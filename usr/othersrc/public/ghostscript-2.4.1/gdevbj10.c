begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1990, 1992 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* gdevbj10.c */
end_comment

begin_comment
comment|/* Canon Bubble Jet BJ-10e printer driver for Ghostscript */
end_comment

begin_include
include|#
directive|include
file|"gdevprn.h"
end_include

begin_comment
comment|/*  * The only available resolutions are (180,360)x(180,360).  */
end_comment

begin_comment
comment|/* The device descriptor */
end_comment

begin_function_decl
name|private
name|dev_proc_print_page
parameter_list|(
name|bj10e_print_page
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|gx_device_printer
name|gs_bj10e_device
init|=
name|prn_device
argument_list|(
name|prn_std_procs
argument_list|,
literal|"bj10e"
argument_list|,
literal|80
argument_list|,
comment|/* width_10ths, 8" */
literal|105
argument_list|,
comment|/* height_10ths, 10.5" */
literal|360
argument_list|,
comment|/* x_dpi */
literal|360
argument_list|,
comment|/* y_dpi */
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
comment|/* margins */
literal|1
argument_list|,
name|bj10e_print_page
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ------ internal routines ------ */
end_comment

begin_comment
comment|/* Send the page to the printer. */
end_comment

begin_function
name|private
name|int
name|bj10e_print_page
parameter_list|(
name|gx_device_printer
modifier|*
name|pdev
parameter_list|,
name|FILE
modifier|*
name|prn_stream
parameter_list|)
block|{
name|int
name|line_size
init|=
name|gx_device_bytes_per_scan_line
argument_list|(
operator|(
name|gx_device
operator|*
operator|)
name|pdev
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|int
name|xres
init|=
name|pdev
operator|->
name|x_pixels_per_inch
decl_stmt|;
name|int
name|yres
init|=
name|pdev
operator|->
name|y_pixels_per_inch
decl_stmt|;
name|int
name|mode
init|=
operator|(
name|yres
operator|==
literal|180
condition|?
operator|(
name|xres
operator|==
literal|180
condition|?
literal|11
else|:
literal|12
operator|)
else|:
operator|(
name|xres
operator|==
literal|180
condition|?
literal|14
else|:
literal|16
operator|)
operator|)
decl_stmt|;
name|int
name|bits_per_column
init|=
literal|24
operator|*
operator|(
name|yres
operator|/
literal|180
operator|)
decl_stmt|;
name|int
name|bytes_per_column
init|=
name|bits_per_column
operator|/
literal|8
decl_stmt|;
name|int
name|skip_unit
init|=
literal|9
operator|*
operator|(
name|xres
operator|/
literal|180
operator|)
decl_stmt|;
name|byte
modifier|*
name|in
init|=
operator|(
name|byte
operator|*
operator|)
name|gs_malloc
argument_list|(
literal|8
argument_list|,
name|line_size
argument_list|,
literal|"bj10e_print_page(in)"
argument_list|)
decl_stmt|;
name|byte
modifier|*
name|out
init|=
operator|(
name|byte
operator|*
operator|)
name|gs_malloc
argument_list|(
name|bits_per_column
argument_list|,
name|line_size
argument_list|,
literal|"bj10e_print_page(out)"
argument_list|)
decl_stmt|;
specifier|static
name|char
name|cmp
index|[
literal|18
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|int
name|lnum
init|=
literal|0
decl_stmt|;
name|int
name|skip
init|=
literal|0
decl_stmt|;
name|int
name|code
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|in
operator|==
literal|0
operator|||
name|out
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Initialize the printer. */
name|fwrite
argument_list|(
literal|"\033[K\004\000\000\044\000\000"
argument_list|,
literal|1
argument_list|,
literal|9
argument_list|,
name|prn_stream
argument_list|)
expr_stmt|;
comment|/* Set vertical spacing. */
name|fwrite
argument_list|(
literal|"\033[\\\004\000\000\000"
argument_list|,
literal|1
argument_list|,
literal|7
argument_list|,
name|prn_stream
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
name|yres
operator|&
literal|0xff
argument_list|,
name|prn_stream
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
name|yres
operator|>>
literal|8
argument_list|,
name|prn_stream
argument_list|)
expr_stmt|;
comment|/* Transfer pixels to printer */
while|while
condition|(
name|lnum
operator|<
name|pdev
operator|->
name|height
condition|)
block|{
name|byte
modifier|*
name|in_end
init|=
name|in
operator|+
name|line_size
decl_stmt|;
name|byte
modifier|*
name|out_beg
init|=
name|out
decl_stmt|;
name|byte
modifier|*
name|out_end
init|=
name|out
operator|+
name|bytes_per_column
operator|*
name|pdev
operator|->
name|width
decl_stmt|;
name|byte
modifier|*
name|outl
init|=
name|out
decl_stmt|;
name|int
name|count
decl_stmt|,
name|bnum
decl_stmt|;
comment|/* Copy 1 scan line and test for all zero. */
name|code
operator|=
name|gdev_prn_get_bits
argument_list|(
name|pdev
argument_list|,
name|lnum
argument_list|,
name|in
argument_list|,
name|line_size
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
goto|goto
name|xit
goto|;
comment|/* The mem... or str... functions should be faster than */
comment|/* the following code, but all systems seem to implement */
comment|/* them so badly that this code is faster. */
block|{
specifier|register
name|long
modifier|*
name|zip
init|=
operator|(
name|long
operator|*
operator|)
name|in
decl_stmt|;
specifier|register
name|int
name|zcnt
init|=
name|line_size
decl_stmt|;
specifier|static
name|long
name|zeroes
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
for|for
control|(
init|;
name|zcnt
operator|>=
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
condition|;
name|zip
operator|+=
literal|4
operator|,
name|zcnt
operator|-=
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
control|)
block|{
if|if
condition|(
name|zip
index|[
literal|0
index|]
operator||
name|zip
index|[
literal|1
index|]
operator||
name|zip
index|[
literal|2
index|]
operator||
name|zip
index|[
literal|3
index|]
condition|)
goto|goto
name|notz
goto|;
block|}
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|in
argument_list|,
operator|(
name|char
operator|*
operator|)
name|zeroes
argument_list|,
name|zcnt
argument_list|)
condition|)
block|{
comment|/* Line is all zero, skip */
name|lnum
operator|++
expr_stmt|;
name|skip
operator|++
expr_stmt|;
continue|continue;
block|}
name|notz
label|:
empty_stmt|;
block|}
comment|/* Vertical tab to the appropriate position. */
while|while
condition|(
name|skip
operator|>
literal|255
condition|)
block|{
name|fputs
argument_list|(
literal|"\033J\377"
argument_list|,
name|prn_stream
argument_list|)
expr_stmt|;
name|skip
operator|-=
literal|255
expr_stmt|;
block|}
if|if
condition|(
name|skip
condition|)
name|fprintf
argument_list|(
name|prn_stream
argument_list|,
literal|"\033J%c"
argument_list|,
name|skip
argument_list|)
expr_stmt|;
comment|/* Transpose in blocks of 8 scan lines. */
for|for
control|(
name|bnum
operator|=
literal|0
init|;
name|bnum
operator|<
name|bits_per_column
condition|;
name|bnum
operator|+=
literal|8
operator|,
name|lnum
operator|+=
literal|8
control|)
block|{
name|int
name|lcnt
init|=
name|gdev_prn_copy_scan_lines
argument_list|(
name|pdev
argument_list|,
name|lnum
argument_list|,
name|in
argument_list|,
literal|8
operator|*
name|line_size
argument_list|)
decl_stmt|;
name|byte
modifier|*
name|inp
init|=
name|in
decl_stmt|;
name|byte
modifier|*
name|outp
init|=
name|outl
decl_stmt|;
if|if
condition|(
name|lcnt
operator|<
literal|0
condition|)
block|{
name|code
operator|=
name|lcnt
expr_stmt|;
goto|goto
name|xit
goto|;
block|}
if|if
condition|(
name|lcnt
operator|<
literal|8
condition|)
name|memset
argument_list|(
name|in
operator|+
name|lcnt
operator|*
name|line_size
argument_list|,
literal|0
argument_list|,
operator|(
literal|8
operator|-
name|lcnt
operator|)
operator|*
name|line_size
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|inp
operator|<
name|in_end
condition|;
name|inp
operator|++
operator|,
name|outp
operator|+=
name|bits_per_column
control|)
block|{
name|gdev_prn_transpose_8x8
argument_list|(
name|inp
argument_list|,
name|line_size
argument_list|,
name|outp
argument_list|,
name|bytes_per_column
argument_list|)
expr_stmt|;
block|}
name|outl
operator|++
expr_stmt|;
block|}
comment|/* Remove trailing 0s. */
while|while
condition|(
name|out_end
operator|-
literal|6
operator|>=
name|out
condition|)
block|{
if|if
condition|(
name|out_end
index|[
operator|-
literal|1
index|]
operator||
name|out_end
index|[
operator|-
literal|2
index|]
operator||
name|out_end
index|[
operator|-
literal|3
index|]
operator||
name|out_end
index|[
operator|-
literal|4
index|]
operator||
name|out_end
index|[
operator|-
literal|5
index|]
operator||
name|out_end
index|[
operator|-
literal|6
index|]
condition|)
break|break;
name|out_end
operator|-=
literal|6
expr_stmt|;
block|}
comment|/* Remove leading 0s. */
while|while
condition|(
name|out_beg
operator|+
name|skip_unit
operator|<=
name|out_end
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cmp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|out_beg
argument_list|,
name|skip_unit
argument_list|)
operator|!=
literal|0
condition|)
break|break;
name|out_beg
operator|+=
name|skip_unit
expr_stmt|;
block|}
comment|/* Transfer the bits */
name|count
operator|=
name|out_end
operator|-
name|out_beg
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|out_beg
operator|>
name|out
operator|&&
name|count
operator|>
literal|1
condition|)
block|{
name|int
name|skip
init|=
operator|(
name|out_beg
operator|-
name|out
operator|)
operator|/
name|skip_unit
decl_stmt|;
if|if
condition|(
name|xres
operator|==
literal|180
condition|)
name|skip
operator|<<=
literal|1
expr_stmt|;
name|fprintf
argument_list|(
name|prn_stream
argument_list|,
literal|"\033d%c%c"
argument_list|,
name|skip
operator|&
literal|0xff
argument_list|,
name|skip
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|prn_stream
argument_list|,
literal|"\033[g%c%c%c"
argument_list|,
name|count
operator|&
literal|0xff
argument_list|,
name|count
operator|>>
literal|8
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|out_beg
argument_list|,
literal|1
argument_list|,
name|count
operator|-
literal|1
argument_list|,
name|prn_stream
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
literal|'\r'
argument_list|,
name|prn_stream
argument_list|)
expr_stmt|;
name|skip
operator|=
name|bits_per_column
expr_stmt|;
block|}
comment|/* Eject the page */
name|xit
label|:
name|fputc
argument_list|(
literal|014
argument_list|,
name|prn_stream
argument_list|)
expr_stmt|;
comment|/* form feed */
name|fflush
argument_list|(
name|prn_stream
argument_list|)
expr_stmt|;
name|gs_free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|out
argument_list|,
name|bits_per_column
argument_list|,
name|line_size
argument_list|,
literal|"bj10e_print_page(out)"
argument_list|)
expr_stmt|;
name|gs_free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|in
argument_list|,
literal|8
argument_list|,
name|line_size
argument_list|,
literal|"bj10e_print_page(in)"
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

end_unit


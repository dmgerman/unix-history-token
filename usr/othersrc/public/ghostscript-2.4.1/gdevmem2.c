begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1992 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* gdevmem2.c */
end_comment

begin_comment
comment|/* 8-and-more-bit-per-pixel "memory" (stored bitmap) devices */
end_comment

begin_comment
comment|/* for Ghostscript library. */
end_comment

begin_include
include|#
directive|include
file|"memory_.h"
end_include

begin_include
include|#
directive|include
file|"gs.h"
end_include

begin_include
include|#
directive|include
file|"gxdevice.h"
end_include

begin_include
include|#
directive|include
file|"gxdevmem.h"
end_include

begin_comment
comment|/* semi-public definitions */
end_comment

begin_include
include|#
directive|include
file|"gdevmem.h"
end_include

begin_comment
comment|/* private definitions */
end_comment

begin_comment
comment|/* ------ Generic procedures ------ */
end_comment

begin_comment
comment|/* Copy a rectangle of bytes from a source to a destination. */
end_comment

begin_undef
undef|#
directive|undef
name|chunk
end_undef

begin_define
define|#
directive|define
name|chunk
value|byte
end_define

begin_function
name|private
name|int
name|copy_byte_rect
parameter_list|(
name|gx_device_memory
modifier|*
name|dev
parameter_list|,
specifier|const
name|byte
modifier|*
name|source
parameter_list|,
name|int
name|sraster
parameter_list|,
name|int
name|offset
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|byte_count
parameter_list|,
name|int
name|h
parameter_list|)
block|{
name|uint
name|draster
init|=
name|dev
operator|->
name|raster
decl_stmt|;
name|byte
modifier|*
name|dest
init|=
name|scan_line_base
argument_list|(
name|dev
argument_list|,
name|y
argument_list|)
operator|+
name|offset
decl_stmt|;
while|while
condition|(
name|h
operator|--
operator|>
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|dest
argument_list|,
name|source
argument_list|,
name|byte_count
argument_list|)
expr_stmt|;
name|source
operator|+=
name|sraster
expr_stmt|;
name|dest
operator|+=
name|draster
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Map a r-g-b color to a color index. */
end_comment

begin_comment
comment|/* This requires searching the palette. */
end_comment

begin_function
name|gx_color_index
name|mem_mapped_map_rgb_color
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|gx_color_value
name|r
parameter_list|,
name|gx_color_value
name|g
parameter_list|,
name|gx_color_value
name|b
parameter_list|)
block|{
name|byte
name|br
init|=
name|gx_color_value_to_byte
argument_list|(
name|r
argument_list|)
decl_stmt|;
name|byte
name|bg
init|=
name|gx_color_value_to_byte
argument_list|(
name|g
argument_list|)
decl_stmt|;
name|byte
name|bb
init|=
name|gx_color_value_to_byte
argument_list|(
name|b
argument_list|)
decl_stmt|;
specifier|register
name|byte
modifier|*
name|pptr
init|=
name|mdev
operator|->
name|palette
decl_stmt|;
name|int
name|cnt
init|=
name|mdev
operator|->
name|palette_size
decl_stmt|;
name|byte
modifier|*
name|which
decl_stmt|;
name|int
name|best
init|=
literal|256
operator|*
literal|3
decl_stmt|;
while|while
condition|(
name|cnt
operator|--
operator|>
literal|0
condition|)
block|{
specifier|register
name|int
name|diff
init|=
operator|*
name|pptr
operator|-
name|br
decl_stmt|;
if|if
condition|(
name|diff
operator|<
literal|0
condition|)
name|diff
operator|=
operator|-
name|diff
expr_stmt|;
if|if
condition|(
name|diff
operator|<
name|best
condition|)
comment|/* quick rejection */
block|{
name|int
name|dg
init|=
name|pptr
index|[
literal|1
index|]
operator|-
name|bg
decl_stmt|;
if|if
condition|(
name|dg
operator|<
literal|0
condition|)
name|dg
operator|=
operator|-
name|dg
expr_stmt|;
if|if
condition|(
operator|(
name|diff
operator|+=
name|dg
operator|)
operator|<
name|best
condition|)
comment|/* quick rejection */
block|{
name|int
name|db
init|=
name|pptr
index|[
literal|2
index|]
operator|-
name|bb
decl_stmt|;
if|if
condition|(
name|db
operator|<
literal|0
condition|)
name|db
operator|=
operator|-
name|db
expr_stmt|;
if|if
condition|(
operator|(
name|diff
operator|+=
name|db
operator|)
operator|<
name|best
condition|)
name|which
operator|=
name|pptr
operator|,
name|best
operator|=
name|diff
expr_stmt|;
block|}
block|}
name|pptr
operator|+=
literal|3
expr_stmt|;
block|}
return|return
call|(
name|gx_color_index
call|)
argument_list|(
operator|(
name|which
operator|-
name|mdev
operator|->
name|palette
operator|)
operator|/
literal|3
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Map a color index to a r-g-b color. */
end_comment

begin_function
name|int
name|mem_mapped_map_color_rgb
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|gx_color_index
name|color
parameter_list|,
name|gx_color_value
name|prgb
index|[
literal|3
index|]
parameter_list|)
block|{
name|byte
modifier|*
name|pptr
init|=
name|mdev
operator|->
name|palette
operator|+
operator|(
name|int
operator|)
name|color
operator|*
literal|3
decl_stmt|;
name|prgb
index|[
literal|0
index|]
operator|=
name|gx_color_value_from_byte
argument_list|(
name|pptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|prgb
index|[
literal|1
index|]
operator|=
name|gx_color_value_from_byte
argument_list|(
name|pptr
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|prgb
index|[
literal|2
index|]
operator|=
name|gx_color_value_from_byte
argument_list|(
name|pptr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ------ Mapped 8-bit color ------ */
end_comment

begin_comment
comment|/* Procedures */
end_comment

begin_expr_stmt
name|declare_mem_procs
argument_list|(
name|mem_mapped8_copy_mono
argument_list|,
name|mem_mapped8_copy_color
argument_list|,
name|mem_mapped8_fill_rectangle
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* The device descriptor. */
end_comment

begin_decl_stmt
name|private
name|gx_device_procs
name|mem_mapped8_procs
init|=
name|mem_procs
argument_list|(
name|mem_mapped_map_rgb_color
argument_list|,
name|mem_mapped_map_color_rgb
argument_list|,
name|mem_mapped8_copy_mono
argument_list|,
name|mem_mapped8_copy_color
argument_list|,
name|mem_mapped8_fill_rectangle
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The instance is public. */
end_comment

begin_decl_stmt
name|gx_device_memory
name|mem_mapped8_color_device
init|=
name|mem_device
argument_list|(
literal|"image(8)"
argument_list|,
literal|8
argument_list|,
name|mem_mapped8_procs
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Convert x coordinate to byte offset in scan line. */
end_comment

begin_undef
undef|#
directive|undef
name|x_to_byte
end_undef

begin_define
define|#
directive|define
name|x_to_byte
parameter_list|(
name|x
parameter_list|)
value|(x)
end_define

begin_comment
comment|/* Fill a rectangle with a color. */
end_comment

begin_function
name|private
name|int
name|mem_mapped8_fill_rectangle
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|gx_color_index
name|color
parameter_list|)
block|{
name|declare_scan_ptr
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|check_rect
argument_list|()
expr_stmt|;
name|setup_rect
argument_list|(
name|dest
argument_list|)
expr_stmt|;
while|while
condition|(
name|h
operator|--
operator|>
literal|0
condition|)
block|{
name|memset
argument_list|(
name|dest
argument_list|,
operator|(
name|byte
operator|)
name|color
argument_list|,
name|w
argument_list|)
expr_stmt|;
name|inc_chunk_ptr
argument_list|(
name|dest
argument_list|,
name|draster
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Copy a monochrome bitmap. */
end_comment

begin_function
name|private
name|int
name|mem_mapped8_copy_mono
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|byte
modifier|*
name|base
parameter_list|,
name|int
name|sourcex
parameter_list|,
name|int
name|sraster
parameter_list|,
name|gx_bitmap_id
name|id
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|gx_color_index
name|zero
parameter_list|,
name|gx_color_index
name|one
parameter_list|)
block|{
name|byte
modifier|*
name|line
decl_stmt|;
name|int
name|first_bit
decl_stmt|;
name|declare_scan_ptr
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|check_rect
argument_list|()
expr_stmt|;
name|setup_rect
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|line
operator|=
name|base
operator|+
operator|(
name|sourcex
operator|>>
literal|3
operator|)
expr_stmt|;
name|first_bit
operator|=
literal|0x80
operator|>>
operator|(
name|sourcex
operator|&
literal|7
operator|)
expr_stmt|;
while|while
condition|(
name|h
operator|--
operator|>
literal|0
condition|)
block|{
specifier|register
name|byte
modifier|*
name|pptr
init|=
name|dest
decl_stmt|;
name|byte
modifier|*
name|sptr
init|=
name|line
decl_stmt|;
specifier|register
name|int
name|sbyte
init|=
operator|*
name|sptr
decl_stmt|;
specifier|register
name|uint
name|bit
init|=
name|first_bit
decl_stmt|;
name|int
name|count
init|=
name|w
decl_stmt|;
define|#
directive|define
name|is_color
parameter_list|(
name|c
parameter_list|)
value|((int)(c) != (int)gx_no_color_index)
define|#
directive|define
name|next_bit
parameter_list|()
define|\
value|if ( (bit>>= 1) == 0 ) bit = 0x80, sbyte = *++sptr;\   pptr++
if|if
condition|(
name|is_color
argument_list|(
name|one
argument_list|)
condition|)
block|{
if|if
condition|(
name|is_color
argument_list|(
name|zero
argument_list|)
condition|)
block|{
comment|/* Optimize halftone coloring */
do|do
block|{
operator|*
name|pptr
operator|=
operator|(
name|sbyte
operator|&
name|bit
condition|?
operator|(
name|byte
operator|)
name|one
else|:
operator|(
name|byte
operator|)
name|zero
operator|)
expr_stmt|;
name|next_bit
argument_list|()
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|count
operator|>
literal|0
condition|)
do|;
block|}
else|else
block|{
comment|/* Optimize stenciling */
do|do
block|{
if|if
condition|(
name|sbyte
operator|&
name|bit
condition|)
operator|*
name|pptr
operator|=
operator|(
name|byte
operator|)
name|one
expr_stmt|;
name|next_bit
argument_list|()
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|count
operator|>
literal|0
condition|)
do|;
block|}
block|}
elseif|else
if|if
condition|(
name|is_color
argument_list|(
name|zero
argument_list|)
condition|)
block|{
do|do
block|{
if|if
condition|(
operator|!
operator|(
name|sbyte
operator|&
name|bit
operator|)
condition|)
operator|*
name|pptr
operator|=
operator|(
name|byte
operator|)
name|zero
expr_stmt|;
name|next_bit
argument_list|()
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|count
operator|>
literal|0
condition|)
do|;
block|}
undef|#
directive|undef
name|next_bit
undef|#
directive|undef
name|is_color
name|line
operator|+=
name|sraster
expr_stmt|;
name|inc_chunk_ptr
argument_list|(
name|dest
argument_list|,
name|draster
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Copy a color bitmap. */
end_comment

begin_function
name|private
name|int
name|mem_mapped8_copy_color
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|byte
modifier|*
name|base
parameter_list|,
name|int
name|sourcex
parameter_list|,
name|int
name|sraster
parameter_list|,
name|gx_bitmap_id
name|id
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|)
block|{
name|check_rect
argument_list|()
expr_stmt|;
return|return
name|copy_byte_rect
argument_list|(
name|mdev
argument_list|,
name|base
operator|+
name|x_to_byte
argument_list|(
name|sourcex
argument_list|)
argument_list|,
name|sraster
argument_list|,
name|x_to_byte
argument_list|(
name|x
argument_list|)
argument_list|,
name|y
argument_list|,
name|x_to_byte
argument_list|(
name|w
argument_list|)
argument_list|,
name|h
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ------ 16-bit true color ------ */
end_comment

begin_comment
comment|/* The 16 bits are divided 5 for red, 6 for green, and 5 for blue. */
end_comment

begin_comment
comment|/* Procedures */
end_comment

begin_expr_stmt
name|declare_mem_map_procs
argument_list|(
name|mem_true16_map_rgb_color
argument_list|,
name|mem_true16_map_color_rgb
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|declare_mem_procs
argument_list|(
name|mem_true16_copy_mono
argument_list|,
name|mem_true16_copy_color
argument_list|,
name|mem_true16_fill_rectangle
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* The device descriptor. */
end_comment

begin_decl_stmt
name|private
name|gx_device_procs
name|mem_true16_procs
init|=
name|mem_procs
argument_list|(
name|mem_true16_map_rgb_color
argument_list|,
name|mem_true16_map_color_rgb
argument_list|,
name|mem_true16_copy_mono
argument_list|,
name|mem_true16_copy_color
argument_list|,
name|mem_true16_fill_rectangle
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The instance is public. */
end_comment

begin_decl_stmt
name|gx_device_memory
name|mem_true16_color_device
init|=
name|mem_device
argument_list|(
literal|"image(16)"
argument_list|,
literal|16
argument_list|,
name|mem_true16_procs
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Map a r-g-b color to a color index. */
end_comment

begin_function
name|private
name|gx_color_index
name|mem_true16_map_rgb_color
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|gx_color_value
name|r
parameter_list|,
name|gx_color_value
name|g
parameter_list|,
name|gx_color_value
name|b
parameter_list|)
block|{
return|return
operator|(
operator|(
name|r
operator|>>
operator|(
name|gx_color_value_bits
operator|-
literal|5
operator|)
operator|)
operator|<<
literal|11
operator|)
operator|+
operator|(
operator|(
name|g
operator|>>
operator|(
name|gx_color_value_bits
operator|-
literal|6
operator|)
operator|)
operator|<<
literal|5
operator|)
operator|+
operator|(
name|b
operator|>>
operator|(
name|gx_color_value_bits
operator|-
literal|5
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Map a color index to a r-g-b color. */
end_comment

begin_function
name|private
name|int
name|mem_true16_map_color_rgb
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|gx_color_index
name|color
parameter_list|,
name|gx_color_value
name|prgb
index|[
literal|3
index|]
parameter_list|)
block|{
name|ushort
name|value
decl_stmt|;
name|value
operator|=
name|color
operator|>>
literal|11
expr_stmt|;
name|prgb
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|value
operator|<<
literal|11
operator|)
operator|+
operator|(
name|value
operator|<<
literal|6
operator|)
operator|+
operator|(
name|value
operator|<<
literal|1
operator|)
operator|+
operator|(
name|value
operator|>>
literal|4
operator|)
operator|)
operator|>>
operator|(
literal|16
operator|-
name|gx_color_value_bits
operator|)
expr_stmt|;
name|value
operator|=
operator|(
name|color
operator|>>
literal|6
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|prgb
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|value
operator|<<
literal|10
operator|)
operator|+
operator|(
name|value
operator|<<
literal|4
operator|)
operator|+
operator|(
name|value
operator|>>
literal|2
operator|)
operator|)
operator|>>
operator|(
literal|16
operator|-
name|gx_color_value_bits
operator|)
expr_stmt|;
name|value
operator|=
name|color
operator|&
literal|0x3f
expr_stmt|;
name|prgb
index|[
literal|2
index|]
operator|=
operator|(
operator|(
name|value
operator|<<
literal|11
operator|)
operator|+
operator|(
name|value
operator|<<
literal|6
operator|)
operator|+
operator|(
name|value
operator|<<
literal|1
operator|)
operator|+
operator|(
name|value
operator|>>
literal|4
operator|)
operator|)
operator|>>
operator|(
literal|16
operator|-
name|gx_color_value_bits
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Convert x coordinate to byte offset in scan line. */
end_comment

begin_undef
undef|#
directive|undef
name|x_to_byte
end_undef

begin_define
define|#
directive|define
name|x_to_byte
parameter_list|(
name|x
parameter_list|)
value|((x)<< 1)
end_define

begin_comment
comment|/* Fill a rectangle with a color. */
end_comment

begin_function
name|private
name|int
name|mem_true16_fill_rectangle
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|gx_color_index
name|color
parameter_list|)
block|{
name|declare_scan_ptr
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|check_rect
argument_list|()
expr_stmt|;
name|setup_rect
argument_list|(
name|dest
argument_list|)
expr_stmt|;
while|while
condition|(
name|h
operator|--
operator|>
literal|0
condition|)
block|{
name|ushort
modifier|*
name|pptr
init|=
operator|(
name|ushort
operator|*
operator|)
name|dest
decl_stmt|;
name|int
name|cnt
init|=
name|w
decl_stmt|;
do|do
block|{
operator|*
name|pptr
operator|++
operator|=
operator|(
name|ushort
operator|)
name|color
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|cnt
operator|>
literal|0
condition|)
do|;
name|inc_chunk_ptr
argument_list|(
name|dest
argument_list|,
name|draster
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Copy a monochrome bitmap. */
end_comment

begin_function
name|private
name|int
name|mem_true16_copy_mono
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|byte
modifier|*
name|base
parameter_list|,
name|int
name|sourcex
parameter_list|,
name|int
name|sraster
parameter_list|,
name|gx_bitmap_id
name|id
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|gx_color_index
name|zero
parameter_list|,
name|gx_color_index
name|one
parameter_list|)
block|{
name|byte
modifier|*
name|line
decl_stmt|;
name|int
name|first_bit
decl_stmt|;
name|declare_scan_ptr
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|check_rect
argument_list|()
expr_stmt|;
name|setup_rect
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|line
operator|=
name|base
operator|+
operator|(
name|sourcex
operator|>>
literal|3
operator|)
expr_stmt|;
name|first_bit
operator|=
literal|0x80
operator|>>
operator|(
name|sourcex
operator|&
literal|7
operator|)
expr_stmt|;
while|while
condition|(
name|h
operator|--
operator|>
literal|0
condition|)
block|{
specifier|register
name|ushort
modifier|*
name|pptr
init|=
operator|(
name|ushort
operator|*
operator|)
name|dest
decl_stmt|;
name|byte
modifier|*
name|sptr
init|=
name|line
decl_stmt|;
specifier|register
name|int
name|sbyte
init|=
operator|*
name|sptr
operator|++
decl_stmt|;
specifier|register
name|int
name|bit
init|=
name|first_bit
decl_stmt|;
name|int
name|count
init|=
name|w
decl_stmt|;
do|do
block|{
if|if
condition|(
name|sbyte
operator|&
name|bit
condition|)
block|{
if|if
condition|(
name|one
operator|!=
name|gx_no_color_index
condition|)
operator|*
name|pptr
operator|=
operator|(
name|ushort
operator|)
name|one
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|zero
operator|!=
name|gx_no_color_index
condition|)
operator|*
name|pptr
operator|=
operator|(
name|ushort
operator|)
name|zero
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|bit
operator|>>=
literal|1
operator|)
operator|==
literal|0
condition|)
name|bit
operator|=
literal|0x80
operator|,
name|sbyte
operator|=
operator|*
name|sptr
operator|++
expr_stmt|;
name|pptr
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|count
operator|>
literal|0
condition|)
do|;
name|line
operator|+=
name|sraster
expr_stmt|;
name|inc_chunk_ptr
argument_list|(
name|dest
argument_list|,
name|draster
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Copy a color bitmap. */
end_comment

begin_function
name|private
name|int
name|mem_true16_copy_color
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|byte
modifier|*
name|base
parameter_list|,
name|int
name|sourcex
parameter_list|,
name|int
name|sraster
parameter_list|,
name|gx_bitmap_id
name|id
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|)
block|{
name|check_rect
argument_list|()
expr_stmt|;
return|return
name|copy_byte_rect
argument_list|(
name|mdev
argument_list|,
name|base
operator|+
name|x_to_byte
argument_list|(
name|sourcex
argument_list|)
argument_list|,
name|sraster
argument_list|,
name|x_to_byte
argument_list|(
name|x
argument_list|)
argument_list|,
name|y
argument_list|,
name|x_to_byte
argument_list|(
name|w
argument_list|)
argument_list|,
name|h
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ------ 24- or 32-bit true color ------ */
end_comment

begin_comment
comment|/* Procedures */
end_comment

begin_expr_stmt
name|declare_mem_map_procs
argument_list|(
name|mem_true_map_rgb_color
argument_list|,
name|mem_true_map_color_rgb
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* The device descriptor. */
end_comment

begin_define
define|#
directive|define
name|mem_true_procs
parameter_list|(
name|copy_mono
parameter_list|,
name|copy_color
parameter_list|,
name|fill_rectangle
parameter_list|)
define|\
value|mem_procs(mem_true_map_rgb_color, mem_true_map_color_rgb,\     copy_mono, copy_color, fill_rectangle)
end_define

begin_comment
comment|/* We want the bytes of a color always to be in the order -,r,g,b, */
end_comment

begin_comment
comment|/* but we want to manipulate colors as longs.  This requires careful */
end_comment

begin_comment
comment|/* handling to be byte-order independent. */
end_comment

begin_define
define|#
directive|define
name|color_byte
parameter_list|(
name|cx
parameter_list|,
name|i
parameter_list|)
value|(((byte *)&(cx))[i])
end_define

begin_comment
comment|/* Map a r-g-b color to a color index. */
end_comment

begin_function
name|private
name|gx_color_index
name|mem_true_map_rgb_color
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|gx_color_value
name|r
parameter_list|,
name|gx_color_value
name|g
parameter_list|,
name|gx_color_value
name|b
parameter_list|)
block|{
return|return
name|gx_color_value_to_byte
argument_list|(
name|b
argument_list|)
operator|+
operator|(
operator|(
name|uint
operator|)
name|gx_color_value_to_byte
argument_list|(
name|g
argument_list|)
operator|<<
literal|8
operator|)
operator|+
operator|(
operator|(
name|ulong
operator|)
name|gx_color_value_to_byte
argument_list|(
name|r
argument_list|)
operator|<<
literal|16
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Map a color index to a r-g-b color. */
end_comment

begin_function
name|private
name|int
name|mem_true_map_color_rgb
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|gx_color_index
name|color
parameter_list|,
name|gx_color_value
name|prgb
index|[
literal|3
index|]
parameter_list|)
block|{
name|prgb
index|[
literal|0
index|]
operator|=
name|gx_color_value_from_byte
argument_list|(
name|color
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|prgb
index|[
literal|1
index|]
operator|=
name|gx_color_value_from_byte
argument_list|(
operator|(
name|color
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|prgb
index|[
literal|2
index|]
operator|=
name|gx_color_value_from_byte
argument_list|(
name|color
operator|&
literal|0xff
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ------ 24-bit color ------ */
end_comment

begin_comment
comment|/* 24-bit takes less space than 32-bit, but is slower. */
end_comment

begin_comment
comment|/* Procedures */
end_comment

begin_expr_stmt
name|declare_mem_procs
argument_list|(
name|mem_true24_copy_mono
argument_list|,
name|mem_true24_copy_color
argument_list|,
name|mem_true24_fill_rectangle
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* The device descriptor. */
end_comment

begin_decl_stmt
name|private
name|gx_device_procs
name|mem_true24_procs
init|=
name|mem_true_procs
argument_list|(
name|mem_true24_copy_mono
argument_list|,
name|mem_true24_copy_color
argument_list|,
name|mem_true24_fill_rectangle
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|gx_device_memory
name|mem_true24_color_device
init|=
name|mem_device
argument_list|(
literal|"image(24)"
argument_list|,
literal|24
argument_list|,
name|mem_true24_procs
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Convert x coordinate to byte offset in scan line. */
end_comment

begin_undef
undef|#
directive|undef
name|x_to_byte
end_undef

begin_define
define|#
directive|define
name|x_to_byte
parameter_list|(
name|x
parameter_list|)
value|((x) * 3)
end_define

begin_comment
comment|/* Unpack a color into its bytes. */
end_comment

begin_define
define|#
directive|define
name|declare_unpack_color
parameter_list|(
name|r
parameter_list|,
name|g
parameter_list|,
name|b
parameter_list|,
name|color
parameter_list|)
define|\
value|byte r = (byte)(color>> 16);\ 	byte g = (byte)((uint)color>> 8);\ 	byte b = (byte)color
end_define

begin_define
define|#
directive|define
name|put3
parameter_list|(
name|ptr
parameter_list|,
name|r
parameter_list|,
name|g
parameter_list|,
name|b
parameter_list|)
define|\
value|ptr[0] = r, ptr[1] = g, ptr[2] = b
end_define

begin_comment
comment|/* Fill a rectangle with a color. */
end_comment

begin_function
name|private
name|int
name|mem_true24_fill_rectangle
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|gx_color_index
name|color
parameter_list|)
block|{
name|declare_unpack_color
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|,
name|color
argument_list|)
expr_stmt|;
name|declare_scan_ptr
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|check_rect
argument_list|()
expr_stmt|;
name|setup_rect
argument_list|(
name|dest
argument_list|)
expr_stmt|;
while|while
condition|(
name|h
operator|--
operator|>
literal|0
condition|)
block|{
specifier|register
name|int
name|cnt
init|=
name|w
decl_stmt|;
specifier|register
name|byte
modifier|*
name|pptr
init|=
name|dest
decl_stmt|;
do|do
block|{
name|put3
argument_list|(
name|pptr
argument_list|,
name|r
argument_list|,
name|g
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|pptr
operator|+=
literal|3
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|cnt
operator|>
literal|0
condition|)
do|;
name|inc_chunk_ptr
argument_list|(
name|dest
argument_list|,
name|draster
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Copy a monochrome bitmap. */
end_comment

begin_function
name|private
name|int
name|mem_true24_copy_mono
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|byte
modifier|*
name|base
parameter_list|,
name|int
name|sourcex
parameter_list|,
name|int
name|sraster
parameter_list|,
name|gx_bitmap_id
name|id
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|gx_color_index
name|zero
parameter_list|,
name|gx_color_index
name|one
parameter_list|)
block|{
name|byte
modifier|*
name|line
decl_stmt|;
name|int
name|first_bit
decl_stmt|;
name|declare_unpack_color
argument_list|(
name|r0
argument_list|,
name|g0
argument_list|,
name|b0
argument_list|,
name|zero
argument_list|)
expr_stmt|;
name|declare_unpack_color
argument_list|(
name|r1
argument_list|,
name|g1
argument_list|,
name|b1
argument_list|,
name|one
argument_list|)
expr_stmt|;
name|declare_scan_ptr
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|check_rect
argument_list|()
expr_stmt|;
name|setup_rect
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|line
operator|=
name|base
operator|+
operator|(
name|sourcex
operator|>>
literal|3
operator|)
expr_stmt|;
name|first_bit
operator|=
literal|0x80
operator|>>
operator|(
name|sourcex
operator|&
literal|7
operator|)
expr_stmt|;
while|while
condition|(
name|h
operator|--
operator|>
literal|0
condition|)
block|{
specifier|register
name|byte
modifier|*
name|pptr
init|=
name|dest
decl_stmt|;
name|byte
modifier|*
name|sptr
init|=
name|line
decl_stmt|;
specifier|register
name|int
name|sbyte
init|=
operator|*
name|sptr
operator|++
decl_stmt|;
specifier|register
name|int
name|bit
init|=
name|first_bit
decl_stmt|;
name|int
name|count
init|=
name|w
decl_stmt|;
do|do
block|{
if|if
condition|(
name|sbyte
operator|&
name|bit
condition|)
block|{
if|if
condition|(
name|one
operator|!=
name|gx_no_color_index
condition|)
name|put3
argument_list|(
name|pptr
argument_list|,
name|r1
argument_list|,
name|g1
argument_list|,
name|b1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|zero
operator|!=
name|gx_no_color_index
condition|)
name|put3
argument_list|(
name|pptr
argument_list|,
name|r0
argument_list|,
name|g0
argument_list|,
name|b0
argument_list|)
expr_stmt|;
block|}
name|pptr
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
operator|(
name|bit
operator|>>=
literal|1
operator|)
operator|==
literal|0
condition|)
name|bit
operator|=
literal|0x80
operator|,
name|sbyte
operator|=
operator|*
name|sptr
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|count
operator|>
literal|0
condition|)
do|;
name|line
operator|+=
name|sraster
expr_stmt|;
name|inc_chunk_ptr
argument_list|(
name|dest
argument_list|,
name|draster
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Copy a color bitmap. */
end_comment

begin_function
name|private
name|int
name|mem_true24_copy_color
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|byte
modifier|*
name|base
parameter_list|,
name|int
name|sourcex
parameter_list|,
name|int
name|sraster
parameter_list|,
name|gx_bitmap_id
name|id
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|)
block|{
name|check_rect
argument_list|()
expr_stmt|;
return|return
name|copy_byte_rect
argument_list|(
name|mdev
argument_list|,
name|base
operator|+
name|x_to_byte
argument_list|(
name|sourcex
argument_list|)
argument_list|,
name|sraster
argument_list|,
name|x_to_byte
argument_list|(
name|x
argument_list|)
argument_list|,
name|y
argument_list|,
name|x_to_byte
argument_list|(
name|w
argument_list|)
argument_list|,
name|h
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ------ 32-bit color ------ */
end_comment

begin_comment
comment|/* Procedures */
end_comment

begin_expr_stmt
name|declare_mem_procs
argument_list|(
name|mem_true32_copy_mono
argument_list|,
name|mem_true32_copy_color
argument_list|,
name|mem_true32_fill_rectangle
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* The device descriptor. */
end_comment

begin_decl_stmt
name|private
name|gx_device_procs
name|mem_true32_procs
init|=
name|mem_true_procs
argument_list|(
name|mem_true32_copy_mono
argument_list|,
name|mem_true32_copy_color
argument_list|,
name|mem_true32_fill_rectangle
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|gx_device_memory
name|mem_true32_color_device
init|=
name|mem_device
argument_list|(
literal|"image(32)"
argument_list|,
literal|32
argument_list|,
name|mem_true32_procs
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Convert x coordinate to byte offset in scan line. */
end_comment

begin_undef
undef|#
directive|undef
name|x_to_byte
end_undef

begin_define
define|#
directive|define
name|x_to_byte
parameter_list|(
name|x
parameter_list|)
value|((x)<< 2)
end_define

begin_comment
comment|/* Swap the bytes of a color if needed. */
end_comment

begin_if
if|#
directive|if
name|arch_is_big_endian
end_if

begin_define
define|#
directive|define
name|arrange_bytes
parameter_list|(
name|color
parameter_list|)
value|(color)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|arrange_bytes
parameter_list|(
name|color
parameter_list|)
define|\
value|(((color)>> 24) + (((color)>> 16)& 0xff00) +\      (((color)& 0xff00)<< 8) + ((color)<< 24))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Fill a rectangle with a color. */
end_comment

begin_function
name|private
name|int
name|mem_true32_fill_rectangle
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|gx_color_index
name|color
parameter_list|)
block|{
name|gx_color_index
name|a_color
init|=
name|arrange_bytes
argument_list|(
name|color
argument_list|)
decl_stmt|;
name|declare_scan_ptr
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|check_rect
argument_list|()
expr_stmt|;
name|setup_rect
argument_list|(
name|dest
argument_list|)
expr_stmt|;
while|while
condition|(
name|h
operator|--
operator|>
literal|0
condition|)
block|{
name|gx_color_index
modifier|*
name|pptr
init|=
operator|(
name|gx_color_index
operator|*
operator|)
name|dest
decl_stmt|;
name|int
name|cnt
init|=
name|w
decl_stmt|;
do|do
block|{
operator|*
name|pptr
operator|++
operator|=
name|a_color
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|cnt
operator|>
literal|0
condition|)
do|;
name|inc_chunk_ptr
argument_list|(
name|dest
argument_list|,
name|draster
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Copy a monochrome bitmap. */
end_comment

begin_function
name|private
name|int
name|mem_true32_copy_mono
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|byte
modifier|*
name|base
parameter_list|,
name|int
name|sourcex
parameter_list|,
name|int
name|sraster
parameter_list|,
name|gx_bitmap_id
name|id
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|gx_color_index
name|zero
parameter_list|,
name|gx_color_index
name|one
parameter_list|)
block|{
name|gx_color_index
name|a_zero
init|=
name|arrange_bytes
argument_list|(
name|zero
argument_list|)
decl_stmt|;
name|gx_color_index
name|a_one
init|=
name|arrange_bytes
argument_list|(
name|one
argument_list|)
decl_stmt|;
name|byte
modifier|*
name|line
decl_stmt|;
name|int
name|first_bit
decl_stmt|;
name|declare_scan_ptr
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|check_rect
argument_list|()
expr_stmt|;
name|setup_rect
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|line
operator|=
name|base
operator|+
operator|(
name|sourcex
operator|>>
literal|3
operator|)
expr_stmt|;
name|first_bit
operator|=
literal|0x80
operator|>>
operator|(
name|sourcex
operator|&
literal|7
operator|)
expr_stmt|;
while|while
condition|(
name|h
operator|--
operator|>
literal|0
condition|)
block|{
specifier|register
name|gx_color_index
modifier|*
name|pptr
init|=
operator|(
name|gx_color_index
operator|*
operator|)
name|dest
decl_stmt|;
name|byte
modifier|*
name|sptr
init|=
name|line
decl_stmt|;
specifier|register
name|int
name|sbyte
init|=
operator|*
name|sptr
operator|++
decl_stmt|;
specifier|register
name|int
name|bit
init|=
name|first_bit
decl_stmt|;
name|int
name|count
init|=
name|w
decl_stmt|;
do|do
block|{
if|if
condition|(
name|sbyte
operator|&
name|bit
condition|)
block|{
if|if
condition|(
name|one
operator|!=
name|gx_no_color_index
condition|)
operator|*
name|pptr
operator|=
name|a_one
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|zero
operator|!=
name|gx_no_color_index
condition|)
operator|*
name|pptr
operator|=
name|a_zero
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|bit
operator|>>=
literal|1
operator|)
operator|==
literal|0
condition|)
name|bit
operator|=
literal|0x80
operator|,
name|sbyte
operator|=
operator|*
name|sptr
operator|++
expr_stmt|;
name|pptr
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|count
operator|>
literal|0
condition|)
do|;
name|line
operator|+=
name|sraster
expr_stmt|;
name|inc_chunk_ptr
argument_list|(
name|dest
argument_list|,
name|draster
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Copy a color bitmap. */
end_comment

begin_function
name|private
name|int
name|mem_true32_copy_color
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|byte
modifier|*
name|base
parameter_list|,
name|int
name|sourcex
parameter_list|,
name|int
name|sraster
parameter_list|,
name|gx_bitmap_id
name|id
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|)
block|{
name|check_rect
argument_list|()
expr_stmt|;
return|return
name|copy_byte_rect
argument_list|(
name|mdev
argument_list|,
name|base
operator|+
name|x_to_byte
argument_list|(
name|sourcex
argument_list|)
argument_list|,
name|sraster
argument_list|,
name|x_to_byte
argument_list|(
name|x
argument_list|)
argument_list|,
name|y
argument_list|,
name|x_to_byte
argument_list|(
name|w
argument_list|)
argument_list|,
name|h
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1990, 1991 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* gsfont.c */
end_comment

begin_comment
comment|/* Font operators for GhostScript library */
end_comment

begin_include
include|#
directive|include
file|"gx.h"
end_include

begin_include
include|#
directive|include
file|"memory_.h"
end_include

begin_include
include|#
directive|include
file|"gserrors.h"
end_include

begin_include
include|#
directive|include
file|"gxfixed.h"
end_include

begin_include
include|#
directive|include
file|"gxmatrix.h"
end_include

begin_include
include|#
directive|include
file|"gzstate.h"
end_include

begin_comment
comment|/* must precede gxdevice */
end_comment

begin_include
include|#
directive|include
file|"gxdevice.h"
end_include

begin_comment
comment|/* must precede gxfont */
end_comment

begin_include
include|#
directive|include
file|"gschar.h"
end_include

begin_include
include|#
directive|include
file|"gxfont.h"
end_include

begin_include
include|#
directive|include
file|"gxfdir.h"
end_include

begin_comment
comment|/* Imported procedures */
end_comment

begin_decl_stmt
name|void
name|gs_purge_font_from_char_caches
argument_list|(
name|P2
argument_list|(
name|gs_font_dir
operator|*
argument_list|,
name|gs_font
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Size of cache structures */
end_comment

begin_decl_stmt
specifier|extern
specifier|const
name|uint
name|cached_char_sizeof
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
specifier|const
name|uint
name|cached_fm_pair_sizeof
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Define the sizes of the various aspects of the font/character cache. */
end_comment

begin_comment
comment|/*** Big memory machines ***/
end_comment

begin_define
define|#
directive|define
name|smax_LARGE
value|50
end_define

begin_comment
comment|/* smax - # of scaled fonts */
end_comment

begin_define
define|#
directive|define
name|bmax_LARGE
value|500000
end_define

begin_comment
comment|/* bmax - space for cached chars */
end_comment

begin_define
define|#
directive|define
name|mmax_LARGE
value|200
end_define

begin_comment
comment|/* mmax - # of cached font/matrix pairs */
end_comment

begin_define
define|#
directive|define
name|cmax_LARGE
value|5000
end_define

begin_comment
comment|/* cmax - # of cached chars */
end_comment

begin_define
define|#
directive|define
name|blimit_LARGE
value|1000
end_define

begin_comment
comment|/* blimit/upper - max size of a single cached char */
end_comment

begin_comment
comment|/*** Small memory machines ***/
end_comment

begin_define
define|#
directive|define
name|smax_SMALL
value|20
end_define

begin_comment
comment|/* smax - # of scaled fonts */
end_comment

begin_define
define|#
directive|define
name|bmax_SMALL
value|25000
end_define

begin_comment
comment|/* bmax - space for cached chars */
end_comment

begin_define
define|#
directive|define
name|mmax_SMALL
value|40
end_define

begin_comment
comment|/* mmax - # of cached font/matrix pairs */
end_comment

begin_define
define|#
directive|define
name|cmax_SMALL
value|500
end_define

begin_comment
comment|/* cmax - # of cached chars */
end_comment

begin_define
define|#
directive|define
name|blimit_SMALL
value|100
end_define

begin_comment
comment|/* blimit/upper - max size of a single cached char */
end_comment

begin_comment
comment|/* Allocate a font directory */
end_comment

begin_function
name|gs_font_dir
modifier|*
name|gs_font_dir_alloc
parameter_list|(
name|proc_alloc_t
name|palloc
parameter_list|,
name|proc_free_t
name|pfree
parameter_list|)
block|{
comment|/* Try allocating a very large cache. */
comment|/* If this fails, allocate a small one. */
name|gs_font_dir
modifier|*
name|pdir
decl_stmt|;
if|#
directive|if
operator|!
name|arch_ints_are_short
name|pdir
operator|=
name|gs_font_dir_alloc_limits
argument_list|(
name|palloc
argument_list|,
name|pfree
argument_list|,
name|smax_LARGE
argument_list|,
name|bmax_LARGE
argument_list|,
name|mmax_LARGE
argument_list|,
name|cmax_LARGE
argument_list|,
name|blimit_LARGE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdir
operator|!=
literal|0
condition|)
return|return
name|pdir
return|;
endif|#
directive|endif
return|return
name|gs_font_dir_alloc_limits
argument_list|(
name|palloc
argument_list|,
name|pfree
argument_list|,
name|smax_SMALL
argument_list|,
name|bmax_SMALL
argument_list|,
name|mmax_SMALL
argument_list|,
name|cmax_SMALL
argument_list|,
name|blimit_SMALL
argument_list|)
return|;
block|}
end_function

begin_function
name|gs_font_dir
modifier|*
name|gs_font_dir_alloc_limits
parameter_list|(
name|proc_alloc_t
name|palloc
parameter_list|,
name|proc_free_t
name|pfree
parameter_list|,
name|uint
name|smax
parameter_list|,
name|uint
name|bmax
parameter_list|,
name|uint
name|mmax
parameter_list|,
name|uint
name|cmax
parameter_list|,
name|uint
name|upper
parameter_list|)
block|{
specifier|register
name|gs_font_dir
modifier|*
name|pdir
init|=
operator|(
name|gs_font_dir
operator|*
operator|)
call|(
modifier|*
name|palloc
call|)
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|gs_font_dir
argument_list|)
argument_list|,
literal|"font_dir_alloc(dir)"
argument_list|)
decl_stmt|;
name|uint
name|cdcount
init|=
name|bmax
operator|/
name|cached_char_sizeof
operator|+
literal|1
decl_stmt|;
name|uint
name|cdsize
init|=
name|cdcount
operator|*
name|cached_char_sizeof
decl_stmt|;
name|uint
name|chsize
init|=
operator|(
name|cmax
operator|/
literal|5
operator|)
operator||
literal|31
decl_stmt|;
comment|/* a guess */
name|struct
name|cached_fm_pair_s
modifier|*
name|mdata
decl_stmt|;
name|byte
modifier|*
name|cdata
decl_stmt|;
name|struct
name|cached_char_s
modifier|*
modifier|*
name|chars
decl_stmt|;
if|if
condition|(
name|pdir
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Round up chsize to a power of 2. */
while|while
condition|(
name|chsize
operator|&
operator|(
name|chsize
operator|+
literal|1
operator|)
condition|)
name|chsize
operator||=
name|chsize
operator|>>
literal|1
expr_stmt|;
name|chsize
operator|++
expr_stmt|;
name|mdata
operator|=
operator|(
expr|struct
name|cached_fm_pair_s
operator|*
operator|)
call|(
modifier|*
name|palloc
call|)
argument_list|(
name|mmax
argument_list|,
name|cached_fm_pair_sizeof
argument_list|,
literal|"font_dir_alloc(mdata)"
argument_list|)
expr_stmt|;
name|cdata
operator|=
operator|(
name|byte
operator|*
operator|)
call|(
modifier|*
name|palloc
call|)
argument_list|(
name|cdcount
argument_list|,
name|cached_char_sizeof
argument_list|,
literal|"font_dir_alloc(cdata)"
argument_list|)
expr_stmt|;
name|chars
operator|=
operator|(
expr|struct
name|cached_char_s
operator|*
operator|*
operator|)
call|(
modifier|*
name|palloc
call|)
argument_list|(
name|chsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|cached_char_s
operator|*
argument_list|)
argument_list|,
literal|"font_dir_alloc(chars)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdata
operator|==
literal|0
operator|||
name|cdata
operator|==
literal|0
operator|||
name|chars
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|chars
operator|!=
literal|0
condition|)
call|(
modifier|*
name|pfree
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|chars
argument_list|,
name|chsize
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|cached_char_s
operator|*
argument_list|)
argument_list|,
literal|"font_dir_alloc(chars)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdata
operator|!=
literal|0
condition|)
call|(
modifier|*
name|pfree
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cdata
argument_list|,
name|cdcount
argument_list|,
name|cached_char_sizeof
argument_list|,
literal|"font_dir_alloc(cdata)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdata
operator|!=
literal|0
condition|)
call|(
modifier|*
name|pfree
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|mdata
argument_list|,
name|mmax
argument_list|,
name|cached_fm_pair_sizeof
argument_list|,
literal|"font_dir_alloc(mdata)"
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pfree
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pdir
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|gs_font_dir
argument_list|)
argument_list|,
literal|"font_dir_alloc(dir)"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pdir
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gs_font_dir
argument_list|)
argument_list|)
expr_stmt|;
comment|/* easiest to clear everything first */
name|pdir
operator|->
name|alloc
operator|=
name|palloc
expr_stmt|;
name|pdir
operator|->
name|free
operator|=
name|pfree
expr_stmt|;
name|pdir
operator|->
name|smax
operator|=
name|smax
expr_stmt|;
name|pdir
operator|->
name|bmax
operator|=
name|bmax
expr_stmt|;
name|pdir
operator|->
name|mmax
operator|=
name|mmax
expr_stmt|;
name|pdir
operator|->
name|cmax
operator|=
name|cmax
expr_stmt|;
name|pdir
operator|->
name|lower
operator|=
name|upper
operator|/
literal|10
expr_stmt|;
name|pdir
operator|->
name|upper
operator|=
name|upper
expr_stmt|;
name|pdir
operator|->
name|mdata
operator|=
name|mdata
expr_stmt|;
name|pdir
operator|->
name|cdata
operator|=
name|cdata
expr_stmt|;
name|pdir
operator|->
name|cdata_size
operator|=
name|cdsize
expr_stmt|;
name|pdir
operator|->
name|chars
operator|=
name|chars
expr_stmt|;
name|pdir
operator|->
name|chars_mask
operator|=
name|chsize
operator|-
literal|1
expr_stmt|;
name|gx_char_cache_init
argument_list|(
name|pdir
argument_list|)
expr_stmt|;
return|return
name|pdir
return|;
block|}
end_function

begin_comment
comment|/* Macro for linking an element at the head of a chain */
end_comment

begin_define
define|#
directive|define
name|link_first
parameter_list|(
name|first
parameter_list|,
name|elt
parameter_list|)
define|\
value|if ( (elt->next = first) != NULL ) first->prev = elt;\   elt->prev = 0;\   first = elt
end_define

begin_comment
comment|/* scalefont */
end_comment

begin_function
name|int
name|gs_scalefont
parameter_list|(
name|gs_font_dir
modifier|*
name|pdir
parameter_list|,
name|gs_font
modifier|*
name|pfont
parameter_list|,
name|floatp
name|scale
parameter_list|,
name|gs_font
modifier|*
modifier|*
name|ppfont
parameter_list|,
name|gs_font
modifier|*
modifier|*
name|pdfont
parameter_list|)
block|{
name|gs_matrix
name|mat
decl_stmt|;
name|gs_make_scaling
argument_list|(
name|scale
argument_list|,
name|scale
argument_list|,
operator|&
name|mat
argument_list|)
expr_stmt|;
return|return
name|gs_makefont
argument_list|(
name|pdir
argument_list|,
name|pfont
argument_list|,
operator|&
name|mat
argument_list|,
name|ppfont
argument_list|,
name|pdfont
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* makefont */
end_comment

begin_function
name|int
name|gs_makefont
parameter_list|(
name|gs_font_dir
modifier|*
name|pdir
parameter_list|,
name|gs_font
modifier|*
name|pfont
parameter_list|,
name|gs_matrix
modifier|*
name|pmat
parameter_list|,
name|gs_font
modifier|*
modifier|*
name|ppfont
parameter_list|,
name|gs_font
modifier|*
modifier|*
name|pdfont
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|gs_font
modifier|*
name|prev
init|=
literal|0
decl_stmt|,
modifier|*
name|pf_out
init|=
name|pdir
operator|->
name|scaled_fonts
decl_stmt|;
name|gs_matrix
name|newmat
decl_stmt|;
operator|*
name|pdfont
operator|=
literal|0
expr_stmt|;
name|gs_make_identity
argument_list|(
operator|&
name|newmat
argument_list|)
expr_stmt|;
comment|/* fill in tags */
if|if
condition|(
operator|(
name|code
operator|=
name|gs_matrix_multiply
argument_list|(
operator|&
name|pfont
operator|->
name|FontMatrix
argument_list|,
name|pmat
argument_list|,
operator|&
name|newmat
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
comment|/* Check for the font already being in the scaled font cache. */
comment|/* Only attempt to share fonts if the current font has */
comment|/* a real UniqueID (i.e., not -1). */
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|gs_debug
index|[
literal|'m'
index|]
condition|)
block|{
name|dprintf2
argument_list|(
literal|"[m]UniqueID=%ld, FontType=%d,\n"
argument_list|,
name|pfont
operator|->
name|data
operator|.
name|base
operator|.
name|UniqueID
argument_list|,
name|pfont
operator|->
name|FontType
argument_list|)
expr_stmt|;
name|dprintf6
argument_list|(
literal|"[m]  new FontMatrix=[%g %g %g %g %g %g]\n"
argument_list|,
name|pmat
operator|->
name|xx
argument_list|,
name|pmat
operator|->
name|xy
argument_list|,
name|pmat
operator|->
name|yx
argument_list|,
name|pmat
operator|->
name|yy
argument_list|,
name|pmat
operator|->
name|tx
argument_list|,
name|pmat
operator|->
name|ty
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|pfont
operator|->
name|data
operator|.
name|base
operator|.
name|UniqueID
operator|!=
operator|-
literal|1
condition|)
for|for
control|(
init|;
name|pf_out
operator|!=
literal|0
condition|;
name|prev
operator|=
name|pf_out
operator|,
name|pf_out
operator|=
name|pf_out
operator|->
name|next
control|)
if|if
condition|(
name|pf_out
operator|->
name|data
operator|.
name|base
operator|.
name|UniqueID
operator|==
name|pfont
operator|->
name|data
operator|.
name|base
operator|.
name|UniqueID
operator|&&
name|pf_out
operator|->
name|FontType
operator|==
name|pfont
operator|->
name|FontType
operator|&&
name|pf_out
operator|->
name|FontMatrix
operator|.
name|xx
operator|==
name|newmat
operator|.
name|xx
operator|&&
name|pf_out
operator|->
name|FontMatrix
operator|.
name|xy
operator|==
name|newmat
operator|.
name|xy
operator|&&
name|pf_out
operator|->
name|FontMatrix
operator|.
name|yx
operator|==
name|newmat
operator|.
name|yx
operator|&&
name|pf_out
operator|->
name|FontMatrix
operator|.
name|yy
operator|==
name|newmat
operator|.
name|yy
operator|&&
name|pf_out
operator|->
name|FontMatrix
operator|.
name|tx
operator|==
name|newmat
operator|.
name|tx
operator|&&
name|pf_out
operator|->
name|FontMatrix
operator|.
name|ty
operator|==
name|newmat
operator|.
name|ty
condition|)
block|{
operator|*
name|ppfont
operator|=
name|pf_out
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|gs_debug
index|[
literal|'m'
index|]
condition|)
name|dprintf1
argument_list|(
literal|"[m]found font=%lx\n"
argument_list|,
operator|(
name|ulong
operator|)
name|pf_out
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
name|pf_out
operator|=
operator|(
name|gs_font
operator|*
operator|)
call|(
modifier|*
name|pdir
operator|->
name|alloc
call|)
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|gs_font
argument_list|)
argument_list|,
literal|"gs_makefont"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pf_out
condition|)
name|return_error
argument_list|(
name|gs_error_VMerror
argument_list|)
expr_stmt|;
operator|*
name|pf_out
operator|=
operator|*
name|pfont
expr_stmt|;
name|pf_out
operator|->
name|FontMatrix
operator|=
name|newmat
expr_stmt|;
if|if
condition|(
name|pdir
operator|->
name|ssize
operator|==
name|pdir
operator|->
name|smax
condition|)
block|{
comment|/* Must discard a cached scaled font. */
comment|/* Scan for the oldest font if we didn't already. */
if|if
condition|(
operator|!
name|prev
condition|)
for|for
control|(
name|prev
operator|=
name|pdir
operator|->
name|scaled_fonts
init|;
name|prev
operator|->
name|next
operator|!=
literal|0
condition|;
name|prev
operator|=
name|prev
operator|->
name|next
control|)
empty_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|gs_debug
index|[
literal|'m'
index|]
condition|)
name|dprintf1
argument_list|(
literal|"[m]discarding font %lx\n"
argument_list|,
operator|(
name|ulong
operator|)
name|prev
argument_list|)
expr_stmt|;
endif|#
directive|endif
operator|*
name|pdfont
operator|=
name|prev
expr_stmt|;
name|prev
operator|->
name|prev
operator|->
name|next
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|pdir
operator|->
name|ssize
operator|++
expr_stmt|;
name|link_first
argument_list|(
name|pdir
operator|->
name|scaled_fonts
argument_list|,
name|pf_out
argument_list|)
expr_stmt|;
name|pf_out
operator|->
name|base
operator|=
name|pfont
operator|->
name|base
expr_stmt|;
name|pf_out
operator|->
name|dir
operator|=
name|pdir
expr_stmt|;
operator|*
name|ppfont
operator|=
name|pf_out
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|gs_debug
index|[
literal|'m'
index|]
condition|)
name|dprintf1
argument_list|(
literal|"[m]new font=%lx\n"
argument_list|,
operator|(
name|ulong
operator|)
name|pf_out
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* setfont */
end_comment

begin_function
name|int
name|gs_setfont
parameter_list|(
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|gs_font
modifier|*
name|pfont
parameter_list|)
block|{
name|pgs
operator|->
name|font
operator|=
name|pfont
expr_stmt|;
name|pgs
operator|->
name|char_tm_valid
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* currentfont */
end_comment

begin_function
name|gs_font
modifier|*
name|gs_currentfont
parameter_list|(
name|gs_state
modifier|*
name|pgs
parameter_list|)
block|{
return|return
name|pgs
operator|->
name|font
return|;
block|}
end_function

begin_comment
comment|/* cachestatus */
end_comment

begin_function
name|void
name|gs_cachestatus
parameter_list|(
specifier|register
name|gs_font_dir
modifier|*
name|pdir
parameter_list|,
specifier|register
name|uint
name|pstat
index|[
literal|7
index|]
parameter_list|)
block|{
name|pstat
index|[
literal|0
index|]
operator|=
name|pdir
operator|->
name|bsize
expr_stmt|;
name|pstat
index|[
literal|1
index|]
operator|=
name|pdir
operator|->
name|bmax
expr_stmt|;
name|pstat
index|[
literal|2
index|]
operator|=
name|pdir
operator|->
name|msize
expr_stmt|;
name|pstat
index|[
literal|3
index|]
operator|=
name|pdir
operator|->
name|mmax
expr_stmt|;
name|pstat
index|[
literal|4
index|]
operator|=
name|pdir
operator|->
name|csize
expr_stmt|;
name|pstat
index|[
literal|5
index|]
operator|=
name|pdir
operator|->
name|cmax
expr_stmt|;
name|pstat
index|[
literal|6
index|]
operator|=
name|pdir
operator|->
name|upper
expr_stmt|;
block|}
end_function

begin_comment
comment|/* setcachelimit */
end_comment

begin_function
name|int
name|gs_setcachelimit
parameter_list|(
name|gs_font_dir
modifier|*
name|pdir
parameter_list|,
name|uint
name|size
parameter_list|)
block|{
name|pdir
operator|->
name|upper
operator|=
name|size
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setcacheparams */
end_comment

begin_function
name|int
name|gs_setcachelower
parameter_list|(
name|gs_font_dir
modifier|*
name|pdir
parameter_list|,
name|uint
name|size
parameter_list|)
block|{
name|pdir
operator|->
name|lower
operator|=
name|size
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|gs_setcacheupper
parameter_list|(
name|gs_font_dir
modifier|*
name|pdir
parameter_list|,
name|uint
name|size
parameter_list|)
block|{
name|pdir
operator|->
name|upper
operator|=
name|size
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* currentcacheparams */
end_comment

begin_function
name|uint
name|gs_currentcachelower
parameter_list|(
name|gs_font_dir
modifier|*
name|pdir
parameter_list|)
block|{
return|return
name|pdir
operator|->
name|lower
return|;
block|}
end_function

begin_function
name|uint
name|gs_currentcacheupper
parameter_list|(
name|gs_font_dir
modifier|*
name|pdir
parameter_list|)
block|{
return|return
name|pdir
operator|->
name|upper
return|;
block|}
end_function

begin_comment
comment|/* Dummy (ineffective) BuildChar procedure */
end_comment

begin_function
name|int
name|gs_no_build_char_proc
parameter_list|(
name|struct
name|gs_show_enum_s
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|gs_font
modifier|*
name|pfont
parameter_list|,
name|char_code
name|chr
parameter_list|,
name|char
modifier|*
name|data
parameter_list|)
block|{
return|return
literal|1
return|;
comment|/* failure, but not error */
block|}
end_function

begin_comment
comment|/* Purge a font from the font- and character-related caches. */
end_comment

begin_comment
comment|/* This is only used by restore (and, someday, the GC). */
end_comment

begin_function
name|void
name|gs_purge_font_from_caches
parameter_list|(
name|gs_font_dir
modifier|*
name|pdir
parameter_list|,
name|gs_font
modifier|*
name|pfont
parameter_list|)
block|{
comment|/* Purge the font from the scaled font cache. */
name|gs_font
modifier|*
name|pf
init|=
name|pdir
operator|->
name|scaled_fonts
decl_stmt|;
while|while
condition|(
name|pf
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|pf
operator|==
name|pfont
condition|)
block|{
name|pf
operator|=
name|pf
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|pfont
operator|->
name|prev
condition|)
name|pfont
operator|->
name|prev
operator|->
name|next
operator|=
name|pf
expr_stmt|;
else|else
name|pdir
operator|->
name|scaled_fonts
operator|=
name|pf
expr_stmt|;
if|if
condition|(
name|pf
condition|)
name|pf
operator|->
name|prev
operator|=
name|pfont
operator|->
name|prev
expr_stmt|;
name|pdir
operator|->
name|ssize
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pf
operator|->
name|base
operator|==
name|pfont
condition|)
block|{
name|gs_purge_font_from_caches
argument_list|(
name|pdir
argument_list|,
name|pf
operator|->
name|base
argument_list|)
expr_stmt|;
name|pf
operator|=
name|pdir
operator|->
name|scaled_fonts
expr_stmt|;
comment|/* start over */
block|}
else|else
name|pf
operator|=
name|pf
operator|->
name|next
expr_stmt|;
block|}
comment|/* Purge the font from the font/matrix pair cache, */
comment|/* including all cached characters rendered with that font. */
name|gs_purge_font_from_char_caches
argument_list|(
name|pdir
argument_list|,
name|pfont
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


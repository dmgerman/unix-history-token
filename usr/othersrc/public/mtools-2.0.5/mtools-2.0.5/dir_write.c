begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"msdos.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|fd
decl_stmt|,
name|dir_dirty
decl_stmt|,
name|clus_size
decl_stmt|,
name|dir_entries
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|long
name|dir_chain
index|[
name|MAX_DIR_SECS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|unsigned
name|char
modifier|*
name|dir_buf
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Write a directory entry.  A simple cache is used instead of something  * more elaborate.  */
end_comment

begin_function
name|void
name|dir_write
parameter_list|(
name|num
parameter_list|,
name|dir
parameter_list|)
name|int
name|num
decl_stmt|;
name|struct
name|directory
modifier|*
name|dir
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
name|offset
decl_stmt|;
name|char
modifier|*
name|memcpy
parameter_list|()
function_decl|;
name|offset
operator|=
name|dir_buf
operator|+
operator|(
name|num
operator|*
name|MDIR_SIZE
operator|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|offset
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dir
argument_list|,
name|MDIR_SIZE
argument_list|)
expr_stmt|;
name|dir_dirty
operator|=
literal|1
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Write a partially filled directory buffer to disk.  Resets dir_dirty to  * zero.  */
end_comment

begin_function
name|void
name|dir_flush
parameter_list|()
block|{
name|int
name|i
decl_stmt|,
name|length
decl_stmt|;
name|unsigned
name|char
modifier|*
name|offset
decl_stmt|;
name|void
name|disk_write
parameter_list|()
function_decl|;
if|if
condition|(
name|fd
operator|<
literal|0
operator|||
operator|!
name|dir_dirty
condition|)
return|return;
name|length
operator|=
name|dir_entries
operator|/
literal|16
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|offset
operator|=
name|dir_buf
operator|+
operator|(
name|i
operator|*
name|MSECTOR_SIZE
operator|)
expr_stmt|;
name|disk_write
argument_list|(
name|dir_chain
index|[
name|i
index|]
argument_list|,
name|offset
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
block|}
name|dir_dirty
operator|=
literal|0
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Convert a Unix filename to a legal MSDOS name.  Returns a pointer to  * a static area.  Will truncate file and extension names, will  * substitute the letter 'X' for any illegal character in the name.  */
end_comment

begin_function
name|unsigned
name|char
modifier|*
name|dos_name
parameter_list|(
name|filename
parameter_list|,
name|verbose
parameter_list|)
name|char
modifier|*
name|filename
decl_stmt|;
name|int
name|verbose
decl_stmt|;
block|{
specifier|static
name|char
modifier|*
name|dev
index|[
literal|9
index|]
init|=
block|{
literal|"CON"
block|,
literal|"AUX"
block|,
literal|"COM1"
block|,
literal|"COM2"
block|,
literal|"PRN"
block|,
literal|"LPT1"
block|,
literal|"LPT2"
block|,
literal|"LPT3"
block|,
literal|"NUL"
block|}
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
name|buf
index|[
name|MAX_PATH
index|]
decl_stmt|,
modifier|*
name|name
decl_stmt|,
modifier|*
name|ext
decl_stmt|,
modifier|*
name|strcpy
argument_list|()
decl_stmt|,
modifier|*
name|strpbrk
argument_list|()
decl_stmt|,
modifier|*
name|strrchr
argument_list|()
decl_stmt|;
specifier|static
name|unsigned
name|char
name|ans
index|[
literal|13
index|]
decl_stmt|;
name|int
name|dot
decl_stmt|,
name|modified
decl_stmt|,
name|len
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|strcpy
argument_list|(
name|buf
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|name
operator|=
name|buf
expr_stmt|;
comment|/* skip drive letter */
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|&&
name|buf
index|[
literal|1
index|]
operator|==
literal|':'
condition|)
name|name
operator|=
operator|&
name|buf
index|[
literal|2
index|]
expr_stmt|;
comment|/* zap the leading path */
if|if
condition|(
name|s
operator|=
name|strrchr
argument_list|(
name|name
argument_list|,
literal|'/'
argument_list|)
condition|)
name|name
operator|=
name|s
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|strrchr
argument_list|(
name|name
argument_list|,
literal|'\\'
argument_list|)
condition|)
name|name
operator|=
name|s
operator|+
literal|1
expr_stmt|;
name|ext
operator|=
literal|""
expr_stmt|;
name|dot
operator|=
literal|0
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|s
operator|=
name|name
operator|+
name|len
operator|-
name|i
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|==
literal|'.'
operator|&&
operator|!
name|dot
condition|)
block|{
name|dot
operator|=
literal|1
expr_stmt|;
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
name|ext
operator|=
name|s
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|islower
argument_list|(
operator|*
name|s
argument_list|)
condition|)
operator|*
name|s
operator|=
name|toupper
argument_list|(
operator|*
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|name
operator|==
literal|'\0'
condition|)
block|{
name|name
operator|=
literal|"X"
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"\"%s\" Null name component, using \"%s.%s\"\n"
argument_list|,
name|filename
argument_list|,
name|name
argument_list|,
name|ext
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
name|dev
index|[
name|i
index|]
argument_list|)
condition|)
block|{
operator|*
name|name
operator|=
literal|'X'
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"\"%s\" Is a device name, using \"%s.%s\"\n"
argument_list|,
name|filename
argument_list|,
name|name
argument_list|,
name|ext
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|>
literal|8
condition|)
block|{
operator|*
operator|(
name|name
operator|+
literal|8
operator|)
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"\"%s\" Name too long, using, \"%s.%s\"\n"
argument_list|,
name|filename
argument_list|,
name|name
argument_list|,
name|ext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|ext
argument_list|)
operator|>
literal|3
condition|)
block|{
operator|*
operator|(
name|ext
operator|+
literal|3
operator|)
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"\"%s\" Extension too long, using \"%s.%s\"\n"
argument_list|,
name|filename
argument_list|,
name|name
argument_list|,
name|ext
argument_list|)
expr_stmt|;
block|}
name|modified
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|s
operator|=
name|strpbrk
argument_list|(
name|name
argument_list|,
literal|"^+=/[]:',?*\\<>|\". "
argument_list|)
condition|)
block|{
name|modified
operator|++
expr_stmt|;
operator|*
name|s
operator|=
literal|'X'
expr_stmt|;
block|}
while|while
condition|(
name|s
operator|=
name|strpbrk
argument_list|(
name|ext
argument_list|,
literal|"^+=/[]:',?*\\<>|\". "
argument_list|)
condition|)
block|{
name|modified
operator|++
expr_stmt|;
operator|*
name|s
operator|=
literal|'X'
expr_stmt|;
block|}
if|if
condition|(
name|modified
operator|&&
name|verbose
condition|)
name|printf
argument_list|(
literal|"\"%s\" Contains illegal character(s), using \"%s.%s\"\n"
argument_list|,
name|filename
argument_list|,
name|name
argument_list|,
name|ext
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ans
argument_list|,
literal|"%-8.8s%-3.3s"
argument_list|,
name|name
argument_list|,
name|ext
argument_list|)
expr_stmt|;
return|return
operator|(
name|ans
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Make a directory entry.  Builds a directory entry based on the  * name, attribute, starting cluster number, and size.  Returns a pointer  * to a static directory structure.  */
end_comment

begin_function
name|struct
name|directory
modifier|*
name|mk_entry
parameter_list|(
name|filename
parameter_list|,
name|attr
parameter_list|,
name|fat
parameter_list|,
name|size
parameter_list|,
name|date
parameter_list|)
name|unsigned
name|char
modifier|*
name|filename
decl_stmt|;
name|unsigned
name|char
name|attr
decl_stmt|;
name|unsigned
name|int
name|fat
decl_stmt|;
name|long
name|size
decl_stmt|,
name|date
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|strncpy
parameter_list|()
function_decl|;
specifier|static
name|struct
name|directory
name|ndir
decl_stmt|;
name|struct
name|tm
modifier|*
name|now
decl_stmt|,
modifier|*
name|localtime
argument_list|()
decl_stmt|;
name|unsigned
name|char
name|hour
decl_stmt|,
name|min_hi
decl_stmt|,
name|min_low
decl_stmt|,
name|sec
decl_stmt|;
name|unsigned
name|char
name|year
decl_stmt|,
name|month_hi
decl_stmt|,
name|month_low
decl_stmt|,
name|day
decl_stmt|;
name|now
operator|=
name|localtime
argument_list|(
operator|&
name|date
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ndir
operator|.
name|name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|filename
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ndir
operator|.
name|ext
argument_list|,
operator|(
name|char
operator|*
operator|)
name|filename
operator|+
literal|8
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ndir
operator|.
name|attr
operator|=
name|attr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
name|ndir
operator|.
name|reserved
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|hour
operator|=
name|now
operator|->
name|tm_hour
operator|<<
literal|3
expr_stmt|;
name|min_hi
operator|=
name|now
operator|->
name|tm_min
operator|>>
literal|3
expr_stmt|;
name|min_low
operator|=
name|now
operator|->
name|tm_min
operator|<<
literal|5
expr_stmt|;
name|sec
operator|=
name|now
operator|->
name|tm_sec
operator|/
literal|2
expr_stmt|;
name|ndir
operator|.
name|time
index|[
literal|1
index|]
operator|=
name|hour
operator|+
name|min_hi
expr_stmt|;
name|ndir
operator|.
name|time
index|[
literal|0
index|]
operator|=
name|min_low
operator|+
name|sec
expr_stmt|;
name|year
operator|=
operator|(
name|now
operator|->
name|tm_year
operator|-
literal|80
operator|)
operator|<<
literal|1
expr_stmt|;
name|month_hi
operator|=
operator|(
name|now
operator|->
name|tm_mon
operator|+
literal|1
operator|)
operator|>>
literal|3
expr_stmt|;
name|month_low
operator|=
operator|(
name|now
operator|->
name|tm_mon
operator|+
literal|1
operator|)
operator|<<
literal|5
expr_stmt|;
name|day
operator|=
name|now
operator|->
name|tm_mday
expr_stmt|;
name|ndir
operator|.
name|date
index|[
literal|1
index|]
operator|=
name|year
operator|+
name|month_hi
expr_stmt|;
name|ndir
operator|.
name|date
index|[
literal|0
index|]
operator|=
name|month_low
operator|+
name|day
expr_stmt|;
name|ndir
operator|.
name|start
index|[
literal|1
index|]
operator|=
name|fat
operator|/
literal|0x100
expr_stmt|;
name|ndir
operator|.
name|start
index|[
literal|0
index|]
operator|=
name|fat
operator|%
literal|0x100
expr_stmt|;
name|ndir
operator|.
name|size
index|[
literal|3
index|]
operator|=
name|size
operator|/
literal|0x1000000L
expr_stmt|;
name|ndir
operator|.
name|size
index|[
literal|2
index|]
operator|=
operator|(
name|size
operator|%
literal|0x1000000L
operator|)
operator|/
literal|0x10000L
expr_stmt|;
name|ndir
operator|.
name|size
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|size
operator|%
literal|0x1000000L
operator|)
operator|%
literal|0x10000L
operator|)
operator|/
literal|0x100
expr_stmt|;
name|ndir
operator|.
name|size
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|size
operator|%
literal|0x1000000L
operator|)
operator|%
literal|0x10000L
operator|)
operator|%
literal|0x100
expr_stmt|;
return|return
operator|(
operator|&
name|ndir
operator|)
return|;
block|}
end_function

end_unit


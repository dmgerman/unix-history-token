begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* interfaces.c - MIB realization of the Interfaces group */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/snmp/RCS/interfaces.c,v 7.12 91/02/22 09:43:23 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/snmp/RCS/interfaces.c,v 7.12 91/02/22 09:43:23 mrose Interim $  *  * Contributed by NYSERNet Inc.  This work was partially supported by the  * U.S. Defense Advanced Research Projects Agency and the Rome Air Development  * Center of the U.S. Air Force Systems Command under contract number  * F30602-88-C-0016.  *  *  * $Log:	interfaces.c,v $  * Revision 7.12  91/02/22  09:43:23  mrose  * Interim 6.8  *   * Revision 7.11  91/01/11  15:34:19  mrose  * sets  *   * Revision 7.10  91/01/07  12:40:46  mrose  * update  *   * Revision 7.9  90/12/18  10:13:28  mrose  * update  *   * Revision 7.8  90/10/23  20:39:57  mrose  * update  *   * Revision 7.7  90/10/23  20:36:16  mrose  * update  *   * Revision 7.6  90/03/24  10:54:02  mrose  * update  *   * Revision 7.5  90/02/27  18:49:35  mrose  * unix stuff  *   * Revision 7.4  90/02/23  17:47:38  mrose  * update  *   * Revision 7.3  90/02/17  10:38:10  mrose  * smux  *   * Revision 7.2  90/01/27  08:21:47  mrose  * touch-up  *   * Revision 7.1  90/01/11  18:34:04  mrose  * real-sync  *   * Revision 7.0  89/11/23  22:23:03  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"mib.h"
end_include

begin_include
include|#
directive|include
file|"interfaces.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|TYPE_MIN
value|1
end_define

begin_comment
comment|/* ifType */
end_comment

begin_define
define|#
directive|define
name|TYPE_OTHER
value|1
end_define

begin_define
define|#
directive|define
name|TYPE_ETHER
value|6
end_define

begin_define
define|#
directive|define
name|TYPE_P10
value|12
end_define

begin_define
define|#
directive|define
name|TYPE_P80
value|13
end_define

begin_define
define|#
directive|define
name|TYPE_MAX
value|28
end_define

begin_define
define|#
directive|define
name|ADMIN_MIN
value|1
end_define

begin_comment
comment|/* ifAdminStatus */
end_comment

begin_define
define|#
directive|define
name|ADMIN_MAX
value|3
end_define

begin_define
define|#
directive|define
name|OPER_UP
value|1
end_define

begin_comment
comment|/* ifOperStatus */
end_comment

begin_define
define|#
directive|define
name|OPER_DOWN
value|2
end_define

begin_comment
comment|/* we assume that all interfaces are present at startup time and that they    don't move around in memory... */
end_comment

begin_decl_stmt
name|int
name|ifNumber
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|interface
modifier|*
name|ifs
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|address
modifier|*
name|afs
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|address
modifier|*
name|afs_inet
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_decl_stmt
name|struct
name|address
modifier|*
name|afs_iso
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|flush_if_cache
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|ifIndex
value|0
end_define

begin_define
define|#
directive|define
name|ifDescr
value|1
end_define

begin_define
define|#
directive|define
name|ifType
value|2
end_define

begin_comment
comment|/* SEMI IMPLEMENTED */
end_comment

begin_define
define|#
directive|define
name|ifMtu
value|3
end_define

begin_define
define|#
directive|define
name|ifSpeed
value|4
end_define

begin_comment
comment|/* SEMI IMPLEMENTED */
end_comment

begin_define
define|#
directive|define
name|ifPhysAddress
value|5
end_define

begin_define
define|#
directive|define
name|ifAdminStatus
value|6
end_define

begin_define
define|#
directive|define
name|ifOperStatus
value|7
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_define
define|#
directive|define
name|ifLastChange
value|8
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_define
define|#
directive|define
name|ifInOctets
value|9
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ifInUcastPkts
value|10
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_define
define|#
directive|define
name|ifInNUcastPkts
value|11
end_define

begin_define
define|#
directive|define
name|ifInDiscards
value|12
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ifInErrors
value|13
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_define
define|#
directive|define
name|ifInUnknownProtos
value|14
end_define

begin_define
define|#
directive|define
name|ifOutOctets
value|15
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ifOutUcastPkts
value|16
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_define
define|#
directive|define
name|ifOutNUcastPkts
value|17
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ifOutDiscards
value|18
end_define

begin_define
define|#
directive|define
name|ifOutErrors
value|19
end_define

begin_define
define|#
directive|define
name|ifOutQLen
value|20
end_define

begin_define
define|#
directive|define
name|ifSpecific
value|21
end_define

begin_function
specifier|static
name|int
name|o_interfaces
parameter_list|(
name|oi
parameter_list|,
name|v
parameter_list|,
name|offset
parameter_list|)
name|OI
name|oi
decl_stmt|;
specifier|register
name|struct
name|type_SNMP_VarBind
modifier|*
name|v
decl_stmt|;
name|int
name|offset
decl_stmt|;
block|{
name|int
name|ifnum
decl_stmt|,
name|ifvar
decl_stmt|;
specifier|register
name|struct
name|interface
modifier|*
name|is
decl_stmt|;
specifier|register
name|struct
name|ifnet
modifier|*
name|ifn
decl_stmt|;
specifier|register
name|OID
name|oid
init|=
name|oi
operator|->
name|oi_name
decl_stmt|;
specifier|register
name|OT
name|ot
init|=
name|oi
operator|->
name|oi_type
decl_stmt|;
ifdef|#
directive|ifdef
name|ifLastChange
specifier|static
name|int
name|lastq
init|=
operator|-
literal|1
decl_stmt|;
specifier|static
name|integer
name|diff
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|get_interfaces
argument_list|(
name|offset
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|generr
argument_list|(
name|offset
argument_list|)
return|;
name|ifvar
operator|=
operator|(
name|int
operator|)
name|ot
operator|->
name|ot_info
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
name|type_SNMP_PDUs_get__request
case|:
if|if
condition|(
name|oid
operator|->
name|oid_nelem
operator|!=
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
operator|+
literal|1
condition|)
return|return
name|int_SNMP_error__status_noSuchName
return|;
name|ifnum
operator|=
name|oid
operator|->
name|oid_elements
index|[
name|oid
operator|->
name|oid_nelem
operator|-
literal|1
index|]
expr_stmt|;
for|for
control|(
name|is
operator|=
name|ifs
init|;
name|is
condition|;
name|is
operator|=
name|is
operator|->
name|ifn_next
control|)
if|if
condition|(
name|is
operator|->
name|ifn_index
operator|==
name|ifnum
condition|)
break|break;
if|if
condition|(
name|is
operator|==
name|NULL
operator|||
operator|!
name|is
operator|->
name|ifn_ready
condition|)
return|return
name|int_SNMP_error__status_noSuchName
return|;
break|break;
case|case
name|type_SNMP_PDUs_get__next__request
case|:
if|if
condition|(
name|oid
operator|->
name|oid_nelem
operator|==
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
condition|)
block|{
name|OID
name|new
decl_stmt|;
for|for
control|(
name|is
operator|=
name|ifs
init|;
name|is
condition|;
name|is
operator|=
name|is
operator|->
name|ifn_next
control|)
if|if
condition|(
name|is
operator|->
name|ifn_ready
condition|)
break|break;
if|if
condition|(
operator|!
name|is
condition|)
return|return
name|NOTOK
return|;
name|ifnum
operator|=
name|is
operator|->
name|ifn_index
expr_stmt|;
if|if
condition|(
operator|(
name|new
operator|=
name|oid_extend
argument_list|(
name|oid
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
return|return
name|NOTOK
return|;
name|new
operator|->
name|oid_elements
index|[
name|new
operator|->
name|oid_nelem
operator|-
literal|1
index|]
operator|=
name|ifnum
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
condition|)
name|free_SNMP_ObjectName
argument_list|(
name|v
operator|->
name|name
argument_list|)
expr_stmt|;
name|v
operator|->
name|name
operator|=
name|new
expr_stmt|;
block|}
else|else
block|{
name|int
name|i
init|=
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
decl_stmt|;
specifier|register
name|struct
name|interface
modifier|*
name|iz
decl_stmt|;
if|if
condition|(
operator|(
name|ifnum
operator|=
name|oid
operator|->
name|oid_elements
index|[
name|i
index|]
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|is
operator|=
name|ifs
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|is
operator|->
name|ifn_ready
condition|)
goto|goto
name|stuff_ifnum
goto|;
name|ifnum
operator|=
literal|1
expr_stmt|;
block|}
for|for
control|(
name|is
operator|=
name|iz
operator|=
name|ifs
init|;
name|is
condition|;
name|is
operator|=
name|is
operator|->
name|ifn_next
control|)
if|if
condition|(
operator|(
name|iz
operator|=
name|is
operator|)
operator|->
name|ifn_index
operator|==
name|ifnum
condition|)
break|break;
for|for
control|(
name|is
operator|=
name|iz
operator|->
name|ifn_next
init|;
name|is
condition|;
name|is
operator|=
name|is
operator|->
name|ifn_next
control|)
if|if
condition|(
name|is
operator|->
name|ifn_ready
condition|)
break|break;
if|if
condition|(
operator|!
name|is
condition|)
return|return
name|NOTOK
return|;
name|stuff_ifnum
label|:
empty_stmt|;
name|ifnum
operator|=
name|is
operator|->
name|ifn_index
expr_stmt|;
name|oid
operator|->
name|oid_elements
index|[
name|i
index|]
operator|=
name|ifnum
expr_stmt|;
name|oid
operator|->
name|oid_nelem
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
break|break;
default|default:
return|return
name|int_SNMP_error__status_genErr
return|;
block|}
name|ifn
operator|=
operator|&
name|is
operator|->
name|ifn_interface
operator|.
name|ac_if
expr_stmt|;
switch|switch
condition|(
name|ifvar
condition|)
block|{
case|case
name|ifIndex
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|is
operator|->
name|ifn_index
argument_list|)
return|;
case|case
name|ifDescr
case|:
return|return
name|o_string
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|is
operator|->
name|ifn_descr
argument_list|,
name|strlen
argument_list|(
name|is
operator|->
name|ifn_descr
argument_list|)
argument_list|)
return|;
case|case
name|ifType
case|:
if|if
condition|(
name|is
operator|->
name|ifn_type
operator|<
name|TYPE_MIN
operator|||
name|is
operator|->
name|ifn_type
operator|>
name|TYPE_MAX
condition|)
name|is
operator|->
name|ifn_type
operator|=
name|TYPE_OTHER
expr_stmt|;
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|is
operator|->
name|ifn_type
argument_list|)
return|;
case|case
name|ifMtu
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_mtu
argument_list|)
return|;
case|case
name|ifSpeed
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|is
operator|->
name|ifn_speed
argument_list|)
return|;
case|case
name|ifPhysAddress
case|:
ifdef|#
directive|ifdef
name|NEW_AT
return|return
name|o_string
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
operator|(
name|char
operator|*
operator|)
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
argument_list|,
sizeof|sizeof
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
argument_list|)
return|;
else|#
directive|else
return|return
name|o_string
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
operator|(
name|char
operator|*
operator|)
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
operator|.
name|ether_addr_octet
argument_list|,
sizeof|sizeof
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
operator|.
name|ether_addr_octet
argument_list|)
return|;
endif|#
directive|endif
case|case
name|ifAdminStatus
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|is
operator|->
name|ifn_admin
argument_list|)
return|;
case|case
name|ifOperStatus
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|?
name|OPER_UP
else|:
name|OPER_DOWN
argument_list|)
return|;
ifdef|#
directive|ifdef
name|ifLastChange
case|case
name|ifLastChange
case|:
if|if
condition|(
operator|(
name|diff
operator|=
operator|(
name|ifn
operator|->
name|if_lastchange
operator|.
name|tv_sec
operator|-
name|my_boottime
operator|.
name|tv_sec
operator|)
operator|*
literal|100
operator|+
operator|(
operator|(
name|ifn
operator|->
name|if_lastchange
operator|.
name|tv_usec
operator|-
name|my_boottime
operator|.
name|tv_usec
operator|)
operator|/
literal|10000
operator|)
operator|)
operator|<
literal|0
condition|)
name|diff
operator|=
literal|0
expr_stmt|;
return|return
name|o_number
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|diff
argument_list|)
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ifInOctets
case|case
name|ifInOctets
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_ibytes
argument_list|)
return|;
endif|#
directive|endif
case|case
name|ifInUcastPkts
case|:
ifndef|#
directive|ifndef
name|BSD44
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_ipackets
argument_list|)
return|;
else|#
directive|else
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_ipackets
operator|-
name|ifn
operator|->
name|if_imcasts
argument_list|)
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ifInNUcastPkts
case|case
name|ifInNUcastPkts
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_imcasts
argument_list|)
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ifInDiscards
case|case
name|ifInDiscards
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_iqdrops
argument_list|)
return|;
endif|#
directive|endif
case|case
name|ifInErrors
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_ierrors
argument_list|)
return|;
ifdef|#
directive|ifdef
name|ifInUnknownProtos
case|case
name|ifInUnknownProtos
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_noproto
argument_list|)
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ifOutOctets
case|case
name|ifOutOctets
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_obytes
argument_list|)
return|;
endif|#
directive|endif
case|case
name|ifOutUcastPkts
case|:
ifndef|#
directive|ifndef
name|BSD44
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_opackets
argument_list|)
return|;
else|#
directive|else
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_opackets
operator|-
name|ifn
operator|->
name|if_omcasts
argument_list|)
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ifOutNUcastPkts
case|case
name|ifOutNUcastPkts
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_omcasts
argument_list|)
return|;
endif|#
directive|endif
case|case
name|ifOutDiscards
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_snd
operator|.
name|ifq_drops
argument_list|)
return|;
case|case
name|ifOutErrors
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_oerrors
argument_list|)
return|;
case|case
name|ifOutQLen
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ifn
operator|->
name|if_snd
operator|.
name|ifq_len
argument_list|)
return|;
case|case
name|ifSpecific
case|:
return|return
name|o_specific
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
operator|(
name|caddr_t
operator|)
name|nullSpecific
argument_list|)
return|;
default|default:
return|return
name|int_SNMP_error__status_noSuchName
return|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|set_interface
argument_list|(
argument|name
argument_list|,
argument|ava
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|ava
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|u_long
name|l
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|struct
name|interface
modifier|*
name|is
decl_stmt|;
for|for
control|(
name|is
operator|=
name|ifs
init|;
name|is
condition|;
name|is
operator|=
name|is
operator|->
name|ifn_next
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|is
operator|->
name|ifn_descr
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
operator|!
name|is
condition|)
block|{
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"no such interface as \"%s\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|cp
operator|=
name|index
argument_list|(
name|ava
argument_list|,
literal|'='
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
operator|*
name|cp
operator|++
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|lexequ
argument_list|(
name|ava
argument_list|,
literal|"ifType"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sscanf
argument_list|(
name|cp
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|i
argument_list|)
operator|!=
literal|1
operator|||
name|i
operator|<
name|TYPE_MIN
operator|||
name|i
operator|>
name|TYPE_MAX
condition|)
block|{
name|malformed
label|:
empty_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"malformed attribute \"%s=%s\""
argument_list|,
name|ava
argument_list|,
name|cp
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|is
operator|->
name|ifn_type
operator|=
name|i
condition|)
block|{
case|case
name|TYPE_ETHER
case|:
case|case
name|TYPE_P10
case|:
name|is
operator|->
name|ifn_speed
operator|=
literal|10000000
expr_stmt|;
break|break;
case|case
name|TYPE_P80
case|:
name|is
operator|->
name|ifn_speed
operator|=
literal|80000000
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return;
block|}
if|if
condition|(
name|lexequ
argument_list|(
name|ava
argument_list|,
literal|"ifSpeed"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sscanf
argument_list|(
name|cp
argument_list|,
literal|"%U"
argument_list|,
operator|&
name|l
argument_list|)
operator|!=
literal|1
condition|)
goto|goto
name|malformed
goto|;
name|is
operator|->
name|ifn_speed
operator|=
name|l
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|lexequ
argument_list|(
name|ava
argument_list|,
literal|"ifAdminStatus"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sscanf
argument_list|(
name|cp
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|i
argument_list|)
operator|!=
literal|1
operator|||
name|i
operator|<
name|ADMIN_MIN
operator|||
name|i
operator|>
name|ADMIN_MAX
condition|)
goto|goto
name|malformed
goto|;
name|is
operator|->
name|ifn_admin
operator|=
name|i
expr_stmt|;
return|return;
block|}
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"unknown attribute \"%s=%s\""
argument_list|,
name|ava
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|init_interfaces
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifnet
decl_stmt|;
specifier|register
name|OT
name|ot
decl_stmt|;
specifier|register
name|struct
name|interface
modifier|*
name|is
decl_stmt|,
modifier|*
modifier|*
name|ifp
decl_stmt|;
name|struct
name|nlist
name|nzs
decl_stmt|;
specifier|register
name|struct
name|nlist
modifier|*
name|nz
init|=
operator|&
name|nzs
decl_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nl
operator|+
name|N_IFNET
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifnet
argument_list|,
sizeof|sizeof
name|ifnet
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
specifier|register
name|struct
name|interface
modifier|*
name|ip
decl_stmt|;
name|disabled
label|:
empty_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"interfaces group disabled!"
argument_list|)
expr_stmt|;
for|for
control|(
name|is
operator|=
name|ifs
init|;
name|is
condition|;
name|is
operator|=
name|ip
control|)
block|{
name|ip
operator|=
name|is
operator|->
name|ifn_next
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|is
argument_list|)
expr_stmt|;
block|}
name|ifs
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
name|ifp
operator|=
operator|&
name|ifs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ifnet
condition|;
name|i
operator|++
control|)
block|{
specifier|register
name|struct
name|ifnet
modifier|*
name|ifn
decl_stmt|;
if|if
condition|(
operator|(
name|is
operator|=
operator|(
expr|struct
name|interface
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|is
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|is
operator|->
name|ifn_index
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|is
operator|->
name|ifn_indexmask
operator|=
literal|1
operator|<<
name|i
expr_stmt|;
name|ifn
operator|=
operator|&
name|is
operator|->
name|ifn_interface
operator|.
name|ac_if
expr_stmt|;
name|is
operator|->
name|ifn_offset
operator|=
operator|(
name|unsigned
name|long
operator|)
name|ifnet
expr_stmt|;
name|nz
operator|->
name|n_name
operator|=
literal|"struct ifnet"
operator|,
name|nz
operator|->
name|n_value
operator|=
name|is
operator|->
name|ifn_offset
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nz
argument_list|,
operator|(
name|caddr_t
operator|)
name|ifn
argument_list|,
sizeof|sizeof
name|is
operator|->
name|ifn_interface
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|disabled
goto|;
name|ifnet
operator|=
name|ifn
operator|->
name|if_next
expr_stmt|;
name|nz
operator|->
name|n_name
operator|=
literal|"if_name"
operator|,
name|nz
operator|->
name|n_value
operator|=
operator|(
name|unsigned
name|long
operator|)
name|ifn
operator|->
name|if_name
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nz
argument_list|,
operator|(
name|caddr_t
operator|)
name|is
operator|->
name|ifn_descr
argument_list|,
sizeof|sizeof
name|is
operator|->
name|ifn_descr
operator|-
literal|1
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|disabled
goto|;
name|is
operator|->
name|ifn_descr
index|[
sizeof|sizeof
name|is
operator|->
name|ifn_descr
operator|-
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|is
operator|->
name|ifn_descr
operator|+
name|strlen
argument_list|(
name|is
operator|->
name|ifn_descr
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|ifn
operator|->
name|if_unit
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD44
switch|switch
condition|(
name|is
operator|->
name|ifn_type
operator|=
name|ifn
operator|->
name|if_type
condition|)
block|{
case|case
name|IFT_ETHER
case|:
case|case
name|IFT_P10
case|:
name|is
operator|->
name|ifn_speed
operator|=
literal|10000000
expr_stmt|;
break|break;
case|case
name|IFT_P80
case|:
name|is
operator|->
name|ifn_speed
operator|=
literal|80000000
expr_stmt|;
break|break;
default|default:
break|break;
block|}
endif|#
directive|endif
if|if
condition|(
name|is
operator|->
name|ifn_type
operator|!=
name|TYPE_ETHER
condition|)
ifdef|#
directive|ifdef
name|NEW_AT
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
argument_list|,
sizeof|sizeof
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
argument_list|)
expr_stmt|;
else|#
directive|else
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
operator|.
name|ether_addr_octet
argument_list|,
sizeof|sizeof
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
operator|.
name|ether_addr_octet
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|is
operator|->
name|ifn_admin
operator|=
name|OPER_UP
expr_stmt|;
operator|*
name|ifp
operator|=
name|is
operator|,
name|ifp
operator|=
operator|&
name|is
operator|->
name|ifn_next
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"add interface %d: %s 0x%x"
argument_list|,
name|is
operator|->
name|ifn_index
argument_list|,
name|is
operator|->
name|ifn_descr
argument_list|,
name|is
operator|->
name|ifn_offset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifNumber"
argument_list|)
condition|)
block|{
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_generic
expr_stmt|;
if|if
condition|(
operator|(
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|integer
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|integer
operator|*
operator|)
name|ot
operator|->
name|ot_info
operator|)
operator|=
name|ifNumber
operator|=
name|i
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|get_interfaces
argument_list|(
name|type_SNMP_PDUs_get__request
argument_list|)
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifIndex"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifIndex
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifDescr"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifDescr
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifType"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifType
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifMtu"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifMtu
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifSpeed"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifSpeed
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifPhysAddress"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifPhysAddress
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifAdminStatus"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifAdminStatus
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifOperStatus"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifOperStatus
expr_stmt|;
ifdef|#
directive|ifdef
name|ifLastChange
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifLastChange"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifLastChange
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ifInOctets
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifInOctets"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifInOctets
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifInUcastPkts"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifInUcastPkts
expr_stmt|;
ifdef|#
directive|ifdef
name|ifInNUcastPkts
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifInNUcastPkts"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifInNUcastPkts
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ifInDiscards
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifInDiscards"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifInDiscards
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifInErrors"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifInErrors
expr_stmt|;
ifdef|#
directive|ifdef
name|ifInUnknownProtos
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifInUnknownProtos"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifInUnknownProtos
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ifOutOctets
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifOutOctets"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifOutOctets
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifOutUcastPkts"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifOutUcastPkts
expr_stmt|;
ifdef|#
directive|ifdef
name|ifOutNUcastPkts
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifOutNUcastPkts"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifOutNUcastPkts
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifOutDiscards"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifOutDiscards
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifOutErrors"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifOutErrors
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifOutQLen"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifOutQLen
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifSpecific"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_interfaces
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|ifSpecific
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|adr_compar
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
specifier|register
name|struct
name|address
modifier|*
modifier|*
name|a
decl_stmt|,
decl|*
modifier|*
name|b
decl_stmt|;
end_function

begin_block
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
operator|(
operator|*
name|a
operator|)
operator|->
name|adr_address
operator|.
name|sa
operator|.
name|sa_family
operator|-
operator|(
operator|*
name|b
operator|)
operator|->
name|adr_address
operator|.
name|sa
operator|.
name|sa_family
operator|)
condition|)
return|return
operator|(
name|i
operator|>
literal|0
condition|?
literal|1
else|:
operator|-
literal|1
operator|)
return|;
return|return
name|elem_cmp
argument_list|(
operator|(
operator|*
name|a
operator|)
operator|->
name|adr_instance
argument_list|,
operator|(
operator|*
name|a
operator|)
operator|->
name|adr_insize
argument_list|,
operator|(
operator|*
name|b
operator|)
operator|->
name|adr_instance
argument_list|,
operator|(
operator|*
name|b
operator|)
operator|->
name|adr_insize
argument_list|)
return|;
block|}
end_block

begin_function
name|int
name|get_interfaces
parameter_list|(
name|offset
parameter_list|)
name|int
name|offset
decl_stmt|;
block|{
name|int
name|adrNumber
init|=
literal|0
decl_stmt|;
specifier|register
name|OT
name|ot
decl_stmt|;
specifier|register
name|struct
name|interface
modifier|*
name|is
decl_stmt|;
specifier|register
name|struct
name|address
modifier|*
name|as
decl_stmt|,
modifier|*
name|ap
decl_stmt|,
modifier|*
modifier|*
name|base
decl_stmt|,
modifier|*
modifier|*
name|afe
decl_stmt|,
modifier|*
modifier|*
name|afp
decl_stmt|;
specifier|static
name|int
name|first_time
init|=
literal|1
decl_stmt|;
specifier|static
name|int
name|lastq
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|quantum
operator|==
name|lastq
condition|)
return|return
name|OK
return|;
if|if
condition|(
operator|!
name|flush_if_cache
operator|&&
name|offset
operator|==
name|type_SNMP_PDUs_get__next__request
operator|&&
name|quantum
operator|==
name|lastq
operator|+
literal|1
condition|)
block|{
comment|/* XXX: caching! */
name|lastq
operator|=
name|quantum
expr_stmt|;
return|return
name|OK
return|;
block|}
name|lastq
operator|=
name|quantum
operator|,
name|flush_if_cache
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|as
operator|=
name|afs
init|;
name|as
condition|;
name|as
operator|=
name|ap
control|)
block|{
name|ap
operator|=
name|as
operator|->
name|adr_next
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|as
argument_list|)
expr_stmt|;
block|}
name|afs
operator|=
name|afs_inet
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD44
name|afs_iso
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
name|afp
operator|=
operator|&
name|afs
expr_stmt|;
for|for
control|(
name|is
operator|=
name|ifs
init|;
name|is
condition|;
name|is
operator|=
name|is
operator|->
name|ifn_next
control|)
block|{
name|struct
name|arpcom
name|ifns
decl_stmt|;
specifier|register
name|struct
name|ifnet
modifier|*
name|ifn
init|=
operator|&
name|ifns
operator|.
name|ac_if
decl_stmt|;
ifdef|#
directive|ifdef
name|BSD43
name|struct
name|ifaddr
name|ifaddr
decl_stmt|;
specifier|register
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
ifdef|#
directive|ifdef
name|BSD44
name|union
name|sockaddr_un
name|ifsocka
decl_stmt|,
name|ifsockb
decl_stmt|;
endif|#
directive|endif
name|union
name|sockaddr_un
name|ifsockc
decl_stmt|;
specifier|register
name|union
name|sockaddr_un
modifier|*
name|ia
decl_stmt|,
modifier|*
name|ib
decl_stmt|;
specifier|register
name|union
name|sockaddr_un
modifier|*
name|ic
init|=
operator|&
name|ifsockc
decl_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|BSD44
name|struct
name|ifreq
name|ifreq
decl_stmt|;
endif|#
directive|endif
name|struct
name|nlist
name|nzs
decl_stmt|;
specifier|register
name|struct
name|nlist
modifier|*
name|nz
init|=
operator|&
name|nzs
decl_stmt|;
name|nz
operator|->
name|n_name
operator|=
literal|"struct ifnet"
operator|,
name|nz
operator|->
name|n_value
operator|=
name|is
operator|->
name|ifn_offset
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nz
argument_list|,
operator|(
name|caddr_t
operator|)
name|ifn
argument_list|,
sizeof|sizeof
name|ifns
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
ifndef|#
directive|ifndef
name|BSD43
if|if
condition|(
name|ifn
operator|->
name|if_addr
operator|.
name|sa_family
operator|==
name|AF_UNSPEC
condition|)
continue|continue;
if|if
condition|(
name|nd
operator|!=
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ifreq
operator|.
name|ifr_name
argument_list|,
name|is
operator|->
name|ifn_descr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|nd
argument_list|,
name|SIOCGIFNETMASK
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ifreq
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
literal|"SIOCGIFNETMASK on %s"
argument_list|,
name|is
operator|->
name|ifn_descr
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifreq
argument_list|,
sizeof|sizeof
name|ifreq
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifreq
argument_list|,
sizeof|sizeof
name|ifreq
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifn
operator|->
name|if_addr
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|sx
init|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|ifreq
operator|.
name|ifr_addr
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sy
init|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|ifn
operator|->
name|if_addr
decl_stmt|;
if|if
condition|(
name|sx
operator|->
name|sin_addr
operator|.
name|s_addr
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|IN_CLASSA
argument_list|(
name|sy
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
condition|)
name|sx
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|IN_CLASSA_NET
expr_stmt|;
elseif|else
if|if
condition|(
name|IN_CLASSB
argument_list|(
name|sy
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
condition|)
name|sx
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|IN_CLASSB_NET
expr_stmt|;
else|else
name|sx
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|IN_CLASSC_NET
expr_stmt|;
block|}
block|}
if|if
condition|(
name|as
operator|=
name|find_address
argument_list|(
operator|(
expr|union
name|sockaddr_un
operator|*
operator|)
operator|&
name|ifn
operator|->
name|if_addr
argument_list|)
condition|)
name|as
operator|->
name|adr_indexmask
operator||=
name|is
operator|->
name|ifn_indexmask
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
name|as
operator|=
operator|(
expr|struct
name|address
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|as
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
operator|*
name|afp
operator|=
name|as
operator|,
name|afp
operator|=
operator|&
name|as
operator|->
name|adr_next
operator|,
name|adrNumber
operator|++
expr_stmt|;
name|as
operator|->
name|adr_address
operator|.
name|sa
operator|=
name|ifn
operator|->
name|if_addr
expr_stmt|;
comment|/* struct copy */
if|if
condition|(
name|ifn
operator|->
name|if_addr
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
name|as
operator|->
name|adr_broadaddr
operator|.
name|sa
operator|=
name|ifn
operator|->
name|if_broadaddr
expr_stmt|;
comment|/*   .. */
name|as
operator|->
name|adr_netmask
operator|.
name|sa
operator|=
name|ifreq
operator|.
name|ifr_addr
expr_stmt|;
comment|/*   .. */
name|as
operator|->
name|adr_indexmask
operator|=
name|is
operator|->
name|ifn_indexmask
expr_stmt|;
switch|switch
condition|(
name|ifn
operator|->
name|if_addr
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|as
operator|->
name|adr_insize
operator|=
name|ipaddr2oid
argument_list|(
name|as
operator|->
name|adr_instance
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|ifn
operator|->
name|if_addr
operator|)
operator|->
name|sin_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|afs_inet
operator|==
name|NULL
condition|)
comment|/* needed for find_address */
name|afs_inet
operator|=
name|as
expr_stmt|;
break|break;
default|default:
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|as
operator|->
name|adr_instance
argument_list|,
sizeof|sizeof
name|as
operator|->
name|adr_instance
argument_list|)
expr_stmt|;
name|as
operator|->
name|adr_insize
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
else|#
directive|else
ifndef|#
directive|ifndef
name|BSD44
name|ia
operator|=
operator|(
expr|union
name|sockaddr_un
operator|*
operator|)
operator|&
name|ifaddr
operator|.
name|ifa_addr
operator|,
name|ib
operator|=
operator|(
expr|union
name|sockaddr_un
operator|*
operator|)
operator|&
name|ifaddr
operator|.
name|ifa_broadaddr
expr_stmt|;
else|#
directive|else
name|ia
operator|=
operator|&
name|ifsocka
operator|,
name|ib
operator|=
operator|&
name|ifsockb
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|ifa
operator|=
name|ifn
operator|->
name|if_addrlist
init|;
name|ifa
condition|;
name|ifa
operator|=
name|ifaddr
operator|.
name|ifa_next
control|)
block|{
name|nz
operator|->
name|n_name
operator|=
literal|"struct ifaddr"
operator|,
name|nz
operator|->
name|n_value
operator|=
operator|(
name|unsigned
name|long
operator|)
name|ifa
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nz
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifaddr
argument_list|,
sizeof|sizeof
name|ifaddr
argument_list|)
operator|==
name|NOTOK
condition|)
continue|continue;
ifndef|#
directive|ifndef
name|BSD44
if|if
condition|(
name|ia
operator|->
name|sa
operator|.
name|sa_family
operator|==
name|AF_UNSPEC
condition|)
continue|continue;
if|if
condition|(
name|nd
operator|!=
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ifreq
operator|.
name|ifr_name
argument_list|,
name|is
operator|->
name|ifn_descr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|nd
argument_list|,
name|SIOCGIFNETMASK
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ifreq
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
literal|"SIOCGIFNETMASK on %s"
argument_list|,
name|is
operator|->
name|ifn_descr
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ic
argument_list|,
sizeof|sizeof
expr|*
name|ic
argument_list|)
expr_stmt|;
block|}
name|ic
operator|->
name|sa
operator|=
name|ifreq
operator|.
name|ifr_addr
expr_stmt|;
comment|/* struct copy */
block|}
else|else
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ic
argument_list|,
sizeof|sizeof
expr|*
name|ic
argument_list|)
expr_stmt|;
else|#
directive|else
name|nz
operator|->
name|n_name
operator|=
literal|"union sockaddr_un"
operator|,
name|nz
operator|->
name|n_value
operator|=
operator|(
name|unsigned
name|long
operator|)
name|ifaddr
operator|.
name|ifa_addr
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nz
argument_list|,
operator|(
name|caddr_t
operator|)
name|ia
argument_list|,
sizeof|sizeof
expr|*
name|ia
argument_list|)
operator|==
name|NOTOK
condition|)
continue|continue;
if|if
condition|(
name|ia
operator|->
name|sa
operator|.
name|sa_family
operator|==
name|AF_UNSPEC
condition|)
continue|continue;
if|if
condition|(
name|ia
operator|->
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|nz
operator|->
name|n_value
operator|=
operator|(
name|unsigned
name|long
operator|)
name|ifaddr
operator|.
name|ifa_broadaddr
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nz
argument_list|,
operator|(
name|caddr_t
operator|)
name|ib
argument_list|,
sizeof|sizeof
expr|*
name|ib
argument_list|)
operator|==
name|NOTOK
condition|)
continue|continue;
block|}
name|nz
operator|->
name|n_value
operator|=
operator|(
name|unsigned
name|long
operator|)
name|ifaddr
operator|.
name|ifa_netmask
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nz
argument_list|,
operator|(
name|caddr_t
operator|)
name|ic
argument_list|,
sizeof|sizeof
expr|*
name|ic
argument_list|)
operator|==
name|NOTOK
condition|)
continue|continue;
endif|#
directive|endif
if|if
condition|(
name|ia
operator|->
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
operator|&&
name|ic
operator|->
name|un_in
operator|.
name|sin_addr
operator|.
name|s_addr
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|IN_CLASSA
argument_list|(
name|ia
operator|->
name|un_in
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|)
condition|)
name|ic
operator|->
name|un_in
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|IN_CLASSA_NET
expr_stmt|;
elseif|else
if|if
condition|(
name|IN_CLASSB
argument_list|(
name|ia
operator|->
name|un_in
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|)
condition|)
name|ic
operator|->
name|un_in
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|IN_CLASSB_NET
expr_stmt|;
else|else
name|ic
operator|->
name|un_in
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|IN_CLASSC_NET
expr_stmt|;
block|}
if|if
condition|(
name|as
operator|=
name|find_address
argument_list|(
name|ia
argument_list|)
condition|)
name|as
operator|->
name|adr_indexmask
operator||=
name|is
operator|->
name|ifn_indexmask
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
name|as
operator|=
operator|(
expr|struct
name|address
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|as
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
operator|*
name|afp
operator|=
name|as
operator|,
name|afp
operator|=
operator|&
name|as
operator|->
name|adr_next
operator|,
name|adrNumber
operator|++
expr_stmt|;
name|as
operator|->
name|adr_address
operator|=
operator|*
name|ia
expr_stmt|;
comment|/* struct copy */
if|if
condition|(
name|ia
operator|->
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
name|as
operator|->
name|adr_broadaddr
operator|=
operator|*
name|ib
expr_stmt|;
comment|/* struct copy */
name|as
operator|->
name|adr_netmask
operator|=
operator|*
name|ic
expr_stmt|;
comment|/*   .. */
name|as
operator|->
name|adr_indexmask
operator|=
name|is
operator|->
name|ifn_indexmask
expr_stmt|;
switch|switch
condition|(
name|ia
operator|->
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|as
operator|->
name|adr_insize
operator|=
name|ipaddr2oid
argument_list|(
name|as
operator|->
name|adr_instance
argument_list|,
operator|&
name|ia
operator|->
name|un_in
operator|.
name|sin_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|afs_inet
operator|==
name|NULL
condition|)
comment|/* needed for find_address */
name|afs_inet
operator|=
name|as
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|BSD44
case|case
name|AF_ISO
case|:
name|as
operator|->
name|adr_insize
operator|=
name|clnpaddr2oid
argument_list|(
name|as
operator|->
name|adr_instance
argument_list|,
operator|&
name|ia
operator|->
name|un_iso
operator|.
name|siso_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|afs_iso
operator|==
name|NULL
condition|)
comment|/* needed for find_address */
name|afs_iso
operator|=
name|as
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|as
operator|->
name|adr_instance
argument_list|,
sizeof|sizeof
name|as
operator|->
name|adr_instance
argument_list|)
expr_stmt|;
name|as
operator|->
name|adr_insize
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
block|}
endif|#
directive|endif
name|is
operator|->
name|ifn_interface
operator|=
name|ifns
expr_stmt|;
comment|/* struct copy */
if|if
condition|(
name|is
operator|->
name|ifn_type
operator|!=
name|TYPE_ETHER
condition|)
ifdef|#
directive|ifdef
name|NEW_AT
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
argument_list|,
sizeof|sizeof
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
argument_list|)
expr_stmt|;
else|#
directive|else
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
operator|.
name|ether_addr_octet
argument_list|,
sizeof|sizeof
name|is
operator|->
name|ifn_interface
operator|.
name|ac_enaddr
operator|.
name|ether_addr_octet
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|ifNumber
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|is
operator|=
name|ifs
init|;
name|is
condition|;
name|is
operator|=
name|is
operator|->
name|ifn_next
control|)
block|{
name|is
operator|->
name|ifn_ready
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|as
operator|=
name|afs
init|;
name|as
condition|;
name|as
operator|=
name|as
operator|->
name|adr_next
control|)
if|if
condition|(
name|as
operator|->
name|adr_indexmask
operator|&
name|is
operator|->
name|ifn_indexmask
condition|)
break|break;
if|if
condition|(
name|as
condition|)
name|ifNumber
operator|+=
operator|(
name|is
operator|->
name|ifn_ready
operator|=
literal|1
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"ifNumber"
argument_list|)
condition|)
operator|*
operator|(
operator|(
name|integer
operator|*
operator|)
name|ot
operator|->
name|ot_info
operator|)
operator|=
name|ifNumber
expr_stmt|;
if|if
condition|(
name|debug
operator|&&
name|first_time
condition|)
block|{
name|first_time
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|as
operator|=
name|afs
init|;
name|as
condition|;
name|as
operator|=
name|as
operator|->
name|adr_next
control|)
block|{
name|OIDentifier
name|oids
decl_stmt|;
name|oids
operator|.
name|oid_elements
operator|=
name|as
operator|->
name|adr_instance
expr_stmt|;
name|oids
operator|.
name|oid_nelem
operator|=
name|as
operator|->
name|adr_insize
expr_stmt|;
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"add address: %d/%s with mask 0x%x"
argument_list|,
name|as
operator|->
name|adr_address
operator|.
name|sa
operator|.
name|sa_family
argument_list|,
name|sprintoid
argument_list|(
operator|&
name|oids
argument_list|)
argument_list|,
name|as
operator|->
name|adr_indexmask
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|adrNumber
operator|<=
literal|1
condition|)
return|return
name|OK
return|;
if|if
condition|(
operator|(
name|base
operator|=
operator|(
expr|struct
name|address
operator|*
operator|*
operator|)
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|adrNumber
operator|*
sizeof|sizeof
expr|*
name|base
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|afe
operator|=
name|base
expr_stmt|;
for|for
control|(
name|as
operator|=
name|afs
init|;
name|as
condition|;
name|as
operator|=
name|as
operator|->
name|adr_next
control|)
operator|*
name|afe
operator|++
operator|=
name|as
expr_stmt|;
name|qsort
argument_list|(
operator|(
name|char
operator|*
operator|)
name|base
argument_list|,
name|adrNumber
argument_list|,
sizeof|sizeof
expr|*
name|base
argument_list|,
name|adr_compar
argument_list|)
expr_stmt|;
name|afp
operator|=
name|base
expr_stmt|;
name|as
operator|=
name|afs
operator|=
operator|*
name|afp
operator|++
expr_stmt|;
name|afs_inet
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD44
name|afs_iso
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
name|afp
operator|<
name|afe
condition|)
block|{
switch|switch
condition|(
name|as
operator|->
name|adr_address
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|afs_inet
operator|==
name|NULL
condition|)
name|afs_inet
operator|=
name|as
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|BSD44
case|case
name|AF_ISO
case|:
if|if
condition|(
name|afs_iso
operator|==
name|NULL
condition|)
name|afs_iso
operator|=
name|as
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
name|as
operator|->
name|adr_next
operator|=
operator|*
name|afp
expr_stmt|;
name|as
operator|=
operator|*
name|afp
operator|++
expr_stmt|;
block|}
switch|switch
condition|(
name|as
operator|->
name|adr_address
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|afs_inet
operator|==
name|NULL
condition|)
name|afs_inet
operator|=
name|as
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|BSD44
case|case
name|AF_ISO
case|:
if|if
condition|(
name|afs_iso
operator|==
name|NULL
condition|)
name|afs_iso
operator|=
name|as
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
name|as
operator|->
name|adr_next
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|base
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|struct
name|address
modifier|*
name|find_address
parameter_list|(
name|addr
parameter_list|)
specifier|register
name|union
name|sockaddr_un
modifier|*
name|addr
decl_stmt|;
block|{
specifier|register
name|struct
name|address
modifier|*
name|as
decl_stmt|;
specifier|register
name|struct
name|in_addr
modifier|*
name|in
decl_stmt|;
ifdef|#
directive|ifdef
name|BSD44
specifier|register
name|struct
name|iso_addr
modifier|*
name|iso
decl_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|addr
operator|->
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|in
operator|=
operator|&
name|addr
operator|->
name|un_in
operator|.
name|sin_addr
expr_stmt|;
for|for
control|(
name|as
operator|=
name|afs_inet
init|;
name|as
condition|;
name|as
operator|=
name|as
operator|->
name|adr_next
control|)
if|if
condition|(
name|as
operator|->
name|adr_address
operator|.
name|sa
operator|.
name|sa_family
operator|!=
name|AF_INET
condition|)
break|break;
elseif|else
if|if
condition|(
name|bcmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|in
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|as
operator|->
name|adr_address
operator|.
name|un_in
operator|.
name|sin_addr
argument_list|,
sizeof|sizeof
expr|*
name|in
argument_list|)
operator|==
literal|0
condition|)
return|return
name|as
return|;
break|break;
ifdef|#
directive|ifdef
name|BSD44
case|case
name|AF_ISO
case|:
name|iso
operator|=
operator|&
name|addr
operator|->
name|un_iso
operator|.
name|siso_addr
expr_stmt|;
for|for
control|(
name|as
operator|=
name|afs_iso
init|;
name|as
condition|;
name|as
operator|=
name|as
operator|->
name|adr_next
control|)
if|if
condition|(
name|as
operator|->
name|adr_address
operator|.
name|sa
operator|.
name|sa_family
operator|!=
name|AF_ISO
condition|)
break|break;
elseif|else
if|if
condition|(
name|bcmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|iso
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|as
operator|->
name|adr_address
operator|.
name|un_iso
operator|.
name|siso_addr
argument_list|,
sizeof|sizeof
expr|*
name|iso
argument_list|)
operator|==
literal|0
condition|)
return|return
name|as
return|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|struct
name|address
modifier|*
name|get_addrent
parameter_list|(
name|ip
parameter_list|,
name|len
parameter_list|,
name|head
parameter_list|,
name|isnext
parameter_list|)
specifier|register
name|unsigned
name|int
modifier|*
name|ip
decl_stmt|;
name|int
name|len
decl_stmt|;
name|struct
name|address
modifier|*
name|head
decl_stmt|;
name|int
name|isnext
decl_stmt|;
block|{
name|int
name|family
decl_stmt|;
specifier|register
name|struct
name|address
modifier|*
name|as
decl_stmt|;
if|if
condition|(
name|head
condition|)
name|family
operator|=
name|head
operator|->
name|adr_address
operator|.
name|sa
operator|.
name|sa_family
expr_stmt|;
for|for
control|(
name|as
operator|=
name|head
init|;
name|as
condition|;
name|as
operator|=
name|as
operator|->
name|adr_next
control|)
if|if
condition|(
name|as
operator|->
name|adr_address
operator|.
name|sa
operator|.
name|sa_family
operator|!=
name|family
condition|)
break|break;
else|else
switch|switch
condition|(
name|elem_cmp
argument_list|(
name|as
operator|->
name|adr_instance
argument_list|,
name|as
operator|->
name|adr_insize
argument_list|,
name|ip
argument_list|,
name|len
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
operator|!
name|isnext
condition|)
return|return
name|as
return|;
if|if
condition|(
operator|(
name|as
operator|=
name|as
operator|->
name|adr_next
operator|)
operator|==
name|NULL
operator|||
name|as
operator|->
name|adr_address
operator|.
name|sa
operator|.
name|sa_family
operator|!=
name|family
condition|)
goto|goto
name|out
goto|;
comment|/* else fall... */
case|case
literal|1
case|:
return|return
operator|(
name|isnext
condition|?
name|as
else|:
name|NULL
operator|)
return|;
block|}
name|out
label|:
empty_stmt|;
name|flush_if_cache
operator|=
literal|1
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* udp.c - MIB realization of the UDP group */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/snmp/RCS/udp.c,v 7.7 91/02/22 09:44:50 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/snmp/RCS/udp.c,v 7.7 91/02/22 09:44:50 mrose Interim $  *  * Contributed by NYSERNet Inc.  This work was partially supported by the  * U.S. Defense Advanced Research Projects Agency and the Rome Air Development  * Center of the U.S. Air Force Systems Command under contract number  * F30602-88-C-0016.  *  *  * $Log:	udp.c,v $  * Revision 7.7  91/02/22  09:44:50  mrose  * Interim 6.8  *   * Revision 7.6  91/01/08  12:48:51  mrose  * update  *   * Revision 7.5  90/12/18  10:14:19  mrose  * update  *   * Revision 7.4  90/10/02  09:55:03  mrose  * normalize again  *   * Revision 7.3  90/04/23  00:08:20  mrose  * touch-up  *   * Revision 7.2  90/04/18  08:52:09  mrose  * oid_normalize  *   * Revision 7.1  90/02/27  18:50:10  mrose  * unix stuff  *   * Revision 7.0  89/11/23  22:23:38  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"mib.h"
end_include

begin_include
include|#
directive|include
file|"internet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp_var.h>
end_include

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
specifier|static
name|struct
name|udpstat
name|udpstat
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_define
define|#
directive|define
name|udpInDatagrams
value|1
end_define

begin_define
define|#
directive|define
name|udpNoPorts
value|2
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|udpInErrors
value|3
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_define
define|#
directive|define
name|udpOutDatagrams
value|4
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|o_udp
parameter_list|(
name|oi
parameter_list|,
name|v
parameter_list|,
name|offset
parameter_list|)
name|OI
name|oi
decl_stmt|;
specifier|register
name|struct
name|type_SNMP_VarBind
modifier|*
name|v
decl_stmt|;
name|int
name|offset
decl_stmt|;
block|{
name|int
name|ifvar
decl_stmt|;
specifier|register
name|struct
name|udpstat
modifier|*
name|udps
init|=
operator|&
name|udpstat
decl_stmt|;
specifier|register
name|OID
name|oid
init|=
name|oi
operator|->
name|oi_name
decl_stmt|;
specifier|register
name|OT
name|ot
init|=
name|oi
operator|->
name|oi_type
decl_stmt|;
specifier|static
name|int
name|lastq
init|=
operator|-
literal|1
decl_stmt|;
name|ifvar
operator|=
operator|(
name|int
operator|)
name|ot
operator|->
name|ot_info
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
name|type_SNMP_PDUs_get__request
case|:
if|if
condition|(
name|oid
operator|->
name|oid_nelem
operator|!=
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
operator|+
literal|1
operator|||
name|oid
operator|->
name|oid_elements
index|[
name|oid
operator|->
name|oid_nelem
operator|-
literal|1
index|]
operator|!=
literal|0
condition|)
return|return
name|int_SNMP_error__status_noSuchName
return|;
break|break;
case|case
name|type_SNMP_PDUs_get__next__request
case|:
if|if
condition|(
name|oid
operator|->
name|oid_nelem
operator|==
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
condition|)
block|{
name|OID
name|new
decl_stmt|;
if|if
condition|(
operator|(
name|new
operator|=
name|oid_extend
argument_list|(
name|oid
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
return|return
name|NOTOK
return|;
name|new
operator|->
name|oid_elements
index|[
name|new
operator|->
name|oid_nelem
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
condition|)
name|free_SNMP_ObjectName
argument_list|(
name|v
operator|->
name|name
argument_list|)
expr_stmt|;
name|v
operator|->
name|name
operator|=
name|new
expr_stmt|;
block|}
else|else
return|return
name|NOTOK
return|;
break|break;
default|default:
return|return
name|int_SNMP_error__status_genErr
return|;
block|}
if|if
condition|(
name|quantum
operator|!=
name|lastq
condition|)
block|{
name|lastq
operator|=
name|quantum
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nl
operator|+
name|N_UDPSTAT
argument_list|,
operator|(
name|caddr_t
operator|)
name|udps
argument_list|,
sizeof|sizeof
expr|*
name|udps
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|generr
argument_list|(
name|offset
argument_list|)
return|;
block|}
switch|switch
condition|(
name|ifvar
condition|)
block|{
ifdef|#
directive|ifdef
name|udpInDatagrams
case|case
name|udpInDatagrams
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|udps
operator|->
name|udps_ipackets
argument_list|)
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|udpNoPorts
case|case
name|udpNoPorts
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|udps
operator|->
name|udps_noport
argument_list|)
return|;
endif|#
directive|endif
case|case
name|udpInErrors
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|udps
operator|->
name|udps_hdrops
operator|+
name|udps
operator|->
name|udps_badsum
operator|+
name|udps
operator|->
name|udps_badlen
argument_list|)
return|;
ifdef|#
directive|ifdef
name|udpOutDatagrams
case|case
name|udpOutDatagrams
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|udps
operator|->
name|udps_opackets
argument_list|)
return|;
endif|#
directive|endif
default|default:
return|return
name|int_SNMP_error__status_noSuchName
return|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_struct
struct|struct
name|udptab
block|{
define|#
directive|define
name|UT_SIZE
value|5
comment|/* object instance */
name|unsigned
name|int
name|ut_instance
index|[
name|UT_SIZE
index|]
decl_stmt|;
name|struct
name|inpcb
name|ut_pcb
decl_stmt|;
comment|/* protocol control block */
name|struct
name|socket
name|ut_socb
decl_stmt|;
comment|/* socket info */
name|struct
name|udptab
modifier|*
name|ut_next
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|udptab
modifier|*
name|uts
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|flush_udp_cache
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
name|struct
name|udptab
modifier|*
name|get_udpent
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|udpLocalAddress
value|0
end_define

begin_define
define|#
directive|define
name|udpLocalPort
value|1
end_define

begin_define
define|#
directive|define
name|unixUdpRemAddress
value|2
end_define

begin_define
define|#
directive|define
name|unixUdpRemPort
value|3
end_define

begin_define
define|#
directive|define
name|unixUdpSendQ
value|4
end_define

begin_define
define|#
directive|define
name|unixUdpRecvQ
value|5
end_define

begin_function
specifier|static
name|int
name|o_udp_listen
parameter_list|(
name|oi
parameter_list|,
name|v
parameter_list|,
name|offset
parameter_list|)
name|OI
name|oi
decl_stmt|;
specifier|register
name|struct
name|type_SNMP_VarBind
modifier|*
name|v
decl_stmt|;
name|int
name|offset
decl_stmt|;
block|{
name|int
name|ifvar
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|unsigned
name|int
modifier|*
name|ip
decl_stmt|,
modifier|*
name|jp
decl_stmt|;
specifier|register
name|struct
name|udptab
modifier|*
name|ut
decl_stmt|;
name|struct
name|sockaddr_in
name|netaddr
decl_stmt|;
specifier|register
name|OID
name|oid
init|=
name|oi
operator|->
name|oi_name
decl_stmt|;
name|OID
name|new
decl_stmt|;
specifier|register
name|OT
name|ot
init|=
name|oi
operator|->
name|oi_type
decl_stmt|;
if|if
condition|(
name|get_listeners
argument_list|(
name|offset
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|generr
argument_list|(
name|offset
argument_list|)
return|;
name|ifvar
operator|=
operator|(
name|int
operator|)
name|ot
operator|->
name|ot_info
expr_stmt|;
switch|switch
condition|(
name|offset
condition|)
block|{
case|case
name|type_SNMP_PDUs_get__request
case|:
if|if
condition|(
name|oid
operator|->
name|oid_nelem
operator|!=
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
operator|+
name|UT_SIZE
condition|)
return|return
name|int_SNMP_error__status_noSuchName
return|;
if|if
condition|(
operator|(
name|ut
operator|=
name|get_udpent
argument_list|(
name|oid
operator|->
name|oid_elements
operator|+
name|oid
operator|->
name|oid_nelem
operator|-
name|UT_SIZE
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|int_SNMP_error__status_noSuchName
return|;
break|break;
case|case
name|type_SNMP_PDUs_get__next__request
case|:
if|if
condition|(
operator|(
name|i
operator|=
name|oid
operator|->
name|oid_nelem
operator|-
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
operator|)
operator|!=
literal|0
operator|&&
name|i
operator|<
name|UT_SIZE
condition|)
block|{
for|for
control|(
name|jp
operator|=
operator|(
name|ip
operator|=
name|oid
operator|->
name|oid_elements
operator|+
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
operator|-
literal|1
operator|)
operator|+
name|i
init|;
name|jp
operator|>
name|ip
condition|;
name|jp
operator|--
control|)
if|if
condition|(
operator|*
name|jp
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|jp
operator|==
name|ip
condition|)
name|oid
operator|->
name|oid_nelem
operator|=
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
name|new
operator|=
name|oid_normalize
argument_list|(
name|oid
argument_list|,
name|UT_SIZE
operator|-
name|i
argument_list|,
literal|65536
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|v
operator|->
name|name
condition|)
name|free_SNMP_ObjectName
argument_list|(
name|v
operator|->
name|name
argument_list|)
expr_stmt|;
name|v
operator|->
name|name
operator|=
name|oid
operator|=
name|new
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|i
operator|>
name|UT_SIZE
condition|)
name|oid
operator|->
name|oid_nelem
operator|=
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
operator|+
name|UT_SIZE
expr_stmt|;
if|if
condition|(
name|oid
operator|->
name|oid_nelem
operator|==
name|ot
operator|->
name|ot_name
operator|->
name|oid_nelem
condition|)
block|{
if|if
condition|(
operator|(
name|ut
operator|=
name|uts
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
operator|(
name|new
operator|=
name|oid_extend
argument_list|(
name|oid
argument_list|,
name|UT_SIZE
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
return|return
name|NOTOK
return|;
name|ip
operator|=
name|new
operator|->
name|oid_elements
operator|+
name|new
operator|->
name|oid_nelem
operator|-
name|UT_SIZE
expr_stmt|;
name|jp
operator|=
name|ut
operator|->
name|ut_instance
expr_stmt|;
for|for
control|(
name|i
operator|=
name|UT_SIZE
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
operator|*
name|ip
operator|++
operator|=
operator|*
name|jp
operator|++
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
condition|)
name|free_SNMP_ObjectName
argument_list|(
name|v
operator|->
name|name
argument_list|)
expr_stmt|;
name|v
operator|->
name|name
operator|=
name|new
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ut
operator|=
name|get_udpent
argument_list|(
name|ip
operator|=
name|oid
operator|->
name|oid_elements
operator|+
name|oid
operator|->
name|oid_nelem
operator|-
name|UT_SIZE
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
name|jp
operator|=
name|ut
operator|->
name|ut_instance
expr_stmt|;
for|for
control|(
name|i
operator|=
name|UT_SIZE
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
operator|*
name|ip
operator|++
operator|=
operator|*
name|jp
operator|++
expr_stmt|;
block|}
break|break;
default|default:
return|return
name|int_SNMP_error__status_genErr
return|;
block|}
switch|switch
condition|(
name|ifvar
condition|)
block|{
case|case
name|udpLocalAddress
case|:
name|netaddr
operator|.
name|sin_addr
operator|=
name|ut
operator|->
name|ut_pcb
operator|.
name|inp_laddr
expr_stmt|;
comment|/* struct copy */
return|return
name|o_ipaddr
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
operator|&
name|netaddr
argument_list|)
return|;
case|case
name|udpLocalPort
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ntohs
argument_list|(
name|ut
operator|->
name|ut_pcb
operator|.
name|inp_lport
argument_list|)
operator|&
literal|0xffff
argument_list|)
return|;
case|case
name|unixUdpRemAddress
case|:
name|netaddr
operator|.
name|sin_addr
operator|=
name|ut
operator|->
name|ut_pcb
operator|.
name|inp_faddr
expr_stmt|;
comment|/* struct copy */
return|return
name|o_ipaddr
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
operator|&
name|netaddr
argument_list|)
return|;
case|case
name|unixUdpRemPort
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ntohs
argument_list|(
name|ut
operator|->
name|ut_pcb
operator|.
name|inp_fport
argument_list|)
operator|&
literal|0xffff
argument_list|)
return|;
case|case
name|unixUdpSendQ
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ut
operator|->
name|ut_socb
operator|.
name|so_snd
operator|.
name|sb_cc
argument_list|)
return|;
case|case
name|unixUdpRecvQ
case|:
return|return
name|o_integer
argument_list|(
name|oi
argument_list|,
name|v
argument_list|,
name|ut
operator|->
name|ut_socb
operator|.
name|so_rcv
operator|.
name|sb_cc
argument_list|)
return|;
default|default:
return|return
name|int_SNMP_error__status_noSuchName
return|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|ut_compar
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
name|struct
name|udptab
modifier|*
modifier|*
name|a
decl_stmt|,
decl|*
modifier|*
name|b
decl_stmt|;
end_function

begin_block
block|{
return|return
name|elem_cmp
argument_list|(
operator|(
operator|*
name|a
operator|)
operator|->
name|ut_instance
argument_list|,
name|UT_SIZE
argument_list|,
operator|(
operator|*
name|b
operator|)
operator|->
name|ut_instance
argument_list|,
name|UT_SIZE
argument_list|)
return|;
block|}
end_block

begin_function
specifier|static
name|int
name|get_listeners
parameter_list|(
name|offset
parameter_list|)
name|int
name|offset
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|unsigned
name|int
modifier|*
name|cp
decl_stmt|;
specifier|register
name|struct
name|udptab
modifier|*
name|us
decl_stmt|,
modifier|*
name|up
decl_stmt|,
modifier|*
modifier|*
name|usp
decl_stmt|;
specifier|register
name|struct
name|inpcb
modifier|*
name|ip
decl_stmt|;
name|struct
name|inpcb
modifier|*
name|head
decl_stmt|,
name|udb
decl_stmt|,
name|zdb
decl_stmt|;
name|struct
name|nlist
name|nzs
decl_stmt|;
specifier|register
name|struct
name|nlist
modifier|*
name|nz
init|=
operator|&
name|nzs
decl_stmt|;
specifier|static
name|int
name|first_time
init|=
literal|1
decl_stmt|;
specifier|static
name|int
name|lastq
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|quantum
operator|==
name|lastq
condition|)
return|return
name|OK
return|;
if|if
condition|(
operator|!
name|flush_udp_cache
operator|&&
name|offset
operator|==
name|type_SNMP_PDUs_get__next__request
operator|&&
name|quantum
operator|==
name|lastq
operator|+
literal|1
condition|)
block|{
comment|/* XXX: caching! */
name|lastq
operator|=
name|quantum
expr_stmt|;
return|return
name|OK
return|;
block|}
name|lastq
operator|=
name|quantum
operator|,
name|flush_udp_cache
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|us
operator|=
name|uts
init|;
name|us
condition|;
name|us
operator|=
name|up
control|)
block|{
name|up
operator|=
name|us
operator|->
name|ut_next
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|us
argument_list|)
expr_stmt|;
block|}
name|uts
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nl
operator|+
name|N_UDB
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udb
argument_list|,
sizeof|sizeof
name|udb
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
name|head
operator|=
operator|(
expr|struct
name|inpcb
operator|*
operator|)
name|nl
index|[
name|N_UDB
index|]
operator|.
name|n_value
expr_stmt|;
name|usp
operator|=
operator|&
name|uts
operator|,
name|i
operator|=
literal|0
expr_stmt|;
name|ip
operator|=
operator|&
name|udb
expr_stmt|;
while|while
condition|(
name|ip
operator|->
name|inp_next
operator|!=
name|head
condition|)
block|{
specifier|register
name|struct
name|udptab
modifier|*
name|uz
decl_stmt|;
name|OIDentifier
name|oids
decl_stmt|;
if|if
condition|(
operator|(
name|us
operator|=
operator|(
expr|struct
name|udptab
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|us
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|nz
operator|->
name|n_name
operator|=
literal|"struct inpcb"
operator|,
name|nz
operator|->
name|n_value
operator|=
operator|(
name|unsigned
name|long
operator|)
name|ip
operator|->
name|inp_next
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nz
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|us
operator|->
name|ut_pcb
argument_list|,
sizeof|sizeof
name|us
operator|->
name|ut_pcb
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
name|ip
operator|=
operator|&
name|us
operator|->
name|ut_pcb
expr_stmt|;
name|nz
operator|->
name|n_name
operator|=
literal|"struct socket"
operator|,
name|nz
operator|->
name|n_value
operator|=
operator|(
name|unsigned
name|long
operator|)
name|ip
operator|->
name|inp_socket
expr_stmt|;
if|if
condition|(
name|getkmem
argument_list|(
name|nz
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|us
operator|->
name|ut_socb
argument_list|,
sizeof|sizeof
name|us
operator|->
name|ut_socb
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
name|cp
operator|=
name|us
operator|->
name|ut_instance
expr_stmt|;
name|cp
operator|+=
name|ipaddr2oid
argument_list|(
name|cp
argument_list|,
operator|&
name|ip
operator|->
name|inp_laddr
argument_list|)
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|ntohs
argument_list|(
name|ip
operator|->
name|inp_lport
argument_list|)
operator|&
literal|0xffff
expr_stmt|;
for|for
control|(
name|uz
operator|=
name|uts
init|;
name|uz
condition|;
name|uz
operator|=
name|uz
operator|->
name|ut_next
control|)
if|if
condition|(
name|elem_cmp
argument_list|(
name|uz
operator|->
name|ut_instance
argument_list|,
name|UT_SIZE
argument_list|,
name|us
operator|->
name|ut_instance
argument_list|,
name|UT_SIZE
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|uz
condition|)
block|{
if|if
condition|(
name|first_time
condition|)
block|{
name|oids
operator|.
name|oid_elements
operator|=
name|us
operator|->
name|ut_instance
expr_stmt|;
name|oids
operator|.
name|oid_nelem
operator|=
name|UT_SIZE
expr_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"duplicate listeners: %s"
argument_list|,
name|sprintoid
argument_list|(
operator|&
name|oids
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|*
operator|(
name|ip
operator|=
operator|&
name|zdb
operator|)
operator|=
name|us
operator|->
name|ut_pcb
expr_stmt|;
comment|/* struct copy */
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|us
argument_list|)
expr_stmt|;
continue|continue;
block|}
operator|*
name|usp
operator|=
name|us
operator|,
name|usp
operator|=
operator|&
name|us
operator|->
name|ut_next
operator|,
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|debug
operator|&&
name|first_time
condition|)
block|{
name|oids
operator|.
name|oid_elements
operator|=
name|us
operator|->
name|ut_instance
expr_stmt|;
name|oids
operator|.
name|oid_nelem
operator|=
name|UT_SIZE
expr_stmt|;
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"add listener: %s"
argument_list|,
name|sprintoid
argument_list|(
operator|&
name|oids
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|first_time
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|1
condition|)
block|{
specifier|register
name|struct
name|udptab
modifier|*
modifier|*
name|base
decl_stmt|,
modifier|*
modifier|*
name|use
decl_stmt|;
if|if
condition|(
operator|(
name|base
operator|=
operator|(
expr|struct
name|udptab
operator|*
operator|*
operator|)
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|i
operator|*
sizeof|sizeof
expr|*
name|base
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|use
operator|=
name|base
expr_stmt|;
for|for
control|(
name|us
operator|=
name|uts
init|;
name|us
condition|;
name|us
operator|=
name|us
operator|->
name|ut_next
control|)
operator|*
name|use
operator|++
operator|=
name|us
expr_stmt|;
name|qsort
argument_list|(
operator|(
name|char
operator|*
operator|)
name|base
argument_list|,
name|i
argument_list|,
sizeof|sizeof
expr|*
name|base
argument_list|,
name|ut_compar
argument_list|)
expr_stmt|;
name|usp
operator|=
name|base
expr_stmt|;
name|us
operator|=
name|uts
operator|=
operator|*
name|usp
operator|++
expr_stmt|;
while|while
condition|(
name|usp
operator|<
name|use
condition|)
block|{
name|us
operator|->
name|ut_next
operator|=
operator|*
name|usp
expr_stmt|;
name|us
operator|=
operator|*
name|usp
operator|++
expr_stmt|;
block|}
name|us
operator|->
name|ut_next
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|base
argument_list|)
expr_stmt|;
block|}
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|struct
name|udptab
modifier|*
name|get_udpent
parameter_list|(
name|ip
parameter_list|,
name|isnext
parameter_list|)
specifier|register
name|unsigned
name|int
modifier|*
name|ip
decl_stmt|;
name|int
name|isnext
decl_stmt|;
block|{
specifier|register
name|struct
name|udptab
modifier|*
name|ut
decl_stmt|;
for|for
control|(
name|ut
operator|=
name|uts
init|;
name|ut
condition|;
name|ut
operator|=
name|ut
operator|->
name|ut_next
control|)
switch|switch
condition|(
name|elem_cmp
argument_list|(
name|ut
operator|->
name|ut_instance
argument_list|,
name|UT_SIZE
argument_list|,
name|ip
argument_list|,
name|UT_SIZE
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
operator|!
name|isnext
condition|)
return|return
name|ut
return|;
if|if
condition|(
operator|(
name|ut
operator|=
name|ut
operator|->
name|ut_next
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
comment|/* else fall... */
case|case
literal|1
case|:
return|return
operator|(
name|isnext
condition|?
name|ut
else|:
name|NULL
operator|)
return|;
block|}
name|out
label|:
empty_stmt|;
name|flush_udp_cache
operator|=
literal|1
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|init_udp
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|OT
name|ot
decl_stmt|;
ifdef|#
directive|ifdef
name|udpInDatagrams
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"udpInDatagrams"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_udp
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|udpInDatagrams
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|udpNoPorts
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"udpNoPorts"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_udp
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|udpNoPorts
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"udpInErrors"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_udp
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|udpInErrors
expr_stmt|;
ifdef|#
directive|ifdef
name|udpOutDatagrams
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"udpOutDatagrams"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_udp
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|udpOutDatagrams
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"udpLocalAddress"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_udp_listen
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|udpLocalAddress
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"udpLocalPort"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_udp_listen
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|udpLocalPort
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"unixUdpRemAddress"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_udp_listen
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|unixUdpRemAddress
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"unixUdpRemPort"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_udp_listen
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|unixUdpRemPort
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"unixUdpSendQ"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_udp_listen
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|unixUdpSendQ
expr_stmt|;
if|if
condition|(
name|ot
operator|=
name|text2obj
argument_list|(
literal|"unixUdpRecvQ"
argument_list|)
condition|)
name|ot
operator|->
name|ot_getfnx
operator|=
name|o_udp_listen
operator|,
name|ot
operator|->
name|ot_info
operator|=
operator|(
name|caddr_t
operator|)
name|unixUdpRecvQ
expr_stmt|;
block|}
end_block

end_unit


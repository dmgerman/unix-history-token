begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* rtf.c - RT-file transfer utility -- initiator */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/others/rtf/RCS/rtf.c,v 7.2 91/02/22 09:34:16 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/others/rtf/RCS/rtf.c,v 7.2 91/02/22 09:34:16 mrose Interim $  *  *  * $Log:	rtf.c,v $  * Revision 7.2  91/02/22  09:34:16  mrose  * Interim 6.8  *   * Revision 7.1  90/07/01  21:04:45  mrose  * pepsy  *   * Revision 7.0  89/11/23  22:10:45  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|"RTF-types.h"
end_include

begin_include
include|#
directive|include
file|"rtf.h"
end_include

begin_include
include|#
directive|include
file|"isoservent.h"
end_include

begin_comment
comment|/*
comment|DATA */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|myname
init|=
literal|"rtf"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|myprovider
init|=
literal|"rtsap"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|myentity
init|=
literal|"file transfer"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|host
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|user
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|password
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|source
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|destination
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|turn
init|=
name|NOTOK
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|fd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|downtrans
argument_list|()
decl_stmt|,
name|uptrans
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|MAIN */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|envp
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|,
decl|*
modifier|*
name|envp
decl_stmt|;
end_function

begin_block
block|{
name|int
name|result
decl_stmt|,
name|sd
decl_stmt|;
name|char
modifier|*
name|file
decl_stmt|;
specifier|register
name|struct
name|isoservent
modifier|*
name|is
decl_stmt|;
name|struct
name|SSAPaddr
modifier|*
name|sa
decl_stmt|;
name|struct
name|RtSAPaddr
name|rtzs
decl_stmt|;
specifier|register
name|struct
name|RtSAPaddr
modifier|*
name|rtz
init|=
operator|&
name|rtzs
decl_stmt|;
name|struct
name|RtSAPconnect
name|rtcs
decl_stmt|;
specifier|register
name|struct
name|RtSAPconnect
modifier|*
name|rtc
init|=
operator|&
name|rtcs
decl_stmt|;
name|struct
name|RtSAPindication
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPindication
modifier|*
name|rti
init|=
operator|&
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rta
init|=
operator|&
name|rti
operator|->
name|rti_abort
decl_stmt|;
name|PE
name|pe
decl_stmt|;
name|struct
name|type_RTF_Request
name|reqs
decl_stmt|;
specifier|register
name|struct
name|type_RTF_Request
modifier|*
name|req
init|=
operator|&
name|reqs
decl_stmt|;
name|arginit
argument_list|(
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|turn
operator|==
name|RTS_INITIATOR
condition|)
block|{
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|source
argument_list|,
name|O_RDONLY
argument_list|,
literal|0x00
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|source
argument_list|,
literal|"unable to open"
argument_list|)
expr_stmt|;
name|file
operator|=
name|destination
expr_stmt|;
block|}
else|else
name|file
operator|=
name|source
expr_stmt|;
if|if
condition|(
operator|(
name|req
operator|->
name|user
operator|=
name|str2qb
argument_list|(
name|user
argument_list|,
name|strlen
argument_list|(
name|user
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|req
operator|->
name|password
operator|=
name|str2qb
argument_list|(
name|password
argument_list|,
name|strlen
argument_list|(
name|password
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|req
operator|->
name|file
operator|=
name|str2qb
argument_list|(
name|file
argument_list|,
name|strlen
argument_list|(
name|file
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|pe
operator|=
name|NULLPE
expr_stmt|;
if|if
condition|(
name|encode_RTF_Request
argument_list|(
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|req
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"error encoding request: %s"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
name|PLOGP
argument_list|(
name|pgm_log
argument_list|,
name|RTF_Request
argument_list|,
name|pe
argument_list|,
literal|"Request"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|is
operator|=
name|getisoserventbyname
argument_list|(
name|myentity
argument_list|,
name|myprovider
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s/%s: unknown provider/entity pair"
argument_list|,
name|myentity
argument_list|,
name|myprovider
argument_list|)
expr_stmt|;
name|rtz
operator|->
name|rta_port
operator|=
name|is
operator|->
name|is_port
expr_stmt|;
comment|/* yikes! */
if|if
condition|(
operator|(
name|is
operator|=
name|getisoserventbyname
argument_list|(
literal|"rts"
argument_list|,
literal|"ssap"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ssap/rts: unknown entity"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sa
operator|=
name|is2saddr
argument_list|(
name|host
argument_list|,
name|NULLCP
argument_list|,
name|is
argument_list|)
operator|)
operator|==
name|NULLSA
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"address translation failed"
argument_list|)
expr_stmt|;
name|rtz
operator|->
name|rta_addr
operator|=
operator|*
name|sa
expr_stmt|;
comment|/* struct copy */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s..."
argument_list|,
name|host
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtBeginRequest
argument_list|(
name|rtz
argument_list|,
name|RTS_TWA
argument_list|,
name|turn
argument_list|,
name|pe
argument_list|,
name|rtc
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-BEGIN.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
name|qb_free
argument_list|(
name|req
operator|->
name|user
argument_list|)
expr_stmt|;
name|qb_free
argument_list|(
name|req
operator|->
name|password
argument_list|)
expr_stmt|;
name|qb_free
argument_list|(
name|req
operator|->
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtc
operator|->
name|rtc_result
operator|!=
name|RTS_ACCEPT
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"association rejected: [%s]"
argument_list|,
name|RtErrString
argument_list|(
name|rtc
operator|->
name|rtc_result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connected\n"
argument_list|)
expr_stmt|;
name|sd
operator|=
name|rtc
operator|->
name|rtc_sd
expr_stmt|;
name|RTCFREE
argument_list|(
name|rtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|turn
operator|==
name|RTS_INITIATOR
condition|)
block|{
if|if
condition|(
name|RtSetDownTrans
argument_list|(
name|sd
argument_list|,
name|downtrans
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"set DownTrans upcall"
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtTransferRequest
argument_list|(
name|sd
argument_list|,
name|NULLPE
argument_list|,
name|NOTOK
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-TRANSFER.REQUEST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbytes
operator|==
literal|0
condition|)
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"transfer complete"
argument_list|)
expr_stmt|;
else|else
name|timer
argument_list|(
name|nbytes
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|RtSetUpTrans
argument_list|(
name|sd
argument_list|,
name|uptrans
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"set UpTrans upcall"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
switch|switch
condition|(
name|result
operator|=
name|RtWaitRequest
argument_list|(
name|sd
argument_list|,
name|NOTOK
argument_list|,
name|rti
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
case|case
name|OK
case|:
case|case
name|DONE
case|:
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown return from RtWaitRequest=%d"
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|rti
operator|->
name|rti_type
condition|)
block|{
case|case
name|RTI_TURN
case|:
block|{
specifier|register
name|struct
name|RtSAPturn
modifier|*
name|rtu
init|=
operator|&
name|rti
operator|->
name|rti_turn
decl_stmt|;
if|if
condition|(
name|rtu
operator|->
name|rtu_please
condition|)
block|{
if|if
condition|(
name|RtGTurnRequest
argument_list|(
name|sd
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-TURN-GIVE.REQUEST"
argument_list|)
expr_stmt|;
block|}
else|else
break|break;
block|}
continue|continue;
case|case
name|RTI_TRANSFER
case|:
block|{
ifndef|#
directive|ifndef
name|lint
specifier|register
name|struct
name|RtSAPtransfer
modifier|*
name|rtt
init|=
operator|&
name|rti
operator|->
name|rti_transfer
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|nbytes
operator|==
literal|0
condition|)
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"transfer complete"
argument_list|)
expr_stmt|;
else|else
name|timer
argument_list|(
name|nbytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtPTurnRequest
argument_list|(
name|sd
argument_list|,
literal|1
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-TURN-PLEASE.REQUEST"
argument_list|)
expr_stmt|;
block|}
continue|continue;
case|case
name|RTI_ABORT
case|:
block|{
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rtb
init|=
operator|&
name|rti
operator|->
name|rti_abort
decl_stmt|;
if|if
condition|(
name|rtb
operator|->
name|rta_peer
condition|)
name|rts_adios
argument_list|(
name|rtb
argument_list|,
literal|"RT-U-ABORT.INDICATION"
argument_list|)
expr_stmt|;
if|if
condition|(
name|RTS_FATAL
argument_list|(
name|rtb
operator|->
name|rta_reason
argument_list|)
condition|)
name|rts_adios
argument_list|(
name|rtb
argument_list|,
literal|"RT-P-ABORT.INDICATION"
argument_list|)
expr_stmt|;
name|rts_advise
argument_list|(
name|rtb
argument_list|,
literal|"RT-P-ABORT.INDICATION"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RTI_CLOSE
case|:
case|case
name|RTI_FINISH
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unexpected indication type=%d"
argument_list|,
name|rti
operator|->
name|rti_type
argument_list|)
expr_stmt|;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown indication type=%d"
argument_list|,
name|rti
operator|->
name|rti_type
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
if|if
condition|(
name|RtEndRequest
argument_list|(
name|sd
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-END.REQUEST"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|TRANSFER */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|downtrans
parameter_list|(
name|sd
parameter_list|,
name|base
parameter_list|,
name|len
parameter_list|,
name|size
parameter_list|,
name|ssn
parameter_list|,
name|ack
parameter_list|,
name|rti
parameter_list|)
name|int
name|sd
decl_stmt|;
name|char
modifier|*
modifier|*
name|base
decl_stmt|;
name|int
modifier|*
name|len
decl_stmt|,
name|size
decl_stmt|;
name|long
name|ssn
decl_stmt|,
name|ack
decl_stmt|;
name|struct
name|RtSAPindication
modifier|*
name|rti
decl_stmt|;
block|{
specifier|register
name|int
name|cc
decl_stmt|;
name|int
name|n
decl_stmt|;
specifier|register
name|char
modifier|*
name|dp
decl_stmt|,
modifier|*
name|ep
decl_stmt|;
specifier|static
name|int
name|bsize
decl_stmt|;
specifier|static
name|char
modifier|*
name|bp
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|base
operator|==
name|NULLVP
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"RT-PLEASE.INDICATION: %d"
argument_list|,
name|size
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|OK
return|;
block|}
if|if
condition|(
name|bp
operator|==
name|NULL
condition|)
block|{
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|st
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|rtsaplose
argument_list|(
name|rti
argument_list|,
name|RTS_TRANSFER
argument_list|,
name|source
argument_list|,
literal|"unable to fstat"
argument_list|)
return|;
ifdef|#
directive|ifdef
name|MAXBSIZE
name|bsize
operator|=
name|st
operator|.
name|st_blksize
operator|>
literal|0
condition|?
name|st
operator|.
name|st_blksize
else|:
name|BUFSIZ
expr_stmt|;
else|#
directive|else
name|bsize
operator|=
name|BUFSIZ
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|size
operator|==
literal|0
condition|)
comment|/* no checkpointing... */
name|n
operator|=
name|st
operator|.
name|st_size
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|n
operator|=
name|bsize
operator|)
operator|>
name|size
condition|)
name|n
operator|=
name|size
expr_stmt|;
if|if
condition|(
operator|(
name|bp
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|n
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|rtsaplose
argument_list|(
name|rti
argument_list|,
name|RTS_CONGEST
argument_list|,
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
return|;
ifdef|#
directive|ifdef
name|DEBUG
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Selecting block size of %d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"  based on blksize of %d and RTTR size of %d"
argument_list|,
name|bsize
argument_list|,
name|size
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|bsize
operator|=
name|n
expr_stmt|;
name|timer
argument_list|(
name|nbytes
operator|=
literal|0
argument_list|)
expr_stmt|;
block|}
operator|*
name|base
operator|=
name|NULLCP
operator|,
operator|*
name|len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ep
operator|=
operator|(
name|dp
operator|=
name|bp
operator|)
operator|+
operator|(
name|cc
operator|=
name|bsize
operator|)
init|;
name|dp
operator|<
name|ep
condition|;
name|dp
operator|+=
name|n
operator|,
name|cc
operator|-=
name|n
control|)
block|{
switch|switch
condition|(
name|n
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|dp
argument_list|,
name|cc
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
return|return
name|rtsaplose
argument_list|(
name|rti
argument_list|,
name|RTS_TRANSFER
argument_list|,
literal|"failed"
argument_list|,
literal|"read"
argument_list|)
return|;
default|default:
continue|continue;
case|case
name|OK
case|:
break|break;
block|}
break|break;
block|}
if|if
condition|(
operator|(
name|cc
operator|=
name|dp
operator|-
name|bp
operator|)
operator|>
literal|0
condition|)
block|{
operator|*
name|base
operator|=
name|bp
operator|,
operator|*
name|len
operator|=
name|cc
expr_stmt|;
name|nbytes
operator|+=
name|cc
expr_stmt|;
block|}
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|uptrans
parameter_list|(
name|sd
parameter_list|,
name|type
parameter_list|,
name|addr
parameter_list|,
name|rti
parameter_list|)
name|int
name|sd
decl_stmt|;
name|int
name|type
decl_stmt|;
name|caddr_t
name|addr
decl_stmt|;
name|struct
name|RtSAPindication
modifier|*
name|rti
decl_stmt|;
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SI_DATA
case|:
block|{
specifier|register
name|struct
name|qbuf
modifier|*
name|qb
init|=
operator|(
expr|struct
name|qbuf
operator|*
operator|)
name|addr
decl_stmt|;
specifier|register
name|struct
name|qbuf
modifier|*
name|qp
decl_stmt|;
for|for
control|(
name|qp
operator|=
name|qb
operator|->
name|qb_forw
init|;
name|qp
operator|!=
name|qb
condition|;
name|qp
operator|=
name|qp
operator|->
name|qb_forw
control|)
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|qp
operator|->
name|qb_data
argument_list|,
name|qp
operator|->
name|qb_len
argument_list|)
operator|!=
name|qp
operator|->
name|qb_len
condition|)
return|return
name|rtsaplose
argument_list|(
name|rti
argument_list|,
name|RTS_TRANSFER
argument_list|,
literal|"failed"
argument_list|,
literal|"write"
argument_list|)
return|;
else|else
name|nbytes
operator|+=
name|qp
operator|->
name|qb_len
expr_stmt|;
block|}
break|break;
case|case
name|SI_SYNC
case|:
block|{
ifdef|#
directive|ifdef
name|DEBUG
specifier|register
name|struct
name|SSAPsync
modifier|*
name|sn
init|=
operator|(
expr|struct
name|SSAPsync
operator|*
operator|)
name|addr
decl_stmt|;
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"S-MINOR-SYNC.INDICATION: %ld"
argument_list|,
name|sn
operator|->
name|sn_ssn
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
break|break;
case|case
name|SI_ACTIVITY
case|:
block|{
specifier|register
name|struct
name|SSAPactivity
modifier|*
name|sv
init|=
operator|(
expr|struct
name|SSAPactivity
operator|*
operator|)
name|addr
decl_stmt|;
switch|switch
condition|(
name|sv
operator|->
name|sv_type
condition|)
block|{
case|case
name|SV_START
case|:
ifdef|#
directive|ifdef
name|DEBUG
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"S-ACTIVITY-START.INDICATION"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|fd
operator|=
name|creat
argument_list|(
name|destination
argument_list|,
literal|0666
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|destination
argument_list|,
literal|"unable to create"
argument_list|)
expr_stmt|;
return|return
name|rtsaplose
argument_list|(
name|rti
argument_list|,
name|RTS_TRANSFER
argument_list|,
name|destination
argument_list|,
literal|"unable to create"
argument_list|)
return|;
block|}
name|timer
argument_list|(
name|nbytes
operator|=
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SV_INTRIND
case|:
case|case
name|SV_DISCIND
case|:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"activity %s: %s"
argument_list|,
name|sv
operator|->
name|sv_type
operator|==
name|SV_INTRIND
condition|?
literal|"interrupted"
else|:
literal|"discarded"
argument_list|,
name|SReportString
argument_list|(
name|sv
operator|->
name|sv_reason
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlink
argument_list|(
name|destination
argument_list|)
operator|==
name|NOTOK
condition|)
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|destination
argument_list|,
literal|"unable to unlink"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SV_ENDIND
case|:
ifdef|#
directive|ifdef
name|DEBUG
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"S-ACTIVITY-END.INDICATION"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|close
argument_list|(
name|fd
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|rtsaplose
argument_list|(
name|rti
argument_list|,
name|RTS_TRANSFER
argument_list|,
name|destination
argument_list|,
literal|"close failed on"
argument_list|)
return|;
break|break;
default|default:
return|return
name|rtsaplose
argument_list|(
name|rti
argument_list|,
name|RTS_TRANSFER
argument_list|,
name|NULLCP
argument_list|,
literal|"unexpected activity indication=0x%x"
argument_list|,
name|sv
operator|->
name|sv_type
argument_list|)
return|;
block|}
block|}
break|break;
case|case
name|SI_REPORT
case|:
block|{
specifier|register
name|struct
name|SSAPreport
modifier|*
name|sp
init|=
operator|(
expr|struct
name|SSAPreport
operator|*
operator|)
name|addr
decl_stmt|;
if|if
condition|(
operator|!
name|sp
operator|->
name|sp_peer
condition|)
return|return
name|rtsaplose
argument_list|(
name|rti
argument_list|,
name|RTS_TRANSFER
argument_list|,
name|NULLCP
argument_list|,
literal|"unexpected provider-initiated exception report"
argument_list|)
return|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"exception: %s"
argument_list|,
name|SReportString
argument_list|(
name|sp
operator|->
name|sp_reason
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlink
argument_list|(
name|destination
argument_list|)
operator|==
name|NOTOK
condition|)
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|destination
argument_list|,
literal|"unable to unlink"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
return|return
name|rtsaplose
argument_list|(
name|rti
argument_list|,
name|RTS_TRANSFER
argument_list|,
name|NULLCP
argument_list|,
literal|"unknown uptrans type=0x%x"
argument_list|,
name|type
argument_list|)
return|;
block|}
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|arginit
argument_list|(
argument|vec
argument_list|)
name|char
operator|*
operator|*
name|vec
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|ap
decl_stmt|;
name|char
name|prompt
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|myname
operator|=
name|rindex
argument_list|(
operator|*
name|vec
argument_list|,
literal|'/'
argument_list|)
condition|)
name|myname
operator|++
expr_stmt|;
if|if
condition|(
name|myname
operator|==
name|NULL
operator|||
operator|*
name|myname
operator|==
name|NULL
condition|)
name|myname
operator|=
operator|*
name|vec
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|myname
argument_list|,
literal|"rtf"
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|myname
argument_list|,
literal|"xrtf"
argument_list|)
condition|)
name|host
operator|=
name|myname
operator|,
name|myname
operator|=
literal|"rtf"
expr_stmt|;
name|isodetailor
argument_list|(
name|myname
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ll_hdinit
argument_list|(
name|pgm_log
argument_list|,
name|myname
argument_list|)
expr_stmt|;
name|pgm_log
operator|->
name|ll_stat
operator||=
name|LLOGTTY
expr_stmt|;
for|for
control|(
name|vec
operator|++
init|;
name|ap
operator|=
operator|*
name|vec
condition|;
name|vec
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|ap
operator|==
literal|'-'
condition|)
switch|switch
condition|(
operator|*
operator|++
name|ap
condition|)
block|{
case|case
literal|'l'
case|:
if|if
condition|(
operator|(
name|user
operator|=
operator|*
operator|++
name|vec
operator|)
operator|==
name|NULL
operator|||
operator|*
name|user
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"usage: %s -l username"
argument_list|,
name|myname
argument_list|)
expr_stmt|;
continue|continue;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"-%s: unknown switch"
argument_list|,
name|ap
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|host
operator|==
name|NULL
condition|)
name|host
operator|=
name|ap
expr_stmt|;
elseif|else
if|if
condition|(
name|turn
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|ap
argument_list|,
literal|"get"
argument_list|)
operator|==
literal|0
condition|)
name|turn
operator|=
name|RTS_RESPONDER
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|ap
argument_list|,
literal|"put"
argument_list|)
operator|==
literal|0
condition|)
name|turn
operator|=
name|RTS_INITIATOR
expr_stmt|;
else|else
goto|goto
name|usage
goto|;
block|}
elseif|else
if|if
condition|(
name|source
operator|==
name|NULL
condition|)
name|source
operator|=
name|ap
expr_stmt|;
elseif|else
if|if
condition|(
name|destination
operator|==
name|NULL
condition|)
name|destination
operator|=
name|ap
expr_stmt|;
else|else
block|{
name|usage
label|:
empty_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"usage: %s host [get|put] source destination"
argument_list|,
name|myname
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|destination
operator|==
name|NULL
condition|)
goto|goto
name|usage
goto|;
if|if
condition|(
name|user
operator|==
name|NULL
operator|&&
operator|(
name|user
operator|=
name|getenv
argument_list|(
literal|"USER"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|user
operator|=
name|getenv
argument_list|(
literal|"LOGNAME"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|user
argument_list|,
literal|"anon"
argument_list|)
operator|==
literal|0
condition|)
name|user
operator|=
literal|"ANON"
expr_stmt|;
if|if
condition|(
name|password
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|user
argument_list|,
literal|"ANON"
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|prompt
argument_list|,
literal|"password (%s:%s): "
argument_list|,
name|host
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|password
operator|=
name|getpassword
argument_list|(
name|prompt
argument_list|)
expr_stmt|;
block|}
else|else
name|password
operator|=
name|user
condition|?
name|user
else|:
literal|""
expr_stmt|;
block|}
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* dsapbind1.c - DSAP : Bind for Directory protocols DAP, DSP and QSP */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/dsap/net/RCS/dsapbind1.c,v 7.3 91/03/09 11:53:35 mrose Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/dsap/net/RCS/dsapbind1.c,v 7.3 91/03/09 11:53:35 mrose Exp $  *  *  * $Log:	dsapbind1.c,v $  * Revision 7.3  91/03/09  11:53:35  mrose  * update  *   * Revision 7.2  91/02/22  09:21:14  mrose  * Interim 6.8  *   * Revision 7.1  90/10/17  11:43:32  mrose  * sync  *   * Revision 7.0  90/07/26  14:45:49  mrose  * *** empty log message ***  *   */
end_comment

begin_comment
comment|/*  *                                NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"logger.h"
end_include

begin_include
include|#
directive|include
file|"quipu/dsap.h"
end_include

begin_include
include|#
directive|include
file|"../x500as/DAS-types.h"
end_include

begin_decl_stmt
specifier|extern
name|OID
name|acse_pci
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|OID
name|x500_da_ac
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|OID
name|x500_ds_ac
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|OID
name|quipu_ds_ac
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|OID
name|x500_da_as
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|OID
name|x500_ds_as
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|OID
name|quipu_ds_as
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|PSAPctxlist
modifier|*
name|x500_da_pcdl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|PSAPctxlist
modifier|*
name|x500_ds_pcdl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|PSAPctxlist
modifier|*
name|quipu_ds_pcdl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|log_dsap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|qlocalhost
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|DspAsynBindReqAux
parameter_list|(
name|callingtitle
parameter_list|,
name|calledtitle
parameter_list|,
name|callingaddr
parameter_list|,
name|calledaddr
parameter_list|,
name|prequirements
parameter_list|,
name|srequirements
parameter_list|,
name|isn
parameter_list|,
name|settings
parameter_list|,
name|sf
parameter_list|,
name|bindarg
parameter_list|,
name|qos
parameter_list|,
name|dc
parameter_list|,
name|di
parameter_list|,
name|async
parameter_list|)
name|AEI
name|callingtitle
decl_stmt|;
name|AEI
name|calledtitle
decl_stmt|;
name|struct
name|PSAPaddr
modifier|*
name|callingaddr
decl_stmt|;
name|struct
name|PSAPaddr
modifier|*
name|calledaddr
decl_stmt|;
name|int
name|prequirements
decl_stmt|;
name|int
name|srequirements
decl_stmt|;
name|long
name|isn
decl_stmt|;
name|int
name|settings
decl_stmt|;
name|struct
name|SSAPref
modifier|*
name|sf
decl_stmt|;
name|struct
name|ds_bind_arg
modifier|*
name|bindarg
decl_stmt|;
name|struct
name|QOStype
modifier|*
name|qos
decl_stmt|;
name|struct
name|DSAPconnect
modifier|*
name|dc
decl_stmt|;
name|struct
name|DSAPindication
modifier|*
name|di
decl_stmt|;
name|int
name|async
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|OID
name|app_ctx
decl_stmt|;
name|struct
name|PSAPctxlist
modifier|*
name|pcl
decl_stmt|;
name|OID
name|def_ctx
decl_stmt|;
name|PE
name|bindargpe
decl_stmt|;
name|struct
name|RoNOTindication
name|rni_s
decl_stmt|;
name|struct
name|RoNOTindication
modifier|*
name|rni
init|=
operator|&
operator|(
name|rni_s
operator|)
decl_stmt|;
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
operator|(
name|dc
operator|->
name|dc_connect
operator|)
decl_stmt|;
name|app_ctx
operator|=
name|x500_ds_ac
expr_stmt|;
name|def_ctx
operator|=
name|x500_ds_as
expr_stmt|;
name|pcl
operator|=
operator|(
expr|struct
name|PSAPctxlist
operator|*
operator|)
name|smalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|PSAPctxlist
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|pcl
operator|)
operator|=
operator|(
operator|*
operator|(
name|x500_ds_pcdl
operator|)
operator|)
expr_stmt|;
comment|/* struct copy */
if|if
condition|(
name|encode_DAS_DirectoryBindArgument
argument_list|(
operator|&
name|bindargpe
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|bindarg
argument_list|)
operator|!=
name|OK
condition|)
block|{
return|return
operator|(
name|dsaplose
argument_list|(
name|di
argument_list|,
name|DA_ARG_ENC
argument_list|,
name|NULLCP
argument_list|,
literal|"DSP BIND REQUEST"
argument_list|)
operator|)
return|;
block|}
name|bindargpe
operator|->
name|pe_context
operator|=
name|DIR_SYSTEM_PC_ID
expr_stmt|;
name|watch_dog
argument_list|(
literal|"RoAsynBindRequest (DSP)"
argument_list|)
expr_stmt|;
name|result
operator|=
name|RoAsynBindRequest
argument_list|(
name|app_ctx
argument_list|,
name|callingtitle
argument_list|,
name|calledtitle
argument_list|,
name|callingaddr
argument_list|,
name|calledaddr
argument_list|,
name|pcl
argument_list|,
name|def_ctx
argument_list|,
name|prequirements
argument_list|,
name|srequirements
argument_list|,
name|isn
argument_list|,
name|settings
argument_list|,
name|sf
argument_list|,
name|bindargpe
argument_list|,
name|qos
argument_list|,
name|acc
argument_list|,
name|rni
argument_list|,
name|async
argument_list|)
expr_stmt|;
name|watch_dog_reset
argument_list|()
expr_stmt|;
if|if
condition|(
name|bindargpe
operator|!=
name|NULLPE
condition|)
name|pe_free
argument_list|(
name|bindargpe
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pcl
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NOTOK
condition|)
block|{
return|return
operator|(
name|ronot2dsaplose
argument_list|(
name|di
argument_list|,
literal|"DSP-BIND.REQUEST"
argument_list|,
name|rni
argument_list|)
operator|)
return|;
block|}
name|dc
operator|->
name|dc_sd
operator|=
name|acc
operator|->
name|acc_sd
expr_stmt|;
if|if
condition|(
operator|(
operator|(
operator|!
name|async
operator|)
operator|&&
operator|(
name|result
operator|==
name|OK
operator|)
operator|)
operator|||
operator|(
name|async
operator|&&
operator|(
name|result
operator|==
name|DONE
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|DBindDecode
argument_list|(
name|acc
argument_list|,
name|dc
argument_list|)
operator|!=
name|OK
condition|)
block|{
return|return
operator|(
name|dsaplose
argument_list|(
name|di
argument_list|,
name|DA_RES_DEC
argument_list|,
name|NULLCP
argument_list|,
literal|"DSP BIND REQUEST"
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|int
name|DspAsynBindRequest
parameter_list|(
name|calledaddr
parameter_list|,
name|bindarg
parameter_list|,
name|qos_maxtime
parameter_list|,
name|dc
parameter_list|,
name|di
parameter_list|,
name|async
parameter_list|)
name|struct
name|PSAPaddr
modifier|*
name|calledaddr
decl_stmt|;
name|struct
name|ds_bind_arg
modifier|*
name|bindarg
decl_stmt|;
name|int
name|qos_maxtime
decl_stmt|;
name|struct
name|DSAPconnect
modifier|*
name|dc
decl_stmt|;
name|struct
name|DSAPindication
modifier|*
name|di
decl_stmt|;
name|int
name|async
decl_stmt|;
block|{
name|struct
name|SSAPref
name|sf_s
decl_stmt|;
name|struct
name|SSAPref
modifier|*
name|sf
init|=
operator|&
operator|(
name|sf_s
operator|)
decl_stmt|;
name|struct
name|QOStype
name|qos
decl_stmt|;
if|if
condition|(
name|qlocalhost
operator|==
name|NULLCP
condition|)
name|qlocalhost
operator|=
name|PLocalHostName
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|sf
operator|=
name|addr2ref
argument_list|(
name|qlocalhost
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sf
operator|=
operator|&
name|sf_s
expr_stmt|;
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sf
argument_list|,
sizeof|sizeof
expr|*
name|sf
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|qos
argument_list|,
sizeof|sizeof
name|qos
argument_list|)
expr_stmt|;
name|qos
operator|.
name|qos_sversion
operator|=
name|NOTOK
expr_stmt|;
comment|/* Negotiate highest session */
name|qos
operator|.
name|qos_maxtime
operator|=
name|qos_maxtime
expr_stmt|;
return|return
operator|(
name|DspAsynBindReqAux
argument_list|(
name|NULLAEI
argument_list|,
name|NULLAEI
argument_list|,
name|NULLPA
argument_list|,
name|calledaddr
argument_list|,
name|PR_MYREQUIRE
argument_list|,
name|ROS_MYREQUIRE
argument_list|,
name|SERIAL_NONE
argument_list|,
literal|0
argument_list|,
name|sf
argument_list|,
name|bindarg
argument_list|,
operator|&
name|qos
argument_list|,
name|dc
argument_list|,
name|di
argument_list|,
name|async
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|QspAsynBindReqAux
parameter_list|(
name|callingtitle
parameter_list|,
name|calledtitle
parameter_list|,
name|callingaddr
parameter_list|,
name|calledaddr
parameter_list|,
name|prequirements
parameter_list|,
name|srequirements
parameter_list|,
name|isn
parameter_list|,
name|settings
parameter_list|,
name|sf
parameter_list|,
name|bindarg
parameter_list|,
name|qos
parameter_list|,
name|dc
parameter_list|,
name|di
parameter_list|,
name|async
parameter_list|)
name|AEI
name|callingtitle
decl_stmt|;
name|AEI
name|calledtitle
decl_stmt|;
name|struct
name|PSAPaddr
modifier|*
name|callingaddr
decl_stmt|;
name|struct
name|PSAPaddr
modifier|*
name|calledaddr
decl_stmt|;
name|int
name|prequirements
decl_stmt|;
name|int
name|srequirements
decl_stmt|;
name|long
name|isn
decl_stmt|;
name|int
name|settings
decl_stmt|;
name|struct
name|SSAPref
modifier|*
name|sf
decl_stmt|;
name|struct
name|ds_bind_arg
modifier|*
name|bindarg
decl_stmt|;
name|struct
name|QOStype
modifier|*
name|qos
decl_stmt|;
name|struct
name|DSAPconnect
modifier|*
name|dc
decl_stmt|;
name|struct
name|DSAPindication
modifier|*
name|di
decl_stmt|;
name|int
name|async
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|OID
name|app_ctx
decl_stmt|;
name|struct
name|PSAPctxlist
modifier|*
name|pcl
decl_stmt|;
name|OID
name|def_ctx
decl_stmt|;
name|PE
name|bindargpe
decl_stmt|;
name|struct
name|RoNOTindication
name|rni_s
decl_stmt|;
name|struct
name|RoNOTindication
modifier|*
name|rni
init|=
operator|&
operator|(
name|rni_s
operator|)
decl_stmt|;
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
operator|(
name|dc
operator|->
name|dc_connect
operator|)
decl_stmt|;
name|app_ctx
operator|=
name|quipu_ds_ac
expr_stmt|;
name|def_ctx
operator|=
name|quipu_ds_as
expr_stmt|;
name|pcl
operator|=
operator|(
expr|struct
name|PSAPctxlist
operator|*
operator|)
name|smalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|PSAPctxlist
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|pcl
operator|)
operator|=
operator|(
operator|*
operator|(
name|quipu_ds_pcdl
operator|)
operator|)
expr_stmt|;
comment|/* struct copy */
comment|/* Encode Bind Argument */
if|if
condition|(
name|encode_DAS_DirectoryBindArgument
argument_list|(
operator|&
name|bindargpe
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|bindarg
argument_list|)
operator|!=
name|OK
condition|)
block|{
return|return
operator|(
name|dsaplose
argument_list|(
name|di
argument_list|,
name|DA_ARG_ENC
argument_list|,
name|NULLCP
argument_list|,
literal|"QSP BIND REQUEST"
argument_list|)
operator|)
return|;
block|}
name|bindargpe
operator|->
name|pe_context
operator|=
name|DIR_SYSTEM_PC_ID
expr_stmt|;
name|watch_dog
argument_list|(
literal|"RoAsynBindRequest (DSP)"
argument_list|)
expr_stmt|;
name|result
operator|=
name|RoAsynBindRequest
argument_list|(
name|app_ctx
argument_list|,
name|callingtitle
argument_list|,
name|calledtitle
argument_list|,
name|callingaddr
argument_list|,
name|calledaddr
argument_list|,
name|pcl
argument_list|,
name|def_ctx
argument_list|,
name|prequirements
argument_list|,
name|srequirements
argument_list|,
name|isn
argument_list|,
name|settings
argument_list|,
name|sf
argument_list|,
name|bindargpe
argument_list|,
name|qos
argument_list|,
name|acc
argument_list|,
name|rni
argument_list|,
name|async
argument_list|)
expr_stmt|;
name|watch_dog_reset
argument_list|()
expr_stmt|;
if|if
condition|(
name|bindargpe
operator|!=
name|NULLPE
condition|)
name|pe_free
argument_list|(
name|bindargpe
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pcl
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NOTOK
condition|)
block|{
comment|/* Have an RoSAPindication, need to return DSAPindication */
return|return
operator|(
name|ronot2dsaplose
argument_list|(
name|di
argument_list|,
literal|"QSP-BIND.REQUEST"
argument_list|,
name|rni
argument_list|)
operator|)
return|;
block|}
name|dc
operator|->
name|dc_sd
operator|=
name|acc
operator|->
name|acc_sd
expr_stmt|;
if|if
condition|(
operator|(
operator|(
operator|!
name|async
operator|)
operator|&&
operator|(
name|result
operator|==
name|OK
operator|)
operator|)
operator|||
operator|(
name|async
operator|&&
operator|(
name|result
operator|==
name|DONE
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|DBindDecode
argument_list|(
name|acc
argument_list|,
name|dc
argument_list|)
operator|!=
name|OK
condition|)
block|{
return|return
operator|(
name|dsaplose
argument_list|(
name|di
argument_list|,
name|DA_RES_DEC
argument_list|,
name|NULLCP
argument_list|,
literal|"QSP BIND REQUEST"
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|int
name|QspAsynBindRequest
parameter_list|(
name|calledaddr
parameter_list|,
name|bindarg
parameter_list|,
name|qos_maxtime
parameter_list|,
name|dc
parameter_list|,
name|di
parameter_list|,
name|async
parameter_list|)
name|struct
name|PSAPaddr
modifier|*
name|calledaddr
decl_stmt|;
name|struct
name|ds_bind_arg
modifier|*
name|bindarg
decl_stmt|;
name|int
name|qos_maxtime
decl_stmt|;
name|struct
name|DSAPconnect
modifier|*
name|dc
decl_stmt|;
name|struct
name|DSAPindication
modifier|*
name|di
decl_stmt|;
name|int
name|async
decl_stmt|;
block|{
name|struct
name|SSAPref
name|sf_s
decl_stmt|;
name|struct
name|SSAPref
modifier|*
name|sf
init|=
operator|&
operator|(
name|sf_s
operator|)
decl_stmt|;
name|struct
name|QOStype
name|qos
decl_stmt|;
if|if
condition|(
name|qlocalhost
operator|==
name|NULLCP
condition|)
name|qlocalhost
operator|=
name|PLocalHostName
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|sf
operator|=
name|addr2ref
argument_list|(
name|qlocalhost
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sf
operator|=
operator|&
name|sf_s
expr_stmt|;
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sf
argument_list|,
sizeof|sizeof
expr|*
name|sf
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|qos
argument_list|,
sizeof|sizeof
name|qos
argument_list|)
expr_stmt|;
name|qos
operator|.
name|qos_sversion
operator|=
name|NOTOK
expr_stmt|;
comment|/* Negotiate highest session */
name|qos
operator|.
name|qos_maxtime
operator|=
name|qos_maxtime
expr_stmt|;
comment|/* 	* The quipu system application context can assume that 	* the remote DSA is a Quipu DSA and can take certain actions 	* that are not generally available, such as refusing a 	* connection release request. To do this, session negotiated 	* release appears to be necessary, so SR_NEGOTIATED is 	* is included in the session requirements here. 	*/
return|return
operator|(
name|QspAsynBindReqAux
argument_list|(
name|NULLAEI
argument_list|,
name|NULLAEI
argument_list|,
name|NULLPA
argument_list|,
name|calledaddr
argument_list|,
name|PR_MYREQUIRE
argument_list|,
name|ROS_MYREQUIRE
operator||
name|SR_NEGOTIATED
argument_list|,
name|SERIAL_NONE
argument_list|,
literal|0
argument_list|,
name|sf
argument_list|,
name|bindarg
argument_list|,
operator|&
name|qos
argument_list|,
name|dc
argument_list|,
name|di
argument_list|,
name|async
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|DspAsynBindRetry
parameter_list|(
name|sd
parameter_list|,
name|do_next_nsap
parameter_list|,
name|dc
parameter_list|,
name|di
parameter_list|)
name|int
name|sd
decl_stmt|;
name|int
name|do_next_nsap
decl_stmt|;
name|struct
name|DSAPconnect
modifier|*
name|dc
decl_stmt|;
name|struct
name|DSAPindication
modifier|*
name|di
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|RoNOTindication
name|rni_s
decl_stmt|;
name|struct
name|RoNOTindication
modifier|*
name|rni
init|=
operator|&
operator|(
name|rni_s
operator|)
decl_stmt|;
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
operator|(
name|dc
operator|->
name|dc_connect
operator|)
decl_stmt|;
name|watch_dog
argument_list|(
literal|"RoAsynBindRetry (DSP)"
argument_list|)
expr_stmt|;
name|result
operator|=
name|RoAsynBindRetry
argument_list|(
name|sd
argument_list|,
name|do_next_nsap
argument_list|,
name|acc
argument_list|,
name|rni
argument_list|)
expr_stmt|;
name|watch_dog_reset
argument_list|()
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NOTOK
condition|)
block|{
return|return
operator|(
name|ronot2dsaplose
argument_list|(
name|di
argument_list|,
literal|"DAP-BIND.RETRY"
argument_list|,
name|rni
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|result
operator|==
name|DONE
condition|)
block|{
if|if
condition|(
name|DBindDecode
argument_list|(
name|acc
argument_list|,
name|dc
argument_list|)
operator|!=
name|OK
condition|)
block|{
return|return
operator|(
name|dsaplose
argument_list|(
name|di
argument_list|,
name|DA_RES_DEC
argument_list|,
name|NULLCP
argument_list|,
literal|"DSP BIND RETRY"
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|int
name|QspAsynBindRetry
parameter_list|(
name|sd
parameter_list|,
name|do_next_nsap
parameter_list|,
name|dc
parameter_list|,
name|di
parameter_list|)
name|int
name|sd
decl_stmt|;
name|int
name|do_next_nsap
decl_stmt|;
name|struct
name|DSAPconnect
modifier|*
name|dc
decl_stmt|;
name|struct
name|DSAPindication
modifier|*
name|di
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|RoNOTindication
name|rni_s
decl_stmt|;
name|struct
name|RoNOTindication
modifier|*
name|rni
init|=
operator|&
operator|(
name|rni_s
operator|)
decl_stmt|;
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
operator|(
name|dc
operator|->
name|dc_connect
operator|)
decl_stmt|;
name|watch_dog
argument_list|(
literal|"RoAsynBindRetry (QSP)"
argument_list|)
expr_stmt|;
name|result
operator|=
name|RoAsynBindRetry
argument_list|(
name|sd
argument_list|,
name|do_next_nsap
argument_list|,
name|acc
argument_list|,
name|rni
argument_list|)
expr_stmt|;
name|watch_dog_reset
argument_list|()
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NOTOK
condition|)
block|{
return|return
operator|(
name|ronot2dsaplose
argument_list|(
name|di
argument_list|,
literal|"DAP-BIND.RETRY"
argument_list|,
name|rni
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|result
operator|==
name|DONE
condition|)
block|{
if|if
condition|(
name|DBindDecode
argument_list|(
name|acc
argument_list|,
name|dc
argument_list|)
operator|!=
name|OK
condition|)
block|{
return|return
operator|(
name|dsaplose
argument_list|(
name|di
argument_list|,
name|DA_RES_DEC
argument_list|,
name|NULLCP
argument_list|,
literal|"QSP BIND RETRY"
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|int
name|DBindDecode
parameter_list|(
name|acc
parameter_list|,
name|dc
parameter_list|)
name|struct
name|AcSAPconnect
modifier|*
name|acc
decl_stmt|;
name|struct
name|DSAPconnect
modifier|*
name|dc
decl_stmt|;
block|{
name|struct
name|ds_bind_arg
modifier|*
name|bind_res
decl_stmt|;
name|struct
name|ds_bind_error
modifier|*
name|bind_err
decl_stmt|;
switch|switch
condition|(
name|acc
operator|->
name|acc_result
condition|)
block|{
case|case
name|ACS_ACCEPT
case|:
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"DBindDecode ACCEPT"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|acc
operator|->
name|acc_ninfo
operator|==
literal|1
operator|)
operator|&&
operator|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
operator|!=
name|NULLPE
operator|)
condition|)
block|{
if|if
condition|(
name|decode_DAS_DirectoryBindResult
argument_list|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|,
name|NULLIP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|bind_res
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Unable to parse DirectoryBindResult"
operator|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DS_REJECT
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
name|dc
operator|->
name|dc_un
operator|.
name|dc_bind_res
operator|=
operator|*
name|bind_res
expr_stmt|;
comment|/* struct copy */
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|bind_res
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DS_RESULT
expr_stmt|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"No DirectoryBindResult"
operator|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DS_REJECT
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
break|break;
case|case
name|ACS_PERMANENT
case|:
comment|/* 	    * Get the DirectoryBindError 	    */
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"DBindDecode PERMANENT"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|acc
operator|->
name|acc_ninfo
operator|==
literal|1
operator|)
operator|&&
operator|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
operator|!=
name|NULLPE
operator|)
condition|)
block|{
if|if
condition|(
name|decode_DAS_DirectoryBindError
argument_list|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|,
name|NULLIP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|bind_err
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Unable to decode DirectoryBindError"
operator|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DS_REJECT
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
name|dc
operator|->
name|dc_un
operator|.
name|dc_bind_err
operator|=
operator|*
name|bind_err
expr_stmt|;
comment|/* struct copy */
empty_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|bind_err
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DS_ERROR
expr_stmt|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DirectoryBindError (%s)"
operator|,
name|AcErrString
argument_list|(
name|acc
operator|->
name|acc_result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DS_REJECT
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
break|break;
default|default:
if|if
condition|(
operator|(
name|acc
operator|->
name|acc_result
operator|==
name|ACS_REFUSED
operator|)
operator|||
operator|(
name|acc
operator|->
name|acc_result
operator|==
name|ACS_PRESENTATION
operator|)
condition|)
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"Association rejected: [%s]"
operator|,
name|AcErrString
argument_list|(
name|acc
operator|->
name|acc_result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|else
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Association rejected: [%s]"
operator|,
name|AcErrString
argument_list|(
name|acc
operator|->
name|acc_result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DS_REJECT
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
comment|/* switch acc->acc_result */
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* dapbind.c - Establish directory association */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/dsap/net/RCS/dapbind.c,v 7.2 91/02/22 09:20:55 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/dsap/net/RCS/dapbind.c,v 7.2 91/02/22 09:20:55 mrose Interim $  *  *  * $Log:	dapbind.c,v $  * Revision 7.2  91/02/22  09:20:55  mrose  * Interim 6.8  *   * Revision 7.1  90/10/17  11:43:16  mrose  * sync  *   * Revision 7.0  90/07/26  14:45:20  mrose  * *** empty log message ***  *   */
end_comment

begin_comment
comment|/*  *                                NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|"quipu/util.h"
end_include

begin_include
include|#
directive|include
file|"quipu/oid.h"
end_include

begin_include
include|#
directive|include
file|"quipu/dap2.h"
end_include

begin_include
include|#
directive|include
file|"../x500as/DAS-types.h"
end_include

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|log_dsap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|dsap_ad
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Association descriptor */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|dsap_id
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Last id sent */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|dsa_address
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* address of default dsa */
end_comment

begin_decl_stmt
name|struct
name|PSAPaddr
name|dsa_bound
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|qlocalhost
init|=
name|NULLCP
decl_stmt|;
end_decl_stmt

begin_macro
name|ds_bind
argument_list|(
argument|arg
argument_list|,
argument|error
argument_list|,
argument|result
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|ds_bind_arg
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ds_bind_arg
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ds_bind_error
modifier|*
name|error
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* reverse compatability for bind */
name|arg
operator|->
name|dba_auth_type
operator|=
name|DBA_AUTH_SIMPLE
expr_stmt|;
name|arg
operator|->
name|dba_time1
operator|=
name|NULLCP
expr_stmt|;
name|arg
operator|->
name|dba_time2
operator|=
name|NULLCP
expr_stmt|;
return|return
operator|(
name|secure_ds_bind
argument_list|(
name|arg
argument_list|,
name|error
argument_list|,
name|result
argument_list|)
operator|)
return|;
block|}
end_block

begin_macro
name|secure_ds_bind
argument_list|(
argument|arg
argument_list|,
argument|error
argument_list|,
argument|result
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|ds_bind_arg
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ds_bind_arg
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ds_bind_error
modifier|*
name|error
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|PSAPaddr
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
operator|(
name|addr
operator|=
name|str2paddr
argument_list|(
name|dsa_address
argument_list|)
operator|)
operator|==
name|NULLPA
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"invalid name %s"
operator|,
name|dsa_address
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|DS_ERROR_LOCAL
operator|)
return|;
block|}
return|return
operator|(
name|dap_bind
argument_list|(
operator|&
operator|(
name|dsap_ad
operator|)
argument_list|,
name|arg
argument_list|,
name|error
argument_list|,
name|result
argument_list|,
name|addr
argument_list|)
operator|)
return|;
block|}
end_block

begin_macro
name|dap_bind
argument_list|(
argument|ad
argument_list|,
argument|arg
argument_list|,
argument|error
argument_list|,
argument|result
argument_list|,
argument|addr
argument_list|)
end_macro

begin_decl_stmt
name|int
modifier|*
name|ad
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ds_bind_arg
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ds_bind_arg
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ds_bind_error
modifier|*
name|error
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|PSAPaddr
modifier|*
name|addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|DAPconnect
name|dc_s
decl_stmt|;
name|struct
name|DAPconnect
modifier|*
name|dc
init|=
operator|&
name|dc_s
decl_stmt|;
name|struct
name|DAPindication
name|di_s
decl_stmt|;
name|struct
name|DAPindication
modifier|*
name|di
init|=
operator|&
name|di_s
decl_stmt|;
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"dap_bind: Address: %s"
operator|,
name|paddr2str
argument_list|(
name|addr
argument_list|,
name|NULLNA
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dc
argument_list|,
sizeof|sizeof
name|dc_s
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DapAsynBindRequest
argument_list|(
name|addr
argument_list|,
name|arg
argument_list|,
name|dc
argument_list|,
name|di
argument_list|,
name|ROS_SYNC
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NOTOK
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapAsynBindRequest() failed"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|DS_ERROR_CONNECT
operator|)
return|;
block|}
if|if
condition|(
name|dc
operator|->
name|dc_result
operator|==
name|DC_RESULT
condition|)
block|{
name|dsa_bound
operator|=
name|dc
operator|->
name|dc_connect
operator|.
name|acc_connect
operator|.
name|pc_responding
expr_stmt|;
comment|/* struct copy */
operator|(
operator|*
name|ad
operator|)
operator|=
name|dc
operator|->
name|dc_sd
expr_stmt|;
operator|*
name|result
operator|=
name|dc
operator|->
name|dc_un
operator|.
name|dc_bind_res
expr_stmt|;
comment|/* struct copy */
name|dc
operator|->
name|dc_un
operator|.
name|dc_bind_res
operator|.
name|dba_dn
operator|=
name|NULLDN
expr_stmt|;
comment|/* stop freeing it ! */
name|DCFREE
argument_list|(
name|dc
argument_list|)
expr_stmt|;
return|return
operator|(
name|DS_OK
operator|)
return|;
block|}
if|if
condition|(
name|dc
operator|->
name|dc_result
operator|==
name|DC_ERROR
condition|)
block|{
operator|*
name|error
operator|=
name|dc
operator|->
name|dc_un
operator|.
name|dc_bind_err
expr_stmt|;
name|DCFREE
argument_list|(
name|dc
argument_list|)
expr_stmt|;
return|return
operator|(
name|DS_X500_ERROR
operator|)
return|;
block|}
return|return
operator|(
name|DS_ERROR_CONNECT
operator|)
return|;
block|}
end_block

begin_comment
comment|/*
comment|DAP-BIND.REQUEST */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|int
name|DapAsynBindReqAux
parameter_list|(
name|callingtitle
parameter_list|,
name|calledtitle
parameter_list|,
name|callingaddr
parameter_list|,
name|calledaddr
parameter_list|,
name|prequirements
parameter_list|,
name|srequirements
parameter_list|,
name|isn
parameter_list|,
name|settings
parameter_list|,
name|sf
parameter_list|,
name|bindarg
parameter_list|,
name|qos
parameter_list|,
name|dc
parameter_list|,
name|di
parameter_list|,
name|async
parameter_list|)
name|AEI
name|callingtitle
decl_stmt|;
name|AEI
name|calledtitle
decl_stmt|;
name|struct
name|PSAPaddr
modifier|*
name|callingaddr
decl_stmt|;
name|struct
name|PSAPaddr
modifier|*
name|calledaddr
decl_stmt|;
name|int
name|prequirements
decl_stmt|;
name|int
name|srequirements
decl_stmt|;
name|long
name|isn
decl_stmt|;
name|int
name|settings
decl_stmt|;
name|struct
name|SSAPref
modifier|*
name|sf
decl_stmt|;
name|struct
name|ds_bind_arg
modifier|*
name|bindarg
decl_stmt|;
name|struct
name|QOStype
modifier|*
name|qos
decl_stmt|;
name|struct
name|DAPconnect
modifier|*
name|dc
decl_stmt|;
name|struct
name|DAPindication
modifier|*
name|di
decl_stmt|;
name|int
name|async
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|OID
name|app_ctx
decl_stmt|;
name|struct
name|PSAPctxlist
name|pc_s
decl_stmt|;
name|struct
name|PSAPctxlist
modifier|*
name|pc
init|=
operator|&
operator|(
name|pc_s
operator|)
decl_stmt|;
name|OID
name|def_ctx
decl_stmt|;
name|PE
name|bindargpe
decl_stmt|;
name|struct
name|RoNOTindication
name|rni_s
decl_stmt|;
name|struct
name|RoNOTindication
modifier|*
name|rni
init|=
operator|&
operator|(
name|rni_s
operator|)
decl_stmt|;
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
operator|(
name|dc
operator|->
name|dc_connect
operator|)
decl_stmt|;
name|OID
name|acse_pci
decl_stmt|;
comment|/* 	* Set application-context, presentation context definition list, 	* and default-context. 	*/
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_TRACE
argument_list|,
operator|(
literal|"DapAsynBindReqAux():"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|acse_pci
operator|=
name|oid_cpy
argument_list|(
name|DIR_ACSE
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"acse pci version 1 OID not found"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
name|app_ctx
operator|=
name|oid_cpy
argument_list|(
name|DIR_ACCESS_AC
argument_list|)
expr_stmt|;
name|def_ctx
operator|=
name|oid_cpy
argument_list|(
name|DIR_ACCESS_AS
argument_list|)
expr_stmt|;
name|pc
operator|->
name|pc_nctx
operator|=
literal|2
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_id
operator|=
name|DIR_ACCESS_PC_ID
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_asn
operator|=
name|oid_cpy
argument_list|(
name|def_ctx
argument_list|)
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_atn
operator|=
name|NULLOID
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|1
index|]
operator|.
name|pc_id
operator|=
name|DIR_ACSE_PC_ID
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|1
index|]
operator|.
name|pc_asn
operator|=
name|acse_pci
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|1
index|]
operator|.
name|pc_atn
operator|=
name|NULLOID
expr_stmt|;
comment|/* Encode Bind Argument */
if|if
condition|(
name|encode_DAS_DirectoryBindArgument
argument_list|(
operator|&
name|bindargpe
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|bindarg
argument_list|)
operator|!=
name|OK
condition|)
block|{
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DA_ARG_ENC
argument_list|,
name|NULLCP
argument_list|,
literal|"DAP BIND REQUEST"
argument_list|)
operator|)
return|;
block|}
name|bindargpe
operator|->
name|pe_context
operator|=
name|DIR_ACCESS_PC_ID
expr_stmt|;
ifdef|#
directive|ifdef
name|PDU_DUMP
name|pdu_dump
argument_list|(
name|bindargpe
argument_list|,
literal|"arg"
argument_list|,
literal|100
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|result
operator|=
name|RoAsynBindRequest
argument_list|(
name|app_ctx
argument_list|,
name|callingtitle
argument_list|,
name|calledtitle
argument_list|,
name|callingaddr
argument_list|,
name|calledaddr
argument_list|,
name|pc
argument_list|,
name|def_ctx
argument_list|,
name|prequirements
argument_list|,
name|srequirements
argument_list|,
name|isn
argument_list|,
name|settings
argument_list|,
name|sf
argument_list|,
name|bindargpe
argument_list|,
name|qos
argument_list|,
name|acc
argument_list|,
name|rni
argument_list|,
name|async
argument_list|)
expr_stmt|;
if|if
condition|(
name|bindargpe
operator|!=
name|NULLPE
condition|)
name|pe_free
argument_list|(
name|bindargpe
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NOTOK
condition|)
block|{
return|return
operator|(
name|ronot2daplose
argument_list|(
name|di
argument_list|,
literal|"DAP-BIND.REQUEST"
argument_list|,
name|rni
argument_list|)
operator|)
return|;
block|}
comment|/* Set the connection identifier */
name|dc
operator|->
name|dc_sd
operator|=
name|acc
operator|->
name|acc_sd
expr_stmt|;
if|if
condition|(
operator|(
operator|(
operator|!
name|async
operator|)
operator|&&
operator|(
name|result
operator|==
name|OK
operator|)
operator|)
operator|||
operator|(
name|async
operator|&&
operator|(
name|result
operator|==
name|DONE
operator|)
operator|)
condition|)
block|{
comment|/* 		* Check the type of return and attempt to decode user data. 		*/
if|if
condition|(
name|DapBindDecode
argument_list|(
name|acc
argument_list|,
name|dc
argument_list|)
operator|!=
name|OK
condition|)
block|{
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DA_RES_DEC
argument_list|,
name|NULLCP
argument_list|,
literal|"DAP BIND REQUEST"
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|int
name|DapAsynBindRequest
parameter_list|(
name|calledaddr
parameter_list|,
name|bindarg
parameter_list|,
name|dc
parameter_list|,
name|di
parameter_list|,
name|async
parameter_list|)
name|struct
name|PSAPaddr
modifier|*
name|calledaddr
decl_stmt|;
name|struct
name|ds_bind_arg
modifier|*
name|bindarg
decl_stmt|;
name|struct
name|DAPconnect
modifier|*
name|dc
decl_stmt|;
name|struct
name|DAPindication
modifier|*
name|di
decl_stmt|;
name|int
name|async
decl_stmt|;
block|{
name|struct
name|SSAPref
name|sf_s
decl_stmt|;
name|struct
name|SSAPref
modifier|*
name|sf
init|=
operator|&
operator|(
name|sf_s
operator|)
decl_stmt|;
name|struct
name|QOStype
name|qos
decl_stmt|;
if|if
condition|(
name|qlocalhost
operator|==
name|NULLCP
condition|)
name|qlocalhost
operator|=
name|PLocalHostName
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|sf
operator|=
name|addr2ref
argument_list|(
name|qlocalhost
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sf
operator|=
operator|&
name|sf_s
expr_stmt|;
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sf
argument_list|,
sizeof|sizeof
expr|*
name|sf
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|qos
argument_list|,
sizeof|sizeof
name|qos
argument_list|)
expr_stmt|;
name|qos
operator|.
name|qos_sversion
operator|=
name|NOTOK
expr_stmt|;
comment|/* Negotiate highest session */
name|qos
operator|.
name|qos_maxtime
operator|=
name|NOTOK
expr_stmt|;
comment|/* No time out specified */
return|return
operator|(
name|DapAsynBindReqAux
argument_list|(
name|NULLAEI
argument_list|,
name|NULLAEI
argument_list|,
name|NULLPA
argument_list|,
name|calledaddr
argument_list|,
name|PR_MYREQUIRE
argument_list|,
name|ROS_MYREQUIRE
argument_list|,
name|SERIAL_NONE
argument_list|,
literal|0
argument_list|,
name|sf
argument_list|,
name|bindarg
argument_list|,
operator|&
name|qos
argument_list|,
name|dc
argument_list|,
name|di
argument_list|,
name|async
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|DapAsynBindRetry
parameter_list|(
name|sd
parameter_list|,
name|do_next_nsap
parameter_list|,
name|dc
parameter_list|,
name|di
parameter_list|)
name|int
name|sd
decl_stmt|;
name|int
name|do_next_nsap
decl_stmt|;
name|struct
name|DAPconnect
modifier|*
name|dc
decl_stmt|;
name|struct
name|DAPindication
modifier|*
name|di
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|RoNOTindication
name|rni_s
decl_stmt|;
name|struct
name|RoNOTindication
modifier|*
name|rni
init|=
operator|&
operator|(
name|rni_s
operator|)
decl_stmt|;
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
operator|(
name|dc
operator|->
name|dc_connect
operator|)
decl_stmt|;
name|result
operator|=
name|RoAsynBindRetry
argument_list|(
name|sd
argument_list|,
name|do_next_nsap
argument_list|,
name|acc
argument_list|,
name|rni
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NOTOK
condition|)
block|{
return|return
operator|(
name|ronot2daplose
argument_list|(
name|di
argument_list|,
literal|"DAP-BIND.RETRY"
argument_list|,
name|rni
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|result
operator|==
name|DONE
condition|)
block|{
if|if
condition|(
name|DapBindDecode
argument_list|(
name|acc
argument_list|,
name|dc
argument_list|)
operator|!=
name|OK
condition|)
block|{
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DA_RES_DEC
argument_list|,
name|NULLCP
argument_list|,
literal|"DAP BIND RETRY"
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|int
name|DapBindDecode
parameter_list|(
name|acc
parameter_list|,
name|dc
parameter_list|)
name|struct
name|AcSAPconnect
modifier|*
name|acc
decl_stmt|;
name|struct
name|DAPconnect
modifier|*
name|dc
decl_stmt|;
block|{
name|struct
name|ds_bind_arg
modifier|*
name|bind_res
decl_stmt|;
name|struct
name|ds_bind_error
modifier|*
name|bind_err
decl_stmt|;
switch|switch
condition|(
name|acc
operator|->
name|acc_result
condition|)
block|{
case|case
name|ACS_ACCEPT
case|:
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"DapBindDecode ACCEPT"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|acc
operator|->
name|acc_ninfo
operator|==
literal|1
operator|)
operator|&&
operator|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
operator|!=
name|NULLPE
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|PDU_DUMP
name|pdu_dump
argument_list|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
argument_list|,
literal|"res"
argument_list|,
literal|100
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|decode_DAS_DirectoryBindResult
argument_list|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|,
name|NULLIP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|bind_res
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Unable to parse DirectoryBindResult"
operator|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DC_REJECT
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
name|dc
operator|->
name|dc_result
operator|=
name|DC_RESULT
expr_stmt|;
name|dc
operator|->
name|dc_un
operator|.
name|dc_bind_res
operator|=
operator|*
name|bind_res
expr_stmt|;
comment|/* struct copy */
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|bind_res
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"No DirectoryBindResult"
operator|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DC_REJECT
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
break|break;
case|case
name|ACS_PERMANENT
case|:
comment|/* 	    * Get the DirectoryBindError 	    */
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"DapBindDecode PERMANENT"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|acc
operator|->
name|acc_ninfo
operator|==
literal|1
operator|)
operator|&&
operator|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
operator|!=
name|NULLPE
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|PDU_DUMP
name|pdu_dump
argument_list|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
argument_list|,
literal|"err"
argument_list|,
literal|100
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|decode_DAS_DirectoryBindError
argument_list|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|,
name|NULLIP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|bind_err
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Unable to decode DirectoryBindError"
operator|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DC_REJECT
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
name|dc
operator|->
name|dc_result
operator|=
name|DC_ERROR
expr_stmt|;
name|dc
operator|->
name|dc_un
operator|.
name|dc_bind_err
operator|=
operator|*
name|bind_err
expr_stmt|;
comment|/* struct copy */
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|bind_err
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"No DirectoryBindError"
operator|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DC_REJECT
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
break|break;
default|default:
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"DapBindDecode OTHER"
operator|)
argument_list|)
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Association rejected: [%s]"
operator|,
name|AcErrString
argument_list|(
name|acc
operator|->
name|acc_result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|dc_result
operator|=
name|DC_REJECT
expr_stmt|;
return|return
operator|(
name|NOTOK
operator|)
return|;
block|}
comment|/* switch acc->acc_result */
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

end_unit


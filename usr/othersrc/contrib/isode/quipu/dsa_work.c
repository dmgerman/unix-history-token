begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* dsa_work.c - do some work on an active task. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/quipu/RCS/dsa_work.c,v 7.5 91/02/22 09:39:13 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * $Header: /f/osi/quipu/RCS/dsa_work.c,v 7.5 91/02/22 09:39:13 mrose Interim $  *  *  * $Log:	dsa_work.c,v $  * Revision 7.5  91/02/22  09:39:13  mrose  * Interim 6.8  *   * Revision 7.4  90/10/17  11:54:10  mrose  * sync  *   * Revision 7.3  90/07/09  14:46:05  mrose  * sync  *   * Revision 7.2  90/03/15  11:19:02  mrose  * quipu-sync  *   * Revision 7.1  89/12/19  16:20:32  mrose  * sync  *   * Revision 7.0  89/11/23  22:17:26  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *                                NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|"acsap.h"
end_include

begin_include
include|#
directive|include
file|"quipu/util.h"
end_include

begin_include
include|#
directive|include
file|"quipu/common.h"
end_include

begin_include
include|#
directive|include
file|"quipu/connection.h"
end_include

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|log_dsap
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|dsa_work
argument_list|(
name|tk
argument_list|)
specifier|register
expr|struct
name|task_act
operator|*
name|tk
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|struct
name|DSArgument
modifier|*
name|arg
decl_stmt|;
name|struct
name|DSError
modifier|*
name|err
decl_stmt|;
name|struct
name|DSResult
modifier|*
name|res
decl_stmt|;
name|DN
name|orig
init|=
name|NULLDN
decl_stmt|;
name|DN
name|base
init|=
name|NULLDN
decl_stmt|;
name|struct
name|ds_search_task
modifier|*
modifier|*
name|local
decl_stmt|;
name|struct
name|ds_search_task
modifier|*
modifier|*
name|refer
decl_stmt|;
name|int
name|dsa_ret
decl_stmt|;
name|struct
name|di_block
modifier|*
name|di
decl_stmt|;
name|char
name|dsp
decl_stmt|;
name|arg
operator|=
operator|&
operator|(
name|tk
operator|->
name|tk_dx
operator|.
name|dx_arg
operator|.
name|dca_dsarg
operator|)
expr_stmt|;
name|res
operator|=
operator|&
operator|(
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|)
expr_stmt|;
name|err
operator|=
operator|&
operator|(
name|tk
operator|->
name|tk_resp
operator|.
name|di_error
operator|.
name|de_err
operator|)
expr_stmt|;
name|local
operator|=
operator|&
operator|(
name|tk
operator|->
name|local_st
operator|)
expr_stmt|;
name|refer
operator|=
operator|&
operator|(
name|tk
operator|->
name|refer_st
operator|)
expr_stmt|;
if|if
condition|(
name|tk
operator|->
name|tk_conn
operator|->
name|cn_ctx
operator|==
name|DS_CTX_X500_DAP
condition|)
block|{
name|orig
operator|=
name|tk
operator|->
name|tk_conn
operator|->
name|cn_dn
expr_stmt|;
name|dsp
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|tk
operator|->
name|tk_dx
operator|.
name|dx_arg
operator|.
name|dca_charg
operator|.
name|cha_originator
operator|==
name|NULLDN
condition|)
block|{
switch|switch
condition|(
name|arg
operator|->
name|arg_type
condition|)
block|{
case|case
name|OP_READ
case|:
name|orig
operator|=
name|arg
operator|->
name|arg_rd
operator|.
name|rda_common
operator|.
name|ca_requestor
expr_stmt|;
break|break;
case|case
name|OP_COMPARE
case|:
name|orig
operator|=
name|arg
operator|->
name|arg_cm
operator|.
name|cma_common
operator|.
name|ca_requestor
expr_stmt|;
break|break;
case|case
name|OP_LIST
case|:
name|orig
operator|=
name|arg
operator|->
name|arg_ls
operator|.
name|lsa_common
operator|.
name|ca_requestor
expr_stmt|;
break|break;
case|case
name|OP_SEARCH
case|:
name|orig
operator|=
name|arg
operator|->
name|arg_sr
operator|.
name|sra_common
operator|.
name|ca_requestor
expr_stmt|;
break|break;
case|case
name|OP_ADDENTRY
case|:
name|orig
operator|=
name|arg
operator|->
name|arg_ad
operator|.
name|ada_common
operator|.
name|ca_requestor
expr_stmt|;
break|break;
case|case
name|OP_REMOVEENTRY
case|:
name|orig
operator|=
name|arg
operator|->
name|arg_rm
operator|.
name|rma_common
operator|.
name|ca_requestor
expr_stmt|;
break|break;
case|case
name|OP_MODIFYENTRY
case|:
name|orig
operator|=
name|arg
operator|->
name|arg_me
operator|.
name|mea_common
operator|.
name|ca_requestor
expr_stmt|;
break|break;
case|case
name|OP_MODIFYRDN
case|:
name|orig
operator|=
name|arg
operator|->
name|arg_mr
operator|.
name|mra_common
operator|.
name|ca_requestor
expr_stmt|;
break|break;
default|default:
name|orig
operator|=
name|NULLDN
expr_stmt|;
break|break;
block|}
block|}
else|else
name|orig
operator|=
name|tk
operator|->
name|tk_dx
operator|.
name|dx_arg
operator|.
name|dca_charg
operator|.
name|cha_originator
expr_stmt|;
if|if
condition|(
name|tk
operator|->
name|tk_dx
operator|.
name|dx_arg
operator|.
name|dca_charg
operator|.
name|cha_target
operator|==
name|NULLDN
condition|)
block|{
switch|switch
condition|(
name|arg
operator|->
name|arg_type
condition|)
block|{
case|case
name|OP_READ
case|:
name|base
operator|=
name|arg
operator|->
name|arg_rd
operator|.
name|rda_object
expr_stmt|;
break|break;
case|case
name|OP_COMPARE
case|:
name|base
operator|=
name|arg
operator|->
name|arg_cm
operator|.
name|cma_object
expr_stmt|;
break|break;
case|case
name|OP_LIST
case|:
name|base
operator|=
name|arg
operator|->
name|arg_ls
operator|.
name|lsa_object
expr_stmt|;
break|break;
case|case
name|OP_SEARCH
case|:
name|base
operator|=
name|arg
operator|->
name|arg_sr
operator|.
name|sra_baseobject
expr_stmt|;
break|break;
case|case
name|OP_ADDENTRY
case|:
name|base
operator|=
name|arg
operator|->
name|arg_ad
operator|.
name|ada_object
expr_stmt|;
break|break;
case|case
name|OP_REMOVEENTRY
case|:
name|base
operator|=
name|arg
operator|->
name|arg_rm
operator|.
name|rma_object
expr_stmt|;
break|break;
case|case
name|OP_MODIFYENTRY
case|:
name|base
operator|=
name|arg
operator|->
name|arg_me
operator|.
name|mea_object
expr_stmt|;
break|break;
case|case
name|OP_MODIFYRDN
case|:
name|base
operator|=
name|arg
operator|->
name|arg_mr
operator|.
name|mra_object
expr_stmt|;
break|break;
case|case
name|OP_GETEDB
case|:
name|base
operator|=
name|arg
operator|->
name|arg_ge
operator|.
name|ga_entry
expr_stmt|;
break|break;
default|default:
name|base
operator|=
name|NULLDN
expr_stmt|;
break|break;
block|}
block|}
else|else
name|base
operator|=
name|tk
operator|->
name|tk_dx
operator|.
name|dx_arg
operator|.
name|dca_charg
operator|.
name|cha_target
expr_stmt|;
name|dsp
operator|=
name|TRUE
expr_stmt|;
block|}
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_TRACE
argument_list|,
operator|(
literal|"Apply operation"
operator|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|NO_STATS
if|if
condition|(
operator|*
name|local
operator|==
name|NULL_ST
condition|)
name|log_x500_event
argument_list|(
name|arg
argument_list|,
name|tk
operator|->
name|tk_conn
operator|->
name|cn_ctx
argument_list|,
name|orig
argument_list|,
name|base
argument_list|,
name|tk
operator|->
name|tk_conn
operator|->
name|cn_ad
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|dsp
operator|&&
operator|(
name|tk
operator|->
name|tk_conn
operator|->
name|cn_authen
operator|==
name|DBA_AUTH_NONE
operator|)
condition|)
block|{
name|orig
operator|=
name|NULLDN
expr_stmt|;
block|}
switch|switch
condition|(
name|arg
operator|->
name|arg_type
condition|)
block|{
case|case
name|OP_READ
case|:
name|dsa_ret
operator|=
name|do_ds_read
argument_list|(
operator|&
operator|(
name|arg
operator|->
name|arg_rd
operator|)
argument_list|,
name|err
argument_list|,
operator|&
operator|(
name|res
operator|->
name|res_rd
operator|)
argument_list|,
name|orig
argument_list|,
name|base
argument_list|,
operator|&
operator|(
name|di
operator|)
argument_list|,
name|dsp
argument_list|,
name|tk
operator|->
name|tk_conn
operator|->
name|cn_ctx
operator|==
name|DS_CTX_QUIPU_DSP
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_COMPARE
case|:
name|dsa_ret
operator|=
name|do_ds_compare
argument_list|(
operator|&
operator|(
name|arg
operator|->
name|arg_cm
operator|)
argument_list|,
name|err
argument_list|,
operator|&
operator|(
name|res
operator|->
name|res_cm
operator|)
argument_list|,
name|orig
argument_list|,
name|base
argument_list|,
operator|&
operator|(
name|di
operator|)
argument_list|,
name|dsp
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_ABANDON
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_FATAL
argument_list|,
operator|(
literal|"Abandon being applied!"
operator|)
argument_list|)
expr_stmt|;
name|dsa_ret
operator|=
name|do_ds_abandon
argument_list|(
operator|&
operator|(
name|arg
operator|->
name|arg_ab
operator|)
argument_list|,
name|err
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_LIST
case|:
name|dsa_ret
operator|=
name|do_ds_list
argument_list|(
operator|&
operator|(
name|arg
operator|->
name|arg_ls
operator|)
argument_list|,
name|err
argument_list|,
operator|&
operator|(
name|res
operator|->
name|res_ls
operator|)
argument_list|,
name|orig
argument_list|,
name|base
argument_list|,
operator|&
operator|(
name|di
operator|)
argument_list|,
name|dsp
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_SEARCH
case|:
name|dsa_ret
operator|=
name|do_ds_search
argument_list|(
operator|&
operator|(
name|arg
operator|->
name|arg_sr
operator|)
argument_list|,
name|err
argument_list|,
operator|&
operator|(
name|res
operator|->
name|res_sr
operator|)
argument_list|,
name|orig
argument_list|,
name|base
argument_list|,
name|local
argument_list|,
name|refer
argument_list|,
operator|&
operator|(
name|di
operator|)
argument_list|,
name|dsp
argument_list|,
name|tk
operator|->
name|tk_conn
operator|->
name|cn_ctx
operator|==
name|DS_CTX_QUIPU_DSP
argument_list|,
name|tk
operator|->
name|tk_timed
condition|?
name|tk
operator|->
name|tk_timeout
else|:
operator|(
name|time_t
operator|)
literal|0
argument_list|,
name|tk
operator|->
name|tk_dx
operator|.
name|dx_arg
operator|.
name|dca_charg
operator|.
name|cha_entryonly
argument_list|)
expr_stmt|;
name|search_continue
argument_list|(
name|tk
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_ADDENTRY
case|:
name|dsa_ret
operator|=
name|do_ds_addentry
argument_list|(
operator|&
operator|(
name|arg
operator|->
name|arg_ad
operator|)
argument_list|,
name|err
argument_list|,
name|orig
argument_list|,
name|base
argument_list|,
operator|&
operator|(
name|di
operator|)
argument_list|,
name|dsp
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_REMOVEENTRY
case|:
name|dsa_ret
operator|=
name|do_ds_removeentry
argument_list|(
operator|&
operator|(
name|arg
operator|->
name|arg_rm
operator|)
argument_list|,
name|err
argument_list|,
name|orig
argument_list|,
name|base
argument_list|,
operator|&
operator|(
name|di
operator|)
argument_list|,
name|dsp
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_MODIFYENTRY
case|:
name|dsa_ret
operator|=
name|do_ds_modifyentry
argument_list|(
operator|&
operator|(
name|arg
operator|->
name|arg_me
operator|)
argument_list|,
name|err
argument_list|,
name|orig
argument_list|,
name|base
argument_list|,
operator|&
operator|(
name|di
operator|)
argument_list|,
name|dsp
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_MODIFYRDN
case|:
name|dsa_ret
operator|=
name|do_ds_modifyrdn
argument_list|(
operator|&
operator|(
name|arg
operator|->
name|arg_mr
operator|)
argument_list|,
name|err
argument_list|,
name|orig
argument_list|,
name|base
argument_list|,
operator|&
operator|(
name|di
operator|)
argument_list|,
name|dsp
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_GETEDB
case|:
name|orig
operator|=
name|tk
operator|->
name|tk_conn
operator|->
name|cn_dn
expr_stmt|;
name|dsa_ret
operator|=
name|do_get_edb
argument_list|(
operator|&
operator|(
name|arg
operator|->
name|arg_ge
operator|)
argument_list|,
name|err
argument_list|,
operator|&
operator|(
name|res
operator|->
name|res_ge
operator|)
argument_list|,
name|orig
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Unknown operation type!"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_TRACE
argument_list|,
operator|(
literal|"Activity applied"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dsa_ret
condition|)
block|{
case|case
name|DS_OK
case|:
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"dsa_work - DS_OK"
operator|)
argument_list|)
expr_stmt|;
comment|/* Task completed successfully: send result */
name|tk
operator|->
name|tk_result
operator|=
operator|&
operator|(
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|)
expr_stmt|;
name|tk
operator|->
name|tk_result
operator|->
name|dcr_dsres
operator|.
name|result_type
operator|=
name|tk
operator|->
name|tk_dx
operator|.
name|dx_arg
operator|.
name|dca_dsarg
operator|.
name|arg_type
expr_stmt|;
name|tk
operator|->
name|tk_resp
operator|.
name|di_type
operator|=
name|DI_RESULT
expr_stmt|;
if|if
condition|(
operator|(
name|tk
operator|->
name|referred_st
operator|!=
name|NULL_ST
operator|)
operator|||
operator|(
name|tk
operator|->
name|tk_operlist
operator|!=
name|NULLOPER
operator|)
condition|)
block|{
name|tk
operator|->
name|tk_state
operator|=
name|TK_PASSIVE
expr_stmt|;
break|break;
comment|/* Go wait for operations to return */
block|}
name|tk
operator|->
name|tk_resp
operator|.
name|di_type
operator|=
name|DI_RESULT
expr_stmt|;
name|task_conn_extract
argument_list|(
name|tk
argument_list|)
expr_stmt|;
name|task_result
argument_list|(
name|tk
argument_list|)
expr_stmt|;
name|task_extract
argument_list|(
name|tk
argument_list|)
expr_stmt|;
break|break;
case|case
name|DS_X500_ERROR
case|:
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"dsa_work - DS_X500_ERROR"
operator|)
argument_list|)
expr_stmt|;
comment|/* Task produced error: send error */
name|tk
operator|->
name|tk_resp
operator|.
name|di_type
operator|=
name|DI_ERROR
expr_stmt|;
name|tk
operator|->
name|tk_error
operator|=
operator|&
operator|(
name|tk
operator|->
name|tk_resp
operator|.
name|di_error
operator|.
name|de_err
operator|)
expr_stmt|;
name|task_conn_extract
argument_list|(
name|tk
argument_list|)
expr_stmt|;
name|task_error
argument_list|(
name|tk
argument_list|)
expr_stmt|;
if|if
condition|(
name|tk
operator|->
name|tk_dx
operator|.
name|dx_arg
operator|.
name|dca_dsarg
operator|.
name|arg_type
operator|==
name|OP_SEARCH
condition|)
block|{
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|.
name|res_sr
operator|.
name|srr_un
operator|.
name|srr_unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|.
name|res_sr
operator|.
name|srr_next
operator|->
name|srr_un
operator|.
name|srr_unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|.
name|res_sr
operator|.
name|srr_next
argument_list|)
expr_stmt|;
block|}
name|task_extract
argument_list|(
name|tk
argument_list|)
expr_stmt|;
break|break;
case|case
name|DS_CONTINUE
case|:
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"dsa_work - DS_CONTINUE"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|di_list_log
argument_list|(
name|di
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Task produced list of dsas: chain operation or send referral */
if|if
condition|(
name|task_chain
argument_list|(
name|tk
argument_list|,
name|di
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|task_conn_extract
argument_list|(
name|tk
argument_list|)
expr_stmt|;
name|task_error
argument_list|(
name|tk
argument_list|)
expr_stmt|;
if|if
condition|(
name|tk
operator|->
name|tk_dx
operator|.
name|dx_arg
operator|.
name|dca_dsarg
operator|.
name|arg_type
operator|==
name|OP_SEARCH
condition|)
block|{
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|.
name|res_sr
operator|.
name|srr_un
operator|.
name|srr_unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|.
name|res_sr
operator|.
name|srr_next
operator|->
name|srr_un
operator|.
name|srr_unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|.
name|res_sr
operator|.
name|srr_next
argument_list|)
expr_stmt|;
block|}
name|task_extract
argument_list|(
name|tk
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tk
operator|->
name|tk_state
operator|=
name|TK_PASSIVE
expr_stmt|;
block|}
break|break;
case|case
name|DS_SUSPEND
case|:
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"dsa_work - DS_SUSPEND"
operator|)
argument_list|)
expr_stmt|;
comment|/* Task has suspended itself to check network and other tasks */
if|if
condition|(
operator|(
name|tk
operator|->
name|referred_st
operator|!=
name|NULL_ST
operator|)
operator|||
operator|(
name|tk
operator|->
name|tk_operlist
operator|!=
name|NULLOPER
operator|)
condition|)
comment|/* doing things over the net - no need to hurry !!! */
name|tk
operator|->
name|tk_prio
operator|=
name|DSA_PRIO_LOW
expr_stmt|;
name|tk
operator|->
name|tk_state
operator|=
name|TK_SUSPEND
expr_stmt|;
break|break;
default|default:
comment|/* Local error */
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"dsa_work - do_ds_OP() failed"
operator|)
argument_list|)
expr_stmt|;
name|tk
operator|->
name|tk_resp
operator|.
name|di_error
operator|.
name|de_err
operator|.
name|dse_type
operator|=
name|DSE_SERVICEERROR
expr_stmt|;
name|tk
operator|->
name|tk_resp
operator|.
name|di_error
operator|.
name|de_err
operator|.
name|ERR_SERVICE
operator|.
name|DSE_sv_problem
operator|=
name|DSE_SV_DITERROR
expr_stmt|;
name|task_conn_extract
argument_list|(
name|tk
argument_list|)
expr_stmt|;
name|task_error
argument_list|(
name|tk
argument_list|)
expr_stmt|;
if|if
condition|(
name|tk
operator|->
name|tk_dx
operator|.
name|dx_arg
operator|.
name|dca_dsarg
operator|.
name|arg_type
operator|==
name|OP_SEARCH
condition|)
block|{
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|.
name|res_sr
operator|.
name|srr_un
operator|.
name|srr_unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|.
name|res_sr
operator|.
name|srr_next
operator|->
name|srr_un
operator|.
name|srr_unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|.
name|res_sr
operator|.
name|srr_next
argument_list|)
expr_stmt|;
block|}
name|task_extract
argument_list|(
name|tk
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_macro
name|search_continue
argument_list|(
argument|tk
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|task_act
modifier|*
name|tk
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|ds_search_result
modifier|*
name|tk_sr
init|=
operator|&
operator|(
name|tk
operator|->
name|tk_resp
operator|.
name|di_result
operator|.
name|dr_res
operator|.
name|dcr_dsres
operator|.
name|res_sr
operator|)
decl_stmt|;
comment|/* Set up next part of search result to collate remote sub-searches */
if|if
condition|(
name|tk_sr
operator|->
name|srr_next
operator|==
name|NULLSRR
condition|)
block|{
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"Allocating a search result"
operator|)
argument_list|)
expr_stmt|;
name|tk_sr
operator|->
name|srr_next
operator|=
operator|(
expr|struct
name|ds_search_result
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ds_search_result
argument_list|)
argument_list|)
expr_stmt|;
name|tk_sr
operator|->
name|srr_next
operator|->
name|srr_correlated
operator|=
name|TRUE
expr_stmt|;
name|tk_sr
operator|->
name|srr_next
operator|->
name|srr_un
operator|.
name|srr_unit
operator|=
operator|(
expr|struct
name|ds_search_unit
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ds_search_unit
argument_list|)
argument_list|)
expr_stmt|;
name|tk_sr
operator|->
name|srr_next
operator|->
name|CSR_limitproblem
operator|=
name|LSR_NOLIMITPROBLEM
expr_stmt|;
block|}
comment|/* Map any new elements in the refer list onto opers */
name|subtask_chain
argument_list|(
name|tk
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tk
operator|->
name|local_st
operator|!=
name|NULL_ST
operator|)
operator|&&
operator|(
name|tk
operator|->
name|tk_state
operator|==
name|TK_PASSIVE
operator|)
condition|)
block|{
name|tk
operator|->
name|tk_state
operator|=
name|TK_ACTIVE
expr_stmt|;
block|}
block|}
end_block

begin_ifndef
ifndef|#
directive|ifndef
name|NO_STATS
end_ifndef

begin_macro
name|log_x500_event
argument_list|(
argument|arg
argument_list|,
argument|context
argument_list|,
argument|orig
argument_list|,
argument|dsptarget
argument_list|,
argument|ad
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|DSArgument
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|context
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DN
name|dsptarget
decl_stmt|,
name|orig
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ad
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|LLog
modifier|*
name|log_stat
decl_stmt|;
name|char
modifier|*
name|op
decl_stmt|;
name|int
name|dn_print
parameter_list|()
function_decl|;
name|DN
name|daptarget
init|=
name|NULLDN
decl_stmt|;
name|char
name|buf
index|[
name|LINESIZE
index|]
decl_stmt|;
switch|switch
condition|(
name|arg
operator|->
name|arg_type
condition|)
block|{
case|case
name|OP_READ
case|:
name|op
operator|=
literal|"Read"
expr_stmt|;
name|daptarget
operator|=
name|arg
operator|->
name|arg_rd
operator|.
name|rda_object
expr_stmt|;
break|break;
case|case
name|OP_COMPARE
case|:
name|op
operator|=
literal|"Compare"
expr_stmt|;
name|daptarget
operator|=
name|arg
operator|->
name|arg_cm
operator|.
name|cma_object
expr_stmt|;
break|break;
case|case
name|OP_ABANDON
case|:
name|op
operator|=
literal|"Abandon"
expr_stmt|;
break|break;
case|case
name|OP_LIST
case|:
name|op
operator|=
literal|"List"
expr_stmt|;
name|daptarget
operator|=
name|arg
operator|->
name|arg_ls
operator|.
name|lsa_object
expr_stmt|;
break|break;
case|case
name|OP_SEARCH
case|:
name|op
operator|=
literal|"Search"
expr_stmt|;
name|daptarget
operator|=
name|arg
operator|->
name|arg_sr
operator|.
name|sra_baseobject
expr_stmt|;
break|break;
case|case
name|OP_ADDENTRY
case|:
name|op
operator|=
literal|"Add"
expr_stmt|;
name|daptarget
operator|=
name|arg
operator|->
name|arg_ad
operator|.
name|ada_object
expr_stmt|;
break|break;
case|case
name|OP_REMOVEENTRY
case|:
name|op
operator|=
literal|"Remove"
expr_stmt|;
name|daptarget
operator|=
name|arg
operator|->
name|arg_rm
operator|.
name|rma_object
expr_stmt|;
break|break;
case|case
name|OP_MODIFYENTRY
case|:
name|op
operator|=
literal|"Modify"
expr_stmt|;
name|daptarget
operator|=
name|arg
operator|->
name|arg_me
operator|.
name|mea_object
expr_stmt|;
break|break;
case|case
name|OP_MODIFYRDN
case|:
name|op
operator|=
literal|"Modifyrdn"
expr_stmt|;
name|daptarget
operator|=
name|arg
operator|->
name|arg_mr
operator|.
name|mra_object
expr_stmt|;
break|break;
case|case
name|OP_GETEDB
case|:
name|op
operator|=
literal|"Getedb"
expr_stmt|;
if|if
condition|(
name|dsptarget
operator|==
name|NULLDN
condition|)
block|{
name|dsptarget
operator|=
name|arg
operator|->
name|arg_ge
operator|.
name|ga_entry
expr_stmt|;
block|}
break|break;
default|default:
name|op
operator|=
literal|"Unknown op"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|context
operator|==
name|DS_CTX_X500_DAP
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s (%d)"
argument_list|,
name|op
argument_list|,
name|ad
argument_list|)
expr_stmt|;
name|pslog
argument_list|(
name|log_stat
argument_list|,
name|LLOG_NOTICE
argument_list|,
name|buf
argument_list|,
name|dn_print
argument_list|,
operator|(
name|caddr_t
operator|)
name|daptarget
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s (%d)"
argument_list|,
name|op
argument_list|,
name|ad
argument_list|)
expr_stmt|;
name|pslog
argument_list|(
name|log_stat
argument_list|,
name|LLOG_NOTICE
argument_list|,
name|buf
argument_list|,
name|dn_print
argument_list|,
operator|(
name|caddr_t
operator|)
name|dsptarget
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|->
name|arg_type
operator|!=
name|OP_GETEDB
condition|)
block|{
name|pslog
argument_list|(
name|log_stat
argument_list|,
name|LLOG_TRACE
argument_list|,
literal|"DAP Originator"
argument_list|,
name|dn_print
argument_list|,
operator|(
name|caddr_t
operator|)
name|orig
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


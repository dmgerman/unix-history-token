begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* imiscd.c - miscellaneous network service -- responder */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/imisc/RCS/imiscd.c,v 7.4 91/02/22 09:26:21 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/imisc/RCS/imiscd.c,v 7.4 91/02/22 09:26:21 mrose Interim $  *  *  * $Log:	imiscd.c,v $  * Revision 7.4  91/02/22  09:26:21  mrose  * Interim 6.8  *   * Revision 7.3  90/11/21  11:37:04  mrose  * update  *   * Revision 7.2  90/07/09  14:38:48  mrose  * sync  *   * Revision 7.1  90/07/01  21:04:05  mrose  * pepsy  *   * Revision 7.0  89/11/23  21:57:39  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"IMISC-types.h"
end_include

begin_comment
comment|/* IMISC type definitions */
end_comment

begin_include
include|#
directive|include
file|"ryresponder.h"
end_include

begin_comment
comment|/* for generic idempotent responders */
end_comment

begin_include
include|#
directive|include
file|"IMISC-ops.h"
end_include

begin_comment
comment|/* IMISC operation definitions */
end_comment

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SYS5
end_ifdef

begin_include
include|#
directive|include
file|<sys/times.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_comment
comment|/*
comment|DATA */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|myservice
init|=
literal|"isode miscellany"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* should be something else */
end_comment

begin_decl_stmt
specifier|static
name|int
name|execuid
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|execgid
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* OPERATIONS */
end_comment

begin_decl_stmt
name|int
name|op_utcTime
argument_list|()
decl_stmt|,
name|op_genTime
argument_list|()
decl_stmt|,
name|op_timeOfDay
argument_list|()
decl_stmt|,
name|op_users
argument_list|()
decl_stmt|,
name|op_charGen
argument_list|()
decl_stmt|,
name|op_pwdGen
argument_list|()
decl_stmt|,
name|op_exec
argument_list|()
decl_stmt|,
name|op_tellUser
argument_list|()
decl_stmt|,
name|op_data
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|dispatch
name|dispatches
index|[]
init|=
block|{
literal|"utcTime"
block|,
name|operation_IMISC_utcTime
block|,
name|op_utcTime
block|,
literal|"genTime"
block|,
name|operation_IMISC_genTime
block|,
name|op_genTime
block|,
literal|"timeOfDay"
block|,
name|operation_IMISC_timeOfDay
block|,
name|op_timeOfDay
block|,
literal|"users"
block|,
name|operation_IMISC_users
block|,
name|op_users
block|,
literal|"chargen"
block|,
name|operation_IMISC_charGen
block|,
name|op_charGen
block|,
literal|"pwdGen"
block|,
name|operation_IMISC_pwdGen
block|,
name|op_pwdGen
block|,
literal|"qotd"
block|,
name|operation_IMISC_qotd
block|,
name|op_exec
block|,
literal|"finger"
block|,
name|operation_IMISC_finger
block|,
name|op_exec
block|,
literal|"tellUser"
block|,
name|operation_IMISC_tellUser
block|,
name|op_tellUser
block|,
literal|"ping"
block|,
name|operation_IMISC_ping
block|,
name|op_data
block|,
literal|"sink"
block|,
name|operation_IMISC_sink
block|,
name|op_data
block|,
literal|"echo"
block|,
name|operation_IMISC_echo
block|,
name|op_data
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* TYPES */
end_comment

begin_function_decl
name|struct
name|type_IMISC_IA5List
modifier|*
name|str2ia5list
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_function_decl
name|long
name|time
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|ctime
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|MAIN */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|envp
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|,
decl|*
modifier|*
name|envp
decl_stmt|;
end_function

begin_block
block|{
name|ryresponder
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|PLocalHostName
argument_list|()
argument_list|,
name|myservice
argument_list|,
name|NULLCP
argument_list|,
name|dispatches
argument_list|,
name|table_IMISC_Operations
argument_list|,
name|NULLIFP
argument_list|,
name|NULLIFP
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_block

begin_comment
comment|/*
comment|OPERATIONS */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|op_utcTime
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
name|long
name|clock
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
name|struct
name|UTCtime
name|uts
decl_stmt|;
specifier|register
name|struct
name|UTCtime
modifier|*
name|ut
init|=
operator|&
name|uts
decl_stmt|;
specifier|register
name|struct
name|type_IMISC_UTCResult
modifier|*
name|ur
decl_stmt|;
if|if
condition|(
name|rox
operator|->
name|rox_nolinked
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s, unknown linkage %d"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|,
name|rox
operator|->
name|rox_linkid
argument_list|)
expr_stmt|;
return|return
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_LINKED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|time
argument_list|(
operator|&
name|clock
argument_list|)
operator|==
name|NOTOK
operator|||
operator|(
name|tm
operator|=
name|gmtime
argument_list|(
operator|&
name|clock
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_unableToDetermineTime
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
name|tm2ut
argument_list|(
name|tm
argument_list|,
name|ut
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|utct2str
argument_list|(
name|ut
argument_list|)
operator|)
operator|==
name|NULLCP
operator|||
operator|(
name|ur
operator|=
name|str2qb
argument_list|(
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_congested
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
operator|(
name|caddr_t
operator|)
name|ur
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RESULT"
argument_list|)
expr_stmt|;
name|free_IMISC_UTCResult
argument_list|(
name|ur
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|op_genTime
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
name|long
name|clock
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|BSD42
argument_list|)
operator|||
name|defined
argument_list|(
name|HPUX
argument_list|)
name|struct
name|timeval
name|tvs
decl_stmt|;
endif|#
directive|endif
specifier|register
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
name|struct
name|UTCtime
name|uts
decl_stmt|;
specifier|register
name|struct
name|UTCtime
modifier|*
name|ut
init|=
operator|&
name|uts
decl_stmt|;
specifier|register
name|struct
name|type_IMISC_GenResult
modifier|*
name|gr
decl_stmt|;
if|if
condition|(
name|rox
operator|->
name|rox_nolinked
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s, unknown linkage %d"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|,
name|rox
operator|->
name|rox_linkid
argument_list|)
expr_stmt|;
return|return
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_LINKED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|BSD42
argument_list|)
operator|||
name|defined
argument_list|(
name|HPUX
argument_list|)
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|tvs
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_unableToDetermineTime
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
name|clock
operator|=
name|tvs
operator|.
name|tv_sec
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|time
argument_list|(
operator|&
name|clock
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_unableToDetermineTime
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|tm
operator|=
name|gmtime
argument_list|(
operator|&
name|clock
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_unableToDetermineTime
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
name|tm2ut
argument_list|(
name|tm
argument_list|,
name|ut
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD42
name|ut
operator|->
name|ut_flags
operator||=
name|UT_USEC
expr_stmt|;
name|ut
operator|->
name|ut_usec
operator|=
name|tvs
operator|.
name|tv_usec
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|cp
operator|=
name|gent2str
argument_list|(
name|ut
argument_list|)
operator|)
operator|==
name|NULLCP
operator|||
operator|(
name|gr
operator|=
name|str2qb
argument_list|(
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_congested
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
operator|(
name|caddr_t
operator|)
name|gr
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RESULT"
argument_list|)
expr_stmt|;
name|free_IMISC_GenResult
argument_list|(
name|gr
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* Return the number of seconds since 00:00 (midnight) 1 January 1900 GMT */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|op_timeOfDay
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
name|long
name|clock
decl_stmt|;
name|struct
name|type_IMISC_TimeResult
name|trs
decl_stmt|;
specifier|register
name|struct
name|type_IMISC_TimeResult
modifier|*
name|tr
init|=
operator|&
name|trs
decl_stmt|;
if|if
condition|(
name|rox
operator|->
name|rox_nolinked
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s, unknown linkage %d"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|,
name|rox
operator|->
name|rox_linkid
argument_list|)
expr_stmt|;
return|return
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_LINKED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|time
argument_list|(
operator|&
name|clock
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_unableToDetermineTime
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
name|tr
operator|->
name|parm
operator|=
name|clock
operator|+
literal|2208988800
expr_stmt|;
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
operator|(
name|caddr_t
operator|)
name|tr
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RESULT"
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|sun
end_ifdef

begin_define
define|#
directive|define
name|BSD42
end_define

begin_undef
undef|#
directive|undef
name|SYS5
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|bsd43_ut_host
end_ifdef

begin_undef
undef|#
directive|undef
name|BSD42
end_undef

begin_define
define|#
directive|define
name|SYS5
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|BSD42
end_ifdef

begin_define
define|#
directive|define
name|HMAX
value|(sizeof (ut -> ut_host))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|LMAX
value|(sizeof (ut -> ut_line))
end_define

begin_define
define|#
directive|define
name|NMAX
value|(sizeof (ut -> ut_name))
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|SYS5
end_ifdef

begin_function_decl
name|struct
name|utmp
modifier|*
name|getutent
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|op_users
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
ifndef|#
directive|ifndef
name|SYS5
name|int
name|ud
decl_stmt|;
endif|#
directive|endif
specifier|register
name|char
modifier|*
name|dp
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|utmp
name|uts
decl_stmt|;
specifier|register
name|struct
name|utmp
modifier|*
name|ut
init|=
operator|&
name|uts
decl_stmt|;
name|struct
name|type_IMISC_IA5List
modifier|*
name|ia5
decl_stmt|;
specifier|register
name|struct
name|type_IMISC_IA5List
modifier|*
modifier|*
name|ia5p
decl_stmt|;
if|if
condition|(
name|rox
operator|->
name|rox_nolinked
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s, unknown linkage %d"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|,
name|rox
operator|->
name|rox_linkid
argument_list|)
expr_stmt|;
return|return
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_LINKED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|)
expr_stmt|;
name|ia5
operator|=
name|NULL
expr_stmt|;
name|ia5p
operator|=
operator|&
name|ia5
expr_stmt|;
ifndef|#
directive|ifndef
name|SYS5
if|if
condition|(
operator|(
name|ud
operator|=
name|open
argument_list|(
literal|"/etc/utmp"
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|int
name|result
decl_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"/etc/utmp: %s"
argument_list|,
name|sys_errname
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ia5p
operator|=
name|str2ia5list
argument_list|(
name|buffer
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
name|ia5p
operator|=
operator|&
operator|(
operator|(
operator|*
name|ia5p
operator|)
operator|->
name|next
operator|)
expr_stmt|;
name|result
operator|=
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_unableToOpenFile
argument_list|,
operator|(
name|caddr_t
operator|)
name|ia5
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
expr_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
while|while
condition|(
name|read
argument_list|(
name|ud
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ut
argument_list|,
sizeof|sizeof
expr|*
name|ut
argument_list|)
operator|==
sizeof|sizeof
expr|*
name|ut
condition|)
block|{
if|if
condition|(
name|ut
operator|->
name|ut_name
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
operator|(
name|dp
operator|=
name|ctime
argument_list|(
operator|&
name|ut
operator|->
name|ut_time
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%-*.*s %-*.*s %.12s"
argument_list|,
name|NMAX
argument_list|,
name|NMAX
argument_list|,
name|ut
operator|->
name|ut_name
argument_list|,
name|LMAX
argument_list|,
name|LMAX
argument_list|,
name|ut
operator|->
name|ut_line
argument_list|,
name|dp
operator|+
literal|4
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD42
if|if
condition|(
name|ut
operator|->
name|ut_host
index|[
literal|0
index|]
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
operator|+
name|strlen
argument_list|(
name|buffer
argument_list|)
argument_list|,
literal|"\t(%.*s)"
argument_list|,
name|HMAX
argument_list|,
name|ut
operator|->
name|ut_host
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
operator|*
name|ia5p
operator|=
name|str2ia5list
argument_list|(
name|buffer
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
name|ia5p
operator|=
operator|&
operator|(
operator|(
operator|*
name|ia5p
operator|)
operator|->
name|next
operator|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|ud
argument_list|)
expr_stmt|;
else|#
directive|else
name|setutent
argument_list|()
expr_stmt|;
while|while
condition|(
name|ut
operator|=
name|getutent
argument_list|()
condition|)
block|{
if|if
condition|(
name|ut
operator|->
name|ut_type
operator|!=
name|USER_PROCESS
condition|)
continue|continue;
if|if
condition|(
operator|(
name|dp
operator|=
name|ctime
argument_list|(
operator|&
name|ut
operator|->
name|ut_time
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%-*.*s %-*.*s %.12s"
argument_list|,
name|NMAX
argument_list|,
name|NMAX
argument_list|,
name|ut
operator|->
name|ut_name
argument_list|,
name|LMAX
argument_list|,
name|LMAX
argument_list|,
name|ut
operator|->
name|ut_line
argument_list|,
name|dp
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ia5p
operator|=
name|str2ia5list
argument_list|(
name|buffer
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
name|ia5p
operator|=
operator|&
operator|(
operator|(
operator|*
name|ia5p
operator|)
operator|->
name|next
operator|)
expr_stmt|;
block|}
name|endutent
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
operator|(
name|caddr_t
operator|)
name|ia5
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RESULT"
argument_list|)
expr_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
name|congested
label|:
empty_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_congested
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|bsd43_ut_host
end_ifdef

begin_define
define|#
directive|define
name|BSD42
end_define

begin_undef
undef|#
directive|undef
name|SYS5
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|NBYTES
value|512
end_define

begin_define
define|#
directive|define
name|LINSIZ
value|72
end_define

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|op_charGen
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|char
modifier|*
name|dp
decl_stmt|,
modifier|*
name|de
decl_stmt|,
modifier|*
name|rs
decl_stmt|,
modifier|*
name|rp
decl_stmt|,
modifier|*
name|re
decl_stmt|;
name|char
name|line
index|[
name|LINSIZ
operator|+
literal|1
index|]
decl_stmt|,
name|ring
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|type_IMISC_IA5List
modifier|*
name|ia5
decl_stmt|;
specifier|register
name|struct
name|type_IMISC_IA5List
modifier|*
modifier|*
name|ia5p
decl_stmt|;
if|if
condition|(
name|rox
operator|->
name|rox_nolinked
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s, unknown linkage %d"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|,
name|rox
operator|->
name|rox_linkid
argument_list|)
expr_stmt|;
return|return
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_LINKED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|)
expr_stmt|;
name|re
operator|=
name|ring
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x80
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|isprint
argument_list|(
operator|(
name|u_char
operator|)
name|i
argument_list|)
condition|)
operator|*
name|re
operator|++
operator|=
name|i
expr_stmt|;
name|ia5
operator|=
name|NULL
expr_stmt|;
name|ia5p
operator|=
operator|&
name|ia5
expr_stmt|;
for|for
control|(
name|rs
operator|=
name|ring
operator|,
name|i
operator|=
name|NBYTES
init|;
name|i
operator|>
literal|0
condition|;
name|rs
operator|++
operator|,
name|i
operator|-=
name|j
control|)
block|{
if|if
condition|(
name|rs
operator|>=
name|re
condition|)
name|rs
operator|=
name|ring
expr_stmt|;
name|j
operator|=
name|i
operator|>
name|LINSIZ
condition|?
name|LINSIZ
else|:
name|i
expr_stmt|;
for|for
control|(
name|de
operator|=
operator|(
name|dp
operator|=
name|line
operator|)
operator|+
name|j
operator|,
name|rp
operator|=
name|rs
init|;
name|dp
operator|<
name|de
condition|;
name|dp
operator|++
operator|,
name|rp
operator|++
control|)
block|{
if|if
condition|(
name|rp
operator|>=
name|re
condition|)
name|rp
operator|=
name|ring
expr_stmt|;
operator|*
name|dp
operator|=
operator|*
name|rp
expr_stmt|;
block|}
operator|*
name|dp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ia5p
operator|=
name|str2ia5list
argument_list|(
name|line
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
name|ia5p
operator|=
operator|&
operator|(
operator|(
operator|*
name|ia5p
operator|)
operator|->
name|next
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
operator|(
name|caddr_t
operator|)
name|ia5
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RESULT"
argument_list|)
expr_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
name|congested
label|:
empty_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_congested
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|NPASS
value|6
end_define

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|op_pwdGen
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|type_IMISC_IA5List
modifier|*
name|ia5
decl_stmt|;
specifier|register
name|struct
name|type_IMISC_IA5List
modifier|*
modifier|*
name|ia5p
decl_stmt|;
if|if
condition|(
name|rox
operator|->
name|rox_nolinked
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s, unknown linkage %d"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|,
name|rox
operator|->
name|rox_linkid
argument_list|)
expr_stmt|;
return|return
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_LINKED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|)
expr_stmt|;
name|ia5
operator|=
name|NULL
expr_stmt|;
name|ia5p
operator|=
operator|&
name|ia5
expr_stmt|;
for|for
control|(
name|i
operator|=
name|NPASS
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|pwdgen
argument_list|(
name|buffer
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|congested
goto|;
if|if
condition|(
operator|(
operator|*
name|ia5p
operator|=
name|str2ia5list
argument_list|(
name|buffer
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
name|ia5p
operator|=
operator|&
operator|(
operator|(
operator|*
name|ia5p
operator|)
operator|->
name|next
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
operator|(
name|caddr_t
operator|)
name|ia5
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RESULT"
argument_list|)
expr_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
name|congested
label|:
empty_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_congested
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* Based on an f77 algorithm supplied by Frank Wancho<Wancho@SIMTEL20>,    which was based on a basic algorithm by Paul D. Merillat and Arthur A. Key.     Strings returned are built by alternating vowels and consonants.    However, there are "Digraphs", and these are presorted according to    END, MIDDLE, and START positions.     Not going into combinatorial analysis (with 7 characters the "possible"    combinations exceed 20 million).  */
end_comment

begin_define
define|#
directive|define
name|TOT
value|54636577
end_define

begin_struct
specifier|static
struct|struct
name|pair
block|{
name|char
modifier|*
name|p_form
decl_stmt|;
name|int
name|p_value
decl_stmt|;
block|}
name|pairs
index|[]
init|=
block|{
literal|"cvcvcvce"
block|,
literal|0
block|,
literal|"vcvcvcvc"
block|,
literal|10827189
block|,
literal|"cpcpce"
block|,
literal|13725209
block|,
literal|"dvcpce"
block|,
literal|14036249
block|,
literal|"vcvcpce"
block|,
literal|14327369
block|,
literal|"cvcpme"
block|,
literal|15296369
block|,
literal|"dvcvcvc"
block|,
literal|15746954
block|,
literal|"cpcvcvc"
block|,
literal|16617618
block|,
literal|"cvmvcvc"
block|,
literal|17547858
block|,
literal|"cvcpcvc"
block|,
literal|23616474
block|,
literal|"cvcvmvc"
block|,
literal|24546714
block|,
literal|"dpcvce"
block|,
literal|30618378
block|,
literal|"dvmvce"
block|,
literal|30908898
block|,
literal|"cpmvce"
block|,
literal|32807107
block|,
literal|"vmvcvce"
block|,
literal|34838173
block|,
literal|"vcpcvce"
block|,
literal|41163763
block|,
literal|"vcvmvce"
block|,
literal|42132163
block|,
literal|"vmvmvc"
block|,
literal|48449078
block|,
literal|"vmpcvc"
block|,
literal|51995642
block|,
literal|"vmvcpc"
block|,
literal|52539386
block|,
literal|"vcvmpc"
block|,
literal|52962661
block|,
literal|"vmpme"
block|,
literal|53385611
block|,
literal|"dvmpc"
block|,
literal|53648987
block|,
literal|"cpmpc"
block|,
literal|53776002
block|,
literal|"cvcvcpc"
block|,
literal|53912072
block|,
name|NULL
block|,
name|TOT
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Mx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Nx
init|=
comment|/* XXX */
literal|"BBBCBFBKBLBMBNBPBTBVCCCDCFCMCPDBDCDDDFDGDKDLDMDNDPDTDVDWDZFBFCFDFGFKFMFNF\ PFZGBGDGFGJGMGNGPGTGVKBKDKFKMKNKPKTKVKZLBLCLFLGLMLNLRLVLZMBMCMDMFMGMJMKMLMMMNM\ RMTMVMZNBNCNFNOSZTBTCTDTFTGTJTKTLTMTNTPTVVCVGVLVPNJNLNPNRPCPDPFPGPKPMPNPVPZRBR\ CRDRFRGRJRLSBSDSFSGSJSRSV"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Cx
init|=
comment|/* consonants */
literal|"BCDFGHJKLMNPRSTVWZ"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Vx
init|=
comment|/* vowels */
literal|"AEIOU"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Dx
init|=
comment|/* consonant pairs */
literal|"BRCHCLCRDRFLFRGLGRKLKRPHPLPRQUSCSHSKSLSMSNSPSTSWTHTRTW"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Lx
init|=
comment|/* end-consonant pairs */
literal|"BSCKCSCTDSFSFTGSHSKSLLLDLKLPLSLTMPMSNDNKNNNSNTPPPSPTRKRMRNRPRSSSTSVSWS"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Px
init|=
comment|/* vowel pairs */
literal|"AIEAEEIEIOOIOOOU"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Ex
init|=
comment|/* end-vowels */
literal|"EOAY"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Zx
init|=
comment|/* end-vowel pairs */
literal|"EEOOAYEYOY"
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
name|web
block|{
name|char
name|w_key
decl_stmt|;
name|int
name|w_length
decl_stmt|;
name|int
name|w_factor
decl_stmt|;
name|char
modifier|*
modifier|*
name|w_string
decl_stmt|;
name|char
modifier|*
name|w_special
decl_stmt|;
block|}
name|webs
index|[]
init|=
block|{
literal|'m'
block|,
literal|189
block|,
literal|2
block|,
operator|&
name|Mx
block|,
name|NULL
block|,
literal|'c'
block|,
literal|18
block|,
literal|1
block|,
operator|&
name|Cx
block|,
literal|"HWJ"
block|,
literal|'v'
block|,
literal|5
block|,
literal|1
block|,
operator|&
name|Vx
block|,
name|NULL
block|,
literal|'d'
block|,
literal|27
block|,
literal|2
block|,
operator|&
name|Dx
block|,
name|NULL
block|,
literal|'l'
block|,
literal|35
block|,
literal|2
block|,
operator|&
name|Lx
block|,
name|NULL
block|,
literal|'p'
block|,
literal|8
block|,
literal|2
block|,
operator|&
name|Px
block|,
name|NULL
block|,
literal|'e'
block|,
literal|4
block|,
literal|1
block|,
operator|&
name|Ex
block|,
name|NULL
block|,
literal|'z'
block|,
literal|5
block|,
literal|2
block|,
operator|&
name|Zx
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
struct|;
end_struct

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|ifix
parameter_list|(
name|f
parameter_list|)
value|((int) ((float) (f) + 0.5))
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|SYS5
end_ifndef

begin_define
define|#
directive|define
name|nrand
parameter_list|()
value|(((float) (random ()) / (float) 2147483647))
end_define

begin_function_decl
name|long
name|random
parameter_list|()
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|nrand
parameter_list|()
value|(((float) (rand ()) / (float) 2147483647))
end_define

begin_decl_stmt
name|int
name|rand
argument_list|()
decl_stmt|,
name|srand
argument_list|()
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|rng
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|if (((i = ifix (a * nrand ()) * b) ? i -= b : i)< 0 \ 				|| i>= a * b + (1 - b)) \ 			    return NOTOK;
end_define

begin_function
specifier|static
name|int
name|pwdgen
parameter_list|(
name|pw
parameter_list|)
name|char
modifier|*
name|pw
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|char
name|c
decl_stmt|,
modifier|*
name|f
decl_stmt|,
modifier|*
name|s
decl_stmt|;
specifier|register
name|struct
name|pair
modifier|*
name|pair
decl_stmt|;
specifier|register
name|struct
name|web
modifier|*
name|web
decl_stmt|;
specifier|static
name|int
name|latch
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|latch
condition|)
block|{
if|if
condition|(
operator|(
name|Mx
operator|=
name|malloc
argument_list|(
operator|(
call|(
name|unsigned
call|)
argument_list|(
name|strlen
argument_list|(
name|Dx
argument_list|)
operator|+
name|strlen
argument_list|(
name|Lx
argument_list|)
operator|+
name|strlen
argument_list|(
name|Nx
argument_list|)
argument_list|)
operator|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|s
operator|=
name|Mx
argument_list|,
name|Dx
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|s
argument_list|,
name|Lx
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|s
argument_list|,
name|Nx
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|SYS5
operator|(
name|void
operator|)
name|srandom
argument_list|(
operator|(
name|int
operator|)
name|time
argument_list|(
operator|(
name|long
operator|*
operator|)
literal|0
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
operator|(
name|void
operator|)
name|srand
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|time
argument_list|(
operator|(
name|long
operator|*
operator|)
literal|0
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|latch
operator|++
expr_stmt|;
block|}
name|rng
argument_list|(
name|TOT
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
for|for
control|(
name|pair
operator|=
name|pairs
init|;
name|pair
operator|->
name|p_form
condition|;
name|pair
operator|++
control|)
if|if
condition|(
name|pair
operator|->
name|p_value
operator|<
name|i
condition|)
name|f
operator|=
name|pair
operator|->
name|p_form
expr_stmt|;
else|else
break|break;
do|do
block|{
for|for
control|(
name|s
operator|=
name|pw
init|;
name|c
operator|=
operator|*
name|f
operator|++
condition|;
control|)
block|{
for|for
control|(
name|web
operator|=
name|webs
init|;
name|web
operator|->
name|w_key
operator|!=
name|c
condition|;
name|web
operator|++
control|)
if|if
condition|(
name|web
operator|->
name|w_key
operator|==
name|c
condition|)
break|break;
if|if
condition|(
operator|!
name|web
operator|->
name|w_key
condition|)
return|return
name|NOTOK
return|;
name|rng
argument_list|(
name|web
operator|->
name|w_length
argument_list|,
name|web
operator|->
name|w_factor
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
name|web
operator|->
name|w_factor
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
operator|*
name|s
operator|++
operator|=
operator|(
operator|*
name|web
operator|->
name|w_string
operator|)
index|[
name|i
operator|++
index|]
expr_stmt|;
if|if
condition|(
name|web
operator|->
name|w_special
operator|&&
operator|*
name|f
operator|==
name|NULL
condition|)
block|{
name|s
operator|--
operator|,
name|i
operator|--
expr_stmt|;
while|while
condition|(
name|index
argument_list|(
name|web
operator|->
name|w_special
argument_list|,
operator|*
name|s
argument_list|)
condition|)
operator|*
name|s
operator|=
operator|(
operator|*
name|web
operator|->
name|w_string
operator|)
index|[
operator|--
name|i
index|]
expr_stmt|;
name|s
operator|++
expr_stmt|;
block|}
block|}
operator|*
name|s
operator|=
name|NULL
expr_stmt|;
block|}
do|while
condition|(
name|object
argument_list|(
name|pw
argument_list|)
condition|)
do|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_struct
specifier|static
struct|struct
name|obj
block|{
name|char
modifier|*
name|o_string
decl_stmt|;
name|int
name|o_advance
decl_stmt|;
block|}
name|objects
index|[]
init|=
block|{
literal|"TRAFLLEHPARCTIHS"
block|,
literal|4
block|,
literal|"SIPSSATITDOGCUFKUF"
block|,
literal|3
block|,
name|NULL
block|,
literal|0
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|object
parameter_list|(
name|pw
parameter_list|)
specifier|register
name|char
modifier|*
name|pw
decl_stmt|;
block|{
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|char
modifier|*
name|f
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|struct
name|obj
modifier|*
name|o
decl_stmt|;
for|for
control|(
name|f
operator|=
name|buffer
operator|+
name|strlen
argument_list|(
name|s
operator|=
name|pw
argument_list|)
operator|,
operator|*
name|f
operator|=
name|NULL
init|;
operator|*
name|s
condition|;
name|s
operator|++
control|)
operator|*
operator|--
name|f
operator|=
operator|*
name|s
expr_stmt|;
for|for
control|(
name|o
operator|=
name|objects
init|;
name|s
operator|=
name|o
operator|->
name|o_string
condition|;
name|o
operator|++
control|)
for|for
control|(
name|n
operator|=
name|o
operator|->
name|o_advance
init|;
operator|*
name|s
condition|;
name|s
operator|+=
name|n
control|)
if|if
condition|(
name|strncmp
argument_list|(
name|f
argument_list|,
name|s
argument_list|,
name|n
argument_list|)
operator|==
literal|0
condition|)
return|return
name|NOTOK
return|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|FORTUNE
end_ifndef

begin_define
define|#
directive|define
name|FORTUNE
value|"/usr/games/fortune"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|RFINGER
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|SYS5
end_ifndef

begin_define
define|#
directive|define
name|RFINGER
value|"/usr/ucb/finger"
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|RFINGER
value|"/usr/bin/finger"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|op_exec
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
name|int
name|fd
decl_stmt|,
name|i
decl_stmt|,
name|result
decl_stmt|,
name|vecp
decl_stmt|,
name|vecq
decl_stmt|,
name|pd
index|[
literal|2
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|bp
decl_stmt|,
modifier|*
name|dp
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|data
index|[
name|BUFSIZ
index|]
decl_stmt|,
modifier|*
name|pgm
decl_stmt|,
modifier|*
name|vec
index|[
name|NVEC
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|type_IMISC_IA5List
modifier|*
name|ia5
decl_stmt|;
specifier|register
name|struct
name|type_IMISC_IA5List
modifier|*
modifier|*
name|ia5p
decl_stmt|;
name|vecp
operator|=
name|vecq
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rox
operator|->
name|rox_nolinked
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s, unknown linkage %d"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|,
name|rox
operator|->
name|rox_linkid
argument_list|)
expr_stmt|;
name|result
operator|=
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_LINKED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ryo
operator|->
name|ryo_op
operator|==
name|operation_IMISC_qotd
condition|)
block|{
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|pgm
operator|=
name|FORTUNE
expr_stmt|;
name|vecq
operator|=
name|vecp
expr_stmt|;
block|}
else|else
block|{
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|pgm
operator|=
name|RFINGER
expr_stmt|;
ifdef|#
directive|ifdef
name|RFOPT1
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|RFOPT1
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|RFOPT2
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|RFOPT2
expr_stmt|;
endif|#
directive|endif
name|vecq
operator|=
name|vecp
expr_stmt|;
for|for
control|(
name|ia5
operator|=
operator|(
expr|struct
name|type_IMISC_IA5List
operator|*
operator|)
name|in
init|;
name|ia5
condition|;
name|ia5
operator|=
name|ia5
operator|->
name|next
control|)
if|if
condition|(
name|vecp
operator|>=
name|NVEC
operator|||
operator|(
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|qb2str
argument_list|(
name|ia5
operator|->
name|IA5String
argument_list|)
operator|)
operator|==
name|NULLCP
condition|)
block|{
name|result
operator|=
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_congested
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|vec
index|[
name|vecp
index|]
operator|=
name|NULLCP
expr_stmt|;
name|ia5
operator|=
name|NULL
expr_stmt|;
name|ia5p
operator|=
operator|&
name|ia5
expr_stmt|;
if|if
condition|(
name|access
argument_list|(
name|pgm
argument_list|,
literal|1
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|result
operator|=
name|error_IMISC_unableToAccessFile
expr_stmt|;
name|oops
label|:
empty_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
name|ia5
operator|=
name|NULL
expr_stmt|;
name|ia5p
operator|=
operator|&
name|ia5
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s: %s"
argument_list|,
name|pgm
argument_list|,
name|sys_errname
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ia5p
operator|=
name|str2ia5list
argument_list|(
name|buffer
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
name|ia5p
operator|=
operator|&
operator|(
operator|(
operator|*
name|ia5p
operator|)
operator|->
name|next
operator|)
expr_stmt|;
name|result
operator|=
name|error
argument_list|(
name|sd
argument_list|,
name|result
argument_list|,
operator|(
name|caddr_t
operator|)
name|ia5
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
expr_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|pipe
argument_list|(
name|pd
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|result
operator|=
name|error_IMISC_unableToPipe
expr_stmt|;
goto|goto
name|oops
goto|;
block|}
switch|switch
condition|(
name|vfork
argument_list|()
condition|)
block|{
case|case
name|NOTOK
case|:
operator|(
name|void
operator|)
name|close
argument_list|(
name|pd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|result
operator|=
name|error_IMISC_unableToFork
expr_stmt|;
goto|goto
name|oops
goto|;
case|case
name|OK
case|:
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
literal|"/dev/null"
argument_list|,
literal|2
argument_list|)
operator|)
operator|!=
name|NOTOK
condition|)
block|{
if|if
condition|(
name|fd
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|dup2
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|)
operator|,
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|dup2
argument_list|(
name|pd
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dup2
argument_list|(
name|pd
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|execuid
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|setgid
argument_list|(
name|execgid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setuid
argument_list|(
name|execuid
argument_list|)
expr_stmt|;
block|}
name|execvp
argument_list|(
name|pgm
argument_list|,
name|vec
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
default|default:
operator|(
name|void
operator|)
name|close
argument_list|(
name|pd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|vecp
operator|=
name|vecq
init|;
name|bp
operator|=
name|vec
index|[
name|vecp
index|]
condition|;
name|vecp
operator|++
control|)
block|{
name|free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|vec
index|[
name|vecp
index|]
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
init|;
name|vecq
operator|<
name|vecp
condition|;
name|vecq
operator|++
control|)
if|if
condition|(
name|bp
operator|=
name|vec
index|[
name|vecq
index|]
condition|)
name|free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|data
init|;
condition|;
control|)
switch|switch
condition|(
name|i
operator|=
name|read
argument_list|(
name|pd
index|[
literal|0
index|]
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|i
operator|=
name|errno
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|errno
operator|=
name|i
expr_stmt|;
name|result
operator|=
name|error_IMISC_errorReading
expr_stmt|;
goto|goto
name|oops
goto|;
case|case
name|OK
case|:
operator|(
name|void
operator|)
name|close
argument_list|(
name|pd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|!=
name|data
condition|)
block|{
operator|*
name|dp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ia5p
operator|=
name|str2ia5list
argument_list|(
name|data
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
name|ia5p
operator|=
operator|&
operator|(
operator|(
operator|*
name|ia5p
operator|)
operator|->
name|next
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
operator|(
name|caddr_t
operator|)
name|ia5
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RESULT"
argument_list|)
expr_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
name|result
operator|=
name|OK
expr_stmt|;
goto|goto
name|out
goto|;
default|default:
for|for
control|(
name|bp
operator|=
name|buffer
init|;
name|i
operator|>
literal|0
condition|;
name|bp
operator|++
operator|,
name|i
operator|--
control|)
switch|switch
condition|(
operator|*
name|bp
condition|)
block|{
case|case
literal|'\n'
case|:
operator|*
name|dp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ia5p
operator|=
name|str2ia5list
argument_list|(
name|data
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
name|ia5p
operator|=
operator|&
operator|(
operator|(
operator|*
name|ia5p
operator|)
operator|->
name|next
operator|)
expr_stmt|;
name|dp
operator|=
name|data
expr_stmt|;
break|break;
case|case
name|NULL
case|:
break|break;
default|default:
operator|*
name|dp
operator|++
operator|=
operator|*
name|bp
expr_stmt|;
break|break;
block|}
continue|continue;
block|}
block|}
name|congested
label|:
empty_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
name|result
operator|=
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_congested
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
expr_stmt|;
name|out
label|:
empty_stmt|;
for|for
control|(
name|vecp
operator|=
name|vecq
init|;
name|bp
operator|=
name|vec
index|[
name|vecp
index|]
condition|;
name|vecp
operator|++
control|)
name|free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|op_tellUser
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
ifndef|#
directive|ifndef
name|SYS5
name|int
name|ud
decl_stmt|;
endif|#
directive|endif
name|int
name|hit
decl_stmt|,
name|result
decl_stmt|,
name|vecp
decl_stmt|;
name|char
modifier|*
name|bp
decl_stmt|,
modifier|*
name|fromuser
decl_stmt|,
modifier|*
name|touser
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|,
modifier|*
modifier|*
name|vec
decl_stmt|,
modifier|*
name|vecl
index|[
name|NVEC
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|utmp
name|uts
decl_stmt|;
specifier|register
name|struct
name|utmp
modifier|*
name|ut
init|=
operator|&
name|uts
decl_stmt|;
name|struct
name|type_IMISC_IA5List
modifier|*
name|ia5
decl_stmt|;
name|vecp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rox
operator|->
name|rox_nolinked
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s, unknown linkage %d"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|,
name|rox
operator|->
name|rox_linkid
argument_list|)
expr_stmt|;
name|result
operator|=
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_LINKED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|)
expr_stmt|;
for|for
control|(
name|ia5
operator|=
operator|(
expr|struct
name|type_IMISC_IA5List
operator|*
operator|)
name|in
init|;
name|ia5
condition|;
name|ia5
operator|=
name|ia5
operator|->
name|next
control|)
if|if
condition|(
name|vecp
operator|>=
name|NVEC
operator|||
operator|(
name|vecl
index|[
name|vecp
operator|++
index|]
operator|=
name|qb2str
argument_list|(
name|ia5
operator|->
name|IA5String
argument_list|)
operator|)
operator|==
name|NULLCP
condition|)
goto|goto
name|congested
goto|;
name|vecl
index|[
name|vecp
index|]
operator|=
name|NULLCP
expr_stmt|;
if|if
condition|(
name|vecp
operator|<
literal|3
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"too few arguments (got %d, wanted at least 3)"
argument_list|,
name|vecp
argument_list|)
expr_stmt|;
name|result
operator|=
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_MISTYPED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|fromuser
operator|=
name|vecl
index|[
literal|0
index|]
expr_stmt|;
name|touser
operator|=
name|vecl
index|[
literal|1
index|]
expr_stmt|;
name|vec
operator|=
operator|&
name|vecl
index|[
literal|2
index|]
operator|,
name|vecp
operator|-=
literal|2
expr_stmt|;
name|hit
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|error_IMISC_userNotLoggedIn
expr_stmt|;
ifndef|#
directive|ifndef
name|SYS5
if|if
condition|(
operator|(
name|ud
operator|=
name|open
argument_list|(
literal|"/etc/utmp"
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"/etc/utmp: %s"
argument_list|,
name|sys_errname
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ia5
operator|=
name|str2ia5list
argument_list|(
name|buffer
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|congested
goto|;
name|result
operator|=
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_unableToOpenFile
argument_list|,
operator|(
name|caddr_t
operator|)
name|ia5
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
expr_stmt|;
name|free_IMISC_IA5List
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
while|while
condition|(
name|read
argument_list|(
name|ud
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ut
argument_list|,
sizeof|sizeof
expr|*
name|ut
argument_list|)
operator|==
sizeof|sizeof
expr|*
name|ut
condition|)
block|{
if|if
condition|(
name|ut
operator|->
name|ut_name
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|strncmp
argument_list|(
name|ut
operator|->
name|ut_name
argument_list|,
name|touser
argument_list|,
sizeof|sizeof
name|ut
operator|->
name|ut_name
argument_list|)
operator|==
literal|0
condition|)
if|if
condition|(
name|do_the_tell
argument_list|(
name|ut
argument_list|,
name|fromuser
argument_list|,
name|vec
argument_list|,
name|vecp
argument_list|)
operator|!=
name|NOTOK
condition|)
name|hit
operator|++
expr_stmt|;
else|else
name|result
operator|=
name|error_IMISC_unableToOpenFile
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|ud
argument_list|)
expr_stmt|;
else|#
directive|else
name|setutent
argument_list|()
expr_stmt|;
while|while
condition|(
name|ut
operator|=
name|getutent
argument_list|()
condition|)
block|{
if|if
condition|(
name|ut
operator|->
name|ut_type
operator|!=
name|USER_PROCESS
condition|)
continue|continue;
if|if
condition|(
name|strncmp
argument_list|(
name|ut
operator|->
name|ut_name
argument_list|,
name|touser
argument_list|,
sizeof|sizeof
name|ut
operator|->
name|ut_name
argument_list|)
operator|==
literal|0
condition|)
if|if
condition|(
name|do_the_tell
argument_list|(
name|ut
argument_list|,
name|fromuser
argument_list|,
name|vec
argument_list|,
name|vecp
argument_list|)
operator|!=
name|NOTOK
condition|)
name|hit
operator|++
expr_stmt|;
else|else
name|result
operator|=
name|error_IMISC_unableToOpenFile
expr_stmt|;
block|}
name|endutent
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|hit
operator|==
literal|0
condition|)
block|{
name|result
operator|=
name|error
argument_list|(
name|sd
argument_list|,
name|result
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RESULT"
argument_list|)
expr_stmt|;
name|result
operator|=
name|OK
expr_stmt|;
goto|goto
name|out
goto|;
name|congested
label|:
empty_stmt|;
name|result
operator|=
name|error
argument_list|(
name|sd
argument_list|,
name|error_IMISC_congested
argument_list|,
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
expr_stmt|;
name|out
label|:
empty_stmt|;
for|for
control|(
name|vecp
operator|=
literal|0
init|;
name|bp
operator|=
name|vecl
index|[
name|vecp
index|]
condition|;
name|vecp
operator|++
control|)
name|free
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|do_the_tell
parameter_list|(
name|ut
parameter_list|,
name|from
parameter_list|,
name|vec
parameter_list|,
name|vecp
parameter_list|)
name|struct
name|utmp
modifier|*
name|ut
decl_stmt|;
name|char
modifier|*
name|from
decl_stmt|;
name|char
modifier|*
name|vec
index|[]
decl_stmt|;
name|int
name|vecp
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|pid
decl_stmt|;
name|char
modifier|*
name|bp
decl_stmt|,
name|tty
index|[
literal|5
operator|+
name|LMAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|bp
operator|=
name|tty
argument_list|,
literal|"/dev/"
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|bp
argument_list|,
name|ut
operator|->
name|ut_line
argument_list|,
name|LMAX
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|LMAX
expr_stmt|;
operator|*
name|bp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|tty
argument_list|,
operator|&
name|st
argument_list|)
operator|==
name|NOTOK
operator|||
operator|(
name|st
operator|.
name|st_mode
operator|&
operator|(
name|S_IWRITE
operator|>>
literal|3
operator|)
operator|)
operator|!=
operator|(
name|S_IWRITE
operator|>>
literal|3
operator|)
condition|)
return|return
name|NOTOK
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|pid
operator|=
name|fork
argument_list|()
condition|)
block|{
case|case
name|NOTOK
case|:
continue|continue;
case|case
literal|0
case|:
break|break;
default|default:
return|return
name|OK
return|;
block|}
break|break;
block|}
if|if
condition|(
name|pid
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|tty
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\r\nmessage from %s:\r\n\007"
argument_list|,
name|from
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|bp
operator|=
name|NULL
init|;
name|i
operator|<
name|vecp
condition|;
name|i
operator|++
operator|,
name|bp
operator|=
literal|" "
control|)
block|{
if|if
condition|(
name|bp
condition|)
name|fputs
argument_list|(
name|bp
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|vec
index|[
name|i
index|]
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
name|fputs
argument_list|(
literal|"\r\n"
argument_list|,
name|fp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|op_data
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
if|if
condition|(
name|rox
operator|->
name|rox_nolinked
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s, unknown linkage %d"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|,
name|rox
operator|->
name|rox_linkid
argument_list|)
expr_stmt|;
return|return
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_LINKED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
name|ryo
operator|->
name|ryo_op
operator|==
name|operation_IMISC_echo
condition|?
name|in
else|:
operator|(
name|caddr_t
operator|)
name|NULL
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RESULT"
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|ERROR */
end_comment

begin_function
specifier|static
name|int
name|error
parameter_list|(
name|sd
parameter_list|,
name|err
parameter_list|,
name|param
parameter_list|,
name|rox
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|,
name|err
decl_stmt|;
name|caddr_t
name|param
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
if|if
condition|(
name|RyDsError
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
name|err
argument_list|,
name|param
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"ERROR"
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|U-REJECT */
end_comment

begin_function
specifier|static
name|int
name|ureject
parameter_list|(
name|sd
parameter_list|,
name|reason
parameter_list|,
name|rox
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|,
name|reason
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
if|if
condition|(
name|RyDsUReject
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
name|reason
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"U-REJECT"
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|TYPES */
end_comment

begin_function
name|struct
name|type_IMISC_IA5List
modifier|*
name|str2ia5list
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
specifier|register
name|struct
name|type_IMISC_IA5List
modifier|*
name|ia5
decl_stmt|;
if|if
condition|(
operator|(
name|ia5
operator|=
operator|(
expr|struct
name|type_IMISC_IA5List
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|ia5
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|(
name|ia5
operator|->
name|IA5String
operator|=
name|str2qb
argument_list|(
name|s
argument_list|,
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ia5
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ia5
return|;
block|}
end_function

end_unit


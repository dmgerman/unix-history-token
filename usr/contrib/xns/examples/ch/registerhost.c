begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Header: registerhost.c,v 2.0a 85/11/21 07:22:36 jqj,sklower Exp $ */
end_comment

begin_comment
comment|/*  * This program enters a Unix host into the Clearinghouse as a server and  * workstation, hence eligible for gap telnet   */
end_comment

begin_comment
comment|/*  * $Log:	registerhost.c,v $  * Revision 2.0  85/11/21  07:22:36  jqj  * 4.3BSD standard release  *   * Revision 1.1  85/11/20  13:54:08  jqj  * Initial revision  *   */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netns/ns.h>
end_include

begin_include
include|#
directive|include
file|"Clearinghouse2_defs.h"
end_include

begin_include
include|#
directive|include
file|<xnscourier/CHEntries.h>
end_include

begin_include
include|#
directive|include
file|<xnscourier/CH.h>
end_include

begin_include
include|#
directive|include
file|<xnscourier/except.h>
end_include

begin_escape
end_escape

begin_function
name|char
modifier|*
name|ItemToString
parameter_list|(
name|item
parameter_list|)
name|Item
name|item
decl_stmt|;
block|{
name|char
modifier|*
name|strval
decl_stmt|;
name|Unspecified
name|buf
index|[
literal|501
index|]
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
name|Cardinal
name|len
decl_stmt|;
name|externalize_Item
argument_list|(
operator|&
name|item
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|bp
operator|=
name|buf
expr_stmt|;
name|bp
operator|+=
name|internalize_Cardinal
argument_list|(
operator|&
name|len
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|internalize_String
argument_list|(
operator|&
name|strval
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|strval
operator|)
return|;
block|}
end_function

begin_function
name|Item
name|StringToItem
parameter_list|(
name|strval
parameter_list|)
name|String
name|strval
decl_stmt|;
block|{
name|Unspecified
name|buf
index|[
literal|501
index|]
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
name|Item
name|item
decl_stmt|;
name|Cardinal
name|len
decl_stmt|;
name|bp
operator|=
name|buf
operator|+
name|sizeof_Cardinal
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|len
operator|=
name|externalize_String
argument_list|(
operator|&
name|strval
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|externalize_Cardinal
argument_list|(
operator|&
name|len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|internalize_Item
argument_list|(
operator|&
name|item
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|item
operator|)
return|;
block|}
end_function

begin_function
name|Item
name|addrToItem
parameter_list|(
name|addr
parameter_list|)
name|struct
name|ns_addr
modifier|*
name|addr
decl_stmt|;
block|{
name|Unspecified
name|buf
index|[
literal|501
index|]
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
name|Item
name|item
decl_stmt|;
name|Cardinal
name|len
decl_stmt|;
name|NetworkAddressList
name|nalist
decl_stmt|;
name|NetworkAddress
name|naddr
decl_stmt|;
name|nalist
operator|.
name|length
operator|=
literal|1
expr_stmt|;
name|nalist
operator|.
name|sequence
operator|=
operator|&
name|naddr
expr_stmt|;
name|naddr
operator|.
name|network
index|[
literal|0
index|]
operator|=
name|htons
argument_list|(
name|addr
operator|->
name|x_net
operator|.
name|s_net
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|naddr
operator|.
name|network
index|[
literal|1
index|]
operator|=
name|htons
argument_list|(
name|addr
operator|->
name|x_net
operator|.
name|s_net
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|naddr
operator|.
name|host
index|[
literal|0
index|]
operator|=
name|htons
argument_list|(
name|addr
operator|->
name|x_host
operator|.
name|s_host
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|naddr
operator|.
name|host
index|[
literal|1
index|]
operator|=
name|htons
argument_list|(
name|addr
operator|->
name|x_host
operator|.
name|s_host
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|naddr
operator|.
name|host
index|[
literal|2
index|]
operator|=
name|htons
argument_list|(
name|addr
operator|->
name|x_host
operator|.
name|s_host
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|naddr
operator|.
name|socket
operator|=
literal|0
expr_stmt|;
name|bp
operator|=
name|buf
operator|+
name|sizeof_Cardinal
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|len
operator|=
name|externalize_NetworkAddressList
argument_list|(
operator|&
name|nalist
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|externalize_Cardinal
argument_list|(
operator|&
name|len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|internalize_Item
argument_list|(
operator|&
name|item
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|item
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isprop
parameter_list|(
name|prop
parameter_list|,
name|proplist
parameter_list|)
name|Property
name|prop
decl_stmt|;
name|Properties
name|proplist
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|prop
operator|=
name|prop
operator|<<
literal|16
expr_stmt|;
comment|/* correct for bug in Clearinghouse v 2 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|proplist
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|proplist
operator|.
name|sequence
index|[
name|i
index|]
operator|==
name|prop
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* not found */
block|}
end_function

begin_function
name|char
modifier|*
name|XNSaddrToString
parameter_list|(
name|addr
parameter_list|)
name|struct
name|ns_addr
modifier|*
name|addr
decl_stmt|;
block|{
name|u_char
modifier|*
name|s
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|21
index|]
decl_stmt|;
name|s
operator|=
name|addr
operator|->
name|x_host
operator|.
name|c_host
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%lx#%x.%x.%x.%x.%x.%x#%x"
argument_list|,
name|ntohl
argument_list|(
name|ns_netof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|)
argument_list|,
name|s
index|[
literal|0
index|]
argument_list|,
name|s
index|[
literal|1
index|]
argument_list|,
name|s
index|[
literal|2
index|]
argument_list|,
name|s
index|[
literal|3
index|]
argument_list|,
name|s
index|[
literal|4
index|]
argument_list|,
name|s
index|[
literal|5
index|]
argument_list|,
name|ntohs
argument_list|(
name|addr
operator|->
name|x_port
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

begin_escape
end_escape

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|ObjectName
name|myname
decl_stmt|,
name|name
decl_stmt|,
name|defname
decl_stmt|;
name|struct
name|ns_addr
modifier|*
name|destaddr
decl_stmt|,
modifier|*
name|getXNSaddr
argument_list|()
decl_stmt|,
modifier|*
name|myaddr
decl_stmt|;
name|struct
name|sockaddr_ns
name|sns
decl_stmt|;
name|Authenticator
name|agent
decl_stmt|;
name|CourierConnection
modifier|*
name|conn
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ListPropertiesResults
name|LPresult
decl_stmt|;
name|RetrieveItemResults
name|RIresult
decl_stmt|;
name|ChangeItemResults
name|CIresult
decl_stmt|;
name|AddItemPropertyResults
name|AIPresult
decl_stmt|;
name|char
modifier|*
name|pwd
decl_stmt|,
modifier|*
name|propval
decl_stmt|,
modifier|*
name|getXNSpass
argument_list|()
decl_stmt|,
modifier|*
name|malloc
argument_list|()
decl_stmt|,
modifier|*
name|gets
argument_list|()
decl_stmt|,
name|mystrname
index|[
literal|200
index|]
decl_stmt|,
name|addrstr
index|[
literal|200
index|]
decl_stmt|,
modifier|*
name|myhostname
decl_stmt|;
name|String
name|ItemToString
parameter_list|()
function_decl|;
name|Item
name|item
decl_stmt|,
name|StringToItem
argument_list|()
decl_stmt|,
name|addrToItem
argument_list|()
decl_stmt|;
name|Property
name|propnum
decl_stmt|;
name|struct
name|ns_addr
modifier|*
name|addr
decl_stmt|;
specifier|static
name|Boolean
name|authseq
index|[
literal|2
index|]
init|=
block|{
literal|1
block|,
literal|0
block|}
decl_stmt|;
comment|/* simple, not strong */
if|if
condition|(
name|argc
operator|<
literal|1
operator|||
name|argc
operator|>
literal|4
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [hostname]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|CH_NameDefault
argument_list|(
operator|&
name|defname
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
name|gethostname
argument_list|(
name|myhostname
operator|=
name|malloc
argument_list|(
literal|100
argument_list|)
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|name
operator|=
name|CH_StringToName
argument_list|(
name|myhostname
argument_list|,
operator|&
name|defname
argument_list|)
expr_stmt|;
block|}
else|else
name|name
operator|=
name|CH_StringToName
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|defname
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
name|name
operator|.
name|domain
operator|=
name|argv
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|3
condition|)
name|name
operator|.
name|organization
operator|=
name|argv
index|[
literal|3
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"Registering host %s:%s:%s\n"
argument_list|,
name|name
operator|.
name|object
argument_list|,
name|name
operator|.
name|domain
argument_list|,
name|name
operator|.
name|organization
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"XNS UserName: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|mystrname
argument_list|)
expr_stmt|;
name|myname
operator|=
name|CH_StringToName
argument_list|(
name|mystrname
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|pwd
operator|=
name|getXNSpass
argument_list|(
literal|"Password:"
argument_list|)
expr_stmt|;
name|MakeSimpleCredsAndVerifier
argument_list|(
operator|&
name|myname
argument_list|,
name|pwd
argument_list|,
operator|&
name|agent
operator|.
name|credentials
argument_list|,
operator|&
name|agent
operator|.
name|verifier
argument_list|)
expr_stmt|;
name|conn
operator|=
name|CH_GetFirstCH
argument_list|()
expr_stmt|;
name|i
operator|=
sizeof|sizeof
argument_list|(
name|sns
argument_list|)
expr_stmt|;
name|myaddr
operator|=
operator|&
name|sns
operator|.
name|sns_addr
expr_stmt|;
name|getsockname
argument_list|(
operator|*
operator|(
name|int
operator|*
operator|)
name|conn
argument_list|,
operator|&
name|sns
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|myaddr
operator|->
name|x_port
operator|=
literal|0
expr_stmt|;
name|DURING
block|{
name|LPresult
operator|=
name|ListProperties
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|agent
argument_list|)
expr_stmt|;
block|}
name|HANDLER
block|{
if|if
condition|(
name|Exception
operator|.
name|Code
operator|==
name|ArgumentError
condition|)
block|{
name|DURING
name|CreateObject
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|agent
argument_list|)
decl_stmt|;
name|HANDLER
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't create object. Error %d\n"
argument_list|,
name|Exception
operator|.
name|Code
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|END_HANDLER
expr_stmt|;
name|LPresult
operator|.
name|properties
operator|.
name|length
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ListProperties failed.  Error %d\n"
argument_list|,
name|Exception
operator|.
name|Code
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|END_HANDLER
expr_stmt|;
comment|/* AddressList property */
if|if
condition|(
name|isprop
argument_list|(
literal|4
argument_list|,
name|LPresult
operator|.
name|properties
argument_list|)
condition|)
block|{
name|addr
operator|=
name|CH_LookupAddr
argument_list|(
name|name
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"NetworkAddress is in property list, but CH_LookupAddr failed\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Old address: %s\n"
argument_list|,
name|XNSaddrToString
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"New address: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|addrstr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|addrstr
operator|==
literal|0
operator|&&
name|addr
operator|->
name|x_port
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Warning:  port should be 0 for gaptelnet\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"New address: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|addrstr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|addrstr
operator|!=
literal|0
condition|)
block|{
name|addr
operator|=
name|getXNSaddr
argument_list|(
name|addrstr
argument_list|)
expr_stmt|;
block|}
else|else
name|addr
operator|=
name|myaddr
expr_stmt|;
name|item
operator|=
name|addrToItem
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|DURING
name|CIresult
init|=
name|ChangeItem
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
literal|4
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
decl_stmt|;
name|HANDLER
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't change address.  Error %d\n"
argument_list|,
name|Exception
operator|.
name|Code
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|END_HANDLER
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"NS address (e.g. 2-273#2-613-688-939-672): "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|addrstr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|addrstr
operator|==
literal|0
condition|)
block|{
name|addr
operator|=
name|myaddr
expr_stmt|;
block|}
else|else
name|addr
operator|=
name|getXNSaddr
argument_list|(
name|addrstr
argument_list|)
expr_stmt|;
name|item
operator|=
name|addrToItem
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|DURING
name|AIPresult
init|=
name|AddItemProperty
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
literal|4
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
decl_stmt|;
name|HANDLER
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't add address property.  Error %d\n"
argument_list|,
name|Exception
operator|.
name|Code
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|END_HANDLER
expr_stmt|;
block|}
comment|/* AuthenticationLevel property */
if|if
condition|(
operator|!
name|isprop
argument_list|(
literal|8
argument_list|,
name|LPresult
operator|.
name|properties
argument_list|)
condition|)
block|{
name|item
operator|.
name|length
operator|=
literal|2
expr_stmt|;
name|item
operator|.
name|sequence
operator|=
operator|(
name|Unspecified
operator|*
operator|)
name|authseq
expr_stmt|;
name|DURING
name|AIPresult
init|=
name|AddItemProperty
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
literal|8
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
decl_stmt|;
name|HANDLER
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't add AuthenticationLevel property.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|END_HANDLER
expr_stmt|;
block|}
comment|/* description */
name|DURING
block|{
if|if
condition|(
name|isprop
argument_list|(
literal|10005
argument_list|,
name|LPresult
operator|.
name|properties
argument_list|)
condition|)
block|{
name|propnum
operator|=
literal|10005
expr_stmt|;
comment|/* 10005<<16; */
name|RIresult
operator|=
name|RetrieveItem
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|agent
argument_list|)
expr_stmt|;
name|propval
operator|=
name|ItemToString
argument_list|(
name|RIresult
operator|.
name|value
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Workstation description (Property 10005) has value ``%s''\n"
argument_list|,
name|propval
argument_list|)
expr_stmt|;
name|clear_RetrieveItemResults
argument_list|(
operator|&
name|RIresult
argument_list|)
expr_stmt|;
block|}
name|propnum
operator|=
literal|10024
expr_stmt|;
comment|/* 10024<<16; */
if|if
condition|(
name|isprop
argument_list|(
literal|10024
argument_list|,
name|LPresult
operator|.
name|properties
argument_list|)
condition|)
block|{
name|RIresult
operator|=
name|RetrieveItem
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|agent
argument_list|)
expr_stmt|;
name|propval
operator|=
name|ItemToString
argument_list|(
name|RIresult
operator|.
name|value
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Server description (Property 10024) has value ``%s''\nNew value: "
argument_list|,
name|propval
argument_list|)
expr_stmt|;
name|propval
operator|=
name|gets
argument_list|(
name|malloc
argument_list|(
literal|100
argument_list|)
argument_list|)
expr_stmt|;
name|item
operator|=
name|StringToItem
argument_list|(
name|propval
argument_list|)
expr_stmt|;
name|CIresult
operator|=
name|ChangeItem
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Enter new description: "
argument_list|)
expr_stmt|;
name|propval
operator|=
name|gets
argument_list|(
name|malloc
argument_list|(
literal|100
argument_list|)
argument_list|)
expr_stmt|;
name|item
operator|=
name|StringToItem
argument_list|(
name|propval
argument_list|)
expr_stmt|;
name|AIPresult
operator|=
name|AddItemProperty
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
expr_stmt|;
block|}
block|}
name|HANDLER
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error during Property manipulations, %d (%d)\n"
argument_list|,
name|Exception
operator|.
name|Code
argument_list|,
name|CourierErrArgs
argument_list|(
name|Clearinghouse2_CallErrorArgs
argument_list|,
name|problem
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|END_HANDLER
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1985 Free Software Foundation This file is part of GNU Emacs.  GNU Emacs is distributed in the hope that it will be useful, but without any warranty.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Everyone is granted permission to copy, modify and redistribute GNU Emacs, but only under the conditions described in the document "GNU Emacs copying permission notice".   An exact copy of the document is supposed to have been given to you along with GNU Emacs so that you can know how you may redistribute it all. It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* cvtmail:  * Program to convert oldstyle goslings emacs mail directories into  * gnu-rmail format.  Program expects a directory called Messages to  * exist in your home directory, containing individual mail messages in  * separate files in the standard gosling emacs mail reader format.  *  * Program takes one argument: an output file.  THis file will contain  * all the messages in Messages directory, in berkeley mail format.  * If no output file is mentioned, messages are put in ~/OMAIL.  *  * In order to get rmail to read the messages, the resulting file must  * be mv'ed to ~/mbox, and then have rmail invoked on them.  *   * Author: Larry Kolodney, 1985   * RMS, 2 Sept 85: Removed fix maximums on file name sizes.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|char
modifier|*
name|hd
decl_stmt|;
name|char
modifier|*
name|md
decl_stmt|;
name|char
modifier|*
name|mdd
decl_stmt|;
name|char
modifier|*
name|mfile
decl_stmt|;
name|char
modifier|*
name|cf
decl_stmt|;
name|int
name|cflen
decl_stmt|;
name|FILE
modifier|*
name|mddf
decl_stmt|;
name|FILE
modifier|*
name|mfilef
decl_stmt|;
name|FILE
modifier|*
name|cff
decl_stmt|;
name|char
name|pre
index|[
literal|10
index|]
decl_stmt|,
name|post
index|[
literal|100
index|]
decl_stmt|;
name|char
name|name
index|[
literal|14
index|]
decl_stmt|;
name|int
name|c
decl_stmt|;
name|hd
operator|=
operator|(
name|char
operator|*
operator|)
name|getenv
argument_list|(
literal|"HOME"
argument_list|)
expr_stmt|;
name|md
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|hd
argument_list|)
operator|+
literal|10
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|md
argument_list|,
name|hd
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|md
argument_list|,
literal|"/Messages"
argument_list|)
expr_stmt|;
name|mdd
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|md
argument_list|)
operator|+
literal|11
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|mdd
argument_list|,
name|md
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|mdd
argument_list|,
literal|"/Directory"
argument_list|)
expr_stmt|;
name|cflen
operator|=
literal|100
expr_stmt|;
name|cf
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|cflen
argument_list|)
expr_stmt|;
name|mddf
operator|=
name|fopen
argument_list|(
name|mdd
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|mfilef
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
else|else
block|{
name|mfile
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|hd
argument_list|)
operator|+
literal|7
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|mfile
argument_list|,
name|hd
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|mfile
argument_list|,
literal|"/OMAIL"
argument_list|)
expr_stmt|;
name|mfilef
operator|=
name|fopen
argument_list|(
name|mfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|skip_to_lf
argument_list|(
name|mddf
argument_list|)
expr_stmt|;
while|while
condition|(
name|fscanf
argument_list|(
name|mddf
argument_list|,
literal|"%4c%14[0123456789]"
argument_list|,
name|pre
argument_list|,
name|name
argument_list|)
operator|!=
name|EOF
condition|)
block|{
if|if
condition|(
name|cflen
operator|<
name|strlen
argument_list|(
name|md
argument_list|)
operator|+
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|2
condition|)
block|{
name|cflen
operator|=
name|strlen
argument_list|(
name|md
argument_list|)
operator|+
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|2
expr_stmt|;
name|cf
operator|=
operator|(
name|char
operator|*
operator|)
name|xrealloc
argument_list|(
name|cf
argument_list|,
name|cflen
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|cf
argument_list|,
name|md
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|cf
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|cf
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|cff
operator|=
name|fopen
argument_list|(
name|cf
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|cff
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
name|putc
argument_list|(
name|c
argument_list|,
name|mfilef
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|mfilef
argument_list|)
expr_stmt|;
name|skip_to_lf
argument_list|(
name|mddf
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|cff
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|mddf
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|mfilef
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_macro
name|skip_to_lf
argument_list|(
argument|stream
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|stream
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|stream
argument_list|)
operator|)
operator|!=
literal|'\n'
condition|)
empty_stmt|;
block|}
end_block

begin_function
name|int
name|xmalloc
parameter_list|(
name|size
parameter_list|)
name|int
name|size
decl_stmt|;
block|{
name|int
name|result
init|=
name|malloc
argument_list|(
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
name|fatal
argument_list|(
literal|"virtual memory exhausted"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|int
name|xrealloc
parameter_list|(
name|ptr
parameter_list|,
name|size
parameter_list|)
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|size
decl_stmt|;
block|{
name|int
name|result
init|=
name|realloc
argument_list|(
name|ptr
argument_list|,
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
name|fatal
argument_list|(
literal|"virtual memory exhausted"
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* Print error message and exit.  */
end_comment

begin_macro
name|fatal
argument_list|(
argument|s1
argument_list|,
argument|s2
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s1
decl_stmt|,
modifier|*
name|s2
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|error
argument_list|(
name|s1
argument_list|,
name|s2
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|error
argument_list|(
argument|s1
argument_list|,
argument|s2
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s1
decl_stmt|,
modifier|*
name|s2
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"cvtmail: "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|s1
argument_list|,
name|s2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


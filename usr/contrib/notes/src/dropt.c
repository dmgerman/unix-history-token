begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"parms.h"
end_include

begin_include
include|#
directive|include
file|"structs.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|RCSIDENT
end_ifdef

begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"$Header: dropt.c,v 1.7.0.1 85/09/09 18:31:21 notes Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|RCSIDENT
end_endif

begin_define
define|#
directive|define
name|BUFSZ
value|128
end_define

begin_comment
comment|/*  *	this file processes the director options.  *  *	call: contains the io pointer to the file.  *  *	allows continued access only if the user if a director.  *  *	the functions of the director options includes:  *	1) granting/denial of director priviledges  *	2) granting/denial of regular access priviledges  *	3) changing the director message  *	4) writing a policy note  *  *	Returns: -1 normally  *		 -4 if the user hit cntrl d ( to total exit)  *  *	original author/outliner : Ray Essick may 29, 1981  *  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|anonrow
decl_stmt|,
comment|/* allow anon */
name|openrow
decl_stmt|,
comment|/* is open */
name|archrow
decl_stmt|,
comment|/* is archive */
name|keeprow
decl_stmt|,
comment|/* expire action */
name|dirmsgrow
decl_stmt|,
comment|/* expire w/dirmsg */
name|netrow
decl_stmt|,
comment|/* networked */
name|expirerow
decl_stmt|,
comment|/* expire age */
name|longrow
decl_stmt|,
comment|/* longest ok text */
name|worksetrow
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* working set */
end_comment

begin_decl_stmt
specifier|static
name|int
name|lastrow
decl_stmt|;
end_decl_stmt

begin_macro
name|direct
argument_list|(
argument|io
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|io_f
modifier|*
name|io
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
comment|/* scratch */
name|int
name|c
decl_stmt|;
name|long
name|expires
decl_stmt|;
name|long
name|workset
decl_stmt|;
name|long
name|textlength
decl_stmt|;
comment|/* scratch */
name|char
name|title
index|[
name|DMLEN
operator|+
literal|1
index|]
decl_stmt|;
comment|/* hold new director message */
name|char
name|ntitle
index|[
name|NNLEN
operator|+
literal|1
index|]
decl_stmt|;
comment|/* hold note file title */
name|struct
name|note_f
name|note
decl_stmt|;
name|struct
name|auth_f
name|auth
decl_stmt|;
comment|/* author of policy note */
name|struct
name|daddr_f
name|where
decl_stmt|;
name|char
modifier|*
name|r
decl_stmt|,
name|buff
index|[
name|BUFSZ
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|buffptr
decl_stmt|;
name|int
name|start
decl_stmt|,
name|end
decl_stmt|,
name|nnotes
decl_stmt|,
name|nresps
decl_stmt|;
name|int
name|redraw
decl_stmt|;
comment|/* paint screen */
if|if
condition|(
name|allow
argument_list|(
name|io
argument_list|,
name|DRCTOK
argument_list|)
operator|==
literal|0
condition|)
block|{
name|at
argument_list|(
literal|0
argument_list|,
name|PROMPTMSGX
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Sorry, you are not a director"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|redraw
operator|=
literal|1
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|redraw
condition|)
name|dirplot
argument_list|(
name|io
argument_list|)
expr_stmt|;
name|getkey
label|:
comment|/* suck in a key */
name|at
argument_list|(
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Option:  \010"
argument_list|)
expr_stmt|;
name|c
operator|=
name|gchar
argument_list|()
expr_stmt|;
comment|/* get command */
name|printf
argument_list|(
literal|"\010 "
argument_list|)
expr_stmt|;
comment|/* overwrite the character */
name|redraw
operator|=
literal|0
expr_stmt|;
comment|/* draw if want it */
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'?'
case|:
case|case
literal|'h'
case|:
name|help
argument_list|(
name|DIRHLP
argument_list|)
expr_stmt|;
name|redraw
operator|++
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
comment|/* replot the screen */
case|case
literal|'\f'
case|:
comment|/* control-L also */
name|redraw
operator|++
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|K_KEY
case|case
literal|'k'
case|:
comment|/* same as q */
endif|#
directive|endif
endif|K_KEY
case|case
literal|'q'
case|:
comment|/* leave */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
case|case
literal|'\004'
case|:
return|return
name|QUITFAST
return|;
comment|/* Universal exit */
case|case
literal|'!'
case|:
comment|/* give him a shell */
name|gshell
argument_list|()
expr_stmt|;
name|redraw
operator|++
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* run access lists */
if|if
condition|(
name|accessedit
argument_list|(
name|io
argument_list|)
operator|==
name|QUITFAST
condition|)
return|return
name|QUITFAST
return|;
comment|/* doit */
name|redraw
operator|++
expr_stmt|;
break|break;
comment|/* skipt out of the loop */
case|case
literal|'a'
case|:
comment|/* toggle anonymous option */
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* lock the thing for a minute */
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* get up to date descriptor */
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ANONOK
condition|)
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&=
name|NOT
name|ANONOK
expr_stmt|;
else|else
name|io
operator|->
name|descr
operator|.
name|d_stat
operator||=
name|ANONOK
expr_stmt|;
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|anonrow
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ANONOK
condition|?
literal|"ON "
else|:
literal|"OFF"
argument_list|)
expr_stmt|;
name|redraw
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
comment|/* Archive option */
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* lock the thing for a minute */
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* get up to date descriptor */
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ISARCH
condition|)
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&=
name|NOT
name|ISARCH
expr_stmt|;
else|else
name|io
operator|->
name|descr
operator|.
name|d_stat
operator||=
name|ISARCH
expr_stmt|;
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|archrow
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ISARCH
condition|?
literal|"YES"
else|:
literal|"NO "
argument_list|)
expr_stmt|;
name|redraw
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
comment|/* message length */
while|while
condition|(
literal|1
condition|)
block|{
name|at
argument_list|(
name|lastrow
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"New Maximum Message Size: "
argument_list|)
expr_stmt|;
name|ceol
argument_list|()
expr_stmt|;
comment|/* clear to eol */
if|if
condition|(
name|gline
argument_list|(
name|buff
argument_list|,
name|BUFSZ
argument_list|)
operator|==
literal|1
condition|)
comment|/* empty line */
block|{
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Maximum Message Size Unchanged"
argument_list|)
expr_stmt|;
goto|goto
name|getkey
goto|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|buff
argument_list|,
literal|"%ld"
argument_list|,
operator|&
name|textlength
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|textlength
operator|<=
name|HARDMAX
condition|)
comment|/* too big? */
break|break;
else|else
block|{
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Maximum Allowed is %d"
argument_list|,
name|HARDMAX
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enter an integer or<return>"
argument_list|)
expr_stmt|;
block|}
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* CRITICAL SECTION */
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* update descriptor */
name|io
operator|->
name|descr
operator|.
name|d_longnote
operator|=
name|textlength
expr_stmt|;
comment|/* new value */
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* all done ... */
name|at
argument_list|(
name|longrow
argument_list|,
literal|27
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%ld bytes   "
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_longnote
argument_list|)
expr_stmt|;
name|redraw
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
comment|/* compress the notefile */
name|redraw
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|OPEN
condition|)
block|{
name|at
argument_list|(
name|lastrow
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Notefile must be closed to compress"
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|at
argument_list|(
name|lastrow
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|askyn
argument_list|(
literal|"Really Compress? (y/n) "
argument_list|)
operator|!=
literal|'y'
condition|)
block|{
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Compress not done"
argument_list|)
expr_stmt|;
break|break;
block|}
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Compressing "
argument_list|)
expr_stmt|;
if|if
condition|(
name|compress
argument_list|(
name|io
argument_list|,
name|LOCKIT
argument_list|,
literal|1
argument_list|,
operator|&
name|nnotes
argument_list|,
operator|&
name|nresps
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|dirplot
argument_list|(
name|io
argument_list|)
expr_stmt|;
comment|/* show it */
name|at
argument_list|(
operator|-
literal|3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Compress left %d notes and %d responses"
argument_list|,
name|nnotes
argument_list|,
name|nresps
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dirplot
argument_list|(
name|io
argument_list|)
expr_stmt|;
comment|/* show page */
name|at
argument_list|(
operator|-
literal|3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Compress not done"
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
break|break;
case|case
literal|'e'
case|:
comment|/* change expiration time */
while|while
condition|(
literal|1
condition|)
block|{
name|at
argument_list|(
name|lastrow
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"New Expiration time: "
argument_list|)
expr_stmt|;
name|ceol
argument_list|()
expr_stmt|;
comment|/* clear to eol */
if|if
condition|(
name|gline
argument_list|(
name|buff
argument_list|,
name|BUFSZ
argument_list|)
operator|==
literal|1
condition|)
comment|/* empty line */
block|{
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Expiration Threshold Unchanged"
argument_list|)
expr_stmt|;
goto|goto
name|getkey
goto|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|buff
argument_list|,
literal|"Never"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|buff
argument_list|,
literal|"never"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|buff
argument_list|,
literal|"NEVER"
argument_list|)
condition|)
block|{
name|expires
operator|=
name|NEVER
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|buff
argument_list|,
literal|"Default"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|buff
argument_list|,
literal|"default"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|buff
argument_list|,
literal|"DEFAULT"
argument_list|)
condition|)
block|{
name|expires
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|buff
argument_list|,
literal|"%ld"
argument_list|,
operator|&
name|expires
argument_list|)
operator|==
literal|1
condition|)
block|{
break|break;
block|}
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Want `default', `never', or a number"
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|lastrow
operator|+
literal|2
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"<return> to leave unchanged"
argument_list|)
expr_stmt|;
block|}
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* critical section */
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|io
operator|->
name|descr
operator|.
name|d_archtime
operator|=
name|expires
expr_stmt|;
comment|/* update */
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* replace */
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* leave critical */
name|at
argument_list|(
name|expirerow
argument_list|,
literal|27
argument_list|)
expr_stmt|;
switch|switch
condition|(
call|(
name|int
call|)
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_archtime
argument_list|)
condition|)
comment|/* update screen */
block|{
case|case
name|NEVER
case|:
name|printf
argument_list|(
literal|"Never       "
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"Default     "
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%ld days     "
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_archtime
argument_list|)
expr_stmt|;
break|break;
block|}
name|redraw
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
comment|/* working Set size */
while|while
condition|(
literal|1
condition|)
block|{
name|at
argument_list|(
name|lastrow
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"New Working Set Size: "
argument_list|)
expr_stmt|;
name|ceol
argument_list|()
expr_stmt|;
comment|/* clear to eol */
if|if
condition|(
name|gline
argument_list|(
name|buff
argument_list|,
name|BUFSZ
argument_list|)
operator|==
literal|1
condition|)
comment|/* empty line */
block|{
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Working Set Size Unchanged"
argument_list|)
expr_stmt|;
goto|goto
name|getkey
goto|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|buff
argument_list|,
literal|"Default"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|buff
argument_list|,
literal|"default"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|buff
argument_list|,
literal|"DEFAULT"
argument_list|)
condition|)
block|{
name|workset
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|buff
argument_list|,
literal|"%ld"
argument_list|,
operator|&
name|workset
argument_list|)
operator|==
literal|1
condition|)
block|{
break|break;
block|}
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Want `default' or a number"
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|lastrow
operator|+
literal|2
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"<return> to leave unchanged"
argument_list|)
expr_stmt|;
block|}
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* critical section */
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|io
operator|->
name|descr
operator|.
name|d_workset
operator|=
name|workset
expr_stmt|;
comment|/* update */
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* replace */
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* leave critical */
name|at
argument_list|(
name|worksetrow
argument_list|,
literal|27
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|io
operator|->
name|descr
operator|.
name|d_workset
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"Default      "
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%ld Notes    "
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_workset
argument_list|)
expr_stmt|;
block|}
name|redraw
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
comment|/* keep/delete/default */
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* critical section */
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|io
operator|->
name|descr
operator|.
name|d_archkeep
condition|)
comment|/* change it */
block|{
case|case
name|KEEPNO
case|:
name|io
operator|->
name|descr
operator|.
name|d_archkeep
operator|=
name|KEEPYES
expr_stmt|;
break|break;
case|case
name|KEEPYES
case|:
name|io
operator|->
name|descr
operator|.
name|d_archkeep
operator|=
name|KEEPDFLT
expr_stmt|;
break|break;
case|case
name|KEEPDFLT
case|:
default|default:
name|io
operator|->
name|descr
operator|.
name|d_archkeep
operator|=
name|KEEPNO
expr_stmt|;
break|break;
block|}
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* replace */
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* leave critical */
name|at
argument_list|(
name|keeprow
argument_list|,
literal|27
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|io
operator|->
name|descr
operator|.
name|d_archkeep
condition|)
comment|/* update display */
block|{
case|case
name|KEEPYES
case|:
name|printf
argument_list|(
literal|"ARCHIVE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|KEEPNO
case|:
name|printf
argument_list|(
literal|"DELETE "
argument_list|)
expr_stmt|;
break|break;
case|case
name|KEEPDFLT
case|:
name|printf
argument_list|(
literal|"Default"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"UNKNOWN"
argument_list|)
expr_stmt|;
break|break;
block|}
name|redraw
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* Archive dirmsg */
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* critical section */
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|io
operator|->
name|descr
operator|.
name|d_dmesgstat
condition|)
comment|/* change it */
block|{
case|case
name|DIRNOCARE
case|:
name|io
operator|->
name|descr
operator|.
name|d_dmesgstat
operator|=
name|DIRON
expr_stmt|;
break|break;
case|case
name|DIRON
case|:
name|io
operator|->
name|descr
operator|.
name|d_dmesgstat
operator|=
name|DIROFF
expr_stmt|;
break|break;
case|case
name|DIROFF
case|:
name|io
operator|->
name|descr
operator|.
name|d_dmesgstat
operator|=
name|DIRDFLT
expr_stmt|;
break|break;
case|case
name|DIRDFLT
case|:
default|default:
name|io
operator|->
name|descr
operator|.
name|d_dmesgstat
operator|=
name|DIRNOCARE
expr_stmt|;
break|break;
block|}
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* replace */
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* leave critical */
name|at
argument_list|(
name|dirmsgrow
argument_list|,
literal|27
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|io
operator|->
name|descr
operator|.
name|d_dmesgstat
condition|)
block|{
case|case
name|DIRNOCARE
case|:
name|printf
argument_list|(
literal|"NOCARE   "
argument_list|)
expr_stmt|;
break|break;
case|case
name|DIRON
case|:
name|printf
argument_list|(
literal|"ON       "
argument_list|)
expr_stmt|;
break|break;
case|case
name|DIROFF
case|:
name|printf
argument_list|(
literal|"OFF      "
argument_list|)
expr_stmt|;
break|break;
case|case
name|DIRDFLT
case|:
name|printf
argument_list|(
literal|"Default  "
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"UNKNOWN  "
argument_list|)
expr_stmt|;
break|break;
block|}
name|redraw
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
comment|/* toggle open status */
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|OPEN
condition|)
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&=
name|NOT
name|OPEN
expr_stmt|;
else|else
name|io
operator|->
name|descr
operator|.
name|d_stat
operator||=
name|OPEN
expr_stmt|;
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|openrow
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|OPEN
condition|?
literal|"OPEN  "
else|:
literal|"CLOSED"
argument_list|)
expr_stmt|;
name|redraw
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* toggle network status */
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|NETWRKD
condition|)
block|{
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&=
name|NOT
name|NETWRKD
expr_stmt|;
block|}
else|else
block|{
name|io
operator|->
name|descr
operator|.
name|d_stat
operator||=
name|NETWRKD
expr_stmt|;
block|}
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|netrow
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|NETWRKD
condition|?
literal|"YES"
else|:
literal|"NO "
argument_list|)
expr_stmt|;
name|redraw
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* collect a new director message */
name|redraw
operator|++
expr_stmt|;
name|at
argument_list|(
name|lastrow
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enter new director message"
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|lastrow
operator|+
literal|2
argument_list|,
literal|10
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DMLEN
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"-"
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|i
operator|=
name|gline
argument_list|(
name|title
argument_list|,
name|DMLEN
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* grab message */
if|if
condition|(
name|i
operator|<=
literal|1
condition|)
break|break;
comment|/* no new message */
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* mutual exclusion */
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* get up-to-date */
name|strncpy
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_drmes
argument_list|,
name|title
argument_list|,
name|DMLEN
argument_list|)
expr_stmt|;
comment|/* replace */
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* uncritical now */
break|break;
case|case
literal|'t'
case|:
comment|/* write title for note file */
name|redraw
operator|++
expr_stmt|;
name|at
argument_list|(
name|lastrow
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enter new title for notefile"
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|lastrow
operator|+
literal|2
argument_list|,
literal|10
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NNLEN
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"-"
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|i
operator|=
name|gline
argument_list|(
name|ntitle
argument_list|,
name|NNLEN
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* suck the title */
if|if
condition|(
name|i
operator|<=
literal|1
condition|)
break|break;
comment|/* no new message */
name|locknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* MUTEX */
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* current descr */
name|strncpy
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_title
argument_list|,
name|ntitle
argument_list|,
name|NNLEN
argument_list|)
expr_stmt|;
comment|/* update */
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* and replace */
name|unlocknf
argument_list|(
name|io
argument_list|,
name|DSCRLOCK
argument_list|)
expr_stmt|;
comment|/* uncritical now */
break|break;
case|case
literal|'w'
case|:
comment|/* let him write a new policy note */
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_plcy
condition|)
block|{
name|at
argument_list|(
literal|0
argument_list|,
name|PROMPTMSGX
argument_list|)
expr_stmt|;
if|if
condition|(
name|askyn
argument_list|(
literal|"Rewrite policy? (y/n) :"
argument_list|)
operator|==
literal|'n'
condition|)
block|{
name|redraw
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|at
argument_list|(
literal|0
argument_list|,
name|PROMPTMSGX
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nEdit New Policy Text:\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|gettext
argument_list|(
name|io
argument_list|,
operator|&
name|where
argument_list|,
operator|(
name|FILE
operator|*
operator|)
name|NULL
argument_list|,
name|EDIT
argument_list|)
operator|==
literal|0
condition|)
block|{
name|redraw
operator|++
expr_stmt|;
break|break;
block|}
name|r
operator|=
name|title
expr_stmt|;
name|strcpy
argument_list|(
name|title
argument_list|,
literal|"POLICY NOTE"
argument_list|)
expr_stmt|;
name|gettime
argument_list|(
operator|&
name|note
operator|.
name|n_date
argument_list|)
expr_stmt|;
comment|/* date of writing */
name|getname
argument_list|(
operator|&
name|auth
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* get author */
name|putnote
argument_list|(
name|io
argument_list|,
operator|&
name|where
argument_list|,
name|title
argument_list|,
literal|0
argument_list|,
operator|&
name|note
argument_list|,
operator|&
name|auth
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|System
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dspnote
argument_list|(
name|io
argument_list|,
operator|&
name|note
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* show it to him */
name|redraw
operator|++
expr_stmt|;
break|break;
case|case
literal|'z'
case|:
comment|/* zap a lot of notes/responses */
case|case
literal|'u'
case|:
comment|/* undelete a bunch */
block|{
name|char
modifier|*
name|action
decl_stmt|;
comment|/* del/undel */
name|redraw
operator|++
expr_stmt|;
comment|/* want to repaint */
name|action
operator|=
name|c
operator|==
literal|'z'
condition|?
literal|"delete"
else|:
literal|"un-delete"
expr_stmt|;
comment|/* for prompts */
name|at
argument_list|(
name|lastrow
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enter list of notes to %s: "
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|gline
argument_list|(
name|buff
argument_list|,
name|BUFSZ
argument_list|)
expr_stmt|;
comment|/* grab line */
name|at
argument_list|(
name|lastrow
operator|+
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Going to %s: %s"
argument_list|,
name|action
argument_list|,
name|buff
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|lastrow
operator|+
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|askyn
argument_list|(
literal|"Do you really want to do that? "
argument_list|)
operator|!=
literal|'y'
condition|)
break|break;
comment|/* chicken out */
name|buffptr
operator|=
literal|0
expr_stmt|;
name|at
argument_list|(
name|lastrow
operator|+
literal|3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|listget
argument_list|(
name|buff
argument_list|,
operator|&
name|buffptr
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|end
argument_list|)
condition|)
block|{
if|if
condition|(
name|start
operator|>
name|end
condition|)
block|{
name|printf
argument_list|(
literal|"IGNORING %d-%d"
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|start
operator|==
name|end
condition|)
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|start
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%d-%d "
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|mdelete
argument_list|(
name|io
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|c
operator|==
literal|'z'
argument_list|)
expr_stmt|;
comment|/* zap those */
block|}
goto|goto
name|getkey
goto|;
comment|/* leave this stuff on screen */
block|}
default|default:
name|printf
argument_list|(
literal|"\07"
argument_list|)
expr_stmt|;
name|redraw
operator|=
literal|0
expr_stmt|;
goto|goto
name|getkey
goto|;
comment|/* hit a bad key */
block|}
block|}
block|}
end_block

begin_comment
comment|/*  *	dirplot - Plot the notesfile status  */
end_comment

begin_macro
name|dirplot
argument_list|(
argument|io
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|io_f
modifier|*
name|io
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|atrow
decl_stmt|;
name|int
name|atcol
decl_stmt|;
name|erase
argument_list|()
expr_stmt|;
name|center
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_title
argument_list|,
name|NNLEN
argument_list|,
literal|1
argument_list|,
literal|40
operator|-
name|NNLEN
operator|/
literal|2
argument_list|)
expr_stmt|;
name|center
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_drmes
argument_list|,
name|DMLEN
argument_list|,
literal|2
argument_list|,
literal|40
operator|-
name|DMLEN
operator|/
literal|2
argument_list|)
expr_stmt|;
name|atrow
operator|=
literal|4
expr_stmt|;
comment|/* start filling in */
name|atcol
operator|=
literal|1
expr_stmt|;
name|at
argument_list|(
name|anonrow
operator|=
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(a) Anonymous:   "
argument_list|)
expr_stmt|;
comment|/* at (3,18); */
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ANONOK
condition|?
literal|"ON"
else|:
literal|"OFF"
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|openrow
operator|=
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(o) Notesfile:   "
argument_list|)
expr_stmt|;
comment|/* at(4,18); */
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|OPEN
condition|?
literal|"OPEN  "
else|:
literal|"CLOSED"
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|netrow
operator|=
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(n) Networked:   "
argument_list|)
expr_stmt|;
comment|/* at(5,18); */
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|NETWRKD
condition|?
literal|"YES"
else|:
literal|"NO "
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|archrow
operator|=
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(A) Is Archive:  "
argument_list|)
expr_stmt|;
comment|/* at(6,18); */
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ISARCH
condition|?
literal|"YES"
else|:
literal|"NO"
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|expirerow
operator|=
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(e) Expiration Threshold: "
argument_list|)
expr_stmt|;
comment|/* at (6,27); */
switch|switch
condition|(
call|(
name|int
call|)
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_archtime
argument_list|)
condition|)
block|{
case|case
name|NEVER
case|:
name|printf
argument_list|(
literal|"Never"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"Default"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%ld days"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_archtime
argument_list|)
expr_stmt|;
break|break;
block|}
name|at
argument_list|(
name|keeprow
operator|=
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(E) Expiration Action:    "
argument_list|)
expr_stmt|;
comment|/* at(?,27); */
switch|switch
condition|(
operator|(
name|int
operator|)
name|io
operator|->
name|descr
operator|.
name|d_archkeep
condition|)
block|{
case|case
name|KEEPYES
case|:
name|printf
argument_list|(
literal|"ARCHIVE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|KEEPNO
case|:
name|printf
argument_list|(
literal|"DELETE "
argument_list|)
expr_stmt|;
break|break;
case|case
name|KEEPDFLT
case|:
name|printf
argument_list|(
literal|"Default"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"UNKNOWN"
argument_list|)
expr_stmt|;
break|break;
block|}
name|at
argument_list|(
name|dirmsgrow
operator|=
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(D) Expire with Dirmsg:   "
argument_list|)
expr_stmt|;
comment|/* at (?,27) */
switch|switch
condition|(
operator|(
name|int
operator|)
name|io
operator|->
name|descr
operator|.
name|d_dmesgstat
condition|)
block|{
case|case
name|DIRNOCARE
case|:
name|printf
argument_list|(
literal|"NOCARE   "
argument_list|)
expr_stmt|;
break|break;
case|case
name|DIRON
case|:
name|printf
argument_list|(
literal|"ON       "
argument_list|)
expr_stmt|;
break|break;
case|case
name|DIROFF
case|:
name|printf
argument_list|(
literal|"OFF      "
argument_list|)
expr_stmt|;
break|break;
case|case
name|DIRDFLT
case|:
name|printf
argument_list|(
literal|"Default  "
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"UNKNOWN  "
argument_list|)
expr_stmt|;
break|break;
block|}
name|at
argument_list|(
name|worksetrow
operator|=
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(W) Working Set Size:     "
argument_list|)
expr_stmt|;
comment|/* at (5,27) */
switch|switch
condition|(
operator|(
name|int
operator|)
name|io
operator|->
name|descr
operator|.
name|d_workset
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"Default"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%ld Notes"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_workset
argument_list|)
expr_stmt|;
block|}
name|at
argument_list|(
name|longrow
operator|=
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(l) Maximum text/article: "
argument_list|)
expr_stmt|;
comment|/* at (6,27) */
name|printf
argument_list|(
literal|"%ld bytes"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_longnote
argument_list|)
expr_stmt|;
name|lastrow
operator|=
name|atrow
expr_stmt|;
comment|/* for queries */
comment|/*  *	Second Column  */
name|atrow
operator|=
literal|4
expr_stmt|;
name|atcol
operator|=
literal|40
expr_stmt|;
name|at
argument_list|(
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Policy Note Exists: %s"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_plcy
condition|?
literal|"YES"
else|:
literal|"NO"
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Next note in slot: %d"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_nnote
operator|+
literal|1
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Deleted Notes (holes): %ld  "
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_delnote
argument_list|)
expr_stmt|;
name|at
argument_list|(
name|atrow
operator|++
argument_list|,
name|atcol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Deleted Responses (holes): %ld  "
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_delresp
argument_list|)
expr_stmt|;
comment|/*  *	Should we show more statistics here?  *	Things like orphans, adoptions, etc.  */
if|if
condition|(
name|atrow
operator|>
name|lastrow
condition|)
name|lastrow
operator|=
name|atrow
expr_stmt|;
name|lastrow
operator|++
expr_stmt|;
block|}
end_block

end_unit


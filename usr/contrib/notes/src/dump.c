begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"parms.h"
end_include

begin_include
include|#
directive|include
file|"structs.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|RCSIDENT
end_ifdef

begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"$Header: dump.c,v 1.7.0.1 85/10/09 18:11:12 notes Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|RCSIDENT
end_endif

begin_comment
comment|/*  *	dumpnf(nfname)  *  *	Dump a notesfile. Parameters are a notesfile name, a name  *	for the descriptor information, and a name for the rest  *	of the notesfile.  *  */
end_comment

begin_macro
name|dumpnf
argument_list|(
argument|nfname
argument_list|,
argument|dfile
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|nfname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* name of notesfile */
end_comment

begin_decl_stmt
name|char
modifier|*
name|dfile
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* descriptor */
end_comment

begin_block
block|{
name|struct
name|io_f
name|io
decl_stmt|;
name|struct
name|note_f
name|note
decl_stmt|;
name|FILE
modifier|*
name|dout
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|init
argument_list|(
operator|&
name|io
argument_list|,
name|nfname
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Problems opening notesfile %s\n"
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
comment|/* die */
block|}
if|if
condition|(
operator|!
name|allow
argument_list|(
operator|&
name|io
argument_list|,
name|READOK
argument_list|)
condition|)
comment|/* no read access! */
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"You aren't allowed to read %s\n"
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|closenf
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|dfile
argument_list|,
literal|"-"
argument_list|)
condition|)
comment|/* use stdout */
name|dout
operator|=
name|stdout
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dout
operator|=
name|fopen
argument_list|(
name|dfile
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
comment|/* a real file */
block|{
name|closenf
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
comment|/* die */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|dmpdescr
argument_list|(
operator|&
name|io
argument_list|,
name|dout
argument_list|)
expr_stmt|;
comment|/* dump descriptor */
name|dmpaccess
argument_list|(
operator|&
name|io
argument_list|,
name|dout
argument_list|)
expr_stmt|;
comment|/* access list out */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|io
operator|.
name|descr
operator|.
name|d_nnote
condition|;
name|i
operator|++
control|)
comment|/* dump each note */
block|{
name|getnrec
argument_list|(
operator|&
name|io
argument_list|,
name|i
argument_list|,
operator|&
name|note
argument_list|)
expr_stmt|;
comment|/* get record */
if|if
condition|(
name|note
operator|.
name|n_stat
operator|&
name|DELETED
condition|)
continue|continue;
comment|/* ignore */
name|dmpnote
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|note
argument_list|,
name|i
argument_list|,
name|dout
argument_list|,
name|DETAIL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* base note */
name|dmprall
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|note
argument_list|,
name|i
argument_list|,
name|dout
argument_list|,
name|DETAIL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* and responses */
block|}
name|fclose
argument_list|(
name|dout
argument_list|)
expr_stmt|;
comment|/* close descriptor */
name|closenf
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
comment|/* and notesfile */
return|return
operator|(
literal|0
operator|)
return|;
comment|/* return nicely */
block|}
end_block

begin_comment
comment|/*  *	dmpdescr  *  *	Dump a notesfile descriptor and it's policy note if there is  *	one.  Send it to the supplied stdio file.  *  */
end_comment

begin_macro
name|dmpdescr
argument_list|(
argument|io
argument_list|,
argument|dmpfile
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|io_f
modifier|*
name|io
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|dmpfile
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
comment|/* hold strings */
specifier|register
name|int
name|i
decl_stmt|;
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* grab descriptor */
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Title: %s\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_title
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Director-Message: %s\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_drmes
argument_list|)
expr_stmt|;
name|sprdate
argument_list|(
operator|&
name|io
operator|->
name|descr
operator|.
name|d_lastm
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Last-Modified: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Status:"
argument_list|)
expr_stmt|;
comment|/* status */
block|{
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ANONOK
condition|)
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|" Anonymous"
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|OPEN
condition|)
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|" Open"
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|NETWRKD
condition|)
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|" Networked"
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ISARCH
condition|)
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|" Archive"
argument_list|)
expr_stmt|;
block|}
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|dmpfile
argument_list|)
expr_stmt|;
comment|/* end status line */
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Id-Sequence: %ld@%s\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_id
operator|.
name|uniqid
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_id
operator|.
name|sys
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Number: %ld\n"
argument_list|,
operator|(
name|long
operator|)
name|io
operator|->
name|descr
operator|.
name|d_nfnum
argument_list|)
expr_stmt|;
name|sprdate
argument_list|(
operator|&
name|io
operator|->
name|descr
operator|.
name|d_lstxmit
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Last-Transmit: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|sprdate
argument_list|(
operator|&
name|io
operator|->
name|descr
operator|.
name|d_created
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Created: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|sprdate
argument_list|(
operator|&
name|io
operator|->
name|descr
operator|.
name|d_lastuse
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Last-Used: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Days-Used: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_daysused
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Notes-Written: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_notwrit
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Notes-Read: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_notread
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Notes-Transmitted: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_notxmit
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Notes-Received: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_notrcvd
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Notes-Dropped: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_notdrop
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Responses-Written: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_rspwrit
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Responses-Read: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_rspread
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Responses-Transmitted: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_rspxmit
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Responses-Received: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_rsprcvd
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Responses-Dropped: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_rspdrop
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Entries: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|entries
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Walltime: %ld seconds\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|walltime
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Orphans-Received: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_orphans
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Orphans-Adopted: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_adopted
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Transmits: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|netwrkouts
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Receives: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|netwrkins
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Expiration-Age: %ld Days\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_archtime
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|io
operator|->
name|descr
operator|.
name|d_archkeep
condition|)
block|{
case|case
name|KEEPYES
case|:
name|strcpy
argument_list|(
name|buf
argument_list|,
literal|"Archive"
argument_list|)
expr_stmt|;
break|break;
case|case
name|KEEPNO
case|:
name|strcpy
argument_list|(
name|buf
argument_list|,
literal|"Delete"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcpy
argument_list|(
name|buf
argument_list|,
literal|"Default"
argument_list|)
expr_stmt|;
break|break;
block|}
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Expiration-Action: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|io
operator|->
name|descr
operator|.
name|d_dmesgstat
condition|)
block|{
case|case
name|DIRON
case|:
name|strcpy
argument_list|(
name|buf
argument_list|,
literal|"On"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DIROFF
case|:
name|strcpy
argument_list|(
name|buf
argument_list|,
literal|"Off"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DIRNOCARE
case|:
name|strcpy
argument_list|(
name|buf
argument_list|,
literal|"Either"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcpy
argument_list|(
name|buf
argument_list|,
literal|"Default"
argument_list|)
expr_stmt|;
break|break;
block|}
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Expiration-Status: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Working-Set-Size: %ld\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_workset
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Longest-Text: %ld bytes\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_longnote
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Policy-Exists: %s\n"
argument_list|,
name|io
operator|->
name|descr
operator|.
name|d_plcy
condition|?
literal|"Yes"
else|:
literal|"No"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dmpfile
argument_list|,
literal|"NF-Descriptor: Finished\n"
argument_list|)
expr_stmt|;
comment|/* mark as done */
comment|/*  *	dump the policy note if there is one  */
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_plcy
condition|)
comment|/* if a policy note */
block|{
comment|/* dump it */
name|struct
name|note_f
name|note
decl_stmt|;
name|getnrec
argument_list|(
name|io
argument_list|,
literal|0
argument_list|,
operator|&
name|note
argument_list|)
expr_stmt|;
name|dmpnote
argument_list|(
name|io
argument_list|,
operator|&
name|note
argument_list|,
literal|0
argument_list|,
name|dmpfile
argument_list|,
name|DETAIL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* dump it */
block|}
block|}
end_block

begin_comment
comment|/*  *	dmpaccess(&io)  *  *	dump the access list.  *	short circuited for now.  */
end_comment

begin_macro
name|dmpaccess
argument_list|(
argument|io
argument_list|,
argument|dfile
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|io_f
modifier|*
name|io
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|dfile
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|perm_f
name|perms
index|[
name|NPERMS
index|]
decl_stmt|;
comment|/* access rights */
name|int
name|nperms
decl_stmt|;
comment|/* and how many */
name|char
name|pathname
index|[
name|WDLEN
index|]
decl_stmt|;
name|char
modifier|*
name|atype
decl_stmt|;
name|char
name|mode
index|[
literal|32
index|]
decl_stmt|;
comment|/* at most 5 */
name|int
name|i
decl_stmt|;
name|FILE
modifier|*
name|afile
decl_stmt|;
name|sprintf
argument_list|(
name|pathname
argument_list|,
literal|"%s/%s/%s"
argument_list|,
name|io
operator|->
name|basedir
argument_list|,
name|io
operator|->
name|nf
argument_list|,
name|ACCESS
argument_list|)
expr_stmt|;
name|x
argument_list|(
operator|(
name|afile
operator|=
name|fopen
argument_list|(
name|pathname
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
argument_list|,
literal|"dmpaccess: no access list"
argument_list|)
expr_stmt|;
name|x
argument_list|(
operator|(
name|nperms
operator|=
name|fread
argument_list|(
name|perms
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|perm_f
argument_list|)
argument_list|,
name|NPERMS
argument_list|,
name|afile
argument_list|)
operator|)
operator|==
literal|0
argument_list|,
literal|"dmpaccess: empty access list"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|afile
argument_list|)
expr_stmt|;
comment|/* all done */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nperms
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|perms
index|[
name|i
index|]
operator|.
name|ptype
condition|)
block|{
case|case
name|PERMUSER
case|:
name|atype
operator|=
literal|"User"
expr_stmt|;
break|break;
case|case
name|PERMGROUP
case|:
name|atype
operator|=
literal|"Group"
expr_stmt|;
break|break;
case|case
name|PERMSYSTEM
case|:
name|atype
operator|=
literal|"System"
expr_stmt|;
break|break;
default|default:
name|atype
operator|=
literal|"Bizarro"
expr_stmt|;
break|break;
block|}
name|strcpy
argument_list|(
name|mode
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|/* build it up */
if|if
condition|(
name|perms
index|[
name|i
index|]
operator|.
name|perms
operator|&
name|DRCTOK
condition|)
comment|/* director */
name|strcat
argument_list|(
name|mode
argument_list|,
literal|"d"
argument_list|)
expr_stmt|;
if|if
condition|(
name|perms
index|[
name|i
index|]
operator|.
name|perms
operator|&
name|READOK
condition|)
comment|/* read */
name|strcat
argument_list|(
name|mode
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|perms
index|[
name|i
index|]
operator|.
name|perms
operator|&
name|WRITOK
condition|)
comment|/* write */
name|strcat
argument_list|(
name|mode
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|perms
index|[
name|i
index|]
operator|.
name|perms
operator|&
name|RESPOK
condition|)
comment|/* respond */
name|strcat
argument_list|(
name|mode
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dfile
argument_list|,
literal|"Access-Right: %s:%s=%s\n"
argument_list|,
name|atype
argument_list|,
name|perms
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|dfile
argument_list|,
literal|"NF-Access-Finished:\n"
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


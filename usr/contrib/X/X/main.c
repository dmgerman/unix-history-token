begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1985, 1986	*/
end_comment

begin_comment
comment|/* Initialization and socket routines */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_main_c
init|=
literal|"$Header: main.c,v 10.15 86/02/06 09:13:00 jg Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dbm.h>
end_include

begin_undef
undef|#
directive|undef
name|NULL
end_undef

begin_include
include|#
directive|include
file|"Xint.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|"rgb.h"
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DNETCONN
end_ifdef

begin_include
include|#
directive|include
file|<netdnet/dn.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|sys_nerr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|sys_errlist
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|CURSOR
modifier|*
name|cursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|base_feep
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|WINDOW
modifier|*
name|rootwindow
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|HangUp
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
modifier|*
name|Xalloc
argument_list|()
decl_stmt|,
modifier|*
name|strcpy
argument_list|()
decl_stmt|,
modifier|*
name|strcat
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|PIXMAP
modifier|*
name|PixmapSave
argument_list|()
decl_stmt|,
modifier|*
name|MakePixmap
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|CURSOR
modifier|*
name|StoreCursor
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|BITMAP
modifier|*
name|StoreBitmap
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|char
modifier|*
name|devdisp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The display device */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|display
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The display number */
end_comment

begin_decl_stmt
specifier|static
name|int
name|devdesc
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The display file descriptor */
end_comment

begin_decl_stmt
name|DEVICE
name|device
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The display info */
end_comment

begin_decl_stmt
specifier|static
name|int
name|Qmax
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* device.queue->size - 1 */
end_comment

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|inputhandler
function_decl|)
parameter_list|()
init|=
name|NULL
function_decl|;
end_function_decl

begin_comment
comment|/* input processor */
end_comment

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|blockhandler
function_decl|)
parameter_list|()
init|=
name|NULL
function_decl|;
end_function_decl

begin_comment
comment|/* called before select() */
end_comment

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|wakeuphandler
function_decl|)
parameter_list|()
init|=
name|NULL
function_decl|;
end_function_decl

begin_comment
comment|/* called after select() */
end_comment

begin_decl_stmt
name|char
modifier|*
name|rgb_name
init|=
name|RGB_DB
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* RGB database name */
end_comment

begin_decl_stmt
name|int
name|havergb
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* have RGB database? */
end_comment

begin_decl_stmt
specifier|static
name|short
name|_back
index|[
literal|16
index|]
init|=
block|{
literal|0x8888
block|,
literal|0x2222
block|,
literal|0x4444
block|,
literal|0x1111
block|,
literal|0x8888
block|,
literal|0x2222
block|,
literal|0x4444
block|,
literal|0x1111
block|,
literal|0x8888
block|,
literal|0x2222
block|,
literal|0x4444
block|,
literal|0x1111
block|,
literal|0x8888
block|,
literal|0x2222
block|,
literal|0x4444
block|,
literal|0x1111
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|PIXMAP
modifier|*
name|roottile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|_pointer
index|[
literal|16
index|]
init|=
block|{
literal|0xf00f
block|,
literal|0x8811
block|,
literal|0x8421
block|,
literal|0x8241
block|,
literal|0x4182
block|,
literal|0x2004
block|,
literal|0x1008
block|,
literal|0x0810
block|,
literal|0x0810
block|,
literal|0x1008
block|,
literal|0x2004
block|,
literal|0x4182
block|,
literal|0x8241
block|,
literal|0x8421
block|,
literal|0x8811
block|,
literal|0xf00f
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|_ptrmask
index|[
literal|16
index|]
init|=
block|{
literal|0xf00f
block|,
literal|0xf81f
block|,
literal|0xfc3f
block|,
literal|0xfe7f
block|,
literal|0x7ffe
block|,
literal|0x3ffc
block|,
literal|0x1ff8
block|,
literal|0x0ff0
block|,
literal|0x0ff0
block|,
literal|0x1ff8
block|,
literal|0x3ffc
block|,
literal|0x7ffe
block|,
literal|0xfe7f
block|,
literal|0xfc3f
block|,
literal|0xf81f
block|,
literal|0xf00f
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|_ssmask
index|[
literal|16
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|CURSOR
modifier|*
name|rootcursor
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* background cursor */
end_comment

begin_decl_stmt
specifier|static
name|CURSOR
modifier|*
name|sscursor
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* screen saver cursor */
end_comment

begin_decl_stmt
specifier|static
name|short
name|default_click
init|=
literal|6
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* KeyClick */
end_comment

begin_decl_stmt
specifier|static
name|short
name|default_repeat
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* AutoRepeat */
end_comment

begin_decl_stmt
specifier|static
name|short
name|default_lock
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ShiftLock */
end_comment

begin_decl_stmt
specifier|static
name|short
name|default_feep
init|=
literal|3
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* FeepControl */
end_comment

begin_decl_stmt
specifier|static
name|short
name|default_threshold
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* MouseControl */
end_comment

begin_decl_stmt
specifier|static
name|short
name|default_acceleration
init|=
literal|4
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|default_savertime
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ScreenSaver */
end_comment

begin_decl_stmt
specifier|static
name|short
name|default_savercycle
init|=
literal|60
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|default_pix0
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Background */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|default_pix1
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Foreground */
end_comment

begin_decl_stmt
specifier|static
name|short
name|default_mono
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Force monochrome */
end_comment

begin_decl_stmt
specifier|static
name|short
name|default_blank
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Blank video preferred */
end_comment

begin_decl_stmt
specifier|static
name|ColorDef
name|basecolors
index|[
literal|2
index|]
init|=
block|{
block|{
name|BlackPixel
block|,
literal|0
block|,
literal|0
block|,
literal|0x8000
block|}
block|,
block|{
name|WhitePixel
block|,
literal|0xff00
block|,
literal|0xff00
block|,
literal|0xff00
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ColorDef
name|randomcolors
index|[
literal|2
index|]
init|=
block|{
block|{
name|BlackPixel
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|WhitePixel
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|socketOn
index|[
name|maxsocks
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 1: active, 0: inactive */
end_comment

begin_decl_stmt
name|int
name|requestId
index|[
name|maxsocks
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Request count associated with the socket */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|sockbuf
index|[
name|maxsocks
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Request buffers */
end_comment

begin_decl_stmt
name|char
modifier|*
name|bufptr
index|[
name|maxsocks
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Buffer pointers */
end_comment

begin_comment
comment|/* Pointer to start of data in sockbuf */
end_comment

begin_decl_stmt
name|int
name|bufcnt
index|[
name|maxsocks
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Buffer counts */
end_comment

begin_comment
comment|/* Count of data bytes available in sockbuf */
end_comment

begin_define
define|#
directive|define
name|DEFBUFSIZE
value|4096
end_define

begin_comment
comment|/* Default buffer size */
end_comment

begin_define
define|#
directive|define
name|MAXBUFSIZE
value|(1<<17)
end_define

begin_comment
comment|/* Maximum buffer size */
end_comment

begin_decl_stmt
specifier|static
name|int
name|bufsize
index|[
name|maxsocks
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Buffer sizes */
end_comment

begin_comment
comment|/* Current size in bytes of sockbuf buffer */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DUALTCP
end_ifdef

begin_decl_stmt
name|int
name|swapped
index|[
name|maxsocks
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 1: must byte swap on connection */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|lastfdesc
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Maximum file descriptor */
end_comment

begin_decl_stmt
specifier|static
name|int
name|maxsock
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Highest socket in use + 1 */
end_comment

begin_decl_stmt
specifier|static
name|int
name|firstsock
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* First possible socket */
end_comment

begin_decl_stmt
specifier|static
name|int
name|firstmask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* First possible socket mask */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DUALTCP
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|swapmask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Swap ports */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|requestmask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Listener mask */
end_comment

begin_decl_stmt
specifier|static
name|int
name|selmask
index|[
name|mskcnt
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Mask of open connections */
end_comment

begin_decl_stmt
name|int
name|havemask
index|[
name|mskcnt
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Connections with buffered requests */
end_comment

begin_decl_stmt
name|int
name|havestate
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*<0: many, 0: none,>0: single */
end_comment

begin_decl_stmt
specifier|static
name|int
name|servergrabber
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Grabbing client */
end_comment

begin_decl_stmt
specifier|static
name|int
name|grabselmask
index|[
name|mskcnt
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Saved mask during GrabServer */
end_comment

begin_decl_stmt
specifier|static
name|int
name|grabhavemask
index|[
name|mskcnt
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Saved mask during GrabServer */
end_comment

begin_decl_stmt
specifier|static
name|int
name|grabhavestate
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Saved state during GrabServer */
end_comment

begin_decl_stmt
specifier|static
name|int
name|devmask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Event mask */
end_comment

begin_decl_stmt
name|int
name|rr_counter
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Round robin counter */
end_comment

begin_decl_stmt
name|struct
name|timeval
name|waittime
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|timeval
name|longtime
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|OUTTIME
value|10
end_define

begin_comment
comment|/* 10 seconds */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|timeval
name|outtime
init|=
block|{
name|OUTTIME
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|timeval
name|notime
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|errdelay
init|=
literal|15
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|blank_video
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|arg
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|3
condition|)
name|Usage
argument_list|()
expr_stmt|;
name|devdisp
operator|=
name|display
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|display
operator|==
literal|'/'
condition|)
name|display
operator|=
literal|"0"
expr_stmt|;
name|argc
operator|--
expr_stmt|;
comment|/* ignore tty name */
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|argc
condition|;
control|)
block|{
name|arg
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-a"
argument_list|)
operator|==
literal|0
operator|&&
name|i
operator|<
name|argc
condition|)
block|{
name|default_acceleration
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|default_acceleration
operator|==
literal|0
condition|)
name|Usage
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-c"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|default_click
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"c"
argument_list|)
operator|==
literal|0
operator|&&
name|i
operator|<
name|argc
condition|)
block|{
name|default_click
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|default_click
operator|>
literal|8
condition|)
name|Usage
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-f"
argument_list|)
operator|==
literal|0
operator|&&
name|i
operator|<
name|argc
condition|)
block|{
name|default_feep
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|default_feep
operator|>
literal|7
condition|)
name|Usage
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-l"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|default_lock
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"l"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|default_lock
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"m"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|default_mono
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-p"
argument_list|)
operator|==
literal|0
operator|&&
name|i
operator|<
name|argc
condition|)
block|{
name|default_savercycle
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|default_savercycle
operator|==
literal|0
condition|)
name|Usage
argument_list|()
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-r"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|default_repeat
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"r"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|default_repeat
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-s"
argument_list|)
operator|==
literal|0
operator|&&
name|i
operator|<
name|argc
condition|)
block|{
name|default_savertime
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|default_savertime
operator|==
literal|0
condition|)
name|Usage
argument_list|()
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-t"
argument_list|)
operator|==
literal|0
operator|&&
name|i
operator|<
name|argc
condition|)
block|{
name|default_threshold
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-v"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|default_blank
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"v"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|default_blank
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-0"
argument_list|)
operator|==
literal|0
operator|&&
name|i
operator|<
name|argc
condition|)
block|{
name|default_pix0
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-1"
argument_list|)
operator|==
literal|0
operator|&&
name|i
operator|<
name|argc
condition|)
block|{
name|default_pix1
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-D"
argument_list|)
operator|==
literal|0
operator|&&
name|i
operator|<
name|argc
condition|)
block|{
name|rgb_name
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|Usage
argument_list|()
expr_stmt|;
block|}
block|}
name|Initialize
argument_list|()
expr_stmt|;
name|Dispatcher
argument_list|()
expr_stmt|;
block|}
end_function

begin_macro
name|Usage
argument_list|()
end_macro

begin_block
block|{
name|printf
argument_list|(
literal|"usage:  X<display> [option ...]<tty>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"options: -a #, c #, -c, -f #, -l, l, m, -p #, -r, r, -s #, -t #, v, -v\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         -0<color> -1<color> -D<rgbdb>\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Called from Dispatcher when there are no complete requests to process, or  * when multiple sockets have requests, or when there is input to be read.  */
end_comment

begin_macro
name|Receive
argument_list|()
end_macro

begin_block
block|{
name|int
name|mask
index|[
name|mskcnt
index|]
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|maskval
decl_stmt|,
name|rrmask
decl_stmt|;
specifier|register
name|vsEventQueue
modifier|*
name|queue
init|=
name|device
operator|.
name|queue
decl_stmt|;
specifier|register
name|vsEvent
modifier|*
name|ev
decl_stmt|;
name|int
name|mi
decl_stmt|,
name|numread
decl_stmt|;
union|union
block|{
name|struct
name|sockaddr
name|sa
decl_stmt|;
ifdef|#
directive|ifdef
name|UNIXCONN
name|struct
name|sockaddr_un
name|un
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TCPCONN
name|struct
name|sockaddr_in
name|in
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DNETCONN
name|struct
name|sockaddr_dn
name|dn
decl_stmt|;
endif|#
directive|endif
block|}
name|from
union|;
name|int
name|fromlen
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* If there is input, deal with it */
while|while
condition|(
name|queue
operator|->
name|head
operator|!=
name|queue
operator|->
name|tail
condition|)
block|{
name|ev
operator|=
operator|&
name|queue
operator|->
name|events
index|[
name|queue
operator|->
name|head
index|]
expr_stmt|;
switch|switch
condition|(
name|ev
operator|->
name|vse_type
condition|)
block|{
case|case
name|VSE_MMOTION
case|:
comment|/* The mouse moved */
name|Deal_with_movement
argument_list|()
expr_stmt|;
break|break;
case|case
name|VSE_BUTTON
case|:
comment|/* A key/button moved */
name|ProcessInput
argument_list|(
name|ev
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|queue
operator|->
name|head
operator|==
name|Qmax
condition|)
name|queue
operator|->
name|head
operator|=
literal|0
expr_stmt|;
else|else
name|queue
operator|->
name|head
operator|++
expr_stmt|;
block|}
comment|/* If we already have data available, don't try to read more */
if|if
condition|(
name|havestate
condition|)
break|break;
comment|/* Wait for input or requests */
if|if
condition|(
name|blockhandler
condition|)
call|(
modifier|*
name|blockhandler
call|)
argument_list|()
expr_stmt|;
name|copybits
argument_list|(
name|selmask
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|i
operator|=
name|select
argument_list|(
name|maxsock
argument_list|,
name|mask
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|waittime
argument_list|)
expr_stmt|;
if|if
condition|(
name|wakeuphandler
condition|)
call|(
modifier|*
name|wakeuphandler
call|)
argument_list|()
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
comment|/* A timeout or error occurred */
if|if
condition|(
operator|!
name|i
condition|)
name|Screen_saver
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|errno
operator|==
name|EBADF
condition|)
name|Check_connections
argument_list|()
expr_stmt|;
continue|continue;
block|}
comment|/* Check if only events */
if|if
condition|(
name|mask
index|[
literal|0
index|]
operator|&
name|devmask
condition|)
block|{
name|mask
index|[
literal|0
index|]
operator|&=
operator|~
name|devmask
expr_stmt|;
if|if
condition|(
name|inputhandler
condition|)
call|(
modifier|*
name|inputhandler
call|)
argument_list|()
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|1
condition|)
continue|continue;
block|}
comment|/* If request socket, deal with the new request */
while|while
condition|(
name|rrmask
operator|=
operator|(
name|mask
index|[
literal|0
index|]
operator|&
name|requestmask
operator|)
condition|)
block|{
name|i
operator|=
name|ffs
argument_list|(
name|rrmask
argument_list|)
operator|-
literal|1
expr_stmt|;
name|rrmask
operator|=
literal|1
operator|<<
name|i
expr_stmt|;
name|mask
index|[
literal|0
index|]
operator|&=
operator|~
name|rrmask
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|accept
argument_list|(
name|i
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|fromlen
operator|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|lastfdesc
operator|||
name|getpeername
argument_list|(
name|i
argument_list|,
operator|&
name|from
operator|.
name|sa
argument_list|,
operator|&
name|fromlen
argument_list|)
operator|||
name|Invalid_host
argument_list|(
operator|&
name|from
operator|.
name|sa
argument_list|,
name|fromlen
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|TCP_NODELAY
if|if
condition|(
name|fromlen
operator|&&
operator|(
name|from
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
operator|)
condition|)
block|{
name|mi
operator|=
literal|1
expr_stmt|;
name|setsockopt
argument_list|(
name|i
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|TCP_NODELAY
argument_list|,
operator|&
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|fcntl
argument_list|(
name|i
argument_list|,
name|F_SETFL
argument_list|,
name|FNDELAY
argument_list|)
expr_stmt|;
name|socketOn
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|requestId
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|servergrabber
condition|)
block|{
name|bitset
argument_list|(
name|grabselmask
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bitset
argument_list|(
name|selmask
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|bufptr
index|[
name|i
index|]
operator|=
name|sockbuf
index|[
name|i
index|]
operator|=
name|Xalloc
argument_list|(
name|DEFBUFSIZE
argument_list|)
expr_stmt|;
name|bufcnt
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|bufsize
index|[
name|i
index|]
operator|=
name|DEFBUFSIZE
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|maxsock
condition|)
name|maxsock
operator|=
name|i
operator|+
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
name|rrmask
operator|&
name|swapmask
condition|)
name|swapped
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
block|}
block|}
comment|/* Read from all ready sockets */
name|mi
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|firstsock
expr_stmt|;
name|rrmask
operator|=
name|firstmask
expr_stmt|;
name|maskval
operator|=
name|mask
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|maskval
condition|)
block|{
if|if
condition|(
name|mi
operator|==
operator|(
name|mskcnt
operator|-
literal|1
operator|)
condition|)
break|break;
name|mi
operator|++
expr_stmt|;
name|i
operator|=
name|mi
operator|<<
literal|5
expr_stmt|;
name|rrmask
operator|=
literal|1
expr_stmt|;
name|maskval
operator|=
name|mask
index|[
name|mi
index|]
expr_stmt|;
continue|continue;
block|}
while|while
condition|(
operator|!
operator|(
name|maskval
operator|&
name|rrmask
operator|)
condition|)
block|{
name|rrmask
operator|+=
name|rrmask
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|maskval
operator|&=
operator|~
name|rrmask
expr_stmt|;
comment|/* copy down any existing data */
if|if
condition|(
name|bufcnt
index|[
name|i
index|]
operator|&&
operator|(
name|bufptr
index|[
name|i
index|]
operator|!=
name|sockbuf
index|[
name|i
index|]
operator|)
condition|)
name|bcopy
argument_list|(
name|bufptr
index|[
name|i
index|]
argument_list|,
name|sockbuf
index|[
name|i
index|]
argument_list|,
name|bufcnt
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* then read as much as we can */
name|bufptr
index|[
name|i
index|]
operator|=
name|sockbuf
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|numread
operator|=
name|read
argument_list|(
name|i
argument_list|,
name|bufptr
index|[
name|i
index|]
operator|+
name|bufcnt
index|[
name|i
index|]
argument_list|,
name|bufsize
index|[
name|i
index|]
operator|-
name|bufcnt
index|[
name|i
index|]
argument_list|)
operator|)
operator|<=
literal|0
condition|)
name|Close_down
argument_list|(
name|i
argument_list|)
expr_stmt|;
comment|/* see if we have enough for a request */
elseif|else
if|if
condition|(
operator|(
name|bufcnt
index|[
name|i
index|]
operator|+=
name|numread
operator|)
operator|>=
sizeof|sizeof
argument_list|(
name|XReq
argument_list|)
condition|)
block|{
name|havemask
index|[
name|mi
index|]
operator||=
name|rrmask
expr_stmt|;
if|if
condition|(
name|havestate
operator|==
literal|0
condition|)
name|havestate
operator|=
name|i
expr_stmt|;
elseif|else
if|if
condition|(
name|havestate
operator|>
literal|0
condition|)
name|havestate
operator|=
operator|-
literal|2
expr_stmt|;
else|else
name|havestate
operator|--
expr_stmt|;
block|}
name|rrmask
operator|+=
name|rrmask
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|havestate
operator|>
literal|0
condition|)
block|{
name|rr_counter
operator|=
name|havestate
expr_stmt|;
return|return;
block|}
comment|/* Handle multiple requests on a round-robin basis */
name|i
operator|=
name|rr_counter
operator|+
literal|1
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|i
operator|>=
name|maxsock
condition|)
name|i
operator|=
name|firstsock
expr_stmt|;
name|rrmask
operator|=
name|bitmask
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|maskval
operator|=
operator|(
name|maskword
argument_list|(
name|havemask
argument_list|,
name|i
argument_list|)
operator|&
operator|-
name|rrmask
operator|)
condition|)
break|break;
name|i
operator|+=
literal|32
expr_stmt|;
name|i
operator|&=
operator|~
literal|31
expr_stmt|;
block|}
while|while
condition|(
operator|!
operator|(
name|maskval
operator|&
name|rrmask
operator|)
condition|)
block|{
name|rrmask
operator|+=
name|rrmask
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|rr_counter
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|havestate
operator|==
operator|-
literal|1
condition|)
name|havestate
operator|=
name|i
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Write data to client.  * We might have to wait, if the client isn't keeping up with us.  We wait for  * a short time, then close the connection.  This isn't a wonderful solution,  * but it rarely seems to be a problem right now, and buffering output for  * asynchronous delivery sounds complicated and expensive.  */
end_comment

begin_macro
name|Write
argument_list|(
argument|client
argument_list|,
argument|buf
argument_list|,
argument|total
argument_list|)
end_macro

begin_decl_stmt
name|int
name|client
decl_stmt|,
name|total
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|count
init|=
name|total
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
name|int
name|mask
index|[
name|mskcnt
index|]
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|n
operator|=
name|write
argument_list|(
name|client
argument_list|,
name|buf
argument_list|,
name|count
argument_list|)
operator|)
operator|==
name|total
condition|)
return|return;
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
name|buf
operator|+=
name|n
expr_stmt|;
name|total
operator|-=
name|n
expr_stmt|;
if|if
condition|(
name|total
operator|<
name|count
condition|)
name|count
operator|=
name|total
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|errno
operator|==
name|EMSGSIZE
condition|)
name|count
operator|>>=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|errno
operator|!=
name|EWOULDBLOCK
condition|)
return|return;
if|if
condition|(
name|blockhandler
condition|)
call|(
modifier|*
name|blockhandler
call|)
argument_list|()
expr_stmt|;
name|singlebit
argument_list|(
name|mask
argument_list|,
name|client
argument_list|)
expr_stmt|;
name|n
operator|=
name|select
argument_list|(
name|client
operator|+
literal|1
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
name|mask
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|outtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|wakeuphandler
condition|)
call|(
modifier|*
name|wakeuphandler
call|)
argument_list|()
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|1
condition|)
block|{
name|close
argument_list|(
name|client
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
end_block

begin_comment
comment|/* Read data from client.  * Returns NULL if the data isn't immediately available, and backs up the  * buffer structures to re-read the request.  */
end_comment

begin_function
name|caddr_t
name|Read_segment
parameter_list|(
name|client
parameter_list|,
name|size
parameter_list|)
specifier|register
name|int
name|client
decl_stmt|;
specifier|register
name|int
name|size
decl_stmt|;
block|{
specifier|register
name|int
name|idx
decl_stmt|,
name|mask
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
name|bufcnt
index|[
name|client
index|]
operator|>=
name|size
condition|)
block|{
name|ptr
operator|=
name|bufptr
index|[
name|client
index|]
expr_stmt|;
name|bufptr
index|[
name|client
index|]
operator|+=
name|size
expr_stmt|;
comment|/* see if there is a request left */
if|if
condition|(
operator|(
name|bufcnt
index|[
name|client
index|]
operator|-=
name|size
operator|)
operator|<
sizeof|sizeof
argument_list|(
name|XReq
argument_list|)
condition|)
block|{
name|idx
operator|=
name|maskidx
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|mask
operator|=
name|bitmask
argument_list|(
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|havemask
index|[
name|idx
index|]
operator|&
name|mask
condition|)
block|{
name|havemask
index|[
name|idx
index|]
operator|&=
operator|~
name|mask
expr_stmt|;
if|if
condition|(
name|havestate
operator|<
literal|0
condition|)
name|havestate
operator|++
expr_stmt|;
else|else
name|havestate
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
operator|(
name|ptr
operator|)
return|;
block|}
comment|/* back up to the request */
name|bufptr
index|[
name|client
index|]
operator|-=
sizeof|sizeof
argument_list|(
name|XReq
argument_list|)
expr_stmt|;
name|bufcnt
index|[
name|client
index|]
operator|+=
sizeof|sizeof
argument_list|(
name|XReq
argument_list|)
expr_stmt|;
name|requestId
index|[
name|client
index|]
operator|--
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
name|swapped
index|[
name|client
index|]
condition|)
name|Swap_request
argument_list|(
operator|(
name|XReq
operator|*
operator|)
name|bufptr
index|[
name|client
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* but make it look like not enough is there */
name|idx
operator|=
name|maskidx
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|mask
operator|=
name|bitmask
argument_list|(
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|havemask
index|[
name|idx
index|]
operator|&
name|mask
condition|)
block|{
name|havemask
index|[
name|idx
index|]
operator|&=
operator|~
name|mask
expr_stmt|;
if|if
condition|(
name|havestate
operator|<
literal|0
condition|)
name|havestate
operator|++
expr_stmt|;
else|else
name|havestate
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|+
sizeof|sizeof
argument_list|(
name|XReq
argument_list|)
operator|>
name|bufsize
index|[
name|client
index|]
condition|)
block|{
comment|/* must increase the buffer to accomodate what's coming */
if|if
condition|(
name|size
operator|<=
name|MAXBUFSIZE
condition|)
block|{
name|ptr
operator|=
name|Xalloc
argument_list|(
name|bufsize
index|[
name|client
index|]
operator|=
name|size
operator|+
sizeof|sizeof
argument_list|(
name|XReq
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|bufptr
index|[
name|client
index|]
argument_list|,
name|ptr
argument_list|,
name|bufcnt
index|[
name|client
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sockbuf
index|[
name|client
index|]
argument_list|)
expr_stmt|;
name|sockbuf
index|[
name|client
index|]
operator|=
name|bufptr
index|[
name|client
index|]
operator|=
name|ptr
expr_stmt|;
block|}
else|else
name|Close_down
argument_list|(
name|client
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Give client sole access to server */
end_comment

begin_expr_stmt
name|Grab_server
argument_list|(
name|client
argument_list|)
specifier|register
name|int
name|client
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|idx
decl_stmt|,
name|mask
decl_stmt|;
if|if
condition|(
name|servergrabber
operator|==
literal|0
condition|)
block|{
name|copybits
argument_list|(
name|selmask
argument_list|,
name|grabselmask
argument_list|)
expr_stmt|;
name|clearbits
argument_list|(
name|selmask
argument_list|)
expr_stmt|;
name|selmask
index|[
literal|0
index|]
operator|=
name|devmask
operator||
name|requestmask
expr_stmt|;
name|idx
operator|=
name|maskidx
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|mask
operator|=
name|bitmask
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|selmask
index|[
name|idx
index|]
operator||=
name|mask
expr_stmt|;
name|copybits
argument_list|(
name|havemask
argument_list|,
name|grabhavemask
argument_list|)
expr_stmt|;
name|clearbits
argument_list|(
name|havemask
argument_list|)
expr_stmt|;
name|grabhavestate
operator|=
name|havestate
expr_stmt|;
if|if
condition|(
name|grabhavemask
index|[
name|idx
index|]
operator|&
name|mask
condition|)
block|{
name|grabhavemask
index|[
name|idx
index|]
operator|&=
operator|~
name|mask
expr_stmt|;
name|havemask
index|[
name|idx
index|]
operator|=
name|mask
expr_stmt|;
name|havestate
operator|=
name|client
expr_stmt|;
if|if
condition|(
name|grabhavestate
operator|<
literal|0
condition|)
name|grabhavestate
operator|++
expr_stmt|;
else|else
name|grabhavestate
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|havestate
operator|=
literal|0
expr_stmt|;
name|servergrabber
operator|=
name|client
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Restore global access to server */
end_comment

begin_macro
name|Ungrab_server
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|servergrabber
condition|)
block|{
name|copybits
argument_list|(
name|grabselmask
argument_list|,
name|selmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|havestate
condition|)
block|{
name|bitset
argument_list|(
name|grabhavemask
argument_list|,
name|servergrabber
argument_list|)
expr_stmt|;
if|if
condition|(
name|grabhavestate
operator|==
literal|0
condition|)
name|grabhavestate
operator|=
name|servergrabber
expr_stmt|;
elseif|else
if|if
condition|(
name|grabhavestate
operator|>
literal|0
condition|)
name|grabhavestate
operator|=
operator|-
literal|2
expr_stmt|;
else|else
name|grabhavestate
operator|--
expr_stmt|;
block|}
name|havestate
operator|=
name|grabhavestate
expr_stmt|;
name|copybits
argument_list|(
name|grabhavemask
argument_list|,
name|havemask
argument_list|)
expr_stmt|;
name|servergrabber
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Blank the screen when the server has been idle for a while */
end_comment

begin_macro
name|Screen_saver
argument_list|()
end_macro

begin_block
block|{
name|int
name|mask
index|[
name|mskcnt
index|]
decl_stmt|;
name|PIXMAP
modifier|*
name|save
init|=
name|NULL
decl_stmt|;
name|int
name|video
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
name|int
name|n
decl_stmt|;
comment|/* zap the cursor */
name|LoadCursor
argument_list|(
name|sscursor
argument_list|)
expr_stmt|;
comment|/* make sure mouse motion wakes us up */
name|device
operator|.
name|mbox
operator|->
name|bottom
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|blank_video
condition|)
name|video
operator|=
name|SetVideo
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|blank_video
operator|||
name|video
condition|)
name|save
operator|=
name|PixmapSave
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|device
operator|.
name|width
argument_list|,
name|device
operator|.
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|blank_video
operator|&&
name|save
operator|==
name|NULL
condition|)
name|video
operator|=
name|SetVideo
argument_list|(
literal|0
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
name|video
condition|)
block|{
comment|/* randomize the pattern */
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
if|if
condition|(
name|device
operator|.
name|entries
operator|>
literal|2
condition|)
block|{
name|randomcolors
index|[
literal|0
index|]
operator|.
name|red
operator|=
name|tv
operator|.
name|tv_sec
operator|&
literal|0x4
condition|?
operator|-
literal|1
else|:
literal|0
expr_stmt|;
name|randomcolors
index|[
literal|0
index|]
operator|.
name|green
operator|=
name|tv
operator|.
name|tv_sec
operator|&
literal|0x2
condition|?
operator|-
literal|1
else|:
literal|0
expr_stmt|;
name|randomcolors
index|[
literal|0
index|]
operator|.
name|blue
operator|=
name|tv
operator|.
name|tv_sec
operator|&
literal|0x1
condition|?
operator|-
literal|1
else|:
literal|0
expr_stmt|;
name|randomcolors
index|[
literal|1
index|]
operator|.
name|red
operator|=
name|tv
operator|.
name|tv_usec
operator|&
literal|0x40000
condition|?
operator|-
literal|1
else|:
literal|0
expr_stmt|;
name|randomcolors
index|[
literal|1
index|]
operator|.
name|green
operator|=
name|tv
operator|.
name|tv_usec
operator|&
literal|0x20000
condition|?
operator|-
literal|1
else|:
literal|0
expr_stmt|;
name|randomcolors
index|[
literal|1
index|]
operator|.
name|blue
operator|=
name|tv
operator|.
name|tv_usec
operator|&
literal|0x10000
condition|?
operator|-
literal|1
else|:
literal|0
expr_stmt|;
name|StoreColors
argument_list|(
literal|2
argument_list|,
name|randomcolors
argument_list|)
expr_stmt|;
block|}
name|TileFill
argument_list|(
name|rootwindow
operator|->
name|tile
argument_list|,
call|(
name|int
call|)
argument_list|(
name|tv
operator|.
name|tv_sec
operator|>>
literal|4
argument_list|)
operator|&
literal|0xf
argument_list|,
operator|(
name|int
operator|)
name|tv
operator|.
name|tv_sec
operator|&
literal|0xf
argument_list|,
operator|(
name|BITMAP
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|device
operator|.
name|width
argument_list|,
name|device
operator|.
name|height
argument_list|,
operator|&
name|rootwindow
operator|->
name|clip
argument_list|,
literal|1
argument_list|,
name|GXcopy
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|blockhandler
condition|)
call|(
modifier|*
name|blockhandler
call|)
argument_list|()
expr_stmt|;
name|copybits
argument_list|(
name|selmask
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|n
operator|=
name|select
argument_list|(
name|maxsock
argument_list|,
name|mask
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|longtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|wakeuphandler
condition|)
call|(
modifier|*
name|wakeuphandler
call|)
argument_list|()
expr_stmt|;
block|}
do|while
condition|(
name|n
operator|==
literal|0
condition|)
do|;
comment|/* now restore the world */
if|if
condition|(
name|video
operator|&&
name|device
operator|.
name|entries
operator|>
literal|2
condition|)
block|{
name|Query_color
argument_list|(
name|randomcolors
index|[
literal|0
index|]
operator|.
name|pixel
argument_list|,
operator|&
name|randomcolors
index|[
literal|0
index|]
operator|.
name|red
argument_list|,
operator|&
name|randomcolors
index|[
literal|0
index|]
operator|.
name|green
argument_list|,
operator|&
name|randomcolors
index|[
literal|0
index|]
operator|.
name|blue
argument_list|)
expr_stmt|;
name|Query_color
argument_list|(
name|randomcolors
index|[
literal|1
index|]
operator|.
name|pixel
argument_list|,
operator|&
name|randomcolors
index|[
literal|1
index|]
operator|.
name|red
argument_list|,
operator|&
name|randomcolors
index|[
literal|1
index|]
operator|.
name|green
argument_list|,
operator|&
name|randomcolors
index|[
literal|1
index|]
operator|.
name|blue
argument_list|)
expr_stmt|;
name|StoreColors
argument_list|(
literal|2
argument_list|,
name|randomcolors
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|save
condition|)
block|{
name|PixmapPut
argument_list|(
name|save
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|device
operator|.
name|width
argument_list|,
name|device
operator|.
name|height
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rootwindow
operator|->
name|clip
argument_list|,
literal|1
argument_list|,
name|GXcopy
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|FreePixmap
argument_list|(
name|save
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|video
condition|)
name|Draw_window
argument_list|(
name|rootwindow
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|SetVideo
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|LoadCursor
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Check the status of each client, and close our side of any goners. */
end_comment

begin_macro
name|Check_connections
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|mask
index|[
name|mskcnt
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
name|firstsock
init|;
name|i
operator|<
name|maxsock
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|socketOn
index|[
name|i
index|]
condition|)
continue|continue;
name|singlebit
argument_list|(
name|mask
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|i
operator|+
literal|1
argument_list|,
name|mask
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|notime
argument_list|)
operator|<
literal|0
condition|)
name|Close_down
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Close down a client, freeing its resources. */
end_comment

begin_expr_stmt
name|Close_down
argument_list|(
name|i
argument_list|)
specifier|register
name|int
name|i
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|idx
decl_stmt|,
name|mask
decl_stmt|;
if|if
condition|(
name|servergrabber
condition|)
name|Ungrab_server
argument_list|()
expr_stmt|;
name|idx
operator|=
name|maskidx
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|mask
operator|=
name|bitmask
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|selmask
index|[
name|idx
index|]
operator|&=
operator|~
name|mask
expr_stmt|;
if|if
condition|(
name|havemask
index|[
name|idx
index|]
operator|&
name|mask
condition|)
block|{
name|havemask
index|[
name|idx
index|]
operator|&=
operator|~
name|mask
expr_stmt|;
if|if
condition|(
name|havestate
operator|<
literal|0
condition|)
name|havestate
operator|++
expr_stmt|;
else|else
name|havestate
operator|=
literal|0
expr_stmt|;
block|}
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|socketOn
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|i
operator|+
literal|1
operator|==
name|maxsock
condition|)
block|{
while|while
condition|(
operator|(
name|maxsock
operator|>
name|firstsock
operator|)
operator|&&
operator|(
operator|!
name|socketOn
index|[
name|maxsock
operator|-
literal|1
index|]
operator|)
condition|)
operator|--
name|maxsock
expr_stmt|;
block|}
name|free
argument_list|(
name|sockbuf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
name|swapped
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|Free_client_resources
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
comment|/* if nobody is left, clean up after them */
if|if
condition|(
name|maxsock
operator|==
name|firstsock
condition|)
name|Restore_root
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* This is where we create the background, etc. */
end_comment

begin_macro
name|Initialize
argument_list|()
end_macro

begin_block
block|{
name|char
name|fname
index|[
literal|32
index|]
decl_stmt|;
name|int
name|request
decl_stmt|;
ifdef|#
directive|ifdef
name|TCPCONN
name|int
name|whichbyte
decl_stmt|;
name|int
name|tcpport1
decl_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
name|int
name|tcpport2
decl_stmt|;
endif|#
directive|endif
name|struct
name|sockaddr_in
name|mysock
decl_stmt|;
ifndef|#
directive|ifndef
name|SO_DONTLINGER
specifier|static
name|int
name|linger
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|UNIXCONN
name|struct
name|sockaddr_un
name|unsock
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DNETCONN
name|struct
name|sockaddr_dn
name|dnsock
decl_stmt|;
endif|#
directive|endif
name|int
name|retry
decl_stmt|;
name|BITMAP
modifier|*
name|bit1
decl_stmt|,
modifier|*
name|bit2
decl_stmt|;
name|datum
name|dbent
decl_stmt|;
name|RGB
name|color
decl_stmt|;
name|lastfdesc
operator|=
name|getdtablesize
argument_list|()
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|lastfdesc
operator|>
name|maxsocks
condition|)
name|lastfdesc
operator|=
name|maxsocks
expr_stmt|;
comment|/* hack test to decide where to log errors */
if|if
condition|(
name|write
argument_list|(
literal|2
argument_list|,
name|fname
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|fname
argument_list|,
literal|"/usr/adm/X"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|fname
argument_list|,
name|display
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|fname
argument_list|,
literal|"msgs"
argument_list|)
expr_stmt|;
name|freopen
argument_list|(
name|fname
argument_list|,
literal|"w+"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|getpgrp
argument_list|(
literal|0
argument_list|)
operator|==
literal|0
condition|)
name|setpgrp
argument_list|(
literal|0
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbminit
argument_list|(
name|rgb_name
argument_list|)
operator|==
literal|0
condition|)
name|havergb
operator|=
literal|1
expr_stmt|;
name|requestmask
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
name|swapmask
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TCPCONN
name|tcpport1
operator|=
name|atoi
argument_list|(
name|display
argument_list|)
expr_stmt|;
name|whichbyte
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|char
operator|*
operator|)
operator|&
name|whichbyte
condition|)
block|{
ifdef|#
directive|ifdef
name|DUALTCP
name|tcpport2
operator|=
name|tcpport1
operator|+
name|X_TCP_BI_PORT
expr_stmt|;
endif|#
directive|endif
name|tcpport1
operator|+=
name|X_TCP_LI_PORT
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|DUALTCP
name|tcpport2
operator|=
name|tcpport1
operator|+
name|X_TCP_LI_PORT
expr_stmt|;
endif|#
directive|endif
name|tcpport1
operator|+=
name|X_TCP_BI_PORT
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|(
name|devdesc
operator|=
name|OpenDisplay
argument_list|(
name|devdisp
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|Error
argument_list|(
literal|"Opening"
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TCPCONN
if|if
condition|(
operator|(
name|request
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|Notice
argument_list|(
literal|"Creating TCP socket"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|mysock
argument_list|,
sizeof|sizeof
argument_list|(
name|mysock
argument_list|)
argument_list|)
expr_stmt|;
name|mysock
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|mysock
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|tcpport1
argument_list|)
expr_stmt|;
name|mysock
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|INADDR_ANY
argument_list|)
expr_stmt|;
name|retry
operator|=
literal|20
expr_stmt|;
while|while
condition|(
name|bind
argument_list|(
name|request
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|mysock
argument_list|,
sizeof|sizeof
argument_list|(
name|mysock
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
operator|--
name|retry
operator|==
literal|0
condition|)
name|Error
argument_list|(
literal|"Binding TCP socket"
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SO_DONTLINGER
if|if
condition|(
name|setsockopt
argument_list|(
name|request
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_DONTLINGER
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
else|#
directive|else
if|if
condition|(
name|setsockopt
argument_list|(
name|request
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_LINGER
argument_list|,
name|linger
argument_list|,
sizeof|sizeof
argument_list|(
name|linger
argument_list|)
argument_list|)
condition|)
endif|#
directive|endif
name|Notice
argument_list|(
literal|"Setting TCP DONTLINGER"
argument_list|)
expr_stmt|;
if|if
condition|(
name|listen
argument_list|(
name|request
argument_list|,
literal|5
argument_list|)
condition|)
name|Error
argument_list|(
literal|"TCP Listening"
argument_list|)
expr_stmt|;
name|requestmask
operator||=
operator|(
literal|1
operator|<<
name|request
operator|)
expr_stmt|;
name|Define_self
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
operator|(
name|request
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|Notice
argument_list|(
literal|"Creating dual TCP socket"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mysock
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|tcpport2
argument_list|)
expr_stmt|;
name|retry
operator|=
literal|20
expr_stmt|;
while|while
condition|(
name|bind
argument_list|(
name|request
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|mysock
argument_list|,
sizeof|sizeof
argument_list|(
name|mysock
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
operator|--
name|retry
operator|==
literal|0
condition|)
name|Error
argument_list|(
literal|"Binding dual TCP socket"
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SO_DONTLINGER
if|if
condition|(
name|setsockopt
argument_list|(
name|request
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_DONTLINGER
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
else|#
directive|else
if|if
condition|(
name|setsockopt
argument_list|(
name|request
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_LINGER
argument_list|,
name|linger
argument_list|,
sizeof|sizeof
argument_list|(
name|linger
argument_list|)
argument_list|)
condition|)
endif|#
directive|endif
name|Notice
argument_list|(
literal|"Setting dual TCP DONTLINGER"
argument_list|)
expr_stmt|;
if|if
condition|(
name|listen
argument_list|(
name|request
argument_list|,
literal|5
argument_list|)
condition|)
name|Error
argument_list|(
literal|"dual TCP Listening"
argument_list|)
expr_stmt|;
name|requestmask
operator||=
operator|(
literal|1
operator|<<
name|request
operator|)
expr_stmt|;
name|swapmask
operator||=
operator|(
literal|1
operator|<<
name|request
operator|)
expr_stmt|;
name|Define_self
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|UNIXCONN
name|unsock
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|strcpy
argument_list|(
name|unsock
operator|.
name|sun_path
argument_list|,
name|X_UNIX_PATH
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|unsock
operator|.
name|sun_path
argument_list|,
name|display
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|unsock
operator|.
name|sun_path
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|request
operator|=
name|socket
argument_list|(
name|AF_UNIX
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|Notice
argument_list|(
literal|"Creating Unix socket"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bind
argument_list|(
name|request
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|unsock
argument_list|,
name|strlen
argument_list|(
name|unsock
operator|.
name|sun_path
argument_list|)
operator|+
literal|2
argument_list|)
condition|)
name|Error
argument_list|(
literal|"Binding Unix socket"
argument_list|)
expr_stmt|;
if|if
condition|(
name|listen
argument_list|(
name|request
argument_list|,
literal|5
argument_list|)
condition|)
name|Error
argument_list|(
literal|"Unix Listening"
argument_list|)
expr_stmt|;
name|requestmask
operator||=
operator|(
literal|1
operator|<<
name|request
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DNETCONN
if|if
condition|(
operator|(
name|request
operator|=
name|socket
argument_list|(
name|AF_DECnet
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|Notice
argument_list|(
literal|"Creating DECnet socket"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|dnsock
argument_list|,
sizeof|sizeof
argument_list|(
name|dnsock
argument_list|)
argument_list|)
expr_stmt|;
name|dnsock
operator|.
name|sdn_family
operator|=
name|AF_DECnet
expr_stmt|;
name|sprintf
argument_list|(
name|dnsock
operator|.
name|sdn_objname
argument_list|,
literal|"X%d"
argument_list|,
name|atoi
argument_list|(
name|display
argument_list|)
argument_list|)
expr_stmt|;
name|dnsock
operator|.
name|sdn_objnamel
operator|=
name|strlen
argument_list|(
name|dnsock
operator|.
name|sdn_objname
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|request
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|dnsock
argument_list|,
sizeof|sizeof
argument_list|(
name|dnsock
argument_list|)
argument_list|)
condition|)
name|Error
argument_list|(
literal|"Binding DECnet socket"
argument_list|)
expr_stmt|;
if|if
condition|(
name|listen
argument_list|(
name|request
argument_list|,
literal|5
argument_list|)
condition|)
name|Error
argument_list|(
literal|"DECnet Listening"
argument_list|)
expr_stmt|;
name|requestmask
operator||=
operator|(
literal|1
operator|<<
name|request
operator|)
expr_stmt|;
name|Define_self
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|requestmask
operator|==
literal|0
condition|)
name|Error
argument_list|(
literal|"No Listeners"
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|InitDisplay
argument_list|(
operator|&
name|device
argument_list|)
condition|)
name|Error
argument_list|(
literal|"Initializing"
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|HangUp
argument_list|)
expr_stmt|;
name|Qmax
operator|=
name|device
operator|.
name|queue
operator|->
name|size
operator|-
literal|1
expr_stmt|;
name|devmask
operator|=
literal|1
operator|<<
name|devdesc
expr_stmt|;
name|selmask
index|[
literal|0
index|]
operator|=
name|devmask
operator||
name|requestmask
expr_stmt|;
name|rr_counter
operator|=
name|request
expr_stmt|;
name|havestate
operator|=
literal|0
expr_stmt|;
name|firstsock
operator|=
name|maxsock
operator|=
name|request
operator|+
literal|1
expr_stmt|;
name|firstmask
operator|=
literal|1
operator|<<
name|maxsock
expr_stmt|;
if|if
condition|(
name|default_mono
operator|&&
name|device
operator|.
name|entries
operator|>
literal|2
condition|)
name|device
operator|.
name|entries
operator|=
literal|2
expr_stmt|;
name|Init_colormap
argument_list|()
expr_stmt|;
if|if
condition|(
name|device
operator|.
name|entries
operator|>
literal|2
condition|)
block|{
if|if
condition|(
name|default_pix0
condition|)
block|{
if|if
condition|(
operator|*
name|default_pix0
operator|==
literal|'#'
condition|)
name|Parse_color
argument_list|(
name|default_pix0
operator|+
literal|1
argument_list|,
operator|&
name|basecolors
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
elseif|else
if|if TRUE
condition|(
name|havergb
condition|)
block|{
name|dbent
operator|.
name|dptr
operator|=
name|default_pix0
expr_stmt|;
name|dbent
operator|.
name|dsize
operator|=
name|strlen
argument_list|(
name|default_pix0
argument_list|)
expr_stmt|;
name|dbent
operator|=
name|fetch
argument_list|(
name|dbent
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbent
operator|.
name|dptr
condition|)
block|{
name|bcopy
argument_list|(
name|dbent
operator|.
name|dptr
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|color
argument_list|,
sizeof|sizeof
argument_list|(
name|RGB
argument_list|)
argument_list|)
expr_stmt|;
name|basecolors
index|[
literal|0
index|]
operator|.
name|red
operator|=
name|color
operator|.
name|red
expr_stmt|;
name|basecolors
index|[
literal|0
index|]
operator|.
name|green
operator|=
name|color
operator|.
name|green
expr_stmt|;
name|basecolors
index|[
literal|0
index|]
operator|.
name|blue
operator|=
name|color
operator|.
name|blue
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|default_pix1
condition|)
block|{
if|if
condition|(
operator|*
name|default_pix1
operator|==
literal|'#'
condition|)
name|Parse_color
argument_list|(
name|default_pix1
operator|+
literal|1
argument_list|,
operator|&
name|basecolors
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
elseif|else
if|if TRUE
condition|(
name|havergb
condition|)
block|{
name|dbent
operator|.
name|dptr
operator|=
name|default_pix1
expr_stmt|;
name|dbent
operator|.
name|dsize
operator|=
name|strlen
argument_list|(
name|default_pix1
argument_list|)
expr_stmt|;
name|dbent
operator|=
name|fetch
argument_list|(
name|dbent
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbent
operator|.
name|dptr
condition|)
block|{
name|bcopy
argument_list|(
name|dbent
operator|.
name|dptr
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|color
argument_list|,
sizeof|sizeof
argument_list|(
name|RGB
argument_list|)
argument_list|)
expr_stmt|;
name|basecolors
index|[
literal|1
index|]
operator|.
name|red
operator|=
name|color
operator|.
name|red
expr_stmt|;
name|basecolors
index|[
literal|1
index|]
operator|.
name|green
operator|=
name|color
operator|.
name|green
expr_stmt|;
name|basecolors
index|[
literal|1
index|]
operator|.
name|blue
operator|=
name|color
operator|.
name|blue
expr_stmt|;
block|}
block|}
block|}
name|Store_colors
argument_list|(
literal|2
argument_list|,
name|basecolors
argument_list|)
expr_stmt|;
block|}
name|bit1
operator|=
name|StoreBitmap
argument_list|(
literal|16
argument_list|,
literal|16
argument_list|,
operator|(
name|char
operator|*
operator|)
name|_back
argument_list|)
expr_stmt|;
name|roottile
operator|=
name|MakePixmap
argument_list|(
name|bit1
argument_list|,
name|WhitePixel
argument_list|,
name|BlackPixel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|bit1
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeBitmap
argument_list|(
name|bit1
argument_list|)
expr_stmt|;
name|Create_root_window
argument_list|(
name|device
operator|.
name|height
argument_list|,
name|device
operator|.
name|width
argument_list|,
name|roottile
argument_list|)
expr_stmt|;
name|bit1
operator|=
name|StoreBitmap
argument_list|(
literal|16
argument_list|,
literal|16
argument_list|,
operator|(
name|char
operator|*
operator|)
name|_pointer
argument_list|)
expr_stmt|;
name|bit2
operator|=
name|StoreBitmap
argument_list|(
literal|16
argument_list|,
literal|16
argument_list|,
operator|(
name|char
operator|*
operator|)
name|_ptrmask
argument_list|)
expr_stmt|;
name|rootcursor
operator|=
name|StoreCursor
argument_list|(
name|GXcopy
argument_list|,
name|bit1
argument_list|,
name|WhitePixel
argument_list|,
name|BlackPixel
argument_list|,
name|bit2
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|bit1
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeBitmap
argument_list|(
name|bit1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|bit2
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeBitmap
argument_list|(
name|bit2
argument_list|)
expr_stmt|;
name|bit1
operator|=
name|StoreBitmap
argument_list|(
literal|16
argument_list|,
literal|16
argument_list|,
operator|(
name|char
operator|*
operator|)
name|_ssmask
argument_list|)
expr_stmt|;
name|sscursor
operator|=
name|StoreCursor
argument_list|(
name|GXnoop
argument_list|,
name|bit1
argument_list|,
name|WhitePixel
argument_list|,
name|BlackPixel
argument_list|,
name|bit1
argument_list|,
literal|7
argument_list|,
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|bit1
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeBitmap
argument_list|(
name|bit1
argument_list|)
expr_stmt|;
name|Restore_root
argument_list|()
expr_stmt|;
name|errdelay
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Parse a color spec:  RGB, RRGGBB, RRRGGGBBB, RRRRGGGGBBBB */
end_comment

begin_expr_stmt
name|Parse_color
argument_list|(
name|spec
argument_list|,
name|def
argument_list|)
specifier|register
name|char
operator|*
name|spec
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|ColorDef
modifier|*
name|def
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|,
name|i
decl_stmt|;
name|int
name|r
decl_stmt|,
name|g
decl_stmt|,
name|b
decl_stmt|;
name|char
name|c
decl_stmt|;
name|n
operator|=
name|strlen
argument_list|(
name|spec
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|3
operator|&&
name|n
operator|!=
literal|6
operator|&&
name|n
operator|!=
literal|9
operator|&&
name|n
operator|!=
literal|12
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|n
operator|/=
literal|3
expr_stmt|;
name|r
operator|=
name|g
operator|=
name|b
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|r
operator|=
name|g
expr_stmt|;
name|g
operator|=
name|b
expr_stmt|;
name|b
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|n
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
control|)
block|{
name|c
operator|=
operator|*
name|spec
operator|++
expr_stmt|;
name|b
operator|<<=
literal|4
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
name|b
operator||=
name|c
operator|-
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|>=
literal|'A'
operator|&&
name|c
operator|<=
literal|'F'
condition|)
name|b
operator||=
name|c
operator|-
operator|(
literal|'A'
operator|-
literal|10
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'f'
condition|)
name|b
operator||=
name|c
operator|-
operator|(
literal|'a'
operator|-
literal|10
operator|)
expr_stmt|;
else|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
operator|*
name|spec
condition|)
do|;
name|n
operator|<<=
literal|2
expr_stmt|;
name|n
operator|=
literal|16
operator|-
name|n
expr_stmt|;
name|def
operator|->
name|red
operator|=
name|r
operator|<<
name|n
expr_stmt|;
name|def
operator|->
name|green
operator|=
name|g
operator|<<
name|n
expr_stmt|;
name|def
operator|->
name|blue
operator|=
name|b
operator|<<
name|n
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Restore the world to original condition */
end_comment

begin_macro
name|Restore_root
argument_list|()
end_macro

begin_block
block|{
name|Free_window_storage
argument_list|()
expr_stmt|;
name|Free_rectangle_storage
argument_list|()
expr_stmt|;
if|if
condition|(
name|device
operator|.
name|entries
operator|>
literal|2
condition|)
name|Store_colors
argument_list|(
literal|2
argument_list|,
name|basecolors
argument_list|)
expr_stmt|;
name|Reset_cuts
argument_list|()
expr_stmt|;
name|waittime
operator|.
name|tv_sec
operator|=
name|default_savertime
operator|*
literal|60
expr_stmt|;
name|longtime
operator|.
name|tv_sec
operator|=
name|default_savercycle
operator|*
literal|60
expr_stmt|;
name|SetKeyClick
argument_list|(
name|default_click
argument_list|)
expr_stmt|;
name|SetAutoRepeat
argument_list|(
name|default_repeat
argument_list|)
expr_stmt|;
name|Set_shiftlock
argument_list|(
name|default_lock
argument_list|)
expr_stmt|;
name|base_feep
operator|=
name|default_feep
expr_stmt|;
name|blank_video
operator|=
name|default_blank
expr_stmt|;
name|rootwindow
operator|->
name|mask
operator|=
name|NoEvent
expr_stmt|;
name|rootwindow
operator|->
name|client
operator|=
literal|0
expr_stmt|;
name|rootwindow
operator|->
name|tilemode
operator|=
name|TileModeAbsolute
expr_stmt|;
name|rootwindow
operator|->
name|clipmode
operator|=
name|ClipModeDrawThru
expr_stmt|;
name|Change_background
argument_list|(
name|rootwindow
argument_list|,
name|roottile
argument_list|)
expr_stmt|;
name|Map_root_window
argument_list|()
expr_stmt|;
name|Focus_keyboard
argument_list|(
name|rootwindow
argument_list|)
expr_stmt|;
name|Register_cursor
argument_list|(
name|rootwindow
argument_list|,
name|rootcursor
argument_list|)
expr_stmt|;
name|Startup_mouse
argument_list|()
expr_stmt|;
name|SetMouseCharacteristics
argument_list|(
name|default_threshold
argument_list|,
name|default_acceleration
argument_list|)
expr_stmt|;
name|Reset_hosts
argument_list|(
name|display
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Exists for ddX to call if it needs to simulate input queue */
end_comment

begin_function_decl
name|Define_input_handler
function_decl|(
name|func
function_decl|)
name|int
argument_list|(
argument|*func
argument_list|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
name|inputhandler
operator|=
name|func
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Exists for ddX to call if it needs computes before blocking */
end_comment

begin_function_decl
name|Define_block_handler
function_decl|(
name|func
function_decl|)
name|int
argument_list|(
argument|*func
argument_list|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
name|blockhandler
operator|=
name|func
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Exists for ddX to call if it needs computes after unblocking */
end_comment

begin_function_decl
name|Define_wakeup_handler
function_decl|(
name|func
function_decl|)
name|int
argument_list|(
argument|*func
argument_list|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
name|wakeuphandler
operator|=
name|func
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Force connections to close on SIGHUP from init */
end_comment

begin_macro
name|HangUp
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|GPROF
name|chdir
argument_list|(
literal|"/tmp"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
name|firstsock
init|;
name|i
operator|<
name|maxsock
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|socketOn
index|[
name|i
index|]
condition|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|DisplayDead
argument_list|()
condition|)
name|Error
argument_list|(
literal|"HangUp"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* log a server error */
end_comment

begin_macro
name|Notice
argument_list|(
argument|where
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|where
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error: %s at %s\n"
argument_list|,
operator|(
name|errno
operator|>
literal|0
operator|&&
name|errno
operator|<
name|sys_nerr
operator|)
condition|?
name|sys_errlist
index|[
name|errno
index|]
else|:
literal|"?"
argument_list|,
name|where
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* log a fatal server error */
end_comment

begin_macro
name|Error
argument_list|(
argument|where
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|where
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"fatal "
argument_list|)
expr_stmt|;
name|Notice
argument_list|(
name|where
argument_list|)
expr_stmt|;
if|if
condition|(
name|errdelay
condition|)
name|sleep
argument_list|(
name|errdelay
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* log a device error */
end_comment

begin_macro
name|DeviceError
argument_list|(
argument|why
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|why
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"device error: %s\n"
argument_list|,
name|why
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


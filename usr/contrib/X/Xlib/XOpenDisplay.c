begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* $Header: XOpenDisplay.c,v 10.8 86/02/01 15:37:30 tony Rel $ */
end_comment

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1985	*/
end_comment

begin_include
include|#
directive|include
file|"XlibInternal.h"
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_comment
comment|/*   * Connects to a server, creates a Display object and returns a pointer to  * the newly created Display back to the caller.  */
end_comment

begin_function
name|Display
modifier|*
name|XOpenDisplay
parameter_list|(
name|display
parameter_list|)
specifier|register
name|char
modifier|*
name|display
decl_stmt|;
block|{
specifier|register
name|Display
modifier|*
name|dpy
decl_stmt|;
comment|/* New Display object being created. */
name|char
name|displaybuf
index|[
literal|256
index|]
decl_stmt|;
comment|/* Display string buffer. */
specifier|register
name|char
modifier|*
name|displayptr
decl_stmt|;
comment|/* Display string buffer pointer. */
name|char
name|buf
index|[
literal|3
index|]
decl_stmt|;
comment|/* place to form display string */
name|struct
name|sockaddr_in
name|inaddr
decl_stmt|;
comment|/* INET socket address. */
name|struct
name|sockaddr_un
name|unaddr
decl_stmt|;
comment|/* UNIX socket address. */
name|struct
name|sockaddr
modifier|*
name|addr
decl_stmt|;
comment|/* address to connect to */
name|int
name|addrlen
decl_stmt|;
comment|/* length of address */
name|int
name|dispnum
decl_stmt|;
comment|/* display number. */
name|int
name|indian
decl_stmt|;
comment|/* to determine which indian. */
name|struct
name|hostent
modifier|*
name|host_ptr
decl_stmt|;
ifdef|#
directive|ifdef
name|DNETCONN
name|char
name|objname
index|[
literal|20
index|]
decl_stmt|;
comment|/* Object name buffer */
name|int
name|dnet
init|=
literal|0
decl_stmt|;
comment|/* flag to indicate DECnet connect */
endif|#
directive|endif
specifier|register
name|XReq
modifier|*
name|req
decl_stmt|;
comment|/* XReq request packet pointer. */
name|XRep
name|rep
decl_stmt|;
comment|/* XRep reply packet. */
comment|/* External declarations. */
specifier|extern
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
specifier|extern
name|struct
name|hostent
modifier|*
name|gethostbyname
parameter_list|()
function_decl|;
comment|/* 	 * Extract the host name and display number from the display 	 * specifier string.  The display specifier string is supplied 	 * as an argument to this routine.  If it is NULL or a pointer 	 * to NULL 	 */
if|if
condition|(
name|display
operator|==
name|NULL
operator|||
operator|*
name|display
operator|==
literal|'\0'
condition|)
block|{
name|char
modifier|*
name|disp
decl_stmt|;
comment|/* No display given check the DISPLAY environment variable. */
if|if
condition|(
operator|(
name|disp
operator|=
name|getenv
argument_list|(
literal|"DISPLAY"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
comment|/* Oops! No DISPLAY environment variable - error. */
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|strncpy
argument_list|(
name|displaybuf
argument_list|,
name|disp
argument_list|,
sizeof|sizeof
argument_list|(
name|displaybuf
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Display is non-NULL, copy it into the display buffer. */
name|strncpy
argument_list|(
name|displaybuf
argument_list|,
name|display
argument_list|,
sizeof|sizeof
argument_list|(
name|displaybuf
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/*  	 * Find the ':' seperator and cut out the hostname and the 	 * display number. 	 * NOTE - if DECnet is to be used, the display name is formated 	 * as "host::number" 	 */
if|if
condition|(
operator|(
name|displayptr
operator|=
name|index
argument_list|(
name|displaybuf
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
ifdef|#
directive|ifdef
name|DNETCONN
if|if
condition|(
operator|*
operator|(
name|displayptr
operator|+
literal|1
operator|)
operator|==
literal|':'
condition|)
block|{
name|dnet
operator|++
expr_stmt|;
operator|*
operator|(
name|displayptr
operator|++
operator|)
operator|=
literal|'\0'
expr_stmt|;
block|}
endif|#
directive|endif
operator|*
operator|(
name|displayptr
operator|++
operator|)
operator|=
literal|'\0'
expr_stmt|;
comment|/* displaybuf now contains only a null-terminated host name; 	 * displayptr points to the display number */
comment|/* If the display number is missing there is an error. 	 * Otherwise, convert string to an integer we can use */
if|if
condition|(
operator|*
name|displayptr
operator|==
literal|'\0'
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|dispnum
operator|=
name|atoi
argument_list|(
name|displayptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"unix"
argument_list|,
name|displaybuf
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Connect locally using Unix domain. */
name|unaddr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|strcpy
argument_list|(
name|unaddr
operator|.
name|sun_path
argument_list|,
name|X_UNIX_PATH
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|unaddr
operator|.
name|sun_path
argument_list|,
name|displayptr
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|unaddr
expr_stmt|;
name|addrlen
operator|=
name|strlen
argument_list|(
name|unaddr
operator|.
name|sun_path
argument_list|)
operator|+
literal|2
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|DNETCONN
if|if
condition|(
operator|!
name|dnet
condition|)
block|{
endif|#
directive|endif
comment|/* If the hostname is missing default to the local host. */
if|if
condition|(
name|displaybuf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|gethostname
argument_list|(
name|displaybuf
argument_list|,
sizeof|sizeof
argument_list|(
name|displaybuf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Get the statistics on the specified host. */
if|if
condition|(
operator|(
name|host_ptr
operator|=
name|gethostbyname
argument_list|(
name|displaybuf
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
comment|/* No such host! */
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Check the address type to see if it is an internet host. */
if|if
condition|(
name|host_ptr
operator|->
name|h_addrtype
operator|!=
name|AF_INET
condition|)
block|{
comment|/* Not an Internet host! */
name|errno
operator|=
name|EPROTOTYPE
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Set up the socket data. */
name|inaddr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|inaddr
operator|.
name|sin_port
operator|=
name|dispnum
expr_stmt|;
name|indian
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|char
operator|*
operator|)
operator|&
name|indian
condition|)
name|inaddr
operator|.
name|sin_port
operator|+=
name|X_TCP_LI_PORT
expr_stmt|;
else|else
name|inaddr
operator|.
name|sin_port
operator|+=
name|X_TCP_BI_PORT
expr_stmt|;
name|inaddr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|inaddr
operator|.
name|sin_port
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|host_ptr
operator|->
name|h_addr
argument_list|,
operator|&
name|inaddr
operator|.
name|sin_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|inaddr
operator|.
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|inaddr
expr_stmt|;
name|addrlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DNETCONN
block|}
else|else
block|{
comment|/* If the nodename is missing default to the local node. */
if|if
condition|(
name|displaybuf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|strcpy
argument_list|(
name|displaybuf
argument_list|,
literal|"0"
argument_list|)
expr_stmt|;
comment|/* build the target object name. */
name|sprintf
argument_list|(
name|objname
argument_list|,
literal|"X%d"
argument_list|,
name|dispnum
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
comment|/* Malloc the new Display. */
if|if
condition|(
operator|(
name|dpy
operator|=
operator|(
name|Display
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Display
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
comment|/* Malloc call failed! */
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|dpy
operator|->
name|height
operator|=
name|dpy
operator|->
name|width
operator|=
literal|0
expr_stmt|;
comment|/* If DisplayWidth or DisplayWidth is subsequently called, 	       these will be replaced by "real" values. */
comment|/* Open the network socket. */
ifdef|#
directive|ifdef
name|DNETCONN
if|if
condition|(
operator|!
name|dnet
condition|)
block|{
endif|#
directive|endif
if|if
condition|(
operator|(
name|dpy
operator|->
name|fd
operator|=
name|socket
argument_list|(
name|addr
operator|->
name|sa_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
comment|/* Socket call failed! */
comment|/* errno set by system call. */
name|free
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Open the connection to the specified X server. */
if|if
condition|(
name|connect
argument_list|(
name|dpy
operator|->
name|fd
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* Connection call failed! */
comment|/* errno set by system call. */
name|close
argument_list|(
name|dpy
operator|->
name|fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|DNETCONN
block|}
else|else
block|{
if|if
condition|(
operator|(
name|dpy
operator|->
name|fd
operator|=
name|dnet_conn
argument_list|(
name|displaybuf
argument_list|,
name|objname
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
comment|/* connect failed! */
comment|/* errno set by dnet_conn. */
name|free
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
endif|#
directive|endif
comment|/* Salt away the host:display string for later use */
name|buf
index|[
literal|0
index|]
operator|=
literal|':'
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
literal|'0'
operator|+
name|dispnum
expr_stmt|;
name|strcat
argument_list|(
name|displaybuf
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dpy
operator|->
name|displayname
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|displaybuf
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|close
argument_list|(
name|dpy
operator|->
name|fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|strcpy
argument_list|(
name|dpy
operator|->
name|displayname
argument_list|,
name|displaybuf
argument_list|)
expr_stmt|;
comment|/* Set up the output buffers. */
if|if
condition|(
operator|(
name|dpy
operator|->
name|bufptr
operator|=
name|dpy
operator|->
name|buffer
operator|=
name|malloc
argument_list|(
name|BUFSIZE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
comment|/* Malloc call failed! */
name|close
argument_list|(
name|dpy
operator|->
name|fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|dpy
operator|->
name|bufmax
operator|=
name|dpy
operator|->
name|buffer
operator|+
name|BUFSIZE
expr_stmt|;
comment|/* Set up the input event queue and input event queue parameters. */
name|dpy
operator|->
name|head
operator|=
name|dpy
operator|->
name|tail
operator|=
name|NULL
expr_stmt|;
name|dpy
operator|->
name|qlen
operator|=
literal|0
expr_stmt|;
comment|/* Initialize MouseMoved event squishing. */
name|dpy
operator|->
name|squish
operator|=
literal|1
expr_stmt|;
name|_XlibCurrentDisplay
operator|=
name|dpy
expr_stmt|;
comment|/* Send an X_SetUp request to the server. */
name|GetReq
argument_list|(
name|X_SetUp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Send X_MakePixmap requests to get black and white          * constant tile Pixmaps */
name|GetReq
argument_list|(
name|X_MakePixmap
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|req
operator|->
name|param
operator|.
name|l
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* no bitmap */
name|req
operator|->
name|param
operator|.
name|u
index|[
literal|2
index|]
operator|=
name|BlackPixel
expr_stmt|;
name|GetReq
argument_list|(
name|X_MakePixmap
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|req
operator|->
name|param
operator|.
name|l
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|param
operator|.
name|u
index|[
literal|2
index|]
operator|=
name|WhitePixel
expr_stmt|;
comment|/* The following is needed to synchronize properly with errors, 	 * since three requests are outstanding and no replies have 	 * yet been read 	 */
name|dpy
operator|->
name|request
operator|=
literal|1
expr_stmt|;
comment|/* Get reply to X_SetUp */
if|if
condition|(
operator|!
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|&
name|rep
argument_list|)
condition|)
block|{
comment|/* There was an error in retrieving the reply. */
name|close
argument_list|(
name|dpy
operator|->
name|fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dpy
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Set the Display data returned by the X_SetUp call. */
name|dpy
operator|->
name|root
operator|=
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|0
index|]
expr_stmt|;
comment|/* Root window id. */
name|dpy
operator|->
name|vnumber
operator|=
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|2
index|]
expr_stmt|;
comment|/* X protocol version number. */
name|dpy
operator|->
name|dtype
operator|=
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|3
index|]
expr_stmt|;
comment|/* Server's display type. */
name|dpy
operator|->
name|dplanes
operator|=
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|4
index|]
expr_stmt|;
comment|/* Number of display bit planes. */
name|dpy
operator|->
name|dcells
operator|=
name|rep
operator|.
name|param
operator|.
name|u
index|[
literal|5
index|]
expr_stmt|;
comment|/* Number of display color map cell. */
comment|/* Get reply to MakePixmap (black) */
name|dpy
operator|->
name|request
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|&
name|rep
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|dpy
operator|->
name|fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dpy
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|dpy
operator|->
name|black
operator|=
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|0
index|]
expr_stmt|;
comment|/* Get reply to MakePixmap (white) */
name|dpy
operator|->
name|request
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|&
name|rep
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|dpy
operator|->
name|fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dpy
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|dpy
operator|->
name|white
operator|=
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|0
index|]
expr_stmt|;
return|return
operator|(
name|dpy
operator|)
return|;
block|}
end_function

end_unit


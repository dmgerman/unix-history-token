begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1985	*/
end_comment

begin_comment
comment|/*  *	GetButton - This subroutine is used by the X Window Manager (xwm)  *	to acquire button events.  It waits for a button event to occur  *	and handles all event traffic in the interim.  *  *	File:		GetButton.c  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_GetButton_c
init|=
literal|"$Header: GetButton.c,v 10.5 86/02/01 16:09:26 tony Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"xwm.h"
end_include

begin_function
name|Bool
name|GetButton
parameter_list|(
name|button_event
parameter_list|)
name|XButtonEvent
modifier|*
name|button_event
decl_stmt|;
comment|/* Button event packet. */
block|{
name|XKeyPressedEvent
modifier|*
name|kp_event
decl_stmt|;
comment|/* Key pressed event. */
name|char
modifier|*
name|icon_str
decl_stmt|;
comment|/* Icon's name string. */
specifier|register
name|int
name|icon_str_len
decl_stmt|;
comment|/* Icon name string lenght.  */
specifier|register
name|int
name|key_char
decl_stmt|;
comment|/* Key press character code. */
specifier|register
name|int
name|icon_x
decl_stmt|;
comment|/* Icon window X coordinate. */
specifier|register
name|int
name|icon_y
decl_stmt|;
comment|/* Icon window Y coordinate. */
specifier|register
name|int
name|icon_w
decl_stmt|;
comment|/* Icon window width. */
specifier|register
name|int
name|icon_h
decl_stmt|;
comment|/* Icon window height. */
name|int
name|status
decl_stmt|;
comment|/* Routine call return status. */
name|Window
name|icon
decl_stmt|;
comment|/* Icon window. */
name|WindowInfo
name|icon_info
decl_stmt|;
comment|/* Icon window info structure. */
name|char
modifier|*
name|kbd_str
decl_stmt|;
comment|/* Keyboard string	*/
name|int
name|nbytes
decl_stmt|;
comment|/* Keyboard string length	*/
name|int
name|i
decl_stmt|;
comment|/* loop over the string		*/
name|Bool
name|name_changed
init|=
name|FALSE
decl_stmt|;
comment|/* if TRUE, must redisplay */
comment|/*      * Get next event from input queue and store it in the event packet      * passed to GetButton.      */
name|XNextEvent
argument_list|(
name|button_event
argument_list|)
expr_stmt|;
comment|/*      * The event occured on the root window, it must be a mouse      * button event.       */
if|if
condition|(
name|button_event
operator|->
name|window
operator|==
name|RootWindow
condition|)
block|{
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
comment|/*      * Ok, if the event is not on the root window it must be an event on      * one of the icons owned by xwm.      */
name|icon
operator|=
name|button_event
operator|->
name|window
expr_stmt|;
comment|/*      * If the event is an UnmapWindow event then delete the icon window      * and return FALSE.      */
if|if
condition|(
name|button_event
operator|->
name|type
operator|==
name|UnmapWindow
condition|)
block|{
name|XDestroyWindow
argument_list|(
name|icon
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
comment|/*      * If it is not an UnmapWindow event then it must be either an       * ExposeWindow event or a KeyPressed event.      */
comment|/*      * Find out current information about the icon window.      */
name|status
operator|=
name|XQueryWindow
argument_list|(
name|icon
argument_list|,
operator|&
name|icon_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|FAILURE
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
comment|/*      * Initialize the icon position variables.      */
name|icon_x
operator|=
name|icon_info
operator|.
name|x
expr_stmt|;
name|icon_y
operator|=
name|icon_info
operator|.
name|y
expr_stmt|;
comment|/*      * Get the name of the window associated with the icon and      * determine its lenght.      */
name|status
operator|=
name|XFetchName
argument_list|(
name|icon_info
operator|.
name|assoc_wind
argument_list|,
operator|&
name|icon_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|FAILURE
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|icon_str_len
operator|=
name|icon_str
condition|?
name|strlen
argument_list|(
name|icon_str
argument_list|)
else|:
literal|0
expr_stmt|;
comment|/*      * If the event is a window exposure event and the icon's name string      * is not of zero length, simply repaint the text in the icon window      * and return FALSE.      */
if|if
condition|(
name|button_event
operator|->
name|type
operator|==
name|ExposeWindow
condition|)
block|{
name|XClear
argument_list|(
name|icon
argument_list|)
expr_stmt|;
if|if
condition|(
name|icon_str_len
operator|!=
literal|0
condition|)
block|{
name|XTextPad
argument_list|(
name|icon
argument_list|,
name|IPadding
argument_list|,
name|IPadding
argument_list|,
name|icon_str
argument_list|,
name|icon_str_len
argument_list|,
name|IFont
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|ITextForground
argument_list|,
name|ITextBackground
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
comment|/* 	     * Remember to free the icon name string.  (Oh Bother! Said Poo.) 	     */
name|free
argument_list|(
name|icon_str
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
comment|/*      * If we have gotten this far event can only be a key pressed event.      */
name|kp_event
operator|=
operator|(
name|XKeyPressedEvent
operator|*
operator|)
name|button_event
expr_stmt|;
comment|/*       * We convert the key pressed event to ascii.      */
name|kbd_str
operator|=
name|XLookupMapping
argument_list|(
name|kp_event
argument_list|,
operator|&
name|nbytes
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbytes
condition|;
name|i
operator|++
control|)
block|{
name|key_char
operator|=
name|kbd_str
index|[
name|i
index|]
expr_stmt|;
comment|/* 	     * If the key was<DELETE>, then delete a character from the end of 	     * the name. 	     * 	     * If the key was<CTRL-U>, then wipe out the entire window name. 	     * 	     * All other ctrl keys are squashed. 	     * 	     * All printable characters are appended to the window's name, which 	     * may have to be grown to allow for the extra length. 	     */
if|if
condition|(
name|key_char
operator|==
literal|'\177'
condition|)
block|{
comment|/* 		 *<DELETE> 		 */
if|if
condition|(
name|icon_str_len
operator|>
literal|0
condition|)
block|{
name|icon_str_len
operator|--
expr_stmt|;
name|icon_str
index|[
name|icon_str_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|name_changed
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|key_char
operator|==
literal|'\025'
condition|)
block|{
comment|/* 		 *<CTRL-U> 		 */
if|if
condition|(
name|icon_str_len
operator|>
literal|0
condition|)
block|{
name|icon_str_len
operator|=
literal|0
expr_stmt|;
operator|*
name|icon_str
operator|=
literal|'\0'
expr_stmt|;
name|name_changed
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|key_char
operator|<
name|IFontInfo
operator|.
name|firstchar
operator|||
name|key_char
operator|>
name|IFontInfo
operator|.
name|lastchar
condition|)
comment|/* 		 * Any other random (non-printable) key: ignore it. 		 */
comment|/* do nothing */
empty_stmt|;
else|else
block|{
comment|/* 		 * ASCII Alphanumerics. 		 */
if|if
condition|(
name|icon_str
operator|==
name|NULL
condition|)
name|icon_str
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|icon_str_len
operator|+
literal|2
argument_list|)
expr_stmt|;
else|else
name|icon_str
operator|=
operator|(
name|char
operator|*
operator|)
name|realloc
argument_list|(
name|icon_str
argument_list|,
operator|(
name|icon_str_len
operator|+
literal|2
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|icon_str
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
name|Error
argument_list|(
literal|"GetButton -> Realloc of window name string memory failed."
argument_list|)
expr_stmt|;
block|}
name|icon_str
index|[
name|icon_str_len
index|]
operator|=
name|key_char
expr_stmt|;
name|icon_str
index|[
name|icon_str_len
operator|+
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|icon_str_len
operator|+=
literal|1
expr_stmt|;
name|name_changed
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|name_changed
condition|)
block|{
comment|/* 	 * Now that we have changed the size of the icon we have to reconfigure 	 * it so that everything looks good.  Oh yes, don't forget to move the 	 * mouse so that it stays in the window! 	 */
comment|/* 	 * Set the window name to the new string. 	 */
name|XStoreName
argument_list|(
name|icon_info
operator|.
name|assoc_wind
argument_list|,
name|icon_str
argument_list|)
expr_stmt|;
comment|/* 	 * Determine the new icon window configuration. 	 */
name|icon_h
operator|=
name|IFontInfo
operator|.
name|height
operator|+
operator|(
name|IPadding
operator|<<
literal|1
operator|)
expr_stmt|;
name|icon_w
operator|=
name|XQueryWidth
argument_list|(
name|icon_str
argument_list|,
name|IFont
argument_list|)
expr_stmt|;
if|if
condition|(
name|icon_w
operator|==
literal|0
condition|)
block|{
name|icon_w
operator|=
name|icon_h
expr_stmt|;
block|}
else|else
block|{
name|icon_w
operator|+=
operator|(
name|IPadding
operator|<<
literal|1
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|icon_x
operator|<
literal|0
condition|)
name|icon_x
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|icon_y
operator|<
literal|0
condition|)
name|icon_y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|icon_x
operator|-
literal|1
operator|+
name|icon_w
operator|+
operator|(
name|IBorderWidth
operator|<<
literal|1
operator|)
operator|>
name|ScreenWidth
condition|)
block|{
name|icon_x
operator|=
name|ScreenWidth
operator|-
name|icon_w
operator|-
operator|(
name|IBorderWidth
operator|<<
literal|1
operator|)
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|icon_y
operator|-
literal|1
operator|+
name|icon_h
operator|+
operator|(
name|IBorderWidth
operator|<<
literal|1
operator|)
operator|>
name|ScreenHeight
condition|)
block|{
name|icon_y
operator|=
name|ScreenHeight
operator|-
name|icon_h
operator|-
operator|(
name|IBorderWidth
operator|<<
literal|1
operator|)
operator|+
literal|1
expr_stmt|;
block|}
name|XConfigureWindow
argument_list|(
name|icon
argument_list|,
name|icon_x
argument_list|,
name|icon_y
argument_list|,
name|icon_w
argument_list|,
name|icon_h
argument_list|)
expr_stmt|;
name|XWarpMouse
argument_list|(
name|icon
argument_list|,
operator|(
name|icon_w
operator|>>
literal|1
operator|)
argument_list|,
operator|(
name|icon_h
operator|>>
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*       * Free the local storage and return FALSE.      */
if|if
condition|(
name|icon_str
condition|)
name|free
argument_list|(
name|icon_str
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
end_function

end_unit


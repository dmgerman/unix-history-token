begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: initial.c,v 10.4 86/02/01 16:21:01 tony Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|sun
end_ifdef

begin_comment
comment|/*  * The Sun X drivers are a product of Sun Microsystems, Inc. and are provided  * for unrestricted use provided that this legend is included on all tape  * media and as a part of the software program in whole or part.  Users  * may copy or modify these drivers without charge, but are not authorized  * to license or distribute them to anyone else except as part of a product or  * program developed by the user.  *   * THE SUN X DRIVERS ARE PROVIDED AS IS WITH NO WARRANTIES OF ANY KIND  * INCLUDING THE WARRANTIES OF DESIGN, MERCHANTIBILITY AND FITNESS FOR A  * PARTICULAR PURPOSE, OR ARISING FROM A COURSE OF DEALING, USAGE OR TRADE  * PRACTICE.  *  * The Sun X Drivers are provided with no support and without any obligation  * on the part of Sun Microsystems, Inc. to assist in their use, correction,  * modification or enhancement.  *   * SUN MICROSYSTEMS, INC. SHALL HAVE NO LIABILITY WITH RESPECT TO THE  * INFRINGEMENT OF COPYRIGHTS, TRADE SECRETS OR ANY PATENTS BY THE SUN X  * DRIVERS OR ANY PART THEREOF.  *   * In no event will Sun Microsystems, Inc. be liable for any lost revenue  * or profits or other special, indirect and consequential damages, even if  * Sun has been advised of the possibility of such damages.  *   * Sun Microsystems, Inc.  * 2550 Garcia Avenue  * Mountain View, California  94043  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"%Z%%M% %I% %E% Copyright 1986 Sun Micro"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*-  * Copyright 1985, Massachusetts Institute of Technology  * Copyright (c) 1986 by Sun Microsystems,  Inc.  */
end_comment

begin_comment
comment|/* initial.c	Routines to open& close display  *  *	OpenDisplay		Open it  *	InitDisplay		Download it  *	DisplayDead		Check if dead  *	Allocate_space		Allocate some temporary storage  *  */
end_comment

begin_comment
comment|/*  *	ToDo:  *		Look in environment/defaults for programs to start  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/signal.h>
end_include

begin_include
include|#
directive|include
file|<sun/fbio.h>
end_include

begin_include
include|#
directive|include
file|"Xsun.h"
end_include

begin_include
include|#
directive|include
file|<pixrect/pixrect_hs.h>
end_include

begin_include
include|#
directive|include
file|<sunwindow/rect.h>
end_include

begin_include
include|#
directive|include
file|<sunwindow/rectlist.h>
end_include

begin_include
include|#
directive|include
file|<sunwindow/pixwin.h>
end_include

begin_include
include|#
directive|include
file|<sunwindow/win_screen.h>
end_include

begin_include
include|#
directive|include
file|<sunwindow/win_struct.h>
end_include

begin_include
include|#
directive|include
file|<sunwindow/win_input.h>
end_include

begin_function_decl
specifier|extern
name|int
name|InputReader
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|pixwin
modifier|*
name|Display
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pixrect
modifier|*
name|PixRect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|InvPix
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|Sun_From_X_Op
index|[]
init|=
block|{
name|PIX_CLR
block|,
comment|/* GXclear */
name|PIX_SRC
operator|&
name|PIX_DST
block|,
comment|/* GXand */
name|PIX_SRC
operator|&
name|PIX_NOT
argument_list|(
name|PIX_DST
argument_list|)
block|,
comment|/* GXandReverse */
name|PIX_SRC
block|,
comment|/* GXcopy */
name|PIX_NOT
argument_list|(
name|PIX_SRC
argument_list|)
operator|&
name|PIX_DST
block|,
comment|/* GXandInverted */
name|PIX_DST
block|,
comment|/* GXnoop */
name|PIX_SRC
operator|^
name|PIX_DST
block|,
comment|/* GXxor */
name|PIX_SRC
operator||
name|PIX_DST
block|,
comment|/* GXor */
name|PIX_NOT
argument_list|(
name|PIX_SRC
argument_list|)
operator|&
name|PIX_NOT
argument_list|(
name|PIX_DST
argument_list|)
block|,
comment|/* GXnor */
name|PIX_NOT
argument_list|(
name|PIX_SRC
argument_list|)
operator|^
name|PIX_DST
block|,
comment|/* GXequiv */
name|PIX_NOT
argument_list|(
name|PIX_DST
argument_list|)
block|,
comment|/* GXinvert */
name|PIX_SRC
operator||
name|PIX_NOT
argument_list|(
name|PIX_DST
argument_list|)
block|,
comment|/* GXorReverse */
name|PIX_NOT
argument_list|(
name|PIX_SRC
argument_list|)
block|,
comment|/* GXcopyInverted */
name|PIX_NOT
argument_list|(
name|PIX_SRC
argument_list|)
operator||
name|PIX_DST
block|,
comment|/* GXorInverted */
name|PIX_NOT
argument_list|(
name|PIX_SRC
argument_list|)
operator||
name|PIX_NOT
argument_list|(
name|PIX_DST
argument_list|)
block|,
comment|/* GXnand */
name|PIX_SET
block|,
comment|/* GXset */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|vsdev
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DEVICE
modifier|*
name|CurrentDevice
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PARENT
value|"WINDOW_GFX"
end_define

begin_comment
comment|/* Open the display */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|parent
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|OpenDisplay
argument_list|(
argument|devname
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|devname
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|screen
name|sc
decl_stmt|;
specifier|extern
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
name|signal
argument_list|(
name|SIGWINCH
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|parent
operator|=
name|getenv
argument_list|(
name|PARENT
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|sc
argument_list|,
sizeof|sizeof
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|devname
operator|!=
literal|'/'
condition|)
name|devname
operator|=
literal|"/dev/fb"
expr_stmt|;
name|strncpy
argument_list|(
name|sc
operator|.
name|scr_fbname
argument_list|,
name|devname
argument_list|,
name|SCR_NAMESIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|parent
condition|)
block|{
comment|/* Running under "overview" */
name|int
name|pfd
decl_stmt|;
if|if
condition|(
operator|(
name|pfd
operator|=
name|open
argument_list|(
name|parent
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open parent %s\n"
argument_list|,
name|parent
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|vsdev
operator|=
name|win_getnewwindow
argument_list|()
expr_stmt|;
name|win_setlink
argument_list|(
name|vsdev
argument_list|,
name|WL_PARENT
argument_list|,
name|win_fdtonumber
argument_list|(
name|pfd
argument_list|)
argument_list|)
expr_stmt|;
name|win_insert
argument_list|(
name|vsdev
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pfd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Running alone */
name|vsdev
operator|=
name|win_screennew
argument_list|(
operator|&
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|vsdev
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Do sun specific initialization */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|notdef
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|pid
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|XTERM
value|"xterm"
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|args
index|[]
init|=
block|{
name|XTERM
block|,
literal|"=80x24+30+30"
block|,
literal|"-C"
block|,
literal|"-n"
block|,
literal|"console"
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_expr_stmt
specifier|static
name|SigChildHandler
argument_list|()
block|{
specifier|register
name|int
name|dead
block|;
expr|union
name|wait
name|status
block|;
while|while
condition|(
operator|(
name|dead
operator|=
name|wait3
argument_list|(
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|,
name|NULL
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|dead
operator|==
name|pid
condition|)
block|{
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_expr_stmt
unit|} }
specifier|static
name|StartShell
argument_list|()
block|{
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|SigChildHandler
argument_list|)
block|;
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
block|{
specifier|register
name|int
name|i
init|=
name|getdtablesize
argument_list|()
decl_stmt|;
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
block|{
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_expr_stmt
unit|} 	open
operator|(
literal|"/dev/null"
operator|,
literal|2
operator|,
literal|0
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|dup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|dup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_block
block|{
comment|/* Copy the environment for Setenv */
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
specifier|register
name|int
name|i
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|envnew
decl_stmt|;
while|while
condition|(
name|environ
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|i
operator|++
expr_stmt|;
name|envnew
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|i
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|envnew
index|[
name|i
index|]
operator|=
name|environ
index|[
name|i
index|]
expr_stmt|;
name|environ
operator|=
name|envnew
expr_stmt|;
block|}
end_block

begin_block
block|{
define|#
directive|define
name|HOSTNAMESIZE
value|128
name|char
name|DisplayName
index|[
name|HOSTNAMESIZE
index|]
decl_stmt|;
name|gethostname
argument_list|(
name|DisplayName
argument_list|,
name|HOSTNAMESIZE
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|DisplayName
argument_list|,
literal|":0"
argument_list|)
expr_stmt|;
name|Setenv
argument_list|(
literal|"DISPLAY="
argument_list|,
name|DisplayName
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|HOSTNAMESIZE
block|}
end_block

begin_expr_stmt
name|execvp
argument_list|(
name|XTERM
argument_list|,
name|args
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
unit|} }
endif|#
directive|endif
end_endif

begin_expr_stmt
name|InitDisplay
argument_list|(
name|info
argument_list|)
specifier|register
name|DEVICE
operator|*
name|info
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|static
name|vsCursor
name|vsc
decl_stmt|;
specifier|static
name|vsBox
name|vsm
decl_stmt|;
specifier|static
name|vsEventQueue
name|vsq
init|=
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,     }
decl_stmt|;
name|struct
name|screen
name|sc
decl_stmt|;
name|win_screenget
argument_list|(
name|vsdev
argument_list|,
operator|&
name|sc
argument_list|)
expr_stmt|;
name|info
operator|->
name|height
operator|=
name|sc
operator|.
name|scr_rect
operator|.
name|r_height
expr_stmt|;
name|info
operator|->
name|width
operator|=
name|sc
operator|.
name|scr_rect
operator|.
name|r_width
expr_stmt|;
if|if
condition|(
name|parent
condition|)
block|{
comment|/* running under "overview" */
name|win_setrect
argument_list|(
name|vsdev
argument_list|,
operator|&
name|sc
operator|.
name|scr_rect
argument_list|)
expr_stmt|;
block|}
block|{
name|struct
name|fbtype
name|fbt
decl_stmt|;
name|int
name|fd
init|=
name|open
argument_list|(
name|sc
operator|.
name|scr_fbname
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
operator|||
name|ioctl
argument_list|(
name|fd
argument_list|,
name|FBIOGTYPE
argument_list|,
operator|&
name|fbt
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open fb %s\n"
argument_list|,
name|sc
operator|.
name|scr_fbname
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't FBIOGTYPE on %s\n"
argument_list|,
name|sc
operator|.
name|scr_fbname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|info
operator|->
name|id
operator|=
name|fbt
operator|.
name|fb_type
operator|+
name|SUN_BASE
expr_stmt|;
name|info
operator|->
name|planes
operator|=
name|fbt
operator|.
name|fb_depth
expr_stmt|;
name|info
operator|->
name|entries
operator|=
name|fbt
operator|.
name|fb_cmsize
expr_stmt|;
block|}
name|Display
operator|=
name|pw_open
argument_list|(
name|vsdev
argument_list|)
expr_stmt|;
name|PixRect
operator|=
name|Display
operator|->
name|pw_pixrect
expr_stmt|;
name|pw_reversevideo
argument_list|(
name|Display
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|{
name|struct
name|inputmask
name|im
decl_stmt|;
name|input_imnull
argument_list|(
operator|&
name|im
argument_list|)
expr_stmt|;
name|im
operator|.
name|im_flags
operator|=
name|IM_ASCII
operator||
name|IM_META
operator||
name|IM_NEGEVENT
expr_stmt|;
name|win_setinputcodebit
argument_list|(
operator|&
name|im
argument_list|,
name|LOC_MOVE
argument_list|)
expr_stmt|;
name|win_setinputcodebit
argument_list|(
operator|&
name|im
argument_list|,
name|MS_LEFT
argument_list|)
expr_stmt|;
name|win_setinputcodebit
argument_list|(
operator|&
name|im
argument_list|,
name|MS_MIDDLE
argument_list|)
expr_stmt|;
name|win_setinputcodebit
argument_list|(
operator|&
name|im
argument_list|,
name|MS_RIGHT
argument_list|)
expr_stmt|;
name|win_setinputmask
argument_list|(
name|vsdev
argument_list|,
operator|&
name|im
argument_list|,
name|NULL
argument_list|,
name|WIN_NULLLINK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fcntl
argument_list|(
name|vsdev
argument_list|,
name|F_SETFL
argument_list|,
name|O_NDELAY
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|{
comment|/* Following struct cannot be included from win_cursor.h */
struct|struct
name|cursor
block|{
name|short
name|cur_xhot
decl_stmt|,
name|cur_yhot
decl_stmt|;
comment|/* offset of mouse position from shape*/
name|int
name|cur_function
decl_stmt|;
comment|/* relationship of shape to screen */
name|struct
name|pixrect
modifier|*
name|cur_shape
decl_stmt|;
comment|/* memory image to use */
name|int
name|flags
decl_stmt|;
comment|/* various options */
name|short
name|horiz_hair_thickness
decl_stmt|;
comment|/* horizontal crosshair height */
name|int
name|horiz_hair_op
decl_stmt|;
comment|/*            drawing op       */
name|int
name|horiz_hair_color
decl_stmt|;
comment|/*            color            */
name|short
name|horiz_hair_length
decl_stmt|;
comment|/*            width           */
name|short
name|horiz_hair_gap
decl_stmt|;
comment|/*            gap             */
name|short
name|vert_hair_thickness
decl_stmt|;
comment|/* vertical crosshair width  */
name|int
name|vert_hair_op
decl_stmt|;
comment|/*          drawing op       */
name|int
name|vert_hair_color
decl_stmt|;
comment|/*          color            */
name|short
name|vert_hair_length
decl_stmt|;
comment|/*          height           */
name|short
name|vert_hair_gap
decl_stmt|;
comment|/*          gap              */
block|}
name|cs
struct|;
specifier|static
name|struct
name|pixrect
name|pr
decl_stmt|;
name|cs
operator|.
name|cur_xhot
operator|=
name|cs
operator|.
name|cur_yhot
operator|=
name|cs
operator|.
name|cur_function
operator|=
literal|0
expr_stmt|;
name|cs
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|cs
operator|.
name|cur_shape
operator|=
operator|&
name|pr
expr_stmt|;
name|pr
operator|.
name|pr_size
operator|.
name|x
operator|=
name|pr
operator|.
name|pr_size
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|win_setcursor
argument_list|(
name|vsdev
argument_list|,
operator|&
name|cs
argument_list|)
expr_stmt|;
name|win_setmouseposition
argument_list|(
name|vsdev
argument_list|,
name|info
operator|->
name|width
operator|>>
literal|1
argument_list|,
name|info
operator|->
name|height
operator|>>
literal|1
argument_list|)
expr_stmt|;
block|}
name|info
operator|->
name|mouse
operator|=
operator|&
name|vsc
expr_stmt|;
name|info
operator|->
name|mbox
operator|=
operator|&
name|vsm
expr_stmt|;
name|info
operator|->
name|queue
operator|=
operator|&
name|vsq
expr_stmt|;
name|Define_input_handler
argument_list|(
name|InputReader
argument_list|)
expr_stmt|;
name|SetUpInvPix
argument_list|()
expr_stmt|;
name|CurrentDevice
operator|=
name|info
expr_stmt|;
ifdef|#
directive|ifdef
name|notdef
name|StartShell
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Check if display is dead */
end_comment

begin_macro
name|DisplayDead
argument_list|()
end_macro

begin_block
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* the presumption here is that only one Allocate_space call is made/request */
end_comment

begin_define
define|#
directive|define
name|ABUFSIZE
value|3072
end_define

begin_decl_stmt
specifier|static
name|char
name|ABuffer
index|[
literal|3072
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* random size buffer for allocate space */
end_comment

begin_function
name|caddr_t
name|AllocateSpace
parameter_list|(
name|size
parameter_list|)
specifier|register
name|int
name|size
decl_stmt|;
block|{
if|if
condition|(
name|size
operator|<
name|ABUFSIZE
condition|)
return|return
operator|(
name|ABuffer
operator|)
return|;
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX - should be static data */
end_comment

begin_macro
name|SetUpInvPix
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|255
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
specifier|register
name|int
name|j
init|=
literal|1
decl_stmt|,
name|k
init|=
literal|128
decl_stmt|,
name|l
init|=
literal|8
decl_stmt|;
while|while
condition|(
name|l
operator|--
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|&
name|j
operator|)
operator|!=
literal|0
condition|)
name|InvPix
index|[
name|i
index|]
operator||=
name|k
expr_stmt|;
name|j
operator|<<=
literal|1
expr_stmt|;
name|k
operator|>>=
literal|1
expr_stmt|;
block|}
block|}
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|notdef
end_ifdef

begin_expr_stmt
name|Setenv
argument_list|(
name|var
argument_list|,
name|value
argument_list|)
comment|/*    sets the value of var to be arg in the Unix 4.2 BSD environment env.    Var should end with '='.    (bindings are of the form "var=value")    This procedure assumes the memory for the first level of environ    was allocated using malloc.  */
specifier|register
name|char
operator|*
name|var
operator|,
operator|*
name|value
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
specifier|register
name|int
name|index
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|environ
index|[
name|index
index|]
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|environ
index|[
name|index
index|]
argument_list|,
name|var
argument_list|,
name|strlen
argument_list|(
name|var
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* found it */
name|environ
index|[
name|index
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|var
argument_list|)
operator|+
name|strlen
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|environ
index|[
name|index
index|]
argument_list|,
name|var
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|environ
index|[
name|index
index|]
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
block|}
name|index
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|environ
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|realloc
argument_list|(
name|environ
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|index
operator|+
literal|2
operator|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Setenv: malloc out of memory\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|environ
index|[
name|index
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|var
argument_list|)
operator|+
name|strlen
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|environ
index|[
name|index
index|]
argument_list|,
name|var
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|environ
index|[
name|index
index|]
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|environ
index|[
operator|++
name|index
index|]
operator|=
name|NULL
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
endif|sun
end_endif

end_unit


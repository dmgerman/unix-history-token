begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) Stichting Mathematisch Centrum, Amsterdam, 1985. */
end_comment

begin_comment
comment|/*   $Header: b1mem.c,v 1.4 85/08/27 10:55:51 timo Exp $ */
end_comment

begin_comment
comment|/* B memory management */
end_comment

begin_include
include|#
directive|include
file|"b.h"
end_include

begin_include
include|#
directive|include
file|"b1obj.h"
end_include

begin_include
include|#
directive|include
file|"b1mem.h"
end_include

begin_include
include|#
directive|include
file|"b3err.h"
end_include

begin_comment
comment|/* For still_ok */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|IBMPC
end_ifdef

begin_define
define|#
directive|define
name|RESERVE
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|RESERVE
end_ifdef

begin_decl_stmt
name|Forward
name|char
modifier|*
name|mymalloc
argument_list|()
decl_stmt|,
modifier|*
name|myrealloc
argument_list|()
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|mymalloc
value|malloc
end_define

begin_define
define|#
directive|define
name|myrealloc
value|realloc
end_define

begin_define
define|#
directive|define
name|initreserve
parameter_list|()
value|0
end_define

begin_comment
comment|/* Dummy routine */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|ebug
end_ifdef

begin_decl_stmt
name|Hidden
name|value
name|notel
decl_stmt|,
name|inotel
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Visible
name|bool
name|noting
init|=
name|Yes
decl_stmt|;
end_decl_stmt

begin_function
name|Hidden
name|Procedure
name|note
parameter_list|(
name|p
parameter_list|)
name|int
name|p
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|noting
condition|)
block|{
name|value
name|ip
decl_stmt|;
name|noting
operator|=
name|Yes
expr_stmt|;
name|insert
argument_list|(
name|ip
operator|=
name|mk_integer
argument_list|(
name|p
argument_list|)
argument_list|,
operator|&
name|notel
argument_list|)
expr_stmt|;
name|release
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|noting
operator|=
name|No
expr_stmt|;
block|}
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|denote
parameter_list|(
name|p
parameter_list|)
name|int
name|p
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|noting
condition|)
block|{
name|value
name|ip
decl_stmt|;
name|noting
operator|=
name|Yes
expr_stmt|;
if|if
condition|(
name|in
argument_list|(
name|ip
operator|=
name|mk_integer
argument_list|(
name|p
argument_list|)
argument_list|,
name|notel
argument_list|)
condition|)
block|{
name|remove
argument_list|(
name|ip
argument_list|,
operator|&
name|notel
argument_list|)
expr_stmt|;
if|if
condition|(
name|inotel
operator|!=
name|Vnil
operator|&&
name|in
argument_list|(
name|ip
argument_list|,
name|inotel
argument_list|)
condition|)
name|remove
argument_list|(
name|ip
argument_list|,
operator|&
name|inotel
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|IBMPC
else|else
name|syserr
argument_list|(
name|MESS
argument_list|(
literal|600
argument_list|,
literal|"releasing illegally"
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|release
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|noting
operator|=
name|No
expr_stmt|;
block|}
block|}
end_function

begin_function
name|Visible
name|Procedure
name|initmem
parameter_list|()
block|{
name|notel
operator|=
name|mk_elt
argument_list|()
expr_stmt|;
name|noting
operator|=
name|No
expr_stmt|;
name|initreserve
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|end_init
parameter_list|()
block|{
name|noting
operator|=
name|Yes
expr_stmt|;
name|inotel
operator|=
name|copy
argument_list|(
name|notel
argument_list|)
expr_stmt|;
name|noting
operator|=
name|No
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|term_mem
parameter_list|()
block|{
name|int
name|l
decl_stmt|,
name|i
decl_stmt|;
name|value
name|v
decl_stmt|;
name|testing
operator|=
name|noting
operator|=
name|Yes
expr_stmt|;
name|l
operator|=
name|length
argument_list|(
name|notel
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|>
name|length
argument_list|(
name|inotel
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Unreleased:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|l
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|=
name|thof
argument_list|(
name|i
argument_list|,
name|notel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in
argument_list|(
name|v
argument_list|,
name|inotel
argument_list|)
condition|)
block|{
name|wri
argument_list|(
operator|(
name|value
operator|)
name|intval
argument_list|(
name|v
argument_list|)
argument_list|,
name|No
argument_list|,
name|No
argument_list|,
name|No
argument_list|)
expr_stmt|;
name|newline
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|Visible
name|Procedure
name|endmem
parameter_list|()
block|{
name|release
argument_list|(
name|inotel
argument_list|)
expr_stmt|;
name|inotel
operator|=
name|Vnil
expr_stmt|;
name|release
argument_list|(
name|notel
argument_list|)
expr_stmt|;
name|notel
operator|=
name|Vnil
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
else|!ebug
end_else

begin_define
define|#
directive|define
name|note
parameter_list|(
name|p
parameter_list|)
end_define

begin_define
define|#
directive|define
name|denote
parameter_list|(
name|p
parameter_list|)
end_define

begin_function
name|Visible
name|Procedure
name|initmem
parameter_list|()
block|{
name|initreserve
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|end_init
parameter_list|()
block|{}
end_function

begin_function
name|Visible
name|Procedure
name|term_mem
parameter_list|()
block|{}
end_function

begin_function
name|Visible
name|Procedure
name|endmem
parameter_list|()
block|{}
end_function

begin_endif
endif|#
directive|endif
endif|ebug
end_endif

begin_define
define|#
directive|define
name|Negative
value|MESS(601, "creating value of exceedingly large size")
end_define

begin_function
name|Visible
name|ptr
name|getmem
parameter_list|(
name|syze
parameter_list|)
name|unsigned
name|syze
decl_stmt|;
block|{
name|ptr
name|p
decl_stmt|;
if|if
condition|(
call|(
name|int
call|)
argument_list|(
name|syze
argument_list|)
operator|<
literal|0
condition|)
name|error
argument_list|(
name|Negative
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|ptr
operator|)
name|mymalloc
argument_list|(
name|syze
argument_list|)
expr_stmt|;
name|note
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|bugs
operator|||
name|p
operator|==
name|Nil
condition|)
name|printf
argument_list|(
literal|"{%u}"
argument_list|,
name|syze
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|Nil
condition|)
name|memexh
argument_list|()
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|regetmem
parameter_list|(
name|v
parameter_list|,
name|syze
parameter_list|)
name|ptr
modifier|*
name|v
decl_stmt|;
name|unsigned
name|syze
decl_stmt|;
block|{
if|if
condition|(
call|(
name|int
call|)
argument_list|(
name|syze
argument_list|)
operator|<
literal|0
condition|)
name|error
argument_list|(
name|Negative
argument_list|)
expr_stmt|;
if|if
condition|(
name|bugs
condition|)
name|printf
argument_list|(
literal|"[%u]"
argument_list|,
name|syze
argument_list|)
expr_stmt|;
name|denote
argument_list|(
operator|*
name|v
argument_list|)
expr_stmt|;
operator|*
name|v
operator|=
name|myrealloc
argument_list|(
operator|*
name|v
argument_list|,
name|syze
argument_list|)
expr_stmt|;
name|note
argument_list|(
operator|*
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|v
operator|==
name|Nil
condition|)
name|memexh
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|freemem
parameter_list|(
name|p
parameter_list|)
name|ptr
name|p
decl_stmt|;
block|{
name|denote
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|RESERVE
end_ifdef

begin_define
define|#
directive|define
name|RES_SIZE
value|3000
end_define

begin_decl_stmt
name|Hidden
name|char
modifier|*
name|p_reserve
init|=
name|Nil
decl_stmt|;
end_decl_stmt

begin_function
name|Hidden
name|Procedure
name|initreserve
parameter_list|()
block|{
name|p_reserve
operator|=
name|malloc
argument_list|(
name|RES_SIZE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Hidden
name|char
modifier|*
name|mymalloc
parameter_list|(
name|syze
parameter_list|)
name|unsigned
name|syze
decl_stmt|;
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|malloc
argument_list|(
name|syze
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|Nil
operator|&&
name|p_reserve
operator|!=
name|Nil
condition|)
return|return
name|p
return|;
if|if
condition|(
name|p_reserve
operator|!=
name|Nil
condition|)
block|{
name|free
argument_list|(
name|p_reserve
argument_list|)
expr_stmt|;
name|p_reserve
operator|=
name|Nil
expr_stmt|;
name|p
operator|=
name|malloc
argument_list|(
name|syze
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|Nil
condition|)
name|error
argument_list|(
name|MESS
argument_list|(
literal|602
argument_list|,
literal|"out of memory"
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_reserve
operator|==
name|Nil
condition|)
name|initreserve
argument_list|()
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_function
name|Hidden
name|char
modifier|*
name|myrealloc
parameter_list|(
name|p1
parameter_list|,
name|syze
parameter_list|)
name|char
modifier|*
name|p1
decl_stmt|;
name|unsigned
name|syze
decl_stmt|;
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|realloc
argument_list|(
name|p1
argument_list|,
name|syze
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|Nil
operator|&&
name|p_reserve
operator|!=
name|Nil
condition|)
return|return
name|p
return|;
if|if
condition|(
name|p_reserve
operator|!=
name|Nil
condition|)
block|{
name|free
argument_list|(
name|p_reserve
argument_list|)
expr_stmt|;
name|p_reserve
operator|=
name|Nil
expr_stmt|;
name|p
operator|=
name|realloc
argument_list|(
name|p1
argument_list|,
name|syze
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|Nil
condition|)
name|error
argument_list|(
name|MESS
argument_list|(
literal|602
argument_list|,
literal|"out of memory"
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_reserve
operator|==
name|Nil
condition|)
name|initreserve
argument_list|()
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
endif|RESERVE
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) Stichting Mathematisch Centrum, Amsterdam, 1985. */
end_comment

begin_comment
comment|/*   $Header: b2tcU.c,v 1.4 85/08/22 16:57:11 timo Exp $ */
end_comment

begin_comment
comment|/* unification of polytypes */
end_comment

begin_include
include|#
directive|include
file|"b.h"
end_include

begin_include
include|#
directive|include
file|"b1obj.h"
end_include

begin_include
include|#
directive|include
file|"b2tcP.h"
end_include

begin_include
include|#
directive|include
file|"b2tcU.h"
end_include

begin_include
include|#
directive|include
file|"b2tcE.h"
end_include

begin_decl_stmt
name|Hidden
name|bool
name|bad
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Hidden
name|bool
name|cycling
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Hidden
name|bool
name|badcycle
decl_stmt|;
end_decl_stmt

begin_function
name|Visible
name|Procedure
name|unify
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|pu
parameter_list|)
name|polytype
name|a
decl_stmt|,
name|b
decl_stmt|,
decl|*
name|pu
decl_stmt|;
end_function

begin_block
block|{
name|bad
operator|=
name|No
expr_stmt|;
name|cycling
operator|=
name|No
expr_stmt|;
name|setreprtable
argument_list|()
expr_stmt|;
name|u_unify
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|pu
argument_list|)
expr_stmt|;
if|if
condition|(
name|bad
condition|)
name|badtyperr
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|delreprtable
argument_list|()
expr_stmt|;
block|}
end_block

begin_function
name|Hidden
name|Procedure
name|u_unify
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|pu
parameter_list|)
name|polytype
name|a
decl_stmt|,
name|b
decl_stmt|,
decl|*
name|pu
decl_stmt|;
end_function

begin_block
block|{
name|typekind
name|a_kind
decl_stmt|,
name|b_kind
decl_stmt|;
name|polytype
name|res
decl_stmt|;
name|a_kind
operator|=
name|kind
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|b_kind
operator|=
name|kind
argument_list|(
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|are_same_types
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
condition|)
block|{
operator|*
name|pu
operator|=
name|p_copy
argument_list|(
name|a
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|t_is_var
argument_list|(
name|a_kind
argument_list|)
operator|||
name|t_is_var
argument_list|(
name|b_kind
argument_list|)
condition|)
block|{
name|substitute_for
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|pu
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|have_same_structure
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
condition|)
block|{
name|unify_subtypes
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|pu
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|has_number
argument_list|(
name|a_kind
argument_list|)
operator|&&
name|has_number
argument_list|(
name|b_kind
argument_list|)
condition|)
block|{
operator|*
name|pu
operator|=
name|mkt_number
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|has_text
argument_list|(
name|a_kind
argument_list|)
operator|&&
name|has_text
argument_list|(
name|b_kind
argument_list|)
condition|)
block|{
operator|*
name|pu
operator|=
name|mkt_text
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|has_text
argument_list|(
name|a_kind
argument_list|)
operator|&&
name|t_is_tlt
argument_list|(
name|b_kind
argument_list|)
condition|)
block|{
name|u_unify
argument_list|(
name|asctype
argument_list|(
name|b
argument_list|)
argument_list|,
operator|(
name|res
operator|=
name|mkt_text
argument_list|()
operator|)
argument_list|,
name|pu
argument_list|)
expr_stmt|;
name|p_release
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|has_text
argument_list|(
name|b_kind
argument_list|)
operator|&&
name|t_is_tlt
argument_list|(
name|a_kind
argument_list|)
condition|)
block|{
name|u_unify
argument_list|(
name|asctype
argument_list|(
name|a
argument_list|)
argument_list|,
operator|(
name|res
operator|=
name|mkt_text
argument_list|()
operator|)
argument_list|,
name|pu
argument_list|)
expr_stmt|;
name|p_release
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|t_is_list
argument_list|(
name|a_kind
argument_list|)
operator|&&
name|has_lt
argument_list|(
name|b_kind
argument_list|)
operator|)
operator|||
operator|(
name|t_is_list
argument_list|(
name|b_kind
argument_list|)
operator|&&
name|has_lt
argument_list|(
name|a_kind
argument_list|)
operator|)
condition|)
block|{
name|u_unify
argument_list|(
name|asctype
argument_list|(
name|a
argument_list|)
argument_list|,
name|asctype
argument_list|(
name|b
argument_list|)
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
operator|*
name|pu
operator|=
name|mkt_list
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|t_is_table
argument_list|(
name|a_kind
argument_list|)
operator|&&
name|has_lt
argument_list|(
name|b_kind
argument_list|)
condition|)
block|{
name|u_unify
argument_list|(
name|asctype
argument_list|(
name|a
argument_list|)
argument_list|,
name|asctype
argument_list|(
name|b
argument_list|)
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
operator|*
name|pu
operator|=
name|mkt_table
argument_list|(
name|p_copy
argument_list|(
name|keytype
argument_list|(
name|a
argument_list|)
argument_list|)
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|t_is_table
argument_list|(
name|b_kind
argument_list|)
operator|&&
name|has_lt
argument_list|(
name|a_kind
argument_list|)
condition|)
block|{
name|u_unify
argument_list|(
name|asctype
argument_list|(
name|a
argument_list|)
argument_list|,
name|asctype
argument_list|(
name|b
argument_list|)
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
operator|*
name|pu
operator|=
name|mkt_table
argument_list|(
name|p_copy
argument_list|(
name|keytype
argument_list|(
name|b
argument_list|)
argument_list|)
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|t_is_tlt
argument_list|(
name|a_kind
argument_list|)
operator|&&
name|t_is_lt
argument_list|(
name|b_kind
argument_list|)
operator|)
operator|||
operator|(
name|t_is_lt
argument_list|(
name|a_kind
argument_list|)
operator|&&
name|t_is_tlt
argument_list|(
name|b_kind
argument_list|)
operator|)
condition|)
block|{
name|u_unify
argument_list|(
name|asctype
argument_list|(
name|a
argument_list|)
argument_list|,
name|asctype
argument_list|(
name|b
argument_list|)
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
operator|*
name|pu
operator|=
name|mkt_lt
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|t_is_error
argument_list|(
name|a_kind
argument_list|)
operator|||
name|t_is_error
argument_list|(
name|b_kind
argument_list|)
condition|)
block|{
operator|*
name|pu
operator|=
name|mkt_error
argument_list|()
expr_stmt|;
block|}
else|else
block|{
operator|*
name|pu
operator|=
name|mkt_error
argument_list|()
expr_stmt|;
if|if
condition|(
name|cycling
condition|)
name|badcycle
operator|=
name|Yes
expr_stmt|;
else|else
name|bad
operator|=
name|Yes
expr_stmt|;
block|}
block|}
end_block

begin_function
name|Hidden
name|Procedure
name|unify_subtypes
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|pu
parameter_list|)
name|polytype
name|a
decl_stmt|,
name|b
decl_stmt|,
decl|*
name|pu
decl_stmt|;
end_function

begin_block
block|{
name|polytype
name|sa
decl_stmt|,
name|sb
decl_stmt|,
name|s
decl_stmt|;
name|intlet
name|nsub
decl_stmt|,
name|is
decl_stmt|;
name|nsub
operator|=
name|nsubtypes
argument_list|(
name|a
argument_list|)
expr_stmt|;
operator|*
name|pu
operator|=
name|mkt_polytype
argument_list|(
name|kind
argument_list|(
name|a
argument_list|)
argument_list|,
name|nsub
argument_list|)
expr_stmt|;
for|for
control|(
name|is
operator|=
literal|0
init|;
name|is
operator|<
name|nsub
condition|;
name|is
operator|++
control|)
block|{
name|sa
operator|=
name|subtype
argument_list|(
name|a
argument_list|,
name|is
argument_list|)
expr_stmt|;
name|sb
operator|=
name|subtype
argument_list|(
name|b
argument_list|,
name|is
argument_list|)
expr_stmt|;
name|u_unify
argument_list|(
name|sa
argument_list|,
name|sb
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|putsubtype
argument_list|(
name|s
argument_list|,
operator|*
name|pu
argument_list|,
name|is
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function_decl
name|Forward
name|bool
name|contains
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|Forward
name|bool
name|equal_vars
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|Hidden
name|Procedure
name|substitute_for
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|pu
parameter_list|)
name|polytype
name|a
decl_stmt|,
name|b
decl_stmt|,
decl|*
name|pu
decl_stmt|;
end_function

begin_block
block|{
name|typekind
name|a_kind
decl_stmt|,
name|b_kind
decl_stmt|;
name|polytype
name|ta
decl_stmt|,
name|tb
decl_stmt|;
name|bool
name|ta_is_a
decl_stmt|,
name|tb_is_b
decl_stmt|;
name|a_kind
operator|=
name|kind
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|b_kind
operator|=
name|kind
argument_list|(
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|t_is_var
argument_list|(
name|a_kind
argument_list|)
operator|&&
name|table_has_type_of
argument_list|(
name|a
argument_list|)
condition|)
block|{
name|ta
operator|=
name|type_of
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|ta_is_a
operator|=
name|No
expr_stmt|;
block|}
else|else
block|{
name|ta
operator|=
name|a
expr_stmt|;
name|ta_is_a
operator|=
name|Yes
expr_stmt|;
block|}
if|if
condition|(
name|t_is_var
argument_list|(
name|b_kind
argument_list|)
operator|&&
name|table_has_type_of
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|tb
operator|=
name|type_of
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|tb_is_b
operator|=
name|No
expr_stmt|;
block|}
else|else
block|{
name|tb
operator|=
name|b
expr_stmt|;
name|tb_is_b
operator|=
name|Yes
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|ta_is_a
operator|&&
name|tb_is_b
operator|)
condition|)
name|u_unify
argument_list|(
name|ta
argument_list|,
name|tb
argument_list|,
name|pu
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|t_is_var
argument_list|(
name|a_kind
argument_list|)
condition|)
operator|*
name|pu
operator|=
name|p_copy
argument_list|(
name|a
argument_list|)
expr_stmt|;
else|else
operator|*
name|pu
operator|=
name|p_copy
argument_list|(
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|t_is_var
argument_list|(
name|a_kind
argument_list|)
condition|)
block|{
if|if
condition|(
name|contains
argument_list|(
operator|*
name|pu
argument_list|,
name|bottom_var
argument_list|(
name|a
argument_list|)
argument_list|)
condition|)
name|textify
argument_list|(
name|a
argument_list|,
name|pu
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t_is_var
argument_list|(
name|b_kind
argument_list|)
condition|)
block|{
if|if
condition|(
name|contains
argument_list|(
operator|*
name|pu
argument_list|,
name|bottom_var
argument_list|(
name|b
argument_list|)
argument_list|)
condition|)
name|textify
argument_list|(
name|b
argument_list|,
name|pu
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t_is_var
argument_list|(
name|a_kind
argument_list|)
operator|&&
operator|!
name|are_same_types
argument_list|(
operator|*
name|pu
argument_list|,
name|a
argument_list|)
condition|)
name|repl_type_of
argument_list|(
name|a
argument_list|,
operator|*
name|pu
argument_list|)
expr_stmt|;
if|if
condition|(
name|t_is_var
argument_list|(
name|b_kind
argument_list|)
operator|&&
operator|!
name|are_same_types
argument_list|(
operator|*
name|pu
argument_list|,
name|b
argument_list|)
condition|)
name|repl_type_of
argument_list|(
name|b
argument_list|,
operator|*
name|pu
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|Hidden
name|Procedure
name|textify
parameter_list|(
name|a
parameter_list|,
name|pu
parameter_list|)
name|polytype
name|a
decl_stmt|,
decl|*
name|pu
decl_stmt|;
end_function

begin_block
block|{
name|polytype
name|ttext
decl_stmt|,
name|text_hopefully
decl_stmt|;
name|ttext
operator|=
name|mkt_text
argument_list|()
expr_stmt|;
name|cycling
operator|=
name|Yes
expr_stmt|;
name|badcycle
operator|=
name|No
expr_stmt|;
name|u_unify
argument_list|(
operator|*
name|pu
argument_list|,
name|ttext
argument_list|,
operator|&
name|text_hopefully
argument_list|)
expr_stmt|;
if|if
condition|(
name|badcycle
name|EQ
name|No
condition|)
block|{
name|p_release
argument_list|(
name|text_hopefully
argument_list|)
expr_stmt|;
name|u_unify
argument_list|(
name|a
argument_list|,
name|ttext
argument_list|,
operator|&
name|text_hopefully
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|badcycle
name|EQ
name|No
condition|)
block|{
operator|*
name|pu
operator|=
name|ttext
expr_stmt|;
block|}
else|else
block|{
operator|*
name|pu
operator|=
name|mkt_error
argument_list|()
expr_stmt|;
name|cyctyperr
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|p_release
argument_list|(
name|ttext
argument_list|)
expr_stmt|;
block|}
name|p_release
argument_list|(
name|text_hopefully
argument_list|)
expr_stmt|;
name|cycling
operator|=
name|No
expr_stmt|;
block|}
end_block

begin_function
name|Visible
name|bool
name|contains
parameter_list|(
name|u
parameter_list|,
name|a
parameter_list|)
name|polytype
name|u
decl_stmt|,
name|a
decl_stmt|;
block|{
name|bool
name|result
decl_stmt|;
name|result
operator|=
name|No
expr_stmt|;
if|if
condition|(
name|t_is_var
argument_list|(
name|kind
argument_list|(
name|u
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|table_has_type_of
argument_list|(
name|u
argument_list|)
condition|)
block|{
name|result
operator|=
name|contains
argument_list|(
name|type_of
argument_list|(
name|u
argument_list|)
argument_list|,
name|a
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|polytype
name|s
decl_stmt|;
name|intlet
name|is
decl_stmt|,
name|nsub
decl_stmt|;
name|nsub
operator|=
name|nsubtypes
argument_list|(
name|u
argument_list|)
expr_stmt|;
for|for
control|(
name|is
operator|=
literal|0
init|;
name|is
operator|<
name|nsub
condition|;
name|is
operator|++
control|)
block|{
name|s
operator|=
name|subtype
argument_list|(
name|u
argument_list|,
name|is
argument_list|)
expr_stmt|;
if|if
condition|(
name|equal_vars
argument_list|(
name|s
argument_list|,
name|a
argument_list|)
operator|||
name|contains
argument_list|(
name|s
argument_list|,
name|a
argument_list|)
condition|)
block|{
name|result
operator|=
name|Yes
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|Visible
name|bool
name|equal_vars
parameter_list|(
name|s
parameter_list|,
name|a
parameter_list|)
name|polytype
name|s
decl_stmt|,
name|a
decl_stmt|;
block|{
return|return
operator|(
name|are_same_types
argument_list|(
name|bottom_var
argument_list|(
name|s
argument_list|)
argument_list|,
name|a
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


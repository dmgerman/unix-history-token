begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Lexical analysis routines.  */
end_comment

begin_include
include|#
directive|include
file|"ilink.h"
end_include

begin_include
include|#
directive|include
file|"opcode.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|nlflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* newline last seen */
end_comment

begin_comment
comment|/*  * getop - get an opcode from infile, return the opcode number (via  *  binary search of opcode table), and point id at the name of the opcode.  */
end_comment

begin_macro
name|getop
argument_list|(
argument|id
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|id
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
specifier|register
name|struct
name|opentry
modifier|*
name|p
decl_stmt|;
specifier|register
name|int
name|test
decl_stmt|;
name|int
name|low
decl_stmt|,
name|high
decl_stmt|,
name|cmp
decl_stmt|;
specifier|extern
name|char
modifier|*
name|getstr
parameter_list|()
function_decl|;
name|s
operator|=
name|getstr
argument_list|()
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return
operator|(
name|EOF
operator|)
return|;
name|low
operator|=
literal|0
expr_stmt|;
name|high
operator|=
name|NOPCODES
expr_stmt|;
do|do
block|{
name|test
operator|=
operator|(
name|low
operator|+
name|high
operator|)
operator|/
literal|2
expr_stmt|;
name|p
operator|=
operator|&
name|optable
index|[
name|test
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|cmp
operator|=
name|strcmp
argument_list|(
name|p
operator|->
name|op_name
argument_list|,
name|s
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|low
operator|=
name|test
operator|+
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|cmp
operator|>
literal|0
condition|)
name|high
operator|=
name|test
expr_stmt|;
else|else
block|{
operator|*
name|id
operator|=
name|p
operator|->
name|op_name
expr_stmt|;
return|return
operator|(
name|p
operator|->
name|op_code
operator|)
return|;
block|}
block|}
do|while
condition|(
name|low
operator|<
name|high
condition|)
do|;
operator|*
name|id
operator|=
name|s
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * getid - get an identifier from infile, put it in the identifier  *  table, and return a pointer to it.  */
end_comment

begin_function
name|char
modifier|*
name|getid
parameter_list|()
block|{
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
specifier|extern
name|char
modifier|*
name|getstr
parameter_list|()
function_decl|;
specifier|extern
name|char
modifier|*
name|putident
parameter_list|()
function_decl|;
name|s
operator|=
name|getstr
argument_list|()
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|putident
argument_list|(
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * getstr - get an identifier from infile and return a pointer to it.  */
end_comment

begin_function
name|char
modifier|*
name|getstr
parameter_list|()
block|{
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|sfree
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
operator|)
operator|==
literal|' '
operator|||
name|c
operator|==
literal|'\t'
condition|)
empty_stmt|;
if|if
condition|(
name|c
operator|==
name|EOF
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
while|while
condition|(
name|c
operator|!=
literal|' '
operator|&&
name|c
operator|!=
literal|'\t'
operator|&&
name|c
operator|!=
literal|'\n'
operator|&&
name|c
operator|!=
literal|','
operator|&&
name|c
operator|!=
name|EOF
condition|)
block|{
operator|*
name|p
operator|++
operator|=
name|c
expr_stmt|;
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
expr_stmt|;
block|}
operator|*
name|p
operator|=
literal|0
expr_stmt|;
name|nlflag
operator|=
operator|(
name|c
operator|==
literal|'\n'
operator|)
expr_stmt|;
return|return
operator|(
name|sfree
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * getdec - get a decimal integer from infile, and return it.  */
end_comment

begin_macro
name|getdec
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|n
decl_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
operator|)
operator|==
literal|' '
operator|||
name|c
operator|==
literal|'\t'
condition|)
empty_stmt|;
if|if
condition|(
name|c
operator|==
name|EOF
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
name|n
operator|=
name|n
operator|*
literal|10
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
expr_stmt|;
block|}
name|nlflag
operator|=
operator|(
name|c
operator|==
literal|'\n'
operator|)
expr_stmt|;
return|return
operator|(
name|n
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * getoct - get an octal number from infile, and return it.  */
end_comment

begin_macro
name|getoct
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|n
decl_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
operator|)
operator|==
literal|' '
operator|||
name|c
operator|==
literal|'\t'
condition|)
empty_stmt|;
if|if
condition|(
name|c
operator|==
name|EOF
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'7'
condition|)
block|{
name|n
operator|=
operator|(
name|n
operator|<<
literal|3
operator|)
operator||
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
expr_stmt|;
block|}
name|nlflag
operator|=
operator|(
name|c
operator|==
literal|'\n'
operator|)
expr_stmt|;
return|return
operator|(
name|n
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * getint - get an Icon integer from infile, and return it.  */
end_comment

begin_function
name|long
name|getint
parameter_list|()
block|{
specifier|register
name|c
expr_stmt|;
specifier|register
name|int
name|r
decl_stmt|;
name|long
name|int
name|n
decl_stmt|;
name|n
operator|=
literal|0L
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
operator|)
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
name|n
operator|=
name|n
operator|*
literal|10
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'r'
operator|||
name|c
operator|==
literal|'R'
condition|)
block|{
name|r
operator|=
name|n
expr_stmt|;
name|n
operator|=
literal|0L
expr_stmt|;
while|while
condition|(
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
condition|)
block|{
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
name|c
operator|-=
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
condition|)
name|c
operator|-=
literal|'a'
operator|-
literal|10
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|>=
literal|'A'
operator|&&
name|c
operator|<=
literal|'Z'
condition|)
name|c
operator|-=
literal|'A'
operator|-
literal|10
expr_stmt|;
else|else
break|break;
name|n
operator|=
name|n
operator|*
name|r
operator|+
name|c
expr_stmt|;
block|}
block|}
name|nlflag
operator|=
operator|(
name|c
operator|==
literal|'\n'
operator|)
expr_stmt|;
return|return
operator|(
name|n
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * getreal - get an Icon real number from infile, and return it.  */
end_comment

begin_function
name|double
name|getreal
parameter_list|()
block|{
name|double
name|n
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|,
name|d
decl_stmt|,
name|e
decl_stmt|;
name|int
name|esign
decl_stmt|;
specifier|static
name|double
name|tens
index|[]
init|=
block|{
literal|1.0e0
block|,
literal|1.0e1
block|,
literal|1.0e2
block|,
literal|1.0e3
block|,
literal|1.0e4
block|,
literal|1.0e5
block|,
literal|1.0e6
block|,
literal|1.0e7
block|,
literal|1.0e8
block|,
literal|1.0e9
block|,
literal|1.0e10
block|,
literal|1.0e11
block|,
literal|1.0e12
block|,
literal|1.0e13
block|,
literal|1.0e14
block|,
literal|1.0e15
block|,
literal|1.0e16
block|,
literal|1.0e17
block|,
literal|1.0e18
block|,
literal|1.0e19
block|,
literal|1.0e20
block|,
literal|1.0e21
block|,
literal|1.0e22
block|,
literal|1.0e23
block|,
literal|1.0e24
block|,
literal|1.0e25
block|,
literal|1.0e26
block|,
literal|1.0e27
block|,
literal|1.0e28
block|,
literal|1.0e29
block|,
literal|1.0e30
block|,
literal|1.0e31
block|,
literal|1.0e32
block|,
literal|1.0e33
block|,
literal|1.0e34
block|,
literal|1.0e35
block|,
literal|1.0e36
block|,
literal|1.0e37
block|,
literal|1.0e38
block|}
decl_stmt|;
specifier|static
name|double
name|ntens
index|[]
init|=
block|{
literal|1.0e0
block|,
literal|1.0e-1
block|,
literal|1.0e-2
block|,
literal|1.0e-3
block|,
literal|1.0e-4
block|,
literal|1.0e-5
block|,
literal|1.0e-6
block|,
literal|1.0e-7
block|,
literal|1.0e-8
block|,
literal|1.0e-9
block|,
literal|1.0e-10
block|,
literal|1.0e-11
block|,
literal|1.0e-12
block|,
literal|1.0e-13
block|,
literal|1.0e-14
block|,
literal|1.0e-15
block|,
literal|1.0e-16
block|,
literal|1.0e-17
block|,
literal|1.0e-18
block|,
literal|1.0e-19
block|,
literal|1.0e-20
block|,
literal|1.0e-21
block|,
literal|1.0e-22
block|,
literal|1.0e-23
block|,
literal|1.0e-24
block|,
literal|1.0e-25
block|,
literal|1.0e-26
block|,
literal|1.0e-27
block|,
literal|1.0e-28
block|,
literal|1.0e-29
block|,
literal|1.0e-30
block|,
literal|1.0e-31
block|,
literal|1.0e-32
block|,
literal|1.0e-33
block|,
literal|1.0e-34
block|,
literal|1.0e-35
block|,
literal|1.0e-36
block|,
literal|1.0e-37
block|,
literal|1.0e-38
block|}
decl_stmt|;
name|n
operator|=
literal|0.0
expr_stmt|;
name|d
operator|=
name|e
operator|=
literal|0
expr_stmt|;
name|esign
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
operator|)
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
name|n
operator|=
name|n
operator|*
literal|10
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'.'
condition|)
block|{
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
operator|)
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
name|n
operator|=
name|n
operator|*
literal|10
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
name|d
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|c
operator|==
literal|'e'
operator|||
name|c
operator|==
literal|'E'
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
operator|)
operator|==
literal|'+'
operator|||
name|c
operator|==
literal|'-'
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'-'
condition|)
name|esign
operator|=
operator|-
literal|1
expr_stmt|;
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
name|e
operator|=
name|e
operator|*
literal|10
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|esign
operator|<
literal|0
condition|)
name|e
operator|=
operator|-
name|e
expr_stmt|;
name|e
operator|=
name|e
operator|-
name|d
expr_stmt|;
if|if
condition|(
name|e
operator|>=
operator|-
literal|38
operator|&&
name|e
operator|<
literal|0
condition|)
name|n
operator|=
name|n
operator|*
name|ntens
index|[
operator|-
name|e
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|e
operator|>
literal|0
operator|&&
name|e
operator|<=
literal|38
condition|)
name|n
operator|=
name|n
operator|*
name|tens
index|[
name|e
index|]
expr_stmt|;
name|nlflag
operator|=
operator|(
name|c
operator|==
literal|'\n'
operator|)
expr_stmt|;
return|return
operator|(
name|n
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * getlab - get a label ("L" followed by a number) from infile,  *  and return the number.  */
end_comment

begin_macro
name|getlab
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
operator|)
operator|!=
literal|'L'
operator|&&
name|c
operator|!=
name|EOF
operator|&&
name|c
operator|!=
literal|'\n'
condition|)
empty_stmt|;
if|if
condition|(
name|c
operator|==
literal|'L'
condition|)
return|return
operator|(
name|getdec
argument_list|()
operator|)
return|;
name|nlflag
operator|=
operator|(
name|c
operator|==
literal|'\n'
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * getstrlit - get a string literal from infile, as a string  *  of octal bytes, and return it.  */
end_comment

begin_function
name|char
modifier|*
name|getstrlit
parameter_list|(
name|l
parameter_list|)
specifier|register
name|int
name|l
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|extern
name|char
modifier|*
name|putident
parameter_list|()
function_decl|;
name|p
operator|=
name|sfree
expr_stmt|;
while|while
condition|(
operator|!
name|nlflag
operator|&&
name|l
operator|--
condition|)
operator|*
name|p
operator|++
operator|=
name|getoct
argument_list|()
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|putident
argument_list|(
name|p
operator|-
name|sfree
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * newline - skip to next line.  */
end_comment

begin_macro
name|newline
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
if|if
condition|(
operator|!
name|nlflag
condition|)
block|{
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|infile
argument_list|)
operator|)
operator|!=
literal|'\n'
operator|&&
name|c
operator|!=
name|EOF
condition|)
empty_stmt|;
block|}
name|nlflag
operator|=
literal|0
expr_stmt|;
block|}
end_block

end_unit


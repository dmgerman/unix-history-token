begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* mts.c - definitions for the mail transport system */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_undef
undef|#
directive|undef
name|NETWORK
end_undef

begin_if
if|#
directive|if
name|defined
argument_list|(
name|BSD41A
argument_list|)
operator|||
name|defined
argument_list|(
name|BSD42
argument_list|)
end_if

begin_define
define|#
directive|define
name|NETWORK
end_define

begin_endif
endif|#
directive|endif
endif|not (defined(BSD41A) || defined(BSD42))
end_endif

begin_include
include|#
directive|include
file|"../h/strings.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"mts.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|NETWORK
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|BSD42
end_ifdef

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_endif
endif|#
directive|endif
endif|BSD42
end_endif

begin_else
else|#
directive|else
else|not NETWORK
end_else

begin_ifndef
ifndef|#
directive|ifndef
name|SYS5
end_ifndef

begin_include
include|#
directive|include
file|<whoami.h>
end_include

begin_else
else|#
directive|else
else|SYS5
end_else

begin_include
include|#
directive|include
file|<sys/utsname.h>
end_include

begin_endif
endif|#
directive|endif
endif|SYS5
end_endif

begin_endif
endif|#
directive|endif
endif|not NETWORK
end_endif

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_define
define|#
directive|define
name|NOTOK
value|(-1)
end_define

begin_define
define|#
directive|define
name|OK
value|0
end_define

begin_define
define|#
directive|define
name|NULLCP
value|((char *) 0)
end_define

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_function_decl
name|char
modifier|*
name|tailor_value
parameter_list|()
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|SYS5
end_ifdef

begin_define
define|#
directive|define
name|index
value|strchr
end_define

begin_define
define|#
directive|define
name|rindex
value|strrchr
end_define

begin_endif
endif|#
directive|endif
endif|SYS5
end_endif

begin_decl_stmt
name|char
modifier|*
name|index
argument_list|()
decl_stmt|,
modifier|*
name|malloc
argument_list|()
decl_stmt|,
modifier|*
name|mktemp
argument_list|()
decl_stmt|,
modifier|*
name|rindex
argument_list|()
decl_stmt|,
modifier|*
name|strcpy
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|struct
name|passwd
modifier|*
name|getpwuid
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/*    *mmdfldir and *uucpldir are the maildrop directories.  If maildrops    are kept in the user's home directory, then these should be empty    strings.  In this case, the appropriate ...lfil array should contain    the name of the file in the user's home directory.  Usually, this is    something like ".mail".  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|mtstailor
init|=
literal|"/usr/new/lib/mh/mtstailor"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|localname
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|systemname
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|MF
end_ifdef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|UUCPchan
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|MF
end_endif

begin_decl_stmt
name|char
modifier|*
name|mmdfldir
init|=
literal|"/usr/spool/mail"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|mmdflfil
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|uucpldir
init|=
literal|"/usr/spool/mail"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|uucplfil
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|mmdlm1
init|=
literal|"\001\001\001\001\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|mmdlm2
init|=
literal|"\001\001\001\001\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|MMailids
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|mmailid
init|=
literal|"0"
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|MF
end_ifdef

begin_decl_stmt
name|char
modifier|*
name|umincproc
init|=
literal|"/usr/new/lib/mh/uminc"
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
else|MF
end_else

begin_decl_stmt
name|char
modifier|*
name|umincproc
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|MF
end_endif

begin_decl_stmt
name|int
name|lockstyle
init|=
name|LOK_UNIX
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|lkstyle
init|=
literal|"0"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|lockldir
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* MTS specific variables */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|MHMTS
end_ifdef

begin_decl_stmt
name|char
modifier|*
name|Mailqdir
init|=
literal|"/usr/spool/netmail"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|TMailqdir
init|=
literal|"/usr/tmp"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Syscpy
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|syscpy
init|=
literal|"1"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Overseer
init|=
literal|"root"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Mailer
init|=
literal|"root"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Fromtmp
init|=
literal|"/tmp/rml.f.XXXXXX"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Msgtmp
init|=
literal|"/tmp/rml.m.XXXXXX"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Errtmp
init|=
literal|"/tmp/rml.e.XXXXXX"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Tmpmode
init|=
literal|0600
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|tmpmode
init|=
literal|"0600"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Okhosts
init|=
literal|"/usr/new/lib/mh/Rmail.OkHosts"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Okdests
init|=
literal|"/usr/new/lib/mh/Rmail.OkDests"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|MHMTS
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|MMDFMTS
end_ifdef

begin_endif
endif|#
directive|endif
endif|MMDFMTS
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SENDMTS
end_ifdef

begin_decl_stmt
name|char
modifier|*
name|hostable
init|=
literal|"/usr/new/lib/mh/hosts"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|sendmail
init|=
literal|"/usr/lib/sendmail"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|SENDMTS
end_endif

begin_comment
comment|/* SMTP/POP stuff */
end_comment

begin_decl_stmt
name|char
modifier|*
name|servers
init|=
literal|"localhost \01localnet"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|pophost
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* BBoards-specific variables */
end_comment

begin_decl_stmt
name|char
modifier|*
name|bb_domain
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* POP BBoards-specific variables */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|BPOP
end_ifdef

begin_decl_stmt
name|char
modifier|*
name|popbbhost
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|popbbuser
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|popbblist
init|=
literal|"/usr/new/lib/mh/hosts.popbb"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|BPOP
end_endif

begin_comment
comment|/* MailDelivery */
end_comment

begin_decl_stmt
name|char
modifier|*
name|maildelivery
init|=
literal|"/usr/new/lib/mh/maildelivery"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Aliasing Facility (doesn't belong here) */
end_comment

begin_decl_stmt
name|int
name|Everyone
init|=
name|NOTOK
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|everyone
init|=
literal|"-1"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|NoShell
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* customize the MTS settings for MH by reading /usr/new/lib/mh/mtstailor */
end_comment

begin_struct
specifier|static
struct|struct
name|bind
block|{
name|char
modifier|*
name|keyword
decl_stmt|;
name|char
modifier|*
modifier|*
name|value
decl_stmt|;
block|}
name|binds
index|[]
init|=
block|{
literal|"localname"
block|,
operator|&
name|localname
block|,
literal|"systemname"
block|,
operator|&
name|systemname
block|,
ifdef|#
directive|ifdef
name|MF
literal|"uucpchan"
block|,
operator|&
name|UUCPchan
block|,
endif|#
directive|endif
endif|MF
literal|"mmdfldir"
block|,
operator|&
name|mmdfldir
block|,
literal|"mmdflfil"
block|,
operator|&
name|mmdflfil
block|,
literal|"uucpldir"
block|,
operator|&
name|uucpldir
block|,
literal|"uucplfil"
block|,
operator|&
name|uucplfil
block|,
literal|"mmdelim1"
block|,
operator|&
name|mmdlm1
block|,
literal|"mmdelim2"
block|,
operator|&
name|mmdlm2
block|,
literal|"mmailid"
block|,
operator|&
name|mmailid
block|,
literal|"umincproc"
block|,
operator|&
name|umincproc
block|,
literal|"lockstyle"
block|,
operator|&
name|lkstyle
block|,
literal|"lockldir"
block|,
operator|&
name|lockldir
block|,
ifdef|#
directive|ifdef
name|MHMTS
literal|"mailqdir"
block|,
operator|&
name|Mailqdir
block|,
literal|"tmailqdir"
block|,
operator|&
name|TMailqdir
block|,
literal|"syscpy"
block|,
operator|&
name|syscpy
block|,
literal|"overseer"
block|,
operator|&
name|Overseer
block|,
literal|"mailer"
block|,
operator|&
name|Mailer
block|,
literal|"fromtmp"
block|,
operator|&
name|Fromtmp
block|,
literal|"msgtmp"
block|,
operator|&
name|Msgtmp
block|,
literal|"errtmp"
block|,
operator|&
name|Errtmp
block|,
literal|"tmpmode"
block|,
operator|&
name|tmpmode
block|,
literal|"okhosts"
block|,
operator|&
name|Okhosts
block|,
literal|"okdests"
block|,
operator|&
name|Okdests
block|,
endif|#
directive|endif
endif|MHMTS
ifdef|#
directive|ifdef
name|MMDFMTS
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
literal|"hostable"
block|,
operator|&
name|hostable
block|,
literal|"sendmail"
block|,
operator|&
name|sendmail
block|,
endif|#
directive|endif
endif|SENDMTS
literal|"servers"
block|,
operator|&
name|servers
block|,
literal|"pophost"
block|,
operator|&
name|pophost
block|,
literal|"bbdomain"
block|,
operator|&
name|bb_domain
block|,
ifdef|#
directive|ifdef
name|BPOP
literal|"popbbhost"
block|,
operator|&
name|popbbhost
block|,
literal|"popbbuser"
block|,
operator|&
name|popbbuser
block|,
literal|"popbblist"
block|,
operator|&
name|popbblist
block|,
endif|#
directive|endif
endif|BPOP
literal|"maildelivery"
block|,
operator|&
name|maildelivery
block|,
literal|"everyone"
block|,
operator|&
name|everyone
block|,
literal|"noshell"
block|,
operator|&
name|NoShell
block|,
name|NULL
block|}
struct|;
end_struct

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* I'd like to use m_getfld() here, but not all programs loading mts.o may be    MH-style programs... */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_macro
name|mts_init
argument_list|(
argument|name
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|bp
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|struct
name|bind
modifier|*
name|b
decl_stmt|;
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
specifier|static
name|int
name|inited
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|inited
operator|++
operator|||
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|mtstailor
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|fp
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|index
argument_list|(
name|buffer
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
break|break;
operator|*
name|cp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|*
name|buffer
operator|==
literal|'#'
operator|||
operator|*
name|buffer
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
operator|(
name|bp
operator|=
name|index
argument_list|(
name|buffer
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
break|break;
operator|*
name|bp
operator|++
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|bp
argument_list|)
condition|)
operator|*
name|bp
operator|++
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|b
operator|=
name|binds
init|;
name|b
operator|->
name|keyword
condition|;
name|b
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|buffer
argument_list|,
name|b
operator|->
name|keyword
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|b
operator|->
name|keyword
operator|&&
operator|(
name|cp
operator|=
name|tailor_value
argument_list|(
name|bp
argument_list|)
operator|)
condition|)
operator|*
name|b
operator|->
name|value
operator|=
name|cp
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|MMailids
operator|=
name|atoi
argument_list|(
name|mmailid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|lockstyle
operator|=
name|atoi
argument_list|(
name|lkstyle
argument_list|)
operator|)
operator|<
name|LOK_UNIX
operator|||
name|lockstyle
operator|>
name|LOK_MMDF
condition|)
name|lockstyle
operator|=
name|LOK_UNIX
expr_stmt|;
ifdef|#
directive|ifdef
name|MHMTS
name|Syscpy
operator|=
name|atoi
argument_list|(
name|syscpy
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sscanf
argument_list|(
name|tmpmode
argument_list|,
literal|"0%o"
argument_list|,
operator|&
name|Tmpmode
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
name|Everyone
operator|=
name|atoi
argument_list|(
name|everyone
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|QUOTE
value|'\\'
end_define

begin_define
define|#
directive|define
name|grot
parameter_list|(
name|x
parameter_list|)
value|case 'x': *bp = '\x'; break
end_define

begin_function
specifier|static
name|char
modifier|*
name|tailor_value
parameter_list|(
name|s
parameter_list|)
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|r
decl_stmt|;
specifier|register
name|char
modifier|*
name|bp
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
for|for
control|(
name|bp
operator|=
name|buffer
init|;
operator|*
name|s
condition|;
name|bp
operator|++
operator|,
name|s
operator|++
control|)
if|if
condition|(
operator|*
name|s
operator|!=
name|QUOTE
condition|)
operator|*
name|bp
operator|=
operator|*
name|s
expr_stmt|;
else|else
switch|switch
condition|(
operator|*
operator|++
name|s
condition|)
block|{
name|grot
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|grot
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|grot
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|grot
argument_list|(
name|t
argument_list|)
expr_stmt|;
case|case
name|NULL
case|:
name|s
operator|--
expr_stmt|;
case|case
name|QUOTE
case|:
operator|*
name|bp
operator|=
name|QUOTE
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|)
block|{
operator|*
name|bp
operator|++
operator|=
name|QUOTE
expr_stmt|;
operator|*
name|bp
operator|=
operator|*
name|s
expr_stmt|;
block|}
name|r
operator|=
operator|*
name|s
operator|!=
literal|'0'
condition|?
literal|10
else|:
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|isdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|;
name|s
operator|++
control|)
name|i
operator|=
name|i
operator|*
name|r
operator|+
operator|*
name|s
operator|-
literal|'0'
expr_stmt|;
name|s
operator|--
expr_stmt|;
operator|*
name|bp
operator|=
name|toascii
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
operator|*
name|bp
operator|=
name|NULL
expr_stmt|;
name|bp
operator|=
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|bp
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
return|return
name|bp
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|char
modifier|*
name|LocalName
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|BSD41A
name|char
modifier|*
name|myname
decl_stmt|;
endif|#
directive|endif
endif|BSD41A
ifdef|#
directive|ifdef
name|BSD42
specifier|register
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
endif|#
directive|endif
endif|BSD42
ifdef|#
directive|ifdef
name|SYS5
name|struct
name|utsname
name|name
decl_stmt|;
endif|#
directive|endif
endif|SYS5
specifier|static
name|char
name|buffer
index|[
name|BUFSIZ
index|]
init|=
literal|""
decl_stmt|;
if|if
condition|(
name|buffer
index|[
literal|0
index|]
condition|)
return|return
name|buffer
return|;
name|mts_init
argument_list|(
literal|"mts"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|localname
condition|)
return|return
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|localname
argument_list|)
return|;
ifdef|#
directive|ifdef
name|locname
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|locname
argument_list|)
expr_stmt|;
else|#
directive|else
else|not locname
ifdef|#
directive|ifdef
name|NETWORK
ifdef|#
directive|ifdef
name|BSD41A
name|myname
operator|=
literal|"myname"
expr_stmt|;
if|if
condition|(
name|rhost
argument_list|(
operator|&
name|myname
argument_list|)
operator|==
operator|-
literal|1
condition|)
operator|(
name|void
operator|)
name|gethostname
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|)
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|myname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|myname
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|BSD41A
ifdef|#
directive|ifdef
name|BSD42
operator|(
name|void
operator|)
name|gethostname
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|)
expr_stmt|;
name|sethostent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|=
name|gethostbyname
argument_list|(
name|buffer
argument_list|)
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD42
else|#
directive|else
else|not NETWORK
ifndef|#
directive|ifndef
name|SYS5
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|SystemName
argument_list|()
argument_list|)
expr_stmt|;
else|#
directive|else
else|SYS5
operator|(
name|void
operator|)
name|uname
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|name
operator|.
name|nodename
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SYS5
endif|#
directive|endif
endif|not NETWORK
endif|#
directive|endif
endif|not locname
return|return
name|buffer
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|char
modifier|*
name|SystemName
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|SYS5
name|struct
name|utsname
name|name
decl_stmt|;
endif|#
directive|endif
endif|SYS5
specifier|static
name|char
name|buffer
index|[
name|BUFSIZ
index|]
init|=
literal|""
decl_stmt|;
if|if
condition|(
name|buffer
index|[
literal|0
index|]
condition|)
return|return
name|buffer
return|;
name|mts_init
argument_list|(
literal|"mts"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|systemname
condition|)
return|return
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|systemname
argument_list|)
return|;
ifdef|#
directive|ifdef
name|sysname
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|sysname
argument_list|)
expr_stmt|;
else|#
directive|else
else|sysname
ifndef|#
directive|ifndef
name|SYS5
operator|(
name|void
operator|)
name|gethostname
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|)
expr_stmt|;
else|#
directive|else
else|SYS5
operator|(
name|void
operator|)
name|uname
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|name
operator|.
name|nodename
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SYS5
endif|#
directive|endif
endif|sysname
return|return
name|buffer
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|char
modifier|*
name|UucpChan
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|MF
specifier|static
name|char
name|buffer
index|[
name|BUFSIZ
index|]
init|=
literal|""
decl_stmt|;
endif|#
directive|endif
endif|MF
ifndef|#
directive|ifndef
name|MF
return|return
name|NULL
return|;
else|#
directive|else
else|MF
if|if
condition|(
name|buffer
index|[
literal|0
index|]
condition|)
return|return
name|buffer
return|;
name|mts_init
argument_list|(
literal|"mts"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|UUCPchan
condition|)
return|return
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|UUCPchan
argument_list|)
return|;
ifdef|#
directive|ifdef
name|uucpchan
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|uucpchan
argument_list|)
expr_stmt|;
else|#
directive|else
else|uucpchan
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
literal|"uucp"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|uucpchan
return|return
name|buffer
return|;
endif|#
directive|endif
endif|MF
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|ALTOS
end_ifdef

begin_expr_stmt
name|gethostname
argument_list|(
name|name
argument_list|,
name|len
argument_list|)
specifier|register
name|char
operator|*
name|name
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
if|if
condition|(
name|fp
operator|=
name|fopen
argument_list|(
literal|"/etc/systemid"
argument_list|,
literal|"r"
argument_list|)
condition|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|name
argument_list|,
name|len
argument_list|,
name|fp
argument_list|)
condition|)
block|{
if|if
condition|(
name|cp
operator|=
name|index
argument_list|(
name|name
argument_list|,
literal|'\n'
argument_list|)
condition|)
operator|*
name|cp
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|name
argument_list|,
literal|"altos"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|ALTOS
end_endif

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
specifier|static
name|char
name|username
index|[
name|BUFSIZ
index|]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|fullname
index|[
name|BUFSIZ
index|]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_function
name|char
modifier|*
name|getusr
parameter_list|()
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|np
decl_stmt|;
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
if|if
condition|(
name|username
index|[
literal|0
index|]
condition|)
return|return
name|username
return|;
if|if
condition|(
operator|(
name|pw
operator|=
name|getpwuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|pw
operator|->
name|pw_name
operator|==
name|NULL
operator|||
operator|*
name|pw
operator|->
name|pw_name
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|username
argument_list|,
literal|"intruder"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|fullname
argument_list|,
literal|"The Unknown User-ID (%d)"
argument_list|,
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|username
return|;
block|}
if|if
condition|(
name|MMailids
condition|)
block|{
name|np
operator|=
name|pw
operator|->
name|pw_gecos
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|fullname
init|;
operator|*
name|np
operator|&&
operator|*
name|np
operator|!=
literal|'<'
condition|;
operator|*
name|cp
operator|++
operator|=
operator|*
name|np
operator|++
control|)
continue|continue;
operator|*
name|cp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|*
name|np
condition|)
name|np
operator|++
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|username
init|;
operator|*
name|np
operator|&&
operator|*
name|np
operator|!=
literal|'>'
condition|;
operator|*
name|cp
operator|++
operator|=
operator|*
name|np
operator|++
control|)
continue|continue;
operator|*
name|cp
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|MMailids
operator|==
literal|0
operator|||
operator|*
name|np
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|username
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
name|fullname
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cp
operator|=
name|getenv
argument_list|(
literal|"SIGNATURE"
argument_list|)
operator|)
operator|&&
operator|*
name|cp
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|fullname
argument_list|,
name|cp
argument_list|)
expr_stmt|;
return|return
name|username
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|getfullname
parameter_list|()
block|{
if|if
condition|(
name|username
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
operator|(
name|void
operator|)
name|getusr
argument_list|()
expr_stmt|;
return|return
name|fullname
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SYS5
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|notdef
end_ifndef

begin_comment
comment|/* Supposedly this works, I prefer the 				   recursive solution... */
end_comment

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_function
name|int
name|dup2
parameter_list|(
name|d1
parameter_list|,
name|d2
parameter_list|)
specifier|register
name|int
name|d1
decl_stmt|,
name|d2
decl_stmt|;
block|{
name|int
name|d
decl_stmt|;
if|if
condition|(
name|d1
operator|==
name|d2
condition|)
return|return
name|OK
return|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|d2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|fcntl
argument_list|(
name|d1
argument_list|,
name|F_DUPFD
argument_list|,
name|d2
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|d
operator|==
name|d2
condition|)
return|return
name|OK
return|;
name|errno
operator|=
literal|0
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
end_function

begin_else
else|#
directive|else
else|notdef
end_else

begin_function
name|int
name|dup2
parameter_list|(
name|d1
parameter_list|,
name|d2
parameter_list|)
specifier|register
name|int
name|d1
decl_stmt|,
name|d2
decl_stmt|;
block|{
if|if
condition|(
name|d1
operator|==
name|d2
condition|)
return|return
name|OK
return|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|d2
argument_list|)
expr_stmt|;
return|return
name|dup2aux
argument_list|(
name|d1
argument_list|,
name|d2
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dup2aux
parameter_list|(
name|d1
parameter_list|,
name|d2
parameter_list|)
specifier|register
name|int
name|d1
decl_stmt|,
name|d2
decl_stmt|;
block|{
name|int
name|d
decl_stmt|,
name|i
decl_stmt|,
name|eindex
decl_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|dup
argument_list|(
name|d1
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|d
operator|==
name|d2
condition|)
return|return
name|OK
return|;
name|i
operator|=
name|dup2aux
argument_list|(
name|d1
argument_list|,
name|d2
argument_list|)
expr_stmt|;
name|eindex
operator|=
name|errno
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|errno
operator|=
name|eindex
expr_stmt|;
return|return
name|i
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
endif|notdef
end_endif

begin_endif
endif|#
directive|endif
endif|SYS5
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* post.c - enter messages into the transport system */
end_comment

begin_include
include|#
directive|include
file|"../h/mh.h"
end_include

begin_include
include|#
directive|include
file|"../h/addrsbr.h"
end_include

begin_include
include|#
directive|include
file|"../h/aliasbr.h"
end_include

begin_include
include|#
directive|include
file|"../h/dropsbr.h"
end_include

begin_include
include|#
directive|include
file|"../zotnet/tws.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|MMDFMTS
end_ifndef

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_else
else|#
directive|else
else|MMDFMTS
end_else

begin_include
include|#
directive|include
file|"../mts/mmdf/util.h"
end_include

begin_include
include|#
directive|include
file|"../mts/mmdf/mmdf.h"
end_include

begin_endif
endif|#
directive|endif
endif|MMDFMTS
end_endif

begin_include
include|#
directive|include
file|"../zotnet/mts.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|MHMTS
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|V7
end_ifndef

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_endif
endif|#
directive|endif
endif|not V7
end_endif

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_endif
endif|#
directive|endif
endif|MHMTS
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SENDMTS
end_ifdef

begin_include
include|#
directive|include
file|"../mts/sendmail/smail.h"
end_include

begin_undef
undef|#
directive|undef
name|MF
end_undef

begin_endif
endif|#
directive|endif
endif|SENDMTS
end_endif

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|MMDFMTS
end_ifndef

begin_define
define|#
directive|define
name|uptolow
parameter_list|(
name|c
parameter_list|)
value|(isupper (c) ? tolower (c) : (c))
end_define

begin_endif
endif|#
directive|endif
endif|not MMDFMTS
end_endif

begin_define
define|#
directive|define
name|FCCS
value|10
end_define

begin_comment
comment|/* max number of fccs allowed */
end_comment

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
specifier|static
name|struct
name|swit
name|switches
index|[]
init|=
block|{
define|#
directive|define
name|ALIASW
value|0
literal|"alias aliasfile"
block|,
literal|0
block|,
define|#
directive|define
name|CHKSW
value|1
literal|"check"
block|,
operator|-
literal|5
block|,
comment|/* interface from whom */
define|#
directive|define
name|NCHKSW
value|2
literal|"nocheck"
block|,
operator|-
literal|7
block|,
comment|/* interface from whom */
define|#
directive|define
name|DEBUGSW
value|3
literal|"debug"
block|,
operator|-
literal|5
block|,
define|#
directive|define
name|DISTSW
value|4
literal|"dist"
block|,
operator|-
literal|4
block|,
comment|/* interface from dist */
define|#
directive|define
name|ENCRSW
value|5
literal|"encrypt"
block|,
ifndef|#
directive|ifndef
name|TMA
operator|-
literal|7
block|,
else|#
directive|else
else|TMA
literal|0
block|,
endif|#
directive|endif
endif|TMA
define|#
directive|define
name|NENCRSW
value|6
literal|"noencrypt"
block|,
ifndef|#
directive|ifndef
name|TMA
operator|-
literal|9
block|,
else|#
directive|else
else|TMA
literal|0
block|,
endif|#
directive|endif
endif|TMA
define|#
directive|define
name|FILTSW
value|7
literal|"filter filterfile"
block|,
literal|0
block|,
define|#
directive|define
name|NFILTSW
value|8
literal|"nofilter"
block|,
literal|0
block|,
define|#
directive|define
name|FRMTSW
value|9
literal|"format"
block|,
literal|0
block|,
define|#
directive|define
name|NFRMTSW
value|10
literal|"noformat"
block|,
literal|0
block|,
define|#
directive|define
name|LIBSW
value|11
comment|/* interface from send, whom */
literal|"library directory"
block|,
operator|-
literal|7
block|,
define|#
directive|define
name|MSGDSW
value|12
literal|"msgid"
block|,
literal|0
block|,
define|#
directive|define
name|NMSGDSW
value|13
literal|"nomsgid"
block|,
literal|0
block|,
define|#
directive|define
name|VERBSW
value|14
literal|"verbose"
block|,
literal|0
block|,
define|#
directive|define
name|NVERBSW
value|15
literal|"noverbose"
block|,
literal|0
block|,
define|#
directive|define
name|WATCSW
value|16
literal|"watch"
block|,
literal|0
block|,
define|#
directive|define
name|NWATCSW
value|17
literal|"nowatch"
block|,
literal|0
block|,
define|#
directive|define
name|WHOMSW
value|18
comment|/* interface from whom */
literal|"whom"
block|,
operator|-
literal|4
block|,
define|#
directive|define
name|WIDTHSW
value|19
literal|"width columns"
block|,
literal|0
block|,
define|#
directive|define
name|HELPSW
value|20
literal|"help"
block|,
literal|4
block|,
define|#
directive|define
name|MAILSW
value|21
literal|"mail"
block|,
operator|-
literal|4
block|,
define|#
directive|define
name|SAMLSW
value|22
literal|"saml"
block|,
operator|-
literal|4
block|,
define|#
directive|define
name|SENDSW
value|23
literal|"send"
block|,
operator|-
literal|4
block|,
define|#
directive|define
name|SOMLSW
value|24
literal|"soml"
block|,
operator|-
literal|4
block|,
define|#
directive|define
name|ANNOSW
value|25
comment|/* interface from send */
literal|"idanno number"
block|,
operator|-
literal|6
block|,
define|#
directive|define
name|DLVRSW
value|26
literal|"deliver address-list"
block|,
operator|-
literal|7
block|,
define|#
directive|define
name|CLIESW
value|27
literal|"client host"
block|,
operator|-
literal|6
block|,
define|#
directive|define
name|SERVSW
value|28
literal|"server host"
block|,
operator|-
literal|6
block|,
define|#
directive|define
name|SNOOPSW
value|29
literal|"snoop"
block|,
operator|-
literal|5
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_struct
struct|struct
name|headers
block|{
name|char
modifier|*
name|value
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
define|#
directive|define
name|HNOP
value|0x0000
comment|/* just used to keep .set around */
define|#
directive|define
name|HBAD
value|0x0001
comment|/* bad header - don't let it through */
define|#
directive|define
name|HADR
value|0x0002
comment|/* header has an address field */
define|#
directive|define
name|HSUB
value|0x0004
comment|/* Subject: header */
define|#
directive|define
name|HTRY
value|0x0008
comment|/* try to send to addrs on header */
define|#
directive|define
name|HBCC
value|0x0010
comment|/* don't output this header */
define|#
directive|define
name|HMNG
value|0x0020
comment|/* munge this header */
define|#
directive|define
name|HNGR
value|0x0040
comment|/* no groups allowed in this header */
define|#
directive|define
name|HFCC
value|0x0080
comment|/* FCC: type header */
define|#
directive|define
name|HNIL
value|0x0100
comment|/* okay for this header not to have addrs */
define|#
directive|define
name|HIGN
value|0x0200
comment|/* ignore this header */
name|unsigned
name|int
name|set
decl_stmt|;
define|#
directive|define
name|MFRM
value|0x0001
comment|/* we've seen a From: */
define|#
directive|define
name|MDAT
value|0x0002
comment|/* we've seen a Date: */
define|#
directive|define
name|MRFM
value|0x0004
comment|/* we've seen a Resent-From: */
define|#
directive|define
name|MVIS
value|0x0008
comment|/* we've seen sighted addrs */
define|#
directive|define
name|MINV
value|0x0010
comment|/* we've seen blind addrs */
block|}
struct|;
end_struct

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
specifier|static
name|struct
name|headers
name|NHeaders
index|[]
init|=
block|{
literal|"Return-Path"
block|,
name|HBAD
block|,
name|NULL
block|,
literal|"Received"
block|,
name|HBAD
block|,
name|NULL
block|,
literal|"Reply-To"
block|,
name|HADR
operator||
name|HNGR
block|,
name|NULL
block|,
literal|"From"
block|,
name|HADR
operator||
name|HNGR
block|,
name|MFRM
block|,
literal|"Sender"
block|,
name|HADR
operator||
name|HBAD
block|,
name|NULL
block|,
literal|"Date"
block|,
name|HBAD
block|,
name|NULL
block|,
literal|"Subject"
block|,
name|HSUB
block|,
name|NULL
block|,
literal|"To"
block|,
name|HADR
operator||
name|HTRY
block|,
name|MVIS
block|,
literal|"cc"
block|,
name|HADR
operator||
name|HTRY
block|,
name|MVIS
block|,
literal|"Bcc"
block|,
name|HADR
operator||
name|HTRY
operator||
name|HBCC
operator||
name|HNIL
block|,
name|MINV
block|,
literal|"Message-ID"
block|,
name|HBAD
block|,
name|NULL
block|,
literal|"Fcc"
block|,
name|HFCC
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|headers
name|RHeaders
index|[]
init|=
block|{
literal|"Resent-Reply-To"
block|,
name|HADR
operator||
name|HNGR
block|,
name|NULL
block|,
literal|"Resent-From"
block|,
name|HADR
operator||
name|HNGR
block|,
name|MRFM
block|,
literal|"Resent-Sender"
block|,
name|HADR
operator||
name|HBAD
block|,
name|NULL
block|,
literal|"Resent-Date"
block|,
name|HBAD
block|,
name|NULL
block|,
literal|"Resent-Subject"
block|,
name|HSUB
block|,
name|NULL
block|,
literal|"Resent-To"
block|,
name|HADR
operator||
name|HTRY
block|,
name|MVIS
block|,
literal|"Resent-cc"
block|,
name|HADR
operator||
name|HTRY
block|,
name|MVIS
block|,
literal|"Resent-Bcc"
block|,
name|HADR
operator||
name|HTRY
operator||
name|HBCC
block|,
name|MINV
block|,
literal|"Resent-Message-ID"
block|,
name|HBAD
block|,
name|NULL
block|,
literal|"Resent-Fcc"
block|,
name|HFCC
block|,
name|NULL
block|,
literal|"Reply-To"
block|,
name|HADR
block|,
name|NULL
block|,
literal|"From"
block|,
name|HADR
operator||
name|HNGR
block|,
name|MFRM
block|,
ifdef|#
directive|ifdef
name|MMDFI
literal|"Sender"
block|,
name|HADR
operator||
name|HMNG
operator||
name|HNGR
block|,
name|NULL
block|,
else|#
directive|else
else|not MMFDI
literal|"Sender"
block|,
name|HADR
operator||
name|HNGR
block|,
name|NULL
block|,
endif|#
directive|endif
endif|not MMDFI
literal|"Date"
block|,
name|HNOP
block|,
name|MDAT
block|,
literal|"To"
block|,
name|HADR
operator||
name|HNIL
block|,
name|NULL
block|,
literal|"cc"
block|,
name|HADR
operator||
name|HNIL
block|,
name|NULL
block|,
literal|"Bcc"
block|,
name|HADR
operator||
name|HTRY
operator||
name|HBCC
operator||
name|HNIL
block|,
name|NULL
block|,
literal|"Fcc"
block|,
name|HIGN
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
specifier|static
name|short
name|fccind
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* index into fccfold[] */
end_comment

begin_decl_stmt
specifier|static
name|short
name|outputlinelen
init|=
name|OUTPUTLINELEN
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pfd
init|=
name|NOTOK
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* fd to write annotation list to */
end_comment

begin_decl_stmt
specifier|static
name|int
name|myuid
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* my user id */
end_comment

begin_decl_stmt
specifier|static
name|int
name|mygid
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* my group id */
end_comment

begin_decl_stmt
specifier|static
name|int
name|recipients
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* how many people will get a copy */
end_comment

begin_decl_stmt
specifier|static
name|int
name|unkadr
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* how many of those were unknown */
end_comment

begin_decl_stmt
specifier|static
name|int
name|badadr
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of bad addrs */
end_comment

begin_decl_stmt
specifier|static
name|int
name|badmsg
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* message has bad semantics */
end_comment

begin_decl_stmt
specifier|static
name|int
name|verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* spell it out */
end_comment

begin_decl_stmt
specifier|static
name|int
name|format
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* format addresses */
end_comment

begin_decl_stmt
specifier|static
name|int
name|msgid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* add msgid */
end_comment

begin_decl_stmt
specifier|static
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* debugging post */
end_comment

begin_decl_stmt
specifier|static
name|int
name|watch
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* watch the delivery process */
end_comment

begin_decl_stmt
specifier|static
name|int
name|whomsw
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* we are whom not post */
end_comment

begin_decl_stmt
specifier|static
name|int
name|checksw
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* whom -check */
end_comment

begin_decl_stmt
specifier|static
name|int
name|linepos
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* putadr()'s position on the line */
end_comment

begin_decl_stmt
specifier|static
name|int
name|nameoutput
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* putadr() has output header name */
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|msgflags
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* what we've seen */
end_comment

begin_define
define|#
directive|define
name|NORMAL
value|0
end_define

begin_define
define|#
directive|define
name|RESENT
value|1
end_define

begin_decl_stmt
specifier|static
name|int
name|msgstate
init|=
name|NORMAL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|clock
init|=
literal|0L
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the time we started (more or less) */
end_comment

begin_decl_stmt
specifier|static
name|int
argument_list|(
operator|*
name|hstat
argument_list|)
argument_list|()
decl_stmt|,
argument_list|(
operator|*
name|istat
argument_list|)
argument_list|()
decl_stmt|,
argument_list|(
operator|*
name|qstat
argument_list|)
argument_list|()
decl_stmt|,
argument_list|(
operator|*
name|tstat
argument_list|)
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|tmpfil
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|bccfil
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|from
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* my network address */
end_comment

begin_decl_stmt
specifier|static
name|char
name|signature
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* my signature */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|filter
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the filter for BCC'ing */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|subject
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the subject field for BCC'ing */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|fccfold
index|[
name|FCCS
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* foldernames for FCC'ing */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|headers
modifier|*
name|hdrtab
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* table for the message we're doing */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|mailname
name|localaddrs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* local addrs */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|mailname
name|netaddrs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* network addrs */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|mailname
name|uuaddrs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* uucp addrs */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|mailname
name|tmpaddrs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* temporary queue */
end_comment

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|MMDFMTS
end_ifdef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|submitmode
init|=
literal|"m"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* deliver to mailbox only */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|RP_DOK
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|submitopts
index|[
literal|6
index|]
init|=
literal|"vl"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* initial options for submit */
end_comment

begin_else
else|#
directive|else
else|RP_DOK
end_else

begin_decl_stmt
specifier|static
name|char
name|submitopts
index|[
literal|7
index|]
init|=
literal|"vlk"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* initial options for submit */
end_comment

begin_endif
endif|#
directive|endif
endif|RP_DOK
end_endif

begin_endif
endif|#
directive|endif
endif|MMDFMTS
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|MHMTS
end_ifdef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|deliver
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|sigser
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
endif|MHMTS
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SENDMTS
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|smtpmode
init|=
name|S_MAIL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|snoop
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|clientsw
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|serversw
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|smtp
name|sm_reply
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|SENDMTS
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TMA
end_ifdef

begin_define
define|#
directive|define
name|post
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
define|\
value|if (encryptsw) postcipher ((a), (b), (c)); else postplain ((a), (b), (c))
end_define

begin_endif
endif|#
directive|endif
endif|TMA
end_endif

begin_decl_stmt
specifier|static
name|int
name|encryptsw
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* encrypt it */
end_comment

begin_function_decl
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|MAIN */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|state
decl_stmt|,
name|compnum
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|msg
init|=
name|NULL
decl_stmt|,
modifier|*
modifier|*
name|argp
init|=
name|argv
operator|+
literal|1
decl_stmt|,
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|name
index|[
name|NAMESZ
index|]
decl_stmt|;
name|FILE
modifier|*
name|in
decl_stmt|,
modifier|*
name|out
decl_stmt|;
name|invo_name
operator|=
name|r1bindex
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
name|m_foil
argument_list|(
name|NULLCP
argument_list|)
expr_stmt|;
name|mts_init
argument_list|(
name|invo_name
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
ifdef|#
directive|ifdef
name|MMDFII
name|mmdf_init
argument_list|(
name|invo_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFII
endif|#
directive|endif
endif|MMDFMTS
comment|/*
comment|*/
while|while
condition|(
name|cp
operator|=
operator|*
name|argp
operator|++
condition|)
block|{
if|if
condition|(
operator|*
name|cp
operator|==
literal|'-'
condition|)
switch|switch
condition|(
name|smatch
argument_list|(
operator|++
name|cp
argument_list|,
name|switches
argument_list|)
condition|)
block|{
case|case
name|AMBIGSW
case|:
name|ambigsw
argument_list|(
name|cp
argument_list|,
name|switches
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
case|case
name|UNKWNSW
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"-%s unknown"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
case|case
name|HELPSW
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s [switches] file"
argument_list|,
name|invo_name
argument_list|)
expr_stmt|;
name|help
argument_list|(
name|buf
argument_list|,
name|switches
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
case|case
name|LIBSW
case|:
if|if
condition|(
operator|!
operator|(
name|cp
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|cp
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
name|m_foil
argument_list|(
name|cp
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|ALIASW
case|:
if|if
condition|(
operator|!
operator|(
name|cp
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|cp
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MHMTS
if|if
condition|(
name|access
argument_list|(
name|libpath
argument_list|(
name|cp
argument_list|)
argument_list|,
literal|04
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|cp
argument_list|,
literal|"unable to read"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
if|if
condition|(
operator|(
name|state
operator|=
name|alias
argument_list|(
name|cp
argument_list|)
operator|)
operator|!=
name|AK_OK
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"aliasing error in %s - %s"
argument_list|,
name|cp
argument_list|,
name|akerror
argument_list|(
name|state
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|CHKSW
case|:
name|checksw
operator|++
expr_stmt|;
continue|continue;
case|case
name|NCHKSW
case|:
name|checksw
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|DEBUGSW
case|:
name|debug
operator|++
expr_stmt|;
continue|continue;
case|case
name|DISTSW
case|:
name|msgstate
operator|=
name|RESENT
expr_stmt|;
continue|continue;
case|case
name|FILTSW
case|:
if|if
condition|(
operator|!
operator|(
name|filter
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|filter
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|NFILTSW
case|:
name|filter
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|FRMTSW
case|:
name|format
operator|++
expr_stmt|;
continue|continue;
case|case
name|NFRMTSW
case|:
name|format
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|MSGDSW
case|:
name|msgid
operator|++
expr_stmt|;
continue|continue;
case|case
name|NMSGDSW
case|:
name|msgid
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|VERBSW
case|:
name|verbose
operator|++
expr_stmt|;
continue|continue;
case|case
name|NVERBSW
case|:
name|verbose
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|WATCSW
case|:
name|watch
operator|++
expr_stmt|;
continue|continue;
case|case
name|NWATCSW
case|:
name|watch
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|WHOMSW
case|:
name|whomsw
operator|++
expr_stmt|;
continue|continue;
case|case
name|WIDTHSW
case|:
if|if
condition|(
operator|!
operator|(
name|cp
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|cp
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|outputlinelen
operator|=
name|atoi
argument_list|(
name|cp
argument_list|)
operator|)
operator|<
literal|10
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"impossible width %d"
argument_list|,
name|outputlinelen
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|ENCRSW
case|:
name|encryptsw
operator|++
expr_stmt|;
continue|continue;
case|case
name|NENCRSW
case|:
name|encryptsw
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|ANNOSW
case|:
if|if
condition|(
operator|!
operator|(
name|cp
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|cp
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pfd
operator|=
name|atoi
argument_list|(
name|cp
argument_list|)
operator|)
operator|<=
literal|2
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"bad argument %s %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|,
name|cp
argument_list|)
expr_stmt|;
continue|continue;
ifdef|#
directive|ifdef
name|MMDFMTS
case|case
name|MAILSW
case|:
name|submitmode
operator|=
literal|"m"
expr_stmt|;
continue|continue;
case|case
name|SOMLSW
case|:
comment|/* for right now, sigh... */
case|case
name|SAMLSW
case|:
name|submitmode
operator|=
literal|"b"
expr_stmt|;
continue|continue;
case|case
name|SENDSW
case|:
name|submitmode
operator|=
literal|"y"
expr_stmt|;
continue|continue;
endif|#
directive|endif
endif|MMDFMTS
ifndef|#
directive|ifndef
name|MHMTS
case|case
name|DLVRSW
case|:
if|if
condition|(
operator|!
operator|(
name|cp
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|cp
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
continue|continue;
else|#
directive|else
else|MHMTS
case|case
name|MAILSW
case|:
case|case
name|SAMLSW
case|:
case|case
name|SOMLSW
case|:
case|case
name|SENDSW
case|:
continue|continue;
case|case
name|DLVRSW
case|:
if|if
condition|(
operator|!
operator|(
name|deliver
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|deliver
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
continue|continue;
endif|#
directive|endif
endif|MHMTS
ifndef|#
directive|ifndef
name|SENDMTS
case|case
name|CLIESW
case|:
case|case
name|SERVSW
case|:
if|if
condition|(
operator|!
operator|(
name|cp
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|cp
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|SNOOPSW
case|:
continue|continue;
else|#
directive|else
else|SENDMTS
case|case
name|MAILSW
case|:
name|smtpmode
operator|=
name|S_MAIL
expr_stmt|;
continue|continue;
case|case
name|SAMLSW
case|:
name|smtpmode
operator|=
name|S_SAML
expr_stmt|;
continue|continue;
case|case
name|SOMLSW
case|:
name|smtpmode
operator|=
name|S_SOML
expr_stmt|;
continue|continue;
case|case
name|SENDSW
case|:
name|smtpmode
operator|=
name|S_SEND
expr_stmt|;
continue|continue;
case|case
name|CLIESW
case|:
if|if
condition|(
operator|!
operator|(
name|clientsw
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|clientsw
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|SERVSW
case|:
if|if
condition|(
operator|!
operator|(
name|serversw
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|serversw
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|SNOOPSW
case|:
name|snoop
operator|++
expr_stmt|;
continue|continue;
endif|#
directive|endif
endif|SENDMTS
block|}
if|if
condition|(
name|msg
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"only one message at a time!"
argument_list|)
expr_stmt|;
else|else
name|msg
operator|=
name|cp
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|alias
argument_list|(
name|AliasFile
argument_list|)
expr_stmt|;
comment|/*
comment|*/
if|if
condition|(
operator|!
name|msg
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"usage: %s [switches] file"
argument_list|,
name|invo_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|outputlinelen
operator|<
literal|10
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"impossible width %d"
argument_list|,
name|outputlinelen
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MHMTS
if|if
condition|(
name|access
argument_list|(
name|msg
argument_list|,
literal|04
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|msg
argument_list|,
literal|"unable to read"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
if|if
condition|(
operator|(
name|in
operator|=
name|fopen
argument_list|(
name|msg
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|msg
argument_list|,
literal|"unable to open"
argument_list|)
expr_stmt|;
name|start_headers
argument_list|()
expr_stmt|;
if|if
condition|(
name|debug
condition|)
block|{
name|verbose
operator|++
expr_stmt|;
name|out
operator|=
name|stdout
expr_stmt|;
ifdef|#
directive|ifdef
name|MHMTS
if|if
condition|(
name|deliver
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|putfmt
argument_list|(
literal|"To"
argument_list|,
name|deliver
argument_list|,
name|out
argument_list|)
expr_stmt|;
goto|goto
name|daemon
goto|;
block|}
endif|#
directive|endif
endif|MHMTS
block|}
elseif|else
ifdef|#
directive|ifdef
name|MHMTS
if|if
condition|(
name|deliver
condition|)
block|{
if|if
condition|(
operator|(
name|out
operator|=
name|fopen
argument_list|(
literal|"/dev/null"
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
literal|"/dev/null"
argument_list|,
literal|"unable to write"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|putfmt
argument_list|(
literal|"To"
argument_list|,
name|deliver
argument_list|,
name|out
argument_list|)
expr_stmt|;
goto|goto
name|daemon
goto|;
block|}
elseif|else
endif|#
directive|endif
endif|MHMTS
if|if
condition|(
name|whomsw
condition|)
block|{
if|if
condition|(
operator|(
name|out
operator|=
name|fopen
argument_list|(
literal|"/dev/null"
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
literal|"/dev/null"
argument_list|,
literal|"unable to open"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
name|m_tmpfil
argument_list|(
name|invo_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|out
operator|=
name|fopen
argument_list|(
name|tmpfil
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|tmpfil
argument_list|,
literal|"unable to create"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MHMTS
operator|(
name|void
operator|)
name|chown
argument_list|(
name|tmpfil
argument_list|,
name|myuid
argument_list|,
name|mygid
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
operator|(
name|void
operator|)
name|chmod
argument_list|(
name|tmpfil
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
block|}
comment|/*
comment|*/
name|hdrtab
operator|=
name|msgstate
operator|==
name|NORMAL
condition|?
name|NHeaders
else|:
name|RHeaders
expr_stmt|;
for|for
control|(
name|compnum
operator|=
literal|1
operator|,
name|state
operator|=
name|FLD
init|;
condition|;
control|)
block|{
switch|switch
condition|(
name|state
operator|=
name|m_getfld
argument_list|(
name|state
argument_list|,
name|name
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|in
argument_list|)
condition|)
block|{
case|case
name|FLD
case|:
case|case
name|FLDEOF
case|:
case|case
name|FLDPLUS
case|:
name|compnum
operator|++
expr_stmt|;
name|cp
operator|=
name|add
argument_list|(
name|buf
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
while|while
condition|(
name|state
operator|==
name|FLDPLUS
condition|)
block|{
name|state
operator|=
name|m_getfld
argument_list|(
name|state
argument_list|,
name|name
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|cp
operator|=
name|add
argument_list|(
name|buf
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
name|putfmt
argument_list|(
name|name
argument_list|,
name|cp
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|!=
name|FLDEOF
condition|)
continue|continue;
name|finish_headers
argument_list|(
name|out
argument_list|)
expr_stmt|;
break|break;
case|case
name|BODY
case|:
case|case
name|BODYEOF
case|:
name|finish_headers
argument_list|(
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|whomsw
condition|)
break|break;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
while|while
condition|(
name|state
operator|==
name|BODY
condition|)
block|{
name|state
operator|=
name|m_getfld
argument_list|(
name|state
argument_list|,
name|name
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|buf
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|FILEEOF
case|:
name|finish_headers
argument_list|(
name|out
argument_list|)
expr_stmt|;
break|break;
case|case
name|LENERR
case|:
case|case
name|FMTERR
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"message format error in component #%d"
argument_list|,
name|compnum
argument_list|)
expr_stmt|;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"getfld() returned %d"
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
comment|/*
comment|*/
ifdef|#
directive|ifdef
name|MHMTS
name|daemon
label|:
empty_stmt|;
endif|#
directive|endif
endif|MHMTS
if|if
condition|(
name|pfd
operator|!=
name|NOTOK
condition|)
name|anno
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
block|{
name|pl
argument_list|()
expr_stmt|;
name|done
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|out
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TMA
if|if
condition|(
name|encryptsw
condition|)
name|tmastart
argument_list|()
expr_stmt|;
endif|#
directive|endif
endif|TMA
if|if
condition|(
name|whomsw
condition|)
block|{
name|verify_all_addresses
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MMDFMTS
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|submitopts
argument_list|,
name|submitmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|watch
condition|)
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|submitopts
argument_list|,
literal|"nw"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|MHMTS
name|verify_all_addresses
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
if|if
condition|(
name|encryptsw
condition|)
name|verify_all_addresses
argument_list|(
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgflags
operator|&
name|MINV
condition|)
block|{
name|make_bcc_file
argument_list|()
expr_stmt|;
if|if
condition|(
name|msgflags
operator|&
name|MVIS
condition|)
block|{
ifndef|#
directive|ifndef
name|MHMTS
if|if
condition|(
operator|!
name|encryptsw
condition|)
name|verify_all_addresses
argument_list|(
name|verbose
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|not MHMTS
name|post
argument_list|(
name|tmpfil
argument_list|,
literal|0
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
block|}
name|post
argument_list|(
name|bccfil
argument_list|,
literal|1
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|bccfil
argument_list|)
expr_stmt|;
block|}
else|else
name|post
argument_list|(
name|tmpfil
argument_list|,
literal|0
argument_list|,
name|isatty
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TMA
if|if
condition|(
name|encryptsw
condition|)
name|tmastop
argument_list|()
expr_stmt|;
endif|#
directive|endif
endif|TMA
name|refile
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MHMTS
if|if
condition|(
operator|!
name|deliver
condition|)
endif|#
directive|endif
endif|MHMTS
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Message Processed\n"
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|DRAFT GENERATION */
end_comment

begin_expr_stmt
specifier|static
name|putfmt
argument_list|(
name|name
argument_list|,
name|str
argument_list|,
name|out
argument_list|)
specifier|register
name|char
operator|*
name|name
operator|,
operator|*
name|str
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|FILE
modifier|*
name|out
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|count
decl_stmt|,
name|grp
decl_stmt|,
name|i
decl_stmt|,
name|keep
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|pp
decl_stmt|,
modifier|*
name|qp
decl_stmt|;
name|char
name|namep
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|struct
name|mailname
modifier|*
name|mp
decl_stmt|,
modifier|*
name|np
decl_stmt|;
specifier|register
name|struct
name|headers
modifier|*
name|hdr
decl_stmt|;
while|while
condition|(
operator|*
name|str
operator|==
literal|' '
operator|||
operator|*
name|str
operator|==
literal|'\t'
condition|)
name|str
operator|++
expr_stmt|;
if|if
condition|(
name|msgstate
operator|==
name|NORMAL
operator|&&
name|uprf
argument_list|(
name|name
argument_list|,
literal|"resent"
argument_list|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"illegal header line -- %s:"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|badmsg
operator|++
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|i
operator|=
name|get_header
argument_list|(
name|name
argument_list|,
name|hdrtab
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s: %s"
argument_list|,
name|name
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return;
block|}
name|hdr
operator|=
operator|&
name|hdrtab
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|flags
operator|&
name|HIGN
condition|)
return|return;
if|if
condition|(
name|hdr
operator|->
name|flags
operator|&
name|HBAD
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"illegal header line -- %s:"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|badmsg
operator|++
expr_stmt|;
return|return;
block|}
name|msgflags
operator||=
operator|(
name|hdr
operator|->
name|set
operator|&
operator|~
operator|(
name|MVIS
operator||
name|MINV
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|flags
operator|&
name|HSUB
condition|)
name|subject
operator|=
name|subject
condition|?
name|add
argument_list|(
name|str
argument_list|,
name|add
argument_list|(
literal|"\t"
argument_list|,
name|subject
argument_list|)
argument_list|)
else|:
name|getcpy
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|flags
operator|&
name|HFCC
condition|)
block|{
if|if
condition|(
name|cp
operator|=
name|rindex
argument_list|(
name|str
argument_list|,
literal|'\n'
argument_list|)
condition|)
operator|*
name|cp
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|pp
operator|=
name|str
init|;
name|cp
operator|=
name|index
argument_list|(
name|pp
argument_list|,
literal|','
argument_list|)
condition|;
name|pp
operator|=
name|cp
control|)
block|{
operator|*
name|cp
operator|++
operator|=
name|NULL
expr_stmt|;
name|insert_fcc
argument_list|(
name|hdr
argument_list|,
name|pp
argument_list|)
expr_stmt|;
block|}
name|insert_fcc
argument_list|(
name|hdr
argument_list|,
name|pp
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*
comment|*/
if|if
condition|(
operator|!
operator|(
name|hdr
operator|->
name|flags
operator|&
name|HADR
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s: %s"
argument_list|,
name|name
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return;
block|}
name|tmpaddrs
operator|.
name|m_next
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|cp
operator|=
name|getname
argument_list|(
name|str
argument_list|)
condition|;
name|count
operator|++
control|)
if|if
condition|(
name|mp
operator|=
name|getm
argument_list|(
name|cp
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|AD_HOST
argument_list|,
name|NULLCP
argument_list|)
condition|)
block|{
if|if
condition|(
name|tmpaddrs
operator|.
name|m_next
condition|)
name|np
operator|->
name|m_next
operator|=
name|mp
expr_stmt|;
else|else
name|tmpaddrs
operator|.
name|m_next
operator|=
name|mp
expr_stmt|;
name|np
operator|=
name|mp
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hdr
operator|->
name|flags
operator|&
name|HTRY
condition|)
name|badadr
operator|++
expr_stmt|;
else|else
name|badmsg
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|<
literal|1
condition|)
block|{
if|if
condition|(
name|hdr
operator|->
name|flags
operator|&
name|HNIL
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s: %s"
argument_list|,
name|name
argument_list|,
name|str
argument_list|)
expr_stmt|;
else|else
block|{
ifdef|#
directive|ifdef
name|notdef
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: field requires at least one address"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|badmsg
operator|++
expr_stmt|;
endif|#
directive|endif
endif|notdef
block|}
return|return;
block|}
comment|/*
comment|*/
name|nameoutput
operator|=
name|linepos
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|namep
argument_list|,
literal|"%s%s"
argument_list|,
operator|(
name|hdr
operator|->
name|flags
operator|&
name|HMNG
operator|)
condition|?
literal|"Original-"
else|:
literal|""
argument_list|,
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|grp
operator|=
literal|0
operator|,
name|mp
operator|=
name|tmpaddrs
operator|.
name|m_next
init|;
name|mp
condition|;
name|mp
operator|=
name|np
control|)
if|if
condition|(
name|mp
operator|->
name|m_nohost
condition|)
block|{
comment|/* also used to test (hdr -> flags& HTRY) */
name|pp
operator|=
name|akvalue
argument_list|(
name|mp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
name|qp
operator|=
name|akvisible
argument_list|()
condition|?
name|mp
operator|->
name|m_mbox
else|:
literal|""
expr_stmt|;
name|np
operator|=
name|mp
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|m_gname
condition|)
name|putgrp
argument_list|(
name|namep
argument_list|,
name|np
operator|->
name|m_gname
argument_list|,
name|out
argument_list|,
name|hdr
operator|->
name|flags
argument_list|)
expr_stmt|;
while|while
condition|(
name|cp
operator|=
name|getname
argument_list|(
name|pp
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|mp
operator|=
name|getm
argument_list|(
name|cp
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|AD_HOST
argument_list|,
name|NULLCP
argument_list|)
operator|)
condition|)
block|{
name|badadr
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|hdr
operator|->
name|flags
operator|&
name|HBCC
condition|)
name|mp
operator|->
name|m_bcc
operator|++
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_ingrp
operator|=
name|np
operator|->
name|m_ingrp
condition|)
name|grp
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|MHMTS
name|mp
operator|->
name|m_aka
operator|=
name|getcpy
argument_list|(
name|np
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
if|if
condition|(
name|putadr
argument_list|(
name|namep
argument_list|,
name|qp
argument_list|,
name|mp
argument_list|,
name|out
argument_list|,
name|hdr
operator|->
name|flags
argument_list|)
condition|)
name|msgflags
operator||=
operator|(
name|hdr
operator|->
name|set
operator|&
operator|(
name|MVIS
operator||
name|MINV
operator|)
operator|)
expr_stmt|;
else|else
name|mnfree
argument_list|(
name|mp
argument_list|)
expr_stmt|;
block|}
name|mp
operator|=
name|np
expr_stmt|;
name|np
operator|=
name|np
operator|->
name|m_next
expr_stmt|;
name|mnfree
argument_list|(
name|mp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|hdr
operator|->
name|flags
operator|&
name|HBCC
condition|)
name|mp
operator|->
name|m_bcc
operator|++
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_gname
condition|)
name|putgrp
argument_list|(
name|namep
argument_list|,
name|mp
operator|->
name|m_gname
argument_list|,
name|out
argument_list|,
name|hdr
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_ingrp
condition|)
name|grp
operator|++
expr_stmt|;
name|keep
operator|=
name|putadr
argument_list|(
name|namep
argument_list|,
literal|""
argument_list|,
name|mp
argument_list|,
name|out
argument_list|,
name|hdr
operator|->
name|flags
argument_list|)
expr_stmt|;
name|np
operator|=
name|mp
operator|->
name|m_next
expr_stmt|;
if|if
condition|(
name|keep
condition|)
block|{
name|mp
operator|->
name|m_next
operator|=
name|NULL
expr_stmt|;
name|msgflags
operator||=
operator|(
name|hdr
operator|->
name|set
operator|&
operator|(
name|MVIS
operator||
name|MINV
operator|)
operator|)
expr_stmt|;
block|}
else|else
name|mnfree
argument_list|(
name|mp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|grp
operator|>
literal|0
operator|&&
operator|(
name|hdr
operator|->
name|flags
operator|&
name|HNGR
operator|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: field does not allow groups"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|badmsg
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|linepos
condition|)
operator|(
name|void
operator|)
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|start_headers
argument_list|()
block|{
specifier|register
name|char
operator|*
name|cp
block|;
name|char
name|myhost
index|[
name|BUFSIZ
index|]
block|,
name|sigbuf
index|[
name|BUFSIZ
index|]
block|;
specifier|register
expr|struct
name|mailname
operator|*
name|mp
block|;
name|myuid
operator|=
name|getuid
argument_list|()
block|;
name|mygid
operator|=
name|getgid
argument_list|()
block|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|clock
argument_list|)
block|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|from
argument_list|,
name|adrsprintf
argument_list|(
name|NULLCP
argument_list|,
name|NULLCP
argument_list|)
argument_list|)
block|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|myhost
argument_list|,
name|LocalName
argument_list|()
argument_list|)
block|;
for|for
control|(
name|cp
operator|=
name|myhost
init|;
operator|*
name|cp
condition|;
name|cp
operator|++
control|)
operator|*
name|cp
operator|=
name|uptolow
argument_list|(
operator|*
name|cp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|MHMTS
end_ifdef

begin_if
if|if
condition|(
name|deliver
condition|)
block|{
if|if
condition|(
name|geteuid
argument_list|()
operator|==
literal|0
operator|&&
name|myuid
operator|!=
literal|0
operator|&&
name|myuid
operator|!=
literal|1
operator|&&
name|mygid
operator|!=
literal|1
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"-deliver unknown"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|signature
argument_list|,
name|from
argument_list|)
expr_stmt|;
block|}
end_if

begin_endif
endif|#
directive|endif
endif|MHMTS
end_endif

begin_if
if|if
condition|(
operator|(
name|cp
operator|=
name|getfullname
argument_list|()
operator|)
operator|&&
operator|*
name|cp
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|sigbuf
argument_list|,
name|cp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|signature
argument_list|,
literal|"%s<%s>"
argument_list|,
name|sigbuf
argument_list|,
name|adrsprintf
argument_list|(
name|NULLCP
argument_list|,
name|NULLCP
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|getname
argument_list|(
name|signature
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"getname () failed -- you lose extraordinarily big"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mp
operator|=
name|getm
argument_list|(
name|cp
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|AD_HOST
argument_list|,
name|NULLCP
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"bad signature '%s'"
argument_list|,
name|sigbuf
argument_list|)
expr_stmt|;
name|mnfree
argument_list|(
name|mp
argument_list|)
expr_stmt|;
while|while
condition|(
name|getname
argument_list|(
literal|""
argument_list|)
condition|)
continue|continue;
block|}
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|signature
argument_list|,
name|adrsprintf
argument_list|(
name|NULLCP
argument_list|,
name|NULLCP
argument_list|)
argument_list|)
expr_stmt|;
end_if

begin_comment
unit|}
comment|/*
comment|*/
end_comment

begin_expr_stmt
unit|static
name|finish_headers
argument_list|(
name|out
argument_list|)
specifier|register
name|FILE
operator|*
name|out
expr_stmt|;
end_expr_stmt

begin_block
block|{
switch|switch
condition|(
name|msgstate
condition|)
block|{
case|case
name|NORMAL
case|:
if|if
condition|(
name|whomsw
condition|)
break|break;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Date: %s\n"
argument_list|,
name|dtime
argument_list|(
operator|&
name|clock
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgid
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Message-ID:<%d.%ld@%s>\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|clock
argument_list|,
name|LocalName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgflags
operator|&
name|MFRM
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Sender: %s\n"
argument_list|,
name|from
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"From: %s\n"
argument_list|,
name|signature
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msgflags
operator|&
name|MVIS
operator|)
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Bcc: Blind Distribution List: ;\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RESENT
case|:
if|if
condition|(
operator|!
operator|(
name|msgflags
operator|&
name|MDAT
operator|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"message has no Date: header"
argument_list|)
expr_stmt|;
name|badmsg
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|msgflags
operator|&
name|MFRM
operator|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"message has no From: header"
argument_list|)
expr_stmt|;
name|badmsg
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|whomsw
condition|)
break|break;
ifdef|#
directive|ifdef
name|MMDFI
comment|/* sigh */
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Sender: %s\n"
argument_list|,
name|from
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFI
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Resent-Date: %s\n"
argument_list|,
name|dtime
argument_list|(
operator|&
name|clock
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgid
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Resent-Message-ID:<%d.%ld@%s>\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|clock
argument_list|,
name|LocalName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgflags
operator|&
name|MRFM
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Resent-Sender: %s\n"
argument_list|,
name|from
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Resent-From: %s\n"
argument_list|,
name|signature
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msgflags
operator|&
name|MVIS
operator|)
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Resent-Bcc: Blind Re-Distribution List: ;\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|badmsg
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"re-format message and try again"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|recipients
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"no addressees"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|get_header
parameter_list|(
name|header
parameter_list|,
name|table
parameter_list|)
specifier|register
name|char
modifier|*
name|header
decl_stmt|;
specifier|register
name|struct
name|headers
modifier|*
name|table
decl_stmt|;
block|{
specifier|register
name|struct
name|headers
modifier|*
name|h
decl_stmt|;
for|for
control|(
name|h
operator|=
name|table
init|;
name|h
operator|->
name|value
condition|;
name|h
operator|++
control|)
if|if
condition|(
name|uleq
argument_list|(
name|header
argument_list|,
name|h
operator|->
name|value
argument_list|)
condition|)
return|return
operator|(
name|h
operator|-
name|table
operator|)
return|;
return|return
name|NOTOK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|putadr
parameter_list|(
name|name
parameter_list|,
name|aka
parameter_list|,
name|mp
parameter_list|,
name|out
parameter_list|,
name|flags
parameter_list|)
specifier|register
name|char
modifier|*
name|name
decl_stmt|,
decl|*
name|aka
decl_stmt|;
end_function

begin_decl_stmt
specifier|register
name|struct
name|mailname
modifier|*
name|mp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|FILE
modifier|*
name|out
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|flags
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|len
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_mbox
operator|==
name|NULL
operator|||
operator|(
operator|(
name|flags
operator|&
name|HTRY
operator|)
operator|&&
operator|!
name|insert
argument_list|(
name|mp
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|flags
operator|&
name|HBCC
operator|)
operator|||
name|mp
operator|->
name|m_ingrp
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|nameoutput
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s: "
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|linepos
operator|+=
operator|(
name|nameoutput
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|2
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|aka
operator|&&
name|mp
operator|->
name|m_type
operator|!=
name|UUCPHOST
operator|&&
operator|!
name|mp
operator|->
name|m_pers
condition|)
name|mp
operator|->
name|m_pers
operator|=
name|getcpy
argument_list|(
name|aka
argument_list|)
expr_stmt|;
if|if
condition|(
name|format
condition|)
block|{
if|if
condition|(
name|mp
operator|->
name|m_gname
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|cp
operator|=
name|buffer
argument_list|,
literal|"%s;"
argument_list|,
name|mp
operator|->
name|m_gname
argument_list|)
expr_stmt|;
else|else
name|cp
operator|=
name|adrformat
argument_list|(
name|mp
argument_list|)
expr_stmt|;
block|}
else|else
name|cp
operator|=
name|mp
operator|->
name|m_text
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|linepos
operator|!=
name|nameoutput
condition|)
if|if
condition|(
name|len
operator|+
name|linepos
operator|+
literal|2
operator|>
name|outputlinelen
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|",\n%*s"
argument_list|,
name|linepos
operator|=
name|nameoutput
argument_list|,
literal|""
argument_list|)
expr_stmt|;
else|else
block|{
name|fputs
argument_list|(
literal|", "
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|linepos
operator|+=
literal|2
expr_stmt|;
block|}
name|fputs
argument_list|(
name|cp
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|linepos
operator|+=
name|len
expr_stmt|;
return|return
operator|(
name|flags
operator|&
name|HTRY
operator|)
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|putgrp
argument_list|(
name|name
argument_list|,
name|group
argument_list|,
name|out
argument_list|,
name|flags
argument_list|)
specifier|register
name|char
operator|*
name|name
operator|,
operator|*
name|group
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|FILE
modifier|*
name|out
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|flags
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|len
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|HBCC
condition|)
return|return;
if|if
condition|(
operator|!
name|nameoutput
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s: "
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|linepos
operator|+=
operator|(
name|nameoutput
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|2
operator|)
expr_stmt|;
block|}
name|cp
operator|=
name|concat
argument_list|(
name|group
argument_list|,
literal|";"
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|linepos
operator|!=
name|nameoutput
condition|)
if|if
condition|(
name|len
operator|+
name|linepos
operator|+
literal|2
operator|>
name|outputlinelen
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|",\n%*s"
argument_list|,
name|nameoutput
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|linepos
operator|=
name|nameoutput
expr_stmt|;
block|}
else|else
block|{
name|fputs
argument_list|(
literal|", "
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|linepos
operator|+=
literal|2
expr_stmt|;
block|}
name|fputs
argument_list|(
name|cp
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|linepos
operator|+=
name|len
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|insert
parameter_list|(
name|np
parameter_list|)
specifier|register
name|struct
name|mailname
modifier|*
name|np
decl_stmt|;
block|{
specifier|register
name|struct
name|mailname
modifier|*
name|mp
decl_stmt|;
if|if
condition|(
name|np
operator|->
name|m_mbox
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|mp
operator|=
name|np
operator|->
name|m_type
operator|==
name|LOCALHOST
condition|?
operator|&
name|localaddrs
else|:
name|np
operator|->
name|m_type
operator|==
name|UUCPHOST
condition|?
operator|&
name|uuaddrs
else|:
operator|&
name|netaddrs
init|;
name|mp
operator|->
name|m_next
condition|;
name|mp
operator|=
name|mp
operator|->
name|m_next
control|)
if|if
condition|(
name|uleq
argument_list|(
name|np
operator|->
name|m_host
argument_list|,
name|mp
operator|->
name|m_next
operator|->
name|m_host
argument_list|)
operator|&&
name|uleq
argument_list|(
name|np
operator|->
name|m_mbox
argument_list|,
name|mp
operator|->
name|m_next
operator|->
name|m_mbox
argument_list|)
operator|&&
name|np
operator|->
name|m_bcc
operator|==
name|mp
operator|->
name|m_next
operator|->
name|m_bcc
condition|)
return|return
literal|0
return|;
name|mp
operator|->
name|m_next
operator|=
name|np
expr_stmt|;
name|recipients
operator|++
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|pl
argument_list|()
block|{
specifier|register
name|int
name|i
block|;
specifier|register
expr|struct
name|mailname
operator|*
name|mp
block|;
name|printf
argument_list|(
literal|"-------\n\t-- Addresses --\nlocal:\t"
argument_list|)
block|;
for|for
control|(
name|mp
operator|=
name|localaddrs
operator|.
name|m_next
init|;
name|mp
condition|;
name|mp
operator|=
name|mp
operator|->
name|m_next
control|)
name|printf
argument_list|(
literal|"%s%s%s"
argument_list|,
name|mp
operator|->
name|m_mbox
argument_list|,
name|mp
operator|->
name|m_bcc
condition|?
literal|"[BCC]"
else|:
literal|""
argument_list|,
name|mp
operator|->
name|m_next
condition|?
literal|",\n\t"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nnet:\t"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
name|mp
operator|=
name|netaddrs
operator|.
name|m_next
init|;
name|mp
condition|;
name|mp
operator|=
name|mp
operator|->
name|m_next
control|)
name|printf
argument_list|(
literal|"%s%s@%s%s%s"
argument_list|,
name|mp
operator|->
name|m_path
condition|?
name|mp
operator|->
name|m_path
else|:
literal|""
argument_list|,
name|mp
operator|->
name|m_mbox
argument_list|,
name|mp
operator|->
name|m_host
argument_list|,
name|mp
operator|->
name|m_bcc
condition|?
literal|"[BCC]"
else|:
literal|""
argument_list|,
name|mp
operator|->
name|m_next
condition|?
literal|",\n\t"
else|:
literal|""
argument_list|)
expr_stmt|;
end_for

begin_expr_stmt
name|printf
argument_list|(
literal|"\nuucp:\t"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
name|mp
operator|=
name|uuaddrs
operator|.
name|m_next
init|;
name|mp
condition|;
name|mp
operator|=
name|mp
operator|->
name|m_next
control|)
name|printf
argument_list|(
literal|"%s!%s%s"
argument_list|,
name|mp
operator|->
name|m_host
argument_list|,
name|mp
operator|->
name|m_mbox
argument_list|,
name|mp
operator|->
name|m_bcc
condition|?
literal|"[BCC]"
else|:
literal|""
argument_list|,
name|mp
operator|->
name|m_next
condition|?
literal|",\n\t"
else|:
literal|""
argument_list|)
expr_stmt|;
end_for

begin_expr_stmt
name|printf
argument_list|(
literal|"\n\t-- Folder Copies --\nfcc:\t"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fccind
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|fccfold
index|[
name|i
index|]
argument_list|,
name|i
operator|+
literal|1
operator|<
name|fccind
condition|?
literal|",\n\t"
else|:
literal|""
argument_list|)
expr_stmt|;
end_for

begin_expr_stmt
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
unit|}
comment|/*
comment|*/
end_comment

begin_macro
unit|static
name|anno
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|mailname
modifier|*
name|mp
decl_stmt|;
for|for
control|(
name|mp
operator|=
name|localaddrs
operator|.
name|m_next
init|;
name|mp
condition|;
name|mp
operator|=
name|mp
operator|->
name|m_next
control|)
if|if
condition|(
name|annoaux
argument_list|(
name|mp
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|oops
goto|;
for|for
control|(
name|mp
operator|=
name|netaddrs
operator|.
name|m_next
init|;
name|mp
condition|;
name|mp
operator|=
name|mp
operator|->
name|m_next
control|)
if|if
condition|(
name|annoaux
argument_list|(
name|mp
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|oops
goto|;
for|for
control|(
name|mp
operator|=
name|uuaddrs
operator|.
name|m_next
init|;
name|mp
condition|;
name|mp
operator|=
name|mp
operator|->
name|m_next
control|)
if|if
condition|(
name|annoaux
argument_list|(
name|mp
argument_list|)
operator|==
name|NOTOK
condition|)
break|break;
name|oops
label|:
empty_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pfd
argument_list|)
expr_stmt|;
name|pfd
operator|=
name|NOTOK
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|int
name|annoaux
parameter_list|(
name|mp
parameter_list|)
specifier|register
name|struct
name|mailname
modifier|*
name|mp
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s\n"
argument_list|,
name|adrformat
argument_list|(
name|mp
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|=
name|strlen
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
name|write
argument_list|(
name|pfd
argument_list|,
name|buffer
argument_list|,
name|i
argument_list|)
operator|==
name|i
condition|?
name|OK
else|:
name|NOTOK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|insert_fcc
argument_list|(
name|hdr
argument_list|,
name|pp
argument_list|)
specifier|register
expr|struct
name|headers
operator|*
name|hdr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|char
modifier|*
name|pp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
for|for
control|(
name|cp
operator|=
name|pp
init|;
name|isspace
argument_list|(
operator|*
name|cp
argument_list|)
condition|;
name|cp
operator|++
control|)
continue|continue;
for|for
control|(
name|pp
operator|+=
name|strlen
argument_list|(
name|pp
argument_list|)
operator|-
literal|1
init|;
name|pp
operator|>
name|cp
operator|&&
name|isspace
argument_list|(
operator|*
name|pp
argument_list|)
condition|;
name|pp
operator|--
control|)
continue|continue;
if|if
condition|(
name|pp
operator|>=
name|cp
condition|)
operator|*
operator|++
name|pp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|fccind
operator|>=
name|FCCS
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"too many %ss"
argument_list|,
name|hdr
operator|->
name|value
argument_list|)
expr_stmt|;
name|fccfold
index|[
name|fccind
operator|++
index|]
operator|=
name|getcpy
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|BCC GENERATION */
end_comment

begin_expr_stmt
specifier|static
name|make_bcc_file
argument_list|()
block|{
name|int
name|fd
block|,
name|i
block|,
name|child_id
block|;
name|char
operator|*
name|vec
index|[
literal|6
index|]
block|;
specifier|register
name|FILE
operator|*
name|out
block|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|bccfil
argument_list|,
name|m_tmpfil
argument_list|(
literal|"bccs"
argument_list|)
argument_list|)
block|;
if|if
condition|(
operator|(
name|out
operator|=
name|fopen
argument_list|(
name|bccfil
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|bccfil
argument_list|,
literal|"unable to create"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|chmod
argument_list|(
name|bccfil
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Date: %s\n"
argument_list|,
name|dtime
argument_list|(
operator|&
name|clock
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|msgid
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Message-ID:<%d.%ld@%s>\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|clock
argument_list|,
name|LocalName
argument_list|()
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"From: %s\n"
argument_list|,
name|signature
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|subject
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Subject: %s"
argument_list|,
name|subject
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"BCC:\n\n------- Blind-Carbon-Copy\n\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|out
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|filter
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|tmpfil
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to re-open"
argument_list|)
expr_stmt|;
name|cpydgst
argument_list|(
name|fd
argument_list|,
name|fileno
argument_list|(
name|out
argument_list|)
argument_list|,
name|tmpfil
argument_list|,
name|bccfil
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vec
index|[
literal|0
index|]
operator|=
name|r1bindex
argument_list|(
name|mhlproc
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|child_id
operator|=
name|fork
argument_list|()
operator|)
operator|==
name|NOTOK
operator|&&
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|child_id
condition|)
block|{
case|case
name|NOTOK
case|:
name|adios
argument_list|(
literal|"fork"
argument_list|,
literal|"unable to"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
operator|(
name|void
operator|)
name|dup2
argument_list|(
name|fileno
argument_list|(
name|out
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|i
operator|=
literal|1
expr_stmt|;
name|vec
index|[
name|i
operator|++
index|]
operator|=
literal|"-forward"
expr_stmt|;
name|vec
index|[
name|i
operator|++
index|]
operator|=
literal|"-form"
expr_stmt|;
name|vec
index|[
name|i
operator|++
index|]
operator|=
name|filter
expr_stmt|;
name|vec
index|[
name|i
operator|++
index|]
operator|=
name|tmpfil
expr_stmt|;
name|vec
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|execvp
argument_list|(
name|mhlproc
argument_list|,
name|vec
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unable to exec "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|mhlproc
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
default|default:
operator|(
name|void
operator|)
name|pidXwait
argument_list|(
name|child_id
argument_list|,
name|mhlproc
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_if

begin_expr_stmt
operator|(
name|void
operator|)
name|fseek
argument_list|(
name|out
argument_list|,
literal|0L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n------- End of Blind-Carbon-Copy\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|out
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
unit|}
comment|/*
comment|ADDRESS VERIFICATION */
end_comment

begin_macro
unit|static
name|verify_all_addresses
argument_list|(
argument|talk
argument_list|)
end_macro

begin_decl_stmt
name|int
name|talk
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifndef|#
directive|ifndef
name|MHMTS
name|int
name|retval
decl_stmt|;
endif|#
directive|endif
endif|not MHMTS
ifdef|#
directive|ifdef
name|MMDFMTS
ifdef|#
directive|ifdef
name|RP_NS
name|int
name|len
decl_stmt|;
name|struct
name|rp_bufstruct
name|reply
decl_stmt|;
endif|#
directive|endif
endif|RP_NS
endif|#
directive|endif
endif|MMDFMTS
specifier|register
name|struct
name|mailname
modifier|*
name|lp
decl_stmt|;
ifndef|#
directive|ifndef
name|MHMTS
name|sigon
argument_list|()
expr_stmt|;
endif|#
directive|endif
endif|not MHMTS
ifdef|#
directive|ifdef
name|MMDFMTS
if|if
condition|(
operator|!
name|whomsw
operator|||
name|checksw
condition|)
block|{
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_init
argument_list|()
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_sbinit
argument_list|()
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_winit
argument_list|(
name|NULLCP
argument_list|,
name|submitopts
argument_list|,
name|from
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem initializing MMDF system [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RP_NS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_rrply
argument_list|(
operator|&
name|reply
argument_list|,
operator|&
name|len
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem with sender address [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|RP_NS
block|}
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
if|if
condition|(
operator|!
name|whomsw
operator|||
name|checksw
condition|)
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_init
argument_list|(
name|clientsw
argument_list|,
name|serversw
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|snoop
argument_list|)
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_winit
argument_list|(
name|smtpmode
argument_list|,
name|from
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem initializing server; %s"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
if|if
condition|(
name|talk
operator|&&
operator|!
name|whomsw
condition|)
name|printf
argument_list|(
literal|" -- Address Verification --\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|BERK
if|if
condition|(
name|talk
operator|&&
name|localaddrs
operator|.
name|m_next
condition|)
name|printf
argument_list|(
literal|"  -- Local Recipients --\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BERK
for|for
control|(
name|lp
operator|=
name|localaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
name|do_an_address
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|encryptsw
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|BERK
if|if
condition|(
name|talk
operator|&&
name|uuaddrs
operator|.
name|m_next
condition|)
name|printf
argument_list|(
literal|"  -- UUCP Recipients --\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BERK
for|for
control|(
name|lp
operator|=
name|uuaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
name|do_an_address
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|encryptsw
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|BERK
if|if
condition|(
name|talk
operator|&&
name|netaddrs
operator|.
name|m_next
condition|)
name|printf
argument_list|(
literal|"  -- Network Recipients --\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BERK
for|for
control|(
name|lp
operator|=
name|netaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
name|do_an_address
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|encryptsw
argument_list|)
expr_stmt|;
name|chkadr
argument_list|()
expr_stmt|;
if|if
condition|(
name|talk
operator|&&
operator|!
name|whomsw
condition|)
name|printf
argument_list|(
literal|" -- Address Verification Successful --\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
if|if
condition|(
operator|!
name|whomsw
operator|||
name|checksw
condition|)
operator|(
name|void
operator|)
name|mm_end
argument_list|(
name|NOTOK
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
if|if
condition|(
operator|!
name|whomsw
operator|||
name|checksw
condition|)
operator|(
name|void
operator|)
name|sm_end
argument_list|(
name|DONE
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|MHMTS
name|sigoff
argument_list|()
expr_stmt|;
endif|#
directive|endif
endif|not MHMTS
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|chkadr
argument_list|()
block|{
define|#
directive|define
name|plural
parameter_list|(
name|x
parameter_list|)
value|(x == 1 ? "" : "s")
if|if
condition|(
name|badadr
operator|&&
name|unkadr
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"%d address%s unparsable, %d addressee%s undeliverable"
argument_list|,
name|badadr
argument_list|,
name|plural
argument_list|(
name|badadr
argument_list|)
argument_list|,
name|unkadr
argument_list|,
name|plural
argument_list|(
name|badadr
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|badadr
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"%d address%s unparsable"
argument_list|,
name|badadr
argument_list|,
name|plural
argument_list|(
name|badadr
argument_list|)
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|unkadr
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"%d addressee%s undeliverable"
argument_list|,
name|unkadr
argument_list|,
name|plural
argument_list|(
name|unkadr
argument_list|)
argument_list|)
expr_stmt|;
end_if

begin_comment
unit|}
comment|/*
comment|MTS INTERACTION */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|TMA
end_ifdef

begin_macro
unit|static
name|postplain
argument_list|(
argument|file
argument_list|,
argument|bccque
argument_list|,
argument|talk
argument_list|)
end_macro

begin_else
else|#
directive|else
else|TMA
end_else

begin_expr_stmt
specifier|static
name|post
argument_list|(
name|file
argument_list|,
name|bccque
argument_list|,
name|talk
argument_list|)
endif|#
directive|endif
endif|TMA
specifier|register
name|char
operator|*
name|file
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|bccque
decl_stmt|,
name|talk
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|fd
decl_stmt|;
ifndef|#
directive|ifndef
name|MHMTS
name|int
name|retval
decl_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
ifdef|#
directive|ifdef
name|RP_NS
name|int
name|len
decl_stmt|;
name|struct
name|rp_bufstruct
name|reply
decl_stmt|;
endif|#
directive|endif
endif|RP_NS
endif|#
directive|endif
endif|MMDFMTS
else|#
directive|else
else|MHMTS
name|int
name|ud
decl_stmt|;
endif|#
directive|endif
endif|MHMTS
if|if
condition|(
name|verbose
condition|)
if|if
condition|(
name|msgflags
operator|&
name|MINV
condition|)
name|printf
argument_list|(
literal|" -- Posting for %s Recipients --\n"
argument_list|,
name|bccque
condition|?
literal|"Blind"
else|:
literal|"Sighted"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" -- Posting for All Recipients --\n"
argument_list|)
expr_stmt|;
name|sigon
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_init
argument_list|()
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_sbinit
argument_list|()
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_winit
argument_list|(
name|NULLCP
argument_list|,
name|submitopts
argument_list|,
name|from
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem initializing MMDF system [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RP_NS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_rrply
argument_list|(
operator|&
name|reply
argument_list|,
operator|&
name|len
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem with sender address [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|RP_NS
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_init
argument_list|(
name|clientsw
argument_list|,
name|serversw
argument_list|,
name|watch
argument_list|,
name|verbose
argument_list|,
name|snoop
argument_list|)
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_winit
argument_list|(
name|smtpmode
argument_list|,
name|from
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem initializing server; %s"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
ifndef|#
directive|ifndef
name|MHMTS
name|do_addresses
argument_list|(
name|bccque
argument_list|,
name|talk
operator|&&
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|file
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|die
argument_list|(
name|file
argument_list|,
literal|"unable to re-open"
argument_list|)
expr_stmt|;
name|do_text
argument_list|(
name|file
argument_list|,
name|fd
argument_list|)
expr_stmt|;
else|#
directive|else
else|MHMTS
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|file
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|file
argument_list|,
literal|"unable to re-open"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MF
name|ud
operator|=
name|UucpChan
argument_list|()
operator|&&
name|uuaddrs
operator|.
name|m_next
condition|?
name|make_uucp_file
argument_list|(
name|fd
argument_list|)
else|:
name|NOTOK
expr_stmt|;
else|#
directive|else
else|not MF
name|ud
operator|=
name|NOTOK
expr_stmt|;
endif|#
directive|endif
endif|not MF
name|do_addresses
argument_list|(
name|file
argument_list|,
name|fd
argument_list|,
name|ud
argument_list|,
name|bccque
argument_list|,
name|talk
operator|&&
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|ud
operator|!=
name|NOTOK
condition|)
operator|(
name|void
operator|)
name|close
argument_list|(
name|ud
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
operator|(
name|void
operator|)
name|mm_sbend
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|mm_end
argument_list|(
name|OK
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
operator|(
name|void
operator|)
name|sm_end
argument_list|(
operator|!
operator|(
name|msgflags
operator|&
name|MINV
operator|)
operator|||
name|bccque
condition|?
name|OK
else|:
name|DONE
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
name|sigoff
argument_list|()
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
if|if
condition|(
name|msgflags
operator|&
name|MINV
condition|)
name|printf
argument_list|(
literal|" -- %s Recipient Copies Posted --\n"
argument_list|,
name|bccque
condition|?
literal|"Blind"
else|:
literal|"Sighted"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" -- Recipient Copies Posted --\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|TMA
end_ifdef

begin_expr_stmt
specifier|static
name|postcipher
argument_list|(
name|file
argument_list|,
name|bccque
argument_list|,
name|talk
argument_list|)
specifier|register
name|char
operator|*
name|file
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|bccque
decl_stmt|,
name|talk
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|fdP
decl_stmt|,
name|state
decl_stmt|;
name|char
name|reason
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|mailname
modifier|*
name|lp
decl_stmt|;
if|if
condition|(
name|verbose
condition|)
if|if
condition|(
name|msgflags
operator|&
name|MINV
condition|)
name|printf
argument_list|(
literal|" -- Posting for %s Recipients --\n"
argument_list|,
name|bccque
condition|?
literal|"Blind"
else|:
literal|"Sighted"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" -- Posting for All Recipients --\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fdP
operator|=
name|open
argument_list|(
name|file
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|file
argument_list|,
literal|"unable to re-open"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ciphinit
argument_list|(
name|fdP
argument_list|,
name|reason
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fdP
argument_list|)
expr_stmt|;
for|for
control|(
name|state
operator|=
literal|0
operator|,
name|lp
operator|=
name|localaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
if|if
condition|(
name|lp
operator|->
name|m_bcc
condition|?
name|bccque
else|:
operator|!
name|bccque
condition|)
block|{
ifndef|#
directive|ifndef
name|BERK
if|if
condition|(
name|talk
operator|&&
operator|!
name|state
condition|)
name|printf
argument_list|(
literal|"  -- Local Recipients --\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BERK
name|do_a_cipher
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|BERK
name|state
operator|++
expr_stmt|;
endif|#
directive|endif
endif|BERK
block|}
for|for
control|(
name|state
operator|=
literal|0
operator|,
name|lp
operator|=
name|uuaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
if|if
condition|(
name|lp
operator|->
name|m_bcc
condition|?
name|bccque
else|:
operator|!
name|bccque
condition|)
block|{
ifndef|#
directive|ifndef
name|BERK
if|if
condition|(
name|talk
operator|&&
operator|!
name|state
condition|)
name|printf
argument_list|(
literal|"  -- UUCP Recipients --\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BERK
name|do_a_cipher
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|BERK
name|state
operator|++
expr_stmt|;
endif|#
directive|endif
endif|BERK
block|}
for|for
control|(
name|state
operator|=
literal|0
operator|,
name|lp
operator|=
name|netaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
if|if
condition|(
name|lp
operator|->
name|m_bcc
condition|?
name|bccque
else|:
operator|!
name|bccque
condition|)
block|{
ifndef|#
directive|ifndef
name|BERK
if|if
condition|(
name|talk
operator|&&
operator|!
name|state
condition|)
name|printf
argument_list|(
literal|"  -- Network Recipients --\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BERK
name|do_a_cipher
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|BERK
name|state
operator|++
expr_stmt|;
endif|#
directive|endif
endif|BERK
block|}
if|if
condition|(
name|ciphdone
argument_list|(
name|reason
argument_list|)
operator|==
name|NOTOK
condition|)
name|admonish
argument_list|(
name|NULLCP
argument_list|,
literal|"%s"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SENDMTS
if|if
condition|(
operator|!
operator|(
name|msgflags
operator|&
name|MINV
operator|)
operator|||
name|bccque
condition|)
operator|(
name|void
operator|)
name|sm_end
argument_list|(
name|OK
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
if|if
condition|(
name|verbose
condition|)
if|if
condition|(
name|msgflags
operator|&
name|MINV
condition|)
name|printf
argument_list|(
literal|" -- %s Recipient Copies Posted --\n"
argument_list|,
name|bccque
condition|?
literal|"Blind"
else|:
literal|"Sighted"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" -- Recipient Copies Posted --\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|do_a_cipher
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|)
specifier|register
expr|struct
name|mailname
operator|*
name|lp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|talk
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|fd
decl_stmt|,
name|retval
decl_stmt|;
specifier|register
name|char
modifier|*
name|mbox
decl_stmt|,
modifier|*
name|host
decl_stmt|;
name|char
name|addr
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|reason
index|[
name|BUFSIZ
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
ifdef|#
directive|ifdef
name|RP_NS
name|int
name|len
decl_stmt|;
name|struct
name|rp_bufstruct
name|reply
decl_stmt|;
endif|#
directive|endif
endif|RP_NS
endif|#
directive|endif
endif|MMDFMTS
name|sigon
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_init
argument_list|()
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_sbinit
argument_list|()
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_winit
argument_list|(
name|NULL
argument_list|,
name|submitopts
argument_list|,
name|from
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem initializing MMDF system [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RP_NS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_rrply
argument_list|(
operator|&
name|reply
argument_list|,
operator|&
name|len
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem with sender address [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|RP_NS
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_init
argument_list|(
name|clientsw
argument_list|,
name|serversw
argument_list|,
name|watch
argument_list|,
name|verbose
argument_list|,
name|snoop
argument_list|)
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_winit
argument_list|(
name|smtpmode
argument_list|,
name|from
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem initializing server; %s"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
name|do_an_address
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|lp
operator|->
name|m_type
condition|)
block|{
case|case
name|LOCALHOST
case|:
name|mbox
operator|=
name|lp
operator|->
name|m_mbox
expr_stmt|;
name|host
operator|=
name|LocalName
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|addr
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
break|break;
case|case
name|UUCPHOST
case|:
ifdef|#
directive|ifdef
name|MMDFMTS
name|mbox
operator|=
name|concat
argument_list|(
name|lp
operator|->
name|m_host
argument_list|,
literal|"!"
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
name|host
operator|=
name|UucpChan
argument_list|()
expr_stmt|;
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
name|mbox
operator|=
name|auxformat
argument_list|(
name|lp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|host
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|addr
argument_list|,
literal|"%s!%s"
argument_list|,
name|lp
operator|->
name|m_host
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
break|break;
default|default:
name|mbox
operator|=
name|lp
operator|->
name|m_mbox
expr_stmt|;
name|host
operator|=
name|lp
operator|->
name|m_host
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|addr
argument_list|,
literal|"%s at %s"
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|,
name|lp
operator|->
name|m_host
argument_list|)
expr_stmt|;
break|break;
block|}
name|chkadr
argument_list|()
expr_stmt|;
comment|/* XXX */
ifdef|#
directive|ifdef
name|MMDFMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_waend
argument_list|()
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem ending addresses [%s]\n"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_waend
argument_list|()
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem ending addresses; %s"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
if|if
condition|(
operator|(
name|fd
operator|=
name|encipher
argument_list|(
name|mbox
argument_list|,
name|host
argument_list|,
name|reason
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: %s"
argument_list|,
name|addr
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|do_text
argument_list|(
literal|"temporary file"
argument_list|,
name|fd
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
operator|(
name|void
operator|)
name|mm_sbend
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|mm_end
argument_list|(
name|OK
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
operator|(
name|void
operator|)
name|sm_end
argument_list|(
name|DONE
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
name|sigoff
argument_list|()
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|TMA
end_endif

begin_comment
comment|/*
comment|*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|MHMTS
end_ifndef

begin_expr_stmt
specifier|static
name|do_addresses
argument_list|(
argument|bccque
argument_list|,
argument|talk
argument_list|)
else|#
directive|else
else|MHMTS
specifier|static
name|do_addresses
argument_list|(
name|file
argument_list|,
name|fd
argument_list|,
name|ud
argument_list|,
name|bccque
argument_list|,
name|talk
argument_list|)
specifier|register
name|char
operator|*
name|file
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|fd
decl_stmt|,
name|ud
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|MHMTS
end_endif

begin_decl_stmt
name|int
name|bccque
decl_stmt|,
name|talk
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|retval
decl_stmt|;
ifndef|#
directive|ifndef
name|BERK
name|int
name|state
decl_stmt|;
endif|#
directive|endif
endif|not BERK
specifier|register
name|struct
name|mailname
modifier|*
name|lp
decl_stmt|;
ifndef|#
directive|ifndef
name|BERK
name|state
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
endif|not BERK
for|for
control|(
name|lp
operator|=
name|localaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
if|if
condition|(
name|lp
operator|->
name|m_bcc
condition|?
name|bccque
else|:
operator|!
name|bccque
condition|)
block|{
ifndef|#
directive|ifndef
name|BERK
if|if
condition|(
name|talk
operator|&&
operator|!
name|state
condition|)
name|printf
argument_list|(
literal|"  -- Local Recipients --\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|not BERK
ifndef|#
directive|ifndef
name|MHMTS
name|do_an_address
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
else|MHMTS
name|localmail
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|fd
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
ifndef|#
directive|ifndef
name|BERK
name|state
operator|++
expr_stmt|;
endif|#
directive|endif
endif|not BERK
block|}
ifndef|#
directive|ifndef
name|BERK
name|state
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
endif|not BERK
for|for
control|(
name|lp
operator|=
name|uuaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
if|if
condition|(
name|lp
operator|->
name|m_bcc
condition|?
name|bccque
else|:
operator|!
name|bccque
condition|)
block|{
ifndef|#
directive|ifndef
name|BERK
if|if
condition|(
name|talk
operator|&&
operator|!
name|state
condition|)
name|printf
argument_list|(
literal|"  -- UUCP Recipients --\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|not BERK
ifndef|#
directive|ifndef
name|MHMTS
name|do_an_address
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
else|MHMTS
name|uucpmail
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|ud
operator|!=
name|NOTOK
condition|?
name|ud
else|:
name|fd
argument_list|,
name|ud
operator|==
name|NOTOK
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
ifndef|#
directive|ifndef
name|BERK
name|state
operator|++
expr_stmt|;
endif|#
directive|endif
endif|not BERK
block|}
ifndef|#
directive|ifndef
name|BERK
name|state
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
endif|not BERK
for|for
control|(
name|lp
operator|=
name|netaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
if|if
condition|(
name|lp
operator|->
name|m_bcc
condition|?
name|bccque
else|:
operator|!
name|bccque
condition|)
block|{
ifndef|#
directive|ifndef
name|BERK
if|if
condition|(
name|talk
operator|&&
operator|!
name|state
condition|)
name|printf
argument_list|(
literal|"  -- Network Recipients --\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|not BERK
ifndef|#
directive|ifndef
name|MHMTS
name|do_an_address
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
else|MHMTS
name|netmail
argument_list|(
name|talk
argument_list|,
name|fd
argument_list|,
name|bccque
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
ifndef|#
directive|ifndef
name|BERK
name|state
operator|++
expr_stmt|;
endif|#
directive|endif
endif|not BERK
block|}
comment|/*
comment|*/
name|chkadr
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_waend
argument_list|()
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem ending addresses [%s]\n"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_waend
argument_list|()
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem ending addresses; %s"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|MHMTS
end_ifndef

begin_expr_stmt
specifier|static
name|do_text
argument_list|(
name|file
argument_list|,
name|fd
argument_list|)
specifier|register
name|char
operator|*
name|file
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|fd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|retval
decl_stmt|,
name|state
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
name|struct
name|rp_bufstruct
name|reply
decl_stmt|;
endif|#
directive|endif
endif|MMDFMTS
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|state
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
operator|)
operator|>
literal|0
condition|)
ifdef|#
directive|ifdef
name|MMDFMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|mm_wtxt
argument_list|(
name|buf
argument_list|,
name|state
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem writing text [%s]\n"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_wtxt
argument_list|(
name|buf
argument_list|,
name|state
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem writing text; %s\n"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
if|if
condition|(
name|state
operator|==
name|NOTOK
condition|)
name|die
argument_list|(
name|file
argument_list|,
literal|"problem reading from"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_wtend
argument_list|()
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem ending text [%s]\n"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_rrply
argument_list|(
operator|&
name|reply
argument_list|,
operator|&
name|state
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem getting submission status [%s]\n"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rp_gval
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
condition|)
block|{
case|case
name|RP_OK
case|:
case|case
name|RP_MOK
case|:
break|break;
case|case
name|RP_NO
case|:
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"you lose; %s"
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
case|case
name|RP_NDEL
case|:
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"no delivery occurred; %s"
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
case|case
name|RP_AGN
case|:
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"try again later; %s"
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
case|case
name|RP_NOOP
case|:
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"nothing done; %s"
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
default|default:
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"unexpected response;\n\t[%s] -- %s"
argument_list|,
name|rp_valstr
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
switch|switch
condition|(
name|retval
operator|=
name|sm_wtend
argument_list|()
condition|)
block|{
case|case
name|RP_OK
case|:
break|break;
case|case
name|RP_NO
case|:
case|case
name|RP_NDEL
case|:
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"posting failed; %s"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
default|default:
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"unexpected response; %s"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|SENDMTS
block|}
end_block

begin_endif
endif|#
directive|endif
endif|not MHMTS
end_endif

begin_comment
comment|/*
comment|MTS-SPECIFIC INTERACTION */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|MMDFMTS
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|TMA
end_ifndef

begin_comment
comment|/* ARGSUSED */
end_comment

begin_endif
endif|#
directive|endif
endif|TMA
end_endif

begin_expr_stmt
specifier|static
name|do_an_address
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|tma
argument_list|)
specifier|register
expr|struct
name|mailname
operator|*
name|lp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|talk
decl_stmt|,
name|tma
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|len
decl_stmt|,
name|retval
decl_stmt|;
specifier|register
name|char
modifier|*
name|mbox
decl_stmt|,
modifier|*
name|host
decl_stmt|,
modifier|*
name|text
decl_stmt|,
modifier|*
name|path
decl_stmt|;
name|char
name|addr
index|[
name|BUFSIZ
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|TMA
name|char
name|reason
index|[
name|BUFSIZ
index|]
decl_stmt|;
endif|#
directive|endif
endif|TMA
name|struct
name|rp_bufstruct
name|reply
decl_stmt|;
switch|switch
condition|(
name|lp
operator|->
name|m_type
condition|)
block|{
case|case
name|LOCALHOST
case|:
name|mbox
operator|=
name|lp
operator|->
name|m_mbox
expr_stmt|;
name|host
operator|=
name|LocalName
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|addr
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
break|break;
case|case
name|UUCPHOST
case|:
ifdef|#
directive|ifdef
name|MF
name|mbox
operator|=
name|concat
argument_list|(
name|lp
operator|->
name|m_host
argument_list|,
literal|"!"
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
name|host
operator|=
name|UucpChan
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|addr
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
break|break;
else|#
directive|else
else|MF
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"  %s!%s: %s\n"
argument_list|,
name|lp
operator|->
name|m_host
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|,
literal|"not supported; UUCP address"
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return;
endif|#
directive|endif
endif|MF
default|default:
comment|/* let MMDF decide if the host is bad */
name|mbox
operator|=
name|lp
operator|->
name|m_mbox
expr_stmt|;
name|host
operator|=
name|lp
operator|->
name|m_host
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|addr
argument_list|,
literal|"%s at %s"
argument_list|,
name|mbox
argument_list|,
name|host
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|TMA
if|if
condition|(
operator|(
operator|!
name|whomsw
operator|||
name|checksw
operator|)
operator|&&
name|tma
operator|&&
name|seekaddr
argument_list|(
name|mbox
argument_list|,
name|host
argument_list|,
name|reason
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"  %s%s: %s\n"
argument_list|,
name|addr
argument_list|,
literal|"[TMA]"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
endif|TMA
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"  %s%s"
argument_list|,
name|addr
argument_list|,
name|whomsw
operator|&&
name|lp
operator|->
name|m_bcc
condition|?
literal|"[BCC]"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|whomsw
operator|&&
operator|!
name|checksw
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|": "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
comment|/*
comment|*/
ifdef|#
directive|ifdef
name|MMDFII
if|if
condition|(
name|lp
operator|->
name|m_path
condition|)
name|path
operator|=
name|concat
argument_list|(
name|lp
operator|->
name|m_path
argument_list|,
name|mbox
argument_list|,
literal|"@"
argument_list|,
name|host
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
endif|MMDFII
name|path
operator|=
name|NULLCP
expr_stmt|;
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_wadr
argument_list|(
name|path
condition|?
name|NULLCP
else|:
name|host
argument_list|,
name|path
condition|?
name|path
else|:
name|mbox
argument_list|)
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|retval
operator|=
name|mm_rrply
argument_list|(
operator|&
name|reply
argument_list|,
operator|&
name|len
argument_list|)
argument_list|)
condition|)
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"problem submitting address [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rp_gval
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
condition|)
block|{
case|case
name|RP_AOK
case|:
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"address ok\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return;
ifdef|#
directive|ifdef
name|RP_DOK
case|case
name|RP_DOK
case|:
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"nameserver timeout - queued for checking\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return;
endif|#
directive|endif
endif|RP_DOK
case|case
name|RP_NO
case|:
name|text
operator|=
literal|"you lose"
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|RP_NS
case|case
name|RP_NS
case|:
name|text
operator|=
literal|"temporary nameserver failure"
expr_stmt|;
break|break;
endif|#
directive|endif
endif|RP_NS
case|case
name|RP_USER
case|:
case|case
name|RP_NDEL
case|:
name|text
operator|=
literal|"not deliverable"
expr_stmt|;
break|break;
case|case
name|RP_AGN
case|:
name|text
operator|=
literal|"try again later"
expr_stmt|;
break|break;
case|case
name|RP_NOOP
case|:
name|text
operator|=
literal|"nothing done"
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|text
operator|=
literal|"unexpected response"
expr_stmt|;
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"%s;\n    [%s] -- %s"
argument_list|,
name|text
argument_list|,
name|rp_valstr
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"%s;\n    %s\n"
argument_list|,
name|text
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|MMDFMTS
end_endif

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|MHMTS
end_ifdef

begin_comment
comment|/* ARGSUSED */
end_comment

begin_expr_stmt
specifier|static
name|do_an_address
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|tma
argument_list|)
specifier|register
expr|struct
name|mailname
operator|*
name|lp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|talk
decl_stmt|,
name|tma
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|mbox
decl_stmt|;
name|char
name|addr
index|[
name|BUFSIZ
index|]
decl_stmt|;
switch|switch
condition|(
name|lp
operator|->
name|m_type
condition|)
block|{
case|case
name|LOCALHOST
case|:
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|addr
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
break|break;
case|case
name|UUCPHOST
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|addr
argument_list|,
literal|"%s!%s"
argument_list|,
name|lp
operator|->
name|m_host
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|addr
argument_list|,
literal|"%s at %s"
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|,
name|lp
operator|->
name|m_host
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"  %s%s"
argument_list|,
name|addr
argument_list|,
name|whomsw
operator|&&
name|lp
operator|->
name|m_bcc
condition|?
literal|"[BCC]"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|whomsw
operator|&&
operator|!
name|checksw
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|": "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
comment|/*
comment|*/
switch|switch
condition|(
name|lp
operator|->
name|m_type
condition|)
block|{
case|case
name|LOCALHOST
case|:
name|mbox
operator|=
name|lp
operator|->
name|m_mbox
expr_stmt|;
if|if
condition|(
operator|*
name|mbox
operator|==
literal|'~'
condition|)
name|mbox
operator|++
expr_stmt|;
if|if
condition|(
name|seek_home
argument_list|(
name|mbox
argument_list|)
condition|)
block|{
name|lp
operator|->
name|m_mbox
operator|=
name|mbox
expr_stmt|;
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"address ok\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"not deliverable; unknown user\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|UUCPHOST
case|:
if|if
condition|(
name|uucpsite
argument_list|(
name|lp
operator|->
name|m_host
argument_list|)
operator|==
name|OK
condition|)
block|{
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"address ok\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"not deliverable; unknown system\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|NETHOST
case|:
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"address ok\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"not deliverable; unknown host\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|MHMTS
end_endif

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SENDMTS
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|TMA
end_ifndef

begin_comment
comment|/* ARGSUSED */
end_comment

begin_endif
endif|#
directive|endif
endif|TMA
end_endif

begin_expr_stmt
specifier|static
name|do_an_address
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|tma
argument_list|)
specifier|register
expr|struct
name|mailname
operator|*
name|lp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|talk
decl_stmt|,
name|tma
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|retval
decl_stmt|;
specifier|register
name|char
modifier|*
name|mbox
decl_stmt|,
modifier|*
name|host
decl_stmt|;
name|char
name|addr
index|[
name|BUFSIZ
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|TMA
name|char
name|reason
index|[
name|BUFSIZ
index|]
decl_stmt|;
endif|#
directive|endif
endif|TMA
switch|switch
condition|(
name|lp
operator|->
name|m_type
condition|)
block|{
case|case
name|LOCALHOST
case|:
name|mbox
operator|=
name|lp
operator|->
name|m_mbox
expr_stmt|;
name|host
operator|=
name|lp
operator|->
name|m_host
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|addr
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
break|break;
case|case
name|UUCPHOST
case|:
name|mbox
operator|=
name|auxformat
argument_list|(
name|lp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|host
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|addr
argument_list|,
literal|"%s!%s"
argument_list|,
name|lp
operator|->
name|m_host
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* let SendMail decide if the host is bad  */
name|mbox
operator|=
name|lp
operator|->
name|m_mbox
expr_stmt|;
name|host
operator|=
name|lp
operator|->
name|m_host
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|addr
argument_list|,
literal|"%s at %s"
argument_list|,
name|mbox
argument_list|,
name|host
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|TMA
if|if
condition|(
operator|(
operator|!
name|whomsw
operator|||
name|checksw
operator|)
operator|&&
name|tma
operator|&&
name|seekaddr
argument_list|(
name|mbox
argument_list|,
name|host
argument_list|,
name|reason
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"  %s%s: %s\n"
argument_list|,
name|addr
argument_list|,
literal|"[TMA]"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
endif|TMA
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"  %s%s"
argument_list|,
name|addr
argument_list|,
name|whomsw
operator|&&
name|lp
operator|->
name|m_bcc
condition|?
literal|"[BCC]"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|whomsw
operator|&&
operator|!
name|checksw
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|": "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
comment|/*
comment|*/
switch|switch
condition|(
name|retval
operator|=
name|sm_wadr
argument_list|(
name|mbox
argument_list|,
name|host
argument_list|,
name|lp
operator|->
name|m_type
operator|!=
name|UUCPHOST
condition|?
name|lp
operator|->
name|m_path
else|:
name|NULLCP
argument_list|)
condition|)
block|{
case|case
name|RP_OK
case|:
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"address ok\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RP_NO
case|:
case|case
name|RP_USER
case|:
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"loses; %s\n"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|die
argument_list|(
name|NULLCP
argument_list|,
literal|"unexpected response; %s"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|SENDMTS
end_endif

begin_comment
comment|/*
comment|SIGNAL HANDLING */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|MHMTS
end_ifndef

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|sigser
parameter_list|(
name|i
parameter_list|)
name|int
name|i
decl_stmt|;
block|{
ifndef|#
directive|ifndef
name|BSD42
operator|(
name|void
operator|)
name|signal
argument_list|(
name|i
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|not BSD42
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgflags
operator|&
name|MINV
condition|)
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|bccfil
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MMDFMTS
if|if
condition|(
operator|!
name|whomsw
operator|||
name|checksw
condition|)
operator|(
name|void
operator|)
name|mm_end
argument_list|(
name|NOTOK
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
if|if
condition|(
operator|!
name|whomsw
operator|||
name|checksw
condition|)
operator|(
name|void
operator|)
name|sm_end
argument_list|(
name|NOTOK
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
endif|not MHMTS
end_endif

begin_expr_stmt
specifier|static
name|sigon
argument_list|()
block|{
if|if
condition|(
name|debug
condition|)
return|return;
ifndef|#
directive|ifndef
name|MHMTS
name|setsigx
argument_list|(
name|hstat
argument_list|,
name|SIGHUP
argument_list|,
name|sigser
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|setsigx
argument_list|(
name|istat
argument_list|,
name|SIGINT
argument_list|,
name|sigser
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|setsigx
argument_list|(
name|qstat
argument_list|,
name|SIGQUIT
argument_list|,
name|sigser
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|setsigx
argument_list|(
name|tstat
argument_list|,
name|SIGTERM
argument_list|,
name|sigser
argument_list|)
expr_stmt|;
end_expr_stmt

begin_else
else|#
directive|else
else|MHMTS
end_else

begin_expr_stmt
name|setsigx
argument_list|(
name|hstat
argument_list|,
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|setsigx
argument_list|(
name|istat
argument_list|,
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|setsigx
argument_list|(
name|qstat
argument_list|,
name|SIGQUIT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|setsigx
argument_list|(
name|tstat
argument_list|,
name|SIGTERM
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
endif|MHMTS
end_endif

begin_macro
unit|}   static
name|sigoff
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|debug
condition|)
return|return;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|hstat
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|istat
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|qstat
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|tstat
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|FCC INTERACTION */
end_comment

begin_expr_stmt
specifier|static
name|refile
argument_list|(
name|file
argument_list|)
specifier|register
name|char
operator|*
name|file
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|fccind
operator|==
literal|0
condition|)
return|return;
ifdef|#
directive|ifdef
name|MHMTS
operator|(
name|void
operator|)
name|setuid
argument_list|(
name|myuid
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|" -- Filing Folder Copies --\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fccind
condition|;
name|i
operator|++
control|)
name|fcc
argument_list|(
name|file
argument_list|,
name|fccfold
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|" -- Folder Copies Filed --\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|fcc
argument_list|(
name|file
argument_list|,
name|folder
argument_list|)
specifier|register
name|char
operator|*
name|file
operator|,
operator|*
name|folder
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|child_id
decl_stmt|,
name|status
decl_stmt|;
name|char
name|fold
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"  %sFcc %s: "
argument_list|,
name|msgstate
operator|==
name|RESENT
condition|?
literal|"Resent-"
else|:
literal|""
argument_list|,
name|folder
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|child_id
operator|=
name|fork
argument_list|()
operator|)
operator|==
name|NOTOK
operator|&&
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|child_id
condition|)
block|{
case|case
name|NOTOK
case|:
if|if
condition|(
operator|!
name|verbose
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %sFcc %s: "
argument_list|,
name|msgstate
operator|==
name|RESENT
condition|?
literal|"Resent-"
else|:
literal|""
argument_list|,
name|folder
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|verbose
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"no forks, so not ok\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|OK
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|fold
argument_list|,
literal|"%s%s"
argument_list|,
operator|*
name|folder
operator|==
literal|'+'
operator|||
operator|*
name|folder
operator|==
literal|'@'
condition|?
literal|""
else|:
literal|"+"
argument_list|,
name|folder
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
name|fileproc
argument_list|,
name|r1bindex
argument_list|(
name|fileproc
argument_list|,
literal|'/'
argument_list|)
argument_list|,
literal|"-link"
argument_list|,
literal|"-file"
argument_list|,
name|file
argument_list|,
name|fold
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
default|default:
if|if
condition|(
name|status
operator|=
name|pidwait
argument_list|(
name|child_id
argument_list|,
name|OK
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|verbose
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %sFcc %s: "
argument_list|,
name|msgstate
operator|==
name|RESENT
condition|?
literal|"Resent-"
else|:
literal|""
argument_list|,
name|folder
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|pidstatus
argument_list|(
name|status
argument_list|,
name|verbose
condition|?
name|stdout
else|:
name|stderr
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"folder ok\n"
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|TERMINATION */
end_comment

begin_comment
comment|/* VARARGS2 */
end_comment

begin_expr_stmt
specifier|static
name|die
argument_list|(
argument|what
argument_list|,
argument|fmt
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|,
argument|d
argument_list|)
name|char
operator|*
name|what
operator|,
operator|*
name|fmt
operator|,
operator|*
name|a
operator|,
operator|*
name|b
operator|,
operator|*
name|c
operator|,
operator|*
name|d
expr_stmt|;
end_expr_stmt

begin_block
block|{
ifndef|#
directive|ifndef
name|MHMTS
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgflags
operator|&
name|MINV
condition|)
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|bccfil
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MHMTS
ifdef|#
directive|ifdef
name|MMDFMTS
if|if
condition|(
operator|!
name|whomsw
operator|||
name|checksw
condition|)
operator|(
name|void
operator|)
name|mm_end
argument_list|(
name|NOTOK
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MMDFMTS
ifdef|#
directive|ifdef
name|SENDMTS
if|if
condition|(
operator|!
name|whomsw
operator|||
name|checksw
condition|)
operator|(
name|void
operator|)
name|sm_end
argument_list|(
name|NOTOK
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SENDMTS
name|adios
argument_list|(
name|what
argument_list|,
name|fmt
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|)
expr_stmt|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|MMDFMTS
end_ifdef

begin_comment
comment|/*   *    err_abrt() is used by the mm_ routines  *    		 do not, under *ANY* circumstances, remove it from post,  *		 or you will lose *BIG*  */
end_comment

begin_macro
name|err_abrt
argument_list|(
argument|code
argument_list|,
argument|fmt
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|int
name|code
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fmt
decl_stmt|,
modifier|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|,
modifier|*
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|code
argument_list|)
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|buffer
argument_list|,
name|fmt
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|MMDFMTS
end_endif

begin_comment
comment|/*
comment|STAND-ALONE DELIVERY */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|MHMTS
end_ifdef

begin_comment
comment|/* BUG: MHMTS ignores 822-style route addresses... */
end_comment

begin_expr_stmt
specifier|static
name|localmail
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|fd
argument_list|)
specifier|register
expr|struct
name|mailname
operator|*
name|lp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|talk
decl_stmt|,
name|fd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|md
decl_stmt|;
name|char
name|mailbox
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|ddate
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|struct
name|home
modifier|*
name|hp
decl_stmt|;
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"  %s: "
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hp
operator|=
name|seek_home
argument_list|(
name|lp
operator|->
name|m_mbox
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"not deliverable; unknown address\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|mailbox
argument_list|,
literal|"%s/%s"
argument_list|,
name|mmdfldir
index|[
literal|0
index|]
condition|?
name|mmdfldir
else|:
name|hp
operator|->
name|h_home
argument_list|,
name|mmdflfil
index|[
literal|0
index|]
condition|?
name|mmdflfil
else|:
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
comment|/*
comment|*/
switch|switch
condition|(
name|access
argument_list|(
name|slocalproc
argument_list|,
literal|01
argument_list|)
condition|)
block|{
default|default:
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"(invoking hook)\n\t"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|usr_hook
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|fd
argument_list|,
name|hp
argument_list|,
name|mailbox
argument_list|)
operator|!=
name|NOTOK
condition|)
return|return;
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"  %s: "
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
case|case
name|NOTOK
case|:
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|md
operator|=
name|mbx_open
argument_list|(
name|mailbox
argument_list|,
name|hp
operator|->
name|h_uid
argument_list|,
name|hp
operator|->
name|h_gid
argument_list|,
name|m_gmprot
argument_list|()
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"error in transmission; unable to open maildrop\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|ddate
argument_list|,
literal|"Delivery-Date: %s\n"
argument_list|,
name|dtimenow
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbx_copy
argument_list|(
name|mailbox
argument_list|,
name|md
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|,
name|ddate
argument_list|,
literal|0
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"error in transmission; write to maildrop failed\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|md
argument_list|)
expr_stmt|;
return|return;
block|}
name|mbx_close
argument_list|(
name|mailbox
argument_list|,
name|md
argument_list|)
expr_stmt|;
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"sent\n"
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|usr_hook
parameter_list|(
name|lp
parameter_list|,
name|talk
parameter_list|,
name|fd
parameter_list|,
name|hp
parameter_list|,
name|mailbox
parameter_list|)
specifier|register
name|struct
name|mailname
modifier|*
name|lp
decl_stmt|;
name|int
name|talk
decl_stmt|,
name|fd
decl_stmt|;
specifier|register
name|struct
name|home
modifier|*
name|hp
decl_stmt|;
specifier|register
name|char
modifier|*
name|mailbox
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|child_id
decl_stmt|,
name|status
decl_stmt|;
name|char
name|tmpfil
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|copyfile
argument_list|(
name|fd
argument_list|,
name|tmpfil
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"unable to copy message; skipping hook\n"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
operator|(
name|void
operator|)
name|chown
argument_list|(
name|tmpfil
argument_list|,
name|hp
operator|->
name|h_uid
argument_list|,
name|hp
operator|->
name|h_gid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|child_id
operator|=
name|fork
argument_list|()
operator|)
operator|==
name|NOTOK
operator|&&
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|child_id
condition|)
block|{
case|case
name|NOTOK
case|:
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"unable to invoke hook; fork() failed\n"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
case|case
name|OK
case|:
if|if
condition|(
name|fd
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|dup2
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|freopen
argument_list|(
literal|"/dev/null"
argument_list|,
literal|"w"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|freopen
argument_list|(
literal|"/dev/null"
argument_list|,
literal|"w"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|!=
literal|3
condition|)
comment|/* backwards compatible... */
operator|(
name|void
operator|)
name|dup2
argument_list|(
name|fd
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|closefds
argument_list|(
literal|4
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIOCNOTTY
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
literal|"/dev/tty"
argument_list|,
literal|2
argument_list|)
operator|)
operator|!=
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|TIOCNOTTY
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|TIOCNOTTY
ifdef|#
directive|ifdef
name|BSD42
operator|(
name|void
operator|)
name|setpgrp
argument_list|(
literal|0
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD42
operator|*
name|environ
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"USER"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"HOME"
argument_list|,
name|hp
operator|->
name|h_home
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"SHELL"
argument_list|,
name|hp
operator|->
name|h_shell
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|hp
operator|->
name|h_home
argument_list|)
operator|==
name|NOTOK
condition|)
operator|(
name|void
operator|)
name|chdir
argument_list|(
literal|"/"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|umask
argument_list|(
literal|0077
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD41A
operator|(
name|void
operator|)
name|inigrp
argument_list|(
name|hp
operator|->
name|h_name
argument_list|,
name|hp
operator|->
name|h_gid
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD41A
operator|(
name|void
operator|)
name|setgid
argument_list|(
name|hp
operator|->
name|h_gid
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD42
operator|(
name|void
operator|)
name|initgroups
argument_list|(
name|hp
operator|->
name|h_name
argument_list|,
name|hp
operator|->
name|h_gid
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD42
operator|(
name|void
operator|)
name|setuid
argument_list|(
name|hp
operator|->
name|h_uid
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
name|slocalproc
argument_list|,
name|r1bindex
argument_list|(
name|slocalproc
argument_list|,
literal|'/'
argument_list|)
argument_list|,
literal|"-file"
argument_list|,
name|tmpfil
argument_list|,
literal|"-mailbox"
argument_list|,
name|mailbox
argument_list|,
literal|"-home"
argument_list|,
name|hp
operator|->
name|h_home
argument_list|,
literal|"-addr"
argument_list|,
name|lp
operator|->
name|m_aka
argument_list|,
literal|"-user"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|,
literal|"-sender"
argument_list|,
name|from
argument_list|,
name|talk
condition|?
literal|"-verbose"
else|:
name|NULLCP
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/*
comment|*/
default|default:
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|status
operator|=
name|pidwait
argument_list|(
name|child_id
argument_list|,
name|OK
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"accepted\n"
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"%s error on hook; status=0%o\n"
argument_list|,
name|status
operator|&
literal|0x00ff
condition|?
literal|"system"
else|:
literal|"user"
argument_list|,
name|status
operator|&
literal|0x00ff
condition|?
name|status
operator|&
literal|0xff
else|:
operator|(
name|status
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|copyfile
parameter_list|(
name|qd
parameter_list|,
name|tmpfil
parameter_list|)
name|int
name|qd
decl_stmt|;
specifier|register
name|char
modifier|*
name|tmpfil
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|fd
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
name|m_tmpfil
argument_list|(
literal|"hook"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|creat
argument_list|(
name|tmpfil
argument_list|,
literal|0600
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|tmpfil
argument_list|,
literal|2
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|qd
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|read
argument_list|(
name|qd
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|)
operator|)
operator|>
literal|0
condition|)
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|buffer
argument_list|,
name|i
argument_list|)
operator|!=
name|i
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|i
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|uucpmail
argument_list|(
name|lp
argument_list|,
name|talk
argument_list|,
name|fd
argument_list|,
name|from
argument_list|)
specifier|register
expr|struct
name|mailname
operator|*
name|lp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|talk
decl_stmt|,
name|fd
decl_stmt|,
name|from
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|int
function_decl|(
modifier|*
name|pstat
function_decl|)
parameter_list|()
function_decl|;
name|char
name|addr
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|addr
argument_list|,
literal|"%s!%s"
argument_list|,
name|lp
operator|->
name|m_host
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|UCI
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"uux -r -p %s!rmail \\(%s\\)"
argument_list|,
name|lp
operator|->
name|m_host
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
else|#
directive|else
else|UCI
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"uux -p %s!rmail \\(%s\\)"
argument_list|,
name|lp
operator|->
name|m_host
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|UCI
if|if
condition|(
operator|(
name|fp
operator|=
name|popen
argument_list|(
name|buffer
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"unable to start uux; popen() failed\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
return|return;
block|}
name|pstat
operator|=
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|from
condition|)
block|{
comment|/* no mail filtering, so... */
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"From %s %.24s remote from %s\n"
argument_list|,
name|getusr
argument_list|()
argument_list|,
name|ctime
argument_list|(
operator|&
name|clock
argument_list|)
argument_list|,
name|SystemName
argument_list|()
argument_list|)
expr_stmt|;
name|i
operator|=
name|strlen
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwrite
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
expr|*
name|buffer
argument_list|,
name|i
argument_list|,
name|fp
argument_list|)
operator|!=
name|i
condition|)
goto|goto
name|oops
goto|;
block|}
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|)
operator|)
operator|>
literal|0
condition|)
if|if
condition|(
name|fwrite
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
expr|*
name|buffer
argument_list|,
name|i
argument_list|,
name|fp
argument_list|)
operator|!=
name|i
condition|)
block|{
name|oops
label|:
empty_stmt|;
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"error in transmission; write to uux failed\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|pclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pclose
argument_list|(
name|fp
argument_list|)
condition|)
goto|goto
name|oops
goto|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|pstat
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|talk
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s: "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|talk
condition|?
name|stdout
else|:
name|stderr
argument_list|,
literal|"error in transmission; read failed\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|++
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"queued (via uux)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|MF
end_ifdef

begin_function
specifier|static
name|int
name|make_uucp_file
parameter_list|(
name|td
parameter_list|)
name|int
name|td
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|qd
decl_stmt|,
name|fd
decl_stmt|;
name|char
name|tmpfil
index|[
name|BUFSIZ
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|td
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|qd
operator|=
name|dup
argument_list|(
name|td
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
literal|"fd"
argument_list|,
literal|"unable to dup"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
name|m_tmpfil
argument_list|(
literal|"uumf"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|creat
argument_list|(
name|tmpfil
argument_list|,
literal|0600
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|tmpfil
argument_list|,
literal|"unable to create"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|tmpfil
argument_list|,
literal|2
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|tmpfil
argument_list|,
literal|"unable to re-open"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
operator|=
name|mmdf2uucp
argument_list|(
name|qd
argument_list|,
name|fd
argument_list|,
literal|1
argument_list|)
condition|)
block|{
case|case
name|OK
case|:
if|if
condition|(
operator|!
name|debug
condition|)
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to filter mail(%d), examine %s"
argument_list|,
name|i
argument_list|,
name|tmpfil
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|qd
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
endif|MF
end_endif

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|netmail
argument_list|(
argument|talk
argument_list|,
argument|fd
argument_list|,
argument|bccque
argument_list|)
name|int
name|talk
operator|,
name|fd
operator|,
name|bccque
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|naddrs
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|struct
name|mailname
modifier|*
name|lp
decl_stmt|;
name|naddrs
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|nm_init
argument_list|(
name|getusr
argument_list|()
argument_list|,
operator|&
name|clock
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
for|for
control|(
name|lp
operator|=
name|netaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
if|if
condition|(
name|lp
operator|->
name|m_bcc
condition|?
name|bccque
else|:
operator|!
name|bccque
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s at %s: unable to get queue file\n"
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|,
name|lp
operator|->
name|m_host
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|lp
operator|=
name|netaddrs
operator|.
name|m_next
init|;
name|lp
condition|;
name|lp
operator|=
name|lp
operator|->
name|m_next
control|)
if|if
condition|(
name|lp
operator|->
name|m_bcc
condition|?
name|bccque
else|:
operator|!
name|bccque
condition|)
block|{
operator|(
name|void
operator|)
name|nm_wadr
argument_list|(
name|lp
operator|->
name|m_mbox
argument_list|,
name|lp
operator|->
name|m_host
argument_list|)
expr_stmt|;
name|naddrs
operator|++
expr_stmt|;
if|if
condition|(
name|talk
condition|)
name|printf
argument_list|(
literal|"  %s at %s: queued\n"
argument_list|,
name|lp
operator|->
name|m_mbox
argument_list|,
name|lp
operator|->
name|m_host
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
name|nm_waend
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|)
operator|)
operator|>
literal|0
condition|)
if|if
condition|(
name|nm_wtxt
argument_list|(
name|buffer
argument_list|,
name|i
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error in transmission; write to temporary failed"
argument_list|)
expr_stmt|;
name|unkadr
operator|+=
name|naddrs
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error in transmission; read failed\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|+=
name|naddrs
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|nm_wtend
argument_list|()
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error in transmission; unable to queue message\n"
argument_list|)
expr_stmt|;
name|unkadr
operator|+=
name|naddrs
expr_stmt|;
return|return;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
endif|MHMTS
end_endif

end_unit


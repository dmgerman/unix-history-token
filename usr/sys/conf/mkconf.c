begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|CHAR
value|01
end_define

begin_define
define|#
directive|define
name|BLOCK
value|02
end_define

begin_define
define|#
directive|define
name|INTR
value|04
end_define

begin_define
define|#
directive|define
name|EVEN
value|010
end_define

begin_define
define|#
directive|define
name|KL
value|020
end_define

begin_decl_stmt
name|int
name|tabp
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tabpp
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|tab
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|address
decl_stmt|;
name|int
name|key
decl_stmt|;
name|char
modifier|*
name|codea
decl_stmt|;
name|char
modifier|*
name|codeb
decl_stmt|;
name|char
modifier|*
name|codec
decl_stmt|;
name|char
modifier|*
name|coded
decl_stmt|;
name|char
modifier|*
name|codee
decl_stmt|;
block|}
name|table
index|[]
block|{
literal|"console"
operator|,
operator|-
literal|1
operator|,
literal|60
operator|,
name|CHAR
operator|+
name|INTR
operator|+
name|KL
operator|,
literal|"\tklin; br4\n\tklou; br4\n"
operator|,
literal|".globl\t_klrint\nklin:\tjsr\tr0,call; _klrint\n"
operator|,
literal|".globl\t_klxint\nklou:\tjsr\tr0,call; _klxint\n"
operator|,
literal|""
operator|,
literal|"\t&klopen,&klclose,&klread,&klwrite,&klsgtty,"
operator|,
literal|"mem"
operator|,
operator|-
literal|1
operator|,
literal|300
operator|,
name|CHAR
operator|,
literal|""
operator|,
literal|""
operator|,
literal|""
operator|,
literal|""
operator|,
literal|"\t&nulldev,&nulldev,&mmread,&mmwrite,&nodev,"
operator|,
literal|"pc"
operator|,
literal|0
operator|,
literal|70
operator|,
name|CHAR
operator|+
name|INTR
operator|,
literal|"\tpcin; br4\n\tpcou; br4\n"
operator|,
literal|".globl\t_pcrint\npcin:\tjsr\tr0,call; _pcrint\n"
operator|,
literal|".globl\t_pcpint\npcou:\tjsr\tr0,call; _pcpint\n"
operator|,
literal|""
operator|,
literal|"\t&pcopen,&pcclose,&pcread,&pcwrite,&nodev,"
operator|,
literal|"clock"
operator|,
operator|-
literal|2
operator|,
literal|100
operator|,
name|INTR
operator|,
literal|"\tkwlp; br6\n"
operator|,
literal|".globl\t_clock\n"
operator|,
literal|"kwlp:\tjsr\tr0,call; _clock\n"
operator|,
literal|""
operator|,
literal|""
operator|,
comment|/*  * 110 unused  * 114 memory parity  * 120 XY plotter  * 124 DR11-B  * 130 AD01  * 134 AFC11  * 140 AA11  * 144 AA11  * 150-174 unused  */
literal|"lp"
operator|,
literal|0
operator|,
literal|200
operator|,
name|CHAR
operator|+
name|INTR
operator|,
literal|"\tlpou; br4\n"
operator|,
literal|""
operator|,
literal|".globl\t_lpint\nlpou:\tjsr\tr0,call; _lpint\n"
operator|,
literal|""
operator|,
literal|"\t&lpopen,&lpclose,&nodev,&lpwrite,&nodev,"
operator|,
literal|"rf"
operator|,
literal|0
operator|,
literal|204
operator|,
name|BLOCK
operator|+
name|CHAR
operator|+
name|INTR
operator|,
literal|"\trfio; br5\n"
operator|,
literal|".globl\t_rfintr\n"
operator|,
literal|"rfio:\tjsr\tr0,call; _rfintr\n"
operator|,
literal|"\t&nulldev,\t&nulldev,\t&rfstrategy, \t&rftab,"
operator|,
literal|"\t&nulldev,&nulldev,&rfread,&rfwrite,&nodev,"
operator|,
comment|/*  * 210 RC  */
literal|"tc"
operator|,
literal|0
operator|,
literal|214
operator|,
name|BLOCK
operator|+
name|INTR
operator|,
literal|"\ttcio; br6\n"
operator|,
literal|".globl\t_tcintr\n"
operator|,
literal|"tcio:\tjsr\tr0,call; _tcintr\n"
operator|,
literal|"\t&nulldev,\t&tcclose,\t&tcstrategy, \t&tctab,"
operator|,
literal|""
operator|,
literal|"rk"
operator|,
literal|0
operator|,
literal|220
operator|,
name|BLOCK
operator|+
name|CHAR
operator|+
name|INTR
operator|,
literal|"\trkio; br5\n"
operator|,
literal|".globl\t_rkintr\n"
operator|,
literal|"rkio:\tjsr\tr0,call; _rkintr\n"
operator|,
literal|"\t&nulldev,\t&nulldev,\t&rkstrategy, \t&rktab,"
operator|,
literal|"\t&nulldev,&nulldev,&rkread,&rkwrite,&nodev,"
operator|,
literal|"tm"
operator|,
literal|0
operator|,
literal|224
operator|,
name|BLOCK
operator|+
name|CHAR
operator|+
name|INTR
operator|,
literal|"\ttmio; br5\n"
operator|,
literal|".globl\t_tmintr\n"
operator|,
literal|"tmio:\tjsr\tr0,call; _tmintr\n"
operator|,
literal|"\t&tmopen,\t&tmclose,\t&tmstrategy, \t&tmtab,"
operator|,
literal|"\t&tmopen,&tmclose,&tmread,&tmwrite,&nodev,"
operator|,
literal|"cr"
operator|,
literal|0
operator|,
literal|230
operator|,
name|CHAR
operator|+
name|INTR
operator|,
literal|"\tcrin; br6\n"
operator|,
literal|""
operator|,
literal|".globl\t_crint\ncrin:\tjsr\tr0,call; _crint\n"
operator|,
literal|""
operator|,
literal|"\t&cropen,&crclose,&crread,&nodev,&nodev,"
operator|,
comment|/*  * 234 UDC11  */
literal|"rp"
operator|,
literal|0
operator|,
literal|254
operator|,
name|BLOCK
operator|+
name|CHAR
operator|+
name|INTR
operator|,
literal|"\trpio; br5\n"
operator|,
literal|".globl\t_rpintr\n"
operator|,
literal|"rpio:\tjsr\tr0,call; _rpintr\n"
operator|,
literal|"\t&nulldev,\t&nulldev,\t&rpstrategy, \t&rptab,"
operator|,
literal|"\t&nulldev,&nulldev,&rpread,&rpwrite,&nodev,"
operator|,
comment|/*  * 260 TA11  * 264-274 unused  */
literal|"dc"
operator|,
literal|0
operator|,
literal|308
operator|,
name|CHAR
operator|+
name|INTR
operator|,
literal|"\tdcin; br5+%d.\n\tdcou; br5+%d.\n"
operator|,
literal|".globl\t_dcrint\ndcin:\tjsr\tr0,call; _dcrint\n"
operator|,
literal|".globl\t_dcxint\ndcou:\tjsr\tr0,call; _dcxint\n"
operator|,
literal|""
operator|,
literal|"\t&dcopen,&dcclose,&dcread,&dcwrite,&dcsgtty,"
operator|,
literal|"kl"
operator|,
literal|0
operator|,
literal|308
operator|,
name|INTR
operator|+
name|KL
operator|,
literal|"\tklin; br4+%d.\n\tklou; br4+%d.\n"
operator|,
literal|""
operator|,
literal|""
operator|,
literal|""
operator|,
literal|""
operator|,
literal|"dp"
operator|,
literal|0
operator|,
literal|308
operator|,
name|CHAR
operator|+
name|INTR
operator|,
literal|"\tdpin; br6+%d.\n\tdpou; br6+%d.\n"
operator|,
literal|".globl\t_dprint\ndpin:\tjsr\tr0,call; _dprint\n"
operator|,
literal|".globl\t_dpxint\ndpou:\tjsr\tr0,call; _dpxint\n"
operator|,
literal|""
operator|,
literal|"\t&dpopen,&dpclose,&dpread,&dpwrite,&nodev,"
operator|,
comment|/*  * DM11-A  */
literal|"dn"
operator|,
literal|0
operator|,
literal|304
operator|,
name|CHAR
operator|+
name|INTR
operator|,
literal|"\tdnou; br5+%d.\n"
operator|,
literal|""
operator|,
literal|".globl\t_dnint\ndnou:\tjsr\tr0,call; _dnint\n"
operator|,
literal|""
operator|,
literal|"\t&dnopen,&dnclose,&nodev,&dnwrite,&nodev,"
operator|,
literal|"dhdm"
operator|,
literal|0
operator|,
literal|304
operator|,
name|INTR
operator|,
literal|"\tdmin; br4+%d.\n"
operator|,
literal|""
operator|,
literal|".globl\t_dmint\ndmin:\tjsr\tr0,call; _dmint\n"
operator|,
literal|""
operator|,
literal|""
operator|,
comment|/*  * DR11-A+  * DR11-C+  * PA611+  * PA611+  * DT11+  * DX11+  */
literal|"dl"
operator|,
literal|0
operator|,
literal|308
operator|,
name|INTR
operator|+
name|KL
operator|,
literal|"\tklin; br4+%d.\n\tklou; br4+%d.\n"
operator|,
literal|""
operator|,
literal|""
operator|,
literal|""
operator|,
literal|""
operator|,
comment|/*  * DJ11  */
literal|"dh"
operator|,
literal|0
operator|,
literal|308
operator|,
name|CHAR
operator|+
name|INTR
operator|+
name|EVEN
operator|,
literal|"\tdhin; br5+%d.\n\tdhou; br5+%d.\n"
operator|,
literal|".globl\t_dhrint\ndhin:\tjsr\tr0,call; _dhrint\n"
operator|,
literal|".globl\t_dhxint\ndhou:\tjsr\tr0,call; _dhxint\n"
operator|,
literal|""
operator|,
literal|"\t&dhopen,&dhclose,&dhread,&dhwrite,&dhsgtty,"
operator|,
comment|/*  * GT40  * LPS+  * VT20  */
literal|0
block|}
struct|;
end_struct

begin_decl_stmt
name|char
modifier|*
name|stra
index|[]
block|{
literal|"/ Copyright 1974 Bell Telephone Laboratories Inc"
operator|,
literal|"/ low core"
operator|,
literal|""
operator|,
literal|"br4 = 200"
operator|,
literal|"br5 = 240"
operator|,
literal|"br6 = 300"
operator|,
literal|"br7 = 340"
operator|,
literal|""
operator|,
literal|". = 0^."
operator|,
literal|"\tbr\t1f"
operator|,
literal|"\t4"
operator|,
literal|""
operator|,
literal|"/ trap vectors"
operator|,
literal|"\ttrap; br7+0.\t\t/ bus error"
operator|,
literal|"\ttrap; br7+1.\t\t/ illegal instruction"
operator|,
literal|"\ttrap; br7+2.\t\t/ bpt-trace trap"
operator|,
literal|"\ttrap; br7+3.\t\t/ iot trap"
operator|,
literal|"\ttrap; br7+4.\t\t/ power fail"
operator|,
literal|"\ttrap; br7+5.\t\t/ emulator trap"
operator|,
literal|"\ttrap; br7+6.\t\t/ system entry"
operator|,
literal|""
operator|,
literal|". = 40^."
operator|,
literal|".globl\tstart, dump"
operator|,
literal|"1:\tjmp\tstart"
operator|,
literal|"\tjmp\tdump"
operator|,
literal|""
operator|,
literal|0
operator|,
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|char
modifier|*
name|strb
index|[]
block|{
literal|""
operator|,
literal|". = 240^."
operator|,
literal|"\ttrap; br7+7.\t\t/ programmed interrupt"
operator|,
literal|"\ttrap; br7+8.\t\t/ floating point"
operator|,
literal|"\ttrap; br7+9.\t\t/ segmentation violation"
operator|,
literal|0
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|char
modifier|*
name|strc
index|[]
block|{
literal|""
operator|,
literal|"/ floating vectors"
operator|,
literal|". = 300^."
operator|,
literal|0
operator|,
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|char
modifier|*
name|strd
index|[]
block|{
literal|""
operator|,
literal|"//////////////////////////////////////////////////////"
operator|,
literal|"/\t\tinterface code to C"
operator|,
literal|"//////////////////////////////////////////////////////"
operator|,
literal|""
operator|,
literal|".globl\tcall, trap"
operator|,
literal|0
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|char
modifier|*
name|stre
index|[]
block|{
literal|"/*"
operator|,
literal|" *\tCopyright 1974 Bell Telephone Laboratories Inc"
operator|,
literal|" */"
operator|,
literal|""
operator|,
literal|"int\t(*bdevsw[])()"
operator|,
literal|"{"
operator|,
literal|0
operator|,
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|char
modifier|*
name|strf
index|[]
block|{
literal|"\t0"
operator|,
literal|"};"
operator|,
literal|""
operator|,
literal|"int\t(*cdevsw[])()"
operator|,
literal|"{"
operator|,
literal|0
operator|,
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|char
modifier|*
name|strg
index|[]
block|{
literal|"\t0"
operator|,
literal|"};"
operator|,
literal|""
operator|,
literal|"int\trootdev\t{(0<<8)|0};"
operator|,
literal|"int\tswapdev\t{(0<<8)|0};"
operator|,
literal|"int\tswplo\t4000;"
operator|,
literal|"int\tnswap\t872;"
operator|,
literal|0
operator|,
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|fout
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|()
block|{
specifier|register
name|struct
name|tab
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
name|ev
decl_stmt|,
name|nkl
decl_stmt|;
name|int
name|flagf
decl_stmt|,
name|flagb
decl_stmt|;
name|tabp
index|[
name|tabpp
operator|++
index|]
operator|=
name|table
expr_stmt|;
name|tabp
index|[
name|tabpp
operator|++
index|]
operator|=
name|table
operator|+
literal|1
expr_stmt|;
while|while
condition|(
name|input
argument_list|()
condition|)
empty_stmt|;
comment|/*  * pass1 -- create interrupt vectors  */
name|nkl
operator|=
literal|0
expr_stmt|;
name|flagf
operator|=
name|flagb
operator|=
literal|1
expr_stmt|;
name|fout
operator|=
name|creat
argument_list|(
literal|"l.s"
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
name|puke
argument_list|(
name|stra
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|table
init|;
name|p
operator|->
name|name
condition|;
name|p
operator|++
control|)
if|if
condition|(
name|p
operator|->
name|count
operator|!=
literal|0
operator|&&
name|p
operator|->
name|key
operator|&
name|INTR
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|address
operator|>
literal|240
operator|&&
name|flagb
condition|)
block|{
name|flagb
operator|=
literal|0
expr_stmt|;
name|puke
argument_list|(
name|strb
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|address
operator|>=
literal|300
condition|)
block|{
if|if
condition|(
name|flagf
condition|)
block|{
name|ev
operator|=
literal|0
expr_stmt|;
name|flagf
operator|=
literal|0
expr_stmt|;
name|puke
argument_list|(
name|strc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|key
operator|&
name|EVEN
operator|&&
name|ev
operator|&
literal|07
condition|)
block|{
name|printf
argument_list|(
literal|"\t.=.+4\n"
argument_list|)
expr_stmt|;
name|ev
operator|=
operator|+
literal|4
expr_stmt|;
block|}
name|ev
operator|=
operator|+
name|p
operator|->
name|address
operator|-
literal|300
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"\n. = %d^.\n"
argument_list|,
name|p
operator|->
name|address
argument_list|)
expr_stmt|;
name|n
operator|=
name|p
operator|->
name|count
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
name|n
operator|=
operator|-
name|n
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p
operator|->
name|key
operator|&
name|KL
condition|)
block|{
name|printf
argument_list|(
name|p
operator|->
name|codea
argument_list|,
name|nkl
argument_list|,
name|nkl
argument_list|)
expr_stmt|;
name|nkl
operator|++
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
name|p
operator|->
name|codea
argument_list|,
name|i
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flagb
condition|)
name|puke
argument_list|(
name|strb
argument_list|)
expr_stmt|;
name|puke
argument_list|(
name|strd
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|table
init|;
name|p
operator|->
name|name
condition|;
name|p
operator|++
control|)
if|if
condition|(
name|p
operator|->
name|count
operator|!=
literal|0
operator|&&
name|p
operator|->
name|key
operator|&
name|INTR
condition|)
name|printf
argument_list|(
literal|"\n%s%s"
argument_list|,
name|p
operator|->
name|codeb
argument_list|,
name|p
operator|->
name|codec
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
name|close
argument_list|(
name|fout
argument_list|)
expr_stmt|;
comment|/*  * pass 2 -- create configuration table  */
name|fout
operator|=
name|creat
argument_list|(
literal|"c.c"
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
name|puke
argument_list|(
name|stre
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|p
operator|=
name|tabp
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p
operator|->
name|key
operator|&
name|BLOCK
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|p
operator|->
name|coded
argument_list|)
expr_stmt|;
name|puke
argument_list|(
name|strf
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|p
operator|=
name|tabp
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p
operator|->
name|key
operator|&
name|CHAR
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|p
operator|->
name|codee
argument_list|)
expr_stmt|;
name|puke
argument_list|(
name|strg
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
name|close
argument_list|(
name|fout
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|puke
argument_list|(
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|c
decl_stmt|;
while|while
condition|(
name|c
operator|=
operator|*
name|s
operator|++
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|input
argument_list|()
end_macro

begin_block
block|{
name|char
name|line
index|[
literal|100
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|struct
name|tab
modifier|*
name|q
decl_stmt|;
specifier|register
name|n
expr_stmt|;
name|p
operator|=
name|line
expr_stmt|;
while|while
condition|(
operator|(
name|n
operator|=
name|getchar
argument_list|()
operator|)
operator|!=
literal|'\n'
condition|)
block|{
if|if
condition|(
name|n
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|n
operator|==
literal|' '
operator|||
name|n
operator|==
literal|'\t'
condition|)
continue|continue;
operator|*
name|p
operator|++
operator|=
name|n
expr_stmt|;
block|}
operator|*
name|p
operator|++
operator|=
literal|0
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|line
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|>=
literal|'0'
operator|&&
operator|*
name|p
operator|<=
literal|'9'
condition|)
block|{
name|n
operator|=
operator|*
literal|10
expr_stmt|;
name|n
operator|=
operator|+
operator|*
name|p
operator|++
operator|-
literal|'0'
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|==
literal|0
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
for|for
control|(
name|q
operator|=
name|table
init|;
name|q
operator|->
name|name
condition|;
name|q
operator|++
control|)
if|if
condition|(
name|equal
argument_list|(
name|q
operator|->
name|name
argument_list|,
name|p
argument_list|)
condition|)
block|{
if|if
condition|(
name|q
operator|->
name|count
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: no more, no less\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|q
operator|->
name|count
operator|=
operator|+
name|n
expr_stmt|;
if|if
condition|(
name|q
operator|->
name|address
operator|<
literal|300
operator|&&
name|q
operator|->
name|count
operator|>
literal|1
condition|)
block|{
name|q
operator|->
name|count
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"%s: only one\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
name|tabp
index|[
name|tabpp
operator|++
index|]
operator|=
name|q
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"%s: cannot find\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|equal
argument_list|(
argument|a
argument_list|,
argument|b
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|a
operator|++
operator|==
operator|*
name|b
condition|)
if|if
condition|(
operator|*
name|b
operator|++
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  RL disk driver  */
end_comment

begin_define
define|#
directive|define
name|DK_N
value|2
end_define

begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/buf.h"
end_include

begin_include
include|#
directive|include
file|"../h/dir.h"
end_include

begin_include
include|#
directive|include
file|"../h/user.h"
end_include

begin_include
include|#
directive|include
file|"../h/systm.h"
end_include

begin_define
define|#
directive|define
name|NRLBLK
value|10240
end_define

begin_define
define|#
directive|define
name|RLCYLSZ
value|10240
end_define

begin_define
define|#
directive|define
name|RLSECSZ
value|256
end_define

begin_define
define|#
directive|define
name|RESET
value|013
end_define

begin_define
define|#
directive|define
name|STAT
value|03
end_define

begin_define
define|#
directive|define
name|GETSTAT
value|04
end_define

begin_define
define|#
directive|define
name|WCOM
value|012
end_define

begin_define
define|#
directive|define
name|RCOM
value|014
end_define

begin_define
define|#
directive|define
name|SEEK
value|06
end_define

begin_define
define|#
directive|define
name|SEEKHI
value|5
end_define

begin_define
define|#
directive|define
name|SEEKLO
value|1
end_define

begin_define
define|#
directive|define
name|RDHDR
value|010
end_define

begin_define
define|#
directive|define
name|IENABLE
value|0100
end_define

begin_define
define|#
directive|define
name|CRDY
value|0200
end_define

begin_define
define|#
directive|define
name|OPI
value|02000
end_define

begin_define
define|#
directive|define
name|CRCERR
value|04000
end_define

begin_define
define|#
directive|define
name|TIMOUT
value|010000
end_define

begin_define
define|#
directive|define
name|NXM
value|020000
end_define

begin_define
define|#
directive|define
name|DE
value|040000
end_define

begin_struct
struct|struct
name|device
block|{
name|int
name|rlcs
decl_stmt|,
name|rlba
decl_stmt|,
name|rlda
decl_stmt|,
name|rlmp
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|RLADDR
value|((struct device *)0174400)
end_define

begin_define
define|#
directive|define
name|RL_CNT
value|1
end_define

begin_decl_stmt
name|struct
name|buf
name|rrlbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|buf
name|rltab
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
block|{
name|int
name|cn
index|[
literal|4
index|]
decl_stmt|;
comment|/* location of heads for each drive */
name|int
name|dn
decl_stmt|;
comment|/* drive number */
name|int
name|com
decl_stmt|;
comment|/* read or write command word */
name|int
name|chn
decl_stmt|;
comment|/* cylinder and head number */
name|unsigned
name|int
name|bleft
decl_stmt|;
comment|/* bytes left to be transferred */
name|unsigned
name|int
name|bpart
decl_stmt|;
comment|/* number of bytes transferred */
name|int
name|sn
decl_stmt|;
comment|/* sector number */
union|union
block|{
name|int
name|w
index|[
literal|2
index|]
decl_stmt|;
name|long
name|l
decl_stmt|;
block|}
name|addr
union|;
comment|/* address of memory for transfer */
block|}
name|rl
init|=
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|}
struct|;
end_struct

begin_expr_stmt
name|rlstrategy
argument_list|(
name|bp
argument_list|)
specifier|register
expr|struct
name|buf
operator|*
name|bp
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|bp
operator|->
name|b_blkno
operator|>=
name|NRLBLK
condition|)
block|{
if|if
condition|(
name|bp
operator|->
name|b_blkno
operator|==
name|NRLBLK
operator|&&
name|bp
operator|->
name|b_flags
operator|&
name|B_READ
condition|)
name|bp
operator|->
name|b_resid
operator|=
name|bp
operator|->
name|b_bcount
expr_stmt|;
else|else
block|{
name|bp
operator|->
name|b_flags
operator||=
name|B_ERROR
expr_stmt|;
name|bp
operator|->
name|b_error
operator|=
name|ENXIO
expr_stmt|;
block|}
name|iodone
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|bp
operator|->
name|av_forw
operator|=
name|NULL
expr_stmt|;
name|spl5
argument_list|()
expr_stmt|;
if|if
condition|(
name|rltab
operator|.
name|b_actf
operator|==
name|NULL
condition|)
name|rltab
operator|.
name|b_actf
operator|=
name|bp
expr_stmt|;
else|else
name|rltab
operator|.
name|b_actl
operator|->
name|av_forw
operator|=
name|bp
expr_stmt|;
name|rltab
operator|.
name|b_actl
operator|=
name|bp
expr_stmt|;
if|if
condition|(
name|rltab
operator|.
name|b_active
operator|==
name|NULL
condition|)
name|rlstart
argument_list|()
expr_stmt|;
name|spl0
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|rlstart
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
if|if
condition|(
operator|(
name|bp
operator|=
name|rltab
operator|.
name|b_actf
operator|)
operator|==
name|NULL
condition|)
return|return;
name|rltab
operator|.
name|b_active
operator|++
expr_stmt|;
name|rl
operator|.
name|dn
operator|=
name|minor
argument_list|(
name|bp
operator|->
name|b_dev
argument_list|)
expr_stmt|;
name|rl
operator|.
name|chn
operator|=
name|bp
operator|->
name|b_blkno
operator|/
literal|20
expr_stmt|;
name|rl
operator|.
name|sn
operator|=
operator|(
name|bp
operator|->
name|b_blkno
operator|%
literal|20
operator|)
operator|<<
literal|1
expr_stmt|;
name|rl
operator|.
name|bleft
operator|=
name|bp
operator|->
name|b_bcount
expr_stmt|;
name|rl
operator|.
name|addr
operator|.
name|w
index|[
literal|0
index|]
operator|=
name|bp
operator|->
name|b_xmem
operator|&
literal|3
expr_stmt|;
name|rl
operator|.
name|addr
operator|.
name|w
index|[
literal|1
index|]
operator|=
operator|(
name|int
operator|)
name|bp
operator|->
name|b_un
operator|.
name|b_addr
expr_stmt|;
name|rl
operator|.
name|com
operator|=
operator|(
name|rl
operator|.
name|dn
operator|<<
literal|8
operator|)
operator||
name|IENABLE
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|b_flags
operator|&
name|B_READ
condition|)
name|rl
operator|.
name|com
operator||=
name|RCOM
expr_stmt|;
else|else
name|rl
operator|.
name|com
operator||=
name|WCOM
expr_stmt|;
name|rlio
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|rlintr
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
specifier|register
name|struct
name|device
modifier|*
name|rp
decl_stmt|;
specifier|register
name|int
name|status
decl_stmt|;
name|rp
operator|=
name|RLADDR
expr_stmt|;
if|if
condition|(
name|rltab
operator|.
name|b_active
operator|==
name|NULL
condition|)
block|{
comment|/* 		logstray(rp); */
return|return;
block|}
name|bp
operator|=
name|rltab
operator|.
name|b_actf
expr_stmt|;
name|dk_busy
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|DK_N
operator|)
expr_stmt|;
if|if
condition|(
name|rp
operator|->
name|rlcs
operator|<
literal|0
condition|)
block|{
comment|/* error bit */
if|if
condition|(
name|rp
operator|->
name|rlcs
operator|&
literal|036000
condition|)
block|{
if|if
condition|(
name|rltab
operator|.
name|b_errcnt
operator|>
literal|2
condition|)
name|deverror
argument_list|(
name|bp
argument_list|,
name|rp
operator|->
name|rlcs
argument_list|,
name|rp
operator|->
name|rlda
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rp
operator|->
name|rlcs
operator|&
literal|040000
condition|)
block|{
name|rp
operator|->
name|rlda
operator|=
name|STAT
expr_stmt|;
name|rp
operator|->
name|rlcs
operator|=
operator|(
name|rl
operator|.
name|dn
operator|<<
literal|8
operator|)
operator||
name|GETSTAT
expr_stmt|;
while|while
condition|(
operator|(
name|rp
operator|->
name|rlcs
operator|&
name|CRDY
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
name|status
operator|=
name|rp
operator|->
name|rlmp
expr_stmt|;
if|if
condition|(
name|rltab
operator|.
name|b_errcnt
operator|>
literal|2
condition|)
name|deverror
argument_list|(
name|bp
argument_list|,
name|status
argument_list|,
name|rp
operator|->
name|rlda
argument_list|)
expr_stmt|;
name|rp
operator|->
name|rlda
operator|=
name|RESET
expr_stmt|;
name|rp
operator|->
name|rlcs
operator|=
operator|(
name|rl
operator|.
name|dn
operator|<<
literal|8
operator|)
operator||
name|GETSTAT
expr_stmt|;
while|while
condition|(
operator|(
name|rp
operator|->
name|rlcs
operator|&
name|CRDY
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
if|if
condition|(
name|status
operator|&
literal|01000
condition|)
block|{
name|rlstart
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
operator|++
name|rltab
operator|.
name|b_errcnt
operator|<=
literal|10
condition|)
block|{
name|rl
operator|.
name|cn
index|[
name|rl
operator|.
name|dn
index|]
operator|=
operator|-
literal|1
expr_stmt|;
name|rlstart
argument_list|()
expr_stmt|;
return|return;
block|}
else|else
block|{
name|bp
operator|->
name|b_flags
operator||=
name|B_ERROR
expr_stmt|;
name|rl
operator|.
name|bpart
operator|=
name|rl
operator|.
name|bleft
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|rl
operator|.
name|bleft
operator|-=
name|rl
operator|.
name|bpart
operator|)
operator|>
literal|0
condition|)
block|{
name|rl
operator|.
name|addr
operator|.
name|l
operator|+=
name|rl
operator|.
name|bpart
expr_stmt|;
name|rl
operator|.
name|sn
operator|=
literal|0
expr_stmt|;
name|rl
operator|.
name|chn
operator|++
expr_stmt|;
name|rlio
argument_list|()
expr_stmt|;
return|return;
block|}
name|rltab
operator|.
name|b_active
operator|=
name|NULL
expr_stmt|;
name|rltab
operator|.
name|b_errcnt
operator|=
literal|0
expr_stmt|;
name|rltab
operator|.
name|b_actf
operator|=
name|bp
operator|->
name|av_forw
expr_stmt|;
name|bp
operator|->
name|b_resid
operator|=
literal|0
expr_stmt|;
name|iodone
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|rlstart
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|rlio
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|device
modifier|*
name|rp
decl_stmt|;
specifier|register
name|dif
expr_stmt|;
specifier|register
name|int
name|head
decl_stmt|;
name|rp
operator|=
name|RLADDR
expr_stmt|;
name|dk_busy
operator||=
literal|1
operator|<<
name|DK_N
expr_stmt|;
name|dk_numb
index|[
name|DK_N
index|]
operator|+=
literal|1
expr_stmt|;
name|head
operator|=
name|rl
operator|.
name|bpart
operator|>>
literal|6
expr_stmt|;
name|dk_wds
index|[
name|DK_N
index|]
operator|+=
name|head
expr_stmt|;
if|if
condition|(
name|rl
operator|.
name|cn
index|[
name|rl
operator|.
name|dn
index|]
operator|<
literal|0
condition|)
block|{
name|rp
operator|->
name|rlcs
operator|=
operator|(
name|rl
operator|.
name|dn
operator|<<
literal|8
operator|)
operator||
name|RDHDR
expr_stmt|;
while|while
condition|(
operator|(
name|rp
operator|->
name|rlcs
operator|&
name|CRDY
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
name|rl
operator|.
name|cn
index|[
name|rl
operator|.
name|dn
index|]
operator|=
operator|(
name|rp
operator|->
name|rlmp
operator|&
literal|077700
operator|)
operator|>>
literal|6
expr_stmt|;
block|}
name|dif
operator|=
operator|(
name|rl
operator|.
name|cn
index|[
name|rl
operator|.
name|dn
index|]
operator|>>
literal|1
operator|)
operator|-
operator|(
name|rl
operator|.
name|chn
operator|>>
literal|1
operator|)
expr_stmt|;
name|head
operator|=
operator|(
name|rl
operator|.
name|chn
operator|&
literal|1
operator|)
operator|<<
literal|4
expr_stmt|;
if|if
condition|(
name|dif
operator|<
literal|0
condition|)
name|rp
operator|->
name|rlda
operator|=
operator|(
operator|-
name|dif
operator|<<
literal|7
operator|)
operator||
name|SEEKHI
operator||
name|head
expr_stmt|;
else|else
name|rp
operator|->
name|rlda
operator|=
operator|(
name|dif
operator|<<
literal|7
operator|)
operator||
name|SEEKLO
operator||
name|head
expr_stmt|;
name|rp
operator|->
name|rlcs
operator|=
operator|(
name|rl
operator|.
name|dn
operator|<<
literal|8
operator|)
operator||
name|SEEK
expr_stmt|;
name|rl
operator|.
name|cn
index|[
name|rl
operator|.
name|dn
index|]
operator|=
name|rl
operator|.
name|chn
expr_stmt|;
if|if
condition|(
name|rl
operator|.
name|bleft
operator|<
operator|(
name|rl
operator|.
name|bpart
operator|=
name|RLCYLSZ
operator|-
operator|(
name|rl
operator|.
name|sn
operator|*
name|RLSECSZ
operator|)
operator|)
condition|)
name|rl
operator|.
name|bpart
operator|=
name|rl
operator|.
name|bleft
expr_stmt|;
while|while
condition|(
operator|(
name|rp
operator|->
name|rlcs
operator|&
name|CRDY
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
name|rp
operator|->
name|rlda
operator|=
operator|(
name|rl
operator|.
name|chn
operator|<<
literal|6
operator|)
operator||
name|rl
operator|.
name|sn
expr_stmt|;
name|rp
operator|->
name|rlba
operator|=
name|rl
operator|.
name|addr
operator|.
name|w
index|[
literal|1
index|]
expr_stmt|;
name|rp
operator|->
name|rlmp
operator|=
operator|-
operator|(
name|rl
operator|.
name|bpart
operator|>>
literal|1
operator|)
expr_stmt|;
name|rp
operator|->
name|rlcs
operator|=
name|rl
operator|.
name|com
operator||
name|rl
operator|.
name|addr
operator|.
name|w
index|[
literal|0
index|]
operator|<<
literal|4
expr_stmt|;
block|}
end_block

begin_macro
name|rlread
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
name|physio
argument_list|(
name|rlstrategy
argument_list|,
operator|&
name|rrlbuf
argument_list|,
name|dev
argument_list|,
name|B_READ
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rlwrite
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
name|physio
argument_list|(
name|rlstrategy
argument_list|,
operator|&
name|rrlbuf
argument_list|,
name|dev
argument_list|,
name|B_WRITE
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


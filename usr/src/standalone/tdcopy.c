begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"MBA.h"
end_include

begin_include
include|#
directive|include
file|"RP.h"
end_include

begin_include
include|#
directive|include
file|"TM.h"
end_include

begin_include
include|#
directive|include
file|"CON.h"
end_include

begin_define
define|#
directive|define
name|BLKMAX
value|32768
end_define

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(a<b?a:b)
end_define

begin_define
define|#
directive|define
name|MAXTER
value|10
end_define

begin_comment
comment|/*  max. no. consec. tape errors */
end_comment

begin_comment
comment|/*		*/
end_comment

begin_decl_stmt
name|int
name|blksiz
decl_stmt|,
name|tfoff
decl_stmt|,
name|tboff
decl_stmt|,
name|dboff
decl_stmt|,
name|tunit
decl_stmt|,
name|dens
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|count
decl_stmt|,
modifier|*
name|tmMBA
decl_stmt|,
modifier|*
name|rpMBA
decl_stmt|,
name|dblks
decl_stmt|,
name|wsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|ins
decl_stmt|,
name|outs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|nread
decl_stmt|,
name|bytoff
decl_stmt|,
name|error
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|RPptr
decl_stmt|,
modifier|*
name|TMptr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rpcyl
decl_stmt|,
name|rptrk
decl_stmt|,
name|rpsec
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|input
index|[
literal|150
index|]
decl_stmt|,
modifier|*
name|bufptr
decl_stmt|,
name|retry
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*		*/
end_comment

begin_function
name|main
parameter_list|()
block|{
specifier|register
name|int
name|i
decl_stmt|;
comment|/* *  Stand-alone program to copy TM[23]/TE16 mag tape to *  RP06/RM03 disk. *  User specifies tape and disk MBA no.'s, tape and disk unit no.'s, *  tape block size, tape file offset, tape block offset in file, *  and disk sector offset. */
name|putlin
argument_list|(
literal|"tdcopy : TM03 tape-to-disk copy"
argument_list|)
expr_stmt|;
name|putnl
argument_list|()
expr_stmt|;
name|tmbno
label|:
name|count
operator|=
name|getval
argument_list|(
literal|"tape MBA #"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|count
operator|<
literal|0
operator|)
operator|||
operator|(
name|count
operator|>
name|MAXMBA
operator|-
literal|1
operator|)
condition|)
goto|goto
name|tmbno
goto|;
name|tmMBA
operator|=
name|TMptr
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
name|M_BASE
operator|+
operator|(
name|count
operator|*
name|NEXSPC
operator|)
operator|)
expr_stmt|;
comment|/* TM02 MBA addr */
name|tuni
label|:
name|tunit
operator|=
name|getval
argument_list|(
literal|"tape unit #"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tunit
operator|<
literal|0
operator|)
operator|||
operator|(
name|tunit
operator|>
literal|7
operator|)
condition|)
goto|goto
name|tuni
goto|;
name|TMptr
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
operator|(
name|int
operator|)
name|TMptr
operator|+
operator|(
name|tunit
operator|*
name|EXTSIZ
operator|)
operator|+
name|M_extern
operator|)
expr_stmt|;
comment|/*  ptr. to MBA 		ext. reg set for this TM02 unit */
comment|/* *  ignore density prompt for tape read - TM02 recognizes and adjusts *  for NRZ or PE input (800 or 1600 BPI) gden : dens = getval("tape density(8 or 16)") ; if (dens == 0) dens = TM_D800 ; else if ((dens != 8)&&(dens!=16)) goto gden ; */
name|dens
operator|=
operator|(
name|dens
operator|==
literal|16
condition|?
name|TM_D1600
else|:
name|TM_D800
operator|)
expr_stmt|;
name|toff
label|:
name|tfoff
operator|=
name|getval
argument_list|(
literal|"tape file offset"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tfoff
operator|<
literal|0
condition|)
goto|goto
name|toff
goto|;
name|gtbo
label|:
name|tboff
operator|=
name|getval
argument_list|(
literal|"tape block offset"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tboff
operator|<
literal|0
condition|)
goto|goto
name|gtbo
goto|;
name|putnl
argument_list|()
expr_stmt|;
name|gdm
label|:
name|count
operator|=
name|getval
argument_list|(
literal|"disk MBA #"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|count
operator|<
literal|0
operator|)
operator|||
operator|(
name|count
operator|>
name|MAXMBA
operator|-
literal|1
operator|)
condition|)
goto|goto
name|gdm
goto|;
name|rpMBA
operator|=
name|RPptr
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
name|M_BASE
operator|+
operator|(
name|count
operator|*
name|NEXSPC
operator|)
operator|)
expr_stmt|;
comment|/* RP06 MBA addr */
name|dun
label|:
name|count
operator|=
name|getval
argument_list|(
literal|"disk unit"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|count
operator|>
literal|7
operator|)
operator|||
operator|(
name|count
operator|<
literal|0
operator|)
condition|)
goto|goto
name|dun
goto|;
name|RPptr
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
operator|(
name|int
operator|)
name|RPptr
operator|+
operator|(
name|count
operator|*
name|EXTSIZ
operator|)
operator|+
name|M_extern
operator|)
expr_stmt|;
comment|/* ptr to MBA ext reg set for 			this RP06 unit */
name|doff
label|:
name|dboff
operator|=
name|getval
argument_list|(
literal|"disk block offset"
argument_list|)
expr_stmt|;
name|putnl
argument_list|()
expr_stmt|;
name|gknt
label|:
name|count
operator|=
name|getval
argument_list|(
literal|"no. of input blocks"
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|<
literal|0
condition|)
goto|goto
name|gknt
goto|;
if|if
condition|(
name|init
argument_list|()
condition|)
block|{
name|putlin
argument_list|(
literal|"init() error"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|dboff
operator|<
literal|0
operator|)
operator|||
operator|(
name|dboff
operator|>
name|MAXSEC
operator|-
literal|1
operator|)
condition|)
goto|goto
name|doff
goto|;
if|if
condition|(
name|tapfil
argument_list|(
name|TMptr
argument_list|,
name|tfoff
argument_list|)
condition|)
block|{
name|tioerr
label|:
name|putlin
argument_list|(
literal|"tape positioning error"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|tapfsp
argument_list|(
name|TMptr
argument_list|,
name|tboff
argument_list|)
condition|)
goto|goto
name|tioerr
goto|;
comment|/* read in 1st block of tape file to determine block size */
name|nread
operator|=
literal|1
expr_stmt|;
name|blksiz
operator|=
literal|65536
expr_stmt|;
for|for
control|(
name|retry
operator|=
literal|0
operator|,
name|i
operator|=
literal|10
operator|,
name|error
operator|=
literal|0
init|;
name|i
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|tread
argument_list|()
operator|&
name|TM_FCE
operator|)
operator|!=
name|TM_FCE
condition|)
block|{
if|if
condition|(
operator|++
name|error
operator|>
name|MAXTER
condition|)
goto|goto
name|tioerr
goto|;
block|}
else|else
break|break ;
block|}
name|retry
operator|++
expr_stmt|;
name|blksiz
operator|=
operator|(
operator|*
operator|(
name|TMptr
operator|+
name|TM_fc
operator|)
operator|)
operator|&
literal|0xffff
expr_stmt|;
name|pdstr
argument_list|(
literal|" = tape block size"
argument_list|,
name|blksiz
argument_list|)
expr_stmt|;
name|nread
operator|=
name|M_BCMAX
operator|/
name|blksiz
expr_stmt|;
comment|/* no. of tape reads to fill input buffer */
name|wsize
operator|=
name|nread
operator|*
name|blksiz
expr_stmt|;
comment|/* no. bytes each write to disc */
name|dblks
operator|=
name|wsize
operator|/
literal|512
expr_stmt|;
comment|/* no. of disc blocks on each write */
operator|*
operator|(
name|TMptr
operator|+
name|TM_cs1
operator|)
operator|=
name|TM_DCLR
operator||
name|TM_GO
expr_stmt|;
name|twait
argument_list|(
name|TMptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tapbsp
argument_list|(
name|TMptr
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|tioerr
goto|;
name|putnl
argument_list|()
expr_stmt|;
for|for
control|(
name|error
operator|=
literal|0
init|;
operator|(
name|error
operator|==
literal|0
operator|)
operator|&&
operator|(
name|count
operator|>
literal|0
operator|)
condition|;
name|count
operator|-=
name|nread
control|)
block|{
if|if
condition|(
name|i
operator|=
name|tread
argument_list|(
name|TMptr
argument_list|)
condition|)
block|{
name|putlin
argument_list|(
literal|"tape i/o error"
argument_list|)
expr_stmt|;
name|TME_print
argument_list|(
name|i
argument_list|)
expr_stmt|;
goto|goto
name|ioerr
goto|;
block|}
name|ins
operator|+=
name|nread
expr_stmt|;
comment|/*  count of tape blocks input */
if|if
condition|(
name|i
operator|=
name|dwrite
argument_list|(
name|RPptr
argument_list|)
condition|)
block|{
name|putlin
argument_list|(
literal|"disk i/o error"
argument_list|)
expr_stmt|;
name|RPE_print
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|ioerr
label|:
name|error
operator|++
expr_stmt|;
continue|continue ;
block|}
name|outs
operator|+=
name|dblks
expr_stmt|;
comment|/*  count of disk blocks output */
block|}
name|fini
label|:
comment|/*  no rewind on normal termination */
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|putlin
argument_list|(
literal|"normal termination"
argument_list|)
expr_stmt|;
else|else
name|taprew
argument_list|(
name|TMptr
argument_list|)
expr_stmt|;
name|pdstr
argument_list|(
literal|" input blocks read"
argument_list|,
name|ins
argument_list|)
expr_stmt|;
name|pdstr
argument_list|(
literal|" output blocks written"
argument_list|,
name|outs
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*		*/
end_comment

begin_macro
name|init
argument_list|()
end_macro

begin_block
block|{
comment|/* *  Initialization. *  Initialize MBA's and tape/disk units. *  Initialize TM2/TE16 for drive 0 , 800 BPI, PDP11, etc. *  Set up MBA  map registers to map a max. *    transfer of 'M_BCMAX' bytes. */
specifier|register
name|int
modifier|*
name|mp0
decl_stmt|,
modifier|*
name|mp1
decl_stmt|,
name|i
decl_stmt|,
name|page
decl_stmt|;
specifier|extern
name|char
modifier|*
name|end
decl_stmt|;
operator|*
operator|(
name|rpMBA
operator|+
name|M_cr
operator|)
operator|=
name|MBAinit
expr_stmt|;
comment|/* init. RP06 MBA */
if|if
condition|(
name|rpMBA
operator|!=
name|tmMBA
condition|)
operator|*
operator|(
name|tmMBA
operator|+
name|M_cr
operator|)
operator|=
name|MBAinit
expr_stmt|;
if|if
condition|(
operator|(
operator|*
operator|(
name|RPptr
operator|+
name|RP_sr
operator|)
operator|&
name|RP_MOL
operator|)
operator|==
literal|0
condition|)
block|{
name|putlin
argument_list|(
literal|"disk unit not online"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
operator|(
name|RPptr
operator|+
name|RP_cr
operator|)
operator|=
name|RP_RIP
operator||
name|RP_GO
expr_stmt|;
comment|/* preset */
name|dwait
argument_list|(
name|RPptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|=
name|derror
argument_list|(
name|RPptr
argument_list|)
condition|)
block|{
name|putlin
argument_list|(
literal|"disk init error"
argument_list|)
expr_stmt|;
name|RPE_print
argument_list|(
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
operator|(
name|RPptr
operator|+
name|RP_off
operator|)
operator|=
name|RP_FMT
expr_stmt|;
comment|/* set format bit */
name|i
operator|=
operator|*
operator|(
name|RPptr
operator|+
name|RP_dt
operator|)
operator|&
literal|0777
expr_stmt|;
comment|/* get disk type */
if|if
condition|(
name|i
operator|==
name|RP6typ
condition|)
block|{
comment|/* RP06 */
name|rpsec
operator|=
name|RP6SEC
expr_stmt|;
name|rpcyl
operator|=
name|RP6CYL
expr_stmt|;
name|rptrk
operator|=
name|RP6TRK
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|i
operator|==
name|RM3typ
condition|)
block|{
name|rpsec
operator|=
name|RM3SEC
expr_stmt|;
name|rpcyl
operator|=
name|RM3CYL
expr_stmt|;
name|rptrk
operator|=
name|RM3TRK
expr_stmt|;
block|}
else|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* set TM03 unit no., density, PDP11 normal mode, odd parity 	abort on error */
operator|*
operator|(
name|TMptr
operator|+
name|TM_tc
operator|)
operator|=
name|tunit
operator||
name|dens
operator||
name|TM_PNOR
operator||
name|TM_EABO
expr_stmt|;
operator|*
operator|(
name|TMptr
operator|+
name|TM_cs1
operator|)
operator|=
name|TM_DCLR
operator||
name|TM_GO
expr_stmt|;
name|twait
argument_list|(
name|TMptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|=
name|terror
argument_list|(
name|TMptr
argument_list|)
condition|)
block|{
name|tierr
label|:
name|putlin
argument_list|(
literal|"tape init error"
argument_list|)
expr_stmt|;
name|TME_print
argument_list|(
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
operator|*
operator|(
name|TMptr
operator|+
name|TM_ds
operator|)
operator|&
name|TM_MOL
operator|)
operator|==
literal|0
condition|)
block|{
name|putlin
argument_list|(
literal|"tape unit not online"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
operator|(
name|TMptr
operator|+
name|TM_cs1
operator|)
operator|=
name|TM_RWND
operator||
name|TM_GO
expr_stmt|;
name|twait
argument_list|(
name|TMptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|=
name|terror
argument_list|(
name|TMptr
argument_list|)
condition|)
goto|goto
name|tierr
goto|;
name|bufptr
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
operator|(
operator|(
operator|(
name|int
operator|)
operator|&
name|end
operator|)
operator|+
literal|511
operator|)
operator|&
literal|017777777000
operator|)
expr_stmt|;
name|page
operator|=
operator|(
call|(
name|int
call|)
argument_list|(
operator|(
name|int
operator|)
name|bufptr
operator|>>
literal|9
argument_list|)
operator|&
literal|017777777
operator|)
operator||
literal|0x80000000
expr_stmt|;
comment|/* SBI page no. */
name|mp0
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
operator|(
name|int
operator|)
name|tmMBA
operator|+
call|(
name|int
call|)
argument_list|(
name|M_map
operator|*
literal|4
argument_list|)
operator|)
expr_stmt|;
name|mp1
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
operator|(
name|int
operator|)
name|rpMBA
operator|+
call|(
name|int
call|)
argument_list|(
name|M_map
operator|*
literal|4
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
operator|(
operator|(
name|M_BCMAX
operator|+
literal|511
operator|)
operator|/
literal|512
operator|)
operator|+
literal|1
init|;
name|i
condition|;
name|i
operator|--
operator|,
name|page
operator|++
control|)
block|{
operator|(
operator|*
name|mp0
operator|++
operator|)
operator|=
name|page
expr_stmt|;
operator|(
operator|*
name|mp1
operator|++
operator|)
operator|=
name|page
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*		*/
end_comment

begin_macro
name|tread
argument_list|()
end_macro

begin_block
block|{
comment|/* *  Function to read TM2/TE16 tape drive, 'blksiz' bytes each *  read, and 'nread' reads. */
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
modifier|*
name|t
decl_stmt|,
modifier|*
name|m
decl_stmt|,
name|teknt
decl_stmt|;
name|m
operator|=
name|tmMBA
expr_stmt|;
name|t
operator|=
name|TMptr
expr_stmt|;
for|for
control|(
name|i
operator|=
name|MIN
argument_list|(
name|nread
argument_list|,
name|count
argument_list|)
operator|,
name|j
operator|=
literal|0
operator|,
name|teknt
operator|=
literal|0
init|;
name|i
condition|;
name|i
operator|--
operator|,
name|j
operator|++
control|)
block|{
name|trloop
label|:
operator|*
operator|(
name|m
operator|+
name|M_var
operator|)
operator|=
name|j
operator|*
name|blksiz
expr_stmt|;
operator|*
operator|(
name|m
operator|+
name|M_bc
operator|)
operator|=
operator|(
operator|-
name|blksiz
operator|)
expr_stmt|;
comment|/* MBA byte count reg */
operator|*
operator|(
name|t
operator|+
name|TM_cs1
operator|)
operator|=
name|TM_REDF
operator||
name|TM_GO
expr_stmt|;
comment|/* read forward */
name|twait
argument_list|(
name|t
argument_list|)
expr_stmt|;
comment|/* wait for ready */
if|if
condition|(
name|k
operator|=
name|terror
argument_list|(
name|t
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
operator|++
name|teknt
operator|>
name|MAXTER
operator|)
operator|||
operator|(
name|retry
operator|==
literal|0
operator|)
condition|)
return|return
operator|(
name|k
operator|)
return|;
operator|*
operator|(
name|t
operator|+
name|TM_cs1
operator|)
operator|=
name|TM_DCLR
operator||
name|TM_GO
expr_stmt|;
name|twait
argument_list|(
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|=
name|tapbsp
argument_list|(
name|t
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
name|k
operator|)
return|;
goto|goto
name|trloop
goto|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* normal return */
block|}
end_block

begin_comment
comment|/*		*/
end_comment

begin_macro
name|dwrite
argument_list|()
end_macro

begin_block
block|{
comment|/* *  Function to write 'wsize' bytes to disc *  from buffer '*bufptr'. */
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
modifier|*
name|m
decl_stmt|,
modifier|*
name|d
decl_stmt|;
name|m
operator|=
name|rpMBA
expr_stmt|;
name|d
operator|=
name|RPptr
expr_stmt|;
operator|*
operator|(
name|d
operator|+
name|RP_cr
operator|)
operator|=
name|RP_DC
operator||
name|RP_GO
expr_stmt|;
comment|/* drive clear */
name|dwait
argument_list|(
name|d
argument_list|)
expr_stmt|;
operator|*
operator|(
name|d
operator|+
name|RP_cyl
operator|)
operator|=
name|dboff
operator|/
name|RP6ST
expr_stmt|;
comment|/* cylinder no. */
name|i
operator|=
name|dboff
operator|%
name|RP6ST
expr_stmt|;
name|j
operator|=
operator|(
name|i
operator|/
name|rpsec
operator|)
operator|<<
literal|8
expr_stmt|;
comment|/* track */
operator|*
operator|(
name|d
operator|+
name|RP_stk
operator|)
operator|=
name|j
operator||
operator|(
name|i
operator|%
name|rpsec
operator|)
expr_stmt|;
comment|/* sector : track */
operator|*
operator|(
name|m
operator|+
name|M_bc
operator|)
operator|=
operator|(
name|count
operator|<
name|nread
condition|?
operator|-
operator|(
name|count
operator|*
literal|512
operator|)
else|:
operator|(
operator|-
name|wsize
operator|)
operator|)
expr_stmt|;
comment|/* byte count */
operator|*
operator|(
name|m
operator|+
name|M_var
operator|)
operator|=
literal|0
expr_stmt|;
comment|/* virt addr reg = map no. + byte off */
operator|*
operator|(
name|d
operator|+
name|RP_cr
operator|)
operator|=
name|RP_WR
operator||
name|RP_GO
expr_stmt|;
name|dwait
argument_list|(
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|=
name|derror
argument_list|(
name|d
argument_list|)
condition|)
return|return
operator|(
name|i
operator|)
return|;
comment|/* error */
name|dboff
operator|+=
name|dblks
expr_stmt|;
comment|/*  point to next disc sector */
return|return
operator|(
literal|0
operator|)
return|;
comment|/* normal return */
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)mwrite.c	4.1	(Berkeley)	9/12/82"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* sccs id variable */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|mwrite_sid
init|=
literal|"@(#)mwrite.c	1.2"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  	Mwrite provides the "response" function in the network. 	It sends its standard input to "toaddress", either by opening 	his terminal and writing on it, or by mailing it to him. 	It is executed by a remote machine from netdameon.c, either for a  	response to be sent back or an errormsg to be sent back. 	It excutes mmail locally if it needs to.  Archaic Usage: 	mwrite toaddress ttystr lutmptime fmach fuser [command ltimeSent]  New Usage: 	mwrite [-t toaddress] [-f fromaddress] [-x lutmptime] 		[-c command] [-y ttystr] [-e ltimeSent] [-r rc] 	 	fmach is a single letter. 	ttystr is the full name, e.g. /dev/tty0 	ltimeSent is number of secs since TIMEBASE in decimal. 	lutmptime is the login time from utmp in OCTAL in the old protocol 	and in decimal in the new protocol. 	rc is the decimal return code (exit code>>8) of the command. 	command and ltimeSent are optional.  	There is duplication in this argument list. 	See the note in mmail.c about this stuff.  	Mwrite must be setuid bin or setuid root, to get in group 0, 	on the CC machines, in order to write on the user's terminal.  	Exit Codes: 		Returns 0 if the writing on the terminal works. 		Returns the return code of the mmail program if this is mailed. */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_decl_stmt
name|jmp_buf
name|env
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|long
name|lutmptime
decl_stmt|,
name|otime
decl_stmt|,
name|ltimeSent
decl_stmt|,
name|ltimeCur
decl_stmt|,
name|ltimeElap
decl_stmt|;
name|int
name|alarmint
parameter_list|()
function_decl|;
name|FILE
modifier|*
name|file
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|utmp
modifier|*
name|putmp
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|char
name|fromaddress
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|toaddress
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
name|ttynamestr
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|cmdstr
index|[
name|BUFSIZ
index|]
decl_stmt|,
modifier|*
name|stimeCur
decl_stmt|,
name|stimeSent
index|[
literal|20
index|]
decl_stmt|;
name|char
name|src
index|[
literal|10
index|]
decl_stmt|,
name|stemp
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|stat
name|statbuf
decl_stmt|;
name|debugflg
operator|=
name|DBV
expr_stmt|;
name|argv
index|[
name|argc
index|]
operator|=
literal|0
expr_stmt|;
name|otime
operator|=
literal|0
expr_stmt|;
name|src
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
comment|/* NO LONGER NEEDED */
name|strcpy
argument_list|(
name|toaddress
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ttynamestr
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|argv
index|[
literal|3
index|]
argument_list|,
literal|"%lo"
argument_list|,
operator|&
name|lutmptime
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|fromaddress
argument_list|,
literal|"%s:%s"
argument_list|,
name|longname
argument_list|(
name|argv
index|[
literal|4
index|]
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|argv
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|6
condition|)
name|strcpy
argument_list|(
name|cmdstr
argument_list|,
name|argv
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
else|else
name|cmdstr
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|7
condition|)
name|strcpy
argument_list|(
name|stimeSent
argument_list|,
name|argv
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
else|else
name|stimeSent
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* parse arguments */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
switch|switch
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'t'
case|:
name|strcpy
argument_list|(
name|toaddress
argument_list|,
name|argv
index|[
operator|++
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'y'
case|:
name|strcpy
argument_list|(
name|ttynamestr
argument_list|,
name|argv
index|[
operator|++
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|lutmptime
operator|=
name|atol
argument_list|(
name|argv
index|[
operator|++
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|strcpy
argument_list|(
name|fromaddress
argument_list|,
name|argv
index|[
operator|++
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|strcpy
argument_list|(
name|cmdstr
argument_list|,
name|argv
index|[
operator|++
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|strcpy
argument_list|(
name|stimeSent
argument_list|,
name|argv
index|[
operator|++
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|strcpy
argument_list|(
name|src
argument_list|,
name|argv
index|[
operator|++
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* it is important that this code ignore unknown flags 		   so that options can be added w/o recompiling */
block|}
name|ltimeSent
operator|=
name|atol
argument_list|(
name|stimeSent
argument_list|)
operator|+
name|TIMEBASE
expr_stmt|;
name|setjmp
argument_list|(
name|env
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|alarmint
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|100
operator|&&
name|ttynamestr
index|[
literal|0
index|]
operator|&&
name|ttynamestr
index|[
literal|8
index|]
operator|!=
literal|'x'
condition|)
block|{
name|alarm
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|putmp
operator|=
name|getutmp
argument_list|(
name|ttynamestr
argument_list|)
expr_stmt|;
if|if
condition|(
name|putmp
operator|!=
name|NULL
condition|)
name|otime
operator|=
name|putmp
operator|->
name|ut_time
expr_stmt|;
comment|/* 		debug("lutmptime %lo otime %lo",lutmptime,otime); 		*/
if|if
condition|(
name|otime
operator|!=
literal|0
operator|&&
name|otime
operator|==
name|lutmptime
condition|)
block|{
name|file
operator|=
name|fopen
argument_list|(
name|ttynamestr
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|file
operator|!=
name|NULL
operator|&&
name|fstat
argument_list|(
name|fileno
argument_list|(
name|file
argument_list|)
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|!=
operator|-
literal|1
operator|&&
operator|(
name|statbuf
operator|.
name|st_mode
operator|&
literal|02
operator|)
condition|)
block|{
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|sprintf
argument_list|(
name|stemp
argument_list|,
literal|", R: %s"
argument_list|,
name|src
argument_list|)
expr_stmt|;
else|else
name|stemp
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|ltimeCur
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|stimeCur
operator|=
name|ctime
argument_list|(
operator|&
name|ltimeCur
argument_list|)
expr_stmt|;
name|stimeCur
operator|+=
literal|11
expr_stmt|;
name|stimeCur
index|[
name|strlen
argument_list|(
name|stimeCur
argument_list|)
operator|-
literal|9
index|]
operator|=
literal|0
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"\r\nMessage from %s at %s ...\r\n"
argument_list|,
name|fromaddress
argument_list|,
name|stimeCur
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdstr
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
block|{
name|s
operator|=
name|ctime
argument_list|(
operator|&
name|ltimeSent
argument_list|)
expr_stmt|;
name|s
index|[
name|strlen
argument_list|(
name|s
argument_list|)
operator|-
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|ltimeElap
operator|=
name|ltimeCur
operator|-
name|ltimeSent
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"(command: %s%s, sent %s, took %s)\r\n"
argument_list|,
name|cmdstr
argument_list|,
name|stemp
argument_list|,
name|s
argument_list|,
name|comptime
argument_list|(
name|ltimeElap
argument_list|)
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
name|BUFSIZ
argument_list|,
name|stdin
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|fputs
argument_list|(
name|buf
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
literal|'\r'
argument_list|,
name|file
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"------\r\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_OK
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* well, couldn't write to him, so we'll mail to him on this mach */
comment|/* mail to "toaddress", saying its from "fromaddress", about a command 	   "cmdstr", which was sent at time "stimeSent" */
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|stimeSent
argument_list|,
literal|"%ld"
argument_list|,
name|ltimeSent
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdstr
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|src
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|mexecl
argument_list|(
name|MMAILCMD
argument_list|,
literal|"mmail"
argument_list|,
literal|"-r"
argument_list|,
name|src
argument_list|,
literal|"-c"
argument_list|,
name|cmdstr
argument_list|,
literal|"-e"
argument_list|,
name|stimeSent
argument_list|,
literal|"-f"
argument_list|,
name|fromaddress
argument_list|,
literal|"-t"
argument_list|,
name|toaddress
argument_list|,
literal|"-z"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|mexecl
argument_list|(
name|MMAILCMD
argument_list|,
literal|"mmail"
argument_list|,
literal|"-c"
argument_list|,
name|cmdstr
argument_list|,
literal|"-e"
argument_list|,
name|stimeSent
argument_list|,
literal|"-f"
argument_list|,
name|fromaddress
argument_list|,
literal|"-t"
argument_list|,
name|toaddress
argument_list|,
literal|"-z"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|mexecl
argument_list|(
name|MMAILCMD
argument_list|,
literal|"mmail"
argument_list|,
literal|"-f"
argument_list|,
name|fromaddress
argument_list|,
literal|"-t"
argument_list|,
name|toaddress
argument_list|,
literal|"-z"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|MMAILCMD
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_UNAVAILABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|alarmint
argument_list|()
end_macro

begin_block
block|{
name|errno
operator|=
literal|100
expr_stmt|;
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
comment|/* alarm off */
name|longjmp
argument_list|(
name|env
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* ugh */
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)header.c	4.1	(Berkeley)	9/12/82"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* sccs id variable */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|header_sid
init|=
literal|"@(#)header.c	1.3"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 	header.c  	these routines provide a way of transferring the information 	in the "header" structure between machines. 	Programs calling these routines either read or write 	their information into the header structure. 	These procedures format the info in a way that is acceptable. 	Called by net.c, netdaemon.c, and netq.c. */
end_comment

begin_comment
comment|/* 	protocol that is sent (in ASCII): 	code, remote mach, local mach, version stamp (2), remote login name, 	password, -i, -o, -r files, 	local login name, terminal, flag, utmp tty login time, 	cc jobno(variable parameter list), current time, 	command '\n' real command '\n' 	any data 	 	changes: 	1) remove header 	3) use ascii length instead of 4 bytes 	4) encrypt the login name, command, and part of data as well */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_expr_stmt
name|writehdfd
argument_list|(
name|phd
argument_list|,
name|fd
argument_list|)
specifier|register
expr|struct
name|header
operator|*
name|phd
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|genparmlist
parameter_list|()
function_decl|;
name|char
name|cflag
init|=
literal|'a'
decl_stmt|;
comment|/* cflag is initially 'a'. Add the flags as needed. */
if|if
condition|(
name|phd
operator|->
name|hd_fnonotify
condition|)
name|cflag
operator|+=
name|F_NONOTIFY
expr_stmt|;
if|if
condition|(
name|phd
operator|->
name|hd_fquiet
condition|)
name|cflag
operator|+=
name|F_QUIET
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%c :%c :%c :%c :%c :%s :%s :%s :%s :%s :%s :%s :%c :%lo :%s%s :%ld :"
argument_list|,
name|phd
operator|->
name|hd_code
argument_list|,
name|phd
operator|->
name|hd_mchto
argument_list|,
name|phd
operator|->
name|hd_mchfrom
argument_list|,
name|phd
operator|->
name|hd_vmajor
operator|+
literal|'a'
argument_list|,
name|phd
operator|->
name|hd_vminor
operator|+
literal|'a'
argument_list|,
name|phd
operator|->
name|hd_snto
argument_list|,
name|phd
operator|->
name|hd_spasswd
argument_list|,
name|phd
operator|->
name|hd_sinfile
argument_list|,
name|phd
operator|->
name|hd_soutfile
argument_list|,
name|phd
operator|->
name|hd_srespfile
argument_list|,
name|phd
operator|->
name|hd_snfrom
argument_list|,
name|phd
operator|->
name|hd_sttyname
argument_list|,
name|cflag
argument_list|,
name|phd
operator|->
name|hd_lttytime
argument_list|,
name|phd
operator|->
name|hd_ijobno
argument_list|,
name|genparmlist
argument_list|(
name|phd
argument_list|)
argument_list|,
name|phd
operator|->
name|hd_ltimesent
operator|-
name|TIMEBASE
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|phd
operator|->
name|hd_scmdact
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|phd
operator|->
name|hd_scmdvirt
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|fd
argument_list|)
expr_stmt|;
comment|/* not used, but a good idea */
name|sprintf
argument_list|(
name|phd
operator|->
name|hd_addrfrom
argument_list|,
literal|"%c:%s"
argument_list|,
name|phd
operator|->
name|hd_mchfrom
argument_list|,
name|phd
operator|->
name|hd_snfrom
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|phd
operator|->
name|hd_addrto
argument_list|,
literal|"%c:%s"
argument_list|,
name|phd
operator|->
name|hd_mchto
argument_list|,
name|phd
operator|->
name|hd_snto
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* 	print out debugging values of a header structure */
end_comment

begin_expr_stmt
name|printhd
argument_list|(
name|phd
argument_list|)
specifier|register
expr|struct
name|header
operator|*
name|phd
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|debugflg
condition|)
block|{
name|printf
argument_list|(
literal|"To %s From %s quiet=%c nonotify=%c\n"
argument_list|,
name|phd
operator|->
name|hd_addrto
argument_list|,
name|phd
operator|->
name|hd_addrfrom
argument_list|,
name|chfromf
argument_list|(
name|phd
operator|->
name|hd_fquiet
argument_list|)
argument_list|,
name|chfromf
argument_list|(
name|phd
operator|->
name|hd_fnonotify
argument_list|)
argument_list|)
expr_stmt|;
comment|/* don't print out for security reasons 		printf("Password %s\n",phd->hd_spasswd); 		*/
name|printf
argument_list|(
literal|"Code '%c' Version (%d,%d) Infile '%s'\n"
argument_list|,
name|phd
operator|->
name|hd_code
argument_list|,
name|phd
operator|->
name|hd_vmajor
argument_list|,
name|phd
operator|->
name|hd_vminor
argument_list|,
name|phd
operator|->
name|hd_sinfile
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Outfile '%s' Respfile '%s' TTYName '%s'\n"
argument_list|,
name|phd
operator|->
name|hd_soutfile
argument_list|,
name|phd
operator|->
name|hd_srespfile
argument_list|,
name|phd
operator|->
name|hd_sttyname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Jobno %s TimeSent %s"
argument_list|,
name|phd
operator|->
name|hd_ijobno
argument_list|,
name|ctime
argument_list|(
operator|&
name|phd
operator|->
name|hd_ltimesent
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phd
operator|->
name|hd_lttytime
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"TTYTime %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|phd
operator|->
name|hd_lttytime
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Virtual Command \"%s\"\n"
argument_list|,
name|phd
operator|->
name|hd_scmdvirt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Actual Command \"%s\"\n"
argument_list|,
name|phd
operator|->
name|hd_scmdact
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* 	generate a variable parameter list 	the format is: 		(name value, name value, ..., name value) 	where names are unquoted single words and values 	are unquoted if a single alphanumeric word, and are 	surrounded by {} otherwise. \ quotes { and }. 	the values are escape-processed, e.g. \n becomes 012. 	this function returns such a list. 	Returns the null parm list if nothing to give, i.e. "()"   	Should also default so single keywords can have on/off 	states, and so do not require a value.  	Things this variable protocol should specify: 		EPASSWD 	encrypted passwd 		FILEMODE 	file mode 		FROMUID  	from users' uid 		FROMGID  	from users' gid 		COMPRESS 	use colin's compression 		ACCTPAIR	handle acct pairs 		MESSAGEID	unique number identifying this request. 		FILENAME	when omitted by netcp, will use FILENAME ext. 		REPLYTO		the person the response should be sent to  		 --- possibly --- 		MACHINE2	a second machine (e.g. 3way netcp) 		LOGIN2		a second login name 		PASSWD2		a second passwd  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|genparmlist
parameter_list|(
name|phd
parameter_list|)
specifier|register
name|struct
name|header
modifier|*
name|phd
decl_stmt|;
block|{
specifier|static
name|char
name|returnstr
index|[
name|PARMLIST
index|]
decl_stmt|;
name|strcpy
argument_list|(
name|returnstr
argument_list|,
literal|"()"
argument_list|)
expr_stmt|;
return|return
operator|(
name|returnstr
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ingres.h>
end_include

begin_include
include|#
directive|include
file|"globs.h"
end_include

begin_include
include|#
directive|include
file|<sccs.h>
end_include

begin_macro
name|SCCSID
argument_list|(
argument|@(#)rnum.c
literal|7.1
literal|2
argument|/
literal|5
argument|/
literal|81
argument_list|)
end_macro

begin_comment
comment|/* **	Internal numbers are used in decomp to **	represent relation names. The numbers **	from 0 to FIRSTNUM-1 refer to the names **	stored in De.de_name_table[]. ** **	The number from FIRSTNUM to LASTNUM have **	names which are computed from aa, ab, etc. */
end_comment

begin_comment
comment|/* **	Assign an internal number rnum to name. */
end_comment

begin_macro
name|rnum_assign
argument_list|(
argument|name
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FIRSTNUM
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|De
operator|.
name|de_num_used
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
name|bmove
argument_list|(
name|name
argument_list|,
name|De
operator|.
name|de_name_table
index|[
name|i
index|]
argument_list|,
name|MAXNAME
argument_list|)
expr_stmt|;
name|De
operator|.
name|de_num_used
index|[
name|i
index|]
operator|++
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
name|syserr
argument_list|(
literal|"rnum_assign:no room"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* **	Allocate the next available name */
end_comment

begin_macro
name|rnum_alloc
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|cp
operator|=
operator|&
name|De
operator|.
name|de_num_used
index|[
name|FIRSTNUM
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|FIRSTNUM
init|;
name|i
operator|<
name|LASTNUM
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|*
name|cp
operator|++
operator|==
literal|0
condition|)
block|{
operator|--
name|cp
expr_stmt|;
operator|(
operator|*
name|cp
operator|)
operator|++
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
name|syserr
argument_list|(
literal|"no free names"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* **	Convert internal relation number **	to its real name. Guarantee '\0' at end. */
end_comment

begin_function
name|char
modifier|*
name|rnum_convert
parameter_list|(
name|num
parameter_list|)
name|int
name|num
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|ret
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
specifier|static
name|char
name|temp
index|[
name|MAXNAME
operator|+
literal|1
index|]
decl_stmt|;
specifier|extern
name|char
modifier|*
name|Fileset
decl_stmt|;
specifier|extern
name|char
modifier|*
name|concat
parameter_list|()
function_decl|;
name|i
operator|=
name|num
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|LASTNUM
operator|||
name|De
operator|.
name|de_num_used
index|[
name|i
index|]
operator|==
literal|0
condition|)
name|syserr
argument_list|(
literal|"no name for %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ret
operator|=
name|temp
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|FIRSTNUM
condition|)
block|{
name|bmove
argument_list|(
name|De
operator|.
name|de_name_table
index|[
name|i
index|]
argument_list|,
name|ret
argument_list|,
name|MAXNAME
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* compute temp name */
name|cp
operator|=
name|concat
argument_list|(
literal|"_SYS"
argument_list|,
name|Fileset
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|pad
argument_list|(
name|ret
argument_list|,
name|MAXNAME
argument_list|)
expr_stmt|;
name|i
operator|-=
name|FIRSTNUM
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|i
operator|/
literal|26
operator|+
literal|'a'
expr_stmt|;
operator|*
name|cp
operator|=
name|i
operator|%
literal|26
operator|+
literal|'a'
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* **	Remove a num from the used list */
end_comment

begin_macro
name|rnum_remove
argument_list|(
argument|num
argument_list|)
end_macro

begin_decl_stmt
name|int
name|num
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|cp
operator|=
operator|&
name|De
operator|.
name|de_num_used
index|[
name|num
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|0
condition|)
name|syserr
argument_list|(
literal|"cant remove %d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* **	returns number of largest assigned temp number. **	zero if none */
end_comment

begin_macro
name|rnum_last
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|LASTNUM
operator|-
literal|1
init|;
name|i
operator|>=
name|FIRSTNUM
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|De
operator|.
name|de_num_used
index|[
name|i
index|]
condition|)
block|{
return|return
operator|(
name|i
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* **	Predicate to check whether rnum is a temporary relation or not */
end_comment

begin_macro
name|rnum_temp
argument_list|(
argument|rnum
argument_list|)
end_macro

begin_decl_stmt
name|int
name|rnum
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|i
operator|=
name|rnum
expr_stmt|;
return|return
operator|(
name|i
operator|>=
name|FIRSTNUM
operator|||
name|bequal
argument_list|(
literal|"_SYS"
argument_list|,
name|rnum_convert
argument_list|(
name|i
argument_list|)
argument_list|,
literal|4
argument_list|)
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* **	Clear tag fields from previous query */
end_comment

begin_macro
name|rnum_init
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|cp
operator|=
name|De
operator|.
name|de_num_used
expr_stmt|;
name|i
operator|=
name|FIRSTNUM
expr_stmt|;
while|while
condition|(
operator|--
name|i
condition|)
operator|*
name|cp
operator|++
operator|=
literal|0
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1983 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)cmds.c	2.2 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|not lint
end_endif

begin_include
include|#
directive|include
file|"timedc.h"
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_define
define|#
directive|define
name|TSPTYPES
end_define

begin_include
include|#
directive|include
file|<protocols/timed.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_decl_stmt
name|int
name|id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sock_raw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|hostname
index|[
name|MAXHOSTNAMELEN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|,
modifier|*
name|gethostbyname
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr_in
name|server
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|measure_delta
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bytenetorder
argument_list|()
decl_stmt|,
name|bytehostorder
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|char
modifier|*
name|strcpy
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  * Clockdiff computes the difference between the time of the machine on   * which it is called and the time of the machines given as argument.  * The time differences measured by clockdiff are obtained using a sequence  * of ICMP TSTAMP messages which are returned to the sender by the IP module  * in the remote machine.  * In order to compare clocks of machines in different time zones, the time   * is transmitted (as a 32-bit value) in milliseconds since midnight UT.   * If a hosts uses a different time format, it should set the high order  * bit of the 32-bit quantity it transmits.  * However, VMS apparently transmits the time in milliseconds since midnight  * local time (rather than GMT) without setting the high order bit.   * Furthermore, it does not understand daylight-saving time.  This makes   * clockdiff behaving inconsistently with hosts running VMS.  *  * In order to reduce the sensitivity to the variance of message transmission   * time, clockdiff sends a sequence of messages.  Yet, measures between   * two `distant' hosts can be affected by a small error. The error can, however,  * be reduced by increasing the number of messages sent in each measurement.  */
end_comment

begin_macro
name|clockdiff
argument_list|(
argument|argc
argument_list|,
argument|argv
argument_list|)
end_macro

begin_decl_stmt
name|int
name|argc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|measure_status
decl_stmt|;
name|struct
name|timeval
name|ack
decl_stmt|;
name|int
name|measure
parameter_list|()
function_decl|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: clockdiff host ... \n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|id
operator|=
name|getpid
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|gethostname
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|hp
operator|=
name|gethostbyname
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: unknown host\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|server
operator|.
name|sin_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr
argument_list|,
operator|&
operator|(
name|server
operator|.
name|sin_addr
operator|.
name|s_addr
operator|)
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
name|ack
operator|.
name|tv_sec
operator|=
literal|10
expr_stmt|;
name|ack
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|measure_status
operator|=
name|measure
argument_list|(
operator|&
name|ack
argument_list|,
operator|&
name|server
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"measure"
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|measure_status
condition|)
block|{
case|case
name|HOSTDOWN
case|:
name|printf
argument_list|(
literal|"%s is down\n"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
continue|continue;
break|break;
case|case
name|NONSTDTIME
case|:
name|printf
argument_list|(
literal|"%s time transmitted in a non-standard format\n"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
continue|continue;
break|break;
case|case
name|UNREACHABLE
case|:
name|printf
argument_list|(
literal|"%s is unreachable\n"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
continue|continue;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|measure_delta
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"time on %s is %d ms. ahead of time on %s\n"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|,
name|measure_delta
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|measure_delta
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"%s and %s have the same time\n"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"time on %s is %d ms. behind time on %s\n"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|,
operator|-
name|measure_delta
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_block

begin_comment
comment|/*  * finds location of master timedaemon  */
end_comment

begin_macro
name|msite
argument_list|(
argument|argc
argument_list|)
end_macro

begin_decl_stmt
name|int
name|argc
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|length
decl_stmt|;
name|int
name|cc
decl_stmt|;
name|fd_set
name|ready
decl_stmt|;
name|struct
name|sockaddr_in
name|dest
decl_stmt|;
name|struct
name|timeval
name|tout
decl_stmt|;
name|struct
name|sockaddr_in
name|from
decl_stmt|;
name|struct
name|tsp
name|msg
decl_stmt|;
name|struct
name|servent
modifier|*
name|srvp
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: msite\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|srvp
operator|=
name|getservbyname
argument_list|(
literal|"timed"
argument_list|,
literal|"udp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|srvp
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"udp/timed: unknown service\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dest
operator|.
name|sin_port
operator|=
name|srvp
operator|->
name|s_port
expr_stmt|;
name|dest
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
operator|(
name|void
operator|)
name|gethostname
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
name|hp
operator|=
name|gethostbyname
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"gethostbyname"
argument_list|)
expr_stmt|;
return|return;
block|}
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr
argument_list|,
operator|&
name|dest
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|msg
operator|.
name|tsp_name
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
name|msg
operator|.
name|tsp_type
operator|=
name|TSP_MSITE
expr_stmt|;
name|msg
operator|.
name|tsp_vers
operator|=
name|TSPVERSION
expr_stmt|;
name|bytenetorder
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendto
argument_list|(
name|sock
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tsp
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|dest
argument_list|,
name|length
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto"
argument_list|)
expr_stmt|;
return|return;
block|}
name|tout
operator|.
name|tv_sec
operator|=
literal|15
expr_stmt|;
name|tout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|ready
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|sock
argument_list|,
operator|&
name|ready
argument_list|)
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|FD_SETSIZE
argument_list|,
operator|&
name|ready
argument_list|,
operator|(
name|fd_set
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|fd_set
operator|*
operator|)
literal|0
argument_list|,
operator|&
name|tout
argument_list|)
condition|)
block|{
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|cc
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tsp
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|from
argument_list|,
operator|&
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom"
argument_list|)
expr_stmt|;
return|return;
block|}
name|bytehostorder
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|.
name|tsp_type
operator|==
name|TSP_ACK
condition|)
name|printf
argument_list|(
literal|"master timedaemon runs on %s\n"
argument_list|,
name|msg
operator|.
name|tsp_name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"received wrong ack: %s\n"
argument_list|,
name|tsptype
index|[
name|msg
operator|.
name|tsp_type
index|]
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"communication error\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * quits timedc  */
end_comment

begin_macro
name|quit
argument_list|()
end_macro

begin_block
block|{
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|MAXH
value|4
end_define

begin_comment
comment|/* max no. of hosts where election can occur */
end_comment

begin_comment
comment|/*  * Causes the election timer to expire on the selected hosts  * It sends just one udp message per machine, relying on  * reliability of communication channel.  */
end_comment

begin_macro
name|testing
argument_list|(
argument|argc
argument_list|,
argument|argv
argument_list|)
end_macro

begin_decl_stmt
name|int
name|argc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|length
decl_stmt|;
name|int
name|nhosts
decl_stmt|;
name|struct
name|servent
modifier|*
name|srvp
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
index|[
name|MAXH
index|]
decl_stmt|;
name|struct
name|tsp
name|msg
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: testing host ...\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|srvp
operator|=
name|getservbyname
argument_list|(
literal|"timed"
argument_list|,
literal|"udp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|srvp
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"udp/timed: unknown service\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|nhosts
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|hp
operator|=
name|gethostbyname
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: unknown host %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
continue|continue;
block|}
name|sin
index|[
name|nhosts
index|]
operator|.
name|sin_port
operator|=
name|srvp
operator|->
name|s_port
expr_stmt|;
name|sin
index|[
name|nhosts
index|]
operator|.
name|sin_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr
argument_list|,
operator|&
operator|(
name|sin
index|[
name|nhosts
index|]
operator|.
name|sin_addr
operator|.
name|s_addr
operator|)
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|nhosts
operator|==
name|MAXH
condition|)
break|break;
block|}
name|msg
operator|.
name|tsp_type
operator|=
name|TSP_TEST
expr_stmt|;
name|msg
operator|.
name|tsp_vers
operator|=
name|TSPVERSION
expr_stmt|;
operator|(
name|void
operator|)
name|gethostname
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|msg
operator|.
name|tsp_name
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
name|bytenetorder
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
comment|/* it is not really necessary here */
while|while
condition|(
name|nhosts
operator|--
operator|>
literal|0
condition|)
block|{
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendto
argument_list|(
name|sock
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tsp
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|sin
index|[
name|nhosts
index|]
argument_list|,
name|length
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  * Enables or disables tracing on local timedaemon  */
end_comment

begin_macro
name|tracing
argument_list|(
argument|argc
argument_list|,
argument|argv
argument_list|)
end_macro

begin_decl_stmt
name|int
name|argc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|onflag
decl_stmt|;
name|int
name|length
decl_stmt|;
name|int
name|cc
decl_stmt|;
name|fd_set
name|ready
decl_stmt|;
name|struct
name|sockaddr_in
name|dest
decl_stmt|;
name|struct
name|timeval
name|tout
decl_stmt|;
name|struct
name|sockaddr_in
name|from
decl_stmt|;
name|struct
name|tsp
name|msg
decl_stmt|;
name|struct
name|servent
modifier|*
name|srvp
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: tracing { on | off }\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|srvp
operator|=
name|getservbyname
argument_list|(
literal|"timed"
argument_list|,
literal|"udp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|srvp
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"udp/timed: unknown service\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dest
operator|.
name|sin_port
operator|=
name|srvp
operator|->
name|s_port
expr_stmt|;
name|dest
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
operator|(
name|void
operator|)
name|gethostname
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
name|hp
operator|=
name|gethostbyname
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr
argument_list|,
operator|&
name|dest
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|msg
operator|.
name|tsp_type
operator|=
name|TSP_TRACEON
expr_stmt|;
name|onflag
operator|=
name|ON
expr_stmt|;
block|}
else|else
block|{
name|msg
operator|.
name|tsp_type
operator|=
name|TSP_TRACEOFF
expr_stmt|;
name|onflag
operator|=
name|OFF
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|msg
operator|.
name|tsp_name
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
name|msg
operator|.
name|tsp_vers
operator|=
name|TSPVERSION
expr_stmt|;
name|bytenetorder
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendto
argument_list|(
name|sock
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tsp
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|dest
argument_list|,
name|length
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto"
argument_list|)
expr_stmt|;
return|return;
block|}
name|tout
operator|.
name|tv_sec
operator|=
literal|5
expr_stmt|;
name|tout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|ready
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|sock
argument_list|,
operator|&
name|ready
argument_list|)
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|FD_SETSIZE
argument_list|,
operator|&
name|ready
argument_list|,
operator|(
name|fd_set
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|fd_set
operator|*
operator|)
literal|0
argument_list|,
operator|&
name|tout
argument_list|)
condition|)
block|{
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|cc
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tsp
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|from
argument_list|,
operator|&
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom"
argument_list|)
expr_stmt|;
return|return;
block|}
name|bytehostorder
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|.
name|tsp_type
operator|==
name|TSP_ACK
condition|)
if|if
condition|(
name|onflag
condition|)
name|printf
argument_list|(
literal|"timed tracing enabled\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"timed tracing disabled\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"wrong ack received: %s\n"
argument_list|,
name|tsptype
index|[
name|msg
operator|.
name|tsp_type
index|]
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"communication error\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|priv_resources
argument_list|()
end_macro

begin_block
block|{
name|int
name|port
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|sock
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sock
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"opening socket"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|port
operator|=
name|IPPORT_RESERVED
operator|-
literal|1
init|;
name|port
operator|>
name|IPPORT_RESERVED
operator|/
literal|2
condition|;
name|port
operator|--
control|)
block|{
name|sin
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
argument_list|)
operator|>=
literal|0
condition|)
break|break;
if|if
condition|(
name|errno
operator|!=
name|EADDRINUSE
operator|&&
name|errno
operator|!=
name|EADDRNOTAVAIL
condition|)
block|{
name|perror
argument_list|(
literal|"bind"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|sock
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
if|if
condition|(
name|port
operator|==
name|IPPORT_RESERVED
operator|/
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"all reserved ports in use\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|sock
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sock_raw
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_RAW
argument_list|,
name|IPPROTO_ICMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|sock_raw
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"opening raw socket"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|sock_raw
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

end_unit


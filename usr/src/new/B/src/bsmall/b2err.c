begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) Stichting Mathematisch Centrum, Amsterdam, 1984. */
end_comment

begin_comment
comment|/* $Header: b2err.c,v 1.1 84/06/28 00:49:07 timo Exp $ */
end_comment

begin_comment
comment|/* B error message handling */
end_comment

begin_include
include|#
directive|include
file|"b.h"
end_include

begin_include
include|#
directive|include
file|"b0con.h"
end_include

begin_include
include|#
directive|include
file|"b1obj.h"
end_include

begin_include
include|#
directive|include
file|"b2err.h"
end_include

begin_include
include|#
directive|include
file|"b2scr.h"
end_include

begin_include
include|#
directive|include
file|"b2env.h"
end_include

begin_include
include|#
directive|include
file|"b2sem.h"
end_include

begin_comment
comment|/* for xeq */
end_comment

begin_include
include|#
directive|include
file|"b2syn.h"
end_include

begin_include
include|#
directive|include
file|"b2sig.h"
end_include

begin_include
include|#
directive|include
file|"b2fil.h"
end_include

begin_decl_stmt
name|jmp_buf
name|main_loop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bool
name|skipping
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|Interactive
value|((cntxt == In_read || active_reads> 0) \ 				? read_interactive : interactive)
end_define

begin_define
define|#
directive|define
name|Errout
value|(Interactive ? stderr : stdout)
end_define

begin_define
define|#
directive|define
name|Skip
parameter_list|()
value|{if (skipping) proceed();}
end_define

begin_function
name|Hidden
name|Procedure
name|Line
parameter_list|()
block|{
if|if
condition|(
name|interactive
operator|||
name|Errout
operator|==
name|stdout
condition|)
name|line
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|errmess
parameter_list|(
name|m
parameter_list|)
name|string
name|m
decl_stmt|;
block|{
name|fprintf
argument_list|(
name|Errout
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|core_dump
parameter_list|()
block|{
name|errmess
argument_list|(
literal|"*** Core-dump for inspection purposes: "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|dump
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|bye
parameter_list|(
name|ex
parameter_list|)
name|int
name|ex
decl_stmt|;
block|{
name|at_nwl
operator|=
name|Yes
expr_stmt|;
name|putprmnv
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|ex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|prname
parameter_list|(
name|name
parameter_list|)
name|value
name|name
decl_stmt|;
block|{
name|value
name|ch
decl_stmt|;
name|int
name|k
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
name|Is_text
argument_list|(
name|name
argument_list|)
condition|)
block|{
name|len
operator|=
name|length
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|k_Over_len
block|{
name|ch
operator|=
name|thof
argument_list|(
name|k
operator|+
literal|1
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|putc
argument_list|(
name|charval
argument_list|(
name|ch
argument_list|)
argument_list|,
name|Errout
argument_list|)
expr_stmt|;
name|release
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|errmess
argument_list|(
literal|"???"
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|value
name|erruname
init|=
name|Vnil
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|literal
name|errutype
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|intlet
name|errlino
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|Hidden
name|intlet
name|display_line
parameter_list|(
name|ax
parameter_list|)
name|txptr
name|ax
decl_stmt|;
block|{
comment|/*displays the line that tx is in, and returns the column number that 	  ax is at. 	*/
name|txptr
name|lx
init|=
name|fcol
argument_list|()
decl_stmt|;
name|intlet
name|ap
init|=
operator|-
literal|1
decl_stmt|,
name|p
init|=
literal|0
decl_stmt|;
name|char
name|c
decl_stmt|;
while|while
condition|(
operator|!
name|Eol
argument_list|(
name|lx
argument_list|)
operator|&&
name|Char
argument_list|(
name|lx
argument_list|)
operator|!=
name|Eotc
condition|)
block|{
if|if
condition|(
name|lx
operator|==
name|ax
condition|)
name|ap
operator|=
name|p
expr_stmt|;
name|c
operator|=
operator|*
name|lx
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\t'
condition|)
block|{
do|do
block|{
name|putc
argument_list|(
literal|' '
argument_list|,
name|Errout
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
operator|++
name|p
operator|)
operator|%
literal|4
operator|)
operator|!=
literal|0
condition|)
do|;
block|}
else|else
block|{
name|putc
argument_list|(
name|c
argument_list|,
name|Errout
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
block|}
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|Errout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|<
literal|0
condition|)
return|return
name|p
return|;
return|return
name|ap
return|;
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|prline
parameter_list|(
name|at
parameter_list|)
name|bool
name|at
decl_stmt|;
block|{
name|txptr
name|ax
init|=
name|tx
decl_stmt|;
name|intlet
name|p
decl_stmt|,
name|ap
decl_stmt|;
if|if
condition|(
name|cntxt
operator|==
name|In_read
operator|||
name|cntxt
operator|==
name|In_value
condition|)
name|errmess
argument_list|(
literal|" in your "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cntxt
operator|!=
name|In_formal
condition|)
name|fprintf
argument_list|(
name|Errout
argument_list|,
literal|" in line %d of your "
argument_list|,
name|lino
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cntxt
condition|)
block|{
case|case
name|In_command
case|:
name|errmess
argument_list|(
literal|"command"
argument_list|)
expr_stmt|;
break|break;
case|case
name|In_read
case|:
name|errmess
argument_list|(
literal|"expression to be read"
argument_list|)
expr_stmt|;
break|break;
case|case
name|In_value
case|:
name|errmess
argument_list|(
literal|"edited value"
argument_list|)
expr_stmt|;
break|break;
case|case
name|In_unit
case|:
name|errmess
argument_list|(
literal|"unit "
argument_list|)
expr_stmt|;
name|prname
argument_list|(
name|uname
argument_list|)
expr_stmt|;
name|erruname
operator|=
name|uname
expr_stmt|;
name|errutype
operator|=
name|utype
expr_stmt|;
name|errlino
operator|=
name|lino
expr_stmt|;
break|break;
case|case
name|In_formal
case|:
break|break;
case|case
name|In_prmnv
case|:
name|errmess
argument_list|(
literal|"permanent environment"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|errmess
argument_list|(
literal|"???\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|errmess
argument_list|(
literal|"\n    "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|at
condition|)
do|do
name|ax
operator|--
expr_stmt|;
do|while
condition|(
name|Space
argument_list|(
name|Char
argument_list|(
name|ax
argument_list|)
argument_list|)
condition|)
do|;
name|ap
operator|=
name|display_line
argument_list|(
name|ax
argument_list|)
operator|+
literal|4
expr_stmt|;
for|for
control|(
name|p
operator|=
literal|0
init|;
name|p
operator|<
name|ap
condition|;
name|p
operator|++
control|)
name|putc
argument_list|(
literal|' '
argument_list|,
name|Errout
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'^'
argument_list|,
name|Errout
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|Errout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|show_where
parameter_list|(
name|at
parameter_list|,
name|wia
parameter_list|)
name|bool
name|at
decl_stmt|,
name|wia
decl_stmt|;
block|{
name|context
name|cc
decl_stmt|;
if|if
condition|(
name|cntxt
operator|==
name|In_formal
condition|)
block|{
name|sv_context
argument_list|(
operator|&
name|cc
argument_list|)
expr_stmt|;
name|set_context
argument_list|(
operator|&
name|how_context
argument_list|)
expr_stmt|;
name|prline
argument_list|(
name|No
argument_list|)
expr_stmt|;
name|set_context
argument_list|(
operator|&
name|cc
argument_list|)
expr_stmt|;
name|errmess
argument_list|(
literal|"originating from your command"
argument_list|)
expr_stmt|;
block|}
name|prline
argument_list|(
name|at
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Interactive
operator|||
operator|!
name|wia
condition|)
block|{
name|fprintf
argument_list|(
name|Errout
argument_list|,
literal|"(detected after reading %d input line%s of your input file "
argument_list|,
name|alino
argument_list|,
name|alino
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|iname
operator|==
name|Vnil
condition|)
name|errmess
argument_list|(
literal|"standard input)"
argument_list|)
expr_stmt|;
else|else
block|{
name|prname
argument_list|(
name|iname
argument_list|)
expr_stmt|;
name|errmess
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|Errout
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|Visible
name|Procedure
name|syserr
parameter_list|(
name|m
parameter_list|)
name|string
name|m
decl_stmt|;
block|{
name|Line
argument_list|()
expr_stmt|;
name|errmess
argument_list|(
literal|"*** Sorry, B system malfunction"
argument_list|)
expr_stmt|;
name|show_where
argument_list|(
name|Yes
argument_list|,
name|Yes
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|Errout
argument_list|,
literal|"*** The problem is: %s\n"
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|errmess
argument_list|(
literal|"*** Please save pertinent data for inspection by B guru\n"
argument_list|)
expr_stmt|;
name|core_dump
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|memexh
parameter_list|()
block|{
name|Line
argument_list|()
expr_stmt|;
name|errmess
argument_list|(
literal|"*** Sorry, memory exhausted"
argument_list|)
expr_stmt|;
name|show_where
argument_list|(
name|Yes
argument_list|,
name|Yes
argument_list|)
expr_stmt|;
name|errmess
argument_list|(
literal|"*** Get your boss to buy a larger computer\n"
argument_list|)
expr_stmt|;
name|core_dump
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|fix_files
parameter_list|()
block|{
if|if
condition|(
name|ifile
operator|!=
name|stdin
condition|)
name|fclose
argument_list|(
name|ifile
argument_list|)
expr_stmt|;
if|if
condition|(
name|f_interactive
argument_list|(
name|stdin
argument_list|)
operator|||
name|filtered
condition|)
block|{
name|interactive
operator|=
name|Yes
expr_stmt|;
name|release
argument_list|(
name|iname
argument_list|)
expr_stmt|;
name|iname
operator|=
name|Vnil
expr_stmt|;
name|ifile
operator|=
name|stdin
expr_stmt|;
name|Eof
operator|=
name|Eof0
operator|=
name|No
expr_stmt|;
block|}
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|proceed
parameter_list|()
block|{
if|if
condition|(
name|cntxt
operator|==
name|In_prmnv
condition|)
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cntxt
operator|==
name|In_read
operator|&&
name|read_interactive
condition|)
block|{
name|errmess
argument_list|(
literal|"*** please enter a valid expression instead\n"
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|reading
index|[
name|active_reads
operator|-
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|active_reads
operator|>
literal|0
operator|&&
name|read_interactive
condition|)
block|{
name|errmess
argument_list|(
literal|"*** please enter a suitable expression instead\n"
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|reading
index|[
name|active_reads
operator|-
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|cntxt
operator|==
name|In_value
condition|)
name|fix_files
argument_list|()
expr_stmt|;
name|longjmp
argument_list|(
name|main_loop
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|message
parameter_list|(
name|m1
parameter_list|,
name|m2
parameter_list|,
name|m3
parameter_list|,
name|at
parameter_list|)
name|string
name|m1
decl_stmt|,
name|m2
decl_stmt|,
name|m3
decl_stmt|;
name|bool
name|at
decl_stmt|;
block|{
name|Skip
argument_list|()
expr_stmt|;
name|Line
argument_list|()
expr_stmt|;
name|errmess
argument_list|(
name|m1
argument_list|)
expr_stmt|;
name|show_where
argument_list|(
name|at
argument_list|,
name|Yes
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|Errout
argument_list|,
literal|"*** The problem is: %s%s\n"
argument_list|,
name|m2
argument_list|,
name|m3
argument_list|)
expr_stmt|;
name|proceed
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|error
parameter_list|(
name|m
parameter_list|)
name|string
name|m
decl_stmt|;
block|{
name|message
argument_list|(
literal|"*** Cannot cope with problem"
argument_list|,
name|m
argument_list|,
literal|""
argument_list|,
name|No
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|parerr
parameter_list|(
name|m
parameter_list|,
name|ss
parameter_list|)
name|string
name|m
decl_stmt|,
name|ss
decl_stmt|;
block|{
name|message
argument_list|(
literal|"*** There's something I don't understand"
argument_list|,
name|m
argument_list|,
name|ss
argument_list|,
name|Yes
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|pprerr
parameter_list|(
name|m
parameter_list|,
name|ss
parameter_list|)
name|string
name|m
decl_stmt|,
name|ss
decl_stmt|;
block|{
name|message
argument_list|(
literal|"*** There's something I don't understand"
argument_list|,
name|m
argument_list|,
name|ss
argument_list|,
name|No
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|checkerr
parameter_list|()
block|{
name|Line
argument_list|()
expr_stmt|;
name|errmess
argument_list|(
literal|"*** Your check failed"
argument_list|)
expr_stmt|;
name|show_where
argument_list|(
name|No
argument_list|,
name|Yes
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|main_loop
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|Procedure
name|int_signal
parameter_list|(
name|in_read
parameter_list|)
name|bool
name|in_read
decl_stmt|;
block|{
if|if
condition|(
name|cntxt
operator|==
name|In_prmnv
condition|)
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|interactive
condition|)
block|{
name|interrupt
argument_list|(
name|in_read
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in_read
condition|)
name|accept_int
argument_list|()
expr_stmt|;
name|longjmp
argument_list|(
name|main_loop
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fix_files
argument_list|()
expr_stmt|;
if|if
condition|(
name|interactive
condition|)
block|{
name|interrupt
argument_list|(
name|in_read
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in_read
condition|)
name|accept_int
argument_list|()
expr_stmt|;
name|process
argument_list|()
expr_stmt|;
block|}
else|else
name|bye
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|interrupt
parameter_list|(
name|in_read
parameter_list|)
name|bool
name|in_read
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|in_read
condition|)
name|at_nwl
operator|=
name|No
expr_stmt|;
name|Line
argument_list|()
expr_stmt|;
name|errmess
argument_list|(
name|in_read
condition|?
literal|"*** READ aborted\n"
else|:
literal|"*** interrupted\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|filtered
condition|)
name|errmess
argument_list|(
literal|"\177"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cntxt
operator|==
name|In_read
operator|||
name|active_reads
operator|>
literal|0
condition|)
name|set_context
argument_list|(
operator|&
name|read_context
argument_list|)
expr_stmt|;
comment|/* show_where(No, was_interactive); */
block|}
end_function

begin_decl_stmt
name|bool
name|bugs
init|=
name|No
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bool
name|tracing
init|=
name|No
decl_stmt|;
end_decl_stmt

begin_function
name|Visible
name|Procedure
name|debug
parameter_list|(
name|m
parameter_list|)
name|string
name|m
decl_stmt|;
block|{
if|if
condition|(
name|bugs
condition|)
block|{
name|Line
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|Errout
argument_list|,
literal|"*** Debugging (xeq = %s, cur_ilev = %d)"
argument_list|,
name|xeq
condition|?
literal|"Yes"
else|:
literal|"No"
argument_list|,
name|cur_ilev
argument_list|)
expr_stmt|;
name|show_where
argument_list|(
name|Yes
argument_list|,
name|Yes
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|Errout
argument_list|,
literal|"*** %s\n"
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|Visible
name|Procedure
name|trace
parameter_list|()
block|{
name|VOID
name|display_line
argument_list|(
name|tx
argument_list|)
decl_stmt|;
block|}
end_function

end_unit


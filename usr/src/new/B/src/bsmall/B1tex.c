begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) Stichting Mathematisch Centrum, Amsterdam, 1984. */
end_comment

begin_comment
comment|/* $Header: B1tex.c,v 1.1 84/06/28 00:48:59 timo Exp $ */
end_comment

begin_comment
comment|/* B texts */
end_comment

begin_include
include|#
directive|include
file|"b.h"
end_include

begin_include
include|#
directive|include
file|"b1obj.h"
end_include

begin_include
include|#
directive|include
file|"B1tlt.h"
end_include

begin_comment
comment|/* for Cts */
end_comment

begin_function
name|Visible
name|value
name|mk_text
parameter_list|(
name|m
parameter_list|)
name|string
name|m
decl_stmt|;
block|{
name|value
name|v
decl_stmt|;
name|intlet
name|len
init|=
name|strlen
argument_list|(
name|m
argument_list|)
decl_stmt|;
name|v
operator|=
name|grab_tex
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|Str
argument_list|(
name|v
argument_list|)
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
name|v
return|;
block|}
end_function

begin_function
name|Visible
name|bool
name|character
parameter_list|(
name|v
parameter_list|)
name|value
name|v
decl_stmt|;
block|{
if|if
condition|(
name|Is_text
argument_list|(
name|v
argument_list|)
operator|&&
name|Length
argument_list|(
name|v
argument_list|)
operator|==
literal|1
condition|)
return|return
name|Yes
return|;
else|else
return|return
name|No
return|;
block|}
end_function

begin_function
name|Visible
name|char
name|charval
parameter_list|(
name|v
parameter_list|)
name|value
name|v
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|Is_text
argument_list|(
name|v
argument_list|)
operator|||
name|Length
argument_list|(
name|v
argument_list|)
operator|!=
literal|1
condition|)
name|error
argument_list|(
literal|"value not a character"
argument_list|)
expr_stmt|;
return|return
operator|*
name|Str
argument_list|(
name|v
argument_list|)
return|;
block|}
end_function

begin_function
name|Visible
name|string
name|strval
parameter_list|(
name|v
parameter_list|)
name|value
name|v
decl_stmt|;
block|{
return|return
name|Str
argument_list|(
name|v
argument_list|)
return|;
block|}
end_function

begin_function
name|Visible
name|value
name|concat
parameter_list|(
name|s
parameter_list|,
name|t
parameter_list|)
name|value
name|s
decl_stmt|,
name|t
decl_stmt|;
block|{
name|value
name|c
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|type
operator|!=
name|Tex
condition|)
name|error
argument_list|(
literal|"in t^u, t is not a text"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|t
operator|->
name|type
operator|!=
name|Tex
condition|)
name|error
argument_list|(
literal|"in t^u, t is a text, but u is not"
argument_list|)
expr_stmt|;
name|c
operator|=
name|grab_tex
argument_list|(
name|Length
argument_list|(
name|s
argument_list|)
operator|+
name|Length
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|Str
argument_list|(
name|c
argument_list|)
argument_list|,
name|Str
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|Str
argument_list|(
name|c
argument_list|)
operator|+
name|Length
argument_list|(
name|s
argument_list|)
argument_list|,
name|Str
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|c
return|;
block|}
end_function

begin_function
name|Hidden
name|Procedure
name|concato
parameter_list|(
name|s
parameter_list|,
name|t
parameter_list|)
name|value
modifier|*
name|s
decl_stmt|;
name|string
name|t
decl_stmt|;
block|{
if|if
condition|(
operator|(
operator|*
name|s
operator|)
operator|->
name|type
operator|!=
name|Tex
condition|)
name|error
argument_list|(
literal|"attempt to join text with non-text"
argument_list|)
expr_stmt|;
name|xtndtex
argument_list|(
name|s
argument_list|,
name|strlen
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|Str
argument_list|(
operator|*
name|s
argument_list|)
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Visible
name|value
name|trim
parameter_list|(
name|v
parameter_list|,
name|B
parameter_list|,
name|C
parameter_list|)
name|value
name|v
decl_stmt|;
name|intlet
name|B
decl_stmt|,
name|C
decl_stmt|;
block|{
name|intlet
name|len
init|=
name|Length
argument_list|(
name|v
argument_list|)
decl_stmt|,
name|k
decl_stmt|;
name|value
name|w
decl_stmt|;
name|string
name|vp
init|=
name|Str
argument_list|(
name|v
argument_list|)
operator|+
name|B
decl_stmt|,
name|wp
decl_stmt|;
if|if
condition|(
name|v
operator|->
name|type
operator|!=
name|Tex
condition|)
name|error
argument_list|(
literal|"trim (@ or |) applied to non-text"
argument_list|)
expr_stmt|;
if|if
condition|(
name|B
operator|<
literal|0
operator|||
name|C
operator|<
literal|0
operator|||
name|B
operator|+
name|C
operator|>
name|len
condition|)
name|error
argument_list|(
literal|"trim (@ or |) out of bounds"
argument_list|)
expr_stmt|;
name|w
operator|=
name|grab_tex
argument_list|(
name|len
operator|-=
operator|(
name|B
operator|+
name|C
operator|)
argument_list|)
expr_stmt|;
name|wp
operator|=
name|Str
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|Overall
operator|*
name|wp
operator|++
operator|=
operator|*
name|vp
operator|++
expr_stmt|;
operator|*
name|wp
operator|=
literal|'\0'
expr_stmt|;
return|return
name|w
return|;
block|}
end_function

begin_function
name|Visible
name|value
name|repeat
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
name|value
name|x
decl_stmt|,
name|y
decl_stmt|;
block|{
name|value
name|r
decl_stmt|;
name|intlet
name|i
init|=
name|propintlet
argument_list|(
name|intval
argument_list|(
name|y
argument_list|)
argument_list|)
decl_stmt|;
name|intlet
name|xl
init|=
name|Length
argument_list|(
name|x
argument_list|)
decl_stmt|,
name|p
decl_stmt|,
name|q
decl_stmt|;
name|string
name|rp
decl_stmt|,
name|xp
decl_stmt|;
if|if
condition|(
name|x
operator|->
name|type
operator|!=
name|Tex
condition|)
name|error
argument_list|(
literal|"in t^^n, t is not a text"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
name|error
argument_list|(
literal|"in t^^n, n is negative"
argument_list|)
expr_stmt|;
name|r
operator|=
name|grab_tex
argument_list|(
name|propintlet
argument_list|(
name|i
operator|*
name|xl
argument_list|)
argument_list|)
expr_stmt|;
name|rp
operator|=
name|Str
argument_list|(
name|r
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
literal|0
init|;
name|p
operator|<
name|i
condition|;
name|p
operator|++
control|)
block|{
name|xp
operator|=
name|Str
argument_list|(
name|x
argument_list|)
expr_stmt|;
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|xl
condition|;
name|q
operator|++
control|)
operator|*
name|rp
operator|++
operator|=
operator|*
name|xp
operator|++
expr_stmt|;
block|}
operator|*
name|rp
operator|=
literal|'\0'
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_define
define|#
directive|define
name|Left
value|'L'
end_define

begin_define
define|#
directive|define
name|Right
value|'R'
end_define

begin_define
define|#
directive|define
name|Centre
value|'C'
end_define

begin_function
name|Hidden
name|value
name|adj
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|side
parameter_list|)
name|value
name|x
decl_stmt|,
name|y
decl_stmt|;
name|literal
name|side
decl_stmt|;
block|{
name|value
name|r
decl_stmt|,
name|v
init|=
name|convert
argument_list|(
name|x
argument_list|,
name|Yes
argument_list|,
name|Yes
argument_list|)
decl_stmt|;
name|int
name|i
init|=
name|intval
argument_list|(
name|y
argument_list|)
decl_stmt|;
name|intlet
name|lv
init|=
name|Length
argument_list|(
name|v
argument_list|)
decl_stmt|,
name|la
decl_stmt|,
name|k
decl_stmt|,
name|ls
decl_stmt|,
name|rs
decl_stmt|;
name|string
name|rp
decl_stmt|,
name|vp
decl_stmt|;
name|la
operator|=
name|propintlet
argument_list|(
name|i
argument_list|)
operator|-
name|lv
expr_stmt|;
if|if
condition|(
name|la
operator|<=
literal|0
condition|)
return|return
name|v
return|;
name|r
operator|=
name|grab_tex
argument_list|(
name|lv
operator|+
name|la
argument_list|)
expr_stmt|;
name|rp
operator|=
name|Str
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|vp
operator|=
name|Str
argument_list|(
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|side
operator|==
name|Left
condition|)
block|{
name|ls
operator|=
literal|0
expr_stmt|;
name|rs
operator|=
name|la
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|side
operator|==
name|Centre
condition|)
block|{
name|ls
operator|=
name|la
operator|/
literal|2
expr_stmt|;
name|rs
operator|=
operator|(
name|la
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
block|}
else|else
block|{
name|ls
operator|=
name|la
expr_stmt|;
name|rs
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|ls
condition|;
name|k
operator|++
control|)
operator|*
name|rp
operator|++
operator|=
literal|' '
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|lv
condition|;
name|k
operator|++
control|)
operator|*
name|rp
operator|++
operator|=
operator|*
name|vp
operator|++
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|rs
condition|;
name|k
operator|++
control|)
operator|*
name|rp
operator|++
operator|=
literal|' '
expr_stmt|;
operator|*
name|rp
operator|=
literal|0
expr_stmt|;
name|release
argument_list|(
name|v
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|Visible
name|value
name|adjleft
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
name|value
name|x
decl_stmt|,
name|y
decl_stmt|;
block|{
return|return
name|adj
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|Left
argument_list|)
return|;
block|}
end_function

begin_function
name|Visible
name|value
name|centre
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
name|value
name|x
decl_stmt|,
name|y
decl_stmt|;
block|{
return|return
name|adj
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|Centre
argument_list|)
return|;
block|}
end_function

begin_function
name|Visible
name|value
name|adjright
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
name|value
name|x
decl_stmt|,
name|y
decl_stmt|;
block|{
return|return
name|adj
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|Right
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* For reasons of efficiency, wri does not always call convert but writes    directly on the standard output. Modifications in convert should    be mirrored by changes in wri and vice versa. */
end_comment

begin_function
name|Visible
name|value
name|convert
parameter_list|(
name|v
parameter_list|,
name|coll
parameter_list|,
name|outer
parameter_list|)
name|value
name|v
decl_stmt|;
name|bool
name|coll
decl_stmt|,
name|outer
decl_stmt|;
block|{
name|literal
name|type
init|=
name|v
operator|->
name|type
decl_stmt|;
name|intlet
name|len
init|=
name|Length
argument_list|(
name|v
argument_list|)
decl_stmt|,
name|k
decl_stmt|;
name|value
modifier|*
name|vp
init|=
name|Ats
argument_list|(
name|v
argument_list|)
decl_stmt|;
name|value
name|t
decl_stmt|,
name|cv
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|Num
case|:
return|return
name|mk_text
argument_list|(
name|convnum
argument_list|(
name|v
argument_list|)
argument_list|)
return|;
case|case
name|Tex
case|:
if|if
condition|(
name|outer
condition|)
return|return
name|copy
argument_list|(
name|v
argument_list|)
return|;
else|else
block|{
name|string
name|tp
init|=
operator|(
name|string
operator|)
name|vp
decl_stmt|;
name|char
name|cs
index|[
literal|2
index|]
decl_stmt|;
name|cs
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|t
operator|=
name|mk_text
argument_list|(
literal|"'"
argument_list|)
expr_stmt|;
name|Overall
block|{
name|cs
index|[
literal|0
index|]
operator|=
operator|*
name|tp
operator|++
expr_stmt|;
name|concato
argument_list|(
operator|&
name|t
argument_list|,
name|cs
argument_list|)
expr_stmt|;
if|if
condition|(
name|cs
index|[
literal|0
index|]
operator|==
literal|'\''
operator|||
name|cs
index|[
literal|0
index|]
operator|==
literal|'`'
condition|)
name|concato
argument_list|(
operator|&
name|t
argument_list|,
name|cs
argument_list|)
expr_stmt|;
block|}
name|concato
argument_list|(
operator|&
name|t
argument_list|,
literal|"'"
argument_list|)
expr_stmt|;
return|return
name|t
return|;
block|}
case|case
name|Com
case|:
name|outer
operator|&=
name|coll
expr_stmt|;
name|t
operator|=
name|mk_text
argument_list|(
name|coll
condition|?
literal|""
else|:
literal|"("
argument_list|)
expr_stmt|;
name|Overall
block|{
name|concato
argument_list|(
operator|&
name|t
argument_list|,
name|Str
argument_list|(
name|cv
operator|=
name|convert
argument_list|(
operator|*
name|vp
operator|++
argument_list|,
name|No
argument_list|,
name|outer
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|release
argument_list|(
name|cv
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|!=
name|len
operator|-
literal|1
condition|)
name|concato
argument_list|(
operator|&
name|t
argument_list|,
name|outer
condition|?
literal|" "
else|:
literal|", "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|coll
condition|)
name|concato
argument_list|(
operator|&
name|t
argument_list|,
literal|")"
argument_list|)
expr_stmt|;
return|return
name|t
return|;
case|case
name|Lis
case|:
case|case
name|ELT
case|:
name|t
operator|=
name|mk_text
argument_list|(
literal|"{"
argument_list|)
expr_stmt|;
name|Overall
block|{
name|concato
argument_list|(
operator|&
name|t
argument_list|,
name|Str
argument_list|(
name|cv
operator|=
name|convert
argument_list|(
operator|*
name|vp
operator|++
argument_list|,
name|No
argument_list|,
name|No
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|release
argument_list|(
name|cv
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|!=
name|len
operator|-
literal|1
condition|)
name|concato
argument_list|(
operator|&
name|t
argument_list|,
literal|"; "
argument_list|)
expr_stmt|;
block|}
name|concato
argument_list|(
operator|&
name|t
argument_list|,
literal|"}"
argument_list|)
expr_stmt|;
return|return
name|t
return|;
case|case
name|Tab
case|:
name|t
operator|=
name|mk_text
argument_list|(
literal|"{"
argument_list|)
expr_stmt|;
name|Overall
block|{
name|concato
argument_list|(
operator|&
name|t
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
name|concato
argument_list|(
operator|&
name|t
argument_list|,
name|Str
argument_list|(
name|cv
operator|=
name|convert
argument_list|(
name|Cts
argument_list|(
operator|*
name|vp
argument_list|)
argument_list|,
name|Yes
argument_list|,
name|No
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|release
argument_list|(
name|cv
argument_list|)
expr_stmt|;
name|concato
argument_list|(
operator|&
name|t
argument_list|,
literal|"]: "
argument_list|)
expr_stmt|;
name|concato
argument_list|(
operator|&
name|t
argument_list|,
name|Str
argument_list|(
name|cv
operator|=
name|convert
argument_list|(
name|Dts
argument_list|(
operator|*
name|vp
operator|++
argument_list|)
argument_list|,
name|No
argument_list|,
name|No
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|release
argument_list|(
name|cv
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|!=
name|len
operator|-
literal|1
condition|)
name|concato
argument_list|(
operator|&
name|t
argument_list|,
literal|"; "
argument_list|)
expr_stmt|;
block|}
name|concato
argument_list|(
operator|&
name|t
argument_list|,
literal|"}"
argument_list|)
expr_stmt|;
return|return
name|t
return|;
default|default:
name|syserr
argument_list|(
literal|"converting value of unknown type"
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
name|Dummy
return|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1984, 1985, 1986 Xerox Corp.  *  *    This module reads a compressed bitmap file in the MacPaint  *    format and outputs an RES file.  *  *    For a description of RES (Raster Encoding Standard) see  *    the booklet entitled "Raster Encoding Standard" XNS Standard 178506  *    (June, 1985)  *  * HISTORY  * 21-Jul-86  Lee Moore (lee) at Xerox Webster Research Center  *	Added the ability to generate IP masters, too.  *  * 07-Jul-86  Lee Moore (lee) at Xerox Webster Research Center  *	Converted for use with getopt.  *  * 03-Jun-86  Lee Moore (lee) at Xerox Webster Research Center  *	Created mp2res from readmac.c .  *  *  * K. Knox, 10-Dec-84 18:51:22, Created readmac.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"iptokens.h"
end_include

begin_include
include|#
directive|include
file|"literal.h"
end_include

begin_include
include|#
directive|include
file|"operator.h"
end_include

begin_define
define|#
directive|define
name|err0
value|"usage: readmac filename\n"
end_define

begin_define
define|#
directive|define
name|err1
value|"mp2res: Could not open, %s.\n"
end_define

begin_define
define|#
directive|define
name|TRUE
value|1
end_define

begin_define
define|#
directive|define
name|FALSE
value|0
end_define

begin_comment
comment|/* External procedures. */
end_comment

begin_function_decl
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  * Main program  *	parse command line  *	call ProcessData to do the work  */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|c
decl_stmt|;
name|int
name|firstRow
init|=
literal|0
decl_stmt|,
name|lastRow
init|=
operator|(
literal|720
operator|-
literal|1
operator|)
decl_stmt|,
name|firstColumn
init|=
literal|0
decl_stmt|,
name|lastColumn
init|=
operator|(
literal|576
operator|-
literal|1
operator|)
decl_stmt|,
name|outputFileFD
decl_stmt|,
name|makeInterpress
init|=
name|FALSE
decl_stmt|;
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
extern|extern optind;
name|FILE
modifier|*
name|inputFileDesc
decl_stmt|;
name|outputFileFD
operator|=
literal|1
expr_stmt|;
comment|/* standard out */
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"it:b:l:o:r:"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'i'
case|:
name|makeInterpress
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
comment|/* top */
name|firstRow
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
comment|/* bottom */
name|lastRow
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
comment|/* left */
name|firstColumn
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
comment|/* output file */
if|if
condition|(
operator|(
name|outputFileFD
operator|=
name|creat
argument_list|(
name|optarg
argument_list|,
literal|0664
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"mp2res: can't open %s for writing\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'r'
case|:
comment|/* right */
name|lastColumn
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"ipmetrics: option '%c' not allowed\n"
argument_list|)
expr_stmt|;
block|}
comment|/* do we read from standard input? */
if|if
condition|(
name|argc
operator|==
name|optind
condition|)
block|{
name|inputFileDesc
operator|=
name|stdin
expr_stmt|;
block|}
else|else
block|{
comment|/* open the MacPaint file */
if|if
condition|(
operator|(
name|inputFileDesc
operator|=
name|fopen
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|err1
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|makeInterpress
condition|)
name|MakeRES
argument_list|(
name|inputFileDesc
argument_list|,
name|outputFileFD
argument_list|,
name|firstRow
argument_list|,
name|lastRow
argument_list|,
name|firstColumn
argument_list|,
name|lastColumn
argument_list|)
expr_stmt|;
else|else
name|MakeIP
argument_list|(
name|inputFileDesc
argument_list|,
name|outputFileFD
argument_list|,
name|firstRow
argument_list|,
name|lastRow
argument_list|,
name|firstColumn
argument_list|,
name|lastColumn
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Convert a MacPaint document to an RES file  *	don't copy the data that the user doesn't want  */
end_comment

begin_macro
name|MakeRES
argument_list|(
argument|inputFileDesc
argument_list|,
argument|outputFileFD
argument_list|,
argument|firstRow
argument_list|,
argument|lastRow
argument_list|,
argument|firstColumn
argument_list|,
argument|lastColumn
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|inputFileDesc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|outputFileFD
decl_stmt|,
name|firstRow
decl_stmt|,
name|lastRow
decl_stmt|,
name|firstColumn
decl_stmt|,
name|lastColumn
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|bufferSize
decl_stmt|;
name|int
name|pixelsPerScanLine
decl_stmt|,
name|numberOfScanLines
decl_stmt|,
name|bytesPerScanLine
decl_stmt|;
name|unsigned
name|char
modifier|*
name|image
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|pixelsPerScanLine
operator|=
name|lastColumn
operator|-
name|firstColumn
operator|+
literal|1
expr_stmt|;
name|numberOfScanLines
operator|=
name|lastRow
operator|-
name|firstRow
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|pixelsPerScanLine
operator|%
literal|32
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"internal error: %d is not a multiple of 32\n"
argument_list|,
name|pixelsPerScanLine
argument_list|)
expr_stmt|;
name|bytesPerScanLine
operator|=
operator|(
name|pixelsPerScanLine
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
comment|/* skip over MacPaint header */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|512
condition|;
name|i
operator|++
control|)
name|getc
argument_list|(
name|inputFileDesc
argument_list|)
expr_stmt|;
name|bufferSize
operator|=
name|bytesPerScanLine
operator|*
name|numberOfScanLines
expr_stmt|;
name|image
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|bufferSize
argument_list|)
expr_stmt|;
name|res_select
argument_list|(
name|outputFileFD
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_beginBlock
argument_list|)
expr_stmt|;
comment|/* element 1: imageScale */
name|AppendRational
argument_list|(
literal|254L
argument_list|,
literal|72L
operator|*
literal|100
operator|*
literal|100
argument_list|)
expr_stmt|;
comment|/* assume 72 spots/inch */
name|AppendOp
argument_list|(
name|OP_dup
argument_list|)
expr_stmt|;
name|AppendInteger
argument_list|(
literal|2L
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_makevec
argument_list|)
expr_stmt|;
comment|/* element 2: xDimension */
name|AppendInteger
argument_list|(
operator|(
name|long
operator|)
name|pixelsPerScanLine
argument_list|)
expr_stmt|;
comment|/* xPixels */
comment|/* element 3: yDimension */
name|AppendInteger
argument_list|(
operator|(
name|long
operator|)
name|numberOfScanLines
argument_list|)
expr_stmt|;
comment|/* yPixels */
comment|/* element 4: maskImage */
name|AppendInteger
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
comment|/* maskImage */
comment|/* element 5: colorImage */
name|AppendInteger
argument_list|(
operator|(
name|long
operator|)
name|numberOfScanLines
argument_list|)
expr_stmt|;
comment|/* yPixels */
name|AppendInteger
argument_list|(
operator|(
name|long
operator|)
name|pixelsPerScanLine
argument_list|)
expr_stmt|;
comment|/* xPixels */
name|AppendInteger
argument_list|(
literal|1L
argument_list|)
expr_stmt|;
comment|/* sampelsPerPixel */
name|AppendInteger
argument_list|(
literal|1L
argument_list|)
expr_stmt|;
comment|/* maxSampleValue */
name|AppendInteger
argument_list|(
literal|1L
argument_list|)
expr_stmt|;
comment|/* samplesInterleaved */
comment|/* enter transformation to bring it to row major order */
name|AppendInteger
argument_list|(
operator|-
literal|90L
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_rotate
argument_list|)
expr_stmt|;
name|AppendInteger
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
name|AppendInteger
argument_list|(
operator|(
name|long
operator|)
name|numberOfScanLines
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_translate
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_concat
argument_list|)
expr_stmt|;
comment|/* skip over as many rows as needed */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|firstRow
condition|;
name|i
operator|++
control|)
name|readscan
argument_list|(
name|inputFileDesc
argument_list|,
name|image
argument_list|)
expr_stmt|;
comment|/* read the scan lines in */
for|for
control|(
name|i
operator|=
name|firstRow
operator|,
name|p
operator|=
name|image
init|;
name|i
operator|<=
name|lastRow
condition|;
name|i
operator|++
operator|,
name|p
operator|+=
name|bytesPerScanLine
control|)
name|readscan
argument_list|(
name|inputFileDesc
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|AppendPPVector
argument_list|(
name|bufferSize
argument_list|,
literal|1
argument_list|,
name|pixelsPerScanLine
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|image
argument_list|)
expr_stmt|;
name|Op
argument_list|(
name|makepixelarray
argument_list|)
expr_stmt|;
comment|/* make the array */
comment|/* element 6: colorOperator */
name|AppendInteger
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
comment|/* element 7: image Properties */
name|AppendIdentifier
argument_list|(
literal|"imageDescription"
argument_list|)
expr_stmt|;
name|AppendString
argument_list|(
literal|"made from a MacPaint file"
argument_list|)
expr_stmt|;
name|Makevec
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* element 8: signature */
name|AppendInteger
argument_list|(
literal|13086L
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_endBlock
argument_list|)
expr_stmt|;
name|ip_flush
argument_list|()
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|image
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|MakeIP
argument_list|(
argument|inputFileDesc
argument_list|,
argument|outputFileFD
argument_list|,
argument|firstRow
argument_list|,
argument|lastRow
argument_list|,
argument|firstColumn
argument_list|,
argument|lastColumn
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|inputFileDesc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|outputFileFD
decl_stmt|,
name|firstRow
decl_stmt|,
name|lastRow
decl_stmt|,
name|firstColumn
decl_stmt|,
name|lastColumn
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|bufferSize
decl_stmt|;
name|int
name|pixelsPerScanLine
decl_stmt|,
name|numberOfScanLines
decl_stmt|,
name|bytesPerScanLine
decl_stmt|;
name|unsigned
name|char
modifier|*
name|image
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|pixelsPerScanLine
operator|=
name|lastColumn
operator|-
name|firstColumn
operator|+
literal|1
expr_stmt|;
name|numberOfScanLines
operator|=
name|lastRow
operator|-
name|firstRow
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|pixelsPerScanLine
operator|%
literal|32
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d is not a multiple of 32\n"
argument_list|,
name|pixelsPerScanLine
argument_list|)
expr_stmt|;
name|bytesPerScanLine
operator|=
operator|(
name|pixelsPerScanLine
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|512
condition|;
name|i
operator|++
control|)
name|getc
argument_list|(
name|inputFileDesc
argument_list|)
expr_stmt|;
name|bufferSize
operator|=
name|bytesPerScanLine
operator|*
name|numberOfScanLines
expr_stmt|;
name|image
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|bufferSize
argument_list|)
expr_stmt|;
name|ip_select
argument_list|(
name|outputFileFD
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_beginBlock
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_beginBody
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_endBody
argument_list|)
expr_stmt|;
comment|/* end preamble */
name|AppendOp
argument_list|(
name|OP_beginBody
argument_list|)
expr_stmt|;
comment|/* page 1 (and only) */
name|AppendRational
argument_list|(
literal|254L
argument_list|,
literal|72L
operator|*
literal|100
operator|*
literal|100
argument_list|)
expr_stmt|;
comment|/* assume 72 spots/inch */
name|AppendOp
argument_list|(
name|OP_scale
argument_list|)
expr_stmt|;
name|Translate
argument_list|(
literal|.5
operator|*
literal|.0254
argument_list|,
literal|.25
operator|*
literal|.0254
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_concat
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_concatt
argument_list|)
expr_stmt|;
name|AppendInteger
argument_list|(
operator|(
name|long
operator|)
name|numberOfScanLines
argument_list|)
expr_stmt|;
comment|/* yPixels */
name|AppendInteger
argument_list|(
operator|(
name|long
operator|)
name|pixelsPerScanLine
argument_list|)
expr_stmt|;
comment|/* xPixels */
name|AppendInteger
argument_list|(
literal|1L
argument_list|)
expr_stmt|;
comment|/* sampelsPerPixel */
name|AppendInteger
argument_list|(
literal|1L
argument_list|)
expr_stmt|;
comment|/* maxSampleValue */
name|AppendInteger
argument_list|(
literal|1L
argument_list|)
expr_stmt|;
comment|/* samplesInterleaved */
comment|/* enter transformation to bring it to row major order */
name|AppendInteger
argument_list|(
operator|-
literal|90L
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_rotate
argument_list|)
expr_stmt|;
name|AppendInteger
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
name|AppendInteger
argument_list|(
operator|(
name|long
operator|)
name|numberOfScanLines
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_translate
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_concat
argument_list|)
expr_stmt|;
comment|/* skip over as many rows as needed */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|firstRow
condition|;
name|i
operator|++
control|)
name|readscan
argument_list|(
name|inputFileDesc
argument_list|,
name|image
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|firstRow
operator|,
name|p
operator|=
name|image
init|;
name|i
operator|<=
name|lastRow
condition|;
name|i
operator|++
operator|,
name|p
operator|+=
name|bytesPerScanLine
control|)
name|readscan
argument_list|(
name|inputFileDesc
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* output the result to the Interpress file */
name|AppendPPVector
argument_list|(
name|bufferSize
argument_list|,
literal|1
argument_list|,
name|pixelsPerScanLine
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|image
argument_list|)
expr_stmt|;
name|Op
argument_list|(
name|makepixelarray
argument_list|)
expr_stmt|;
comment|/* make the array */
comment|/* draw a box around the pixel array */
name|AppendInteger
argument_list|(
literal|1L
argument_list|)
expr_stmt|;
comment|/* unit stroke width */
name|AppendInteger
argument_list|(
literal|15L
argument_list|)
expr_stmt|;
comment|/* stroke width imager variable */
name|AppendOp
argument_list|(
name|OP_iset
argument_list|)
expr_stmt|;
name|AppendRational
argument_list|(
operator|-
literal|1L
argument_list|,
literal|2L
argument_list|)
expr_stmt|;
name|AppendRational
argument_list|(
operator|-
literal|1L
argument_list|,
literal|2L
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_moveto
argument_list|)
expr_stmt|;
name|AppendInteger
argument_list|(
call|(
name|long
call|)
argument_list|(
name|numberOfScanLines
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_linetoy
argument_list|)
expr_stmt|;
name|AppendInteger
argument_list|(
call|(
name|long
call|)
argument_list|(
name|pixelsPerScanLine
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_linetox
argument_list|)
expr_stmt|;
name|AppendRational
argument_list|(
operator|-
literal|1L
argument_list|,
literal|2L
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_linetoy
argument_list|)
expr_stmt|;
name|AppendRational
argument_list|(
operator|-
literal|1L
argument_list|,
literal|2L
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_linetox
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_maskstroke
argument_list|)
expr_stmt|;
comment|/* prepare to show pixel array */
name|AppendInteger
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
name|AppendInteger
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_setxy
argument_list|)
expr_stmt|;
name|Op
argument_list|(
name|maskpixel
argument_list|)
expr_stmt|;
comment|/* show it */
name|AppendOp
argument_list|(
name|OP_endBody
argument_list|)
expr_stmt|;
name|AppendOp
argument_list|(
name|OP_endBlock
argument_list|)
expr_stmt|;
name|ip_flush
argument_list|()
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|image
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Read the next scan line from the MacPaint file  */
end_comment

begin_macro
name|readscan
argument_list|(
argument|inputFileDesc
argument_list|,
argument|image
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|inputFileDesc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|image
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|in_pos
decl_stmt|,
name|count
decl_stmt|,
name|data_byte
decl_stmt|;
name|in_pos
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|in_pos
operator|<
literal|72
condition|)
block|{
name|count
operator|=
name|getc
argument_list|(
name|inputFileDesc
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|127
condition|)
name|count
operator|-=
literal|256
expr_stmt|;
if|if
condition|(
name|count
operator|>=
literal|0
condition|)
block|{
comment|/* run of raw bytes */
name|count
operator|++
expr_stmt|;
comment|/* # of bytes to read */
while|while
condition|(
name|count
operator|--
condition|)
name|image
index|[
name|in_pos
operator|++
index|]
operator|=
name|getc
argument_list|(
name|inputFileDesc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* run of repeated byte */
name|count
operator|=
operator|-
name|count
operator|+
literal|1
expr_stmt|;
comment|/* repetition factor */
name|data_byte
operator|=
name|getc
argument_list|(
name|inputFileDesc
argument_list|)
expr_stmt|;
comment|/* byte to repeat */
while|while
condition|(
name|count
operator|--
condition|)
name|image
index|[
name|in_pos
operator|++
index|]
operator|=
name|data_byte
expr_stmt|;
block|}
block|}
block|}
end_block

end_unit


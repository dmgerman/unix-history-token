begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* stack.c  *  * Copyright (c) 1984, 1985 Xerox Corp.  *  * This module manipulates the RES stack.  *  */
end_comment

begin_include
include|#
directive|include
file|"stack.h"
end_include

begin_decl_stmt
specifier|extern
name|long
name|filepos
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|unsigned
name|char
modifier|*
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* Private procedures defined in this module. */
end_comment

begin_function_decl
specifier|extern
name|unsigned
name|char
modifier|*
name|makeitem
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|double
name|readdouble
parameter_list|()
function_decl|;
end_function_decl

begin_struct
struct|struct
name|item
block|{
name|int
name|length
decl_stmt|;
comment|/* total byte length of this stack item. */
name|struct
name|item
modifier|*
name|next
decl_stmt|;
comment|/* next element on the stack. */
name|int
name|type
decl_stmt|;
comment|/* stack element type. */
name|int
name|subtype
decl_stmt|;
comment|/* subtype within this type. */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|number
block|{
name|int
name|length
decl_stmt|;
name|struct
name|item
modifier|*
name|next
decl_stmt|;
name|int
name|type
decl_stmt|;
name|int
name|subtype
decl_stmt|;
name|unsigned
name|char
name|nbytes
decl_stmt|;
name|unsigned
name|char
name|num
index|[
literal|1
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|string
block|{
name|int
name|length
decl_stmt|;
name|struct
name|item
modifier|*
name|next
decl_stmt|;
name|int
name|type
decl_stmt|;
name|int
name|subtype
decl_stmt|;
name|char
name|s
index|[
literal|1
index|]
decl_stmt|;
comment|/* the string follows here, above char gives room for terminating null */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|vector
block|{
name|int
name|length
decl_stmt|;
name|struct
name|item
modifier|*
name|next
decl_stmt|;
name|int
name|type
decl_stmt|;
name|int
name|subtype
decl_stmt|;
name|int
name|depth
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|integers
block|{
name|int
name|length
decl_stmt|;
name|struct
name|item
modifier|*
name|next
decl_stmt|;
name|int
name|type
decl_stmt|;
name|int
name|subtype
decl_stmt|;
name|int
name|bytesPerInteger
decl_stmt|;
name|long
name|bytepos
decl_stmt|;
name|long
name|bytelength
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|transformation
block|{
name|int
name|length
decl_stmt|;
name|struct
name|item
modifier|*
name|next
decl_stmt|;
name|int
name|type
decl_stmt|;
name|int
name|subtype
decl_stmt|;
name|double
name|a
decl_stmt|;
name|double
name|b
decl_stmt|;
name|double
name|c
decl_stmt|;
name|double
name|d
decl_stmt|;
name|double
name|e
decl_stmt|;
name|double
name|f
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|item
modifier|*
name|stack
init|=
operator|(
expr|struct
name|item
operator|*
operator|)
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|err0
value|"(%d) stack: pop called on an empty stack!\n"
end_define

begin_define
define|#
directive|define
name|err1
value|"(%d) stack: expecting type (%s, %s), got (%d, %d)!\n"
end_define

begin_define
define|#
directive|define
name|err2
value|"(%d) stack: should be 8 elements in pixelarray, got %d!\n"
end_define

begin_comment
comment|/*  *  Items on the stack.  *  */
end_comment

begin_macro
name|stackempty
argument_list|()
end_macro

begin_block
block|{
return|return
operator|(
name|stack
operator|==
operator|(
expr|struct
name|item
operator|*
operator|)
literal|0
operator|)
return|;
block|}
end_block

begin_function
name|unsigned
name|char
modifier|*
name|pop
parameter_list|(
name|type
parameter_list|,
name|subtype
parameter_list|)
name|int
name|type
decl_stmt|,
name|subtype
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|struct
name|item
modifier|*
name|pitem
decl_stmt|;
name|pitem
operator|=
name|stack
expr_stmt|;
if|if
condition|(
name|pitem
operator|==
operator|(
expr|struct
name|item
operator|*
operator|)
literal|0
condition|)
name|error
argument_list|(
name|err0
argument_list|,
name|filepos
argument_list|)
expr_stmt|;
name|stack
operator|=
name|pitem
operator|->
name|next
expr_stmt|;
name|ptr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|pitem
expr_stmt|;
name|checktype
argument_list|(
name|ptr
argument_list|,
name|type
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_macro
name|push
argument_list|(
argument|pitem
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|item
modifier|*
name|pitem
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pitem
operator|->
name|next
operator|=
name|stack
expr_stmt|;
name|stack
operator|=
name|pitem
expr_stmt|;
block|}
end_block

begin_function
name|unsigned
name|char
modifier|*
name|duplicate
parameter_list|(
name|from
parameter_list|)
name|unsigned
name|char
modifier|*
name|from
decl_stmt|;
block|{
name|int
name|n
decl_stmt|;
name|unsigned
name|char
modifier|*
name|to
decl_stmt|;
name|to
operator|=
name|makeitem
argument_list|(
name|getlength
argument_list|(
name|from
argument_list|)
argument_list|,
name|gettype
argument_list|(
name|from
argument_list|)
argument_list|,
name|getsubtype
argument_list|(
name|from
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|getlength
argument_list|(
name|from
argument_list|)
condition|;
name|n
operator|++
control|)
name|to
index|[
name|n
index|]
operator|=
name|from
index|[
name|n
index|]
expr_stmt|;
return|return
operator|(
name|to
operator|)
return|;
block|}
end_function

begin_macro
name|gettype
argument_list|(
argument|pitem
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|item
modifier|*
name|pitem
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|pitem
operator|->
name|type
operator|)
return|;
block|}
end_block

begin_macro
name|getsubtype
argument_list|(
argument|pitem
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|item
modifier|*
name|pitem
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|pitem
operator|->
name|subtype
operator|)
return|;
block|}
end_block

begin_macro
name|getlength
argument_list|(
argument|pitem
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|item
modifier|*
name|pitem
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|pitem
operator|->
name|length
operator|)
return|;
block|}
end_block

begin_macro
name|checktype
argument_list|(
argument|ptr
argument_list|,
argument|type
argument_list|,
argument|subtype
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|type
decl_stmt|,
name|subtype
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|intype
decl_stmt|,
name|insubtype
decl_stmt|,
name|problem
decl_stmt|;
name|char
modifier|*
name|typename
decl_stmt|,
modifier|*
name|subtypename
decl_stmt|;
name|intype
operator|=
name|gettype
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|insubtype
operator|=
name|getsubtype
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|problem
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|type
condition|)
block|{
if|if
condition|(
operator|(
name|type
operator|&
name|intype
operator|)
operator|==
literal|0
condition|)
name|problem
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|subtype
operator|!=
literal|0
operator|)
operator|&&
operator|(
operator|(
name|subtype
operator|&
name|insubtype
operator|)
operator|==
literal|0
operator|)
condition|)
name|problem
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|problem
condition|)
block|{
name|typename
operator|=
name|gettypename
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|subtypename
operator|=
name|getsubtypename
argument_list|(
name|subtype
argument_list|)
expr_stmt|;
name|error
argument_list|(
name|err1
argument_list|,
name|filepos
argument_list|,
name|typename
argument_list|,
name|subtypename
argument_list|,
name|intype
argument_list|,
name|insubtype
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|char
modifier|*
name|gettypename
parameter_list|(
name|type
parameter_list|)
name|int
name|type
decl_stmt|;
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
literal|"undefined"
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
literal|"number"
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
literal|"string"
operator|)
return|;
case|case
literal|4
case|:
return|return
operator|(
literal|"vector"
operator|)
return|;
case|case
literal|8
case|:
return|return
operator|(
literal|"operator"
operator|)
return|;
case|case
literal|16
case|:
return|return
operator|(
literal|"color"
operator|)
return|;
case|case
literal|32
case|:
return|return
operator|(
literal|"pixelarray"
operator|)
return|;
case|case
literal|64
case|:
return|return
operator|(
literal|"transformation"
operator|)
return|;
case|case
literal|128
case|:
return|return
operator|(
literal|"integers"
operator|)
return|;
default|default:
return|return
operator|(
literal|"unknown"
operator|)
return|;
block|}
empty_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|getsubtypename
parameter_list|(
name|subtype
parameter_list|)
name|int
name|subtype
decl_stmt|;
block|{
switch|switch
condition|(
name|subtype
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
literal|"undefined"
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
literal|"integer"
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
literal|"rational"
operator|)
return|;
case|case
literal|4
case|:
return|return
operator|(
literal|"identifier"
operator|)
return|;
case|case
literal|8
case|:
return|return
operator|(
literal|"string"
operator|)
return|;
case|case
literal|16
case|:
return|return
operator|(
literal|"general"
operator|)
return|;
case|case
literal|32
case|:
return|return
operator|(
literal|"integers"
operator|)
return|;
case|case
literal|64
case|:
return|return
operator|(
literal|"samples"
operator|)
return|;
case|case
literal|128
case|:
return|return
operator|(
literal|"decompressop"
operator|)
return|;
case|case
literal|256
case|:
return|return
operator|(
literal|"colorop"
operator|)
return|;
case|case
literal|512
case|:
return|return
operator|(
literal|"colormodelop"
operator|)
return|;
case|case
literal|1024
case|:
return|return
operator|(
literal|"value"
operator|)
return|;
case|case
literal|2048
case|:
return|return
operator|(
literal|"name"
operator|)
return|;
case|case
literal|4096
case|:
return|return
operator|(
literal|"operator"
operator|)
return|;
default|default:
return|return
operator|(
literal|"unknown"
operator|)
return|;
block|}
empty_stmt|;
block|}
end_function

begin_comment
comment|/*  *  Numbers  *  */
end_comment

begin_function
name|unsigned
name|char
modifier|*
name|makenumber
parameter_list|(
name|nbytes
parameter_list|,
name|array
parameter_list|,
name|subtype
parameter_list|)
name|int
name|nbytes
decl_stmt|;
name|unsigned
name|char
modifier|*
name|array
decl_stmt|;
block|{
name|int
name|n
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|struct
name|number
modifier|*
name|pnumber
decl_stmt|;
name|ptr
operator|=
name|makeitem
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|number
argument_list|)
operator|+
name|nbytes
argument_list|,
name|type_number
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|pnumber
operator|=
operator|(
expr|struct
name|number
operator|*
operator|)
name|ptr
expr_stmt|;
name|pnumber
operator|->
name|nbytes
operator|=
name|nbytes
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
name|pnumber
operator|->
name|num
index|[
name|n
index|]
operator|=
name|array
index|[
name|n
index|]
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_macro
name|getnumlen
argument_list|(
argument|pnumber
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|number
modifier|*
name|pnumber
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|checktype
argument_list|(
name|pnumber
argument_list|,
name|type_number
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|pnumber
operator|->
name|nbytes
operator|)
return|;
block|}
end_block

begin_function
name|unsigned
name|char
modifier|*
name|getnumber
parameter_list|(
name|pnumber
parameter_list|)
name|struct
name|number
modifier|*
name|pnumber
decl_stmt|;
block|{
name|checktype
argument_list|(
name|pnumber
argument_list|,
name|type_number
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|pnumber
operator|->
name|num
operator|)
return|;
block|}
end_function

begin_macro
name|getint
argument_list|(
argument|ptr
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|result
decl_stmt|;
name|result
operator|=
name|getdouble
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_block

begin_function
name|double
name|getdouble
parameter_list|(
name|pnumber
parameter_list|)
name|struct
name|number
modifier|*
name|pnumber
decl_stmt|;
block|{
name|int
name|nbytes
decl_stmt|;
name|double
name|result
decl_stmt|,
name|numerator
decl_stmt|,
name|denominator
decl_stmt|;
name|checktype
argument_list|(
name|pnumber
argument_list|,
name|type_number
argument_list|,
name|subtype_integer
operator||
name|subtype_rational
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|getsubtype
argument_list|(
name|pnumber
argument_list|)
condition|)
block|{
case|case
name|subtype_integer
case|:
name|result
operator|=
name|readdouble
argument_list|(
name|pnumber
operator|->
name|nbytes
argument_list|,
name|pnumber
operator|->
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
name|subtype_rational
case|:
name|nbytes
operator|=
name|pnumber
operator|->
name|nbytes
operator|/
literal|2
expr_stmt|;
name|numerator
operator|=
name|readdouble
argument_list|(
name|nbytes
argument_list|,
name|pnumber
operator|->
name|num
argument_list|)
expr_stmt|;
name|denominator
operator|=
name|readdouble
argument_list|(
name|nbytes
argument_list|,
name|pnumber
operator|->
name|num
operator|+
name|nbytes
argument_list|)
expr_stmt|;
name|result
operator|=
name|numerator
operator|/
name|denominator
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|double
name|getnumerator
parameter_list|(
name|pnumber
parameter_list|)
name|unsigned
name|char
modifier|*
name|pnumber
decl_stmt|;
block|{
name|int
name|nbytes
decl_stmt|;
name|double
name|numerator
decl_stmt|;
name|checktype
argument_list|(
name|pnumber
argument_list|,
name|type_number
argument_list|,
name|subtype_rational
argument_list|)
expr_stmt|;
name|nbytes
operator|=
name|getnumlen
argument_list|(
name|pnumber
argument_list|)
operator|/
literal|2
expr_stmt|;
name|numerator
operator|=
name|readdouble
argument_list|(
name|nbytes
argument_list|,
name|getnumber
argument_list|(
name|pnumber
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|numerator
operator|)
return|;
block|}
end_function

begin_function
name|double
name|getdenominator
parameter_list|(
name|pnumber
parameter_list|)
name|unsigned
name|char
modifier|*
name|pnumber
decl_stmt|;
block|{
name|int
name|nbytes
decl_stmt|;
name|double
name|denominator
decl_stmt|;
name|checktype
argument_list|(
name|pnumber
argument_list|,
name|type_number
argument_list|,
name|subtype_rational
argument_list|)
expr_stmt|;
name|nbytes
operator|=
name|getnumlen
argument_list|(
name|pnumber
argument_list|)
operator|/
literal|2
expr_stmt|;
name|denominator
operator|=
name|readdouble
argument_list|(
name|nbytes
argument_list|,
name|getnumber
argument_list|(
name|pnumber
argument_list|)
operator|+
name|nbytes
argument_list|)
expr_stmt|;
return|return
operator|(
name|denominator
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  Strings  *  */
end_comment

begin_function
name|unsigned
name|char
modifier|*
name|makestring
parameter_list|(
name|string
parameter_list|,
name|subtype
parameter_list|)
name|char
modifier|*
name|string
decl_stmt|;
name|int
name|subtype
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|struct
name|string
modifier|*
name|pstring
decl_stmt|;
name|ptr
operator|=
name|makeitem
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|string
argument_list|)
operator|+
name|strlen
argument_list|(
name|string
argument_list|)
argument_list|,
name|type_string
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|pstring
operator|=
operator|(
expr|struct
name|string
operator|*
operator|)
name|ptr
expr_stmt|;
name|strcpy
argument_list|(
name|pstring
operator|->
name|s
argument_list|,
name|string
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|char
modifier|*
name|makeidentifier
parameter_list|(
name|ptr
parameter_list|,
name|prefix
parameter_list|)
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|prefix
decl_stmt|;
block|{
name|char
modifier|*
name|string
decl_stmt|;
name|int
name|n
decl_stmt|,
name|len
decl_stmt|,
name|depth
decl_stmt|;
name|unsigned
name|char
modifier|*
name|composite
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|depth
operator|=
name|getdepth
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|array
operator|=
name|getvector
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|prefix
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
block|{
name|string
operator|=
name|getstring
argument_list|(
name|array
index|[
name|n
index|]
argument_list|,
name|subtype_identifier
argument_list|)
expr_stmt|;
name|len
operator|+=
name|strlen
argument_list|(
name|string
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* add one for '/' character */
block|}
comment|/* added one too many, gives extra space */
name|string
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* add one for null character */
name|strcpy
argument_list|(
name|string
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|n
condition|)
name|strcat
argument_list|(
name|string
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|string
argument_list|,
name|getstring
argument_list|(
name|array
index|[
name|n
index|]
argument_list|,
name|subtype_identifier
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|composite
operator|=
name|makestring
argument_list|(
name|string
argument_list|,
name|subtype_identifier
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|string
argument_list|)
expr_stmt|;
return|return
operator|(
name|composite
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|getstring
parameter_list|(
name|pstring
parameter_list|,
name|subtype
parameter_list|)
name|struct
name|string
modifier|*
name|pstring
decl_stmt|;
block|{
name|checktype
argument_list|(
name|pstring
argument_list|,
name|type_string
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
operator|(
name|pstring
operator|->
name|s
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  Vectors  *  */
end_comment

begin_function
name|unsigned
name|char
modifier|*
name|makevector
parameter_list|(
name|array
parameter_list|,
name|type
parameter_list|,
name|subtype
parameter_list|)
name|unsigned
name|char
modifier|*
modifier|*
name|array
decl_stmt|;
name|int
name|type
decl_stmt|,
name|subtype
decl_stmt|;
block|{
name|int
name|n
decl_stmt|,
name|m
decl_stmt|,
name|len
decl_stmt|,
name|depth
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|to
decl_stmt|,
modifier|*
name|from
decl_stmt|;
name|struct
name|vector
modifier|*
name|pvector
decl_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|vector
argument_list|)
expr_stmt|;
for|for
control|(
name|depth
operator|=
literal|0
init|;
name|array
index|[
name|depth
index|]
operator|!=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
condition|;
name|depth
operator|++
control|)
name|len
operator|+=
name|getlength
argument_list|(
name|array
index|[
name|depth
index|]
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|makeitem
argument_list|(
name|len
argument_list|,
name|type
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|pvector
operator|=
operator|(
expr|struct
name|vector
operator|*
operator|)
name|ptr
expr_stmt|;
name|pvector
operator|->
name|depth
operator|=
name|depth
expr_stmt|;
name|to
operator|=
name|ptr
expr_stmt|;
name|to
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|vector
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
block|{
name|from
operator|=
name|array
index|[
name|n
index|]
expr_stmt|;
name|len
operator|=
name|getlength
argument_list|(
name|from
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|len
condition|;
name|m
operator|++
control|)
name|to
index|[
name|m
index|]
operator|=
name|from
index|[
name|m
index|]
expr_stmt|;
name|to
operator|+=
name|len
expr_stmt|;
block|}
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|char
modifier|*
modifier|*
name|getvector
parameter_list|(
name|from
parameter_list|)
name|unsigned
name|char
modifier|*
name|from
decl_stmt|;
block|{
name|int
name|n
decl_stmt|,
name|m
decl_stmt|,
name|depth
decl_stmt|,
name|len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|to
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|depth
operator|=
name|getdepth
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|array
operator|=
name|malloc
argument_list|(
operator|(
name|depth
operator|+
literal|1
operator|)
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|from
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|vector
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
block|{
name|array
index|[
name|n
index|]
operator|=
name|from
expr_stmt|;
name|len
operator|=
name|getlength
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|from
operator|+=
name|len
expr_stmt|;
block|}
name|array
index|[
name|depth
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* null terminated list */
return|return
operator|(
name|array
operator|)
return|;
block|}
end_function

begin_macro
name|getdepth
argument_list|(
argument|pvector
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vector
modifier|*
name|pvector
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|pvector
operator|->
name|depth
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  *  Operators  *  */
end_comment

begin_function
name|unsigned
name|char
modifier|*
name|makeoperator
parameter_list|(
name|array
parameter_list|,
name|subtype
parameter_list|)
name|unsigned
name|char
modifier|*
modifier|*
name|array
decl_stmt|;
name|int
name|subtype
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_operator
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|char
modifier|*
modifier|*
name|getoperator
parameter_list|(
name|ptr
parameter_list|)
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
modifier|*
name|array
decl_stmt|;
name|array
operator|=
name|getvector
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|array
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  Pixel array  *  */
end_comment

begin_function
name|unsigned
name|char
modifier|*
name|makepixelarray
parameter_list|(
name|array
parameter_list|)
name|unsigned
name|char
modifier|*
modifier|*
name|array
decl_stmt|;
block|{
name|int
name|depth
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
for|for
control|(
name|depth
operator|=
literal|0
init|;
name|array
index|[
name|depth
index|]
operator|!=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
condition|;
name|depth
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|depth
operator|!=
literal|8
condition|)
name|error
argument_list|(
name|err2
argument_list|,
name|filepos
argument_list|,
name|depth
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_pixelarray
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|char
modifier|*
name|makeselect
parameter_list|(
name|max
parameter_list|,
name|samples
parameter_list|)
name|int
name|max
decl_stmt|,
name|samples
decl_stmt|;
block|{
name|int
name|n
decl_stmt|,
name|mask
decl_stmt|,
name|depth
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|,
name|value
decl_stmt|;
name|array
operator|=
name|malloc
argument_list|(
operator|(
name|max
operator|+
literal|1
operator|)
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|depth
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|max
condition|;
name|n
operator|++
control|)
block|{
name|value
operator|=
name|n
expr_stmt|;
name|mask
operator|=
literal|1
operator|<<
name|n
expr_stmt|;
if|if
condition|(
name|samples
operator|&
name|mask
condition|)
block|{
name|array
index|[
name|depth
index|]
operator|=
name|makenumber
argument_list|(
literal|1
argument_list|,
operator|&
name|value
argument_list|,
name|subtype_integer
argument_list|)
expr_stmt|;
name|depth
operator|++
expr_stmt|;
block|}
block|}
name|array
index|[
name|depth
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* null terminated list */
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_vector
argument_list|,
name|subtype_general
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|free
argument_list|(
name|array
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|char
modifier|*
modifier|*
name|getpixelarray
parameter_list|(
name|from
parameter_list|)
name|unsigned
name|char
modifier|*
name|from
decl_stmt|;
block|{
if|if
condition|(
name|getdepth
argument_list|(
name|from
argument_list|)
operator|!=
literal|8
condition|)
name|error
argument_list|(
name|err2
argument_list|,
name|filepos
argument_list|,
name|getdepth
argument_list|(
name|from
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|getvector
argument_list|(
name|from
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  Transformations  *  */
end_comment

begin_function
name|unsigned
name|char
modifier|*
name|maketransformation
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|,
name|e
parameter_list|,
name|f
parameter_list|)
name|double
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|e
decl_stmt|,
name|f
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|struct
name|transformation
modifier|*
name|ptransformation
decl_stmt|;
name|ptr
operator|=
name|makeitem
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|transformation
argument_list|)
argument_list|,
name|type_transformation
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ptransformation
operator|=
operator|(
expr|struct
name|transformation
operator|*
operator|)
name|ptr
expr_stmt|;
name|ptransformation
operator|->
name|a
operator|=
name|a
expr_stmt|;
name|ptransformation
operator|->
name|b
operator|=
name|b
expr_stmt|;
name|ptransformation
operator|->
name|c
operator|=
name|c
expr_stmt|;
name|ptransformation
operator|->
name|d
operator|=
name|d
expr_stmt|;
name|ptransformation
operator|->
name|e
operator|=
name|e
expr_stmt|;
name|ptransformation
operator|->
name|f
operator|=
name|f
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
name|double
modifier|*
name|gettransformation
parameter_list|(
name|ptransformation
parameter_list|)
name|struct
name|transformation
modifier|*
name|ptransformation
decl_stmt|;
block|{
name|double
modifier|*
name|array
decl_stmt|;
name|checktype
argument_list|(
name|ptransformation
argument_list|,
name|type_transformation
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|array
operator|=
operator|(
name|double
operator|*
operator|)
name|malloc
argument_list|(
literal|6
operator|*
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|ptransformation
operator|->
name|a
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
name|ptransformation
operator|->
name|b
expr_stmt|;
name|array
index|[
literal|2
index|]
operator|=
name|ptransformation
operator|->
name|c
expr_stmt|;
name|array
index|[
literal|3
index|]
operator|=
name|ptransformation
operator|->
name|d
expr_stmt|;
name|array
index|[
literal|4
index|]
operator|=
name|ptransformation
operator|->
name|e
expr_stmt|;
name|array
index|[
literal|5
index|]
operator|=
name|ptransformation
operator|->
name|f
expr_stmt|;
return|return
operator|(
name|array
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  Integers  *  */
end_comment

begin_function
name|unsigned
name|char
modifier|*
name|makeintegers
parameter_list|(
name|bytesPerInteger
parameter_list|,
name|bytepos
parameter_list|,
name|bytelength
parameter_list|)
name|int
name|bytesPerInteger
decl_stmt|;
name|long
name|bytepos
decl_stmt|,
name|bytelength
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|struct
name|integers
modifier|*
name|pintegers
decl_stmt|;
name|ptr
operator|=
name|makeitem
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|integers
argument_list|)
argument_list|,
name|type_integers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pintegers
operator|=
operator|(
expr|struct
name|integers
operator|*
operator|)
name|ptr
expr_stmt|;
name|pintegers
operator|->
name|bytesPerInteger
operator|=
name|bytesPerInteger
expr_stmt|;
name|pintegers
operator|->
name|bytepos
operator|=
name|bytepos
expr_stmt|;
name|pintegers
operator|->
name|bytelength
operator|=
name|bytelength
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_macro
name|getbytesPerInteger
argument_list|(
argument|pintegers
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|integers
modifier|*
name|pintegers
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|checktype
argument_list|(
name|pintegers
argument_list|,
name|type_integers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|pintegers
operator|->
name|bytesPerInteger
operator|)
return|;
block|}
end_block

begin_function
name|long
name|getbytepos
parameter_list|(
name|pintegers
parameter_list|)
name|struct
name|integers
modifier|*
name|pintegers
decl_stmt|;
block|{
name|checktype
argument_list|(
name|pintegers
argument_list|,
name|type_integers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|pintegers
operator|->
name|bytepos
operator|)
return|;
block|}
end_function

begin_function
name|long
name|getbytelength
parameter_list|(
name|pintegers
parameter_list|)
name|struct
name|integers
modifier|*
name|pintegers
decl_stmt|;
block|{
name|checktype
argument_list|(
name|pintegers
argument_list|,
name|type_integers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|pintegers
operator|->
name|bytelength
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  Private procedures to this module.  *  */
end_comment

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|makeitem
parameter_list|(
name|length
parameter_list|,
name|type
parameter_list|,
name|subtype
parameter_list|)
name|int
name|length
decl_stmt|,
name|type
decl_stmt|,
name|subtype
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|struct
name|item
modifier|*
name|pitem
decl_stmt|;
name|length
operator|=
operator|(
name|length
operator|+
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|-
literal|1
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|length
operator|*=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|pitem
operator|=
operator|(
expr|struct
name|item
operator|*
operator|)
name|ptr
expr_stmt|;
name|pitem
operator|->
name|length
operator|=
name|length
expr_stmt|;
name|pitem
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|pitem
operator|->
name|subtype
operator|=
name|subtype
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|double
name|readdouble
parameter_list|(
name|nbytes
parameter_list|,
name|array
parameter_list|)
name|int
name|nbytes
decl_stmt|;
name|unsigned
name|char
modifier|*
name|array
decl_stmt|;
block|{
name|int
name|n
decl_stmt|,
name|negative
decl_stmt|,
name|temp
decl_stmt|;
name|double
name|result
decl_stmt|;
name|negative
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|array
index|[
literal|0
index|]
operator|>
literal|127
condition|)
block|{
name|negative
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
name|array
index|[
name|n
index|]
operator|=
operator|~
name|array
index|[
name|n
index|]
expr_stmt|;
block|}
name|result
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
block|{
name|temp
operator|=
name|array
index|[
name|n
index|]
expr_stmt|;
name|result
operator|=
literal|256.
operator|*
name|result
operator|+
operator|(
name|double
operator|)
name|temp
expr_stmt|;
block|}
if|if
condition|(
name|negative
condition|)
name|result
operator|=
operator|-
name|result
operator|-
literal|1
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Change Log  *  * K. Knox, 29-Mar-85 18:20:18, Created first version.  * K. Knox, 13-May-85  9:50:52, Fixed negative number bug in readdouble().  *  *  *  */
end_comment

end_unit


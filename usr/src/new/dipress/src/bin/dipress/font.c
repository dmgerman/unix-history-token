begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************  *  font - 	manages the fonts and their associated descriptor files for  *		processing ditroff commands into interpress  *  *  *	William LeFebvre (Xerox Corp)  *	with modifications by John Mellor-Crummey (Xerox Corp)  *  * 	Copyright (c) 1984, 1985, 1986 Xerox Corp.  *  *  * HISTORY  * 15-Jan-86  lee at Xerox, WRC  *	Fixed NULL pointer de-reference.  *  *  ******************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"deviceinfo.h"
end_include

begin_comment
comment|/* typesetter characteristics */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_comment
comment|/* constant and macro definitions */
end_comment

begin_include
include|#
directive|include
file|"externs.h"
end_include

begin_comment
comment|/* declarations for global variables */
end_comment

begin_comment
comment|/*-----------------------------------------------------------------------------  *	readDeviceInitInfo	read the device descriptor and font   *				initialization info into tables in memory  *				from a typesetter descriptor file created using   *				by makedev  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|readDeviceInitInfo
argument_list|()
end_macro

begin_block
block|{
name|int
name|devicefd
decl_stmt|,
name|entries
decl_stmt|,
name|fontno
decl_stmt|;
name|char
name|deviceFilename
index|[
literal|80
index|]
decl_stmt|,
modifier|*
name|buffer
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
comment|/* read in device descriptor , fonts character and width info */
comment|/* form descriptor file name */
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|deviceFilename
argument_list|,
literal|"%s/dev%s/DESC.out"
argument_list|,
name|fontdirectory
argument_list|,
name|devicename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|devicefd
operator|=
name|open
argument_list|(
name|deviceFilename
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"can't open file %s for device characteristics (%s)"
argument_list|,
name|deviceFilename
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
comment|/* read in device characteristics */
operator|(
name|void
operator|)
name|read
argument_list|(
name|devicefd
argument_list|,
operator|&
name|device
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|device_entry
argument_list|)
argument_list|)
expr_stmt|;
comment|/* allocate space to read in the rest of  	 * the tables in the descriptor file  	 */
name|buffer
operator|=
name|malloc
argument_list|(
name|device
operator|.
name|font_size
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|read
argument_list|(
name|devicefd
argument_list|,
name|buffer
argument_list|,
name|device
operator|.
name|font_size
argument_list|)
expr_stmt|;
comment|/* set up global pointers to tables */
name|pointsizeTab
operator|=
operator|(
name|short
operator|*
operator|)
name|buffer
expr_stmt|;
name|specCharTab
operator|=
operator|(
name|short
operator|*
operator|)
name|pointsizeTab
operator|+
name|device
operator|.
name|num_sizes
operator|+
literal|1
expr_stmt|;
name|specCharStrTab
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|specCharTab
operator|+
name|device
operator|.
name|spec_char_num
operator|)
expr_stmt|;
comment|/* walk through the rest of the fonts */
name|ptr
operator|=
name|specCharStrTab
operator|+
name|device
operator|.
name|spec_name_len
expr_stmt|;
for|for
control|(
name|fontno
operator|=
literal|1
init|;
name|fontno
operator|<=
name|device
operator|.
name|num_fonts
condition|;
name|fontno
operator|++
control|)
block|{
name|fontPtr
index|[
name|fontno
index|]
operator|=
operator|(
expr|struct
name|font_entry
operator|*
operator|)
name|ptr
expr_stmt|;
name|entries
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
operator|*
name|ptr
argument_list|)
operator|&
literal|255
expr_stmt|;
comment|/* get width entries */
if|if
condition|(
name|specFontPos
operator|==
literal|0
operator|&&
name|fontPtr
index|[
name|fontno
index|]
operator|->
name|special_flag
operator|==
literal|1
condition|)
name|specFontPos
operator|=
name|fontno
expr_stmt|;
comment|/* position of 1st special font */
name|ptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|font_entry
argument_list|)
expr_stmt|;
comment|/* that's what's on the beginning */
name|charWidthTab
index|[
name|fontno
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ptr
expr_stmt|;
comment|/* ignore kerning info */
name|ptr
operator|+=
name|entries
operator|*
literal|2
expr_stmt|;
name|charCodeTab
index|[
name|fontno
index|]
operator|=
name|ptr
expr_stmt|;
name|ptr
operator|+=
name|entries
expr_stmt|;
name|fontIndexTab
index|[
name|fontno
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ptr
expr_stmt|;
name|ptr
operator|+=
name|device
operator|.
name|spec_char_num
operator|+
literal|128
operator|-
literal|32
expr_stmt|;
name|setFontPosition
argument_list|(
name|fontno
argument_list|,
name|fontPtr
index|[
name|fontno
index|]
operator|->
name|font_name
argument_list|,
name|fontPtr
index|[
name|fontno
index|]
operator|->
name|font_number
argument_list|)
expr_stmt|;
block|}
name|fontPtr
index|[
literal|0
index|]
operator|=
operator|(
expr|struct
name|font_entry
operator|*
operator|)
name|malloc
argument_list|(
literal|3
operator|*
literal|255
operator|+
name|device
operator|.
name|spec_char_num
operator|+
operator|(
literal|128
operator|-
literal|32
operator|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|font_entry
argument_list|)
argument_list|)
expr_stmt|;
name|charWidthTab
index|[
literal|0
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|fontPtr
index|[
literal|0
index|]
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|font_entry
argument_list|)
expr_stmt|;
name|fontPtr
index|[
literal|0
index|]
operator|->
name|num_char_wid
operator|=
literal|255
expr_stmt|;
if|if
condition|(
name|dbg
operator|&&
name|device
operator|.
name|num_stiptypes
operator|>
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d stipple families: "
argument_list|,
name|device
operator|.
name|num_stiptypes
argument_list|)
expr_stmt|;
for|for
control|(
name|fontno
operator|=
literal|1
init|;
name|fontno
operator|<=
name|device
operator|.
name|num_stiptypes
condition|;
name|fontno
operator|++
control|)
block|{
name|stipTypeName
index|[
name|fontno
index|]
operator|=
name|ptr
expr_stmt|;
if|if
condition|(
name|dbg
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s "
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|ptr
operator|++
condition|)
empty_stmt|;
comment|/* advance to next one */
if|if
condition|(
name|dbg
operator|&&
name|fontno
operator|==
name|device
operator|.
name|num_stiptypes
condition|)
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|devicefd
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*-----------------------------------------------------------------------------  *	loadFont	load the descriptor and tables for a font into position  *			n in the font table  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|loadFont
argument_list|(
argument|fontno
argument_list|,
argument|fname
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fontno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fname
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|fontsfd
decl_stmt|,
name|entries
decl_stmt|;
name|int
name|num_widths
decl_stmt|;
name|char
name|fontfilename
index|[
literal|60
index|]
decl_stmt|;
if|if
condition|(
name|fontno
operator|<
literal|0
operator|||
name|fontno
operator|>
name|MAX_NUM_FONTS
condition|)
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"load fail for font %s, index out of bounds %d"
argument_list|,
name|fname
argument_list|,
name|fontno
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|fname
argument_list|,
name|fontPtr
index|[
name|fontno
index|]
operator|->
name|font_name
argument_list|)
operator|==
literal|0
condition|)
return|return;
comment|/* already loaded */
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|fontfilename
argument_list|,
literal|"%s/dev%s/%s.out"
argument_list|,
name|fontdirectory
argument_list|,
name|devicename
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fontsfd
operator|=
name|open
argument_list|(
name|fontfilename
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"can't open font file %s (%s)"
argument_list|,
name|fontfilename
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
comment|/* record the current length of this font table */
name|entries
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|fontPtr
index|[
name|fontno
index|]
operator|->
name|num_char_wid
argument_list|)
operator|&
literal|255
expr_stmt|;
comment|/* read in the new font */
operator|(
name|void
operator|)
name|read
argument_list|(
name|fontsfd
argument_list|,
name|fontPtr
index|[
name|fontno
index|]
argument_list|,
literal|3
operator|*
name|entries
operator|+
name|device
operator|.
name|spec_char_num
operator|+
literal|128
operator|-
literal|32
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|font_entry
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fontsfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
call|(
name|unsigned
name|char
call|)
argument_list|(
name|fontPtr
index|[
name|fontno
index|]
operator|->
name|num_char_wid
argument_list|)
operator|&
literal|255
operator|)
operator|>
name|entries
condition|)
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"Font %s too big for position %d\n"
argument_list|,
name|fname
argument_list|,
name|fontno
argument_list|)
expr_stmt|;
name|num_widths
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|fontPtr
index|[
name|fontno
index|]
operator|->
name|num_char_wid
argument_list|)
operator|&
literal|255
expr_stmt|;
comment|/* width of new font tables */
name|charWidthTab
index|[
name|fontno
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|fontPtr
index|[
name|fontno
index|]
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|font_entry
argument_list|)
expr_stmt|;
name|charCodeTab
index|[
name|fontno
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|charWidthTab
index|[
name|fontno
index|]
operator|+
literal|2
operator|*
name|num_widths
expr_stmt|;
name|fontIndexTab
index|[
name|fontno
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|charWidthTab
index|[
name|fontno
index|]
operator|+
literal|3
operator|*
name|num_widths
expr_stmt|;
name|setFontPosition
argument_list|(
name|fontno
argument_list|,
name|fontPtr
index|[
name|fontno
index|]
operator|->
name|font_name
argument_list|,
name|fontPtr
index|[
name|fontno
index|]
operator|->
name|font_number
argument_list|)
expr_stmt|;
comment|/* restore to old value to allow use of the maximum space later */
name|fontPtr
index|[
name|fontno
index|]
operator|->
name|num_char_wid
operator|=
name|entries
expr_stmt|;
block|}
end_block

begin_comment
comment|/*-----------------------------------------------------------------------------  *	setFontPosition		set up a font with troff name *name in the   *				position given by index of the current fonts   *				table  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|setFontPosition
argument_list|(
argument|index
argument_list|,
argument|name
argument_list|,
argument|iname
argument_list|)
end_macro

begin_decl_stmt
name|int
name|index
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* index into fontPtr */
end_comment

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* troff name */
end_comment

begin_decl_stmt
name|char
modifier|*
name|iname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* internal name */
end_comment

begin_block
block|{
name|int
name|cnt
decl_stmt|;
name|char
modifier|*
modifier|*
name|trp
decl_stmt|;
specifier|register
name|struct
name|ifont
modifier|*
name|ifp
decl_stmt|;
if|if
condition|(
name|dbg
condition|)
name|printf
argument_list|(
literal|"setFontPosition(%d, %s, %s)\n"
argument_list|,
name|index
argument_list|,
name|name
argument_list|,
name|iname
argument_list|)
expr_stmt|;
comment|/* do nothing if it is the same font */
if|if
condition|(
name|currfonts
index|[
name|index
index|]
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|name
argument_list|,
name|currfonts
index|[
name|index
index|]
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|dbg
condition|)
name|printf
argument_list|(
literal|"trivial case -- no action taken\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* place any old and used font on the inactive list if not already there */
name|ifp
operator|=
name|currfonts
index|[
name|index
index|]
expr_stmt|;
if|if
condition|(
name|ifp
operator|!=
name|NULL
operator|&&
name|ifp
operator|->
name|frames
operator|!=
name|NULL
operator|&&
name|ifp
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|dbg
condition|)
name|printf
argument_list|(
literal|"placing old font (%s) on inactive list\n"
argument_list|,
name|ifp
operator|->
name|name
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|next
operator|=
name|inactfonts
expr_stmt|;
name|inactfonts
operator|=
name|ifp
expr_stmt|;
block|}
comment|/* try to find the new font on the inactive list */
if|if
condition|(
name|dbg
condition|)
name|printf
argument_list|(
literal|"checking inactive list: "
argument_list|)
expr_stmt|;
for|for
control|(
name|ifp
operator|=
name|inactfonts
init|;
name|ifp
operator|!=
name|NULL
condition|;
name|ifp
operator|=
name|ifp
operator|->
name|next
control|)
block|{
if|if
condition|(
name|dbg
condition|)
name|printf
argument_list|(
literal|"%s  "
argument_list|,
name|ifp
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|ifp
operator|->
name|name
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|ifp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|dbg
condition|)
name|printf
argument_list|(
literal|"\ngot it!\n"
argument_list|)
expr_stmt|;
comment|/* it was on the inactive list -- pull it back */
name|currfonts
index|[
name|index
index|]
operator|=
name|ifp
expr_stmt|;
block|}
else|else
block|{
comment|/* brand new font */
if|if
condition|(
name|dbg
condition|)
name|printf
argument_list|(
literal|"\nnot there ... making new font\ninterpress equiv: "
argument_list|)
expr_stmt|;
name|currfonts
index|[
name|index
index|]
operator|=
name|ifp
operator|=
operator|(
expr|struct
name|ifont
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ifont
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifp
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|frames
operator|=
name|NULL
expr_stmt|;
name|ifp
operator|->
name|extab
operator|=
name|NULL
expr_stmt|;
name|ifp
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
comment|/* map the troff name to an interpress name */
for|for
control|(
name|cnt
operator|=
literal|0
operator|,
name|trp
operator|=
name|trname
init|;
name|cnt
operator|<
name|mapcnt
condition|;
name|cnt
operator|++
operator|,
name|trp
operator|++
control|)
block|{
if|if
condition|(
name|dbg
condition|)
name|printf
argument_list|(
literal|"%s  "
argument_list|,
operator|*
name|trp
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|trp
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|cnt
operator|==
name|mapcnt
condition|)
block|{
name|reportError
argument_list|(
name|CONTINUE
argument_list|,
literal|"no interpress equivalent for troff font %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|currfonts
index|[
name|index
index|]
operator|->
name|uname
operator|=
name|ipname
index|[
literal|0
index|]
expr_stmt|;
comment|/* punt */
block|}
else|else
block|{
if|if
condition|(
name|dbg
condition|)
name|printf
argument_list|(
literal|"\ngot it ... using %s\n"
argument_list|,
name|ipname
index|[
name|cnt
index|]
argument_list|)
expr_stmt|;
name|currfonts
index|[
name|index
index|]
operator|->
name|uname
operator|=
name|ipname
index|[
name|cnt
index|]
expr_stmt|;
block|}
block|}
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************  *	(C) Copyright 1985, 1986 Xerox Corporation  *  *	main	--	main routine for dipress   *			(ditroff to interpress conversion)  *  *	John Mellor-Crummey (Xerox Corp)  *  *  * HISTORY  * 07-Jul-86  Lee Moore (lee) at Xerox Webster Research Center  *	Converted to use getopt.  *  *  *****************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_comment
comment|/* constant and macro definitions */
end_comment

begin_include
include|#
directive|include
file|"externs.h"
end_include

begin_comment
comment|/* declarations for global variables */
end_comment

begin_define
define|#
directive|define
name|SAME
value|0
end_define

begin_comment
comment|/* equality comparison for strings */
end_comment

begin_decl_stmt
name|enum
name|IPDeviceType
name|IPDeviceType
init|=
name|GenericIPDevice
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*-----------------------------------------------------------------------------  *  *	main processes the list of command line options and opens the   *	necessary temporary files  *  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|FILE
modifier|*
name|inputfile
decl_stmt|;
name|int
name|c
decl_stmt|;
specifier|extern
name|int
name|optind
decl_stmt|;
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
comment|/* set up signal handlers to insure clean termination */
name|signalHandler
argument_list|()
expr_stmt|;
comment|/* process command line options */
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"d:D:f:F:o:t"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'d'
case|:
comment|/* produce debugging info */
name|dbg
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbg
operator|==
literal|0
condition|)
name|dbg
operator|=
literal|1
expr_stmt|;
name|setbuf
argument_list|(
name|stdout
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"debugging level %d\n"
argument_list|,
name|dbg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* read the following list of page numbers */
name|setIPDeviceType
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
case|case
literal|'F'
case|:
comment|/* reset default font directory */
name|fontdirectory
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
comment|/* read the following list of page numbers */
name|readPageList
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
comment|/* dump the interpress to the standard output */
name|outputfile
operator|=
name|fileno
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* construct name for temporary files */
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tempfilename
argument_list|,
literal|"/tmp/dip%d"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|outputfile
operator|!=
name|fileno
argument_list|(
name|stdout
argument_list|)
condition|)
block|{
comment|/* open file to hold master */
if|if
condition|(
operator|(
name|outputfile
operator|=
name|open
argument_list|(
name|tempfilename
argument_list|,
name|O_WRONLY
operator||
name|O_TRUNC
operator||
name|O_CREAT
argument_list|,
literal|0666
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"temporary file %s: %s"
argument_list|,
name|tempfilename
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
name|ip_select
argument_list|(
name|outputfile
argument_list|)
expr_stmt|;
block|}
comment|/* open file to hold body */
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|tempfilename
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pagebodyfile
operator|=
name|open
argument_list|(
name|tempfilename
argument_list|,
name|O_WRONLY
operator||
name|O_TRUNC
operator||
name|O_CREAT
argument_list|,
literal|0666
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"temporary file %s: %s"
argument_list|,
name|tempfilename
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
name|ip_raw_select
argument_list|(
name|pagebodyfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|-
name|optind
operator|==
literal|0
condition|)
comment|/* if no file specified, default to stdin */
name|ditroffToIpress
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
else|else
comment|/* process files explicitly specified */
for|for
control|(
init|;
name|argc
operator|>
name|optind
condition|;
name|optind
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|inputfile
operator|=
name|fopen
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"can't open %s: %s"
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
name|ditroffToIpress
argument_list|(
name|inputfile
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|inputfile
argument_list|)
expr_stmt|;
block|}
name|goodbye
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-----------------------------------------------------------------------------  * readPageList	--	read a list of page specifications of the form  *			p1 or p1-p2 separated by commas. if in the dash form  *			either p1 or p2 is omitted, it will appropriately   *			default to the first of last page of the document  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|readPageList
argument_list|(
argument|ptr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|ptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|ptr
operator|!=
literal|'\0'
condition|)
block|{
name|pagerange
index|[
name|nPageRanges
index|]
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|isdigit
argument_list|(
operator|*
name|ptr
argument_list|)
operator|)
condition|?
name|readPageNumber
argument_list|(
operator|&
name|ptr
argument_list|)
else|:
name|DEFAULTRANGEBOT
operator|)
expr_stmt|;
name|pagerange
index|[
name|nPageRanges
index|]
index|[
literal|1
index|]
operator|=
operator|(
operator|(
operator|*
name|ptr
operator|!=
literal|'-'
operator|)
condition|?
name|pagerange
index|[
name|nPageRanges
index|]
index|[
literal|0
index|]
else|:
operator|(
operator|(
name|isdigit
argument_list|(
operator|*
operator|++
name|ptr
argument_list|)
operator|)
condition|?
name|readPageNumber
argument_list|(
operator|&
name|ptr
argument_list|)
else|:
name|DEFAULTRANGETOP
operator|)
operator|)
expr_stmt|;
name|nPageRanges
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|ptr
operator|!=
literal|'\0'
condition|)
name|ptr
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*-----------------------------------------------------------------------------  * readPageNumber	--	read a page number from a string and update the  *				pointer to the next non-digit  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|readPageNumber
argument_list|(
argument|ptr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|ptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|pagenumber
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|pagenumber
operator|=
name|pagenumber
operator|*
literal|10
operator|+
operator|*
operator|*
name|ptr
operator|-
literal|'0'
expr_stmt|;
operator|++
operator|*
name|ptr
expr_stmt|;
block|}
return|return
operator|(
name|pagenumber
operator|)
return|;
block|}
end_block

begin_comment
comment|/*-----------------------------------------------------------------------------  * setIPDeviceType	--	record the type of the Interpress output device.  *				This must be done because of limitations in  *				some devices.  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|setIPDeviceType
argument_list|(
argument|deviceString
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|deviceString
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|deviceString
argument_list|,
literal|"Xerox8044_Services8"
argument_list|)
operator|==
name|SAME
condition|)
name|IPDeviceType
operator|=
name|Xerox8044_Services8
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|deviceString
argument_list|,
literal|"Xerox8044_Services9"
argument_list|)
operator|==
name|SAME
condition|)
name|IPDeviceType
operator|=
name|Xerox8044_Services9
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|deviceString
argument_list|,
literal|"Xerox8044_Services10"
argument_list|)
operator|==
name|SAME
condition|)
name|IPDeviceType
operator|=
name|Xerox8044_Services10
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|deviceString
argument_list|,
literal|"Xerox9700_V10"
argument_list|)
operator|==
name|SAME
condition|)
name|IPDeviceType
operator|=
name|Xerox9700_V10
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"IP Device unknown: %s\n"
argument_list|,
name|deviceName
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


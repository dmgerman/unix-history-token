begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"mh.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"strings.h"
end_include

begin_decl_stmt
name|struct
name|msgs
modifier|*
name|mp
decl_stmt|;
end_decl_stmt

begin_function_decl
name|char
modifier|*
name|rindex
parameter_list|()
function_decl|;
end_function_decl

begin_macro
name|m_edit
argument_list|(
argument|ed
argument_list|,
argument|file
argument_list|,
argument|use
argument_list|,
argument|altmsg
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|ed
decl_stmt|,
modifier|*
name|file
decl_stmt|,
modifier|*
name|altmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|use
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* Exec editor.  Normal exit returns 0. 	 * To abort, returns -1.  To try again, returns -2 	 */
specifier|static
name|char
modifier|*
name|edsave
decl_stmt|;
specifier|static
name|int
name|reedit
decl_stmt|;
name|struct
name|stat
name|stbuf
decl_stmt|;
name|int
name|retstat
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|pid
decl_stmt|,
name|wpid
decl_stmt|;
name|int
name|intr
decl_stmt|;
union|union
block|{
name|int
name|statint
decl_stmt|;
struct|struct
block|{
name|char
name|lobyte
decl_stmt|,
name|hibyte
decl_stmt|;
block|}
name|statby
struct|;
block|}
name|status
union|;
if|if
condition|(
operator|!
name|reedit
condition|)
block|{
comment|/* set initial editor */
if|if
condition|(
operator|!
operator|*
name|ed
operator|&&
operator|(
operator|*
name|ed
operator|=
name|m_find
argument_list|(
literal|"editor"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
operator|*
name|ed
operator|=
name|sysed
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|*
name|ed
condition|)
block|{
comment|/* no explicit editor */
operator|*
name|ed
operator|=
name|edsave
expr_stmt|;
name|cp
operator|=
name|rindex
argument_list|(
operator|*
name|ed
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
literal|0
condition|)
name|cp
operator|=
operator|*
name|ed
expr_stmt|;
name|cp
operator|=
name|concat
argument_list|(
name|cp
argument_list|,
literal|"-next"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|m_find
argument_list|(
name|cp
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|ed
operator|=
name|cp
expr_stmt|;
block|}
name|intr
operator|=
operator|(
name|int
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|altmsg
condition|)
block|{
name|unlink
argument_list|(
literal|"@"
argument_list|)
expr_stmt|;
name|link
argument_list|(
name|altmsg
argument_list|,
literal|"@"
argument_list|)
expr_stmt|;
comment|/* An easy handle on cur msg */
block|}
name|m_update
argument_list|()
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
operator|(
name|int
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|intr
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
operator|*
name|ed
argument_list|,
operator|*
name|ed
argument_list|,
name|file
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't exec the editor:  "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
operator|*
name|ed
argument_list|)
expr_stmt|;
name|done
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pid
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No forks!\n"
argument_list|)
expr_stmt|;
name|retstat
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|leave
goto|;
block|}
else|else
while|while
condition|(
operator|(
name|wpid
operator|=
name|wait
argument_list|(
operator|&
name|status
argument_list|)
operator|)
operator|!=
operator|-
literal|1
operator|&&
name|wpid
operator|!=
name|pid
condition|)
empty_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
operator|(
name|int
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|intr
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|statint
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|.
name|statby
operator|.
name|hibyte
operator|==
operator|-
literal|1
operator|)
operator|||
comment|/* Can't exec editor */
operator|(
name|reedit
operator|&&
operator|!
name|status
operator|.
name|statby
operator|.
name|lobyte
operator|)
condition|)
block|{
comment|/*2nd edit.Aborted by user*/
name|retstat
operator|=
operator|-
literal|2
expr_stmt|;
goto|goto
name|leave
goto|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"[%s aborted--%s "
argument_list|,
name|invo_name
argument_list|()
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|use
operator|&&
name|status
operator|.
name|statby
operator|.
name|hibyte
condition|)
block|{
comment|/* edit aborted by user */
name|unlink
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"deleted]\n"
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* 'use' or system abort */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"preserved]\n"
argument_list|)
expr_stmt|;
name|retstat
operator|=
operator|-
literal|2
expr_stmt|;
goto|goto
name|leave
goto|;
block|}
name|reedit
operator|++
expr_stmt|;
name|retstat
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|altmsg
operator|&&
operator|!
name|mp
operator|->
name|msgflags
operator|&
name|READONLY
condition|)
block|{
name|stat
argument_list|(
literal|"@"
argument_list|,
operator|&
name|stbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|stbuf
operator|.
name|st_nlink
operator|==
literal|1
condition|)
comment|/*@'s been edited by Ned*/
if|if
condition|(
name|unlink
argument_list|(
name|altmsg
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|link
argument_list|(
literal|"@"
argument_list|,
name|altmsg
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't update %s from @ file!\n"
argument_list|,
name|altmsg
argument_list|)
expr_stmt|;
name|retstat
operator|=
literal|0
expr_stmt|;
goto|goto
name|leave
goto|;
block|}
block|}
name|leave
label|:
name|edsave
operator|=
name|getcpy
argument_list|(
operator|*
name|ed
argument_list|)
expr_stmt|;
operator|*
name|ed
operator|=
literal|0
expr_stmt|;
name|unlink
argument_list|(
literal|"@"
argument_list|)
expr_stmt|;
comment|/* Remove this extra link */
return|return
operator|(
name|retstat
operator|)
return|;
block|}
end_block

end_unit


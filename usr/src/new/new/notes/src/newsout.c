begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
modifier|*
name|sccsid
init|=
literal|"@(#)newsout.c	1.2\t1/24/83"
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|"parms.h"
end_include

begin_include
include|#
directive|include
file|"structs.h"
end_include

begin_include
include|#
directive|include
file|"newsgate.h"
end_include

begin_comment
comment|/*  *	newsoutput - process a particular notesfile for updates  *	out to the news system.  *  *	This particular implementation of the program DOES NOT   *	recombine split articles. This is a shame, but I wanted a  *	fast implementation.  *  *	Original Coding:	Ray Essick	April 1982  */
end_comment

begin_macro
name|newsout
argument_list|(
argument|nfname
argument_list|,
argument|othersok
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|nfname
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|io_f
name|io
decl_stmt|;
name|struct
name|note_f
name|note
decl_stmt|;
name|struct
name|resp_f
name|rsprec
decl_stmt|;
name|struct
name|when_f
name|whendump
decl_stmt|;
comment|/* when we did this */
name|int
name|notenum
decl_stmt|,
name|respnum
decl_stmt|,
name|rdumped
decl_stmt|,
name|ndumped
decl_stmt|,
comment|/* number dumped */
name|roffset
decl_stmt|,
name|rblock
decl_stmt|;
name|char
name|ngroup
index|[
name|NNLEN
index|]
decl_stmt|;
comment|/* hold newsgroup */
name|FILE
modifier|*
name|log
decl_stmt|;
name|char
name|buf
index|[
name|CMDLEN
index|]
decl_stmt|;
name|char
name|ztime
index|[
name|DATELEN
index|]
decl_stmt|;
if|if
condition|(
name|init
argument_list|(
operator|&
name|io
argument_list|,
name|nfname
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* open the bugger */
name|printf
argument_list|(
literal|"Can not open notesfile `%s'\n"
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|io
operator|.
name|descr
operator|.
name|d_stat
operator|&
name|NETWRKD
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* are we permitted to gate? */
name|closenf
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s must be networked to go to news!\n"
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|gettime
argument_list|(
operator|&
name|whendump
argument_list|)
expr_stmt|;
comment|/* for updating last access */
name|getlast
argument_list|(
operator|&
name|io
operator|.
name|stime
argument_list|,
name|nfname
argument_list|,
literal|1
argument_list|,
name|NEWSSYS
argument_list|)
expr_stmt|;
comment|/* grab last time dumped */
name|newsgroup
argument_list|(
name|io
operator|.
name|nf
argument_list|,
name|ngroup
argument_list|,
name|NFNEWS
argument_list|)
expr_stmt|;
comment|/* alias 'newsgroup' */
name|ndumped
operator|=
name|rdumped
operator|=
literal|0
expr_stmt|;
name|notenum
operator|=
literal|0
expr_stmt|;
comment|/* start at the top */
while|while
condition|(
operator|(
name|notenum
operator|=
name|nxtnote
argument_list|(
operator|&
name|io
argument_list|,
name|notenum
argument_list|,
operator|&
name|io
operator|.
name|stime
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|getnrec
argument_list|(
operator|&
name|io
argument_list|,
name|notenum
argument_list|,
operator|&
name|note
argument_list|)
expr_stmt|;
comment|/* get descriptor */
name|respnum
operator|=
literal|0
expr_stmt|;
comment|/* response chain */
if|if
condition|(
name|inorder
argument_list|(
operator|&
name|io
operator|.
name|stime
argument_list|,
operator|&
name|note
operator|.
name|n_rcvd
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* been dumped */
goto|goto
name|doresps
goto|;
block|}
if|if
condition|(
operator|(
name|note
operator|.
name|n_stat
operator|&
name|FRMNEWS
operator|)
operator|!=
literal|0
condition|)
block|{
goto|goto
name|doresps
goto|;
comment|/* stupid to send it back! */
block|}
if|if
condition|(
operator|(
name|note
operator|.
name|n_stat
operator|&
name|ORPHND
operator|)
operator|!=
literal|0
condition|)
block|{
goto|goto
name|doresps
goto|;
comment|/* don't send foster dad out */
block|}
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|note
operator|.
name|n_id
operator|.
name|sys
argument_list|,
name|SYSTEM
argument_list|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|othersok
operator|==
literal|0
operator|)
condition|)
block|{
goto|goto
name|doresps
goto|;
comment|/* don't dump non-local */
block|}
if|if
condition|(
name|newsnote
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|note
argument_list|,
name|notenum
argument_list|,
name|ngroup
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* dump it */
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s/%s/%s"
argument_list|,
name|MSTDIR
argument_list|,
name|UTILITY
argument_list|,
name|NETLOG
argument_list|)
expr_stmt|;
name|sprdate
argument_list|(
operator|&
name|whendump
argument_list|,
name|ztime
argument_list|)
expr_stmt|;
name|glock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
comment|/* mutual exclusion */
name|x
argument_list|(
operator|(
name|log
operator|=
name|fopen
argument_list|(
name|buf
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
argument_list|,
literal|"newsout: missing log file"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|log
argument_list|,
literal|"%s: failed to send to NEWS at %s\n"
argument_list|,
name|nfname
argument_list|,
name|ndumped
argument_list|,
name|rdumped
argument_list|,
name|ztime
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|log
argument_list|)
expr_stmt|;
name|gunlock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
comment|/* all done */
block|}
name|ndumped
operator|++
expr_stmt|;
comment|/* count */
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* let news run ... */
name|doresps
label|:
comment|/* let's process responses */
while|while
condition|(
operator|(
name|respnum
operator|=
name|nxtresp
argument_list|(
operator|&
name|io
argument_list|,
name|notenum
argument_list|,
name|respnum
argument_list|,
operator|&
name|io
operator|.
name|stime
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|lrsp
argument_list|(
operator|&
name|io
argument_list|,
name|notenum
argument_list|,
name|respnum
argument_list|,
operator|&
name|rsprec
argument_list|,
operator|&
name|roffset
argument_list|,
operator|&
name|rblock
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
comment|/* bad chain */
if|if
condition|(
name|rsprec
operator|.
name|r_stat
index|[
name|roffset
index|]
operator|&
name|FRMNEWS
condition|)
continue|continue;
comment|/* never back to news */
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|rsprec
operator|.
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|,
name|SYSTEM
argument_list|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|othersok
operator|==
literal|0
operator|)
condition|)
continue|continue;
comment|/* don't dump non-local */
if|if
condition|(
name|newsresp
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|note
argument_list|,
name|notenum
argument_list|,
operator|&
name|rsprec
argument_list|,
name|roffset
argument_list|,
name|respnum
argument_list|,
name|ngroup
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s/%s/%s"
argument_list|,
name|MSTDIR
argument_list|,
name|UTILITY
argument_list|,
name|NETLOG
argument_list|)
expr_stmt|;
name|sprdate
argument_list|(
operator|&
name|whendump
argument_list|,
name|ztime
argument_list|)
expr_stmt|;
name|glock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
comment|/* mutual exclusion */
name|x
argument_list|(
operator|(
name|log
operator|=
name|fopen
argument_list|(
name|buf
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
argument_list|,
literal|"newsout: missing log file"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|log
argument_list|,
literal|"%s: failed to send to NEWS at %s\n"
argument_list|,
name|nfname
argument_list|,
name|ndumped
argument_list|,
name|rdumped
argument_list|,
name|ztime
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|log
argument_list|)
expr_stmt|;
name|gunlock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
comment|/* all done */
block|}
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* let news run ... */
name|rdumped
operator|++
expr_stmt|;
block|}
block|}
name|fixlast
argument_list|(
operator|&
name|whendump
argument_list|,
name|nfname
argument_list|,
literal|1
argument_list|,
name|NEWSSYS
argument_list|)
expr_stmt|;
comment|/* update sequencer */
if|if
condition|(
name|ndumped
operator|+
name|rdumped
condition|)
block|{
comment|/* log dump */
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s/%s/%s"
argument_list|,
name|MSTDIR
argument_list|,
name|UTILITY
argument_list|,
name|NETLOG
argument_list|)
expr_stmt|;
name|sprdate
argument_list|(
operator|&
name|whendump
argument_list|,
name|ztime
argument_list|)
expr_stmt|;
name|glock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
comment|/* mutual exclusion */
name|x
argument_list|(
operator|(
name|log
operator|=
name|fopen
argument_list|(
name|buf
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
argument_list|,
literal|"newsout: missing log file"
argument_list|)
expr_stmt|;
name|x
argument_list|(
operator|(
name|log
operator|=
name|fopen
argument_list|(
name|buf
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
argument_list|,
literal|"newsout: missing log file"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|log
argument_list|,
literal|"%s: sent %d notes& %d responses to NEWS at %s\n"
argument_list|,
name|nfname
argument_list|,
name|ndumped
argument_list|,
name|rdumped
argument_list|,
name|ztime
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|log
argument_list|)
expr_stmt|;
name|gunlock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
comment|/* all done */
block|}
name|finish
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
comment|/* close shop here */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


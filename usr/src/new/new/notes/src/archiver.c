begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
modifier|*
name|sccsid
init|=
literal|"%W%"
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|"parms.h"
end_include

begin_include
include|#
directive|include
file|"structs.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|BSD4
name|.1c
end_ifdef

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_endif
endif|#
directive|endif
endif|BSD4.1c
end_endif

begin_comment
comment|/*  *	archiver - archives a notesfile. Takes all articles older  *	than 'daysold' days and places them, in generic format, in  *	a sub-directory in the archie directory. The files are marked  *	by the time that they were created.   *	The deleteonly parameter is normally zero. If it is non-zero,  *	no archive is taken; the old notes are merely thrown away.  *  *	Ray Essick			March 1982  *  *	modified so that could also toggle on the director message.  *	in addition to the days untouched.  *				Ray Essick	June 1982  */
end_comment

begin_macro
name|archiver
argument_list|(
argument|nfname
argument_list|,
argument|daysold
argument_list|,
argument|deleteonly
argument_list|,
argument|dirmsgflag
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|nfname
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|io_f
name|io
decl_stmt|;
name|struct
name|when_f
name|zaptime
decl_stmt|;
comment|/* boundary time */
name|struct
name|note_f
name|note
decl_stmt|;
name|int
name|archfid
decl_stmt|,
name|i
decl_stmt|,
name|ncount
decl_stmt|;
name|char
name|line
index|[
name|CMDLEN
index|]
decl_stmt|;
name|char
name|archfile
index|[
name|WDLEN
index|]
decl_stmt|;
name|char
name|timeline
index|[
name|DATELEN
index|]
decl_stmt|;
name|long
name|current
decl_stmt|;
name|struct
name|stat
name|buf
decl_stmt|;
name|FILE
modifier|*
name|log
decl_stmt|,
modifier|*
name|farchfile
decl_stmt|;
ifdef|#
directive|ifdef
name|BSD4
name|.1c
name|DIR
modifier|*
name|dir
decl_stmt|;
name|int
name|fid
decl_stmt|;
endif|#
directive|endif
endif|BSD4.1c
if|if
condition|(
name|init
argument_list|(
operator|&
name|io
argument_list|,
name|nfname
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* no notesfile */
if|if
condition|(
operator|(
name|allow
argument_list|(
operator|&
name|io
argument_list|,
name|DRCTOK
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|globuid
operator|!=
name|NOTESUID
operator|)
condition|)
block|{
name|closenf
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"You are not allowed to archive the %s notesfile\n"
argument_list|,
name|io
operator|.
name|nf
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|gettime
argument_list|(
operator|&
name|zaptime
argument_list|)
expr_stmt|;
comment|/* make the old time */
name|sprintf
argument_list|(
name|archfile
argument_list|,
literal|"%02d.%02d.%02d:%02d%02d"
argument_list|,
name|zaptime
operator|.
name|w_year
operator|%
literal|100
argument_list|,
name|zaptime
operator|.
name|w_month
argument_list|,
name|zaptime
operator|.
name|w_day
argument_list|,
name|zaptime
operator|.
name|w_hours
argument_list|,
name|zaptime
operator|.
name|w_mins
argument_list|)
expr_stmt|;
name|zaptime
operator|.
name|w_hours
operator|=
name|zaptime
operator|.
name|w_mins
operator|=
literal|0
expr_stmt|;
comment|/* zilch these */
name|zaptime
operator|.
name|w_day
operator|-=
name|daysold
expr_stmt|;
comment|/* reset days */
while|while
condition|(
name|zaptime
operator|.
name|w_day
operator|<=
literal|0
condition|)
block|{
comment|/* fix month wrap */
name|zaptime
operator|.
name|w_day
operator|+=
literal|30
expr_stmt|;
name|zaptime
operator|.
name|w_month
operator|-=
literal|1
expr_stmt|;
block|}
while|while
condition|(
name|zaptime
operator|.
name|w_month
operator|<=
literal|0
condition|)
block|{
comment|/* fix year wrap */
name|zaptime
operator|.
name|w_month
operator|+=
literal|12
expr_stmt|;
name|zaptime
operator|.
name|w_year
operator|-=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|deleteonly
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|BSD4
name|.1c
if|if
condition|(
operator|(
name|dir
operator|=
name|opendir
argument_list|(
name|ARCHDIR
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"archiver: no achive directory"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|BAD
argument_list|)
expr_stmt|;
block|}
name|closedir
argument_list|(
name|dir
argument_list|)
expr_stmt|;
else|#
directive|else
name|x
argument_list|(
operator|(
name|i
operator|=
name|open
argument_list|(
name|ARCHDIR
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
argument_list|,
literal|"archiver: no achive directory"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD4.1c
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%s/%s"
argument_list|,
name|ARCHDIR
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD4
name|.1c
if|if
condition|(
operator|(
name|dir
operator|=
name|opendir
argument_list|(
name|line
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
else|#
directive|else
if|if
condition|(
operator|(
name|i
operator|=
name|open
argument_list|(
name|line
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
endif|#
directive|endif
endif|BSD4.1c
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%s/%s"
argument_list|,
name|ARCHDIR
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|dounix
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"/bin/mkdir"
argument_list|,
name|line
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* build directory */
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|BSD4
name|.1c
name|closedir
argument_list|(
name|dir
argument_list|)
expr_stmt|;
comment|/* close up */
else|#
directive|else
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
comment|/* close up */
endif|#
directive|endif
endif|BSD4.1c
block|}
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%s/%s/%s"
argument_list|,
name|ARCHDIR
argument_list|,
name|nfname
argument_list|,
name|archfile
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD4
name|.1c
if|if
condition|(
operator|(
name|archfid
operator|=
name|open
argument_list|(
name|line
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
else|#
directive|else
if|if
condition|(
operator|(
name|archfid
operator|=
name|open
argument_list|(
name|line
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
endif|#
directive|endif
endif|BSD4.1c
name|printf
argument_list|(
literal|"Archive of %s too recent, try again in a minute\n"
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|archfid
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* did not archive */
block|}
name|x
argument_list|(
operator|(
name|farchfile
operator|=
name|fopen
argument_list|(
name|line
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
argument_list|,
literal|"archiver: bad create"
argument_list|)
expr_stmt|;
block|}
name|lock
argument_list|(
operator|&
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
comment|/* would be a good idea */
ifdef|#
directive|ifdef
name|OLDGROUP
comment|/* delete inactive groups - RLS 1/8/83 */
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%s/%s"
argument_list|,
name|MSTDIR
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|stat
argument_list|(
name|line
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
name|current
operator|=
name|time
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|current
operator|-
name|buf
operator|.
name|st_mtime
operator|>
literal|60
operator|*
literal|60
operator|*
literal|24
operator|*
operator|(
name|OLDGROUP
operator|-
name|daysold
operator|)
condition|)
block|{
name|unlock
argument_list|(
operator|&
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|finish
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"/bin/rm -rf %s/%s"
argument_list|,
name|MSTDIR
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|line
argument_list|)
expr_stmt|;
name|gettime
argument_list|(
operator|&
name|zaptime
argument_list|)
expr_stmt|;
name|sprdate
argument_list|(
operator|&
name|zaptime
argument_list|,
name|timeline
argument_list|)
expr_stmt|;
comment|/* message in nfmaint */
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"Archiver: removed %s\n"
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|nfcomment
argument_list|(
name|NOSUCHWARN
argument_list|,
name|line
argument_list|,
name|line
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|glock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
comment|/* make log entry */
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%s/%s/%s"
argument_list|,
name|MSTDIR
argument_list|,
name|UTILITY
argument_list|,
name|NETLOG
argument_list|)
expr_stmt|;
name|x
argument_list|(
operator|(
name|log
operator|=
name|fopen
argument_list|(
name|line
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
argument_list|,
literal|"archiver: no logfile"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|log
argument_list|,
literal|"Archiver: deleted %s at %s\n"
argument_list|,
name|nfname
argument_list|,
name|timeline
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Archiver: deleted %s at %s\n"
argument_list|,
name|nfname
argument_list|,
name|timeline
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|log
argument_list|)
expr_stmt|;
name|gunlock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
endif|#
directive|endif
comment|/*      * 	this open races with above check - can archive twice!       */
name|getdscr
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|io
operator|.
name|descr
argument_list|)
expr_stmt|;
name|ncount
operator|=
literal|0
expr_stmt|;
comment|/* count of notes archived */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|io
operator|.
name|descr
operator|.
name|d_nnote
condition|;
name|i
operator|++
control|)
block|{
name|getnrec
argument_list|(
operator|&
name|io
argument_list|,
name|i
argument_list|,
operator|&
name|note
argument_list|)
expr_stmt|;
if|if
condition|(
name|note
operator|.
name|n_stat
operator|&
name|DELETED
condition|)
block|{
continue|continue;
comment|/* never archive deleted notes */
block|}
if|if
condition|(
name|dirmsgflag
operator|==
name|DIROFF
operator|&&
operator|(
name|note
operator|.
name|n_stat
operator|&
name|DIRMES
operator|)
condition|)
block|{
continue|continue;
comment|/* don't if dir on */
block|}
if|if
condition|(
name|dirmsgflag
operator|==
name|DIRON
operator|&&
operator|(
name|note
operator|.
name|n_stat
operator|&
name|DIRMES
operator|)
operator|==
literal|0
condition|)
block|{
continue|continue;
comment|/* don't if dir off */
block|}
if|if
condition|(
name|inorder
argument_list|(
operator|&
name|zaptime
argument_list|,
operator|&
name|note
operator|.
name|n_lmod
argument_list|)
condition|)
block|{
continue|continue;
comment|/* touched too recently */
block|}
if|if
condition|(
name|deleteonly
operator|==
literal|0
condition|)
block|{
name|dmpnote
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|note
argument_list|,
name|i
argument_list|,
name|farchfile
argument_list|,
name|NODETAIL
argument_list|)
expr_stmt|;
comment|/* save base note */
name|dmprall
argument_list|(
operator|&
name|io
argument_list|,
operator|&
name|note
argument_list|,
name|i
argument_list|,
name|farchfile
argument_list|,
name|NODETAIL
argument_list|)
expr_stmt|;
comment|/* save resps */
block|}
name|delnote
argument_list|(
operator|&
name|io
argument_list|,
name|i
argument_list|,
name|NOLOCKIT
argument_list|)
expr_stmt|;
comment|/* delete entry */
name|ncount
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|deleteonly
operator|==
literal|0
condition|)
name|x
argument_list|(
name|fclose
argument_list|(
name|farchfile
argument_list|)
operator|<
literal|0
argument_list|,
literal|"archiver: close archive"
argument_list|)
expr_stmt|;
comment|/* dont' compress if the group is empty, saves time and allows auto      * group expiration      */
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%s/%s/text"
argument_list|,
name|MSTDIR
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|stat
argument_list|(
name|line
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|.
name|st_size
operator|>
literal|4
condition|)
block|{
name|int
name|nnotes
decl_stmt|,
name|nresps
decl_stmt|;
if|if
condition|(
name|compress
argument_list|(
operator|&
name|io
argument_list|,
name|NOLOCKIT
argument_list|,
operator|&
name|nnotes
argument_list|,
operator|&
name|nresps
argument_list|)
operator|>=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: %d notes and %d responses after compression.\n"
argument_list|,
name|nfname
argument_list|,
name|nnotes
argument_list|,
name|nresps
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s: notesfile already compressed\n"
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
block|}
name|unlock
argument_list|(
operator|&
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
comment|/* all done with this */
name|finish
argument_list|(
operator|&
name|io
argument_list|)
expr_stmt|;
comment|/* and close the notesfile */
comment|/* fix by RLS (8/19/82) */
name|gettime
argument_list|(
operator|&
name|zaptime
argument_list|)
expr_stmt|;
name|sprdate
argument_list|(
operator|&
name|zaptime
argument_list|,
name|timeline
argument_list|)
expr_stmt|;
if|if
condition|(
name|ncount
condition|)
block|{
comment|/* log only if did somethine */
name|glock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
comment|/* make log entry */
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%s/%s/%s"
argument_list|,
name|MSTDIR
argument_list|,
name|UTILITY
argument_list|,
name|NETLOG
argument_list|)
expr_stmt|;
name|x
argument_list|(
operator|(
name|log
operator|=
name|fopen
argument_list|(
name|line
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
argument_list|,
literal|"archiver: no logfile"
argument_list|)
expr_stmt|;
if|if
condition|(
name|deleteonly
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|log
argument_list|,
literal|"%s: archived %d notes into %s at %s\n"
argument_list|,
name|nfname
argument_list|,
name|ncount
argument_list|,
name|archfile
argument_list|,
name|timeline
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|log
argument_list|,
literal|"%s: Archiver deleted %d notes at %s\n"
argument_list|,
name|nfname
argument_list|,
name|ncount
argument_list|,
name|timeline
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|log
argument_list|)
expr_stmt|;
name|gunlock
argument_list|(
operator|&
name|io
argument_list|,
name|LOGLOCK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|deleteonly
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Archived: %s: %d notes into file %s at %s\n"
argument_list|,
name|nfname
argument_list|,
name|ncount
argument_list|,
name|archfile
argument_list|,
name|timeline
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Archiver deleted from %s %d notes at %s\n"
argument_list|,
name|nfname
argument_list|,
name|ncount
argument_list|,
name|timeline
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* and return */
block|}
end_block

end_unit


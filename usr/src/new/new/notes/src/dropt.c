begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
modifier|*
name|sccsid
init|=
literal|"%W%"
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|"parms.h"
end_include

begin_include
include|#
directive|include
file|"structs.h"
end_include

begin_define
define|#
directive|define
name|BUFSZ
value|128
end_define

begin_comment
comment|/*  *	this file processes the director options.  *  *	call: contains the io pointer to the file.  *  *	allows continued access only if the user if a director.  *  *	the functions of the director options includes:  *	1) granting/denial of director priviledges  *	2) granting/denial of regular access priviledges  *	3) changing the director message  *	4) writing a policy note  *  *	Returns: -1 normally  *		 -4 if the user hit cntrl d ( to total exit)  *  *	original author/outliner : Ray Essick may 29, 1981  *	modified: Lou Salkind  */
end_comment

begin_macro
name|direct
argument_list|(
argument|io
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|io_f
modifier|*
name|io
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
comment|/* scratch */
name|int
name|c
decl_stmt|;
name|char
name|title
index|[
name|DMLEN
operator|+
literal|1
index|]
decl_stmt|;
comment|/* hold new director message */
name|char
name|ntitle
index|[
name|NNLEN
operator|+
literal|1
index|]
decl_stmt|;
comment|/* hold note file title */
name|struct
name|note_f
name|note
decl_stmt|;
name|struct
name|auth_f
name|auth
decl_stmt|;
comment|/* author of policy note */
name|struct
name|daddr_f
name|where
decl_stmt|;
name|char
modifier|*
name|r
decl_stmt|,
name|buff
index|[
name|BUFSZ
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|buffptr
decl_stmt|;
name|int
name|start
decl_stmt|,
name|end
decl_stmt|;
name|struct
name|notesenv
name|oldenv
decl_stmt|;
name|int
name|retstat
decl_stmt|;
name|int
name|nnotes
decl_stmt|,
name|nresps
decl_stmt|;
if|if
condition|(
name|allow
argument_list|(
name|io
argument_list|,
name|DRCTOK
argument_list|)
operator|==
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"Sorry, you are not a director"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|replot
operator|=
literal|1
expr_stmt|;
name|oldenv
operator|=
name|curenv
expr_stmt|;
name|setjmp
argument_list|(
name|jenv
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|replot
condition|)
block|{
name|replot
operator|=
literal|0
expr_stmt|;
name|erase
argument_list|()
expr_stmt|;
name|center
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_title
argument_list|,
name|NNLEN
argument_list|,
literal|1
argument_list|,
literal|40
operator|-
name|NNLEN
operator|/
literal|2
argument_list|)
expr_stmt|;
name|center
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_drmes
argument_list|,
name|DMLEN
argument_list|,
literal|2
argument_list|,
literal|40
operator|-
name|DMLEN
operator|/
literal|2
argument_list|)
expr_stmt|;
name|at
argument_list|(
literal|3
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Anonymous: "
argument_list|)
expr_stmt|;
comment|/* at(3, 25); */
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ANONOK
condition|?
literal|"ON "
else|:
literal|"OFF"
argument_list|)
expr_stmt|;
name|at
argument_list|(
literal|3
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Notefile: "
argument_list|)
expr_stmt|;
comment|/* at(3, 41); */
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|OPEN
condition|?
literal|"OPEN  "
else|:
literal|"CLOSED"
argument_list|)
expr_stmt|;
name|at
argument_list|(
literal|3
argument_list|,
literal|51
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Networked: "
argument_list|)
expr_stmt|;
comment|/* at(3, 62); */
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|NETWRKD
condition|?
literal|"YES"
else|:
literal|"NO "
argument_list|)
expr_stmt|;
block|}
name|cmdprompt
argument_list|()
expr_stmt|;
name|c
operator|=
name|gchar
argument_list|()
expr_stmt|;
comment|/* get the command character */
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'r'
case|:
case|case
literal|'\f'
case|:
name|replot
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
case|case
literal|'h'
case|:
name|help
argument_list|(
name|DIRHLP
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
case|case
literal|'q'
case|:
comment|/* leave director options */
name|retstat
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
case|case
literal|'\004'
case|:
comment|/* control D */
name|retstat
operator|=
name|QUITFAST
expr_stmt|;
goto|goto
name|out
goto|;
case|case
literal|'!'
case|:
comment|/* give him a shell */
name|gshell
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* run access lists */
if|if
condition|(
name|access
argument_list|(
name|io
argument_list|)
operator|==
name|QUITFAST
condition|)
block|{
name|retstat
operator|=
name|QUITFAST
expr_stmt|;
goto|goto
name|out
goto|;
block|}
break|break;
comment|/* skipt out of the loop */
case|case
literal|'a'
case|:
comment|/* toggle anonymous option */
name|lock
argument_list|(
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* get up to date descriptor */
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ANONOK
condition|)
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&=
name|NOT
name|ANONOK
expr_stmt|;
else|else
name|io
operator|->
name|descr
operator|.
name|d_stat
operator||=
name|ANONOK
expr_stmt|;
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlock
argument_list|(
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|at
argument_list|(
literal|3
argument_list|,
literal|25
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|ANONOK
condition|?
literal|"ON "
else|:
literal|"OFF"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
comment|/* compress the notefile */
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|OPEN
condition|)
block|{
name|warn
argument_list|(
literal|"Notefile must be closed to compress"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|prompt
argument_list|(
literal|"Compressing..."
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|compress
argument_list|(
name|io
argument_list|,
name|LOCKIT
argument_list|,
operator|&
name|nnotes
argument_list|,
operator|&
name|nresps
argument_list|)
operator|>=
literal|0
condition|)
name|prompt
argument_list|(
literal|"Left %d notes and %d responses"
argument_list|,
name|nnotes
argument_list|,
name|nresps
argument_list|)
expr_stmt|;
else|else
name|warn
argument_list|(
literal|"notesfile compressed behind your back"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
comment|/* toggle open status */
name|lock
argument_list|(
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|OPEN
condition|)
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&=
name|NOT
name|OPEN
expr_stmt|;
else|else
name|io
operator|->
name|descr
operator|.
name|d_stat
operator||=
name|OPEN
expr_stmt|;
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlock
argument_list|(
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|at
argument_list|(
literal|3
argument_list|,
literal|41
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|OPEN
condition|?
literal|"OPEN  "
else|:
literal|"CLOSED"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* toggle network status */
name|lock
argument_list|(
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|NETWRKD
condition|)
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&=
name|NOT
name|NETWRKD
expr_stmt|;
else|else
name|io
operator|->
name|descr
operator|.
name|d_stat
operator||=
name|NETWRKD
expr_stmt|;
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlock
argument_list|(
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|at
argument_list|(
literal|3
argument_list|,
literal|62
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|io
operator|->
name|descr
operator|.
name|d_stat
operator|&
name|NETWRKD
condition|?
literal|"YES"
else|:
literal|"NO "
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* collect a new director message */
name|prompt
argument_list|(
literal|"New director message: "
argument_list|)
expr_stmt|;
name|i
operator|=
name|gline
argument_list|(
name|title
argument_list|,
name|DMLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|1
condition|)
break|break;
comment|/* no new message */
for|for
control|(
name|i
operator|--
init|;
name|i
operator|<
name|DMLEN
condition|;
name|i
operator|++
control|)
name|title
index|[
name|i
index|]
operator|=
literal|' '
expr_stmt|;
comment|/* space fill the message */
name|lock
argument_list|(
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
comment|/* get up-to-date version */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DMLEN
condition|;
name|i
operator|++
control|)
name|io
operator|->
name|descr
operator|.
name|d_drmes
index|[
name|i
index|]
operator|=
name|title
index|[
name|i
index|]
expr_stmt|;
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlock
argument_list|(
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|replot
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
comment|/* write title for note file */
name|prompt
argument_list|(
literal|"New title for notefile: "
argument_list|)
expr_stmt|;
name|i
operator|=
name|gline
argument_list|(
name|ntitle
argument_list|,
name|NNLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|1
condition|)
break|break;
comment|/* no new message */
for|for
control|(
name|i
operator|--
init|;
name|i
operator|<
name|NNLEN
condition|;
name|i
operator|++
control|)
name|ntitle
index|[
name|i
index|]
operator|=
literal|' '
expr_stmt|;
name|lock
argument_list|(
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
comment|/* get up-to-date version */
name|getdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NNLEN
condition|;
name|i
operator|++
control|)
name|io
operator|->
name|descr
operator|.
name|d_title
index|[
name|i
index|]
operator|=
name|ntitle
index|[
name|i
index|]
expr_stmt|;
name|putdscr
argument_list|(
name|io
argument_list|,
operator|&
name|io
operator|->
name|descr
argument_list|)
expr_stmt|;
name|unlock
argument_list|(
name|io
argument_list|,
literal|'n'
argument_list|)
expr_stmt|;
name|replot
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
comment|/* let him write a new policy note */
if|if
condition|(
name|io
operator|->
name|descr
operator|.
name|d_plcy
condition|)
block|{
name|prompt
argument_list|(
literal|"Rewrite policy? "
argument_list|)
expr_stmt|;
if|if
condition|(
name|askyn
argument_list|()
operator|==
literal|'n'
condition|)
block|{
name|c
operator|=
literal|'e'
expr_stmt|;
break|break;
block|}
block|}
name|prompt
argument_list|(
literal|"Edit New Policy Text:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|gettext
argument_list|(
name|io
argument_list|,
operator|&
name|where
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|c
operator|=
literal|'e'
expr_stmt|;
break|break;
block|}
name|r
operator|=
name|title
expr_stmt|;
for|for
control|(
name|i
operator|=
name|strmove
argument_list|(
literal|"POLICY NOTE"
argument_list|,
name|r
argument_list|)
init|;
name|i
operator|<
name|TITLEN
condition|;
name|i
operator|++
control|)
name|title
index|[
name|i
index|]
operator|=
literal|' '
expr_stmt|;
comment|/* spave fill */
name|gettime
argument_list|(
operator|&
name|note
operator|.
name|n_date
argument_list|)
expr_stmt|;
comment|/* date of writing */
name|getname
argument_list|(
operator|&
name|auth
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* get author */
name|putnote
argument_list|(
name|io
argument_list|,
operator|&
name|where
argument_list|,
name|title
argument_list|,
literal|0
argument_list|,
operator|&
name|note
argument_list|,
operator|&
name|auth
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|SYSTEM
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dspnote
argument_list|(
name|io
argument_list|,
operator|&
name|note
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* show it to him */
break|break;
case|case
literal|'z'
case|:
comment|/* zap a lot of notes/responses */
name|prompt
argument_list|(
literal|"Enter list of notes to delete: "
argument_list|)
expr_stmt|;
name|i
operator|=
name|gline
argument_list|(
name|buff
argument_list|,
name|BUFSZ
argument_list|)
expr_stmt|;
comment|/* grab line */
if|if
condition|(
name|i
operator|<=
literal|1
condition|)
continue|continue;
name|prompt
argument_list|(
literal|"Really delete %s? "
argument_list|,
name|buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|askyn
argument_list|()
operator|!=
literal|'y'
condition|)
break|break;
comment|/* chicken out */
name|buffptr
operator|=
literal|0
expr_stmt|;
name|at
argument_list|(
literal|14
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|clear_eol
argument_list|()
expr_stmt|;
while|while
condition|(
name|listget
argument_list|(
name|buff
argument_list|,
operator|&
name|buffptr
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|end
argument_list|)
condition|)
block|{
if|if
condition|(
name|start
operator|==
name|end
condition|)
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|start
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%d-%d "
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|mdelete
argument_list|(
name|io
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
comment|/* zap those */
block|}
continue|continue;
default|default:
name|warn
argument_list|(
literal|"? for help, q to quit"
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|out
label|:
name|ignsigs
operator|++
expr_stmt|;
name|curenv
operator|=
name|oldenv
expr_stmt|;
name|ignsigs
operator|--
expr_stmt|;
return|return
operator|(
name|retstat
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***************************************************************************  * This program is Copyright (C) 1986, 1987, 1988 by Jonathan Payne.  JOVE *  * is provided to you without charge, and with no warranty.  You may give  *  * away copies of JOVE, including sources, provided that this notice is    *  * included in all the files.                                              *  ***************************************************************************/
end_comment

begin_comment
comment|/* Macvert converts old style macro files to the new style.  The old    style macros were binary files, the new ones are text files suitable    for loading with the "source" command of JOVE. */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_decl_stmt
specifier|extern
name|int
name|read
argument_list|()
decl_stmt|,
name|write
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mac_fd
decl_stmt|;
end_decl_stmt

begin_macro
name|mac_io
argument_list|(
argument|fcn
argument_list|,
argument|ptr
argument_list|,
argument|nbytes
argument_list|)
end_macro

begin_function_decl
name|int
function_decl|(
modifier|*
name|fcn
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
modifier|*
name|ptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|nio
decl_stmt|;
if|if
condition|(
operator|(
name|nio
operator|=
call|(
modifier|*
name|fcn
call|)
argument_list|(
name|mac_fd
argument_list|,
name|ptr
argument_list|,
name|nbytes
argument_list|)
operator|)
operator|!=
name|nbytes
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"[Macro %s error: %d got %d]"
argument_list|,
operator|(
name|fcn
operator|==
name|read
operator|)
condition|?
literal|"read"
else|:
literal|"write"
argument_list|,
name|nbytes
argument_list|,
name|nio
argument_list|)
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|NEWWAY
value|1
end_define

begin_define
define|#
directive|define
name|OLDWAY
value|0
end_define

begin_decl_stmt
name|int
name|int_how
init|=
name|NEWWAY
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Formatting int's the old way or the new "improved" way? */
end_comment

begin_if
if|#
directive|if
name|vax
operator|||
name|pdp11
end_if

begin_function
name|long
name|htonl
parameter_list|(
name|x
parameter_list|)
specifier|register
name|long
name|x
decl_stmt|;
block|{
return|return
operator|(
operator|(
operator|(
operator|(
name|x
operator|>>
literal|0
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
operator|(
name|x
operator|>>
literal|8
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|x
operator|>>
literal|16
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|x
operator|>>
literal|24
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|0
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|short
name|htons
parameter_list|(
name|x
parameter_list|)
specifier|register
name|short
name|x
decl_stmt|;
block|{
return|return
operator|(
operator|(
operator|(
operator|(
name|x
operator|>>
literal|0
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|x
operator|>>
literal|8
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|0
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|long
name|ntohl
parameter_list|(
name|x
parameter_list|)
specifier|register
name|long
name|x
decl_stmt|;
block|{
return|return
operator|(
operator|(
operator|(
operator|(
name|x
operator|>>
literal|0
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
operator|(
name|x
operator|>>
literal|8
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|x
operator|>>
literal|16
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|x
operator|>>
literal|24
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|0
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|short
name|ntohs
parameter_list|(
name|x
parameter_list|)
specifier|register
name|short
name|x
decl_stmt|;
block|{
return|return
operator|(
operator|(
operator|(
operator|(
name|x
operator|>>
literal|0
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|x
operator|>>
literal|8
operator|)
operator|&
literal|0377
operator|)
operator|<<
literal|0
operator|)
operator|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
name|long
name|htonl
parameter_list|(
name|x
parameter_list|)
specifier|register
name|long
name|x
decl_stmt|;
block|{
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_function
name|short
name|htons
parameter_list|(
name|x
parameter_list|)
specifier|register
name|short
name|x
decl_stmt|;
block|{
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_function
name|long
name|ntohl
parameter_list|(
name|x
parameter_list|)
specifier|register
name|long
name|x
decl_stmt|;
block|{
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_function
name|short
name|ntohs
parameter_list|(
name|x
parameter_list|)
specifier|register
name|short
name|x
decl_stmt|;
block|{
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_macro
name|int_fmt
argument_list|(
argument|i
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|int_how
operator|==
name|NEWWAY
condition|)
return|return
name|ntohl
argument_list|(
name|i
argument_list|)
return|;
return|return
name|i
return|;
block|}
end_block

begin_macro
name|read_and_write_macros
argument_list|(
argument|filein
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|filein
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|namelen
decl_stmt|,
name|bodylen
decl_stmt|,
name|tmp
decl_stmt|;
name|char
name|macname
index|[
literal|256
index|]
decl_stmt|,
name|macbuf
index|[
literal|1024
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|mac_fd
operator|=
name|open
argument_list|(
name|filein
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot open %s\n"
argument_list|,
name|filein
argument_list|)
expr_stmt|;
while|while
condition|(
name|read
argument_list|(
name|mac_fd
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|tmp
argument_list|,
sizeof|sizeof
name|tmp
argument_list|)
operator|==
operator|(
sizeof|sizeof
name|tmp
operator|)
condition|)
block|{
name|retry
label|:
name|bodylen
operator|=
name|int_fmt
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bodylen
operator|<=
literal|0
operator|||
name|bodylen
operator|>
literal|10000
condition|)
block|{
if|if
condition|(
name|int_how
operator|==
name|NEWWAY
condition|)
block|{
name|int_how
operator|=
name|OLDWAY
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"I don't think \"%s\" is an old style JOVE macro file\n"
argument_list|,
name|filein
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|mac_io
argument_list|(
name|read
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|namelen
argument_list|,
sizeof|sizeof
name|namelen
argument_list|)
expr_stmt|;
name|namelen
operator|=
name|int_fmt
argument_list|(
name|namelen
argument_list|)
expr_stmt|;
name|mac_io
argument_list|(
name|read
argument_list|,
name|macname
argument_list|,
name|namelen
argument_list|)
expr_stmt|;
name|mac_io
argument_list|(
name|read
argument_list|,
name|macbuf
argument_list|,
name|bodylen
argument_list|)
expr_stmt|;
name|output_new_definition
argument_list|(
name|macname
argument_list|,
name|macbuf
argument_list|,
name|bodylen
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|pr_putc
argument_list|(
argument|c
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|c
operator|==
literal|'\\'
operator|||
name|c
operator|==
literal|'^'
condition|)
name|putchar
argument_list|(
literal|'\\'
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|<
literal|' '
operator|||
name|c
operator|==
literal|'\177'
condition|)
block|{
name|putchar
argument_list|(
literal|'^'
argument_list|)
expr_stmt|;
name|c
operator|=
operator|(
name|c
operator|==
literal|'\177'
operator|)
condition|?
literal|'?'
else|:
operator|(
name|c
operator|+
literal|'@'
operator|)
expr_stmt|;
block|}
name|putchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|output_new_definition
argument_list|(
argument|name
argument_list|,
argument|body
argument_list|,
argument|bodylen
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|body
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"define-macro %s "
argument_list|,
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bodylen
condition|;
name|i
operator|++
control|)
name|pr_putc
argument_list|(
name|body
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: macvert<old-style-macro-file>\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|read_and_write_macros
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


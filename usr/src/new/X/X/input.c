begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1985	*/
end_comment

begin_comment
comment|/*	Routines for dealing with input devices and events:  *  *	Register_cursor, Unregister_cursor, Interpret_locator,  *	Grab_mouse, Ungrab_mouse, Grab_button, Ungrab_button, Warp_mouse,  *	Focus_keyboard, Unbutton_window, Ungrab_client, Select_input,  *	Set_shiftlock, Startup_mouse,  *	Deal_with_movement, Deal_with_input,  *	Stash_changes, Stash_misses, Stash_simple  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_input_c
init|=
literal|"$Header: input.c,v 10.12 86/12/17 20:25:13 swick Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"Xint.h"
end_include

begin_decl_stmt
specifier|extern
name|u_char
name|Xstatus
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|DEVICE
name|device
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|WINDOW
modifier|*
name|rootwindow
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|RECTANGLE
modifier|*
name|free_rectangles
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|DUALTCP
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|swapped
index|[]
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
struct|struct
name|grab_info
block|{
name|int
name|client
decl_stmt|;
comment|/* Grabbing client */
name|WINDOW
modifier|*
name|window
decl_stmt|;
comment|/* Event window */
name|long
name|mask
decl_stmt|;
comment|/* Event mask */
name|CURSOR
modifier|*
name|cursor
decl_stmt|;
comment|/* Cursor info */
block|}
name|GRAB_INFO
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|short
name|mouse_x
init|=
literal|0
decl_stmt|,
name|mouse_y
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The mouse state */
end_comment

begin_decl_stmt
name|CURSOR
modifier|*
name|cursor
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Current cursor */
end_comment

begin_decl_stmt
specifier|static
name|WINDOW
modifier|*
name|cursor_window
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Where cursor came from */
end_comment

begin_decl_stmt
specifier|static
name|WINDOW
modifier|*
name|mouse_window
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Where mouse currently is */
end_comment

begin_decl_stmt
name|RASTER
name|mbox
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Mouse motion bounding box */
end_comment

begin_decl_stmt
name|WINDOW
modifier|*
name|button_window
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Where button was pressed */
end_comment

begin_decl_stmt
name|int
name|mouse_grabber
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Who has grabbed the mouse */
end_comment

begin_decl_stmt
name|WINDOW
modifier|*
name|mouse_grab_window
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Window for grab events */
end_comment

begin_decl_stmt
specifier|static
name|long
name|mouse_grab_mask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Grab events of interest */
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|mouse_grab_button
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Button that caused grab */
end_comment

begin_decl_stmt
name|WINDOW
modifier|*
name|key_window
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Keyboard focus window */
end_comment

begin_decl_stmt
specifier|static
name|ushort
name|key_level
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* key_window->level */
end_comment

begin_decl_stmt
name|unsigned
name|state_mask
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* key and button state mask */
end_comment

begin_decl_stmt
specifier|static
name|int
name|lock_mode
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* shiftlock mode */
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|lock_mask
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* shiftlock shadow mask */
end_comment

begin_decl_stmt
specifier|static
name|long
name|motion_mask
init|=
name|MouseMoved
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* motion events */
end_comment

begin_define
define|#
directive|define
name|GRABS
value|48
end_define

begin_decl_stmt
specifier|static
name|GRAB_INFO
name|bgrabs
index|[
name|GRABS
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* button grab info */
end_comment

begin_define
define|#
directive|define
name|GRABIDX
parameter_list|(
name|but
parameter_list|,
name|mask
parameter_list|)
value|((but<< 4) + FullKeyState(mask))
end_define

begin_define
define|#
directive|define
name|grabbits
value|(ControlMask|MetaMask|ShiftMask|ShiftLockMask|LeftMask|MiddleMask|RightMask)
end_define

begin_define
define|#
directive|define
name|ShiftKeyCode
value|0256
end_define

begin_define
define|#
directive|define
name|ControlKeyCode
value|0257
end_define

begin_define
define|#
directive|define
name|LockKeyCode
value|0260
end_define

begin_define
define|#
directive|define
name|MetaKeyCode
value|0261
end_define

begin_comment
comment|/* Search down the heirarchy for the smallest enclosing window.  * This usually should be faster than doing a linear search of mapped_list,  * and should be fast enough that we don't need to maintain extra, complicated  * data structures like a layered dag.  */
end_comment

begin_define
define|#
directive|define
name|SEARCH
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|w
parameter_list|,
name|ww
parameter_list|)
define|\
value|ww = rootwindow;\ 	    w = ww->last_child;\ 	    while (w) {\ 		if (TRUE(w->mapped)&&\ 		    x>= w->vs.left&& y>= w->vs.top&&\ 		    x< w->vs.right&& y< w->vs.bottom) {\ 		    ww = w;\ 		    w = ww->last_child;\ 		} else\ 		    w = w->prev_sib;\ 	    }\ 	    if (w == NULL)\ 		w = ww
end_define

begin_comment
comment|/* Define the mouse cursor for a window */
end_comment

begin_expr_stmt
name|Register_cursor
argument_list|(
name|w
argument_list|,
name|curs
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|CURSOR
modifier|*
name|curs
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|CURSOR
modifier|*
name|ocurs
decl_stmt|;
name|ocurs
operator|=
name|w
operator|->
name|cursor
expr_stmt|;
name|curs
operator|->
name|refcnt
operator|++
expr_stmt|;
name|w
operator|->
name|cursor
operator|=
name|curs
expr_stmt|;
if|if
condition|(
name|mouse_grabber
operator|==
literal|0
condition|)
name|Check_cursor
argument_list|(
name|w
argument_list|)
expr_stmt|;
if|if
condition|(
name|ocurs
operator|&&
operator|--
name|ocurs
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeCursor
argument_list|(
name|ocurs
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Undefine the mouse cursor for a window */
end_comment

begin_expr_stmt
name|Unregister_cursor
argument_list|(
name|w
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|CURSOR
modifier|*
name|curs
decl_stmt|;
if|if
condition|(
operator|(
name|curs
operator|=
name|w
operator|->
name|cursor
operator|)
operator|==
name|NULL
operator|||
name|w
operator|==
name|rootwindow
condition|)
return|return;
name|w
operator|->
name|cursor
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|mouse_grabber
operator|==
literal|0
condition|)
name|Check_cursor
argument_list|(
name|w
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|curs
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeCursor
argument_list|(
name|curs
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Start up the mouse. */
end_comment

begin_macro
name|Startup_mouse
argument_list|()
end_macro

begin_block
block|{
name|vsCursor
name|mcursor
decl_stmt|;
name|cursor
operator|=
name|rootwindow
operator|->
name|cursor
expr_stmt|;
name|LoadCursor
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
name|InitMouse
argument_list|()
expr_stmt|;
name|mcursor
operator|.
name|x
operator|=
operator|(
name|mouse_x
operator|=
operator|(
name|device
operator|.
name|width
operator|>>
literal|1
operator|)
operator|)
operator|-
name|cursor
operator|->
name|xoff
expr_stmt|;
name|mcursor
operator|.
name|y
operator|=
operator|(
name|mouse_y
operator|=
operator|(
name|device
operator|.
name|height
operator|>>
literal|1
operator|)
operator|)
operator|-
name|cursor
operator|->
name|yoff
expr_stmt|;
name|SetCursorPosition
argument_list|(
operator|&
name|mcursor
argument_list|)
expr_stmt|;
name|mouse_window
operator|=
name|rootwindow
expr_stmt|;
name|mbox
operator|.
name|bottom
operator|=
literal|0
expr_stmt|;
name|Set_mbox
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* The cursor in the given window has changed.  Check if it is/was the cursor  * window, and update the cursor if it is.  */
end_comment

begin_expr_stmt
name|Check_cursor
argument_list|(
name|w
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|ww
decl_stmt|;
if|if
condition|(
operator|(
name|ww
operator|=
name|mouse_window
operator|)
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
init|;
name|ww
operator|->
name|cursor
operator|==
name|NULL
condition|;
name|ww
operator|=
name|ww
operator|->
name|parent
control|)
empty_stmt|;
if|if
condition|(
name|ww
operator|!=
name|cursor_window
operator|||
name|ww
operator|==
name|w
condition|)
block|{
name|New_cursor
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Change the cursor.  The deltas give the physical adjustment from the old  * cursor to keep the "point" from moving.  */
end_comment

begin_macro
name|New_cursor
argument_list|(
argument|deltax
argument_list|,
argument|deltay
argument_list|)
end_macro

begin_decl_stmt
name|int
name|deltax
decl_stmt|,
name|deltay
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|vsCursor
name|mcursor
decl_stmt|;
specifier|register
name|CURSOR
modifier|*
name|curs
init|=
name|cursor
decl_stmt|;
name|short
name|x
decl_stmt|,
name|y
decl_stmt|;
specifier|register
name|WINDOW
modifier|*
name|w
decl_stmt|,
modifier|*
name|ww
decl_stmt|;
name|int
name|old
init|=
literal|0
decl_stmt|;
name|mcursor
operator|=
operator|*
name|device
operator|.
name|mouse
expr_stmt|;
name|x
operator|=
name|mcursor
operator|.
name|x
operator|+
name|cursor
operator|->
name|xoff
operator|+
name|deltax
expr_stmt|;
name|y
operator|=
name|mcursor
operator|.
name|y
operator|+
name|cursor
operator|->
name|yoff
operator|+
name|deltay
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* force cursor to stay in bounds */
if|if
condition|(
name|x
operator|<
name|curs
operator|->
name|xmin
condition|)
name|x
operator|=
name|curs
operator|->
name|xmin
expr_stmt|;
elseif|else
if|if
condition|(
name|x
operator|>
name|curs
operator|->
name|xmax
condition|)
name|x
operator|=
name|curs
operator|->
name|xmax
expr_stmt|;
if|if
condition|(
name|y
operator|<
name|curs
operator|->
name|ymin
condition|)
name|y
operator|=
name|curs
operator|->
name|ymin
expr_stmt|;
elseif|else
if|if
condition|(
name|y
operator|>
name|curs
operator|->
name|ymax
condition|)
name|y
operator|=
name|curs
operator|->
name|ymax
expr_stmt|;
if|if
condition|(
name|mouse_grabber
condition|)
break|break;
name|SEARCH
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|ww
argument_list|)
expr_stmt|;
while|while
condition|(
name|w
operator|->
name|cursor
operator|==
name|NULL
condition|)
name|w
operator|=
name|w
operator|->
name|parent
expr_stmt|;
if|if
condition|(
name|old
operator|&&
name|w
operator|==
name|cursor_window
condition|)
break|break;
name|cursor_window
operator|=
name|w
expr_stmt|;
name|cursor
operator|=
name|curs
operator|=
name|w
operator|->
name|cursor
expr_stmt|;
name|old
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|x
operator|-
name|curs
operator|->
name|xoff
operator|)
operator|!=
name|mcursor
operator|.
name|x
operator|||
operator|(
name|y
operator|-
name|curs
operator|->
name|yoff
operator|)
operator|!=
name|mcursor
operator|.
name|y
condition|)
block|{
name|mcursor
operator|.
name|x
operator|=
name|x
operator|-
name|curs
operator|->
name|xoff
expr_stmt|;
name|mcursor
operator|.
name|y
operator|=
name|y
operator|-
name|curs
operator|->
name|yoff
expr_stmt|;
name|SetCursorPosition
argument_list|(
operator|&
name|mcursor
argument_list|)
expr_stmt|;
block|}
name|LoadCursor
argument_list|(
name|curs
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Deal with mouse motion or window changes */
end_comment

begin_macro
name|Deal_with_movement
argument_list|()
end_macro

begin_block
block|{
name|vsCursor
name|mcursor
decl_stmt|;
specifier|register
name|CURSOR
modifier|*
name|curs
init|=
name|cursor
decl_stmt|;
specifier|register
name|WINDOW
modifier|*
name|w
decl_stmt|,
modifier|*
name|ww
decl_stmt|,
modifier|*
name|oldw
decl_stmt|;
name|short
name|x
decl_stmt|,
name|y
decl_stmt|;
name|int
name|new
decl_stmt|;
comment|/* read current mouse coordinates */
name|mcursor
operator|=
operator|*
name|device
operator|.
name|mouse
expr_stmt|;
name|x
operator|=
name|mcursor
operator|.
name|x
operator|+
name|curs
operator|->
name|xoff
expr_stmt|;
name|y
operator|=
name|mcursor
operator|.
name|y
operator|+
name|curs
operator|->
name|yoff
expr_stmt|;
name|oldw
operator|=
name|mouse_window
expr_stmt|;
comment|/* fast check to see if we are still in box */
if|if
condition|(
name|y
operator|<
name|mbox
operator|.
name|bottom
operator|&&
name|y
operator|>=
name|mbox
operator|.
name|top
operator|&&
name|x
operator|<
name|mbox
operator|.
name|right
operator|&&
name|x
operator|>=
name|mbox
operator|.
name|left
condition|)
block|{
if|if
condition|(
name|x
operator|!=
name|mouse_x
operator|||
name|y
operator|!=
name|mouse_y
condition|)
block|{
name|mouse_x
operator|=
name|x
expr_stmt|;
name|mouse_y
operator|=
name|y
expr_stmt|;
name|Stash_event
argument_list|(
name|oldw
argument_list|,
name|motion_mask
argument_list|,
literal|0
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* may need to reset device mbox */
name|Set_mbox
argument_list|()
expr_stmt|;
return|return;
block|}
name|mbox
operator|.
name|bottom
operator|=
literal|0
expr_stmt|;
name|new
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* force cursor to stay in bounds */
if|if
condition|(
name|x
operator|<
name|curs
operator|->
name|xmin
condition|)
name|x
operator|=
name|curs
operator|->
name|xmin
expr_stmt|;
elseif|else
if|if
condition|(
name|x
operator|>
name|curs
operator|->
name|xmax
condition|)
name|x
operator|=
name|curs
operator|->
name|xmax
expr_stmt|;
if|if
condition|(
name|y
operator|<
name|curs
operator|->
name|ymin
condition|)
name|y
operator|=
name|curs
operator|->
name|ymin
expr_stmt|;
elseif|else
if|if
condition|(
name|y
operator|>
name|curs
operator|->
name|ymax
condition|)
name|y
operator|=
name|curs
operator|->
name|ymax
expr_stmt|;
name|SEARCH
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|ww
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|==
name|mouse_window
condition|)
break|break;
name|mouse_window
operator|=
name|w
expr_stmt|;
if|if
condition|(
name|mouse_grabber
condition|)
break|break;
while|while
condition|(
name|w
operator|->
name|cursor
operator|==
name|NULL
condition|)
name|w
operator|=
name|w
operator|->
name|parent
expr_stmt|;
if|if
condition|(
name|w
operator|!=
name|cursor_window
condition|)
block|{
name|cursor_window
operator|=
name|w
expr_stmt|;
name|cursor
operator|=
name|curs
operator|=
name|w
operator|->
name|cursor
expr_stmt|;
name|new
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|x
operator|-
name|curs
operator|->
name|xoff
operator|)
operator|!=
name|mcursor
operator|.
name|x
operator|||
operator|(
name|y
operator|-
name|curs
operator|->
name|yoff
operator|)
operator|!=
name|mcursor
operator|.
name|y
condition|)
block|{
name|mcursor
operator|.
name|x
operator|=
name|x
operator|-
name|curs
operator|->
name|xoff
expr_stmt|;
name|mcursor
operator|.
name|y
operator|=
name|y
operator|-
name|curs
operator|->
name|yoff
expr_stmt|;
name|SetCursorPosition
argument_list|(
operator|&
name|mcursor
argument_list|)
expr_stmt|;
block|}
if|if TRUE
condition|(
name|new
condition|)
name|LoadCursor
argument_list|(
name|curs
argument_list|)
expr_stmt|;
name|w
operator|=
name|mouse_window
expr_stmt|;
if|if
condition|(
name|w
operator|!=
name|oldw
condition|)
block|{
name|mouse_x
operator|=
name|x
expr_stmt|;
name|mouse_y
operator|=
name|y
expr_stmt|;
while|while
condition|(
name|oldw
operator|->
name|level
operator|<
name|w
operator|->
name|level
condition|)
name|w
operator|=
name|w
operator|->
name|parent
expr_stmt|;
if|if
condition|(
name|w
operator|==
name|oldw
condition|)
name|Stash_event
argument_list|(
name|oldw
argument_list|,
operator|(
name|long
operator|)
name|LeaveWindow
argument_list|,
name|IntoOrFromSubwindow
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
if|if TRUE
condition|(
name|oldw
operator|->
name|mapped
condition|)
name|Stash_event
argument_list|(
name|oldw
argument_list|,
operator|(
name|long
operator|)
name|LeaveWindow
argument_list|,
literal|0
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|oldw
operator|->
name|level
operator|>
name|w
operator|->
name|level
condition|)
block|{
name|oldw
operator|=
name|oldw
operator|->
name|parent
expr_stmt|;
if|if
condition|(
name|oldw
operator|==
name|w
condition|)
block|{
name|Stash_event
argument_list|(
name|oldw
argument_list|,
operator|(
name|long
operator|)
name|EnterWindow
argument_list|,
name|IntoOrFromSubwindow
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
comment|/* grot */
block|}
elseif|else
if|if
condition|(
operator|(
name|oldw
operator|->
name|mask
operator|&
name|LeaveWindow
operator|)
operator|&&
name|TRUE
argument_list|(
name|oldw
operator|->
name|mapped
argument_list|)
condition|)
name|Stash_event
argument_list|(
name|oldw
argument_list|,
operator|(
name|long
operator|)
name|LeaveWindow
argument_list|,
name|VirtualCrossing
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|oldw
operator|=
name|oldw
operator|->
name|parent
expr_stmt|;
name|w
operator|=
name|w
operator|->
name|parent
expr_stmt|;
if|if
condition|(
name|oldw
operator|==
name|w
condition|)
break|break;
if|if
condition|(
operator|(
name|oldw
operator|->
name|mask
operator|&
name|LeaveWindow
operator|)
operator|&&
name|TRUE
argument_list|(
name|oldw
operator|->
name|mapped
argument_list|)
condition|)
name|Stash_event
argument_list|(
name|oldw
argument_list|,
operator|(
name|long
operator|)
name|LeaveWindow
argument_list|,
name|VirtualCrossing
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|w
operator|=
name|mouse_window
expr_stmt|;
if|if
condition|(
name|oldw
operator|!=
name|w
operator|->
name|parent
condition|)
name|Stash_enters
argument_list|(
name|oldw
argument_list|,
name|w
operator|->
name|parent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Stash_event
argument_list|(
name|w
argument_list|,
operator|(
name|long
operator|)
name|EnterWindow
argument_list|,
literal|0
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|x
operator|!=
name|mouse_x
operator|||
name|y
operator|!=
name|mouse_y
condition|)
block|{
name|Stash_event
argument_list|(
name|w
argument_list|,
name|motion_mask
argument_list|,
literal|0
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mouse_x
operator|=
name|x
expr_stmt|;
name|mouse_y
operator|=
name|y
expr_stmt|;
block|}
name|done
label|:
name|Set_mbox
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Select events */
end_comment

begin_expr_stmt
name|Select_input
argument_list|(
name|w
argument_list|,
name|client
argument_list|,
name|mask
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|client
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|mask
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|long
name|omask
init|=
name|w
operator|->
name|mask
decl_stmt|;
comment|/* stop a button grab in progress if no longer interested in release */
if|if
condition|(
name|w
operator|==
name|button_window
operator|&&
operator|(
name|client
operator|!=
name|w
operator|->
name|client
operator|||
operator|!
operator|(
name|mask
operator|&
name|ButtonReleased
operator|)
operator|)
condition|)
name|button_window
operator|=
name|NULL
expr_stmt|;
name|w
operator|->
name|mask
operator|=
name|mask
expr_stmt|;
name|w
operator|->
name|client
operator|=
name|client
expr_stmt|;
comment|/* recompute motion box if movement interest changes */
if|if
condition|(
name|mouse_grabber
operator|==
literal|0
operator|&&
operator|(
operator|(
name|omask
operator|^
name|mask
operator|)
operator|&
name|motion_mask
operator|)
condition|)
name|Set_mbox
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Change the ShiftLock mode */
end_comment

begin_expr_stmt
name|Set_shiftlock
argument_list|(
name|mode
argument_list|)
specifier|register
name|int
name|mode
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|unsigned
name|mask
decl_stmt|;
if|if
condition|(
name|lock_mode
operator|!=
name|mode
condition|)
block|{
name|lock_mode
operator|=
name|mode
expr_stmt|;
name|mask
operator|=
name|state_mask
expr_stmt|;
name|state_mask
operator|&=
operator|~
name|ShiftLockMask
expr_stmt|;
name|state_mask
operator||=
name|lock_mask
expr_stmt|;
name|lock_mask
operator|=
name|mask
operator|&
name|ShiftLockMask
expr_stmt|;
block|}
name|SetLockLED
argument_list|(
operator|(
name|lock_mode
operator|&&
operator|(
name|state_mask
operator|&
name|ShiftLockMask
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Set motion box */
end_comment

begin_macro
name|Set_mbox
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|w
decl_stmt|,
modifier|*
name|sw
decl_stmt|;
specifier|register
name|RECTANGLE
modifier|*
name|r
decl_stmt|;
specifier|register
name|CURSOR
modifier|*
name|curs
decl_stmt|;
name|vsBox
name|b
decl_stmt|;
comment|/* recalculate if need be */
if|if
condition|(
name|mbox
operator|.
name|bottom
operator|<=
name|mbox
operator|.
name|top
condition|)
block|{
name|w
operator|=
name|mouse_window
expr_stmt|;
comment|/* use containing visible rectangle if any */
for|for
control|(
name|r
operator|=
name|w
operator|->
name|visible
init|;
name|r
operator|&&
operator|(
name|mouse_x
operator|<
name|r
operator|->
name|left
operator|||
name|mouse_x
operator|>=
name|r
operator|->
name|right
operator|||
name|mouse_y
operator|<
name|r
operator|->
name|top
operator|||
name|mouse_y
operator|>=
name|r
operator|->
name|bottom
operator|)
condition|;
name|r
operator|=
name|r
operator|->
name|next
control|)
empty_stmt|;
if|if
condition|(
name|r
condition|)
name|mbox
operator|=
operator|*
operator|(
name|RASTER
operator|*
operator|)
name|r
expr_stmt|;
else|else
name|mbox
operator|=
name|w
operator|->
name|vs
expr_stmt|;
if|if
condition|(
name|sw
operator|=
name|w
operator|->
name|first_child
condition|)
name|w
operator|=
name|sw
expr_stmt|;
else|else
name|sw
operator|=
name|w
operator|->
name|next_sib
expr_stmt|;
comment|/* clip with obscuring windows */
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|sw
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|w
operator|=
name|w
operator|->
name|parent
operator|)
operator|==
name|NULL
condition|)
break|break;
name|sw
operator|=
name|w
operator|->
name|next_sib
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|FALSE
argument_list|(
name|sw
operator|->
name|mapped
argument_list|)
operator|||
operator|(
name|r
operator|&&
name|sw
operator|->
name|kind
operator|!=
name|IsTransparent
operator|)
condition|)
block|{
name|sw
operator|=
name|sw
operator|->
name|next_sib
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|sw
operator|->
name|vs
operator|.
name|top
operator|<
name|mbox
operator|.
name|bottom
operator|&&
name|sw
operator|->
name|vs
operator|.
name|bottom
operator|>
name|mbox
operator|.
name|top
condition|)
block|{
if|if
condition|(
name|sw
operator|->
name|vs
operator|.
name|right
operator|>
name|mbox
operator|.
name|left
operator|&&
name|sw
operator|->
name|vs
operator|.
name|right
operator|<=
name|mouse_x
condition|)
name|mbox
operator|.
name|left
operator|=
name|sw
operator|->
name|vs
operator|.
name|right
expr_stmt|;
elseif|else
if|if
condition|(
name|sw
operator|->
name|vs
operator|.
name|left
operator|<
name|mbox
operator|.
name|right
operator|&&
name|sw
operator|->
name|vs
operator|.
name|left
operator|>=
name|mouse_x
condition|)
name|mbox
operator|.
name|right
operator|=
name|sw
operator|->
name|vs
operator|.
name|left
expr_stmt|;
block|}
if|if
condition|(
name|sw
operator|->
name|vs
operator|.
name|left
operator|<
name|mbox
operator|.
name|right
operator|&&
name|sw
operator|->
name|vs
operator|.
name|right
operator|>
name|mbox
operator|.
name|left
condition|)
block|{
if|if
condition|(
name|sw
operator|->
name|vs
operator|.
name|bottom
operator|>
name|mbox
operator|.
name|top
operator|&&
name|sw
operator|->
name|vs
operator|.
name|bottom
operator|<=
name|mouse_y
condition|)
name|mbox
operator|.
name|top
operator|=
name|sw
operator|->
name|vs
operator|.
name|bottom
expr_stmt|;
elseif|else
if|if
condition|(
name|sw
operator|->
name|vs
operator|.
name|top
operator|<
name|mbox
operator|.
name|bottom
operator|&&
name|sw
operator|->
name|vs
operator|.
name|top
operator|>=
name|mouse_y
condition|)
name|mbox
operator|.
name|bottom
operator|=
name|sw
operator|->
name|vs
operator|.
name|top
expr_stmt|;
block|}
name|sw
operator|=
name|sw
operator|->
name|next_sib
expr_stmt|;
block|}
block|}
comment|/* if anyone wants motion events, we lose */
if|if
condition|(
operator|(
name|mouse_grabber
operator|&&
operator|(
name|mouse_grab_mask
operator|&
name|motion_mask
operator|)
operator|)
operator|||
operator|(
name|button_window
operator|&&
operator|(
name|button_window
operator|->
name|mask
operator|&
name|motion_mask
operator|)
operator|)
condition|)
block|{
name|device
operator|.
name|mbox
operator|->
name|bottom
operator|=
literal|0
expr_stmt|;
return|return;
block|}
for|for
control|(
name|w
operator|=
name|mouse_window
init|;
name|w
condition|;
name|w
operator|=
name|w
operator|->
name|parent
control|)
block|{
if|if
condition|(
name|w
operator|->
name|mask
operator|&
name|motion_mask
condition|)
block|{
name|device
operator|.
name|mbox
operator|->
name|bottom
operator|=
literal|0
expr_stmt|;
return|return;
block|}
block|}
name|curs
operator|=
name|cursor
expr_stmt|;
name|b
operator|.
name|left
operator|=
name|mbox
operator|.
name|left
operator|-
name|curs
operator|->
name|xoff
expr_stmt|;
name|b
operator|.
name|right
operator|=
name|mbox
operator|.
name|right
operator|-
name|curs
operator|->
name|xoff
expr_stmt|;
name|b
operator|.
name|top
operator|=
name|mbox
operator|.
name|top
operator|-
name|curs
operator|->
name|yoff
expr_stmt|;
name|b
operator|.
name|bottom
operator|=
name|mbox
operator|.
name|bottom
operator|-
name|curs
operator|->
name|yoff
expr_stmt|;
operator|*
name|device
operator|.
name|mbox
operator|=
name|b
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Deal with a button/key transition */
end_comment

begin_expr_stmt
name|Deal_with_input
argument_list|(
name|ev
argument_list|)
specifier|register
name|vsEvent
operator|*
name|ev
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|w
decl_stmt|,
modifier|*
name|ww
decl_stmt|;
name|short
name|x
init|=
name|ev
operator|->
name|vse_x
operator|+
name|cursor
operator|->
name|xoff
decl_stmt|;
name|short
name|y
init|=
name|ev
operator|->
name|vse_y
operator|+
name|cursor
operator|->
name|yoff
decl_stmt|;
name|w
operator|=
name|mouse_window
expr_stmt|;
comment|/* lightning usually strikes twice */
if|if
condition|(
name|y
operator|>=
name|mbox
operator|.
name|bottom
operator|||
name|y
operator|<
name|mbox
operator|.
name|top
operator|||
name|x
operator|>=
name|mbox
operator|.
name|right
operator|||
name|x
operator|<
name|mbox
operator|.
name|left
condition|)
block|{
comment|/* but not this time */
name|SEARCH
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|ww
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ev
operator|->
name|vse_device
operator|==
name|VSE_DKB
condition|)
block|{
if|if
condition|(
name|ev
operator|->
name|vse_direction
operator|==
name|VSE_KBTUP
condition|)
block|{
name|Stash_event
argument_list|(
name|w
argument_list|,
operator|(
name|long
operator|)
name|KeyReleased
argument_list|,
name|ev
operator|->
name|vse_key
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|ev
operator|->
name|vse_time
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ev
operator|->
name|vse_key
condition|)
block|{
case|case
name|ShiftKeyCode
case|:
name|state_mask
operator|&=
operator|~
name|ShiftMask
expr_stmt|;
break|break;
case|case
name|ControlKeyCode
case|:
name|state_mask
operator|&=
operator|~
name|ControlMask
expr_stmt|;
break|break;
case|case
name|LockKeyCode
case|:
if|if TRUE
condition|(
name|lock_mode
condition|)
name|lock_mask
operator|=
literal|0
expr_stmt|;
else|else
name|state_mask
operator|&=
operator|~
name|ShiftLockMask
expr_stmt|;
break|break;
case|case
name|MetaKeyCode
case|:
name|state_mask
operator|&=
operator|~
name|MetaMask
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|Stash_event
argument_list|(
name|w
argument_list|,
operator|(
name|long
operator|)
name|KeyPressed
argument_list|,
name|ev
operator|->
name|vse_key
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|ev
operator|->
name|vse_time
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ev
operator|->
name|vse_key
condition|)
block|{
case|case
name|ShiftKeyCode
case|:
name|state_mask
operator||=
name|ShiftMask
expr_stmt|;
break|break;
case|case
name|ControlKeyCode
case|:
name|state_mask
operator||=
name|ControlMask
expr_stmt|;
break|break;
case|case
name|LockKeyCode
case|:
if|if TRUE
condition|(
name|lock_mode
condition|)
block|{
name|state_mask
operator|^=
name|ShiftLockMask
expr_stmt|;
name|lock_mask
operator|=
name|ShiftLockMask
expr_stmt|;
name|SetLockLED
argument_list|(
name|state_mask
operator|&
name|ShiftLockMask
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|state_mask
operator||=
name|ShiftLockMask
expr_stmt|;
name|lock_mask
operator|^=
name|ShiftLockMask
expr_stmt|;
block|}
break|break;
case|case
name|MetaKeyCode
case|:
name|state_mask
operator||=
name|MetaMask
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|ev
operator|->
name|vse_direction
operator|==
name|VSE_KBTUP
condition|)
block|{
name|Stash_event
argument_list|(
name|w
argument_list|,
operator|(
name|long
operator|)
name|ButtonReleased
argument_list|,
literal|2
operator|-
name|ev
operator|->
name|vse_key
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|ev
operator|->
name|vse_time
argument_list|)
expr_stmt|;
name|motion_mask
operator|&=
operator|~
operator|(
name|LeftDownMotion
operator|>>
name|ev
operator|->
name|vse_key
operator|)
expr_stmt|;
name|state_mask
operator|&=
operator|~
operator|(
name|LeftMask
operator|>>
name|ev
operator|->
name|vse_key
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|state_mask
operator|&
operator|(
name|LeftMask
operator||
name|MiddleMask
operator||
name|RightMask
operator|)
operator|)
condition|)
block|{
comment|/* check for end of grab */
if|if
condition|(
name|button_window
operator|||
operator|(
name|mouse_grabber
operator|&&
name|mouse_grab_button
operator|)
condition|)
name|Stash_ungrabs
argument_list|()
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|button_window
operator|==
name|NULL
operator|&&
name|mouse_grabber
operator|==
literal|0
condition|)
block|{
comment|/* check for start of grab */
if|if
condition|(
name|bgrabs
index|[
name|GRABIDX
argument_list|(
name|ev
operator|->
name|vse_key
argument_list|,
name|state_mask
argument_list|)
index|]
operator|.
name|client
condition|)
name|Button_grab
argument_list|(
name|ev
operator|->
name|vse_key
argument_list|,
name|state_mask
argument_list|)
expr_stmt|;
else|else
block|{
name|ww
operator|=
name|w
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|ww
operator|->
name|mask
operator|&
name|ButtonPressed
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|ww
operator|=
name|ww
operator|->
name|parent
operator|)
operator|==
name|NULL
condition|)
break|break;
block|}
if|if
condition|(
name|ww
operator|&&
operator|(
name|ww
operator|->
name|mask
operator|&
name|ButtonReleased
operator|)
condition|)
block|{
name|Stash_grabs
argument_list|(
name|ww
operator|->
name|client
argument_list|)
expr_stmt|;
name|button_window
operator|=
name|ww
expr_stmt|;
block|}
block|}
block|}
name|Stash_event
argument_list|(
name|w
argument_list|,
operator|(
name|long
operator|)
name|ButtonPressed
argument_list|,
literal|2
operator|-
name|ev
operator|->
name|vse_key
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|ev
operator|->
name|vse_time
argument_list|)
expr_stmt|;
name|motion_mask
operator||=
operator|(
name|LeftDownMotion
operator|>>
name|ev
operator|->
name|vse_key
operator|)
expr_stmt|;
name|state_mask
operator||=
operator|(
name|LeftMask
operator|>>
name|ev
operator|->
name|vse_key
operator|)
expr_stmt|;
block|}
name|Deal_with_movement
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Give the client sole possession of the mouse */
end_comment

begin_expr_stmt
name|Grab_mouse
argument_list|(
name|w
argument_list|,
name|curs
argument_list|,
name|mask
argument_list|,
name|client
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|CURSOR
modifier|*
name|curs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|mask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|client
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|CURSOR
modifier|*
name|ocurs
decl_stmt|;
name|int
name|deltax
decl_stmt|,
name|deltay
decl_stmt|;
if|if
condition|(
operator|(
name|button_window
operator|&&
name|button_window
operator|->
name|client
operator|!=
name|client
operator|)
operator|||
operator|(
name|mouse_grabber
operator|&&
name|mouse_grabber
operator|!=
name|client
operator|)
condition|)
block|{
name|Xstatus
operator|=
name|BadGrab
expr_stmt|;
return|return;
block|}
name|ocurs
operator|=
name|cursor
expr_stmt|;
name|deltax
operator|=
name|ocurs
operator|->
name|xoff
operator|-
name|curs
operator|->
name|xoff
expr_stmt|;
name|deltay
operator|=
name|ocurs
operator|->
name|yoff
operator|-
name|curs
operator|->
name|yoff
expr_stmt|;
name|button_window
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|mouse_grabber
operator|==
literal|0
condition|)
block|{
name|Stash_grabs
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|mouse_grabber
operator|=
name|client
expr_stmt|;
name|ocurs
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mouse_grab_button
condition|)
name|ocurs
operator|=
name|NULL
expr_stmt|;
name|mouse_grab_window
operator|=
name|w
expr_stmt|;
name|mouse_grab_mask
operator|=
name|mask
expr_stmt|;
name|mouse_grab_button
operator|=
literal|0
expr_stmt|;
name|curs
operator|->
name|refcnt
operator|++
expr_stmt|;
name|cursor
operator|=
name|curs
expr_stmt|;
name|New_cursor
argument_list|(
name|deltax
argument_list|,
name|deltay
argument_list|)
expr_stmt|;
name|cursor_window
operator|=
name|NULL
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
if|if
condition|(
name|ocurs
operator|&&
operator|--
name|ocurs
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeCursor
argument_list|(
name|ocurs
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Ungrab the mouse */
end_comment

begin_macro
name|Ungrab_mouse
argument_list|(
argument|client
argument_list|)
end_macro

begin_decl_stmt
name|int
name|client
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|client
operator|==
name|mouse_grabber
operator|&&
name|mouse_grab_button
operator|==
literal|0
condition|)
block|{
name|Stash_ungrabs
argument_list|()
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Indicates that a client wants sole possession of the mouse when the  * specified button is down.  */
end_comment

begin_expr_stmt
name|Grab_button
argument_list|(
name|w
argument_list|,
name|curs
argument_list|,
name|button
argument_list|,
name|mask
argument_list|,
name|client
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|CURSOR
modifier|*
name|curs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|button
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|mask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|client
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|GRAB_INFO
modifier|*
name|grab
decl_stmt|;
specifier|register
name|CURSOR
modifier|*
name|ocurs
decl_stmt|;
name|i
operator|=
name|ButtonState
argument_list|(
name|button
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
operator|||
operator|(
name|i
operator|&
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|Xstatus
operator|=
name|BadValue
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|4
condition|)
name|i
operator|=
literal|3
expr_stmt|;
name|grab
operator|=
operator|&
name|bgrabs
index|[
name|GRABIDX
argument_list|(
literal|3
operator|-
name|i
argument_list|,
name|button
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|grab
operator|->
name|client
operator|&&
name|grab
operator|->
name|client
operator|!=
name|client
condition|)
block|{
name|Xstatus
operator|=
name|BadGrab
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|grab
operator|->
name|client
condition|)
block|{
name|ocurs
operator|=
name|grab
operator|->
name|cursor
expr_stmt|;
name|grab
operator|->
name|window
operator|->
name|bgrabs
operator|--
expr_stmt|;
block|}
else|else
name|ocurs
operator|=
name|NULL
expr_stmt|;
name|grab
operator|->
name|client
operator|=
name|client
expr_stmt|;
name|grab
operator|->
name|window
operator|=
name|w
expr_stmt|;
name|grab
operator|->
name|mask
operator|=
name|mask
expr_stmt|;
name|grab
operator|->
name|cursor
operator|=
name|curs
expr_stmt|;
name|curs
operator|->
name|refcnt
operator|++
expr_stmt|;
name|w
operator|->
name|bgrabs
operator|++
expr_stmt|;
comment|/* check if this is an in-progress update */
if|if
condition|(
name|mouse_grabber
operator|&&
name|mouse_grab_button
operator|==
operator|(
name|button
operator|&
name|grabbits
operator|)
condition|)
block|{
name|Button_grab
argument_list|(
operator|(
name|unsigned
operator|)
literal|3
operator|-
name|i
argument_list|,
name|button
argument_list|)
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|ocurs
operator|&&
operator|--
name|ocurs
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeCursor
argument_list|(
name|ocurs
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Ungrab a button */
end_comment

begin_macro
name|Ungrab_button
argument_list|(
argument|button
argument_list|,
argument|client
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|button
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|client
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|GRAB_INFO
modifier|*
name|grab
decl_stmt|;
name|i
operator|=
name|ButtonState
argument_list|(
name|button
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
operator|||
operator|(
name|i
operator|&
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|Xstatus
operator|=
name|BadValue
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|4
condition|)
name|i
operator|=
literal|3
expr_stmt|;
name|grab
operator|=
operator|&
name|bgrabs
index|[
name|GRABIDX
argument_list|(
literal|3
operator|-
name|i
argument_list|,
name|button
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|grab
operator|->
name|client
operator|!=
name|client
condition|)
return|return;
name|grab
operator|->
name|client
operator|=
literal|0
expr_stmt|;
name|grab
operator|->
name|window
operator|->
name|bgrabs
operator|--
expr_stmt|;
comment|/* check if aborting */
if|if
condition|(
name|client
operator|==
name|mouse_grabber
operator|&&
name|mouse_grab_button
operator|==
operator|(
name|button
operator|&
name|grabbits
operator|)
condition|)
name|Stash_ungrabs
argument_list|()
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
if|if
condition|(
operator|--
name|grab
operator|->
name|cursor
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeCursor
argument_list|(
name|grab
operator|->
name|cursor
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Start a button grab */
end_comment

begin_expr_stmt
name|Button_grab
argument_list|(
name|key
argument_list|,
name|mask
argument_list|)
specifier|register
name|unsigned
name|key
operator|,
name|mask
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|GRAB_INFO
modifier|*
name|grab
decl_stmt|;
name|int
name|deltax
decl_stmt|,
name|deltay
decl_stmt|;
name|grab
operator|=
operator|&
name|bgrabs
index|[
name|GRABIDX
argument_list|(
name|key
argument_list|,
name|mask
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|mouse_grabber
operator|==
literal|0
condition|)
block|{
name|Stash_grabs
argument_list|(
name|grab
operator|->
name|client
argument_list|)
expr_stmt|;
name|mouse_grabber
operator|=
name|grab
operator|->
name|client
expr_stmt|;
block|}
name|mouse_grab_window
operator|=
name|grab
operator|->
name|window
expr_stmt|;
name|mouse_grab_mask
operator|=
name|grab
operator|->
name|mask
expr_stmt|;
name|mouse_grab_button
operator|=
operator|(
name|mask
operator|&
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator||
name|ShiftLockMask
operator|)
operator|)
operator||
operator|(
name|LeftMask
operator|>>
name|key
operator|)
expr_stmt|;
name|deltax
operator|=
name|cursor
operator|->
name|xoff
operator|-
name|grab
operator|->
name|cursor
operator|->
name|xoff
expr_stmt|;
name|deltay
operator|=
name|cursor
operator|->
name|yoff
operator|-
name|grab
operator|->
name|cursor
operator|->
name|yoff
expr_stmt|;
name|cursor
operator|=
name|grab
operator|->
name|cursor
expr_stmt|;
name|New_cursor
argument_list|(
name|deltax
argument_list|,
name|deltay
argument_list|)
expr_stmt|;
name|cursor_window
operator|=
name|NULL
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Conditionally warp mouse to new position */
end_comment

begin_macro
name|Warp_mouse
argument_list|(
argument|dstw
argument_list|,
argument|dstx
argument_list|,
argument|dsty
argument_list|,
argument|srcw
argument_list|,
argument|src
argument_list|)
end_macro

begin_decl_stmt
name|WINDOW
modifier|*
name|dstw
decl_stmt|,
modifier|*
name|srcw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dstx
decl_stmt|,
name|dsty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|REGION
modifier|*
name|src
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|;
specifier|register
name|int
name|cx
decl_stmt|,
name|cy
decl_stmt|;
specifier|register
name|RECTANGLE
modifier|*
name|v
decl_stmt|;
specifier|register
name|WINDOW
modifier|*
name|w
decl_stmt|;
name|vsCursor
name|mcursor
decl_stmt|;
name|w
operator|=
name|srcw
expr_stmt|;
if|if FALSE
condition|(
name|w
operator|->
name|mapped
condition|)
return|return;
comment|/* get absolute coordinates */
name|x
operator|=
name|w
operator|->
name|full
operator|.
name|left
operator|+
name|src
operator|->
name|left
expr_stmt|;
name|y
operator|=
name|w
operator|->
name|full
operator|.
name|top
operator|+
name|src
operator|->
name|top
expr_stmt|;
if|if
condition|(
operator|(
name|width
operator|=
name|src
operator|->
name|width
operator|)
operator|==
literal|0
condition|)
name|width
operator|=
name|w
operator|->
name|full
operator|.
name|right
operator|-
name|x
expr_stmt|;
if|if
condition|(
operator|(
name|height
operator|=
name|src
operator|->
name|height
operator|)
operator|==
literal|0
condition|)
name|height
operator|=
name|w
operator|->
name|full
operator|.
name|bottom
operator|-
name|y
expr_stmt|;
name|mcursor
operator|=
operator|*
name|device
operator|.
name|mouse
expr_stmt|;
name|cx
operator|=
name|mcursor
operator|.
name|x
operator|+
name|cursor
operator|->
name|xoff
expr_stmt|;
name|cy
operator|=
name|mcursor
operator|.
name|y
operator|+
name|cursor
operator|->
name|yoff
expr_stmt|;
if|if
condition|(
name|cx
operator|<
name|x
operator|||
name|cy
operator|<
name|y
operator|||
name|cx
operator|>=
name|x
operator|+
name|width
operator|||
name|cy
operator|>=
name|y
operator|+
name|height
condition|)
return|return;
for|for
control|(
name|v
operator|=
name|w
operator|->
name|cmvisible
init|;
name|v
condition|;
name|v
operator|=
name|v
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cx
operator|<
name|v
operator|->
name|left
operator|||
name|cy
operator|<
name|v
operator|->
name|top
operator|||
name|cx
operator|>=
name|v
operator|->
name|right
operator|||
name|cy
operator|>=
name|v
operator|->
name|bottom
condition|)
continue|continue;
name|cx
operator|=
name|dstx
expr_stmt|;
name|cy
operator|=
name|dsty
expr_stmt|;
name|w
operator|=
name|dstw
expr_stmt|;
comment|/* get absolute coordinates */
while|while
condition|(
literal|1
condition|)
block|{
name|cx
operator|+=
name|w
operator|->
name|full
operator|.
name|left
expr_stmt|;
name|cy
operator|+=
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
if|if TRUE
condition|(
name|w
operator|->
name|mapped
condition|)
break|break;
name|w
operator|=
name|w
operator|->
name|parent
expr_stmt|;
block|}
name|mcursor
operator|=
operator|*
name|device
operator|.
name|mouse
expr_stmt|;
name|New_cursor
argument_list|(
name|cx
operator|-
name|cursor
operator|->
name|xoff
operator|-
name|mcursor
operator|.
name|x
argument_list|,
name|cy
operator|-
name|cursor
operator|->
name|yoff
operator|-
name|mcursor
operator|.
name|y
argument_list|)
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Change keyboard focus */
end_comment

begin_expr_stmt
name|Focus_keyboard
argument_list|(
name|w
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|key_window
operator|!=
name|w
condition|)
block|{
if|if
condition|(
name|key_window
condition|)
name|Stash_simple
argument_list|(
name|key_window
argument_list|,
operator|(
name|long
operator|)
name|FocusChange
argument_list|,
name|LeaveWindow
argument_list|)
expr_stmt|;
name|key_window
operator|=
name|w
expr_stmt|;
name|key_level
operator|=
name|w
operator|->
name|level
expr_stmt|;
name|Stash_simple
argument_list|(
name|w
argument_list|,
operator|(
name|long
operator|)
name|FocusChange
argument_list|,
name|EnterWindow
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Remove grabs that use this window */
end_comment

begin_expr_stmt
name|Unbutton_window
argument_list|(
name|w
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|GRAB_INFO
modifier|*
name|grab
decl_stmt|;
for|for
control|(
name|grab
operator|=
operator|&
name|bgrabs
index|[
literal|0
index|]
init|;
condition|;
name|grab
operator|++
control|)
block|{
if|if
condition|(
name|w
operator|==
name|grab
operator|->
name|window
operator|&&
name|grab
operator|->
name|client
condition|)
block|{
name|grab
operator|->
name|client
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|--
name|grab
operator|->
name|cursor
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeCursor
argument_list|(
name|grab
operator|->
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|w
operator|->
name|bgrabs
operator|==
literal|0
condition|)
return|return;
block|}
block|}
block|}
end_block

begin_comment
comment|/* Remove grabs by this client */
end_comment

begin_macro
name|Ungrab_client
argument_list|(
argument|client
argument_list|)
end_macro

begin_decl_stmt
name|int
name|client
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|GRAB_INFO
modifier|*
name|grab
decl_stmt|;
if|if
condition|(
name|client
operator|==
name|mouse_grabber
operator|||
operator|(
name|button_window
operator|&&
name|client
operator|==
name|button_window
operator|->
name|client
operator|)
condition|)
name|Stash_ungrabs
argument_list|()
expr_stmt|;
for|for
control|(
name|grab
operator|=
operator|&
name|bgrabs
index|[
literal|0
index|]
init|;
name|grab
operator|!=
operator|&
name|bgrabs
index|[
name|GRABS
index|]
condition|;
name|grab
operator|++
control|)
block|{
if|if
condition|(
name|client
operator|==
name|grab
operator|->
name|client
condition|)
block|{
name|grab
operator|->
name|client
operator|=
literal|0
expr_stmt|;
name|grab
operator|->
name|window
operator|->
name|bgrabs
operator|--
expr_stmt|;
if|if
condition|(
operator|--
name|grab
operator|->
name|cursor
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeCursor
argument_list|(
name|grab
operator|->
name|cursor
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_comment
comment|/* Generate leave events at mouse grab */
end_comment

begin_expr_stmt
name|Stash_grabs
argument_list|(
name|client
argument_list|)
specifier|register
name|int
name|client
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|w
decl_stmt|;
name|w
operator|=
name|mouse_window
expr_stmt|;
if|if
condition|(
name|w
operator|==
name|rootwindow
condition|)
return|return;
if|if
condition|(
name|w
operator|->
name|client
operator|!=
name|client
condition|)
block|{
while|while
condition|(
operator|!
operator|(
name|w
operator|->
name|mask
operator|&
name|LeaveWindow
operator|)
operator|&&
operator|(
name|w
operator|=
name|w
operator|->
name|parent
operator|)
operator|&&
name|w
operator|->
name|client
operator|!=
name|client
condition|)
empty_stmt|;
if|if
condition|(
name|w
operator|&&
name|w
operator|->
name|client
operator|!=
name|client
condition|)
name|Stash_event
argument_list|(
name|mouse_window
argument_list|,
operator|(
name|long
operator|)
name|LeaveWindow
argument_list|,
literal|0
argument_list|,
name|mouse_x
argument_list|,
name|mouse_y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|w
operator|=
name|mouse_window
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|w
operator|=
name|w
operator|->
name|parent
operator|)
operator|!=
name|rootwindow
condition|)
block|{
if|if
condition|(
name|w
operator|->
name|client
operator|!=
name|client
operator|&&
operator|(
name|w
operator|->
name|mask
operator|&
name|LeaveWindow
operator|)
condition|)
name|Stash_event
argument_list|(
name|w
argument_list|,
operator|(
name|long
operator|)
name|LeaveWindow
argument_list|,
name|VirtualCrossing
argument_list|,
name|mouse_x
argument_list|,
name|mouse_y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Restore cursor and generate enter events at mouse ungrab */
end_comment

begin_macro
name|Stash_ungrabs
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|w
decl_stmt|;
specifier|register
name|int
name|client
decl_stmt|;
name|CURSOR
modifier|*
name|curs
decl_stmt|;
if|if
condition|(
name|button_window
condition|)
block|{
name|client
operator|=
name|button_window
operator|->
name|client
expr_stmt|;
name|button_window
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|client
operator|=
name|mouse_grabber
expr_stmt|;
name|mouse_grabber
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mouse_grab_button
condition|)
name|New_cursor
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|curs
operator|=
name|cursor
expr_stmt|;
name|New_cursor
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|curs
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeCursor
argument_list|(
name|curs
argument_list|)
expr_stmt|;
block|}
block|}
name|w
operator|=
name|mouse_window
expr_stmt|;
while|while
condition|(
name|w
operator|!=
name|rootwindow
operator|&&
operator|(
name|w
operator|->
name|client
operator|==
name|client
operator|||
operator|!
operator|(
name|w
operator|->
name|mask
operator|&
name|EnterWindow
operator|)
operator|)
condition|)
name|w
operator|=
name|w
operator|->
name|parent
expr_stmt|;
if|if
condition|(
name|w
operator|!=
name|rootwindow
condition|)
block|{
name|w
operator|=
name|mouse_window
expr_stmt|;
if|if
condition|(
name|rootwindow
operator|!=
name|w
operator|->
name|parent
condition|)
name|Stash_enters
argument_list|(
name|rootwindow
argument_list|,
name|w
operator|->
name|parent
argument_list|,
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|client
operator|!=
name|client
condition|)
block|{
while|while
condition|(
operator|!
operator|(
name|w
operator|->
name|mask
operator|&
name|EnterWindow
operator|)
operator|&&
operator|(
name|w
operator|=
name|w
operator|->
name|parent
operator|)
operator|&&
name|w
operator|->
name|client
operator|!=
name|client
condition|)
empty_stmt|;
if|if
condition|(
name|w
operator|&&
name|w
operator|->
name|client
operator|!=
name|client
condition|)
name|Stash_event
argument_list|(
name|mouse_window
argument_list|,
operator|(
name|long
operator|)
name|EnterWindow
argument_list|,
literal|0
argument_list|,
name|mouse_x
argument_list|,
name|mouse_y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_comment
comment|/* Stash enter events in windows */
end_comment

begin_macro
name|Stash_enters
argument_list|(
argument|p
argument_list|,
argument|c
argument_list|,
argument|client
argument_list|)
end_macro

begin_decl_stmt
name|WINDOW
modifier|*
name|p
decl_stmt|,
modifier|*
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|client
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|p
operator|!=
name|c
operator|->
name|parent
condition|)
name|Stash_enters
argument_list|(
name|p
argument_list|,
name|c
operator|->
name|parent
argument_list|,
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|client
operator|!=
name|client
operator|&&
operator|(
name|c
operator|->
name|mask
operator|&
name|EnterWindow
operator|)
condition|)
name|Stash_event
argument_list|(
name|c
argument_list|,
operator|(
name|long
operator|)
name|EnterWindow
argument_list|,
name|VirtualCrossing
argument_list|,
name|mouse_x
argument_list|,
name|mouse_y
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Place an event in the event queue of a window */
end_comment

begin_expr_stmt
name|Stash_event
argument_list|(
name|w
argument_list|,
name|event
argument_list|,
name|detail
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|time
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|long
name|event
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|detail
decl_stmt|,
name|time
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|sub
init|=
name|NULL
decl_stmt|;
name|WINDOW
modifier|*
name|ww
decl_stmt|;
name|XRep
name|rep
decl_stmt|;
name|int
name|client
decl_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
specifier|register
name|swaptype
name|n
decl_stmt|;
endif|#
directive|endif
comment|/* Find someone who is interested in dealing with this event 	 * and set w to the window lowest in the hierarchy at or 	 * above the original event window that is interested. 	 */
if|if
condition|(
name|event
operator|&
operator|(
name|KeyPressed
operator||
name|KeyReleased
operator|)
condition|)
block|{
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|w
operator|->
name|mask
operator|&
name|event
operator|)
condition|)
block|{
name|sub
operator|=
name|w
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|level
operator|>
name|key_level
condition|)
block|{
name|w
operator|=
name|w
operator|->
name|parent
expr_stmt|;
continue|continue;
block|}
block|}
elseif|else
if|if
condition|(
name|key_level
operator|==
literal|0
condition|)
block|{
break|break;
block|}
else|else
block|{
name|ww
operator|=
name|w
expr_stmt|;
while|while
condition|(
name|ww
operator|->
name|level
operator|>
name|key_level
condition|)
name|ww
operator|=
name|ww
operator|->
name|parent
expr_stmt|;
if|if
condition|(
name|ww
operator|==
name|key_window
condition|)
break|break;
block|}
name|w
operator|=
name|key_window
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|w
operator|->
name|mask
operator|&
name|event
operator|)
condition|)
return|return;
name|sub
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
name|client
operator|=
name|w
operator|->
name|client
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|button_window
condition|)
block|{
while|while
condition|(
name|w
operator|&&
operator|!
operator|(
name|w
operator|->
name|mask
operator|&
name|event
operator|)
condition|)
block|{
name|sub
operator|=
name|w
expr_stmt|;
name|w
operator|=
name|w
operator|->
name|parent
expr_stmt|;
block|}
name|client
operator|=
name|button_window
operator|->
name|client
expr_stmt|;
if|if
condition|(
name|w
operator|==
name|NULL
operator|||
name|w
operator|->
name|client
operator|!=
name|client
condition|)
block|{
name|sub
operator|=
name|w
expr_stmt|;
name|w
operator|=
name|button_window
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|(
name|w
operator|->
name|mask
operator|&
name|event
operator|)
operator|&
operator|~
operator|(
name|EnterWindow
operator||
name|LeaveWindow
operator|)
operator|)
condition|)
return|return;
while|while
condition|(
name|sub
operator|&&
name|sub
operator|->
name|parent
operator|!=
name|w
condition|)
name|sub
operator|=
name|sub
operator|->
name|parent
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|mouse_grabber
condition|)
block|{
while|while
condition|(
name|w
operator|&&
operator|!
operator|(
name|event
operator|&
operator|(
operator|(
name|w
operator|==
name|mouse_grab_window
operator|)
condition|?
name|mouse_grab_mask
else|:
name|w
operator|->
name|mask
operator|)
operator|)
condition|)
block|{
name|sub
operator|=
name|w
expr_stmt|;
name|w
operator|=
name|w
operator|->
name|parent
expr_stmt|;
block|}
name|client
operator|=
name|mouse_grabber
expr_stmt|;
if|if
condition|(
name|w
operator|==
name|NULL
operator|||
operator|(
name|w
operator|!=
name|mouse_grab_window
operator|&&
name|w
operator|->
name|client
operator|!=
name|client
operator|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|mouse_grab_mask
operator|&
name|event
operator|)
operator|&
operator|~
operator|(
name|EnterWindow
operator||
name|LeaveWindow
operator|)
operator|)
condition|)
return|return;
name|sub
operator|=
name|w
expr_stmt|;
name|w
operator|=
name|mouse_grab_window
expr_stmt|;
while|while
condition|(
name|sub
operator|&&
name|sub
operator|->
name|parent
operator|!=
name|w
condition|)
name|sub
operator|=
name|sub
operator|->
name|parent
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
operator|!
operator|(
name|w
operator|->
name|mask
operator|&
name|event
operator|)
condition|)
block|{
name|sub
operator|=
name|w
expr_stmt|;
if|if
condition|(
operator|(
name|w
operator|=
name|w
operator|->
name|parent
operator|)
operator|==
name|NULL
condition|)
return|return;
block|}
name|client
operator|=
name|w
operator|->
name|client
expr_stmt|;
block|}
name|rep
operator|.
name|code
operator|=
name|event
operator|&
operator|~
operator|(
name|LeftDownMotion
operator||
name|MiddleDownMotion
operator||
name|RightDownMotion
operator|)
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|0
index|]
operator|=
name|w
operator|->
name|rid
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|2
index|]
operator|=
name|time
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|3
index|]
operator|=
name|state_mask
operator||
name|detail
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|4
index|]
operator|=
name|x
operator|-
name|w
operator|->
name|full
operator|.
name|left
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|5
index|]
operator|=
name|y
operator|-
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|3
index|]
operator|=
operator|(
name|sub
condition|?
name|sub
operator|->
name|rid
else|:
literal|0
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|vax
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|8
index|]
operator|=
name|y
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|9
index|]
operator|=
name|x
expr_stmt|;
else|#
directive|else
ifdef|#
directive|ifdef
name|mc68000
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|9
index|]
operator|=
name|y
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|8
index|]
operator|=
name|x
expr_stmt|;
else|#
directive|else
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|4
index|]
operator|=
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
name|swapped
index|[
name|client
index|]
condition|)
block|{
name|swapl
argument_list|(
operator|&
name|rep
operator|.
name|code
argument_list|)
expr_stmt|;
name|pswapl
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|pswapl
argument_list|(
operator|&
name|rep
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|pswapl
argument_list|(
operator|&
name|rep
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|Write
argument_list|(
name|client
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|rep
argument_list|,
sizeof|sizeof
argument_list|(
name|XRep
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Place window changes in the event queue of a window.  * If not_just_new, generate an ExposeWindow, else update visible list and  * generate ExposeRegions (or ExposeWindow).  */
end_comment

begin_expr_stmt
name|Stash_changes
argument_list|(
name|w
argument_list|,
name|not_just_new
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|not_just_new
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|ew
init|=
name|w
decl_stmt|;
specifier|register
name|RECTANGLE
modifier|*
name|r
decl_stmt|,
modifier|*
modifier|*
name|prev
decl_stmt|;
name|RECTANGLE
modifier|*
name|changed
init|=
name|NULL
decl_stmt|;
name|XRep
name|rep
decl_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
specifier|register
name|swaptype
name|n
decl_stmt|;
endif|#
directive|endif
while|while
condition|(
operator|!
operator|(
name|ew
operator|->
name|mask
operator|&
operator|(
name|ExposeWindow
operator||
name|ExposeRegion
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|ew
operator|=
name|ew
operator|->
name|parent
condition|)
continue|continue;
if|if TRUE
condition|(
name|not_just_new
condition|)
return|return;
comment|/* nobody interested, just update */
name|prev
operator|=
operator|&
name|w
operator|->
name|visible
expr_stmt|;
while|while
condition|(
name|r
operator|=
operator|*
name|prev
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|type
operator|==
name|new_rec
condition|)
block|{
name|r
operator|->
name|type
operator|=
name|contents_rec
expr_stmt|;
operator|*
name|prev
operator|=
name|r
operator|->
name|next
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|changed
expr_stmt|;
name|changed
operator|=
name|r
expr_stmt|;
block|}
else|else
name|prev
operator|=
operator|&
name|r
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|changed
condition|)
block|{
name|Merge_rectangles
argument_list|(
name|changed
argument_list|,
operator|&
name|w
operator|->
name|visible
argument_list|)
expr_stmt|;
name|Windex
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|0
index|]
operator|=
name|ew
operator|->
name|rid
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|3
index|]
operator|=
operator|(
name|w
operator|==
name|ew
operator|)
condition|?
literal|0
else|:
name|w
operator|->
name|rid
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
name|swapped
index|[
name|ew
operator|->
name|client
index|]
condition|)
block|{
name|rep
operator|.
name|code
operator|=
name|lswapl
argument_list|(
name|ExposeRegion
argument_list|)
expr_stmt|;
name|pswapl
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pswapl
argument_list|(
operator|&
name|rep
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|rep
operator|.
name|code
operator|=
name|ExposeRegion
expr_stmt|;
if|if FALSE
condition|(
name|not_just_new
condition|)
block|{
name|prev
operator|=
operator|&
name|w
operator|->
name|visible
expr_stmt|;
while|while
condition|(
name|r
operator|=
operator|*
name|prev
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|type
operator|==
name|new_rec
condition|)
block|{
name|r
operator|->
name|type
operator|=
name|contents_rec
expr_stmt|;
operator|*
name|prev
operator|=
name|r
operator|->
name|next
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|changed
expr_stmt|;
name|changed
operator|=
name|r
expr_stmt|;
if|if
condition|(
name|ew
operator|->
name|mask
operator|&
name|ExposeRegion
condition|)
block|{
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|4
index|]
operator|=
name|r
operator|->
name|right
operator|-
name|r
operator|->
name|left
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|5
index|]
operator|=
name|r
operator|->
name|bottom
operator|-
name|r
operator|->
name|top
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|8
index|]
operator|=
name|r
operator|->
name|top
operator|-
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|9
index|]
operator|=
name|r
operator|->
name|left
operator|-
name|w
operator|->
name|full
operator|.
name|left
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
name|swapped
index|[
name|ew
operator|->
name|client
index|]
condition|)
block|{
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|9
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|Write
argument_list|(
name|ew
operator|->
name|client
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|rep
argument_list|,
sizeof|sizeof
argument_list|(
name|XRep
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|not_just_new
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|prev
operator|=
operator|&
name|r
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|changed
condition|)
block|{
name|Merge_rectangles
argument_list|(
name|changed
argument_list|,
operator|&
name|w
operator|->
name|visible
argument_list|)
expr_stmt|;
name|Windex
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
block|}
if|if TRUE
condition|(
name|not_just_new
condition|)
block|{
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|4
index|]
operator|=
name|w
operator|->
name|full
operator|.
name|right
operator|-
name|w
operator|->
name|full
operator|.
name|left
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|5
index|]
operator|=
name|w
operator|->
name|full
operator|.
name|bottom
operator|-
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|9
index|]
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
name|swapped
index|[
name|ew
operator|->
name|client
index|]
condition|)
block|{
name|rep
operator|.
name|code
operator|=
name|lswapl
argument_list|(
name|ExposeWindow
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|rep
operator|.
name|code
operator|=
name|ExposeWindow
expr_stmt|;
name|Write
argument_list|(
name|ew
operator|->
name|client
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|rep
argument_list|,
sizeof|sizeof
argument_list|(
name|XRep
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Stash CopyArea misses in the event queue of a window */
end_comment

begin_expr_stmt
name|Stash_misses
argument_list|(
name|w
argument_list|,
name|vis
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|RECTANGLE
modifier|*
name|vis
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|RECTANGLE
modifier|*
name|rec
decl_stmt|;
specifier|register
name|WINDOW
modifier|*
name|ew
init|=
name|w
decl_stmt|;
name|XRep
name|rep
decl_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
specifier|register
name|swaptype
name|n
decl_stmt|;
endif|#
directive|endif
while|while
condition|(
operator|!
operator|(
name|ew
operator|->
name|mask
operator|&
name|ExposeCopy
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|ew
operator|=
name|ew
operator|->
name|parent
operator|)
operator|==
name|NULL
condition|)
return|return;
block|}
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|0
index|]
operator|=
name|ew
operator|->
name|rid
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|3
index|]
operator|=
operator|(
name|w
operator|==
name|ew
operator|)
condition|?
literal|0
else|:
name|w
operator|->
name|rid
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
name|swapped
index|[
name|ew
operator|->
name|client
index|]
condition|)
block|{
name|rep
operator|.
name|code
operator|=
name|lswapl
argument_list|(
name|ExposeRegion
argument_list|)
expr_stmt|;
name|pswapl
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|3
index|]
operator|=
name|lswaps
argument_list|(
name|ExposeCopy
argument_list|)
expr_stmt|;
name|pswapl
argument_list|(
operator|&
name|rep
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
name|rep
operator|.
name|code
operator|=
name|ExposeRegion
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|3
index|]
operator|=
name|ExposeCopy
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
block|}
endif|#
directive|endif
while|while
condition|(
name|rec
operator|=
name|vis
condition|)
block|{
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|4
index|]
operator|=
name|rec
operator|->
name|right
operator|-
name|rec
operator|->
name|left
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|5
index|]
operator|=
name|rec
operator|->
name|bottom
operator|-
name|rec
operator|->
name|top
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|8
index|]
operator|=
name|rec
operator|->
name|top
operator|-
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|9
index|]
operator|=
name|rec
operator|->
name|left
operator|-
name|w
operator|->
name|full
operator|.
name|left
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
name|swapped
index|[
name|ew
operator|->
name|client
index|]
condition|)
block|{
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|9
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|Write
argument_list|(
name|ew
operator|->
name|client
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|rep
argument_list|,
sizeof|sizeof
argument_list|(
name|XRep
argument_list|)
argument_list|)
expr_stmt|;
name|vis
operator|=
name|rec
operator|->
name|next
expr_stmt|;
name|FREERECT
argument_list|(
name|rec
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
name|swapped
index|[
name|ew
operator|->
name|client
index|]
condition|)
name|rep
operator|.
name|code
operator|=
name|lswapl
argument_list|(
name|ExposeCopy
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|rep
operator|.
name|code
operator|=
name|ExposeCopy
expr_stmt|;
name|Write
argument_list|(
name|ew
operator|->
name|client
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|rep
argument_list|,
sizeof|sizeof
argument_list|(
name|XRep
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Stash unmap or focus event in the event queue of a window */
end_comment

begin_expr_stmt
name|Stash_simple
argument_list|(
name|w
argument_list|,
name|event
argument_list|,
name|detail
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|long
name|event
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|detail
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|ew
init|=
name|w
decl_stmt|;
name|XRep
name|rep
decl_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
specifier|register
name|swaptype
name|n
decl_stmt|;
endif|#
directive|endif
while|while
condition|(
operator|!
operator|(
name|ew
operator|->
name|mask
operator|&
name|event
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|ew
operator|=
name|ew
operator|->
name|parent
operator|)
operator|==
name|NULL
condition|)
return|return;
block|}
name|rep
operator|.
name|code
operator|=
name|event
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|0
index|]
operator|=
name|ew
operator|->
name|rid
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|s
index|[
literal|3
index|]
operator|=
name|detail
expr_stmt|;
name|rep
operator|.
name|param
operator|.
name|l
index|[
literal|3
index|]
operator|=
operator|(
name|w
operator|==
name|ew
operator|)
condition|?
literal|0
else|:
name|w
operator|->
name|rid
expr_stmt|;
ifdef|#
directive|ifdef
name|DUALTCP
if|if
condition|(
name|swapped
index|[
name|ew
operator|->
name|client
index|]
condition|)
block|{
name|swapl
argument_list|(
operator|&
name|rep
operator|.
name|code
argument_list|)
expr_stmt|;
name|pswapl
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pswaps
argument_list|(
operator|&
name|rep
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|pswapl
argument_list|(
operator|&
name|rep
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|Write
argument_list|(
name|ew
operator|->
name|client
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|rep
argument_list|,
sizeof|sizeof
argument_list|(
name|XRep
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Find out coordinates of a point relative to a window. */
end_comment

begin_expr_stmt
name|Interpret_locator
argument_list|(
name|w
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|rep
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|short
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|XRep
modifier|*
name|rep
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|sw
decl_stmt|;
name|rep
operator|->
name|param
operator|.
name|l
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|x
operator|>=
name|w
operator|->
name|vs
operator|.
name|left
operator|&&
name|y
operator|>=
name|w
operator|->
name|vs
operator|.
name|top
operator|&&
name|x
operator|<
name|w
operator|->
name|vs
operator|.
name|right
operator|&&
name|y
operator|<
name|w
operator|->
name|vs
operator|.
name|bottom
condition|)
block|{
comment|/* see if it is in a subwindow */
for|for
control|(
name|sw
operator|=
name|w
operator|->
name|last_child
init|;
name|sw
condition|;
name|sw
operator|=
name|sw
operator|->
name|prev_sib
control|)
block|{
if|if
condition|(
name|TRUE
argument_list|(
name|sw
operator|->
name|mapped
argument_list|)
operator|&&
name|x
operator|>=
name|sw
operator|->
name|full
operator|.
name|left
operator|&&
name|y
operator|>=
name|sw
operator|->
name|full
operator|.
name|top
operator|&&
name|x
operator|<
name|sw
operator|->
name|full
operator|.
name|right
operator|&&
name|y
operator|<
name|sw
operator|->
name|full
operator|.
name|bottom
condition|)
block|{
name|rep
operator|->
name|param
operator|.
name|l
index|[
literal|0
index|]
operator|=
name|sw
operator|->
name|rid
expr_stmt|;
break|break;
block|}
block|}
block|}
name|rep
operator|->
name|param
operator|.
name|s
index|[
literal|2
index|]
operator|=
name|x
operator|-
name|w
operator|->
name|full
operator|.
name|left
expr_stmt|;
name|rep
operator|->
name|param
operator|.
name|s
index|[
literal|3
index|]
operator|=
name|y
operator|-
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|rep
operator|->
name|param
operator|.
name|s
index|[
literal|4
index|]
operator|=
name|state_mask
expr_stmt|;
block|}
end_block

end_unit


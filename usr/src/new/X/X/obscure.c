begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1985	*/
end_comment

begin_comment
comment|/*	Routines for calculating how windows obscure each other:  *  *	Obscure_top, Obscure_bottom, Remove_rectangles  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_obscure_c
init|=
literal|"$Header: obscure.c,v 10.7 86/02/01 15:16:51 tony Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"Xint.h"
end_include

begin_decl_stmt
specifier|extern
name|RECTANGLE
modifier|*
name|free_rectangles
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|RECTANGLE
modifier|*
name|Alloc_rectangle
argument_list|()
decl_stmt|,
modifier|*
modifier|*
name|Do_overlap
argument_list|()
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Obscure_top allocates the rectangles for a top window, and updates the lists  * of visible rectangles in other mapped windows to reflect obscuring.  */
end_comment

begin_expr_stmt
name|Obscure_top
argument_list|(
name|w
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|w1
decl_stmt|;
specifier|register
name|RECTANGLE
modifier|*
name|pr
decl_stmt|,
modifier|*
name|v
decl_stmt|,
modifier|*
name|r
decl_stmt|;
name|RECTANGLE
name|crec
decl_stmt|,
name|brec1
decl_stmt|,
name|brec2
decl_stmt|,
name|brec3
decl_stmt|,
name|brec4
decl_stmt|;
name|int
name|done
decl_stmt|;
comment|/* Compute visible rectangles from what parent has to offer */
operator|*
operator|(
name|RASTER
operator|*
operator|)
operator|&
name|crec
operator|=
name|w
operator|->
name|vs
expr_stmt|;
name|done
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|w
operator|->
name|parent
operator|->
name|cmvisible
init|;
name|pr
condition|;
name|pr
operator|=
name|pr
operator|->
name|next
control|)
block|{
if|if
condition|(
name|crec
operator|.
name|left
operator|>=
name|pr
operator|->
name|right
operator|||
name|pr
operator|->
name|left
operator|>=
name|crec
operator|.
name|right
operator|||
name|crec
operator|.
name|top
operator|>=
name|pr
operator|->
name|bottom
operator|||
name|pr
operator|->
name|top
operator|>=
name|crec
operator|.
name|bottom
condition|)
continue|continue;
name|NEWRECT
argument_list|(
name|v
argument_list|,
name|max
argument_list|(
name|crec
operator|.
name|left
argument_list|,
name|pr
operator|->
name|left
argument_list|)
argument_list|,
name|min
argument_list|(
name|crec
operator|.
name|right
argument_list|,
name|pr
operator|->
name|right
argument_list|)
argument_list|,
name|max
argument_list|(
name|crec
operator|.
name|top
argument_list|,
name|pr
operator|->
name|top
argument_list|)
argument_list|,
name|min
argument_list|(
name|crec
operator|.
name|bottom
argument_list|,
name|pr
operator|->
name|bottom
argument_list|)
argument_list|,
name|contents_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|left
operator|==
name|crec
operator|.
name|left
operator|&&
name|v
operator|->
name|right
operator|==
name|crec
operator|.
name|right
operator|&&
name|v
operator|->
name|top
operator|==
name|crec
operator|.
name|top
operator|&&
name|v
operator|->
name|bottom
operator|==
name|crec
operator|.
name|bottom
condition|)
name|done
operator|=
literal|1
expr_stmt|;
name|RASTRECT
argument_list|(
name|r
argument_list|,
operator|*
operator|(
name|RASTER
operator|*
operator|)
name|v
argument_list|,
name|contents_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|visible
operator|&&
name|TRUE
argument_list|(
name|Merge_vertical
argument_list|(
name|v
argument_list|,
operator|&
name|w
operator|->
name|visible
argument_list|,
literal|1
argument_list|)
argument_list|)
condition|)
name|Merge_vertical
argument_list|(
name|r
argument_list|,
operator|&
name|w
operator|->
name|cmvisible
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
block|{
name|v
operator|->
name|next
operator|=
name|w
operator|->
name|visible
expr_stmt|;
name|w
operator|->
name|visible
operator|=
name|v
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|w
operator|->
name|cmvisible
expr_stmt|;
name|w
operator|->
name|cmvisible
operator|=
name|r
expr_stmt|;
block|}
if|if TRUE
condition|(
name|done
condition|)
break|break;
block|}
name|w
operator|->
name|unobscured
operator|=
name|OB_NOT
expr_stmt|;
name|Windex
argument_list|(
name|w
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|bwidth
condition|)
block|{
comment|/* Compute the visible border */
name|brec1
operator|.
name|left
operator|=
name|w
operator|->
name|full
operator|.
name|left
operator|-
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec1
operator|.
name|right
operator|=
name|w
operator|->
name|full
operator|.
name|left
expr_stmt|;
name|brec1
operator|.
name|top
operator|=
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|brec1
operator|.
name|bottom
operator|=
name|w
operator|->
name|full
operator|.
name|bottom
expr_stmt|;
name|brec1
operator|.
name|next
operator|=
operator|&
name|brec2
expr_stmt|;
name|brec2
operator|.
name|left
operator|=
name|w
operator|->
name|full
operator|.
name|right
expr_stmt|;
name|brec2
operator|.
name|right
operator|=
name|w
operator|->
name|full
operator|.
name|right
operator|+
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec2
operator|.
name|top
operator|=
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|brec2
operator|.
name|bottom
operator|=
name|w
operator|->
name|full
operator|.
name|bottom
expr_stmt|;
name|brec2
operator|.
name|next
operator|=
operator|&
name|brec3
expr_stmt|;
name|brec3
operator|.
name|left
operator|=
name|w
operator|->
name|full
operator|.
name|left
operator|-
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec3
operator|.
name|right
operator|=
name|w
operator|->
name|full
operator|.
name|right
operator|+
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec3
operator|.
name|top
operator|=
name|w
operator|->
name|full
operator|.
name|top
operator|-
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec3
operator|.
name|bottom
operator|=
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|brec3
operator|.
name|next
operator|=
operator|&
name|brec4
expr_stmt|;
name|brec4
operator|.
name|left
operator|=
name|w
operator|->
name|full
operator|.
name|left
operator|-
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec4
operator|.
name|right
operator|=
name|w
operator|->
name|full
operator|.
name|right
operator|+
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec4
operator|.
name|top
operator|=
name|w
operator|->
name|full
operator|.
name|bottom
expr_stmt|;
name|brec4
operator|.
name|bottom
operator|=
name|w
operator|->
name|full
operator|.
name|bottom
operator|+
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec4
operator|.
name|type
operator|=
name|border_rec
expr_stmt|;
name|brec4
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|r
operator|=
operator|&
name|brec1
expr_stmt|;
do|do
block|{
name|done
operator|=
literal|0
expr_stmt|;
comment|/* again, use what parent has to offer */
for|for
control|(
name|pr
operator|=
name|w
operator|->
name|parent
operator|->
name|cmvisible
init|;
name|pr
condition|;
name|pr
operator|=
name|pr
operator|->
name|next
control|)
block|{
if|if
condition|(
name|r
operator|->
name|left
operator|>=
name|pr
operator|->
name|right
operator|||
name|pr
operator|->
name|left
operator|>=
name|r
operator|->
name|right
operator|||
name|r
operator|->
name|top
operator|>=
name|pr
operator|->
name|bottom
operator|||
name|pr
operator|->
name|top
operator|>=
name|r
operator|->
name|bottom
condition|)
continue|continue;
name|NEWRECT
argument_list|(
name|v
argument_list|,
name|max
argument_list|(
name|r
operator|->
name|left
argument_list|,
name|pr
operator|->
name|left
argument_list|)
argument_list|,
name|min
argument_list|(
name|r
operator|->
name|right
argument_list|,
name|pr
operator|->
name|right
argument_list|)
argument_list|,
name|max
argument_list|(
name|r
operator|->
name|top
argument_list|,
name|pr
operator|->
name|top
argument_list|)
argument_list|,
name|min
argument_list|(
name|r
operator|->
name|bottom
argument_list|,
name|pr
operator|->
name|bottom
argument_list|)
argument_list|,
name|border_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|left
operator|==
name|r
operator|->
name|left
operator|&&
name|v
operator|->
name|right
operator|==
name|r
operator|->
name|right
operator|&&
name|v
operator|->
name|top
operator|==
name|r
operator|->
name|top
operator|&&
name|v
operator|->
name|bottom
operator|==
name|r
operator|->
name|bottom
condition|)
name|done
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|visible
operator|==
name|NULL
operator|||
name|FALSE
argument_list|(
name|Merge_vertical
argument_list|(
name|v
argument_list|,
operator|&
name|w
operator|->
name|visible
argument_list|,
literal|1
argument_list|)
argument_list|)
condition|)
block|{
name|v
operator|->
name|next
operator|=
name|w
operator|->
name|visible
expr_stmt|;
name|w
operator|->
name|visible
operator|=
name|v
expr_stmt|;
block|}
if|if TRUE
condition|(
name|done
condition|)
break|break;
block|}
block|}
do|while
condition|(
name|r
operator|=
name|r
operator|->
name|next
condition|)
do|;
block|}
if|if
condition|(
name|w
operator|->
name|visible
operator|==
name|NULL
condition|)
return|return;
comment|/* Let the window obscure the rest of the list */
name|w1
operator|=
name|w
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|w1
operator|=
name|w1
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|w1
operator|->
name|kind
operator|==
name|IsTransparent
operator|||
name|w
operator|->
name|ovs
operator|.
name|left
operator|>=
name|w1
operator|->
name|ovs
operator|.
name|right
operator|||
name|w1
operator|->
name|ovs
operator|.
name|left
operator|>=
name|w
operator|->
name|ovs
operator|.
name|right
operator|||
name|w
operator|->
name|ovs
operator|.
name|top
operator|>=
name|w1
operator|->
name|ovs
operator|.
name|bottom
operator|||
name|w1
operator|->
name|ovs
operator|.
name|top
operator|>=
name|w
operator|->
name|ovs
operator|.
name|bottom
condition|)
block|{
if|if
condition|(
name|w1
operator|!=
name|w
operator|->
name|parent
condition|)
continue|continue;
return|return;
block|}
if|if
condition|(
name|TRUE
argument_list|(
name|Calc_overlaps
argument_list|(
operator|&
name|w
operator|->
name|ovs
argument_list|,
operator|&
name|w1
operator|->
name|visible
argument_list|)
argument_list|)
operator|&&
name|w1
operator|->
name|unobscured
operator|==
name|OB_YES
condition|)
name|w1
operator|->
name|unobscured
operator|=
name|OB_NOT
expr_stmt|;
if|if
condition|(
name|w1
operator|==
name|w
operator|->
name|parent
condition|)
return|return;
name|Calc_overlaps
argument_list|(
operator|&
name|w
operator|->
name|ovs
argument_list|,
operator|&
name|w1
operator|->
name|cmvisible
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Obscure_bottom allocates the rectangles for a bottom window, and updates the  * lists of visible rectangles in the parent to reflect obscuring.  */
end_comment

begin_expr_stmt
name|Obscure_bottom
argument_list|(
name|w
argument_list|)
specifier|register
name|WINDOW
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|WINDOW
modifier|*
name|w1
decl_stmt|;
specifier|register
name|RECTANGLE
modifier|*
modifier|*
name|prev
decl_stmt|,
modifier|*
name|v
decl_stmt|,
modifier|*
name|pr
decl_stmt|,
modifier|*
name|r
decl_stmt|;
name|RECTANGLE
name|crec
decl_stmt|,
name|brec1
decl_stmt|,
name|brec2
decl_stmt|,
name|brec3
decl_stmt|,
name|brec4
decl_stmt|;
name|int
name|done
decl_stmt|;
comment|/* Compute visible rectangles from what parent has left */
operator|*
operator|(
name|RASTER
operator|*
operator|)
operator|&
name|crec
operator|=
name|w
operator|->
name|vs
expr_stmt|;
name|done
operator|=
literal|0
expr_stmt|;
name|w1
operator|=
name|w
operator|->
name|parent
expr_stmt|;
name|prev
operator|=
operator|&
name|w1
operator|->
name|visible
expr_stmt|;
while|while
condition|(
name|pr
operator|=
operator|*
name|prev
condition|)
block|{
if|if
condition|(
name|pr
operator|->
name|type
operator|==
name|border_rec
operator|||
name|crec
operator|.
name|left
operator|>=
name|pr
operator|->
name|right
operator|||
name|pr
operator|->
name|left
operator|>=
name|crec
operator|.
name|right
operator|||
name|crec
operator|.
name|top
operator|>=
name|pr
operator|->
name|bottom
operator|||
name|pr
operator|->
name|top
operator|>=
name|crec
operator|.
name|bottom
condition|)
block|{
name|prev
operator|=
operator|&
name|pr
operator|->
name|next
expr_stmt|;
continue|continue;
block|}
name|NEWRECT
argument_list|(
name|v
argument_list|,
name|max
argument_list|(
name|crec
operator|.
name|left
argument_list|,
name|pr
operator|->
name|left
argument_list|)
argument_list|,
name|min
argument_list|(
name|crec
operator|.
name|right
argument_list|,
name|pr
operator|->
name|right
argument_list|)
argument_list|,
name|max
argument_list|(
name|crec
operator|.
name|top
argument_list|,
name|pr
operator|->
name|top
argument_list|)
argument_list|,
name|min
argument_list|(
name|crec
operator|.
name|bottom
argument_list|,
name|pr
operator|->
name|bottom
argument_list|)
argument_list|,
name|contents_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|left
operator|==
name|crec
operator|.
name|left
operator|&&
name|v
operator|->
name|right
operator|==
name|crec
operator|.
name|right
operator|&&
name|v
operator|->
name|top
operator|==
name|crec
operator|.
name|top
operator|&&
name|v
operator|->
name|bottom
operator|==
name|crec
operator|.
name|bottom
condition|)
name|done
operator|=
literal|1
expr_stmt|;
comment|/* compute what remains for parent */
name|prev
operator|=
name|Do_overlap
argument_list|(
operator|(
name|RASTER
operator|*
operator|)
name|v
argument_list|,
name|prev
argument_list|,
operator|&
name|w1
operator|->
name|visible
argument_list|)
expr_stmt|;
if|if
condition|(
name|w1
operator|->
name|unobscured
operator|==
name|OB_YES
condition|)
name|w1
operator|->
name|unobscured
operator|=
name|OB_NOT
expr_stmt|;
name|RASTRECT
argument_list|(
name|r
argument_list|,
operator|*
operator|(
name|RASTER
operator|*
operator|)
name|v
argument_list|,
name|contents_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|visible
operator|&&
name|TRUE
argument_list|(
name|Merge_vertical
argument_list|(
name|v
argument_list|,
operator|&
name|w
operator|->
name|visible
argument_list|,
literal|1
argument_list|)
argument_list|)
condition|)
name|Merge_vertical
argument_list|(
name|r
argument_list|,
operator|&
name|w
operator|->
name|cmvisible
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
block|{
name|v
operator|->
name|next
operator|=
name|w
operator|->
name|visible
expr_stmt|;
name|w
operator|->
name|visible
operator|=
name|v
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|w
operator|->
name|cmvisible
expr_stmt|;
name|w
operator|->
name|cmvisible
operator|=
name|r
expr_stmt|;
block|}
if|if TRUE
condition|(
name|done
condition|)
break|break;
block|}
name|w
operator|->
name|unobscured
operator|=
name|OB_NOT
expr_stmt|;
name|Windex
argument_list|(
name|w
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|bwidth
condition|)
block|{
comment|/* Compute visible border from what parent has left */
name|brec1
operator|.
name|left
operator|=
name|w
operator|->
name|full
operator|.
name|left
operator|-
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec1
operator|.
name|right
operator|=
name|w
operator|->
name|full
operator|.
name|left
expr_stmt|;
name|brec1
operator|.
name|top
operator|=
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|brec1
operator|.
name|bottom
operator|=
name|w
operator|->
name|full
operator|.
name|bottom
expr_stmt|;
name|brec1
operator|.
name|next
operator|=
operator|&
name|brec2
expr_stmt|;
name|brec2
operator|.
name|left
operator|=
name|w
operator|->
name|full
operator|.
name|right
expr_stmt|;
name|brec2
operator|.
name|right
operator|=
name|w
operator|->
name|full
operator|.
name|right
operator|+
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec2
operator|.
name|top
operator|=
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|brec2
operator|.
name|bottom
operator|=
name|w
operator|->
name|full
operator|.
name|bottom
expr_stmt|;
name|brec2
operator|.
name|next
operator|=
operator|&
name|brec3
expr_stmt|;
name|brec3
operator|.
name|left
operator|=
name|w
operator|->
name|full
operator|.
name|left
operator|-
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec3
operator|.
name|right
operator|=
name|w
operator|->
name|full
operator|.
name|right
operator|+
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec3
operator|.
name|top
operator|=
name|w
operator|->
name|full
operator|.
name|top
operator|-
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec3
operator|.
name|bottom
operator|=
name|w
operator|->
name|full
operator|.
name|top
expr_stmt|;
name|brec3
operator|.
name|next
operator|=
operator|&
name|brec4
expr_stmt|;
name|brec4
operator|.
name|left
operator|=
name|w
operator|->
name|full
operator|.
name|left
operator|-
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec4
operator|.
name|right
operator|=
name|w
operator|->
name|full
operator|.
name|right
operator|+
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec4
operator|.
name|top
operator|=
name|w
operator|->
name|full
operator|.
name|bottom
expr_stmt|;
name|brec4
operator|.
name|bottom
operator|=
name|w
operator|->
name|full
operator|.
name|bottom
operator|+
name|w
operator|->
name|bwidth
expr_stmt|;
name|brec4
operator|.
name|type
operator|=
name|border_rec
expr_stmt|;
name|brec4
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|r
operator|=
operator|&
name|brec1
expr_stmt|;
do|do
block|{
name|done
operator|=
literal|0
expr_stmt|;
name|prev
operator|=
operator|&
name|w1
operator|->
name|visible
expr_stmt|;
while|while
condition|(
name|pr
operator|=
operator|*
name|prev
condition|)
block|{
if|if
condition|(
name|pr
operator|->
name|type
operator|==
name|border_rec
operator|||
name|r
operator|->
name|left
operator|>=
name|pr
operator|->
name|right
operator|||
name|pr
operator|->
name|left
operator|>=
name|r
operator|->
name|right
operator|||
name|r
operator|->
name|top
operator|>=
name|pr
operator|->
name|bottom
operator|||
name|pr
operator|->
name|top
operator|>=
name|r
operator|->
name|bottom
condition|)
block|{
name|prev
operator|=
operator|&
name|pr
operator|->
name|next
expr_stmt|;
continue|continue;
block|}
name|NEWRECT
argument_list|(
name|v
argument_list|,
name|max
argument_list|(
name|r
operator|->
name|left
argument_list|,
name|pr
operator|->
name|left
argument_list|)
argument_list|,
name|min
argument_list|(
name|r
operator|->
name|right
argument_list|,
name|pr
operator|->
name|right
argument_list|)
argument_list|,
name|max
argument_list|(
name|r
operator|->
name|top
argument_list|,
name|pr
operator|->
name|top
argument_list|)
argument_list|,
name|min
argument_list|(
name|r
operator|->
name|bottom
argument_list|,
name|pr
operator|->
name|bottom
argument_list|)
argument_list|,
name|border_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|left
operator|==
name|r
operator|->
name|left
operator|&&
name|v
operator|->
name|right
operator|==
name|r
operator|->
name|right
operator|&&
name|v
operator|->
name|top
operator|==
name|r
operator|->
name|top
operator|&&
name|v
operator|->
name|bottom
operator|==
name|r
operator|->
name|bottom
condition|)
name|done
operator|=
literal|1
expr_stmt|;
comment|/* compute what remains in parent */
name|prev
operator|=
name|Do_overlap
argument_list|(
operator|(
name|RASTER
operator|*
operator|)
name|v
argument_list|,
name|prev
argument_list|,
operator|&
name|w1
operator|->
name|visible
argument_list|)
expr_stmt|;
if|if
condition|(
name|w1
operator|->
name|unobscured
operator|==
name|OB_YES
condition|)
name|w1
operator|->
name|unobscured
operator|=
name|OB_NOT
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|visible
operator|==
name|NULL
operator|||
name|FALSE
argument_list|(
name|Merge_vertical
argument_list|(
name|v
argument_list|,
operator|&
name|w
operator|->
name|visible
argument_list|,
literal|1
argument_list|)
argument_list|)
condition|)
block|{
name|v
operator|->
name|next
operator|=
name|w
operator|->
name|visible
expr_stmt|;
name|w
operator|->
name|visible
operator|=
name|v
expr_stmt|;
block|}
if|if TRUE
condition|(
name|done
condition|)
break|break;
block|}
block|}
do|while
condition|(
name|r
operator|=
name|r
operator|->
name|next
condition|)
do|;
block|}
block|}
end_block

begin_comment
comment|/* Remove_rectangles removes rectangles from remw and gives the space to  * the various windows in the chain.  It does this by moving down the list,  * giving space to each window in turn.  If cleanup = 1, then update and  * display windows you give space to.  If cleanup< 0, then update the  * windows without changing the bits on the screen.  If, in the course  * of following the chain, remw is encountered, we stop.  */
end_comment

begin_expr_stmt
name|Remove_rectangles
argument_list|(
name|remw
argument_list|,
name|chain
argument_list|,
name|cleanup
argument_list|)
specifier|register
name|WINDOW
operator|*
name|remw
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|WINDOW
modifier|*
name|chain
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cleanup
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|RECTANGLE
modifier|*
name|r
decl_stmt|,
modifier|*
modifier|*
name|oldr
decl_stmt|;
specifier|register
name|WINDOW
modifier|*
name|w
decl_stmt|,
modifier|*
name|ww
decl_stmt|;
specifier|register
name|RECTANGLE
modifier|*
name|addrec
decl_stmt|;
name|RECTANGLE
modifier|*
name|new
decl_stmt|;
for|for
control|(
name|w
operator|=
name|chain
init|;
name|remw
operator|->
name|visible
operator|&&
name|w
operator|!=
name|remw
condition|;
name|w
operator|=
name|w
operator|->
name|next
control|)
block|{
if|if
condition|(
name|w
operator|->
name|kind
operator|==
name|IsTransparent
operator|||
name|w
operator|->
name|ovs
operator|.
name|left
operator|>=
name|remw
operator|->
name|ovs
operator|.
name|right
operator|||
name|remw
operator|->
name|ovs
operator|.
name|left
operator|>=
name|w
operator|->
name|ovs
operator|.
name|right
operator|||
name|w
operator|->
name|ovs
operator|.
name|top
operator|>=
name|remw
operator|->
name|ovs
operator|.
name|bottom
operator|||
name|remw
operator|->
name|ovs
operator|.
name|top
operator|>=
name|w
operator|->
name|ovs
operator|.
name|bottom
condition|)
continue|continue;
name|new
operator|=
name|NULL
expr_stmt|;
name|oldr
operator|=
operator|&
name|remw
operator|->
name|visible
expr_stmt|;
while|while
condition|(
name|r
operator|=
operator|*
name|oldr
condition|)
block|{
if|if
condition|(
name|w
operator|->
name|ovs
operator|.
name|left
operator|>=
name|r
operator|->
name|right
operator|||
name|r
operator|->
name|left
operator|>=
name|w
operator|->
name|ovs
operator|.
name|right
operator|||
name|w
operator|->
name|ovs
operator|.
name|top
operator|>=
name|r
operator|->
name|bottom
operator|||
name|r
operator|->
name|top
operator|>=
name|w
operator|->
name|ovs
operator|.
name|bottom
condition|)
block|{
name|oldr
operator|=
operator|&
name|r
operator|->
name|next
expr_stmt|;
block|}
else|else
block|{
comment|/* compute what remains */
name|oldr
operator|=
name|Do_overlap
argument_list|(
operator|&
name|w
operator|->
name|ovs
argument_list|,
name|oldr
argument_list|,
operator|&
name|remw
operator|->
name|visible
argument_list|)
expr_stmt|;
name|remw
operator|->
name|unobscured
operator|=
name|OB_NOT
expr_stmt|;
comment|/* get the piece it wants */
name|Clip_rectangle
argument_list|(
name|r
argument_list|,
operator|&
name|w
operator|->
name|ovs
argument_list|)
expr_stmt|;
comment|/* remove it */
if|if
condition|(
name|r
operator|->
name|type
operator|!=
name|border_rec
operator|&&
name|remw
operator|->
name|cmvisible
condition|)
name|Calc_overlaps
argument_list|(
operator|(
name|RASTER
operator|*
operator|)
name|r
argument_list|,
operator|&
name|remw
operator|->
name|cmvisible
argument_list|)
expr_stmt|;
comment|/* give it to our elders too */
if|if
condition|(
name|w
operator|->
name|level
operator|>
name|remw
operator|->
name|level
condition|)
block|{
name|ww
operator|=
name|w
expr_stmt|;
while|while
condition|(
operator|(
name|ww
operator|=
name|ww
operator|->
name|parent
operator|)
operator|->
name|level
operator|>=
name|remw
operator|->
name|level
condition|)
block|{
name|RASTRECT
argument_list|(
name|addrec
argument_list|,
operator|*
operator|(
name|RASTER
operator|*
operator|)
name|r
argument_list|,
name|new_rec
argument_list|)
expr_stmt|;
name|addrec
operator|->
name|next
operator|=
name|ww
operator|->
name|cmvisible
expr_stmt|;
name|ww
operator|->
name|cmvisible
operator|=
name|addrec
expr_stmt|;
block|}
block|}
comment|/* If the rectangle enters the border of w, split it up */
if|if
condition|(
name|w
operator|->
name|bwidth
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|left
operator|<
name|w
operator|->
name|vs
operator|.
name|left
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|right
operator|<=
name|w
operator|->
name|vs
operator|.
name|left
condition|)
block|{
name|r
operator|->
name|type
operator|=
name|border_rec
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|new
expr_stmt|;
name|new
operator|=
name|r
expr_stmt|;
continue|continue;
block|}
name|NEWRECT
argument_list|(
name|addrec
argument_list|,
name|r
operator|->
name|left
argument_list|,
name|w
operator|->
name|vs
operator|.
name|left
argument_list|,
name|r
operator|->
name|top
argument_list|,
name|r
operator|->
name|bottom
argument_list|,
name|border_rec
argument_list|)
expr_stmt|;
name|addrec
operator|->
name|next
operator|=
name|new
expr_stmt|;
name|new
operator|=
name|addrec
expr_stmt|;
name|r
operator|->
name|left
operator|=
name|w
operator|->
name|vs
operator|.
name|left
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|right
operator|>
name|w
operator|->
name|vs
operator|.
name|right
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|left
operator|>=
name|w
operator|->
name|vs
operator|.
name|right
condition|)
block|{
name|r
operator|->
name|type
operator|=
name|border_rec
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|new
expr_stmt|;
name|new
operator|=
name|r
expr_stmt|;
continue|continue;
block|}
name|NEWRECT
argument_list|(
name|addrec
argument_list|,
name|w
operator|->
name|vs
operator|.
name|right
argument_list|,
name|r
operator|->
name|right
argument_list|,
name|r
operator|->
name|top
argument_list|,
name|r
operator|->
name|bottom
argument_list|,
name|border_rec
argument_list|)
expr_stmt|;
name|addrec
operator|->
name|next
operator|=
name|new
expr_stmt|;
name|new
operator|=
name|addrec
expr_stmt|;
name|r
operator|->
name|right
operator|=
name|w
operator|->
name|vs
operator|.
name|right
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|top
operator|<
name|w
operator|->
name|vs
operator|.
name|top
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|bottom
operator|<=
name|w
operator|->
name|vs
operator|.
name|top
condition|)
block|{
name|r
operator|->
name|type
operator|=
name|border_rec
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|new
expr_stmt|;
name|new
operator|=
name|r
expr_stmt|;
continue|continue;
block|}
name|NEWRECT
argument_list|(
name|addrec
argument_list|,
name|r
operator|->
name|left
argument_list|,
name|r
operator|->
name|right
argument_list|,
name|r
operator|->
name|top
argument_list|,
name|w
operator|->
name|vs
operator|.
name|top
argument_list|,
name|border_rec
argument_list|)
expr_stmt|;
name|addrec
operator|->
name|next
operator|=
name|new
expr_stmt|;
name|new
operator|=
name|addrec
expr_stmt|;
name|r
operator|->
name|top
operator|=
name|w
operator|->
name|vs
operator|.
name|top
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|bottom
operator|>
name|w
operator|->
name|vs
operator|.
name|bottom
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|top
operator|>=
name|w
operator|->
name|vs
operator|.
name|bottom
condition|)
block|{
name|r
operator|->
name|type
operator|=
name|border_rec
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|new
expr_stmt|;
name|new
operator|=
name|r
expr_stmt|;
continue|continue;
block|}
name|NEWRECT
argument_list|(
name|addrec
argument_list|,
name|r
operator|->
name|left
argument_list|,
name|r
operator|->
name|right
argument_list|,
name|w
operator|->
name|vs
operator|.
name|bottom
argument_list|,
name|r
operator|->
name|bottom
argument_list|,
name|border_rec
argument_list|)
expr_stmt|;
name|addrec
operator|->
name|next
operator|=
name|new
expr_stmt|;
name|new
operator|=
name|addrec
expr_stmt|;
name|r
operator|->
name|bottom
operator|=
name|w
operator|->
name|vs
operator|.
name|bottom
expr_stmt|;
block|}
block|}
comment|/* give it to ourselves too */
if|if
condition|(
name|w
operator|->
name|level
operator|>=
name|remw
operator|->
name|level
condition|)
block|{
name|RASTRECT
argument_list|(
name|addrec
argument_list|,
operator|*
operator|(
name|RASTER
operator|*
operator|)
name|r
argument_list|,
name|new_rec
argument_list|)
expr_stmt|;
name|addrec
operator|->
name|next
operator|=
name|w
operator|->
name|cmvisible
expr_stmt|;
name|w
operator|->
name|cmvisible
operator|=
name|addrec
expr_stmt|;
block|}
if|if
condition|(
name|cleanup
operator|>=
literal|0
condition|)
name|r
operator|->
name|type
operator|=
name|new_rec
expr_stmt|;
else|else
name|r
operator|->
name|type
operator|=
name|contents_rec
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|new
expr_stmt|;
name|new
operator|=
name|r
expr_stmt|;
block|}
block|}
if|if
condition|(
name|new
condition|)
block|{
for|for
control|(
name|ww
operator|=
name|w
init|;
name|ww
operator|->
name|level
operator|>=
name|remw
operator|->
name|level
condition|;
name|ww
operator|=
name|ww
operator|->
name|parent
control|)
block|{
comment|/* find any new stuff and merge it */
name|addrec
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
operator|(
name|r
operator|=
name|ww
operator|->
name|cmvisible
operator|)
operator|&&
name|r
operator|->
name|type
operator|==
name|new_rec
condition|)
block|{
name|r
operator|->
name|type
operator|=
name|contents_rec
expr_stmt|;
name|ww
operator|->
name|cmvisible
operator|=
name|r
operator|->
name|next
expr_stmt|;
name|r
operator|->
name|next
operator|=
name|addrec
expr_stmt|;
name|addrec
operator|=
name|r
expr_stmt|;
block|}
if|if
condition|(
name|addrec
condition|)
name|Merge_rectangles
argument_list|(
name|addrec
argument_list|,
operator|&
name|ww
operator|->
name|cmvisible
argument_list|)
expr_stmt|;
block|}
name|Merge_rectangles
argument_list|(
name|new
argument_list|,
operator|&
name|w
operator|->
name|visible
argument_list|)
expr_stmt|;
name|Windex
argument_list|(
name|w
argument_list|)
expr_stmt|;
if|if
condition|(
name|cleanup
operator|>
literal|0
condition|)
name|Draw_window
argument_list|(
name|w
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cleanup
operator|==
literal|0
condition|)
name|w
operator|->
name|unobscured
operator|=
name|OB_TMP
expr_stmt|;
block|}
block|}
block|}
end_block

end_unit


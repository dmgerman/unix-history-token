begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Header: font.c,v 10.3 86/02/01 15:46:53 tony Rel $ */
end_comment

begin_comment
comment|/* font.c	Reads a font from a file and stores it on the workstation  *  *	GetFont		Takes a font name and stores it  *	FreeFont	Frees the storage taken by a font  *  */
end_comment

begin_comment
comment|/****************************************************************************  *									    *  *  Copyright (c) 1983, 1984 by						    *  *  DIGITAL EQUIPMENT CORPORATION, Maynard, Massachusetts.		    *  *  All rights reserved.						    *  * 									    *  *  This software is furnished on an as-is basis and may be used and copied *  *  only with inclusion of the above copyright notice. This software or any *  *  other copies thereof may be provided or otherwise made available to     *  *  others only for non-commercial purposes.  No title to or ownership of   *  *  the software is hereby transferred.					    *  * 									    *  *  The information in this software is  subject to change without notice   *  *  and  should  not  be  construed as  a commitment by DIGITAL EQUIPMENT   *  *  CORPORATION.							    *  * 									    *  *  DIGITAL assumes no responsibility for the use  or  reliability of its   *  *  software on equipment which is not supplied by DIGITAL.		    *  * 									    *  *									    *  ****************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"vs100.h"
end_include

begin_include
include|#
directive|include
file|"vssite.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Xalloc
argument_list|()
decl_stmt|,
modifier|*
name|AllocateSpace
argument_list|()
decl_stmt|,
modifier|*
name|strcpy
argument_list|()
decl_stmt|,
modifier|*
name|strcat
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|VSArea
modifier|*
name|VSAlloc
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|FONT
modifier|*
name|GetFont
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|char
name|fontname
index|[
literal|256
index|]
decl_stmt|;
name|int
name|fontfile
decl_stmt|;
name|FontData
name|font
decl_stmt|;
specifier|register
name|FontData
modifier|*
name|fontCopy
decl_stmt|;
define|#
directive|define
name|chars
value|((BitMap *) font.f_characters)
name|int
name|fontsize
decl_stmt|,
name|leftsize
decl_stmt|,
name|width
decl_stmt|;
name|char
modifier|*
name|fontarea
decl_stmt|;
specifier|register
name|short
modifier|*
name|leftarea
decl_stmt|;
specifier|register
name|FONT
modifier|*
name|fd
decl_stmt|;
name|FontPriv
modifier|*
name|fpriv
decl_stmt|;
specifier|register
name|BitMap
modifier|*
name|mychars
decl_stmt|;
name|strcpy
argument_list|(
name|fontname
argument_list|,
name|DEFAULT_FONT_DIRECTORY
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|fontname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|fontname
argument_list|,
name|DEFAULT_FONT_SUFFIX
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fontfile
operator|=
name|open
argument_list|(
name|fontname
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|&&
operator|(
name|errno
operator|!=
name|ENOENT
operator|||
operator|(
name|fontfile
operator|=
name|open
argument_list|(
name|name
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|fontfile
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|font
argument_list|,
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|fontsize
operator|=
name|BitmapSize
argument_list|(
name|chars
operator|->
name|bm_width
argument_list|,
name|chars
operator|->
name|bm_height
argument_list|)
expr_stmt|;
name|fontarea
operator|=
operator|(
name|char
operator|*
operator|)
name|Xalloc
argument_list|(
name|fontsize
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|fontfile
argument_list|,
operator|(
name|long
operator|)
name|font
operator|.
name|f_characters
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fontfile
argument_list|,
name|fontarea
argument_list|,
name|fontsize
argument_list|)
operator|!=
name|fontsize
condition|)
block|{
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|font
operator|.
name|f_fixedWidth
operator|==
literal|0
condition|)
block|{
name|leftsize
operator|=
operator|(
name|font
operator|.
name|f_lastChar
operator|-
name|font
operator|.
name|f_firstChar
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
expr_stmt|;
name|leftarea
operator|=
operator|(
name|short
operator|*
operator|)
name|Xalloc
argument_list|(
name|leftsize
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|fontfile
argument_list|,
operator|(
name|long
operator|)
name|font
operator|.
name|f_leftArray
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fontfile
argument_list|,
operator|(
name|caddr_t
operator|)
name|leftarea
argument_list|,
name|leftsize
argument_list|)
operator|!=
name|leftsize
condition|)
block|{
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarea
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
else|else
block|{
name|leftsize
operator|=
literal|0
expr_stmt|;
name|leftarea
operator|=
name|NULL
expr_stmt|;
block|}
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fontCopy
operator|=
operator|(
name|FontData
operator|*
operator|)
name|AllocateSpace
argument_list|(
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
if|if
condition|(
name|leftarea
condition|)
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarea
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|mychars
operator|=
operator|(
name|BitMap
operator|*
operator|)
name|fontCopy
operator|->
name|f_characters
expr_stmt|;
name|fd
operator|=
operator|(
name|FONT
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FONT
argument_list|)
argument_list|)
expr_stmt|;
name|mychars
operator|->
name|bm_address
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
expr_stmt|;
name|mychars
operator|->
name|bm_address
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|mychars
operator|->
name|bm_width
operator|=
name|chars
operator|->
name|bm_width
expr_stmt|;
name|fd
operator|->
name|height
operator|=
name|mychars
operator|->
name|bm_height
operator|=
name|chars
operator|->
name|bm_height
expr_stmt|;
name|mychars
operator|->
name|bm_bitsPerPixel
operator|=
literal|1
expr_stmt|;
name|fd
operator|->
name|first
operator|=
name|fontCopy
operator|->
name|f_firstChar
operator|=
name|font
operator|.
name|f_firstChar
expr_stmt|;
name|fd
operator|->
name|last
operator|=
name|fontCopy
operator|->
name|f_lastChar
operator|=
name|font
operator|.
name|f_lastChar
expr_stmt|;
if|if
condition|(
name|leftarea
condition|)
name|fontCopy
operator|->
name|f_leftArray
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
operator|+
name|fontsize
expr_stmt|;
else|else
name|fontCopy
operator|->
name|f_leftArray
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|fontCopy
operator|->
name|f_leftArray
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|fd
operator|->
name|base
operator|=
name|fontCopy
operator|->
name|f_baseline
operator|=
name|font
operator|.
name|f_baseline
expr_stmt|;
name|fd
operator|->
name|space
operator|=
name|fontCopy
operator|->
name|f_spaceIndex
operator|=
name|font
operator|.
name|f_spaceIndex
expr_stmt|;
name|fd
operator|->
name|space
operator|+=
name|fd
operator|->
name|first
expr_stmt|;
if|if
condition|(
name|fd
operator|->
name|avg_width
operator|=
name|fontCopy
operator|->
name|f_fixedWidth
operator|=
name|font
operator|.
name|f_fixedWidth
condition|)
name|fd
operator|->
name|fixed
operator|=
literal|1
expr_stmt|;
else|else
name|fd
operator|->
name|fixed
operator|=
literal|0
expr_stmt|;
name|fd
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|fpriv
operator|=
operator|(
name|FontPriv
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FontPriv
argument_list|)
argument_list|)
expr_stmt|;
name|fd
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|fpriv
expr_stmt|;
name|fpriv
operator|->
name|widths
operator|=
name|leftarea
expr_stmt|;
if|if
condition|(
operator|(
name|fpriv
operator|->
name|remote
operator|=
operator|(
name|VSArea
operator|*
operator|)
name|VSAlloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
operator|+
name|fontsize
operator|+
name|leftsize
argument_list|,
name|FONT_TYPE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
if|if
condition|(
name|leftarea
condition|)
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarea
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|fpriv
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|fd
operator|->
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|Xalloc
argument_list|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|fd
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|MoveObjectDown
argument_list|(
operator|(
name|caddr_t
operator|)
name|fontCopy
argument_list|,
name|fpriv
operator|->
name|remote
operator|->
name|vsPtr
argument_list|,
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
argument_list|)
operator|||
name|MoveBufferDown
argument_list|(
name|fontarea
argument_list|,
name|fpriv
operator|->
name|remote
operator|->
name|vsPtr
operator|+
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
argument_list|,
name|fontsize
argument_list|)
operator|||
operator|(
name|leftarea
operator|&&
name|MoveBufferDown
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarea
argument_list|,
name|fpriv
operator|->
name|remote
operator|->
name|vsPtr
operator|+
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
operator|+
name|fontsize
argument_list|,
name|leftsize
argument_list|)
operator|)
condition|)
block|{
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
name|FreeFont
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|leftarea
condition|)
block|{
name|leftsize
operator|=
name|font
operator|.
name|f_lastChar
operator|-
name|font
operator|.
name|f_firstChar
operator|+
literal|1
expr_stmt|;
name|width
operator|=
literal|0
expr_stmt|;
name|fontsize
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|--
name|leftsize
operator|>=
literal|0
condition|)
block|{
operator|*
name|leftarea
operator|=
name|leftarea
index|[
literal|1
index|]
operator|-
operator|*
name|leftarea
expr_stmt|;
if|if
condition|(
operator|*
name|leftarea
condition|)
block|{
name|width
operator|+=
operator|*
name|leftarea
expr_stmt|;
name|fontsize
operator|++
expr_stmt|;
block|}
name|leftarea
operator|++
expr_stmt|;
block|}
name|fd
operator|->
name|avg_width
operator|=
name|width
operator|/
name|fontsize
expr_stmt|;
block|}
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
return|return
operator|(
name|fd
operator|)
return|;
undef|#
directive|undef
name|chars
block|}
end_function

begin_expr_stmt
name|FreeFont
argument_list|(
name|font
argument_list|)
specifier|register
name|FONT
operator|*
name|font
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|FontPriv
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|FDATA
argument_list|(
name|font
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|widths
condition|)
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|data
operator|->
name|widths
argument_list|)
expr_stmt|;
name|VSFree
argument_list|(
name|data
operator|->
name|remote
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|font
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|font
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


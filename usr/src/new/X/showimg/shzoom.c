begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|"wzoom.cursor"
end_include

begin_include
include|#
directive|include
file|"wzoom_mask.cursor"
end_include

begin_define
define|#
directive|define
name|ZOOMFACT
value|4
end_define

begin_comment
comment|/* zoom factor relative to parent window */
end_comment

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(((a)< (b)) ? (a) : (b))
end_define

begin_define
define|#
directive|define
name|MAX
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(((a)> (b)) ? (a) : (b))
end_define

begin_decl_stmt
specifier|static
name|u_char
modifier|*
name|zimage
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* pointer to storage */
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|long
name|zsize
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current storage size */
end_comment

begin_decl_stmt
specifier|static
name|Bitmap
name|wzmask
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xcur
decl_stmt|,
name|ycur
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xnstatic
init|=
literal|0
decl_stmt|,
name|ynstatic
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xzoom
init|=
literal|0
decl_stmt|,
name|yzoom
init|=
literal|0
decl_stmt|,
name|f
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_macro
name|updatezoom
argument_list|(
argument|wzoom
argument_list|,
argument|xzoomsize
argument_list|,
argument|yzoomsize
argument_list|,
argument|x
argument_list|,
argument|y
argument_list|,
argument|xsize
argument_list|,
argument|ysize
argument_list|,
argument|image
argument_list|,
argument|wzfactor
argument_list|)
end_macro

begin_decl_stmt
name|Window
name|wzoom
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* zoom window ID */
end_comment

begin_decl_stmt
name|int
name|xzoomsize
decl_stmt|,
name|yzoomsize
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* zoom window size */
end_comment

begin_decl_stmt
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* center coord for zoom */
end_comment

begin_decl_stmt
name|int
name|xsize
decl_stmt|,
name|ysize
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size of original image */
end_comment

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|image
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 8-bit image */
end_comment

begin_decl_stmt
name|int
name|wzfactor
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* parent window zoom factor */
end_comment

begin_block
block|{
name|unsigned
name|char
modifier|*
name|malloc
argument_list|()
decl_stmt|,
modifier|*
name|free
argument_list|()
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|j
decl_stmt|,
name|xn
init|=
name|xnstatic
decl_stmt|,
name|yn
init|=
name|ynstatic
decl_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
operator|||
name|x
operator|>=
name|xsize
operator|||
name|y
operator|<
literal|0
operator|||
name|y
operator|>=
name|ysize
condition|)
return|return;
comment|/* recalculate the storage needed for nearest larger zoomed pixel */
if|if
condition|(
operator|(
name|f
operator|!=
name|ZOOMFACT
operator|*
name|wzfactor
operator|)
operator|||
operator|(
name|xzoom
operator|!=
name|xzoomsize
operator|)
operator|||
operator|(
name|yzoom
operator|!=
name|yzoomsize
operator|)
condition|)
block|{
name|f
operator|=
name|ZOOMFACT
operator|*
name|wzfactor
expr_stmt|;
name|xn
operator|=
name|xnstatic
operator|=
name|xzoomsize
operator|/
name|f
operator|+
literal|1
expr_stmt|;
name|yn
operator|=
name|ynstatic
operator|=
name|yzoomsize
operator|/
name|f
operator|+
literal|1
expr_stmt|;
name|xzoom
operator|=
name|xn
operator|*
name|f
expr_stmt|;
name|yzoom
operator|=
name|yn
operator|*
name|f
expr_stmt|;
name|xcur
operator|=
operator|(
name|xzoom
operator|>>
literal|1
operator|)
operator|-
name|wzoom_x_hot
operator|+
operator|(
operator|(
name|f
operator|/
name|ZOOMFACT
operator|)
operator|<<
literal|1
operator|)
expr_stmt|;
name|ycur
operator|=
operator|(
name|yzoom
operator|>>
literal|1
operator|)
operator|-
name|wzoom_y_hot
operator|+
operator|(
operator|(
name|f
operator|/
name|ZOOMFACT
operator|)
operator|<<
literal|1
operator|)
expr_stmt|;
block|}
comment|/* check available storage space */
if|if
condition|(
operator|(
name|xzoom
operator|*
name|yzoom
operator|)
operator|>
name|zsize
condition|)
block|{
if|if
condition|(
name|zimage
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|zimage
argument_list|)
expr_stmt|;
name|zsize
operator|=
name|xzoom
operator|*
name|yzoom
expr_stmt|;
if|if
condition|(
operator|(
name|zimage
operator|=
name|malloc
argument_list|(
name|zsize
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't allocate zoom image buffer!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|replicate
argument_list|(
name|x
operator|-
name|xn
operator|/
literal|2
argument_list|,
name|y
operator|-
name|yn
operator|/
literal|2
argument_list|,
name|xsize
argument_list|,
name|ysize
argument_list|,
name|image
argument_list|,
name|f
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|xzoom
argument_list|,
name|yzoom
argument_list|,
name|zimage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|y
operator|-
name|yn
operator|/
literal|2
operator|)
operator|<
literal|0
condition|)
name|bzero
argument_list|(
name|zimage
argument_list|,
name|xzoom
operator|*
name|f
operator|*
operator|(
name|yn
operator|/
literal|2
operator|-
name|y
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|y
operator|-
name|yn
operator|/
literal|2
operator|+
name|yn
operator|)
operator|>
name|ysize
condition|)
name|bzero
argument_list|(
name|zimage
operator|+
name|xzoom
operator|*
name|f
operator|*
operator|(
name|ysize
operator|-
name|y
operator|+
name|yn
operator|/
literal|2
operator|)
argument_list|,
name|xzoom
operator|*
name|f
operator|*
operator|(
name|y
operator|-
name|yn
operator|/
literal|2
operator|+
name|yn
operator|-
name|ysize
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|-
name|xn
operator|/
literal|2
operator|)
operator|<
literal|0
condition|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|yzoom
condition|;
name|j
operator|++
control|)
name|bzero
argument_list|(
name|zimage
operator|+
name|j
operator|*
name|xzoom
argument_list|,
name|f
operator|*
operator|(
name|xn
operator|/
literal|2
operator|-
name|x
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|-
name|xn
operator|/
literal|2
operator|+
name|xn
operator|)
operator|>
name|xsize
condition|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|yzoom
condition|;
name|j
operator|++
control|)
name|bzero
argument_list|(
name|zimage
operator|+
name|j
operator|*
name|xzoom
operator|+
name|f
operator|*
operator|(
name|xsize
operator|-
name|x
operator|+
name|xn
operator|/
literal|2
operator|)
argument_list|,
name|f
operator|*
operator|(
name|x
operator|-
name|xn
operator|/
literal|2
operator|+
name|xn
operator|-
name|xsize
operator|)
argument_list|)
expr_stmt|;
name|XPixmapBitsPutZ
argument_list|(
name|wzoom
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|xzoom
argument_list|,
name|yzoom
argument_list|,
name|zimage
argument_list|,
literal|0
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
if|if
condition|(
name|wzmask
operator|==
name|NULL
condition|)
block|{
name|wzmask
operator|=
name|XStoreBitmap
argument_list|(
name|wzoom_mask_width
argument_list|,
name|wzoom_mask_height
argument_list|,
name|wzoom_mask_bits
argument_list|)
expr_stmt|;
block|}
name|XBitmapBitsPut
argument_list|(
name|wzoom
argument_list|,
name|xcur
argument_list|,
name|ycur
argument_list|,
name|wzoom_width
argument_list|,
name|wzoom_height
argument_list|,
name|wzoom_bits
argument_list|,
name|WhitePixel
argument_list|,
name|BlackPixel
argument_list|,
name|wzmask
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|replicate
argument_list|(
argument|x0
argument_list|,
argument|y0
argument_list|,
argument|w0
argument_list|,
argument|h0
argument_list|,
argument|from
argument_list|,
argument|f
argument_list|,
argument|x
argument_list|,
argument|y
argument_list|,
argument|w
argument_list|,
argument|h
argument_list|,
argument|to
argument_list|)
end_macro

begin_comment
comment|/* Fill array "to" with a piece of "from", each pixel mapping to fxf pixels */
end_comment

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|from
decl_stmt|,
modifier|*
name|to
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Source array, destination array */
end_comment

begin_decl_stmt
name|int
name|x0
decl_stmt|,
name|y0
decl_stmt|,
name|w0
decl_stmt|,
name|h0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Source origin, dimensions */
end_comment

begin_decl_stmt
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Destination origin, dimensions */
end_comment

begin_decl_stmt
name|int
name|f
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Replication factor */
end_comment

begin_block
block|{
specifier|register
name|unsigned
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|d
decl_stmt|;
specifier|register
name|int
name|k
decl_stmt|,
name|n
decl_stmt|,
name|i
decl_stmt|;
name|int
name|i0
decl_stmt|,
name|i1
decl_stmt|,
name|j0
decl_stmt|,
name|j1
decl_stmt|,
name|j
decl_stmt|;
name|j0
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|y0
argument_list|)
expr_stmt|;
name|j1
operator|=
name|MIN
argument_list|(
name|h0
argument_list|,
name|y0
operator|+
operator|(
name|h
operator|-
name|y
operator|)
operator|/
name|f
argument_list|)
expr_stmt|;
name|i0
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|x0
argument_list|)
expr_stmt|;
name|i1
operator|=
name|MIN
argument_list|(
name|w0
argument_list|,
name|x0
operator|+
operator|(
name|w
operator|-
name|x
operator|)
operator|/
name|f
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
name|j0
init|;
name|j
operator|<
name|j1
condition|;
name|j
operator|++
control|)
block|{
name|s
operator|=
name|from
operator|+
name|w0
operator|*
name|j
operator|+
name|i0
expr_stmt|;
name|d
operator|=
name|to
operator|+
name|w
operator|*
operator|(
name|f
operator|*
operator|(
name|j
operator|-
name|y0
operator|)
operator|+
name|y
operator|)
operator|+
name|x
operator|+
name|f
operator|*
operator|(
name|i0
operator|-
name|x0
operator|)
expr_stmt|;
name|i
operator|=
name|i1
operator|-
name|i0
expr_stmt|;
name|n
operator|=
name|f
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
name|k
operator|=
name|n
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
operator|*
name|d
operator|++
operator|=
operator|*
name|s
expr_stmt|;
name|s
operator|++
expr_stmt|;
block|}
name|i
operator|=
name|f
operator|-
literal|1
expr_stmt|;
name|n
operator|=
name|f
operator|*
operator|(
name|i1
operator|-
name|i0
operator|)
expr_stmt|;
name|s
operator|=
name|d
operator|-
name|f
operator|*
operator|(
name|i1
operator|-
name|i0
operator|)
expr_stmt|;
name|d
operator|=
name|s
operator|+
name|w
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
name|d
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|d
operator|+=
name|w
expr_stmt|;
block|}
block|}
block|}
end_block

end_unit


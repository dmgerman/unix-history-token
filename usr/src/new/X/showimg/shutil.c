begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* split off some utility functions */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|"quad_arrow.cursor"
end_include

begin_include
include|#
directive|include
file|"quad_arrow_mask.cursor"
end_include

begin_include
include|#
directive|include
file|"pan.cursor"
end_include

begin_include
include|#
directive|include
file|"pan_mask.cursor"
end_include

begin_include
include|#
directive|include
file|"print.cursor"
end_include

begin_include
include|#
directive|include
file|"print_mask.cursor"
end_include

begin_include
include|#
directive|include
file|"zoom2.cursor"
end_include

begin_include
include|#
directive|include
file|"zoom2_mask.cursor"
end_include

begin_include
include|#
directive|include
file|"zoom4.cursor"
end_include

begin_include
include|#
directive|include
file|"zoom4_mask.cursor"
end_include

begin_include
include|#
directive|include
file|"pal.cursor"
end_include

begin_include
include|#
directive|include
file|"pal_mask.cursor"
end_include

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(((a)< (b)) ? (a) : (b))
end_define

begin_define
define|#
directive|define
name|MAX
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(((a)> (b)) ? (a) : (b))
end_define

begin_define
define|#
directive|define
name|SYNCINT
value|20
end_define

begin_expr_stmt
name|ipow
argument_list|(
name|x
argument_list|,
name|n
argument_list|)
specifier|register
name|int
name|x
operator|,
name|n
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
literal|1
init|;
name|n
operator|>
literal|0
condition|;
operator|--
name|n
control|)
name|p
operator|*=
name|x
expr_stmt|;
return|return
operator|(
name|p
operator|)
return|;
block|}
end_block

begin_macro
name|make_cursors
argument_list|(
argument|imcursor
argument_list|,
argument|pancursor
argument_list|,
argument|printcursor
argument_list|,
argument|zoom2cursor
argument_list|,
argument|zoom4cursor
argument_list|,
argument|palcursor
argument_list|)
end_macro

begin_decl_stmt
name|Cursor
modifier|*
name|imcursor
decl_stmt|,
modifier|*
name|pancursor
decl_stmt|,
modifier|*
name|printcursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Cursor
modifier|*
name|zoom2cursor
decl_stmt|,
modifier|*
name|zoom4cursor
decl_stmt|,
modifier|*
name|palcursor
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Cursor
name|XCreateCursor
parameter_list|()
function_decl|;
operator|*
name|imcursor
operator|=
name|XCreateCursor
argument_list|(
name|quad_arrow_width
argument_list|,
name|quad_arrow_height
argument_list|,
name|quad_arrow_bits
argument_list|,
name|quad_arrow_mask_bits
argument_list|,
name|quad_arrow_x_hot
argument_list|,
name|quad_arrow_y_hot
argument_list|,
name|BlackPixel
argument_list|,
name|WhitePixel
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
operator|*
name|pancursor
operator|=
name|XCreateCursor
argument_list|(
name|pan_width
argument_list|,
name|pan_height
argument_list|,
name|pan_bits
argument_list|,
name|pan_mask_bits
argument_list|,
name|pan_x_hot
argument_list|,
name|pan_y_hot
argument_list|,
name|BlackPixel
argument_list|,
name|WhitePixel
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
operator|*
name|printcursor
operator|=
name|XCreateCursor
argument_list|(
name|print_width
argument_list|,
name|print_height
argument_list|,
name|print_bits
argument_list|,
name|print_mask_bits
argument_list|,
name|print_x_hot
argument_list|,
name|print_y_hot
argument_list|,
name|BlackPixel
argument_list|,
name|WhitePixel
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
operator|*
name|zoom2cursor
operator|=
name|XCreateCursor
argument_list|(
name|zoom2_width
argument_list|,
name|zoom2_height
argument_list|,
name|zoom2_bits
argument_list|,
name|zoom2_mask_bits
argument_list|,
name|zoom2_x_hot
argument_list|,
name|zoom2_y_hot
argument_list|,
name|BlackPixel
argument_list|,
name|WhitePixel
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
operator|*
name|zoom4cursor
operator|=
name|XCreateCursor
argument_list|(
name|zoom4_width
argument_list|,
name|zoom4_height
argument_list|,
name|zoom4_bits
argument_list|,
name|zoom4_mask_bits
argument_list|,
name|zoom4_x_hot
argument_list|,
name|zoom4_y_hot
argument_list|,
name|BlackPixel
argument_list|,
name|WhitePixel
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
operator|*
name|palcursor
operator|=
name|XCreateCursor
argument_list|(
name|pal_width
argument_list|,
name|pal_height
argument_list|,
name|pal_bits
argument_list|,
name|pal_mask_bits
argument_list|,
name|pal_x_hot
argument_list|,
name|pal_y_hot
argument_list|,
name|BlackPixel
argument_list|,
name|WhitePixel
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
return|return;
block|}
end_block

begin_comment
comment|/* write image pixels to the screen according to location,   * zoom factor  */
end_comment

begin_macro
name|writepix
argument_list|(
argument|wind
argument_list|,
argument|image
argument_list|,
argument|ncols
argument_list|,
argument|nrows
argument_list|,
argument|zoomfactor
argument_list|,
argument|x
argument_list|,
argument|y
argument_list|,
argument|width
argument_list|,
argument|height
argument_list|,
argument|xzero
argument_list|,
argument|yzero
argument_list|,
argument|mask
argument_list|,
argument|func
argument_list|,
argument|planes
argument_list|)
end_macro

begin_decl_stmt
name|Window
name|wind
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|ncols
decl_stmt|,
name|nrows
decl_stmt|,
name|zoomfactor
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|,
name|xzero
decl_stmt|,
name|yzero
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mask
decl_stmt|,
name|func
decl_stmt|,
name|planes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|char
name|linebuf
index|[
literal|8192
index|]
decl_stmt|;
name|int
name|j
decl_stmt|,
name|k
decl_stmt|,
name|l
decl_stmt|,
name|minw
decl_stmt|,
name|ldebug
init|=
literal|0
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|byteimage
decl_stmt|,
modifier|*
name|line
init|=
name|linebuf
decl_stmt|;
specifier|register
name|int
name|ncols_reg
init|=
name|ncols
decl_stmt|;
specifier|register
name|minwidth
operator|,
name|maxy
expr_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|minwidth
operator|=
name|MIN
argument_list|(
operator|(
name|ncols_reg
operator|-
name|x
operator|)
operator|<<
name|zoomfactor
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|maxy
operator|=
name|MIN
argument_list|(
name|nrows
operator|<<
name|zoomfactor
argument_list|,
name|y
operator|+
name|height
argument_list|)
expr_stmt|;
name|byteimage
operator|=
name|image
operator|+
operator|(
operator|(
name|yzero
operator|+
name|y
operator|)
operator|*
name|ncols_reg
operator|)
operator|+
name|xzero
operator|+
name|x
expr_stmt|;
name|XSync
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|zoomfactor
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
name|y
init|;
name|i
operator|<
name|maxy
condition|;
name|i
operator|++
control|)
block|{
name|XPixmapBitsPutZ
argument_list|(
name|wind
argument_list|,
name|x
argument_list|,
name|i
argument_list|,
name|minwidth
argument_list|,
literal|1
argument_list|,
name|byteimage
argument_list|,
name|mask
argument_list|,
name|func
argument_list|,
name|planes
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
name|SYNCINT
operator|)
operator|==
literal|0
condition|)
name|XSync
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|byteimage
operator|+=
name|ncols_reg
expr_stmt|;
block|}
return|return;
block|}
else|else
block|{
name|l
operator|=
literal|1
operator|<<
name|zoomfactor
expr_stmt|;
comment|/* adjust for odd pixels */
name|width
operator|+=
name|x
operator|&
operator|(
name|l
operator|-
literal|1
operator|)
expr_stmt|;
name|x
operator|-=
name|x
operator|&
operator|(
name|l
operator|-
literal|1
operator|)
expr_stmt|;
name|height
operator|+=
name|y
operator|&
operator|(
name|l
operator|-
literal|1
operator|)
expr_stmt|;
name|y
operator|-=
name|y
operator|&
operator|(
name|l
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|width
operator|&
operator|(
name|l
operator|-
literal|1
operator|)
condition|)
name|width
operator|=
operator|(
name|width
operator|&
operator|~
operator|(
name|l
operator|-
literal|1
operator|)
operator|)
operator|+
name|l
expr_stmt|;
if|if
condition|(
name|height
operator|&
operator|(
name|l
operator|-
literal|1
operator|)
condition|)
name|height
operator|=
operator|(
name|height
operator|&
operator|~
operator|(
name|l
operator|-
literal|1
operator|)
operator|)
operator|+
name|l
expr_stmt|;
name|minwidth
operator|=
name|MIN
argument_list|(
operator|(
name|ncols_reg
operator|-
operator|(
name|x
operator|>>
name|zoomfactor
operator|)
operator|)
operator|<<
name|zoomfactor
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|maxy
operator|=
name|MIN
argument_list|(
name|nrows
operator|<<
name|zoomfactor
argument_list|,
name|y
operator|+
name|height
argument_list|)
expr_stmt|;
name|minw
operator|=
name|minwidth
operator|>>
name|zoomfactor
expr_stmt|;
name|byteimage
operator|=
name|image
operator|+
operator|(
operator|(
name|yzero
operator|+
operator|(
name|y
operator|>>
name|zoomfactor
operator|)
operator|)
operator|*
name|ncols_reg
operator|)
operator|+
name|xzero
operator|+
operator|(
name|x
operator|>>
name|zoomfactor
operator|)
expr_stmt|;
for|for
control|(
name|j
operator|=
name|y
init|;
name|j
operator|<
name|maxy
condition|;
name|j
operator|+=
name|l
control|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|minw
condition|;
name|k
operator|++
control|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|l
condition|;
name|i
operator|++
control|)
operator|*
name|line
operator|++
operator|=
name|byteimage
index|[
name|k
index|]
expr_stmt|;
name|line
operator|=
name|linebuf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|l
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|+
name|i
operator|>=
name|maxy
condition|)
return|return;
name|XPixmapBitsPutZ
argument_list|(
name|wind
argument_list|,
name|x
argument_list|,
name|j
operator|+
name|i
argument_list|,
name|minwidth
argument_list|,
literal|1
argument_list|,
name|line
argument_list|,
name|mask
argument_list|,
name|func
argument_list|,
name|planes
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|i
operator|+
name|j
operator|)
operator|%
name|SYNCINT
operator|)
operator|==
literal|0
condition|)
name|XSync
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|byteimage
operator|+=
name|ncols_reg
expr_stmt|;
block|}
block|}
return|return;
block|}
end_block

end_unit


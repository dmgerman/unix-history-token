begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	$Source: /u1/X/libis/RCS/events.c,v $  *	$Header: events.c,v 1.1 86/11/17 14:33:56 swick Rel $  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_events_c
init|=
literal|"$Header: events.c,v 1.1 86/11/17 14:33:56 swick Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|"is-copyright.h"
end_include

begin_comment
comment|/*      events.c  *  *	ProcessInput	stub  *      InputHandler	Read IS input; convert to X event  *  *      Copyright (c) 1986, Integrated Solutions, Inc.  */
end_comment

begin_include
include|#
directive|include
file|"Xis.h"
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|"lk201.h"
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_define
define|#
directive|define
name|IBUFSIZE
value|512
end_define

begin_define
define|#
directive|define
name|KEY_MASKS
value|(ControlMask|MetaMask|ShiftMask|ShiftLockMask)
end_define

begin_comment
comment|/*  *	taken from ../X/input.c  */
end_comment

begin_define
define|#
directive|define
name|ShiftKeyCode
value|0256
end_define

begin_define
define|#
directive|define
name|ControlKeyCode
value|0257
end_define

begin_define
define|#
directive|define
name|LockKeyCode
value|0260
end_define

begin_define
define|#
directive|define
name|MetaKeyCode
value|0261
end_define

begin_define
define|#
directive|define
name|VSE_LEFT_BUTTON
value|0
end_define

begin_define
define|#
directive|define
name|VSE_MIDDLE_BUTTON
value|1
end_define

begin_define
define|#
directive|define
name|VSE_RIGHT_BUTTON
value|2
end_define

begin_decl_stmt
specifier|extern
name|DEVICE
modifier|*
name|CurrentDevice
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|indev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|vsCursor
name|last_mouse
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mouse_acceleration
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mouse_threshold
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|invalid_mouse
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *	ProcessInput  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_expr_stmt
name|ProcessInput
argument_list|(
name|ev
argument_list|)
specifier|register
name|vsEvent
operator|*
name|ev
expr_stmt|;
end_expr_stmt

begin_block
block|{
comment|/*NOTREACHED*/
block|}
end_block

begin_comment
comment|/*  *	InputHandler  *  *	It is assumed that read always returns complete sequences.  *	Uses PF[1-4] to toggle ShiftKey, LockKey, ControlKey, and MetaKey.  */
end_comment

begin_function
name|int
name|InputHandler
parameter_list|()
block|{
name|unsigned
name|char
name|inbuf
index|[
name|IBUFSIZE
index|]
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|p
init|=
name|inbuf
decl_stmt|;
specifier|register
name|int
name|nread
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fcntl
argument_list|(
name|indev
argument_list|,
name|F_SETFL
argument_list|,
name|FNDELAY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nread
operator|=
name|read
argument_list|(
name|indev
argument_list|,
operator|(
name|char
operator|*
operator|)
name|inbuf
argument_list|,
name|IBUFSIZE
argument_list|)
operator|)
operator|<=
literal|0
condition|)
block|{
comment|/* no input now */
name|fcntl
argument_list|(
name|indev
argument_list|,
name|F_SETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|invalid_mouse
condition|)
operator|--
name|invalid_mouse
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|p
operator|<
operator|&
name|inbuf
index|[
name|nread
index|]
condition|)
block|{
specifier|static
name|unsigned
name|mask
init|=
literal|0
decl_stmt|;
name|vsEvent
name|event
decl_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
name|VT_MOUSE
condition|)
block|{
comment|/* a mouse input */
name|int
name|warp
init|=
literal|0
decl_stmt|;
name|event
operator|.
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|p
operator|++
expr_stmt|;
comment|/* which button */
switch|switch
condition|(
operator|*
name|p
operator|&
operator|(
name|VT_MOUSE_LEFT
operator||
name|VT_MOUSE_MIDDLE
operator||
name|VT_MOUSE_RIGHT
operator|)
condition|)
block|{
case|case
name|VT_MOUSE_LEFT
case|:
name|event
operator|.
name|vse_key
operator|=
name|VSE_LEFT_BUTTON
expr_stmt|;
break|break;
case|case
name|VT_MOUSE_MIDDLE
case|:
name|event
operator|.
name|vse_key
operator|=
name|VSE_MIDDLE_BUTTON
expr_stmt|;
break|break;
case|case
name|VT_MOUSE_RIGHT
case|:
name|event
operator|.
name|vse_key
operator|=
name|VSE_RIGHT_BUTTON
expr_stmt|;
break|break;
block|}
comment|/* which direction */
switch|switch
condition|(
operator|*
name|p
operator|++
operator|&
operator|(
name|VT_MOUSE_DOWN
operator||
name|VT_MOUSE_UP
operator||
name|VT_MOUSE_NOBUTTON
operator|)
condition|)
block|{
case|case
name|VT_MOUSE_DOWN
case|:
name|event
operator|.
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|event
operator|.
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
break|break;
case|case
name|VT_MOUSE_UP
case|:
name|event
operator|.
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|event
operator|.
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
break|break;
case|case
name|VT_MOUSE_NOBUTTON
case|:
name|event
operator|.
name|vse_type
operator|=
name|VSE_MMOTION
expr_stmt|;
name|event
operator|.
name|vse_direction
operator|=
name|VSE_KBTRAW
expr_stmt|;
break|break;
block|}
name|p
operator|++
expr_stmt|;
comment|/* window */
name|p
operator|++
expr_stmt|;
comment|/* pane */
name|event
operator|.
name|vse_x
operator|=
operator|*
name|p
operator|++
operator|<<
literal|8
expr_stmt|;
name|event
operator|.
name|vse_x
operator||=
operator|*
name|p
operator|++
expr_stmt|;
comment|/* x location */
name|event
operator|.
name|vse_y
operator|=
operator|*
name|p
operator|++
operator|<<
literal|8
expr_stmt|;
name|event
operator|.
name|vse_y
operator||=
operator|*
name|p
operator|++
expr_stmt|;
comment|/* y location */
if|if
condition|(
name|invalid_mouse
operator|&&
operator|(
name|event
operator|.
name|vse_type
operator|==
name|VSE_MMOTION
operator|)
condition|)
block|{
comment|/* throw away buffered mouse motion events after warp */
continue|continue;
block|}
comment|/* adjust for mouse acceleration if necessary */
if|if
condition|(
operator|(
name|mouse_acceleration
operator|>
literal|1
operator|)
operator|&&
operator|(
name|event
operator|.
name|vse_type
operator|==
name|VSE_MMOTION
operator|)
condition|)
block|{
comment|/* accelerated mouse */
specifier|register
name|int
name|delta
decl_stmt|;
name|delta
operator|=
name|event
operator|.
name|vse_x
operator|-
name|last_mouse
operator|.
name|x
expr_stmt|;
if|if
condition|(
operator|(
name|delta
operator|<
operator|-
name|mouse_threshold
operator|)
operator|||
operator|(
name|delta
operator|>
name|mouse_threshold
operator|)
condition|)
block|{
comment|/* accelerate mouse in x direction */
specifier|register
name|short
name|new_x
decl_stmt|;
name|warp
operator|=
literal|1
expr_stmt|;
comment|/* will have to warp the mouse */
name|new_x
operator|=
name|last_mouse
operator|.
name|x
operator|+
operator|(
operator|(
name|delta
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|1
operator|)
operator|*
name|mouse_threshold
operator|)
operator|*
operator|(
literal|1
operator|-
name|mouse_acceleration
operator|)
operator|+
operator|(
name|mouse_acceleration
operator|*
name|delta
operator|)
expr_stmt|;
comment|/* keep warped mouse on the screen */
if|if
condition|(
name|new_x
operator|>=
name|ScreenPixmap
operator|.
name|width
condition|)
name|event
operator|.
name|vse_x
operator|=
name|ScreenPixmap
operator|.
name|width
operator|-
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|new_x
operator|<
literal|0
condition|)
name|event
operator|.
name|vse_x
operator|=
literal|0
expr_stmt|;
else|else
name|event
operator|.
name|vse_x
operator|=
operator|(
name|unsigned
name|short
operator|)
name|new_x
expr_stmt|;
block|}
name|delta
operator|=
name|event
operator|.
name|vse_y
operator|-
name|last_mouse
operator|.
name|y
expr_stmt|;
if|if
condition|(
operator|(
name|delta
operator|<
operator|-
name|mouse_threshold
operator|)
operator|||
operator|(
name|delta
operator|>
name|mouse_threshold
operator|)
condition|)
block|{
comment|/* accelerate mouse in y direction */
specifier|register
name|short
name|new_y
decl_stmt|;
name|warp
operator|=
literal|1
expr_stmt|;
comment|/* will have to warp the mouse */
name|new_y
operator|=
name|last_mouse
operator|.
name|y
operator|+
operator|(
operator|(
name|delta
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|1
operator|)
operator|*
name|mouse_threshold
operator|)
operator|*
operator|(
literal|1
operator|-
name|mouse_acceleration
operator|)
operator|+
operator|(
name|mouse_acceleration
operator|*
name|delta
operator|)
expr_stmt|;
comment|/* keep warped mouse on the screen */
if|if
condition|(
name|new_y
operator|>=
name|ScreenPixmap
operator|.
name|height
condition|)
name|event
operator|.
name|vse_y
operator|=
name|ScreenPixmap
operator|.
name|height
operator|-
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|new_y
operator|<
literal|0
condition|)
name|event
operator|.
name|vse_y
operator|=
literal|0
expr_stmt|;
else|else
name|event
operator|.
name|vse_y
operator|=
operator|(
name|unsigned
name|short
operator|)
name|new_y
expr_stmt|;
block|}
block|}
if|if
condition|(
name|invalid_mouse
operator|&&
operator|(
name|event
operator|.
name|vse_type
operator|!=
name|VSE_MMOTION
operator|)
condition|)
block|{
comment|/* don't throw away buffered mouse button events after warp */
comment|/* but set them to warp location */
name|event
operator|.
name|vse_x
operator|=
name|last_mouse
operator|.
name|x
expr_stmt|;
name|event
operator|.
name|vse_y
operator|=
name|last_mouse
operator|.
name|y
expr_stmt|;
block|}
if|if
condition|(
name|warp
condition|)
name|SetCursorPosition
argument_list|(
operator|(
name|vsCursor
operator|*
operator|)
operator|&
name|event
argument_list|)
expr_stmt|;
else|else
name|UpdateCursorPosition
argument_list|(
operator|(
name|vsCursor
operator|*
operator|)
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|.
name|vse_type
operator|==
name|VSE_MMOTION
condition|)
block|{
specifier|register
name|vsBox
modifier|*
name|b
init|=
name|CurrentDevice
operator|->
name|mbox
decl_stmt|;
specifier|register
name|vsCursor
modifier|*
name|m
init|=
name|CurrentDevice
operator|->
name|mouse
decl_stmt|;
comment|/* Has it left the box? */
if|if
condition|(
name|m
operator|->
name|y
operator|>=
name|b
operator|->
name|bottom
operator|||
name|m
operator|->
name|y
operator|<
name|b
operator|->
name|top
operator|||
name|m
operator|->
name|x
operator|>=
name|b
operator|->
name|right
operator|||
name|m
operator|->
name|x
operator|<
name|b
operator|->
name|left
condition|)
block|{
name|b
operator|->
name|bottom
operator|=
literal|0
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* a mouse button press or release */
name|struct
name|timeval
name|t
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
comment|/* this is the best we can do for now */
name|gettimeofday
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
name|event
operator|.
name|vse_time
operator|=
name|t
operator|.
name|tv_sec
operator|*
literal|100
operator|+
name|t
operator|.
name|tv_usec
operator|/
literal|10000
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* keyboard input */
name|struct
name|timeval
name|t
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
comment|/* this is the best we can do for now */
name|gettimeofday
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
name|event
operator|.
name|vse_time
operator|=
name|t
operator|.
name|tv_sec
operator|*
literal|100
operator|+
name|t
operator|.
name|tv_usec
operator|/
literal|10000
expr_stmt|;
name|event
operator|.
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|event
operator|.
name|vse_device
operator|=
name|VSE_DKB
expr_stmt|;
comment|/* check for PF[1-4] (ESC O [PQRS]);  assumes that if a */
comment|/* complete PF escape sequence is in the buffer, it was */
comment|/* produced by a PF key */
if|if
condition|(
operator|(
operator|&
name|inbuf
index|[
name|nread
index|]
operator|-
name|p
operator|>=
literal|3
operator|)
operator|&&
operator|(
operator|*
name|p
operator|==
literal|'\033'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|p
operator|+
literal|1
operator|)
operator|==
literal|'O'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|p
operator|+
literal|2
operator|)
operator|>=
literal|'P'
operator|)
operator|&&
operator|(
operator|*
operator|(
name|p
operator|+
literal|2
operator|)
operator|<=
literal|'S'
operator|)
condition|)
block|{
comment|/* one of Shift, Lock, Control, Meta (PF[1-4]) was pressed */
switch|switch
condition|(
operator|*
operator|(
name|p
operator|+
literal|2
operator|)
condition|)
block|{
comment|/* toggle the appropriate key */
case|case
literal|'P'
case|:
comment|/* PF1 -- ShiftKey */
name|mask
operator|^=
name|ShiftMask
expr_stmt|;
name|event
operator|.
name|vse_key
operator|=
name|ShiftKeyCode
expr_stmt|;
name|event
operator|.
name|vse_direction
operator|=
operator|(
name|mask
operator|&
name|ShiftMask
operator|)
condition|?
name|VSE_KBTDOWN
else|:
name|VSE_KBTUP
expr_stmt|;
break|break;
case|case
literal|'Q'
case|:
comment|/* PF2 -- LockKey */
name|mask
operator|^=
name|ShiftLockMask
expr_stmt|;
name|event
operator|.
name|vse_key
operator|=
name|LockKeyCode
expr_stmt|;
name|event
operator|.
name|vse_direction
operator|=
operator|(
name|mask
operator|&
name|ShiftLockMask
operator|)
condition|?
name|VSE_KBTDOWN
else|:
name|VSE_KBTUP
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
comment|/* PF3 -- ControlKey */
name|mask
operator|^=
name|ControlMask
expr_stmt|;
name|event
operator|.
name|vse_key
operator|=
name|ControlKeyCode
expr_stmt|;
name|event
operator|.
name|vse_direction
operator|=
operator|(
name|mask
operator|&
name|ControlMask
operator|)
condition|?
name|VSE_KBTDOWN
else|:
name|VSE_KBTUP
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* PF4 -- MetaKey */
name|mask
operator|^=
name|MetaMask
expr_stmt|;
name|event
operator|.
name|vse_key
operator|=
name|MetaKeyCode
expr_stmt|;
name|event
operator|.
name|vse_direction
operator|=
operator|(
name|mask
operator|&
name|MetaMask
operator|)
condition|?
name|VSE_KBTDOWN
else|:
name|VSE_KBTUP
expr_stmt|;
break|break;
block|}
name|p
operator|+=
literal|3
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* "normal" key */
specifier|register
name|unsigned
name|short
name|key
init|=
name|LK201
index|[
operator|*
name|p
operator|++
index|]
decl_stmt|;
specifier|static
name|vsEvent
name|upkey
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|VSE_BUTTON
block|,
literal|0
block|,
name|VSE_KBTUP
block|,
name|VSE_DKB
block|}
decl_stmt|;
specifier|static
name|vsEvent
name|dnkey
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|VSE_BUTTON
block|,
literal|0
block|,
name|VSE_KBTDOWN
block|,
name|VSE_DKB
block|}
decl_stmt|;
name|upkey
operator|.
name|vse_time
operator|=
name|dnkey
operator|.
name|vse_time
operator|=
name|event
operator|.
name|vse_time
expr_stmt|;
comment|/* send UP for any Shift, Lock, Control, or Meta keys down */
comment|/* but not if this is a Shift or Control key */
if|if
condition|(
operator|(
name|mask
operator|&
name|ShiftMask
operator|)
operator|&&
operator|!
operator|(
name|key
operator|&
name|ShiftMask
operator|)
condition|)
block|{
name|upkey
operator|.
name|vse_key
operator|=
name|ShiftKeyCode
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|upkey
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|ShiftLockMask
condition|)
block|{
name|upkey
operator|.
name|vse_key
operator|=
name|LockKeyCode
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|upkey
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mask
operator|&
name|ControlMask
operator|)
operator|&&
operator|!
operator|(
name|key
operator|&
name|ControlMask
operator|)
condition|)
block|{
name|upkey
operator|.
name|vse_key
operator|=
name|ControlKeyCode
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|upkey
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|MetaMask
condition|)
block|{
name|upkey
operator|.
name|vse_key
operator|=
name|MetaKeyCode
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|upkey
argument_list|)
expr_stmt|;
block|}
comment|/* set up keyboard event */
name|event
operator|.
name|vse_key
operator|=
name|key
operator|&
literal|0377
expr_stmt|;
name|event
operator|.
name|vse_direction
operator|=
name|VSE_KBTRAW
expr_stmt|;
switch|switch
condition|(
name|key
operator|&
name|KEY_MASKS
condition|)
block|{
case|case
name|ShiftMask
case|:
comment|/* send Shift down if not down already */
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|ShiftMask
operator|)
condition|)
block|{
name|dnkey
operator|.
name|vse_key
operator|=
name|ShiftKeyCode
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|dnkey
argument_list|)
expr_stmt|;
block|}
comment|/* send the key */
name|Deal_with_input
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
comment|/* send Shift up */
name|upkey
operator|.
name|vse_key
operator|=
name|ShiftKeyCode
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|upkey
argument_list|)
expr_stmt|;
break|break;
case|case
name|ControlMask
case|:
comment|/* send Control down if not down already */
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|ControlMask
operator|)
condition|)
block|{
name|dnkey
operator|.
name|vse_key
operator|=
name|ControlKeyCode
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|dnkey
argument_list|)
expr_stmt|;
block|}
comment|/* send the key */
name|Deal_with_input
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
comment|/* send Control up */
name|upkey
operator|.
name|vse_key
operator|=
name|ControlKeyCode
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|upkey
argument_list|)
expr_stmt|;
break|break;
case|case
name|ShiftLockMask
case|:
case|case
name|MetaMask
case|:
default|default:
comment|/* send the key */
name|Deal_with_input
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
name|mask
operator|=
literal|0
expr_stmt|;
comment|/* nothing should be down now */
block|}
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|invalid_mouse
condition|)
operator|--
name|invalid_mouse
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	$Source: /u1/X/libis/RCS/cursor.c,v $  *	$Header: cursor.c,v 1.1 86/11/17 14:33:26 swick Rel $  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_cursor_c
init|=
literal|"$Header: cursor.c,v 1.1 86/11/17 14:33:26 swick Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|"is-copyright.h"
end_include

begin_comment
comment|/*	cursor.c - various stuff with the mouse& cursor  *  *	StoreCursor		Creates a cursor  *	FreeCursor		Frees the storage taken by a cursor  *	LoadCursor		Loads a bitmap to use as cursor  *	InitMouse		Initialize the mouse  *	SetCursorPosition	Forces cursor to a particular position  *	UpdateCursorPosition	Moves cursor to a particular position  *	SetMouseCharacteristics	Controls speed of cursor relative to mouse  *  *      Copyright (c) 1986, Integrated Solutions, Inc.  *  */
end_comment

begin_include
include|#
directive|include
file|"Xis.h"
end_include

begin_decl_stmt
specifier|static
name|CURSOR
modifier|*
name|CurrentCursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|CursorDisplayed
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|BITMAP
modifier|*
name|StoreBitmap
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|PIXMAP
modifier|*
name|MakePixmap
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|DEVICE
modifier|*
name|CurrentDevice
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *	StoreCursor  */
end_comment

begin_function
name|CURSOR
modifier|*
name|StoreCursor
parameter_list|(
name|func
parameter_list|,
name|image
parameter_list|,
name|fore
parameter_list|,
name|back
parameter_list|,
name|mask
parameter_list|,
name|xoff
parameter_list|,
name|yoff
parameter_list|)
name|int
name|func
decl_stmt|;
specifier|register
name|BITMAP
modifier|*
name|image
decl_stmt|;
specifier|register
name|int
name|fore
decl_stmt|,
name|back
decl_stmt|;
name|BITMAP
modifier|*
name|mask
decl_stmt|;
name|int
name|xoff
decl_stmt|,
name|yoff
decl_stmt|;
block|{
specifier|register
name|CURSOR
modifier|*
name|cursor
decl_stmt|;
specifier|register
name|CursPriv
modifier|*
name|data
decl_stmt|;
name|BITMAP
modifier|*
name|bitmap
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Cursor
condition|)
name|printf
argument_list|(
literal|"StoreCursor(func=%d, image=0x%x, fore=%d, back=%d, mask=0x%x,\n	xoff=%d, yoff=%d)\n"
argument_list|,
name|func
argument_list|,
name|image
argument_list|,
name|fore
argument_list|,
name|back
argument_list|,
name|mask
argument_list|,
name|xoff
argument_list|,
name|yoff
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|!
name|image
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|cursor
operator|=
operator|(
name|CURSOR
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|CURSOR
argument_list|)
argument_list|)
expr_stmt|;
name|cursor
operator|->
name|width
operator|=
name|image
operator|->
name|width
expr_stmt|;
name|cursor
operator|->
name|height
operator|=
name|image
operator|->
name|height
expr_stmt|;
name|cursor
operator|->
name|xoff
operator|=
name|xoff
expr_stmt|;
name|cursor
operator|->
name|yoff
operator|=
name|yoff
expr_stmt|;
comment|/* Only the tip need be on-screen */
name|cursor
operator|->
name|xmin
operator|=
literal|0
expr_stmt|;
name|cursor
operator|->
name|ymin
operator|=
literal|0
expr_stmt|;
name|cursor
operator|->
name|xmax
operator|=
name|CurrentDevice
operator|->
name|width
expr_stmt|;
name|cursor
operator|->
name|ymax
operator|=
name|CurrentDevice
operator|->
name|height
expr_stmt|;
name|cursor
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|data
operator|=
operator|(
name|CursPriv
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|CursPriv
argument_list|)
argument_list|)
expr_stmt|;
name|cursor
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|data
expr_stmt|;
name|data
operator|->
name|image
operator|=
name|MakePixmap
argument_list|(
name|image
argument_list|,
name|fore
argument_list|,
name|back
argument_list|)
expr_stmt|;
name|data
operator|->
name|image
operator|->
name|tile
operator|=
name|CannotBeTiled
expr_stmt|;
name|data
operator|->
name|mask
operator|=
name|mask
expr_stmt|;
if|if
condition|(
name|mask
condition|)
block|{
name|mask
operator|->
name|refcnt
operator|++
expr_stmt|;
block|}
name|data
operator|->
name|func
operator|=
name|func
expr_stmt|;
name|data
operator|->
name|fore
operator|=
name|fore
expr_stmt|;
name|data
operator|->
name|back
operator|=
name|back
expr_stmt|;
name|bitmap
operator|=
name|StoreBitmap
argument_list|(
name|image
operator|->
name|width
argument_list|,
name|image
operator|->
name|height
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|data
operator|->
name|save
operator|=
name|MakePixmap
argument_list|(
name|bitmap
argument_list|,
name|fore
argument_list|,
name|back
argument_list|)
expr_stmt|;
name|data
operator|->
name|save
operator|->
name|tile
operator|=
name|CannotBeTiled
expr_stmt|;
return|return
operator|(
name|cursor
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *	FreeCursor  */
end_comment

begin_macro
name|FreeCursor
argument_list|(
argument|cursor
argument_list|)
end_macro

begin_decl_stmt
name|CURSOR
modifier|*
name|cursor
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|CursPriv
modifier|*
name|cp
init|=
name|CDATA
argument_list|(
name|cursor
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Cursor
condition|)
name|printf
argument_list|(
literal|"FreeCursor(cursor=0x%x)\n"
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|FreePixmap
argument_list|(
name|cp
operator|->
name|image
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|->
name|mask
condition|)
block|{
name|FreeBitmap
argument_list|(
name|cp
operator|->
name|mask
argument_list|)
expr_stmt|;
block|}
name|FreePixmap
argument_list|(
name|cp
operator|->
name|save
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|cp
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|cursor
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *	LoadCursor  */
end_comment

begin_expr_stmt
name|LoadCursor
argument_list|(
name|cursor
argument_list|)
specifier|register
name|CURSOR
operator|*
name|cursor
expr_stmt|;
end_expr_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Cursor
condition|)
name|printf
argument_list|(
literal|"LoadCursor(cursor=0x%x)\n"
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|CurrentCursor
operator|!=
name|cursor
condition|)
block|{
if|if
condition|(
name|CursorDisplayed
condition|)
block|{
name|DisplayCursor
argument_list|(
operator|(
name|CURSOR
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|CurrentCursor
operator|=
name|cursor
operator|)
operator|!=
name|NULL
condition|)
block|{
name|DisplayCursor
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  *	InitMouse  */
end_comment

begin_decl_stmt
specifier|static
name|short
name|sbounds
index|[
literal|4
index|]
decl_stmt|;
end_decl_stmt

begin_macro
name|InitMouse
argument_list|()
end_macro

begin_block
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Misc
condition|)
name|printf
argument_list|(
literal|"InitMouse()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|sbounds
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|sbounds
index|[
literal|1
index|]
operator|=
name|ScreenPixmap
operator|.
name|width
expr_stmt|;
name|sbounds
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|sbounds
index|[
literal|3
index|]
operator|=
name|ScreenPixmap
operator|.
name|height
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *	SetCursorPosition  */
end_comment

begin_expr_stmt
name|SetCursorPosition
argument_list|(
name|pos
argument_list|)
specifier|register
name|vsCursor
operator|*
name|pos
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|extern
name|int
name|indev
decl_stmt|,
name|invalid_mouse
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Cursor
condition|)
name|printf
argument_list|(
literal|"SetCursorPosition(pos->x=%d, pos->y=%d)\n"
argument_list|,
name|pos
operator|->
name|x
argument_list|,
name|pos
operator|->
name|y
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|pos
operator|->
name|x
operator|!=
operator|(
name|CurrentDevice
operator|->
name|mouse
operator|->
name|x
operator|)
operator|||
name|pos
operator|->
name|y
operator|!=
operator|(
name|CurrentDevice
operator|->
name|mouse
operator|->
name|y
operator|)
condition|)
block|{
comment|/* keep mouse in sync with cursor */
name|short
name|mbounds
index|[
literal|4
index|]
decl_stmt|;
name|mbounds
index|[
literal|0
index|]
operator|=
name|mbounds
index|[
literal|1
index|]
operator|=
name|pos
operator|->
name|x
expr_stmt|;
name|mbounds
index|[
literal|2
index|]
operator|=
name|mbounds
index|[
literal|3
index|]
operator|=
name|pos
operator|->
name|y
expr_stmt|;
name|ioctl
argument_list|(
name|indev
argument_list|,
name|TIOUMBND
argument_list|,
name|mbounds
argument_list|)
expr_stmt|;
comment|/* warps mouse cursor */
name|ioctl
argument_list|(
name|indev
argument_list|,
name|TIOUMBND
argument_list|,
name|sbounds
argument_list|)
expr_stmt|;
comment|/* sets bounds back */
name|invalid_mouse
operator|=
literal|1
expr_stmt|;
name|UpdateCursorPosition
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_decl_stmt
name|vsCursor
name|last_mouse
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* last known mouse position */
end_comment

begin_comment
comment|/*  *	UpdateCursorPosition  */
end_comment

begin_expr_stmt
name|UpdateCursorPosition
argument_list|(
name|pos
argument_list|)
specifier|register
name|vsCursor
operator|*
name|pos
expr_stmt|;
end_expr_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Cursor
condition|)
name|printf
argument_list|(
literal|"UpdateCursorPosition(pos->x=%d, pos->y=%d)\n"
argument_list|,
name|pos
operator|->
name|x
argument_list|,
name|pos
operator|->
name|y
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
comment|/* assumes mouse is in sync with cursor */
if|if
condition|(
name|pos
operator|->
name|x
operator|!=
operator|(
name|CurrentDevice
operator|->
name|mouse
operator|->
name|x
operator|)
operator|||
name|pos
operator|->
name|y
operator|!=
operator|(
name|CurrentDevice
operator|->
name|mouse
operator|->
name|y
operator|)
condition|)
block|{
if|if
condition|(
name|CursorDisplayed
condition|)
block|{
name|DisplayCursor
argument_list|(
operator|(
name|CURSOR
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
operator|*
operator|(
name|CurrentDevice
operator|->
name|mouse
operator|)
operator|=
operator|*
name|pos
expr_stmt|;
name|last_mouse
operator|=
operator|*
name|pos
expr_stmt|;
comment|/* update last mouse position */
name|DisplayCursor
argument_list|(
name|CurrentCursor
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|SetMouseCharacteristics
argument_list|(
argument|threshold
argument_list|,
argument|acceleration
argument_list|)
end_macro

begin_decl_stmt
name|int
name|threshold
decl_stmt|,
name|acceleration
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|int
name|mouse_threshold
decl_stmt|,
name|mouse_acceleration
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Misc
condition|)
name|printf
argument_list|(
literal|"SetMouseCharacteristics(threshold=%d, acceleration=%d)\n"
argument_list|,
name|threshold
argument_list|,
name|acceleration
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|mouse_threshold
operator|=
name|threshold
expr_stmt|;
name|mouse_acceleration
operator|=
name|acceleration
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *	DisplayCursor  */
end_comment

begin_expr_stmt
specifier|static
name|DisplayCursor
argument_list|(
argument|cursor
argument_list|)
name|CURSOR
operator|*
name|cursor
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|vsCursor
modifier|*
name|ms
init|=
name|CurrentDevice
operator|->
name|mouse
decl_stmt|;
specifier|register
name|CursPriv
modifier|*
name|cp
init|=
name|CDATA
argument_list|(
name|cursor
argument_list|)
decl_stmt|;
specifier|register
name|int
name|x
init|=
name|ms
operator|->
name|x
decl_stmt|;
specifier|register
name|int
name|y
init|=
name|ms
operator|->
name|y
decl_stmt|;
name|CLIP
name|i
decl_stmt|;
name|CLIP
name|bc
decl_stmt|,
name|bs
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Cursor
condition|)
name|printf
argument_list|(
literal|"DisplayCursor(cursor=0x%x)\n"
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|bs
operator|.
name|left
operator|=
literal|0
expr_stmt|;
name|bs
operator|.
name|width
operator|=
name|ScreenPixmap
operator|.
name|width
expr_stmt|;
name|bs
operator|.
name|top
operator|=
literal|0
expr_stmt|;
name|bs
operator|.
name|height
operator|=
name|ScreenPixmap
operator|.
name|height
expr_stmt|;
if|if
condition|(
name|cursor
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|CurrentCursor
condition|)
block|{
comment|/* pick up cursor (put background back) */
name|cp
operator|=
name|CDATA
argument_list|(
name|CurrentCursor
argument_list|)
expr_stmt|;
name|bc
operator|.
name|left
operator|=
name|x
expr_stmt|;
name|bc
operator|.
name|width
operator|=
name|CurrentCursor
operator|->
name|width
expr_stmt|;
name|bc
operator|.
name|top
operator|=
name|y
expr_stmt|;
name|bc
operator|.
name|height
operator|=
name|CurrentCursor
operator|->
name|height
expr_stmt|;
name|i
operator|=
name|Intersection
argument_list|(
name|bc
argument_list|,
name|bs
argument_list|)
expr_stmt|;
name|GIP_RasterOp
argument_list|(
name|GIPcopy
argument_list|,
name|cp
operator|->
name|save
argument_list|,
name|i
operator|.
name|left
operator|-
name|x
argument_list|,
name|i
operator|.
name|top
operator|-
name|y
argument_list|,
operator|&
name|ScreenPixmap
argument_list|,
name|i
operator|.
name|left
argument_list|,
name|i
operator|.
name|top
argument_list|,
operator|(
name|BITMAP
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|i
operator|.
name|width
argument_list|,
name|i
operator|.
name|height
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|CursorDisplayed
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|bc
operator|.
name|left
operator|=
name|x
expr_stmt|;
name|bc
operator|.
name|width
operator|=
name|cursor
operator|->
name|width
expr_stmt|;
name|bc
operator|.
name|top
operator|=
name|y
expr_stmt|;
name|bc
operator|.
name|height
operator|=
name|cursor
operator|->
name|height
expr_stmt|;
name|i
operator|=
name|Intersection
argument_list|(
name|bc
argument_list|,
name|bs
argument_list|)
expr_stmt|;
comment|/* save background */
name|GIP_RasterOp
argument_list|(
name|GIPcopy
argument_list|,
operator|&
name|ScreenPixmap
argument_list|,
name|i
operator|.
name|left
argument_list|,
name|i
operator|.
name|top
argument_list|,
name|cp
operator|->
name|save
argument_list|,
name|i
operator|.
name|left
operator|-
name|x
argument_list|,
name|i
operator|.
name|top
operator|-
name|y
argument_list|,
operator|(
name|BITMAP
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|i
operator|.
name|width
argument_list|,
name|i
operator|.
name|height
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
comment|/* put cursor down */
name|GIP_RasterOp
argument_list|(
call|(
name|unsigned
name|char
call|)
argument_list|(
name|cp
operator|->
name|func
argument_list|)
argument_list|,
name|cp
operator|->
name|image
argument_list|,
name|i
operator|.
name|left
operator|-
name|x
argument_list|,
name|i
operator|.
name|top
operator|-
name|y
argument_list|,
operator|&
name|ScreenPixmap
argument_list|,
name|i
operator|.
name|left
argument_list|,
name|i
operator|.
name|top
argument_list|,
name|cp
operator|->
name|mask
argument_list|,
name|i
operator|.
name|left
operator|-
name|x
argument_list|,
name|i
operator|.
name|top
operator|-
name|y
argument_list|,
name|i
operator|.
name|width
argument_list|,
name|i
operator|.
name|height
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|CursorDisplayed
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  *	CheckCursor  */
end_comment

begin_macro
name|CheckCursor
argument_list|(
argument|r1
argument_list|)
end_macro

begin_decl_stmt
name|CLIP
name|r1
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|vsCursor
modifier|*
name|ms
init|=
name|CurrentDevice
operator|->
name|mouse
decl_stmt|;
specifier|register
name|CURSOR
modifier|*
name|cursor
init|=
name|CurrentCursor
decl_stmt|;
name|CLIP
name|r2
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Cursor
condition|)
block|{
name|printf
argument_list|(
literal|"CheckCursor()\n"
argument_list|)
expr_stmt|;
name|printf_clip
argument_list|(
literal|"	bounds"
argument_list|,
name|r1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|cursor
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|r2
operator|.
name|left
operator|=
name|ms
operator|->
name|x
expr_stmt|;
name|r2
operator|.
name|top
operator|=
name|ms
operator|->
name|y
expr_stmt|;
name|r2
operator|.
name|width
operator|=
name|cursor
operator|->
name|width
expr_stmt|;
name|r2
operator|.
name|height
operator|=
name|cursor
operator|->
name|height
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Cursor
condition|)
name|printf_clip
argument_list|(
literal|"	cursor"
argument_list|,
name|r2
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|CursorDisplayed
operator|&&
name|Overlap
argument_list|(
name|r1
argument_list|,
name|r2
argument_list|)
condition|)
block|{
name|DisplayCursor
argument_list|(
operator|(
name|CURSOR
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  *	RestoreCursor  */
end_comment

begin_macro
name|RestoreCursor
argument_list|()
end_macro

begin_block
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Cursor
condition|)
name|printf
argument_list|(
literal|"RestoreCursor()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|!
name|CursorDisplayed
condition|)
block|{
name|DisplayCursor
argument_list|(
name|CurrentCursor
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit


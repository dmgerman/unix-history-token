begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	$Source: /u1/X/xterm/RCS/screen.c,v $  *	$Header: screen.c,v 10.100 86/12/01 14:45:17 jg Rel $  */
end_comment

begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1984, 1985	*/
end_comment

begin_comment
comment|/* screen.c */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|csrg_id
index|[]
init|=
literal|"@(#)screen.c	1.6\t(Berkeley/CSRG)\t9/21/87"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|sccs_id
index|[]
init|=
literal|"@(#)screen.c\tX10/6.6B\t12/26/86"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|"scrollbar.h"
end_include

begin_include
include|#
directive|include
file|"ptyx.h"
end_include

begin_include
include|#
directive|include
file|"error.h"
end_include

begin_function_decl
specifier|extern
name|char
modifier|*
name|calloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|realloc
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|ScrnBuf
name|Allocate
parameter_list|(
name|nrow
parameter_list|,
name|ncol
parameter_list|)
comment|/*    allocates memory for a 2-dimensional array of chars and returns a pointer    thereto    each line is formed from a pair of char arrays.  The first (even) one is    the actual character array and the second (odd) one is the attributes.  */
specifier|register
name|int
name|nrow
decl_stmt|,
name|ncol
decl_stmt|;
block|{
specifier|register
name|ScrnBuf
name|base
decl_stmt|;
if|if
condition|(
operator|(
name|base
operator|=
operator|(
name|ScrnBuf
operator|)
name|calloc
argument_list|(
operator|(
name|nrow
operator|*=
literal|2
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|SysError
argument_list|(
name|ERROR_SCALLOC
argument_list|)
expr_stmt|;
for|for
control|(
name|nrow
operator|--
init|;
name|nrow
operator|>=
literal|0
condition|;
name|nrow
operator|--
control|)
if|if
condition|(
operator|(
name|base
index|[
name|nrow
index|]
operator|=
name|calloc
argument_list|(
name|ncol
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|SysError
argument_list|(
name|ERROR_SCALLOC2
argument_list|)
expr_stmt|;
return|return
operator|(
name|base
operator|)
return|;
block|}
end_function

begin_macro
name|ScreenWrite
argument_list|(
argument|screen
argument_list|,
argument|str
argument_list|,
argument|flags
argument_list|,
argument|length
argument_list|)
end_macro

begin_comment
comment|/*    Writes str into buf at row row and column col.  Characters are set to match    flags.  */
end_comment

begin_decl_stmt
name|Screen
modifier|*
name|screen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|unsigned
name|flags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|length
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* length of string */
end_comment

begin_block
block|{
specifier|register
name|char
modifier|*
name|att
decl_stmt|;
specifier|register
name|int
name|avail
init|=
name|screen
operator|->
name|max_col
operator|-
name|screen
operator|->
name|cur_col
operator|+
literal|1
decl_stmt|;
specifier|register
name|char
modifier|*
name|col
decl_stmt|;
if|if
condition|(
name|length
operator|>
name|avail
condition|)
name|length
operator|=
name|avail
expr_stmt|;
if|if
condition|(
name|length
operator|<=
literal|0
condition|)
return|return;
name|col
operator|=
name|screen
operator|->
name|buf
index|[
name|avail
operator|=
literal|2
operator|*
name|screen
operator|->
name|cur_row
index|]
operator|+
name|screen
operator|->
name|cur_col
expr_stmt|;
name|att
operator|=
name|screen
operator|->
name|buf
index|[
name|avail
operator|+
literal|1
index|]
operator|+
name|screen
operator|->
name|cur_col
expr_stmt|;
name|flags
operator|&=
name|ATTRIBUTES
expr_stmt|;
name|bcopy
argument_list|(
name|str
argument_list|,
name|col
argument_list|,
name|length
argument_list|)
expr_stmt|;
while|while
condition|(
name|length
operator|--
operator|>
literal|0
condition|)
operator|*
name|att
operator|++
operator|=
name|flags
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ScrnInsertLine
argument_list|(
name|sb
argument_list|,
name|last
argument_list|,
name|where
argument_list|,
name|n
argument_list|,
name|size
argument_list|)
comment|/*    Inserts n blank lines at sb + where, treating last as a bottom margin.    Size is the size of each entry in sb.    Requires: 0<= where< where + n<= last    	     n<= MAX_ROWS  */
specifier|register
name|ScrnBuf
name|sb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|last
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|where
decl_stmt|,
name|n
decl_stmt|,
name|size
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|save
index|[
literal|2
operator|*
name|MAX_ROWS
index|]
decl_stmt|;
comment|/* save n lines at bottom */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
index|[
literal|2
operator|*
operator|(
name|last
operator|-=
name|n
operator|-
literal|1
operator|)
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
name|save
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|n
argument_list|)
expr_stmt|;
comment|/* clear contents of old rows */
for|for
control|(
name|i
operator|=
literal|2
operator|*
name|n
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|save
index|[
name|i
index|]
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* move down lines */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
index|[
literal|2
operator|*
name|where
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
index|[
literal|2
operator|*
operator|(
name|where
operator|+
name|n
operator|)
index|]
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|last
operator|-
name|where
operator|)
argument_list|)
expr_stmt|;
comment|/* reuse storage for new lines at where */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|save
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
index|[
literal|2
operator|*
name|where
index|]
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|n
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ScrnDeleteLine
argument_list|(
name|sb
argument_list|,
name|last
argument_list|,
name|where
argument_list|,
name|n
argument_list|,
name|size
argument_list|)
comment|/*    Deletes n lines at sb + where, treating last as a bottom margin.    Size is the size of each entry in sb.    Requires 0<= where< where + n< = last    	    n<= MAX_ROWS  */
specifier|register
name|ScrnBuf
name|sb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|,
name|last
decl_stmt|,
name|size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|where
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|save
index|[
literal|2
operator|*
name|MAX_ROWS
index|]
decl_stmt|;
comment|/* save n lines at where */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
index|[
literal|2
operator|*
name|where
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
name|save
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|n
argument_list|)
expr_stmt|;
comment|/* clear contents of old rows */
for|for
control|(
name|i
operator|=
literal|2
operator|*
name|n
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|save
index|[
name|i
index|]
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* move up lines */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
index|[
literal|2
operator|*
operator|(
name|where
operator|+
name|n
operator|)
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
index|[
literal|2
operator|*
name|where
index|]
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
operator|(
name|last
operator|-=
name|n
operator|-
literal|1
operator|)
operator|-
name|where
operator|)
argument_list|)
expr_stmt|;
comment|/* reuse storage for new bottom lines */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|save
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
index|[
literal|2
operator|*
name|last
index|]
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|n
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ScrnInsertChar
argument_list|(
argument|sb
argument_list|,
argument|row
argument_list|,
argument|col
argument_list|,
argument|n
argument_list|,
argument|size
argument_list|)
end_macro

begin_comment
comment|/*    Inserts n blanks in sb at row, col.  Size is the size of each row.  */
end_comment

begin_decl_stmt
name|ScrnBuf
name|sb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|row
decl_stmt|,
name|size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|col
decl_stmt|,
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|char
modifier|*
name|ptr
init|=
name|sb
index|[
literal|2
operator|*
name|row
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|att
init|=
name|sb
index|[
literal|2
operator|*
name|row
operator|+
literal|1
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
name|size
operator|-
literal|1
init|;
name|i
operator|>=
name|col
operator|+
name|n
condition|;
name|i
operator|--
control|)
block|{
name|ptr
index|[
name|i
index|]
operator|=
name|ptr
index|[
name|j
operator|=
name|i
operator|-
name|n
index|]
expr_stmt|;
name|att
index|[
name|i
index|]
operator|=
name|att
index|[
name|j
index|]
expr_stmt|;
block|}
name|bzero
argument_list|(
name|ptr
operator|+
name|col
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|att
operator|+
name|col
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ScrnDeleteChar
argument_list|(
argument|sb
argument_list|,
argument|row
argument_list|,
argument|col
argument_list|,
argument|n
argument_list|,
argument|size
argument_list|)
end_macro

begin_comment
comment|/*    Deletes n characters in sb at row, col. Size is the size of each row.  */
end_comment

begin_decl_stmt
name|ScrnBuf
name|sb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|row
decl_stmt|,
name|size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|,
name|col
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|ptr
init|=
name|sb
index|[
literal|2
operator|*
name|row
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|att
init|=
name|sb
index|[
literal|2
operator|*
name|row
operator|+
literal|1
index|]
decl_stmt|;
specifier|register
name|nbytes
operator|=
operator|(
name|size
operator|-
name|n
operator|-
name|col
operator|)
expr_stmt|;
name|bcopy
argument_list|(
name|ptr
operator|+
name|col
operator|+
name|n
argument_list|,
name|ptr
operator|+
name|col
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|att
operator|+
name|col
operator|+
name|n
argument_list|,
name|att
operator|+
name|col
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ptr
operator|+
name|size
operator|-
name|n
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|att
operator|+
name|size
operator|-
name|n
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|toprow
argument_list|,
name|leftcol
argument_list|,
name|nrows
argument_list|,
name|ncols
argument_list|)
comment|/*    Repaints the area enclosed by the parameters.    Requires: (toprow, leftcol), (toprow + nrows, leftcol + ncols) are    	     coordinates of characters in screen; 	     nrows and ncols positive.  */
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|toprow
decl_stmt|,
name|leftcol
decl_stmt|,
name|nrows
decl_stmt|,
name|ncols
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|y
init|=
name|toprow
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
decl_stmt|;
specifier|register
name|int
name|row
decl_stmt|;
specifier|register
name|int
name|topline
init|=
name|screen
operator|->
name|topline
decl_stmt|;
name|int
name|maxrow
init|=
name|toprow
operator|+
name|nrows
operator|-
literal|1
decl_stmt|;
name|int
name|scrollamt
init|=
name|screen
operator|->
name|scroll_amt
decl_stmt|;
name|int
name|max
init|=
name|screen
operator|->
name|max_row
decl_stmt|;
name|int
name|dostatus
init|=
literal|0
decl_stmt|,
name|left
decl_stmt|,
name|width
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|statusline
operator|&&
name|maxrow
operator|==
name|screen
operator|->
name|max_row
operator|+
literal|1
condition|)
block|{
name|dostatus
operator|++
expr_stmt|;
name|maxrow
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|cursor_col
operator|>=
name|leftcol
operator|&&
name|screen
operator|->
name|cursor_col
operator|<=
operator|(
name|leftcol
operator|+
name|ncols
operator|-
literal|1
operator|)
operator|&&
name|screen
operator|->
name|cursor_row
operator|>=
name|toprow
operator|+
name|topline
operator|&&
name|screen
operator|->
name|cursor_row
operator|<=
name|maxrow
operator|+
name|topline
condition|)
name|screen
operator|->
name|cursor_state
operator|=
name|OFF
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
for|for
control|(
name|row
operator|=
name|toprow
init|;
name|row
operator|<=
name|maxrow
condition|;
name|y
operator|+=
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|,
name|row
operator|++
control|)
block|{
specifier|register
name|char
modifier|*
name|chars
decl_stmt|;
specifier|register
name|char
modifier|*
name|att
decl_stmt|;
specifier|register
name|int
name|col
init|=
name|leftcol
decl_stmt|;
name|int
name|maxcol
init|=
name|leftcol
operator|+
name|ncols
operator|-
literal|1
decl_stmt|;
name|int
name|lastind
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|int
name|gxfunction
decl_stmt|;
name|Font
name|fnt
decl_stmt|;
name|int
name|x
decl_stmt|,
name|yb
decl_stmt|,
name|pix
decl_stmt|,
name|n
decl_stmt|;
name|lastind
operator|=
name|row
operator|-
name|scrollamt
expr_stmt|;
if|if
condition|(
name|lastind
operator|<
literal|0
operator|||
name|lastind
operator|>
name|max
condition|)
continue|continue;
name|chars
operator|=
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
operator|(
name|lastind
operator|+
name|topline
operator|)
index|]
expr_stmt|;
name|att
operator|=
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
operator|(
name|lastind
operator|+
name|topline
operator|)
operator|+
literal|1
index|]
expr_stmt|;
while|while
condition|(
name|col
operator|<=
name|maxcol
operator|&&
operator|(
name|att
index|[
name|col
index|]
operator|&
operator|~
name|BOLD
operator|)
operator|==
literal|0
operator|&&
operator|(
name|chars
index|[
name|col
index|]
operator|&
operator|~
literal|040
operator|)
operator|==
literal|0
condition|)
name|col
operator|++
expr_stmt|;
while|while
condition|(
name|col
operator|<=
name|maxcol
operator|&&
operator|(
name|att
index|[
name|maxcol
index|]
operator|&
operator|~
name|BOLD
operator|)
operator|==
literal|0
operator|&&
operator|(
name|chars
index|[
name|maxcol
index|]
operator|&
operator|~
literal|040
operator|)
operator|==
literal|0
condition|)
name|maxcol
operator|--
expr_stmt|;
if|if
condition|(
name|col
operator|>
name|maxcol
condition|)
continue|continue;
name|flags
operator|=
name|att
index|[
name|col
index|]
expr_stmt|;
name|fnt
operator|=
name|ActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|screen
operator|->
name|fnt_icon
else|:
operator|(
name|flags
operator|&
name|BOLD
operator|)
condition|?
name|screen
operator|->
name|fnt_bold
else|:
name|screen
operator|->
name|fnt_norm
expr_stmt|;
name|x
operator|=
name|col
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
expr_stmt|;
name|lastind
operator|=
name|col
expr_stmt|;
for|for
control|(
init|;
name|col
operator|<=
name|maxcol
condition|;
name|col
operator|++
control|)
block|{
if|if
condition|(
name|att
index|[
name|col
index|]
operator|!=
name|flags
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|flags
operator|&
name|INVERSE
operator|)
operator|!=
literal|0
operator|)
operator|^
operator|(
name|dostatus
operator|<
literal|0
operator|&&
name|screen
operator|->
name|reversestatus
operator|)
condition|)
name|XText
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
operator|&
name|chars
index|[
name|lastind
index|]
argument_list|,
name|n
operator|=
name|col
operator|-
name|lastind
argument_list|,
name|fnt
argument_list|,
name|pix
operator|=
name|screen
operator|->
name|background
argument_list|,
name|screen
operator|->
name|foreground
argument_list|)
expr_stmt|;
else|else
name|XText
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
operator|&
name|chars
index|[
name|lastind
index|]
argument_list|,
name|n
operator|=
name|col
operator|-
name|lastind
argument_list|,
name|fnt
argument_list|,
name|pix
operator|=
name|screen
operator|->
name|foreground
argument_list|,
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BOLD
operator|)
operator|&&
name|screen
operator|->
name|enbolden
condition|)
name|XTextMask
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|y
argument_list|,
operator|&
name|chars
index|[
name|lastind
index|]
argument_list|,
name|n
argument_list|,
name|fnt
argument_list|,
name|pix
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|UNDERLINE
condition|)
block|{
name|yb
operator|=
name|y
operator|+
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|-
literal|2
expr_stmt|;
name|XLine
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
argument_list|,
name|yb
argument_list|,
name|x
operator|+
name|n
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|yb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|pix
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
name|x
operator|+=
operator|(
name|col
operator|-
name|lastind
operator|)
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|lastind
operator|=
name|col
expr_stmt|;
name|flags
operator|=
name|att
index|[
name|col
index|]
expr_stmt|;
name|fnt
operator|=
name|ActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|screen
operator|->
name|fnt_icon
else|:
operator|(
name|flags
operator|&
name|BOLD
operator|)
condition|?
name|screen
operator|->
name|fnt_bold
else|:
name|screen
operator|->
name|fnt_norm
expr_stmt|;
block|}
if|if
condition|(
name|chars
index|[
name|col
index|]
operator|==
literal|0
condition|)
name|chars
index|[
name|col
index|]
operator|=
literal|' '
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|flags
operator|&
name|INVERSE
operator|)
operator|!=
literal|0
operator|)
operator|^
operator|(
name|dostatus
operator|<
literal|0
operator|&&
name|screen
operator|->
name|reversestatus
operator|)
condition|)
name|XText
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
operator|&
name|chars
index|[
name|lastind
index|]
argument_list|,
name|n
operator|=
name|col
operator|-
name|lastind
argument_list|,
name|fnt
argument_list|,
name|pix
operator|=
name|screen
operator|->
name|background
argument_list|,
name|screen
operator|->
name|foreground
argument_list|)
expr_stmt|;
else|else
name|XText
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
operator|&
name|chars
index|[
name|lastind
index|]
argument_list|,
name|n
operator|=
name|col
operator|-
name|lastind
argument_list|,
name|fnt
argument_list|,
name|pix
operator|=
name|screen
operator|->
name|foreground
argument_list|,
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BOLD
operator|)
operator|&&
name|screen
operator|->
name|enbolden
condition|)
name|XTextMask
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|y
argument_list|,
operator|&
name|chars
index|[
name|lastind
index|]
argument_list|,
name|n
argument_list|,
name|fnt
argument_list|,
name|pix
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|UNDERLINE
condition|)
block|{
name|yb
operator|=
name|y
operator|+
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|-
literal|2
expr_stmt|;
name|XLine
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
argument_list|,
name|yb
argument_list|,
name|x
operator|+
name|n
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|yb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|pix
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|dostatus
operator|<=
literal|0
condition|)
break|break;
name|dostatus
operator|=
operator|-
literal|1
expr_stmt|;
name|topline
operator|=
literal|0
expr_stmt|;
name|scrollamt
operator|=
literal|0
expr_stmt|;
name|toprow
operator|=
name|maxrow
operator|=
name|max
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
name|left
operator|=
name|leftcol
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
expr_stmt|;
name|width
operator|=
name|ncols
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|leftcol
operator|==
literal|0
condition|)
block|{
name|left
operator|--
expr_stmt|;
name|width
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|leftcol
operator|+
name|ncols
operator|-
literal|1
operator|>=
name|screen
operator|->
name|max_col
condition|)
name|width
operator|++
expr_stmt|;
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|left
argument_list|,
name|y
argument_list|,
name|width
argument_list|,
name|screen
operator|->
name|statusheight
argument_list|,
name|screen
operator|->
name|reversestatus
condition|?
name|screen
operator|->
name|foreground
else|:
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|reversestatus
condition|)
name|StatusBox
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|y
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|ClearBufRows
argument_list|(
name|screen
argument_list|,
name|first
argument_list|,
name|last
argument_list|)
comment|/*    Sets the rows first though last of the buffer of screen to spaces.    Requires first<= last; first, last are rows of screen->buf.  */
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|first
decl_stmt|,
name|last
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|first
operator|*=
literal|2
expr_stmt|;
name|last
operator|=
literal|2
operator|*
name|last
operator|+
literal|1
expr_stmt|;
while|while
condition|(
name|first
operator|<=
name|last
condition|)
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
name|first
operator|++
index|]
argument_list|,
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ScreenResize
argument_list|(
name|screen
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|flags
argument_list|)
comment|/*    Resizes screen:    1. If new window would have fractional characters, sets window size so as to       discard fractional characters and returns -1.       Minimum screen size is 1 X 1.       Note that this causes another ExposeWindow event.    2. Enlarges screen->buf if necessary.  New space is appended to the bottom       and to the right    3. Reduces  screen->buf if necessary.  Old space is removed from the bottom       and from the right    4. Cursor is positioned as closely to its former position as possible    5. Sets screen->max_row and screen->max_col to reflect new size    6. Maintains the inner border.    7. Clears origin mode and sets scrolling region to be entire screen.    8. Returns 0  */
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
modifier|*
name|flags
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|rows
decl_stmt|,
name|cols
decl_stmt|;
specifier|register
name|int
name|index
decl_stmt|;
specifier|register
name|int
name|savelines
decl_stmt|;
specifier|register
name|ScrnBuf
name|sb
init|=
name|screen
operator|->
name|allbuf
decl_stmt|;
specifier|register
name|ScrnBuf
name|ab
init|=
name|screen
operator|->
name|altbuf
decl_stmt|;
specifier|register
name|int
name|x
decl_stmt|;
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
specifier|register
name|int
name|extra
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
specifier|register
name|char
modifier|*
name|sl0
decl_stmt|,
modifier|*
name|sl1
decl_stmt|;
comment|/* keep status line */
name|double
name|scale_x
decl_stmt|,
name|scale_y
decl_stmt|;
ifdef|#
directive|ifdef
name|TIOCSWINSZ
name|struct
name|winsize
name|ws
decl_stmt|;
endif|#
directive|endif
endif|TIOCSWINSZ
comment|/* don't resize on icon exposure */
if|if
condition|(
name|ActiveIcon
argument_list|(
name|screen
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|extra
operator|=
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|statusheight
expr_stmt|;
comment|/* round so that it is unlikely the screen will change size on  */
comment|/* small mouse movements.					*/
name|rows
operator|=
operator|(
name|height
operator|+
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|/
literal|2
operator|-
name|border
operator|-
name|extra
operator|)
operator|/
name|FontHeight
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|cols
operator|=
operator|(
name|width
operator|+
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|/
literal|2
operator|-
name|border
operator|-
name|screen
operator|->
name|scrollbar
operator|)
operator|/
name|FontWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|rows
operator|<
literal|1
condition|)
name|rows
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cols
operator|<
literal|1
condition|)
name|cols
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|width
operator|-
name|border
operator|-
name|screen
operator|->
name|scrollbar
operator|)
operator|%
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|!=
literal|0
operator|||
operator|(
name|height
operator|-
name|border
operator|-
name|extra
operator|)
operator|%
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|!=
literal|0
operator|||
name|rows
operator|<
name|screen
operator|->
name|minrows
condition|)
block|{
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cols
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
operator|(
name|rows
operator|<
name|screen
operator|->
name|minrows
condition|?
name|screen
operator|->
name|minrows
else|:
name|rows
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|border
operator|+
name|extra
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* change buffers if the screen has changed size */
if|if
condition|(
name|screen
operator|->
name|max_row
operator|!=
name|rows
operator|-
literal|1
operator|||
name|screen
operator|->
name|max_col
operator|!=
name|cols
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|savelines
operator|=
name|screen
operator|->
name|sb
condition|?
name|screen
operator|->
name|savelines
else|:
literal|0
expr_stmt|;
name|j
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
expr_stmt|;
name|i
operator|=
name|cols
operator|-
name|j
expr_stmt|;
name|k
operator|=
name|screen
operator|->
name|max_row
expr_stmt|;
if|if
condition|(
name|ab
condition|)
block|{
comment|/* resize current lines in alternate buf */
for|for
control|(
name|index
operator|=
name|x
operator|=
literal|0
init|;
name|index
operator|<=
name|k
condition|;
name|x
operator|+=
literal|2
operator|,
name|index
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ab
index|[
name|x
index|]
operator|=
name|realloc
argument_list|(
name|ab
index|[
name|x
index|]
argument_list|,
name|cols
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|SysError
argument_list|(
name|ERROR_SREALLOC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ab
index|[
name|x
operator|+
literal|1
index|]
operator|=
name|realloc
argument_list|(
name|ab
index|[
name|x
operator|+
literal|1
index|]
argument_list|,
name|cols
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|SysError
argument_list|(
name|ERROR_SREALLOC2
argument_list|)
expr_stmt|;
if|if
condition|(
name|cols
operator|>
name|j
condition|)
block|{
name|bzero
argument_list|(
name|ab
index|[
name|x
index|]
operator|+
name|j
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ab
index|[
name|x
operator|+
literal|1
index|]
operator|+
name|j
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* resize current lines */
name|k
operator|+=
name|savelines
operator|+
literal|1
expr_stmt|;
comment|/* includes status line */
for|for
control|(
name|index
operator|=
name|x
operator|=
literal|0
init|;
name|index
operator|<=
name|k
condition|;
name|x
operator|+=
literal|2
operator|,
name|index
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|sb
index|[
name|x
index|]
operator|=
name|realloc
argument_list|(
name|sb
index|[
name|x
index|]
argument_list|,
name|cols
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|SysError
argument_list|(
name|ERROR_SREALLOC3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sb
index|[
name|x
operator|+
literal|1
index|]
operator|=
name|realloc
argument_list|(
name|sb
index|[
name|x
operator|+
literal|1
index|]
argument_list|,
name|cols
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|SysError
argument_list|(
name|ERROR_SREALLOC4
argument_list|)
expr_stmt|;
if|if
condition|(
name|cols
operator|>
name|j
condition|)
block|{
name|bzero
argument_list|(
name|sb
index|[
name|x
index|]
operator|+
name|j
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|sb
index|[
name|x
operator|+
literal|1
index|]
operator|+
name|j
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 		 * Adjust the number of lines, either discarding the 		 * oldest (if we're getting shorter) or padding at 		 * the "old" end with blanks (if we're getting taller. 		 * 		 * Throughout this section, i is the number of lines 		 * we need, j is the number we currently have& index 		 * is the difference. 		 */
name|i
operator|=
name|rows
operator|+
name|savelines
operator|+
literal|1
expr_stmt|;
name|j
operator|=
name|screen
operator|->
name|max_row
operator|+
name|savelines
operator|+
literal|2
expr_stmt|;
name|index
operator|=
name|j
operator|-
name|i
expr_stmt|;
if|if
condition|(
name|index
operator|>
literal|0
condition|)
block|{
comment|/* we're getting shorter - free the oldest lines */
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
literal|2
operator|*
name|index
condition|;
control|)
block|{
name|free
argument_list|(
name|sb
index|[
name|x
operator|++
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* move the newer stuff into the right place */
name|k
operator|=
name|i
operator|*
literal|2
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|sb
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|sb
index|[
literal|2
operator|*
name|index
index|]
argument_list|,
name|sb
argument_list|,
name|k
argument_list|)
expr_stmt|;
name|sb
operator|=
operator|(
name|ScrnBuf
operator|)
name|realloc
argument_list|(
name|sb
argument_list|,
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sb
condition|)
name|SysError
argument_list|(
name|ERROR_RESIZE2
argument_list|)
expr_stmt|;
comment|/* do the same thing for the alternate buf */
if|if
condition|(
name|ab
condition|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
literal|2
operator|*
name|index
condition|;
control|)
block|{
name|free
argument_list|(
name|ab
index|[
name|x
operator|++
index|]
argument_list|)
expr_stmt|;
block|}
name|k
operator|=
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|sb
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|ab
index|[
literal|2
operator|*
name|index
index|]
argument_list|,
name|ab
argument_list|,
name|k
argument_list|)
expr_stmt|;
name|ab
operator|=
operator|(
name|ScrnBuf
operator|)
name|realloc
argument_list|(
name|ab
argument_list|,
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ab
condition|)
name|SysError
argument_list|(
name|ERROR_RESIZE
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|index
operator|<
literal|0
condition|)
block|{
comment|/* we're getting taller - add 'index' lines */
comment|/* at the "old" end of the saved lines */
name|sb
operator|=
operator|(
name|ScrnBuf
operator|)
name|realloc
argument_list|(
name|sb
argument_list|,
name|i
operator|*
literal|2
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|sb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sb
condition|)
name|SysError
argument_list|(
name|ERROR_RESIZE2
argument_list|)
expr_stmt|;
comment|/* move up the stuff we want at the new end */
comment|/* of the buffer and fill the hole with blanks */
name|k
operator|=
operator|-
literal|2
operator|*
name|index
expr_stmt|;
name|bcopy
argument_list|(
name|sb
argument_list|,
operator|&
name|sb
index|[
name|k
index|]
argument_list|,
name|j
operator|*
literal|2
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|sb
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|k
condition|;
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|sb
index|[
name|x
operator|++
index|]
operator|=
name|calloc
argument_list|(
name|cols
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|sb
argument_list|)
argument_list|)
operator|)
condition|)
name|SysError
argument_list|(
name|ERROR_RESIZROW3
argument_list|)
expr_stmt|;
block|}
comment|/* do the same thing with the alternate buffer */
if|if
condition|(
name|ab
condition|)
block|{
name|ab
operator|=
operator|(
name|ScrnBuf
operator|)
name|realloc
argument_list|(
name|ab
argument_list|,
name|rows
operator|*
literal|2
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|ab
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ab
condition|)
name|SysError
argument_list|(
name|ERROR_RESIZE
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|ab
argument_list|,
operator|&
name|ab
index|[
name|k
index|]
argument_list|,
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|*
literal|2
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|ab
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|k
condition|;
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|ab
index|[
name|x
operator|++
index|]
operator|=
name|calloc
argument_list|(
name|cols
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|ab
argument_list|)
argument_list|)
operator|)
condition|)
name|SysError
argument_list|(
name|ERROR_RESIZROW4
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|screen
operator|->
name|allbuf
operator|=
name|sb
expr_stmt|;
name|screen
operator|->
name|buf
operator|=
operator|&
name|sb
index|[
literal|2
operator|*
name|savelines
index|]
expr_stmt|;
name|screen
operator|->
name|altbuf
operator|=
name|ab
expr_stmt|;
comment|/* add the new lines to the old screen size& pos */
name|screen
operator|->
name|max_row
operator|-=
name|index
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
name|screen
operator|->
name|cur_row
operator|-=
name|index
expr_stmt|;
else|else
name|screen
operator|->
name|cur_row
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
name|screen
operator|->
name|max_row
operator|=
name|rows
operator|-
literal|1
expr_stmt|;
name|screen
operator|->
name|max_col
operator|=
name|cols
operator|-
literal|1
expr_stmt|;
comment|/* adjust scrolling region */
name|screen
operator|->
name|top_marg
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|bot_marg
operator|=
name|screen
operator|->
name|max_row
expr_stmt|;
operator|*
name|flags
operator|&=
operator|~
name|ORIGIN
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|>
name|screen
operator|->
name|max_row
condition|)
name|screen
operator|->
name|cur_row
operator|=
name|screen
operator|->
name|max_row
expr_stmt|;
elseif|else
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|<
literal|0
condition|)
name|screen
operator|->
name|cur_row
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_col
operator|>
name|screen
operator|->
name|max_col
condition|)
name|screen
operator|->
name|cur_col
operator|=
name|screen
operator|->
name|max_col
expr_stmt|;
elseif|else
if|if
condition|(
name|screen
operator|->
name|cur_col
operator|<
literal|0
condition|)
name|screen
operator|->
name|cur_col
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|height
operator|=
name|height
operator|-
name|extra
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|width
operator|=
name|width
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|active_icon
condition|)
name|SetIconSize
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FullHeight
argument_list|(
name|screen
argument_list|)
operator|==
name|height
operator|&&
name|FullWidth
argument_list|(
name|screen
argument_list|)
operator|==
name|width
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* nothing has changed at all */
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
name|ResizeScrollBar
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
name|width
operator|-
name|SCROLLBARWIDTH
argument_list|,
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
argument_list|,
name|height
operator|-
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|rows
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|title
operator|.
name|tbar
operator|&&
name|FullWidth
argument_list|(
name|screen
argument_list|)
operator|!=
name|width
condition|)
name|VTTitleResize
argument_list|(
name|width
argument_list|)
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|fullheight
operator|=
name|height
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|fullwidth
operator|=
name|width
expr_stmt|;
ifdef|#
directive|ifdef
name|TIOCSWINSZ
comment|/* Set tty's idea of window size */
name|ws
operator|.
name|ws_row
operator|=
name|rows
expr_stmt|;
name|ws
operator|.
name|ws_col
operator|=
name|cols
expr_stmt|;
name|ws
operator|.
name|ws_xpixel
operator|=
name|width
expr_stmt|;
name|ws
operator|.
name|ws_ypixel
operator|=
name|height
expr_stmt|;
name|ioctl
argument_list|(
name|screen
operator|->
name|respond
argument_list|,
name|TIOCSWINSZ
argument_list|,
operator|&
name|ws
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SIGWINCH
if|if
condition|(
name|screen
operator|->
name|pid
operator|>
literal|1
condition|)
name|killpg
argument_list|(
name|getpgrp
argument_list|(
name|screen
operator|->
name|pid
argument_list|)
argument_list|,
name|SIGWINCH
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SIGWINCH
endif|#
directive|endif
endif|TIOCSWINSZ
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|SetIconSize
argument_list|(
argument|screen
argument_list|)
end_macro

begin_decl_stmt
name|Screen
modifier|*
name|screen
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|screen
operator|->
name|active_icon
condition|)
block|{
name|screen
operator|->
name|iconVwin
operator|.
name|width
operator|=
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
operator|*
name|screen
operator|->
name|iconVwin
operator|.
name|f_width
operator|+
name|screen
operator|->
name|border
operator|*
literal|2
expr_stmt|;
name|screen
operator|->
name|iconVwin
operator|.
name|height
operator|=
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|*
name|screen
operator|->
name|iconVwin
operator|.
name|f_height
operator|+
name|screen
operator|->
name|border
operator|*
literal|2
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|iconVwin
operator|.
name|width
argument_list|,
name|screen
operator|->
name|iconVwin
operator|.
name|height
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|IconRecalc
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|iconVwin
operator|.
name|fullwidth
operator|=
name|screen
operator|->
name|iconVwin
operator|.
name|width
expr_stmt|;
name|screen
operator|->
name|iconVwin
operator|.
name|fullheight
operator|=
name|screen
operator|->
name|iconVwin
operator|.
name|height
expr_stmt|;
block|}
end_block

end_unit


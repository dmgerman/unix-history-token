begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	$Source: /u1/X/xterm/RCS/charproc.c,v $  *	$Header: charproc.c,v 10.102 86/12/02 11:37:25 swick Exp $  */
end_comment

begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright (c) 1985 Massachusetts Institute of Technology		*/
end_comment

begin_comment
comment|/* Copyright (c) 1985	Digital Equipment Corporation			*/
end_comment

begin_comment
comment|/* charproc.c */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|"scrollbar.h"
end_include

begin_include
include|#
directive|include
file|"ptyx.h"
end_include

begin_include
include|#
directive|include
file|"VTparse.h"
end_include

begin_include
include|#
directive|include
file|"data.h"
end_include

begin_include
include|#
directive|include
file|"error.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|MODEMENU
end_ifdef

begin_include
include|#
directive|include
file|"menu.h"
end_include

begin_endif
endif|#
directive|endif
endif|MODEMENU
end_endif

begin_define
define|#
directive|define
name|DEFAULT
value|-1
end_define

begin_define
define|#
directive|define
name|TEXT_BUF_SIZE
value|256
end_define

begin_define
define|#
directive|define
name|input
parameter_list|()
value|(bcnt--> 0 ? *bptr++ : in_put())
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|csrg_id
index|[]
init|=
literal|"@(#)charproc.c	1.6\t(Berkeley/CSRG)\t9/21/87"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|sccs_id
index|[]
init|=
literal|"@(#)charproc.c\tX10/6.6B\t1/9/87"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_decl_stmt
specifier|static
name|long
name|arg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ch
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nparam
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ANSI
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|param
index|[
name|NPARAM
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|long
name|ctotal
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|long
name|ntotal
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|jmp_buf
name|vtjmpbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|groundtable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|csitable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|dectable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|eigtable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|esctable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|iestable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|igntable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|scrtable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|scstable
index|[]
decl_stmt|;
end_decl_stmt

begin_macro
name|VTparse
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
modifier|*
name|parsestate
init|=
name|groundtable
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|row
decl_stmt|,
name|col
decl_stmt|,
name|top
decl_stmt|,
name|bot
decl_stmt|,
name|scstype
decl_stmt|;
name|WindowInfo
name|wininfo
decl_stmt|;
specifier|extern
name|int
name|bitset
argument_list|()
decl_stmt|,
name|bitclr
argument_list|()
decl_stmt|,
name|finput
argument_list|()
decl_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|vtjmpbuf
argument_list|)
condition|)
name|parsestate
operator|=
name|groundtable
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
switch|switch
condition|(
name|parsestate
index|[
name|c
operator|=
name|input
argument_list|()
index|]
condition|)
block|{
case|case
name|CASE_GROUND_STATE
case|:
comment|/* exit ignore mode */
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_IGNORE_STATE
case|:
comment|/* Ies: ignore anything else */
name|parsestate
operator|=
name|igntable
expr_stmt|;
break|break;
case|case
name|CASE_IGNORE_ESC
case|:
comment|/* Ign: escape */
name|parsestate
operator|=
name|iestable
expr_stmt|;
break|break;
case|case
name|CASE_IGNORE
case|:
comment|/* Ignore character */
break|break;
case|case
name|CASE_BELL
case|:
comment|/* bell */
name|Bell
argument_list|()
expr_stmt|;
break|break;
case|case
name|CASE_BS
case|:
comment|/* backspace */
name|CursorBack
argument_list|(
name|screen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|CASE_CR
case|:
comment|/* carriage return */
name|CarriageReturn
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
name|CASE_ESC
case|:
comment|/* escape */
name|parsestate
operator|=
name|esctable
expr_stmt|;
break|break;
case|case
name|CASE_VMOT
case|:
comment|/* 			 * form feed, line feed, vertical tab, but not in 			 * status line 			 */
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
name|Index
argument_list|(
name|screen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|term
operator|.
name|flags
operator|&
name|LINEFEED
condition|)
name|CarriageReturn
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|display
operator|->
name|qlen
operator|>
literal|0
operator|||
operator|(
name|ioctl
argument_list|(
name|screen
operator|->
name|display
operator|->
name|fd
argument_list|,
name|FIONREAD
argument_list|,
operator|&
name|arg
argument_list|)
operator|,
name|arg
operator|)
operator|>
literal|0
condition|)
name|xevents
argument_list|()
expr_stmt|;
break|break;
case|case
name|CASE_TAB
case|:
comment|/* tab */
name|screen
operator|->
name|cur_col
operator|=
name|TabNext
argument_list|(
name|term
operator|.
name|tabs
argument_list|,
name|screen
operator|->
name|cur_col
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_col
operator|>
name|screen
operator|->
name|max_col
condition|)
name|screen
operator|->
name|cur_col
operator|=
name|screen
operator|->
name|max_col
expr_stmt|;
break|break;
case|case
name|CASE_SI
case|:
name|screen
operator|->
name|curgl
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|CASE_SO
case|:
name|screen
operator|->
name|curgl
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CASE_SCR_STATE
case|:
comment|/* enter scr state */
name|parsestate
operator|=
name|scrtable
expr_stmt|;
break|break;
case|case
name|CASE_SCS0_STATE
case|:
comment|/* enter scs state 0 */
name|scstype
operator|=
literal|0
expr_stmt|;
name|parsestate
operator|=
name|scstable
expr_stmt|;
break|break;
case|case
name|CASE_SCS1_STATE
case|:
comment|/* enter scs state 1 */
name|scstype
operator|=
literal|1
expr_stmt|;
name|parsestate
operator|=
name|scstable
expr_stmt|;
break|break;
case|case
name|CASE_SCS2_STATE
case|:
comment|/* enter scs state 2 */
name|scstype
operator|=
literal|2
expr_stmt|;
name|parsestate
operator|=
name|scstable
expr_stmt|;
break|break;
case|case
name|CASE_SCS3_STATE
case|:
comment|/* enter scs state 3 */
name|scstype
operator|=
literal|3
expr_stmt|;
name|parsestate
operator|=
name|scstable
expr_stmt|;
break|break;
case|case
name|CASE_ESC_IGNORE
case|:
comment|/* unknown escape sequence */
name|parsestate
operator|=
name|eigtable
expr_stmt|;
break|break;
case|case
name|CASE_ESC_DIGIT
case|:
comment|/* digit in csi or dec mode */
if|if
condition|(
operator|(
name|row
operator|=
name|param
index|[
name|nparam
operator|-
literal|1
index|]
operator|)
operator|==
name|DEFAULT
condition|)
name|row
operator|=
literal|0
expr_stmt|;
name|param
index|[
name|nparam
operator|-
literal|1
index|]
operator|=
literal|10
operator|*
name|row
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
break|break;
case|case
name|CASE_ESC_SEMI
case|:
comment|/* semicolon in csi or dec mode */
name|param
index|[
name|nparam
operator|++
index|]
operator|=
name|DEFAULT
expr_stmt|;
break|break;
case|case
name|CASE_DEC_STATE
case|:
comment|/* enter dec mode */
name|parsestate
operator|=
name|dectable
expr_stmt|;
break|break;
case|case
name|CASE_ICH
case|:
comment|/* ICH */
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|c
operator|=
literal|1
expr_stmt|;
name|InsertChar
argument_list|(
name|screen
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_CUU
case|:
comment|/* CUU */
comment|/* only if not in status line */
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|c
operator|=
literal|1
expr_stmt|;
name|CursorUp
argument_list|(
name|screen
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_CUD
case|:
comment|/* CUD */
comment|/* only if not in status line */
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|c
operator|=
literal|1
expr_stmt|;
name|CursorDown
argument_list|(
name|screen
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_CUF
case|:
comment|/* CUF */
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|c
operator|=
literal|1
expr_stmt|;
name|CursorForward
argument_list|(
name|screen
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_CUB
case|:
comment|/* CUB */
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|c
operator|=
literal|1
expr_stmt|;
name|CursorBack
argument_list|(
name|screen
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_CUP
case|:
comment|/* CUP | HVP */
comment|/* only if not in status line */
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|(
name|row
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|row
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|nparam
operator|<
literal|2
operator|||
operator|(
name|col
operator|=
name|param
index|[
literal|1
index|]
operator|)
operator|<
literal|1
condition|)
name|col
operator|=
literal|1
expr_stmt|;
name|CursorSet
argument_list|(
name|screen
argument_list|,
name|row
operator|-
literal|1
argument_list|,
name|col
operator|-
literal|1
argument_list|,
name|term
operator|.
name|flags
argument_list|)
expr_stmt|;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_ED
case|:
comment|/* ED */
switch|switch
condition|(
name|param
index|[
literal|0
index|]
condition|)
block|{
case|case
name|DEFAULT
case|:
case|case
literal|0
case|:
if|if
condition|(
name|screen
operator|->
name|instatus
condition|)
name|ClearRight
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|ClearBelow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
if|if
condition|(
name|screen
operator|->
name|instatus
condition|)
name|ClearLeft
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|ClearAbove
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|screen
operator|->
name|instatus
condition|)
name|ClearLine
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|ClearScreen
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_EL
case|:
comment|/* EL */
switch|switch
condition|(
name|param
index|[
literal|0
index|]
condition|)
block|{
case|case
name|DEFAULT
case|:
case|case
literal|0
case|:
name|ClearRight
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|ClearLeft
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|ClearLine
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_IL
case|:
comment|/* IL */
comment|/* only if not in status line */
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|c
operator|=
literal|1
expr_stmt|;
name|InsertLine
argument_list|(
name|screen
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DL
case|:
comment|/* DL */
comment|/* only if not in status line */
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|c
operator|=
literal|1
expr_stmt|;
name|DeleteLine
argument_list|(
name|screen
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DCH
case|:
comment|/* DCH */
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|c
operator|=
literal|1
expr_stmt|;
name|DeleteChar
argument_list|(
name|screen
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DA1
case|:
comment|/* DA1 */
if|if
condition|(
name|param
index|[
literal|0
index|]
operator|<=
literal|0
condition|)
block|{
comment|/* less than means DEFAULT */
name|reply
operator|.
name|a_type
operator|=
name|CSI
expr_stmt|;
name|reply
operator|.
name|a_pintro
operator|=
literal|'?'
expr_stmt|;
name|reply
operator|.
name|a_nparam
operator|=
literal|2
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
comment|/* VT102 */
name|reply
operator|.
name|a_param
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
comment|/* VT102 */
name|reply
operator|.
name|a_inters
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_final
operator|=
literal|'c'
expr_stmt|;
name|unparseseq
argument_list|(
operator|&
name|reply
argument_list|,
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_TBC
case|:
comment|/* TBC */
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<=
literal|0
condition|)
comment|/* less than means default */
name|TabClear
argument_list|(
name|term
operator|.
name|tabs
argument_list|,
name|screen
operator|->
name|cur_col
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|3
condition|)
name|TabZonk
argument_list|(
name|term
operator|.
name|tabs
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_SET
case|:
comment|/* SET */
name|modes
argument_list|(
operator|&
name|term
argument_list|,
name|bitset
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_RST
case|:
comment|/* RST */
name|modes
argument_list|(
operator|&
name|term
argument_list|,
name|bitclr
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_SGR
case|:
comment|/* SGR */
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|nparam
condition|;
operator|++
name|c
control|)
block|{
switch|switch
condition|(
name|param
index|[
name|c
index|]
condition|)
block|{
case|case
name|DEFAULT
case|:
case|case
literal|0
case|:
name|term
operator|.
name|flags
operator|&=
operator|~
operator|(
name|INVERSE
operator||
name|BOLD
operator||
name|UNDERLINE
operator|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
case|case
literal|5
case|:
comment|/* Blink, really.	*/
name|term
operator|.
name|flags
operator||=
name|BOLD
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* Underscore		*/
name|term
operator|.
name|flags
operator||=
name|UNDERLINE
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|term
operator|.
name|flags
operator||=
name|INVERSE
expr_stmt|;
block|}
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_CPR
case|:
comment|/* CPR */
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|==
literal|5
condition|)
block|{
name|reply
operator|.
name|a_type
operator|=
name|CSI
expr_stmt|;
name|reply
operator|.
name|a_pintro
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_nparam
operator|=
literal|1
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_inters
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_final
operator|=
literal|'n'
expr_stmt|;
name|unparseseq
argument_list|(
operator|&
name|reply
argument_list|,
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|6
condition|)
block|{
name|reply
operator|.
name|a_type
operator|=
name|CSI
expr_stmt|;
name|reply
operator|.
name|a_pintro
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_nparam
operator|=
literal|2
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|0
index|]
operator|=
name|screen
operator|->
name|cur_row
operator|+
literal|1
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|1
index|]
operator|=
name|screen
operator|->
name|cur_col
operator|+
literal|1
expr_stmt|;
name|reply
operator|.
name|a_inters
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_final
operator|=
literal|'R'
expr_stmt|;
name|unparseseq
argument_list|(
operator|&
name|reply
argument_list|,
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DECSTBM
case|:
comment|/* DECSTBM */
comment|/* only if not in status line */
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|(
name|top
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|top
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|nparam
operator|<
literal|2
operator|||
operator|(
name|bot
operator|=
name|param
index|[
literal|1
index|]
operator|)
operator|==
name|DEFAULT
operator|||
name|bot
operator|>
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|||
name|bot
operator|==
literal|0
condition|)
name|bot
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|bot
operator|>
name|top
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|top_marg
operator|=
name|top
operator|-
literal|1
expr_stmt|;
name|screen
operator|->
name|bot_marg
operator|=
name|bot
operator|-
literal|1
expr_stmt|;
name|CursorSet
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|term
operator|.
name|flags
argument_list|)
expr_stmt|;
block|}
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_SUN_EMU
case|:
comment|/* sub-set of sun tty emulation */
switch|switch
condition|(
name|param
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|3
case|:
comment|/* move window */
if|if
condition|(
name|nparam
operator|==
literal|3
condition|)
block|{
name|XMoveWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|param
index|[
literal|2
index|]
argument_list|,
name|param
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|XSync
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|/* synchronize */
if|if
condition|(
name|QLength
argument_list|()
operator|>
literal|0
condition|)
name|xevents
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
comment|/* resize window (pixels) */
if|if
condition|(
name|nparam
operator|==
literal|3
condition|)
block|{
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|param
index|[
literal|1
index|]
argument_list|,
name|param
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|XSync
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|/* synchronize */
if|if
condition|(
name|QLength
argument_list|()
operator|>
literal|0
condition|)
name|xevents
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|5
case|:
comment|/* raise window */
name|XRaiseWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* lower window */
name|XLowerWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* redisplay window */
name|Redraw
argument_list|()
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* resize window (rows and columns) */
if|if
condition|(
name|nparam
operator|==
literal|3
condition|)
block|{
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|*
name|param
index|[
literal|2
index|]
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
name|param
index|[
literal|1
index|]
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
argument_list|)
expr_stmt|;
name|XSync
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|/* synchronize */
if|if
condition|(
name|QLength
argument_list|()
operator|>
literal|0
condition|)
name|xevents
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|13
case|:
comment|/* send window position */
name|XQueryWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
operator|&
name|wininfo
argument_list|)
expr_stmt|;
name|reply
operator|.
name|a_type
operator|=
name|CSI
expr_stmt|;
name|reply
operator|.
name|a_pintro
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_nparam
operator|=
literal|3
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|0
index|]
operator|=
literal|3
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|1
index|]
operator|=
name|wininfo
operator|.
name|y
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|2
index|]
operator|=
name|wininfo
operator|.
name|x
expr_stmt|;
name|reply
operator|.
name|a_inters
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_final
operator|=
literal|'t'
expr_stmt|;
name|unparseseq
argument_list|(
operator|&
name|reply
argument_list|,
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
break|break;
case|case
literal|14
case|:
comment|/* send window size (pixels) */
name|reply
operator|.
name|a_type
operator|=
name|CSI
expr_stmt|;
name|reply
operator|.
name|a_pintro
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_nparam
operator|=
literal|3
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|0
index|]
operator|=
literal|4
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|1
index|]
operator|=
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|screen
operator|->
name|scrollbar
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|2
index|]
operator|=
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
expr_stmt|;
name|reply
operator|.
name|a_inters
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_final
operator|=
literal|'t'
expr_stmt|;
name|unparseseq
argument_list|(
operator|&
name|reply
argument_list|,
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
break|break;
case|case
literal|18
case|:
comment|/* send window size (rows and cols) */
name|reply
operator|.
name|a_type
operator|=
name|CSI
expr_stmt|;
name|reply
operator|.
name|a_pintro
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_nparam
operator|=
literal|3
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|0
index|]
operator|=
literal|8
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|1
index|]
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|2
index|]
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
expr_stmt|;
name|reply
operator|.
name|a_inters
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_final
operator|=
literal|'t'
expr_stmt|;
name|unparseseq
argument_list|(
operator|&
name|reply
argument_list|,
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
break|break;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DECREQTPARM
case|:
comment|/* DECREQTPARM */
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|==
name|DEFAULT
condition|)
name|c
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
operator|||
name|c
operator|==
literal|1
condition|)
block|{
name|reply
operator|.
name|a_type
operator|=
name|CSI
expr_stmt|;
name|reply
operator|.
name|a_pintro
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_nparam
operator|=
literal|7
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|0
index|]
operator|=
name|c
operator|+
literal|2
expr_stmt|;
name|reply
operator|.
name|a_param
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
comment|/* no parity */
name|reply
operator|.
name|a_param
index|[
literal|2
index|]
operator|=
literal|1
expr_stmt|;
comment|/* eight bits */
name|reply
operator|.
name|a_param
index|[
literal|3
index|]
operator|=
literal|112
expr_stmt|;
comment|/* transmit 9600 baud */
name|reply
operator|.
name|a_param
index|[
literal|4
index|]
operator|=
literal|112
expr_stmt|;
comment|/* receive 9600 baud */
name|reply
operator|.
name|a_param
index|[
literal|5
index|]
operator|=
literal|1
expr_stmt|;
comment|/* clock multiplier ? */
name|reply
operator|.
name|a_param
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
comment|/* STP flags ? */
name|reply
operator|.
name|a_inters
operator|=
literal|0
expr_stmt|;
name|reply
operator|.
name|a_final
operator|=
literal|'x'
expr_stmt|;
name|unparseseq
argument_list|(
operator|&
name|reply
argument_list|,
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
block|}
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DECSET
case|:
comment|/* DECSET */
name|dpmodes
argument_list|(
operator|&
name|term
argument_list|,
name|bitset
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
return|return;
break|break;
case|case
name|CASE_DECRST
case|:
comment|/* DECRST */
name|dpmodes
argument_list|(
operator|&
name|term
argument_list|,
name|bitclr
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_HIDDEN
case|:
comment|/* special "hidden" sequence */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"avg call = %ld char\n"
argument_list|,
name|ctotal
operator|/
name|ntotal
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DECALN
case|:
comment|/* DECALN */
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
for|for
control|(
name|row
operator|=
name|screen
operator|->
name|max_row
init|;
name|row
operator|>=
literal|0
condition|;
name|row
operator|--
control|)
block|{
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
name|row
operator|+
literal|1
index|]
argument_list|,
name|col
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
name|row
index|]
init|;
name|col
operator|>
literal|0
condition|;
name|col
operator|--
control|)
operator|*
name|cp
operator|++
operator|=
literal|'E'
expr_stmt|;
block|}
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_GSETS
case|:
name|screen
operator|->
name|gsets
index|[
name|scstype
index|]
operator|=
name|c
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DECSC
case|:
comment|/* DECSC */
name|CursorSave
argument_list|(
operator|&
name|term
argument_list|,
operator|&
name|screen
operator|->
name|sc
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DECRC
case|:
comment|/* DECRC */
name|CursorRestore
argument_list|(
operator|&
name|term
argument_list|,
operator|&
name|screen
operator|->
name|sc
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DECKPAM
case|:
comment|/* DECKPAM */
name|term
operator|.
name|keyboard
operator|.
name|flags
operator||=
name|KYPD_APL
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_DECKPNM
case|:
comment|/* DECKPNM */
name|term
operator|.
name|keyboard
operator|.
name|flags
operator|&=
operator|~
name|KYPD_APL
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_IND
case|:
comment|/* IND */
comment|/* only if not in status line */
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
name|Index
argument_list|(
name|screen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|display
operator|->
name|qlen
operator|>
literal|0
operator|||
operator|(
name|ioctl
argument_list|(
name|screen
operator|->
name|display
operator|->
name|fd
argument_list|,
name|FIONREAD
argument_list|,
operator|&
name|arg
argument_list|)
operator|,
name|arg
operator|)
operator|>
literal|0
condition|)
name|xevents
argument_list|()
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_NEL
case|:
comment|/* NEL */
comment|/* only if not in status line */
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
name|Index
argument_list|(
name|screen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CarriageReturn
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|display
operator|->
name|qlen
operator|>
literal|0
operator|||
operator|(
name|ioctl
argument_list|(
name|screen
operator|->
name|display
operator|->
name|fd
argument_list|,
name|FIONREAD
argument_list|,
operator|&
name|arg
argument_list|)
operator|,
name|arg
operator|)
operator|>
literal|0
condition|)
name|xevents
argument_list|()
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_HTS
case|:
comment|/* HTS */
name|TabSet
argument_list|(
name|term
operator|.
name|tabs
argument_list|,
name|screen
operator|->
name|cur_col
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_RI
case|:
comment|/* RI */
comment|/* only if not in status line */
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
name|RevIndex
argument_list|(
name|screen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_SS2
case|:
comment|/* SS2 */
name|screen
operator|->
name|curss
operator|=
literal|2
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_SS3
case|:
comment|/* SS3 */
name|screen
operator|->
name|curss
operator|=
literal|3
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_CSI_STATE
case|:
comment|/* enter csi state */
name|nparam
operator|=
literal|1
expr_stmt|;
name|param
index|[
literal|0
index|]
operator|=
name|DEFAULT
expr_stmt|;
name|parsestate
operator|=
name|csitable
expr_stmt|;
break|break;
case|case
name|CASE_OSC
case|:
comment|/* do osc escapes */
name|do_osc
argument_list|(
name|finput
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_RIS
case|:
comment|/* RIS */
name|VTReset
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_LS2
case|:
comment|/* LS2 */
name|screen
operator|->
name|curgl
operator|=
literal|2
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_LS3
case|:
comment|/* LS3 */
name|screen
operator|->
name|curgl
operator|=
literal|3
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_LS3R
case|:
comment|/* LS3R */
name|screen
operator|->
name|curgr
operator|=
literal|3
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_LS2R
case|:
comment|/* LS2R */
name|screen
operator|->
name|curgr
operator|=
literal|2
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_LS1R
case|:
comment|/* LS1R */
name|screen
operator|->
name|curgr
operator|=
literal|1
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_TO_STATUS
case|:
if|if
condition|(
operator|(
name|c
operator|=
name|param
index|[
literal|0
index|]
operator|)
operator|<
literal|1
condition|)
name|c
operator|=
literal|1
expr_stmt|;
name|ToStatus
argument_list|(
name|c
operator|-
literal|1
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_FROM_STATUS
case|:
name|FromStatus
argument_list|()
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_SHOW_STATUS
case|:
name|ShowStatus
argument_list|()
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_HIDE_STATUS
case|:
name|HideStatus
argument_list|()
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_ERASE_STATUS
case|:
name|EraseStatus
argument_list|()
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_XTERM_SAVE
case|:
name|savemodes
argument_list|(
operator|&
name|term
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_XTERM_RESTORE
case|:
name|restoremodes
argument_list|(
operator|&
name|term
argument_list|)
expr_stmt|;
name|parsestate
operator|=
name|groundtable
expr_stmt|;
break|break;
case|case
name|CASE_PRINT
case|:
comment|/* printable characters */
name|top
operator|=
name|bcnt
operator|>
name|TEXT_BUF_SIZE
condition|?
name|TEXT_BUF_SIZE
else|:
name|bcnt
expr_stmt|;
name|cp
operator|=
name|bptr
expr_stmt|;
operator|*
operator|--
name|bptr
operator|=
name|c
expr_stmt|;
while|while
condition|(
name|top
operator|>
literal|0
operator|&&
name|isprint
argument_list|(
operator|*
name|cp
argument_list|)
condition|)
block|{
name|top
operator|--
expr_stmt|;
name|bcnt
operator|--
expr_stmt|;
name|cp
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|curss
condition|)
block|{
name|dotext
argument_list|(
name|screen
argument_list|,
name|term
operator|.
name|flags
argument_list|,
name|screen
operator|->
name|gsets
index|[
name|screen
operator|->
name|curss
index|]
argument_list|,
name|bptr
argument_list|,
name|bptr
operator|+
literal|1
argument_list|)
expr_stmt|;
name|screen
operator|->
name|curss
operator|=
literal|0
expr_stmt|;
name|bptr
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|bptr
operator|<
name|cp
condition|)
name|dotext
argument_list|(
name|screen
argument_list|,
name|term
operator|.
name|flags
argument_list|,
name|screen
operator|->
name|gsets
index|[
name|screen
operator|->
name|curgl
index|]
argument_list|,
name|bptr
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|bptr
operator|=
name|cp
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_macro
name|finput
argument_list|()
end_macro

begin_block
block|{
return|return
operator|(
name|input
argument_list|()
operator|)
return|;
block|}
end_block

begin_decl_stmt
specifier|static
name|int
name|select_mask
decl_stmt|;
end_decl_stmt

begin_macro
name|in_put
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|select_mask
operator|=
name|pty_mask
expr_stmt|;
comment|/* force initial read */
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|select_mask
operator|&
name|pty_mask
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
name|FlushLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|bcnt
operator|=
name|read
argument_list|(
name|screen
operator|->
name|respond
argument_list|,
name|bptr
operator|=
name|buffer
argument_list|,
name|BUF_SIZE
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EIO
operator|&&
name|am_slave
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|errno
operator|!=
name|EWOULDBLOCK
condition|)
name|Panic
argument_list|(
literal|"input: read returned unexpected error (%d)\n"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bcnt
operator|==
literal|0
condition|)
name|Panic
argument_list|(
literal|"input: read returned zero\n"
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* strip parity bit */
for|for
control|(
name|i
operator|=
name|bcnt
operator|,
name|cp
operator|=
name|bptr
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
operator|*
name|cp
operator|++
operator|&=
name|CHAR
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|sb
operator|&&
name|screen
operator|->
name|scrollinput
operator|&&
name|screen
operator|->
name|topline
operator|<
literal|0
condition|)
name|ScrollToBottom
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|&&
operator|!
name|screen
operator|->
name|iconinput
condition|)
block|{
name|screen
operator|->
name|iconinput
operator|=
name|TRUE
expr_stmt|;
name|IconBox
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_set
operator|&&
operator|(
name|screen
operator|->
name|cursor_col
operator|!=
name|screen
operator|->
name|cur_col
operator|||
name|screen
operator|->
name|cursor_row
operator|!=
name|screen
operator|->
name|cur_row
operator|)
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|ShowCursor
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|screen
operator|->
name|cursor_set
operator|!=
name|screen
operator|->
name|cursor_state
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|cursor_set
condition|)
name|ShowCursor
argument_list|()
expr_stmt|;
else|else
name|HideCursor
argument_list|()
expr_stmt|;
block|}
comment|/* Window select/unselect */
if|if
condition|(
name|doonalarmcode
condition|)
name|onalarmcode
argument_list|()
expr_stmt|;
if|if
condition|(
name|QLength
argument_list|()
condition|)
name|select_mask
operator|=
name|X_mask
expr_stmt|;
else|else
block|{
name|XFlush
argument_list|()
expr_stmt|;
name|select_mask
operator|=
name|Select_mask
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|select
argument_list|(
name|max_plus1
argument_list|,
operator|&
name|select_mask
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|screen
operator|->
name|timeout
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
condition|)
name|SysError
argument_list|(
name|ERROR_SELECT
argument_list|)
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|GetButtonState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|&
name|HILITED
condition|)
name|WindowScroll
argument_list|(
name|screen
argument_list|,
name|ButtonRegion
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
argument_list|)
expr_stmt|;
name|screen
operator|->
name|timeout
operator|->
name|tv_usec
operator|=
name|STEPTIME
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|select_mask
operator|&
name|X_mask
condition|)
name|xevents
argument_list|()
expr_stmt|;
block|}
name|bcnt
operator|--
expr_stmt|;
return|return
operator|(
operator|*
name|bptr
operator|++
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * process a string of characters according to the character set indicated  * by charset.  worry about end of line conditions (wraparound if selected).  */
end_comment

begin_expr_stmt
name|dotext
argument_list|(
name|screen
argument_list|,
name|flags
argument_list|,
name|charset
argument_list|,
name|buf
argument_list|,
name|ptr
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|unsigned
name|flags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|charset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|ptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|int
name|next_col
decl_stmt|;
switch|switch
condition|(
name|charset
condition|)
block|{
case|case
literal|'A'
case|:
comment|/* United Kingdom set				*/
for|for
control|(
name|s
operator|=
name|buf
init|;
name|s
operator|<
name|ptr
condition|;
operator|++
name|s
control|)
if|if
condition|(
operator|*
name|s
operator|==
literal|'#'
condition|)
operator|*
name|s
operator|=
literal|'\036'
expr_stmt|;
comment|/* UK pound sign	*/
break|break;
case|case
literal|'B'
case|:
comment|/* ASCII set					*/
break|break;
case|case
literal|'0'
case|:
comment|/* special graphics (line drawing)		*/
for|for
control|(
name|s
operator|=
name|buf
init|;
name|s
operator|<
name|ptr
condition|;
operator|++
name|s
control|)
if|if
condition|(
operator|*
name|s
operator|>=
literal|0x5f
operator|&&
operator|*
name|s
operator|<=
literal|0x7e
condition|)
operator|*
name|s
operator|=
operator|*
name|s
operator|==
literal|0x5f
condition|?
literal|0x7f
else|:
operator|*
name|s
operator|-
literal|0x5f
expr_stmt|;
break|break;
default|default:
comment|/* any character sets we don't recognize	*/
return|return;
block|}
name|len
operator|=
name|ptr
operator|-
name|buf
expr_stmt|;
name|ptr
operator|=
name|buf
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|n
operator|=
name|screen
operator|->
name|max_col
operator|-
name|screen
operator|->
name|cur_col
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|<=
literal|1
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|do_wrap
operator|&&
operator|(
name|flags
operator|&
name|WRAPAROUND
operator|)
operator|&&
operator|!
name|screen
operator|->
name|instatus
condition|)
block|{
name|Index
argument_list|(
name|screen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|screen
operator|->
name|cur_col
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
literal|0
expr_stmt|;
name|n
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
expr_stmt|;
block|}
else|else
name|n
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|<
name|n
condition|)
name|n
operator|=
name|len
expr_stmt|;
name|next_col
operator|=
name|screen
operator|->
name|cur_col
operator|+
name|n
expr_stmt|;
name|WriteText
argument_list|(
name|screen
argument_list|,
name|ptr
argument_list|,
name|n
argument_list|,
name|flags
argument_list|)
expr_stmt|;
comment|/* 		 * the call to WriteText updates screen->cur_col. 		 * If screen->cur_col != next_col, we must have 		 * hit the right margin, so set the do_wrap flag. 		 */
name|screen
operator|->
name|do_wrap
operator|=
operator|(
name|screen
operator|->
name|cur_col
operator|<
name|next_col
operator|)
expr_stmt|;
name|len
operator|-=
name|n
expr_stmt|;
name|ptr
operator|+=
name|n
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * write a string str of length len onto the screen at  * the current cursor position.  update cursor position.  */
end_comment

begin_expr_stmt
name|WriteText
argument_list|(
name|screen
argument_list|,
name|str
argument_list|,
name|len
argument_list|,
name|flags
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|flags
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|pix
decl_stmt|,
name|cx
decl_stmt|,
name|cy
decl_stmt|;
specifier|register
name|unsigned
name|fgs
init|=
name|flags
decl_stmt|;
name|Font
name|fnt
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|instatus
operator|&&
name|screen
operator|->
name|reversestatus
condition|)
name|fgs
operator|^=
name|INVERSE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|-
name|screen
operator|->
name|topline
operator|<=
name|screen
operator|->
name|max_row
operator|||
name|screen
operator|->
name|instatus
condition|)
block|{
comment|/* 	if(screen->cur_row == screen->cursor_row&& screen->cur_col<= 	 screen->cursor_col&& screen->cursor_col<= screen->cur_col + len - 1) 		screen->cursor_state = OFF; 	 */
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|fnt
operator|=
name|ActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|screen
operator|->
name|fnt_icon
else|:
operator|(
name|fgs
operator|&
name|BOLD
operator|)
condition|?
name|screen
operator|->
name|fnt_bold
else|:
name|screen
operator|->
name|fnt_norm
expr_stmt|;
if|if
condition|(
name|fgs
operator|&
name|INSERT
condition|)
name|InsertChar
argument_list|(
name|screen
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|AddToRefresh
argument_list|(
name|screen
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|cx
operator|=
name|CursorX
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_col
argument_list|)
expr_stmt|;
name|cy
operator|=
name|CursorY
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|show
operator|||
name|ActiveIcon
argument_list|(
name|screen
argument_list|)
condition|)
block|{
if|if
condition|(
name|fgs
operator|&
name|INVERSE
condition|)
name|XText
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cx
argument_list|,
name|cy
argument_list|,
name|str
argument_list|,
name|len
argument_list|,
name|fnt
argument_list|,
name|pix
operator|=
name|screen
operator|->
name|background
argument_list|,
name|screen
operator|->
name|foreground
argument_list|)
expr_stmt|;
else|else
name|XText
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cx
argument_list|,
name|cy
argument_list|,
name|str
argument_list|,
name|len
argument_list|,
name|fnt
argument_list|,
name|pix
operator|=
name|screen
operator|->
name|foreground
argument_list|,
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fgs
operator|&
name|BOLD
operator|)
operator|&&
name|screen
operator|->
name|enbolden
condition|)
name|XTextMask
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cx
operator|+
literal|1
argument_list|,
name|cy
argument_list|,
name|str
argument_list|,
name|len
argument_list|,
name|fnt
argument_list|,
name|pix
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgs
operator|&
name|UNDERLINE
condition|)
block|{
name|cy
operator|+=
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|-
literal|2
expr_stmt|;
name|XLine
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cx
argument_list|,
name|cy
argument_list|,
name|cx
operator|+
name|len
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cy
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|pix
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * the following statements compile data to compute the average  	 * number of characters written on each call to XText.  The data 	 * may be examined via the use of a "hidden" escape sequence. 	 */
name|ctotal
operator|+=
name|len
expr_stmt|;
operator|++
name|ntotal
expr_stmt|;
block|}
block|}
name|ScreenWrite
argument_list|(
name|screen
argument_list|,
name|str
argument_list|,
name|flags
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|CursorForward
argument_list|(
name|screen
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * process ANSI modes set, reset  */
end_comment

begin_macro
name|modes
argument_list|(
argument|term
argument_list|,
argument|func
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nparam
condition|;
operator|++
name|i
control|)
block|{
switch|switch
condition|(
name|param
index|[
name|i
index|]
condition|)
block|{
case|case
literal|4
case|:
comment|/* IRM				*/
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|term
operator|->
name|flags
argument_list|,
name|INSERT
argument_list|)
expr_stmt|;
break|break;
case|case
literal|20
case|:
comment|/* LNM				*/
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|term
operator|->
name|flags
argument_list|,
name|LINEFEED
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  * process DEC private modes set, reset  */
end_comment

begin_macro
name|dpmodes
argument_list|(
argument|term
argument_list|,
argument|func
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|extern
name|int
name|bitset
parameter_list|()
function_decl|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nparam
condition|;
operator|++
name|i
control|)
block|{
switch|switch
condition|(
name|param
index|[
name|i
index|]
condition|)
block|{
case|case
literal|1
case|:
comment|/* DECCKM			*/
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|term
operator|->
name|keyboard
operator|.
name|flags
argument_list|,
name|CURSOR_APL
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* DECCOLM			*/
if|if
condition|(
name|screen
operator|->
name|c132
condition|)
block|{
name|ClearScreen
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|CursorSet
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|term
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|=
name|func
operator|==
name|bitset
condition|?
literal|132
else|:
literal|80
operator|)
operator|!=
operator|(
operator|(
name|term
operator|->
name|flags
operator|&
name|IN132COLUMNS
operator|)
condition|?
literal|132
else|:
literal|80
operator|)
operator|||
name|j
operator|!=
name|screen
operator|->
name|max_col
operator|+
literal|1
condition|)
block|{
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|*
name|j
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
argument_list|)
expr_stmt|;
name|XSync
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|/* synchronize */
if|if
condition|(
name|QLength
argument_list|()
operator|>
literal|0
condition|)
name|xevents
argument_list|()
expr_stmt|;
block|}
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|term
operator|->
name|flags
argument_list|,
name|IN132COLUMNS
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
comment|/* DECSCLM (slow scroll)	*/
if|if
condition|(
name|func
operator|==
name|bitset
condition|)
block|{
name|screen
operator|->
name|jumpscroll
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|jumpscroll
operator|=
literal|1
expr_stmt|;
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|term
operator|->
name|flags
argument_list|,
name|SMOOTHSCROLL
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* DECSCNM			*/
name|j
operator|=
name|term
operator|->
name|flags
expr_stmt|;
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|term
operator|->
name|flags
argument_list|,
name|REVERSE_VIDEO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|term
operator|->
name|flags
operator|^
name|j
operator|)
operator|&
name|REVERSE_VIDEO
condition|)
name|ReverseVideo
argument_list|(
name|term
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* DECOM			*/
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|term
operator|->
name|flags
argument_list|,
name|ORIGIN
argument_list|)
expr_stmt|;
name|CursorSet
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|term
operator|->
name|flags
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* DECAWM			*/
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|term
operator|->
name|flags
argument_list|,
name|WRAPAROUND
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* DECARM			*/
name|j
operator|=
name|term
operator|->
name|flags
expr_stmt|;
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|term
operator|->
name|flags
argument_list|,
name|AUTOREPEAT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|term
operator|->
name|flags
operator|^
name|j
operator|)
operator|&
name|AUTOREPEAT
condition|)
if|if
condition|(
name|term
operator|->
name|flags
operator|&
name|AUTOREPEAT
condition|)
name|XAutoRepeatOn
argument_list|()
expr_stmt|;
else|else
name|XAutoRepeatOff
argument_list|()
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* MIT bogus sequence		*/
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|screen
operator|->
name|send_mouse_pos
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|38
case|:
comment|/* DECTEK			*/
if|if
condition|(
name|func
operator|==
name|bitset
operator|&
operator|!
operator|(
name|screen
operator|->
name|inhibit
operator|&
name|I_TEK
operator|)
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
block|{
name|FlushLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|logstart
operator|=
name|Tbuffer
expr_stmt|;
block|}
name|screen
operator|->
name|TekEmu
operator|=
name|TRUE
expr_stmt|;
block|}
break|break;
case|case
literal|40
case|:
comment|/* 132 column mode		*/
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|screen
operator|->
name|c132
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|41
case|:
comment|/* curses hack			*/
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|screen
operator|->
name|curses
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|42
case|:
comment|/* scrollbar			*/
if|if
condition|(
name|func
operator|==
name|bitset
condition|)
name|ScrollBarOn
argument_list|(
name|screen
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
else|else
name|ScrollBarOff
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
literal|43
case|:
comment|/* lines off top		*/
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
name|SetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
operator|(
name|func
operator|==
name|bitset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|44
case|:
comment|/* margin bell			*/
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|screen
operator|->
name|marginbell
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|marginbell
condition|)
name|screen
operator|->
name|bellarmed
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|45
case|:
comment|/* reverse wraparound	*/
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|term
operator|->
name|flags
argument_list|,
name|REVERSEWRAP
argument_list|)
expr_stmt|;
break|break;
case|case
literal|46
case|:
comment|/* logging		*/
if|if
condition|(
name|func
operator|==
name|bitset
condition|)
name|StartLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|CloseLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
literal|47
case|:
comment|/* alternate buffer		*/
if|if
condition|(
name|func
operator|==
name|bitset
condition|)
name|ToAlternate
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|FromAlternate
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
literal|48
case|:
comment|/* reverse status line	*/
name|j
operator|=
name|screen
operator|->
name|reversestatus
expr_stmt|;
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|screen
operator|->
name|reversestatus
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|!=
name|screen
operator|->
name|reversestatus
condition|)
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|49
case|:
comment|/* page mode		*/
name|j
operator|=
name|screen
operator|->
name|pagemode
expr_stmt|;
call|(
modifier|*
name|func
call|)
argument_list|(
operator|&
name|screen
operator|->
name|pagemode
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|j
operator|&&
name|screen
operator|->
name|pagemode
condition|)
name|screen
operator|->
name|pagecnt
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  * process xterm private modes save  */
end_comment

begin_macro
name|savemodes
argument_list|(
argument|term
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nparam
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|param
index|[
name|i
index|]
condition|)
block|{
case|case
literal|1
case|:
comment|/* DECCKM			*/
name|screen
operator|->
name|save_modes
index|[
literal|0
index|]
operator|=
name|term
operator|->
name|keyboard
operator|.
name|flags
operator|&
name|CURSOR_APL
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* DECCOLM			*/
if|if
condition|(
name|screen
operator|->
name|c132
condition|)
name|screen
operator|->
name|save_modes
index|[
literal|1
index|]
operator|=
name|term
operator|->
name|flags
operator|&
name|IN132COLUMNS
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* DECSCLM (slow scroll)	*/
name|screen
operator|->
name|save_modes
index|[
literal|2
index|]
operator|=
name|term
operator|->
name|flags
operator|&
name|SMOOTHSCROLL
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* DECSCNM			*/
name|screen
operator|->
name|save_modes
index|[
literal|3
index|]
operator|=
name|term
operator|->
name|flags
operator|&
name|REVERSE_VIDEO
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* DECOM			*/
name|screen
operator|->
name|save_modes
index|[
literal|4
index|]
operator|=
name|term
operator|->
name|flags
operator|&
name|ORIGIN
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* DECAWM			*/
name|screen
operator|->
name|save_modes
index|[
literal|5
index|]
operator|=
name|term
operator|->
name|flags
operator|&
name|WRAPAROUND
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* DECARM			*/
name|screen
operator|->
name|save_modes
index|[
literal|6
index|]
operator|=
name|term
operator|->
name|flags
operator|&
name|AUTOREPEAT
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* MIT bogus sequence		*/
name|screen
operator|->
name|save_modes
index|[
literal|7
index|]
operator|=
name|screen
operator|->
name|send_mouse_pos
expr_stmt|;
break|break;
case|case
literal|40
case|:
comment|/* 132 column mode		*/
name|screen
operator|->
name|save_modes
index|[
literal|8
index|]
operator|=
name|screen
operator|->
name|c132
expr_stmt|;
break|break;
case|case
literal|41
case|:
comment|/* curses hack			*/
name|screen
operator|->
name|save_modes
index|[
literal|9
index|]
operator|=
name|screen
operator|->
name|curses
expr_stmt|;
break|break;
case|case
literal|42
case|:
comment|/* scrollbar			*/
name|screen
operator|->
name|save_modes
index|[
literal|10
index|]
operator|=
name|screen
operator|->
name|scrollbar
expr_stmt|;
break|break;
case|case
literal|43
case|:
comment|/* lines off top		*/
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
name|screen
operator|->
name|save_modes
index|[
literal|11
index|]
operator|=
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
break|break;
case|case
literal|44
case|:
comment|/* margin bell			*/
name|screen
operator|->
name|save_modes
index|[
literal|12
index|]
operator|=
name|screen
operator|->
name|marginbell
expr_stmt|;
break|break;
case|case
literal|45
case|:
comment|/* reverse wraparound	*/
name|screen
operator|->
name|save_modes
index|[
literal|13
index|]
operator|=
name|term
operator|->
name|flags
operator|&
name|REVERSEWRAP
expr_stmt|;
break|break;
case|case
literal|46
case|:
comment|/* logging		*/
name|screen
operator|->
name|save_modes
index|[
literal|14
index|]
operator|=
name|screen
operator|->
name|logging
expr_stmt|;
break|break;
case|case
literal|47
case|:
comment|/* alternate buffer		*/
name|screen
operator|->
name|save_modes
index|[
literal|15
index|]
operator|=
name|screen
operator|->
name|alternate
expr_stmt|;
break|break;
case|case
literal|48
case|:
comment|/* reverse status line		*/
name|screen
operator|->
name|save_modes
index|[
literal|16
index|]
operator|=
name|screen
operator|->
name|reversestatus
expr_stmt|;
break|break;
case|case
literal|49
case|:
comment|/* page mode			*/
name|screen
operator|->
name|save_modes
index|[
literal|17
index|]
operator|=
name|screen
operator|->
name|pagemode
expr_stmt|;
name|screen
operator|->
name|save_modes
index|[
literal|18
index|]
operator|=
name|screen
operator|->
name|pagecnt
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  * process xterm private modes restore  */
end_comment

begin_macro
name|restoremodes
argument_list|(
argument|term
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nparam
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|param
index|[
name|i
index|]
condition|)
block|{
case|case
literal|1
case|:
comment|/* DECCKM			*/
name|term
operator|->
name|keyboard
operator|.
name|flags
operator|&=
operator|~
name|CURSOR_APL
expr_stmt|;
name|term
operator|->
name|keyboard
operator|.
name|flags
operator||=
name|screen
operator|->
name|save_modes
index|[
literal|0
index|]
operator|&
name|CURSOR_APL
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* DECCOLM			*/
if|if
condition|(
name|screen
operator|->
name|c132
condition|)
block|{
name|ClearScreen
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|CursorSet
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|term
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|=
operator|(
name|screen
operator|->
name|save_modes
index|[
literal|1
index|]
operator|&
name|IN132COLUMNS
operator|)
condition|?
literal|132
else|:
literal|80
operator|)
operator|!=
operator|(
operator|(
name|term
operator|->
name|flags
operator|&
name|IN132COLUMNS
operator|)
condition|?
literal|132
else|:
literal|80
operator|)
operator|||
name|j
operator|!=
name|screen
operator|->
name|max_col
operator|+
literal|1
condition|)
block|{
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|*
name|j
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
argument_list|)
expr_stmt|;
name|XSync
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|/* synchronize */
if|if
condition|(
name|QLength
argument_list|()
operator|>
literal|0
condition|)
name|xevents
argument_list|()
expr_stmt|;
block|}
name|term
operator|->
name|flags
operator|&=
operator|~
name|IN132COLUMNS
expr_stmt|;
name|term
operator|->
name|flags
operator||=
name|screen
operator|->
name|save_modes
index|[
literal|1
index|]
operator|&
name|IN132COLUMNS
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
comment|/* DECSCLM (slow scroll)	*/
if|if
condition|(
name|screen
operator|->
name|save_modes
index|[
literal|2
index|]
operator|&
name|SMOOTHSCROLL
condition|)
block|{
name|screen
operator|->
name|jumpscroll
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|jumpscroll
operator|=
literal|1
expr_stmt|;
name|term
operator|->
name|flags
operator|&=
operator|~
name|SMOOTHSCROLL
expr_stmt|;
name|term
operator|->
name|flags
operator||=
name|screen
operator|->
name|save_modes
index|[
literal|2
index|]
operator|&
name|SMOOTHSCROLL
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* DECSCNM			*/
if|if
condition|(
operator|(
name|screen
operator|->
name|save_modes
index|[
literal|3
index|]
operator|^
name|term
operator|->
name|flags
operator|)
operator|&
name|REVERSE_VIDEO
condition|)
block|{
name|term
operator|->
name|flags
operator|&=
operator|~
name|REVERSE_VIDEO
expr_stmt|;
name|term
operator|->
name|flags
operator||=
name|screen
operator|->
name|save_modes
index|[
literal|3
index|]
operator|&
name|REVERSE_VIDEO
expr_stmt|;
name|ReverseVideo
argument_list|(
name|term
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|6
case|:
comment|/* DECOM			*/
name|term
operator|->
name|flags
operator|&=
operator|~
name|ORIGIN
expr_stmt|;
name|term
operator|->
name|flags
operator||=
name|screen
operator|->
name|save_modes
index|[
literal|4
index|]
operator|&
name|ORIGIN
expr_stmt|;
name|CursorSet
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|term
operator|->
name|flags
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* DECAWM			*/
name|term
operator|->
name|flags
operator|&=
operator|~
name|WRAPAROUND
expr_stmt|;
name|term
operator|->
name|flags
operator||=
name|screen
operator|->
name|save_modes
index|[
literal|5
index|]
operator|&
name|WRAPAROUND
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* DECARM			*/
if|if
condition|(
operator|(
name|screen
operator|->
name|save_modes
index|[
literal|6
index|]
operator|^
name|term
operator|->
name|flags
operator|)
operator|&
name|AUTOREPEAT
condition|)
block|{
name|term
operator|->
name|flags
operator|&=
operator|~
name|REVERSE_VIDEO
expr_stmt|;
name|term
operator|->
name|flags
operator||=
name|screen
operator|->
name|save_modes
index|[
literal|6
index|]
operator|&
name|REVERSE_VIDEO
expr_stmt|;
if|if
condition|(
name|term
operator|->
name|flags
operator|&
name|AUTOREPEAT
condition|)
name|XAutoRepeatOn
argument_list|()
expr_stmt|;
else|else
name|XAutoRepeatOff
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|9
case|:
comment|/* MIT bogus sequence		*/
name|screen
operator|->
name|send_mouse_pos
operator|=
name|screen
operator|->
name|save_modes
index|[
literal|7
index|]
expr_stmt|;
break|break;
case|case
literal|40
case|:
comment|/* 132 column mode		*/
name|screen
operator|->
name|c132
operator|=
name|screen
operator|->
name|save_modes
index|[
literal|8
index|]
expr_stmt|;
break|break;
case|case
literal|41
case|:
comment|/* curses hack			*/
name|screen
operator|->
name|curses
operator|=
name|screen
operator|->
name|save_modes
index|[
literal|9
index|]
expr_stmt|;
break|break;
case|case
literal|42
case|:
comment|/* scrollbar			*/
if|if
condition|(
name|screen
operator|->
name|save_modes
index|[
literal|10
index|]
condition|)
name|ScrollBarOn
argument_list|(
name|screen
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
else|else
name|ScrollBarOff
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
literal|43
case|:
comment|/* lines off top		*/
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
name|SetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
name|screen
operator|->
name|save_modes
index|[
literal|11
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|44
case|:
comment|/* margin bell			*/
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|marginbell
operator|=
name|screen
operator|->
name|save_modes
index|[
literal|12
index|]
operator|)
condition|)
name|screen
operator|->
name|bellarmed
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|45
case|:
comment|/* reverse wraparound	*/
name|term
operator|->
name|flags
operator|&=
operator|~
name|REVERSEWRAP
expr_stmt|;
name|term
operator|->
name|flags
operator||=
name|screen
operator|->
name|save_modes
index|[
literal|13
index|]
operator|&
name|REVERSEWRAP
expr_stmt|;
break|break;
case|case
literal|46
case|:
comment|/* logging		*/
if|if
condition|(
name|screen
operator|->
name|save_modes
index|[
literal|14
index|]
condition|)
name|StartLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|CloseLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
literal|47
case|:
comment|/* alternate buffer		*/
if|if
condition|(
name|screen
operator|->
name|save_modes
index|[
literal|15
index|]
condition|)
name|ToAlternate
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|FromAlternate
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
literal|48
case|:
comment|/* reverse status line		*/
if|if
condition|(
name|screen
operator|->
name|save_modes
index|[
literal|16
index|]
operator|!=
name|screen
operator|->
name|reversestatus
condition|)
block|{
name|screen
operator|->
name|reversestatus
operator|=
name|screen
operator|->
name|save_modes
index|[
literal|16
index|]
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|49
case|:
comment|/* page mode			*/
name|screen
operator|->
name|pagemode
operator|=
name|screen
operator|->
name|save_modes
index|[
literal|17
index|]
expr_stmt|;
name|screen
operator|->
name|pagecnt
operator|=
name|screen
operator|->
name|save_modes
index|[
literal|18
index|]
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  * set a bit in a word given a pointer to the word and a mask.  */
end_comment

begin_macro
name|bitset
argument_list|(
argument|p
argument_list|,
argument|mask
argument_list|)
end_macro

begin_decl_stmt
name|int
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
operator|*
name|p
operator||=
name|mask
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * clear a bit in a word given a pointer to the word and a mask.  */
end_comment

begin_macro
name|bitclr
argument_list|(
argument|p
argument_list|,
argument|mask
argument_list|)
end_macro

begin_decl_stmt
name|int
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
operator|*
name|p
operator|&=
operator|~
name|mask
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|unparseseq
argument_list|(
name|ap
argument_list|,
name|fd
argument_list|)
specifier|register
name|ANSI
operator|*
name|ap
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|inters
decl_stmt|;
name|c
operator|=
name|ap
operator|->
name|a_type
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|0x80
operator|&&
name|c
operator|<=
literal|0x9F
condition|)
block|{
name|unparseputc
argument_list|(
name|ESC
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|c
operator|-=
literal|0x40
expr_stmt|;
block|}
name|unparseputc
argument_list|(
name|c
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|c
operator|=
name|ap
operator|->
name|a_type
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|ESC
operator|||
name|c
operator|==
name|DCS
operator|||
name|c
operator|==
name|CSI
operator|||
name|c
operator|==
name|OSC
operator|||
name|c
operator|==
name|PM
operator|||
name|c
operator|==
name|APC
condition|)
block|{
if|if
condition|(
name|ap
operator|->
name|a_pintro
operator|!=
literal|0
condition|)
name|unparseputc
argument_list|(
name|ap
operator|->
name|a_pintro
argument_list|,
name|fd
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ap
operator|->
name|a_nparam
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|unparseputc
argument_list|(
literal|';'
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|unparseputn
argument_list|(
name|ap
operator|->
name|a_param
index|[
name|i
index|]
argument_list|,
name|fd
argument_list|)
expr_stmt|;
block|}
name|inters
operator|=
name|ap
operator|->
name|a_inters
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
operator|>=
literal|0
condition|;
operator|--
name|i
control|)
name|c
operator|=
operator|(
name|inters
operator|>>
operator|(
literal|8
operator|*
name|i
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|c
operator|!=
literal|0
condition|)
name|unparseputc
argument_list|(
name|c
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|unparseputc
argument_list|(
name|ap
operator|->
name|a_final
argument_list|,
name|fd
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|unparseputn
argument_list|(
argument|n
argument_list|,
argument|fd
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|int
name|q
decl_stmt|;
name|q
operator|=
name|n
operator|/
literal|10
expr_stmt|;
if|if
condition|(
name|q
operator|!=
literal|0
condition|)
name|unparseputn
argument_list|(
name|q
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|unparseputc
argument_list|(
operator|(
name|n
operator|%
literal|10
operator|)
operator|+
literal|'0'
argument_list|,
name|fd
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|unparseputc
argument_list|(
argument|c
argument_list|,
argument|fd
argument_list|)
end_macro

begin_block
block|{
name|char
name|buf
index|[
literal|2
index|]
decl_stmt|;
specifier|register
name|i
operator|=
literal|1
expr_stmt|;
specifier|extern
name|Terminal
name|term
decl_stmt|;
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|=
name|c
operator|)
operator|==
literal|'\r'
operator|&&
operator|(
name|term
operator|.
name|flags
operator|&
name|LINEFEED
operator|)
condition|)
block|{
name|buf
index|[
literal|1
index|]
operator|=
literal|'\n'
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
name|i
argument_list|)
operator|!=
name|i
condition|)
name|Panic
argument_list|(
literal|"unparseputc: error writing character\n"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
specifier|static
name|int
name|alt_pagecnt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|alt_pagemode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|alt_saving
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|ToAlternate
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|extern
name|ScrnBuf
name|Allocate
parameter_list|()
function_decl|;
if|if
condition|(
name|screen
operator|->
name|alternate
condition|)
return|return;
if|if
condition|(
operator|!
name|screen
operator|->
name|altbuf
condition|)
name|screen
operator|->
name|altbuf
operator|=
name|Allocate
argument_list|(
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
block|{
name|alt_saving
operator|=
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
name|SetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
else|else
name|alt_saving
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|alt_pagemode
operator|=
name|screen
operator|->
name|pagemode
condition|)
name|alt_pagecnt
operator|=
name|screen
operator|->
name|pagecnt
expr_stmt|;
name|screen
operator|->
name|pagemode
operator|=
name|FALSE
expr_stmt|;
name|SwitchBufs
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|alternate
operator|=
name|TRUE
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|FromAlternate
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|screen
operator|->
name|alternate
condition|)
return|return;
name|screen
operator|->
name|alternate
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
name|SetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
name|alt_saving
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|pagemode
operator|=
name|alt_pagemode
condition|)
name|screen
operator|->
name|pagecnt
operator|=
name|alt_pagecnt
expr_stmt|;
name|SwitchBufs
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|SwitchBufs
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|rows
decl_stmt|,
name|top
decl_stmt|;
name|char
modifier|*
name|save
index|[
literal|2
operator|*
name|MAX_ROWS
index|]
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|rows
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|screen
operator|->
name|buf
argument_list|,
operator|(
name|char
operator|*
operator|)
name|save
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|rows
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|screen
operator|->
name|altbuf
argument_list|,
operator|(
name|char
operator|*
operator|)
name|screen
operator|->
name|buf
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|rows
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|save
argument_list|,
operator|(
name|char
operator|*
operator|)
name|screen
operator|->
name|altbuf
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
name|rows
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|top
operator|=
operator|-
name|screen
operator|->
name|topline
operator|)
operator|<=
name|screen
operator|->
name|max_row
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|top
operator|==
literal|0
operator|&&
operator|!
name|screen
operator|->
name|statusline
condition|)
name|XClear
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|XTileSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|top
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
operator|(
name|screen
operator|->
name|max_row
operator|-
name|top
operator|+
literal|1
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
block|}
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|rows
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|VTRun
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|VWindow
argument_list|(
name|screen
argument_list|)
operator|&&
operator|!
name|VTInit
argument_list|()
condition|)
block|{
if|if
condition|(
name|TWindow
argument_list|(
name|screen
argument_list|)
condition|)
block|{
name|screen
operator|->
name|TekEmu
operator|=
name|TRUE
expr_stmt|;
return|return;
block|}
name|Exit
argument_list|(
name|ERROR_VINIT
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|cursor_state
operator|=
name|OFF
expr_stmt|;
name|screen
operator|->
name|cursor_set
operator|=
name|ON
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|icon_show
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|<
literal|0
condition|)
block|{
name|screen
operator|->
name|icon_show
operator|=
name|TRUE
expr_stmt|;
name|screen
operator|->
name|mappedVwin
operator|=
operator|&
name|screen
operator|->
name|iconVwin
expr_stmt|;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|screen
operator|->
name|show
condition|)
block|{
name|screen
operator|->
name|show
operator|=
name|TRUE
expr_stmt|;
name|screen
operator|->
name|mappedVwin
operator|=
operator|&
name|screen
operator|->
name|fullVwin
expr_stmt|;
name|XMapWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|XRaiseWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|select
condition|)
name|VTSelect
argument_list|()
expr_stmt|;
if|if
condition|(
name|L_flag
operator|>
literal|0
condition|)
block|{
name|XWarpMouse
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FullWidth
argument_list|(
name|screen
argument_list|)
operator|>>
literal|1
argument_list|,
name|FullHeight
argument_list|(
name|screen
argument_list|)
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|L_flag
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|bcnt
operator|=
literal|0
expr_stmt|;
name|bptr
operator|=
name|buffer
expr_stmt|;
while|while
condition|(
name|Tpushb
operator|>
name|Tpushback
condition|)
block|{
operator|*
name|bptr
operator|++
operator|=
operator|*
operator|--
name|Tpushb
expr_stmt|;
name|bcnt
operator|++
expr_stmt|;
block|}
name|bcnt
operator|+=
operator|(
name|i
operator|=
name|Tbcnt
operator|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
operator|*
name|bptr
operator|++
operator|=
operator|*
name|Tbptr
operator|++
expr_stmt|;
name|bptr
operator|=
name|buffer
expr_stmt|;
if|if
condition|(
operator|!
name|setjmp
argument_list|(
name|VTend
argument_list|)
condition|)
name|VTparse
argument_list|()
expr_stmt|;
name|HideCursor
argument_list|()
expr_stmt|;
name|screen
operator|->
name|cursor_set
operator|=
name|OFF
expr_stmt|;
name|VTUnselect
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|VTInit
argument_list|()
end_macro

begin_block
block|{
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|FontInfo
modifier|*
name|fInfo
decl_stmt|,
modifier|*
name|ifInfo
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|Vertex
modifier|*
name|vp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|def
init|=
literal|"=80x24+1+1"
decl_stmt|;
name|char
name|iconname
index|[
literal|128
index|]
decl_stmt|;
specifier|static
name|short
name|failed
decl_stmt|;
name|Color
name|cdef
decl_stmt|;
name|OpaqueFrame
name|twindow
decl_stmt|;
name|WindowInfo
name|wininfo
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|Window
name|win
decl_stmt|;
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
if|if
condition|(
name|failed
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|screen
operator|->
name|mappedVwin
operator|=
operator|&
name|screen
operator|->
name|fullVwin
expr_stmt|;
name|TabReset
argument_list|(
name|term
operator|.
name|tabs
argument_list|)
expr_stmt|;
name|screen
operator|->
name|fnt_norm
operator|=
name|screen
operator|->
name|fnt_bold
operator|=
name|screen
operator|->
name|fnt_icon
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|fInfo
operator|=
name|XOpenFont
argument_list|(
name|f_n
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Could not open font %s!\n"
argument_list|,
name|xterm_name
argument_list|,
name|f_n
argument_list|)
expr_stmt|;
name|failed
operator|=
name|TRUE
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
name|screen
operator|->
name|fnt_norm
operator|=
name|fInfo
operator|->
name|id
expr_stmt|;
if|if
condition|(
operator|!
name|f_b
operator|||
operator|!
operator|(
name|screen
operator|->
name|fnt_bold
operator|=
name|XGetFont
argument_list|(
name|f_b
argument_list|)
operator|)
condition|)
block|{
name|screen
operator|->
name|fnt_bold
operator|=
name|screen
operator|->
name|fnt_norm
expr_stmt|;
name|screen
operator|->
name|enbolden
operator|=
name|TRUE
expr_stmt|;
block|}
name|screen
operator|->
name|fullVwin
operator|.
name|f_width
operator|=
name|fInfo
operator|->
name|width
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|f_height
operator|=
name|fInfo
operator|->
name|height
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|active_icon
condition|)
block|{
if|if
condition|(
operator|!
name|screen
operator|->
name|fnt_icon
condition|)
block|{
if|if
condition|(
operator|(
name|ifInfo
operator|=
name|XOpenFont
argument_list|(
name|f_i
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Could not open font %s!\n"
argument_list|,
name|xterm_name
argument_list|,
name|f_i
argument_list|)
expr_stmt|;
name|failed
operator|=
name|TRUE
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
name|screen
operator|->
name|fnt_icon
operator|=
name|ifInfo
operator|->
name|id
expr_stmt|;
block|}
else|else
name|XQueryFont
argument_list|(
name|screen
operator|->
name|fnt_icon
argument_list|,
operator|&
name|ifInfo
argument_list|)
expr_stmt|;
name|screen
operator|->
name|iconVwin
operator|.
name|f_width
operator|=
name|ifInfo
operator|->
name|width
expr_stmt|;
name|screen
operator|->
name|iconVwin
operator|.
name|f_height
operator|=
name|ifInfo
operator|->
name|height
expr_stmt|;
block|}
comment|/* X11 arrow cursor feature */
if|if
condition|(
name|curs_shape
operator|&&
name|strcmp
argument_list|(
name|curs_shape
argument_list|,
literal|"arrow"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|curs
operator|=
name|make_arrow
argument_list|(
name|screen
operator|->
name|mousecolor
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
else|else
name|screen
operator|->
name|curs
operator|=
name|make_xterm
argument_list|(
name|screen
operator|->
name|mousecolor
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
name|twindow
operator|.
name|bdrwidth
operator|=
name|screen
operator|->
name|borderwidth
expr_stmt|;
if|if
condition|(
name|grayborder
condition|)
name|twindow
operator|.
name|border
operator|=
name|screen
operator|->
name|graybordertile
expr_stmt|;
else|else
name|twindow
operator|.
name|border
operator|=
name|screen
operator|->
name|bordertile
expr_stmt|;
name|twindow
operator|.
name|background
operator|=
name|screen
operator|->
name|bgndtile
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|minrows
operator|=
operator|(
name|MINSCROLLBARHEIGHT
operator|-
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|fInfo
operator|->
name|height
operator|-
literal|1
operator|)
operator|/
name|fInfo
operator|->
name|height
operator|)
operator|<
literal|0
condition|)
name|screen
operator|->
name|minrows
operator|=
literal|0
expr_stmt|;
name|i
operator|=
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|screen
operator|->
name|scrollbar
expr_stmt|;
name|j
operator|=
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|statusline
condition|)
name|j
operator|+=
operator|(
name|screen
operator|->
name|statusheight
operator|=
name|fInfo
operator|->
name|height
operator|+
literal|2
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|fullVwin
operator|.
name|window
operator|=
name|XCreateTerm
argument_list|(
literal|"Terminal Emulator"
argument_list|,
name|xterm_name
argument_list|,
name|geo_metry
argument_list|,
name|def
argument_list|,
operator|&
name|twindow
argument_list|,
literal|12
argument_list|,
name|screen
operator|->
name|minrows
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|width
argument_list|,
operator|&
name|height
argument_list|,
name|fInfo
argument_list|,
name|fInfo
operator|->
name|width
argument_list|,
name|fInfo
operator|->
name|height
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't create VT window\n"
argument_list|)
expr_stmt|;
name|XCloseFont
argument_list|(
name|fInfo
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
name|XSelectInput
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|WINDOWEVENTS
argument_list|)
expr_stmt|;
comment|/* 	 * XCreateTerm flushes all events, which might include an EnterWindow 	 * or LeaveWindow.  So if the cursor is not where it is supposed to 	 * be, we set select to the appropriate thing. 	 */
if|if
condition|(
name|TWindow
argument_list|(
name|screen
argument_list|)
operator|&&
name|XQueryMouse
argument_list|(
name|RootWindow
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
operator|&
name|win
argument_list|)
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|timer
condition|)
block|{
name|Timer
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
name|screen
operator|->
name|timer
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|win
operator|==
name|TWindow
argument_list|(
name|screen
argument_list|)
condition|)
name|screen
operator|->
name|select
operator||=
name|INWINDOW
expr_stmt|;
else|else
name|screen
operator|->
name|select
operator|&=
operator|~
name|INWINDOW
expr_stmt|;
block|}
name|screen
operator|->
name|fullVwin
operator|.
name|fullwidth
operator|=
name|twindow
operator|.
name|width
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|fullheight
operator|=
name|twindow
operator|.
name|height
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|width
operator|=
name|twindow
operator|.
name|width
operator|-
name|i
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|height
operator|=
name|twindow
operator|.
name|height
operator|-
name|j
expr_stmt|;
comment|/* Reset variables used by ANSI emulation. */
name|screen
operator|->
name|gsets
index|[
literal|0
index|]
operator|=
literal|'B'
expr_stmt|;
comment|/* ASCII_G		*/
name|screen
operator|->
name|gsets
index|[
literal|1
index|]
operator|=
literal|'B'
expr_stmt|;
name|screen
operator|->
name|gsets
index|[
literal|2
index|]
operator|=
literal|'B'
expr_stmt|;
comment|/* DEC supplemental.	*/
name|screen
operator|->
name|gsets
index|[
literal|3
index|]
operator|=
literal|'B'
expr_stmt|;
name|screen
operator|->
name|curgl
operator|=
literal|0
expr_stmt|;
comment|/* G0 => GL.		*/
name|screen
operator|->
name|curgr
operator|=
literal|2
expr_stmt|;
comment|/* G2 => GR.		*/
name|screen
operator|->
name|curss
operator|=
literal|0
expr_stmt|;
comment|/* No single shift.	*/
if|if
condition|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
condition|)
block|{
name|XQueryWindow
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
operator|&
name|wininfo
argument_list|)
expr_stmt|;
name|x
operator|=
name|wininfo
operator|.
name|x
expr_stmt|;
name|y
operator|=
name|wininfo
operator|.
name|y
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|twindow
operator|.
name|x
operator|+
operator|(
name|twindow
operator|.
name|width
operator|-
name|screen
operator|->
name|iconVwin
operator|.
name|width
operator|)
operator|/
literal|2
expr_stmt|;
name|y
operator|=
name|twindow
operator|.
name|y
operator|+
operator|(
name|twindow
operator|.
name|height
operator|-
name|screen
operator|->
name|iconVwin
operator|.
name|height
operator|)
operator|/
literal|2
expr_stmt|;
name|IconGeometry
argument_list|(
name|screen
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|iconVwin
operator|.
name|window
operator|=
name|XCreateWindow
argument_list|(
name|RootWindow
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|borderwidth
argument_list|,
name|screen
operator|->
name|bordertile
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
name|XSetIconWindow
argument_list|(
name|screen
operator|->
name|fullVwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|)
expr_stmt|;
name|XDefineCursor
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|arrow
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|active_icon
operator|&&
operator|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
operator|)
condition|?
name|ICONWINDOWEVENTS
operator||
name|ICONINPUTEVENTS
else|:
name|ICONWINDOWEVENTS
argument_list|)
expr_stmt|;
name|XDefineCursor
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|curs
argument_list|)
expr_stmt|;
name|XStoreName
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|winname
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|iconname
argument_list|,
name|screen
operator|->
name|winname
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|iconname
argument_list|,
literal|" (icon)"
argument_list|)
expr_stmt|;
name|XStoreName
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|iconname
argument_list|)
expr_stmt|;
name|XSetResizeHint
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|statusheight
argument_list|,
name|fInfo
operator|->
name|width
argument_list|,
name|fInfo
operator|->
name|height
argument_list|)
expr_stmt|;
name|screen
operator|->
name|cur_col
operator|=
name|screen
operator|->
name|cur_row
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|max_col
operator|=
name|Width
argument_list|(
name|screen
argument_list|)
operator|/
name|fInfo
operator|->
name|width
operator|-
literal|1
expr_stmt|;
name|screen
operator|->
name|top_marg
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|bot_marg
operator|=
name|screen
operator|->
name|max_row
operator|=
name|Height
argument_list|(
name|screen
argument_list|)
operator|/
name|fInfo
operator|->
name|height
operator|-
literal|1
expr_stmt|;
name|screen
operator|->
name|sc
operator|.
name|row
operator|=
name|screen
operator|->
name|sc
operator|.
name|col
operator|=
name|screen
operator|->
name|sc
operator|.
name|flags
operator|=
name|NULL
expr_stmt|;
name|SetIconSize
argument_list|(
name|screen
argument_list|)
expr_stmt|;
comment|/* requires max_col, max_row */
comment|/* allocate memory for screen buffer (including one for status line */
name|screen
operator|->
name|buf
operator|=
name|screen
operator|->
name|allbuf
operator|=
operator|(
name|ScrnBuf
operator|)
name|Allocate
argument_list|(
name|screen
operator|->
name|max_row
operator|+
literal|2
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
name|NULL
expr_stmt|;
name|screen
operator|->
name|scrolls
operator|=
name|screen
operator|->
name|incopy
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fInfo
argument_list|)
expr_stmt|;
name|vp
operator|=
operator|&
name|VTbox
index|[
literal|1
index|]
expr_stmt|;
operator|(
name|vp
operator|++
operator|)
operator|->
name|x
operator|=
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
expr_stmt|;
operator|(
name|vp
operator|++
operator|)
operator|->
name|y
operator|=
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
expr_stmt|;
operator|(
name|vp
operator|++
operator|)
operator|->
name|x
operator|=
operator|-
operator|(
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|vp
operator|->
name|y
operator|=
operator|-
operator|(
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|screen
operator|->
name|box
operator|=
name|VTbox
expr_stmt|;
name|status_box
index|[
literal|0
index|]
operator|.
name|x
operator|=
name|screen
operator|->
name|border
operator|-
literal|1
expr_stmt|;
name|screen
operator|->
name|savelines
operator|=
name|save_lines
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scrollbar
condition|)
block|{
name|screen
operator|->
name|scrollbar
operator|=
literal|0
expr_stmt|;
name|ScrollBarOn
argument_list|(
name|screen
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|screen
operator|->
name|sb
operator|->
name|action
operator|=
name|NONE
expr_stmt|;
block|}
name|screen
operator|->
name|nmarginbell
operator|=
name|n_marginbell
expr_stmt|;
if|if
condition|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
condition|)
name|VTTitleShow
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
name|CursorSave
argument_list|(
operator|&
name|term
argument_list|,
operator|&
name|screen
operator|->
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|CHANGEFONT
end_ifdef

begin_expr_stmt
name|VTChangeFont
argument_list|(
name|screen
argument_list|,
name|newfname
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|newfname
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Vertex
modifier|*
name|vp
decl_stmt|;
name|FontInfo
modifier|*
name|fInfo
decl_stmt|;
specifier|register
name|width
operator|,
name|height
operator|,
name|border
operator|,
name|extra
expr_stmt|;
comment|/* Make sure we can get the new font */
if|if
condition|(
operator|(
name|fInfo
operator|=
name|XOpenFont
argument_list|(
name|newfname
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
comment|/* Disallow variable fonts with no average sizes for now */
if|if
condition|(
name|fInfo
operator|->
name|width
operator|==
literal|0
operator|||
name|fInfo
operator|->
name|height
operator|==
literal|0
condition|)
block|{
name|XCloseFont
argument_list|(
name|fInfo
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
comment|/* Destroy old font */
name|XFreeFont
argument_list|(
name|screen
operator|->
name|fnt_norm
argument_list|)
expr_stmt|;
name|screen
operator|->
name|fnt_norm
operator|=
name|fInfo
operator|->
name|id
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|enbolden
condition|)
name|screen
operator|->
name|fnt_bold
operator|=
name|screen
operator|->
name|fnt_norm
expr_stmt|;
name|XSetResizeHint
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|statusheight
argument_list|,
name|fInfo
operator|->
name|width
argument_list|,
name|fInfo
operator|->
name|height
argument_list|)
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|f_width
operator|=
name|fInfo
operator|->
name|width
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|f_height
operator|=
name|fInfo
operator|->
name|height
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fInfo
argument_list|)
expr_stmt|;
name|width
operator|=
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
expr_stmt|;
name|height
operator|=
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
expr_stmt|;
name|border
operator|=
literal|2
operator|*
name|screen
operator|->
name|border
expr_stmt|;
name|extra
operator|=
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|statusheight
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|fullwidth
operator|=
name|width
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|fullheight
operator|=
name|height
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|height
operator|=
name|height
operator|-
name|extra
expr_stmt|;
name|screen
operator|->
name|fullVwin
operator|.
name|width
operator|=
name|width
expr_stmt|;
name|vp
operator|=
operator|&
name|VTbox
index|[
literal|1
index|]
expr_stmt|;
operator|(
name|vp
operator|++
operator|)
operator|->
name|x
operator|=
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
expr_stmt|;
operator|(
name|vp
operator|++
operator|)
operator|->
name|y
operator|=
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
expr_stmt|;
operator|(
name|vp
operator|++
operator|)
operator|->
name|x
operator|=
operator|-
operator|(
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|vp
operator|->
name|y
operator|=
operator|-
operator|(
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
name|ResizeScrollBar
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
name|width
operator|-
name|SCROLLBARWIDTH
argument_list|,
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
argument_list|,
name|height
operator|-
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|title
operator|.
name|tbar
condition|)
name|VTTitleResize
argument_list|(
name|width
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|VTExpose
argument_list|(
name|rep
argument_list|)
specifier|register
name|XExposeWindowEvent
operator|*
name|rep
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|rep
operator|&&
name|ScreenResize
argument_list|(
name|screen
argument_list|,
name|rep
operator|->
name|width
argument_list|,
name|rep
operator|->
name|height
argument_list|,
operator|&
name|term
operator|.
name|flags
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return;
name|XClear
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|+
name|screen
operator|->
name|statusline
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Shows cursor at new cursor position in screen.  */
end_comment

begin_macro
name|ShowCursor
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|fg
decl_stmt|;
specifier|register
name|int
name|bg
decl_stmt|;
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|flags
decl_stmt|;
specifier|register
name|Font
name|fnt
decl_stmt|;
name|char
name|c
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|&&
operator|!
name|screen
operator|->
name|active_icon
condition|)
return|return;
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
operator|&&
name|screen
operator|->
name|cur_row
operator|-
name|screen
operator|->
name|topline
operator|>
name|screen
operator|->
name|max_row
condition|)
return|return;
name|c
operator|=
name|screen
operator|->
name|buf
index|[
name|y
operator|=
literal|2
operator|*
operator|(
name|screen
operator|->
name|cursor_row
operator|=
name|screen
operator|->
name|cur_row
operator|)
index|]
index|[
name|x
operator|=
name|screen
operator|->
name|cursor_col
operator|=
name|screen
operator|->
name|cur_col
index|]
expr_stmt|;
name|flags
operator|=
name|screen
operator|->
name|buf
index|[
name|y
operator|+
literal|1
index|]
index|[
name|x
index|]
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
condition|)
name|c
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|instatus
condition|)
name|flags
operator|^=
name|INVERSE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|select
condition|)
block|{
if|if
condition|(
name|flags
operator|&
name|INVERSE
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|cursorcolor
operator|!=
name|screen
operator|->
name|foreground
condition|)
block|{
name|fg
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
name|bg
operator|=
name|screen
operator|->
name|cursorcolor
expr_stmt|;
block|}
else|else
block|{
name|fg
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
name|bg
operator|=
name|screen
operator|->
name|background
expr_stmt|;
block|}
block|}
else|else
block|{
name|fg
operator|=
name|screen
operator|->
name|background
expr_stmt|;
name|bg
operator|=
name|screen
operator|->
name|cursorcolor
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|flags
operator|&
name|INVERSE
condition|)
block|{
name|fg
operator|=
name|screen
operator|->
name|background
expr_stmt|;
name|bg
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
block|}
else|else
block|{
name|fg
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
name|bg
operator|=
name|screen
operator|->
name|background
expr_stmt|;
block|}
block|}
name|fnt
operator|=
name|ActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|screen
operator|->
name|fnt_icon
else|:
operator|(
name|flags
operator|&
name|BOLD
operator|)
condition|?
name|screen
operator|->
name|fnt_bold
else|:
name|screen
operator|->
name|fnt_norm
expr_stmt|;
name|XText
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
operator|=
name|CursorX
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_col
argument_list|)
argument_list|,
name|y
operator|=
name|CursorY
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|)
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|,
name|fnt
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BOLD
operator|)
operator|&&
name|screen
operator|->
name|enbolden
condition|)
name|XTextMask
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|y
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|,
name|fnt
argument_list|,
name|fg
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|UNDERLINE
condition|)
block|{
name|bg
operator|=
name|y
operator|+
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|-
literal|2
expr_stmt|;
name|XLine
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
argument_list|,
name|bg
argument_list|,
name|x
operator|+
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|bg
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|fg
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|screen
operator|->
name|select
operator|&&
operator|!
name|ActiveIcon
argument_list|(
name|screen
argument_list|)
condition|)
block|{
name|screen
operator|->
name|box
operator|->
name|x
operator|=
name|x
expr_stmt|;
name|screen
operator|->
name|box
operator|->
name|y
operator|=
name|y
expr_stmt|;
name|XDraw
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|box
argument_list|,
name|NBOX
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|fg
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|cursor_state
operator|=
name|ON
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * hide cursor at previous cursor position in screen.  */
end_comment

begin_macro
name|HideCursor
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|fg
decl_stmt|;
specifier|register
name|int
name|bg
decl_stmt|;
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|flags
decl_stmt|,
name|instatus
decl_stmt|;
specifier|register
name|Font
name|fnt
decl_stmt|;
name|char
name|c
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|&&
operator|!
name|screen
operator|->
name|active_icon
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|instatus
operator|=
name|screen
operator|->
name|cursor_row
operator|>
name|screen
operator|->
name|max_row
operator|)
operator|&&
name|screen
operator|->
name|cursor_row
operator|-
name|screen
operator|->
name|topline
operator|>
name|screen
operator|->
name|max_row
condition|)
return|return;
name|c
operator|=
name|screen
operator|->
name|buf
index|[
name|y
operator|=
literal|2
operator|*
name|screen
operator|->
name|cursor_row
index|]
index|[
name|x
operator|=
name|screen
operator|->
name|cursor_col
index|]
expr_stmt|;
name|flags
operator|=
name|screen
operator|->
name|buf
index|[
name|y
operator|+
literal|1
index|]
index|[
name|x
index|]
expr_stmt|;
if|if
condition|(
name|instatus
condition|)
name|flags
operator|^=
name|INVERSE
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|INVERSE
condition|)
block|{
name|fg
operator|=
name|screen
operator|->
name|background
expr_stmt|;
name|bg
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
block|}
else|else
block|{
name|fg
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
name|bg
operator|=
name|screen
operator|->
name|background
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|==
literal|0
condition|)
name|c
operator|=
literal|' '
expr_stmt|;
name|y
operator|=
operator|(
name|instatus
condition|?
operator|(
name|screen
operator|->
name|cursor_row
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
literal|1
operator|)
else|:
operator|(
operator|(
name|screen
operator|->
name|cursor_row
operator|-
name|screen
operator|->
name|topline
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|)
operator|)
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
expr_stmt|;
name|fnt
operator|=
name|ActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|screen
operator|->
name|fnt_icon
else|:
operator|(
name|flags
operator|&
name|BOLD
operator|)
condition|?
name|screen
operator|->
name|fnt_bold
else|:
name|screen
operator|->
name|fnt_norm
expr_stmt|;
name|XText
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
operator|=
name|CursorX
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cursor_col
argument_list|)
argument_list|,
name|y
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|,
name|fnt
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|BOLD
operator|)
operator|&&
name|screen
operator|->
name|enbolden
condition|)
name|XTextMask
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
operator|+
literal|1
argument_list|,
name|y
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|,
name|fnt
argument_list|,
name|fg
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|UNDERLINE
condition|)
block|{
name|y
operator|+=
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|-
literal|2
expr_stmt|;
name|XLine
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|x
operator|+
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|y
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|fg
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|cursor_state
operator|=
name|OFF
expr_stmt|;
block|}
end_block

begin_macro
name|VTSelect
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|grayborder
operator|&&
name|screen
operator|->
name|borderwidth
operator|>
literal|0
condition|)
name|XChangeBorder
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bordertile
argument_list|)
expr_stmt|;
if|if
condition|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
condition|)
name|VTTitleHilite
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|VTUnselect
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|grayborder
operator|&&
name|screen
operator|->
name|borderwidth
operator|>
literal|0
condition|)
name|XChangeBorder
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|graybordertile
argument_list|)
expr_stmt|;
if|if
condition|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
condition|)
name|VTTitleUnhilite
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|VTReset
argument_list|(
argument|full
argument_list|)
end_macro

begin_decl_stmt
name|int
name|full
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
comment|/* reset scrolling region */
name|screen
operator|->
name|top_marg
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|bot_marg
operator|=
name|screen
operator|->
name|max_row
expr_stmt|;
name|term
operator|.
name|flags
operator|&=
operator|~
name|ORIGIN
expr_stmt|;
if|if
condition|(
name|full
condition|)
block|{
name|TabReset
argument_list|(
name|term
operator|.
name|tabs
argument_list|)
expr_stmt|;
name|term
operator|.
name|keyboard
operator|.
name|flags
operator|=
name|NULL
expr_stmt|;
name|screen
operator|->
name|gsets
index|[
literal|0
index|]
operator|=
literal|'B'
expr_stmt|;
name|screen
operator|->
name|gsets
index|[
literal|1
index|]
operator|=
literal|'B'
expr_stmt|;
name|screen
operator|->
name|gsets
index|[
literal|2
index|]
operator|=
literal|'B'
expr_stmt|;
name|screen
operator|->
name|gsets
index|[
literal|3
index|]
operator|=
literal|'B'
expr_stmt|;
name|screen
operator|->
name|curgl
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|curgr
operator|=
literal|2
expr_stmt|;
name|screen
operator|->
name|curss
operator|=
literal|0
expr_stmt|;
name|ClearScreen
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|cursor_state
operator|=
name|OFF
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|term
operator|.
name|flags
operator|&
name|AUTOREPEAT
operator|)
condition|)
name|XAutoRepeatOn
argument_list|()
expr_stmt|;
if|if
condition|(
name|term
operator|.
name|flags
operator|&
name|REVERSE_VIDEO
condition|)
name|ReverseVideo
argument_list|(
operator|&
name|term
argument_list|)
expr_stmt|;
name|term
operator|.
name|flags
operator|=
name|term
operator|.
name|initflags
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|c132
operator|&&
operator|(
name|term
operator|.
name|flags
operator|&
name|IN132COLUMNS
operator|)
condition|)
block|{
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
literal|80
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
argument_list|)
expr_stmt|;
name|XSync
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|/* synchronize */
if|if
condition|(
name|QLength
argument_list|()
operator|>
literal|0
condition|)
name|xevents
argument_list|()
expr_stmt|;
block|}
name|CursorSet
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|term
operator|.
name|flags
argument_list|)
expr_stmt|;
block|}
name|longjmp
argument_list|(
name|vtjmpbuf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* force ground state in parser */
block|}
end_block

begin_macro
name|ToStatus
argument_list|(
argument|col
argument_list|)
end_macro

begin_decl_stmt
name|int
name|col
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|col
operator|>
name|screen
operator|->
name|max_col
condition|)
name|col
operator|=
name|screen
operator|->
name|max_col
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|!
name|screen
operator|->
name|statusline
condition|)
name|ShowStatus
argument_list|()
expr_stmt|;
name|CursorSave
argument_list|(
operator|&
name|term
argument_list|,
operator|&
name|screen
operator|->
name|statussc
argument_list|)
expr_stmt|;
name|screen
operator|->
name|instatus
operator|=
name|TRUE
expr_stmt|;
name|screen
operator|->
name|cur_row
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
block|}
name|screen
operator|->
name|cur_col
operator|=
name|col
expr_stmt|;
block|}
end_block

begin_macro
name|FromStatus
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|instatus
condition|)
return|return;
name|screen
operator|->
name|instatus
operator|=
name|FALSE
expr_stmt|;
name|CursorRestore
argument_list|(
operator|&
name|term
argument_list|,
operator|&
name|screen
operator|->
name|statussc
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ShowStatus
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|statusline
condition|)
return|return;
name|screen
operator|->
name|statusline
operator|=
literal|1
expr_stmt|;
name|screen
operator|->
name|statusheight
operator|=
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
literal|2
expr_stmt|;
name|XSetResizeHint
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|statusheight
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
operator|+
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|HideStatus
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|statusline
condition|)
return|return;
if|if
condition|(
name|screen
operator|->
name|instatus
condition|)
name|FromStatus
argument_list|()
expr_stmt|;
name|screen
operator|->
name|statusline
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|statusheight
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
name|i
operator|=
literal|2
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
index|]
argument_list|,
name|j
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|XSetResizeHint
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|*
name|j
operator|+
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|+
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|EraseStatus
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|pix
decl_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|statusline
condition|)
return|return;
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
name|i
operator|=
literal|2
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
index|]
argument_list|,
name|j
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
operator|-
literal|1
argument_list|,
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|j
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
literal|2
argument_list|,
name|screen
operator|->
name|statusheight
argument_list|,
name|screen
operator|->
name|reversestatus
condition|?
name|screen
operator|->
name|foreground
else|:
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|reversestatus
condition|)
name|StatusBox
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|StatusBox
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|status_box
index|[
literal|0
index|]
operator|.
name|y
operator|=
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|status_box
index|[
literal|3
index|]
operator|.
name|x
operator|=
operator|-
operator|(
name|status_box
index|[
literal|1
index|]
operator|.
name|x
operator|=
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
literal|1
operator|)
expr_stmt|;
name|status_box
index|[
literal|4
index|]
operator|.
name|y
operator|=
operator|-
operator|(
name|status_box
index|[
literal|2
index|]
operator|.
name|y
operator|=
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
literal|1
operator|)
expr_stmt|;
name|XDraw
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|status_box
argument_list|,
name|NBOX
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|foreground
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|VTTitleShow
argument_list|(
argument|init
argument_list|)
end_macro

begin_decl_stmt
name|int
name|init
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|title
operator|.
name|tbar
condition|)
name|VTTitleInit
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|init
condition|)
block|{
name|XSetResizeHint
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|statusheight
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
operator|+
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|select
operator|&&
operator|!
name|screen
operator|->
name|TekEmu
condition|)
name|VTTitleHilite
argument_list|()
expr_stmt|;
else|else
name|VTTitleUnhilite
argument_list|()
expr_stmt|;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|VTTitleHide
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
name|XUnmapWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|)
expr_stmt|;
name|XSetResizeHint
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|border
operator|+
name|screen
operator|->
name|statusheight
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
operator|+
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|border
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|VTTitleHilite
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|title
operator|.
name|hilited
condition|)
return|return;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|left
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|right
argument_list|)
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|hilited
operator|=
name|TRUE
expr_stmt|;
block|}
end_block

begin_macro
name|VTTitleUnhilite
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|title
operator|.
name|hilited
condition|)
return|return;
name|XUnmapWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|left
argument_list|)
expr_stmt|;
name|XUnmapWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|right
argument_list|)
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|hilited
operator|=
name|FALSE
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|VTTitleResize
argument_list|(
name|width
argument_list|)
specifier|register
name|int
name|width
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|title
operator|.
name|width
operator|=
name|i
operator|=
name|screen
operator|->
name|title
operator|.
name|fullwidth
operator|)
operator|>
operator|(
name|j
operator|=
name|width
operator|-
literal|2
operator|*
operator|(
name|MINHILITE
operator|+
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
operator|)
condition|)
name|screen
operator|->
name|title
operator|.
name|width
operator|=
operator|(
name|i
operator|=
name|j
operator|)
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|j
operator|=
name|width
operator|-
name|i
operator|-
literal|2
operator|*
operator|(
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
expr_stmt|;
name|i
operator|=
name|j
operator|/
literal|2
expr_stmt|;
name|j
operator|-=
name|i
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|x
operator|=
name|i
operator|+
literal|1
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|,
name|width
argument_list|,
name|screen
operator|->
name|titleheight
operator|-
literal|1
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|left
argument_list|,
name|i
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|height
argument_list|)
expr_stmt|;
name|XConfigureWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|right
argument_list|,
name|width
operator|-
name|j
operator|-
literal|1
argument_list|,
name|TITLEPAD
argument_list|,
name|j
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|VTTitleExpose
argument_list|(
name|rep
argument_list|)
specifier|register
name|XExposeWindowEvent
operator|*
name|rep
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|rep
operator|&&
operator|(
name|rep
operator|->
name|x
operator|>
operator|(
name|screen
operator|->
name|title
operator|.
name|x
operator|+
name|screen
operator|->
name|title
operator|.
name|width
operator|)
operator|||
operator|(
name|rep
operator|->
name|x
operator|+
name|rep
operator|->
name|width
operator|)
operator|<
name|screen
operator|->
name|title
operator|.
name|x
operator|||
name|rep
operator|->
name|y
operator|>
operator|(
name|screen
operator|->
name|title
operator|.
name|y
operator|+
name|screen
operator|->
name|titlefont
operator|->
name|height
operator|)
operator|||
operator|(
name|rep
operator|->
name|y
operator|+
name|rep
operator|->
name|height
operator|)
operator|<
name|screen
operator|->
name|title
operator|.
name|y
operator|)
condition|)
return|return;
name|XText
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|,
name|screen
operator|->
name|title
operator|.
name|x
argument_list|,
name|screen
operator|->
name|title
operator|.
name|y
argument_list|,
name|screen
operator|->
name|winname
argument_list|,
name|screen
operator|->
name|winnamelen
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|id
argument_list|,
name|screen
operator|->
name|foreground
argument_list|,
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|VTTitleInit
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|w
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|OpaqueFrame
name|hilite
index|[
literal|2
index|]
decl_stmt|;
specifier|extern
name|Pixmap
name|make_hilite
parameter_list|()
function_decl|;
if|if
condition|(
operator|(
name|screen
operator|->
name|title
operator|.
name|tbar
operator|=
name|XCreateWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
name|w
operator|=
name|FullWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|titleheight
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|bordertile
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Error
argument_list|(
name|ERROR_CRTITLE
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|,
name|ButtonPressed
operator||
name|ButtonReleased
operator||
name|ExposeWindow
operator||
name|EnterWindow
operator||
name|LeaveWindow
operator||
name|UnmapWindow
argument_list|)
expr_stmt|;
name|XDefineCursor
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|,
name|screen
operator|->
name|arrow
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|hilitetile
operator|&&
operator|(
name|screen
operator|->
name|hilitetile
operator|=
name|make_hilite
argument_list|(
name|screen
operator|->
name|foreground
argument_list|,
name|screen
operator|->
name|background
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Error
argument_list|(
name|ERROR_HILITE
argument_list|)
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|fullwidth
operator|=
name|XQueryWidth
argument_list|(
name|screen
operator|->
name|winname
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|title
operator|.
name|width
operator|=
name|i
operator|=
name|screen
operator|->
name|title
operator|.
name|fullwidth
operator|)
operator|>
operator|(
name|j
operator|=
name|w
operator|-
literal|2
operator|*
operator|(
name|MINHILITE
operator|+
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
operator|)
condition|)
name|screen
operator|->
name|title
operator|.
name|width
operator|=
operator|(
name|i
operator|=
name|j
operator|)
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|j
operator|=
name|w
operator|-
name|i
operator|-
literal|2
operator|*
operator|(
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
expr_stmt|;
name|i
operator|=
name|j
operator|/
literal|2
expr_stmt|;
name|j
operator|-=
name|i
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|x
operator|=
name|i
operator|+
literal|1
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|y
operator|=
name|TITLEPAD
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|x
operator|=
literal|1
expr_stmt|;
name|hilite
index|[
literal|1
index|]
operator|.
name|x
operator|=
name|w
operator|-
name|j
operator|-
literal|1
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|y
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|y
operator|=
name|TITLEPAD
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|width
operator|=
name|i
expr_stmt|;
name|hilite
index|[
literal|1
index|]
operator|.
name|width
operator|=
name|j
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|height
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|height
operator|=
name|screen
operator|->
name|titlefont
operator|->
name|height
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|bdrwidth
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|bdrwidth
operator|=
literal|0
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|border
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|border
operator|=
name|NULL
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|background
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|background
operator|=
name|screen
operator|->
name|hilitetile
expr_stmt|;
if|if
condition|(
name|XCreateWindows
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|,
name|hilite
argument_list|,
literal|2
argument_list|)
operator|!=
literal|2
condition|)
name|Error
argument_list|(
name|ERROR_CRLFRG
argument_list|)
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|left
operator|=
name|hilite
index|[
literal|0
index|]
operator|.
name|self
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|right
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|self
expr_stmt|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|MODEMENU
end_ifdef

begin_define
define|#
directive|define
name|MMENU_SCROLL
value|0
end_define

begin_define
define|#
directive|define
name|MMENU_VIDEO
value|(MMENU_SCROLL+1)
end_define

begin_define
define|#
directive|define
name|MMENU_WRAP
value|(MMENU_VIDEO+1)
end_define

begin_define
define|#
directive|define
name|MMENU_REVERSEWRAP
value|(MMENU_WRAP+1)
end_define

begin_define
define|#
directive|define
name|MMENU_NLM
value|(MMENU_REVERSEWRAP+1)
end_define

begin_define
define|#
directive|define
name|MMENU_CURSOR
value|(MMENU_NLM+1)
end_define

begin_define
define|#
directive|define
name|MMENU_PAD
value|(MMENU_CURSOR+1)
end_define

begin_define
define|#
directive|define
name|MMENU_REPEAT
value|(MMENU_PAD+1)
end_define

begin_define
define|#
directive|define
name|MMENU_SCROLLBAR
value|(MMENU_REPEAT+1)
end_define

begin_define
define|#
directive|define
name|MMENU_PAGEMODE
value|(MMENU_SCROLLBAR+1)
end_define

begin_define
define|#
directive|define
name|MMENU_STATUS
value|(MMENU_PAGEMODE+1)
end_define

begin_define
define|#
directive|define
name|MMENU_REVSTATUS
value|(MMENU_STATUS+1)
end_define

begin_define
define|#
directive|define
name|MMENU_C132
value|(MMENU_REVSTATUS+1)
end_define

begin_define
define|#
directive|define
name|MMENU_CURSES
value|(MMENU_C132+1)
end_define

begin_define
define|#
directive|define
name|MMENU_MARGBELL
value|(MMENU_CURSES+1)
end_define

begin_define
define|#
directive|define
name|MMENU_TEKWIN
value|(MMENU_MARGBELL+1)
end_define

begin_define
define|#
directive|define
name|MMENU_ALTERN
value|(MMENU_TEKWIN+1)
end_define

begin_define
define|#
directive|define
name|MMENU_LINE
value|(MMENU_ALTERN+1)
end_define

begin_define
define|#
directive|define
name|MMENU_RESET
value|(MMENU_LINE+1)
end_define

begin_define
define|#
directive|define
name|MMENU_FULLRESET
value|(MMENU_RESET+1)
end_define

begin_define
define|#
directive|define
name|MMENU_TEKMODE
value|(MMENU_FULLRESET+1)
end_define

begin_define
define|#
directive|define
name|MMENU_HIDEVT
value|(MMENU_TEKMODE+1)
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|vtext
index|[]
init|=
block|{
literal|"Jump Scroll"
block|,
literal|"Reverse Video"
block|,
literal|"Auto Wraparound"
block|,
literal|"Reverse Wraparound"
block|,
literal|"Auto Linefeed"
block|,
literal|"Application Cursors"
block|,
literal|"Application Pad"
block|,
literal|"Auto Repeat"
block|,
literal|"Scrollbar"
block|,
literal|"Page Scroll"
block|,
literal|"Status Line"
block|,
literal|"Reverse Status Line"
block|,
literal|"80<-> 132 Columns"
block|,
literal|"Curses Emulation"
block|,
literal|"Margin Bell"
block|,
literal|"Tek Window Showing"
block|,
literal|"Alternate Screen"
block|,
literal|"-"
block|,
literal|"Soft Reset"
block|,
literal|"Full Reset"
block|,
literal|"Select Tek Mode"
block|,
literal|"Hide VT Window"
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|menutermflags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|menukbdflags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|t132
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|taltern
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tcurses
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tmarginbell
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tpagemode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|trevstatus
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tscrollbar
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tshow
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tstatusline
decl_stmt|;
end_decl_stmt

begin_function
name|Menu
modifier|*
name|setupmenu
parameter_list|(
name|menu
parameter_list|)
specifier|register
name|Menu
modifier|*
modifier|*
name|menu
decl_stmt|;
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|flags
init|=
name|term
operator|.
name|flags
decl_stmt|;
specifier|register
name|int
name|kflags
init|=
name|term
operator|.
name|keyboard
operator|.
name|flags
decl_stmt|;
if|if
condition|(
operator|*
name|menu
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|menu
operator|=
name|NewMenu
argument_list|(
literal|"Modes"
argument_list|,
name|re_verse
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|cp
operator|=
name|vtext
init|;
operator|*
name|cp
condition|;
name|cp
operator|++
control|)
name|AddMenuItem
argument_list|(
operator|*
name|menu
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|SMOOTHSCROLL
operator|)
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_SCROLL
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|REVERSE_VIDEO
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_VIDEO
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|WRAPAROUND
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_WRAP
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|REVERSEWRAP
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_REVERSEWRAP
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|LINEFEED
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_NLM
argument_list|)
expr_stmt|;
if|if
condition|(
name|kflags
operator|&
name|CURSOR_APL
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_CURSOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|kflags
operator|&
name|KYPD_APL
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_PAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|AUTOREPEAT
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_REPEAT
argument_list|)
expr_stmt|;
if|if
condition|(
name|tscrollbar
operator|=
operator|(
name|screen
operator|->
name|scrollbar
operator|>
literal|0
operator|)
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_SCROLLBAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|tpagemode
operator|=
name|screen
operator|->
name|pagemode
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_PAGEMODE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tstatusline
operator|=
name|screen
operator|->
name|statusline
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|trevstatus
operator|=
name|screen
operator|->
name|reversestatus
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_REVSTATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|t132
operator|=
name|screen
operator|->
name|c132
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_C132
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcurses
operator|=
name|screen
operator|->
name|curses
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_CURSES
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmarginbell
operator|=
name|screen
operator|->
name|marginbell
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_MARGBELL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tshow
operator|=
name|screen
operator|->
name|Tshow
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_TEKWIN
argument_list|)
expr_stmt|;
else|else
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_HIDEVT
argument_list|)
expr_stmt|;
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_ALTERN
argument_list|)
expr_stmt|;
if|if
condition|(
name|taltern
operator|=
name|screen
operator|->
name|alternate
condition|)
block|{
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_ALTERN
argument_list|)
expr_stmt|;
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_PAGEMODE
argument_list|)
expr_stmt|;
block|}
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|inhibit
operator|&
name|I_TEK
condition|)
block|{
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_TEKWIN
argument_list|)
expr_stmt|;
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_TEKMODE
argument_list|)
expr_stmt|;
block|}
name|menutermflags
operator|=
name|flags
expr_stmt|;
name|menukbdflags
operator|=
name|kflags
expr_stmt|;
return|return
operator|(
operator|*
name|menu
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|menutermflags
operator|^=
name|flags
operator|)
operator|&
name|SMOOTHSCROLL
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_SCROLL
argument_list|,
operator|!
operator|(
name|flags
operator|&
name|SMOOTHSCROLL
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|menutermflags
operator|&
name|REVERSE_VIDEO
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_VIDEO
argument_list|,
name|flags
operator|&
name|REVERSE_VIDEO
argument_list|)
expr_stmt|;
if|if
condition|(
name|menutermflags
operator|&
name|WRAPAROUND
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_WRAP
argument_list|,
name|flags
operator|&
name|WRAPAROUND
argument_list|)
expr_stmt|;
if|if
condition|(
name|menutermflags
operator|&
name|REVERSEWRAP
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_REVERSEWRAP
argument_list|,
name|flags
operator|&
name|REVERSEWRAP
argument_list|)
expr_stmt|;
if|if
condition|(
name|menutermflags
operator|&
name|LINEFEED
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_NLM
argument_list|,
name|flags
operator|&
name|LINEFEED
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|menukbdflags
operator|^=
name|kflags
operator|)
operator|&
name|CURSOR_APL
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_CURSOR
argument_list|,
name|kflags
operator|&
name|CURSOR_APL
argument_list|)
expr_stmt|;
if|if
condition|(
name|menukbdflags
operator|&
name|KYPD_APL
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_PAD
argument_list|,
name|NULL
argument_list|,
name|kflags
operator|&
name|KYPD_APL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tscrollbar
operator|!=
operator|(
name|screen
operator|->
name|scrollbar
operator|>
literal|0
operator|)
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_SCROLLBAR
argument_list|,
operator|(
name|tscrollbar
operator|=
operator|(
name|screen
operator|->
name|scrollbar
operator|>
literal|0
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tpagemode
operator|!=
name|screen
operator|->
name|pagemode
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_PAGEMODE
argument_list|,
operator|(
name|tpagemode
operator|=
name|screen
operator|->
name|pagemode
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tstatusline
operator|!=
name|screen
operator|->
name|statusline
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_STATUS
argument_list|,
operator|(
name|tstatusline
operator|=
name|screen
operator|->
name|statusline
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|trevstatus
operator|!=
name|screen
operator|->
name|reversestatus
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_REVSTATUS
argument_list|,
operator|(
name|trevstatus
operator|=
name|screen
operator|->
name|reversestatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t132
operator|!=
name|screen
operator|->
name|c132
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_C132
argument_list|,
operator|(
name|t132
operator|=
name|screen
operator|->
name|c132
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcurses
operator|!=
name|screen
operator|->
name|curses
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_CURSES
argument_list|,
operator|(
name|tcurses
operator|=
name|screen
operator|->
name|curses
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmarginbell
operator|!=
name|screen
operator|->
name|marginbell
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_MARGBELL
argument_list|,
operator|(
name|tmarginbell
operator|=
name|screen
operator|->
name|marginbell
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tshow
operator|!=
name|screen
operator|->
name|Tshow
condition|)
block|{
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_TEKWIN
argument_list|,
operator|(
name|tshow
operator|=
name|screen
operator|->
name|Tshow
operator|)
argument_list|)
expr_stmt|;
name|SetItemDisable
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_HIDEVT
argument_list|,
operator|!
name|tshow
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|taltern
operator|!=
name|screen
operator|->
name|alternate
condition|)
block|{
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_ALTERN
argument_list|,
operator|(
name|taltern
operator|=
name|screen
operator|->
name|alternate
operator|)
argument_list|)
expr_stmt|;
name|SetItemDisable
argument_list|(
operator|*
name|menu
argument_list|,
name|MMENU_PAGEMODE
argument_list|,
name|taltern
argument_list|)
expr_stmt|;
block|}
name|menutermflags
operator|=
name|flags
expr_stmt|;
name|menukbdflags
operator|=
name|kflags
expr_stmt|;
return|return
operator|(
operator|*
name|menu
operator|)
return|;
block|}
end_function

begin_macro
name|domenufunc
argument_list|(
argument|item
argument_list|)
end_macro

begin_decl_stmt
name|int
name|item
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
switch|switch
condition|(
name|item
condition|)
block|{
case|case
name|MMENU_SCROLL
case|:
name|term
operator|.
name|flags
operator|^=
name|SMOOTHSCROLL
expr_stmt|;
if|if
condition|(
name|term
operator|.
name|flags
operator|&
name|SMOOTHSCROLL
condition|)
block|{
name|screen
operator|->
name|jumpscroll
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|jumpscroll
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|MMENU_VIDEO
case|:
name|term
operator|.
name|flags
operator|^=
name|REVERSE_VIDEO
expr_stmt|;
name|ReverseVideo
argument_list|(
operator|&
name|term
argument_list|)
expr_stmt|;
break|break;
case|case
name|MMENU_WRAP
case|:
name|term
operator|.
name|flags
operator|^=
name|WRAPAROUND
expr_stmt|;
break|break;
case|case
name|MMENU_REVERSEWRAP
case|:
name|term
operator|.
name|flags
operator|^=
name|REVERSEWRAP
expr_stmt|;
break|break;
case|case
name|MMENU_NLM
case|:
name|term
operator|.
name|flags
operator|^=
name|LINEFEED
expr_stmt|;
break|break;
case|case
name|MMENU_CURSOR
case|:
name|term
operator|.
name|keyboard
operator|.
name|flags
operator|^=
name|CURSOR_APL
expr_stmt|;
break|break;
case|case
name|MMENU_PAD
case|:
name|term
operator|.
name|keyboard
operator|.
name|flags
operator|^=
name|KYPD_APL
expr_stmt|;
break|break;
case|case
name|MMENU_REPEAT
case|:
name|term
operator|.
name|flags
operator|^=
name|AUTOREPEAT
expr_stmt|;
if|if
condition|(
name|term
operator|.
name|flags
operator|&
name|AUTOREPEAT
condition|)
name|XAutoRepeatOn
argument_list|()
expr_stmt|;
else|else
name|XAutoRepeatOff
argument_list|()
expr_stmt|;
break|break;
case|case
name|MMENU_SCROLLBAR
case|:
if|if
condition|(
name|screen
operator|->
name|scrollbar
condition|)
name|ScrollBarOff
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|ScrollBarOn
argument_list|(
name|screen
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
break|break;
case|case
name|MMENU_PAGEMODE
case|:
if|if
condition|(
name|screen
operator|->
name|pagemode
operator|=
operator|!
name|screen
operator|->
name|pagemode
condition|)
name|screen
operator|->
name|pagecnt
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|MMENU_STATUS
case|:
if|if
condition|(
name|screen
operator|->
name|statusline
condition|)
name|HideStatus
argument_list|()
expr_stmt|;
else|else
name|ShowStatus
argument_list|()
expr_stmt|;
break|break;
case|case
name|MMENU_REVSTATUS
case|:
name|screen
operator|->
name|reversestatus
operator|=
operator|!
name|screen
operator|->
name|reversestatus
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|MMENU_C132
case|:
name|screen
operator|->
name|c132
operator|=
operator|!
name|screen
operator|->
name|c132
expr_stmt|;
break|break;
case|case
name|MMENU_MARGBELL
case|:
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|marginbell
operator|=
operator|!
name|screen
operator|->
name|marginbell
operator|)
condition|)
name|screen
operator|->
name|bellarmed
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
name|MMENU_CURSES
case|:
name|screen
operator|->
name|curses
operator|=
operator|!
name|screen
operator|->
name|curses
expr_stmt|;
break|break;
case|case
name|MMENU_FULLRESET
case|:
name|VTReset
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
break|break;
case|case
name|MMENU_RESET
case|:
name|VTReset
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
break|break;
case|case
name|MMENU_HIDEVT
case|:
name|screen
operator|->
name|show
operator|=
name|FALSE
expr_stmt|;
name|XUnmapWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|reselectwindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|SyncUnmap
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|WINDOWEVENTS
argument_list|)
expr_stmt|;
comment|/* drop through */
case|case
name|MMENU_TEKMODE
case|:
if|if
condition|(
operator|!
name|screen
operator|->
name|TekEmu
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
block|{
name|FlushLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|logstart
operator|=
name|Tbuffer
expr_stmt|;
block|}
name|screen
operator|->
name|TekEmu
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|pagemode
condition|)
block|{
name|Scroll
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|pagecnt
argument_list|)
expr_stmt|;
name|screen
operator|->
name|pagecnt
operator|=
literal|0
expr_stmt|;
name|ioctl
argument_list|(
name|screen
operator|->
name|respond
argument_list|,
name|TIOCSTART
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|longjmp
argument_list|(
name|VTend
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|XRaiseWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MMENU_TEKWIN
case|:
if|if
condition|(
name|screen
operator|->
name|Tshow
operator|=
operator|!
name|screen
operator|->
name|Tshow
condition|)
block|{
if|if
condition|(
name|TWindow
argument_list|(
name|screen
argument_list|)
operator|||
name|TekInit
argument_list|()
condition|)
block|{
name|XMapWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Tshow
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
else|else
block|{
name|screen
operator|->
name|Tshow
operator|=
name|FALSE
expr_stmt|;
name|XUnmapWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|SyncUnmap
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|TWINDOWEVENTS
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
block|{
name|FlushLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|logstart
operator|=
name|buffer
expr_stmt|;
block|}
name|longjmp
argument_list|(
name|Tekend
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|reselectwindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
endif|MODEMENU
end_endif

end_unit


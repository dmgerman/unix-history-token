begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	$Source: /u1/X/xterm/RCS/button.c,v $  *	$Header: button.c,v 10.103 86/12/02 09:49:20 swick Exp $  */
end_comment

begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1984, 1985	*/
end_comment

begin_comment
comment|/* button.c	Handles button events in the terminal emulator. 		does cut/paste operations, change modes via menu, 		passes button events through to some applications. 				J. Gettys. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|csrg_id
index|[]
init|=
literal|"@(#)button.c	1.6\t(Berkeley/CSRG)\t9/18/87"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|sccs_id
index|[]
init|=
literal|"@(#)button.c\tX10/6.6B\t12/26/86"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|"scrollbar.h"
end_include

begin_include
include|#
directive|include
file|"ptyx.h"
end_include

begin_include
include|#
directive|include
file|"data.h"
end_include

begin_include
include|#
directive|include
file|"error.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|MODEMENU
end_ifdef

begin_include
include|#
directive|include
file|"menu.h"
end_include

begin_endif
endif|#
directive|endif
endif|MODEMENU
end_endif

begin_define
define|#
directive|define
name|NBUTS
value|3
end_define

begin_define
define|#
directive|define
name|DIRS
value|2
end_define

begin_define
define|#
directive|define
name|UP
value|1
end_define

begin_define
define|#
directive|define
name|DOWN
value|0
end_define

begin_define
define|#
directive|define
name|SHIFTS
value|8
end_define

begin_comment
comment|/* three keys, so eight combinations */
end_comment

begin_define
define|#
directive|define
name|Coordinate
parameter_list|(
name|r
parameter_list|,
name|c
parameter_list|)
value|((r) * ncols + (c))
end_define

begin_function_decl
name|char
modifier|*
name|GetRestOfLine
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|SaveText
parameter_list|()
function_decl|;
end_function_decl

begin_extern
extern|extern UnSaltText(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_extern
extern|extern StartCut(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_extern
extern|extern ReExecute(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_extern
extern|extern EditorDown(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_extern
extern|extern ButtonUp(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_extern
extern|extern DownButtonDown(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_extern
extern|extern MiddleButtonDown(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_extern
extern|extern UpButtonDown(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_extern
extern|extern ModeMenu(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|xterm_name
decl_stmt|;
end_decl_stmt

begin_extern
extern|extern Bogus(
end_extern

begin_operator
unit|)
operator|,
end_operator

begin_expr_stmt
name|Silence
argument_list|()
expr_stmt|;
end_expr_stmt

begin_extern
extern|extern GINbutton(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_comment
comment|/* due to LK201 limitations, not all of the below are actually possible */
end_comment

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|bfunc
index|[
name|SHIFTS
index|]
index|[
name|DIRS
index|]
index|[
name|NBUTS
index|]
function_decl|)
parameter_list|()
init|=
block|{
comment|/*	left		middle		right	*/
name|EditorDown
operator|,
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|no shift */
function_decl|ReExecute
operator|,
function_decl|StartCut
operator|,
function_decl|Silence
operator|,
comment|/* down |	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|UnSaltText
operator|,
comment|/* up	|shift	  */
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|meta	  */
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|meta shift */
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|control  */
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|ctl shift */
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|no shift */
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
function_decl|EditorDown
operator|,
comment|/* down	| control  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
end_function_decl

begin_comment
comment|/* up	|meta shift*/
end_comment

begin_comment
unit|};
comment|/* button, shift keys, and direction */
end_comment

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|tfunc
index|[
name|SHIFTS
index|]
index|[
name|DIRS
index|]
index|[
name|NBUTS
index|]
function_decl|)
parameter_list|()
init|=
block|{
comment|/*	left		middle		right	*/
name|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|no shift */
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
comment|/* down |	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|shift	  */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|meta	  */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|meta shift */
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|control  */
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|ctl shift */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|no shift */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	| control  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
end_function_decl

begin_comment
comment|/* up	|meta shift*/
end_comment

begin_comment
unit|};
comment|/* button, shift keys, and direction */
end_comment

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|scrollfunc
index|[
name|SHIFTS
index|]
index|[
name|DIRS
index|]
index|[
name|NBUTS
index|]
function_decl|)
parameter_list|()
init|=
block|{
comment|/*	left		middle		right	*/
name|DownButtonDown
operator|,
function_decl|ModeMenu
operator|,
function_decl|UpButtonDown
operator|,
comment|/* down	|	  */
function_decl|ButtonUp
operator|,
function_decl|Silence
operator|,
function_decl|ButtonUp
operator|,
comment|/* up	|no shift */
function_decl|DownButtonDown
operator|,
function_decl|ModeMenu
operator|,
function_decl|UpButtonDown
operator|,
comment|/* down |	  */
function_decl|ButtonUp
operator|,
function_decl|Silence
operator|,
function_decl|ButtonUp
operator|,
comment|/* up	|shift	  */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|meta	  */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|meta shift */
function_decl|DownButtonDown
operator|,
function_decl|ModeMenu
operator|,
function_decl|UpButtonDown
operator|,
comment|/* down	|	  */
function_decl|ButtonUp
operator|,
function_decl|Silence
operator|,
function_decl|ButtonUp
operator|,
comment|/* up	|control  */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|ctl shift */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|no shift */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	| control  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
end_function_decl

begin_comment
comment|/* up	|meta shift*/
end_comment

begin_comment
unit|};
comment|/* button, shift keys, and direction */
end_comment

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|Tbfunc
index|[
name|SHIFTS
index|]
index|[
name|DIRS
index|]
index|[
name|NBUTS
index|]
function_decl|)
parameter_list|()
init|=
block|{
comment|/*	left		middle		right	*/
name|GINbutton
operator|,
function_decl|GINbutton
operator|,
function_decl|GINbutton
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|no shift */
function_decl|GINbutton
operator|,
function_decl|GINbutton
operator|,
function_decl|GINbutton
operator|,
comment|/* down |	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|shift	  */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|meta	  */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|meta shift */
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
function_decl|ModeMenu
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|control  */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|ctl shift */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	|	  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
operator|,
comment|/* up	|no shift */
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
function_decl|Bogus
operator|,
comment|/* down	| control  */
function_decl|Silence
operator|,
function_decl|Silence
operator|,
function_decl|Silence
end_function_decl

begin_comment
comment|/* up	|meta shift*/
end_comment

begin_comment
unit|};
comment|/* button, shift keys, and direction */
end_comment

begin_decl_stmt
specifier|extern
name|Terminal
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|crow
decl_stmt|,
name|ccol
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* cut row and column */
end_comment

begin_decl_stmt
specifier|static
name|int
name|ccoord
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ncols
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|HandleButtons
argument_list|(
name|term
argument_list|,
name|reply
argument_list|,
name|pty
argument_list|)
specifier|register
name|Terminal
operator|*
name|term
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|XEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
name|int
function_decl|(
modifier|*
name|bp
function_decl|)
parameter_list|()
function_decl|;
name|int
name|dir
init|=
name|DOWN
decl_stmt|;
comment|/* so table above will be nice, we change left to right */
name|int
name|button
init|=
literal|2
operator|-
operator|(
operator|(
name|XKeyOrButtonEvent
operator|*
operator|)
name|reply
operator|)
operator|->
name|detail
operator|&
literal|0177
decl_stmt|;
name|int
name|shift
init|=
name|KeyState
argument_list|(
operator|(
operator|(
name|XKeyOrButtonEvent
operator|*
operator|)
name|reply
operator|)
operator|->
name|detail
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|reply
operator|->
name|type
condition|)
block|{
case|case
name|ButtonPressed
case|:
name|dir
operator|=
name|DOWN
expr_stmt|;
break|break;
case|case
name|ButtonReleased
case|:
name|dir
operator|=
name|UP
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|L_flag
operator|&&
operator|!
name|checklogin
argument_list|()
condition|)
block|{
comment|/* if login window, check for login */
if|if
condition|(
name|dir
operator|==
name|DOWN
condition|)
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
name|bp
operator|=
operator|(
name|screen
operator|->
name|sb
operator|&&
operator|(
name|reply
operator|->
name|window
operator|==
name|screen
operator|->
name|sb
operator|->
name|bar
operator|||
name|GetButtonState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|!=
name|BUTTON_NORMAL
operator|)
operator|)
condition|?
name|scrollfunc
index|[
name|shift
index|]
index|[
name|dir
index|]
index|[
name|button
index|]
else|:
operator|(
operator|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|&&
operator|(
name|reply
operator|->
name|window
operator|==
name|screen
operator|->
name|title
operator|.
name|tbar
operator|||
name|reply
operator|->
name|window
operator|==
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
operator|)
operator|)
condition|?
name|tfunc
index|[
name|shift
index|]
index|[
name|dir
index|]
index|[
name|button
index|]
else|:
operator|(
operator|(
name|reply
operator|->
name|window
operator|==
name|TWindow
argument_list|(
name|screen
argument_list|)
operator|)
condition|?
name|Tbfunc
index|[
name|shift
index|]
index|[
name|dir
index|]
index|[
name|button
index|]
else|:
name|bfunc
index|[
name|shift
index|]
index|[
name|dir
index|]
index|[
name|button
index|]
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|bp
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|bp
call|)
argument_list|(
name|term
argument_list|,
name|reply
argument_list|,
name|pty
argument_list|)
expr_stmt|;
else|else
name|Bell
argument_list|()
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|UnSaltText
argument_list|(
name|term
argument_list|,
name|reply
argument_list|,
name|pty
argument_list|)
specifier|register
name|Terminal
operator|*
name|term
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|XKeyOrButtonEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{
name|char
modifier|*
name|line
decl_stmt|;
name|int
name|nbytes
decl_stmt|;
specifier|register
name|char
modifier|*
name|lag
decl_stmt|,
modifier|*
name|cp
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|line
operator|=
name|XFetchBytes
argument_list|(
operator|&
name|nbytes
argument_list|)
expr_stmt|;
name|end
operator|=
operator|&
name|line
index|[
name|nbytes
index|]
expr_stmt|;
name|lag
operator|=
name|line
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|line
init|;
name|cp
operator|!=
name|end
condition|;
name|cp
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|cp
operator|!=
literal|'\n'
condition|)
continue|continue;
operator|*
name|cp
operator|=
literal|'\r'
expr_stmt|;
name|write
argument_list|(
name|pty
argument_list|,
name|lag
argument_list|,
name|cp
operator|-
name|lag
operator|+
literal|1
argument_list|)
expr_stmt|;
name|lag
operator|=
name|cp
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|lag
operator|!=
name|end
condition|)
name|write
argument_list|(
name|pty
argument_list|,
name|lag
argument_list|,
name|end
operator|-
name|lag
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|line
argument_list|)
expr_stmt|;
comment|/* free text from fetch */
block|}
end_block

begin_expr_stmt
name|ReExecute
argument_list|(
name|term
argument_list|,
name|reply
argument_list|,
name|pty
argument_list|)
specifier|register
name|XKeyOrButtonEvent
operator|*
name|reply
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|XKeyOrButtonEvent
name|xevent
decl_stmt|;
specifier|register
name|XKeyOrButtonEvent
modifier|*
name|ev
init|=
operator|&
name|xevent
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|int
name|xrow
decl_stmt|,
name|xcol
decl_stmt|,
name|mask
decl_stmt|,
name|cursor
decl_stmt|,
name|ignore
decl_stmt|;
specifier|register
name|char
modifier|*
name|line
decl_stmt|;
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
name|cursor
operator|=
name|screen
operator|->
name|curs
expr_stmt|;
if|if
condition|(
operator|!
name|XGrabMouse
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cursor
argument_list|,
name|mask
operator|=
name|ButtonReleased
operator||
name|EnterWindow
operator||
name|LeaveWindow
operator||
name|MouseMoved
argument_list|)
condition|)
block|{
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
name|ncols
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
expr_stmt|;
comment|/* needed by Coordinate() define */
if|if
condition|(
name|NearestRowCol
argument_list|(
name|reply
operator|->
name|y
argument_list|,
name|reply
operator|->
name|x
argument_list|,
operator|&
name|crow
argument_list|,
operator|&
name|ccol
argument_list|)
operator|||
name|crow
operator|>
name|screen
operator|->
name|max_row
condition|)
block|{
name|Bell
argument_list|()
expr_stmt|;
name|XUngrabMouse
argument_list|()
expr_stmt|;
return|return;
block|}
name|xrow
operator|=
name|crow
expr_stmt|;
name|xcol
operator|=
name|ccol
expr_stmt|;
name|crow
operator|++
expr_stmt|;
name|ccol
operator|=
literal|0
expr_stmt|;
name|ccoord
operator|=
name|Coordinate
argument_list|(
name|crow
argument_list|,
name|ccol
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|HiliteText
argument_list|(
name|xrow
argument_list|,
name|xcol
argument_list|,
name|crow
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|ignore
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|XMaskEvent
argument_list|(
name|mask
argument_list|,
name|ev
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ev
operator|->
name|type
condition|)
block|{
case|case
name|ButtonReleased
case|:
if|if
condition|(
name|xrow
operator|==
name|crow
operator|-
literal|1
condition|)
block|{
name|line
operator|=
name|GetRestOfLine
argument_list|(
name|screen
argument_list|,
name|xrow
argument_list|,
name|xcol
argument_list|)
expr_stmt|;
name|row
operator|=
name|strlen
argument_list|(
name|line
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|pty
argument_list|,
name|line
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|line
index|[
name|row
index|]
operator|=
literal|'\n'
expr_stmt|;
name|XStoreBytes
argument_list|(
name|line
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|line
argument_list|)
expr_stmt|;
comment|/* free text from fetch */
name|HiliteText
argument_list|(
name|xrow
argument_list|,
name|xcol
argument_list|,
name|crow
argument_list|,
literal|0
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
name|XUngrabMouse
argument_list|()
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_set
operator|&&
operator|!
name|screen
operator|->
name|cursor_state
condition|)
name|ShowCursor
argument_list|()
expr_stmt|;
return|return;
case|case
name|LeaveWindow
case|:
if|if
condition|(
name|ev
operator|->
name|window
operator|!=
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|)
break|break;
if|if
condition|(
name|xrow
operator|==
name|crow
operator|-
literal|1
condition|)
name|HiliteText
argument_list|(
name|xrow
argument_list|,
name|xcol
argument_list|,
name|crow
argument_list|,
literal|0
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|xrow
operator|=
name|crow
expr_stmt|;
name|xcol
operator|=
literal|0
expr_stmt|;
name|XGrabMouse
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cursor
argument_list|,
name|mask
operator|&
operator|~
name|MouseMoved
argument_list|)
expr_stmt|;
name|ignore
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|EnterWindow
case|:
if|if
condition|(
name|ev
operator|->
name|window
operator|!=
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|)
break|break;
name|XGrabMouse
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cursor
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|ignore
operator|=
name|FALSE
expr_stmt|;
comment|/* drop through */
case|case
name|MouseMoved
case|:
if|if
condition|(
name|ignore
condition|)
break|break;
name|NearestRowCol
argument_list|(
name|ev
operator|->
name|y
argument_list|,
name|ev
operator|->
name|x
argument_list|,
operator|&
name|row
argument_list|,
operator|&
name|col
argument_list|)
expr_stmt|;
if|if
condition|(
name|row
operator|!=
name|crow
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|xrow
operator|==
name|crow
operator|-
literal|1
condition|)
name|HiliteText
argument_list|(
name|xrow
argument_list|,
name|xcol
argument_list|,
name|crow
argument_list|,
literal|0
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xrow
operator|==
name|row
condition|)
name|TrackText
argument_list|(
name|xrow
argument_list|,
name|xcol
argument_list|,
name|row
argument_list|,
name|col
argument_list|)
expr_stmt|;
else|else
name|HiliteText
argument_list|(
name|row
argument_list|,
name|col
argument_list|,
name|crow
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|xrow
operator|=
name|row
expr_stmt|;
name|xcol
operator|=
name|col
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_function
name|char
modifier|*
name|GetRestOfLine
parameter_list|(
name|screen
parameter_list|,
name|row
parameter_list|,
name|col
parameter_list|)
specifier|register
name|Screen
modifier|*
name|screen
decl_stmt|;
specifier|register
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
block|{
name|char
modifier|*
name|line
decl_stmt|;
name|int
name|i
decl_stmt|;
name|i
operator|=
name|Length
argument_list|(
name|screen
argument_list|,
name|row
argument_list|,
name|col
argument_list|,
name|screen
operator|->
name|max_col
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|line
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|i
operator|+
literal|2
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|SysError
argument_list|(
name|ERROR_BMALLOC
argument_list|)
expr_stmt|;
name|SaveText
argument_list|(
name|screen
argument_list|,
name|row
argument_list|,
name|col
argument_list|,
name|screen
operator|->
name|max_col
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|line
index|[
name|i
index|]
operator|=
literal|'\r'
expr_stmt|;
name|line
index|[
name|i
operator|+
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|line
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|StartCut
argument_list|(
name|term
argument_list|,
name|reply
argument_list|,
name|pty
argument_list|)
specifier|register
name|XKeyOrButtonEvent
operator|*
name|reply
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|XKeyOrButtonEvent
name|xevent
decl_stmt|;
specifier|register
name|XKeyOrButtonEvent
modifier|*
name|ev
init|=
operator|&
name|xevent
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|int
name|xrow
decl_stmt|,
name|xcol
decl_stmt|,
name|mask
decl_stmt|,
name|cursor
decl_stmt|,
name|ignore
decl_stmt|;
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
name|cursor
operator|=
name|screen
operator|->
name|curs
expr_stmt|;
if|if
condition|(
operator|!
name|XGrabMouse
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cursor
argument_list|,
name|mask
operator|=
name|ButtonReleased
operator||
name|EnterWindow
operator||
name|LeaveWindow
operator||
name|MouseMoved
argument_list|)
condition|)
block|{
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
name|ncols
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
expr_stmt|;
comment|/* needed by Coordinate() define */
name|NearestRowCol
argument_list|(
name|reply
operator|->
name|y
argument_list|,
name|reply
operator|->
name|x
argument_list|,
operator|&
name|crow
argument_list|,
operator|&
name|ccol
argument_list|)
expr_stmt|;
name|ccoord
operator|=
name|Coordinate
argument_list|(
name|crow
argument_list|,
name|ccol
argument_list|)
expr_stmt|;
name|xrow
operator|=
name|crow
expr_stmt|;
name|xcol
operator|=
name|ccol
expr_stmt|;
name|ignore
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|XMaskEvent
argument_list|(
name|mask
argument_list|,
name|ev
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ev
operator|->
name|type
condition|)
block|{
case|case
name|ButtonReleased
case|:
if|if
condition|(
operator|!
name|ignore
condition|)
block|{
name|row
operator|=
name|crow
expr_stmt|;
name|col
operator|=
name|ccol
expr_stmt|;
comment|/* SaltTextAway may alter these */
name|SaltTextAway
argument_list|(
name|term
argument_list|,
name|xrow
argument_list|,
name|xcol
argument_list|,
name|pty
argument_list|)
expr_stmt|;
block|}
name|HiliteText
argument_list|(
name|row
argument_list|,
name|col
argument_list|,
name|xrow
argument_list|,
name|xcol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|XUngrabMouse
argument_list|()
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_set
operator|&&
operator|!
name|screen
operator|->
name|cursor_state
condition|)
name|ShowCursor
argument_list|()
expr_stmt|;
return|return;
case|case
name|LeaveWindow
case|:
if|if
condition|(
name|ev
operator|->
name|window
operator|!=
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|)
break|break;
name|HiliteText
argument_list|(
name|crow
argument_list|,
name|ccol
argument_list|,
name|xrow
argument_list|,
name|xcol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|xrow
operator|=
name|crow
expr_stmt|;
name|xcol
operator|=
name|ccol
expr_stmt|;
name|XGrabMouse
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cursor
argument_list|,
name|mask
operator|&
operator|~
name|MouseMoved
argument_list|)
expr_stmt|;
name|ignore
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|EnterWindow
case|:
if|if
condition|(
name|ev
operator|->
name|window
operator|!=
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|)
break|break;
name|XGrabMouse
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cursor
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|ignore
operator|=
name|FALSE
expr_stmt|;
comment|/* drop through */
case|case
name|MouseMoved
case|:
if|if
condition|(
name|ignore
condition|)
break|break;
name|NearestRowCol
argument_list|(
name|ev
operator|->
name|y
argument_list|,
name|ev
operator|->
name|x
argument_list|,
operator|&
name|row
argument_list|,
operator|&
name|col
argument_list|)
expr_stmt|;
if|if
condition|(
name|row
operator|!=
name|xrow
operator|||
name|col
operator|!=
name|xcol
condition|)
block|{
name|TrackText
argument_list|(
name|xrow
argument_list|,
name|xcol
argument_list|,
name|row
argument_list|,
name|col
argument_list|)
expr_stmt|;
name|xrow
operator|=
name|row
expr_stmt|;
name|xcol
operator|=
name|col
expr_stmt|;
block|}
break|break;
block|}
block|}
block|}
end_block

begin_function
name|int
name|NearestRowCol
parameter_list|(
name|y
parameter_list|,
name|x
parameter_list|,
name|r
parameter_list|,
name|c
parameter_list|)
specifier|register
name|int
name|y
decl_stmt|,
name|x
decl_stmt|;
name|int
modifier|*
name|r
decl_stmt|,
decl|*
name|c
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|row
operator|,
name|col
operator|,
name|i
expr_stmt|;
specifier|register
name|char
modifier|*
name|ch
decl_stmt|;
specifier|register
name|int
name|passed_eol
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|(
name|row
operator|=
operator|(
name|y
operator|-
name|screen
operator|->
name|border
operator|-
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|)
operator|/
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|row
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|row
operator|>
name|screen
operator|->
name|max_row
condition|)
name|row
operator|=
name|screen
operator|->
name|max_row
expr_stmt|;
name|i
operator|=
name|FontWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|col
operator|=
operator|(
name|x
operator|-
name|screen
operator|->
name|border
operator|+
operator|(
name|i
operator|/
literal|3
operator|)
operator|)
operator|/
name|i
operator|)
operator|<
literal|0
condition|)
name|col
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|col
operator|>
name|screen
operator|->
name|max_col
condition|)
block|{
name|col
operator|=
literal|0
expr_stmt|;
name|row
operator|++
expr_stmt|;
comment|/* this can be screen->max_row + 1 */
name|passed_eol
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|col
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
name|screen
operator|->
name|max_col
operator|,
name|ch
operator|=
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
operator|(
name|row
operator|+
name|screen
operator|->
name|topline
operator|)
index|]
operator|+
name|i
init|;
name|i
operator|>
literal|0
operator|&&
operator|*
name|ch
operator|==
literal|0
condition|;
name|ch
operator|--
operator|,
name|i
operator|--
control|)
empty_stmt|;
if|if
condition|(
name|col
operator|>
name|i
operator|+
literal|1
condition|)
block|{
name|col
operator|=
literal|0
expr_stmt|;
name|row
operator|++
expr_stmt|;
name|passed_eol
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
operator|*
name|r
operator|=
name|row
expr_stmt|;
operator|*
name|c
operator|=
name|col
expr_stmt|;
return|return
operator|(
name|passed_eol
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|TrackText
argument_list|(
name|frow
argument_list|,
name|fcol
argument_list|,
name|trow
argument_list|,
name|tcol
argument_list|)
specifier|register
name|int
name|frow
operator|,
name|fcol
operator|,
name|trow
operator|,
name|tcol
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|f
decl_stmt|,
name|t
decl_stmt|;
name|f
operator|=
name|Coordinate
argument_list|(
name|frow
argument_list|,
name|fcol
argument_list|)
expr_stmt|;
name|t
operator|=
name|Coordinate
argument_list|(
name|trow
argument_list|,
name|tcol
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|t
condition|)
return|return;
if|if
condition|(
name|f
operator|>
name|ccoord
condition|)
block|{
if|if
condition|(
name|t
operator|<
name|ccoord
condition|)
block|{
name|HiliteText
argument_list|(
name|crow
argument_list|,
name|ccol
argument_list|,
name|frow
argument_list|,
name|fcol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|HiliteText
argument_list|(
name|trow
argument_list|,
name|tcol
argument_list|,
name|crow
argument_list|,
name|ccol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|t
operator|>
name|f
condition|)
name|HiliteText
argument_list|(
name|frow
argument_list|,
name|fcol
argument_list|,
name|trow
argument_list|,
name|tcol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
else|else
name|HiliteText
argument_list|(
name|trow
argument_list|,
name|tcol
argument_list|,
name|frow
argument_list|,
name|fcol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|t
operator|>
name|ccoord
condition|)
block|{
name|HiliteText
argument_list|(
name|frow
argument_list|,
name|fcol
argument_list|,
name|crow
argument_list|,
name|ccol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|HiliteText
argument_list|(
name|crow
argument_list|,
name|ccol
argument_list|,
name|trow
argument_list|,
name|tcol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|t
operator|<
name|f
condition|)
name|HiliteText
argument_list|(
name|trow
argument_list|,
name|tcol
argument_list|,
name|frow
argument_list|,
name|fcol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
else|else
name|HiliteText
argument_list|(
name|frow
argument_list|,
name|fcol
argument_list|,
name|trow
argument_list|,
name|tcol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|HiliteText
argument_list|(
name|frow
argument_list|,
name|fcol
argument_list|,
name|trow
argument_list|,
name|tcol
argument_list|,
name|hilite
argument_list|)
specifier|register
name|int
name|frow
operator|,
name|fcol
operator|,
name|trow
operator|,
name|tcol
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|hilite
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|Coordinate
argument_list|(
name|frow
argument_list|,
name|fcol
argument_list|)
operator|)
operator|==
operator|(
name|j
operator|=
name|Coordinate
argument_list|(
name|trow
argument_list|,
name|tcol
argument_list|)
operator|)
condition|)
return|return;
elseif|else
if|if
condition|(
name|i
operator|>
name|j
condition|)
block|{
name|i
operator|=
name|frow
expr_stmt|;
name|j
operator|=
name|fcol
expr_stmt|;
name|frow
operator|=
name|trow
expr_stmt|;
name|fcol
operator|=
name|tcol
expr_stmt|;
name|trow
operator|=
name|i
expr_stmt|;
name|tcol
operator|=
name|j
expr_stmt|;
block|}
if|if
condition|(
name|hilite
condition|)
block|{
name|i
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
name|screen
operator|->
name|foreground
operator|=
name|screen
operator|->
name|background
expr_stmt|;
name|screen
operator|->
name|background
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|frow
operator|!=
name|trow
condition|)
block|{
comment|/* do multiple rows */
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|max_col
operator|-
name|fcol
operator|+
literal|1
operator|)
operator|>
literal|0
condition|)
block|{
comment|/* first row */
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|fcol
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
argument_list|,
name|frow
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|i
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|frow
argument_list|,
name|fcol
argument_list|,
literal|1
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|i
operator|=
name|trow
operator|-
name|frow
operator|-
literal|1
operator|)
operator|>
literal|0
condition|)
block|{
comment|/* middle rows*/
name|j
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
expr_stmt|;
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
operator|(
name|frow
operator|+
literal|1
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|j
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|i
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|frow
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tcol
operator|>
literal|0
operator|&&
name|trow
operator|<=
name|screen
operator|->
name|max_row
condition|)
block|{
comment|/* last row */
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|trow
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|tcol
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|trow
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|tcol
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* do single row */
name|i
operator|=
name|tcol
operator|-
name|fcol
expr_stmt|;
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|fcol
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
argument_list|,
name|frow
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|i
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|frow
argument_list|,
name|fcol
argument_list|,
literal|1
argument_list|,
name|tcol
operator|-
name|fcol
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hilite
condition|)
block|{
name|i
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
name|screen
operator|->
name|foreground
operator|=
name|screen
operator|->
name|background
expr_stmt|;
name|screen
operator|->
name|background
operator|=
name|i
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|SaltTextAway
argument_list|(
argument|term
argument_list|,
argument|row
argument_list|,
argument|col
argument_list|,
argument|pty
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|register
name|row
operator|,
name|col
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|;
specifier|register
name|char
modifier|*
name|str
decl_stmt|;
comment|/* string to be saved */
name|char
modifier|*
name|line
decl_stmt|,
modifier|*
name|lp
decl_stmt|;
comment|/* first order of business is to guarantee that crow,ccol is before */
comment|/* row,col. */
if|if
condition|(
name|row
operator|==
name|crow
condition|)
block|{
comment|/* must exchange as pairs */
if|if
condition|(
name|ccol
operator|>
name|col
condition|)
block|{
comment|/* may have to exchange columns */
specifier|register
name|int
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ccol
expr_stmt|;
name|ccol
operator|=
name|col
expr_stmt|;
name|col
operator|=
name|tmp
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|crow
operator|>
name|row
condition|)
block|{
comment|/* may have to exchange row and col */
specifier|register
name|int
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ccol
expr_stmt|;
name|ccol
operator|=
name|col
expr_stmt|;
name|col
operator|=
name|tmp
expr_stmt|;
name|tmp
operator|=
name|crow
expr_stmt|;
name|crow
operator|=
name|row
expr_stmt|;
name|row
operator|=
name|tmp
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ccol
operator|<
literal|0
condition|)
name|ccol
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|ccol
operator|>
name|screen
operator|->
name|max_col
condition|)
block|{
name|crow
operator|++
expr_stmt|;
name|ccol
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|crow
operator|<
literal|0
condition|)
name|crow
operator|=
name|ccol
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|crow
operator|>
name|screen
operator|->
name|max_row
condition|)
block|{
name|crow
operator|=
name|screen
operator|->
name|max_row
expr_stmt|;
name|ccol
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|row
operator|>
name|screen
operator|->
name|max_row
condition|)
block|{
name|row
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
name|col
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|--
name|col
operator|>
name|screen
operator|->
name|max_col
condition|)
name|col
operator|=
name|screen
operator|->
name|max_col
expr_stmt|;
comment|/* first we need to know how long the string is before we can save it*/
if|if
condition|(
name|row
operator|==
name|crow
condition|)
name|j
operator|=
name|Length
argument_list|(
name|screen
argument_list|,
name|crow
argument_list|,
name|ccol
argument_list|,
name|col
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* two cases, cut is on same line, cut spans multiple lines */
name|j
operator|+=
name|Length
argument_list|(
name|screen
argument_list|,
name|crow
argument_list|,
name|ccol
argument_list|,
name|screen
operator|->
name|max_col
argument_list|)
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|crow
operator|+
literal|1
init|;
name|i
operator|<
name|row
condition|;
name|i
operator|++
control|)
name|j
operator|+=
name|Length
argument_list|(
name|screen
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
name|screen
operator|->
name|max_col
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|col
operator|>=
literal|0
condition|)
name|j
operator|+=
name|Length
argument_list|(
name|screen
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
name|col
argument_list|)
expr_stmt|;
block|}
comment|/* now get some memory to save it in */
if|if
condition|(
operator|(
name|line
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|j
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|SysError
argument_list|(
name|ERROR_BMALLOC2
argument_list|)
expr_stmt|;
name|line
index|[
name|j
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* make sure it is null terminated */
name|lp
operator|=
name|line
expr_stmt|;
comment|/* lp points to where to save the text */
if|if
condition|(
name|row
operator|==
name|crow
condition|)
name|lp
operator|=
name|SaveText
argument_list|(
name|screen
argument_list|,
name|row
argument_list|,
name|ccol
argument_list|,
name|col
argument_list|,
name|lp
argument_list|)
expr_stmt|;
else|else
block|{
name|lp
operator|=
name|SaveText
argument_list|(
name|screen
argument_list|,
name|crow
argument_list|,
name|ccol
argument_list|,
name|screen
operator|->
name|max_col
argument_list|,
name|lp
argument_list|)
expr_stmt|;
operator|*
name|lp
operator|++
operator|=
literal|'\n'
expr_stmt|;
comment|/* put in newline at end of line */
for|for
control|(
name|i
operator|=
name|crow
operator|+
literal|1
init|;
name|i
operator|<
name|row
condition|;
name|i
operator|++
control|)
block|{
name|lp
operator|=
name|SaveText
argument_list|(
name|screen
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
name|screen
operator|->
name|max_col
argument_list|,
name|lp
argument_list|)
expr_stmt|;
operator|*
name|lp
operator|++
operator|=
literal|'\n'
expr_stmt|;
block|}
if|if
condition|(
name|col
operator|>=
literal|0
condition|)
name|lp
operator|=
name|SaveText
argument_list|(
name|screen
argument_list|,
name|row
argument_list|,
literal|0
argument_list|,
name|col
argument_list|,
name|lp
argument_list|)
expr_stmt|;
block|}
operator|*
name|lp
operator|=
literal|'\0'
expr_stmt|;
comment|/* make sure we have end marked */
name|XStoreBytes
argument_list|(
name|line
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|line
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* returns number of chars in line from scol to ecol out */
end_comment

begin_function
name|int
name|Length
parameter_list|(
name|screen
parameter_list|,
name|row
parameter_list|,
name|scol
parameter_list|,
name|ecol
parameter_list|)
specifier|register
name|int
name|row
decl_stmt|,
name|scol
decl_stmt|,
name|ecol
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|ch
decl_stmt|;
name|int
name|end
init|=
literal|0
decl_stmt|;
name|ch
operator|=
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
operator|(
name|row
operator|+
name|screen
operator|->
name|topline
operator|)
index|]
expr_stmt|;
while|while
condition|(
name|ecol
operator|>=
name|scol
operator|&&
name|ch
index|[
name|ecol
index|]
operator|==
literal|0
condition|)
name|ecol
operator|--
expr_stmt|;
return|return
operator|(
name|ecol
operator|-
name|scol
operator|+
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/* copies text into line, preallocated */
end_comment

begin_function
name|char
modifier|*
name|SaveText
parameter_list|(
name|screen
parameter_list|,
name|row
parameter_list|,
name|scol
parameter_list|,
name|ecol
parameter_list|,
name|lp
parameter_list|)
name|int
name|row
decl_stmt|;
name|int
name|scol
decl_stmt|,
name|ecol
decl_stmt|;
name|Screen
modifier|*
name|screen
decl_stmt|;
specifier|register
name|char
modifier|*
name|lp
decl_stmt|;
comment|/* pointer to where to put the text */
block|{
specifier|register
name|int
name|i
init|=
literal|0
decl_stmt|;
specifier|register
name|char
modifier|*
name|ch
init|=
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
operator|(
name|row
operator|+
name|screen
operator|->
name|topline
operator|)
index|]
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|Length
argument_list|(
name|screen
argument_list|,
name|row
argument_list|,
name|scol
argument_list|,
name|ecol
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|lp
operator|)
return|;
name|ecol
operator|=
name|scol
operator|+
name|i
expr_stmt|;
for|for
control|(
name|i
operator|=
name|scol
init|;
name|i
operator|<
name|ecol
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|ch
index|[
name|i
index|]
operator|)
operator|==
literal|0
condition|)
name|c
operator|=
literal|' '
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|<
literal|' '
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\036'
condition|)
name|c
operator|=
literal|'#'
expr_stmt|;
else|else
name|c
operator|+=
literal|0x5f
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|0x7f
condition|)
name|c
operator|=
literal|0x5f
expr_stmt|;
operator|*
name|lp
operator|++
operator|=
name|c
expr_stmt|;
block|}
return|return
operator|(
name|lp
operator|)
return|;
block|}
end_function

begin_macro
name|EditorDown
argument_list|(
argument|term
argument_list|,
argument|reply
argument_list|,
argument|pty
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|XKeyOrButtonEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
name|char
name|line
index|[
literal|6
index|]
decl_stmt|;
specifier|register
name|unsigned
name|row
decl_stmt|,
name|col
decl_stmt|;
name|int
name|button
decl_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|send_mouse_pos
condition|)
block|{
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
name|button
operator|=
literal|2
operator|-
name|reply
operator|->
name|detail
operator|&
literal|0177
expr_stmt|;
name|row
operator|=
operator|(
name|reply
operator|->
name|y
operator|-
name|screen
operator|->
name|border
operator|-
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|)
operator|/
name|FontHeight
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|col
operator|=
operator|(
name|reply
operator|->
name|x
operator|-
name|screen
operator|->
name|border
operator|)
operator|/
name|FontWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|line
argument_list|,
literal|"\033[M"
argument_list|)
expr_stmt|;
name|line
index|[
literal|3
index|]
operator|=
literal|' '
operator|+
name|button
expr_stmt|;
name|line
index|[
literal|4
index|]
operator|=
literal|' '
operator|+
name|col
operator|+
literal|1
expr_stmt|;
name|line
index|[
literal|5
index|]
operator|=
literal|' '
operator|+
name|row
operator|+
literal|1
expr_stmt|;
name|write
argument_list|(
name|pty
argument_list|,
name|line
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|ALLOWUNSHIFTEDSELECTION
end_ifdef

begin_macro
name|UnshiftedSelectionInit
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* copy table for shifted actions to table for unshifted 	 * actions.  We assume the shifted actions are in bfunc[1] 	 * and the unshifted ones go in bfunc[0]. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DIRS
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NBUTS
condition|;
name|j
operator|++
control|)
name|bfunc
index|[
literal|0
index|]
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
name|bfunc
index|[
literal|1
index|]
index|[
name|i
index|]
index|[
name|j
index|]
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|MODEMENU
end_ifdef

begin_define
define|#
directive|define
name|MAXWINDOWMENU
value|64
end_define

begin_define
define|#
directive|define
name|XTERMMENU
value|0
end_define

begin_define
define|#
directive|define
name|VTMENU
value|1
end_define

begin_define
define|#
directive|define
name|TEKMENU
value|2
end_define

begin_define
define|#
directive|define
name|SCROLLBARMENU
value|3
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|NOWINDOWMENU
end_ifndef

begin_define
define|#
directive|define
name|WINDOWMENU
value|4
end_define

begin_define
define|#
directive|define
name|NMENUS
value|5
end_define

begin_else
else|#
directive|else
else|NOWINDOWMENU
end_else

begin_define
define|#
directive|define
name|NMENUS
value|4
end_define

begin_endif
endif|#
directive|endif
endif|NOWINDOWMENU
end_endif

begin_decl_stmt
specifier|static
name|Menu
modifier|*
name|menus
index|[
name|NMENUS
index|]
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|NOWINDOWMENU
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|namebuf
index|[
name|MAXWINDOWMENU
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|wname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Window
name|windows
index|[
name|MAXWINDOWMENU
index|]
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|NOWINDOWMENU
end_endif

begin_macro
name|ModeMenu
argument_list|(
argument|term
argument_list|,
argument|reply
argument_list|,
argument|pty
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|XKeyOrButtonEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|Menu
modifier|*
name|menu
decl_stmt|;
specifier|register
name|int
name|type
decl_stmt|,
name|item
decl_stmt|;
specifier|static
name|int
name|inited
decl_stmt|;
specifier|extern
name|TekLink
modifier|*
name|TekRefresh
decl_stmt|;
specifier|extern
name|int
name|xeventpass
parameter_list|()
function_decl|;
specifier|extern
name|Menu
modifier|*
name|setupmenu
argument_list|()
decl_stmt|,
modifier|*
name|Tsetupmenu
argument_list|()
decl_stmt|,
modifier|*
name|xsetupmenu
argument_list|()
decl_stmt|;
ifndef|#
directive|ifndef
name|NOWINDOWMENU
specifier|extern
name|Menu
modifier|*
name|wsetupmenu
parameter_list|()
function_decl|;
endif|#
directive|endif
endif|NOWINDOWMENU
specifier|extern
name|Menu
modifier|*
name|ssetupmenu
parameter_list|()
function_decl|;
if|if
condition|(
operator|(
name|reply
operator|->
name|window
operator|==
name|screen
operator|->
name|title
operator|.
name|tbar
operator|||
name|reply
operator|->
name|window
operator|==
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
operator|)
operator|&&
name|InTitle
argument_list|(
name|screen
argument_list|,
name|reply
operator|->
name|window
argument_list|,
name|reply
operator|->
name|x
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|inited
condition|)
block|{
specifier|extern
name|Pixmap
name|Gray_Tile
decl_stmt|;
specifier|extern
name|Cursor
name|Menu_DefaultCursor
decl_stmt|;
specifier|extern
name|char
modifier|*
name|Menu_DefaultFont
decl_stmt|;
specifier|extern
name|FontInfo
modifier|*
name|Menu_DefaultFontInfo
decl_stmt|;
name|inited
operator|++
expr_stmt|;
name|Gray_Tile
operator|=
name|screen
operator|->
name|graybordertile
expr_stmt|;
name|InitMenu
argument_list|(
name|xterm_name
argument_list|)
expr_stmt|;
name|Menu_DefaultCursor
operator|=
name|screen
operator|->
name|arrow
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|Menu_DefaultFont
argument_list|,
name|f_t
argument_list|)
operator|==
literal|0
condition|)
name|Menu_DefaultFontInfo
operator|=
name|screen
operator|->
name|titlefont
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|reply
operator|->
name|detail
operator|&
literal|0177
operator|)
operator|==
name|LeftButton
condition|)
name|type
operator|=
name|XTERMMENU
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|reply
operator|->
name|detail
operator|&
literal|0177
operator|)
operator|==
name|RightButton
condition|)
ifndef|#
directive|ifndef
name|NOWINDOWMENU
name|type
operator|=
name|WINDOWMENU
expr_stmt|;
else|#
directive|else
else|NOWINDOWMENU
block|{
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
endif|NOWINDOWMENU
elseif|else
if|if
condition|(
name|reply
operator|->
name|window
operator|==
name|VWindow
argument_list|(
name|screen
argument_list|)
operator|||
name|reply
operator|->
name|window
operator|==
name|screen
operator|->
name|title
operator|.
name|tbar
condition|)
name|type
operator|=
name|VTMENU
expr_stmt|;
elseif|else
if|if
condition|(
name|reply
operator|->
name|window
operator|==
name|TWindow
argument_list|(
name|screen
argument_list|)
operator|||
name|reply
operator|->
name|window
operator|==
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
condition|)
name|type
operator|=
name|TEKMENU
expr_stmt|;
else|else
name|type
operator|=
name|SCROLLBARMENU
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|XTERMMENU
case|:
if|if
condition|(
operator|(
name|menu
operator|=
name|xsetupmenu
argument_list|(
operator|&
name|menus
index|[
name|XTERMMENU
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
break|break;
case|case
name|VTMENU
case|:
if|if
condition|(
operator|(
name|menu
operator|=
name|setupmenu
argument_list|(
operator|&
name|menus
index|[
name|VTMENU
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
break|break;
ifndef|#
directive|ifndef
name|NOWINDOWMENU
case|case
name|WINDOWMENU
case|:
name|wname
operator|=
operator|(
name|reply
operator|->
name|window
operator|==
name|screen
operator|->
name|title
operator|.
name|tbar
operator|||
name|reply
operator|->
name|window
operator|==
name|VWindow
argument_list|(
name|screen
argument_list|)
operator|)
condition|?
name|screen
operator|->
name|winname
else|:
name|screen
operator|->
name|Twinname
expr_stmt|;
if|if
condition|(
operator|(
name|menu
operator|=
name|wsetupmenu
argument_list|(
operator|&
name|menus
index|[
name|WINDOWMENU
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
break|break;
endif|#
directive|endif
endif|NOWINDOWMENU
case|case
name|TEKMENU
case|:
if|if
condition|(
operator|(
name|menu
operator|=
name|Tsetupmenu
argument_list|(
operator|&
name|menus
index|[
name|TEKMENU
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|screen
operator|->
name|waitrefresh
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|SCROLLBARMENU
case|:
if|if
condition|(
operator|(
name|menu
operator|=
name|ssetupmenu
argument_list|(
operator|&
name|menus
index|[
name|SCROLLBARMENU
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
break|break;
block|}
comment|/* 	 * Make the window entry and leaving routines holdoff on setting 	 * the timer and on selecting or unselecting any windows.  Then 	 * set the select mode manually. 	 */
name|screen
operator|->
name|holdoff
operator|=
name|TRUE
expr_stmt|;
name|SetMenuEventHandler
argument_list|(
name|menu
argument_list|,
name|xeventpass
argument_list|)
expr_stmt|;
name|item
operator|=
name|TrackMenu
argument_list|(
name|menu
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|menusync
argument_list|()
expr_stmt|;
name|screen
operator|->
name|waitrefresh
operator|=
name|FALSE
expr_stmt|;
name|screen
operator|->
name|timer
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|holdoff
operator|=
name|FALSE
expr_stmt|;
name|reselectwindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|item
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|type
operator|==
name|TEKMENU
operator|&&
name|TekRefresh
condition|)
name|dorefresh
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|NOWINDOWMENU
elseif|else
if|if
condition|(
name|type
operator|==
name|WINDOWMENU
condition|)
name|wfree
argument_list|(
name|menu
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|NOWINDOWMENU
return|return;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|XTERMMENU
case|:
name|xdomenufunc
argument_list|(
name|item
argument_list|)
expr_stmt|;
break|break;
case|case
name|VTMENU
case|:
name|domenufunc
argument_list|(
name|item
argument_list|)
expr_stmt|;
break|break;
ifndef|#
directive|ifndef
name|NOWINDOWMENU
case|case
name|WINDOWMENU
case|:
name|wdomenufunc
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|wfree
argument_list|(
name|menu
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
endif|NOWINDOWMENU
case|case
name|TEKMENU
case|:
name|Tdomenufunc
argument_list|(
name|item
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCROLLBARMENU
case|:
name|sdomenufunc
argument_list|(
name|item
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_macro
name|menusync
argument_list|()
end_macro

begin_block
block|{
name|XEvent
name|ev
decl_stmt|;
name|XSync
argument_list|(
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|QLength
argument_list|()
operator|>
literal|0
condition|)
block|{
name|XNextEvent
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
name|xeventpass
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_define
define|#
directive|define
name|XMENU_TITLE
value|0
end_define

begin_define
define|#
directive|define
name|XMENU_ACTIVEICON
value|(XMENU_TITLE+1)
end_define

begin_define
define|#
directive|define
name|XMENU_ALLOWICONINPUT
value|(XMENU_ACTIVEICON+1)
end_define

begin_define
define|#
directive|define
name|XMENU_AUTORAISE
value|(XMENU_ALLOWICONINPUT+1)
end_define

begin_define
define|#
directive|define
name|XMENU_AUDIBLEBELL
value|(XMENU_AUTORAISE+1)
end_define

begin_define
define|#
directive|define
name|XMENU_VISUALBELL
value|(XMENU_AUDIBLEBELL+1)
end_define

begin_define
define|#
directive|define
name|XMENU_DEICONWARP
value|(XMENU_VISUALBELL+1)
end_define

begin_define
define|#
directive|define
name|XMENU_SENDMOUSE
value|(XMENU_DEICONWARP+1)
end_define

begin_define
define|#
directive|define
name|XMENU_LOG
value|(XMENU_SENDMOUSE+1)
end_define

begin_define
define|#
directive|define
name|XMENU_LINE
value|(XMENU_LOG+1)
end_define

begin_define
define|#
directive|define
name|XMENU_REDRAW
value|(XMENU_LINE+1)
end_define

begin_define
define|#
directive|define
name|XMENU_RESUME
value|(XMENU_REDRAW+1)
end_define

begin_define
define|#
directive|define
name|XMENU_SUSPEND
value|(XMENU_RESUME+1)
end_define

begin_define
define|#
directive|define
name|XMENU_INTR
value|(XMENU_SUSPEND+1)
end_define

begin_define
define|#
directive|define
name|XMENU_HANGUP
value|(XMENU_INTR+1)
end_define

begin_define
define|#
directive|define
name|XMENU_TERM
value|(XMENU_HANGUP+1)
end_define

begin_define
define|#
directive|define
name|XMENU_KILL
value|(XMENU_TERM+1)
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|xtext
index|[]
init|=
block|{
literal|"Title Bar(s)"
block|,
literal|"Active Icon"
block|,
literal|"Allow Icon Input"
block|,
literal|"Auto Raise"
block|,
literal|"Audible Bell"
block|,
literal|"Visual Bell"
block|,
literal|"Deiconify Warp"
block|,
literal|"Send Mouse Pos"
block|,
literal|"Logging"
block|,
literal|"-"
block|,
literal|"Redraw"
block|,
literal|"Continue"
block|,
literal|"Suspend"
block|,
literal|"Interrupt"
block|,
literal|"Hangup"
block|,
literal|"Terminate"
block|,
literal|"Kill"
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xauto
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xabell
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xvbell
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xdeiconwarp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xsendmouse
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xlog
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xtbar
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xactive_icon
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|xallow_iconinput
decl_stmt|;
end_decl_stmt

begin_function
name|Menu
modifier|*
name|xsetupmenu
parameter_list|(
name|menu
parameter_list|)
specifier|register
name|Menu
modifier|*
modifier|*
name|menu
decl_stmt|;
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|*
name|menu
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|menu
operator|=
name|NewMenu
argument_list|(
literal|"xterm X10/6.6B"
argument_list|,
name|re_verse
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|cp
operator|=
name|xtext
init|;
operator|*
name|cp
condition|;
name|cp
operator|++
control|)
name|AddMenuItem
argument_list|(
operator|*
name|menu
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|xtbar
operator|=
operator|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|>
literal|0
operator|)
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_TITLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|xactive_icon
operator|=
name|screen
operator|->
name|active_icon
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_ACTIVEICON
argument_list|)
expr_stmt|;
if|if
condition|(
name|xallow_iconinput
operator|=
operator|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
operator|)
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_ALLOWICONINPUT
argument_list|)
expr_stmt|;
name|SetItemDisable
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_ALLOWICONINPUT
argument_list|,
operator|!
name|xactive_icon
argument_list|)
expr_stmt|;
if|if
condition|(
name|xauto
operator|=
name|screen
operator|->
name|autoraise
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_AUTORAISE
argument_list|)
expr_stmt|;
if|if
condition|(
name|xabell
operator|=
name|screen
operator|->
name|audiblebell
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_AUDIBLEBELL
argument_list|)
expr_stmt|;
if|if
condition|(
name|xvbell
operator|=
name|screen
operator|->
name|visualbell
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_VISUALBELL
argument_list|)
expr_stmt|;
if|if
condition|(
name|xdeiconwarp
operator|=
name|screen
operator|->
name|deiconwarp
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_DEICONWARP
argument_list|)
expr_stmt|;
if|if
condition|(
name|xlog
operator|=
name|screen
operator|->
name|logging
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_LOG
argument_list|)
expr_stmt|;
if|if
condition|(
name|xsendmouse
operator|=
name|screen
operator|->
name|send_mouse_pos
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_SENDMOUSE
argument_list|)
expr_stmt|;
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|inhibit
operator|&
name|I_LOG
condition|)
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_LOG
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|inhibit
operator|&
name|I_SIGNAL
condition|)
for|for
control|(
name|i
operator|=
name|XMENU_SUSPEND
init|;
name|i
operator|<=
name|XMENU_KILL
condition|;
name|i
operator|++
control|)
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|menu
operator|)
return|;
block|}
if|if
condition|(
name|xtbar
operator|!=
operator|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|>
literal|0
operator|)
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_TITLE
argument_list|,
operator|(
name|xtbar
operator|=
operator|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|>
literal|0
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xactive_icon
operator|!=
name|screen
operator|->
name|active_icon
condition|)
block|{
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_ACTIVEICON
argument_list|,
operator|(
name|xactive_icon
operator|=
name|screen
operator|->
name|active_icon
operator|)
argument_list|)
expr_stmt|;
name|SetItemDisable
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_ALLOWICONINPUT
argument_list|,
operator|!
name|xactive_icon
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|xallow_iconinput
operator|!=
operator|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
operator|)
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_ALLOWICONINPUT
argument_list|,
operator|(
name|xallow_iconinput
operator|=
operator|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xauto
operator|!=
name|screen
operator|->
name|autoraise
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_AUTORAISE
argument_list|,
operator|(
name|xauto
operator|=
name|screen
operator|->
name|autoraise
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xabell
operator|!=
name|screen
operator|->
name|audiblebell
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_AUDIBLEBELL
argument_list|,
operator|(
name|xabell
operator|=
name|screen
operator|->
name|audiblebell
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xvbell
operator|!=
name|screen
operator|->
name|visualbell
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_VISUALBELL
argument_list|,
operator|(
name|xvbell
operator|=
name|screen
operator|->
name|visualbell
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xdeiconwarp
operator|!=
name|screen
operator|->
name|deiconwarp
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_DEICONWARP
argument_list|,
operator|(
name|xdeiconwarp
operator|=
name|screen
operator|->
name|deiconwarp
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xsendmouse
operator|!=
name|screen
operator|->
name|send_mouse_pos
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_SENDMOUSE
argument_list|,
operator|(
name|xsendmouse
operator|=
name|screen
operator|->
name|send_mouse_pos
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xlog
operator|!=
name|screen
operator|->
name|logging
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|XMENU_LOG
argument_list|,
operator|(
name|xlog
operator|=
name|screen
operator|->
name|logging
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|menu
operator|)
return|;
block|}
end_function

begin_macro
name|xdomenufunc
argument_list|(
argument|item
argument_list|)
end_macro

begin_decl_stmt
name|int
name|item
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
switch|switch
condition|(
name|item
condition|)
block|{
case|case
name|XMENU_TITLE
case|:
if|if
condition|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
condition|)
block|{
name|screen
operator|->
name|fullVwin
operator|.
name|titlebar
operator|=
name|screen
operator|->
name|fullTwin
operator|.
name|titlebar
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|)
name|VTTitleHide
argument_list|()
expr_stmt|;
if|if
condition|(
name|TWindow
argument_list|(
name|screen
argument_list|)
condition|)
name|TekTitleHide
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|screen
operator|->
name|fullVwin
operator|.
name|titlebar
operator|=
name|screen
operator|->
name|fullTwin
operator|.
name|titlebar
operator|=
name|screen
operator|->
name|titleheight
expr_stmt|;
if|if
condition|(
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|)
name|VTTitleShow
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|TWindow
argument_list|(
name|screen
argument_list|)
condition|)
name|TekTitleShow
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|XMENU_ACTIVEICON
case|:
name|screen
operator|->
name|active_icon
operator|=
operator|!
name|screen
operator|->
name|active_icon
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|active_icon
operator|&&
operator|!
name|screen
operator|->
name|fnt_icon
condition|)
block|{
name|FontInfo
modifier|*
name|fInfo
init|=
name|XOpenFont
argument_list|(
name|f_i
argument_list|)
decl_stmt|;
name|screen
operator|->
name|fnt_icon
operator|=
name|fInfo
operator|->
name|id
expr_stmt|;
name|screen
operator|->
name|iconVwin
operator|.
name|f_width
operator|=
name|fInfo
operator|->
name|width
expr_stmt|;
name|screen
operator|->
name|iconVwin
operator|.
name|f_height
operator|=
name|fInfo
operator|->
name|height
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
condition|)
block|{
name|SetIconSize
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|active_icon
operator|&&
operator|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
operator|)
condition|?
name|ICONWINDOWEVENTS
operator||
name|ICONINPUTEVENTS
else|:
name|ICONWINDOWEVENTS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
condition|)
block|{
name|TSetIconSize
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|active_icon
operator|&&
operator|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
operator|)
condition|?
name|TICONWINDOWEVENTS
operator||
name|ICONINPUTEVENTS
else|:
name|TICONWINDOWEVENTS
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|XMENU_ALLOWICONINPUT
case|:
name|term
operator|.
name|flags
operator|^=
name|ICONINPUT
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
condition|)
name|XSelectInput
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|active_icon
operator|&&
operator|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
operator|)
condition|?
name|ICONWINDOWEVENTS
operator||
name|ICONINPUTEVENTS
else|:
name|ICONWINDOWEVENTS
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
condition|)
name|XSelectInput
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|active_icon
operator|&&
operator|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
operator|)
condition|?
name|TICONWINDOWEVENTS
operator||
name|ICONINPUTEVENTS
else|:
name|TICONWINDOWEVENTS
argument_list|)
expr_stmt|;
break|break;
case|case
name|XMENU_AUTORAISE
case|:
name|screen
operator|->
name|autoraise
operator|=
operator|!
name|screen
operator|->
name|autoraise
expr_stmt|;
break|break;
case|case
name|XMENU_DEICONWARP
case|:
name|screen
operator|->
name|deiconwarp
operator|=
operator|!
name|screen
operator|->
name|deiconwarp
expr_stmt|;
break|break;
case|case
name|XMENU_AUDIBLEBELL
case|:
name|screen
operator|->
name|audiblebell
operator|=
operator|!
name|screen
operator|->
name|audiblebell
expr_stmt|;
break|break;
case|case
name|XMENU_VISUALBELL
case|:
name|screen
operator|->
name|visualbell
operator|=
operator|!
name|screen
operator|->
name|visualbell
expr_stmt|;
break|break;
case|case
name|XMENU_SENDMOUSE
case|:
name|screen
operator|->
name|send_mouse_pos
operator|=
operator|!
name|screen
operator|->
name|send_mouse_pos
expr_stmt|;
break|break;
case|case
name|XMENU_LOG
case|:
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
name|CloseLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|StartLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
name|XMENU_REDRAW
case|:
name|Redraw
argument_list|()
expr_stmt|;
break|break;
case|case
name|XMENU_RESUME
case|:
if|if
condition|(
name|screen
operator|->
name|pid
operator|>
literal|1
condition|)
name|killpg
argument_list|(
name|getpgrp
argument_list|(
name|screen
operator|->
name|pid
argument_list|)
argument_list|,
name|SIGCONT
argument_list|)
expr_stmt|;
break|break;
case|case
name|XMENU_SUSPEND
case|:
if|if
condition|(
name|screen
operator|->
name|pid
operator|>
literal|1
condition|)
name|killpg
argument_list|(
name|getpgrp
argument_list|(
name|screen
operator|->
name|pid
argument_list|)
argument_list|,
name|SIGTSTP
argument_list|)
expr_stmt|;
break|break;
case|case
name|XMENU_INTR
case|:
if|if
condition|(
name|screen
operator|->
name|pid
operator|>
literal|1
condition|)
name|killpg
argument_list|(
name|getpgrp
argument_list|(
name|screen
operator|->
name|pid
argument_list|)
argument_list|,
name|SIGINT
argument_list|)
expr_stmt|;
break|break;
case|case
name|XMENU_HANGUP
case|:
if|if
condition|(
name|screen
operator|->
name|pid
operator|>
literal|1
condition|)
name|killpg
argument_list|(
name|getpgrp
argument_list|(
name|screen
operator|->
name|pid
argument_list|)
argument_list|,
name|SIGHUP
argument_list|)
expr_stmt|;
break|break;
case|case
name|XMENU_TERM
case|:
if|if
condition|(
name|screen
operator|->
name|pid
operator|>
literal|1
condition|)
name|killpg
argument_list|(
name|getpgrp
argument_list|(
name|screen
operator|->
name|pid
argument_list|)
argument_list|,
name|SIGTERM
argument_list|)
expr_stmt|;
break|break;
case|case
name|XMENU_KILL
case|:
if|if
condition|(
name|screen
operator|->
name|pid
operator|>
literal|1
condition|)
name|killpg
argument_list|(
name|getpgrp
argument_list|(
name|screen
operator|->
name|pid
argument_list|)
argument_list|,
name|SIGKILL
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_ifndef
ifndef|#
directive|ifndef
name|NOWINDOWMENU
end_ifndef

begin_function
name|Menu
modifier|*
name|wsetupmenu
parameter_list|(
name|menu
parameter_list|)
specifier|register
name|Menu
modifier|*
modifier|*
name|menu
decl_stmt|;
block|{
specifier|register
name|Window
modifier|*
name|cp
decl_stmt|,
modifier|*
name|wp
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|np
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|Window
name|win
decl_stmt|,
modifier|*
name|children
decl_stmt|;
name|int
name|nchildren
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|WindowInfo
name|winfo
decl_stmt|;
if|if
condition|(
operator|!
name|XQueryTree
argument_list|(
name|RootWindow
argument_list|,
operator|&
name|win
argument_list|,
operator|&
name|nchildren
argument_list|,
operator|&
name|children
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|nchildren
operator|>
name|MAXWINDOWMENU
condition|)
name|nchildren
operator|=
name|MAXWINDOWMENU
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|menu
operator|=
name|NewMenu
argument_list|(
literal|"Windows"
argument_list|,
name|re_verse
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|children
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|np
operator|=
name|namebuf
expr_stmt|;
name|wp
operator|=
name|windows
expr_stmt|;
for|for
control|(
name|i
operator|=
name|nchildren
operator|,
name|j
operator|=
literal|0
operator|,
name|cp
operator|=
name|children
init|;
name|i
operator|>
literal|0
condition|;
name|cp
operator|++
operator|,
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|!
name|XQueryWindow
argument_list|(
operator|*
name|cp
argument_list|,
operator|&
name|winfo
argument_list|)
condition|)
goto|goto
name|failed
goto|;
if|if
condition|(
name|winfo
operator|.
name|mapped
operator|!=
name|IsMapped
condition|)
continue|continue;
if|if
condition|(
operator|!
name|XFetchName
argument_list|(
operator|*
name|cp
argument_list|,
operator|&
name|name
argument_list|)
condition|)
block|{
name|failed
label|:
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|children
argument_list|)
expr_stmt|;
operator|*
name|np
operator|=
name|NULL
expr_stmt|;
name|wfree
argument_list|(
operator|*
name|menu
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
continue|continue;
name|AddMenuItem
argument_list|(
operator|*
name|menu
argument_list|,
operator|*
name|np
operator|++
operator|=
name|name
argument_list|)
expr_stmt|;
operator|*
name|wp
operator|++
operator|=
operator|*
name|cp
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|wname
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
operator|*
name|np
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|children
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|>
name|namebuf
condition|)
return|return
operator|(
operator|*
name|menu
operator|)
return|;
name|DisposeMenu
argument_list|(
operator|*
name|menu
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_macro
name|wdomenufunc
argument_list|(
argument|item
argument_list|)
end_macro

begin_decl_stmt
name|int
name|item
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Window
name|w
decl_stmt|;
if|if
condition|(
operator|(
name|w
operator|=
name|windows
index|[
name|item
index|]
operator|)
operator|!=
name|NULL
condition|)
name|XRaiseWindow
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|wfree
argument_list|(
argument|menu
argument_list|)
end_macro

begin_decl_stmt
name|Menu
modifier|*
name|menu
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
modifier|*
name|np
decl_stmt|;
for|for
control|(
name|np
operator|=
name|namebuf
init|;
operator|*
name|np
condition|;
name|np
operator|++
control|)
name|free
argument_list|(
operator|*
name|np
argument_list|)
expr_stmt|;
name|DisposeMenu
argument_list|(
name|menu
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|NOWINDOWMENU
end_endif

begin_expr_stmt
name|MenuNewCursor
argument_list|(
name|cur
argument_list|)
specifier|register
name|Cursor
name|cur
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|Menu
modifier|*
modifier|*
name|menu
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|extern
name|Cursor
name|Menu_DefaultCursor
decl_stmt|;
name|Menu_DefaultCursor
operator|=
name|cur
expr_stmt|;
for|for
control|(
name|i
operator|=
name|XTERMMENU
operator|,
name|menu
operator|=
name|menus
init|;
name|i
operator|<=
name|TEKMENU
condition|;
name|menu
operator|++
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|*
name|menu
condition|)
continue|continue;
operator|(
operator|*
name|menu
operator|)
operator|->
name|menuCursor
operator|=
name|cur
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|menu
operator|)
operator|->
name|menuWindow
condition|)
name|XDefineCursor
argument_list|(
operator|(
operator|*
name|menu
operator|)
operator|->
name|menuWindow
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_else
else|#
directive|else
else|MODEMENU
end_else

begin_macro
name|ModeMenu
argument_list|(
argument|term
argument_list|,
argument|reply
argument_list|,
argument|pty
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|XKeyOrButtonEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
if|if
condition|(
operator|(
name|reply
operator|->
name|window
operator|==
name|screen
operator|->
name|title
operator|.
name|tbar
operator|||
name|reply
operator|->
name|window
operator|==
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
operator|)
operator|&&
name|InTitle
argument_list|(
name|screen
argument_list|,
name|reply
operator|->
name|window
argument_list|,
name|reply
operator|->
name|x
argument_list|)
condition|)
return|return;
name|Bell
argument_list|()
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|MODEMENU
end_endif

begin_macro
name|GINbutton
argument_list|(
argument|term
argument_list|,
argument|reply
argument_list|,
argument|pty
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|XKeyOrButtonEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
block|{
name|i
operator|=
literal|"rml"
index|[
name|reply
operator|->
name|detail
operator|&
literal|0xff
index|]
expr_stmt|;
if|if
condition|(
name|reply
operator|->
name|detail
operator|&
name|ShiftMask
condition|)
name|i
operator|=
name|toupper
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|TekEnqMouse
argument_list|(
name|i
operator||
literal|0x80
argument_list|)
expr_stmt|;
comment|/* set high bit */
name|TekGINoff
argument_list|()
expr_stmt|;
block|}
else|else
name|Bell
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|Bogus
argument_list|(
argument|term
argument_list|,
argument|reply
argument_list|,
argument|pty
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|XKeyOrButtonEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{
name|Bell
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|Silence
argument_list|(
argument|term
argument_list|,
argument|reply
argument_list|,
argument|pty
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|XKeyOrButtonEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{ }
end_block

end_unit


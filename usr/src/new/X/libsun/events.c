begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_events_c
init|=
literal|"$Header: events.c,v 10.4 86/12/17 20:36:45 swick Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|sun
end_ifdef

begin_comment
comment|/*  * The Sun X drivers are a product of Sun Microsystems, Inc. and are provided  * for unrestricted use provided that this legend is included on all tape  * media and as a part of the software program in whole or part.  Users  * may copy or modify these drivers without charge, but are not authorized  * to license or distribute them to anyone else except as part of a product or  * program developed by the user.  *   * THE SUN X DRIVERS ARE PROVIDED AS IS WITH NO WARRANTIES OF ANY KIND  * INCLUDING THE WARRANTIES OF DESIGN, MERCHANTIBILITY AND FITNESS FOR A  * PARTICULAR PURPOSE, OR ARISING FROM A COURSE OF DEALING, USAGE OR TRADE  * PRACTICE.  *  * The Sun X Drivers are provided with no support and without any obligation  * on the part of Sun Microsystems, Inc. to assist in their use, correction,  * modification or enhancement.  *   * SUN MICROSYSTEMS, INC. SHALL HAVE NO LIABILITY WITH RESPECT TO THE  * INFRINGEMENT OF COPYRIGHTS, TRADE SECRETS OR ANY PATENTS BY THE SUN X  * DRIVERS OR ANY PART THEREOF.  *   * In no event will Sun Microsystems, Inc. be liable for any lost revenue  * or profits or other special, indirect and consequential damages, even if  * Sun has been advised of the possibility of such damages.  *   * Sun Microsystems, Inc.  * 2550 Garcia Avenue  * Mountain View, California  94043  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)events.c 2.1 86/01/28 Copyright 1986 Sun Micro"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*-  * Copyright (c) 1986 by Sun Microsystems,  Inc.  */
end_comment

begin_comment
comment|/*  *	ToDo:  *		Up events on regular keys  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|"../X/X.h"
end_include

begin_include
include|#
directive|include
file|"../X/vsinput.h"
end_include

begin_include
include|#
directive|include
file|"../X/Xdev.h"
end_include

begin_include
include|#
directive|include
file|<sundev/kbd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|RAW_KBD
end_ifdef

begin_include
include|#
directive|include
file|<sundev/kbio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sunwindow/win_input.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|event_is_ascii
end_ifndef

begin_define
define|#
directive|define
name|event_is_ascii
parameter_list|(
name|e
parameter_list|)
value|(e->ie_code>= ASCII_FIRST&& e->ie_code<= ASCII_LAST)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|event_is_meta
end_ifndef

begin_define
define|#
directive|define
name|event_is_meta
parameter_list|(
name|e
parameter_list|)
value|(e->ie_code>= META_FIRST&& e->ie_code<= META_LAST)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Should be qevent.h */
end_comment

begin_define
define|#
directive|define
name|VSE_LEFT_BUTTON
value|0
end_define

begin_define
define|#
directive|define
name|VSE_MIDDLE_BUTTON
value|1
end_define

begin_define
define|#
directive|define
name|VSE_RIGHT_BUTTON
value|2
end_define

begin_define
define|#
directive|define
name|NOT_A_KEY
value|9
end_define

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|vsdev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|DEVICE
modifier|*
name|CurrentDevice
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sunthreshold
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sunaccel
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|RAW_KBD
end_ifdef

begin_decl_stmt
specifier|extern
name|unsigned
name|state_mask
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_expr_stmt
name|ProcessInput
argument_list|(
name|ev
argument_list|)
specifier|register
name|vsEvent
operator|*
name|ev
expr_stmt|;
end_expr_stmt

begin_block
block|{
comment|/*NOTREACHED*/
block|}
end_block

begin_include
include|#
directive|include
file|"lk201.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|RAW_KBD
end_ifdef

begin_decl_stmt
specifier|extern
name|struct
name|kiockey
name|sunkeymap
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Convert from a Sun event to an X event  */
end_comment

begin_function
name|unsigned
name|ConvertEvent
parameter_list|(
name|se
parameter_list|,
name|xe
parameter_list|)
name|struct
name|inputevent
modifier|*
name|se
decl_stmt|;
name|vsEvent
modifier|*
name|xe
decl_stmt|;
block|{
name|int
name|key
decl_stmt|;
name|unsigned
name|kludgekey
decl_stmt|;
comment|/* Map the coordinates */
name|xe
operator|->
name|vse_x
operator|=
name|se
operator|->
name|ie_locx
expr_stmt|;
name|xe
operator|->
name|vse_y
operator|=
name|se
operator|->
name|ie_locy
expr_stmt|;
comment|/* Map the time stamps */
name|xe
operator|->
name|vse_time
operator|=
operator|(
name|se
operator|->
name|ie_time
operator|.
name|tv_usec
operator|/
literal|10000
operator|+
name|se
operator|->
name|ie_time
operator|.
name|tv_sec
operator|)
expr_stmt|;
comment|/* Set direction */
name|xe
operator|->
name|vse_direction
operator|=
operator|(
name|win_inputposevent
argument_list|(
name|se
argument_list|)
condition|?
name|VSE_KBTDOWN
else|:
name|VSE_KBTUP
operator|)
expr_stmt|;
comment|/* Sort out the event codes */
if|if
condition|(
name|se
operator|->
name|ie_code
operator|>=
name|VKEY_FIRSTSHIFT
operator|&&
name|se
operator|->
name|ie_code
operator|<=
name|VKEY_LASTSHIFT
condition|)
block|{
comment|/* 	 * this makes ie_code between 0 and 0200 inclusive. 	 */
name|se
operator|->
name|ie_code
operator|-=
name|VKEY_FIRSTSHIFT
expr_stmt|;
name|key
operator|=
name|SHIFTKEYS
operator|+
name|se
operator|->
name|ie_code
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|se
operator|->
name|ie_code
operator|>=
literal|0
operator|&&
name|se
operator|->
name|ie_code
operator|<
literal|0200
condition|)
name|key
operator|=
name|sunkeymap
index|[
name|se
operator|->
name|ie_code
index|]
operator|.
name|kio_entry
expr_stmt|;
else|else
name|key
operator|=
operator|-
literal|1
expr_stmt|;
name|kludgekey
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|key
operator|>=
literal|0
condition|)
block|{
name|xe
operator|->
name|vse_device
operator|=
name|VSE_DKB
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
comment|/* 	 * First deal with special keycodes 	 */
if|if
condition|(
name|key
operator|&
literal|0x80
condition|)
block|{
switch|switch
condition|(
name|key
operator|&
literal|0xf0
condition|)
block|{
case|case
name|SHIFTKEYS
case|:
comment|/* 			 * The static count is keeping track of how many 			 * keys I have down for the given function. 			 * Only need to do this for shift and meta. 			 * On an up event I decrease the count.  If it is 			 * not the last one up then I convert to a down event 			 * which really won't do anything.  I should ignore 			 * the event, but this works. 			 * At odd times the sun keyboard gets confused and I 			 * miss an UP event.  This may get you stuck in 			 * shift mode.  I assume there is only 2 shift keys 			 * and only two meta keys.  If count ever goes above 			 * 2 I make it 2 again, assuming I have missed an up 			 * event.  If you get stuck in shifted mode, just his 			 * both shift keys and you should be fixed. 			 */
switch|switch
condition|(
name|key
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|11
case|:
case|case
literal|14
case|:
case|case
name|LEFTSHIFT
case|:
case|case
name|RIGHTSHIFT
case|:
block|{
specifier|static
name|count
expr_stmt|;
name|kludgekey
operator|=
literal|0256
expr_stmt|;
if|if
condition|(
name|win_inputposevent
argument_list|(
name|se
argument_list|)
condition|)
block|{
if|if
condition|(
operator|++
name|count
operator|>
literal|2
condition|)
name|count
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|--
name|count
operator|>
literal|0
condition|)
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
elseif|else
if|if
condition|(
name|count
operator|<
literal|0
condition|)
name|count
operator|=
literal|0
expr_stmt|;
break|break;
block|}
comment|/* LEFT/RIGHT key */
case|case
literal|9
case|:
default|default:
block|{
specifier|static
name|count
expr_stmt|;
name|kludgekey
operator|=
literal|0261
expr_stmt|;
if|if
condition|(
name|win_inputposevent
argument_list|(
name|se
argument_list|)
condition|)
block|{
if|if
condition|(
operator|++
name|count
operator|>
literal|2
condition|)
name|count
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|--
name|count
operator|>
literal|0
condition|)
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
elseif|else
if|if
condition|(
name|count
operator|<
literal|0
condition|)
name|count
operator|=
literal|0
expr_stmt|;
break|break;
block|}
case|case
literal|10
case|:
case|case
literal|13
case|:
case|case
name|CAPSLOCK
case|:
case|case
name|SHIFTLOCK
case|:
name|kludgekey
operator|=
literal|0260
expr_stmt|;
break|break;
case|case
literal|12
case|:
case|case
literal|15
case|:
case|case
name|LEFTCTRL
case|:
case|case
name|RIGHTCTRL
case|:
name|kludgekey
operator|=
literal|0257
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|STRING
case|:
switch|switch
condition|(
name|key
operator|&
literal|0xf
condition|)
block|{
default|default:
case|case
name|HOMEARROW
case|:
name|kludgekey
operator|=
literal|0206
expr_stmt|;
break|break;
case|case
name|UPARROW
case|:
name|kludgekey
operator|=
literal|0252
expr_stmt|;
break|break;
case|case
name|DOWNARROW
case|:
name|kludgekey
operator|=
literal|0251
expr_stmt|;
break|break;
case|case
name|LEFTARROW
case|:
name|kludgekey
operator|=
literal|0247
expr_stmt|;
break|break;
case|case
name|RIGHTARROW
case|:
name|kludgekey
operator|=
literal|0250
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|RIGHTFUNC
case|:
name|kludgekey
operator|=
name|RightKeys
index|[
name|key
operator|&
literal|0xf
index|]
expr_stmt|;
break|break;
case|case
name|LEFTFUNC
case|:
name|kludgekey
operator|=
name|LeftKeys
index|[
name|key
operator|&
literal|0xf
index|]
expr_stmt|;
break|break;
case|case
name|TOPFUNC
case|:
name|kludgekey
operator|=
name|TopKeys
index|[
name|key
operator|&
literal|0xf
index|]
expr_stmt|;
break|break;
case|case
name|BOTTOMFUNC
case|:
name|kludgekey
operator|=
name|BotKeys
index|[
name|key
operator|&
literal|0xf
index|]
expr_stmt|;
break|break;
case|case
name|BUCKYBITS
case|:
case|case
name|FUNNY
case|:
default|default:
name|kludgekey
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 	 * Now deal with regular keys. 	 * Note, I look up the key in the shift/ctrl/caps tables 	 * in case the keys are not quite like a lk201. 	 * I assume that a regular key shifted/ctrled/caped is also a 	 * regular key.  This may be naive. 	 */
if|if
condition|(
name|key
operator|==
literal|'\033'
comment|/*ESC*/
condition|)
name|kludgekey
operator|=
literal|0161
expr_stmt|;
elseif|else
if|if
condition|(
name|key
operator|==
literal|'\b'
condition|)
name|kludgekey
operator|=
literal|0162
expr_stmt|;
elseif|else
if|if
condition|(
name|key
operator|==
literal|'\n'
condition|)
name|kludgekey
operator|=
literal|0163
expr_stmt|;
elseif|else
if|if
condition|(
name|key
operator|==
literal|'\r'
condition|)
name|kludgekey
operator|=
literal|0275
expr_stmt|;
elseif|else
if|if
condition|(
name|key
operator|==
literal|'\t'
condition|)
name|kludgekey
operator|=
literal|0276
expr_stmt|;
elseif|else
if|if
condition|(
name|key
operator|==
literal|'\006'
comment|/*ALT*/
condition|)
name|kludgekey
operator|=
literal|0245
expr_stmt|;
elseif|else
if|if
condition|(
name|key
operator|==
literal|'\177'
comment|/*DEL*/
condition|)
name|kludgekey
operator|=
literal|0274
expr_stmt|;
elseif|else
if|if
condition|(
name|state_mask
operator|&
name|ControlMask
condition|)
name|kludgekey
operator|=
name|LK201
index|[
name|sunkeymap
index|[
name|se
operator|->
name|ie_code
operator|+
literal|00200
index|]
operator|.
name|kio_entry
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|state_mask
operator|&
name|ShiftMask
condition|)
name|kludgekey
operator|=
name|LK201
index|[
name|sunkeymap
index|[
name|se
operator|->
name|ie_code
operator|+
literal|00600
index|]
operator|.
name|kio_entry
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|state_mask
operator|&
name|ShiftLockMask
condition|)
name|kludgekey
operator|=
name|LK201
index|[
name|sunkeymap
index|[
name|se
operator|->
name|ie_code
operator|+
literal|00400
index|]
operator|.
name|kio_entry
index|]
expr_stmt|;
else|else
name|kludgekey
operator|=
name|LK201
index|[
name|key
index|]
expr_stmt|;
block|}
name|xe
operator|->
name|vse_key
operator|=
name|kludgekey
operator|&
literal|0377
expr_stmt|;
name|kludgekey
operator|&=
operator|(
operator|~
name|state_mask
operator|)
operator|&
operator|(
name|ControlMask
operator||
name|ShiftMask
operator|)
expr_stmt|;
block|}
else|else
switch|switch
condition|(
name|se
operator|->
name|ie_code
condition|)
block|{
case|case
name|LOC_MOVE
case|:
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
comment|/* XXX - should query shift state here but ... */
name|xe
operator|->
name|vse_type
operator|=
name|VSE_MMOTION
expr_stmt|;
break|break;
case|case
name|MS_LEFT
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_LEFT_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
break|break;
case|case
name|MS_MIDDLE
case|:
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_key
operator|=
name|VSE_MIDDLE_BUTTON
expr_stmt|;
break|break;
case|case
name|MS_RIGHT
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_RIGHT_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
break|break;
default|default:
name|xe
operator|->
name|vse_key
operator|=
name|NOT_A_KEY
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|kludgekey
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|INPBUFSIZE
value|128
end_define

begin_comment
comment|/*  * Read pending input events  */
end_comment

begin_macro
name|InputReader
argument_list|()
end_macro

begin_block
block|{
name|struct
name|inputevent
name|sunevents
index|[
name|INPBUFSIZE
index|]
decl_stmt|;
name|int
name|n
decl_stmt|,
name|m
decl_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|read
argument_list|(
name|vsdev
argument_list|,
name|sunevents
argument_list|,
name|INPBUFSIZE
operator|*
sizeof|sizeof
name|sunevents
index|[
literal|0
index|]
argument_list|)
operator|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|EWOULDBLOCK
condition|)
block|{
comment|/* 	 * Error reading events  	 */
comment|/* XXX_DO_SOMETHING(); */
return|return;
block|}
for|for
control|(
name|n
operator|/=
sizeof|sizeof
name|sunevents
index|[
literal|0
index|]
operator|,
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|n
condition|;
name|m
operator|++
control|)
block|{
name|vsEvent
name|Xevent
decl_stmt|;
name|unsigned
name|kludgekey
init|=
name|ConvertEvent
argument_list|(
operator|&
operator|(
name|sunevents
index|[
name|m
index|]
operator|)
argument_list|,
operator|&
name|Xevent
argument_list|)
decl_stmt|;
if|if
condition|(
name|Xevent
operator|.
name|vse_type
operator|==
name|VSE_MMOTION
condition|)
block|{
if|if
condition|(
name|sunthreshold
condition|)
block|{
name|int
name|dx
init|=
name|Xevent
operator|.
name|vse_x
operator|-
name|CurrentDevice
operator|->
name|mouse
operator|->
name|x
decl_stmt|;
name|int
name|dy
init|=
name|Xevent
operator|.
name|vse_y
operator|-
name|CurrentDevice
operator|->
name|mouse
operator|->
name|y
decl_stmt|;
if|if
condition|(
name|sunthreshold
operator|<=
operator|(
name|dx
operator|>
literal|0
condition|?
name|dx
else|:
operator|-
name|dx
operator|)
operator|+
operator|(
name|dy
operator|>
literal|0
condition|?
name|dy
else|:
operator|-
name|dy
operator|)
condition|)
block|{
name|Xevent
operator|.
name|vse_x
operator|=
name|CurrentDevice
operator|->
name|mouse
operator|->
name|x
operator|+
name|dx
operator|*
name|sunaccel
expr_stmt|;
name|Xevent
operator|.
name|vse_y
operator|=
name|CurrentDevice
operator|->
name|mouse
operator|->
name|y
operator|+
name|dy
operator|*
name|sunaccel
expr_stmt|;
block|}
block|}
name|SetCursorPosition
argument_list|(
operator|(
name|vsCursor
operator|*
operator|)
operator|&
name|Xevent
argument_list|)
expr_stmt|;
comment|/* XXX - tacky */
block|}
name|Xevent
operator|.
name|vse_key
expr_stmt|;
if|if
condition|(
name|Xevent
operator|.
name|vse_type
operator|==
name|VSE_MMOTION
condition|)
block|{
specifier|register
name|vsBox
modifier|*
name|b
init|=
name|CurrentDevice
operator|->
name|mbox
decl_stmt|;
specifier|register
name|vsCursor
modifier|*
name|m
init|=
name|CurrentDevice
operator|->
name|mouse
decl_stmt|;
comment|/* 	     * Has it left the box?  	     */
if|if
condition|(
name|m
operator|->
name|y
operator|>=
name|b
operator|->
name|bottom
operator|||
name|m
operator|->
name|y
operator|<
name|b
operator|->
name|top
operator|||
name|m
operator|->
name|x
operator|>=
name|b
operator|->
name|right
operator|||
name|m
operator|->
name|x
operator|<
name|b
operator|->
name|left
condition|)
block|{
name|b
operator|->
name|bottom
operator|=
literal|0
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|Xevent
operator|.
name|vse_key
operator|!=
name|NOT_A_KEY
operator|||
name|Xevent
operator|.
name|vse_device
operator|!=
name|VSE_MOUSE
condition|)
block|{
name|state_mask
operator||=
name|kludgekey
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|Xevent
argument_list|)
expr_stmt|;
name|state_mask
operator|&=
operator|~
name|kludgekey
expr_stmt|;
block|}
block|}
block|}
end_block

begin_else
else|#
directive|else
end_else

begin_function
specifier|static
name|int
name|SunToXKeyCode
parameter_list|(
name|s
parameter_list|)
name|int
name|s
decl_stmt|;
block|{
specifier|register
name|int
name|ret
init|=
name|LK201
index|[
name|s
operator|&
literal|0177
index|]
decl_stmt|;
name|char
modifier|*
name|c
init|=
literal|"^."
decl_stmt|;
name|char
modifier|*
name|f
init|=
literal|"."
decl_stmt|;
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|s
operator|&
literal|0177
operator|)
operator||
literal|0100
expr_stmt|;
name|f
index|[
literal|0
index|]
operator|=
operator|(
name|s
operator|&
literal|0177
operator|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert from a Sun event to an X event  */
end_comment

begin_function
name|int
name|ConvertEvent
parameter_list|(
name|se
parameter_list|,
name|xe
parameter_list|)
name|struct
name|inputevent
modifier|*
name|se
decl_stmt|;
name|vsEvent
modifier|*
name|xe
decl_stmt|;
block|{
specifier|static
name|unsigned
name|lstate_mask
decl_stmt|;
comment|/* Map the coordinates */
name|xe
operator|->
name|vse_x
operator|=
name|se
operator|->
name|ie_locx
expr_stmt|;
name|xe
operator|->
name|vse_y
operator|=
name|se
operator|->
name|ie_locy
expr_stmt|;
comment|/* Map the time stamps */
name|xe
operator|->
name|vse_time
operator|=
operator|(
name|se
operator|->
name|ie_time
operator|.
name|tv_usec
operator|/
literal|10000
operator|+
name|se
operator|->
name|ie_time
operator|.
name|tv_sec
operator|)
expr_stmt|;
comment|/* Set direction */
name|xe
operator|->
name|vse_direction
operator|=
operator|(
name|win_inputposevent
argument_list|(
name|se
argument_list|)
condition|?
name|VSE_KBTDOWN
else|:
name|VSE_KBTUP
operator|)
expr_stmt|;
comment|/* Sort out the event codes */
if|if
condition|(
name|event_is_ascii
argument_list|(
name|se
argument_list|)
condition|)
block|{
comment|/* ASCII keystroke */
name|int
name|key
init|=
name|SunToXKeyCode
argument_list|(
name|se
operator|->
name|ie_code
argument_list|)
decl_stmt|;
name|xe
operator|->
name|vse_key
operator|=
operator|(
name|key
operator|&
literal|0377
operator|)
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_DKB
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|lstate_mask
operator|=
operator|(
name|lstate_mask
operator|&
operator|~
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator|)
operator|)
operator||
operator|(
name|key
operator|&
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event_is_meta
argument_list|(
name|se
argument_list|)
condition|)
block|{
comment|/* META keystroke - map to ASCII for now */
name|int
name|key
init|=
name|SunToXKeyCode
argument_list|(
name|se
operator|->
name|ie_code
operator|-
name|META_FIRST
operator|+
name|ASCII_FIRST
argument_list|)
operator||
name|MetaMask
decl_stmt|;
name|xe
operator|->
name|vse_key
operator|=
operator|(
name|key
operator|&
literal|0377
operator|)
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_DKB
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|lstate_mask
operator|=
operator|(
name|lstate_mask
operator|&
operator|~
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator|)
operator|)
operator||
operator|(
name|key
operator|&
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator|)
operator|)
expr_stmt|;
block|}
else|else
switch|switch
condition|(
name|se
operator|->
name|ie_code
condition|)
block|{
case|case
name|LOC_MOVE
case|:
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
comment|/* XXX - should query shift state here but ... */
name|xe
operator|->
name|vse_type
operator|=
name|VSE_MMOTION
expr_stmt|;
break|break;
case|case
name|MS_LEFT
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_LEFT_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
if|if
condition|(
name|xe
operator|->
name|vse_direction
operator|==
name|VSE_KBTUP
condition|)
name|lstate_mask
operator|&=
operator|~
name|LeftMask
expr_stmt|;
else|else
name|lstate_mask
operator||=
name|LeftMask
expr_stmt|;
goto|goto
name|ShiftKeys
goto|;
case|case
name|MS_MIDDLE
case|:
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_key
operator|=
name|VSE_MIDDLE_BUTTON
expr_stmt|;
if|if
condition|(
name|xe
operator|->
name|vse_direction
operator|==
name|VSE_KBTUP
condition|)
name|lstate_mask
operator|&=
operator|~
name|MiddleMask
expr_stmt|;
else|else
name|lstate_mask
operator||=
name|MiddleMask
expr_stmt|;
goto|goto
name|ShiftKeys
goto|;
case|case
name|MS_RIGHT
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_RIGHT_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
if|if
condition|(
name|xe
operator|->
name|vse_direction
operator|==
name|VSE_KBTUP
condition|)
name|lstate_mask
operator|&=
operator|~
name|RightMask
expr_stmt|;
else|else
name|lstate_mask
operator||=
name|RightMask
expr_stmt|;
goto|goto
name|ShiftKeys
goto|;
default|default:
name|xe
operator|->
name|vse_key
operator|=
name|NOT_A_KEY
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
if|if
condition|(
name|xe
operator|->
name|vse_direction
operator|==
name|VSE_KBTUP
condition|)
name|lstate_mask
operator|&=
operator|~
name|ShiftLockMask
expr_stmt|;
else|else
name|lstate_mask
operator||=
name|ShiftLockMask
expr_stmt|;
name|ShiftKeys
label|:
if|if
condition|(
name|se
operator|->
name|ie_shiftmask
operator|&
name|SHIFTMASK
condition|)
name|lstate_mask
operator||=
name|ShiftMask
expr_stmt|;
else|else
name|lstate_mask
operator|&=
operator|~
name|ShiftMask
expr_stmt|;
if|if
condition|(
name|se
operator|->
name|ie_shiftmask
operator|&
name|CTRLMASK
condition|)
name|lstate_mask
operator||=
name|ControlMask
expr_stmt|;
else|else
name|lstate_mask
operator|&=
operator|~
name|ControlMask
expr_stmt|;
ifdef|#
directive|ifdef
name|META_SHIFT_MASK
if|if
condition|(
name|se
operator|->
name|ie_shiftmask
operator|&
name|META_SHIFT_MASK
condition|)
name|lstate_mask
operator||=
name|MetaMask
expr_stmt|;
else|else
name|lstate_mask
operator|&=
operator|~
name|MetaMask
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
return|return
operator|(
name|lstate_mask
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|INPBUFSIZE
value|128
end_define

begin_comment
comment|/*  * Read pending input events  */
end_comment

begin_macro
name|InputReader
argument_list|()
end_macro

begin_block
block|{
name|struct
name|inputevent
name|sunevents
index|[
name|INPBUFSIZE
index|]
decl_stmt|;
name|int
name|n
decl_stmt|,
name|m
decl_stmt|;
specifier|static
name|int
name|last_mask
decl_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|read
argument_list|(
name|vsdev
argument_list|,
name|sunevents
argument_list|,
name|INPBUFSIZE
operator|*
sizeof|sizeof
name|sunevents
index|[
literal|0
index|]
argument_list|)
operator|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|EWOULDBLOCK
condition|)
block|{
comment|/* 	 * Error reading events  	 */
comment|/* XXX_DO_SOMETHING(); */
return|return;
block|}
for|for
control|(
name|n
operator|/=
sizeof|sizeof
name|sunevents
index|[
literal|0
index|]
operator|,
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|n
condition|;
name|m
operator|++
control|)
block|{
name|vsEvent
name|Xevent
decl_stmt|,
name|Sevent
decl_stmt|;
name|int
name|mask
decl_stmt|;
name|mask
operator|=
name|ConvertEvent
argument_list|(
operator|&
operator|(
name|sunevents
index|[
name|m
index|]
operator|)
argument_list|,
operator|&
name|Xevent
argument_list|)
expr_stmt|;
if|if
condition|(
name|Xevent
operator|.
name|vse_type
operator|==
name|VSE_MMOTION
condition|)
block|{
if|if
condition|(
name|sunthreshold
condition|)
block|{
name|int
name|dx
init|=
name|Xevent
operator|.
name|vse_x
operator|-
name|CurrentDevice
operator|->
name|mouse
operator|->
name|x
decl_stmt|;
name|int
name|dy
init|=
name|Xevent
operator|.
name|vse_y
operator|-
name|CurrentDevice
operator|->
name|mouse
operator|->
name|y
decl_stmt|;
if|if
condition|(
name|sunthreshold
operator|<=
operator|(
name|dx
operator|>
literal|0
condition|?
name|dx
else|:
operator|-
name|dx
operator|)
operator|+
operator|(
name|dy
operator|>
literal|0
condition|?
name|dy
else|:
operator|-
name|dy
operator|)
condition|)
block|{
name|Xevent
operator|.
name|vse_x
operator|=
name|CurrentDevice
operator|->
name|mouse
operator|->
name|x
operator|+
name|dx
operator|*
name|sunaccel
expr_stmt|;
name|Xevent
operator|.
name|vse_y
operator|=
name|CurrentDevice
operator|->
name|mouse
operator|->
name|y
operator|+
name|dy
operator|*
name|sunaccel
expr_stmt|;
block|}
block|}
name|SetCursorPosition
argument_list|(
operator|(
name|vsCursor
operator|*
operator|)
operator|&
name|Xevent
argument_list|)
expr_stmt|;
comment|/* XXX - tacky */
block|}
if|if
condition|(
name|mask
operator|!=
name|last_mask
condition|)
block|{
name|last_mask
operator|^=
name|mask
expr_stmt|;
name|Sevent
operator|.
name|vse_device
operator|=
name|VSE_DKB
expr_stmt|;
name|Sevent
operator|.
name|vse_x
operator|=
name|Xevent
operator|.
name|vse_x
expr_stmt|;
name|Sevent
operator|.
name|vse_y
operator|=
name|Xevent
operator|.
name|vse_y
expr_stmt|;
name|Sevent
operator|.
name|vse_time
operator|=
name|Xevent
operator|.
name|vse_time
expr_stmt|;
if|if
condition|(
name|last_mask
operator|&
name|ShiftMask
condition|)
block|{
if|if
condition|(
name|mask
operator|&
name|ShiftMask
condition|)
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
else|else
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
name|Sevent
operator|.
name|vse_key
operator|=
literal|0256
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|Sevent
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|last_mask
operator|&
name|ControlMask
condition|)
block|{
if|if
condition|(
name|mask
operator|&
name|ControlMask
condition|)
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
else|else
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
name|Sevent
operator|.
name|vse_key
operator|=
literal|0257
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|Sevent
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|last_mask
operator|&
name|ShiftLockMask
condition|)
block|{
if|if
condition|(
name|mask
operator|&
name|ShiftLockMask
condition|)
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
else|else
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
name|Sevent
operator|.
name|vse_key
operator|=
literal|0260
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|Sevent
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|last_mask
operator|&
name|MetaMask
condition|)
block|{
if|if
condition|(
name|mask
operator|&
name|MetaMask
condition|)
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
else|else
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
name|Sevent
operator|.
name|vse_key
operator|=
literal|0261
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|Sevent
argument_list|)
expr_stmt|;
block|}
name|last_mask
operator|=
name|mask
expr_stmt|;
block|}
if|if
condition|(
name|Xevent
operator|.
name|vse_type
operator|==
name|VSE_MMOTION
condition|)
block|{
specifier|register
name|vsBox
modifier|*
name|b
init|=
name|CurrentDevice
operator|->
name|mbox
decl_stmt|;
specifier|register
name|vsCursor
modifier|*
name|m
init|=
name|CurrentDevice
operator|->
name|mouse
decl_stmt|;
comment|/* 	     * Has it left the box?  	     */
if|if
condition|(
name|m
operator|->
name|y
operator|>=
name|b
operator|->
name|bottom
operator|||
name|m
operator|->
name|y
operator|<
name|b
operator|->
name|top
operator|||
name|m
operator|->
name|x
operator|>=
name|b
operator|->
name|right
operator|||
name|m
operator|->
name|x
operator|<
name|b
operator|->
name|left
condition|)
block|{
name|b
operator|->
name|bottom
operator|=
literal|0
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|Xevent
operator|.
name|vse_key
operator|!=
name|NOT_A_KEY
operator|||
name|Xevent
operator|.
name|vse_device
operator|!=
name|VSE_MOUSE
condition|)
name|Deal_with_input
argument_list|(
operator|&
name|Xevent
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
endif|sun
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*      Copyright 1986 by the University of Utah      Permission to use, copy, modify, and distribute this     software and its documentation for any purpose and without     fee is hereby granted, provided that the above copyright     notice appear in all copies and that both that copyright     notice and this permission notice appear in supporting     documentation, and that the name of the University of Utah     not be used in advertising or publicity pertaining to      distribution of the software without specific, written      prior permission. The University of Utah makes no     representations about the suitability of this software for     any purpose.  It is provided "as is" without express or     implied warranty.      */
end_comment

begin_comment
comment|/* cursor.c	various stuff with the mouse& cursor  *  *	StoreCursor		Creates a cursor  *	FreeCursor		Frees the storage taken by a cursor  *	LoadCursor		Loads a bitmap to use as cursor  *	InitMouse		Initialize the mouse  *	SetCursorPosition	Forces cursor to a particular position  *	SetMouseCharacteristics	Controls speed of cursor relative to mouse  *  */
end_comment

begin_comment
comment|/*  *	ToDo:  *		Threshold/Acceleration  *		Use macros for CheckCursor()  */
end_comment

begin_include
include|#
directive|include
file|"Xapollo.h"
end_include

begin_function_decl
specifier|extern
name|char
modifier|*
name|Xalloc
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|DEVICE
modifier|*
name|CurrentDevice
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|CURSOR
modifier|*
name|CurrentCursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|CursorDisplayed
decl_stmt|;
end_decl_stmt

begin_function
name|CURSOR
modifier|*
name|StoreCursor
parameter_list|(
name|func
parameter_list|,
name|image
parameter_list|,
name|fore
parameter_list|,
name|back
parameter_list|,
name|mask
parameter_list|,
name|xoff
parameter_list|,
name|yoff
parameter_list|)
name|BITMAP
modifier|*
name|image
decl_stmt|;
name|BITMAP
modifier|*
name|mask
decl_stmt|;
name|int
name|func
decl_stmt|,
name|fore
decl_stmt|,
name|back
decl_stmt|,
name|xoff
decl_stmt|,
name|yoff
decl_stmt|;
block|{
specifier|register
name|CURSOR
modifier|*
name|cursor
decl_stmt|;
specifier|register
name|CursPriv
modifier|*
name|data
decl_stmt|;
if|if
condition|(
operator|!
name|image
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|cursor
operator|=
operator|(
name|CURSOR
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|CURSOR
argument_list|)
argument_list|)
expr_stmt|;
name|cursor
operator|->
name|width
operator|=
name|image
operator|->
name|width
expr_stmt|;
name|cursor
operator|->
name|height
operator|=
name|image
operator|->
name|height
expr_stmt|;
name|cursor
operator|->
name|xmin
operator|=
literal|0
expr_stmt|;
name|cursor
operator|->
name|ymin
operator|=
literal|0
expr_stmt|;
name|cursor
operator|->
name|xoff
operator|=
name|xoff
expr_stmt|;
name|cursor
operator|->
name|yoff
operator|=
name|yoff
expr_stmt|;
name|cursor
operator|->
name|xmax
operator|=
name|Screen
operator|.
name|width
operator|-
name|image
operator|->
name|width
expr_stmt|;
name|cursor
operator|->
name|ymax
operator|=
name|Screen
operator|.
name|height
operator|-
name|image
operator|->
name|height
expr_stmt|;
name|cursor
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|data
operator|=
operator|(
name|CursPriv
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|CursPriv
argument_list|)
argument_list|)
expr_stmt|;
name|cursor
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|data
expr_stmt|;
name|image
operator|->
name|refcnt
operator|++
expr_stmt|;
name|data
operator|->
name|bits
operator|=
operator|(
name|caddr_t
operator|)
name|image
expr_stmt|;
name|data
operator|->
name|fore
operator|=
name|fore
expr_stmt|;
name|data
operator|->
name|back
operator|=
name|back
expr_stmt|;
name|data
operator|->
name|save
operator|=
name|make_bitmap
argument_list|(
name|NULL
argument_list|,
name|image
operator|->
name|width
argument_list|,
name|image
operator|->
name|height
operator|+
literal|2
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
condition|)
block|{
name|data
operator|->
name|mask
operator|=
name|mask
expr_stmt|;
name|mask
operator|->
name|refcnt
operator|++
expr_stmt|;
block|}
else|else
name|data
operator|->
name|mask
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|cursor
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|FreeCursor
argument_list|(
name|cursor
argument_list|)
specifier|register
name|CURSOR
operator|*
name|cursor
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|CursPriv
modifier|*
name|cp
init|=
name|CDATA
argument_list|(
name|cursor
argument_list|)
decl_stmt|;
if|if
condition|(
operator|--
operator|(
name|cp
operator|->
name|bits
operator|->
name|refcnt
operator|)
operator|<=
literal|0
condition|)
name|FreeBitmap
argument_list|(
name|cp
operator|->
name|bits
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|->
name|mask
operator|&&
operator|--
operator|(
name|cp
operator|->
name|mask
operator|->
name|refcnt
operator|)
operator|<=
literal|0
condition|)
name|FreeBitmap
argument_list|(
name|cp
operator|->
name|mask
argument_list|)
expr_stmt|;
name|FreeBitmap
argument_list|(
name|cp
operator|->
name|save
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|CDATA
argument_list|(
name|cursor
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|cursor
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|LoadCursor
argument_list|(
name|cursor
argument_list|)
specifier|register
name|CURSOR
operator|*
name|cursor
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|CursorDisplayed
condition|)
name|DisplayCursor
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|CurrentCursor
operator|=
name|cursor
operator|)
operator|!=
name|NULL
condition|)
block|{
name|DisplayCursor
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|InitMouse
argument_list|()
end_macro

begin_block
block|{ }
end_block

begin_expr_stmt
name|SetCursorPosition
argument_list|(
name|pos
argument_list|)
specifier|register
name|vsCursor
operator|*
name|pos
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|pos
operator|->
name|x
operator|!=
operator|(
name|CurrentDevice
operator|->
name|mouse
operator|->
name|x
operator|)
operator|||
name|pos
operator|->
name|y
operator|!=
operator|(
name|CurrentDevice
operator|->
name|mouse
operator|->
name|y
operator|)
condition|)
block|{
if|if
condition|(
name|CursorDisplayed
condition|)
name|DisplayCursor
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|CurrentDevice
operator|->
name|mouse
operator|->
name|x
operator|=
name|pos
operator|->
name|x
expr_stmt|;
name|CurrentDevice
operator|->
name|mouse
operator|->
name|y
operator|=
name|pos
operator|->
name|y
expr_stmt|;
name|DisplayCursor
argument_list|(
name|CurrentCursor
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|SetMouseCharacteristics
argument_list|(
argument|threshold
argument_list|,
argument|accelaration
argument_list|)
end_macro

begin_decl_stmt
name|int
name|threshold
decl_stmt|,
name|accelaration
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_macro
name|DisplayCursor
argument_list|(
argument|cs
argument_list|)
end_macro

begin_decl_stmt
name|CURSOR
modifier|*
name|cs
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|vsCursor
modifier|*
name|ms
init|=
name|CurrentDevice
operator|->
name|mouse
decl_stmt|;
name|short
name|op
decl_stmt|,
name|i
decl_stmt|,
name|msx
decl_stmt|,
name|msy
decl_stmt|;
name|gpr_$window_t
name|srcwin
decl_stmt|;
name|gpr_$position_t
name|dstorg
decl_stmt|,
name|destorg
decl_stmt|;
name|status_$t
name|status
decl_stmt|;
specifier|static
name|gpr_$attribute_desc_t
name|ab
init|=
operator|-
literal|1
decl_stmt|;
name|gpr_$window_t
name|saved_clip_wind
decl_stmt|;
name|gpr_$window_t
name|screen_clip_wind
decl_stmt|;
name|boolean
name|saved_clip_active
decl_stmt|;
name|gpr_$mask_t
name|saved_plane_mask
decl_stmt|;
name|gpr_$raster_op_array_t
name|saved_rops
decl_stmt|;
comment|/* Use a private attribute block, since caller has probably already set    lots of attributes   --   We disable this, and just save/restore raster ops, clip window and plane mask,   --   because attribute block switching (1) is expensive, especially on color hardware, and   --   (2) screws up input enables something awful.  */
comment|/*     if (ab == -1)  {         gpr_$allocate_attribute_block( ab, status );         gpr_$set_attribute_block( ab, status );         gpr_$set_plane_mask(Screen.plane_mask, status);         }     gpr_$set_attribute_block( ab, status ); */
name|gpr_$inq_raster_ops
argument_list|(
name|saved_rops
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|gpr_$inq_constraints
argument_list|(
name|saved_clip_wind
argument_list|,
name|saved_clip_active
argument_list|,
name|saved_plane_mask
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|screen_clip_wind
operator|.
name|window_base
operator|.
name|x_coord
operator|=
literal|0
expr_stmt|;
name|screen_clip_wind
operator|.
name|window_base
operator|.
name|y_coord
operator|=
literal|0
expr_stmt|;
name|screen_clip_wind
operator|.
name|window_size
operator|.
name|x_size
operator|=
name|Screen
operator|.
name|width
expr_stmt|;
name|screen_clip_wind
operator|.
name|window_size
operator|.
name|y_size
operator|=
name|Screen
operator|.
name|height
expr_stmt|;
name|gpr_$set_clip_window
argument_list|(
name|screen_clip_wind
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|gpr_$set_plane_mask
argument_list|(
name|Screen
operator|.
name|plane_mask
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|msx
operator|=
name|ms
operator|->
name|x
operator|<
literal|0
condition|?
literal|0
else|:
name|ms
operator|->
name|x
expr_stmt|;
name|msy
operator|=
name|ms
operator|->
name|y
operator|<
literal|0
condition|?
literal|0
else|:
name|ms
operator|->
name|y
expr_stmt|;
name|dstorg
operator|.
name|x_coord
operator|=
name|msx
expr_stmt|;
name|dstorg
operator|.
name|y_coord
operator|=
name|msy
expr_stmt|;
if|if
condition|(
name|cs
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|CursorDisplayed
operator|&&
operator|(
name|cs
operator|=
name|CurrentCursor
operator|)
operator|!=
name|NULL
condition|)
block|{
comment|/* take it out */
name|srcwin
operator|.
name|x_coord
operator|=
name|srcwin
operator|.
name|y_coord
operator|=
literal|0
expr_stmt|;
name|srcwin
operator|.
name|x_size
operator|=
name|cs
operator|->
name|width
expr_stmt|;
name|srcwin
operator|.
name|y_size
operator|=
name|cs
operator|->
name|height
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Screen
operator|.
name|depth
condition|;
name|i
operator|++
control|)
name|gpr_$set_raster_op
argument_list|(
operator|(
name|gpr_$plane_t
operator|)
name|i
argument_list|,
operator|(
name|gpr_$raster_op_t
operator|)
literal|3
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|gpr_$pixel_blt
argument_list|(
name|CDATA
argument_list|(
name|cs
argument_list|)
operator|->
name|save
operator|->
name|data
argument_list|,
name|srcwin
argument_list|,
name|dstorg
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|CursorDisplayed
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|int
name|botop
init|=
operator|(
name|CDATA
argument_list|(
name|cs
argument_list|)
operator|->
name|back
operator|==
literal|1
condition|?
literal|7
else|:
literal|4
operator|)
decl_stmt|;
name|int
name|topop
init|=
operator|(
name|CDATA
argument_list|(
name|cs
argument_list|)
operator|->
name|fore
operator|==
literal|1
condition|?
literal|7
else|:
literal|4
operator|)
decl_stmt|;
name|CursorDisplayed
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* save image beneath cursor */
name|srcwin
operator|.
name|x_size
operator|=
name|cs
operator|->
name|width
expr_stmt|;
name|srcwin
operator|.
name|y_size
operator|=
name|cs
operator|->
name|height
expr_stmt|;
name|srcwin
operator|.
name|x_coord
operator|=
name|msx
expr_stmt|;
name|srcwin
operator|.
name|y_coord
operator|=
name|msy
expr_stmt|;
name|destorg
operator|.
name|x_coord
operator|=
name|destorg
operator|.
name|y_coord
operator|=
literal|0
expr_stmt|;
name|gpr_$set_bitmap
argument_list|(
name|CDATA
argument_list|(
name|cs
argument_list|)
operator|->
name|save
operator|->
name|data
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/*  the following code is redundant         for (i=0; i<Screen.depth; i++)              gpr_$set_raster_op( (gpr_$plane_t)i, (gpr_$raster_op_t)3, status ); */
name|gpr_$pixel_blt
argument_list|(
name|Screen
operator|.
name|bm
argument_list|,
name|srcwin
argument_list|,
name|destorg
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|gpr_$set_bitmap
argument_list|(
name|Screen
operator|.
name|bm
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* display mask */
name|srcwin
operator|.
name|x_coord
operator|=
name|srcwin
operator|.
name|y_coord
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|CDATA
argument_list|(
name|cs
argument_list|)
operator|->
name|mask
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Screen
operator|.
name|depth
condition|;
name|i
operator|++
control|)
name|gpr_$set_raster_op
argument_list|(
operator|(
name|gpr_$plane_t
operator|)
name|i
argument_list|,
operator|(
name|gpr_$raster_op_t
operator|)
name|botop
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|gpr_$pixel_blt
argument_list|(
name|CDATA
argument_list|(
name|cs
argument_list|)
operator|->
name|mask
operator|->
name|data
argument_list|,
name|srcwin
argument_list|,
name|dstorg
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
comment|/* display cursor itself */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Screen
operator|.
name|depth
condition|;
name|i
operator|++
control|)
name|gpr_$set_raster_op
argument_list|(
operator|(
name|gpr_$plane_t
operator|)
name|i
argument_list|,
operator|(
name|gpr_$raster_op_t
operator|)
name|topop
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|gpr_$pixel_blt
argument_list|(
name|CDATA
argument_list|(
name|cs
argument_list|)
operator|->
name|bits
operator|->
name|data
argument_list|,
name|srcwin
argument_list|,
name|dstorg
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
comment|/*     gpr_$set_attribute_block( Screen.ab, status ); */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Screen
operator|.
name|depth
condition|;
name|i
operator|++
control|)
name|gpr_$set_raster_op
argument_list|(
operator|(
name|gpr_$plane_t
operator|)
name|i
argument_list|,
name|saved_rops
index|[
name|i
index|]
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|gpr_$set_clip_window
argument_list|(
name|saved_clip_wind
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|gpr_$set_plane_mask
argument_list|(
name|saved_plane_mask
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


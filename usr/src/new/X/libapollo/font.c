begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_font_c
init|=
literal|"$Header: font.c,v 10.1 86/11/29 13:52:01 jg Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_comment
comment|/*      Copyright 1986 by the University of Utah      Permission to use, copy, modify, and distribute this     software and its documentation for any purpose and without     fee is hereby granted, provided that the above copyright     notice appear in all copies and that both that copyright     notice and this permission notice appear in supporting     documentation, and that the name of the University of Utah     not be used in advertising or publicity pertaining to      distribution of the software without specific, written      prior permission. The University of Utah makes no     representations about the suitability of this software for     any purpose.  It is provided "as is" without express or     implied warranty.      */
end_comment

begin_comment
comment|/* font.c	Reads a font from a file and stores it on the workstation  *  *	GetFont		Takes a font name and stores it  *	FreeFont	Frees the storage taken by a font  *  */
end_comment

begin_comment
comment|/*  *	ToDo:  *		Use Sun fonts too  */
end_comment

begin_include
include|#
directive|include
file|"Xapollo.h"
end_include

begin_include
include|#
directive|include
file|"vssite.h"
end_include

begin_include
include|#
directive|include
file|"../libvs100/param.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|borrow_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Xalloc
argument_list|()
decl_stmt|,
modifier|*
name|strcpy
argument_list|()
decl_stmt|,
modifier|*
name|strcat
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|CHARPERFONT
value|256
end_define

begin_decl_stmt
specifier|static
name|short
name|ReverseBitsInByte
index|[
literal|256
index|]
init|=
block|{
literal|0x00
block|,
literal|0x80
block|,
literal|0x40
block|,
literal|0xc0
block|,
literal|0x20
block|,
literal|0xa0
block|,
literal|0x60
block|,
literal|0xe0
block|,
literal|0x10
block|,
literal|0x90
block|,
literal|0x50
block|,
literal|0xd0
block|,
literal|0x30
block|,
literal|0xb0
block|,
literal|0x70
block|,
literal|0xf0
block|,
literal|0x08
block|,
literal|0x88
block|,
literal|0x48
block|,
literal|0xc8
block|,
literal|0x28
block|,
literal|0xa8
block|,
literal|0x68
block|,
literal|0xe8
block|,
literal|0x18
block|,
literal|0x98
block|,
literal|0x58
block|,
literal|0xd8
block|,
literal|0x38
block|,
literal|0xb8
block|,
literal|0x78
block|,
literal|0xf8
block|,
literal|0x04
block|,
literal|0x84
block|,
literal|0x44
block|,
literal|0xc4
block|,
literal|0x24
block|,
literal|0xa4
block|,
literal|0x64
block|,
literal|0xe4
block|,
literal|0x14
block|,
literal|0x94
block|,
literal|0x54
block|,
literal|0xd4
block|,
literal|0x34
block|,
literal|0xb4
block|,
literal|0x74
block|,
literal|0xf4
block|,
literal|0x0c
block|,
literal|0x8c
block|,
literal|0x4c
block|,
literal|0xcc
block|,
literal|0x2c
block|,
literal|0xac
block|,
literal|0x6c
block|,
literal|0xec
block|,
literal|0x1c
block|,
literal|0x9c
block|,
literal|0x5c
block|,
literal|0xdc
block|,
literal|0x3c
block|,
literal|0xbc
block|,
literal|0x7c
block|,
literal|0xfc
block|,
literal|0x02
block|,
literal|0x82
block|,
literal|0x42
block|,
literal|0xc2
block|,
literal|0x22
block|,
literal|0xa2
block|,
literal|0x62
block|,
literal|0xe2
block|,
literal|0x12
block|,
literal|0x92
block|,
literal|0x52
block|,
literal|0xd2
block|,
literal|0x32
block|,
literal|0xb2
block|,
literal|0x72
block|,
literal|0xf2
block|,
literal|0x0a
block|,
literal|0x8a
block|,
literal|0x4a
block|,
literal|0xca
block|,
literal|0x2a
block|,
literal|0xaa
block|,
literal|0x6a
block|,
literal|0xea
block|,
literal|0x1a
block|,
literal|0x9a
block|,
literal|0x5a
block|,
literal|0xda
block|,
literal|0x3a
block|,
literal|0xba
block|,
literal|0x7a
block|,
literal|0xfa
block|,
literal|0x06
block|,
literal|0x86
block|,
literal|0x46
block|,
literal|0xc6
block|,
literal|0x26
block|,
literal|0xa6
block|,
literal|0x66
block|,
literal|0xe6
block|,
literal|0x16
block|,
literal|0x96
block|,
literal|0x56
block|,
literal|0xd6
block|,
literal|0x36
block|,
literal|0xb6
block|,
literal|0x76
block|,
literal|0xf6
block|,
literal|0x0e
block|,
literal|0x8e
block|,
literal|0x4e
block|,
literal|0xce
block|,
literal|0x2e
block|,
literal|0xae
block|,
literal|0x6e
block|,
literal|0xee
block|,
literal|0x1e
block|,
literal|0x9e
block|,
literal|0x5e
block|,
literal|0xde
block|,
literal|0x3e
block|,
literal|0xbe
block|,
literal|0x7e
block|,
literal|0xfe
block|,
literal|0x01
block|,
literal|0x81
block|,
literal|0x41
block|,
literal|0xc1
block|,
literal|0x21
block|,
literal|0xa1
block|,
literal|0x61
block|,
literal|0xe1
block|,
literal|0x11
block|,
literal|0x91
block|,
literal|0x51
block|,
literal|0xd1
block|,
literal|0x31
block|,
literal|0xb1
block|,
literal|0x71
block|,
literal|0xf1
block|,
literal|0x09
block|,
literal|0x89
block|,
literal|0x49
block|,
literal|0xc9
block|,
literal|0x29
block|,
literal|0xa9
block|,
literal|0x69
block|,
literal|0xe9
block|,
literal|0x19
block|,
literal|0x99
block|,
literal|0x59
block|,
literal|0xd9
block|,
literal|0x39
block|,
literal|0xb9
block|,
literal|0x79
block|,
literal|0xf9
block|,
literal|0x05
block|,
literal|0x85
block|,
literal|0x45
block|,
literal|0xc5
block|,
literal|0x25
block|,
literal|0xa5
block|,
literal|0x65
block|,
literal|0xe5
block|,
literal|0x15
block|,
literal|0x95
block|,
literal|0x55
block|,
literal|0xd5
block|,
literal|0x35
block|,
literal|0xb5
block|,
literal|0x75
block|,
literal|0xf5
block|,
literal|0x0d
block|,
literal|0x8d
block|,
literal|0x4d
block|,
literal|0xcd
block|,
literal|0x2d
block|,
literal|0xad
block|,
literal|0x6d
block|,
literal|0xed
block|,
literal|0x1d
block|,
literal|0x9d
block|,
literal|0x5d
block|,
literal|0xdd
block|,
literal|0x3d
block|,
literal|0xbd
block|,
literal|0x7d
block|,
literal|0xfd
block|,
literal|0x03
block|,
literal|0x83
block|,
literal|0x43
block|,
literal|0xc3
block|,
literal|0x23
block|,
literal|0xa3
block|,
literal|0x63
block|,
literal|0xe3
block|,
literal|0x13
block|,
literal|0x93
block|,
literal|0x53
block|,
literal|0xd3
block|,
literal|0x33
block|,
literal|0xb3
block|,
literal|0x73
block|,
literal|0xf3
block|,
literal|0x0b
block|,
literal|0x8b
block|,
literal|0x4b
block|,
literal|0xcb
block|,
literal|0x2b
block|,
literal|0xab
block|,
literal|0x6b
block|,
literal|0xeb
block|,
literal|0x1b
block|,
literal|0x9b
block|,
literal|0x5b
block|,
literal|0xdb
block|,
literal|0x3b
block|,
literal|0xbb
block|,
literal|0x7b
block|,
literal|0xfb
block|,
literal|0x07
block|,
literal|0x87
block|,
literal|0x47
block|,
literal|0xc7
block|,
literal|0x27
block|,
literal|0xa7
block|,
literal|0x67
block|,
literal|0xe7
block|,
literal|0x17
block|,
literal|0x97
block|,
literal|0x57
block|,
literal|0xd7
block|,
literal|0x37
block|,
literal|0xb7
block|,
literal|0x77
block|,
literal|0xf7
block|,
literal|0x0f
block|,
literal|0x8f
block|,
literal|0x4f
block|,
literal|0xcf
block|,
literal|0x2f
block|,
literal|0xaf
block|,
literal|0x6f
block|,
literal|0xef
block|,
literal|0x1f
block|,
literal|0x9f
block|,
literal|0x5f
block|,
literal|0xdf
block|,
literal|0x3f
block|,
literal|0xbf
block|,
literal|0x7f
block|,
literal|0xff
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ReverseBitsInShort
parameter_list|(
name|s
parameter_list|)
value|((ReverseBitsInByte[(s)&0xff]<<8)|ReverseBitsInByte[((s)>>8)&0xff])
end_define

begin_function
name|FONT
modifier|*
name|GetFont
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|char
name|fontname
index|[
literal|256
index|]
decl_stmt|;
name|int
name|fontfile
init|=
operator|-
literal|1
decl_stmt|;
name|FontData
name|font
decl_stmt|;
define|#
directive|define
name|chars
value|((BitMap *) font.f_characters)
name|int
name|fontsize
decl_stmt|,
name|leftsize
decl_stmt|,
name|width
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|fontarea
decl_stmt|;
specifier|register
name|short
modifier|*
name|leftarea
decl_stmt|,
modifier|*
name|leftarray
decl_stmt|;
specifier|register
name|FONT
modifier|*
name|fd
decl_stmt|;
specifier|register
name|FontPriv
modifier|*
name|fpriv
decl_stmt|;
name|int
name|tablesize
init|=
operator|(
name|CHARPERFONT
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
decl_stmt|;
specifier|extern
name|char
modifier|*
name|getenv
argument_list|()
decl_stmt|,
modifier|*
name|index
argument_list|()
decl_stmt|;
specifier|static
name|char
modifier|*
name|Fontpath
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|fontpath
decl_stmt|;
name|char
name|lname
index|[
literal|64
index|]
decl_stmt|;
name|int
name|namelen
decl_stmt|;
name|strcpy
argument_list|(
name|lname
argument_list|,
name|DEFAULT_APOLLO_FONT_PATH
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|lname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|fontfile
operator|=
name|access
argument_list|(
name|lname
argument_list|,
name|F_OK
argument_list|)
expr_stmt|;
if|if
condition|(
name|fontfile
operator|==
literal|0
condition|)
block|{
name|short
name|fid
decl_stmt|;
name|gpr_$offset_t
name|size
decl_stmt|;
name|status_$t
name|status
decl_stmt|;
name|fd
operator|=
operator|(
name|FONT
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FONT
argument_list|)
argument_list|)
expr_stmt|;
name|fd
operator|->
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|Xalloc
argument_list|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|fd
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|fpriv
operator|=
operator|(
name|FontPriv
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FontPriv
argument_list|)
argument_list|)
expr_stmt|;
name|fd
operator|->
name|fixed
operator|=
literal|1
expr_stmt|;
name|fd
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|fpriv
expr_stmt|;
name|fpriv
operator|->
name|widths
operator|=
name|NULL
expr_stmt|;
name|fpriv
operator|->
name|leftarray
operator|=
name|NULL
expr_stmt|;
name|namelen
operator|=
name|strlen
argument_list|(
name|lname
argument_list|)
expr_stmt|;
name|gpr_$load_font_file
argument_list|(
operator|*
name|lname
argument_list|,
operator|(
name|short
operator|)
name|namelen
argument_list|,
operator|(
name|short
operator|)
name|fid
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|check_status
argument_list|(
name|status
argument_list|,
literal|"Getfont"
argument_list|)
expr_stmt|;
name|gpr_$set_text_font
argument_list|(
name|fid
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|gpr_$inq_text_extent
argument_list|(
literal|"W"
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|fd
operator|->
name|height
operator|=
name|size
operator|.
name|y_size
expr_stmt|;
name|fd
operator|->
name|avg_width
operator|=
name|size
operator|.
name|x_size
expr_stmt|;
name|fpriv
operator|->
name|maxwidth
operator|=
name|size
operator|.
name|x_size
expr_stmt|;
name|fd
operator|->
name|first
operator|=
literal|'\0'
expr_stmt|;
name|fd
operator|->
name|last
operator|=
literal|'\177'
expr_stmt|;
name|fd
operator|->
name|base
operator|=
literal|0
expr_stmt|;
name|fd
operator|->
name|space
operator|=
literal|0
expr_stmt|;
name|fd
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|fpriv
operator|->
name|ap_font_id
operator|=
name|fid
expr_stmt|;
name|fpriv
operator|->
name|ap_font
operator|=
name|true
expr_stmt|;
comment|/*  Now load inverse version of font  */
name|strcat
argument_list|(
name|lname
argument_list|,
literal|".i"
argument_list|)
expr_stmt|;
name|namelen
operator|=
name|strlen
argument_list|(
name|lname
argument_list|)
expr_stmt|;
name|gpr_$load_font_file
argument_list|(
operator|*
name|lname
argument_list|,
operator|(
name|short
operator|)
name|namelen
argument_list|,
operator|(
name|short
operator|)
name|fid
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|check_status
argument_list|(
name|status
argument_list|,
literal|"GetFont: "
argument_list|)
expr_stmt|;
name|fpriv
operator|->
name|ap_font_id_inv
operator|=
name|fid
expr_stmt|;
if|if
condition|(
operator|!
name|borrow_flag
condition|)
block|{
name|fpriv
operator|->
name|ap_font_id_inv
operator|=
name|fpriv
operator|->
name|ap_font_id
expr_stmt|;
name|fpriv
operator|->
name|ap_font_id
operator|=
name|fid
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|Fontpath
condition|)
block|{
name|char
modifier|*
name|temp
init|=
name|getenv
argument_list|(
literal|"XFONTPATH"
argument_list|)
decl_stmt|;
if|if
condition|(
name|temp
condition|)
block|{
name|Fontpath
operator|=
name|Xalloc
argument_list|(
name|strlen
argument_list|(
name|temp
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|Fontpath
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|fontpath
operator|=
name|Fontpath
operator|)
operator|==
name|NULL
condition|)
name|fontpath
operator|=
name|DEFAULT_FONT_PATH
expr_stmt|;
name|fontfile
operator|=
name|open
argument_list|(
name|name
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|fontfile
operator|<
literal|0
condition|)
block|{
name|char
modifier|*
name|fend
decl_stmt|;
if|if
condition|(
operator|(
name|fend
operator|=
name|index
argument_list|(
name|fontpath
argument_list|,
literal|':'
argument_list|)
operator|)
operator|!=
literal|0
condition|)
operator|*
name|fend
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|fontpath
operator|==
literal|'\0'
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|fontpath
operator|==
literal|'~'
condition|)
block|{
comment|/* XXX - should implement ~foobar as well */
name|strcpy
argument_list|(
name|fontname
argument_list|,
name|getenv
argument_list|(
literal|"HOME"
argument_list|)
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|fontname
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|fontpath
operator|++
expr_stmt|;
block|}
else|else
operator|*
name|fontname
operator|=
literal|'\0'
expr_stmt|;
name|strcat
argument_list|(
name|fontname
argument_list|,
name|fontpath
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|fontname
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|fontname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|fontname
argument_list|,
name|DEFAULT_FONT_SUFFIX
argument_list|)
expr_stmt|;
name|fontfile
operator|=
name|open
argument_list|(
name|fontname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fend
condition|)
block|{
operator|*
name|fend
operator|=
literal|':'
expr_stmt|;
name|fontpath
operator|=
operator|++
name|fend
expr_stmt|;
block|}
else|else
break|break;
block|}
if|if
condition|(
name|read
argument_list|(
name|fontfile
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|font
argument_list|,
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|Swap_shorts
argument_list|(
operator|(
name|short
operator|*
operator|)
operator|&
name|font
argument_list|,
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|fontsize
operator|=
name|BitmapSize
argument_list|(
name|chars
operator|->
name|bm_width
argument_list|,
name|chars
operator|->
name|bm_height
argument_list|)
expr_stmt|;
name|fontarea
operator|=
operator|(
name|char
operator|*
operator|)
name|Xalloc
argument_list|(
name|fontsize
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|fontarea
argument_list|,
name|fontsize
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|fontfile
argument_list|,
operator|(
name|long
operator|)
name|font
operator|.
name|f_characters
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fontfile
argument_list|,
name|fontarea
argument_list|,
name|fontsize
argument_list|)
operator|!=
name|fontsize
condition|)
block|{
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|Swap_shorts
argument_list|(
operator|(
name|short
operator|*
operator|)
name|fontarea
argument_list|,
name|fontsize
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|leftarea
operator|=
operator|(
name|short
operator|*
operator|)
name|Xalloc
argument_list|(
name|tablesize
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|leftarea
argument_list|,
name|tablesize
argument_list|)
expr_stmt|;
name|leftarray
operator|=
operator|(
name|short
operator|*
operator|)
name|Xalloc
argument_list|(
name|tablesize
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|.
name|f_fixedWidth
operator|==
literal|0
condition|)
block|{
name|leftsize
operator|=
operator|(
name|font
operator|.
name|f_lastChar
operator|-
name|font
operator|.
name|f_firstChar
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|fontfile
argument_list|,
operator|(
name|long
operator|)
name|font
operator|.
name|f_leftArray
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fontfile
argument_list|,
operator|&
name|leftarea
index|[
name|font
operator|.
name|f_firstChar
index|]
argument_list|,
name|leftsize
argument_list|)
operator|!=
name|leftsize
condition|)
block|{
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarea
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarray
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|Swap_shorts
argument_list|(
operator|(
operator|(
name|short
operator|*
operator|)
operator|&
name|leftarea
index|[
name|font
operator|.
name|f_firstChar
index|]
operator|)
argument_list|,
name|leftsize
operator|>>
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* if fixed width font, generate leftarray for use later */
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|font
operator|.
name|f_firstChar
init|;
name|i
operator|<=
name|font
operator|.
name|f_lastChar
operator|+
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|leftarea
index|[
name|i
index|]
operator|=
name|j
expr_stmt|;
name|j
operator|+=
name|font
operator|.
name|f_fixedWidth
expr_stmt|;
block|}
block|}
name|bcopy
argument_list|(
name|leftarea
argument_list|,
name|leftarray
argument_list|,
name|tablesize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
comment|/*      *  set up font data structures      */
name|fd
operator|=
operator|(
name|FONT
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FONT
argument_list|)
argument_list|)
expr_stmt|;
name|fd
operator|->
name|height
operator|=
name|chars
operator|->
name|bm_height
expr_stmt|;
name|fd
operator|->
name|first
operator|=
name|font
operator|.
name|f_firstChar
expr_stmt|;
name|fd
operator|->
name|last
operator|=
name|font
operator|.
name|f_lastChar
expr_stmt|;
name|fd
operator|->
name|base
operator|=
name|font
operator|.
name|f_baseline
expr_stmt|;
name|fd
operator|->
name|space
operator|=
name|font
operator|.
name|f_spaceIndex
expr_stmt|;
name|fd
operator|->
name|space
operator|+=
name|fd
operator|->
name|first
expr_stmt|;
name|fd
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|fd
operator|->
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|Xalloc
argument_list|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|fd
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
comment|/*      * set up the private font structure      */
name|fpriv
operator|=
operator|(
name|FontPriv
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FontPriv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|->
name|avg_width
operator|=
name|font
operator|.
name|f_fixedWidth
condition|)
block|{
name|fd
operator|->
name|fixed
operator|=
literal|1
expr_stmt|;
name|fpriv
operator|->
name|maxwidth
operator|=
name|fd
operator|->
name|avg_width
expr_stmt|;
block|}
else|else
name|fd
operator|->
name|fixed
operator|=
literal|0
expr_stmt|;
name|fd
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|fpriv
expr_stmt|;
name|fpriv
operator|->
name|widths
operator|=
name|leftarea
expr_stmt|;
name|fpriv
operator|->
name|leftarray
operator|=
name|leftarray
expr_stmt|;
name|fpriv
operator|->
name|maxwidth
operator|=
literal|0
expr_stmt|;
comment|/*  of course... the bits are all switched...  */
block|{
specifier|register
name|short
modifier|*
name|sh
init|=
operator|(
name|short
operator|*
operator|)
name|fontarea
decl_stmt|;
specifier|register
name|short
name|limit
init|=
operator|(
operator|(
name|chars
operator|->
name|bm_width
operator|+
literal|15
operator|)
operator|>>
literal|4
operator|)
operator|*
name|chars
operator|->
name|bm_height
decl_stmt|;
do|do
operator|*
name|sh
operator|=
name|ReverseBitsInShort
argument_list|(
operator|*
name|sh
argument_list|)
operator|,
name|sh
operator|++
expr_stmt|;
do|while
condition|(
operator|--
name|limit
operator|!=
operator|-
literal|1
condition|)
do|;
block|}
comment|/* convert the leftarray to the width table */
for|for
control|(
name|i
operator|=
name|fd
operator|->
name|first
init|;
name|i
operator|<=
name|fd
operator|->
name|last
condition|;
name|i
operator|++
control|)
block|{
name|width
operator|=
name|fpriv
operator|->
name|leftarray
index|[
name|i
operator|+
literal|1
index|]
operator|-
name|fpriv
operator|->
name|leftarray
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|width
operator|>
name|fpriv
operator|->
name|maxwidth
condition|)
name|fpriv
operator|->
name|maxwidth
operator|=
name|width
expr_stmt|;
if|if
condition|(
name|width
operator|<
literal|0
condition|)
block|{
name|width
operator|=
literal|0
expr_stmt|;
comment|/* font sanity check */
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|fpriv
operator|->
name|widths
index|[
name|i
index|]
operator|=
name|width
expr_stmt|;
block|}
name|fd
operator|->
name|avg_width
operator|=
operator|(
operator|(
name|fpriv
operator|->
name|leftarray
index|[
name|fd
operator|->
name|last
index|]
operator|-
name|fpriv
operator|->
name|leftarray
index|[
name|fd
operator|->
name|first
index|]
operator|)
operator|/
operator|(
name|fd
operator|->
name|last
operator|-
name|fd
operator|->
name|first
operator|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|fpriv
operator|->
name|strike
operator|=
name|make_bitmap
argument_list|(
name|fontarea
argument_list|,
name|chars
operator|->
name|bm_width
argument_list|,
name|chars
operator|->
name|bm_height
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarea
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarray
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|fpriv
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/*    make_fontmap(fd); */
comment|/*  XXX free fontarea */
undef|#
directive|undef
name|chars
block|}
return|return
operator|(
name|fd
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|FreeFont
argument_list|(
name|font
argument_list|)
specifier|register
name|FONT
operator|*
name|font
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|FontPriv
modifier|*
name|fp
decl_stmt|;
name|status_$t
name|status
decl_stmt|;
name|fp
operator|=
operator|(
name|FontPriv
operator|*
operator|)
name|font
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|ap_font
condition|)
name|gpr_$unload_font_file
argument_list|(
operator|(
name|short
operator|)
name|fp
operator|->
name|ap_font_id
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|font
operator|->
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|font
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|font
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


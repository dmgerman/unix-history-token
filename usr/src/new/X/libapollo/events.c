begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*      Copyright 1986 by the University of Utah      Permission to use, copy, modify, and distribute this     software and its documentation for any purpose and without     fee is hereby granted, provided that the above copyright     notice appear in all copies and that both that copyright     notice and this permission notice appear in supporting     documentation, and that the name of the University of Utah     not be used in advertising or publicity pertaining to      distribution of the software without specific, written      prior permission. The University of Utah makes no     representations about the suitability of this software for     any purpose.  It is provided "as is" without express or     implied warranty.      */
end_comment

begin_comment
comment|/*      Copyright (C) 1986, Leonard N. Zubkoff   All Rights Reserved	     */
end_comment

begin_comment
comment|/*  *	ToDo:  *		Up events  *		Shiftlock support  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_define
define|#
directive|define
name|do
end_define

begin_define
define|#
directive|define
name|hidden
value|static
end_define

begin_define
define|#
directive|define
name|visible
end_define

begin_define
define|#
directive|define
name|procedure
value|void
end_define

begin_include
include|#
directive|include
file|"Xapollo.h"
end_include

begin_include
include|#
directive|include
file|"/sys/ins/ios.ins.c"
end_include

begin_include
include|#
directive|include
file|"/sys/ins/io_traits.ins.c"
end_include

begin_include
include|#
directive|include
file|"/sys/ins/trait.ins.c"
end_include

begin_include
include|#
directive|include
file|"/sys/ins/kbd.ins.c"
end_include

begin_include
include|#
directive|include
file|"/sys/ins/smdu.ins.c"
end_include

begin_include
include|#
directive|include
file|"/sys/ins/tone.ins.c"
end_include

begin_include
include|#
directive|include
file|"/sys/ins/ec2.ins.c"
end_include

begin_comment
comment|/* Should be qevent.h */
end_comment

begin_define
define|#
directive|define
name|VSE_LEFT_BUTTON
value|0
end_define

begin_define
define|#
directive|define
name|VSE_MIDDLE_BUTTON
value|1
end_define

begin_define
define|#
directive|define
name|VSE_RIGHT_BUTTON
value|2
end_define

begin_define
define|#
directive|define
name|ShiftKeyCode
value|0256
end_define

begin_define
define|#
directive|define
name|ControlKeyCode
value|0257
end_define

begin_define
define|#
directive|define
name|LockKeyCode
value|0260
end_define

begin_define
define|#
directive|define
name|MetaKeyCode
value|0261
end_define

begin_define
define|#
directive|define
name|SETSIZE
value|(short)256
end_define

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|state_mask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|DEVICE
modifier|*
name|CurrentDevice
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|borrow_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vsEvent
name|xes
decl_stmt|,
modifier|*
name|xe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|status_$t
name|stp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ec2_$ptr_t
name|ecs
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|ec_vlist
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|gpr_$keyset_t
name|KeySet
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|not_in_window
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|gpr_$event_t
name|EventType
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|EventData
index|[
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|gpr_$position_t
name|EventPosition
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|HavePreviewedData
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|gpr_io_get_calls
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|ec2_$ptr_t
name|GPREc
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|"lk201.h"
end_include

begin_macro
name|ProcessInput
argument_list|()
end_macro

begin_block
block|{ }
end_block

begin_comment
comment|/*    This should be replaced by a tabular implementation of some kind.   */
end_comment

begin_function
name|int
name|ApolloToXKey
parameter_list|(
name|c
parameter_list|)
name|unsigned
name|char
name|c
decl_stmt|;
block|{
specifier|register
name|int
name|ret
decl_stmt|;
name|state_mask
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
name|KBD_$R1
case|:
case|case
name|KBD_$R1U
case|:
return|return
operator|(
name|MetaKeyCode
operator|)
return|;
case|case
name|KBD_$LD
case|:
case|case
name|KBD_$LDU
case|:
return|return
operator|(
name|ControlKeyCode
operator|)
return|;
case|case
name|KBD_$LE
case|:
case|case
name|KBD_$LEU
case|:
return|return
operator|(
name|MetaKeyCode
operator|)
return|;
case|case
name|KBD_$LF
case|:
case|case
name|KBD_$LFU
case|:
return|return
operator|(
name|ShiftKeyCode
operator|)
return|;
case|case
name|KBD_$CR
case|:
name|c
operator|=
literal|'\015'
expr_stmt|;
break|break;
case|case
name|KBD_$BS
case|:
name|c
operator|=
literal|'\010'
expr_stmt|;
break|break;
case|case
name|KBD_$TAB
case|:
case|case
name|KBD_$STAB
case|:
case|case
name|KBD_$CTAB
case|:
name|c
operator|=
literal|'\011'
expr_stmt|;
break|break;
block|}
name|ret
operator|=
name|LK201
index|[
name|c
operator|&
literal|0177
index|]
expr_stmt|;
name|state_mask
operator|=
operator|(
name|state_mask
operator|&
operator|~
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator||
name|ShiftLockMask
operator|)
operator|)
operator||
operator|(
name|ret
operator|&
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator||
name|ShiftLockMask
operator|)
operator|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_macro
name|InputReader
argument_list|()
end_macro

begin_block
block|{
name|gpr_$event_t
name|prior_event
decl_stmt|;
name|int
name|i
decl_stmt|;
name|boolean
name|flag
decl_stmt|;
name|HavePreviewedData
operator|=
name|false
expr_stmt|;
name|prior_event
operator|=
name|gpr_$no_event
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|borrow_flag
condition|)
name|flag
operator|=
name|gpr_$acquire_display
argument_list|(
name|stp
argument_list|)
expr_stmt|;
comment|/* this needs to be replaced with a "real" timestamp */
name|xe
operator|->
name|vse_time
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|EventType
operator|!=
name|gpr_$no_event
condition|)
block|{
name|xe
operator|->
name|vse_x
operator|=
name|EventPosition
operator|.
name|x_coord
expr_stmt|;
name|xe
operator|->
name|vse_y
operator|=
name|EventPosition
operator|.
name|y_coord
expr_stmt|;
block|}
switch|switch
condition|(
name|EventType
condition|)
block|{
case|case
name|gpr_$no_event
case|:
if|if
condition|(
operator|(
name|prior_event
operator|==
name|gpr_$locator_stop
operator|)
operator|||
operator|(
name|prior_event
operator|==
name|gpr_$locator
operator|)
condition|)
block|{
name|Deal_with_movement
argument_list|(
name|xe
argument_list|)
expr_stmt|;
name|SetCursorPosition
argument_list|(
operator|(
name|vsCursor
operator|*
operator|)
name|xe
argument_list|)
expr_stmt|;
name|gpr_$set_cursor_position
argument_list|(
name|EventPosition
argument_list|,
name|stp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|borrow_flag
condition|)
name|gpr_$release_display
argument_list|(
name|stp
argument_list|)
expr_stmt|;
return|return;
case|case
name|gpr_$keystroke
case|:
name|SetCursorPosition
argument_list|(
operator|(
name|vsCursor
operator|*
operator|)
name|xe
argument_list|)
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_DKB
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
if|if
condition|(
operator|(
name|EventData
index|[
literal|0
index|]
operator|==
name|KBD_$R1U
operator|)
operator|||
operator|(
name|EventData
index|[
literal|0
index|]
operator|==
name|KBD_$LDU
operator|)
operator|||
operator|(
name|EventData
index|[
literal|0
index|]
operator|==
name|KBD_$LEU
operator|)
operator|||
operator|(
name|EventData
index|[
literal|0
index|]
operator|==
name|KBD_$LFU
operator|)
condition|)
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
else|else
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
name|xe
operator|->
name|vse_key
operator|=
name|ApolloToXKey
argument_list|(
name|EventData
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|handle_mask_down
argument_list|()
expr_stmt|;
name|Deal_with_input
argument_list|(
name|xe
argument_list|)
expr_stmt|;
name|handle_mask_up
argument_list|()
expr_stmt|;
break|break;
case|case
name|gpr_$buttons
case|:
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|SetCursorPosition
argument_list|(
operator|(
name|vsCursor
operator|*
operator|)
name|xe
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|EventData
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'a'
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_LEFT_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_MIDDLE_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_RIGHT_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_LEFT_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_MIDDLE_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_RIGHT_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
break|break;
block|}
name|Deal_with_input
argument_list|(
name|xe
argument_list|)
expr_stmt|;
break|break;
case|case
name|gpr_$left_window
case|:
name|gpr_$disable_input
argument_list|(
name|gpr_$buttons
argument_list|,
name|stp
argument_list|)
expr_stmt|;
name|gpr_$disable_input
argument_list|(
name|gpr_$keystroke
argument_list|,
name|stp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|borrow_flag
condition|)
name|gpr_$disable_input
argument_list|(
name|gpr_$left_window
argument_list|,
name|stp
argument_list|)
expr_stmt|;
name|gpr_$disable_input
argument_list|(
name|gpr_$locator_stop
argument_list|,
name|stp
argument_list|)
expr_stmt|;
name|gpr_$disable_input
argument_list|(
name|gpr_$locator
argument_list|,
name|stp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|borrow_flag
condition|)
name|gpr_$force_release
argument_list|(
name|i
argument_list|,
name|stp
argument_list|)
expr_stmt|;
break|break;
case|case
name|gpr_$entered_window
case|:
if|if
condition|(
operator|!
name|borrow_flag
condition|)
name|flag
operator|=
name|gpr_$acquire_display
argument_list|(
name|stp
argument_list|)
expr_stmt|;
name|gpr_$enable_input
argument_list|(
name|gpr_$buttons
argument_list|,
name|KeySet
argument_list|,
name|stp
argument_list|)
expr_stmt|;
name|gpr_$enable_input
argument_list|(
name|gpr_$keystroke
argument_list|,
name|KeySet
argument_list|,
name|stp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|borrow_flag
condition|)
block|{
name|gpr_$enable_input
argument_list|(
name|gpr_$left_window
argument_list|,
literal|0L
argument_list|,
name|stp
argument_list|)
expr_stmt|;
name|gpr_$enable_input
argument_list|(
name|gpr_$entered_window
argument_list|,
literal|0L
argument_list|,
name|stp
argument_list|)
expr_stmt|;
block|}
name|gpr_$enable_input
argument_list|(
name|gpr_$locator_stop
argument_list|,
literal|0L
argument_list|,
name|stp
argument_list|)
expr_stmt|;
name|gpr_$enable_input
argument_list|(
name|gpr_$locator
argument_list|,
literal|0L
argument_list|,
name|stp
argument_list|)
expr_stmt|;
break|break;
case|case
name|gpr_$locator
case|:
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_MMOTION
expr_stmt|;
break|break;
case|case
name|gpr_$locator_stop
case|:
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_MMOTION
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unrecognizable event--yecccch!!!!\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|prior_event
operator|=
name|EventType
expr_stmt|;
name|gpr_$cond_event_wait
argument_list|(
name|EventType
argument_list|,
name|EventData
index|[
literal|0
index|]
argument_list|,
name|EventPosition
argument_list|,
name|stp
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Turn off pseudo-shift/control keys  *  --destroys data field of event  */
end_comment

begin_macro
name|handle_mask_up
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|state_mask
operator|&
name|ControlMask
condition|)
block|{
name|xe
operator|->
name|vse_key
operator|=
name|ControlKeyCode
expr_stmt|;
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
name|Deal_with_input
argument_list|(
name|xe
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|state_mask
operator|&
name|ShiftMask
condition|)
block|{
name|xe
operator|->
name|vse_key
operator|=
name|ShiftKeyCode
expr_stmt|;
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
name|Deal_with_input
argument_list|(
name|xe
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/* Turn on pseudo-shift/control keys  *  --preserves data field of event  */
end_comment

begin_macro
name|handle_mask_down
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
name|data
decl_stmt|;
name|data
operator|=
name|xe
operator|->
name|vse_key
expr_stmt|;
if|if
condition|(
name|state_mask
operator|&
name|ControlMask
condition|)
block|{
name|xe
operator|->
name|vse_key
operator|=
name|ControlKeyCode
expr_stmt|;
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
name|Deal_with_input
argument_list|(
name|xe
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|state_mask
operator|&
name|ShiftMask
condition|)
block|{
name|xe
operator|->
name|vse_key
operator|=
name|ShiftKeyCode
expr_stmt|;
name|xe
operator|->
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
name|Deal_with_input
argument_list|(
name|xe
argument_list|)
expr_stmt|;
block|}
name|xe
operator|->
name|vse_key
operator|=
name|data
expr_stmt|;
block|}
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/* A rudimentary stream interface/type mgr for the keyboard and mouse  */
end_comment

begin_function
name|hidden
name|int
name|gpr_io_$get
parameter_list|(
name|hpp
parameter_list|,
name|optp
parameter_list|,
name|bp
parameter_list|,
name|buf_lenp
parameter_list|,
name|stp
parameter_list|)
name|char
modifier|*
modifier|*
name|hpp
decl_stmt|;
name|ios_$put_get_opts_t
modifier|*
name|optp
decl_stmt|;
name|char
modifier|*
name|bp
decl_stmt|;
name|long
modifier|*
name|buf_lenp
decl_stmt|;
name|status_$t
modifier|*
name|stp
decl_stmt|;
block|{
specifier|static
name|char
name|Buff
index|[
literal|10
index|]
decl_stmt|;
specifier|static
name|int
name|BuffLen
decl_stmt|;
specifier|static
name|boolean
name|HaveBuff
init|=
name|false
decl_stmt|;
name|boolean
name|NoWait
init|=
operator|(
operator|(
name|ios_$cond_opt
operator|&
operator|*
name|optp
operator|)
operator|!=
literal|0
operator|)
decl_stmt|;
name|boolean
name|Preview
init|=
operator|(
operator|(
name|ios_$preview_opt
operator|&
operator|*
name|optp
operator|)
operator|!=
literal|0
operator|)
decl_stmt|;
name|status_$t
name|Status
decl_stmt|;
name|boolean
name|flag
decl_stmt|;
if|if
condition|(
operator|!
name|Preview
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Gack!  Not preview in gpr_io_$get\n"
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|HavePreviewedData
condition|)
block|{
name|stp
operator|->
name|all
operator|=
name|status_$ok
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|HavePreviewedData
operator|=
name|false
expr_stmt|;
ifdef|#
directive|ifdef
name|PRE_SR9_5
if|if
condition|(
name|NoWait
condition|)
block|{
name|long
name|ECValue
init|=
operator|(
name|long
operator|)
name|ec2_$read
argument_list|(
operator|*
name|GPREc
argument_list|)
decl_stmt|;
specifier|static
name|long
name|PrevECValue
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|PrevECValue
operator|==
name|ECValue
condition|)
name|stp
operator|->
name|all
operator|=
name|ios_$get_conditional_failed
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|!
name|borrow_flag
condition|)
name|flag
operator|=
name|gpr_$acquire_display
argument_list|(
name|Status
argument_list|)
expr_stmt|;
name|gpr_$cond_event_wait
argument_list|(
name|EventType
argument_list|,
name|EventData
index|[
literal|0
index|]
argument_list|,
name|EventPosition
argument_list|,
operator|*
name|stp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|borrow_flag
condition|)
name|gpr_$release_display
argument_list|(
name|Status
argument_list|)
expr_stmt|;
if|if
condition|(
name|EventType
operator|==
name|gpr_$no_event
condition|)
block|{
name|stp
operator|->
name|all
operator|=
name|ios_$get_conditional_failed
expr_stmt|;
name|PrevECValue
operator|=
name|ECValue
expr_stmt|;
block|}
else|else
name|PrevECValue
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|borrow_flag
condition|)
name|flag
operator|=
name|gpr_$acquire_display
argument_list|(
name|Status
argument_list|)
expr_stmt|;
name|gpr_$event_wait
argument_list|(
name|EventType
argument_list|,
name|EventData
index|[
literal|0
index|]
argument_list|,
name|EventPosition
argument_list|,
operator|*
name|stp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|borrow_flag
condition|)
name|gpr_$release_display
argument_list|(
name|Status
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|NoWait
condition|)
block|{
name|gpr_$cond_event_wait
argument_list|(
name|EventType
argument_list|,
name|EventData
index|[
literal|0
index|]
argument_list|,
name|EventPosition
argument_list|,
operator|*
name|stp
argument_list|)
expr_stmt|;
if|if
condition|(
name|EventType
operator|==
name|gpr_$no_event
condition|)
name|stp
operator|->
name|all
operator|=
name|ios_$get_conditional_failed
expr_stmt|;
block|}
else|else
name|gpr_$event_wait
argument_list|(
name|EventType
argument_list|,
name|EventData
index|[
literal|0
index|]
argument_list|,
name|EventPosition
argument_list|,
operator|*
name|stp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|stp
operator|->
name|all
operator|!=
name|status_$ok
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|HavePreviewedData
operator|=
name|true
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|InitInput
parameter_list|()
block|{
name|boolean
name|flag
decl_stmt|;
name|short
name|i
decl_stmt|;
name|short
name|KeyClass
index|[
literal|256
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|255
condition|;
name|i
operator|++
control|)
do|do
name|KeyClass
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
do|KeyClass[KBD_$L_BOX_ARROW] = 1;     KeyClass[KBD_$L9] = 1;     KeyClass[KBD_$L9S] = 1;     KeyClass[KBD_$L9U] = 1;     KeyClass[KBD_$CMD] = 1;     lib_$init_set(KeySet
operator|,
do|256
block|)
function|;
end_function

begin_for
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
do|do
if|if
condition|(
name|KeyClass
index|[
name|i
index|]
operator|!=
literal|1
condition|)
name|lib_$add_to_set
argument_list|(
name|KeySet
argument_list|,
literal|256
argument_list|,
name|i
argument_list|)
expr_stmt|;
do|gpr_$enable_input(gpr_$keystroke
operator|,
do|KeySet
operator|,
do|stp
end_for

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_expr_stmt
name|gpr_$enable_input
argument_list|(
name|gpr_$buttons
argument_list|,
name|KeySet
argument_list|,
name|stp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|borrow_flag
condition|)
block|{
name|gpr_$enable_input
argument_list|(
name|gpr_$left_window
argument_list|,
literal|0L
argument_list|,
name|stp
argument_list|)
expr_stmt|;
name|gpr_$enable_input
argument_list|(
name|gpr_$entered_window
argument_list|,
literal|0L
argument_list|,
name|stp
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|gpr_$enable_input
argument_list|(
name|gpr_$locator_stop
argument_list|,
literal|0L
argument_list|,
name|stp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gpr_$enable_input
argument_list|(
name|gpr_$locator
argument_list|,
literal|0L
argument_list|,
name|stp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|smd_$set_quit_char
argument_list|(
operator|(
name|char
operator|)
name|KBD_$F8S
argument_list|,
name|stp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|check_status
argument_list|(
name|stp
argument_list|,
literal|"InitInput (Set quit char): "
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|xe
operator|=
operator|&
name|xes
expr_stmt|;
end_expr_stmt

begin_function
unit|}  hidden
name|boolean
name|gpr_io_$close
parameter_list|(
name|hpp
parameter_list|,
name|stp
parameter_list|)
name|char
modifier|*
modifier|*
name|hpp
decl_stmt|;
name|status_$t
modifier|*
name|stp
decl_stmt|;
block|{
name|stp
operator|->
name|all
operator|=
name|status_$ok
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

begin_function
name|hidden
name|ios_$conn_flag_set
name|gpr_io_$inq_conn_flags
parameter_list|(
name|hpp
parameter_list|,
name|stp
parameter_list|)
name|char
modifier|*
modifier|*
name|hpp
decl_stmt|;
name|status_$t
modifier|*
name|stp
decl_stmt|;
block|{
name|stp
operator|->
name|all
operator|=
name|status_$ok
expr_stmt|;
return|return
operator|(
name|ios_$cf_tty_mask
operator||
name|ios_$cf_vt_mask
operator|)
return|;
block|}
end_function

begin_function
name|hidden
name|procedure
name|gpr_io_$get_ec
parameter_list|(
name|hpp
parameter_list|,
name|keyp
parameter_list|,
name|ecpp
parameter_list|,
name|stp
parameter_list|)
name|char
modifier|*
modifier|*
name|hpp
decl_stmt|;
name|ios_$ec_key_t
modifier|*
name|keyp
decl_stmt|;
name|ec2_$ptr_t
modifier|*
name|ecpp
decl_stmt|;
name|status_$t
modifier|*
name|stp
decl_stmt|;
block|{
name|long
name|foo
decl_stmt|;
name|foo
operator|=
operator|(
name|long
operator|)
name|ec2_$read
argument_list|(
operator|*
name|GPREc
argument_list|)
expr_stmt|;
operator|*
name|ecpp
operator|=
name|GPREc
expr_stmt|;
name|stp
operator|->
name|all
operator|=
name|status_$ok
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PRE_SR9_5
end_ifdef

begin_decl_stmt
name|hidden
name|long
name|nilp
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|nilp
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|io_$epv
name|gpr_io_$epv
init|=
block|{
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|gpr_io_$close
block|,
name|gpr_io_$get_ec
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|gpr_io_$inq_conn_flags
block|,
name|nilp
block|,
name|gpr_io_$get
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|,
name|nilp
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|MakeGPRStream
parameter_list|()
block|{
name|status_$t
name|Status
decl_stmt|;
specifier|static
name|uid_$t
name|gpr_io_$uid
init|=
block|{
literal|0x2f3e1e7a
block|,
literal|0x10003166
block|}
decl_stmt|;
name|boolean
name|flag
decl_stmt|;
ifdef|#
directive|ifdef
name|PRE_SR9_5
name|flag
operator|=
name|gpr_$acquire_display
argument_list|(
name|stp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|gpr_$get_ec
argument_list|(
name|gpr_$input_ec
argument_list|,
name|GPREc
argument_list|,
name|Status
argument_list|)
expr_stmt|;
name|check_status
argument_list|(
name|Status
argument_list|,
literal|"MakeGPRStream"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PRE_SR9_5
name|gpr_$release_display
argument_list|(
name|stp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|trait_$mgr_dcl
argument_list|(
name|gpr_io_$uid
argument_list|,
name|io_$trait
argument_list|,
name|trait_$kind_local
argument_list|,
operator|&
name|gpr_io_$epv
argument_list|,
name|Status
argument_list|)
expr_stmt|;
return|return
operator|(
name|ios_$connect
argument_list|(
literal|""
argument_list|,
operator|(
name|short
operator|)
literal|0
argument_list|,
name|gpr_io_$uid
argument_list|,
operator|(
name|long
operator|)
literal|0
argument_list|,
operator|&
name|gpr_io_$epv
argument_list|,
name|Status
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*    Universally used; returns -1 if an status is abnormal/error  */
end_comment

begin_function
name|int
name|check_status
parameter_list|(
name|status
parameter_list|,
name|name
parameter_list|)
name|status_$t
name|status
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|{
if|if
condition|(
name|status
operator|.
name|all
operator|!=
name|status_$ok
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|error_$print
argument_list|(
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 The Regents of the University of California.  * All rights reserved.  *  * This software was developed by the Computer Systems Engineering group  * at Lawrence Berkeley Laboratory under DARPA contract BG 91-66 and  * contributed to Berkeley.  *  * All advertising materials mentioning features or use of this software  * must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Lawrence Berkeley Laboratory.  *  * %sccs.include.redist.c%  *  *	@(#)sun_disklabel.c	7.4 (Berkeley) %G%  *  * from: $Header: sun_disklabel.c,v 1.5 92/06/17 07:04:12 torek Exp $  */
end_comment

begin_comment
comment|/*  * SunOS disk label code.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/disklabel.h>
end_include

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_include
include|#
directive|include
file|<sys/disk.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sparc/sunos/sun_disklabel.h>
end_include

begin_comment
comment|/*  * Take a sector (cp) containing a SunOS disk label and set lp to a BSD  * disk label.  */
end_comment

begin_function
name|int
name|sun_disklabel
parameter_list|(
name|cp
parameter_list|,
name|lp
parameter_list|)
specifier|register
name|caddr_t
name|cp
decl_stmt|;
specifier|register
name|struct
name|disklabel
modifier|*
name|lp
decl_stmt|;
block|{
specifier|register
name|u_short
modifier|*
name|sp
decl_stmt|;
specifier|register
name|struct
name|sun_disklabel
modifier|*
name|sl
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|v
decl_stmt|;
name|sp
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|(
name|cp
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sun_disklabel
argument_list|)
operator|)
expr_stmt|;
operator|--
name|sp
expr_stmt|;
name|v
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|sp
operator|>=
operator|(
name|u_short
operator|*
operator|)
name|cp
condition|)
name|v
operator|^=
operator|*
name|sp
operator|--
expr_stmt|;
if|if
condition|(
name|v
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sl
operator|=
operator|(
expr|struct
name|sun_disklabel
operator|*
operator|)
name|cp
expr_stmt|;
name|lp
operator|->
name|d_magic
operator|=
literal|0
expr_stmt|;
comment|/* denote as pseudo */
name|lp
operator|->
name|d_ncylinders
operator|=
name|sl
operator|->
name|sl_ncylinders
expr_stmt|;
name|lp
operator|->
name|d_acylinders
operator|=
name|sl
operator|->
name|sl_acylinders
expr_stmt|;
name|v
operator|=
operator|(
name|lp
operator|->
name|d_ntracks
operator|=
name|sl
operator|->
name|sl_ntracks
operator|)
operator|*
operator|(
name|lp
operator|->
name|d_nsectors
operator|=
name|sl
operator|->
name|sl_nsectors
operator|)
expr_stmt|;
name|lp
operator|->
name|d_secpercyl
operator|=
name|v
expr_stmt|;
name|lp
operator|->
name|d_npartitions
operator|=
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|lp
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_offset
operator|=
name|sl
operator|->
name|sl_part
index|[
name|i
index|]
operator|.
name|sdkp_cyloffset
operator|*
name|v
expr_stmt|;
name|lp
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
operator|=
name|sl
operator|->
name|sl_part
index|[
name|i
index|]
operator|.
name|sdkp_nsectors
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|sun_dkioctl
parameter_list|(
name|dk
parameter_list|,
name|cmd
parameter_list|,
name|data
parameter_list|,
name|partition
parameter_list|)
name|struct
name|dkdevice
modifier|*
name|dk
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
name|int
name|partition
decl_stmt|;
block|{
specifier|register
name|struct
name|partition
modifier|*
name|p
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|DKIOCGGEOM
case|:
define|#
directive|define
name|geom
value|((struct sun_dkgeom *)data)
name|bzero
argument_list|(
name|data
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|geom
argument_list|)
argument_list|)
expr_stmt|;
name|geom
operator|->
name|sdkc_ncylinders
operator|=
name|dk
operator|->
name|dk_label
operator|.
name|d_ncylinders
expr_stmt|;
name|geom
operator|->
name|sdkc_acylinders
operator|=
name|dk
operator|->
name|dk_label
operator|.
name|d_acylinders
expr_stmt|;
name|geom
operator|->
name|sdkc_ntracks
operator|=
name|dk
operator|->
name|dk_label
operator|.
name|d_ntracks
expr_stmt|;
name|geom
operator|->
name|sdkc_nsectors
operator|=
name|dk
operator|->
name|dk_label
operator|.
name|d_nsectors
expr_stmt|;
name|geom
operator|->
name|sdkc_interleave
operator|=
name|dk
operator|->
name|dk_label
operator|.
name|d_interleave
expr_stmt|;
name|geom
operator|->
name|sdkc_sparespercyl
operator|=
name|dk
operator|->
name|dk_label
operator|.
name|d_sparespercyl
expr_stmt|;
name|geom
operator|->
name|sdkc_rpm
operator|=
name|dk
operator|->
name|dk_label
operator|.
name|d_rpm
expr_stmt|;
name|geom
operator|->
name|sdkc_pcylinders
operator|=
name|dk
operator|->
name|dk_label
operator|.
name|d_ncylinders
operator|+
name|dk
operator|->
name|dk_label
operator|.
name|d_acylinders
expr_stmt|;
undef|#
directive|undef
name|geom
break|break;
case|case
name|DKIOCINFO
case|:
comment|/* Homey don't do DKIOCINFO */
name|bzero
argument_list|(
name|data
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sun_dkctlr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DKIOCGPART
case|:
if|if
condition|(
name|dk
operator|->
name|dk_label
operator|.
name|d_secpercyl
operator|==
literal|0
condition|)
return|return
operator|(
name|ERANGE
operator|)
return|;
comment|/* XXX */
name|p
operator|=
operator|&
name|dk
operator|->
name|dk_label
operator|.
name|d_partitions
index|[
name|partition
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_offset
operator|%
name|dk
operator|->
name|dk_label
operator|.
name|d_secpercyl
operator|!=
literal|0
condition|)
return|return
operator|(
name|ERANGE
operator|)
return|;
comment|/* XXX */
define|#
directive|define
name|part
value|((struct sun_dkpart *)data)
name|part
operator|->
name|sdkp_cyloffset
operator|=
name|p
operator|->
name|p_offset
operator|/
name|dk
operator|->
name|dk_label
operator|.
name|d_secpercyl
expr_stmt|;
name|part
operator|->
name|sdkp_nsectors
operator|=
name|p
operator|->
name|p_size
expr_stmt|;
undef|#
directive|undef
name|part
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


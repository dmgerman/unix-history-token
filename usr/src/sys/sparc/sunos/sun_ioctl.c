begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 The Regents of the University of California.  * All rights reserved.  *  * This software was developed by the Computer Systems Engineering group  * at Lawrence Berkeley Laboratory under DARPA contract BG 91-66 and  * contributed to Berkeley.  *  * All advertising materials mentioning features or use of this software  * must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Lawrence Berkeley Laboratory.  *  * %sccs.include.redist.c%  *  *	@(#)sun_ioctl.c	7.5 (Berkeley) %G%  *  * from: $Header: sun_ioctl.c,v 1.7 93/05/28 04:40:43 torek Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/filedesc.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/termios.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_comment
comment|/*  * SunOS ioctl calls.  * This file is something of a hodge-podge.  * Support gets added as things turn up....  */
end_comment

begin_struct
struct|struct
name|sun_ttysize
block|{
name|int
name|ts_row
decl_stmt|;
name|int
name|ts_col
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sun_termio
block|{
name|u_short
name|c_iflag
decl_stmt|;
name|u_short
name|c_oflag
decl_stmt|;
name|u_short
name|c_cflag
decl_stmt|;
name|u_short
name|c_lflag
decl_stmt|;
name|char
name|c_line
decl_stmt|;
name|unsigned
name|char
name|c_cc
index|[
literal|8
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sun_ioctl_args
block|{
name|int
name|fd
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
name|sun_ioctl
argument_list|(
name|p
argument_list|,
name|uap
argument_list|,
name|retval
argument_list|)
specifier|register
expr|struct
name|proc
operator|*
name|p
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|sun_ioctl_args
modifier|*
name|uap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|retval
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|filedesc
modifier|*
name|fdp
init|=
name|p
operator|->
name|p_fd
decl_stmt|;
specifier|register
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
specifier|register
name|int
function_decl|(
modifier|*
name|ctl
function_decl|)
parameter_list|()
function_decl|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|unsigned
operator|)
name|uap
operator|->
name|fd
operator|>=
name|fdp
operator|->
name|fd_nfiles
operator|||
operator|(
name|fp
operator|=
name|fdp
operator|->
name|fd_ofiles
index|[
name|uap
operator|->
name|fd
index|]
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADF
operator|)
return|;
if|if
condition|(
operator|(
name|fp
operator|->
name|f_flag
operator|&
operator|(
name|FREAD
operator||
name|FWRITE
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|EBADF
operator|)
return|;
name|ctl
operator|=
name|fp
operator|->
name|f_ops
operator|->
name|fo_ioctl
expr_stmt|;
switch|switch
condition|(
name|uap
operator|->
name|cmd
condition|)
block|{
case|case
name|_IOR
argument_list|(
literal|'t'
argument_list|,
literal|0
argument_list|,
name|int
argument_list|)
case|:
name|uap
operator|->
name|cmd
operator|=
name|TIOCGETD
expr_stmt|;
break|break;
case|case
name|_IOW
argument_list|(
literal|'t'
argument_list|,
literal|1
argument_list|,
name|int
argument_list|)
case|:
name|uap
operator|->
name|cmd
operator|=
name|TIOCSETD
expr_stmt|;
break|break;
case|case
name|_IO
argument_list|(
literal|'t'
argument_list|,
literal|36
argument_list|)
case|:
block|{
comment|/* sun TIOCCONS, no parameters */
name|int
name|on
init|=
literal|1
decl_stmt|;
return|return
operator|(
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCCONS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|on
argument_list|,
name|p
argument_list|)
operator|)
return|;
block|}
case|case
name|_IOW
argument_list|(
literal|'t'
argument_list|,
literal|37
argument_list|,
expr|struct
name|sun_ttysize
argument_list|)
case|:
block|{
name|struct
name|winsize
name|ws
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCGWINSZ
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ws
argument_list|,
name|p
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ws
operator|.
name|ws_row
operator|=
operator|(
operator|(
expr|struct
name|sun_ttysize
operator|*
operator|)
name|uap
operator|->
name|data
operator|)
operator|->
name|ts_row
expr_stmt|;
name|ws
operator|.
name|ws_col
operator|=
operator|(
operator|(
expr|struct
name|sun_ttysize
operator|*
operator|)
name|uap
operator|->
name|data
operator|)
operator|->
name|ts_col
expr_stmt|;
return|return
operator|(
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCSWINSZ
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ws
argument_list|,
name|p
argument_list|)
operator|)
return|;
block|}
case|case
name|_IOW
argument_list|(
literal|'t'
argument_list|,
literal|38
argument_list|,
expr|struct
name|sun_ttysize
argument_list|)
case|:
block|{
name|struct
name|winsize
name|ws
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCGWINSZ
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ws
argument_list|,
name|p
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
operator|(
operator|(
expr|struct
name|sun_ttysize
operator|*
operator|)
name|uap
operator|->
name|data
operator|)
operator|->
name|ts_row
operator|=
name|ws
operator|.
name|ws_row
expr_stmt|;
operator|(
operator|(
expr|struct
name|sun_ttysize
operator|*
operator|)
name|uap
operator|->
name|data
operator|)
operator|->
name|ts_col
operator|=
name|ws
operator|.
name|ws_col
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|_IOR
argument_list|(
literal|'t'
argument_list|,
literal|130
argument_list|,
name|int
argument_list|)
case|:
name|uap
operator|->
name|cmd
operator|=
name|TIOCSPGRP
expr_stmt|;
break|break;
case|case
name|_IOR
argument_list|(
literal|'t'
argument_list|,
literal|131
argument_list|,
name|int
argument_list|)
case|:
name|uap
operator|->
name|cmd
operator|=
name|TIOCGPGRP
expr_stmt|;
break|break;
case|case
name|_IO
argument_list|(
literal|'t'
argument_list|,
literal|132
argument_list|)
case|:
name|uap
operator|->
name|cmd
operator|=
name|TIOCSCTTY
expr_stmt|;
break|break;
case|case
name|_IOR
argument_list|(
literal|'T'
argument_list|,
literal|1
argument_list|,
expr|struct
name|sun_termio
argument_list|)
case|:
block|{
name|struct
name|termios
name|bt
decl_stmt|;
name|struct
name|sun_termio
name|st
decl_stmt|;
name|int
name|speed
decl_stmt|;
specifier|static
name|struct
name|speedtab
name|sptab
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|50
block|,
literal|1
block|}
block|,
block|{
literal|75
block|,
literal|2
block|}
block|,
block|{
literal|110
block|,
literal|3
block|}
block|,
block|{
literal|134
block|,
literal|4
block|}
block|,
block|{
literal|135
block|,
literal|4
block|}
block|,
block|{
literal|150
block|,
literal|5
block|}
block|,
block|{
literal|200
block|,
literal|6
block|}
block|,
block|{
literal|300
block|,
literal|7
block|}
block|,
block|{
literal|600
block|,
literal|8
block|}
block|,
block|{
literal|1200
block|,
literal|9
block|}
block|,
block|{
literal|1800
block|,
literal|10
block|}
block|,
block|{
literal|2400
block|,
literal|11
block|}
block|,
block|{
literal|4800
block|,
literal|12
block|}
block|,
block|{
literal|9600
block|,
literal|13
block|}
block|,
block|{
literal|19200
block|,
literal|14
block|}
block|,
block|{
literal|38400
block|,
literal|15
block|}
block|,
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCGETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bt
argument_list|,
name|p
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* most bits match */
name|st
operator|.
name|c_iflag
operator|=
name|bt
operator|.
name|c_iflag
operator|&
operator|(
name|IGNBRK
operator||
name|BRKINT
operator||
name|IGNPAR
operator||
name|PARMRK
operator||
name|INPCK
operator||
name|ISTRIP
operator||
name|INLCR
operator||
name|IGNCR
operator||
name|ICRNL
operator||
name|IXANY
operator||
name|IMAXBEL
operator|)
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_iflag
operator|&
name|IXON
condition|)
name|st
operator|.
name|c_iflag
operator||=
literal|0x0400
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_iflag
operator|&
name|IXOFF
condition|)
name|st
operator|.
name|c_iflag
operator||=
literal|0x1000
expr_stmt|;
name|st
operator|.
name|c_oflag
operator|=
name|bt
operator|.
name|c_oflag
operator|&
name|OPOST
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_oflag
operator|&
name|ONLCR
condition|)
name|st
operator|.
name|c_oflag
operator||=
literal|0x0004
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_oflag
operator|&
name|OXTABS
condition|)
name|st
operator|.
name|c_oflag
operator||=
literal|0x1800
expr_stmt|;
name|speed
operator|=
name|ttspeedtab
argument_list|(
name|bt
operator|.
name|c_ospeed
argument_list|,
name|sptab
argument_list|)
expr_stmt|;
name|st
operator|.
name|c_cflag
operator|=
name|speed
operator|>=
literal|0
condition|?
name|speed
else|:
literal|0
expr_stmt|;
name|st
operator|.
name|c_cflag
operator||=
operator|(
name|bt
operator|.
name|c_cflag
operator|&
name|CSIZE
operator|)
operator|>>
literal|4
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_cflag
operator|&
name|CSTOPB
condition|)
name|st
operator|.
name|c_cflag
operator||=
literal|0x40
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_cflag
operator|&
name|PARENB
condition|)
name|st
operator|.
name|c_cflag
operator||=
literal|0x100
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_cflag
operator|&
name|PARODD
condition|)
name|st
operator|.
name|c_cflag
operator||=
literal|0x200
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_cflag
operator|&
name|HUPCL
condition|)
name|st
operator|.
name|c_cflag
operator||=
literal|0x400
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_cflag
operator|&
name|CLOCAL
condition|)
name|st
operator|.
name|c_cflag
operator||=
literal|0x800
expr_stmt|;
name|st
operator|.
name|c_lflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_lflag
operator|&
operator|(
name|ECHOKE
operator||
name|ECHOE
operator||
name|ECHOK
operator|)
condition|)
name|st
operator|.
name|c_lflag
operator||=
literal|0x0800
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_lflag
operator|&
name|ECHO
condition|)
name|st
operator|.
name|c_lflag
operator||=
literal|0x0008
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_lflag
operator|&
name|ECHONL
condition|)
name|st
operator|.
name|c_lflag
operator||=
literal|0x0040
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_lflag
operator|&
name|ECHOPRT
condition|)
name|st
operator|.
name|c_lflag
operator||=
literal|0x0400
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_lflag
operator|&
name|ECHOCTL
condition|)
name|st
operator|.
name|c_lflag
operator||=
literal|0x0200
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_lflag
operator|&
name|ISIG
condition|)
name|st
operator|.
name|c_lflag
operator||=
literal|0x0001
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_lflag
operator|&
name|ICANON
condition|)
name|st
operator|.
name|c_lflag
operator||=
literal|0x0002
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_lflag
operator|&
name|IEXTEN
condition|)
name|st
operator|.
name|c_lflag
operator||=
literal|0x8000
expr_stmt|;
if|if
condition|(
name|bt
operator|.
name|c_lflag
operator|&
name|NOFLSH
condition|)
name|st
operator|.
name|c_lflag
operator||=
literal|0x0080
expr_stmt|;
define|#
directive|define
name|mapcc
parameter_list|(
name|x
parameter_list|)
value|((x) == _POSIX_VDISABLE ? 0 : (x))
name|st
operator|.
name|c_cc
index|[
literal|0
index|]
operator|=
name|mapcc
argument_list|(
name|bt
operator|.
name|c_cc
index|[
name|VINTR
index|]
argument_list|)
expr_stmt|;
name|st
operator|.
name|c_cc
index|[
literal|1
index|]
operator|=
name|mapcc
argument_list|(
name|bt
operator|.
name|c_cc
index|[
name|VQUIT
index|]
argument_list|)
expr_stmt|;
name|st
operator|.
name|c_cc
index|[
literal|2
index|]
operator|=
name|mapcc
argument_list|(
name|bt
operator|.
name|c_cc
index|[
name|VERASE
index|]
argument_list|)
expr_stmt|;
name|st
operator|.
name|c_cc
index|[
literal|3
index|]
operator|=
name|mapcc
argument_list|(
name|bt
operator|.
name|c_cc
index|[
name|VKILL
index|]
argument_list|)
expr_stmt|;
name|st
operator|.
name|c_cc
index|[
literal|4
index|]
operator|=
name|mapcc
argument_list|(
name|bt
operator|.
name|c_cc
index|[
name|VEOF
index|]
argument_list|)
expr_stmt|;
name|st
operator|.
name|c_cc
index|[
literal|5
index|]
operator|=
name|mapcc
argument_list|(
name|bt
operator|.
name|c_cc
index|[
name|VEOL
index|]
argument_list|)
expr_stmt|;
name|st
operator|.
name|c_cc
index|[
literal|6
index|]
operator|=
name|mapcc
argument_list|(
name|bt
operator|.
name|c_cc
index|[
name|VEOL2
index|]
argument_list|)
expr_stmt|;
name|st
operator|.
name|c_cc
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|st
argument_list|,
name|uap
operator|->
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|st
argument_list|)
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ioctl
argument_list|(
name|p
argument_list|,
name|uap
argument_list|,
name|retval
argument_list|)
operator|)
return|;
block|}
end_block

end_unit


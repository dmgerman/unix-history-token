begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1991 The Regents of the University of California.  * All rights reserved.  *  * This software was developed by the Computer Systems Engineering group  * at Lawrence Berkeley Laboratory under DARPA contract BG 91-66 and  * contributed to Berkeley.  *  * All advertising materials mentioning features or use of this software  * must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Lawrence Berkeley Laboratory.  *  * %sccs.include.redist.c%  *  *	@(#)rcons_subr.c	7.4 (Berkeley) %G%  *  * from: $Header: rcons_subr.c,v 1.38 93/04/20 11:15:39 torek Exp $  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|KERNEL
end_ifdef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/fbio.h>
end_include

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_include
include|#
directive|include
file|<machine/fbvar.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"myfbdevice.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sparc/rcons/raster.h>
end_include

begin_function_decl
name|void
name|rcons_text
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_pctrl
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_esc
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_doesc
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_cursor
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_invert
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_clear2eop
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_clear2eol
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_scroll
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_delchar
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_delline
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_insertchar
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|rcons_insertline
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|rcons_bell
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|RCONS_ISPRINT
parameter_list|(
name|c
parameter_list|)
value|((c)>= ' '&& (c)<= '~')
end_define

begin_define
define|#
directive|define
name|RCONS_ISDIGIT
parameter_list|(
name|c
parameter_list|)
value|((c)>= '0'&& (c)<= '9')
end_define

begin_comment
comment|/* Output (or at least handle) a string sent to the console */
end_comment

begin_function
name|void
name|rcons_puts
parameter_list|(
name|fb
parameter_list|,
name|str
parameter_list|,
name|n
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
specifier|register
name|char
modifier|*
name|str
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
comment|/* Jump scroll */
comment|/* XXX maybe this should be an option? */
if|if
condition|(
operator|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_INESC
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Count newlines up to an escape sequence */
name|i
operator|=
literal|0
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|str
init|;
name|j
operator|++
operator|<
name|n
operator|&&
operator|*
name|cp
operator|!=
literal|'\033'
condition|;
operator|++
name|cp
control|)
block|{
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\n'
condition|)
operator|++
name|i
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\013'
condition|)
operator|--
name|i
expr_stmt|;
block|}
comment|/* Only jump scroll two or more rows */
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_row
operator|+
name|i
operator|>=
name|fb
operator|->
name|fb_maxrow
operator|+
literal|1
condition|)
block|{
comment|/* Erase the cursor (if necessary) */
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_CURSOR
condition|)
name|rcons_cursor
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|rcons_scroll
argument_list|(
name|fb
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Process characters */
while|while
condition|(
operator|--
name|n
operator|>=
literal|0
condition|)
block|{
name|c
operator|=
operator|*
name|str
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\033'
condition|)
block|{
comment|/* Start an escape (perhaps aborting one in progress) */
name|fb
operator|->
name|fb_bits
operator||=
name|FB_INESC
operator||
name|FB_P0_DEFAULT
operator||
name|FB_P1_DEFAULT
expr_stmt|;
name|fb
operator|->
name|fb_bits
operator|&=
operator|~
operator|(
name|FB_P0
operator||
name|FB_P1
operator|)
expr_stmt|;
comment|/* Most parameters default to 1 */
name|fb
operator|->
name|fb_p0
operator|=
name|fb
operator|->
name|fb_p1
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_INESC
condition|)
block|{
name|rcons_esc
argument_list|(
name|fb
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Erase the cursor (if necessary) */
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_CURSOR
condition|)
name|rcons_cursor
argument_list|(
name|fb
argument_list|)
expr_stmt|;
comment|/* Display the character */
if|if
condition|(
name|RCONS_ISPRINT
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* Try to output as much as possible */
name|j
operator|=
name|fb
operator|->
name|fb_maxcol
operator|-
operator|(
operator|*
name|fb
operator|->
name|fb_col
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|j
operator|>
name|n
condition|)
name|j
operator|=
name|n
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|j
operator|&&
name|RCONS_ISPRINT
argument_list|(
name|str
index|[
name|i
index|]
argument_list|)
condition|;
operator|++
name|i
control|)
continue|continue;
name|rcons_text
argument_list|(
name|fb
argument_list|,
name|str
argument_list|,
name|i
argument_list|)
expr_stmt|;
operator|--
name|i
expr_stmt|;
name|str
operator|+=
name|i
expr_stmt|;
name|n
operator|-=
name|i
expr_stmt|;
block|}
else|else
name|rcons_pctrl
argument_list|(
name|fb
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
operator|++
name|str
expr_stmt|;
block|}
comment|/* Redraw the cursor (if necessary) */
if|if
condition|(
operator|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_CURSOR
operator|)
operator|==
literal|0
condition|)
name|rcons_cursor
argument_list|(
name|fb
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Actually write a string to the frame buffer */
end_comment

begin_function
name|void
name|rcons_text
parameter_list|(
name|fb
parameter_list|,
name|str
parameter_list|,
name|n
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
specifier|register
name|char
modifier|*
name|str
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|op
decl_stmt|;
name|x
operator|=
operator|*
name|fb
operator|->
name|fb_col
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|width
operator|+
name|fb
operator|->
name|fb_xorigin
expr_stmt|;
name|y
operator|=
operator|*
name|fb
operator|->
name|fb_row
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
operator|+
name|fb
operator|->
name|fb_font_ascent
operator|+
name|fb
operator|->
name|fb_yorigin
expr_stmt|;
name|op
operator|=
name|RAS_SRC
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_STANDOUT
operator|)
operator|!=
literal|0
operator|)
operator|^
operator|(
operator|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_INVERT
operator|)
operator|!=
literal|0
operator|)
condition|)
name|op
operator|=
name|RAS_NOT
argument_list|(
name|op
argument_list|)
expr_stmt|;
name|raster_textn
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|op
argument_list|,
name|fb
operator|->
name|fb_font
argument_list|,
name|str
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|fb
operator|->
name|fb_col
operator|+=
name|n
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_col
operator|>=
name|fb
operator|->
name|fb_maxcol
condition|)
block|{
operator|*
name|fb
operator|->
name|fb_col
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|fb
operator|->
name|fb_row
operator|)
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_row
operator|>=
name|fb
operator|->
name|fb_maxrow
condition|)
name|rcons_scroll
argument_list|(
name|fb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Handle a control character sent to the console */
end_comment

begin_function
name|void
name|rcons_pctrl
parameter_list|(
name|fb
parameter_list|,
name|c
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|;
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\r'
case|:
comment|/* Carriage return */
operator|*
name|fb
operator|->
name|fb_col
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'\b'
case|:
comment|/* Backspace */
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_col
operator|>
literal|0
condition|)
operator|(
operator|*
name|fb
operator|->
name|fb_col
operator|)
operator|--
expr_stmt|;
break|break;
case|case
literal|'\013'
case|:
comment|/* Vertical tab */
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_row
operator|>
literal|0
condition|)
operator|(
operator|*
name|fb
operator|->
name|fb_row
operator|)
operator|--
expr_stmt|;
break|break;
case|case
literal|'\f'
case|:
comment|/* Formfeed */
operator|*
name|fb
operator|->
name|fb_row
operator|=
operator|*
name|fb
operator|->
name|fb_col
operator|=
literal|0
expr_stmt|;
name|rcons_clear2eop
argument_list|(
name|fb
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
comment|/* Linefeed */
operator|(
operator|*
name|fb
operator|->
name|fb_row
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_row
operator|>=
name|fb
operator|->
name|fb_maxrow
condition|)
name|rcons_scroll
argument_list|(
name|fb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\007'
case|:
comment|/* Bell */
name|rcons_bell
argument_list|(
name|fb
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\t'
case|:
comment|/* Horizontal tab */
operator|*
name|fb
operator|->
name|fb_col
operator|=
operator|(
operator|*
name|fb
operator|->
name|fb_col
operator|+
literal|8
operator|)
operator|&
operator|~
literal|7
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_col
operator|>=
name|fb
operator|->
name|fb_maxcol
condition|)
operator|*
name|fb
operator|->
name|fb_col
operator|=
name|fb
operator|->
name|fb_maxcol
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Handle the next character in an escape sequence */
end_comment

begin_function
name|void
name|rcons_esc
parameter_list|(
name|fb
parameter_list|,
name|c
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|;
block|{
if|if
condition|(
name|c
operator|==
literal|'['
condition|)
block|{
comment|/* Parameter 0 */
name|fb
operator|->
name|fb_bits
operator|&=
operator|~
name|FB_P1
expr_stmt|;
name|fb
operator|->
name|fb_bits
operator||=
name|FB_P0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|';'
condition|)
block|{
comment|/* Parameter 1 */
name|fb
operator|->
name|fb_bits
operator|&=
operator|~
name|FB_P0
expr_stmt|;
name|fb
operator|->
name|fb_bits
operator||=
name|FB_P1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|RCONS_ISDIGIT
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* Add a digit to a parameter */
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_P0
condition|)
block|{
comment|/* Parameter 0 */
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_P0_DEFAULT
condition|)
block|{
name|fb
operator|->
name|fb_bits
operator|&=
operator|~
name|FB_P0_DEFAULT
expr_stmt|;
name|fb
operator|->
name|fb_p0
operator|=
literal|0
expr_stmt|;
block|}
name|fb
operator|->
name|fb_p0
operator|*=
literal|10
expr_stmt|;
name|fb
operator|->
name|fb_p0
operator|+=
name|c
operator|-
literal|'0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_P1
condition|)
block|{
comment|/* Parameter 1 */
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_P1_DEFAULT
condition|)
block|{
name|fb
operator|->
name|fb_bits
operator|&=
operator|~
name|FB_P1_DEFAULT
expr_stmt|;
name|fb
operator|->
name|fb_p1
operator|=
literal|0
expr_stmt|;
block|}
name|fb
operator|->
name|fb_p1
operator|*=
literal|10
expr_stmt|;
name|fb
operator|->
name|fb_p1
operator|+=
name|c
operator|-
literal|'0'
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Erase the cursor (if necessary) */
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_CURSOR
condition|)
name|rcons_cursor
argument_list|(
name|fb
argument_list|)
expr_stmt|;
comment|/* Process the completed escape sequence */
name|rcons_doesc
argument_list|(
name|fb
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|fb
operator|->
name|fb_bits
operator|&=
operator|~
name|FB_INESC
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Process a complete escape sequence */
end_comment

begin_function
name|void
name|rcons_doesc
parameter_list|(
name|fb
parameter_list|,
name|c
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|notdef
comment|/* XXX add escape sequence to enable visual (and audible) bell */
name|fb
operator|->
name|fb_bits
operator|=
name|FB_VISBELL
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'@'
case|:
comment|/* Insert Character (ICH) */
name|rcons_insertchar
argument_list|(
name|fb
argument_list|,
name|fb
operator|->
name|fb_p0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
comment|/* Cursor Up (CUU) */
operator|*
name|fb
operator|->
name|fb_row
operator|-=
name|fb
operator|->
name|fb_p0
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_row
operator|<
literal|0
condition|)
operator|*
name|fb
operator|->
name|fb_row
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* Cursor Down (CUD) */
operator|*
name|fb
operator|->
name|fb_row
operator|+=
name|fb
operator|->
name|fb_p0
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_row
operator|>=
name|fb
operator|->
name|fb_maxrow
condition|)
operator|*
name|fb
operator|->
name|fb_row
operator|=
name|fb
operator|->
name|fb_maxrow
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
comment|/* Cursor Forward (CUF) */
operator|*
name|fb
operator|->
name|fb_col
operator|+=
name|fb
operator|->
name|fb_p0
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_col
operator|>=
name|fb
operator|->
name|fb_maxcol
condition|)
operator|*
name|fb
operator|->
name|fb_col
operator|=
name|fb
operator|->
name|fb_maxcol
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* Cursor Backward (CUB) */
operator|*
name|fb
operator|->
name|fb_col
operator|-=
name|fb
operator|->
name|fb_p0
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_col
operator|<
literal|0
condition|)
operator|*
name|fb
operator|->
name|fb_col
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
comment|/* Cursor Next Line (CNL) */
operator|*
name|fb
operator|->
name|fb_col
operator|=
literal|0
expr_stmt|;
operator|*
name|fb
operator|->
name|fb_row
operator|+=
name|fb
operator|->
name|fb_p0
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_row
operator|>=
name|fb
operator|->
name|fb_maxrow
condition|)
operator|*
name|fb
operator|->
name|fb_row
operator|=
name|fb
operator|->
name|fb_maxrow
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* Horizontal And Vertical Position (HVP) */
case|case
literal|'H'
case|:
comment|/* Cursor Position (CUP) */
operator|*
name|fb
operator|->
name|fb_col
operator|=
name|fb
operator|->
name|fb_p1
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_col
operator|<
literal|0
condition|)
operator|*
name|fb
operator|->
name|fb_col
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_col
operator|>=
name|fb
operator|->
name|fb_maxcol
condition|)
operator|*
name|fb
operator|->
name|fb_col
operator|=
name|fb
operator|->
name|fb_maxcol
operator|-
literal|1
expr_stmt|;
operator|*
name|fb
operator|->
name|fb_row
operator|=
name|fb
operator|->
name|fb_p0
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_row
operator|<
literal|0
condition|)
operator|*
name|fb
operator|->
name|fb_row
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_row
operator|>=
name|fb
operator|->
name|fb_maxrow
condition|)
operator|*
name|fb
operator|->
name|fb_row
operator|=
name|fb
operator|->
name|fb_maxrow
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'J'
case|:
comment|/* Erase in Display (ED) */
name|rcons_clear2eop
argument_list|(
name|fb
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
comment|/* Erase in Line (EL) */
name|rcons_clear2eol
argument_list|(
name|fb
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
comment|/* Insert Line (IL) */
name|rcons_insertline
argument_list|(
name|fb
argument_list|,
name|fb
operator|->
name|fb_p0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
comment|/* Delete Line (DL) */
name|rcons_delline
argument_list|(
name|fb
argument_list|,
name|fb
operator|->
name|fb_p0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
comment|/* Delete Character (DCH) */
name|rcons_delchar
argument_list|(
name|fb
argument_list|,
name|fb
operator|->
name|fb_p0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* Select Graphic Rendition (SGR); */
comment|/* (defaults to zero) */
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_P0_DEFAULT
condition|)
name|fb
operator|->
name|fb_p0
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|fb_p0
condition|)
name|fb
operator|->
name|fb_bits
operator||=
name|FB_STANDOUT
expr_stmt|;
else|else
name|fb
operator|->
name|fb_bits
operator|&=
operator|~
name|FB_STANDOUT
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* Black On White (SUNBOW) */
name|rcons_invert
argument_list|(
name|fb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
comment|/* White On Black (SUNWOB) */
name|rcons_invert
argument_list|(
name|fb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
comment|/* Set scrolling (SUNSCRL) */
comment|/* (defaults to zero) */
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_P0_DEFAULT
condition|)
name|fb
operator|->
name|fb_p0
operator|=
literal|0
expr_stmt|;
comment|/* XXX not implemented yet */
name|fb
operator|->
name|fb_scroll
operator|=
name|fb
operator|->
name|fb_p0
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
comment|/* Reset terminal emulator (SUNRESET) */
name|fb
operator|->
name|fb_bits
operator|&=
operator|~
name|FB_STANDOUT
expr_stmt|;
name|fb
operator|->
name|fb_scroll
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_INVERT
condition|)
name|rcons_invert
argument_list|(
name|fb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Paint (or unpaint) the cursor */
end_comment

begin_function
name|void
name|rcons_cursor
parameter_list|(
name|fb
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
block|{
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|x
operator|=
operator|*
name|fb
operator|->
name|fb_col
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|width
operator|+
name|fb
operator|->
name|fb_xorigin
expr_stmt|;
name|y
operator|=
operator|*
name|fb
operator|->
name|fb_row
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
operator|+
name|fb
operator|->
name|fb_yorigin
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
ifdef|#
directive|ifdef
name|notdef
comment|/* XXX This is the right way but too slow */
name|fb
operator|->
name|fb_font
operator|->
name|chars
index|[
operator|(
name|int
operator|)
literal|' '
index|]
operator|.
name|r
operator|->
name|width
argument_list|,
name|fb
operator|->
name|fb_font
operator|->
name|chars
index|[
operator|(
name|int
operator|)
literal|' '
index|]
operator|.
name|r
operator|->
name|height
argument_list|,
else|#
directive|else
name|fb
operator|->
name|fb_font
operator|->
name|width
argument_list|,
name|fb
operator|->
name|fb_font
operator|->
name|height
argument_list|,
endif|#
directive|endif
name|RAS_INVERT
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fb
operator|->
name|fb_bits
operator|^=
name|FB_CURSOR
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Possibly change to SUNWOB or SUNBOW mode */
end_comment

begin_function
name|void
name|rcons_invert
parameter_list|(
name|fb
parameter_list|,
name|wob
parameter_list|)
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
name|int
name|wob
decl_stmt|;
block|{
if|if
condition|(
operator|(
operator|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_INVERT
operator|)
operator|!=
literal|0
operator|)
operator|^
name|wob
condition|)
block|{
comment|/* Invert the display */
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|fb
operator|->
name|fb_sp
operator|->
name|width
argument_list|,
name|fb
operator|->
name|fb_sp
operator|->
name|height
argument_list|,
name|RAS_INVERT
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Swap things around */
name|fb
operator|->
name|fb_ras_blank
operator|=
name|RAS_NOT
argument_list|(
name|fb
operator|->
name|fb_ras_blank
argument_list|)
expr_stmt|;
name|fb
operator|->
name|fb_bits
operator|^=
name|FB_INVERT
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Clear to the end of the page */
end_comment

begin_function
name|void
name|rcons_clear2eop
parameter_list|(
name|fb
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
block|{
specifier|register
name|int
name|y
decl_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_col
operator|==
literal|0
operator|&&
operator|*
name|fb
operator|->
name|fb_row
operator|==
literal|0
condition|)
block|{
comment|/* Clear the entire frame buffer */
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|fb
operator|->
name|fb_sp
operator|->
name|width
argument_list|,
name|fb
operator|->
name|fb_sp
operator|->
name|height
argument_list|,
name|fb
operator|->
name|fb_ras_blank
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Only clear what needs to be cleared */
name|rcons_clear2eol
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|y
operator|=
operator|(
operator|*
name|fb
operator|->
name|fb_row
operator|+
literal|1
operator|)
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|fb
operator|->
name|fb_yorigin
operator|+
name|y
argument_list|,
name|fb
operator|->
name|fb_emuwidth
argument_list|,
name|fb
operator|->
name|fb_emuheight
operator|-
name|y
argument_list|,
name|fb
operator|->
name|fb_ras_blank
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Clear to the end of the line */
end_comment

begin_function
name|void
name|rcons_clear2eol
parameter_list|(
name|fb
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
block|{
specifier|register
name|int
name|x
decl_stmt|;
name|x
operator|=
operator|*
name|fb
operator|->
name|fb_col
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|width
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
operator|+
name|x
argument_list|,
operator|*
name|fb
operator|->
name|fb_row
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|,
name|fb
operator|->
name|fb_emuwidth
operator|-
name|x
argument_list|,
name|fb
operator|->
name|fb_font
operator|->
name|height
argument_list|,
name|fb
operator|->
name|fb_ras_blank
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Scroll up one line */
end_comment

begin_function
name|void
name|rcons_scroll
parameter_list|(
name|fb
parameter_list|,
name|n
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|ydiv
decl_stmt|;
comment|/* Can't scroll more than the whole screen */
if|if
condition|(
name|n
operator|>
name|fb
operator|->
name|fb_maxrow
condition|)
name|n
operator|=
name|fb
operator|->
name|fb_maxrow
expr_stmt|;
comment|/* Calculate new row */
operator|*
name|fb
operator|->
name|fb_row
operator|-=
name|n
expr_stmt|;
if|if
condition|(
operator|*
name|fb
operator|->
name|fb_row
operator|<
literal|0
condition|)
operator|*
name|fb
operator|->
name|fb_row
operator|=
literal|0
expr_stmt|;
comment|/* Calculate number of pixels to scroll */
name|ydiv
operator|=
name|fb
operator|->
name|fb_font
operator|->
name|height
operator|*
name|n
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|fb
operator|->
name|fb_yorigin
argument_list|,
name|fb
operator|->
name|fb_emuwidth
argument_list|,
name|fb
operator|->
name|fb_emuheight
operator|-
name|ydiv
argument_list|,
name|RAS_SRC
argument_list|,
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|ydiv
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|)
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|fb
operator|->
name|fb_yorigin
operator|+
name|fb
operator|->
name|fb_emuheight
operator|-
name|ydiv
argument_list|,
name|fb
operator|->
name|fb_emuwidth
argument_list|,
name|ydiv
argument_list|,
name|fb
operator|->
name|fb_ras_blank
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Delete characters */
end_comment

begin_function
name|void
name|rcons_delchar
parameter_list|(
name|fb
parameter_list|,
name|n
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|tox
decl_stmt|,
name|fromx
decl_stmt|,
name|y
decl_stmt|,
name|width
decl_stmt|;
comment|/* Can't delete more chars than there are */
if|if
condition|(
name|n
operator|>
name|fb
operator|->
name|fb_maxcol
operator|-
operator|*
name|fb
operator|->
name|fb_col
condition|)
name|n
operator|=
name|fb
operator|->
name|fb_maxcol
operator|-
operator|*
name|fb
operator|->
name|fb_col
expr_stmt|;
name|fromx
operator|=
operator|(
operator|*
name|fb
operator|->
name|fb_col
operator|+
name|n
operator|)
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|width
expr_stmt|;
name|tox
operator|=
operator|*
name|fb
operator|->
name|fb_col
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|width
expr_stmt|;
name|y
operator|=
operator|*
name|fb
operator|->
name|fb_row
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
expr_stmt|;
name|width
operator|=
name|n
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|width
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|tox
operator|+
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|y
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|,
name|fb
operator|->
name|fb_emuwidth
operator|-
name|fromx
argument_list|,
name|fb
operator|->
name|fb_font
operator|->
name|height
argument_list|,
name|RAS_SRC
argument_list|,
name|fb
operator|->
name|fb_sp
argument_list|,
name|fromx
operator|+
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|y
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|)
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_emuwidth
operator|-
name|width
operator|+
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|y
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|,
name|width
argument_list|,
name|fb
operator|->
name|fb_font
operator|->
name|height
argument_list|,
name|fb
operator|->
name|fb_ras_blank
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Delete a number of lines */
end_comment

begin_function
name|void
name|rcons_delline
parameter_list|(
name|fb
parameter_list|,
name|n
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|fromy
decl_stmt|,
name|toy
decl_stmt|,
name|height
decl_stmt|;
comment|/* Can't delete more lines than there are */
if|if
condition|(
name|n
operator|>
name|fb
operator|->
name|fb_maxrow
operator|-
operator|*
name|fb
operator|->
name|fb_row
condition|)
name|n
operator|=
name|fb
operator|->
name|fb_maxrow
operator|-
operator|*
name|fb
operator|->
name|fb_row
expr_stmt|;
name|fromy
operator|=
operator|(
operator|*
name|fb
operator|->
name|fb_row
operator|+
name|n
operator|)
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
expr_stmt|;
name|toy
operator|=
operator|*
name|fb
operator|->
name|fb_row
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
expr_stmt|;
name|height
operator|=
name|fb
operator|->
name|fb_font
operator|->
name|height
operator|*
name|n
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|toy
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|,
name|fb
operator|->
name|fb_emuwidth
argument_list|,
name|fb
operator|->
name|fb_emuheight
operator|-
name|fromy
argument_list|,
name|RAS_SRC
argument_list|,
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|fromy
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|)
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|fb
operator|->
name|fb_emuheight
operator|-
name|height
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|,
name|fb
operator|->
name|fb_emuwidth
argument_list|,
name|height
argument_list|,
name|fb
operator|->
name|fb_ras_blank
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Insert some characters */
end_comment

begin_function
name|void
name|rcons_insertchar
parameter_list|(
name|fb
parameter_list|,
name|n
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|tox
decl_stmt|,
name|fromx
decl_stmt|,
name|y
decl_stmt|;
comment|/* Can't insert more chars than can fit */
if|if
condition|(
name|n
operator|>
name|fb
operator|->
name|fb_maxcol
operator|-
operator|*
name|fb
operator|->
name|fb_col
condition|)
name|n
operator|=
name|fb
operator|->
name|fb_maxcol
operator|-
operator|*
name|fb
operator|->
name|fb_col
expr_stmt|;
name|tox
operator|=
operator|(
operator|*
name|fb
operator|->
name|fb_col
operator|+
name|n
operator|)
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|width
expr_stmt|;
name|fromx
operator|=
operator|*
name|fb
operator|->
name|fb_col
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|width
expr_stmt|;
name|y
operator|=
operator|*
name|fb
operator|->
name|fb_row
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|tox
operator|+
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|y
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|,
name|fb
operator|->
name|fb_emuwidth
operator|-
name|tox
argument_list|,
name|fb
operator|->
name|fb_font
operator|->
name|height
argument_list|,
name|RAS_SRC
argument_list|,
name|fb
operator|->
name|fb_sp
argument_list|,
name|fromx
operator|+
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|y
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|)
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|fromx
operator|+
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|y
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|,
name|fb
operator|->
name|fb_font
operator|->
name|width
operator|*
name|n
argument_list|,
name|fb
operator|->
name|fb_font
operator|->
name|height
argument_list|,
name|fb
operator|->
name|fb_ras_blank
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Insert some lines */
end_comment

begin_function
name|void
name|rcons_insertline
parameter_list|(
name|fb
parameter_list|,
name|n
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|fromy
decl_stmt|,
name|toy
decl_stmt|;
comment|/* Can't insert more lines than can fit */
if|if
condition|(
name|n
operator|>
name|fb
operator|->
name|fb_maxrow
operator|-
operator|*
name|fb
operator|->
name|fb_row
condition|)
name|n
operator|=
name|fb
operator|->
name|fb_maxrow
operator|-
operator|*
name|fb
operator|->
name|fb_row
expr_stmt|;
name|toy
operator|=
operator|(
operator|*
name|fb
operator|->
name|fb_row
operator|+
name|n
operator|)
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
expr_stmt|;
name|fromy
operator|=
operator|*
name|fb
operator|->
name|fb_row
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|toy
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|,
name|fb
operator|->
name|fb_emuwidth
argument_list|,
name|fb
operator|->
name|fb_emuheight
operator|-
name|toy
argument_list|,
name|RAS_SRC
argument_list|,
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|fromy
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|)
expr_stmt|;
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
name|fb
operator|->
name|fb_xorigin
argument_list|,
name|fromy
operator|+
name|fb
operator|->
name|fb_yorigin
argument_list|,
name|fb
operator|->
name|fb_emuwidth
argument_list|,
name|fb
operator|->
name|fb_font
operator|->
name|height
operator|*
name|n
argument_list|,
name|fb
operator|->
name|fb_ras_blank
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


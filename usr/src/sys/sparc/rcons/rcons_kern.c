begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1991 The Regents of the University of California.  * All rights reserved.  *  * This software was developed by the Computer Systems Engineering group  * at Lawrence Berkeley Laboratory under DARPA contract BG 91-66 and  * contributed to Berkeley.  *  * All advertising materials mentioning features or use of this software  * must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Lawrence Berkeley Laboratory.  *  * %sccs.include.redist.c%  *  *	@(#)rcons_kern.c	7.4 (Berkeley) %G%  *  * from: $Header: rcons_kern.c,v 1.28 93/04/20 11:15:38 torek Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_include
include|#
directive|include
file|<sys/fbio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_include
include|#
directive|include
file|<machine/fbvar.h>
end_include

begin_include
include|#
directive|include
file|<machine/autoconf.h>
end_include

begin_include
include|#
directive|include
file|<sparc/dev/kbd.h>
end_include

begin_include
include|#
directive|include
file|<sparc/rcons/raster.h>
end_include

begin_decl_stmt
specifier|extern
name|struct
name|tty
modifier|*
name|fbconstty
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|rcons_belltmr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|rcons_puts
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|rcons_font
parameter_list|(
name|struct
name|fbdevice
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
function_decl|(
modifier|*
name|v_putc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|ttrstrt
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|fbdevice
modifier|*
name|myfbdevicep
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|rcons_cnputc
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
name|rcons_puts
argument_list|(
name|myfbdevicep
argument_list|,
literal|"\r\n"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
else|else
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|c
expr_stmt|;
name|rcons_puts
argument_list|(
name|myfbdevicep
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rcons_output
parameter_list|(
name|tp
parameter_list|)
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
block|{
specifier|register
name|int
name|s
decl_stmt|,
name|n
decl_stmt|,
name|i
decl_stmt|;
name|char
name|buf
index|[
name|OBUFSIZ
index|]
decl_stmt|;
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
operator|(
name|TS_TIMEOUT
operator||
name|TS_BUSY
operator||
name|TS_TTSTOP
operator|)
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|tp
operator|->
name|t_state
operator||=
name|TS_BUSY
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|n
operator|=
name|q_to_b
argument_list|(
operator|&
name|tp
operator|->
name|t_outq
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
name|buf
index|[
name|i
index|]
operator|&=
literal|0177
expr_stmt|;
comment|/* strip parity (argh) */
name|rcons_puts
argument_list|(
name|myfbdevicep
argument_list|,
name|buf
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|tp
operator|->
name|t_state
operator|&=
operator|~
name|TS_BUSY
expr_stmt|;
comment|/* Come back if there's more to do */
if|if
condition|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
condition|)
block|{
name|tp
operator|->
name|t_state
operator||=
name|TS_TIMEOUT
expr_stmt|;
name|timeout
argument_list|(
name|ttrstrt
argument_list|,
name|tp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|<=
name|tp
operator|->
name|t_lowat
condition|)
block|{
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|TS_ASLEEP
condition|)
block|{
name|tp
operator|->
name|t_state
operator|&=
operator|~
name|TS_ASLEEP
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|tp
operator|->
name|t_outq
argument_list|)
expr_stmt|;
block|}
name|selwakeup
argument_list|(
operator|&
name|tp
operator|->
name|t_wsel
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Ring the console bell */
end_comment

begin_function
name|void
name|rcons_bell
parameter_list|(
name|fb
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|s
decl_stmt|;
if|if
condition|(
name|fb
operator|->
name|fb_bits
operator|&
name|FB_VISBELL
condition|)
block|{
comment|/* invert the screen twice */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
operator|++
name|i
control|)
name|raster_op
argument_list|(
name|fb
operator|->
name|fb_sp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|fb
operator|->
name|fb_sp
operator|->
name|width
argument_list|,
name|fb
operator|->
name|fb_sp
operator|->
name|height
argument_list|,
name|RAS_INVERT
argument_list|,
operator|(
expr|struct
name|raster
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|s
operator|=
name|splhigh
argument_list|()
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|fb_belldepth
operator|++
condition|)
block|{
if|if
condition|(
name|fb
operator|->
name|fb_belldepth
operator|>
literal|3
condition|)
name|fb
operator|->
name|fb_belldepth
operator|=
literal|3
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fb
operator|->
name|fb_ringing
operator|=
literal|1
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|kbd_docmd
argument_list|(
name|KBD_CMD_BELL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX Chris doesn't like the following divide */
name|timeout
argument_list|(
name|rcons_belltmr
argument_list|,
name|fb
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Bell timer service routine */
end_comment

begin_function
specifier|static
name|void
name|rcons_belltmr
parameter_list|(
name|p
parameter_list|)
name|void
modifier|*
name|p
decl_stmt|;
block|{
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
init|=
name|p
decl_stmt|;
specifier|register
name|int
name|s
init|=
name|splhigh
argument_list|()
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|fb
operator|->
name|fb_ringing
condition|)
block|{
name|fb
operator|->
name|fb_ringing
operator|=
literal|0
expr_stmt|;
name|i
operator|=
operator|--
name|fb
operator|->
name|fb_belldepth
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|kbd_docmd
argument_list|(
name|KBD_CMD_NOBELL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
comment|/* XXX Chris doesn't like the following divide */
name|timeout
argument_list|(
name|rcons_belltmr
argument_list|,
name|fb
argument_list|,
name|hz
operator|/
literal|30
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fb
operator|->
name|fb_ringing
operator|=
literal|1
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|kbd_docmd
argument_list|(
name|KBD_CMD_BELL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|timeout
argument_list|(
name|rcons_belltmr
argument_list|,
name|fb
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rcons_a2int
parameter_list|(
name|cp
parameter_list|,
name|deflt
parameter_list|)
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|deflt
decl_stmt|;
block|{
specifier|register
name|int
name|i
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\0'
condition|)
return|return
operator|(
name|deflt
operator|)
return|;
while|while
condition|(
operator|*
name|cp
operator|!=
literal|'\0'
condition|)
name|i
operator|=
name|i
operator|*
literal|10
operator|+
operator|*
name|cp
operator|++
operator|-
literal|'0'
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
name|void
name|rcons_init
parameter_list|(
name|fb
parameter_list|)
specifier|register
name|struct
name|fbdevice
modifier|*
name|fb
decl_stmt|;
block|{
comment|/* XXX this should go away */
specifier|static
name|struct
name|raster
name|xxxraster
decl_stmt|;
specifier|register
name|struct
name|raster
modifier|*
name|rp
init|=
name|fb
operator|->
name|fb_sp
operator|=
operator|&
name|xxxraster
decl_stmt|;
specifier|register
name|struct
name|fbtype
modifier|*
name|ft
init|=
operator|&
name|fb
operator|->
name|fb_type
decl_stmt|;
specifier|register
name|struct
name|winsize
modifier|*
name|ws
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|static
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|myfbdevicep
operator|=
name|fb
expr_stmt|;
name|fb
operator|->
name|fb_maxcol
operator|=
name|rcons_a2int
argument_list|(
name|getpropstring
argument_list|(
name|optionsnode
argument_list|,
literal|"screen-#columns"
argument_list|)
argument_list|,
literal|80
argument_list|)
expr_stmt|;
name|fb
operator|->
name|fb_maxrow
operator|=
name|rcons_a2int
argument_list|(
name|getpropstring
argument_list|(
name|optionsnode
argument_list|,
literal|"screen-#rows"
argument_list|)
argument_list|,
literal|34
argument_list|)
expr_stmt|;
comment|/* XXX mostly duplicates of data in other places */
name|rp
operator|->
name|width
operator|=
name|ft
operator|->
name|fb_width
expr_stmt|;
name|rp
operator|->
name|height
operator|=
name|ft
operator|->
name|fb_height
expr_stmt|;
name|rp
operator|->
name|depth
operator|=
name|ft
operator|->
name|fb_depth
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|fb_linebytes
operator|&
literal|0x3
condition|)
block|{
name|printf
argument_list|(
literal|"rcons_init: linebytes assumption botched (0x%x)\n"
argument_list|,
name|fb
operator|->
name|fb_linebytes
argument_list|)
expr_stmt|;
return|return;
block|}
name|rp
operator|->
name|linelongs
operator|=
name|fb
operator|->
name|fb_linebytes
operator|>>
literal|2
expr_stmt|;
name|rp
operator|->
name|pixels
operator|=
operator|(
name|u_long
operator|*
operator|)
name|fb
operator|->
name|fb_pixels
expr_stmt|;
name|fb
operator|->
name|fb_ras_blank
operator|=
name|RAS_CLEAR
expr_stmt|;
comment|/* Setup the static font */
name|rcons_font
argument_list|(
name|fb
argument_list|)
expr_stmt|;
comment|/* Impose upper bounds on fb_max{row,col} */
name|i
operator|=
name|ft
operator|->
name|fb_height
operator|/
name|fb
operator|->
name|fb_font
operator|->
name|height
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|fb_maxrow
operator|>
name|i
condition|)
name|fb
operator|->
name|fb_maxrow
operator|=
name|i
expr_stmt|;
name|i
operator|=
name|ft
operator|->
name|fb_width
operator|/
name|fb
operator|->
name|fb_font
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|fb_maxcol
operator|>
name|i
condition|)
name|fb
operator|->
name|fb_maxcol
operator|=
name|i
expr_stmt|;
comment|/* Let the system know how big the console is */
name|ws
operator|=
operator|&
name|fbconstty
operator|->
name|t_winsize
expr_stmt|;
name|ws
operator|->
name|ws_row
operator|=
name|fb
operator|->
name|fb_maxrow
expr_stmt|;
name|ws
operator|->
name|ws_col
operator|=
name|fb
operator|->
name|fb_maxcol
expr_stmt|;
name|ws
operator|->
name|ws_xpixel
operator|=
name|ft
operator|->
name|fb_width
expr_stmt|;
name|ws
operator|->
name|ws_ypixel
operator|=
name|ft
operator|->
name|fb_height
expr_stmt|;
comment|/* Center emulator screen (but align x origin to 32 bits) */
name|fb
operator|->
name|fb_xorigin
operator|=
operator|(
operator|(
name|ft
operator|->
name|fb_width
operator|-
name|fb
operator|->
name|fb_maxcol
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|width
operator|)
operator|/
literal|2
operator|)
operator|&
operator|~
literal|0x1f
expr_stmt|;
name|fb
operator|->
name|fb_yorigin
operator|=
operator|(
name|ft
operator|->
name|fb_height
operator|-
name|fb
operator|->
name|fb_maxrow
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
operator|)
operator|/
literal|2
expr_stmt|;
comment|/* Emulator width and height used for scrolling */
name|fb
operator|->
name|fb_emuwidth
operator|=
name|fb
operator|->
name|fb_maxcol
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|fb_emuwidth
operator|&
literal|0x1f
condition|)
block|{
comment|/* Pad to 32 bits */
name|i
operator|=
operator|(
name|fb
operator|->
name|fb_emuwidth
operator|+
literal|0x1f
operator|)
operator|&
operator|~
literal|0x1f
expr_stmt|;
comment|/* Make sure emulator width isn't too wide */
if|if
condition|(
name|fb
operator|->
name|fb_xorigin
operator|+
name|i
operator|<=
name|ft
operator|->
name|fb_width
condition|)
name|fb
operator|->
name|fb_emuwidth
operator|=
name|i
expr_stmt|;
block|}
name|fb
operator|->
name|fb_emuheight
operator|=
name|fb
operator|->
name|fb_maxrow
operator|*
name|fb
operator|->
name|fb_font
operator|->
name|height
expr_stmt|;
comment|/* Determine addresses of prom emulator row and column */
name|fb
operator|->
name|fb_row
operator|=
name|fb
operator|->
name|fb_col
operator|=
name|NULL
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"' line#>body>user %x !"
argument_list|,
operator|&
name|fb
operator|->
name|fb_row
argument_list|)
expr_stmt|;
name|rominterpret
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"' column#>body>user %x !"
argument_list|,
operator|&
name|fb
operator|->
name|fb_col
argument_list|)
expr_stmt|;
name|rominterpret
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|fb_row
operator|==
name|NULL
operator|||
name|fb
operator|->
name|fb_col
operator|==
name|NULL
condition|)
block|{
comment|/* Can't find addresses; use private copies */
name|fb
operator|->
name|fb_row
operator|=
operator|&
name|row
expr_stmt|;
name|fb
operator|->
name|fb_col
operator|=
operator|&
name|col
expr_stmt|;
name|row
operator|=
name|col
operator|=
literal|0
expr_stmt|;
name|rcons_clear2eop
argument_list|(
name|fb
argument_list|)
expr_stmt|;
comment|/* clear the display */
name|rcons_cursor
argument_list|(
name|fb
argument_list|)
expr_stmt|;
comment|/* and draw the initial cursor */
block|}
else|else
block|{
comment|/* Prom emulator cursor is currently visible */
name|fb
operator|->
name|fb_bits
operator||=
name|FB_CURSOR
expr_stmt|;
block|}
comment|/* Initialization done; hook us up */
name|v_putc
operator|=
operator|(
name|int
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|rcons_cnputc
expr_stmt|;
name|fbconstty
operator|->
name|t_oproc
operator|=
name|rcons_output
expr_stmt|;
name|fbconstty
operator|->
name|t_stop
operator|=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|nullop
expr_stmt|;
block|}
end_function

end_unit


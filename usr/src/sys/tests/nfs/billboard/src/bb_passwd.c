begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  ******************************************************************************  *  * Module: bb_passwd.c  *  * Functions:   *	    bb_read_passwords()	- Read or create the password file.  *	    bb_check_passwd()	- Check a password against the passwd list.  *	    bb_passwd_set_1()	- Set a password in the passwd list.  *	    bb_passwd_update()	- Update the password list on disk.  *  *  ******************************************************************************  */
end_comment

begin_comment
comment|/*  ******************************************************************************  * Include Files  ******************************************************************************  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpc.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"protocol.h"
end_include

begin_include
include|#
directive|include
file|"server.h"
end_include

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** **  bb_read_passwords() - If the password file exists read it and store	** **  each line in the password array.  If it does not exist then create	** **  it and fill in a blank entry for each implementation.		** **									** *************************************************************************/
end_comment

begin_decl_stmt
name|BB_passwd
name|passwds
index|[
name|BB_MAX_IMP
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The password array.		*/
end_comment

begin_function
name|int
name|bb_read_passwords
parameter_list|()
block|{
name|FILE
modifier|*
name|passwd_file
decl_stmt|;
comment|/* Pointer to the passwd file.	*/
name|int
name|i
init|=
literal|0
decl_stmt|;
comment|/* Index into passwd array.	*/
name|int
name|num_imps
decl_stmt|;
comment|/* The number of implementations*/
name|BB_passwd
name|empty_pass
decl_stmt|;
comment|/* An empty password record.	*/
name|num_imps
operator|=
name|bb_get_imp_cnt
argument_list|()
expr_stmt|;
comment|/*     **  If the file exists read it into the password array.     */
if|if
condition|(
operator|(
name|passwd_file
operator|=
name|fopen
argument_list|(
name|BB_PASSWD_FILE
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
name|fread
argument_list|(
name|passwds
index|[
name|i
index|]
argument_list|,
name|BB_PASSWD_LEN
argument_list|,
literal|1
argument_list|,
name|passwd_file
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|passwds
index|[
name|i
index|]
index|[
name|BB_PASSWD_LEN
operator|-
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|num_imps
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Too many passwords in file.\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|passwd_file
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
block|}
name|fclose
argument_list|(
name|passwd_file
argument_list|)
expr_stmt|;
return|return
name|BB_SUCCESS
return|;
block|}
comment|/*     **  The file did not exist so create it.     */
if|if
condition|(
operator|(
name|passwd_file
operator|=
name|fopen
argument_list|(
name|BB_PASSWD_FILE
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED opening the password data file '%s'.\n"
argument_list|,
name|BB_PASSWD_FILE
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|passwd_file
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
comment|/*     **  Fill the file with empty passwords.     */
name|memset
argument_list|(
name|empty_pass
argument_list|,
name|NUL
argument_list|,
name|BB_PASSWD_LEN
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_imps
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fwrite
argument_list|(
name|empty_pass
argument_list|,
name|BB_PASSWD_LEN
argument_list|,
literal|1
argument_list|,
name|passwd_file
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Could not create password file.\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|passwd_file
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
name|memset
argument_list|(
name|passwds
index|[
name|i
index|]
argument_list|,
name|NUL
argument_list|,
name|BB_PASSWD_LEN
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|passwd_file
argument_list|)
expr_stmt|;
return|return
name|BB_SUCCESS
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** **  bb_check_passwd() - Check to see if the password matches the id.	** **									** *************************************************************************/
end_comment

begin_function
name|int
name|bb_check_passwd
parameter_list|(
name|id
parameter_list|,
name|passwd
parameter_list|)
name|BB_id
name|id
decl_stmt|;
comment|/* The identifier of the passwd owner.	*/
name|BB_passwd
name|passwd
decl_stmt|;
comment|/* The password to verify.		*/
block|{
name|int
name|index
decl_stmt|;
comment|/* The index of the identifier.		*/
if|if
condition|(
operator|(
name|index
operator|=
name|bb_get_hash
argument_list|(
name|id
argument_list|)
operator|)
operator|==
name|BB_HASH_ID_NOT_FOUND
condition|)
block|{
return|return
name|BB_BAD_CLIENT
return|;
block|}
comment|/*     **  If no password exists return success.     */
if|if
condition|(
name|passwds
index|[
name|index
index|]
index|[
literal|0
index|]
operator|==
name|NUL
condition|)
return|return
name|BB_SUCCESS
return|;
if|if
condition|(
name|strncmp
argument_list|(
name|passwd
argument_list|,
name|passwds
index|[
name|index
index|]
argument_list|,
name|BB_PASSWD_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
return|return
name|BB_BAD_PASSWD
return|;
block|}
return|return
name|BB_SUCCESS
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** **  bb_passwd_set_1() - Set the password for the client in the database.** **  check to make sure the old password is correct first.		** **									** *************************************************************************/
end_comment

begin_function
name|int
modifier|*
name|bb_passwd_set_1
parameter_list|(
name|p_passwd
parameter_list|)
name|BB_passwd_in
modifier|*
name|p_passwd
decl_stmt|;
comment|/* The passwd_in structure.		*/
block|{
specifier|static
name|int
name|result
decl_stmt|;
comment|/* The result of the set operation.	*/
name|int
name|index
decl_stmt|;
comment|/* The index of the identifier.		*/
comment|/*     **  bb_check_passwd() returns the reason for failure, so use that     **  as the result of this function call.     */
if|if
condition|(
operator|(
name|result
operator|=
name|bb_check_passwd
argument_list|(
name|p_passwd
operator|->
name|client
argument_list|,
name|p_passwd
operator|->
name|old
argument_list|)
operator|)
operator|!=
name|BB_SUCCESS
condition|)
block|{
return|return
operator|&
name|result
return|;
block|}
if|if
condition|(
operator|(
name|index
operator|=
name|bb_get_hash
argument_list|(
name|p_passwd
operator|->
name|client
argument_list|)
operator|)
operator|==
name|BB_HASH_ID_NOT_FOUND
condition|)
block|{
name|result
operator|=
name|BB_BAD_CLIENT
expr_stmt|;
return|return
operator|&
name|result
return|;
block|}
comment|/*     **  Copy the password to the data structure and update the data file.     */
name|strncpy
argument_list|(
name|passwds
index|[
name|index
index|]
argument_list|,
name|p_passwd
operator|->
name|new
argument_list|,
name|BB_PASSWD_LEN
argument_list|)
expr_stmt|;
name|result
operator|=
name|bb_passwd_update
argument_list|(
name|index
argument_list|)
expr_stmt|;
return|return
operator|&
name|result
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** **  bb_passwd_update() - Write the password which has changed out to	** **  password data file.							** **									** *************************************************************************/
end_comment

begin_function
name|int
name|bb_passwd_update
parameter_list|(
name|index
parameter_list|)
name|int
name|index
decl_stmt|;
comment|/* The index of the changed password.	*/
block|{
name|int
name|num_imps
decl_stmt|;
comment|/* The number of implementations.	*/
name|FILE
modifier|*
name|passwd_file
decl_stmt|;
comment|/* Pointer to the passwd file.		*/
name|long
name|seek_to
decl_stmt|;
comment|/* The position to seek to in the file.	*/
name|num_imps
operator|=
name|bb_get_imp_cnt
argument_list|()
expr_stmt|;
if|if
condition|(
name|index
operator|>=
name|num_imps
condition|)
block|{
return|return
name|BB_FAILURE
return|;
block|}
comment|/*     **  The password that we want to write is at location index     **  passwords into the file.  Multiply index by the size of     **  a password and that is the offset.     */
name|seek_to
operator|=
name|index
operator|*
name|BB_PASSWD_LEN
expr_stmt|;
comment|/*     **  Open the password file.     */
if|if
condition|(
operator|(
name|passwd_file
operator|=
name|fopen
argument_list|(
name|BB_PASSWD_FILE
argument_list|,
literal|"r+"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Could not open password file for update.\n"
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
if|if
condition|(
name|fseek
argument_list|(
name|passwd_file
argument_list|,
name|seek_to
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Could not seek in password file.\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|passwd_file
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
if|if
condition|(
name|fwrite
argument_list|(
name|passwds
index|[
name|index
index|]
argument_list|,
name|BB_PASSWD_LEN
argument_list|,
literal|1
argument_list|,
name|passwd_file
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Could not update password file.\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|passwd_file
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
name|fclose
argument_list|(
name|passwd_file
argument_list|)
expr_stmt|;
return|return
name|BB_SUCCESS
return|;
block|}
end_function

end_unit


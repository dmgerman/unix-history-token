begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  ******************************************************************************  *  * Module: billboard.c  *  * Description: billboard.c  *		Billboard is an RPC program that handles information about  *		testsuites completions.  The module here is the user program  *		that communicates with the billboard server.  This program  *		allows user to update and modify information maintained  *		by the server.  The features supported are (described below  *		using the command line options):  *		i) -s<client identifier><server identifier>  *		   	to set test between<client identifier> and   *<server identifier> as successfully tested  *		ii) -u<client identifier><server identifier>  *		   	to set test between<client identifier> and   *<server identifier> as NOT successfully tested  *		iii) -a<client identifier>  *			to list server implementations that are successfully  *			tested against client<client identifier>  *		iv) -b<client identifier>  *			to list server implementations that are NOT   *			successfully tested against client<client identifier>  *		v) -c<server identifier>  *			to list client implementations that are successfully  *			tested against server<server identifier>  *		vi) -d<server identifier>  *			to list client implementations that are NOT   *			successfully tested against server<server identifier>  *		vii) -p<identifier>  *			to change the password of the<identifier>   *			implementation  *		     *		where<client identifier> and<server identifier> is  *		      identifier of the client and server implementation  *		      respectively.  *  *		This user program also supports interactive interface whereby  *		the user is presented with a list of options (same as the   *		features described above) to choose from.  User will be prompted  *		for any additional data.  *  * Functions:   *	main(argc, argv)  *	_cmd_line_option(argc, argv)  *	_interactive_option()  *	_bb_get_passwd(bb_passwd_in_p)  *  *  ******************************************************************************  */
end_comment

begin_comment
comment|/*  ******************************************************************************  * Include Files  ******************************************************************************  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"protocol.h"
end_include

begin_comment
comment|/*  ******************************************************************************  * Manifest Constants  ******************************************************************************  */
end_comment

begin_define
define|#
directive|define
name|_CONTROL_STR_SIZE
value|5
end_define

begin_comment
comment|/* sscanf control string size */
end_comment

begin_comment
comment|/*  ******************************************************************************  * Macro Definitions  ******************************************************************************  */
end_comment

begin_comment
comment|/* print error messages */
end_comment

begin_define
define|#
directive|define
name|PRINT_ERROR
parameter_list|()
value|{ 	fprintf(stderr, _Usage, argv[0]);\ 					return(1);			\ 				}
end_define

begin_comment
comment|/*  ******************************************************************************  * Module Local Definitions  ******************************************************************************  */
end_comment

begin_comment
comment|/* usage message */
end_comment

begin_decl_stmt
name|char
modifier|*
name|_Usage
init|=
literal|"Usage: %s	[-s|-u client_idenitfier server_identifier]\n\            	[-a|-b client_idenitfier]\n\            	[-c|-d server_identifier]\n\ 		[-p identifier]\n"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*   *randomly picked salt key for password encryption 	  * This may be modified if other algorithm is preferred   */
end_comment

begin_decl_stmt
name|char
modifier|*
name|_bb_salt
init|=
literal|"kR"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  ******************************************************************************  * External Declarations  ******************************************************************************  */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|optind
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  ******************************************************************************  * Function Declarations  ******************************************************************************  */
end_comment

begin_function_decl
name|int
name|main
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|_cmd_line_option
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|_interactive_option
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|_bb_get_passwd
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  ******************************************************************************  *  * Function: main  *  * Description:  * 	Invokes modules to handle command line interface or   * 	interactive according to the user invocation.	  *  * Input:  *	argc  *	argv  *  * Output:  *	Output goes to stdout, error goes to stderr.  *  * Returns:  *	1 -- operation failed  *	0 -- operation succeeded.  *  * Side Effects:  *  * Notes:  *  ******************************************************************************  */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
return|return
operator|(
name|_cmd_line_option
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
operator|)
return|;
else|else
name|_interactive_option
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  ******************************************************************************  *  * Function: _cmd_line_option  *  * Description:  *	Parses command line input and perform the requested  *	operation accordingly.				      *  * Input:  *	argc  *	argv  *  * Output:  *	Output goes to stdout, error goes to stderr.  *  * Returns:  *  * Side Effects:  *  * Notes:  *  ******************************************************************************  */
end_comment

begin_function
specifier|static
name|int
name|_cmd_line_option
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|option
decl_stmt|;
name|BB_set_in
name|bb_set_in
decl_stmt|;
name|BB_list_in
name|bb_list_in
decl_stmt|;
name|BB_passwd_in
name|bb_passwd_in
decl_stmt|;
comment|/* initialise termination of string buffers */
name|bb_set_in
operator|.
name|client
index|[
name|BB_ID_NAME_LEN
operator|-
literal|1
index|]
operator|=
name|bb_set_in
operator|.
name|server
index|[
name|BB_ID_NAME_LEN
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|bb_list_in
operator|.
name|id
index|[
name|BB_ID_NAME_LEN
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* 	 * parses the command line input, and make the remote procedure call 	 */
if|if
condition|(
operator|(
name|option
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"s:u:a:b:c:d:p:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|option
condition|)
block|{
comment|/*  		 * gets client and server identifier and 		 * calls bb_call_set_unset to handle the 		 * remote procedure call 		 */
case|case
literal|'s'
case|:
name|strncpy
argument_list|(
name|bb_set_in
operator|.
name|client
argument_list|,
name|optarg
argument_list|,
name|BB_ID_NAME_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|bb_set_in
operator|.
name|server
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|,
name|BB_ID_NAME_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bb_call_set_unset
argument_list|(
name|BB_SET
argument_list|,
operator|&
name|bb_set_in
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|strncpy
argument_list|(
name|bb_set_in
operator|.
name|client
argument_list|,
name|optarg
argument_list|,
name|BB_ID_NAME_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|bb_set_in
operator|.
name|server
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|,
name|BB_ID_NAME_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bb_call_set_unset
argument_list|(
name|BB_UNSET
argument_list|,
operator|&
name|bb_set_in
argument_list|)
expr_stmt|;
break|break;
comment|/*  		 * gets client or server identifier and 		 * calls bb_list to handle the remote procedure 		 * call 		 */
case|case
literal|'a'
case|:
name|strncpy
argument_list|(
name|bb_list_in
operator|.
name|id
argument_list|,
name|optarg
argument_list|,
name|BB_ID_NAME_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bb_list
argument_list|(
name|BB_ALIST
argument_list|,
operator|&
name|bb_list_in
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|strncpy
argument_list|(
name|bb_list_in
operator|.
name|id
argument_list|,
name|optarg
argument_list|,
name|BB_ID_NAME_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bb_list
argument_list|(
name|BB_BLIST
argument_list|,
operator|&
name|bb_list_in
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|strncpy
argument_list|(
name|bb_list_in
operator|.
name|id
argument_list|,
name|optarg
argument_list|,
name|BB_ID_NAME_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bb_list
argument_list|(
name|BB_CLIST
argument_list|,
operator|&
name|bb_list_in
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|strncpy
argument_list|(
name|bb_list_in
operator|.
name|id
argument_list|,
name|optarg
argument_list|,
name|BB_ID_NAME_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bb_list
argument_list|(
name|BB_DLIST
argument_list|,
operator|&
name|bb_list_in
argument_list|)
expr_stmt|;
break|break;
comment|/* to change password */
case|case
literal|'p'
case|:
name|strncpy
argument_list|(
name|bb_passwd_in
operator|.
name|client
argument_list|,
name|optarg
argument_list|,
name|BB_ID_NAME_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|_bb_get_passwd
argument_list|(
operator|&
name|bb_passwd_in
argument_list|)
operator|==
name|TRUE
condition|)
name|bb_change_passwd
argument_list|(
operator|&
name|bb_passwd_in
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|PRINT_ERROR
argument_list|()
expr_stmt|;
block|}
block|}
else|else
name|PRINT_ERROR
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  ******************************************************************************  *  * Function: _interactive_option  *  * Description:  *	Handles the interactive interface.  Promt user for inforamtion and   *	performs the operation selected by the user.  *  * Input:  *  * Output:  *	Output goes to stdout, error goes to stderr.  *  * Returns:  *  * Side Effects:  *  * Notes:  *  ******************************************************************************  */
end_comment

begin_function
specifier|static
name|void
name|_interactive_option
parameter_list|()
block|{
name|int
name|option
init|=
literal|0
decl_stmt|;
name|BB_id
name|client_id
decl_stmt|;
name|BB_id
name|server_id
decl_stmt|;
name|char
name|buffer
index|[
name|BB_MAX_LINE_LEN
index|]
decl_stmt|;
name|char
name|control_str
index|[
name|_CONTROL_STR_SIZE
index|]
decl_stmt|;
name|BB_set_in
name|bb_set_in
decl_stmt|;
name|BB_list_in
name|bb_list_in
decl_stmt|;
name|BB_passwd_in
name|bb_passwd_in
decl_stmt|;
comment|/* terminate the string buffers */
name|bb_set_in
operator|.
name|client
index|[
name|BB_ID_NAME_LEN
operator|-
literal|1
index|]
operator|=
name|bb_set_in
operator|.
name|server
index|[
name|BB_ID_NAME_LEN
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|bb_list_in
operator|.
name|id
index|[
name|BB_ID_NAME_LEN
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|sprintf
argument_list|(
name|control_str
argument_list|,
literal|"%%%ds"
argument_list|,
name|BB_ID_NAME_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * requests for user input, and call the remote procedure to 	 * handle the operation 	 */
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* print user interface options */
name|printf
argument_list|(
literal|"\n\ Options:\n\ -------:\n\ 1) set test passed\n\ 2) set test failed\n\ 3) list servers successfully tested against\n\ 4) list servers not tested against\n\ 5) list clients successfully tested against\n\ 6) list clients not tested against\n\ 7) set/change password\n\ 8) exit\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Enter option: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|option
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|option
condition|)
block|{
comment|/*  		 * gets client and server identifier and 		 * calls bb_call_set_unset to handle the 		 * remote procedure call 		 */
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"Client Identifier: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
name|control_str
argument_list|,
name|bb_set_in
operator|.
name|client
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Server Identifier: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
name|control_str
argument_list|,
name|bb_set_in
operator|.
name|server
argument_list|)
expr_stmt|;
name|bb_call_set_unset
argument_list|(
name|BB_SET
argument_list|,
operator|&
name|bb_set_in
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"Client Identifier: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
name|control_str
argument_list|,
name|bb_set_in
operator|.
name|client
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Server Identifier: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
name|control_str
argument_list|,
name|bb_set_in
operator|.
name|server
argument_list|)
expr_stmt|;
name|bb_call_set_unset
argument_list|(
name|BB_UNSET
argument_list|,
operator|&
name|bb_set_in
argument_list|)
expr_stmt|;
break|break;
comment|/*  		 * gets client or server identifier and 		 * calls bb_list to handle the remote procedure 		 * call 		 */
case|case
literal|3
case|:
name|printf
argument_list|(
literal|"Client Identifier: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
name|control_str
argument_list|,
name|bb_list_in
operator|.
name|id
argument_list|)
expr_stmt|;
name|bb_list
argument_list|(
name|BB_ALIST
argument_list|,
operator|&
name|bb_list_in
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|printf
argument_list|(
literal|"Client Identifier: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
name|control_str
argument_list|,
name|bb_list_in
operator|.
name|id
argument_list|)
expr_stmt|;
name|bb_list
argument_list|(
name|BB_BLIST
argument_list|,
operator|&
name|bb_list_in
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|printf
argument_list|(
literal|"Server Identifier: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
name|control_str
argument_list|,
name|bb_list_in
operator|.
name|id
argument_list|)
expr_stmt|;
name|bb_list
argument_list|(
name|BB_CLIST
argument_list|,
operator|&
name|bb_list_in
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|printf
argument_list|(
literal|"Server Identifier: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
name|control_str
argument_list|,
name|bb_list_in
operator|.
name|id
argument_list|)
expr_stmt|;
name|bb_list
argument_list|(
name|BB_DLIST
argument_list|,
operator|&
name|bb_list_in
argument_list|)
expr_stmt|;
break|break;
comment|/* to change password */
case|case
literal|7
case|:
name|printf
argument_list|(
literal|"Identifier: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
name|control_str
argument_list|,
name|bb_passwd_in
operator|.
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|_bb_get_passwd
argument_list|(
operator|&
name|bb_passwd_in
argument_list|)
operator|==
name|TRUE
condition|)
name|bb_change_passwd
argument_list|(
operator|&
name|bb_passwd_in
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
return|return;
default|default:
name|printf
argument_list|(
literal|"invalid option\n\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  ******************************************************************************  *  * Function: _bb_get_passwd  *  * Description:  *	Prompt for old and new passwords, and verifies the new one.  *	Both passwords are then encrypted.  *	We use Unix DES with fixed salt key for the password  *      encryption for simplicity, you are welcome to use   *      your own algorithms.				     *  * Input:  *	bb_passwd_in_p -- input structure to RPC call  *  * Output:  *  * Returns:  *  * Side Effects:  *  * Notes:  *  ******************************************************************************  */
end_comment

begin_function
specifier|static
name|bool_t
name|_bb_get_passwd
parameter_list|(
name|bb_passwd_in_p
parameter_list|)
name|BB_passwd_in
modifier|*
name|bb_passwd_in_p
decl_stmt|;
block|{
name|char
name|buffer
index|[
name|BB_MAX_LINE_LEN
index|]
decl_stmt|;
comment|/* initialised password buffers */
name|memset
argument_list|(
name|bb_passwd_in_p
operator|->
name|old
argument_list|,
name|NUL
argument_list|,
name|BB_PASSWD_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|bb_passwd_in_p
operator|->
name|new
argument_list|,
name|NUL
argument_list|,
name|BB_PASSWD_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buffer
argument_list|,
name|NUL
argument_list|,
name|BB_MAX_LINE_LEN
argument_list|)
expr_stmt|;
comment|/* 	 * get old and new password, and verify the new password 	 */
name|strncpy
argument_list|(
name|bb_passwd_in_p
operator|->
name|old
argument_list|,
name|crypt
argument_list|(
name|getpass
argument_list|(
literal|"Old password:"
argument_list|)
argument_list|,
name|_bb_salt
argument_list|)
argument_list|,
name|BB_PASSWD_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|getpass
argument_list|(
literal|"New password:"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|buffer
argument_list|,
name|getpass
argument_list|(
literal|"Retype new password: "
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Mismatch - password unchanged.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
else|else
name|strncpy
argument_list|(
name|bb_passwd_in_p
operator|->
name|new
argument_list|,
name|crypt
argument_list|(
name|buffer
argument_list|,
name|_bb_salt
argument_list|)
argument_list|,
name|BB_PASSWD_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

end_unit


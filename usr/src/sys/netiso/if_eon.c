begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*********************************************************** 		Copyright IBM Corporation 1987                        All Rights Reserved  Permission to use, copy, modify, and distribute this software and its  documentation for any purpose and without fee is hereby granted,  provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in  supporting documentation, and that the name of IBM not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.    IBM DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL IBM BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  ******************************************************************/
end_comment

begin_comment
comment|/*  * ARGO Project, Computer Sciences Dept., University of Wisconsin - Madison  */
end_comment

begin_comment
comment|/*  * $Header: if_eon.c,v 1.4 88/07/19 15:53:59 hagens Exp $   * $Source: /usr/argo/sys/netiso/RCS/if_eon.c,v $   *	@(#)if_eon.c	7.5 (Berkeley) %G% *  *  *	EON rfc   *  Layer between IP and CLNL  *  * TODO:  * Put together a current rfc986 address format and get the right offset  * for the nsel  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: if_eon.c,v 1.4 88/07/19 15:53:59 hagens Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|EON
end_ifdef

begin_define
define|#
directive|define
name|NEON
value|1
end_define

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"systm.h"
end_include

begin_include
include|#
directive|include
file|"types.h"
end_include

begin_include
include|#
directive|include
file|"mbuf.h"
end_include

begin_include
include|#
directive|include
file|"buf.h"
end_include

begin_include
include|#
directive|include
file|"protosw.h"
end_include

begin_include
include|#
directive|include
file|"socket.h"
end_include

begin_include
include|#
directive|include
file|"ioctl.h"
end_include

begin_include
include|#
directive|include
file|"errno.h"
end_include

begin_include
include|#
directive|include
file|"types.h"
end_include

begin_include
include|#
directive|include
file|"../net/if.h"
end_include

begin_include
include|#
directive|include
file|"../net/if_types.h"
end_include

begin_include
include|#
directive|include
file|"../net/netisr.h"
end_include

begin_include
include|#
directive|include
file|"../net/route.h"
end_include

begin_include
include|#
directive|include
file|"machine/mtpr.h"
end_include

begin_include
include|#
directive|include
file|"../netinet/in.h"
end_include

begin_include
include|#
directive|include
file|"../netinet/in_systm.h"
end_include

begin_include
include|#
directive|include
file|"../netinet/ip.h"
end_include

begin_include
include|#
directive|include
file|"../netinet/ip_var.h"
end_include

begin_include
include|#
directive|include
file|"../netinet/if_ether.h"
end_include

begin_include
include|#
directive|include
file|"iso.h"
end_include

begin_include
include|#
directive|include
file|"iso_var.h"
end_include

begin_include
include|#
directive|include
file|"iso_snpac.h"
end_include

begin_decl_stmt
specifier|extern
name|struct
name|snpa_cache
name|all_es
decl_stmt|,
name|all_is
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|"argo_debug.h"
end_include

begin_include
include|#
directive|include
file|"iso_errno.h"
end_include

begin_include
include|#
directive|include
file|"eonvar.h"
end_include

begin_decl_stmt
specifier|extern
name|struct
name|timeval
name|time
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|EOK
value|0
end_define

begin_function_decl
name|int
name|eoninput
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|eonint
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|eonoutput
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|eonioctl
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|eonprobe
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|eonattach
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|eoninit
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|ip_output
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|ifnet
name|eonif
index|[
name|NEON
index|]
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FAKEIOCCDEV
end_ifdef

begin_include
include|#
directive|include
file|"machine/io.h"
end_include

begin_include
include|#
directive|include
file|"../machineio/ioccvar.h"
end_include

begin_define
define|#
directive|define
name|EON_FAKE_CSR
value|0
end_define

begin_decl_stmt
name|int
name|eon_fakeautoconf
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* need at least 2 ints */
end_comment

begin_decl_stmt
name|caddr_t
name|eonstd
index|[]
init|=
block|{
operator|(
name|caddr_t
operator|)
name|eon_fakeautoconf
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|iocc_device
modifier|*
name|eoninfo
index|[
name|NEON
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|iocc_driver
name|eondriver
init|=
block|{
name|eonprobe
block|,
comment|/* idr_probe */
literal|0
block|,
comment|/* idr_slave */
name|eonattach
block|,
comment|/* idr_attach */
literal|0
block|,
comment|/* idr_dgo */
name|eonstd
block|,
comment|/* idr_addr - list of standard addresses for device */
literal|"eon"
block|,
comment|/* idr_dname */
name|eoninfo
block|,
comment|/* idr_dinfo - backptrs to iodinit structs */
literal|0
block|,
comment|/* idr_mname - controller name */
literal|0
block|,
comment|/* idr_minfo -- backptrs to iominit structs */
name|eonint
block|,
comment|/* idr_intr - interrupt rtn */
literal|0
block|,
comment|/* idr_csr - offset to read/write csr */
name|EON_FAKE_CSR
block|,
comment|/* idr_chanrelse */
literal|0
block|,
comment|/* idr_flags */
block|}
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_struct
struct|struct
name|iocc_device
block|{
name|int
name|iod_unit
decl_stmt|;
block|}
name|bsd_iocc_fakeout
struct|;
end_struct

begin_macro
name|eonprotoinit
argument_list|()
end_macro

begin_block
block|{
operator|(
name|void
operator|)
name|eonprobe
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|eonattach
argument_list|(
operator|&
name|bsd_iocc_fakeout
argument_list|)
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|PROBE_OK
value|0;
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * entry in the EON address cache (list)  * (or pt-pt links list, however you view it)  */
end_comment

begin_struct
struct|struct
name|eon_centry
block|{
name|struct
name|qhdr
name|eonc_q_LINK
decl_stmt|;
define|#
directive|define
name|eonc_nextLINK
value|eonc_q_LINK.link
define|#
directive|define
name|eonc_prevLINK
value|eonc_q_LINK.flink
name|struct
name|qhdr
name|eonc_q_IS
decl_stmt|;
define|#
directive|define
name|eonc_nextIS
value|eonc_q_IS.link
define|#
directive|define
name|eonc_prevIS
value|eonc_q_IS.flink
name|struct
name|qhdr
name|eonc_q_ES
decl_stmt|;
define|#
directive|define
name|eonc_nextES
value|eonc_q_ES.link
define|#
directive|define
name|eonc_prevES
value|eonc_q_ES.flink
name|struct
name|in_addr
name|eonc_addr
decl_stmt|;
name|u_short
name|eonc_status
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* kinda like mtod() but for eon_centries */
end_comment

begin_define
define|#
directive|define
name|qtocentry
parameter_list|(
name|q
parameter_list|,
name|off
parameter_list|)
value|((struct eon_centry *)  (((caddr_t)(q)) - off))
end_define

begin_define
define|#
directive|define
name|centrytoq
parameter_list|(
name|c
parameter_list|,
name|off
parameter_list|)
value|((struct qhdr *)  (((caddr_t)(c)) + off))
end_define

begin_decl_stmt
name|struct
name|qhdr
name|eon_LINK_hdr
init|=
block|{
operator|(
expr|struct
name|qhdr
operator|*
operator|)
literal|0
block|,
operator|(
expr|struct
name|qhdr
operator|*
operator|)
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|qhdr
name|eon_IS_hdr
init|=
block|{
operator|(
expr|struct
name|qhdr
operator|*
operator|)
literal|0
block|,
operator|(
expr|struct
name|qhdr
operator|*
operator|)
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|qhdr
name|eon_ES_hdr
init|=
block|{
operator|(
expr|struct
name|qhdr
operator|*
operator|)
literal|0
block|,
operator|(
expr|struct
name|qhdr
operator|*
operator|)
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|qhdr
name|eon_FREE_hdr
init|=
block|{
operator|(
expr|struct
name|qhdr
operator|*
operator|)
literal|0
block|,
operator|(
expr|struct
name|qhdr
operator|*
operator|)
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|INITQ
parameter_list|(
name|q
parameter_list|)
value|(q)->rlink = (q)->link = (q)
end_define

begin_comment
comment|/*  * FUNCTION:		eon_dumpcache  *  * PURPOSE:			dump the cache beginning with the argument given  *  * RETURNS:			0  */
end_comment

begin_macro
name|eon_dumpcache
argument_list|(
argument|which
argument_list|)
end_macro

begin_decl_stmt
name|int
name|which
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|off
decl_stmt|;
specifier|register
name|struct
name|eon_centry
modifier|*
name|ent
decl_stmt|;
name|struct
name|qhdr
modifier|*
name|hdr
decl_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|E_FREE
case|:
name|printf
argument_list|(
literal|"FREE LIST\n"
argument_list|)
expr_stmt|;
name|off
operator|=
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_LINK
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|&
name|eon_FREE_hdr
expr_stmt|;
name|ent
operator|=
name|qtocentry
argument_list|(
name|hdr
operator|->
name|link
argument_list|,
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_LINK
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_ES
case|:
name|printf
argument_list|(
literal|"ES LIST\n"
argument_list|)
expr_stmt|;
name|off
operator|=
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_ES
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|&
name|eon_ES_hdr
expr_stmt|;
name|ent
operator|=
name|qtocentry
argument_list|(
name|hdr
operator|->
name|link
argument_list|,
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_ES
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_IS
case|:
name|printf
argument_list|(
literal|"IS LIST\n"
argument_list|)
expr_stmt|;
name|off
operator|=
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_IS
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|&
name|eon_IS_hdr
expr_stmt|;
name|ent
operator|=
name|qtocentry
argument_list|(
name|hdr
operator|->
name|link
argument_list|,
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_IS
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_LINK
case|:
name|printf
argument_list|(
literal|"LINK LIST\n"
argument_list|)
expr_stmt|;
name|off
operator|=
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_LINK
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|&
name|eon_LINK_hdr
expr_stmt|;
name|ent
operator|=
name|qtocentry
argument_list|(
name|hdr
operator|->
name|link
argument_list|,
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_LINK
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|hdr
operator|==
name|centrytoq
argument_list|(
name|ent
argument_list|,
name|off
argument_list|)
operator|->
name|link
condition|)
name|printf
argument_list|(
literal|"EMPTY\n"
argument_list|)
expr_stmt|;
else|else
while|while
condition|(
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"0x%x: %d.%d.%d.%d, %s %s\n"
argument_list|,
name|ent
argument_list|,
operator|(
name|ent
operator|->
name|eonc_addr
operator|.
name|s_addr
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|ent
operator|->
name|eonc_addr
operator|.
name|s_addr
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|ent
operator|->
name|eonc_addr
operator|.
name|s_addr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|ent
operator|->
name|eonc_addr
operator|.
name|s_addr
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
operator|(
name|ent
operator|->
name|eonc_status
operator|&
name|EON_ESLINK_UP
operator|)
condition|?
literal|"ES^"
else|:
operator|(
name|ent
operator|->
name|eonc_status
operator|&
name|EON_ESLINK_DOWN
operator|)
condition|?
literal|"es*"
else|:
literal|"   "
operator|)
argument_list|,
operator|(
operator|(
name|ent
operator|->
name|eonc_status
operator|&
name|EON_ISLINK_UP
operator|)
condition|?
literal|"IS^"
else|:
operator|(
name|ent
operator|->
name|eonc_status
operator|&
name|EON_ISLINK_DOWN
operator|)
condition|?
literal|"is*"
else|:
literal|"   "
operator|)
argument_list|)
expr_stmt|;
name|dump_buf
argument_list|(
name|ent
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eon_centry
argument_list|)
argument_list|)
expr_stmt|;
block|{
comment|/* ent = ent.next: */
specifier|register
name|struct
name|qhdr
modifier|*
name|q
decl_stmt|;
name|q
operator|=
name|centrytoq
argument_list|(
name|ent
argument_list|,
name|off
argument_list|)
operator|->
name|link
expr_stmt|;
if|if
condition|(
name|q
operator|==
name|hdr
condition|)
break|break;
if|if
condition|(
name|q
operator|==
operator|(
expr|struct
name|qhdr
operator|*
operator|)
literal|0
condition|)
comment|/* panic */
block|{
name|printf
argument_list|(
literal|"eon0: BAD Q HDR or CENTRY! q 0x%x ent 0x%x off 0x%x\n"
argument_list|,
name|q
argument_list|,
name|ent
argument_list|,
name|off
argument_list|)
expr_stmt|;
break|break;
block|}
name|ent
operator|=
name|qtocentry
argument_list|(
name|q
argument_list|,
name|off
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  * FUNCTION:		eon_initcache  *  * PURPOSE:			allocs a bunch of free cache entries  *  * RETURNS:			0  */
end_comment

begin_macro
name|eon_initcache
argument_list|()
end_macro

begin_block
block|{
specifier|static
name|struct
name|eon_centry
name|eoncache
index|[
name|EON_CACHESIZE
index|]
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|struct
name|eon_centry
modifier|*
name|ent
decl_stmt|;
name|bzero
argument_list|(
name|eoncache
argument_list|,
name|EON_CACHESIZE
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|eon_centry
argument_list|)
argument_list|)
expr_stmt|;
name|INITQ
argument_list|(
operator|&
name|eon_FREE_hdr
argument_list|)
expr_stmt|;
name|INITQ
argument_list|(
operator|&
name|eon_LINK_hdr
argument_list|)
expr_stmt|;
name|INITQ
argument_list|(
operator|&
name|eon_IS_hdr
argument_list|)
expr_stmt|;
name|INITQ
argument_list|(
operator|&
name|eon_ES_hdr
argument_list|)
expr_stmt|;
name|ent
operator|=
name|eoncache
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EON_CACHESIZE
condition|;
name|i
operator|++
operator|,
name|ent
operator|++
control|)
block|{
name|_insque
argument_list|(
name|centrytoq
argument_list|(
name|ent
argument_list|,
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_LINK
argument_list|)
argument_list|)
argument_list|,
operator|&
name|eon_FREE_hdr
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"eon0: cache initialized\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * FUNCTION:		eonprobe  *  * PURPOSE:			filler for device configuration  *  * RETURNS:			PROBE_OK  */
end_comment

begin_decl_stmt
name|int
name|int_level
decl_stmt|,
name|int_irq
decl_stmt|;
end_decl_stmt

begin_macro
name|eonprobe
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|int
name|int_level
decl_stmt|,
name|int_irq
decl_stmt|;
name|printf
argument_list|(
literal|"eonprobe() \n"
argument_list|)
expr_stmt|;
name|int_level
operator|=
name|int_irq
operator|=
literal|0x3
expr_stmt|;
comment|/* pick something - anything but -1 */
return|return
name|PROBE_OK
return|;
block|}
end_block

begin_comment
comment|/*  * FUNCTION:		eonattach  *  * PURPOSE:			autoconf attach routine  *  * RETURNS:			void  */
end_comment

begin_expr_stmt
name|eonattach
argument_list|(
name|iod
argument_list|)
specifier|register
expr|struct
name|iocc_device
operator|*
name|iod
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|eonif
index|[
name|iod
operator|->
name|iod_unit
index|]
decl_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonattach()\n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|ifp
operator|->
name|if_unit
init|=
name|iod
operator|->
name|iod_unit
decl_stmt|;
name|ifp
operator|->
name|if_name
operator|=
literal|"eon"
expr_stmt|;
name|ifp
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
comment|/* since everything will go out over ether or token ring */
name|ifp
operator|->
name|if_init
operator|=
name|eoninit
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|eonioctl
expr_stmt|;
name|ifp
operator|->
name|if_output
operator|=
name|eonoutput
expr_stmt|;
name|ifp
operator|->
name|if_type
operator|=
name|IFT_EON
expr_stmt|;
name|ifp
operator|->
name|if_addrlen
operator|=
literal|5
expr_stmt|;
name|ifp
operator|->
name|if_hdrlen
operator|=
name|EONIPLEN
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
expr_stmt|;
name|if_attach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonattach()\n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|eon_initcache
parameter_list|()
function_decl|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eon%d: attached\n"
argument_list|,
name|iod
operator|->
name|iod_unit
argument_list|)
expr_stmt|;
name|ENDDEBUG
block|}
end_block

begin_function
specifier|static
name|struct
name|eon_centry
modifier|*
name|find_oldent
parameter_list|(
name|ea
parameter_list|)
name|struct
name|sockaddr_eon
modifier|*
name|ea
decl_stmt|;
block|{
specifier|register
name|int
name|offset
init|=
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_LINK
argument_list|)
decl_stmt|;
specifier|register
name|struct
name|eon_centry
modifier|*
name|ent
decl_stmt|,
modifier|*
name|oent
decl_stmt|;
name|oent
operator|=
name|ent
operator|=
name|qtocentry
argument_list|(
name|eon_LINK_hdr
operator|.
name|link
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eon: find_oldent() ipaddr: %d.%d.%d.%d\n"
argument_list|,
operator|(
name|ea
operator|->
name|seon_ipaddr
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|ea
operator|->
name|seon_ipaddr
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|ea
operator|->
name|seon_ipaddr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|ea
operator|->
name|seon_ipaddr
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|ENDDEBUG
do|do
block|{
if|if
condition|(
name|ent
operator|->
name|eonc_addr
operator|.
name|s_addr
operator|==
name|ea
operator|->
name|seon_ipaddr
condition|)
return|return
name|ent
return|;
name|ent
operator|=
name|qtocentry
argument_list|(
name|ent
operator|->
name|eonc_nextLINK
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ent
operator|!=
name|oent
condition|)
do|;
return|return
operator|(
expr|struct
name|eon_centry
operator|*
operator|)
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * FUNCTION:		eonioctl  *  * PURPOSE:			io controls - ifconfig  *				need commands to   *					link-UP (core addr) (flags: ES, IS)  *					link-DOWN (core addr) (flags: ES, IS)  *				must be callable from kernel or user  *  * RETURNS:			nothing  */
end_comment

begin_expr_stmt
name|eonioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
specifier|register
expr|struct
name|ifnet
operator|*
name|ifp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|cmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|iso_ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|iso_ifreq
operator|*
operator|)
name|data
decl_stmt|;
specifier|register
name|struct
name|sockaddr_eon
modifier|*
name|eoa
init|=
operator|(
expr|struct
name|sockaddr_eon
operator|*
operator|)
operator|&
operator|(
name|ifr
operator|->
name|ifr_Addr
operator|)
decl_stmt|;
specifier|register
name|int
name|s
init|=
name|splimp
argument_list|()
decl_stmt|;
specifier|register
name|int
name|error
init|=
literal|0
decl_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonioctl (cmd 0x%x) \n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ENDDEBUG
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSEONCORE
case|:
block|{
comment|/* add pt-pt link to the set of core addrs */
specifier|register
name|struct
name|eon_centry
modifier|*
name|ent
decl_stmt|,
modifier|*
name|oldent
decl_stmt|;
specifier|register
name|u_short
name|which
decl_stmt|;
comment|/* "which" tells which lists to put these guys in - don't  			 * want to insert something in a list if it's already there 			 */
define|#
directive|define
name|LEGIT_EONADDR
parameter_list|(
name|a
parameter_list|)
define|\
value|((a->seon_family == AF_ISO)&& (a->seon_afi == AFI_RFC986)&&\ 	(a->seon_idi[0] == 0)&& (a->seon_idi[1] == 6) \&& (a->seon_vers == EON_986_VERSION)&& (a->seon_adrlen == 0x14))
if|if
condition|(
operator|!
name|LEGIT_EONADDR
argument_list|(
name|eoa
argument_list|)
condition|)
block|{
name|error
operator|=
name|EADDRNOTAVAIL
expr_stmt|;
break|break;
block|}
name|oldent
operator|=
name|find_oldent
argument_list|(
name|eoa
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonioctl legit seon_status 0x%x oldent %s\n"
argument_list|,
name|eoa
operator|->
name|seon_status
argument_list|,
name|oldent
condition|?
literal|"found"
else|:
literal|"not found"
argument_list|)
expr_stmt|;
name|ENDDEBUG
if|if
condition|(
name|eoa
operator|->
name|seon_status
operator|&
name|UPBITS
condition|)
block|{
if|if
condition|(
operator|!
name|oldent
condition|)
block|{
comment|/* doesn't exist - need to create one */
if|if
condition|(
name|eon_FREE_hdr
operator|.
name|link
operator|==
name|eon_FREE_hdr
operator|.
name|rlink
condition|)
return|return
name|ENOBUFS
return|;
name|ent
operator|=
name|qtocentry
argument_list|(
name|eon_FREE_hdr
operator|.
name|link
argument_list|,
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_LINK
argument_list|)
argument_list|)
expr_stmt|;
name|remque
argument_list|(
operator|&
operator|(
name|ent
operator|->
name|eonc_q_LINK
operator|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|eonc_addr
operator|.
name|s_addr
operator|=
name|eoa
operator|->
name|seon_ipaddr
expr_stmt|;
name|insque
argument_list|(
operator|&
operator|(
name|ent
operator|->
name|eonc_q_LINK
operator|)
argument_list|,
operator|(
operator|&
name|eon_LINK_hdr
operator|)
argument_list|)
expr_stmt|;
name|oldent
operator|=
name|ent
expr_stmt|;
block|}
name|which
operator|=
operator|(
name|eoa
operator|->
name|seon_status
operator|^
name|oldent
operator|->
name|eonc_status
operator|)
operator|&
name|eoa
operator|->
name|seon_status
operator|&
name|UPBITS
expr_stmt|;
name|oldent
operator|->
name|eonc_status
operator||=
operator|(
name|eoa
operator|->
name|seon_status
operator|&
name|UPBITS
operator|)
expr_stmt|;
if|if
condition|(
name|which
operator|&
name|EON_ESLINK_UP
condition|)
name|insque
argument_list|(
operator|&
name|oldent
operator|->
name|eonc_q_ES
argument_list|,
operator|(
operator|&
name|eon_ES_hdr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|which
operator|&
name|EON_ISLINK_UP
condition|)
name|insque
argument_list|(
operator|&
name|oldent
operator|->
name|eonc_q_IS
argument_list|,
operator|(
operator|&
name|eon_IS_hdr
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eoa
operator|->
name|seon_status
operator|&
name|DOWNBITS
condition|)
block|{
if|if
condition|(
operator|!
name|oldent
condition|)
block|{
return|return
name|ENOENT
return|;
comment|/* no such entry */
block|}
name|which
operator|=
operator|(
name|eoa
operator|->
name|seon_status
operator|^
name|oldent
operator|->
name|eonc_status
operator|)
operator|&
name|eoa
operator|->
name|seon_status
operator|&
name|DOWNBITS
expr_stmt|;
name|oldent
operator|->
name|eonc_status
operator||=
operator|(
name|eoa
operator|->
name|seon_status
operator|&
name|DOWNBITS
operator|)
expr_stmt|;
if|if
condition|(
name|which
operator|&
name|EON_ESLINK_DOWN
condition|)
name|remque
argument_list|(
operator|&
operator|(
name|oldent
operator|->
name|eonc_q_ES
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|which
operator|&
name|EON_ISLINK_DOWN
condition|)
name|remque
argument_list|(
operator|&
operator|(
name|oldent
operator|->
name|eonc_q_IS
operator|)
argument_list|)
expr_stmt|;
block|}
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"at end status 0x%x\n"
argument_list|,
name|oldent
operator|->
name|eonc_status
argument_list|)
expr_stmt|;
name|ENDDEBUG
break|break;
block|}
case|case
name|SIOCGEONCORE
case|:
block|{
specifier|register
name|struct
name|eon_centry
modifier|*
name|oldent
decl_stmt|;
name|oldent
operator|=
name|find_oldent
argument_list|(
name|eoa
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldent
operator|==
operator|(
expr|struct
name|eon_centry
operator|*
operator|)
literal|0
condition|)
name|error
operator|=
name|EADDRNOTAVAIL
expr_stmt|;
else|else
name|eoa
operator|->
name|seon_status
operator|=
name|oldent
operator|->
name|eonc_status
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFADDR
case|:
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_UP
expr_stmt|;
break|break;
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
operator|==
literal|0
operator|&&
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
block|{
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_RUNNING
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|&&
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
operator|)
operator|==
literal|0
condition|)
name|eoninit
argument_list|(
name|ifp
operator|->
name|if_unit
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * FUNCTION:		eoninit  *  * PURPOSE:			initialization  *  * RETURNS:			nothing  */
end_comment

begin_macro
name|eoninit
argument_list|(
argument|unit
argument_list|)
end_macro

begin_decl_stmt
name|int
name|unit
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"eon driver-init eon%d\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * FUNCTION:		eonint  *  * PURPOSE:			filler for device configuration  *  * RETURNS:			nothing  *  * NOTES:			*should* never get called - for debugging it's here  */
end_comment

begin_macro
name|eonint
argument_list|()
end_macro

begin_block
block|{
comment|/* silent - so no more stray interrupt messages from the aed! yay 	printf("eonint() called - BOGUS INTERRUPT\n"); 	*/
block|}
end_block

begin_comment
comment|/*  * FUNCTION:		eonoutput  *  * PURPOSE:			prepend an eon header and hand to IP  * ARGUMENTS:	 	(ifp) is points to the ifnet structure for this unit/device  *					(m)  is an mbuf *, *m is a CLNL packet  *					(dst) is a destination address - have to interp. as  *					multicast or broadcast or real address.  *  * RETURNS:			unix error code  *  * NOTES:			  *  */
end_comment

begin_macro
name|eonoutput
argument_list|(
argument|ifp
argument_list|,
argument|morig
argument_list|,
argument|dst
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|mbuf
modifier|*
name|morig
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* packet */
end_comment

begin_decl_stmt
name|struct
name|sockaddr_iso
modifier|*
name|dst
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination addr */
end_comment

begin_block
block|{
name|int
name|s
decl_stmt|;
name|struct
name|eon_hdr
modifier|*
name|eonhdr
decl_stmt|;
name|struct
name|ip
modifier|*
name|iphdr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mh
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
specifier|register
name|int
name|datalen
decl_stmt|;
name|caddr_t
name|dstipaddrloc
decl_stmt|;
name|int
name|single
init|=
literal|0
decl_stmt|,
name|class
decl_stmt|,
name|qoffset
init|=
literal|0
decl_stmt|,
name|snpalen
decl_stmt|;
specifier|register
name|struct
name|eon_centry
modifier|*
name|ent
decl_stmt|;
specifier|register
name|struct
name|sockaddr_eon
modifier|*
name|eoa
decl_stmt|;
name|struct
name|qhdr
modifier|*
name|q
decl_stmt|;
name|char
name|edst
index|[
literal|6
index|]
decl_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput \n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|ifp
operator|->
name|if_lastchange
init|=
name|time
decl_stmt|;
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|siso_family
operator|!=
name|AF_ISO
condition|)
block|{
name|einval
label|:
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|flush
goto|;
block|}
if|if
condition|(
operator|(
name|morig
operator|->
name|m_flags
operator|&
name|M_PKTHDR
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"eon: got non headered packet\n"
argument_list|)
expr_stmt|;
goto|goto
name|einval
goto|;
block|}
name|eoa
operator|=
operator|(
expr|struct
name|sockaddr_eon
operator|*
operator|)
name|dst
expr_stmt|;
if|if
condition|(
name|LEGIT_EONADDR
argument_list|(
name|eoa
argument_list|)
condition|)
block|{
name|class
operator|=
name|eoa
operator|->
name|seon_protoid
expr_stmt|;
name|dstipaddrloc
operator|=
operator|(
name|caddr_t
operator|)
operator|&
operator|(
name|eoa
operator|->
name|seon_ipaddr
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|eoa
operator|->
name|seon_afi
operator|==
name|AFI_SNA
condition|)
block|{
name|dstipaddrloc
operator|=
operator|(
name|caddr_t
operator|)
operator|&
operator|(
name|dst
operator|->
name|siso_data
index|[
literal|1
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|siso_nlen
operator|==
literal|6
condition|)
block|{
name|class
operator|=
name|dst
operator|->
name|siso_data
index|[
literal|5
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dst
operator|->
name|siso_nlen
operator|==
literal|7
condition|)
block|{
if|if
condition|(
name|bcmp
argument_list|(
name|dstipaddrloc
argument_list|,
name|all_is
operator|.
name|sc_snpa
argument_list|,
literal|6
argument_list|)
condition|)
name|class
operator|=
name|EON_MULTICAST_ES
expr_stmt|;
elseif|else
if|if
condition|(
name|bcmp
argument_list|(
name|dstipaddrloc
argument_list|,
name|all_es
operator|.
name|sc_snpa
argument_list|,
literal|6
argument_list|)
condition|)
name|class
operator|=
name|EON_MULTICAST_IS
expr_stmt|;
else|else
goto|goto
name|einval
goto|;
block|}
else|else
goto|goto
name|einval
goto|;
block|}
elseif|else
if|if
condition|(
literal|0
operator|==
name|iso_snparesolve
argument_list|(
name|ifp
argument_list|,
name|dst
argument_list|,
name|edst
argument_list|,
operator|&
name|snpalen
argument_list|)
condition|)
block|{
name|dstipaddrloc
operator|=
operator|(
name|caddr_t
operator|)
name|edst
expr_stmt|;
name|class
operator|=
name|edst
index|[
literal|4
index|]
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|flush
goto|;
block|}
switch|switch
condition|(
name|class
condition|)
block|{
case|case
name|EON_NORMAL_ADDR
case|:
name|IncStat
argument_list|(
name|es_out_normal
argument_list|)
expr_stmt|;
name|single
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|EON_BROADCAST
case|:
name|IncStat
argument_list|(
name|es_out_broad
argument_list|)
expr_stmt|;
if|if
condition|(
name|eon_LINK_hdr
operator|.
name|link
operator|==
name|eon_LINK_hdr
operator|.
name|rlink
condition|)
block|{
name|error
operator|=
name|EADDRNOTAVAIL
expr_stmt|;
block|}
else|else
block|{
name|qoffset
operator|=
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_LINK
argument_list|)
expr_stmt|;
name|ent
operator|=
name|qtocentry
argument_list|(
name|eon_LINK_hdr
operator|.
name|link
argument_list|,
name|qoffset
argument_list|)
expr_stmt|;
name|dstipaddrloc
operator|=
operator|(
name|caddr_t
operator|)
operator|&
operator|(
name|ent
operator|->
name|eonc_addr
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|EON_MULTICAST_ES
case|:
name|IncStat
argument_list|(
name|es_out_multi_es
argument_list|)
expr_stmt|;
if|if
condition|(
name|eon_ES_hdr
operator|.
name|link
operator|==
name|eon_ES_hdr
operator|.
name|rlink
condition|)
block|{
name|error
operator|=
name|EADDRNOTAVAIL
expr_stmt|;
block|}
else|else
block|{
name|qoffset
operator|=
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_ES
argument_list|)
expr_stmt|;
name|ent
operator|=
name|qtocentry
argument_list|(
name|eon_ES_hdr
operator|.
name|link
argument_list|,
name|qoffset
argument_list|)
expr_stmt|;
name|dstipaddrloc
operator|=
operator|(
name|caddr_t
operator|)
operator|&
operator|(
name|ent
operator|->
name|eonc_addr
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|EON_MULTICAST_IS
case|:
name|IncStat
argument_list|(
name|es_out_multi_is
argument_list|)
expr_stmt|;
if|if
condition|(
name|eon_IS_hdr
operator|.
name|link
operator|==
name|eon_IS_hdr
operator|.
name|rlink
condition|)
block|{
name|error
operator|=
name|EADDRNOTAVAIL
expr_stmt|;
block|}
else|else
block|{
name|qoffset
operator|=
name|_offsetof
argument_list|(
expr|struct
name|eon_centry
argument_list|,
name|eonc_q_LINK
argument_list|)
expr_stmt|;
name|ent
operator|=
name|qtocentry
argument_list|(
name|eon_IS_hdr
operator|.
name|link
argument_list|,
name|qoffset
argument_list|)
expr_stmt|;
name|dstipaddrloc
operator|=
operator|(
name|caddr_t
operator|)
operator|&
operator|(
name|ent
operator|->
name|eonc_addr
operator|)
expr_stmt|;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"bad class value; treated as EON_NORMAL_ADDR\n"
argument_list|)
expr_stmt|;
name|class
operator|=
name|EON_NORMAL_ADDR
expr_stmt|;
name|single
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|error
condition|)
goto|goto
name|done
goto|;
comment|/* get data length -- needed later */
name|datalen
operator|=
name|morig
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput : m_datalen returns %d\n"
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|MGETHDR
parameter_list|(
name|mh
parameter_list|,
name|M_DONTWAIT
parameter_list|,
name|MT_HEADER
parameter_list|)
function_decl|;
if|if
condition|(
name|mh
operator|==
operator|(
expr|struct
name|mbuf
operator|*
operator|)
literal|0
condition|)
goto|goto
name|done
goto|;
comment|/* put an eon_hdr in the buffer, prepended by an ip header */
name|mh
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|eon_hdr
argument_list|)
expr_stmt|;
name|MH_ALIGN
argument_list|(
name|mh
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eon_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|mh
operator|->
name|m_next
operator|=
name|morig
expr_stmt|;
name|eonhdr
operator|=
name|mtod
argument_list|(
name|mh
argument_list|,
expr|struct
name|eon_hdr
operator|*
argument_list|)
expr_stmt|;
name|eonhdr
operator|->
name|eonh_class
operator|=
name|class
expr_stmt|;
name|eonhdr
operator|->
name|eonh_vers
operator|=
name|EON_VERSION
expr_stmt|;
name|eonhdr
operator|->
name|eonh_csum
operator|=
literal|0
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput : gen csum (0x%x, offset %d, datalen %d)\n"
argument_list|,
name|mh
argument_list|,
name|_offsetof
argument_list|(
expr|struct
name|eon_hdr
argument_list|,
name|eonh_csum
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eon_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|iso_gen_csum
argument_list|(
name|mh
argument_list|,
name|_offsetof
argument_list|(
expr|struct
name|eon_hdr
argument_list|,
name|eonh_csum
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eon_hdr
argument_list|)
argument_list|)
decl_stmt|;
name|mh
operator|->
name|m_data
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|iphdr
argument_list|)
expr_stmt|;
name|mh
operator|->
name|m_len
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|iphdr
argument_list|)
expr_stmt|;
name|iphdr
operator|=
name|mtod
argument_list|(
name|mh
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|iphdr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|iphdr
argument_list|)
argument_list|)
expr_stmt|;
name|iphdr
operator|->
name|ip_p
operator|=
name|IPPROTO_EON
expr_stmt|;
name|ifp
operator|->
name|if_obytes
operator|+=
operator|(
name|iphdr
operator|->
name|ip_len
operator|=
call|(
name|u_short
call|)
argument_list|(
name|mh
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|EONIPLEN
operator|+
name|datalen
argument_list|)
operator|)
expr_stmt|;
name|iphdr
operator|->
name|ip_ttl
operator|=
name|MAXTTL
expr_stmt|;
name|iphdr
operator|->
name|ip_src
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput : after gen csum: ip_len %d/0x%x\n"
argument_list|,
name|mh
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|mh
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|morig
init|=
name|mh
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|!
name|single
condition|)
block|{
comment|/* make a copy to send */
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput : m_copy (0x%x, 0, 0x%x)\n"
argument_list|,
name|morig
argument_list|,
name|iphdr
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|ENDDEBUG
if|if
condition|(
operator|(
operator|(
name|mh
operator|=
name|m_copy
argument_list|(
name|morig
argument_list|,
literal|0
argument_list|,
name|morig
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
operator|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|mh
operator|=
name|m_pullup
argument_list|(
name|mh
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|)
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|iphdr
operator|=
name|mtod
argument_list|(
name|mh
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
block|}
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput : bcopy 0x%x to 0x%x length %d\n"
argument_list|,
name|dstipaddrloc
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
operator|(
name|iphdr
operator|->
name|ip_dst
operator|.
name|s_addr
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|iphdr
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|bcopy
argument_list|(
name|dstipaddrloc
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
operator|(
name|iphdr
operator|->
name|ip_dst
operator|.
name|s_addr
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|iphdr
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|)
argument_list|)
decl_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput : dst ip addr : %d.%d.%d.%d"
argument_list|,
operator|(
name|iphdr
operator|->
name|ip_dst
operator|.
name|s_addr
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|iphdr
operator|->
name|ip_dst
operator|.
name|s_addr
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|iphdr
operator|->
name|ip_dst
operator|.
name|s_addr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|iphdr
operator|->
name|ip_dst
operator|.
name|s_addr
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|IFDEBUG
parameter_list|(
name|D_EON
parameter_list|)
function_decl|printf
parameter_list|(
function_decl|"eonoutput ip_output : eon header:\n"
block|)
empty_stmt|;
name|dump_buf
argument_list|(
name|eonhdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eon_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ip header:\n"
argument_list|)
expr_stmt|;
name|dump_buf
argument_list|(
name|iphdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|IncStat
parameter_list|(
name|es_ipout
parameter_list|)
function_decl|;
if|if
condition|(
name|error
operator|=
name|ip_output
argument_list|(
name|mh
argument_list|,
operator|(
expr|struct
name|mbuf
operator|*
operator|)
literal|0
argument_list|,
operator|(
expr|struct
name|route
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
break|break;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput ip_output returns 0x%x; single %d\n"
argument_list|,
name|error
argument_list|,
name|single
argument_list|)
expr_stmt|;
name|ENDDEBUG
if|if
condition|(
name|single
condition|)
break|break;
name|q
operator|=
name|centrytoq
argument_list|(
name|ent
argument_list|,
name|qoffset
argument_list|)
operator|->
name|link
expr_stmt|;
if|if
condition|(
name|q
operator|==
operator|(
expr|struct
name|qhdr
operator|*
operator|)
literal|0
condition|)
break|break;
name|ent
operator|=
name|qtocentry
argument_list|(
name|q
argument_list|,
name|qoffset
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput : get next entry: 0x%x\n"
argument_list|,
name|ent
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|dstipaddrloc
init|=
operator|(
name|caddr_t
operator|)
operator|&
operator|(
name|ent
operator|->
name|eonc_addr
operator|)
decl_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput : dump of eon_centry 0x%x:\n"
argument_list|,
name|ent
argument_list|)
expr_stmt|;
name|dump_buf
argument_list|(
name|ent
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eon_centry
argument_list|)
argument_list|)
expr_stmt|;
name|ENDDEBUG
block|}
end_block

begin_label
name|done
label|:
end_label

begin_if
if|if
condition|(
operator|!
name|single
condition|)
block|{
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonoutput : freeing morig 0x%x\n"
argument_list|,
name|morig
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|flush
range|:
name|m_freem
argument_list|(
name|morig
argument_list|)
decl_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|error
condition|)
block|{
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|--
expr_stmt|;
name|ifp
operator|->
name|if_obytes
operator|-=
name|datalen
operator|+
name|EONIPLEN
expr_stmt|;
block|}
end_if

begin_return
return|return
name|error
return|;
end_return

begin_expr_stmt
unit|}  eoninput
operator|(
name|m
operator|,
name|iphlen
operator|)
specifier|register
expr|struct
name|mbuf
operator|*
name|m
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|iphlen
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|eon_hdr
modifier|*
name|eonhdr
decl_stmt|;
specifier|register
name|struct
name|ip
modifier|*
name|iphdr
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|eonifp
decl_stmt|;
name|int
name|s
decl_stmt|;
name|eonifp
operator|=
operator|&
name|eonif
index|[
literal|0
index|]
expr_stmt|;
comment|/* kludge - really want to give CLNP 						* the ifp for eon, not for the real device 						*/
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eoninput() 0x%x m_data 0x%x m_len 0x%x dequeued\n"
argument_list|,
name|m
argument_list|,
name|m
condition|?
name|m
operator|->
name|m_data
else|:
literal|0
argument_list|,
name|m
condition|?
name|m
operator|->
name|m_len
else|:
literal|0
argument_list|)
expr_stmt|;
name|ENDDEBUG
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|iphlen
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
condition|)
name|ip_stripoptions
argument_list|(
name|m
argument_list|,
operator|(
expr|struct
name|mbuf
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
name|EONIPLEN
condition|)
block|{
if|if
condition|(
operator|(
name|m
operator|=
name|m_pullup
argument_list|(
name|m
argument_list|,
name|EONIPLEN
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|IncStat
argument_list|(
name|es_badhdr
argument_list|)
expr_stmt|;
name|drop
label|:
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eoninput: DROP \n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|eonifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|eonif
operator|->
name|if_ibytes
operator|+=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|eonif
operator|->
name|if_lastchange
operator|=
name|time
expr_stmt|;
name|iphdr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
comment|/* do a few checks for debugging */
if|if
condition|(
name|iphdr
operator|->
name|ip_p
operator|!=
name|IPPROTO_EON
condition|)
block|{
name|IncStat
argument_list|(
name|es_badhdr
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* temporarily drop ip header from the mbuf */
name|m
operator|->
name|m_data
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
expr_stmt|;
name|eonhdr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|eon_hdr
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|iso_check_csum
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eon_hdr
argument_list|)
argument_list|)
operator|!=
name|EOK
condition|)
block|{
name|IncStat
argument_list|(
name|es_badcsum
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|m
operator|->
name|m_data
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eoninput csum ok class 0x%x\n"
argument_list|,
name|eonhdr
operator|->
name|eonh_class
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"eoninput: eon header:\n"
argument_list|)
expr_stmt|;
name|dump_buf
argument_list|(
name|eonhdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eon_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|ENDDEBUG
comment|/* checks for debugging */
if|if
condition|(
name|eonhdr
operator|->
name|eonh_vers
operator|!=
name|EON_VERSION
condition|)
block|{
name|IncStat
argument_list|(
name|es_badhdr
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|m
operator|->
name|m_flags
operator|&=
operator|~
operator|(
name|M_BCAST
operator||
name|M_MCAST
operator|)
expr_stmt|;
switch|switch
condition|(
name|eonhdr
operator|->
name|eonh_class
condition|)
block|{
case|case
name|EON_BROADCAST
case|:
name|IncStat
argument_list|(
name|es_in_broad
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_BCAST
expr_stmt|;
break|break;
case|case
name|EON_NORMAL_ADDR
case|:
name|IncStat
argument_list|(
name|es_in_normal
argument_list|)
expr_stmt|;
break|break;
case|case
name|EON_MULTICAST_ES
case|:
name|IncStat
argument_list|(
name|es_in_multi_es
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_MCAST
expr_stmt|;
break|break;
case|case
name|EON_MULTICAST_IS
case|:
name|IncStat
argument_list|(
name|es_in_multi_is
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_MCAST
expr_stmt|;
break|break;
block|}
name|eonifp
operator|->
name|if_ipackets
operator|++
expr_stmt|;
block|{
comment|/* put it on the CLNP queue and set soft interrupt */
name|struct
name|ifqueue
modifier|*
name|ifq
decl_stmt|;
specifier|extern
name|struct
name|ifqueue
name|clnlintrq
decl_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|eonifp
expr_stmt|;
comment|/* KLUDGE */
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eoninput to clnl IFQ\n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|ifq
init|=
operator|&
name|clnlintrq
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
if|if
condition|(
name|IF_QFULL
argument_list|(
name|ifq
argument_list|)
condition|)
block|{
name|IF_DROP
argument_list|(
name|ifq
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|eonifp
operator|->
name|if_iqdrops
operator|++
expr_stmt|;
name|eonifp
operator|->
name|if_ipackets
operator|--
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|IF_ENQUEUE
argument_list|(
name|ifq
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"0x%x enqueued on clnp Q: m_len 0x%x m_type 0x%x m_data 0x%x\n"
argument_list|,
name|m
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|m
operator|->
name|m_type
argument_list|,
name|m
operator|->
name|m_data
argument_list|)
expr_stmt|;
name|dump_buf
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
name|m
operator|->
name|m_len
argument_list|)
expr_stmt|;
name|ENDDEBUG
name|schednetisr
parameter_list|(
name|NETISR_ISO
parameter_list|)
function_decl|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|int
name|eonctlinput
parameter_list|(
name|cmd
parameter_list|,
name|sin
parameter_list|)
name|int
name|cmd
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
block|{
specifier|extern
name|u_char
name|inetctlerrmap
index|[]
decl_stmt|;
name|IFDEBUG
argument_list|(
argument|D_EON
argument_list|)
name|printf
argument_list|(
literal|"eonctlinput: cmd 0x%x addr: "
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|dump_isoaddr
argument_list|(
name|sin
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|ENDDEBUG
if|if
condition|(
name|cmd
operator|<
literal|0
operator|||
name|cmd
operator|>
name|PRC_NCMDS
condition|)
return|return
literal|0
return|;
name|IncStat
argument_list|(
name|es_icmp
index|[
name|cmd
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|PRC_QUENCH
case|:
case|case
name|PRC_QUENCH2
case|:
comment|/* TODO: set the dec bit */
break|break;
case|case
name|PRC_TIMXCEED_REASS
case|:
case|case
name|PRC_ROUTEDEAD
case|:
case|case
name|PRC_HOSTUNREACH
case|:
case|case
name|PRC_UNREACH_NET
case|:
case|case
name|PRC_IFDOWN
case|:
case|case
name|PRC_UNREACH_HOST
case|:
case|case
name|PRC_HOSTDEAD
case|:
case|case
name|PRC_TIMXCEED_INTRANS
case|:
comment|/* TODO: mark the link down */
break|break;
case|case
name|PRC_UNREACH_PROTOCOL
case|:
case|case
name|PRC_UNREACH_PORT
case|:
case|case
name|PRC_UNREACH_NEEDFRAG
case|:
case|case
name|PRC_UNREACH_SRCFAIL
case|:
case|case
name|PRC_REDIRECT_NET
case|:
case|case
name|PRC_REDIRECT_HOST
case|:
case|case
name|PRC_REDIRECT_TOSNET
case|:
case|case
name|PRC_REDIRECT_TOSHOST
case|:
case|case
name|PRC_MSGSIZE
case|:
case|case
name|PRC_PARAMPROB
case|:
name|printf
argument_list|(
literal|"eonctlinput: ICMP cmd 0x%x\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/systm.h"
end_include

begin_include
include|#
directive|include
file|"../h/mbuf.h"
end_include

begin_include
include|#
directive|include
file|"../h/protosw.h"
end_include

begin_include
include|#
directive|include
file|"../h/socket.h"
end_include

begin_include
include|#
directive|include
file|"../h/socketvar.h"
end_include

begin_include
include|#
directive|include
file|"../net/dn_systm.h"
end_include

begin_include
include|#
directive|include
file|"../net/nsp.h"
end_include

begin_include
include|#
directive|include
file|"../net/nsp_var.h"
end_include

begin_include
include|#
directive|include
file|"../errno.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|nspidebug
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|printd
value|if(nspidebug)printf
end_define

begin_comment
comment|/*  * NSP initialization  */
end_comment

begin_macro
name|nsp_init
argument_list|()
end_macro

begin_block
block|{
name|init
name|queues
name|what
else|else
operator|?
block|}
end_block

begin_comment
comment|/*  * Nsp_chkaddr performs many functions common to the processing  * of input packets.  The arguments are:  *	m	- the mbuf with the packet in it  *	srcnode	- the srcnode from the transport header  *	type	- the packet type, one of:  *		  NSP_DATA, NSP_LS, NSP_INTR, NSP_DATACK, NSP_OTHACK  *	sp	- pointer to a short to receive the segment number  *  * It performs the following functions:  *	1. verify that the packet is of the correct minimum length  *	2. find the associated NSP control block (by calling dn_addrtonspcb())  *	3. process any ack or nak and force retransmission or remove  *		acked data from the retransmit queue, as required  *	4. update the mbuf to point past the segnum field  *	5. return the segnum and nspcb pointer  */
end_comment

begin_function
name|struct
name|nspcb
modifier|*
name|nsp_chkaddr
parameter_list|(
name|m
parameter_list|,
name|srcnode
parameter_list|,
name|type
parameter_list|,
name|sp
parameter_list|)
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|short
name|srcnode
decl_stmt|;
name|int
name|type
decl_stmt|;
name|u_short
modifier|*
name|sp
decl_stmt|;
block|{
specifier|register
name|struct
name|nspcb
modifier|*
name|np
decl_stmt|;
name|struct
name|nspd
modifier|*
name|n
decl_stmt|;
name|u_short
name|dstaddr
decl_stmt|;
name|int
name|ack
decl_stmt|,
name|qual
decl_stmt|,
name|num
decl_stmt|;
comment|/* make sure we are accessing valid data */
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|nspd
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|d_short
argument_list|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|n
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|nspd
operator|*
argument_list|)
expr_stmt|;
name|dstaddr
operator|=
name|D_SHORT
argument_list|(
name|n
operator|->
name|nsp_dstaddr
argument_list|)
expr_stmt|;
name|np
operator|=
name|dn_addrtonspcb
argument_list|(
name|dstaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|==
literal|0
condition|)
block|{
name|no
name|such
name|address
decl_stmt|, return "no link"
name|message
block|}
if|if
condition|(
name|np
operator|->
name|n_node
operator|!=
name|srcnode
condition|)
block|{
name|printf
argument_list|(
literal|"nsp_chkaddr: n_node %d, srcnode %d\n"
argument_list|,
name|np
operator|->
name|n_node
argument_list|,
name|scrnode
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* make sure remote addresses match (consistency check) */
if|if
condition|(
name|np
operator|->
name|n_rem
operator|!=
name|D_SHORT
argument_list|(
name|n
operator|->
name|nsp_srcaddr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"nsp_chkaddr: n_rem %d, srcaddr %d\n"
argument_list|,
name|np
operator|->
name|n_rem
argument_list|,
name|D_SHORT
argument_list|(
name|n
operator|->
name|nsp_srcaddr
argument_list|)
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ack
operator|=
name|D_SHORT
argument_list|(
name|n
operator|->
name|nsp_acknum
argument_list|)
expr_stmt|;
if|if
condition|(
name|ack
operator|&
name|NSPA_ACK
condition|)
block|{
name|qual
operator|=
name|ack
operator|&
name|NSPA_QUAL
expr_stmt|;
name|num
operator|=
name|ack
operator|&
name|NSPA_NUM
expr_stmt|;
name|printd
argument_list|(
literal|", qual 0x%x, num %d"
argument_list|,
name|qual
argument_list|,
name|num
argument_list|)
expr_stmt|;
comment|/* make sure there's room for a segnum */
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|nspd
argument_list|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|type
operator|==
name|NSP_DATA
condition|)
block|{
if|if
condition|(
name|SEQ_GTR
argument_list|(
name|num
argument_list|,
name|np
operator|->
name|na_rcvdat
argument_list|)
operator|&&
name|SEQ_LEQ
argument_list|(
name|num
argument_list|,
name|np
operator|->
name|nn_high
argument_list|)
condition|)
block|{
name|np
operator|->
name|n_retrans
operator|=
literal|0
expr_stmt|;
name|np
operator|->
name|nf_remdat
operator|-=
name|SEQ_SUB
argument_list|(
name|num
argument_list|,
name|np
operator|->
name|na_rcvdat
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|qual
operator|==
name|NSPA_NAK
operator|||
name|SEQ_LEQ
argument_list|(
name|np
operator|->
name|nn_dat
argument_list|,
name|num
argument_list|)
condition|)
name|np
operator|->
name|nn_dat
operator|=
name|SEQ_ADD
argument_list|(
name|num
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|np
operator|->
name|na_rcvdat
operator|=
name|num
expr_stmt|;
name|nsp_purgertq
argument_list|(
name|np
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|n
operator|==
name|np
operator|->
name|nn_oth
operator|&&
operator|(
name|np
operator|->
name|n_flags
operator|&
name|NF_OTHSENT
operator|)
condition|)
block|{
if|if
condition|(
name|qual
operator|==
name|NSPA_NAK
condition|)
block|{
comment|/* force retransmission of other data seg */
name|printf
argument_list|(
literal|"nsp_chkaddr: NAK other\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|np
operator|->
name|n_flags
operator|&=
operator|~
name|NF_OTHSENT
expr_stmt|;
name|np
operator|->
name|nn_oth
operator|=
name|SEQ_ADD
argument_list|(
name|np
operator|->
name|nn_oth
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|n_flags
operator|&
name|NF_OTHINTR
condition|)
block|{
name|np
operator|->
name|n_flags
operator|&=
operator|~
operator|(
name|NF_OTHINTR
operator||
name|NF_INTAVAIL
operator|)
expr_stmt|;
if|if
condition|(
name|np
operator|->
name|nb_xmt
condition|)
name|m_freem
argument_list|(
name|np
operator|->
name|nb_xmt
argument_list|)
expr_stmt|;
block|}
else|else
name|np
operator|->
name|nf_locdat
operator|=
literal|0
expr_stmt|;
name|nsp_purgertq
argument_list|(
name|np
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
block|}
operator|*
name|sp
operator|=
name|D_SHORT
argument_list|(
name|n
operator|->
name|nsp_segnum
argument_list|)
expr_stmt|;
name|num
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nspd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|sp
operator|=
operator|(
name|u_short
operator|)
name|ack
expr_stmt|;
name|num
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nspd
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
expr_stmt|;
block|}
name|m
operator|->
name|m_len
operator|-=
name|num
expr_stmt|;
name|m
operator|->
name|m_off
operator|+=
name|num
expr_stmt|;
return|return
operator|(
name|np
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	kdb_print.c	7.2	86/11/20	*/
end_comment

begin_include
include|#
directive|include
file|"../kdb/defs.h"
end_include

begin_decl_stmt
name|char
modifier|*
name|BADRAD
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ADDR
name|lastframe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ADDR
name|callpc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|BADMOD
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|lp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|maxpos
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radix
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|lastc
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* breakpoints */
end_comment

begin_decl_stmt
name|BKPTR
name|bkpthead
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|REGLIST
name|reglist
index|[]
init|=
block|{
literal|"p2lr"
block|,
operator|&
name|pcb
operator|.
name|pcb_p2lr
block|,
literal|"p2br"
block|,
operator|(
name|int
operator|*
operator|)
operator|&
name|pcb
operator|.
name|pcb_p2br
block|,
literal|"p1lr"
block|,
operator|&
name|pcb
operator|.
name|pcb_p1lr
block|,
literal|"p1br"
block|,
operator|(
name|int
operator|*
operator|)
operator|&
name|pcb
operator|.
name|pcb_p1br
block|,
literal|"p0lr"
block|,
operator|&
name|pcb
operator|.
name|pcb_p0lr
block|,
literal|"p0br"
block|,
operator|(
name|int
operator|*
operator|)
operator|&
name|pcb
operator|.
name|pcb_p0br
block|,
literal|"ksp"
block|,
operator|&
name|pcb
operator|.
name|pcb_ksp
block|,
literal|"hfs"
block|,
operator|&
name|pcb
operator|.
name|pcb_hfs
block|,
literal|"psl"
block|,
operator|&
name|pcb
operator|.
name|pcb_psl
block|,
literal|"pc"
block|,
operator|&
name|pcb
operator|.
name|pcb_pc
block|,
literal|"ach"
block|,
operator|&
name|pcb
operator|.
name|pcb_ach
block|,
literal|"acl"
block|,
operator|&
name|pcb
operator|.
name|pcb_acl
block|,
literal|"usp"
block|,
operator|&
name|pcb
operator|.
name|pcb_usp
block|,
literal|"fp"
block|,
operator|&
name|pcb
operator|.
name|pcb_fp
block|,
literal|"r12"
block|,
operator|&
name|pcb
operator|.
name|pcb_r12
block|,
literal|"r11"
block|,
operator|&
name|pcb
operator|.
name|pcb_r11
block|,
literal|"r10"
block|,
operator|&
name|pcb
operator|.
name|pcb_r10
block|,
literal|"r9"
block|,
operator|&
name|pcb
operator|.
name|pcb_r9
block|,
literal|"r8"
block|,
operator|&
name|pcb
operator|.
name|pcb_r8
block|,
literal|"r7"
block|,
operator|&
name|pcb
operator|.
name|pcb_r7
block|,
literal|"r6"
block|,
operator|&
name|pcb
operator|.
name|pcb_r6
block|,
literal|"r5"
block|,
operator|&
name|pcb
operator|.
name|pcb_r5
block|,
literal|"r4"
block|,
operator|&
name|pcb
operator|.
name|pcb_r4
block|,
literal|"r3"
block|,
operator|&
name|pcb
operator|.
name|pcb_r3
block|,
literal|"r2"
block|,
operator|&
name|pcb
operator|.
name|pcb_r2
block|,
literal|"r1"
block|,
operator|&
name|pcb
operator|.
name|pcb_r1
block|,
literal|"r0"
block|,
operator|&
name|pcb
operator|.
name|pcb_r0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* general printing routines ($) */
end_comment

begin_macro
name|printtrace
argument_list|(
argument|modif
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|narg
operator|,
name|i
expr_stmt|;
specifier|register
name|BKPTR
name|bkptr
decl_stmt|;
specifier|register
name|ADDR
name|word
decl_stmt|;
specifier|register
name|char
modifier|*
name|comptr
decl_stmt|;
specifier|register
name|ADDR
name|argp
decl_stmt|,
name|frame
decl_stmt|;
specifier|register
name|struct
name|nlist
modifier|*
name|sp
decl_stmt|;
name|int
name|stack
decl_stmt|,
name|ntramp
decl_stmt|;
if|if
condition|(
name|cntflg
operator|==
literal|0
condition|)
name|cntval
operator|=
operator|-
literal|1
expr_stmt|;
switch|switch
condition|(
name|modif
condition|)
block|{
case|case
literal|'d'
case|:
if|if
condition|(
name|adrflg
condition|)
block|{
if|if
condition|(
name|adrval
operator|<
literal|2
operator|||
name|adrval
operator|>
literal|16
condition|)
name|error
argument_list|(
name|BADRAD
argument_list|)
expr_stmt|;
name|radix
operator|=
name|adrval
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"radix=%d base ten"
argument_list|,
name|radix
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
case|case
literal|'W'
case|:
name|printf
argument_list|(
literal|"maxpos=%d"
argument_list|,
name|maxpos
operator|=
operator|(
name|adrflg
condition|?
name|adrval
else|:
name|MAXPOS
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
case|case
literal|'S'
case|:
name|printf
argument_list|(
literal|"maxoff=%d"
argument_list|,
name|maxoff
operator|=
operator|(
name|adrflg
condition|?
name|adrval
else|:
name|MAXOFF
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
case|case
literal|'V'
case|:
name|printf
argument_list|(
literal|"variables\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|35
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|var
index|[
name|i
index|]
condition|)
block|{
name|printc
argument_list|(
operator|(
name|i
operator|<=
literal|9
condition|?
literal|'0'
else|:
literal|'a'
operator|-
literal|10
operator|)
operator|+
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" = %R\n"
argument_list|,
name|var
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0
case|:
case|case
literal|'?'
case|:
case|case
literal|'r'
case|:
case|case
literal|'R'
case|:
name|printregs
argument_list|(
name|modif
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'c'
case|:
case|case
literal|'C'
case|:
if|if
condition|(
name|adrflg
condition|)
block|{
name|frame
operator|=
name|adrval
expr_stmt|;
name|callpc
operator|=
name|get
argument_list|(
name|frame
operator|-
literal|8
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|frame
operator|=
name|pcb
operator|.
name|pcb_fp
expr_stmt|;
name|callpc
operator|=
name|pcb
operator|.
name|pcb_pc
expr_stmt|;
block|}
name|lastframe
operator|=
literal|0
expr_stmt|;
name|ntramp
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|cntval
operator|--
operator|&&
name|frame
operator|!=
literal|0
condition|)
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|chkerr
argument_list|()
expr_stmt|;
comment|/* check for pc in pcb (signal trampoline code) */
if|if
condition|(
name|MAXSTOR
operator|<
name|callpc
operator|&&
name|callpc
operator|<
name|MAXSTOR
operator|+
name|ctob
argument_list|(
name|UPAGES
argument_list|)
condition|)
block|{
name|name
operator|=
literal|"sigtramp"
expr_stmt|;
name|ntramp
operator|++
expr_stmt|;
block|}
else|else
block|{
name|ntramp
operator|=
literal|0
expr_stmt|;
name|findsym
argument_list|(
name|callpc
argument_list|,
name|ISYM
argument_list|)
expr_stmt|;
if|if
condition|(
name|cursym
condition|)
name|name
operator|=
name|cursym
operator|->
name|n_un
operator|.
name|n_name
expr_stmt|;
else|else
name|name
operator|=
literal|"?"
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s("
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|narg
operator|=
operator|(
operator|(
name|get
argument_list|(
name|frame
operator|-
literal|4
argument_list|,
name|DSP
argument_list|)
operator|&
literal|0xffff
operator|)
operator|-
literal|4
operator|)
operator|/
literal|4
expr_stmt|;
name|argp
operator|=
name|frame
expr_stmt|;
if|if
condition|(
name|ntramp
operator|!=
literal|1
condition|)
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|narg
operator|==
literal|0
condition|)
break|break;
name|printf
argument_list|(
literal|"%R"
argument_list|,
name|get
argument_list|(
name|argp
operator|+=
literal|4
argument_list|,
name|DSP
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|narg
operator|!=
literal|0
condition|)
name|printc
argument_list|(
literal|','
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|") at "
argument_list|)
expr_stmt|;
name|psymoff
argument_list|(
name|callpc
argument_list|,
name|ISYM
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|modif
operator|==
literal|'C'
condition|)
block|{
while|while
condition|(
name|localsym
argument_list|(
name|frame
argument_list|,
name|argp
argument_list|)
condition|)
block|{
name|word
operator|=
name|get
argument_list|(
name|localval
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8t%s:%10t"
argument_list|,
name|cursym
operator|->
name|n_un
operator|.
name|n_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|errflg
condition|)
block|{
name|printf
argument_list|(
literal|"?\n"
argument_list|)
expr_stmt|;
name|errflg
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"%R\n"
argument_list|,
name|word
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ntramp
operator|!=
literal|1
condition|)
block|{
name|callpc
operator|=
name|get
argument_list|(
name|frame
operator|-
literal|8
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
name|lastframe
operator|=
name|frame
expr_stmt|;
name|frame
operator|=
name|get
argument_list|(
name|frame
argument_list|,
name|DSP
argument_list|)
operator|&
name|ALIGN
expr_stmt|;
block|}
else|else
name|callpc
operator|=
name|get
argument_list|(
name|lastframe
operator|+
literal|44
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame
operator|==
literal|0
operator|||
operator|(
operator|!
name|adrflg
operator|&&
operator|!
name|INSTACK
argument_list|(
name|frame
argument_list|)
operator|)
condition|)
break|break;
block|}
break|break;
comment|/*print externals*/
case|case
literal|'e'
case|:
case|case
literal|'E'
case|:
for|for
control|(
name|sp
operator|=
name|symtab
init|;
name|sp
operator|<
name|esymtab
condition|;
name|sp
operator|++
control|)
if|if
condition|(
name|sp
operator|->
name|n_type
operator|==
operator|(
name|N_DATA
operator||
name|N_EXT
operator|)
operator|||
name|sp
operator|->
name|n_type
operator|==
operator|(
name|N_BSS
operator||
name|N_EXT
operator|)
condition|)
name|printf
argument_list|(
literal|"%s:%12t%R\n"
argument_list|,
name|sp
operator|->
name|n_un
operator|.
name|n_name
argument_list|,
name|get
argument_list|(
name|sp
operator|->
name|n_value
argument_list|,
name|DSP
argument_list|)
argument_list|)
expr_stmt|;
break|break;
comment|/*print breakpoints*/
case|case
literal|'b'
case|:
case|case
literal|'B'
case|:
name|printf
argument_list|(
literal|"breakpoints\ncount%8tbkpt%24tcommand\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|bkptr
operator|=
name|bkpthead
init|;
name|bkptr
condition|;
name|bkptr
operator|=
name|bkptr
operator|->
name|nxtbkpt
control|)
if|if
condition|(
name|bkptr
operator|->
name|flag
condition|)
block|{
name|printf
argument_list|(
literal|"%-8.8d"
argument_list|,
name|bkptr
operator|->
name|count
argument_list|)
expr_stmt|;
name|psymoff
argument_list|(
name|bkptr
operator|->
name|loc
argument_list|,
name|ISYM
argument_list|,
literal|"%24t"
argument_list|)
expr_stmt|;
name|comptr
operator|=
name|bkptr
operator|->
name|comm
expr_stmt|;
while|while
condition|(
operator|*
name|comptr
condition|)
name|printc
argument_list|(
operator|*
name|comptr
operator|++
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'l'
case|:
block|{
specifier|register
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
specifier|extern
name|struct
name|proc
modifier|*
name|allproc
decl_stmt|;
for|for
control|(
name|p
operator|=
name|allproc
init|;
name|p
condition|;
name|p
operator|=
name|p
operator|->
name|p_nxt
control|)
block|{
name|printf
argument_list|(
literal|"%X pid %5d %c"
argument_list|,
name|p
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|p
operator|->
name|p_stat
operator|==
name|SSLEEP
condition|?
literal|'S'
else|:
name|p
operator|->
name|p_stat
operator|==
name|SRUN
condition|?
literal|'R'
else|:
name|p
operator|->
name|p_stat
operator|==
name|SIDL
condition|?
literal|'I'
else|:
name|p
operator|->
name|p_stat
operator|==
name|SSTOP
condition|?
literal|'T'
else|:
literal|'?'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_wchan
condition|)
block|{
name|printf
argument_list|(
literal|" wait "
argument_list|)
expr_stmt|;
name|psymoff
argument_list|(
name|p
operator|->
name|p_wchan
argument_list|,
name|ISYM
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
name|printc
argument_list|(
name|EOR
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
default|default:
name|error
argument_list|(
name|BADMOD
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
specifier|static
name|printregs
argument_list|(
argument|c
argument_list|)
block|{
specifier|register
name|REGPTR
name|p
block|;
name|ADDR
name|v
block|;
for|for
control|(
name|p
operator|=
name|reglist
init|;
name|p
operator|->
name|rname
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|c
operator|!=
literal|'R'
operator|&&
name|p
operator|->
name|rkern
operator|!=
operator|&
name|pcb
operator|.
name|pcb_psl
condition|)
continue|continue;
name|c
operator|=
literal|'R'
expr_stmt|;
name|v
operator|=
operator|*
name|p
operator|->
name|rkern
expr_stmt|;
name|printf
argument_list|(
literal|"%s%6t%R %16t"
argument_list|,
name|p
operator|->
name|rname
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|valpr
argument_list|(
name|v
argument_list|,
operator|(
name|p
operator|->
name|rkern
operator|==
operator|&
name|pcb
operator|.
name|pcb_pc
condition|?
name|ISYM
else|:
name|DSYM
operator|)
argument_list|)
expr_stmt|;
name|printc
argument_list|(
name|EOR
argument_list|)
expr_stmt|;
block|}
name|printpc
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  getreg
operator|(
name|regnam
operator|)
block|{
specifier|register
name|REGPTR
name|p
block|;
specifier|register
name|char
operator|*
name|regptr
block|;
name|char
operator|*
name|olp
block|;
name|olp
operator|=
name|lp
block|;
for|for
control|(
name|p
operator|=
name|reglist
init|;
name|p
operator|->
name|rname
condition|;
name|p
operator|++
control|)
block|{
name|regptr
operator|=
name|p
operator|->
name|rname
expr_stmt|;
if|if
condition|(
name|regnam
operator|==
operator|*
name|regptr
operator|++
condition|)
block|{
while|while
condition|(
operator|*
name|regptr
condition|)
if|if
condition|(
name|readchar
argument_list|()
operator|!=
operator|*
name|regptr
operator|++
condition|)
block|{
operator|--
name|regptr
expr_stmt|;
break|break;
block|}
end_expr_stmt

begin_if
if|if
condition|(
operator|*
name|regptr
condition|)
name|lp
operator|=
name|olp
expr_stmt|;
else|else
return|return
operator|(
operator|(
name|int
operator|)
name|p
operator|->
name|rkern
operator|)
return|;
end_if

begin_expr_stmt
unit|} 	}
name|lp
operator|=
name|olp
expr_stmt|;
end_expr_stmt

begin_return
return|return
operator|(
operator|-
literal|1
operator|)
return|;
end_return

begin_expr_stmt
unit|}  printpc
operator|(
operator|)
block|{
name|psymoff
argument_list|(
name|pcb
operator|.
name|pcb_pc
argument_list|,
name|ISYM
argument_list|,
literal|":%16t"
argument_list|)
block|;
name|printins
argument_list|(
name|ISP
argument_list|,
name|chkget
argument_list|(
name|pcb
operator|.
name|pcb_pc
argument_list|,
name|ISP
argument_list|)
argument_list|)
block|;
name|printc
argument_list|(
name|EOR
argument_list|)
block|; }
end_expr_stmt

end_unit


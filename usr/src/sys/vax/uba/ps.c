begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	ps.c	6.1	83/08/13	*/
end_comment

begin_comment
comment|/*  * Evans and Sutherland Picture System 2 driver  */
end_comment

begin_comment
comment|/*  *	Still to be done:  *		WAIT_HIT  */
end_comment

begin_include
include|#
directive|include
file|"ps.h"
end_include

begin_if
if|#
directive|if
name|NPS
operator|>
literal|0
end_if

begin_define
define|#
directive|define
name|EXTERNAL_SYNC
end_define

begin_include
include|#
directive|include
file|"../machine/pte.h"
end_include

begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/systm.h"
end_include

begin_include
include|#
directive|include
file|"../h/ioctl.h"
end_include

begin_include
include|#
directive|include
file|"../h/map.h"
end_include

begin_include
include|#
directive|include
file|"../h/buf.h"
end_include

begin_include
include|#
directive|include
file|"../h/conf.h"
end_include

begin_include
include|#
directive|include
file|"../h/dir.h"
end_include

begin_include
include|#
directive|include
file|"../h/user.h"
end_include

begin_include
include|#
directive|include
file|"../h/uio.h"
end_include

begin_include
include|#
directive|include
file|"../vaxuba/ubareg.h"
end_include

begin_include
include|#
directive|include
file|"../vaxuba/ubavar.h"
end_include

begin_include
include|#
directive|include
file|"../vaxuba/psreg.h"
end_include

begin_decl_stmt
name|int
name|psprobe
argument_list|()
decl_stmt|,
name|psattach
argument_list|()
decl_stmt|,
name|psintr
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uba_device
modifier|*
name|psdinfo
index|[
name|NPS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_short
name|psstd
index|[]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uba_driver
name|psdriver
init|=
block|{
name|psprobe
block|,
literal|0
block|,
name|psattach
block|,
literal|0
block|,
name|psstd
block|,
literal|"ps"
block|,
name|psdinfo
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PSUNIT
parameter_list|(
name|dev
parameter_list|)
value|(minor(dev))
end_define

begin_define
define|#
directive|define
name|MAXAUTOREFRESH
value|(4)
end_define

begin_define
define|#
directive|define
name|MAXAUTOMAP
value|(4)
end_define

begin_define
define|#
directive|define
name|MAXDBSIZE
value|(0177777/2)
end_define

begin_define
define|#
directive|define
name|PSPRI
value|(PZERO+1)
end_define

begin_define
define|#
directive|define
name|PSWAIT
parameter_list|()
value|{register short int i, j; i=20000; while((i-- != 0)\&& (((j=psaddr->ps_iostat)&DIOREADY)==0));}
end_define

begin_struct
struct|struct
name|ps
block|{
name|char
name|ps_open
decl_stmt|;
name|short
name|int
name|ps_uid
decl_stmt|;
struct|struct
block|{
enum|enum
block|{
name|SINGLE_STEP_RF
block|,
name|AUTO_RF
block|,
name|TIME_RF
block|}
name|state
enum|;
enum|enum
block|{
name|RUNNING_RF
block|,
name|SYNCING_RF
block|,
name|WAITING_MAP
block|,
name|STOPPED_RF
block|}
name|mode
enum|;
name|unsigned
name|short
name|int
name|sraddrs
index|[
name|MAXAUTOREFRESH
index|]
decl_stmt|;
name|short
name|int
name|nsraddrs
decl_stmt|;
name|short
name|int
name|srcntr
decl_stmt|;
name|char
name|waiting
decl_stmt|;
name|char
name|stop
decl_stmt|;
name|int
name|icnt
decl_stmt|;
name|int
name|timecnt
decl_stmt|;
block|}
name|ps_refresh
struct|;
struct|struct
block|{
enum|enum
block|{
name|ON_DB
block|,
name|OFF_DB
block|}
name|state
enum|;
name|unsigned
name|short
name|int
name|dbaddrs
index|[
literal|2
index|]
decl_stmt|;
name|unsigned
name|short
name|int
name|dbsize
decl_stmt|;
name|short
name|int
name|rbuffer
decl_stmt|;
block|}
name|ps_dbuffer
struct|;
struct|struct
block|{
enum|enum
block|{
name|SINGLE_STEP_MAP
block|,
name|AUTO_MAP
block|}
name|state
enum|;
enum|enum
block|{
name|RUNNING_MAP
block|,
name|WAITING_RF
block|,
name|WAITING_START
block|}
name|mode
enum|;
name|unsigned
name|short
name|int
name|maddrs
index|[
name|MAXAUTOMAP
index|]
decl_stmt|;
name|short
name|int
name|nmaddrs
decl_stmt|;
name|short
name|int
name|mcntr
decl_stmt|;
name|short
name|int
name|outputstart
decl_stmt|;
name|char
name|waiting
decl_stmt|;
name|char
name|stop
decl_stmt|;
name|int
name|icnt
decl_stmt|;
block|}
name|ps_map
struct|;
struct|struct
block|{
name|short
name|int
name|ticked
decl_stmt|;
name|short
name|int
name|missed
decl_stmt|;
name|int
name|icnt
decl_stmt|;
block|}
name|ps_clock
struct|;
struct|struct
block|{
name|int
name|icnt
decl_stmt|;
block|}
name|ps_hit
struct|;
name|int
name|ps_strayintr
decl_stmt|;
name|int
name|last_request
decl_stmt|;
name|int
name|strayrequest
decl_stmt|;
name|int
name|ps_icnt
decl_stmt|;
block|}
name|ps
index|[
name|NPS
index|]
struct|;
end_struct

begin_macro
name|psprobe
argument_list|(
argument|reg
argument_list|)
end_macro

begin_decl_stmt
name|caddr_t
name|reg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|br
decl_stmt|,
name|cvec
decl_stmt|;
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
init|=
operator|(
expr|struct
name|psdevice
operator|*
operator|)
name|reg
decl_stmt|;
name|psaddr
operator|->
name|ps_iostat
operator|=
name|PSRESET
expr_stmt|;
name|DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|RTCIE
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
literal|01
expr_stmt|;
name|psaddr
operator|->
name|ps_iostat
operator|=
name|PSIE
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|RTCSR
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
operator|(
name|SYNC
operator||
name|RUN
operator|)
expr_stmt|;
name|DELAY
argument_list|(
literal|200000
argument_list|)
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|RTCREQ
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
literal|01
expr_stmt|;
name|psaddr
operator|->
name|ps_iostat
operator|=
literal|0
expr_stmt|;
name|psaddr
operator|->
name|ps_iostat
operator|=
name|PSRESET
expr_stmt|;
return|return
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|psdevice
argument_list|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_expr_stmt
name|psattach
argument_list|(
name|ui
argument_list|)
specifier|register
expr|struct
name|uba_device
operator|*
name|ui
expr_stmt|;
end_expr_stmt

begin_block
block|{  }
end_block

begin_macro
name|psopen
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|ps
modifier|*
name|psp
decl_stmt|;
specifier|register
name|struct
name|uba_device
modifier|*
name|ui
decl_stmt|;
specifier|register
name|int
name|unit
init|=
name|PSUNIT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|unit
operator|>=
name|NPS
operator|||
operator|(
name|psp
operator|=
operator|&
name|ps
index|[
name|minor
argument_list|(
name|dev
argument_list|)
index|]
operator|)
operator|->
name|ps_open
operator|||
operator|(
name|ui
operator|=
name|psdinfo
index|[
name|unit
index|]
operator|)
operator|==
literal|0
operator|||
name|ui
operator|->
name|ui_alive
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|psp
operator|->
name|ps_open
operator|=
literal|1
expr_stmt|;
name|psp
operator|->
name|ps_uid
operator|=
name|u
operator|.
name|u_uid
expr_stmt|;
name|psp
operator|->
name|ps_strayintr
operator|=
literal|0
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|=
name|SINGLE_STEP_RF
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|waiting
operator|=
literal|0
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|stop
operator|=
literal|0
expr_stmt|;
name|psp
operator|->
name|ps_dbuffer
operator|.
name|state
operator|=
name|OFF_DB
expr_stmt|;
name|psp
operator|->
name|ps_map
operator|.
name|state
operator|=
name|SINGLE_STEP_MAP
expr_stmt|;
name|psp
operator|->
name|ps_map
operator|.
name|waiting
operator|=
literal|0
expr_stmt|;
name|psp
operator|->
name|ps_map
operator|.
name|stop
operator|=
literal|0
expr_stmt|;
name|psp
operator|->
name|ps_clock
operator|.
name|ticked
operator|=
literal|0
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|icnt
operator|=
name|psp
operator|->
name|ps_map
operator|.
name|icnt
operator|=
name|psp
operator|->
name|ps_clock
operator|.
name|icnt
operator|=
literal|0
expr_stmt|;
name|psp
operator|->
name|ps_icnt
operator|=
literal|0
expr_stmt|;
name|maptouser
argument_list|(
name|ui
operator|->
name|ui_addr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|psclose
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
init|=
operator|(
expr|struct
name|psdevice
operator|*
operator|)
name|psdinfo
index|[
name|PSUNIT
argument_list|(
name|dev
argument_list|)
index|]
operator|->
name|ui_addr
decl_stmt|;
name|ps
index|[
name|PSUNIT
argument_list|(
name|dev
argument_list|)
index|]
operator|.
name|ps_open
operator|=
literal|0
expr_stmt|;
name|psaddr
operator|->
name|ps_iostat
operator|=
literal|0
expr_stmt|;
comment|/* clear IENABLE */
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|RFSR
expr_stmt|;
comment|/* set in auto refresh mode */
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
name|AUTOREF
expr_stmt|;
name|unmaptouser
argument_list|(
name|psaddr
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|psread
argument_list|(
argument|dev
argument_list|,
argument|uio
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|pswrite
argument_list|(
argument|dev
argument_list|,
argument|uio
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_expr_stmt
name|psioctl
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|,
name|flag
argument_list|)
specifier|register
name|caddr_t
name|data
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|uba_device
modifier|*
name|ui
init|=
name|psdinfo
index|[
name|PSUNIT
argument_list|(
name|dev
argument_list|)
index|]
decl_stmt|;
specifier|register
name|struct
name|ps
modifier|*
name|psp
init|=
operator|&
name|ps
index|[
name|PSUNIT
argument_list|(
name|dev
argument_list|)
index|]
decl_stmt|;
name|int
modifier|*
name|waddr
init|=
operator|*
operator|(
name|int
operator|*
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|n
decl_stmt|,
name|arg
decl_stmt|,
name|i
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|PSIOGETADDR
case|:
operator|*
operator|(
name|caddr_t
operator|*
operator|)
name|data
operator|=
name|ui
operator|->
name|ui_addr
expr_stmt|;
break|break;
case|case
name|PSIOAUTOREFRESH
case|:
name|n
operator|=
name|fuword
argument_list|(
name|waddr
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
if|if
condition|(
name|n
operator|<
literal|0
operator|||
name|n
operator|>
name|MAXAUTOREFRESH
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|arg
operator|=
name|fuword
argument_list|(
name|waddr
operator|++
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
name|psp
operator|->
name|ps_refresh
operator|.
name|sraddrs
index|[
name|i
index|]
operator|=
name|arg
expr_stmt|;
block|}
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|=
name|AUTO_RF
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|nsraddrs
operator|=
name|n
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|srcntr
operator|=
literal|0
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|mode
operator|=
name|WAITING_MAP
expr_stmt|;
break|break;
case|case
name|PSIOAUTOMAP
case|:
name|n
operator|=
name|fuword
argument_list|(
name|waddr
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
if|if
condition|(
name|n
operator|<
literal|0
operator|||
name|n
operator|>
name|MAXAUTOMAP
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|arg
operator|=
name|fuword
argument_list|(
name|waddr
operator|++
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
name|psp
operator|->
name|ps_map
operator|.
name|maddrs
index|[
name|i
index|]
operator|=
name|arg
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|arg
operator|=
name|fuword
argument_list|(
name|waddr
operator|++
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
name|psp
operator|->
name|ps_map
operator|.
name|outputstart
operator|=
name|arg
expr_stmt|;
name|psp
operator|->
name|ps_map
operator|.
name|state
operator|=
name|AUTO_MAP
expr_stmt|;
name|psp
operator|->
name|ps_map
operator|.
name|nmaddrs
operator|=
name|n
expr_stmt|;
name|psp
operator|->
name|ps_map
operator|.
name|mcntr
operator|=
literal|0
expr_stmt|;
name|psp
operator|->
name|ps_map
operator|.
name|mode
operator|=
name|WAITING_START
expr_stmt|;
break|break;
case|case
name|PSIOSINGLEREFRESH
case|:
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|=
name|SINGLE_STEP_RF
expr_stmt|;
break|break;
case|case
name|PSIOSINGLEMAP
case|:
name|psp
operator|->
name|ps_map
operator|.
name|state
operator|=
name|SINGLE_STEP_MAP
expr_stmt|;
break|break;
case|case
name|PSIODOUBLEBUFFER
case|:
if|if
condition|(
operator|(
name|arg
operator|=
name|fuword
argument_list|(
name|waddr
operator|++
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
name|psp
operator|->
name|ps_dbuffer
operator|.
name|dbaddrs
index|[
literal|0
index|]
operator|=
name|arg
expr_stmt|;
if|if
condition|(
operator|(
name|arg
operator|=
name|fuword
argument_list|(
name|waddr
operator|++
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
if|if
condition|(
name|arg
operator|<=
literal|0
operator|||
name|arg
operator|>
name|MAXDBSIZE
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|psp
operator|->
name|ps_dbuffer
operator|.
name|dbsize
operator|=
name|arg
expr_stmt|;
name|psp
operator|->
name|ps_dbuffer
operator|.
name|dbaddrs
index|[
literal|1
index|]
operator|=
name|psp
operator|->
name|ps_dbuffer
operator|.
name|dbaddrs
index|[
literal|0
index|]
operator|+
name|arg
expr_stmt|;
name|psp
operator|->
name|ps_dbuffer
operator|.
name|state
operator|=
name|ON_DB
expr_stmt|;
name|psp
operator|->
name|ps_dbuffer
operator|.
name|rbuffer
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|PSIOSINGLEBUFFER
case|:
name|psp
operator|->
name|ps_dbuffer
operator|.
name|state
operator|=
name|OFF_DB
expr_stmt|;
break|break;
case|case
name|PSIOTIMEREFRESH
case|:
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|!=
name|SINGLE_STEP_RF
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|arg
operator|=
name|fuword
argument_list|(
name|waddr
operator|++
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|=
name|TIME_RF
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|timecnt
operator|=
name|arg
expr_stmt|;
break|break;
case|case
name|PSIOWAITREFRESH
case|:
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|mode
operator|!=
name|RUNNING_RF
condition|)
comment|/* not running */
return|return
operator|(
literal|0
operator|)
return|;
comment|/* dont wait */
comment|/* fall into ... */
case|case
name|PSIOSTOPREFRESH
case|:
if|if
condition|(
name|cmd
operator|==
name|PSIOSTOPREFRESH
condition|)
block|{
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|mode
operator|==
name|STOPPED_RF
operator|&&
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|!=
name|TIME_RF
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|psp
operator|->
name|ps_refresh
operator|.
name|stop
operator|=
literal|1
expr_stmt|;
block|}
name|spl5
argument_list|()
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|waiting
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|waiting
condition|)
name|sleep
argument_list|(
operator|&
name|psp
operator|->
name|ps_refresh
operator|.
name|waiting
argument_list|,
name|PSPRI
argument_list|)
expr_stmt|;
name|spl0
argument_list|()
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|PSIOSTOPREFRESH
condition|)
name|psp
operator|->
name|ps_refresh
operator|.
name|mode
operator|=
name|STOPPED_RF
expr_stmt|;
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|==
name|TIME_RF
condition|)
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|=
name|SINGLE_STEP_RF
expr_stmt|;
break|break;
case|case
name|PSIOWAITMAP
case|:
if|if
condition|(
name|psp
operator|->
name|ps_map
operator|.
name|mode
operator|!=
name|RUNNING_MAP
condition|)
comment|/* not running */
return|return
operator|(
literal|0
operator|)
return|;
comment|/* dont wait */
comment|/* fall into ... */
case|case
name|PSIOSTOPMAP
case|:
if|if
condition|(
name|cmd
operator|==
name|PSIOSTOPMAP
condition|)
name|psp
operator|->
name|ps_map
operator|.
name|stop
operator|=
literal|1
expr_stmt|;
name|spl5
argument_list|()
expr_stmt|;
name|psp
operator|->
name|ps_map
operator|.
name|waiting
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|psp
operator|->
name|ps_map
operator|.
name|waiting
condition|)
name|sleep
argument_list|(
operator|&
name|psp
operator|->
name|ps_map
operator|.
name|waiting
argument_list|,
name|PSPRI
argument_list|)
expr_stmt|;
name|spl0
argument_list|()
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENOTTY
operator|)
return|;
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_define
define|#
directive|define
name|SAVEPSADDR
parameter_list|()
value|{register short int i, x;x=spl6();i=psaddr->ps_addr;\ 		while(((i=psaddr->ps_iostat)&DIOREADY)==0);\ 		savepsaddr=psaddr->ps_data;splx(x);}
end_define

begin_define
define|#
directive|define
name|RESTORPSADDR
parameter_list|()
value|{register int x,i;x=spl6();\ 		while(((i=psaddr->ps_iostat)&DIOREADY)==0);\ 		psaddr->ps_addr=savepsaddr;splx(x);}
end_define

begin_macro
name|psclockintr
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
init|=
operator|(
expr|struct
name|psdevice
operator|*
operator|)
name|psdinfo
index|[
name|PSUNIT
argument_list|(
name|dev
argument_list|)
index|]
operator|->
name|ui_addr
decl_stmt|;
specifier|register
name|struct
name|ps
modifier|*
name|psp
init|=
operator|&
name|ps
index|[
name|PSUNIT
argument_list|(
name|dev
argument_list|)
index|]
decl_stmt|;
name|int
name|savepsaddr
decl_stmt|;
if|if
condition|(
operator|!
name|psp
operator|->
name|ps_open
condition|)
return|return;
name|psp
operator|->
name|ps_clock
operator|.
name|icnt
operator|++
expr_stmt|;
name|SAVEPSADDR
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|EXTERNAL_SYNC
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|==
name|AUTO_RF
condition|)
block|{
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|mode
operator|==
name|SYNCING_RF
operator|&&
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|!=
name|TIME_RF
condition|)
block|{
name|psrfnext
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|psp
operator|->
name|ps_clock
operator|.
name|ticked
operator|++
expr_stmt|;
name|psp
operator|->
name|ps_clock
operator|.
name|missed
operator|++
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|RTCREQ
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
literal|01
expr_stmt|;
comment|/* clear the request bits */
name|RESTORPSADDR
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|pssystemintr
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
init|=
operator|(
expr|struct
name|psdevice
operator|*
operator|)
name|psdinfo
index|[
name|PSUNIT
argument_list|(
name|dev
argument_list|)
index|]
operator|->
name|ui_addr
decl_stmt|;
specifier|register
name|struct
name|ps
modifier|*
name|psp
init|=
operator|&
name|ps
index|[
name|PSUNIT
argument_list|(
name|dev
argument_list|)
index|]
decl_stmt|;
name|short
name|int
name|request
decl_stmt|;
specifier|register
name|int
name|savepsaddr
decl_stmt|,
name|x
decl_stmt|;
if|if
condition|(
operator|!
name|psp
operator|->
name|ps_open
condition|)
return|return;
name|psp
operator|->
name|ps_icnt
operator|++
expr_stmt|;
name|SAVEPSADDR
argument_list|()
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|SYSREQ
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|request
operator|=
name|psaddr
operator|->
name|ps_data
operator|&
literal|0377
expr_stmt|;
name|psp
operator|->
name|last_request
operator|=
name|request
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|SYSREQ
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
name|request
operator|&
operator|(
operator|~
operator|(
name|HALT_REQ
operator||
name|MOSTOP_REQ
operator|)
operator|)
expr_stmt|;
comment|/* acknowledge */
if|if
condition|(
name|request
operator|&
operator|(
name|MOSTOP_REQ
operator||
name|HALT_REQ
operator|)
condition|)
block|{
comment|/* Map stopped */
name|psp
operator|->
name|ps_map
operator|.
name|icnt
operator|++
expr_stmt|;
name|psmapstop
argument_list|(
name|psaddr
argument_list|)
expr_stmt|;
comment|/* kill it dead */
if|if
condition|(
name|psp
operator|->
name|ps_map
operator|.
name|waiting
condition|)
block|{
name|psp
operator|->
name|ps_map
operator|.
name|waiting
operator|=
literal|0
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|psp
operator|->
name|ps_map
operator|.
name|waiting
argument_list|)
expr_stmt|;
if|if
condition|(
name|psp
operator|->
name|ps_map
operator|.
name|stop
condition|)
block|{
name|psp
operator|->
name|ps_map
operator|.
name|stop
operator|=
literal|0
expr_stmt|;
goto|goto
name|tryrf
goto|;
block|}
block|}
if|if
condition|(
name|psp
operator|->
name|ps_map
operator|.
name|state
operator|==
name|AUTO_MAP
condition|)
if|if
condition|(
operator|!
name|psmapnext
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
condition|)
block|{
name|psp
operator|->
name|ps_map
operator|.
name|mcntr
operator|=
literal|0
expr_stmt|;
comment|/* prepare for next round */
name|pssetmapbounds
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|mode
operator|==
name|WAITING_MAP
condition|)
block|{
if|if
condition|(
name|psp
operator|->
name|ps_dbuffer
operator|.
name|state
operator|==
name|ON_DB
condition|)
comment|/* fill other db */
name|psdbswitch
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
else|else
name|psp
operator|->
name|ps_map
operator|.
name|mode
operator|=
name|WAITING_RF
expr_stmt|;
name|psrfnext
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
comment|/* start rf */
block|}
else|else
name|psp
operator|->
name|ps_map
operator|.
name|mode
operator|=
name|WAITING_RF
expr_stmt|;
block|}
block|}
name|tryrf
label|:
if|if
condition|(
name|request
operator|&
name|RFSTOP_REQ
condition|)
block|{
comment|/* Refresh stopped */
name|psp
operator|->
name|ps_refresh
operator|.
name|icnt
operator|++
expr_stmt|;
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|==
name|TIME_RF
condition|)
if|if
condition|(
operator|--
name|psp
operator|->
name|ps_refresh
operator|.
name|timecnt
operator|>
literal|0
condition|)
goto|goto
name|tryhit
goto|;
name|psrfstop
argument_list|(
name|psaddr
argument_list|,
name|psp
argument_list|)
expr_stmt|;
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|waiting
condition|)
block|{
name|psp
operator|->
name|ps_refresh
operator|.
name|waiting
operator|=
literal|0
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|psp
operator|->
name|ps_refresh
operator|.
name|waiting
argument_list|)
expr_stmt|;
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|stop
condition|)
block|{
name|psp
operator|->
name|ps_refresh
operator|.
name|stop
operator|=
literal|0
expr_stmt|;
goto|goto
name|tryhit
goto|;
block|}
block|}
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|==
name|AUTO_RF
condition|)
if|if
condition|(
operator|!
name|psrfnext
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
condition|)
block|{
comment|/* at end of refresh cycle */
if|if
condition|(
name|psp
operator|->
name|ps_map
operator|.
name|state
operator|==
name|AUTO_MAP
operator|&&
name|psp
operator|->
name|ps_map
operator|.
name|mode
operator|==
name|WAITING_RF
condition|)
block|{
if|if
condition|(
name|psp
operator|->
name|ps_dbuffer
operator|.
name|state
operator|==
name|ON_DB
condition|)
name|psdbswitch
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
else|else
name|psmapnext
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
block|}
name|psp
operator|->
name|ps_refresh
operator|.
name|srcntr
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|EXTERNAL_SYNC
name|x
operator|=
name|spl6
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|psp
operator|->
name|ps_clock
operator|.
name|ticked
operator|||
operator|!
name|psrfnext
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
condition|)
block|{
name|psp
operator|->
name|ps_refresh
operator|.
name|mode
operator|=
name|SYNCING_RF
expr_stmt|;
block|}
name|psp
operator|->
name|ps_clock
operator|.
name|ticked
operator|=
literal|0
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|mode
operator|=
name|SYNCING_RF
expr_stmt|;
ifdef|#
directive|ifdef
name|EXTERNAL_SYNC
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
name|tryhit
label|:
if|if
condition|(
name|request
operator|&
name|HIT_REQ
condition|)
block|{
comment|/* Hit request */
name|psp
operator|->
name|ps_hit
operator|.
name|icnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|request
operator|==
literal|0
condition|)
name|psp
operator|->
name|ps_strayintr
operator|++
expr_stmt|;
name|RESTORPSADDR
argument_list|()
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|psrfnext
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
specifier|register
expr|struct
name|ps
operator|*
name|psp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|srcntr
operator|<
name|psp
operator|->
name|ps_refresh
operator|.
name|nsraddrs
condition|)
name|psrfstart
argument_list|(
name|psp
operator|->
name|ps_refresh
operator|.
name|sraddrs
index|[
name|psp
operator|->
name|ps_refresh
operator|.
name|srcntr
operator|++
index|]
argument_list|,
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|srcntr
operator|==
name|psp
operator|->
name|ps_refresh
operator|.
name|nsraddrs
operator|&&
name|psp
operator|->
name|ps_dbuffer
operator|.
name|state
operator|==
name|ON_DB
condition|)
block|{
name|psrfstart
argument_list|(
name|psp
operator|->
name|ps_dbuffer
operator|.
name|dbaddrs
index|[
name|psp
operator|->
name|ps_dbuffer
operator|.
name|rbuffer
index|]
argument_list|,
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
name|psp
operator|->
name|ps_refresh
operator|.
name|srcntr
operator|++
expr_stmt|;
comment|/* flag for after dbuffer */
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|psrfstart
argument_list|(
argument|dfaddr
argument_list|,
argument|psp
argument_list|,
argument|psaddr
argument_list|)
end_macro

begin_decl_stmt
name|short
name|int
name|dfaddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|ps
modifier|*
name|psp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|dummy
decl_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|RFASA
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
name|dfaddr
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|dummy
operator|=
name|psaddr
operator|->
name|ps_data
expr_stmt|;
comment|/* just access to get to status reg */
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
name|RFSTART
expr_stmt|;
comment|/* may want to | this value in */
name|psp
operator|->
name|ps_refresh
operator|.
name|mode
operator|=
name|RUNNING_RF
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|psrfstop
argument_list|(
name|psaddr
argument_list|,
name|psp
argument_list|)
specifier|register
expr|struct
name|psdevice
operator|*
name|psaddr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|ps
modifier|*
name|psp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|RFSR
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|psdbswitch
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
specifier|register
expr|struct
name|ps
operator|*
name|psp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|psp
operator|->
name|ps_dbuffer
operator|.
name|rbuffer
operator|=
operator|!
name|psp
operator|->
name|ps_dbuffer
operator|.
name|rbuffer
expr_stmt|;
name|pssetmapbounds
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
name|psmapnext
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|psmapnext
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
specifier|register
expr|struct
name|ps
operator|*
name|psp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|psp
operator|->
name|ps_map
operator|.
name|mcntr
operator|<
name|psp
operator|->
name|ps_map
operator|.
name|nmaddrs
condition|)
name|psmapstart
argument_list|(
name|psp
operator|->
name|ps_map
operator|.
name|maddrs
index|[
name|psp
operator|->
name|ps_map
operator|.
name|mcntr
operator|++
index|]
argument_list|,
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|pssetmapbounds
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
specifier|register
expr|struct
name|ps
operator|*
name|psp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|short
name|int
name|start
decl_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|MAOL
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
if|if
condition|(
name|psp
operator|->
name|ps_dbuffer
operator|.
name|state
operator|==
name|ON_DB
condition|)
block|{
name|psaddr
operator|->
name|ps_data
operator|=
operator|(
name|start
operator|=
name|psp
operator|->
name|ps_dbuffer
operator|.
name|dbaddrs
index|[
operator|!
name|psp
operator|->
name|ps_dbuffer
operator|.
name|rbuffer
index|]
operator|)
operator|+
name|psp
operator|->
name|ps_dbuffer
operator|.
name|dbsize
operator|-
literal|2
expr_stmt|;
comment|/* 2 for a refresh halt command */
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
name|start
expr_stmt|;
block|}
else|else
block|{
name|start
operator|=
name|psaddr
operator|->
name|ps_data
expr_stmt|;
comment|/* dummy: don't update limit */
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
name|psp
operator|->
name|ps_map
operator|.
name|outputstart
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|psmapstart
argument_list|(
argument|dfaddr
argument_list|,
argument|psp
argument_list|,
argument|psaddr
argument_list|)
end_macro

begin_decl_stmt
name|int
name|dfaddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|ps
modifier|*
name|psp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|data
decl_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|MAIA
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
name|dfaddr
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
name|MAO
operator||
name|MAI
expr_stmt|;
comment|/* may want more here */
name|psp
operator|->
name|ps_map
operator|.
name|mode
operator|=
name|RUNNING_MAP
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|psmapstop
argument_list|(
name|psaddr
argument_list|)
specifier|register
expr|struct
name|psdevice
operator|*
name|psaddr
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|MASR
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
literal|0
expr_stmt|;
comment|/* zero MAI bit */
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|MAIA
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
literal|0
expr_stmt|;
comment|/* zero input address register */
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_addr
operator|=
name|SYSREQ
expr_stmt|;
name|PSWAIT
argument_list|()
expr_stmt|;
name|psaddr
operator|->
name|ps_data
operator|=
name|HALT_REQ
operator||
name|MOSTOP_REQ
expr_stmt|;
comment|/* overkill?? */
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|psdeviceintr
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"ps device intr\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|psdmaintr
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"ps dma intr\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|psreset
argument_list|(
argument|uban
argument_list|)
end_macro

begin_decl_stmt
name|int
name|uban
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_macro
name|psextsync
argument_list|(
argument|PC
argument_list|,
argument|PS
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|struct
name|psdevice
modifier|*
name|psaddr
decl_stmt|;
specifier|register
name|struct
name|ps
modifier|*
name|psp
decl_stmt|;
specifier|register
name|int
name|savepsaddr
decl_stmt|;
ifdef|#
directive|ifdef
name|EXTERNAL_SYNC
for|for
control|(
name|psp
operator|=
name|ps
operator|,
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|NPS
condition|;
name|psp
operator|++
operator|,
name|n
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|psp
operator|->
name|ps_open
condition|)
continue|continue;
if|if
condition|(
name|psp
operator|->
name|ps_refresh
operator|.
name|mode
operator|==
name|SYNCING_RF
operator|&&
name|psp
operator|->
name|ps_refresh
operator|.
name|state
operator|!=
name|TIME_RF
condition|)
block|{
name|psaddr
operator|=
operator|(
expr|struct
name|psdevice
operator|*
operator|)
name|psdinfo
index|[
name|n
index|]
operator|->
name|ui_addr
expr_stmt|;
name|SAVEPSADDR
argument_list|()
expr_stmt|;
name|psrfnext
argument_list|(
name|psp
argument_list|,
name|psaddr
argument_list|)
expr_stmt|;
name|RESTORPSADDR
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|psp
operator|->
name|ps_clock
operator|.
name|ticked
operator|++
expr_stmt|;
name|psp
operator|->
name|ps_clock
operator|.
name|missed
operator|++
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	raboot.c	4.1	83/02/16	*/
end_comment

begin_comment
comment|/*  * From 4.1 boot sector code by Scott Comer (Rice University).  */
end_comment

begin_expr_stmt
operator|.
name|set
name|BOOTBASE
operator|,
literal|0xfe00
comment|/* relocated home of boot block */
comment|/* 	 * These three hold the register contents needed by the 	 * ROM driver subroutine to access the boot device. 	 */
operator|.
name|set
name|driver_r1
operator|,
name|DATA
operator|.
name|set
name|driver_r2
operator|,
name|driver_r1
operator|+
literal|4
operator|.
name|set
name|driver_r3
operator|,
name|driver_r2
operator|+
literal|4
operator|.
name|set
name|driver
operator|,
name|driver_r3
operator|+
literal|4
comment|/* addr of driver routine */
operator|.
name|set
name|NOT_FIRST_64K
operator|,
literal|0x1001
operator|.
name|set
name|UNSUPPORTED_DEVICE
operator|,
literal|0x1002
operator|.
name|set
name|RETURN_FROM_BOOT
operator|,
literal|0x1003
operator|.
name|set
name|COULD_NOT_FIND_BOOT
operator|,
literal|0x1004
operator|.
name|set
name|FILE_TOO_LARGE
operator|,
literal|0x1005
operator|.
name|set
name|FILE_READ_ERROR
operator|,
literal|0x1006
name|init
operator|:
operator|.
name|long
literal|0
comment|/* boot block parameters */
operator|.
name|long
literal|0
comment|/* (all unused, hence 0) */
operator|.
name|long
literal|0
comment|/*  * The registers are set by the console subsystem as follows.  * Those marked with stars are saved by the driver subroutine.  * Those marked with a "d" are used by the driver subroutine,  * and must contain the indicated values before calling the driver.  *   *    r0  = type of boot device (see 750 hardware reference, console)  * ds r1  = address of the unibus i/o page  * ds r2  = boot device CSR address  * ds r3  = boot device unit number  *  s r4  =   * ds r5  = software boot flags (driver: offset to buffer for read)  *  s r6  = driver subroutine address  *    r7  =   * d  r8  = LBN of block to read from disk  *    r9  =   *  s r10 =   *  s r11 =   *  s ap  =   *    fp  =   *  s sp  =   *   * Memory is mapped as follows:  *   * 0000 to 01ff	Boot block program  * 0200 to f9ff	Available  * fa00 to fdff	Drivers and control routines  * fe00 to ffff	Available  */
name|start
operator|:
name|clrl
name|r7
name|movl
name|r0
operator|,
name|r10
comment|/* save the device type */
name|moval
name|init
operator|,
name|r11
comment|/* base address of good memory */
name|movl
name|r5
operator|,
name|ap
comment|/* save the boot flags */
name|tstl
name|r11
comment|/* see if it is zero */
name|beql
literal|1f
name|movzwl
name|$NOT_FIRST_64K
operator|,
name|r7
name|halt
comment|/* not in first 64k of memory */
literal|1
operator|:
name|moval
name|STACK
argument_list|(
name|r11
argument_list|)
operator|,
name|sp
comment|/* put the stack somewhere good */
comment|/* save the register contents needed by the boot driver */
name|movl
name|r1
operator|,
name|driver_r1
argument_list|(
argument|r11
argument_list|)
name|movl
name|r2
operator|,
name|driver_r2
argument_list|(
argument|r11
argument_list|)
name|movl
name|r3
operator|,
name|driver_r3
argument_list|(
argument|r11
argument_list|)
name|movl
name|r6
operator|,
name|driver
argument_list|(
argument|r11
argument_list|)
comment|/* relocate the boot program */
name|movc3
name|$end
operator|,
operator|(
name|r11
operator|)
operator|,
name|BOOTBASE
argument_list|(
argument|r11
argument_list|)
name|jmp
name|BOOTBASE
operator|+
name|start2
argument_list|(
argument|r11
argument_list|)
name|start2
operator|:
comment|/* running relocated */
name|calls
name|$0
operator|,
name|BOOTBASE
operator|+
name|read_file
argument_list|(
argument|r11
argument_list|)
name|movl
name|r11
operator|,
name|r9
comment|/* save the base pointer */
comment|/* boot strap device codes from microcode routines */
operator|.
name|set
name|AnyMassBus
operator|,
literal|0
operator|.
name|set
name|RK07
operator|,
literal|1
operator|.
name|set
name|RL02
operator|,
literal|2
operator|.
name|set
name|UDA50
operator|,
literal|17
operator|.
name|set
name|TU58
operator|,
literal|64
name|cmpb
name|r10
operator|,
name|$AnyMassBus
name|bneq
literal|1f
name|movzbl
name|$0
operator|,
name|r10
comment|/* massbus disk */
name|brb
literal|2f
literal|1
operator|:
name|cmpb
name|r10
operator|,
name|$RK07
name|bneq
literal|1f
name|movzbl
name|$3
operator|,
name|r10
comment|/* rk07 disk */
name|brb
literal|2f
literal|1
operator|:
name|cmpb
name|r10
operator|,
name|$UDA50
name|bneq
literal|1f
name|movzbl
name|$9
operator|,
name|r10
comment|/* uda50 */
name|brb
literal|2f
literal|1
operator|:
name|movzwl
name|$UNSUPPORTED_DEVICE
operator|,
name|r7
name|halt
comment|/* unsupported device */
literal|2
operator|:
name|movl
name|ap
operator|,
name|r11
comment|/* software boot flags */
name|addl3
name|di_size
argument_list|(
name|r9
argument_list|)
operator|,
name|r9
operator|,
name|r2
comment|/* address to start clear */
name|moval
name|BOOTBASE
argument_list|(
name|r9
argument_list|)
operator|,
name|r1
comment|/* address to stop clearing */
literal|1
operator|:
name|cmpl
name|r2
operator|,
name|r1
name|bgeq
literal|2f
name|clrb
argument_list|(
name|r2
argument_list|)
operator|+
name|brb
literal|1b
literal|2
operator|:
name|calls
name|$0
operator|,
operator|(
name|r9
operator|)
name|movzwl
name|$RETURN_FROM_BOOT
operator|,
name|r7
name|halt
comment|/* end of program */
name|read_block
operator|:
operator|.
name|word
literal|0xffc
comment|/* r11-r2 */
name|clrq
operator|-
operator|(
name|sp
operator|)
comment|/* make room for the buf addr */
name|movl
name|driver_r1
argument_list|(
name|r11
argument_list|)
operator|,
name|r1
name|movl
name|driver_r2
argument_list|(
name|r11
argument_list|)
operator|,
name|r2
name|movl
name|driver_r3
argument_list|(
name|r11
argument_list|)
operator|,
name|r3
name|mull3
name|$2
operator|,
literal|4
operator|(
name|ap
operator|)
operator|,
name|r4
comment|/* mult by 2 to get lbn */
name|movl
name|r4
operator|,
name|r8
name|movl
literal|8
operator|(
name|ap
operator|)
operator|,
name|r5
name|addl3
name|r5
operator|,
name|r11
operator|,
operator|(
name|sp
operator|)
comment|/* for massbus babies */
name|jsb
operator|*
name|driver
argument_list|(
argument|r11
argument_list|)
comment|/* read the first block */
name|blbs
name|r0
operator|,
literal|1f
name|movzwl
name|$FILE_READ_ERROR
operator|,
name|r7
name|halt
comment|/* error reading file */
literal|1
operator|:
name|addl3
name|$1
operator|,
name|r4
operator|,
name|r8
name|addl2
name|$512
operator|,
name|r5
name|addl3
name|r5
operator|,
name|r11
operator|,
operator|(
name|sp
operator|)
comment|/* for massbus babies */
name|jsb
operator|*
name|driver
argument_list|(
argument|r11
argument_list|)
comment|/* read the second block */
name|blbs
name|r0
operator|,
literal|1f
name|movzwl
name|$FILE_READ_ERROR
operator|,
name|r7
name|halt
comment|/* error reading file */
literal|1
operator|:
name|ret
name|end
operator|:
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	@(#)ka780.c	7.1 (UofMD/Berkeley) %G%  */
end_comment

begin_if
if|#
directive|if
name|VAX780
end_if

begin_comment
comment|/*  * 780-specific code.  */
end_comment

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"cpu.h"
end_include

begin_include
include|#
directive|include
file|"mem.h"
end_include

begin_include
include|#
directive|include
file|"mtpr.h"
end_include

begin_comment
comment|/*  * Memory controller register usage varies per controller.  */
end_comment

begin_struct
struct|struct
name|mcr780
block|{
name|int
name|mc_reg
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|M780_ICRD
value|0x40000000
end_define

begin_comment
comment|/* inhibit crd interrupts, in [2] */
end_comment

begin_define
define|#
directive|define
name|M780_HIER
value|0x20000000
end_define

begin_comment
comment|/* high error rate, in reg[2] */
end_comment

begin_define
define|#
directive|define
name|M780_ERLOG
value|0x10000000
end_define

begin_comment
comment|/* error log request, in reg[2] */
end_comment

begin_comment
comment|/* on a 780, memory crd's occur only when bit 15 is set in the SBIER */
end_comment

begin_comment
comment|/* register; bit 14 there is an error bit which we also clear */
end_comment

begin_comment
comment|/* these bits are in the back of the ``red book'' (or in the VMS code) */
end_comment

begin_define
define|#
directive|define
name|M780C_INH
parameter_list|(
name|mcr
parameter_list|)
define|\
value|(((mcr)->mc_reg[2] = (M780_ICRD|M780_HIER|M780_ERLOG)), mtpr(SBIER, 0))
end_define

begin_define
define|#
directive|define
name|M780C_ENA
parameter_list|(
name|mcr
parameter_list|)
define|\
value|(((mcr)->mc_reg[2] = (M780_HIER|M780_ERLOG)), mtpr(SBIER, 3<<14))
end_define

begin_define
define|#
directive|define
name|M780C_ERR
parameter_list|(
name|mcr
parameter_list|)
define|\
value|((mcr)->mc_reg[2]& (M780_ERLOG))
end_define

begin_define
define|#
directive|define
name|M780C_SYN
parameter_list|(
name|mcr
parameter_list|)
value|((mcr)->mc_reg[2]& 0xff)
end_define

begin_define
define|#
directive|define
name|M780C_ADDR
parameter_list|(
name|mcr
parameter_list|)
value|(((mcr)->mc_reg[2]>> 8)& 0xfffff)
end_define

begin_define
define|#
directive|define
name|M780EL_INH
parameter_list|(
name|mcr
parameter_list|)
define|\
value|(((mcr)->mc_reg[2] = (M780_ICRD|M780_HIER|M780_ERLOG)), mtpr(SBIER, 0))
end_define

begin_define
define|#
directive|define
name|M780EL_ENA
parameter_list|(
name|mcr
parameter_list|)
define|\
value|(((mcr)->mc_reg[2] = (M780_HIER|M780_ERLOG)), mtpr(SBIER, 3<<14))
end_define

begin_define
define|#
directive|define
name|M780EL_ERR
parameter_list|(
name|mcr
parameter_list|)
define|\
value|((mcr)->mc_reg[2]& (M780_ERLOG))
end_define

begin_define
define|#
directive|define
name|M780EL_SYN
parameter_list|(
name|mcr
parameter_list|)
value|((mcr)->mc_reg[2]& 0x7f)
end_define

begin_define
define|#
directive|define
name|M780EL_ADDR
parameter_list|(
name|mcr
parameter_list|)
value|(((mcr)->mc_reg[2]>> 11)& 0x1ffff)
end_define

begin_define
define|#
directive|define
name|M780EU_INH
parameter_list|(
name|mcr
parameter_list|)
define|\
value|(((mcr)->mc_reg[3] = (M780_ICRD|M780_HIER|M780_ERLOG)), mtpr(SBIER, 0))
end_define

begin_define
define|#
directive|define
name|M780EU_ENA
parameter_list|(
name|mcr
parameter_list|)
define|\
value|(((mcr)->mc_reg[3] = (M780_HIER|M780_ERLOG)), mtpr(SBIER, 3<<14))
end_define

begin_define
define|#
directive|define
name|M780EU_ERR
parameter_list|(
name|mcr
parameter_list|)
define|\
value|((mcr)->mc_reg[3]& (M780_ERLOG))
end_define

begin_define
define|#
directive|define
name|M780EU_SYN
parameter_list|(
name|mcr
parameter_list|)
value|((mcr)->mc_reg[3]& 0x7f)
end_define

begin_define
define|#
directive|define
name|M780EU_ADDR
parameter_list|(
name|mcr
parameter_list|)
value|(((mcr)->mc_reg[3]>> 11)& 0x1ffff)
end_define

begin_comment
comment|/* enable crd interrrupts */
end_comment

begin_macro
name|ka780_memenable
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|mcr780
modifier|*
name|mcr
decl_stmt|;
specifier|register
name|int
name|m
decl_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|nmcr
condition|;
name|m
operator|++
control|)
block|{
name|mcr
operator|=
operator|(
expr|struct
name|mcr780
operator|*
operator|)
name|mcraddr
index|[
name|m
index|]
expr_stmt|;
switch|switch
condition|(
name|mcrtype
index|[
name|m
index|]
condition|)
block|{
case|case
name|M780C
case|:
name|M780C_ENA
argument_list|(
name|mcr
argument_list|)
expr_stmt|;
break|break;
case|case
name|M780EL
case|:
name|M780EL_ENA
argument_list|(
name|mcr
argument_list|)
expr_stmt|;
break|break;
case|case
name|M780EU
case|:
name|M780EU_ENA
argument_list|(
name|mcr
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_comment
comment|/* log crd errors */
end_comment

begin_macro
name|ka780_memerr
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|mcr780
modifier|*
name|mcr
decl_stmt|;
specifier|register
name|int
name|m
decl_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|nmcr
condition|;
name|m
operator|++
control|)
block|{
name|mcr
operator|=
operator|(
expr|struct
name|mcr780
operator|*
operator|)
name|mcraddr
index|[
name|m
index|]
expr_stmt|;
switch|switch
condition|(
name|mcrtype
index|[
name|m
index|]
condition|)
block|{
case|case
name|M780C
case|:
if|if
condition|(
name|M780C_ERR
argument_list|(
name|mcr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"mcr%d: soft ecc addr %x syn %x\n"
argument_list|,
name|m
argument_list|,
name|M780C_ADDR
argument_list|(
name|mcr
argument_list|)
argument_list|,
name|M780C_SYN
argument_list|(
name|mcr
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TRENDATA
name|memlog
argument_list|(
name|m
argument_list|,
name|mcr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|M780C_INH
argument_list|(
name|mcr
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|M780EL
case|:
if|if
condition|(
name|M780EL_ERR
argument_list|(
name|mcr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"mcr%d: soft ecc addr %x syn %x\n"
argument_list|,
name|m
argument_list|,
name|M780EL_ADDR
argument_list|(
name|mcr
argument_list|)
argument_list|,
name|M780EL_SYN
argument_list|(
name|mcr
argument_list|)
argument_list|)
expr_stmt|;
name|M780EL_INH
argument_list|(
name|mcr
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|M780EU
case|:
if|if
condition|(
name|M780EU_ERR
argument_list|(
name|mcr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"mcr%d: soft ecc addr %x syn %x\n"
argument_list|,
name|m
argument_list|,
name|M780EU_ADDR
argument_list|(
name|mcr
argument_list|)
argument_list|,
name|M780EU_SYN
argument_list|(
name|mcr
argument_list|)
argument_list|)
expr_stmt|;
name|M780EU_INH
argument_list|(
name|mcr
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|TRENDATA
end_ifdef

begin_comment
comment|/*  * Figure out what chip to replace on Trendata boards.  * Assumes all your memory is Trendata or the non-Trendata  * memory never fails..  */
end_comment

begin_struct
struct|struct
block|{
name|u_char
name|m_syndrome
decl_stmt|;
name|char
name|m_chip
index|[
literal|4
index|]
decl_stmt|;
block|}
name|memlogtab
index|[]
init|=
block|{
literal|0x01
block|,
literal|"C00"
block|,
literal|0x02
block|,
literal|"C01"
block|,
literal|0x04
block|,
literal|"C02"
block|,
literal|0x08
block|,
literal|"C03"
block|,
literal|0x10
block|,
literal|"C04"
block|,
literal|0x19
block|,
literal|"L01"
block|,
literal|0x1A
block|,
literal|"L02"
block|,
literal|0x1C
block|,
literal|"L04"
block|,
literal|0x1F
block|,
literal|"L07"
block|,
literal|0x20
block|,
literal|"C05"
block|,
literal|0x38
block|,
literal|"L00"
block|,
literal|0x3B
block|,
literal|"L03"
block|,
literal|0x3D
block|,
literal|"L05"
block|,
literal|0x3E
block|,
literal|"L06"
block|,
literal|0x40
block|,
literal|"C06"
block|,
literal|0x49
block|,
literal|"L09"
block|,
literal|0x4A
block|,
literal|"L10"
block|,
literal|0x4c
block|,
literal|"L12"
block|,
literal|0x4F
block|,
literal|"L15"
block|,
literal|0x51
block|,
literal|"L17"
block|,
literal|0x52
block|,
literal|"L18"
block|,
literal|0x54
block|,
literal|"L20"
block|,
literal|0x57
block|,
literal|"L23"
block|,
literal|0x58
block|,
literal|"L24"
block|,
literal|0x5B
block|,
literal|"L27"
block|,
literal|0x5D
block|,
literal|"L29"
block|,
literal|0x5E
block|,
literal|"L30"
block|,
literal|0x68
block|,
literal|"L08"
block|,
literal|0x6B
block|,
literal|"L11"
block|,
literal|0x6D
block|,
literal|"L13"
block|,
literal|0x6E
block|,
literal|"L14"
block|,
literal|0x70
block|,
literal|"L16"
block|,
literal|0x73
block|,
literal|"L19"
block|,
literal|0x75
block|,
literal|"L21"
block|,
literal|0x76
block|,
literal|"L22"
block|,
literal|0x79
block|,
literal|"L25"
block|,
literal|0x7A
block|,
literal|"L26"
block|,
literal|0x7C
block|,
literal|"L28"
block|,
literal|0x7F
block|,
literal|"L31"
block|,
literal|0x80
block|,
literal|"C07"
block|,
literal|0x89
block|,
literal|"U01"
block|,
literal|0x8A
block|,
literal|"U02"
block|,
literal|0x8C
block|,
literal|"U04"
block|,
literal|0x8F
block|,
literal|"U07"
block|,
literal|0x91
block|,
literal|"U09"
block|,
literal|0x92
block|,
literal|"U10"
block|,
literal|0x94
block|,
literal|"U12"
block|,
literal|0x97
block|,
literal|"U15"
block|,
literal|0x98
block|,
literal|"U16"
block|,
literal|0x9B
block|,
literal|"U19"
block|,
literal|0x9D
block|,
literal|"U21"
block|,
literal|0x9E
block|,
literal|"U22"
block|,
literal|0xA8
block|,
literal|"U00"
block|,
literal|0xAB
block|,
literal|"U03"
block|,
literal|0xAD
block|,
literal|"U05"
block|,
literal|0xAE
block|,
literal|"U06"
block|,
literal|0xB0
block|,
literal|"U08"
block|,
literal|0xB3
block|,
literal|"U11"
block|,
literal|0xB5
block|,
literal|"U13"
block|,
literal|0xB6
block|,
literal|"U14"
block|,
literal|0xB9
block|,
literal|"U17"
block|,
literal|0xBA
block|,
literal|"U18"
block|,
literal|0xBC
block|,
literal|"U20"
block|,
literal|0xBF
block|,
literal|"U23"
block|,
literal|0xC1
block|,
literal|"U25"
block|,
literal|0xC2
block|,
literal|"U26"
block|,
literal|0xC4
block|,
literal|"U28"
block|,
literal|0xC7
block|,
literal|"U31"
block|,
literal|0xE0
block|,
literal|"U24"
block|,
literal|0xE3
block|,
literal|"U27"
block|,
literal|0xE5
block|,
literal|"U29"
block|,
literal|0xE6
block|,
literal|"U30"
block|}
struct|;
end_struct

begin_macro
name|memlog
argument_list|(
argument|m
argument_list|,
argument|mcr
argument_list|)
end_macro

begin_decl_stmt
name|int
name|m
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|mcr780
modifier|*
name|mcr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|i
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|memlogtab
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|memlogtab
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
call|(
name|u_char
call|)
argument_list|(
name|M780C_SYN
argument_list|(
name|mcr
argument_list|)
argument_list|)
operator|==
name|memlogtab
index|[
name|i
index|]
operator|.
name|m_syndrome
condition|)
block|{
name|printf
argument_list|(
literal|"mcr%d: replace %s chip in %s bank of memory board %d (0-15)\n"
argument_list|,
name|m
argument_list|,
name|memlogtab
index|[
name|i
index|]
operator|.
name|m_chip
argument_list|,
operator|(
name|M780C_ADDR
argument_list|(
name|mcr
argument_list|)
operator|&
literal|0x8000
operator|)
condition|?
literal|"upper"
else|:
literal|"lower"
argument_list|,
operator|(
name|M780C_ADDR
argument_list|(
name|mcr
argument_list|)
operator|>>
literal|16
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"mcr%d: multiple errors, not traceable\n"
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|TRENDATA
end_endif

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|mc780750
index|[]
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|mc780frame
block|{
name|int
name|mc8_bcnt
decl_stmt|;
comment|/* byte count == 0x28 */
name|int
name|mc8_summary
decl_stmt|;
comment|/* summary parameter (as above) */
name|int
name|mc8_cpues
decl_stmt|;
comment|/* cpu error status */
name|int
name|mc8_upc
decl_stmt|;
comment|/* micro pc */
name|int
name|mc8_vaviba
decl_stmt|;
comment|/* va/viba register */
name|int
name|mc8_dreg
decl_stmt|;
comment|/* d register */
name|int
name|mc8_tber0
decl_stmt|;
comment|/* tbuf error reg 0 */
name|int
name|mc8_tber1
decl_stmt|;
comment|/* tbuf error reg 1 */
name|int
name|mc8_timo
decl_stmt|;
comment|/* timeout address divided by 4 */
name|int
name|mc8_parity
decl_stmt|;
comment|/* parity */
name|int
name|mc8_sbier
decl_stmt|;
comment|/* sbi error register */
name|int
name|mc8_pc
decl_stmt|;
comment|/* trapped pc */
name|int
name|mc8_psl
decl_stmt|;
comment|/* trapped psl */
block|}
struct|;
end_struct

begin_macro
name|ka780_mchk
argument_list|(
argument|cmcf
argument_list|)
end_macro

begin_decl_stmt
name|caddr_t
name|cmcf
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|mc780frame
modifier|*
name|mcf
init|=
operator|(
expr|struct
name|mc780frame
operator|*
operator|)
name|cmcf
decl_stmt|;
specifier|register
name|int
name|type
init|=
name|mcf
operator|->
name|mc8_summary
decl_stmt|;
specifier|register
name|int
name|sbifs
decl_stmt|;
name|printf
argument_list|(
literal|"machine check %x: %s%s\n"
argument_list|,
name|type
argument_list|,
name|mc780750
index|[
name|type
operator|&
literal|0xf
index|]
argument_list|,
operator|(
name|type
operator|&
literal|0xf0
operator|)
condition|?
literal|" abort"
else|:
literal|" fault"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tcpues %x upc %x va/viba %x dreg %x tber %x %x\n"
argument_list|,
name|mcf
operator|->
name|mc8_cpues
argument_list|,
name|mcf
operator|->
name|mc8_upc
argument_list|,
name|mcf
operator|->
name|mc8_vaviba
argument_list|,
name|mcf
operator|->
name|mc8_dreg
argument_list|,
name|mcf
operator|->
name|mc8_tber0
argument_list|,
name|mcf
operator|->
name|mc8_tber1
argument_list|)
expr_stmt|;
name|sbifs
operator|=
name|mfpr
argument_list|(
name|SBIFS
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\ttimo %x parity %x sbier %x pc %x psl %x sbifs %x\n"
argument_list|,
name|mcf
operator|->
name|mc8_timo
operator|*
literal|4
argument_list|,
name|mcf
operator|->
name|mc8_parity
argument_list|,
name|mcf
operator|->
name|mc8_sbier
argument_list|,
name|mcf
operator|->
name|mc8_pc
argument_list|,
name|mcf
operator|->
name|mc8_psl
argument_list|,
name|sbifs
argument_list|)
expr_stmt|;
comment|/* THE FUNNY BITS IN THE FOLLOWING ARE FROM THE ``BLACK BOOK'' */
comment|/* AND SHOULD BE PUT IN AN ``sbi.h'' */
name|mtpr
argument_list|(
name|SBIFS
argument_list|,
name|sbifs
operator|&
operator|~
literal|0x2000000
argument_list|)
expr_stmt|;
name|mtpr
argument_list|(
name|SBIER
argument_list|,
name|mfpr
argument_list|(
name|SBIER
argument_list|)
operator||
literal|0x70c0
argument_list|)
expr_stmt|;
return|return
operator|(
name|MCHK_PANIC
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1988 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Mt. Xinu.  *  * Redistribution is only permitted until one year after the first shipment  * of 4.4BSD by the Regents.  Otherwise, redistribution and use in source and  * binary forms are permitted provided that: (1) source distributions retain  * this entire copyright notice and comment, and (2) distributions including  * binaries display the following acknowledgement:  This product includes  * software developed by the University of California, Berkeley and its  * contributors'' in the documentation or other materials provided with the  * distribution and in all advertising materials mentioning features or use  * of this software.  Neither the name of the University nor the names of  * its contributors may be used to endorse or promote products derived from  * this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  *	@(#)ka650.c	7.6 (Berkeley) 6/28/90  */
end_comment

begin_if
if|#
directive|if
name|VAX650
end_if

begin_comment
comment|/*  * vax650-specific code.  */
end_comment

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"time.h"
end_include

begin_include
include|#
directive|include
file|"kernel.h"
end_include

begin_include
include|#
directive|include
file|"systm.h"
end_include

begin_include
include|#
directive|include
file|"cpu.h"
end_include

begin_include
include|#
directive|include
file|"clock.h"
end_include

begin_include
include|#
directive|include
file|"psl.h"
end_include

begin_include
include|#
directive|include
file|"mem.h"
end_include

begin_include
include|#
directive|include
file|"mtpr.h"
end_include

begin_include
include|#
directive|include
file|"ka650.h"
end_include

begin_macro
name|ka650_init
argument_list|()
end_macro

begin_block
block|{
name|ioaccess
argument_list|(
name|KA650_MERR
argument_list|,
name|KA650MERRmap
argument_list|,
sizeof|sizeof
argument_list|(
name|ka650merr
argument_list|)
argument_list|)
expr_stmt|;
name|ioaccess
argument_list|(
name|KA650_CBD
argument_list|,
name|KA650CBDmap
argument_list|,
sizeof|sizeof
argument_list|(
name|ka650cbd
argument_list|)
argument_list|)
expr_stmt|;
name|ioaccess
argument_list|(
name|KA650_SSC
argument_list|,
name|KA650SSCmap
argument_list|,
sizeof|sizeof
argument_list|(
name|ka650ssc
argument_list|)
argument_list|)
expr_stmt|;
name|ioaccess
argument_list|(
name|KA650_IPCR
argument_list|,
name|KA650IPCRmap
argument_list|,
sizeof|sizeof
argument_list|(
name|ka650ipcr
argument_list|)
argument_list|)
expr_stmt|;
name|ioaccess
argument_list|(
name|KA650_CACHE
argument_list|,
name|KA650CACHEmap
argument_list|,
name|KA650_CACHESIZE
argument_list|)
expr_stmt|;
name|ka650encache
argument_list|()
expr_stmt|;
if|if
condition|(
name|ctob
argument_list|(
name|physmem
argument_list|)
operator|>
name|ka650merr
operator|.
name|merr_qbmbr
condition|)
block|{
name|printf
argument_list|(
literal|"physmem(0x%x)> qbmbr(0x%x)\n"
argument_list|,
name|ctob
argument_list|(
name|physmem
argument_list|)
argument_list|,
name|ka650merr
operator|.
name|merr_qbmbr
argument_list|)
expr_stmt|;
name|panic
argument_list|(
literal|"qbus map unprotected"
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|ka650_clkstartrt
argument_list|()
end_macro

begin_block
block|{
name|mtpr
argument_list|(
name|ICCS
argument_list|,
name|ICCS_IE
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ka650_memnop
argument_list|()
end_macro

begin_block
block|{
comment|/* void */
block|}
end_block

begin_macro
name|ka650_memerr
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
specifier|register
name|int
name|m
decl_stmt|;
specifier|extern
name|u_int
name|cache2tag
decl_stmt|;
if|if
condition|(
name|ka650cbd
operator|.
name|cbd_cacr
operator|&
name|CACR_CPE
condition|)
block|{
name|printf
argument_list|(
literal|"cache 2 tag parity error: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|time
operator|.
name|tv_sec
operator|-
name|cache2tag
operator|<
literal|7
condition|)
block|{
name|ka650discache
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"cacheing disabled\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cache2tag
operator|=
name|time
operator|.
name|tv_sec
expr_stmt|;
name|printf
argument_list|(
literal|"flushing cache\n"
argument_list|)
expr_stmt|;
name|ka650encache
argument_list|()
expr_stmt|;
block|}
block|}
name|m
operator|=
name|ka650merr
operator|.
name|merr_errstat
expr_stmt|;
name|ka650merr
operator|.
name|merr_errstat
operator|=
name|MEM_EMASK
expr_stmt|;
if|if
condition|(
name|m
operator|&
name|MEM_CDAL
condition|)
block|{
name|cp
operator|=
literal|"Bus Parity"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|m
operator|&
name|MEM_RDS
condition|)
block|{
name|cp
operator|=
literal|"Hard ECC"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|m
operator|&
name|MEM_CRD
condition|)
block|{
name|cp
operator|=
literal|"Soft ECC"
expr_stmt|;
block|}
if|if
condition|(
name|cp
condition|)
block|{
name|printf
argument_list|(
literal|"%sMemory %s Error: page 0x%x\n"
argument_list|,
operator|(
name|m
operator|&
name|MEM_DMA
operator|)
condition|?
literal|"DMA "
else|:
literal|""
argument_list|,
name|cp
argument_list|,
operator|(
name|m
operator|&
name|MEM_PAGE
operator|)
operator|>>
name|MEM_PAGESHFT
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_define
define|#
directive|define
name|NMC650
value|15
end_define

begin_decl_stmt
name|char
modifier|*
name|mc650
index|[]
init|=
block|{
literal|0
block|,
literal|"FPA proto err"
block|,
literal|"FPA resv inst"
block|,
literal|"FPA Ill Stat 2"
block|,
literal|"FPA Ill Stat 1"
block|,
literal|"PTE in P0, TB miss"
block|,
literal|"PTE in P1, TB miss"
block|,
literal|"PTE in P0, Mod"
block|,
literal|"PTE in P1, Mod"
block|,
literal|"Illegal intr IPL"
block|,
literal|"MOVC state error"
block|,
literal|"bus read error"
block|,
literal|"SCB read error"
block|,
literal|"bus write error"
block|,
literal|"PCB write error"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int
name|cache1tag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int
name|cache1data
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int
name|cdalerr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int
name|cache2tag
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|mc650frame
block|{
name|int
name|mc65_bcnt
decl_stmt|;
comment|/* byte count == 0xc */
name|int
name|mc65_summary
decl_stmt|;
comment|/* summary parameter */
name|int
name|mc65_mrvaddr
decl_stmt|;
comment|/* most recent vad */
name|int
name|mc65_istate1
decl_stmt|;
comment|/* internal state */
name|int
name|mc65_istate2
decl_stmt|;
comment|/* internal state */
name|int
name|mc65_pc
decl_stmt|;
comment|/* trapped pc */
name|int
name|mc65_psl
decl_stmt|;
comment|/* trapped psl */
block|}
struct|;
end_struct

begin_macro
name|ka650_mchk
argument_list|(
argument|cmcf
argument_list|)
end_macro

begin_decl_stmt
name|caddr_t
name|cmcf
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|mc650frame
modifier|*
name|mcf
init|=
operator|(
expr|struct
name|mc650frame
operator|*
operator|)
name|cmcf
decl_stmt|;
specifier|register
name|u_int
name|type
init|=
name|mcf
operator|->
name|mc65_summary
decl_stmt|;
specifier|register
name|u_int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"machine check %x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|>=
literal|0x80
operator|&&
name|type
operator|<=
literal|0x83
condition|)
name|type
operator|-=
operator|(
literal|0x80
operator|+
literal|11
operator|)
expr_stmt|;
if|if
condition|(
name|type
operator|<
name|NMC650
operator|&&
name|mc650
index|[
name|type
index|]
condition|)
name|printf
argument_list|(
literal|": %s"
argument_list|,
name|mc650
index|[
name|type
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\tvap %x istate1 %x istate2 %x pc %x psl %x\n"
argument_list|,
name|mcf
operator|->
name|mc65_mrvaddr
argument_list|,
name|mcf
operator|->
name|mc65_istate1
argument_list|,
name|mcf
operator|->
name|mc65_istate2
argument_list|,
name|mcf
operator|->
name|mc65_pc
argument_list|,
name|mcf
operator|->
name|mc65_psl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dmaser=0x%b qbear=0x%x dmaear=0x%x\n"
argument_list|,
name|ka650merr
operator|.
name|merr_dser
argument_list|,
name|DMASER_BITS
argument_list|,
name|ka650merr
operator|.
name|merr_qbear
argument_list|,
name|ka650merr
operator|.
name|merr_dear
argument_list|)
expr_stmt|;
name|ka650merr
operator|.
name|merr_dser
operator|=
name|DSER_CLEAR
expr_stmt|;
name|i
operator|=
name|mfpr
argument_list|(
name|CAER
argument_list|)
expr_stmt|;
name|mtpr
argument_list|(
name|CAER
argument_list|,
name|CAER_MCC
operator||
name|CAER_DAT
operator||
name|CAER_TAG
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|CAER_MCC
condition|)
block|{
name|printf
argument_list|(
literal|"cache 1 "
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|CAER_DAT
condition|)
block|{
name|printf
argument_list|(
literal|"data"
argument_list|)
expr_stmt|;
name|i
operator|=
name|cache1data
expr_stmt|;
name|cache1data
operator|=
name|time
operator|.
name|tv_sec
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|&
name|CAER_TAG
condition|)
block|{
name|printf
argument_list|(
literal|"tag"
argument_list|)
expr_stmt|;
name|i
operator|=
name|cache1tag
expr_stmt|;
name|cache1tag
operator|=
name|time
operator|.
name|tv_sec
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|i
operator|&
name|CAER_MCD
operator|)
operator|||
operator|(
name|ka650merr
operator|.
name|merr_errstat
operator|&
name|MEM_CDAL
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"CDAL"
argument_list|)
expr_stmt|;
name|i
operator|=
name|cdalerr
expr_stmt|;
name|cdalerr
operator|=
name|time
operator|.
name|tv_sec
expr_stmt|;
block|}
if|if
condition|(
name|time
operator|.
name|tv_sec
operator|-
name|i
operator|<
literal|7
condition|)
block|{
name|ka650discache
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|" parity error:  cacheing disabled\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" parity error:  flushing cache\n"
argument_list|)
expr_stmt|;
name|ka650encache
argument_list|()
expr_stmt|;
block|}
comment|/* 	 * May be able to recover if type is 1-4, 0x80 or 0x81, but 	 * only if FPD is set in the saved PSL, or bit VCR in Istate2 	 * is clear. 	 */
if|if
condition|(
operator|(
name|type
operator|>
literal|0
operator|&&
name|type
operator|<
literal|5
operator|)
operator|||
name|type
operator|==
literal|11
operator|||
name|type
operator|==
literal|12
condition|)
block|{
if|if
condition|(
operator|(
name|mcf
operator|->
name|mc65_psl
operator|&
name|PSL_FPD
operator|)
operator|||
operator|!
operator|(
name|mcf
operator|->
name|mc65_istate2
operator|&
name|IS2_VCR
operator|)
condition|)
block|{
name|ka650_memerr
argument_list|()
expr_stmt|;
return|return
operator|(
name|MCHK_RECOVERED
operator|)
return|;
block|}
block|}
return|return
operator|(
name|MCHK_PANIC
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * Make sure both caches are off and not in diagnostic mode.  Clear the  * 2nd level cache (by writing to each quadword entry), then enable it.  * Enable 1st level cache too.  */
end_comment

begin_macro
name|ka650encache
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|ka650discache
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|KA650_CACHESIZE
operator|/
sizeof|sizeof
argument_list|(
name|ka650cache
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|+=
literal|2
control|)
name|ka650cache
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|ka650cbd
operator|.
name|cbd_cacr
operator|=
name|CACR_CEN
expr_stmt|;
name|mtpr
argument_list|(
name|CADR
argument_list|,
name|CADR_SEN2
operator||
name|CADR_SEN1
operator||
name|CADR_CENI
operator||
name|CADR_CEND
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ka650discache
argument_list|()
end_macro

begin_block
block|{
name|mtpr
argument_list|(
name|CADR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ka650cbd
operator|.
name|cbd_cacr
operator|=
name|CACR_CPE
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


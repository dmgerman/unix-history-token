begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* 	pitest.c		V1.0		      30 Aug 1988        */
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/*       ________________________________________________________        */
end_comment

begin_comment
comment|/*      /                                                        \       */
end_comment

begin_comment
comment|/*     |          AAA          CCCCCCCCCCCCCC    CCCCCCCCCCCCCC   |      */
end_comment

begin_comment
comment|/*     |         AAAAA        CCCCCCCCCCCCCCCC  CCCCCCCCCCCCCCCC  |      */
end_comment

begin_comment
comment|/*     |        AAAAAAA       CCCCCCCCCCCCCCCCC CCCCCCCCCCCCCCCCC |      */
end_comment

begin_comment
comment|/*     |       AAAA AAAA      CCCC              CCCC              |      */
end_comment

begin_comment
comment|/*     |      AAAA   AAAA     CCCC              CCCC              |      */
end_comment

begin_comment
comment|/*     |     AAAA     AAAA    CCCC              CCCC              |      */
end_comment

begin_comment
comment|/*     |    AAAA       AAAA   CCCC              CCCC              |      */
end_comment

begin_comment
comment|/*     |   AAAA  AAAAAAAAAAA  CCCCCCCCCCCCCCCCC CCCCCCCCCCCCCCCCC |      */
end_comment

begin_comment
comment|/*     |  AAAA    AAAAAAAAAAA CCCCCCCCCCCCCCCC  CCCCCCCCCCCCCCCC  |      */
end_comment

begin_comment
comment|/*     | AAAA      AAAAAAAAA   CCCCCCCCCCCCCC    CCCCCCCCCCCCCC   |      */
end_comment

begin_comment
comment|/*      \________________________________________________________/       */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/*  	Copyright (c) 1988 by Advanced Computer Communications           */
end_comment

begin_comment
comment|/*  	720 Santa Barbara Street, Santa Barbara, California  93101       */
end_comment

begin_comment
comment|/*  	(805) 963-9431                                                   */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/*  File:		pitest.c                                         */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/*  Author:		Brad Engstrom                                    */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/*  Project:		Installation verification program for ACC        */
end_comment

begin_comment
comment|/*			ACP 5250/6250 Programmers Interface.             */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/*  Function:                                                            */
end_comment

begin_comment
comment|/*	This program fork a child process, establishes an X.25 connection*/
end_comment

begin_comment
comment|/*	with it and sends data packets to the child.   The child echoes  */
end_comment

begin_comment
comment|/*	the packets back to the sender. The sender verifies the packets. */
end_comment

begin_comment
comment|/*	The program will print PASSED or FAILED to indicate the results  */
end_comment

begin_comment
comment|/*	of the test.							 */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/*  Components:		pitest.c, /sys/vaxif/if_pivar.h                  */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/*  Revision History:                                                    */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/* 30-AUG-1988  Brad Engstrom:  first generated.                         */
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"/sys/vaxif/if_pivar.h"
end_include

begin_define
define|#
directive|define
name|PIPROTOCOL
value|7
end_define

begin_define
define|#
directive|define
name|CALL
value|0x0
end_define

begin_define
define|#
directive|define
name|ANSWER
value|0x3
end_define

begin_define
define|#
directive|define
name|RING
value|0x1
end_define

begin_define
define|#
directive|define
name|CLEAR
value|0x4
end_define

begin_comment
comment|/* PREDEFINED SUPERVISORY MESSAGES */
end_comment

begin_decl_stmt
name|u_char
name|callmsg
index|[]
init|=
block|{
name|CALL
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x22
block|,
literal|0xe
block|,
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|8
block|,
literal|0
block|,
literal|5
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0xe
block|,
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|8
block|,
literal|0
block|,
literal|5
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
name|PIPROTOCOL
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|clearmsg
index|[]
init|=
block|{
name|CLEAR
block|,
literal|0x0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DATABUFSIZE
value|1024
end_define

begin_decl_stmt
name|u_char
name|databuffer
index|[
name|DATABUFSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|readbuffer
index|[
name|DATABUFSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PACKETSTOSEND
value|75
end_define

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|fd1
decl_stmt|,
name|fd2
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: pitest xxdev1 xxdev2\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|fd1
operator|=
name|open
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd2
operator|=
name|open
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|fork
argument_list|()
condition|)
block|{
name|caller
argument_list|(
name|fd1
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"pitest: PASSED\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|callee
argument_list|(
name|fd2
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_macro
name|caller
argument_list|(
argument|fd
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|lcn
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|pi_dblock
name|pd
decl_stmt|,
name|rd
decl_stmt|;
name|caddr_t
name|cp
decl_stmt|;
name|char
name|c
decl_stmt|;
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
comment|/* give callee chance to set up */
comment|/*      * RESERVE THE LOGICAL CIRCUIT TO USE       */
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOGETLCN
argument_list|,
operator|&
name|lcn
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"caller: XIOGETLCN"
argument_list|)
expr_stmt|;
name|lcn
operator|&=
literal|0xff
expr_stmt|;
comment|/*      * MAKE THE CALL       */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Making X.25 call...\n"
argument_list|)
expr_stmt|;
name|callmsg
index|[
literal|1
index|]
operator|=
name|lcn
operator|*
literal|2
expr_stmt|;
name|pd
operator|.
name|dataptr
operator|=
operator|(
name|caddr_t
operator|)
name|callmsg
expr_stmt|;
name|pd
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|callmsg
argument_list|)
expr_stmt|;
name|pd
operator|.
name|lcn
operator|=
literal|0
expr_stmt|;
name|pd
operator|.
name|subfunc
operator|=
literal|0
expr_stmt|;
name|pd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOWRITE
argument_list|,
operator|&
name|pd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"caller: XIOWRITE"
argument_list|)
expr_stmt|;
comment|/*      * READ AND CHECK THAT WE GOT AN ANSWER MESSAGE       */
name|pd
operator|.
name|dataptr
operator|=
operator|(
name|caddr_t
operator|)
name|databuffer
expr_stmt|;
name|pd
operator|.
name|length
operator|=
name|DATABUFSIZE
expr_stmt|;
name|pd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOREAD
argument_list|,
operator|&
name|pd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"caller: XIOREAD"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|.
name|lcn
operator|!=
literal|0
operator|||
name|pd
operator|.
name|dataptr
index|[
literal|0
index|]
operator|!=
name|ANSWER
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"caller: did not get answer message\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"X.25 connection established\n"
argument_list|)
expr_stmt|;
comment|/*      * SEND 25 DATA PACKETS, EXPECT THEM TO BE ECHOED       */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sending and verifying data packets\n"
argument_list|)
expr_stmt|;
name|pd
operator|.
name|dataptr
operator|=
operator|(
name|caddr_t
operator|)
name|databuffer
expr_stmt|;
name|pd
operator|.
name|subfunc
operator|=
literal|0
expr_stmt|;
name|pd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|pd
operator|.
name|lcn
operator|=
name|lcn
expr_stmt|;
comment|/* fill buffer with data */
for|for
control|(
name|cp
operator|=
name|pd
operator|.
name|dataptr
operator|,
name|c
operator|=
literal|'0'
init|;
name|cp
operator|<
name|pd
operator|.
name|dataptr
operator|+
name|DATABUFSIZE
condition|;
name|cp
operator|++
control|)
block|{
operator|*
name|cp
operator|=
name|c
expr_stmt|;
if|if
condition|(
operator|++
name|c
operator|>
literal|'9'
condition|)
name|c
operator|=
literal|'0'
expr_stmt|;
block|}
name|srandom
argument_list|(
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PACKETSTOSEND
condition|;
name|i
operator|++
control|)
block|{
name|pd
operator|.
name|length
operator|=
name|random
argument_list|()
operator|&
literal|0x3ff
expr_stmt|;
if|if
condition|(
name|pd
operator|.
name|length
operator|==
literal|0
condition|)
name|pd
operator|.
name|length
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOWRITE
argument_list|,
operator|&
name|pd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"caller: XIOWRITE"
argument_list|)
expr_stmt|;
name|rd
operator|.
name|dataptr
operator|=
operator|(
name|caddr_t
operator|)
name|readbuffer
expr_stmt|;
name|rd
operator|.
name|length
operator|=
name|DATABUFSIZE
expr_stmt|;
name|rd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOREAD
argument_list|,
operator|&
name|rd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"caller: XIOREAD"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|.
name|lcn
operator|!=
name|lcn
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"caller: mismatched lcn (%d != %d)\n"
argument_list|,
name|rd
operator|.
name|lcn
argument_list|,
name|lcn
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rd
operator|.
name|length
operator|!=
name|pd
operator|.
name|length
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"caller: mismatched length\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bcmp
argument_list|(
name|pd
operator|.
name|dataptr
argument_list|,
name|rd
operator|.
name|dataptr
argument_list|,
name|rd
operator|.
name|length
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"caller: data does not match\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"+"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/*      * CLEAR THE CALL.       */
name|clearmsg
index|[
literal|1
index|]
operator|=
name|lcn
operator|*
literal|2
expr_stmt|;
name|pd
operator|.
name|dataptr
operator|=
operator|(
name|caddr_t
operator|)
name|clearmsg
expr_stmt|;
name|pd
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|clearmsg
argument_list|)
expr_stmt|;
name|pd
operator|.
name|lcn
operator|=
literal|0
expr_stmt|;
name|pd
operator|.
name|subfunc
operator|=
literal|0
expr_stmt|;
name|pd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOWRITE
argument_list|,
operator|&
name|pd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"caller: XIOWRITE"
argument_list|)
expr_stmt|;
comment|/*      * WAIT FOR CLEAR CONFIRMATION       */
for|for
control|(
init|;
condition|;
control|)
block|{
name|pd
operator|.
name|dataptr
operator|=
operator|(
name|caddr_t
operator|)
name|databuffer
expr_stmt|;
name|pd
operator|.
name|length
operator|=
name|DATABUFSIZE
expr_stmt|;
name|pd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOREAD
argument_list|,
operator|&
name|pd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"caller: XIOREAD"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|.
name|lcn
operator|==
literal|0
operator|&&
name|pd
operator|.
name|dataptr
index|[
literal|0
index|]
operator|==
name|CLEAR
condition|)
break|break;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"caller: packet was not a clear\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * FREE THE LOGICAL CHANNEL AND RESOURCES       */
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOFREELCN
argument_list|,
operator|&
name|lcn
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"caller: XIOFREELCN"
argument_list|)
expr_stmt|;
comment|/*      * CLOSE THE DEVICE       */
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|callee
argument_list|(
argument|fd
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|pi_dblock
name|pd
decl_stmt|,
name|rd
decl_stmt|;
name|proto_range
name|pr
decl_stmt|;
name|int
name|lcn
decl_stmt|,
name|i
decl_stmt|;
comment|/*      * RESERVE THE LOGICAL CIRCUIT TO USE       */
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOGETLCN
argument_list|,
operator|&
name|lcn
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"callee: XIOGETLCN"
argument_list|)
expr_stmt|;
name|lcn
operator|&=
literal|0xff
expr_stmt|;
comment|/*      * TELL THE DRIVER WHICH PROTOCOLS THIS CHANNEL WILL ACCEPT       */
name|pr
operator|.
name|lower
operator|=
name|PIPROTOCOL
expr_stmt|;
name|pr
operator|.
name|upper
operator|=
name|PIPROTOCOL
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOACCRING
argument_list|,
operator|&
name|pr
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"callee: XIOACCRING"
argument_list|)
expr_stmt|;
comment|/*      * WAIT FOR A RING TO COME IN AND THEN ANSWER IT.       */
for|for
control|(
init|;
condition|;
control|)
block|{
name|pd
operator|.
name|dataptr
operator|=
operator|(
name|caddr_t
operator|)
name|databuffer
expr_stmt|;
name|pd
operator|.
name|length
operator|=
name|DATABUFSIZE
expr_stmt|;
name|pd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOREAD
argument_list|,
operator|&
name|pd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"XIOREAD"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|.
name|lcn
operator|==
literal|0
operator|&&
name|pd
operator|.
name|dataptr
index|[
literal|0
index|]
operator|==
name|RING
condition|)
block|{
name|databuffer
index|[
literal|0
index|]
operator|=
name|ANSWER
expr_stmt|;
name|databuffer
index|[
literal|1
index|]
operator|=
name|lcn
operator|*
literal|2
expr_stmt|;
comment|/* databuffer[2] already has data */
name|databuffer
index|[
literal|3
index|]
operator|=
literal|6
expr_stmt|;
name|databuffer
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
comment|/* length of called addr */
name|databuffer
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
comment|/* length of calling addr */
name|databuffer
index|[
literal|6
index|]
operator|=
literal|1
expr_stmt|;
comment|/* length of protocol */
name|databuffer
index|[
literal|7
index|]
operator|=
name|PIPROTOCOL
expr_stmt|;
comment|/* use protocol 7 */
name|databuffer
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
comment|/* length of facilities */
name|databuffer
index|[
literal|9
index|]
operator|=
literal|0
expr_stmt|;
comment|/* length of user data */
name|pd
operator|.
name|length
operator|=
literal|10
expr_stmt|;
name|pd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|pd
operator|.
name|lcn
operator|=
literal|0
expr_stmt|;
name|pd
operator|.
name|subfunc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOWRITE
argument_list|,
operator|&
name|pd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"XIOWRITE"
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"callee: packet was not a ring\n"
argument_list|)
expr_stmt|;
block|}
comment|/*      * ECHO 25 PACKETS       */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PACKETSTOSEND
condition|;
name|i
operator|++
control|)
block|{
name|rd
operator|.
name|dataptr
operator|=
operator|(
name|caddr_t
operator|)
name|readbuffer
expr_stmt|;
name|rd
operator|.
name|length
operator|=
name|DATABUFSIZE
expr_stmt|;
name|rd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOREAD
argument_list|,
operator|&
name|rd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"callee: XIOREAD"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|.
name|lcn
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"callee: unexpected supervisor message\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOWRITE
argument_list|,
operator|&
name|rd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"callee: XIOWRITE"
argument_list|)
expr_stmt|;
block|}
comment|/*      * WAIT FOR THE CLEAR      */
for|for
control|(
init|;
condition|;
control|)
block|{
name|pd
operator|.
name|dataptr
operator|=
operator|(
name|caddr_t
operator|)
name|databuffer
expr_stmt|;
name|pd
operator|.
name|length
operator|=
name|DATABUFSIZE
expr_stmt|;
name|pd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOREAD
argument_list|,
operator|&
name|pd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"callee: XIOREAD"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|.
name|lcn
operator|==
literal|0
operator|&&
name|pd
operator|.
name|dataptr
index|[
literal|0
index|]
operator|==
name|CLEAR
condition|)
break|break;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"callee: packet was not a clear\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * SEND A CLEAR CONFIRMATION      */
name|pd
operator|.
name|dataptr
index|[
literal|1
index|]
operator|=
name|lcn
operator|*
literal|2
expr_stmt|;
comment|/* patch up clear message and send it back */
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOWRITE
argument_list|,
operator|&
name|pd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"callee: XIOREAD"
argument_list|)
expr_stmt|;
comment|/*      * FREE THE LOGICAL CHANNEL AND RESOURCES       */
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|XIOFREELCN
argument_list|,
operator|&
name|lcn
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"callee: XIOFREELCN"
argument_list|)
expr_stmt|;
comment|/*      * CLOSE THE DEVICE       */
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|error
argument_list|(
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|perror
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
literal|"pitest: FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* if_en.c 4.10 81/11/18 */
end_comment

begin_include
include|#
directive|include
file|"en.h"
end_include

begin_comment
comment|/*  * Ethernet interface driver  */
end_comment

begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/systm.h"
end_include

begin_include
include|#
directive|include
file|"../h/mbuf.h"
end_include

begin_include
include|#
directive|include
file|"../net/inet.h"
end_include

begin_include
include|#
directive|include
file|"../net/inet_pcb.h"
end_include

begin_include
include|#
directive|include
file|"../net/inet_systm.h"
end_include

begin_include
include|#
directive|include
file|"../net/imp.h"
end_include

begin_include
include|#
directive|include
file|"../net/ip.h"
end_include

begin_include
include|#
directive|include
file|"../net/ip_var.h"
end_include

begin_include
include|#
directive|include
file|"../net/tcp.h"
end_include

begin_comment
comment|/* XXX */
end_comment

begin_include
include|#
directive|include
file|"../net/tcp_var.h"
end_include

begin_include
include|#
directive|include
file|"../h/map.h"
end_include

begin_include
include|#
directive|include
file|"../h/pte.h"
end_include

begin_include
include|#
directive|include
file|"../h/buf.h"
end_include

begin_include
include|#
directive|include
file|"../h/ubareg.h"
end_include

begin_include
include|#
directive|include
file|"../h/ubavar.h"
end_include

begin_include
include|#
directive|include
file|"../h/conf.h"
end_include

begin_include
include|#
directive|include
file|"../h/dir.h"
end_include

begin_include
include|#
directive|include
file|"../h/user.h"
end_include

begin_include
include|#
directive|include
file|"../h/proc.h"
end_include

begin_include
include|#
directive|include
file|"../h/enreg.h"
end_include

begin_include
include|#
directive|include
file|"../h/mtpr.h"
end_include

begin_include
include|#
directive|include
file|"../h/cpu.h"
end_include

begin_include
include|#
directive|include
file|"../h/cmap.h"
end_include

begin_decl_stmt
name|int
name|enrswaps
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* int	enwswaps; */
end_comment

begin_decl_stmt
name|int
name|enprobe
argument_list|()
decl_stmt|,
name|enattach
argument_list|()
decl_stmt|,
name|enrint
argument_list|()
decl_stmt|,
name|enxint
argument_list|()
decl_stmt|,
name|encollide
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uba_device
modifier|*
name|eninfo
index|[
name|NEN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_short
name|enstd
index|[]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uba_driver
name|endriver
init|=
block|{
name|enprobe
block|,
literal|0
block|,
name|enattach
block|,
literal|0
block|,
name|enstd
block|,
literal|"en"
block|,
name|eninfo
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ENUNIT
parameter_list|(
name|x
parameter_list|)
value|minor(x)
end_define

begin_decl_stmt
name|struct
name|en_packet
modifier|*
name|xpkt
decl_stmt|,
modifier|*
name|rpkt
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|en_prefix
block|{
name|struct
name|en_header
name|enp_h
decl_stmt|;
name|struct
name|tcpiphdr
name|enp_th
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|uba_regs
modifier|*
name|enuba
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pte
modifier|*
name|enrmr
decl_stmt|,
modifier|*
name|enxmr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|enrbdp
decl_stmt|,
name|enwbdp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|enrproto
decl_stmt|,
name|enwproto
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pte
name|enxmap
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|enxswapd
decl_stmt|;
end_decl_stmt

begin_macro
name|enprobe
argument_list|(
argument|reg
argument_list|)
end_macro

begin_decl_stmt
name|caddr_t
name|reg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|br
decl_stmt|,
name|cvec
decl_stmt|;
specifier|register
name|struct
name|endevice
modifier|*
name|addr
init|=
operator|(
expr|struct
name|endevice
operator|*
operator|)
name|reg
decl_stmt|;
ifdef|#
directive|ifdef
name|lint
name|br
operator|=
literal|0
expr_stmt|;
name|cvec
operator|=
name|br
expr_stmt|;
name|br
operator|=
name|cvec
expr_stmt|;
name|enrint
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|enxint
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|encollide
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|addr
operator|->
name|en_istat
operator|=
literal|0
expr_stmt|;
name|addr
operator|->
name|en_ostat
operator|=
literal|0
expr_stmt|;
name|addr
operator|->
name|en_owc
operator|=
operator|-
literal|1
expr_stmt|;
name|addr
operator|->
name|en_oba
operator|=
literal|0
expr_stmt|;
name|addr
operator|->
name|en_ostat
operator|=
name|EN_IEN
operator||
name|EN_GO
expr_stmt|;
name|DELAY
argument_list|(
literal|100000
argument_list|)
expr_stmt|;
name|addr
operator|->
name|en_ostat
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"ethernet address %d\n"
argument_list|,
operator|~
name|addr
operator|->
name|en_addr
operator|&
literal|0xff
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|enattach
argument_list|(
argument|ui
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|uba_device
modifier|*
name|ui
decl_stmt|;
end_decl_stmt

begin_block
block|{  }
end_block

begin_macro
name|eninit
argument_list|(
argument|unit
argument_list|)
end_macro

begin_decl_stmt
name|int
name|unit
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|endevice
modifier|*
name|addr
decl_stmt|;
specifier|register
name|struct
name|uba_device
modifier|*
name|ui
decl_stmt|;
name|int
name|uban
decl_stmt|,
name|x
decl_stmt|;
specifier|static
name|reenter
expr_stmt|;
if|if
condition|(
name|unit
operator|>=
name|NEN
operator|||
operator|(
name|ui
operator|=
name|eninfo
index|[
name|unit
index|]
operator|)
operator|==
literal|0
operator|||
name|ui
operator|->
name|ui_alive
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"en%d: not alive\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
return|return;
block|}
name|x
operator|=
name|splimp
argument_list|()
expr_stmt|;
if|if
condition|(
name|reenter
operator|==
literal|0
condition|)
block|{
name|int
name|n
decl_stmt|,
name|j
decl_stmt|,
name|i
decl_stmt|,
name|k
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|reenter
operator|=
literal|1
expr_stmt|;
name|n
operator|=
literal|10
expr_stmt|;
name|k
operator|=
name|n
operator|<<
literal|1
expr_stmt|;
name|i
operator|=
name|rmalloc
argument_list|(
name|mbmap
argument_list|,
name|n
operator|*
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"eninit"
argument_list|)
expr_stmt|;
name|j
operator|=
name|i
operator|<<
literal|1
expr_stmt|;
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
name|pftom
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|memall
argument_list|(
operator|&
name|Mbmap
index|[
name|j
index|]
argument_list|,
name|k
argument_list|,
name|proc
argument_list|,
name|CSYS
argument_list|)
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"eninit"
argument_list|)
expr_stmt|;
name|vmaccess
argument_list|(
operator|&
name|Mbmap
index|[
name|j
index|]
argument_list|,
operator|(
name|caddr_t
operator|)
name|cp
argument_list|,
name|k
argument_list|)
expr_stmt|;
name|rpkt
operator|=
operator|(
expr|struct
name|en_packet
operator|*
operator|)
operator|(
name|cp
operator|+
literal|1024
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|en_prefix
argument_list|)
operator|)
expr_stmt|;
name|xpkt
operator|=
operator|(
expr|struct
name|en_packet
operator|*
operator|)
operator|(
name|cp
operator|+
literal|5
operator|*
literal|1024
operator|+
literal|1024
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|en_prefix
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|n
condition|;
name|j
operator|++
control|)
name|mprefcnt
index|[
name|i
operator|+
name|j
index|]
operator|=
literal|1
expr_stmt|;
block|}
name|uban
operator|=
name|ui
operator|->
name|ui_ubanum
expr_stmt|;
name|addr
operator|=
operator|(
expr|struct
name|endevice
operator|*
operator|)
name|ui
operator|->
name|ui_addr
expr_stmt|;
name|addr
operator|->
name|en_istat
operator|=
literal|0
expr_stmt|;
name|addr
operator|->
name|en_ostat
operator|=
literal|0
expr_stmt|;
name|imp_stat
operator|.
name|iaddr
operator|=
name|uballoc
argument_list|(
name|uban
argument_list|,
operator|(
name|caddr_t
operator|)
name|rpkt
argument_list|,
literal|1024
operator|+
literal|512
argument_list|,
name|UBA_NEED16
operator||
name|UBA_NEEDBDP
argument_list|)
expr_stmt|;
name|imp_stat
operator|.
name|oaddr
operator|=
name|uballoc
argument_list|(
name|uban
argument_list|,
operator|(
name|caddr_t
operator|)
name|xpkt
argument_list|,
literal|1024
operator|+
literal|512
argument_list|,
name|UBA_NEED16
operator||
name|UBA_NEEDBDP
argument_list|)
expr_stmt|;
name|enuba
operator|=
name|ui
operator|->
name|ui_hd
operator|->
name|uh_uba
expr_stmt|;
name|enrbdp
operator|=
operator|(
name|imp_stat
operator|.
name|iaddr
operator|>>
literal|28
operator|)
operator|&
literal|0xf
expr_stmt|;
name|enwbdp
operator|=
operator|(
name|imp_stat
operator|.
name|oaddr
operator|>>
literal|28
operator|)
operator|&
literal|0xf
expr_stmt|;
name|enrproto
operator|=
name|UBAMR_MRV
operator||
operator|(
name|enrbdp
operator|<<
literal|21
operator|)
expr_stmt|;
name|enwproto
operator|=
name|UBAMR_MRV
operator||
operator|(
name|enwbdp
operator|<<
literal|21
operator|)
expr_stmt|;
name|enrmr
operator|=
operator|&
name|enuba
operator|->
name|uba_map
index|[
operator|(
operator|(
name|imp_stat
operator|.
name|iaddr
operator|>>
literal|9
operator|)
operator|&
literal|0x1ff
operator|)
operator|+
literal|1
index|]
expr_stmt|;
name|enxmr
operator|=
operator|&
name|enuba
operator|->
name|uba_map
index|[
operator|(
operator|(
name|imp_stat
operator|.
name|oaddr
operator|>>
literal|9
operator|)
operator|&
literal|0x1ff
operator|)
operator|+
literal|1
index|]
expr_stmt|;
name|enxmap
index|[
literal|0
index|]
operator|=
name|enxmr
index|[
literal|0
index|]
expr_stmt|;
name|enxmap
index|[
literal|1
index|]
operator|=
name|enxmr
index|[
literal|1
index|]
expr_stmt|;
name|enxswapd
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"enrbdp %x enrproto %x enrmr %x imp_stat.iaddr %x\n"
argument_list|,
name|enrbdp
argument_list|,
name|enrproto
argument_list|,
name|enrmr
argument_list|,
name|imp_stat
operator|.
name|iaddr
argument_list|)
expr_stmt|;
name|imp_stat
operator|.
name|impopen
operator|=
literal|1
expr_stmt|;
name|imp_stat
operator|.
name|flush
operator|=
literal|0
expr_stmt|;
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IMPDEBUG
name|printf
argument_list|(
literal|"eninit(%d): iaddr = %x, oaddr = %x\n"
argument_list|,
name|unit
argument_list|,
name|imp_stat
operator|.
name|iaddr
argument_list|,
name|imp_stat
operator|.
name|oaddr
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_block

begin_macro
name|enreset
argument_list|(
argument|uban
argument_list|)
end_macro

begin_decl_stmt
name|int
name|uban
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|unit
decl_stmt|;
name|struct
name|uba_device
modifier|*
name|ui
decl_stmt|;
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|NEN
condition|;
name|unit
operator|++
control|)
block|{
name|ui
operator|=
name|eninfo
index|[
name|unit
index|]
expr_stmt|;
if|if
condition|(
name|ui
operator|==
literal|0
operator|||
name|ui
operator|->
name|ui_ubanum
operator|!=
name|uban
operator|||
name|ui
operator|->
name|ui_alive
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|imp_stat
operator|.
name|iaddr
condition|)
name|ubarelse
argument_list|(
name|uban
argument_list|,
operator|&
name|imp_stat
operator|.
name|iaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|imp_stat
operator|.
name|oaddr
condition|)
name|ubarelse
argument_list|(
name|uban
argument_list|,
operator|&
name|imp_stat
operator|.
name|oaddr
argument_list|)
expr_stmt|;
name|eninit
argument_list|(
name|unit
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"en%d "
argument_list|,
name|unit
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_decl_stmt
name|int
name|enlastdel
init|=
literal|25
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|enlastx
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_macro
name|enstart
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|mp
decl_stmt|;
specifier|register
name|struct
name|endevice
modifier|*
name|addr
decl_stmt|;
specifier|register
name|caddr_t
name|cp
decl_stmt|,
name|top
decl_stmt|;
name|int
name|unit
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
name|struct
name|uba_device
modifier|*
name|ui
decl_stmt|;
name|int
name|enxswapnow
init|=
literal|0
decl_stmt|;
name|COUNT
argument_list|(
name|ENSTART
argument_list|)
expr_stmt|;
name|unit
operator|=
name|ENUNIT
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ui
operator|=
name|eninfo
index|[
name|unit
index|]
expr_stmt|;
if|if
condition|(
name|ui
operator|==
literal|0
operator|||
name|ui
operator|->
name|ui_alive
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"en%d (imp_output): not alive\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
return|return;
block|}
name|addr
operator|=
operator|(
expr|struct
name|endevice
operator|*
operator|)
name|ui
operator|->
name|ui_addr
expr_stmt|;
if|if
condition|(
operator|!
name|imp_stat
operator|.
name|outactive
condition|)
block|{
if|if
condition|(
operator|(
name|m
operator|=
name|imp_stat
operator|.
name|outq_head
operator|)
operator|==
name|NULL
condition|)
return|return;
name|imp_stat
operator|.
name|outactive
operator|=
literal|1
expr_stmt|;
comment|/* set myself active */
name|imp_stat
operator|.
name|outq_head
operator|=
name|m
operator|->
name|m_act
expr_stmt|;
comment|/* -> next packet chain */
comment|/* 		 * Pack mbufs into ethernet packet. 		 */
name|cp
operator|=
operator|(
name|caddr_t
operator|)
name|xpkt
expr_stmt|;
name|top
operator|=
operator|(
name|caddr_t
operator|)
name|xpkt
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|en_packet
argument_list|)
expr_stmt|;
while|while
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|dp
decl_stmt|;
if|if
condition|(
name|cp
operator|+
name|m
operator|->
name|m_len
operator|>
name|top
condition|)
block|{
name|printf
argument_list|(
literal|"imp_snd: my packet runneth over\n"
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
name|dp
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|char
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|int
operator|)
name|cp
operator|&
literal|0x3ff
operator|)
operator|==
literal|0
operator|&&
operator|(
operator|(
name|int
operator|)
name|dp
operator|&
literal|0x3ff
operator|)
operator|==
literal|0
condition|)
block|{
name|struct
name|pte
modifier|*
name|pte
init|=
operator|&
name|Mbmap
index|[
name|mtopf
argument_list|(
name|dp
argument_list|)
operator|*
literal|2
index|]
decl_stmt|;
operator|*
operator|(
name|int
operator|*
operator|)
name|enxmr
operator|=
name|enwproto
operator||
name|pte
operator|++
operator|->
name|pg_pfnum
expr_stmt|;
operator|*
operator|(
name|int
operator|*
operator|)
operator|(
name|enxmr
operator|+
literal|1
operator|)
operator|=
name|enwproto
operator||
name|pte
operator|->
name|pg_pfnum
expr_stmt|;
name|enxswapd
operator|=
name|enxswapnow
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|bcopy
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
name|cp
argument_list|,
operator|(
name|unsigned
operator|)
name|m
operator|->
name|m_len
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
comment|/* too soon! */
name|MFREE
argument_list|(
name|m
argument_list|,
name|mp
argument_list|)
expr_stmt|;
name|m
operator|=
name|mp
expr_stmt|;
block|}
if|if
condition|(
name|enxswapnow
operator|==
literal|0
operator|&&
name|enxswapd
condition|)
block|{
name|enxmr
index|[
literal|0
index|]
operator|=
name|enxmap
index|[
literal|0
index|]
expr_stmt|;
name|enxmr
index|[
literal|1
index|]
operator|=
name|enxmap
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|enlastx
operator|&&
name|enlastx
operator|==
name|xpkt
operator|->
name|Header
operator|.
name|en_dhost
condition|)
name|imp_stat
operator|.
name|endelay
operator|=
name|enlastdel
expr_stmt|;
else|else
name|enlastx
operator|=
name|xpkt
operator|->
name|Header
operator|.
name|en_dhost
expr_stmt|;
block|}
name|len
operator|=
name|ntohs
argument_list|(
call|(
name|u_short
call|)
argument_list|(
operator|(
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
operator|(
name|int
operator|)
name|xpkt
operator|+
name|L1822
operator|)
operator|)
operator|->
name|ip_len
argument_list|)
argument_list|)
operator|+
name|L1822
expr_stmt|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|en_packet
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"imp_output: ridiculous IP length %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VAX780
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX750
argument_list|)
switch|switch
condition|(
name|cpu
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VAX780
argument_list|)
case|case
name|VAX_780
case|:
name|UBA_PURGE780
argument_list|(
name|enuba
argument_list|,
name|enwbdp
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
case|case
name|VAX_750
case|:
name|UBA_PURGE750
argument_list|(
name|enuba
argument_list|,
name|enwbdp
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
endif|#
directive|endif
name|addr
operator|->
name|en_oba
operator|=
name|imp_stat
operator|.
name|oaddr
expr_stmt|;
name|addr
operator|->
name|en_odelay
operator|=
name|imp_stat
operator|.
name|endelay
expr_stmt|;
name|addr
operator|->
name|en_owc
operator|=
operator|-
operator|(
operator|(
name|len
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IMPDEBUG
name|printf
argument_list|(
literal|"en%d: sending packet (%d bytes)\n"
argument_list|,
name|unit
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|prt_byte
argument_list|(
name|xpkt
argument_list|,
name|len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|addr
operator|->
name|en_ostat
operator|=
name|EN_IEN
operator||
name|EN_GO
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Output interrupt handler.  */
end_comment

begin_macro
name|enxint
argument_list|(
argument|unit
argument_list|)
end_macro

begin_decl_stmt
name|int
name|unit
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|endevice
modifier|*
name|addr
decl_stmt|;
specifier|register
name|struct
name|uba_device
modifier|*
name|ui
decl_stmt|;
name|COUNT
argument_list|(
name|ENXINT
argument_list|)
expr_stmt|;
name|ui
operator|=
name|eninfo
index|[
name|unit
index|]
expr_stmt|;
name|addr
operator|=
operator|(
expr|struct
name|endevice
operator|*
operator|)
name|ui
operator|->
name|ui_addr
expr_stmt|;
ifdef|#
directive|ifdef
name|IMPDEBUG
name|printf
argument_list|(
literal|"en%d: enxint ostat=%b\n"
argument_list|,
name|unit
argument_list|,
name|addr
operator|->
name|en_ostat
argument_list|,
name|EN_BITS
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|imp_stat
operator|.
name|outactive
condition|)
block|{
name|printf
argument_list|(
literal|"en%d: phantom output intr ostat=%b\n"
argument_list|,
name|unit
argument_list|,
name|addr
operator|->
name|en_ostat
argument_list|,
name|EN_BITS
argument_list|)
expr_stmt|;
return|return;
block|}
name|imp_stat
operator|.
name|endelay
operator|=
literal|0
expr_stmt|;
name|imp_stat
operator|.
name|enmask
operator|=
operator|~
literal|0
expr_stmt|;
if|if
condition|(
name|addr
operator|->
name|en_ostat
operator|&
name|EN_OERROR
condition|)
name|printf
argument_list|(
literal|"en%d: output error ostat=%b\n"
argument_list|,
name|unit
argument_list|,
name|addr
operator|->
name|en_ostat
argument_list|,
name|EN_BITS
argument_list|)
expr_stmt|;
name|imp_stat
operator|.
name|outactive
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|imp_stat
operator|.
name|outq_head
condition|)
name|enstart
argument_list|(
name|unit
argument_list|)
expr_stmt|;
else|else
name|enlastx
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|int
name|collisions
decl_stmt|;
end_decl_stmt

begin_macro
name|encollide
argument_list|(
argument|unit
argument_list|)
end_macro

begin_decl_stmt
name|int
name|unit
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|endevice
modifier|*
name|addr
decl_stmt|;
specifier|register
name|struct
name|uba_device
modifier|*
name|ui
decl_stmt|;
name|COUNT
argument_list|(
name|ENCOLLIDE
argument_list|)
expr_stmt|;
name|collisions
operator|++
expr_stmt|;
name|ui
operator|=
name|eninfo
index|[
name|unit
index|]
expr_stmt|;
name|addr
operator|=
operator|(
expr|struct
name|endevice
operator|*
operator|)
name|ui
operator|->
name|ui_addr
expr_stmt|;
ifdef|#
directive|ifdef
name|IMPDEBUG
name|printf
argument_list|(
literal|"en%d: collision ostat=%b\n"
argument_list|,
name|unit
argument_list|,
name|addr
operator|->
name|en_ostat
argument_list|,
name|EN_BITS
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|imp_stat
operator|.
name|outactive
condition|)
block|{
name|printf
argument_list|(
literal|"en%d: phantom collision intr ostat=%b\n"
argument_list|,
name|unit
argument_list|,
name|addr
operator|->
name|en_ostat
argument_list|,
name|EN_BITS
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|imp_stat
operator|.
name|enmask
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"en%d: output error ostat=%b\n"
argument_list|,
name|unit
argument_list|,
name|addr
operator|->
name|en_ostat
argument_list|,
name|EN_BITS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|imp_stat
operator|.
name|enmask
operator|<<=
literal|1
expr_stmt|;
name|imp_stat
operator|.
name|endelay
operator|=
name|mfpr
argument_list|(
name|ICR
argument_list|)
operator|&
operator|~
name|imp_stat
operator|.
name|enmask
expr_stmt|;
block|}
name|enstart
argument_list|(
name|unit
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|enrint
argument_list|(
argument|unit
argument_list|)
end_macro

begin_decl_stmt
name|int
name|unit
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
specifier|register
name|struct
name|endevice
modifier|*
name|addr
decl_stmt|;
specifier|register
name|struct
name|uba_device
modifier|*
name|ui
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
specifier|register
name|caddr_t
name|cp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|p
decl_stmt|,
modifier|*
name|top
init|=
literal|0
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|u_int
name|hlen
decl_stmt|;
name|COUNT
argument_list|(
name|ENRINT
argument_list|)
expr_stmt|;
name|ui
operator|=
name|eninfo
index|[
name|unit
index|]
expr_stmt|;
name|addr
operator|=
operator|(
expr|struct
name|endevice
operator|*
operator|)
name|ui
operator|->
name|ui_addr
expr_stmt|;
ifdef|#
directive|ifdef
name|IMPDEBUG
name|printf
argument_list|(
literal|"en%d: enrint istat=%b\n"
argument_list|,
name|unit
argument_list|,
name|addr
operator|->
name|en_istat
argument_list|,
name|EN_BITS
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|imp_stat
operator|.
name|flush
condition|)
goto|goto
name|flush
goto|;
if|if
condition|(
name|addr
operator|->
name|en_istat
operator|&
name|EN_IERROR
condition|)
block|{
ifdef|#
directive|ifdef
name|notdef
name|printf
argument_list|(
literal|"en%d: input error istat=%b\n"
argument_list|,
name|unit
argument_list|,
name|addr
operator|->
name|en_istat
argument_list|,
name|EN_BITS
argument_list|)
expr_stmt|;
endif|#
directive|endif
goto|goto
name|flush
goto|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VAX780
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX750
argument_list|)
switch|switch
condition|(
name|cpu
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VAX780
argument_list|)
case|case
name|VAX_780
case|:
name|UBA_PURGE780
argument_list|(
name|enuba
argument_list|,
name|enrbdp
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
case|case
name|VAX_750
case|:
name|UBA_PURGE750
argument_list|(
name|enuba
argument_list|,
name|enrbdp
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
endif|#
directive|endif
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
operator|(
name|int
operator|)
name|rpkt
operator|+
name|L1822
operator|)
expr_stmt|;
name|len
operator|=
name|ntohs
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
operator|+
name|L1822
expr_stmt|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|en_packet
argument_list|)
operator|||
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"enrint: bad ip length %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
goto|goto
name|flush
goto|;
block|}
name|hlen
operator|=
name|L1822
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ip
operator|->
name|ip_p
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
name|hlen
operator|+=
operator|(
operator|(
expr|struct
name|tcpiphdr
operator|*
operator|)
name|ip
operator|)
operator|->
name|ti_off
operator|<<
literal|2
expr_stmt|;
break|break;
block|}
name|MGET
argument_list|(
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
goto|goto
name|flush
goto|;
name|top
operator|=
name|m
expr_stmt|;
name|m
operator|->
name|m_off
operator|=
name|MMINOFF
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|hlen
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|rpkt
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
name|hlen
argument_list|)
expr_stmt|;
name|len
operator|-=
name|hlen
expr_stmt|;
name|cp
operator|=
operator|(
name|caddr_t
operator|)
name|rpkt
operator|+
name|hlen
expr_stmt|;
name|mp
operator|=
name|m
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|MGET
argument_list|(
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
goto|goto
name|flush
goto|;
if|if
condition|(
name|len
operator|>=
name|PGSIZE
condition|)
block|{
name|MPGET
argument_list|(
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
literal|0
condition|)
goto|goto
name|nopage
goto|;
name|m
operator|->
name|m_len
operator|=
name|PGSIZE
expr_stmt|;
name|m
operator|->
name|m_off
operator|=
operator|(
name|int
operator|)
name|p
operator|-
operator|(
name|int
operator|)
name|m
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|int
operator|)
name|cp
operator|&
literal|0x3ff
operator|)
operator|==
literal|0
condition|)
block|{
name|struct
name|pte
modifier|*
name|cpte
init|=
operator|&
name|Mbmap
index|[
name|mtopf
argument_list|(
name|cp
argument_list|)
operator|*
literal|2
index|]
decl_stmt|;
name|struct
name|pte
modifier|*
name|ppte
init|=
operator|&
name|Mbmap
index|[
name|mtopf
argument_list|(
name|p
argument_list|)
operator|*
literal|2
index|]
decl_stmt|;
name|struct
name|pte
name|t
decl_stmt|;
name|enrswaps
operator|++
expr_stmt|;
name|t
operator|=
operator|*
name|ppte
expr_stmt|;
operator|*
name|ppte
operator|++
operator|=
operator|*
name|cpte
expr_stmt|;
operator|*
name|cpte
operator|++
operator|=
name|t
expr_stmt|;
name|t
operator|=
operator|*
name|ppte
expr_stmt|;
operator|*
name|ppte
operator|=
operator|*
name|cpte
expr_stmt|;
operator|*
name|cpte
operator|=
name|t
expr_stmt|;
name|mtpr
argument_list|(
name|TBIS
argument_list|,
operator|(
name|caddr_t
operator|)
name|cp
argument_list|)
expr_stmt|;
name|mtpr
argument_list|(
name|TBIS
argument_list|,
operator|(
name|caddr_t
operator|)
name|cp
operator|+
literal|512
argument_list|)
expr_stmt|;
name|mtpr
argument_list|(
name|TBIS
argument_list|,
operator|(
name|caddr_t
operator|)
name|p
argument_list|)
expr_stmt|;
name|mtpr
argument_list|(
name|TBIS
argument_list|,
operator|(
name|caddr_t
operator|)
name|p
operator|+
literal|512
argument_list|)
expr_stmt|;
operator|*
operator|(
name|int
operator|*
operator|)
operator|(
name|enrmr
operator|+
literal|1
operator|)
operator|=
name|cpte
index|[
literal|0
index|]
operator|.
name|pg_pfnum
operator||
name|enrproto
expr_stmt|;
operator|*
operator|(
name|int
operator|*
operator|)
operator|(
name|enrmr
operator|)
operator|=
name|cpte
index|[
operator|-
literal|1
index|]
operator|.
name|pg_pfnum
operator||
name|enrproto
expr_stmt|;
goto|goto
name|nocopy
goto|;
block|}
block|}
else|else
block|{
name|nopage
label|:
name|m
operator|->
name|m_len
operator|=
name|MIN
argument_list|(
name|MLEN
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_off
operator|=
name|MMINOFF
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|cp
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
operator|(
name|unsigned
operator|)
name|m
operator|->
name|m_len
argument_list|)
expr_stmt|;
name|nocopy
label|:
name|cp
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
name|len
operator|-=
name|m
operator|->
name|m_len
expr_stmt|;
name|mp
operator|->
name|m_next
operator|=
name|m
expr_stmt|;
name|mp
operator|=
name|m
expr_stmt|;
block|}
name|m
operator|=
name|top
expr_stmt|;
if|if
condition|(
name|imp_stat
operator|.
name|inq_head
operator|!=
name|NULL
condition|)
name|imp_stat
operator|.
name|inq_tail
operator|->
name|m_act
operator|=
name|m
expr_stmt|;
else|else
name|imp_stat
operator|.
name|inq_head
operator|=
name|m
expr_stmt|;
name|imp_stat
operator|.
name|inq_tail
operator|=
name|m
expr_stmt|;
ifdef|#
directive|ifdef
name|IMPDEBUG
name|printf
argument_list|(
literal|"en%d: received packet (%d bytes)\n"
argument_list|,
name|unit
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|prt_byte
argument_list|(
name|rpkt
argument_list|,
name|len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|setsoftnet
argument_list|()
expr_stmt|;
goto|goto
name|setup
goto|;
name|flush
label|:
name|m_freem
argument_list|(
name|top
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IMPDEBUG
name|printf
argument_list|(
literal|"en%d: flushing packet %x\n"
argument_list|,
name|unit
argument_list|,
name|top
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|setup
label|:
name|addr
operator|->
name|en_iba
operator|=
name|imp_stat
operator|.
name|iaddr
expr_stmt|;
name|addr
operator|->
name|en_iwc
operator|=
operator|-
literal|600
expr_stmt|;
name|addr
operator|->
name|en_istat
operator|=
name|EN_IEN
operator||
name|EN_GO
expr_stmt|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|IMPDEBUG
end_ifdef

begin_expr_stmt
name|prt_byte
argument_list|(
name|s
argument_list|,
name|ct
argument_list|)
specifier|register
name|char
operator|*
name|s
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|ct
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|i
operator|,
name|j
operator|,
name|c
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ct
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
operator|*
name|s
operator|++
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|2
condition|;
name|j
operator|++
control|)
name|putchar
argument_list|(
literal|"0123456789abcdef"
index|[
operator|(
name|c
operator|>>
operator|(
operator|(
literal|1
operator|-
name|j
operator|)
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|IMPDEBUG
end_endif

end_unit


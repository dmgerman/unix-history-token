begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1982, 1986 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  *  *	@(#)srt0.c	7.4 (Berkeley) %G%  */
end_comment

begin_include
include|#
directive|include
file|"../vax/mtpr.h"
end_include

begin_define
define|#
directive|define
name|LOCORE
end_define

begin_include
include|#
directive|include
file|"../vax/cpu.h"
end_include

begin_comment
comment|/*  * Startup code for standalone system  * Non-relocating version -- for programs which are loaded by boot  * Relocating version for boot*  */
end_comment

begin_expr_stmt
operator|.
name|globl
name|_end
operator|.
name|globl
name|_edata
operator|.
name|globl
name|_main
operator|.
name|globl
name|__rtt
operator|.
name|globl
name|_configure
operator|.
name|globl
name|_cpu
operator|.
name|globl
name|_openfirst
operator|.
name|globl
name|_boothowto
operator|.
name|globl
name|_bootdev
operator|.
name|set
name|HIGH
operator|,
literal|31
operator|#
name|mask
end_expr_stmt

begin_for
for|for total disable  entry:	.globl	entry 	nop
empty_stmt|;
end_for

begin_expr_stmt
name|nop
operator|#
operator|.
name|word
literal|0x0101
name|mtpr
name|$HIGH
operator|,
name|$IPL
operator|#
name|just
name|in
end_expr_stmt

begin_case
case|case
ifdef|#
directive|ifdef
name|REL
empty|# we need to do special stuff on microvax II
name|mfpr
name|$SID
operator|,
name|r0
name|cmpzv
name|$24
decl_stmt|,
name|$8
decl_stmt|,
name|r0
decl_stmt|,
name|$VAX_630
name|bneq
decl|1f
comment|/* 	 * Were we booted by VMB?  If so, r11 is not boothowto, 	 * but rather the address of the `Extended RPB' (see KA630 	 * User's Manual, pp 3-21).  These tests were devised by 	 * richl@tektronix, 11/10/87. 	 */
name|cmpl
argument_list|(
name|r11
argument_list|)
decl_stmt|,
name|r11
decl|# if
name|boothowto
decl_stmt|,
name|r11
name|will
name|be
name|small
name|bneq
decl|1f			#
name|and
name|these
name|will
name|not
name|fault
name|cmpl
decl|4
argument_list|(
name|r11
argument_list|)
decl_stmt|,
name|$0
name|bneq
decl|1f
name|cmpl
decl|8
argument_list|(
name|r11
argument_list|)
decl_stmt|,
name|$
decl|-1
name|bneq
decl|1f
name|tstl
decl|0xc
argument_list|(
name|r11
argument_list|)
name|bneq
decl|1f
comment|/* 	 * Booted by VMB: get flags from extended rpb. 	 * We can only guess at the boot device (here ra(0,0)). 	 */
name|movl
decl|0x30
argument_list|(
name|r11
argument_list|)
decl_stmt|,
name|r11
name|movl
name|$9
decl_stmt|,
name|r10
decl|#
name|device
init|=
name|ra
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
literal|1
case|:
end_case

begin_decl_stmt
name|movl
name|$RELOC
decl_stmt|,
name|sp
else|#
directive|else
name|movl
name|$RELOC
decl|-0x2400
decl_stmt|,
name|sp
endif|#
directive|endif
name|start
range|:
ifndef|#
directive|ifndef
name|REL
comment|/* 	 * Clear bss segment 	 */
name|movl
name|aedata
decl_stmt|,
name|r0
name|clr
range|:
name|clrl
argument_list|(
name|r0
argument_list|)
operator|+
name|cmpl
name|r0
decl_stmt|,
name|sp
name|jlss
name|clr
else|#
directive|else
comment|/* 	 * `entry' below generates a pc-relative reference to the 	 * code, so this works no matter where we are now. 	 * Clear bss segment *after* moving text and data. 	 */
name|movc3
name|aedata
decl_stmt|,
name|entry
decl_stmt|,
argument_list|(
name|sp
argument_list|)
name|dclr
range|:
name|clrl
argument_list|(
name|r3
argument_list|)
operator|+
name|cmpl
name|r3
decl_stmt|,
name|$_end
name|jlss
name|dclr
comment|/* this loop shouldn't be necessary, but is when booting from an ra81 */
name|xclr
range|:
name|clrl
argument_list|(
name|r3
argument_list|)
operator|+
name|cmpl
name|r3
decl_stmt|,
name|$0x100000
name|jlss
name|xclr
name|jmp
modifier|*
name|abegin
name|begin
range|:
endif|#
directive|endif
name|movl
name|r11
decl_stmt|,
name|_boothowto
name|movl
name|r10
decl_stmt|,
name|_bootdev
name|again
range|:
name|mtpr
name|$0
decl_stmt|,
name|$SCBB
name|calls
name|$0
decl_stmt|,
name|_configure
name|movl
name|$1
decl_stmt|,
name|_openfirst
name|calls
name|$0
decl_stmt|,
name|_main
ifdef|#
directive|ifdef
name|REL
name|jmp
name|again
else|#
directive|else
name|ret
endif|#
directive|endif
operator|.
name|data
ifdef|#
directive|ifdef
name|REL
name|abegin
range|:
operator|.
name|long
name|begin
name|aedata
operator|:
operator|.
name|long
name|_edata
operator|-
name|RELOC
else|#
directive|else
name|aedata
operator|:
operator|.
name|long
name|_edata
endif|#
directive|endif
name|_bootdev
operator|:
operator|.
name|long
literal|0
name|_boothowto
operator|:
operator|.
name|long
literal|0
operator|.
name|text
name|__rtt
operator|:
operator|.
name|word
literal|0x0
ifdef|#
directive|ifdef
name|REL
name|halt
else|#
directive|else
name|jmp
name|start
endif|#
directive|endif
operator|.
name|globl
name|_badaddr
name|_badaddr
operator|:
operator|.
name|word
literal|0
name|movl
name|$1
decl_stmt|,
name|r0
name|movl
decl|4
argument_list|(
name|ap
argument_list|)
decl_stmt|,
name|r3
name|movl
decl|8
argument_list|(
name|ap
argument_list|)
decl_stmt|,
name|r4
name|movl
name|$4
decl_stmt|,
name|r2
name|movab
decl|9f
decl_stmt|,
argument_list|(
name|r2
argument_list|)
name|bbc
name|$0
decl_stmt|,
name|r4
decl_stmt|,1f;
end_decl_stmt

begin_expr_stmt
name|tstb
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|bbc
name|$1
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|tstw
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|bbc
name|$2
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|tstl
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|clrl
name|r0
operator|#
name|made
name|it
name|w
operator|/
name|o
name|machine
name|checks
literal|2
operator|:
name|movl
name|$4
operator|,
name|r2
name|clrl
argument_list|(
argument|r2
argument_list|)
name|ret
operator|.
name|align
literal|2
literal|9
operator|:
name|casel
name|_cpu
operator|,
name|$1
operator|,
name|$VAX_MAX
literal|0
operator|:
operator|.
name|word
literal|8f
operator|-
literal|0b
operator|#
literal|1
name|is
literal|780
operator|.
name|word
literal|5f
operator|-
literal|0b
operator|#
literal|2
name|is
literal|750
operator|.
name|word
literal|5f
operator|-
literal|0b
operator|#
literal|3
name|is
literal|730
operator|.
name|word
literal|6f
operator|-
literal|0b
operator|#
literal|4
name|is
literal|8600
operator|.
name|word
literal|5f
operator|-
literal|0b
operator|#
literal|5
name|is
literal|8200
operator|.
name|word
literal|1f
operator|-
literal|0b
operator|#
literal|6
name|is
literal|8800
operator|.
name|word
literal|1f
operator|-
literal|0b
operator|#
literal|7
name|is
literal|610
operator|.
name|word
literal|5f
operator|-
literal|0b
operator|#
literal|8
name|is
literal|630
literal|5
operator|:
name|mtpr
name|$0xf
operator|,
name|$MCESR
name|brb
literal|1f
literal|6
operator|:
name|mtpr
name|$0
operator|,
name|$EHSR
name|brb
literal|1f
literal|8
operator|:
name|mtpr
name|$0
operator|,
name|$SBIFS
literal|1
operator|:
name|addl2
argument_list|(
name|sp
argument_list|)
operator|+
operator|,
name|sp
operator|#
name|discard
name|mchchk
name|trash
name|movab
literal|2b
operator|,
operator|(
name|sp
operator|)
name|rei
comment|/*  * Short assembly versions of strcmp, strcpy, and strlen  * that do not use special instructions.  */
operator|.
name|globl
name|_strcmp
name|_strcmp
operator|:
operator|.
name|word
literal|0
name|movq
literal|4
operator|(
name|ap
operator|)
operator|,
name|r0
literal|0
operator|:
name|cmpb
argument_list|(
name|r0
argument_list|)
operator|,
operator|(
name|r1
operator|)
operator|+
name|bneq
literal|1f
name|tstb
argument_list|(
name|r0
argument_list|)
operator|+
name|bneq
literal|0b
name|clrl
name|r0
name|ret
literal|1
operator|:
name|cvtbl
argument_list|(
name|r0
argument_list|)
operator|,
name|r0
name|cvtbl
operator|-
operator|(
name|r1
operator|)
operator|,
name|r1
name|subl2
name|r1
operator|,
name|r0
name|ret
operator|.
name|globl
name|_strcpy
name|_strcpy
operator|:
operator|.
name|word
literal|0
name|movq
literal|4
operator|(
name|ap
operator|)
operator|,
name|r0
literal|0
operator|:
name|movb
argument_list|(
name|r1
argument_list|)
operator|+
operator|,
operator|(
name|r0
operator|)
operator|+
name|bneq
literal|0b
name|movl
literal|4
operator|(
name|ap
operator|)
operator|,
name|r0
name|ret
operator|.
name|globl
name|_strlen
name|_strlen
operator|:
operator|.
name|word
literal|0
name|movl
literal|4
operator|(
name|ap
operator|)
operator|,
name|r0
literal|0
operator|:
name|tstb
argument_list|(
name|r0
argument_list|)
operator|+
name|bneq
literal|0b
name|decl
name|r0
name|subl2
literal|4
operator|(
name|ap
operator|)
operator|,
name|r0
name|ret
end_expr_stmt

end_unit


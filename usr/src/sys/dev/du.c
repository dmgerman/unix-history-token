begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * DU-11 Synchronous interface driver  */
end_comment

begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/systm.h"
end_include

begin_include
include|#
directive|include
file|"../h/dir.h"
end_include

begin_include
include|#
directive|include
file|"../h/user.h"
end_include

begin_include
include|#
directive|include
file|"../h/buf.h"
end_include

begin_include
include|#
directive|include
file|"../h/uba.h"
end_include

begin_comment
comment|/* device registers */
end_comment

begin_struct
struct|struct
name|dureg
block|{
name|short
name|rxcsr
decl_stmt|,
name|rxdbuf
decl_stmt|;
define|#
directive|define
name|parcsr
value|rxdbuf
name|short
name|txcsr
decl_stmt|,
name|txdbuf
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|du
block|{
name|struct
name|dureg
modifier|*
name|du_addr
decl_stmt|;
name|int
name|du_state
decl_stmt|;
name|struct
name|proc
modifier|*
name|du_proc
decl_stmt|;
name|struct
name|buf
modifier|*
name|du_buf
decl_stmt|;
name|caddr_t
name|du_bufb
decl_stmt|;
name|caddr_t
name|du_bufp
decl_stmt|;
name|int
name|du_nxmit
decl_stmt|;
name|int
name|du_timer
decl_stmt|;
block|}
name|du
index|[]
init|=
block|{
block|{
operator|(
expr|struct
name|dureg
operator|*
operator|)
operator|(
name|UBA0_DEV
operator|+
literal|0160110
operator|)
block|}
block|, }
struct|;
end_struct

begin_define
define|#
directive|define
name|NDU
value|(sizeof(du)/sizeof(du[0]))
end_define

begin_define
define|#
directive|define
name|DONE
value|0200
end_define

begin_define
define|#
directive|define
name|IE
value|0100
end_define

begin_define
define|#
directive|define
name|SIE
value|040
end_define

begin_define
define|#
directive|define
name|CTS
value|020000
end_define

begin_define
define|#
directive|define
name|CARRIER
value|010000
end_define

begin_define
define|#
directive|define
name|RCVACT
value|04000
end_define

begin_define
define|#
directive|define
name|DSR
value|01000
end_define

begin_define
define|#
directive|define
name|STRIP
value|0400
end_define

begin_define
define|#
directive|define
name|SCH
value|020
end_define

begin_define
define|#
directive|define
name|RTS
value|04
end_define

begin_define
define|#
directive|define
name|DTR
value|02
end_define

begin_define
define|#
directive|define
name|MR
value|0400
end_define

begin_define
define|#
directive|define
name|SEND
value|020
end_define

begin_define
define|#
directive|define
name|HALF
value|010
end_define

begin_define
define|#
directive|define
name|READ
value|0
end_define

begin_define
define|#
directive|define
name|WRITE
value|1
end_define

begin_define
define|#
directive|define
name|PWRIT
value|2
end_define

begin_define
define|#
directive|define
name|DUPRI
value|(PZERO+1)
end_define

begin_expr_stmt
name|duopen
argument_list|(
name|dev
argument_list|)
specifier|register
name|dev
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|dutimeout
parameter_list|()
function_decl|;
specifier|register
name|struct
name|du
modifier|*
name|dp
decl_stmt|;
specifier|register
name|struct
name|dureg
modifier|*
name|lp
decl_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|>=
name|NDU
operator|||
operator|(
operator|(
name|dp
operator|=
operator|&
name|du
index|[
name|dev
index|]
operator|)
operator|->
name|du_proc
operator|!=
name|NULL
operator|&&
name|dp
operator|->
name|du_proc
operator|!=
name|u
operator|.
name|u_procp
operator|)
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|ENXIO
expr_stmt|;
return|return;
block|}
name|dp
operator|->
name|du_proc
operator|=
name|u
operator|.
name|u_procp
expr_stmt|;
name|lp
operator|=
name|dp
operator|->
name|du_addr
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|du_buf
operator|==
name|NULL
condition|)
block|{
name|dp
operator|->
name|du_buf
operator|=
name|geteblk
argument_list|()
expr_stmt|;
name|dp
operator|->
name|du_bufb
operator|=
name|dp
operator|->
name|du_buf
operator|->
name|b_un
operator|.
name|b_addr
expr_stmt|;
name|dp
operator|->
name|du_state
operator|=
name|WRITE
expr_stmt|;
name|lp
operator|->
name|txcsr
operator|=
name|MR
expr_stmt|;
name|lp
operator|->
name|parcsr
operator|=
literal|035026
expr_stmt|;
comment|/* Sync Int, 7 bits, even parity, sync=026 */
name|timeout
argument_list|(
name|dutimeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|dp
argument_list|,
name|HZ
argument_list|)
expr_stmt|;
name|duturn
argument_list|(
name|dp
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|duclose
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|du
modifier|*
name|dp
decl_stmt|;
specifier|register
name|struct
name|dureg
modifier|*
name|lp
decl_stmt|;
name|dp
operator|=
operator|&
name|du
index|[
name|minor
argument_list|(
name|dev
argument_list|)
index|]
expr_stmt|;
name|lp
operator|=
name|dp
operator|->
name|du_addr
expr_stmt|;
name|lp
operator|->
name|rxcsr
operator|=
literal|0
expr_stmt|;
name|lp
operator|->
name|txcsr
operator|=
literal|0
expr_stmt|;
name|dp
operator|->
name|du_timer
operator|=
literal|0
expr_stmt|;
name|dp
operator|->
name|du_proc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|du_buf
operator|!=
name|NULL
condition|)
block|{
name|brelse
argument_list|(
name|dp
operator|->
name|du_buf
argument_list|)
expr_stmt|;
name|dp
operator|->
name|du_buf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|duread
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|bp
decl_stmt|;
specifier|register
name|struct
name|du
modifier|*
name|dp
decl_stmt|;
name|dp
operator|=
operator|&
name|du
index|[
name|minor
argument_list|(
name|dev
argument_list|)
index|]
expr_stmt|;
name|bp
operator|=
name|dp
operator|->
name|du_bufb
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|duwait
argument_list|(
name|dev
argument_list|)
condition|)
return|return;
if|if
condition|(
name|dp
operator|->
name|du_bufp
operator|>
name|bp
condition|)
break|break;
name|spl5
argument_list|()
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|du_timer
operator|<=
literal|1
condition|)
block|{
name|spl0
argument_list|()
expr_stmt|;
return|return;
block|}
name|sleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|dp
argument_list|,
name|DUPRI
argument_list|)
expr_stmt|;
name|spl0
argument_list|()
expr_stmt|;
block|}
name|u
operator|.
name|u_offset
operator|=
literal|0
expr_stmt|;
name|iomove
argument_list|(
name|dp
operator|->
name|du_bufb
argument_list|,
operator|(
name|int
operator|)
name|min
argument_list|(
name|u
operator|.
name|u_count
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|dp
operator|->
name|du_bufp
operator|-
name|bp
argument_list|)
argument_list|)
argument_list|,
name|B_READ
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|duwrite
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|du
modifier|*
name|dp
decl_stmt|;
specifier|register
name|struct
name|dureg
modifier|*
name|lp
decl_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|dp
operator|=
operator|&
name|du
index|[
name|dev
index|]
expr_stmt|;
if|if
condition|(
name|u
operator|.
name|u_count
operator|==
literal|0
operator|||
name|duwait
argument_list|(
name|dev
argument_list|)
condition|)
return|return;
name|dp
operator|->
name|du_bufp
operator|=
name|dp
operator|->
name|du_bufb
expr_stmt|;
name|dp
operator|->
name|du_state
operator|=
name|PWRIT
expr_stmt|;
name|dp
operator|->
name|du_addr
operator|->
name|rxcsr
operator|&=
operator|~
name|SCH
expr_stmt|;
name|dp
operator|->
name|du_addr
operator|->
name|rxcsr
operator|=
name|SIE
operator||
name|RTS
operator||
name|DTR
expr_stmt|;
if|if
condition|(
name|u
operator|.
name|u_count
operator|>
name|BSIZE
condition|)
name|u
operator|.
name|u_count
operator|=
name|BSIZE
expr_stmt|;
name|dp
operator|->
name|du_nxmit
operator|=
name|u
operator|.
name|u_count
expr_stmt|;
name|u
operator|.
name|u_offset
operator|=
literal|0
expr_stmt|;
name|iomove
argument_list|(
name|dp
operator|->
name|du_bufb
argument_list|,
name|u
operator|.
name|u_count
argument_list|,
name|B_WRITE
argument_list|)
expr_stmt|;
name|lp
operator|=
name|dp
operator|->
name|du_addr
expr_stmt|;
name|dp
operator|->
name|du_timer
operator|=
literal|10
expr_stmt|;
name|spl5
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|lp
operator|->
name|rxcsr
operator|&
name|CTS
operator|)
operator|==
literal|0
condition|)
name|sleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|dp
argument_list|,
name|DUPRI
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|du_state
operator|!=
name|WRITE
condition|)
block|{
name|dp
operator|->
name|du_state
operator|=
name|WRITE
expr_stmt|;
name|lp
operator|->
name|txcsr
operator|=
name|IE
operator||
name|SIE
operator||
name|SEND
operator||
name|HALF
expr_stmt|;
name|dustart
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|spl0
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|duwait
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|du
modifier|*
name|dp
decl_stmt|;
specifier|register
name|struct
name|dureg
modifier|*
name|lp
decl_stmt|;
name|dp
operator|=
operator|&
name|du
index|[
name|minor
argument_list|(
name|dev
argument_list|)
index|]
expr_stmt|;
name|lp
operator|=
name|dp
operator|->
name|du_addr
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|lp
operator|->
name|rxcsr
operator|&
name|DSR
operator|)
operator|==
literal|0
operator|||
name|dp
operator|->
name|du_buf
operator|==
literal|0
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|spl5
argument_list|()
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|du_state
operator|==
name|READ
operator|&&
operator|(
operator|(
name|lp
operator|->
name|rxcsr
operator|&
name|RCVACT
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
name|spl0
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|dp
argument_list|,
name|DUPRI
argument_list|)
expr_stmt|;
name|spl0
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|dustart
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|du
modifier|*
name|dp
decl_stmt|;
specifier|register
name|struct
name|dureg
modifier|*
name|lp
decl_stmt|;
name|dp
operator|=
operator|&
name|du
index|[
name|minor
argument_list|(
name|dev
argument_list|)
index|]
expr_stmt|;
name|lp
operator|=
name|dp
operator|->
name|du_addr
expr_stmt|;
name|dp
operator|->
name|du_timer
operator|=
literal|10
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|du_nxmit
operator|>
literal|0
condition|)
block|{
name|dp
operator|->
name|du_nxmit
operator|--
expr_stmt|;
name|lp
operator|->
name|txdbuf
operator|=
operator|*
name|dp
operator|->
name|du_bufp
operator|++
expr_stmt|;
block|}
else|else
block|{
name|duturn
argument_list|(
name|dp
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|durint
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|du
modifier|*
name|dp
decl_stmt|;
specifier|register
name|c
operator|,
name|s
expr_stmt|;
name|int
name|dustat
decl_stmt|;
name|dp
operator|=
operator|&
name|du
index|[
name|minor
argument_list|(
name|dev
argument_list|)
index|]
expr_stmt|;
name|dustat
operator|=
name|dp
operator|->
name|du_addr
operator|->
name|rxcsr
expr_stmt|;
if|if
condition|(
name|dustat
operator|<
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|dustat
operator|&
name|CARRIER
operator|)
operator|==
literal|0
operator|&&
name|dp
operator|->
name|du_state
operator|==
name|READ
condition|)
name|duturn
argument_list|(
name|dp
argument_list|)
expr_stmt|;
else|else
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
name|dp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dustat
operator|&
name|DONE
condition|)
block|{
name|dp
operator|->
name|du_addr
operator|->
name|rxcsr
operator|=
name|IE
operator||
name|SIE
operator||
name|SCH
operator||
name|DTR
expr_stmt|;
name|c
operator|=
name|s
operator|=
name|dp
operator|->
name|du_addr
operator|->
name|rxdbuf
expr_stmt|;
name|c
operator|&=
literal|0177
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
name|c
operator||=
literal|0200
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|du_bufp
operator|<
name|dp
operator|->
name|du_bufb
operator|+
name|BSIZE
condition|)
operator|*
name|dp
operator|->
name|du_bufp
operator|++
operator|=
name|c
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|duxint
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|du
modifier|*
name|dp
decl_stmt|;
specifier|register
name|struct
name|dureg
modifier|*
name|lp
decl_stmt|;
specifier|register
name|int
name|dustat
decl_stmt|;
name|dp
operator|=
operator|&
name|du
index|[
name|minor
argument_list|(
name|dev
argument_list|)
index|]
expr_stmt|;
name|lp
operator|=
name|dp
operator|->
name|du_addr
expr_stmt|;
name|dustat
operator|=
name|lp
operator|->
name|txcsr
expr_stmt|;
if|if
condition|(
name|dustat
operator|<
literal|0
condition|)
name|duturn
argument_list|(
name|dp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|dustat
operator|&
name|DONE
condition|)
name|dustart
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|duturn
argument_list|(
name|dp
argument_list|)
specifier|register
expr|struct
name|du
operator|*
name|dp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|dureg
modifier|*
name|lp
decl_stmt|;
name|lp
operator|=
name|dp
operator|->
name|du_addr
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|du_state
operator|!=
name|READ
condition|)
block|{
name|dp
operator|->
name|du_state
operator|=
name|READ
expr_stmt|;
name|dp
operator|->
name|du_timer
operator|=
literal|10
expr_stmt|;
name|dp
operator|->
name|du_bufp
operator|=
name|dp
operator|->
name|du_bufb
expr_stmt|;
block|}
name|lp
operator|->
name|txcsr
operator|=
name|HALF
expr_stmt|;
name|lp
operator|->
name|rxcsr
operator|&=
operator|~
name|SCH
expr_stmt|;
name|lp
operator|->
name|rxcsr
operator|=
name|STRIP
operator||
name|IE
operator||
name|SIE
operator||
name|SCH
operator||
name|DTR
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
name|dp
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|dutimeout
argument_list|(
name|dp
argument_list|)
specifier|register
expr|struct
name|du
operator|*
name|dp
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|dp
operator|->
name|du_timer
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|--
name|dp
operator|->
name|du_timer
operator|==
literal|0
condition|)
block|{
name|duturn
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|dp
operator|->
name|du_timer
operator|=
literal|1
expr_stmt|;
block|}
name|timeout
argument_list|(
name|dutimeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|dp
argument_list|,
name|HZ
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


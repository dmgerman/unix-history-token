begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 The Regents of the University of California  * Copyright (c) 1990, 1992 Jan-Simon Pendry  * All rights reserved.  *  * This code is derived from software donated to Berkeley by  * Jan-Simon Pendry.  *  * %sccs.include.redist.c%  *  *	@(#)lofs_vnops.c	1.2 (Berkeley) 6/18/92  *  * $Id: lofs_vnops.c,v 1.11 1992/05/30 10:05:43 jsp Exp jsp $  */
end_comment

begin_comment
comment|/*  * Null layer Filesystem  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<lofs/lofs.h>
end_include

begin_comment
comment|/*  * Basic strategy: as usual, do as little work as possible.  * Nothing is ever locked in the lofs'ed filesystem, all  * locks are held in the underlying filesystems.  */
end_comment

begin_comment
comment|/*  * Save a vnode and replace with  * the lofs'ed one  */
end_comment

begin_define
define|#
directive|define
name|PUSHREF
parameter_list|(
name|v
parameter_list|,
name|nd
parameter_list|)
define|\
value|{ \ 	struct { struct vnode *vnp; } v; \ 	v.vnp = (nd); \ 	(nd) = NULLTOLOWERVP(v.vnp)
end_define

begin_comment
comment|/*  * Undo the PUSHREF  */
end_comment

begin_define
define|#
directive|define
name|POP
parameter_list|(
name|v
parameter_list|,
name|nd
parameter_list|)
define|\ 	\
value|(nd) = v.vnp; \ }
end_define

begin_comment
comment|/*  * vp is the current namei directory  * ndp is the name to locate in that directory...  */
end_comment

begin_macro
name|null_lookup
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_lookup_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_LOOKUP
expr_stmt|;
name|struct
name|vnode
modifier|*
name|dvp
init|=
name|ap
operator|->
name|a_dvp
decl_stmt|;
name|struct
name|vnode
modifier|*
name|newvp
decl_stmt|;
name|struct
name|vnode
modifier|*
name|targetdvp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|flag
init|=
name|ap
operator|->
name|a_cnp
operator|->
name|cn_nameiop
comment|/*& OPMASK*/
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_lookup(ap->a_dvp = %x->%x, \"%s\", op = %d)\n"
argument_list|,
name|dvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|dvp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_cnp
operator|->
name|cn_nameptr
argument_list|,
name|flag
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * (ap->a_dvp) was locked when passed in, and it will be replaced 	 * with the target vnode, BUT that will already have been 	 * locked when (ap->a_dvp) was locked [see null_lock].  all that 	 * must be done here is to keep track of reference counts. 	 */
name|targetdvp
operator|=
name|NULLTOLOWERVP
argument_list|(
name|dvp
argument_list|)
expr_stmt|;
comment|/*VREF(targetdvp);*/
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|vprint
argument_list|(
literal|"lofs VOP_LOOKUP"
argument_list|,
name|targetdvp
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * Call lookup on the looped vnode 	 */
name|error
operator|=
name|VOP_LOOKUP
argument_list|(
name|targetdvp
argument_list|,
operator|&
name|newvp
argument_list|,
name|ap
operator|->
name|a_cnp
argument_list|)
expr_stmt|;
comment|/*vrele(targetdvp);*/
if|if
condition|(
name|error
condition|)
block|{
operator|*
name|ap
operator|->
name|a_vpp
operator|=
name|NULLVP
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_lookup(%x->%x) = %d\n"
argument_list|,
name|dvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|dvp
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|error
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_lookup(%x->%x) = OK\n"
argument_list|,
name|dvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|dvp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
operator|*
name|ap
operator|->
name|a_vpp
operator|=
name|newvp
expr_stmt|;
comment|/* 	 * If we just found a directory then make 	 * a loopback node for it and return the loopback 	 * instead of the real vnode.  Otherwise simply 	 * return the aliased directory and vnode. 	 */
if|if
condition|(
name|newvp
operator|&&
name|newvp
operator|->
name|v_type
operator|==
name|VDIR
operator|&&
name|flag
operator|==
name|LOOKUP
condition|)
block|{
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_lookup: found VDIR\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 		 * At this point, newvp is the vnode to be looped. 		 * Activate a loopback and return the looped vnode. 		 */
return|return
operator|(
name|make_null_node
argument_list|(
name|dvp
operator|->
name|v_mount
argument_list|,
name|ap
operator|->
name|a_vpp
argument_list|)
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_lookup: not VDIR\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * this = ni_dvp  * ni_dvp references the locked directory.  * ni_vp is NULL.  */
end_comment

begin_macro
name|null_mknod
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_mknod_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_MKNOD
expr_stmt|;
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_mknod(vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PUSHREF
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|error
operator|=
name|VOP_MKNOD
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|,
name|ap
operator|->
name|a_vpp
argument_list|,
name|ap
operator|->
name|a_cnp
argument_list|,
name|ap
operator|->
name|a_vap
argument_list|)
expr_stmt|;
name|POP
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * this = ni_dvp;  * ni_dvp references the locked directory  * ni_vp is NULL.  */
end_comment

begin_macro
name|null_create
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_create_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_CREATE
expr_stmt|;
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_create(ap->a_dvp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PUSHREF
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|error
operator|=
name|VOP_CREATE
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|,
name|ap
operator|->
name|a_vpp
argument_list|,
name|ap
operator|->
name|a_cnp
argument_list|,
name|ap
operator|->
name|a_vap
argument_list|)
expr_stmt|;
name|POP
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_create(ap->a_dvp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_macro
name|null_open
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_open_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_OPEN
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_open(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_OPEN
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_mode
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|,
name|ap
operator|->
name|a_p
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_close
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_close_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_CLOSE
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_close(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_CLOSE
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_fflag
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|,
name|ap
operator|->
name|a_p
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_access
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_access_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_ACCESS
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_access(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_ACCESS
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_mode
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|,
name|ap
operator|->
name|a_p
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_getattr
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_getattr_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_GETATTR
expr_stmt|;
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_getattr(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * Get the stats from the underlying filesystem 	 */
name|error
operator|=
name|VOP_GETATTR
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_vap
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|,
name|ap
operator|->
name|a_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * and replace the fsid field with the loopback number 	 * to preserve the namespace. 	 */
name|ap
operator|->
name|a_vap
operator|->
name|va_fsid
operator|=
name|ap
operator|->
name|a_vp
operator|->
name|v_mount
operator|->
name|mnt_stat
operator|.
name|f_fsid
operator|.
name|val
index|[
literal|0
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|null_setattr
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_setattr_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_SETATTR
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_setattr(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_SETATTR
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_vap
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|,
name|ap
operator|->
name|a_p
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_read
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_read_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_READ
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_read(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_READ
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_uio
argument_list|,
name|ap
operator|->
name|a_ioflag
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_write
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_write_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_WRITE
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_write(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_WRITE
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_uio
argument_list|,
name|ap
operator|->
name|a_ioflag
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_ioctl
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_ioctl_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_IOCTL
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_ioctl(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_IOCTL
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_command
argument_list|,
name|ap
operator|->
name|a_data
argument_list|,
name|ap
operator|->
name|a_fflag
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|,
name|ap
operator|->
name|a_p
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_select
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_select_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_SELECT
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_select(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_SELECT
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_which
argument_list|,
name|ap
operator|->
name|a_fflags
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|,
name|ap
operator|->
name|a_p
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_mmap
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_mmap_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_MMAP
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_mmap(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_MMAP
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_fflags
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|,
name|ap
operator|->
name|a_p
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_fsync
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_fsync_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_FSYNC
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_fsync(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_FSYNC
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_fflags
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|,
name|ap
operator|->
name|a_waitfor
argument_list|,
name|ap
operator|->
name|a_p
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_seek
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_seek_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_SEEK
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_seek(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_SEEK
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_oldoff
argument_list|,
name|ap
operator|->
name|a_newoff
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_remove
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_remove_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_REMOVE
expr_stmt|;
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_remove(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PUSHREF
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|PUSHREF
argument_list|(
name|xvp
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
expr_stmt|;
name|error
operator|=
name|VOP_REMOVE
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|ap
operator|->
name|a_cnp
argument_list|)
expr_stmt|;
name|POP
argument_list|(
name|xvp
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
expr_stmt|;
name|POP
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * vp is this.  * ni_dvp is the locked parent of the target.  * ni_vp is NULL.  */
end_comment

begin_macro
name|null_link
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_link_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_LINK
expr_stmt|;
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_link(ap->a_tdvp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PUSHREF
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
expr_stmt|;
name|error
operator|=
name|VOP_LINK
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_tdvp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_cnp
argument_list|)
expr_stmt|;
name|POP
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_macro
name|null_rename
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_rename_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_RENAME
expr_stmt|;
name|struct
name|vnode
modifier|*
name|fvp
decl_stmt|,
modifier|*
name|tvp
decl_stmt|;
name|struct
name|vnode
modifier|*
name|tdvp
decl_stmt|;
if|#
directive|if
literal|0
block|struct vnode *fsvp, *tsvp;
endif|#
directive|endif
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rename(fdvp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_fdvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_fdvp
argument_list|)
argument_list|)
expr_stmt|;
comment|/*printf("null_rename(tdvp = %x->%x)\n", tndp->ni_dvp, NULLTOLOWERVP(tndp->ni_dvp));*/
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rename - switch source dvp\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * Switch source directory to point to lofsed vnode 	 */
name|PUSHREF
argument_list|(
name|fdvp
argument_list|,
name|ap
operator|->
name|a_fdvp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|ap
operator|->
name|a_fdvp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rename - switch source vp\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * And source object if it is lofsed... 	 */
name|fvp
operator|=
name|ap
operator|->
name|a_fvp
expr_stmt|;
if|if
condition|(
name|fvp
operator|&&
name|fvp
operator|->
name|v_op
operator|==
name|null_vnodeop_p
condition|)
block|{
name|ap
operator|->
name|a_fvp
operator|=
name|NULLTOLOWERVP
argument_list|(
name|fvp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|ap
operator|->
name|a_fvp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fvp
operator|=
literal|0
expr_stmt|;
block|}
if|#
directive|if
literal|0
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
block|printf("null_rename - switch source start vp\n");
endif|#
directive|endif
comment|/* 	 * And source startdir object if it is lofsed... 	 */
block|fsvp = fndp->ni_startdir; 	if (fsvp&& fsvp->v_op == null_vnodeop_p) { 		fndp->ni_startdir = NULLTOLOWERVP(fsvp); 		VREF(fndp->ni_startdir); 	} else { 		fsvp = 0; 	}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rename - switch target dvp\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*  	 * Switch target directory to point to lofsed vnode 	 */
name|tdvp
operator|=
name|ap
operator|->
name|a_tdvp
expr_stmt|;
if|if
condition|(
name|tdvp
operator|&&
name|tdvp
operator|->
name|v_op
operator|==
name|null_vnodeop_p
condition|)
block|{
name|ap
operator|->
name|a_tdvp
operator|=
name|NULLTOLOWERVP
argument_list|(
name|tdvp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|ap
operator|->
name|a_tdvp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdvp
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rename - switch target vp\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * And target object if it is lofsed... 	 */
name|tvp
operator|=
name|ap
operator|->
name|a_tvp
expr_stmt|;
if|if
condition|(
name|tvp
operator|&&
name|tvp
operator|->
name|v_op
operator|==
name|null_vnodeop_p
condition|)
block|{
name|ap
operator|->
name|a_tvp
operator|=
name|NULLTOLOWERVP
argument_list|(
name|tvp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|ap
operator|->
name|a_tvp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tvp
operator|=
literal|0
expr_stmt|;
block|}
if|#
directive|if
literal|0
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
block|printf("null_rename - switch target start vp\n");
endif|#
directive|endif
comment|/* 	 * And target startdir object if it is lofsed... 	 */
block|tsvp = tndp->ni_startdir; 	if (tsvp&& tsvp->v_op == null_vnodeop_p) { 		tndp->ni_startdir = NULLTOLOWERVP(fsvp); 		VREF(tndp->ni_startdir); 	} else { 		tsvp = 0; 	}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rename - VOP_RENAME(%x, %x, %x, %x)\n"
argument_list|,
name|ap
operator|->
name|a_fdvp
argument_list|,
name|ap
operator|->
name|a_fvp
argument_list|,
name|ap
operator|->
name|a_tdvp
argument_list|,
name|ap
operator|->
name|a_tvp
argument_list|)
expr_stmt|;
name|vprint
argument_list|(
literal|"ap->a_fdvp"
argument_list|,
name|ap
operator|->
name|a_fdvp
argument_list|)
expr_stmt|;
name|vprint
argument_list|(
literal|"ap->a_fvp"
argument_list|,
name|ap
operator|->
name|a_fvp
argument_list|)
expr_stmt|;
name|vprint
argument_list|(
literal|"ap->a_tdvp"
argument_list|,
name|ap
operator|->
name|a_tdvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|a_tvp
condition|)
name|vprint
argument_list|(
literal|"ap->a_tvp"
argument_list|,
name|ap
operator|->
name|a_tvp
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|16000000
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|error
operator|=
name|VOP_RENAME
argument_list|(
name|ap
operator|->
name|a_fdvp
argument_list|,
name|ap
operator|->
name|a_fvp
argument_list|,
name|ap
operator|->
name|a_fcnp
argument_list|,
name|ap
operator|->
name|a_tdvp
argument_list|,
name|ap
operator|->
name|a_tvp
argument_list|,
name|ap
operator|->
name|a_tcnp
argument_list|)
expr_stmt|;
comment|/* 	 * Put everything back... 	 */
if|#
directive|if
literal|0
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
block|printf("null_rename - restore target startdir\n");
endif|#
directive|endif
block|if (tsvp) { 		if (tndp->ni_startdir) 			vrele(tndp->ni_startdir); 		tndp->ni_startdir = tsvp; 	}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rename - restore target vp\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|tvp
condition|)
block|{
name|ap
operator|->
name|a_tvp
operator|=
name|tvp
expr_stmt|;
name|vrele
argument_list|(
name|ap
operator|->
name|a_tvp
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rename - restore target dvp\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|tdvp
condition|)
block|{
name|ap
operator|->
name|a_tdvp
operator|=
name|tdvp
expr_stmt|;
name|vrele
argument_list|(
name|ap
operator|->
name|a_tdvp
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
block|printf("null_rename - restore source startdir\n");
endif|#
directive|endif
block|if (fsvp) { 		if (fndp->ni_startdir) 			vrele(fndp->ni_startdir); 		fndp->ni_startdir = fsvp; 	}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rename - restore source vp\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|fvp
condition|)
block|{
name|ap
operator|->
name|a_fvp
operator|=
name|fvp
expr_stmt|;
name|vrele
argument_list|(
name|ap
operator|->
name|a_fvp
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rename - restore source dvp\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|POP
argument_list|(
name|fdvp
argument_list|,
name|ap
operator|->
name|a_fdvp
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|ap
operator|->
name|a_fdvp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * ni_dvp is the locked (alias) parent.  * ni_vp is NULL.  */
end_comment

begin_macro
name|null_mkdir
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_mkdir_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_MKDIR
expr_stmt|;
name|int
name|error
decl_stmt|;
name|struct
name|vnode
modifier|*
name|dvp
init|=
name|ap
operator|->
name|a_dvp
decl_stmt|;
name|struct
name|vnode
modifier|*
name|xdvp
decl_stmt|;
name|struct
name|vnode
modifier|*
name|newvp
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_mkdir(vp = %x->%x)\n"
argument_list|,
name|dvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|dvp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|xdvp
operator|=
name|dvp
expr_stmt|;
name|dvp
operator|=
name|NULLTOLOWERVP
argument_list|(
name|xdvp
argument_list|)
expr_stmt|;
comment|/*VREF(dvp);*/
name|error
operator|=
name|VOP_MKDIR
argument_list|(
name|dvp
argument_list|,
operator|&
name|newvp
argument_list|,
name|ap
operator|->
name|a_cnp
argument_list|,
name|ap
operator|->
name|a_vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
operator|*
name|ap
operator|->
name|a_vpp
operator|=
name|NULLVP
expr_stmt|;
comment|/*vrele(xdvp);*/
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* 	 * Make a new lofs node 	 */
comment|/*VREF(dvp);*/
name|error
operator|=
name|make_null_node
argument_list|(
name|dvp
operator|->
name|v_mount
argument_list|,
operator|&
name|newvp
argument_list|)
expr_stmt|;
operator|*
name|ap
operator|->
name|a_vpp
operator|=
name|newvp
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * ni_dvp is the locked parent.  * ni_vp is the entry to be removed.  */
end_comment

begin_macro
name|null_rmdir
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_rmdir_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_RMDIR
expr_stmt|;
name|struct
name|vnode
modifier|*
name|vp
init|=
name|ap
operator|->
name|a_vp
decl_stmt|;
name|struct
name|vnode
modifier|*
name|dvp
init|=
name|ap
operator|->
name|a_dvp
decl_stmt|;
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_rmdir(dvp = %x->%x)\n"
argument_list|,
name|dvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|dvp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PUSHREF
argument_list|(
name|xdvp
argument_list|,
name|dvp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|dvp
argument_list|)
expr_stmt|;
name|PUSHREF
argument_list|(
name|xvp
argument_list|,
name|vp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|vp
argument_list|)
expr_stmt|;
name|error
operator|=
name|VOP_RMDIR
argument_list|(
name|dvp
argument_list|,
name|vp
argument_list|,
name|ap
operator|->
name|a_cnp
argument_list|)
expr_stmt|;
name|POP
argument_list|(
name|xvp
argument_list|,
name|vp
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|vp
argument_list|)
expr_stmt|;
name|POP
argument_list|(
name|xdvp
argument_list|,
name|dvp
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|dvp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * ni_dvp is the locked parent.  * ni_vp is NULL.  */
end_comment

begin_macro
name|null_symlink
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_symlink_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_SYMLINK
expr_stmt|;
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"VOP_SYMLINK(vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PUSHREF
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|VREF
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|error
operator|=
name|VOP_SYMLINK
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|,
name|ap
operator|->
name|a_vpp
argument_list|,
name|ap
operator|->
name|a_cnp
argument_list|,
name|ap
operator|->
name|a_vap
argument_list|,
name|ap
operator|->
name|a_target
argument_list|)
expr_stmt|;
name|POP
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_macro
name|null_readdir
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_readdir_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_READDIR
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_readdir(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_READDIR
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_uio
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|,
name|ap
operator|->
name|a_eofflagp
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_readlink
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_readlink_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_READLINK
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_readlink(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_READLINK
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_uio
argument_list|,
name|ap
operator|->
name|a_cred
argument_list|)
return|;
block|}
end_block

begin_comment
comment|/*  * Anyone's guess...  */
end_comment

begin_macro
name|null_abortop
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_abortop_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_ABORTOP
expr_stmt|;
name|int
name|error
decl_stmt|;
name|PUSHREF
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
name|error
operator|=
name|VOP_ABORTOP
argument_list|(
name|ap
operator|->
name|a_dvp
argument_list|,
name|ap
operator|->
name|a_cnp
argument_list|)
expr_stmt|;
name|POP
argument_list|(
name|xdvp
argument_list|,
name|ap
operator|->
name|a_dvp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_macro
name|null_inactive
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_inactive_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_INACTIVE
expr_stmt|;
name|struct
name|vnode
modifier|*
name|targetvp
init|=
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_inactive(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|targetvp
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DIAGNOSTIC
block|{
specifier|extern
name|int
name|prtactive
decl_stmt|;
if|if
condition|(
name|prtactive
operator|&&
name|ap
operator|->
name|a_vp
operator|->
name|v_usecount
operator|!=
literal|0
condition|)
name|vprint
argument_list|(
literal|"null_inactive: pushing active"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|targetvp
condition|)
block|{
name|vrele
argument_list|(
name|targetvp
argument_list|)
expr_stmt|;
name|VTONULLNODE
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
operator|->
name|null_lowervp
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|null_reclaim
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_reclaim_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_RECLAIM
expr_stmt|;
name|struct
name|vnode
modifier|*
name|targetvp
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_reclaim(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|remque
argument_list|(
name|VTONULLNODE
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
name|targetvp
operator|=
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|targetvp
condition|)
block|{
name|printf
argument_list|(
literal|"lofs: delayed vrele of %x\n"
argument_list|,
name|targetvp
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|targetvp
argument_list|)
expr_stmt|;
comment|/* XXX should never happen */
block|}
name|FREE
argument_list|(
name|ap
operator|->
name|a_vp
operator|->
name|v_data
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
name|ap
operator|->
name|a_vp
operator|->
name|v_data
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|null_lock
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_lock_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_LOCK
expr_stmt|;
name|int
name|error
decl_stmt|;
name|struct
name|vnode
modifier|*
name|targetvp
init|=
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_lock(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|targetvp
argument_list|)
expr_stmt|;
comment|/*vprint("null_lock ap->a_vp", ap->a_vp); 	if (targetvp) 		vprint("null_lock ->ap->a_vp", targetvp); 	else 		printf("null_lock ->ap->a_vp = NIL\n");*/
endif|#
directive|endif
if|if
condition|(
name|targetvp
condition|)
block|{
name|error
operator|=
name|VOP_LOCK
argument_list|(
name|targetvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|null_unlock
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_unlock_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_UNLOCK
expr_stmt|;
name|struct
name|vnode
modifier|*
name|targetvp
init|=
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_unlock(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|targetvp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|targetvp
condition|)
return|return
operator|(
name|VOP_UNLOCK
argument_list|(
name|targetvp
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|null_bmap
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_bmap_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_BMAP
expr_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_bmap(ap->a_vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|VOP_BMAP
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_bn
argument_list|,
name|ap
operator|->
name|a_vpp
argument_list|,
name|ap
operator|->
name|a_bnp
argument_list|)
return|;
block|}
end_block

begin_macro
name|null_strategy
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_strategy_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_STRATEGY
expr_stmt|;
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|NULLFS_DIAGNOSTIC
name|printf
argument_list|(
literal|"null_strategy(vp = %x->%x)\n"
argument_list|,
name|ap
operator|->
name|a_bp
operator|->
name|b_vp
argument_list|,
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_bp
operator|->
name|b_vp
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PUSHREF
argument_list|(
name|vp
argument_list|,
name|ap
operator|->
name|a_bp
operator|->
name|b_vp
argument_list|)
expr_stmt|;
name|error
operator|=
name|VOP_STRATEGY
argument_list|(
name|ap
operator|->
name|a_bp
argument_list|)
expr_stmt|;
name|POP
argument_list|(
name|vp
argument_list|,
name|ap
operator|->
name|a_bp
operator|->
name|b_vp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_macro
name|null_print
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_print_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_PRINT
expr_stmt|;
name|struct
name|vnode
modifier|*
name|targetvp
init|=
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"tag VT_LOFS ref "
argument_list|)
expr_stmt|;
if|if
condition|(
name|targetvp
condition|)
return|return
operator|(
name|VOP_PRINT
argument_list|(
name|targetvp
argument_list|)
operator|)
return|;
name|printf
argument_list|(
literal|"NULLVP\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|null_islocked
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_islocked_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_ISLOCKED
expr_stmt|;
name|struct
name|vnode
modifier|*
name|targetvp
init|=
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
decl_stmt|;
if|if
condition|(
name|targetvp
condition|)
return|return
operator|(
name|VOP_ISLOCKED
argument_list|(
name|targetvp
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|null_advlock
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_advlock_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|USES_VOP_ADVLOCK
expr_stmt|;
return|return
name|VOP_ADVLOCK
argument_list|(
name|NULLTOLOWERVP
argument_list|(
name|ap
operator|->
name|a_vp
argument_list|)
argument_list|,
name|ap
operator|->
name|a_id
argument_list|,
name|ap
operator|->
name|a_op
argument_list|,
name|ap
operator|->
name|a_fl
argument_list|,
name|ap
operator|->
name|a_flags
argument_list|)
return|;
block|}
end_block

begin_comment
comment|/*  * LOFS directory offset lookup.  * Currently unsupported.  */
end_comment

begin_macro
name|null_blkatoff
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_blkatoff_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * LOFS flat namespace lookup.  * Currently unsupported.  */
end_comment

begin_macro
name|null_vget
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_vget_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * LOFS flat namespace allocation.  * Currently unsupported.  */
end_comment

begin_macro
name|null_valloc
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_valloc_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * LOFS flat namespace free.  * Currently unsupported.  */
end_comment

begin_comment
comment|/*void*/
end_comment

begin_macro
name|null_vfree
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_vfree_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return;
block|}
end_block

begin_comment
comment|/*  * LOFS file truncation.  */
end_comment

begin_macro
name|null_truncate
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_truncate_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* Use null_setattr */
name|printf
argument_list|(
literal|"null_truncate: need to implement!!"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * LOFS update.  */
end_comment

begin_macro
name|null_update
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_update_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* Use null_setattr */
name|printf
argument_list|(
literal|"null_update: need to implement!!"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * LOFS bwrite  */
end_comment

begin_macro
name|null_bwrite
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|vop_bwrite_args
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * Global vfs data structures for ufs  */
end_comment

begin_function_decl
name|int
function_decl|(
modifier|*
modifier|*
name|null_vnodeop_p
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|vnodeopv_entry_desc
name|lofs_vnodeop_entries
index|[]
init|=
block|{
block|{
operator|&
name|vop_default_desc
block|,
name|vn_default_error
block|}
block|,
block|{
operator|&
name|vop_lookup_desc
block|,
name|null_lookup
block|}
block|,
comment|/* lookup */
block|{
operator|&
name|vop_create_desc
block|,
name|null_create
block|}
block|,
comment|/* create */
block|{
operator|&
name|vop_mknod_desc
block|,
name|null_mknod
block|}
block|,
comment|/* mknod */
block|{
operator|&
name|vop_open_desc
block|,
name|null_open
block|}
block|,
comment|/* open */
block|{
operator|&
name|vop_close_desc
block|,
name|null_close
block|}
block|,
comment|/* close */
block|{
operator|&
name|vop_access_desc
block|,
name|null_access
block|}
block|,
comment|/* access */
block|{
operator|&
name|vop_getattr_desc
block|,
name|null_getattr
block|}
block|,
comment|/* getattr */
block|{
operator|&
name|vop_setattr_desc
block|,
name|null_setattr
block|}
block|,
comment|/* setattr */
block|{
operator|&
name|vop_read_desc
block|,
name|null_read
block|}
block|,
comment|/* read */
block|{
operator|&
name|vop_write_desc
block|,
name|null_write
block|}
block|,
comment|/* write */
block|{
operator|&
name|vop_ioctl_desc
block|,
name|null_ioctl
block|}
block|,
comment|/* ioctl */
block|{
operator|&
name|vop_select_desc
block|,
name|null_select
block|}
block|,
comment|/* select */
block|{
operator|&
name|vop_mmap_desc
block|,
name|null_mmap
block|}
block|,
comment|/* mmap */
block|{
operator|&
name|vop_fsync_desc
block|,
name|null_fsync
block|}
block|,
comment|/* fsync */
block|{
operator|&
name|vop_seek_desc
block|,
name|null_seek
block|}
block|,
comment|/* seek */
block|{
operator|&
name|vop_remove_desc
block|,
name|null_remove
block|}
block|,
comment|/* remove */
block|{
operator|&
name|vop_link_desc
block|,
name|null_link
block|}
block|,
comment|/* link */
block|{
operator|&
name|vop_rename_desc
block|,
name|null_rename
block|}
block|,
comment|/* rename */
block|{
operator|&
name|vop_mkdir_desc
block|,
name|null_mkdir
block|}
block|,
comment|/* mkdir */
block|{
operator|&
name|vop_rmdir_desc
block|,
name|null_rmdir
block|}
block|,
comment|/* rmdir */
block|{
operator|&
name|vop_symlink_desc
block|,
name|null_symlink
block|}
block|,
comment|/* symlink */
block|{
operator|&
name|vop_readdir_desc
block|,
name|null_readdir
block|}
block|,
comment|/* readdir */
block|{
operator|&
name|vop_readlink_desc
block|,
name|null_readlink
block|}
block|,
comment|/* readlink */
block|{
operator|&
name|vop_abortop_desc
block|,
name|null_abortop
block|}
block|,
comment|/* abortop */
block|{
operator|&
name|vop_inactive_desc
block|,
name|null_inactive
block|}
block|,
comment|/* inactive */
block|{
operator|&
name|vop_reclaim_desc
block|,
name|null_reclaim
block|}
block|,
comment|/* reclaim */
block|{
operator|&
name|vop_lock_desc
block|,
name|null_lock
block|}
block|,
comment|/* lock */
block|{
operator|&
name|vop_unlock_desc
block|,
name|null_unlock
block|}
block|,
comment|/* unlock */
block|{
operator|&
name|vop_bmap_desc
block|,
name|null_bmap
block|}
block|,
comment|/* bmap */
block|{
operator|&
name|vop_strategy_desc
block|,
name|null_strategy
block|}
block|,
comment|/* strategy */
block|{
operator|&
name|vop_print_desc
block|,
name|null_print
block|}
block|,
comment|/* print */
block|{
operator|&
name|vop_islocked_desc
block|,
name|null_islocked
block|}
block|,
comment|/* islocked */
block|{
operator|&
name|vop_advlock_desc
block|,
name|null_advlock
block|}
block|,
comment|/* advlock */
block|{
operator|&
name|vop_blkatoff_desc
block|,
name|null_blkatoff
block|}
block|,
comment|/* blkatoff */
block|{
operator|&
name|vop_vget_desc
block|,
name|null_vget
block|}
block|,
comment|/* vget */
block|{
operator|&
name|vop_valloc_desc
block|,
name|null_valloc
block|}
block|,
comment|/* valloc */
block|{
operator|&
name|vop_vfree_desc
block|,
name|null_vfree
block|}
block|,
comment|/* vfree */
block|{
operator|&
name|vop_truncate_desc
block|,
name|null_truncate
block|}
block|,
comment|/* truncate */
block|{
operator|&
name|vop_update_desc
block|,
name|null_update
block|}
block|,
comment|/* update */
block|{
operator|&
name|vop_bwrite_desc
block|,
name|null_bwrite
block|}
block|,
comment|/* bwrite */
block|{
operator|(
expr|struct
name|vnodeop_desc
operator|*
operator|)
name|NULL
block|,
operator|(
name|int
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|vnodeopv_desc
name|lofs_vnodeop_opv_desc
init|=
block|{
operator|&
name|null_vnodeop_p
block|,
name|lofs_vnodeop_entries
block|}
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	uipc_proto.c	4.15	82/02/01	*/
end_comment

begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/socket.h"
end_include

begin_include
include|#
directive|include
file|"../h/protosw.h"
end_include

begin_include
include|#
directive|include
file|"../h/mbuf.h"
end_include

begin_include
include|#
directive|include
file|"../net/in.h"
end_include

begin_include
include|#
directive|include
file|"../net/in_systm.h"
end_include

begin_comment
comment|/*  * Protocol configuration table and routines to search it.  *  * SHOULD INCLUDE A HEADER FILE GIVING DESIRED PROTOCOLS  */
end_comment

begin_comment
comment|/*  * Local protocol handler.  */
end_comment

begin_function_decl
name|int
name|piusrreq
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  * TCP/IP protocol family: IP, ICMP, UDP, TCP.  */
end_comment

begin_function_decl
name|int
name|ip_output
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|ip_init
argument_list|()
decl_stmt|,
name|ip_slowtimo
argument_list|()
decl_stmt|,
name|ip_drain
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|icmp_input
argument_list|()
decl_stmt|,
name|icmp_ctlinput
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|icmp_drain
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|udp_input
argument_list|()
decl_stmt|,
name|udp_ctlinput
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|udp_usrreq
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|udp_init
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|tcp_input
argument_list|()
decl_stmt|,
name|tcp_ctlinput
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|tcp_usrreq
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|tcp_init
argument_list|()
decl_stmt|,
name|tcp_fasttimo
argument_list|()
decl_stmt|,
name|tcp_slowtimo
argument_list|()
decl_stmt|,
name|tcp_drain
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rip_input
argument_list|()
decl_stmt|,
name|rip_output
argument_list|()
decl_stmt|,
name|rip_ctlinput
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rip_usrreq
argument_list|()
decl_stmt|,
name|rip_slowtimo
argument_list|()
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * IMP protocol family: raw interface  */
end_comment

begin_include
include|#
directive|include
file|"imp.h"
end_include

begin_if
if|#
directive|if
name|NIMP
operator|>
literal|0
end_if

begin_decl_stmt
name|int
name|imp_usrreq
argument_list|()
decl_stmt|,
name|imp_output
argument_list|()
decl_stmt|,
name|imp_ctlinput
argument_list|()
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Sundries. */
end_comment

begin_decl_stmt
name|int
name|raw_init
argument_list|()
decl_stmt|,
name|raw_usrreq
argument_list|()
decl_stmt|,
name|raw_input
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|protosw
name|protosw
index|[]
init|=
block|{
block|{
name|SOCK_STREAM
block|,
name|PF_UNIX
block|,
literal|0
block|,
name|PR_CONNREQUIRED
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|piusrreq
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
block|,
block|{
name|SOCK_DGRAM
block|,
name|PF_UNIX
block|,
literal|0
block|,
name|PR_ATOMIC
operator||
name|PR_ADDR
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|piusrreq
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
block|,
block|{
name|SOCK_RDM
block|,
name|PF_UNIX
block|,
literal|0
block|,
name|PR_ATOMIC
operator||
name|PR_ADDR
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|piusrreq
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
block|,
block|{
name|SOCK_RAW
block|,
name|PF_UNIX
block|,
literal|0
block|,
name|PR_ATOMIC
operator||
name|PR_ADDR
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|piusrreq
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|ip_output
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|ip_init
block|,
literal|0
block|,
name|ip_slowtimo
block|,
name|ip_drain
block|, }
block|,
block|{
literal|0
block|,
literal|0
block|,
name|IPPROTO_ICMP
block|,
literal|0
block|,
name|icmp_input
block|,
literal|0
block|,
name|icmp_ctlinput
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|icmp_drain
block|, }
block|,
block|{
name|SOCK_DGRAM
block|,
name|PF_INET
block|,
name|IPPROTO_UDP
block|,
name|PR_ATOMIC
operator||
name|PR_ADDR
block|,
name|udp_input
block|,
literal|0
block|,
name|udp_ctlinput
block|,
literal|0
block|,
name|udp_usrreq
block|,
name|udp_init
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
block|,
block|{
name|SOCK_STREAM
block|,
name|PF_INET
block|,
name|IPPROTO_TCP
block|,
name|PR_CONNREQUIRED
operator||
name|PR_WANTRCVD
block|,
name|tcp_input
block|,
literal|0
block|,
name|tcp_ctlinput
block|,
literal|0
block|,
name|tcp_usrreq
block|,
name|tcp_init
block|,
name|tcp_fasttimo
block|,
name|tcp_slowtimo
block|,
name|tcp_drain
block|, }
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|raw_input
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|raw_usrreq
block|,
name|raw_init
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
block|,
block|{
name|SOCK_RAW
block|,
name|PF_INET
block|,
name|IPPROTO_RAW
block|,
name|PR_ATOMIC
operator||
name|PR_ADDR
block|,
name|rip_input
block|,
name|rip_output
block|,
name|rip_ctlinput
block|,
literal|0
block|,
name|rip_usrreq
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
if|#
directive|if
name|NIMP
operator|>
literal|0
block|,
block|{
name|SOCK_RAW
block|,
name|PF_IMPLINK
block|,
literal|0
block|,
name|PR_ATOMIC
operator||
name|PR_ADDR
block|,
literal|0
block|,
name|imp_output
block|,
name|imp_ctlinput
block|,
literal|0
block|,
name|imp_usrreq
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NPROTOSW
value|(sizeof(protosw) / sizeof(protosw[0]))
end_define

begin_decl_stmt
name|struct
name|protosw
modifier|*
name|protoswLAST
init|=
operator|&
name|protosw
index|[
name|NPROTOSW
operator|-
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Operations on protocol table and protocol families.  */
end_comment

begin_comment
comment|/*  * Initialize all protocols.  */
end_comment

begin_macro
name|pfinit
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|protosw
modifier|*
name|pr
decl_stmt|;
name|COUNT
argument_list|(
name|PFINIT
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|protoswLAST
init|;
name|pr
operator|>=
name|protosw
condition|;
name|pr
operator|--
control|)
if|if
condition|(
name|pr
operator|->
name|pr_init
condition|)
call|(
modifier|*
name|pr
operator|->
name|pr_init
call|)
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Find a standard protocol in a protocol family  * of a specific type.  */
end_comment

begin_function
name|struct
name|protosw
modifier|*
name|pffindtype
parameter_list|(
name|family
parameter_list|,
name|type
parameter_list|)
name|int
name|family
decl_stmt|,
name|type
decl_stmt|;
block|{
specifier|register
name|struct
name|protosw
modifier|*
name|pr
decl_stmt|;
name|COUNT
argument_list|(
name|PFFINDTYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|family
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|pr
operator|=
name|protosw
init|;
name|pr
operator|<=
name|protoswLAST
condition|;
name|pr
operator|++
control|)
if|if
condition|(
name|pr
operator|->
name|pr_family
operator|==
name|family
operator|&&
name|pr
operator|->
name|pr_type
operator|==
name|type
condition|)
return|return
operator|(
name|pr
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find a specified protocol in a specified protocol family.  */
end_comment

begin_function
name|struct
name|protosw
modifier|*
name|pffindproto
parameter_list|(
name|family
parameter_list|,
name|protocol
parameter_list|)
name|int
name|family
decl_stmt|,
name|protocol
decl_stmt|;
block|{
specifier|register
name|struct
name|protosw
modifier|*
name|pr
decl_stmt|;
name|COUNT
argument_list|(
name|PFFINDPROTO
argument_list|)
expr_stmt|;
if|if
condition|(
name|family
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|pr
operator|=
name|protosw
init|;
name|pr
operator|<=
name|protoswLAST
condition|;
name|pr
operator|++
control|)
if|if
condition|(
name|pr
operator|->
name|pr_family
operator|==
name|family
operator|&&
name|pr
operator|->
name|pr_protocol
operator|==
name|protocol
condition|)
return|return
operator|(
name|pr
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Slow timeout on all protocols.  */
end_comment

begin_macro
name|pfslowtimo
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|protosw
modifier|*
name|pr
decl_stmt|;
name|COUNT
argument_list|(
name|PFSLOWTIMO
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|protoswLAST
init|;
name|pr
operator|>=
name|protosw
condition|;
name|pr
operator|--
control|)
if|if
condition|(
name|pr
operator|->
name|pr_slowtimo
condition|)
call|(
modifier|*
name|pr
operator|->
name|pr_slowtimo
call|)
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|pffasttimo
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|protosw
modifier|*
name|pr
decl_stmt|;
name|COUNT
argument_list|(
name|PFSLOWTIMO
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|protoswLAST
init|;
name|pr
operator|>=
name|protosw
condition|;
name|pr
operator|--
control|)
if|if
condition|(
name|pr
operator|->
name|pr_fasttimo
condition|)
call|(
modifier|*
name|pr
operator|->
name|pr_fasttimo
call|)
argument_list|()
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1990 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz.  *  * %sccs.include.386.c%  *  *	@(#)pccons.c	5.1 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * code to work keyboard& display for console  */
end_comment

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"conf.h"
end_include

begin_include
include|#
directive|include
file|"dir.h"
end_include

begin_include
include|#
directive|include
file|"ioctl.h"
end_include

begin_include
include|#
directive|include
file|"user.h"
end_include

begin_include
include|#
directive|include
file|"proc.h"
end_include

begin_include
include|#
directive|include
file|"tty.h"
end_include

begin_include
include|#
directive|include
file|"uio.h"
end_include

begin_include
include|#
directive|include
file|"callout.h"
end_include

begin_include
include|#
directive|include
file|"systm.h"
end_include

begin_include
include|#
directive|include
file|"kernel.h"
end_include

begin_include
include|#
directive|include
file|"syslog.h"
end_include

begin_include
include|#
directive|include
file|"icu.h"
end_include

begin_decl_stmt
name|struct
name|tty
name|cons
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|consoftc
block|{
name|char
name|cs_flags
decl_stmt|;
define|#
directive|define
name|CSF_ACTIVE
value|0x1
comment|/* timeout active */
define|#
directive|define
name|CSF_POLLING
value|0x2
comment|/* polling for input */
name|char
name|cs_lastc
decl_stmt|;
comment|/* last char sent */
name|int
name|cs_timo
decl_stmt|;
comment|/* timeouts since interrupt */
name|u_long
name|cs_wedgecnt
decl_stmt|;
comment|/* times restarted */
block|}
name|consoftc
struct|;
end_struct

begin_comment
comment|/*  * We check the console periodically to make sure  * that it hasn't wedged.  Unfortunately, if an XOFF  * is typed on the console, that can't be distinguished  * from more catastrophic failure.  */
end_comment

begin_define
define|#
directive|define
name|CN_TIMERVAL
value|(hz)
end_define

begin_comment
comment|/* frequency at which to check cons */
end_comment

begin_define
define|#
directive|define
name|CN_TIMO
value|(2*60)
end_define

begin_comment
comment|/* intervals to allow for output char */
end_comment

begin_function_decl
name|int
name|cnstart
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|ttrstrt
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
name|partab
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Wait for CP to accept last CP command sent  * before setting up next command.  */
end_comment

begin_define
define|#
directive|define
name|waitforlast
parameter_list|(
name|timo
parameter_list|)
value|{ \ 	if (cnlast) { \ 		(timo) = 10000; \ 		do \ 			uncache((char *)&cnlast->cp_unit); \ 		while ((cnlast->cp_unit&CPTAKE) == 0&& --(timo)); \ 	} \ }
end_define

begin_function_decl
name|u_char
name|inb
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|cnopen
argument_list|(
argument|dev
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
name|int
name|unit
init|=
name|minor
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|tp
operator|=
operator|&
name|cons
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|TS_XCLUDE
operator|&&
name|u
operator|.
name|u_uid
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|tp
operator|->
name|t_oproc
operator|=
name|cnstart
expr_stmt|;
if|if
condition|(
operator|(
name|tp
operator|->
name|t_state
operator|&
name|TS_ISOPEN
operator|)
operator|==
literal|0
condition|)
block|{
name|ttychars
argument_list|(
name|tp
argument_list|)
expr_stmt|;
name|tp
operator|->
name|t_state
operator|=
name|TS_ISOPEN
operator||
name|TS_CARR_ON
expr_stmt|;
name|tp
operator|->
name|t_flags
operator|=
name|EVENP
operator||
name|ECHO
operator||
name|XTABS
operator||
name|CRMOD
expr_stmt|;
name|INTREN
argument_list|(
name|IRQ1
argument_list|)
expr_stmt|;
name|splnone
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_open
operator|)
operator|(
name|dev
operator|,
name|tp
operator|)
operator|)
return|;
block|}
end_block

begin_macro
name|cnclose
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
operator|(
operator|*
name|linesw
index|[
name|cons
operator|.
name|t_line
index|]
operator|.
name|l_close
operator|)
operator|(
operator|&
name|cons
operator|)
expr_stmt|;
name|ttyclose
argument_list|(
operator|&
name|cons
argument_list|)
expr_stmt|;
name|INTRDIS
argument_list|(
name|IRQ1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|cnread
argument_list|(
argument|dev
argument_list|,
argument|uio
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
operator|(
operator|*
name|linesw
index|[
name|cons
operator|.
name|t_line
index|]
operator|.
name|l_read
operator|)
operator|(
operator|&
name|cons
operator|,
name|uio
operator|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|cnwrite
argument_list|(
argument|dev
argument_list|,
argument|uio
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
operator|(
operator|*
name|linesw
index|[
name|cons
operator|.
name|t_line
index|]
operator|.
name|l_write
operator|)
operator|(
operator|&
name|cons
operator|,
name|uio
operator|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * Got a console receive interrupt -  * the console processor wants to give us a character.  * Catch the character, and see who it goes to.  */
end_comment

begin_macro
name|cnrint
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|c
decl_stmt|;
name|c
operator|=
name|sgetc
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|&
literal|0x100
condition|)
return|return;
if|if
condition|(
name|consoftc
operator|.
name|cs_flags
operator|&
name|CSF_POLLING
condition|)
return|return;
ifdef|#
directive|ifdef
name|KDB
if|if
condition|(
name|kdbrintr
argument_list|(
name|c
argument_list|,
operator|&
name|cons
argument_list|)
condition|)
return|return;
endif|#
directive|endif
operator|(
operator|*
name|linesw
index|[
name|cons
operator|.
name|t_line
index|]
operator|.
name|l_rint
operator|)
operator|(
name|c
operator|&
literal|0xff
operator|,
operator|&
name|cons
operator|)
expr_stmt|;
block|}
end_block

begin_macro
name|cnioctl
argument_list|(
argument|dev
argument_list|,
argument|cmd
argument_list|,
argument|addr
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
init|=
operator|&
name|cons
decl_stmt|;
specifier|register
name|error
expr_stmt|;
name|error
operator|=
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_ioctl
operator|)
operator|(
name|tp
operator|,
name|cmd
operator|,
name|addr
operator|)
expr_stmt|;
if|if
condition|(
name|error
operator|>=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|ttioctl
argument_list|(
name|tp
argument_list|,
name|cmd
argument_list|,
name|addr
argument_list|,
name|flag
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|error
operator|=
name|ENOTTY
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|==
name|TIOCSETP
operator|||
name|cmd
operator|==
name|TIOCSETN
condition|)
name|cnparams
argument_list|(
name|tp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_decl_stmt
name|int
name|consintr
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Got a console transmission interrupt -  * the console processor wants another character.  */
end_comment

begin_macro
name|cnxint
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
specifier|register
name|int
name|unit
decl_stmt|;
if|if
condition|(
operator|!
name|consintr
condition|)
return|return;
name|cons
operator|.
name|t_state
operator|&=
operator|~
name|TS_BUSY
expr_stmt|;
name|consoftc
operator|.
name|cs_timo
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cons
operator|.
name|t_line
condition|)
operator|(
operator|*
name|linesw
index|[
name|cons
operator|.
name|t_line
index|]
operator|.
name|l_start
operator|)
operator|(
operator|&
name|cons
operator|)
expr_stmt|;
else|else
name|cnstart
argument_list|(
operator|&
name|cons
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|cnstart
argument_list|(
name|tp
argument_list|)
specifier|register
expr|struct
name|tty
operator|*
name|tp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|c
operator|,
name|s
expr_stmt|;
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
operator|(
name|TS_TIMEOUT
operator||
name|TS_BUSY
operator||
name|TS_TTSTOP
operator|)
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|<=
name|TTLOWAT
argument_list|(
name|tp
argument_list|)
condition|)
block|{
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|TS_ASLEEP
condition|)
block|{
name|tp
operator|->
name|t_state
operator|&=
operator|~
name|TS_ASLEEP
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|tp
operator|->
name|t_outq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tp
operator|->
name|t_wsel
condition|)
block|{
name|selwakeup
argument_list|(
name|tp
operator|->
name|t_wsel
argument_list|,
name|tp
operator|->
name|t_state
operator|&
name|TS_WCOLL
argument_list|)
expr_stmt|;
name|tp
operator|->
name|t_wsel
operator|=
literal|0
expr_stmt|;
name|tp
operator|->
name|t_state
operator|&=
operator|~
name|TS_WCOLL
expr_stmt|;
block|}
block|}
while|while
condition|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|!=
literal|0
condition|)
block|{
name|c
operator|=
name|getc
argument_list|(
operator|&
name|tp
operator|->
name|t_outq
argument_list|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
operator|(
name|tp
operator|->
name|t_flags
operator|&
operator|(
name|RAW
operator||
name|LITOUT
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|>
literal|0177
condition|)
block|{
name|timeout
argument_list|(
name|ttrstrt
argument_list|,
operator|(
name|caddr_t
operator|)
name|tp
argument_list|,
operator|(
name|c
operator|&
literal|0177
operator|)
argument_list|)
expr_stmt|;
name|tp
operator|->
name|t_state
operator||=
name|TS_TIMEOUT
expr_stmt|;
break|break;
block|}
name|c
operator|&=
literal|0177
expr_stmt|;
block|}
name|sput
argument_list|(
name|c
argument_list|,
literal|0xc
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cnputc
argument_list|(
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|char
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
name|sput
argument_list|(
literal|'\r'
argument_list|,
literal|0xb
argument_list|)
expr_stmt|;
name|sput
argument_list|(
name|c
argument_list|,
literal|0xb
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Print a character on console.  */
end_comment

begin_macro
name|cnputchar
argument_list|(
argument|c
argument_list|,
argument|tp
argument_list|)
end_macro

begin_decl_stmt
name|char
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|sput
argument_list|(
name|c
argument_list|,
literal|0xa
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
name|getchar
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|cngetc
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|s
decl_stmt|;
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
comment|/* block cnrint while we poll */
if|if
condition|(
name|c
operator|==
literal|'\r'
condition|)
name|c
operator|=
literal|'\n'
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|c
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|cngetchar
argument_list|(
name|tp
argument_list|)
specifier|register
expr|struct
name|tty
operator|*
name|tp
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|c
decl_stmt|;
name|c
operator|=
name|sgetc
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|c
operator|&
literal|0xff
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * Set line parameters  */
end_comment

begin_expr_stmt
name|cnparams
argument_list|(
name|tp
argument_list|)
specifier|register
expr|struct
name|tty
operator|*
name|tp
expr_stmt|;
end_expr_stmt

begin_block
block|{ }
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|KDB
end_ifdef

begin_comment
comment|/*  * Turn input polling on/off (used by debugger).  */
end_comment

begin_macro
name|cnpoll
argument_list|(
argument|onoff
argument_list|)
end_macro

begin_decl_stmt
name|int
name|onoff
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|CRT_TXTADDR
value|Crtat
end_define

begin_define
define|#
directive|define
name|COL
value|80
end_define

begin_define
define|#
directive|define
name|ROW
value|25
end_define

begin_define
define|#
directive|define
name|CHR
value|2
end_define

begin_decl_stmt
name|u_short
modifier|*
name|Crtat
init|=
operator|(
operator|(
name|u_short
operator|*
operator|)
literal|0xb8000
operator|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_short
modifier|*
name|crtat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|color
init|=
literal|0xe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|row
decl_stmt|;
end_decl_stmt

begin_macro
name|sput
argument_list|(
argument|c
argument_list|,
argument|ca
argument_list|)
end_macro

begin_decl_stmt
name|u_char
name|c
decl_stmt|,
name|ca
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|inb
argument_list|(
literal|0x64
argument_list|)
operator|&
literal|2
operator|==
literal|0
condition|)
name|sgetc
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|crtat
operator|==
literal|0
condition|)
block|{
name|INTREN
argument_list|(
name|IRQ1
argument_list|)
expr_stmt|;
comment|/* XXX */
name|crtat
operator|=
name|CRT_TXTADDR
expr_stmt|;
name|bzero
argument_list|(
name|crtat
argument_list|,
name|COL
operator|*
name|ROW
operator|*
name|CHR
argument_list|)
expr_stmt|;
block|}
comment|/*if (crtat>= (CRT_TXTADDR+COL*(ROW-1))) { 		crtat = CRT_TXTADDR+COL*(ROW-1); row = 0; 	}*/
if|if
condition|(
name|crtat
operator|>=
name|CRT_TXTADDR
operator|+
name|COL
operator|*
operator|(
name|ROW
operator|-
literal|1
operator|)
condition|)
block|{
comment|/* scroll */
name|bcopy
argument_list|(
name|CRT_TXTADDR
operator|+
name|COL
argument_list|,
name|CRT_TXTADDR
argument_list|,
name|COL
operator|*
operator|(
name|ROW
operator|-
literal|1
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|CRT_TXTADDR
operator|+
name|COL
operator|*
operator|(
name|ROW
operator|-
literal|1
operator|)
argument_list|,
name|COL
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|crtat
operator|-=
name|COL
expr_stmt|;
block|}
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\t'
case|:
do|do
block|{
operator|*
name|crtat
operator|++
operator|=
operator|(
name|ca
operator|<<
literal|8
operator|)
operator||
literal|' '
expr_stmt|;
name|row
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|row
operator|%
literal|8
condition|)
do|;
break|break;
case|case
literal|'\010'
case|:
name|crtat
operator|--
expr_stmt|;
name|row
operator|--
expr_stmt|;
break|break;
case|case
literal|'\r'
case|:
comment|/*bzero (crtat,(COL-row)*CHR) ;*/
name|crtat
operator|-=
name|row
expr_stmt|;
name|row
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
if|if
condition|(
name|crtat
operator|>=
name|CRT_TXTADDR
operator|+
name|COL
operator|*
operator|(
name|ROW
operator|-
literal|1
operator|)
condition|)
block|{
comment|/* scroll */
name|bcopy
argument_list|(
name|CRT_TXTADDR
operator|+
name|COL
argument_list|,
name|CRT_TXTADDR
argument_list|,
name|COL
operator|*
operator|(
name|ROW
operator|-
literal|1
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|CRT_TXTADDR
operator|+
name|COL
operator|*
operator|(
name|ROW
operator|-
literal|1
operator|)
argument_list|,
name|COL
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|crtat
operator|-=
name|COL
expr_stmt|;
block|}
name|crtat
operator|+=
name|COL
expr_stmt|;
break|break;
default|default:
operator|*
name|crtat
operator|++
operator|=
operator|(
name|ca
operator|<<
literal|8
operator|)
operator||
name|c
expr_stmt|;
name|row
operator|++
expr_stmt|;
if|if
condition|(
name|row
operator|>=
name|COL
condition|)
block|{
comment|/*bzero (crtat,(COL-row)*CHR) ;*/
name|crtat
operator|-=
name|row
expr_stmt|;
name|row
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|crtat
operator|>=
name|CRT_TXTADDR
operator|+
name|COL
operator|*
operator|(
name|ROW
operator|-
literal|1
operator|)
condition|)
block|{
comment|/* scroll */
name|bcopy
argument_list|(
name|CRT_TXTADDR
operator|+
name|COL
argument_list|,
name|CRT_TXTADDR
argument_list|,
name|COL
operator|*
operator|(
name|ROW
operator|-
literal|1
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|CRT_TXTADDR
operator|+
name|COL
operator|*
operator|(
name|ROW
operator|-
literal|1
operator|)
argument_list|,
name|COL
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|crtat
operator|-=
name|COL
expr_stmt|;
block|}
name|crtat
operator|+=
name|COL
expr_stmt|;
block|}
break|break ;
block|}
block|}
end_block

begin_define
define|#
directive|define
name|L
value|0x0001
end_define

begin_comment
comment|/* locking function */
end_comment

begin_define
define|#
directive|define
name|SHF
value|0x0002
end_define

begin_comment
comment|/* keyboard shift */
end_comment

begin_define
define|#
directive|define
name|ALT
value|0x0004
end_define

begin_comment
comment|/* alternate shift -- alternate chars */
end_comment

begin_define
define|#
directive|define
name|NUM
value|0x0008
end_define

begin_comment
comment|/* numeric shift  cursors vs. numeric */
end_comment

begin_define
define|#
directive|define
name|CTL
value|0x0010
end_define

begin_comment
comment|/* control shift  -- allows ctl function */
end_comment

begin_define
define|#
directive|define
name|CPS
value|0x0020
end_define

begin_comment
comment|/* caps shift -- swaps case of letter */
end_comment

begin_define
define|#
directive|define
name|ASCII
value|0x0040
end_define

begin_comment
comment|/* ascii code for this key */
end_comment

begin_define
define|#
directive|define
name|STP
value|0x0080
end_define

begin_comment
comment|/* stop output */
end_comment

begin_define
define|#
directive|define
name|FUNC
value|0x0100
end_define

begin_comment
comment|/* function key */
end_comment

begin_define
define|#
directive|define
name|SYSREQ
value|0x0200
end_define

begin_comment
comment|/* sys req key */
end_comment

begin_decl_stmt
name|unsigned
name|__debug
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_short
name|action
index|[]
init|=
block|{
literal|0
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan  0- 7 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan  8-15 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan 16-23 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|CTL
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan 24-31 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan 32-39 */
name|ASCII
block|,
name|ASCII
block|,
name|SHF
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan 40-47 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|SHF
block|,
name|ASCII
block|,
comment|/* scan 48-55 */
name|ALT
block|,
name|ASCII
block|,
name|CPS
operator||
name|L
block|,
name|FUNC
block|,
name|FUNC
block|,
name|FUNC
block|,
name|FUNC
block|,
name|FUNC
block|,
comment|/* scan 56-63 */
name|FUNC
block|,
name|FUNC
block|,
name|FUNC
block|,
name|FUNC
block|,
name|FUNC
block|,
name|NUM
operator||
name|L
block|,
name|STP
operator||
name|L
block|,
name|ASCII
block|,
comment|/* scan 64-71 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan 72-79 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 80-87 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,	}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|unshift
index|[]
init|=
block|{
comment|/* no shift */
literal|0
block|,
literal|033
block|,
literal|'1'
block|,
literal|'2'
block|,
literal|'3'
block|,
literal|'4'
block|,
literal|'5'
block|,
literal|'6'
block|,
comment|/* scan  0- 7 */
literal|'7'
block|,
literal|'8'
block|,
literal|'9'
block|,
literal|'0'
block|,
literal|'-'
block|,
literal|'='
block|,
literal|0177
block|,
literal|'\t'
block|,
comment|/* scan  8-15 */
literal|'q'
block|,
literal|'w'
block|,
literal|'e'
block|,
literal|'r'
block|,
literal|'t'
block|,
literal|'y'
block|,
literal|'u'
block|,
literal|'i'
block|,
comment|/* scan 16-23 */
literal|'o'
block|,
literal|'p'
block|,
literal|'['
block|,
literal|']'
block|,
literal|'\r'
block|,
name|CTL
block|,
literal|'a'
block|,
literal|'s'
block|,
comment|/* scan 24-31 */
literal|'d'
block|,
literal|'f'
block|,
literal|'g'
block|,
literal|'h'
block|,
literal|'j'
block|,
literal|'k'
block|,
literal|'l'
block|,
literal|';'
block|,
comment|/* scan 32-39 */
literal|'\''
block|,
literal|'`'
block|,
name|SHF
block|,
literal|'\\'
block|,
literal|'z'
block|,
literal|'x'
block|,
literal|'c'
block|,
literal|'v'
block|,
comment|/* scan 40-47 */
literal|'b'
block|,
literal|'n'
block|,
literal|'m'
block|,
literal|','
block|,
literal|'.'
block|,
literal|'/'
block|,
name|SHF
block|,
literal|'*'
block|,
comment|/* scan 48-55 */
name|ALT
block|,
literal|' '
block|,
name|CPS
operator||
name|L
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
comment|/* scan 56-63 */
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
name|NUM
operator||
name|L
block|,
name|STP
operator||
name|L
block|,
literal|'7'
block|,
comment|/* scan 64-71 */
literal|'8'
block|,
literal|'9'
block|,
literal|'-'
block|,
literal|'4'
block|,
literal|'5'
block|,
literal|'6'
block|,
literal|'+'
block|,
literal|'1'
block|,
comment|/* scan 72-79 */
literal|'2'
block|,
literal|'3'
block|,
literal|'0'
block|,
literal|'.'
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 80-87 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,	}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|shift
index|[]
init|=
block|{
comment|/* shift shift */
literal|0
block|,
literal|033
block|,
literal|'!'
block|,
literal|'@'
block|,
literal|'#'
block|,
literal|'$'
block|,
literal|'%'
block|,
literal|'^'
block|,
comment|/* scan  0- 7 */
literal|'&'
block|,
literal|'*'
block|,
literal|'('
block|,
literal|')'
block|,
literal|'_'
block|,
literal|'+'
block|,
literal|0177
block|,
literal|'\t'
block|,
comment|/* scan  8-15 */
literal|'Q'
block|,
literal|'W'
block|,
literal|'E'
block|,
literal|'R'
block|,
literal|'T'
block|,
literal|'Y'
block|,
literal|'U'
block|,
literal|'I'
block|,
comment|/* scan 16-23 */
literal|'O'
block|,
literal|'P'
block|,
literal|'{'
block|,
literal|'}'
block|,
literal|'\r'
block|,
name|CTL
block|,
literal|'A'
block|,
literal|'S'
block|,
comment|/* scan 24-31 */
literal|'D'
block|,
literal|'F'
block|,
literal|'G'
block|,
literal|'H'
block|,
literal|'J'
block|,
literal|'K'
block|,
literal|'L'
block|,
literal|':'
block|,
comment|/* scan 32-39 */
literal|'"'
block|,
literal|'~'
block|,
name|SHF
block|,
literal|'|'
block|,
literal|'Z'
block|,
literal|'X'
block|,
literal|'C'
block|,
literal|'V'
block|,
comment|/* scan 40-47 */
literal|'B'
block|,
literal|'N'
block|,
literal|'M'
block|,
literal|'<'
block|,
literal|'>'
block|,
literal|'?'
block|,
name|SHF
block|,
literal|'*'
block|,
comment|/* scan 48-55 */
name|ALT
block|,
literal|' '
block|,
name|CPS
operator||
name|L
block|,
literal|0
block|,
literal|0
block|,
literal|' '
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 56-63 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|NUM
operator||
name|L
block|,
name|STP
operator||
name|L
block|,
literal|'7'
block|,
comment|/* scan 64-71 */
literal|'8'
block|,
literal|'9'
block|,
literal|'-'
block|,
literal|'4'
block|,
literal|'5'
block|,
literal|'6'
block|,
literal|'+'
block|,
literal|'1'
block|,
comment|/* scan 72-79 */
literal|'2'
block|,
literal|'3'
block|,
literal|'0'
block|,
literal|'.'
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 80-87 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,	}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|ctl
index|[]
init|=
block|{
comment|/* CTL shift */
literal|0
block|,
literal|033
block|,
literal|'!'
block|,
literal|000
block|,
literal|'#'
block|,
literal|'$'
block|,
literal|'%'
block|,
literal|036
block|,
comment|/* scan  0- 7 */
literal|'&'
block|,
literal|'*'
block|,
literal|'('
block|,
literal|')'
block|,
literal|037
block|,
literal|'+'
block|,
literal|034
block|,
literal|'\177'
block|,
comment|/* scan  8-15 */
literal|021
block|,
literal|027
block|,
literal|005
block|,
literal|022
block|,
literal|024
block|,
literal|031
block|,
literal|025
block|,
literal|011
block|,
comment|/* scan 16-23 */
literal|017
block|,
literal|020
block|,
literal|033
block|,
literal|035
block|,
literal|'\r'
block|,
name|CTL
block|,
literal|001
block|,
literal|023
block|,
comment|/* scan 24-31 */
literal|004
block|,
literal|006
block|,
literal|007
block|,
literal|010
block|,
literal|012
block|,
literal|013
block|,
literal|014
block|,
literal|';'
block|,
comment|/* scan 32-39 */
literal|'\''
block|,
literal|'`'
block|,
name|SHF
block|,
literal|034
block|,
literal|032
block|,
literal|030
block|,
literal|003
block|,
literal|026
block|,
comment|/* scan 40-47 */
literal|002
block|,
literal|016
block|,
literal|015
block|,
literal|'<'
block|,
literal|'>'
block|,
literal|'?'
block|,
name|SHF
block|,
literal|'*'
block|,
comment|/* scan 48-55 */
name|ALT
block|,
literal|' '
block|,
name|CPS
operator||
name|L
block|,
literal|0
block|,
literal|0
block|,
literal|' '
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 56-63 */
name|CPS
operator||
name|L
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 64-71 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 72-79 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 80-87 */
literal|0
block|,
literal|0
block|,
literal|033
block|,
literal|'7'
block|,
literal|'4'
block|,
literal|'1'
block|,
literal|0
block|,
name|NUM
operator||
name|L
block|,
comment|/* scan 88-95 */
literal|'8'
block|,
literal|'5'
block|,
literal|'2'
block|,
literal|0
block|,
name|STP
operator||
name|L
block|,
literal|'9'
block|,
literal|'6'
block|,
literal|'3'
block|,
comment|/*scan  96-103*/
literal|'.'
block|,
literal|0
block|,
literal|'*'
block|,
literal|'-'
block|,
literal|'+'
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/*scan 104-111*/
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,	}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|notdef
end_ifdef

begin_struct
struct|struct
name|key
block|{
name|u_short
name|action
decl_stmt|;
comment|/* how this key functions */
name|char
name|ascii
index|[
literal|8
index|]
decl_stmt|;
comment|/* ascii result character indexed by shifts */
block|}
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|u_char
name|shfts
decl_stmt|,
name|ctls
decl_stmt|,
name|alts
decl_stmt|,
name|caps
decl_stmt|,
name|num
decl_stmt|,
name|stp
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|KBSTATP
value|0x64
end_define

begin_comment
comment|/* kbd status port */
end_comment

begin_define
define|#
directive|define
name|KBS_INP_BUF_FUL
value|0x02
end_define

begin_comment
comment|/* kbd char ready */
end_comment

begin_define
define|#
directive|define
name|KBDATAP
value|0x60
end_define

begin_comment
comment|/* kbd data port */
end_comment

begin_define
define|#
directive|define
name|KBSTATUSPORT
value|0x61
end_define

begin_comment
comment|/* kbd status */
end_comment

begin_decl_stmt
name|u_char
name|odt
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|sgetc
parameter_list|(
name|on
parameter_list|)
block|{
name|u_char
name|dt
decl_stmt|,
name|brk
decl_stmt|;
name|u_short
name|act
decl_stmt|;
name|loop
label|:
do|do
block|{
while|while
condition|(
name|inb
argument_list|(
literal|0x64
argument_list|)
operator|&
literal|2
condition|)
empty_stmt|;
name|dt
operator|=
name|inb
argument_list|(
literal|0x60
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|dt
operator|==
name|odt
condition|)
do|;
name|odt
operator|=
name|dt
expr_stmt|;
if|if
condition|(
name|dt
operator|==
literal|0x54
condition|)
name|_exit
argument_list|()
expr_stmt|;
name|brk
operator|=
name|dt
operator|&
literal|0x80
expr_stmt|;
name|dt
operator|=
name|dt
operator|&
literal|0x7f
expr_stmt|;
name|act
operator|=
name|action
index|[
name|dt
index|]
expr_stmt|;
if|if
condition|(
name|act
operator|&
name|SHF
condition|)
block|{
if|if
condition|(
name|brk
condition|)
name|shfts
operator|=
literal|0
expr_stmt|;
else|else
name|shfts
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|act
operator|&
name|ALT
condition|)
block|{
if|if
condition|(
name|brk
condition|)
name|alts
operator|=
literal|0
expr_stmt|;
else|else
name|alts
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|act
operator|&
name|NUM
condition|)
block|{
if|if
condition|(
name|act
operator|&
name|L
condition|)
block|{
if|if
condition|(
operator|!
name|brk
condition|)
name|num
operator|^=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|brk
condition|)
name|num
operator|=
literal|0
expr_stmt|;
else|else
name|num
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|act
operator|&
name|CTL
condition|)
block|{
if|if
condition|(
name|brk
condition|)
name|ctls
operator|=
literal|0
expr_stmt|;
else|else
name|ctls
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|act
operator|&
name|CPS
condition|)
block|{
if|if
condition|(
name|act
operator|&
name|L
condition|)
block|{
if|if
condition|(
operator|!
name|brk
condition|)
name|caps
operator|^=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|brk
condition|)
name|caps
operator|=
literal|0
expr_stmt|;
else|else
name|caps
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|act
operator|&
name|STP
condition|)
block|{
if|if
condition|(
name|act
operator|&
name|L
condition|)
block|{
if|if
condition|(
operator|!
name|brk
condition|)
name|stp
operator|^=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|brk
condition|)
name|stp
operator|=
literal|0
expr_stmt|;
else|else
name|stp
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|act
operator|&
name|FUNC
operator|)
operator|&&
name|brk
condition|)
block|{
name|unsigned
name|key
init|=
name|unshift
index|[
name|dt
index|]
decl_stmt|;
if|if
condition|(
name|__debug
operator|&
operator|(
literal|1
operator|<<
name|key
operator|)
condition|)
name|__debug
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|key
operator|)
expr_stmt|;
else|else
name|__debug
operator||=
operator|(
literal|1
operator|<<
name|key
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|stp
condition|)
goto|goto
name|loop
goto|;
if|if
condition|(
operator|(
name|act
operator|&
name|ASCII
operator|)
operator|&&
operator|!
name|brk
condition|)
block|{
name|u_char
name|chr
decl_stmt|;
if|if
condition|(
name|shfts
condition|)
block|{
name|chr
operator|=
name|shift
index|[
name|dt
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ctls
condition|)
block|{
name|chr
operator|=
name|ctl
index|[
name|dt
index|]
expr_stmt|;
block|}
else|else
block|{
name|chr
operator|=
name|unshift
index|[
name|dt
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
name|caps
operator|&&
operator|(
name|chr
operator|>=
literal|'a'
operator|&&
name|chr
operator|<=
literal|'z'
operator|)
condition|)
block|{
name|chr
operator|-=
literal|'a'
operator|-
literal|'A'
expr_stmt|;
block|}
return|return
operator|(
name|chr
operator|)
return|;
block|}
if|if
condition|(
name|on
condition|)
return|return
operator|(
literal|0x100
operator|)
return|;
else|else
goto|goto
name|loop
goto|;
block|}
end_function

begin_macro
name|pg
argument_list|(
argument|p
argument_list|,
argument|q
argument_list|,
argument|r
argument_list|,
argument|s
argument_list|,
argument|t
argument_list|,
argument|u
argument_list|,
argument|v
argument_list|,
argument|w
argument_list|,
argument|x
argument_list|,
argument|y
argument_list|,
argument|z
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
name|p
argument_list|,
name|q
argument_list|,
name|r
argument_list|,
name|s
argument_list|,
name|t
argument_list|,
name|u
argument_list|,
name|v
argument_list|,
name|w
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|getchar
argument_list|()
operator|)
return|;
block|}
end_block

begin_comment
comment|/* special characters */
end_comment

begin_define
define|#
directive|define
name|bs
value|8
end_define

begin_define
define|#
directive|define
name|lf
value|10
end_define

begin_define
define|#
directive|define
name|cr
value|13
end_define

begin_define
define|#
directive|define
name|cntlc
value|3
end_define

begin_define
define|#
directive|define
name|del
value|0177
end_define

begin_define
define|#
directive|define
name|cntld
value|4
end_define

begin_macro
name|getchar
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
name|thechar
decl_stmt|;
specifier|register
name|delay
expr_stmt|;
name|int
name|x
decl_stmt|;
name|consoftc
operator|.
name|cs_flags
operator||=
name|CSF_POLLING
expr_stmt|;
name|x
operator|=
name|splhigh
argument_list|()
expr_stmt|;
name|sput
argument_list|(
literal|'>'
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|thechar
operator|=
operator|(
name|char
operator|)
name|sgetc
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|consoftc
operator|.
name|cs_flags
operator|&=
operator|~
name|CSF_POLLING
expr_stmt|;
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|thechar
condition|)
block|{
default|default:
if|if
condition|(
name|thechar
operator|>=
literal|' '
condition|)
name|sput
argument_list|(
name|thechar
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
return|return
operator|(
name|thechar
operator|)
return|;
case|case
name|cr
case|:
case|case
name|lf
case|:
name|sput
argument_list|(
name|cr
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|sput
argument_list|(
name|lf
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
return|return
operator|(
name|lf
operator|)
return|;
case|case
name|bs
case|:
case|case
name|del
case|:
name|sput
argument_list|(
name|bs
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|sput
argument_list|(
literal|' '
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|sput
argument_list|(
name|bs
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
return|return
operator|(
name|thechar
operator|)
return|;
case|case
name|cntlc
case|:
name|sput
argument_list|(
literal|'^'
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|sput
argument_list|(
literal|'C'
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|sput
argument_list|(
literal|'\r'
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|sput
argument_list|(
literal|'\n'
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
case|case
name|cntld
case|:
name|sput
argument_list|(
literal|'^'
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|sput
argument_list|(
literal|'D'
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|sput
argument_list|(
literal|'\r'
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|sput
argument_list|(
literal|'\n'
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
end_block

end_unit


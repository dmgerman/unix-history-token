begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1990 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz.  *  * %sccs.include.noredist.c%  *  *	@(#)srt0.c	7.1 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * Startup code for standalone system  * Non-relocating version -- for programs which are loaded by boot  * Relocating version for boot  */
end_comment

begin_expr_stmt
operator|.
name|globl
name|_end
operator|.
name|globl
name|_edata
operator|.
name|globl
name|_main
operator|.
name|globl
name|__rtt
operator|.
name|globl
name|_exit
operator|.
name|globl
name|_howto
operator|.
name|globl
name|_bootdev
operator|.
name|globl
name|_unit
name|entry
operator|:
operator|.
name|globl
name|entry
name|cli
operator|#
name|no
name|interrupts
ifdef|#
directive|ifdef
name|REL
name|movl
name|$RELOC
operator|,
operator|%
name|esp
else|#
directive|else
name|movl
operator|%
name|esp
operator|,
name|savearea
name|movl
operator|%
name|ebp
operator|,
name|savearea
operator|+
literal|4
name|movl
name|$RELOC
operator|-
literal|0x2400
operator|,
operator|%
name|esp
endif|#
directive|endif
name|movl
operator|%
name|esp
operator|,
operator|%
name|ecx
name|start
operator|:
name|movl
name|$_edata
operator|,
operator|%
name|eax
ifndef|#
directive|ifndef
name|foo
else|#
directive|else
name|subl
operator|%
name|eax
operator|,
operator|%
name|ecx
literal|1
operator|:
name|movl
name|$0
operator|,
operator|(
operator|%
name|eax
operator|)
name|addl
name|$4
operator|,
operator|%
name|eax
name|loopnz
literal|1f
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REL
empty|# movl	$entry-RELOC,%esi	# from beginning of ram
name|movl
name|$0
operator|,
operator|%
name|esi
name|movl
name|$entry
operator|,
operator|%
name|edi
operator|#
name|to
name|relocated
name|area
empty|# movl	$_edata-RELOC,%ecx	# this much
name|movl
name|$64
operator|*
literal|1024
operator|,
operator|%
name|ecx
name|cld
name|rep
name|movsb
operator|.
name|globl
name|begin
empty|# jmp	*$begin	-- does not work, why!?
name|pushl
name|$begin
name|ret
name|begin
operator|:
endif|#
directive|endif
empty|# movl	%esi,_howto
empty|# movl	%edi,_bootdev
empty|# movl	%ebx,_unit
literal|1
operator|:
empty|# calls	$0,_configure
name|movl
name|$1
operator|,
name|_openfirst
name|pushl
name|$0
name|popf
name|call
name|_main
ifdef|#
directive|ifdef
name|REL
name|jmp
literal|1b
else|#
directive|else
name|jmp
literal|1f
endif|#
directive|endif
operator|.
name|data
name|_openfirst
operator|:
operator|.
name|long
literal|0
name|_bootdev
operator|:
operator|.
name|long
literal|0
name|_howto
operator|:
operator|.
name|long
literal|0
name|_unit
operator|:
operator|.
name|long
literal|0
name|savearea
operator|:
operator|.
name|long
literal|0
operator|,
literal|0
operator|#
name|sp
operator|&
name|bp
name|to
end_expr_stmt

begin_return
return|return
name|to
operator|.
name|text
operator|.
name|globl
name|_getchar
operator|.
name|globl
name|_wait
name|__rtt
operator|:
name|call
name|_getchar
name|pushl
name|$1000000
name|call
name|_wait
name|popl
operator|%
name|eax
name|movl
name|$
operator|-
literal|7
operator|,
operator|%
name|eax
name|jmp
literal|1f
name|_exit
operator|:
name|call
name|_getchar
name|pushl
name|$1000000
name|call
name|_wait
name|popl
operator|%
name|eax
name|movl
literal|4
operator|(
name|sp
operator|)
operator|,
operator|%
name|eax
literal|1
operator|:
ifdef|#
directive|ifdef
name|REL
name|movw
name|$0x1234
operator|,
operator|%
name|ax
name|movw
operator|%
name|ax
operator|,
literal|0x472
operator|#
name|warm
name|boot
name|movl
name|$0
operator|,
operator|%
name|esp
operator|#
name|segment
name|violation
name|ret
empty|# jump	PA_Monitor		# jump to startup code in ROM
else|#
directive|else
name|movl
name|savearea
operator|,
operator|%
name|esp
name|movl
name|savearea
operator|+
literal|4
operator|,
operator|%
name|ebp
name|ret
endif|#
directive|endif
operator|.
name|globl
name|_setregs
name|_setregs
operator|:
name|movl
name|_howto
operator|,
operator|%
name|esi
name|movl
name|_bootdev
operator|,
operator|%
name|edi
name|movl
name|_unit
operator|,
operator|%
name|ebx
name|ret
operator|.
name|globl
name|_inb
name|_inb
operator|:
name|movl
literal|4
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|edx
name|subl
operator|%
name|eax
operator|,
operator|%
name|eax
operator|#
name|clr
name|eax
name|nop
name|inb
operator|%
name|dx
operator|,
operator|%
name|al
name|nop
name|ret
operator|.
name|globl
name|_outb
name|_outb
operator|:
name|movl
literal|4
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|edx
name|movl
literal|8
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|eax
name|nop
name|outb
operator|%
name|al
operator|,
operator|%
name|dx
name|nop
name|ret
operator|.
name|globl
name|___udivsi3
name|___udivsi3
operator|:
name|movl
literal|4
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|eax
name|xorl
operator|%
name|edx
operator|,
operator|%
name|edx
name|divl
literal|8
operator|(
operator|%
name|esp
operator|)
name|ret
operator|.
name|globl
name|___divsi3
name|___divsi3
operator|:
name|movl
literal|4
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|eax
name|xorl
operator|%
name|edx
operator|,
operator|%
name|edx
name|cltd
name|idivl
literal|8
operator|(
operator|%
name|esp
operator|)
name|ret
empty|#
empty|# bzero (base,cnt)
empty|#
operator|.
name|globl
name|_bzero
name|_bzero
operator|:
name|pushl
operator|%
name|edi
name|movl
literal|8
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|edi
name|movl
literal|12
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|ecx
name|movb
name|$0x00
operator|,
operator|%
name|al
name|cld
name|rep
name|stosb
name|popl
operator|%
name|edi
name|ret
empty|#
empty|# bcopy (src,dst,cnt)
empty|# NOTE: does not (yet) handle overlapped copies
empty|#
operator|.
name|globl
name|_bcopy
name|_bcopy
operator|:
name|pushl
operator|%
name|esi
name|pushl
operator|%
name|edi
name|movl
literal|12
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|esi
name|movl
literal|16
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|edi
name|movl
literal|20
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|ecx
name|cld
name|rep
name|movsb
name|popl
operator|%
name|edi
name|popl
operator|%
name|esi
name|ret
empty|# insw(port,addr,cnt)
operator|.
name|globl
name|_insw
name|_insw
operator|:
name|pushl
operator|%
name|edi
name|movw
literal|8
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|dx
name|movl
literal|12
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|edi
name|movl
literal|16
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|ecx
name|cld
name|nop
operator|.
name|byte
literal|0x66
operator|,
literal|0xf2
operator|,
literal|0x6d
operator|#
name|rep
name|insw
name|nop
name|movl
operator|%
name|edi
operator|,
operator|%
name|eax
name|popl
operator|%
name|edi
name|ret
empty|# outsw(port,addr,cnt)
operator|.
name|globl
name|_outsw
name|_outsw
operator|:
name|pushl
operator|%
name|esi
name|movw
literal|8
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|dx
name|movl
literal|12
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|esi
name|movl
literal|16
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|ecx
name|cld
name|nop
operator|.
name|byte
literal|0x66
operator|,
literal|0xf2
operator|,
literal|0x6f
operator|#
name|rep
name|outsw
name|nop
name|movl
operator|%
name|esi
operator|,
operator|%
name|eax
name|popl
operator|%
name|esi
name|ret
end_return

end_unit


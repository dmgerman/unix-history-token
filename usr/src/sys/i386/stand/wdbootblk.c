begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1990 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz.  *  * %sccs.include.redist.c%  *  *	@(#)wdbootblk.c	7.2 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * wdbootblk.s:  *	Written 7/6/90 by William F. Jolitz  *	Initial block boot for AT/386 with typical Western Digital  *	WD 1002-WA2 (or upwards compatable). Works either as  *	first and sole partition bootstrap, or as loaded by a  *	earlier BIOS boot when on an inner partition of the disk.  *  *	Goal is to read in sucessive 7.5Kbytes of bootstrap to  *	execute.  *  *	No attempt is made to handle disk errors.  */
end_comment

begin_include
include|#
directive|include
file|<i386/isa/isa.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/wdreg.h>
end_include

begin_define
define|#
directive|define
name|NOP
value|jmp 1f ; nop ; 1:
end_define

begin_define
define|#
directive|define
name|BIOSRELOC
value|0x7c00
end_define

begin_define
define|#
directive|define
name|start
value|0x70400
end_define

begin_comment
comment|/* step 0 force descriptors to bottom of address space */
end_comment

begin_expr_stmt
operator|.
name|byte
literal|0xfa
operator|,
literal|0xb8
operator|,
literal|0x30
operator|,
literal|0x00
operator|,
literal|0x8e
operator|,
literal|0xd0
operator|,
literal|0xbc
operator|,
literal|0x00
operator|,
literal|0x01
operator|#
name|ll
name|fb
name|xorl
operator|%
name|eax
operator|,
operator|%
name|eax
name|movl
operator|%
name|ax
operator|,
operator|%
name|ds
name|movl
operator|%
name|ax
operator|,
operator|%
name|es
comment|/* step 1 load new descriptor table */
operator|.
name|byte
literal|0x2E
operator|,
literal|0x0F
operator|,
literal|1
operator|,
literal|0x16
operator|.
name|word
name|BIOSRELOC
operator|+
literal|0x4a
operator|#
name|GDTptr
empty|# word aword cs lgdt GDTptr
comment|/* step 2 turn on protected mode */
name|smsw
operator|%
name|ax
name|orb
name|$1
operator|,
operator|%
name|al
name|lmsw
operator|%
name|ax
name|jmp
literal|1f
name|nop
comment|/* step 3  reload segment descriptors */
literal|1
operator|:
name|xorl
operator|%
name|eax
operator|,
operator|%
name|eax
name|movb
name|$0x10
operator|,
operator|%
name|al
name|movl
operator|%
name|ax
operator|,
operator|%
name|ds
name|movl
operator|%
name|ax
operator|,
operator|%
name|es
name|movl
operator|%
name|ax
operator|,
operator|%
name|ss
name|word
name|ljmp
name|$0x8
operator|,
name|$
name|BIOSRELOC
operator|+
literal|0x50
comment|/* would be nice if .-RELOC+0x7c00 worked */
comment|/* Global Descriptor Table contains three descriptors:   * 0x00: Null: not used   * 0x08: Code: code segment starts at 0 and extents for 4 gigabytes   * 0x10: Data: data segment starts at 0 and extends for 4 gigabytes   *		(overlays code)   */
name|GDT
operator|:
name|NullDesc
operator|:
operator|.
name|word
literal|0
operator|,
literal|0
operator|,
literal|0
operator|,
literal|0
operator|#
name|null
name|descriptor
operator|-
name|not
name|used
name|CodeDesc
operator|:
operator|.
name|word
literal|0xFFFF
operator|#
name|limit
name|at
name|maximum
operator|:
operator|(
name|bits
literal|15
operator|:
literal|0
operator|)
operator|.
name|byte
literal|0
operator|,
literal|0
operator|,
literal|0
operator|#
name|base
name|at
literal|0
operator|:
operator|(
name|bits
literal|23
operator|:
literal|0
operator|)
operator|.
name|byte
literal|0x9f
operator|#
name|present
operator|/
name|priv
name|level
literal|0
operator|/
name|code
operator|/
name|conforming
operator|/
name|readable
operator|.
name|byte
literal|0xcf
operator|#
name|page
name|granular
operator|/
expr|default
literal|32
operator|-
name|bit
operator|/
name|limit
argument_list|(
name|bits
literal|19
operator|:
literal|16
argument_list|)
operator|.
name|byte
literal|0
operator|#
name|base
name|at
literal|0
operator|:
operator|(
name|bits
literal|31
operator|:
literal|24
operator|)
name|DataDesc
operator|:
operator|.
name|word
literal|0xFFFF
operator|#
name|limit
name|at
name|maximum
operator|:
operator|(
name|bits
literal|15
operator|:
literal|0
operator|)
operator|.
name|byte
literal|0
operator|,
literal|0
operator|,
literal|0
operator|#
name|base
name|at
literal|0
operator|:
operator|(
name|bits
literal|23
operator|:
literal|0
operator|)
operator|.
name|byte
literal|0x93
operator|#
name|present
operator|/
name|priv
name|level
literal|0
operator|/
name|data
operator|/
name|expand
operator|-
name|up
operator|/
name|writeable
operator|.
name|byte
literal|0xcf
operator|#
name|page
name|granular
operator|/
expr|default
literal|32
operator|-
name|bit
operator|/
name|limit
argument_list|(
name|bits
literal|19
operator|:
literal|16
argument_list|)
operator|.
name|byte
literal|0
operator|#
name|base
name|at
literal|0
operator|:
operator|(
name|bits
literal|31
operator|:
literal|24
operator|)
comment|/* Global Descriptor Table pointer  *  contains 6-byte pointer information for LGDT  */
name|GDTptr
operator|:
operator|.
name|word
literal|0x17
operator|#
name|limit
name|to
name|three
literal|8
name|byte
name|selectors
argument_list|(
name|null
argument_list|,
name|code
argument_list|,
name|data
argument_list|)
operator|.
name|long
name|BIOSRELOC
operator|+
literal|0x32
operator|#
name|GDT
operator|--
name|arrgh
operator|,
name|gas
name|again
operator|!
comment|/* step 4 relocate to final bootstrap address. */
name|reloc
operator|:
name|movl
name|$
name|BIOSRELOC
operator|,
operator|%
name|esi
name|movl
name|$
name|RELOC
operator|,
operator|%
name|edi
name|movl
name|$512
operator|,
operator|%
name|ecx
name|rep
name|movsb
name|movl
name|$0x60000
operator|,
operator|%
name|esp
name|pushl
name|$dodisk
name|ret
comment|/* step 5 load remaining 15 sectors off disk */
name|dodisk
operator|:
name|movl
name|$
name|IO_WD1
operator|+
name|wd_seccnt
operator|,
operator|%
name|edx
name|movb
name|$
literal|15
operator|,
operator|%
name|al
name|outb
operator|%
name|al
operator|,
operator|%
name|dx
name|NOP
name|movl
name|$
name|IO_WD1
operator|+
name|wd_sector
operator|,
operator|%
name|edx
name|movb
name|$
literal|2
operator|,
operator|%
name|al
name|outb
operator|%
name|al
operator|,
operator|%
name|dx
name|NOP
empty|#outb(wdc+wd_cyl_lo, (cyloffset& 0xff));
empty|#outb(wdc+wd_cyl_hi, (cyloffset>> 8));
empty|#outb(wdc+wd_sdh, WDSD_IBM | (unit<< 4));
name|movl
name|$
name|IO_WD1
operator|+
name|wd_command
operator|,
operator|%
name|edx
name|movb
name|$
name|WDCC_READ
operator|,
operator|%
name|al
name|outb
operator|%
name|al
operator|,
operator|%
name|dx
name|NOP
name|cld
comment|/* check to make sure controller is not busy and we have data ready */
name|readblk
operator|:
name|movl
name|$
name|IO_WD1
operator|+
name|wd_status
operator|,
operator|%
name|edx
name|inb
operator|%
name|dx
operator|,
operator|%
name|al
name|NOP
name|testb
name|$
name|WDCS_BUSY
operator|,
operator|%
name|al
name|jnz
name|readblk
name|testb
name|$
name|WDCS_DRQ
operator|,
operator|%
name|al
name|jz
name|readblk
comment|/* read a block into final position in memory */
name|movl
name|$
name|IO_WD1
operator|+
name|wd_data
operator|,
operator|%
name|edx
name|movl
name|$
literal|256
operator|,
operator|%
name|ecx
operator|.
name|byte
literal|0x66
operator|,
literal|0xf2
operator|,
literal|0x6d
operator|#
name|rep
name|insw
name|NOP
comment|/* need more blocks to be read in? */
name|cmpl
name|$
name|RELOC
operator|+
literal|16
operator|*
literal|512
operator|-
literal|1
operator|,
operator|%
name|edi
name|jl
name|readblk
comment|/* for clever bootstrap, dig out boot unit and cylinder */
name|movl
name|$
name|IO_WD1
operator|+
name|wd_cyl_lo
operator|,
operator|%
name|edx
name|inb
operator|%
name|dx
operator|,
operator|%
name|al
name|NOP
name|xorl
operator|%
name|ecx
operator|,
operator|%
name|ecx
name|movb
operator|%
name|al
operator|,
operator|%
name|cl
name|incl
operator|%
name|edx
name|inb
operator|%
name|dx
operator|,
operator|%
name|al
comment|/* cyl_hi */
name|NOP
name|movb
operator|%
name|al
operator|,
operator|%
name|ch
name|pushl
operator|%
name|ecx
comment|/* cyloffset */
name|incl
operator|%
name|edx
name|xorl
operator|%
name|eax
operator|,
operator|%
name|eax
name|inb
operator|%
name|dx
operator|,
operator|%
name|al
comment|/* sdh */
name|andb
name|$0x10
operator|,
operator|%
name|al
comment|/* isolate unit # bit */
name|shrb
name|$4
operator|,
operator|%
name|al
name|pushl
operator|%
name|eax
comment|/* unit */
comment|/* wd controller is major device 0 */
name|xorl
operator|%
name|eax
operator|,
operator|%
name|eax
name|pushl
operator|%
name|eax
comment|/* bootdev */
comment|/* sorry, no flags at this point! */
name|pushl
name|$
name|start
name|ret
comment|/* main (dev, unit, offset) */
name|ebootblkcode
operator|:
comment|/* remaining space usable for a disk label */
operator|.
name|space
literal|510
operator|-
literal|223
comment|/* would be nice if .space 512-2-. worked */
operator|.
name|word
literal|0xaa55
comment|/* signature -- used by BIOS ROM */
name|ebootblk
operator|:
end_expr_stmt

begin_comment
comment|/* MUST BE EXACTLY 0x200 BIG FOR SURE */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Sony Corp. and Kazumasa Utashiro of Software Research Associates, Inc.  *  * %sccs.include.redist.c%  *  * from: $Hdr: if_lance.c,v 4.300 91/06/09 06:25:58 root Rel41 $ SONY  *  *	@(#)if_lance.c	7.4 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * if_lance: Am7990 LANCE driver  *  * This driver is available only for single CPU machine.  */
end_comment

begin_define
define|#
directive|define
name|LANCE_LED
end_define

begin_include
include|#
directive|include
file|"en.h"
end_include

begin_if
if|#
directive|if
name|NEN
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<machine/adrsmap.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<news3400/if/lancereg.h>
end_include

begin_include
include|#
directive|include
file|<news3400/if/if_lance.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|mips
end_ifdef

begin_define
define|#
directive|define
name|VOLATILE
value|volatile
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|VOLATILE
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|LANCE_LED
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|news3400
end_ifdef

begin_define
define|#
directive|define
name|LED_ON
value|{ \ 	VOLATILE u_char *p = (u_char *)DEBUG_PORT; \ 	*p = DP_WRITE | (*p& ~DP_LED2); \ }
end_define

begin_define
define|#
directive|define
name|LED_OFF
value|{ \ 	VOLATILE u_char *p = (u_char *)DEBUG_PORT; \ 	*p = DP_WRITE | (*p | DP_LED2); \ }
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* news3400 */
end_comment

begin_define
define|#
directive|define
name|LED_ON
end_define

begin_define
define|#
directive|define
name|LED_OFF
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* news3400 */
end_comment

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* LANCE_LED */
end_comment

begin_define
define|#
directive|define
name|LED_ON
end_define

begin_define
define|#
directive|define
name|LED_OFF
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* LANCE_LED */
end_comment

begin_comment
comment|/*  *	LANCE memory configuration  */
end_comment

begin_define
define|#
directive|define
name|INIT_BLOCK
value|0x000000
end_define

begin_define
define|#
directive|define
name|RECV_MSG_DESC
value|0x000100
end_define

begin_define
define|#
directive|define
name|XMIT_MSG_DESC
value|0x000200
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|mips
end_ifdef

begin_define
define|#
directive|define
name|RECV_BUFFER
value|(0x000300 + 2)
end_define

begin_comment
comment|/* for data alignment to long word */
end_comment

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* mips */
end_comment

begin_define
define|#
directive|define
name|RECV_BUFFER
value|0x000300
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* mips */
end_comment

begin_define
define|#
directive|define
name|XMIT_BUFFER
value|(RECV_BUFFER+(RECV_BUFFER_SIZE*RECV_BUFFERS))
end_define

begin_define
define|#
directive|define
name|RECV_RING_LEN
value|3
end_define

begin_comment
comment|/* log2(8) */
end_comment

begin_define
define|#
directive|define
name|XMIT_RING_LEN
value|1
end_define

begin_comment
comment|/* log2(2) */
end_comment

begin_define
define|#
directive|define
name|RECV_BUFFER_SIZE
value|0x600
end_define

begin_define
define|#
directive|define
name|XMIT_BUFFER_SIZE
value|0x600
end_define

begin_define
define|#
directive|define
name|RECV_BUFFERS
value|(1<< RECV_RING_LEN)
end_define

begin_define
define|#
directive|define
name|XMIT_BUFFERS
value|(1<< XMIT_RING_LEN)
end_define

begin_comment
comment|/*  *	Initialization block  */
end_comment

begin_decl_stmt
name|struct
name|init_block
name|init_block
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|RECV_MSG_DESC
operator|&
literal|0xffff
block|,
operator|(
name|RECV_RING_LEN
operator|<<
literal|13
operator|)
operator||
operator|(
name|RECV_MSG_DESC
operator|>>
literal|16
operator|)
block|,
name|XMIT_MSG_DESC
operator|&
literal|0xffff
block|,
operator|(
name|XMIT_RING_LEN
operator|<<
literal|13
operator|)
operator||
operator|(
name|XMIT_MSG_DESC
operator|>>
literal|16
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *	LANCE control block  */
end_comment

begin_decl_stmt
name|Lance_chan
name|lancesw
index|[
name|NEN
index|]
init|=
block|{
block|{
operator|(
name|Lance_reg
operator|*
operator|)
name|LANCE_PORT
block|,
operator|(
name|caddr_t
operator|)
name|LANCE_MEMORY
block|,
operator|(
name|caddr_t
operator|)
name|ETHER_ID
block|}
block|,
if|#
directive|if
name|NEN
operator|>
literal|1
block|{
operator|(
name|Lance_reg
operator|*
operator|)
name|LANCE_PORT1
block|,
operator|(
name|caddr_t
operator|)
name|LANCE_MEMORY1
block|,
operator|(
name|caddr_t
operator|)
name|ETHER_ID1
block|}
block|,
endif|#
directive|endif
if|#
directive|if
name|NEN
operator|>
literal|2
block|{
operator|(
name|Lance_reg
operator|*
operator|)
name|LANCE_PORT2
block|,
operator|(
name|caddr_t
operator|)
name|LANCE_MEMORY2
block|,
operator|(
name|caddr_t
operator|)
name|ETHER_ID2
block|}
block|,
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|lance_probe
argument_list|(
argument|chan
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
name|VOLATILE
name|int
modifier|*
name|p
init|=
operator|(
name|VOLATILE
name|int
operator|*
operator|)
name|lance
operator|->
name|lance_memory
decl_stmt|;
if|if
condition|(
name|badaddr
argument_list|(
name|lance
operator|->
name|lance_addr
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|*
name|p
operator|=
literal|0x12345678
expr_stmt|;
return|return
operator|(
operator|*
name|p
operator|==
literal|0x12345678
operator|)
return|;
block|}
end_block

begin_macro
name|lance_open
argument_list|(
argument|chan
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
specifier|register
name|recv_msg_desc
modifier|*
name|rmd
decl_stmt|;
specifier|register
name|xmit_msg_desc
modifier|*
name|tmd
decl_stmt|;
specifier|register
name|struct
name|init_block
modifier|*
name|ib
decl_stmt|;
specifier|register
name|int
name|buffer
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|lance
operator|->
name|lance_flags
operator|&
name|LANCE_ACTIVE
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|lance
operator|->
name|lance_addr
operator|==
operator|(
name|Lance_reg
operator|*
operator|)
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|lance_write_reg
argument_list|(
name|chan
argument_list|,
name|CSR0
argument_list|,
name|CSR_STOP
argument_list|)
expr_stmt|;
name|rmd
operator|=
operator|(
name|recv_msg_desc
operator|*
operator|)
operator|(
name|RECV_MSG_DESC
operator|+
name|lance
operator|->
name|lance_memory
operator|)
expr_stmt|;
name|lance
operator|->
name|lance_last_rmd
operator|=
operator|(
name|lance
operator|->
name|lance_rmd
operator|=
name|rmd
operator|)
operator|+
name|RECV_BUFFERS
operator|-
literal|1
expr_stmt|;
name|buffer
operator|=
name|RECV_BUFFER
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RECV_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|rmd
operator|->
name|rmd_ladr
operator|=
name|buffer
operator|&
literal|0xffff
expr_stmt|;
name|rmd
operator|->
name|rmd_stat
operator|=
name|RMD_OWN
operator||
operator|(
name|buffer
operator|>>
literal|16
operator|)
expr_stmt|;
name|rmd
operator|->
name|rmd_bcnt
operator|=
operator|-
name|RECV_BUFFER_SIZE
expr_stmt|;
name|rmd
operator|->
name|rmd_mcnt
operator|=
literal|0
expr_stmt|;
name|rmd
operator|++
expr_stmt|;
name|buffer
operator|+=
name|RECV_BUFFER_SIZE
expr_stmt|;
block|}
name|tmd
operator|=
operator|(
name|xmit_msg_desc
operator|*
operator|)
operator|(
name|XMIT_MSG_DESC
operator|+
name|lance
operator|->
name|lance_memory
operator|)
expr_stmt|;
name|lance
operator|->
name|lance_last_tmd
operator|=
operator|(
name|lance
operator|->
name|lance_tmd
operator|=
name|tmd
operator|)
operator|+
name|XMIT_BUFFERS
operator|-
literal|1
expr_stmt|;
name|buffer
operator|=
name|XMIT_BUFFER
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XMIT_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|tmd
operator|->
name|tmd_ladr
operator|=
name|buffer
operator|&
literal|0xffff
expr_stmt|;
name|tmd
operator|->
name|tmd_stat
operator|=
name|buffer
operator|>>
literal|16
expr_stmt|;
name|tmd
operator|->
name|tmd_bcnt
operator|=
literal|0
expr_stmt|;
name|tmd
operator|++
expr_stmt|;
name|buffer
operator|+=
name|XMIT_BUFFER_SIZE
expr_stmt|;
block|}
name|get_hard_addr
argument_list|(
name|chan
argument_list|,
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
argument_list|)
expr_stmt|;
name|ib
operator|=
operator|(
expr|struct
name|init_block
operator|*
operator|)
operator|(
name|INIT_BLOCK
operator|+
name|lance
operator|->
name|lance_memory
operator|)
expr_stmt|;
name|lance
operator|->
name|lance_ib
operator|=
name|ib
expr_stmt|;
operator|*
name|ib
operator|=
name|init_block
expr_stmt|;
name|ib
operator|->
name|ib_padr
index|[
literal|0
index|]
operator|=
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
index|[
literal|1
index|]
expr_stmt|;
name|ib
operator|->
name|ib_padr
index|[
literal|1
index|]
operator|=
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
index|[
literal|0
index|]
expr_stmt|;
name|ib
operator|->
name|ib_padr
index|[
literal|2
index|]
operator|=
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
index|[
literal|3
index|]
expr_stmt|;
name|ib
operator|->
name|ib_padr
index|[
literal|3
index|]
operator|=
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
index|[
literal|2
index|]
expr_stmt|;
name|ib
operator|->
name|ib_padr
index|[
literal|4
index|]
operator|=
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
index|[
literal|5
index|]
expr_stmt|;
name|ib
operator|->
name|ib_padr
index|[
literal|5
index|]
operator|=
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
index|[
literal|4
index|]
expr_stmt|;
if|if
condition|(
name|lance
operator|->
name|lance_flags
operator|&
name|LANCE_PROM
condition|)
name|ib
operator|->
name|ib_mode
operator||=
name|IB_PROM
expr_stmt|;
name|lance
operator|->
name|lance_flags
operator||=
name|LANCE_ACTIVE
expr_stmt|;
name|lance_init
argument_list|(
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|lance_read_reg
argument_list|(
name|chan
argument_list|,
name|CSR0
argument_list|)
operator|!=
operator|(
name|CSR_INEA
operator||
name|CSR_RXON
operator||
name|CSR_TXON
operator||
name|CSR_STRT
operator||
name|CSR_INIT
operator|)
condition|)
block|{
name|lance
operator|->
name|lance_flags
operator|&=
operator|~
name|LANCE_ACTIVE
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|lance_close
argument_list|(
argument|chan
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
name|lance_write_reg
argument_list|(
name|chan
argument_list|,
name|CSR0
argument_list|,
name|CSR_STOP
argument_list|)
expr_stmt|;
name|lance
operator|->
name|lance_flags
operator|&=
operator|~
name|LANCE_ACTIVE
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|RECEIVE
parameter_list|(
name|lance
parameter_list|,
name|rmd
parameter_list|)
value|{ \ 	register int i; \ 	(rmd) = (lance)->lance_last_rmd + 1; \ 	if ((rmd)>= (lance)->lance_rmd + RECV_BUFFERS) \ 		(rmd) = (lance)->lance_rmd; \ 	if (((rmd)->rmd_stat& RMD_OWN) == 0) \ 		(lance)->lance_last_rmd = (rmd); \ 	else \ 		(rmd) = NULL; \ }
end_define

begin_define
define|#
directive|define
name|RECV_BUF
parameter_list|(
name|lance
parameter_list|,
name|rmd
parameter_list|)
value|(char *)((rmd)->rmd_ladr \ 					+ (((rmd)->rmd_stat& RMD_HADR)<< 16) \ 					+ (lance)->lance_memory)
end_define

begin_define
define|#
directive|define
name|RECV_CNT
parameter_list|(
name|rmd
parameter_list|)
value|((rmd)->rmd_mcnt - 4)
end_define

begin_define
define|#
directive|define
name|RECV_ERR
parameter_list|(
name|rmd
parameter_list|)
value|((rmd)->rmd_stat& RMD_ERR)
end_define

begin_define
define|#
directive|define
name|RELEASE_RECV_BUF
parameter_list|(
name|rmd
parameter_list|)
value|{ \ 	(rmd)->rmd_mcnt = 0; \ 	(rmd)->rmd_stat = ((rmd)->rmd_stat& RMD_HADR) | RMD_OWN; \ }
end_define

begin_function
name|caddr_t
name|get_recv_buffer
parameter_list|(
name|chan
parameter_list|)
name|int
name|chan
decl_stmt|;
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
specifier|register
name|recv_msg_desc
modifier|*
name|rmd
decl_stmt|;
name|next
label|:
name|RECEIVE
argument_list|(
name|lance
argument_list|,
name|rmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rmd
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|RECV_ERR
argument_list|(
name|rmd
argument_list|)
condition|)
block|{
name|recv_error
argument_list|(
name|lance
argument_list|,
name|rmd
argument_list|)
expr_stmt|;
name|RELEASE_RECV_BUF
argument_list|(
name|rmd
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
return|return
operator|(
name|RECV_BUF
argument_list|(
name|lance
argument_list|,
name|rmd
argument_list|)
operator|)
return|;
block|}
end_function

begin_macro
name|get_recv_length
argument_list|(
argument|chan
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|RECV_CNT
argument_list|(
name|lancesw
index|[
name|chan
index|]
operator|.
name|lance_last_rmd
argument_list|)
operator|)
return|;
block|}
end_block

begin_macro
name|free_recv_buffer
argument_list|(
argument|chan
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|recv_msg_desc
modifier|*
name|rmd
init|=
name|lancesw
index|[
name|chan
index|]
operator|.
name|lance_last_rmd
decl_stmt|;
name|RELEASE_RECV_BUF
argument_list|(
name|rmd
argument_list|)
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|GET_XMIT_BUF
parameter_list|(
name|lance
parameter_list|,
name|tmd
parameter_list|)
value|{ \ 	(tmd) = (lance)->lance_last_tmd + 1; \ 	if ((tmd)>= (lance)->lance_tmd + XMIT_BUFFERS) \ 		(tmd) = (lance)->lance_tmd; \ 	if ((tmd)->tmd_stat& TMD_OWN) \ 		(tmd) = NULL; \ 	else \ 		(lance)->lance_last_tmd = (tmd); \ }
end_define

begin_define
define|#
directive|define
name|XMIT_BUF
parameter_list|(
name|lance
parameter_list|,
name|tmd
parameter_list|)
value|(char *)((tmd)->tmd_ladr \ 					+ (((tmd)->tmd_stat& TMD_HADR)<< 16) \ 					+ (lance)->lance_memory)
end_define

begin_define
define|#
directive|define
name|XMIT_ERR
parameter_list|(
name|tmd
parameter_list|)
value|((tmd)->tmd_stat& TMD_ERR)
end_define

begin_define
define|#
directive|define
name|TRANSMIT
parameter_list|(
name|lance
parameter_list|,
name|tmd
parameter_list|,
name|count
parameter_list|)
value|{ \ 	(tmd)->tmd_bcnt = -(count); \ 	(tmd)->tmd_error = 0; \ 	(tmd)->tmd_stat = ((tmd)->tmd_stat& TMD_HADR) | (TMD_OWN|TMD_STP|TMD_ENP); \ 	(lance)->lance_addr->rap = CSR0; \ 	(lance)->lance_addr->rdp = (CSR_INEA|CSR_TDMD); \ }
end_define

begin_function
name|caddr_t
name|get_xmit_buffer
parameter_list|(
name|chan
parameter_list|)
name|int
name|chan
decl_stmt|;
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
specifier|register
name|xmit_msg_desc
modifier|*
name|tmd
decl_stmt|;
name|GET_XMIT_BUF
argument_list|(
name|lance
argument_list|,
name|tmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmd
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|XMIT_BUF
argument_list|(
name|lance
argument_list|,
name|tmd
argument_list|)
operator|)
return|;
block|}
end_function

begin_macro
name|lance_transmit
argument_list|(
argument|chan
argument_list|,
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
specifier|register
name|xmit_msg_desc
modifier|*
name|tmd
decl_stmt|;
name|tmd
operator|=
name|lance
operator|->
name|lance_last_tmd
expr_stmt|;
name|TRANSMIT
argument_list|(
name|lance
argument_list|,
name|tmd
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|lance_xmit_error
argument_list|(
argument|chan
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
specifier|register
name|xmit_msg_desc
modifier|*
name|tmd
decl_stmt|;
name|tmd
operator|=
name|lance
operator|->
name|lance_last_tmd
expr_stmt|;
if|if
condition|(
name|XMIT_ERR
argument_list|(
name|tmd
argument_list|)
condition|)
block|{
name|xmit_error
argument_list|(
name|lance
argument_list|,
name|tmd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|lance_collision
argument_list|(
argument|chan
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
if|if
condition|(
name|lance
operator|->
name|lance_last_tmd
operator|->
name|tmd_stat
operator|&
operator|(
name|TMD_MORE
operator||
name|TMD_ONE
operator|)
condition|)
block|{
name|lance
operator|->
name|lance_stats
operator|.
name|ens_collis
operator|++
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|lance_get_addr
argument_list|(
argument|chan
argument_list|,
argument|addr
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
name|bcopy
argument_list|(
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
argument_list|,
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|lance_prom_mode
argument_list|(
argument|chan
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
name|lance_close
argument_list|(
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
condition|)
name|lance
operator|->
name|lance_flags
operator||=
name|LANCE_PROM
expr_stmt|;
else|else
name|lance
operator|->
name|lance_flags
operator|&=
operator|~
name|LANCE_PROM
expr_stmt|;
name|lance_open
argument_list|(
name|chan
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|lance_get_status
argument_list|(
argument|chan
argument_list|,
argument|addr
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
specifier|register
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|lance
operator|->
name|lance_stats
operator|.
name|ens_frames
argument_list|,
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|lance
operator|->
name|lance_stats
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|lance
operator|->
name|lance_stats
operator|.
name|ens_frames
argument_list|,
sizeof|sizeof
argument_list|(
name|lance
operator|->
name|lance_stats
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|lance
operator|->
name|lance_stats
operator|.
name|ens_addr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|lance_intr
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
decl_stmt|;
specifier|register
name|Lance_reg
modifier|*
name|reg
decl_stmt|;
specifier|register
name|int
name|stat
decl_stmt|,
name|chan
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|;
name|LED_ON
expr_stmt|;
for|for
control|(
name|chan
operator|=
literal|0
operator|,
name|lance
operator|=
name|lancesw
init|;
name|chan
operator|<
name|NEN
condition|;
name|lance
operator|++
operator|,
name|chan
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|lance
operator|->
name|lance_flags
operator|&
name|LANCE_ACTIVE
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|reg
operator|=
name|lance
operator|->
name|lance_addr
expr_stmt|;
name|reg
operator|->
name|rap
operator|=
name|CSR0
expr_stmt|;
name|stat
operator|=
name|reg
operator|->
name|rdp
operator|&
operator|~
name|CSR_INEA
expr_stmt|;
if|if
condition|(
operator|(
name|stat
operator|&
name|CSR_INTR
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|retval
operator|=
literal|1
expr_stmt|;
name|reg
operator|->
name|rdp
operator|=
name|stat
expr_stmt|;
name|reg
operator|->
name|rdp
operator|=
name|CSR_INEA
expr_stmt|;
if|if
condition|(
name|stat
operator|&
name|CSR_ERR
condition|)
block|{
if|if
condition|(
name|stat
operator|&
name|CSR_BABL
condition|)
name|printf
argument_list|(
literal|"lance %d error: babl\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
operator|&
name|CSR_MISS
condition|)
name|lance
operator|->
name|lance_stats
operator|.
name|ens_lost
operator|++
expr_stmt|;
if|if
condition|(
name|stat
operator|&
name|CSR_MERR
condition|)
name|printf
argument_list|(
literal|"lance %d error: merr\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|stat
operator|&
name|CSR_RINT
condition|)
block|{
name|lance
operator|->
name|lance_stats
operator|.
name|ens_frames
operator|++
expr_stmt|;
name|enrint
argument_list|(
name|chan
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|stat
operator|&
name|CSR_TINT
condition|)
block|{
name|lance
operator|->
name|lance_stats
operator|.
name|ens_xmit
operator|++
expr_stmt|;
name|enxint
argument_list|(
name|chan
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|stat
operator|&
name|CSR_IDON
condition|)
name|lance
operator|->
name|lance_flags
operator||=
name|LANCE_IDON
expr_stmt|;
block|}
name|LED_OFF
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_block

begin_macro
name|lance_init
argument_list|(
argument|chan
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
specifier|register
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|lance_write_reg
argument_list|(
name|chan
argument_list|,
name|CSR1
argument_list|,
name|INIT_BLOCK
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|lance_write_reg
argument_list|(
name|chan
argument_list|,
name|CSR2
argument_list|,
name|INIT_BLOCK
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|lance_write_reg
argument_list|(
name|chan
argument_list|,
name|CSR3
argument_list|,
name|CSR_BSWP
operator||
name|CSR_BCON
argument_list|)
expr_stmt|;
name|lance_write_reg
argument_list|(
name|chan
argument_list|,
name|CSR0
argument_list|,
name|CSR_INEA
operator||
name|CSR_STRT
operator||
name|CSR_INIT
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|lance
operator|->
name|lance_flags
operator|&
name|LANCE_IDON
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
block|}
end_block

begin_expr_stmt
name|recv_error
argument_list|(
name|lance
argument_list|,
name|rmd
argument_list|)
specifier|register
name|Lance_chan
operator|*
name|lance
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|recv_msg_desc
modifier|*
name|rmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|status
init|=
name|rmd
operator|->
name|rmd_stat
decl_stmt|;
specifier|register
name|int
name|chan
init|=
name|lance
operator|-
name|lancesw
decl_stmt|;
if|if
condition|(
name|status
operator|&
name|RMD_FRAM
condition|)
name|lance
operator|->
name|lance_stats
operator|.
name|ens_align
operator|++
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RMD_OFLO
condition|)
name|printf
argument_list|(
literal|"lance %d recv error: overflow\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RMD_CRC
condition|)
name|lance
operator|->
name|lance_stats
operator|.
name|ens_crc
operator|++
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RMD_BUFF
condition|)
name|printf
argument_list|(
literal|"lance %d:recv error: buffer\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|xmit_error
argument_list|(
name|lance
argument_list|,
name|tmd
argument_list|)
specifier|register
name|Lance_chan
operator|*
name|lance
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|xmit_msg_desc
modifier|*
name|tmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|status
init|=
name|tmd
operator|->
name|tmd_error
decl_stmt|;
specifier|register
name|int
name|chan
init|=
name|lance
operator|-
name|lancesw
decl_stmt|;
if|if
condition|(
name|status
operator|&
name|TMD_BUFF
condition|)
name|printf
argument_list|(
literal|"lance %d: xmit error: buffer\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|TMD_UFLO
condition|)
name|printf
argument_list|(
literal|"lance %d: xmit error: underflow\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|TMD_LCOL
condition|)
block|{
name|printf
argument_list|(
literal|"lance %d: xmit error: late collision\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|lance
operator|->
name|lance_stats
operator|.
name|ens_owcollis
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|TMD_LCAR
condition|)
name|printf
argument_list|(
literal|"lance %d: xmit error: loss of carrier\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|TMD_RTRY
condition|)
block|{
name|printf
argument_list|(
literal|"lance %d: xmit error: retry tdr=%d\n"
argument_list|,
name|chan
argument_list|,
name|status
operator|&
name|TMD_TDR
argument_list|)
expr_stmt|;
name|lance
operator|->
name|lance_stats
operator|.
name|ens_xcollis
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|lance_write_reg
argument_list|(
argument|chan
argument_list|,
argument|reg
argument_list|,
argument|data
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|,
name|reg
decl_stmt|,
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_reg
modifier|*
name|lance
init|=
name|lancesw
index|[
name|chan
index|]
operator|.
name|lance_addr
decl_stmt|;
specifier|register
name|int
name|s
decl_stmt|;
name|s
operator|=
name|spl7
argument_list|()
expr_stmt|;
name|lance
operator|->
name|rap
operator|=
name|reg
expr_stmt|;
name|lance
operator|->
name|rdp
operator|=
name|data
expr_stmt|;
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|lance_read_reg
argument_list|(
argument|chan
argument_list|,
argument|reg
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|,
name|reg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Lance_reg
modifier|*
name|lance
init|=
name|lancesw
index|[
name|chan
index|]
operator|.
name|lance_addr
decl_stmt|;
specifier|register
name|int
name|s
decl_stmt|,
name|d
decl_stmt|;
name|s
operator|=
name|spl7
argument_list|()
expr_stmt|;
name|lance
operator|->
name|rap
operator|=
name|reg
expr_stmt|;
name|d
operator|=
name|lance
operator|->
name|rdp
expr_stmt|;
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|d
operator|)
return|;
block|}
end_block

begin_macro
name|get_hard_addr
argument_list|(
argument|chan
argument_list|,
argument|addr
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_short
modifier|*
name|addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|unsigned
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|Lance_chan
modifier|*
name|lance
init|=
operator|&
name|lancesw
index|[
name|chan
index|]
decl_stmt|;
name|unsigned
name|char
name|hard_addr
index|[
literal|6
index|]
decl_stmt|;
name|p
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|lance
operator|->
name|lance_rom
operator|+
literal|16
expr_stmt|;
name|q
operator|=
name|hard_addr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|q
operator|=
operator|(
operator|*
name|p
operator|++
operator|&
literal|0xf
operator|)
operator|<<
literal|4
expr_stmt|;
operator|*
name|q
operator|++
operator||=
operator|*
name|p
operator|++
operator|&
literal|0xf
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|hard_addr
argument_list|,
operator|(
name|char
operator|*
operator|)
name|addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
end_block

begin_if
if|#
directive|if
name|defined
argument_list|(
name|mips
argument_list|)
operator|&&
name|defined
argument_list|(
name|CPU_SINGLE
argument_list|)
end_if

begin_macro
name|bxcopy
argument_list|(
argument|s
argument_list|,
argument|d
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|caddr_t
name|s
decl_stmt|,
name|d
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|n
operator|<=
literal|0
condition|)
return|return;
switch|switch
condition|(
operator|(
operator|(
operator|(
name|int
operator|)
name|s
operator|&
literal|03
operator|)
operator|<<
literal|2
operator|)
operator|+
operator|(
operator|(
name|int
operator|)
name|d
operator|&
literal|03
operator|)
condition|)
block|{
case|case
literal|0x0
case|:
name|blcopy
argument_list|(
operator|(
name|long
operator|*
operator|)
name|s
argument_list|,
operator|(
name|long
operator|*
operator|)
name|d
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return;
case|case
literal|0x5
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
name|blcopy
argument_list|(
operator|(
name|long
operator|*
operator|)
operator|(
name|s
operator|+
literal|1
operator|)
argument_list|,
operator|(
name|long
operator|*
operator|)
operator|(
name|d
operator|+
literal|1
operator|)
argument_list|,
name|n
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
case|case
literal|0xa
case|:
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|1
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
return|return;
case|case
literal|2
case|:
operator|*
operator|(
name|short
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
name|s
expr_stmt|;
return|return;
default|default:
operator|*
operator|(
name|short
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
name|s
expr_stmt|;
name|blcopy
argument_list|(
operator|(
name|long
operator|*
operator|)
operator|(
name|s
operator|+
literal|2
operator|)
argument_list|,
operator|(
name|long
operator|*
operator|)
operator|(
name|d
operator|+
literal|2
operator|)
argument_list|,
name|n
operator|-
literal|2
argument_list|)
expr_stmt|;
return|return;
block|}
case|case
literal|0xf
case|:
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|1
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
return|return;
case|case
literal|2
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|d
operator|+
literal|1
operator|)
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|s
operator|+
literal|1
operator|)
expr_stmt|;
return|return;
case|case
literal|3
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
operator|*
operator|(
name|short
operator|*
operator|)
operator|(
name|d
operator|+
literal|1
operator|)
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
operator|(
name|s
operator|+
literal|1
operator|)
expr_stmt|;
return|return;
default|default:
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
operator|*
operator|(
name|short
operator|*
operator|)
operator|(
name|d
operator|+
literal|1
operator|)
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
operator|(
name|s
operator|+
literal|1
operator|)
expr_stmt|;
name|blcopy
argument_list|(
operator|(
name|long
operator|*
operator|)
operator|(
name|s
operator|+
literal|3
operator|)
argument_list|,
operator|(
name|long
operator|*
operator|)
operator|(
name|d
operator|+
literal|3
operator|)
argument_list|,
name|n
operator|-
literal|3
argument_list|)
expr_stmt|;
return|return;
block|}
case|case
literal|0x7
case|:
case|case
literal|0xd
case|:
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|1
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
return|return;
case|case
literal|2
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|d
operator|+
literal|1
operator|)
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|s
operator|+
literal|1
operator|)
expr_stmt|;
return|return;
default|default:
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
name|bwcopy
argument_list|(
operator|(
name|short
operator|*
operator|)
operator|(
name|s
operator|+
literal|1
operator|)
argument_list|,
operator|(
name|short
operator|*
operator|)
operator|(
name|d
operator|+
literal|1
operator|)
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return;
block|}
case|case
literal|0x2
case|:
case|case
literal|0x8
case|:
name|bwcopy
argument_list|(
operator|(
name|short
operator|*
operator|)
name|s
argument_list|,
operator|(
name|short
operator|*
operator|)
name|d
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return;
default|default:
name|bbcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
name|d
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_block

begin_define
define|#
directive|define
name|COPY
parameter_list|(
name|s
parameter_list|,
name|d
parameter_list|,
name|n
parameter_list|,
name|t
parameter_list|)
define|\
value|while ((n)>= 8 * sizeof (t)) { \ 		int t0, t1, t2, t3, t4, t5, t6, t7; \ 		t0 = (s)[0]; \ 		t1 = (s)[1]; \ 		t2 = (s)[2]; \ 		t3 = (s)[3]; \ 		t4 = (s)[4]; \ 		t5 = (s)[5]; \ 		t6 = (s)[6]; \ 		t7 = (s)[7]; \ 		(d)[0] = t0; \ 		(d)[1] = t1; \ 		(d)[2] = t2; \ 		(d)[3] = t3; \ 		(d)[4] = t4; \ 		(d)[5] = t5; \ 		(d)[6] = t6; \ 		(d)[7] = t7; \ 		(s) += 8; \ 		(d) += 8; \ 		(n) -= 8 * sizeof (t); \ 	} \ 	while ((n)>= sizeof (t)) { \ 		(d)[0] = (s)[0]; \ 		(s)++; \ 		(d)++; \ 		(n) -= sizeof (t); \ 	}
end_define

begin_macro
name|blcopy
argument_list|(
argument|s
argument_list|,
argument|d
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|long
modifier|*
name|s
decl_stmt|,
modifier|*
name|d
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|COPY
argument_list|(
name|s
argument_list|,
name|d
argument_list|,
name|n
argument_list|,
name|long
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|0
case|:
return|return;
case|case
literal|1
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
return|return;
case|case
literal|2
case|:
operator|*
operator|(
name|short
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
name|s
expr_stmt|;
return|return;
case|case
literal|3
case|:
operator|*
operator|(
name|short
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
name|s
expr_stmt|;
operator|*
operator|(
operator|(
name|char
operator|*
operator|)
name|d
operator|+
literal|2
operator|)
operator|=
operator|*
operator|(
operator|(
name|char
operator|*
operator|)
name|s
operator|+
literal|2
operator|)
expr_stmt|;
return|return;
block|}
block|}
end_block

begin_macro
name|bwcopy
argument_list|(
argument|s
argument_list|,
argument|d
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|short
modifier|*
name|s
decl_stmt|,
modifier|*
name|d
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|COPY
argument_list|(
name|s
argument_list|,
name|d
argument_list|,
name|n
argument_list|,
name|short
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|1
condition|)
operator|*
operator|(
name|char
operator|*
operator|)
name|d
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|s
expr_stmt|;
block|}
end_block

begin_macro
name|bbcopy
argument_list|(
argument|s
argument_list|,
argument|d
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|d
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|COPY
argument_list|(
name|s
argument_list|,
name|d
argument_list|,
name|n
argument_list|,
name|char
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(mips)&& defined(CPU_SINGLE) */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NEN> 0 */
end_comment

end_unit


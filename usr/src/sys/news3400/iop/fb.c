begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, 1993  *	The Regents of the University of California.  All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Sony Corp. and Kazumasa Utashiro of Software Research Associates, Inc.  *  * %sccs.include.redist.c%  *  * from: $Hdr: fb.c,v 4.300 91/06/27 20:43:06 root Rel41 $ SONY  *  *	@(#)fb.c	8.1 (Berkeley) %G%  */
end_comment

begin_include
include|#
directive|include
file|"fb.h"
end_include

begin_if
if|#
directive|if
name|NFB
operator|>
literal|0
end_if

begin_comment
comment|/*  * Frame buffer driver  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<machine/pte.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/map.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iop/framebuf.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iop/fbreg.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iodev/ioptohb.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_include
include|#
directive|include
file|<news3400/hbdev/hbvar.h>
end_include

begin_define
define|#
directive|define
name|ipc_phys
parameter_list|(
name|x
parameter_list|)
value|(caddr_t)((int)(x))
end_define

begin_define
define|#
directive|define
name|ipc_log
parameter_list|(
name|x
parameter_list|)
value|(caddr_t)((int)(x) | 0x80000000)
end_define

begin_define
define|#
directive|define
name|iop_driver
value|hb_driver
end_define

begin_define
define|#
directive|define
name|iop_device
value|hb_device
end_define

begin_extern
extern|extern rop_xint(
end_extern

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CPU_SINGLE */
end_comment

begin_include
include|#
directive|include
file|<news3400/iop/iopvar.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_include
include|#
directive|include
file|"../ipc/newsipc.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|mips
end_ifdef

begin_define
define|#
directive|define
name|ipc_phys
parameter_list|(
name|x
parameter_list|)
value|K0_TT0(x)
end_define

begin_define
define|#
directive|define
name|ipc_log
parameter_list|(
name|x
parameter_list|)
value|TT0_K0(x)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|ipc_phys
parameter_list|(
name|x
parameter_list|)
value|(caddr_t)((int)(x)& ~0x80000000)
end_define

begin_define
define|#
directive|define
name|ipc_log
parameter_list|(
name|x
parameter_list|)
value|(caddr_t)((int)(x) | 0x80000000)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|port_fb
decl_stmt|,
name|port_fb_iop
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IPC_MRX */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CPU_SINGLE */
end_comment

begin_define
define|#
directive|define
name|FB_USED
value|1
end_define

begin_define
define|#
directive|define
name|VIDEO_USED
value|2
end_define

begin_comment
comment|/*  * driver definition  */
end_comment

begin_decl_stmt
name|int
name|fbprobe
argument_list|()
decl_stmt|,
name|fbattach
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|iop_device
modifier|*
name|fbinfo
index|[
name|NFB
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|iop_driver
name|fbdriver
init|=
ifdef|#
directive|ifdef
name|CPU_SINGLE
block|{
name|fbprobe
block|,
literal|0
block|,
name|fbattach
block|,
literal|0
block|,
literal|0
block|,
literal|"fb"
block|,
name|fbinfo
block|,
literal|"fbc"
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_block
block|{
name|fbprobe
operator|,
literal|0
operator|,
name|fbattach
operator|,
literal|0
operator|,
literal|"fb"
operator|,
name|fbinfo
block|}
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* static */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|fb_softc
name|fb_softc
index|[
name|NFB
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|fbreg
name|fbreg
index|[
name|NFB
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|fbstate
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|fbreg
modifier|*
name|last_fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|devname
index|[]
init|=
block|{
comment|/* 0*/
literal|""
block|,
comment|/* 1*/
literal|"NWB-512"
block|,
comment|/* 2*/
literal|"NWB-225"
block|,
comment|/* 3*/
literal|"POP-MONO"
block|,
comment|/* 4*/
literal|"POP-COLOR"
block|,
comment|/* 5*/
literal|"NWB-514"
block|,
comment|/* 6*/
literal|"NWB-251"
block|,
comment|/* 7*/
literal|"LCD-MONO"
block|,
comment|/* 8*/
literal|"LDC-COLOR"
block|,
comment|/* 9*/
literal|"NWB-518"
block|,
comment|/*10*/
literal|"NWB-252"
block|,
comment|/*11*/
literal|"NWB-253"
block|,
comment|/*12*/
literal|"NWB-254"
block|,
comment|/*13*/
literal|"NWB-255"
block|,
comment|/*14*/
literal|"SLB-101"
block|,
comment|/*15*/
literal|"NWB-256"
block|,
comment|/*16*/
literal|"NWB-257"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fblock
argument_list|()
decl_stmt|,
name|fbunlock
argument_list|()
decl_stmt|,
name|fbreset
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|fbinit
parameter_list|()
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_DOUBLE
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|USE_RAW_INTR
end_ifdef

begin_include
include|#
directive|include
file|"../mrx/h/ipc.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|mips
end_ifdef

begin_define
define|#
directive|define
name|FB_ADDR
value|&IPC_ARG(&ipc_block, ARG_CPU, 4)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|FB_ADDR
value|&IPC_ARG(&ipc_block, ARG_CPU0, 4)
end_define

begin_define
define|#
directive|define
name|volatile
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
name|struct
name|fbreg
modifier|*
name|fbregp
typedef|;
end_typedef

begin_decl_stmt
name|int
name|fb_waiting
decl_stmt|;
end_decl_stmt

begin_macro
name|Xfb_intr
argument_list|(
argument|chan
argument_list|,
argument|arg
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|arg
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|intrcnt
index|[
name|INTR_BITMAP
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|fb_waiting
condition|)
block|{
name|fb_waiting
operator|=
literal|0
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|fb_waiting
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
specifier|static
name|void
name|fbwait
parameter_list|()
block|{
name|int
name|s
init|=
name|splfb
argument_list|()
decl_stmt|;
while|while
condition|(
operator|*
operator|(
specifier|volatile
name|fbregp
operator|*
operator|)
name|FB_ADDR
condition|)
block|{
name|fb_waiting
operator|=
literal|1
expr_stmt|;
name|sleep
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|fb_waiting
argument_list|,
name|FBPRI
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fbstart
parameter_list|(
name|fbp
parameter_list|,
name|wait
parameter_list|)
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
name|int
name|wait
decl_stmt|;
block|{
name|fbwait
argument_list|()
expr_stmt|;
operator|*
operator|(
specifier|volatile
name|fbregp
operator|*
operator|)
name|FB_ADDR
operator|=
ifdef|#
directive|ifdef
name|mips
operator|(
specifier|volatile
name|fbregp
operator|)
name|ipc_phys
argument_list|(
name|MACH_UNCACHED_TO_CACHED
argument_list|(
name|fbp
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
operator|(
specifier|volatile
name|fbregp
operator|)
name|ipc_phys
argument_list|(
name|fbp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|wait
condition|)
name|fbwait
argument_list|()
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* USE_RAW_INTR */
end_comment

begin_function
name|void
name|fbstart
parameter_list|(
name|fbp
parameter_list|,
name|wait
parameter_list|)
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
name|int
name|wait
decl_stmt|;
block|{
name|int
name|s
init|=
name|splfb
argument_list|()
decl_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
name|msg_send
argument_list|(
name|port_fb_iop
argument_list|,
name|port_fb
argument_list|,
name|fbp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fbp
argument_list|)
argument_list|,
name|MSG_INDIRECT
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|last_fb
operator|=
name|fbp
expr_stmt|;
if|if
condition|(
name|wait
condition|)
block|{
name|fbstate
operator||=
name|FB_WAIT
expr_stmt|;
name|sleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|fbreg
argument_list|,
name|FBPRI
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fbstate
operator||=
name|FB_DELAY
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fbcint
parameter_list|(
name|arg
parameter_list|)
name|int
name|arg
decl_stmt|;
block|{
name|intrcnt
index|[
name|INTR_BITMAP
index|]
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
name|msg_recv
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|mips
name|clean_dcache
argument_list|(
operator|(
name|caddr_t
operator|)
name|last_fb
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fbreg
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* IPC_MRX */
if|if
condition|(
name|fbstate
operator|&
name|FB_WAIT
condition|)
block|{
name|fbstate
operator|&=
operator|~
name|FB_WAIT
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
name|fbreg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fbstate
operator|&
name|FB_DELAY
condition|)
block|{
name|fbstate
operator|&=
operator|~
name|FB_DELAY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fbstate
operator|&
name|FB_DELAY2
condition|)
block|{
name|fbstate
operator|&=
operator|~
operator|(
name|FB_BUSY
operator||
name|FB_DELAY2
operator|)
expr_stmt|;
if|if
condition|(
name|fbstate
operator|&
name|FB_WANTED
condition|)
block|{
name|fbstate
operator|&=
operator|~
name|FB_WANTED
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|fbstate
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USE_RAW_INTR */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CPU_DOUBLE */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_macro
name|fbprobe
argument_list|(
argument|ii
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|iop_device
modifier|*
name|ii
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|unit
init|=
name|ii
operator|->
name|ii_unit
decl_stmt|;
specifier|register
name|struct
name|fb_softc
modifier|*
name|fb
init|=
operator|&
name|fb_softc
index|[
name|unit
index|]
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|IPC_MRX
argument_list|)
operator|&&
name|defined
argument_list|(
name|mips
argument_list|)
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|(
expr|struct
name|fbreg
operator|*
operator|)
name|MACH_CACHED_TO_UNCACHED
argument_list|(
operator|&
name|fbreg
index|[
name|unit
index|]
argument_list|)
decl_stmt|;
else|#
directive|else
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|&
name|fbreg
index|[
name|unit
index|]
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CPU_SINGLE
if|if
condition|(
name|unit
operator|==
literal|0
condition|)
name|register_hb_intr2
argument_list|(
name|rop_xint
argument_list|,
name|ii
operator|->
name|ii_unit
argument_list|,
name|ii
operator|->
name|ii_intr
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|IPC_MRX
if|if
condition|(
name|port_fb_iop
operator|<=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|USE_RAW_INTR
name|register_ipcintr
argument_list|(
literal|4
argument_list|,
name|Xfb_intr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|port_fb_iop
operator|=
name|object_query
argument_list|(
literal|"framebuf"
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_fb_iop
operator|<=
literal|0
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
ifndef|#
directive|ifndef
name|USE_RAW_INTR
name|port_fb
operator|=
name|port_create
argument_list|(
literal|"@port_fb"
argument_list|,
name|fbcint
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
endif|#
directive|endif
comment|/* IPC_MRX */
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CPROBE
expr_stmt|;
name|fbp
operator|->
name|fb_device
operator|=
literal|0
expr_stmt|;
name|fbp
operator|->
name|fb_unit
operator|=
name|unit
expr_stmt|;
name|fbp
operator|->
name|fb_data
operator|=
operator|-
literal|1
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fb
operator|->
name|fbs_device
operator|=
name|fbp
operator|->
name|fb_data
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
else|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/* ARGSUSED */
end_comment

begin_macro
name|fbattach
argument_list|(
argument|ii
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|iop_device
modifier|*
name|ii
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|unit
init|=
name|ii
operator|->
name|ii_unit
decl_stmt|;
specifier|register
name|struct
name|fb_softc
modifier|*
name|fb
init|=
operator|&
name|fb_softc
index|[
name|unit
index|]
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|IPC_MRX
argument_list|)
operator|&&
name|defined
argument_list|(
name|mips
argument_list|)
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|(
expr|struct
name|fbreg
operator|*
operator|)
name|MACH_CACHED_TO_UNCACHED
argument_list|(
operator|&
name|fbreg
index|[
name|unit
index|]
argument_list|)
decl_stmt|;
else|#
directive|else
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|&
name|fbreg
index|[
name|unit
index|]
decl_stmt|;
endif|#
directive|endif
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CATTACH
expr_stmt|;
name|fbp
operator|->
name|fb_device
operator|=
name|fb
operator|->
name|fbs_device
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fb
operator|->
name|fbs_type
operator|=
name|fbp
operator|->
name|fb_scrtype
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|fbs_type
operator|.
name|type
condition|)
block|{
name|fb
operator|->
name|fbs_state
operator|=
literal|0
expr_stmt|;
name|fb
operator|->
name|fbs_flag
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"fb%d: %s"
argument_list|,
name|unit
argument_list|,
operator|(
name|fb
operator|->
name|fbs_type
operator|.
name|type
operator|<
sizeof|sizeof
argument_list|(
name|devname
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|devname
argument_list|)
operator|)
condition|?
name|devname
index|[
name|fb
operator|->
name|fbs_type
operator|.
name|type
index|]
else|:
literal|"UNKNOWN"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" (%d x %d %d plane)\n"
argument_list|,
name|fb
operator|->
name|fbs_type
operator|.
name|visiblerect
operator|.
name|extent
operator|.
name|x
argument_list|,
name|fb
operator|->
name|fbs_type
operator|.
name|visiblerect
operator|.
name|extent
operator|.
name|y
argument_list|,
name|fb
operator|->
name|fbs_type
operator|.
name|plane
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|fbopen
argument_list|(
argument|dev
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|unit
init|=
name|FBUNIT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|register
name|struct
name|fb_softc
modifier|*
name|fb
init|=
operator|&
name|fb_softc
index|[
name|unit
index|]
decl_stmt|;
specifier|register
name|struct
name|iop_device
modifier|*
name|ii
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|IPC_MRX
argument_list|)
operator|&&
name|defined
argument_list|(
name|mips
argument_list|)
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|(
expr|struct
name|fbreg
operator|*
operator|)
name|MACH_CACHED_TO_UNCACHED
argument_list|(
operator|&
name|fbreg
index|[
name|unit
index|]
argument_list|)
decl_stmt|;
else|#
directive|else
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|&
name|fbreg
index|[
name|unit
index|]
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|unit
operator|>=
name|NFB
operator|||
operator|(
name|ii
operator|=
name|fbinfo
index|[
name|unit
index|]
operator|)
operator|==
literal|0
operator|||
name|ii
operator|->
name|ii_alive
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|fb
operator|->
name|fbs_flag
operator|&&
operator|!
name|FBVIDEO
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
if|if
condition|(
name|fb
operator|->
name|fbs_state
operator|==
literal|0
condition|)
block|{
name|fbp
operator|->
name|fb_device
operator|=
name|fb
operator|->
name|fbs_device
expr_stmt|;
if|if
condition|(
name|fbinit
argument_list|(
name|fbp
argument_list|)
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
name|fb
operator|->
name|fbs_state
operator||=
name|FBVIDEO
argument_list|(
name|dev
argument_list|)
condition|?
name|VIDEO_USED
else|:
name|FB_USED
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|fbclose
argument_list|(
argument|dev
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|unit
init|=
name|FBUNIT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|register
name|struct
name|fb_softc
modifier|*
name|fb
init|=
operator|&
name|fb_softc
index|[
name|unit
index|]
decl_stmt|;
specifier|register
name|struct
name|iop_device
modifier|*
name|ii
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|IPC_MRX
argument_list|)
operator|&&
name|defined
argument_list|(
name|mips
argument_list|)
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|(
expr|struct
name|fbreg
operator|*
operator|)
name|MACH_CACHED_TO_UNCACHED
argument_list|(
operator|&
name|fbreg
index|[
name|unit
index|]
argument_list|)
decl_stmt|;
else|#
directive|else
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|&
name|fbreg
index|[
name|unit
index|]
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|unit
operator|>=
name|NFB
operator|||
operator|(
name|ii
operator|=
name|fbinfo
index|[
name|unit
index|]
operator|)
operator|==
literal|0
operator|||
name|ii
operator|->
name|ii_alive
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|fb
operator|->
name|fbs_state
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|FBVIDEO
argument_list|(
name|dev
argument_list|)
condition|)
name|fb
operator|->
name|fbs_flag
operator|=
literal|0
expr_stmt|;
name|fb
operator|->
name|fbs_state
operator|&=
operator|~
operator|(
name|FBVIDEO
argument_list|(
name|dev
argument_list|)
condition|?
name|VIDEO_USED
else|:
name|FB_USED
operator|)
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|fbs_state
operator|==
literal|0
condition|)
block|{
name|fbp
operator|->
name|fb_device
operator|=
name|fb
operator|->
name|fbs_device
expr_stmt|;
name|fbreset
argument_list|(
name|fbp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|fbioctl
argument_list|(
argument|dev
argument_list|,
argument|cmd
argument_list|,
argument|data
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|unit
init|=
name|FBUNIT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|register
name|struct
name|fb_softc
modifier|*
name|fb
init|=
operator|&
name|fb_softc
index|[
name|unit
index|]
decl_stmt|;
specifier|register
name|struct
name|iop_device
modifier|*
name|ii
decl_stmt|;
specifier|register
name|int
name|error
init|=
literal|0
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|IPC_MRX
argument_list|)
operator|&&
name|defined
argument_list|(
name|mips
argument_list|)
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|(
expr|struct
name|fbreg
operator|*
operator|)
name|MACH_CACHED_TO_UNCACHED
argument_list|(
operator|&
name|fbreg
index|[
name|unit
index|]
argument_list|)
decl_stmt|;
else|#
directive|else
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|&
name|fbreg
index|[
name|unit
index|]
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|unit
operator|>=
name|NFB
operator|||
operator|(
name|ii
operator|=
name|fbinfo
index|[
name|unit
index|]
operator|)
operator|==
literal|0
operator|||
name|ii
operator|->
name|ii_alive
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|fblock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_device
operator|=
name|fb
operator|->
name|fbs_device
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|FBIOCENABLE
case|:
name|fb
operator|->
name|fbs_flag
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|FBIOCDISABLE
case|:
name|fb
operator|->
name|fbs_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|FBIOCAUTODIM
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CAUTODIM
expr_stmt|;
name|fbp
operator|->
name|fb_data
operator|=
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCSETDIM
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CSETDIM
expr_stmt|;
name|fbp
operator|->
name|fb_data
operator|=
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCGETDIM
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CGETDIM
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
operator|=
name|fbp
operator|->
name|fb_data
expr_stmt|;
break|break;
case|case
name|FBIOCBITBLT
case|:
name|error
operator|=
name|fbbitblt
argument_list|(
name|fbp
argument_list|,
operator|(
name|sBitblt
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNBITBLT
case|:
name|error
operator|=
name|fbnbitblt
argument_list|(
name|fbp
argument_list|,
operator|(
name|lBitblt
operator|*
operator|)
name|data
argument_list|,
name|UIO_USERSPACE
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCBATCHBITBLT
case|:
name|error
operator|=
name|fbbatchbitblt
argument_list|(
name|fbp
argument_list|,
operator|(
name|sBatchBitblt
operator|*
operator|)
name|data
argument_list|,
name|UIO_USERSPACE
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNBATCHBITBLT
case|:
name|error
operator|=
name|fbnbatchbitblt
argument_list|(
name|fbp
argument_list|,
operator|(
name|lBatchBitblt
operator|*
operator|)
name|data
argument_list|,
name|UIO_USERSPACE
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCTILEBITBLT
case|:
name|error
operator|=
name|fbtilebitblt
argument_list|(
name|fbp
argument_list|,
operator|(
name|sTileBitblt
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNTILEBITBLT
case|:
name|error
operator|=
name|fbntilebitblt
argument_list|(
name|fbp
argument_list|,
operator|(
name|lTileBitblt
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCBITBLT3
case|:
name|error
operator|=
name|fbbitblt3
argument_list|(
name|fbp
argument_list|,
operator|(
name|sBitblt3
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNBITBLT3
case|:
name|error
operator|=
name|fbnbitblt3
argument_list|(
name|fbp
argument_list|,
operator|(
name|lBitblt3
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCPOLYLINE
case|:
name|error
operator|=
name|fbpolyline
argument_list|(
name|fbp
argument_list|,
operator|(
name|sPrimLine
operator|*
operator|)
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNPOLYLINE
case|:
name|error
operator|=
name|fbnpolyline
argument_list|(
name|fbp
argument_list|,
operator|(
name|lPrimLine
operator|*
operator|)
name|data
argument_list|,
literal|0
argument_list|,
name|UIO_USERSPACE
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCDJPOLYLINE
case|:
name|error
operator|=
name|fbpolyline
argument_list|(
name|fbp
argument_list|,
operator|(
name|sPrimLine
operator|*
operator|)
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNDJPOLYLINE
case|:
name|error
operator|=
name|fbnpolyline
argument_list|(
name|fbp
argument_list|,
operator|(
name|lPrimLine
operator|*
operator|)
name|data
argument_list|,
literal|1
argument_list|,
name|UIO_USERSPACE
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCPOLYMARKER
case|:
name|error
operator|=
name|fbpolymarker
argument_list|(
name|fbp
argument_list|,
operator|(
name|sPrimMarker
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNPOLYMARKER
case|:
name|error
operator|=
name|fbnpolymarker
argument_list|(
name|fbp
argument_list|,
operator|(
name|lPrimMarker
operator|*
operator|)
name|data
argument_list|,
name|UIO_USERSPACE
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCRECTANGLE
case|:
name|error
operator|=
name|fbrectangle
argument_list|(
name|fbp
argument_list|,
operator|(
name|sPrimRect
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNRECTANGLE
case|:
name|error
operator|=
name|fbnrectangle
argument_list|(
name|fbp
argument_list|,
operator|(
name|lPrimRect
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCFILLSCAN
case|:
name|error
operator|=
name|fbfillscan
argument_list|(
name|fbp
argument_list|,
operator|(
name|sPrimFill
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNFILLSCAN
case|:
name|error
operator|=
name|fbnfillscan
argument_list|(
name|fbp
argument_list|,
operator|(
name|lPrimFill
operator|*
operator|)
name|data
argument_list|,
name|UIO_USERSPACE
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCTEXT
case|:
name|error
operator|=
name|fbtext
argument_list|(
name|fbp
argument_list|,
operator|(
name|sPrimText
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNTEXT
case|:
name|error
operator|=
name|fbntext
argument_list|(
name|fbp
argument_list|,
operator|(
name|lPrimText
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCPOLYDOT
case|:
name|error
operator|=
name|fbpolydot
argument_list|(
name|fbp
argument_list|,
operator|(
name|sPrimDot
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNPOLYDOT
case|:
name|error
operator|=
name|fbnpolydot
argument_list|(
name|fbp
argument_list|,
operator|(
name|lPrimDot
operator|*
operator|)
name|data
argument_list|,
name|UIO_USERSPACE
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCGETSCRTYPE
case|:
name|fbgetscrtype
argument_list|(
name|fbp
argument_list|,
operator|(
name|sScrType
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNGETSCRTYPE
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CGETSCRTYPE
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|lScrType
operator|*
operator|)
name|data
operator|)
operator|=
name|fbp
operator|->
name|fb_scrtype
expr_stmt|;
break|break;
case|case
name|FBIOCSETPALETTE
case|:
name|fbsetpalette
argument_list|(
name|fbp
argument_list|,
operator|(
name|sPalette
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNSETPALETTE
case|:
name|error
operator|=
name|fbnsetpalette
argument_list|(
name|fbp
argument_list|,
operator|(
name|lPalette
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCGETPALETTE
case|:
name|fbgetpalette
argument_list|(
name|fbp
argument_list|,
operator|(
name|sPalette
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNGETPALETTE
case|:
name|error
operator|=
name|fbngetpalette
argument_list|(
name|fbp
argument_list|,
operator|(
name|lPalette
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCSETCURSOR
case|:
name|fbsetcursor
argument_list|(
name|fbp
argument_list|,
operator|(
name|sCursor
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNSETCURSOR
case|:
name|fbnsetcursor
argument_list|(
name|fbp
argument_list|,
operator|(
name|lCursor
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNSETCURSOR2
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CSETCURSOR
expr_stmt|;
name|fbp
operator|->
name|fb_cursor
operator|=
operator|*
operator|(
operator|(
name|lCursor2
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCUNSETCURSOR
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CUNSETCURSOR
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNUNSETCURSOR
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CUNSETCURSOR
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCSHOWCURSOR
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CSHOWCURSOR
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNSHOWCURSOR
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CSHOWCURSOR
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCHIDECURSOR
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CHIDECURSOR
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNHIDECURSOR
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CHIDECURSOR
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCSETXY
case|:
name|fbsetxy
argument_list|(
name|fbp
argument_list|,
operator|(
name|sPoint
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNSETXY
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CSETXY
expr_stmt|;
name|fbp
operator|->
name|fb_point
operator|=
operator|*
operator|(
operator|(
name|lPoint
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNSETPALETTEMODE
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CSETPMODE
expr_stmt|;
name|fbp
operator|->
name|fb_data
operator|=
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNGETPALETTEMODE
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CGETPMODE
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
operator|=
name|fbp
operator|->
name|fb_data
expr_stmt|;
break|break;
case|case
name|FBIOCNSETVIDEO
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CSETVIDEO
expr_stmt|;
name|fbp
operator|->
name|fb_videoctl
operator|=
operator|*
operator|(
operator|(
name|lVideoCtl
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBIOCNGETVIDEO
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CGETVIDEO
expr_stmt|;
name|fbp
operator|->
name|fb_videostatus
operator|.
name|request
operator|=
name|VIDEO_STATUS
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|lVideoStatus
operator|*
operator|)
name|data
operator|)
operator|=
name|fbp
operator|->
name|fb_videostatus
expr_stmt|;
name|error
operator|=
name|fbp
operator|->
name|fb_result
expr_stmt|;
break|break;
case|case
name|FBIOCNIOCTL
case|:
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CIOCTL
expr_stmt|;
name|fbp
operator|->
name|fb_fbioctl
operator|=
operator|*
operator|(
operator|(
name|lFbIoctl
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|lFbIoctl
operator|*
operator|)
name|data
operator|)
operator|=
name|fbp
operator|->
name|fb_fbioctl
expr_stmt|;
if|if
condition|(
name|fbp
operator|->
name|fb_result
operator|==
name|FB_RERROR
condition|)
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ENXIO
expr_stmt|;
break|break;
block|}
name|fbunlock
argument_list|(
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_macro
name|fbmmap
argument_list|(
argument|dev
argument_list|,
argument|off
argument_list|,
argument|prot
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|off_t
name|off
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|prot
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|unit
init|=
name|FBUNIT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|register
name|struct
name|fb_softc
modifier|*
name|fb
init|=
operator|&
name|fb_softc
index|[
name|unit
index|]
decl_stmt|;
specifier|register
name|struct
name|iop_device
modifier|*
name|ii
decl_stmt|;
specifier|register
name|int
name|page
decl_stmt|;
specifier|register
name|struct
name|fbreg
modifier|*
name|fbp
init|=
operator|&
name|fbreg
index|[
name|unit
index|]
decl_stmt|;
if|if
condition|(
name|unit
operator|>=
name|NFB
operator|||
operator|(
name|ii
operator|=
name|fbinfo
index|[
name|unit
index|]
operator|)
operator|==
literal|0
operator|||
name|ii
operator|->
name|ii_alive
operator|==
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|fblock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_device
operator|=
name|fb
operator|->
name|fbs_device
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CGETPAGE
expr_stmt|;
name|fbp
operator|->
name|fb_data
operator|=
name|off
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|page
operator|=
name|fbp
operator|->
name|fb_data
expr_stmt|;
if|if
condition|(
name|fbp
operator|->
name|fb_result
operator|==
name|FB_RERROR
condition|)
name|page
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|fb
operator|->
name|fbs_flag
operator|=
literal|1
expr_stmt|;
name|fbunlock
argument_list|(
name|fbp
operator|->
name|fb_result
argument_list|)
expr_stmt|;
return|return
operator|(
name|page
operator|)
return|;
block|}
end_block

begin_function
specifier|static
name|void
name|fblock
parameter_list|()
block|{
name|int
name|s
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_RAW_INTR
name|fbwait
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|s
operator|=
name|splfb
argument_list|()
expr_stmt|;
while|while
condition|(
name|fbstate
operator|&
name|FB_BUSY
condition|)
block|{
name|fbstate
operator||=
name|FB_WANTED
expr_stmt|;
name|sleep
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|fbstate
argument_list|,
name|FBPRI
argument_list|)
expr_stmt|;
block|}
name|fbstate
operator||=
name|FB_BUSY
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fbunlock
parameter_list|(
name|error
parameter_list|)
name|int
name|error
decl_stmt|;
block|{
name|int
name|s
init|=
name|splfb
argument_list|()
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|fbstate
operator|&=
operator|~
name|FB_BUSY
expr_stmt|;
if|if
condition|(
name|fbstate
operator|&
name|FB_WANTED
condition|)
block|{
name|fbstate
operator|&=
operator|~
name|FB_WANTED
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|fbstate
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
ifdef|#
directive|ifdef
name|USE_RAW_INTR
name|fbstate
operator|&=
operator|~
name|FB_BUSY
expr_stmt|;
if|if
condition|(
name|fbstate
operator|&
name|FB_WANTED
condition|)
block|{
name|fbstate
operator|&=
operator|~
name|FB_WANTED
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|fbstate
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|error
operator|||
operator|(
name|fbstate
operator|&
name|FB_DELAY
operator|)
operator|==
literal|0
condition|)
block|{
name|fbstate
operator|&=
operator|~
operator|(
name|FB_BUSY
operator||
name|FB_WAIT
operator||
name|FB_DELAY
operator|)
expr_stmt|;
if|if
condition|(
name|fbstate
operator|&
name|FB_WANTED
condition|)
block|{
name|fbstate
operator|&=
operator|~
name|FB_WANTED
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|fbstate
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fbstate
operator|&
name|FB_DELAY
condition|)
block|{
name|fbstate
operator|&=
operator|~
name|FB_DELAY
expr_stmt|;
name|fbstate
operator||=
name|FB_DELAY2
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
comment|/* CPU_SINGLE */
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|fbinit
parameter_list|(
name|fbp
parameter_list|)
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
block|{
name|fblock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_COPEN
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fbp
operator|->
name|fb_result
operator|!=
name|FB_ROK
condition|)
block|{
name|fbunlock
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_RERROR
operator|)
return|;
block|}
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CUNSETCURSOR
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|fbreset
parameter_list|(
name|fbp
parameter_list|)
name|struct
name|fbreg
modifier|*
name|fbp
decl_stmt|;
block|{
name|fblock
argument_list|()
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CUNSETCURSOR
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbp
operator|->
name|fb_command
operator|=
name|FB_CCLOSE
expr_stmt|;
name|fbstart
argument_list|(
name|fbp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fbunlock
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NFB */
end_comment

end_unit


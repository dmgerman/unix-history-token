begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Sony Corp. and Kazumasa Utashiro of Software Research Associates, Inc.  *  * %sccs.include.redist.c%  *  * from: $Hdr: scsi.c,v 4.300 91/06/27 20:42:51 root Rel41 $ SONY  *  *	@(#)scsi.c	7.2 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  *	scsi.c	ver 1.1		  */
end_comment

begin_include
include|#
directive|include
file|<machine/fix_machine_type.h>
end_include

begin_include
include|#
directive|include
file|<machine/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<news3400/hbdev/hbvar.h>
end_include

begin_include
include|#
directive|include
file|<news3400/hbdev/scsic.h>
end_include

begin_include
include|#
directive|include
file|<news3400/hbdev/screg_1185.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iodev/scsireg.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iodev/ioptohb.h>
end_include

begin_define
define|#
directive|define
name|DEBUG_LOSSBSY_HUNG
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG_LOSSBSY_HUNG
end_ifdef

begin_define
define|#
directive|define
name|PROBE_MAXRETRY
value|100
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|NO_SCSI_DISCONNECT
end_ifndef

begin_decl_stmt
name|int
name|Scsi_Disconnect
init|=
name|IDT_DISCON
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|int
name|Scsi_Disconnect
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAXCTLR
value|8
end_define

begin_decl_stmt
name|struct
name|sc_data
name|sc_data
index|[
name|MAXCTLR
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|scintsw
name|scintsw
index|[
name|MAXCTLR
index|]
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|RSENSE_MSG_DISP
end_ifdef

begin_decl_stmt
name|int
name|rsense_msg_disp
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* RSENSE-message display flag */
end_comment

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|int
name|rsense_msg_disp
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* RSENSE-message display flag */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|mo_disp_format
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* MO format mode display flag */
end_comment

begin_struct
struct|struct
name|msg_list
block|{
name|int
name|ml_code
decl_stmt|;
comment|/* message code */
name|int
name|ml_msglvl
decl_stmt|;
comment|/* message level */
name|char
modifier|*
name|ml_msgstr
decl_stmt|;
comment|/* message string */
block|}
struct|;
end_struct

begin_ifdef
ifdef|#
directive|ifdef
name|NO_SHRINK_RSENSE_MSG
end_ifdef

begin_decl_stmt
name|struct
name|msg_list
name|skeylist
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|1
block|,
literal|"No Sense"
block|}
block|,
block|{
literal|0x01
block|,
literal|0
block|,
literal|"Recoverable Error"
block|}
block|,
block|{
literal|0x02
block|,
literal|0
block|,
literal|"Not Ready"
block|}
block|,
block|{
literal|0x03
block|,
literal|0
block|,
literal|"Medium Error"
block|}
block|,
block|{
literal|0x04
block|,
literal|0
block|,
literal|"Hardware Error"
block|}
block|,
block|{
literal|0x05
block|,
literal|0
block|,
literal|"Illegal Request"
block|}
block|,
block|{
literal|0x06
block|,
literal|1
block|,
literal|"Unit Attention"
block|}
block|,
block|{
literal|0x07
block|,
literal|1
block|,
literal|"Data protect"
block|}
block|,
block|{
literal|0x08
block|,
literal|0
block|,
literal|"Blank Check"
block|}
block|,
block|{
literal|0x09
block|,
literal|0
block|,
literal|"Vendor Unique"
block|}
block|,
block|{
literal|0x0a
block|,
literal|0
block|,
literal|"Copy/Compare Aborted"
block|}
block|,
block|{
literal|0x0b
block|,
literal|0
block|,
literal|"Aborted Command"
block|}
block|,
block|{
literal|0x0c
block|,
literal|0
block|,
literal|"Equal"
block|}
block|,
block|{
literal|0x0d
block|,
literal|0
block|,
literal|"Volume Overflow"
block|}
block|,
block|{
literal|0x0e
block|,
literal|0
block|,
literal|"Miscompare"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,
operator|(
name|caddr_t
operator|)
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* NO_SHRINK_RSENSE_MSG */
end_comment

begin_decl_stmt
name|struct
name|msg_list
name|skeylist
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|1
block|,
name|NULL
block|}
block|,
block|{
literal|0x01
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x02
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x03
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x04
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x05
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x06
block|,
literal|1
block|,
name|NULL
block|}
block|,
block|{
literal|0x07
block|,
literal|1
block|,
name|NULL
block|}
block|,
block|{
literal|0x08
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x09
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x0a
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x0b
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x0c
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x0d
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x0e
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NO_SHRINK_RSENSE_MSG */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|NO_SHRINK_RSENSE_MSG
end_ifdef

begin_decl_stmt
name|struct
name|msg_list
name|ecodelist
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|9
block|,
literal|"No Additional Sense Information"
block|}
block|,
comment|/*HD*/
block|{
literal|0x01
block|,
literal|1
block|,
literal|"No Index/Address Mark Found signal"
block|}
block|,
block|{
literal|0x02
block|,
literal|0
block|,
literal|"No Seek Complete"
block|}
block|,
block|{
literal|0x03
block|,
literal|0
block|,
literal|"Write Fault"
block|}
block|,
block|{
literal|0x04
block|,
literal|9
block|,
literal|"Drive Not Ready"
block|}
block|,
block|{
literal|0x05
block|,
literal|0
block|,
literal|"Drive Not Selected"
block|}
block|,
comment|/*HD*/
block|{
literal|0x06
block|,
literal|0
block|,
literal|"No Track Zero"
block|}
block|,
block|{
literal|0x07
block|,
literal|0
block|,
literal|"Multiple Drives Selected"
block|}
block|,
block|{
literal|0x08
block|,
literal|0
block|,
literal|"Logical Unit Communication Failure"
block|}
block|,
block|{
literal|0x09
block|,
literal|2
block|,
literal|"Track Following Error"
block|}
block|,
comment|/*MO*/
block|{
literal|0x0a
block|,
literal|1
block|,
literal|"No Disk"
block|}
block|,
comment|/*MO*/
block|{
literal|0x0b
block|,
literal|1
block|,
literal|"Load/Unload Failure"
block|}
block|,
comment|/*MO*/
block|{
literal|0x0c
block|,
literal|1
block|,
literal|"Spindle Failure"
block|}
block|,
comment|/*MO*/
block|{
literal|0x0d
block|,
literal|1
block|,
literal|"Focus Failure"
block|}
block|,
comment|/*MO*/
block|{
literal|0x0e
block|,
literal|1
block|,
literal|"Tracking Failure"
block|}
block|,
comment|/*MO*/
block|{
literal|0x0f
block|,
literal|0
block|,
literal|"Drive Initialization Failure"
block|}
block|,
block|{
literal|0x10
block|,
literal|1
block|,
literal|"ID CRC or ECC error"
block|}
block|,
block|{
literal|0x11
block|,
literal|0
block|,
literal|"Unrecoverd Read error"
block|}
block|,
comment|/*HD*/
block|{
literal|0x12
block|,
literal|0
block|,
literal|"No Address Mark (byte sync byte) found in ID field"
block|}
block|,
comment|/*HD*/
block|{
literal|0x13
block|,
literal|0
block|,
literal|"No Address Mark (byte sync byte) found in Data field"
block|}
block|,
comment|/*HD*/
block|{
literal|0x14
block|,
literal|0
block|,
literal|"No record found"
block|}
block|,
block|{
literal|0x15
block|,
literal|1
block|,
literal|"Seek Positioning Error"
block|}
block|,
comment|/*HD*/
block|{
literal|0x17
block|,
literal|0
block|,
literal|"Recovered Read data with Read retries"
block|}
block|,
block|{
literal|0x18
block|,
literal|0
block|,
literal|"Recovered Read data with ECC procedure"
block|}
block|,
comment|/*HD*/
block|{
literal|0x19
block|,
literal|0
block|,
literal|"Defect List error"
block|}
block|,
comment|/*HD*/
block|{
literal|0x1a
block|,
literal|0
block|,
literal|"Parameter overrun"
block|}
block|,
comment|/*HD*/
block|{
literal|0x1b
block|,
literal|0
block|,
literal|"Synchronous transfer error"
block|}
block|,
comment|/*HD*/
block|{
literal|0x1c
block|,
literal|0
block|,
literal|"Primary Defect List not found"
block|}
block|,
comment|/*HD*/
block|{
literal|0x1d
block|,
literal|0
block|,
literal|"Compare error"
block|}
block|,
block|{
literal|0x20
block|,
literal|0
block|,
literal|"Invalid Command Operation Code"
block|}
block|,
block|{
literal|0x21
block|,
literal|0
block|,
literal|"Illegal Logical Block Address"
block|}
block|,
comment|/*HD*/
block|{
literal|0x22
block|,
literal|0
block|,
literal|"Illegal function for device type"
block|}
block|,
comment|/*MO*/
block|{
literal|0x23
block|,
literal|0
block|,
literal|"Illegal function for Medium Type"
block|}
block|,
block|{
literal|0x24
block|,
literal|0
block|,
literal|"Illegal Field in CDB"
block|}
block|,
block|{
literal|0x25
block|,
literal|0
block|,
literal|"Invalid LUN"
block|}
block|,
block|{
literal|0x26
block|,
literal|0
block|,
literal|"Invalid field in Parameter List"
block|}
block|,
block|{
literal|0x27
block|,
literal|0
block|,
literal|"Write Protected"
block|}
block|,
block|{
literal|0x28
block|,
literal|1
block|,
literal|"Medium Changed"
block|}
block|,
block|{
literal|0x29
block|,
literal|1
block|,
literal|"Power On or Reset or Bus Device Reset Occured"
block|}
block|,
block|{
literal|0x2a
block|,
literal|1
block|,
literal|"Mode Select Parameters Changed"
block|}
block|,
comment|/*HD*/
block|{
literal|0x2b
block|,
literal|0
block|,
literal|"Host cannot Disconnect"
block|}
block|,
block|{
literal|0x31
block|,
literal|0
block|,
literal|"Medium Format Corrupted"
block|}
block|,
block|{
literal|0x32
block|,
literal|0
block|,
literal|"No Defect Spare Location Available"
block|}
block|,
comment|/*MO*/
block|{
literal|0x38
block|,
literal|1
block|,
literal|"Recovered with Automatic Reallocation"
block|}
block|,
comment|/*MO*/
block|{
literal|0x39
block|,
literal|0
block|,
literal|"Automatic Reallocation Failure"
block|}
block|,
comment|/*MO*/
block|{
literal|0x3a
block|,
literal|1
block|,
literal|"Defect List Update Failure"
block|}
block|,
comment|/*MO*/
block|{
literal|0x3d
block|,
literal|0
block|,
literal|"Defect List Not Available"
block|}
block|,
comment|/*HD*/
block|{
literal|0x40
block|,
literal|0
block|,
literal|"RAM failure"
block|}
block|,
comment|/*HD*/
block|{
literal|0x41
block|,
literal|0
block|,
literal|"Data Path diagnostic failure"
block|}
block|,
block|{
literal|0x42
block|,
literal|0
block|,
literal|"Power On Diagnostic Failure"
block|}
block|,
block|{
literal|0x43
block|,
literal|0
block|,
literal|"Message Reject Error"
block|}
block|,
block|{
literal|0x44
block|,
literal|9
block|,
literal|"Internal Controller Error"
block|}
block|,
comment|/*HD*/
block|{
literal|0x45
block|,
literal|0
block|,
literal|"Selection/Reselection failure"
block|}
block|,
block|{
literal|0x47
block|,
literal|0
block|,
literal|"SCSI Interface Parity Error"
block|}
block|,
block|{
literal|0x48
block|,
literal|0
block|,
literal|"Initiator Detected Error"
block|}
block|,
block|{
literal|0x49
block|,
literal|0
block|,
literal|"Inappropriate/Illegal Message"
block|}
block|,
block|{
literal|0x64
block|,
literal|1
block|,
literal|"Illegal mode for this track"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,
operator|(
name|caddr_t
operator|)
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* NO_SHRINK_RSENSE_MSG */
end_comment

begin_decl_stmt
name|struct
name|msg_list
name|ecodelist
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|9
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x01
block|,
literal|1
block|,
name|NULL
block|}
block|,
block|{
literal|0x02
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x03
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x04
block|,
literal|9
block|,
name|NULL
block|}
block|,
block|{
literal|0x05
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x06
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x07
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x08
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x09
block|,
literal|2
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x0a
block|,
literal|1
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x0b
block|,
literal|1
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x0c
block|,
literal|1
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x0d
block|,
literal|1
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x0e
block|,
literal|1
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x0f
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x10
block|,
literal|1
block|,
name|NULL
block|}
block|,
block|{
literal|0x11
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x12
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x13
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x14
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x15
block|,
literal|1
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x17
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x18
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x19
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x1a
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x1b
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x1c
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x1d
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x20
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x21
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x22
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x23
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x24
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x25
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x26
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x27
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x28
block|,
literal|1
block|,
name|NULL
block|}
block|,
block|{
literal|0x29
block|,
literal|1
block|,
name|NULL
block|}
block|,
block|{
literal|0x2a
block|,
literal|1
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x2b
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x31
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x32
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x38
block|,
literal|1
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x39
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x3a
block|,
literal|1
block|,
name|NULL
block|}
block|,
comment|/*MO*/
block|{
literal|0x3d
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x40
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x41
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x42
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x43
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x44
block|,
literal|9
block|,
name|NULL
block|}
block|,
comment|/*HD*/
block|{
literal|0x45
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x47
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x48
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x49
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|0x64
block|,
literal|1
block|,
name|NULL
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NO_SHRINK_RSENSE_MSG */
end_comment

begin_comment
comment|/*  * Init a scsi bus.  */
end_comment

begin_macro
name|scop_init
argument_list|(
argument|scn
argument_list|)
end_macro

begin_decl_stmt
name|int
name|scn
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|struct
name|scsi
name|sc
decl_stmt|;
name|int
name|chan
decl_stmt|;
for|for
control|(
name|chan
operator|=
literal|0
init|;
name|chan
operator|<
name|MAXCTLR
condition|;
name|chan
operator|++
control|)
block|{
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|scsi
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|.
name|sc_cdb
operator|.
name|un_reserved
index|[
literal|0
index|]
operator|=
name|SCOP_RESET
expr_stmt|;
name|sc
operator|.
name|sc_cdb
operator|.
name|un_reserved
index|[
literal|1
index|]
operator|=
name|SCOP_RESET
expr_stmt|;
if|if
condition|(
operator|!
name|sc_busy
argument_list|(
name|chan
argument_list|)
condition|)
block|{
name|sc_go
argument_list|(
name|chan
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
operator|&
name|sc
argument_list|,
name|SCSI_INTDIS
argument_list|)
expr_stmt|;
name|chan
operator|=
operator|(
name|chan
operator|/
literal|8
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
block|}
block|}
block|}
end_block

begin_comment
comment|/************************************** 	The multiple scsi bus is NOT suported by following routines. 	How about use inter like dev_t ( uper is scsi#, lower is inter )  	or hb_ctlr. 	probe() ga futatuarukara unit# ----- udauda.  **************************************/
end_comment

begin_comment
comment|/*  * scprobe. probe routine for mass storage controller.  */
end_comment

begin_macro
name|scprobe
argument_list|(
argument|im
argument_list|,
argument|ctlrintr
argument_list|,
argument|sc
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|iop
comment|/**/
name|_ctlr
modifier|*
name|im
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|ctlrintr
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|scintsw
modifier|*
name|sci
decl_stmt|;
name|int
name|s
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_LOSSBSY_HUNG
name|int
name|retry
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
endif|DEBUG_LOSSBSY_HUNG
name|sci
operator|=
operator|&
name|scintsw
index|[
name|im
operator|->
name|im_intr
index|]
expr_stmt|;
if|if
condition|(
name|sci
operator|->
name|sci_inthandler
condition|)
return|return
operator|(
literal|0
operator|)
return|;
ifdef|#
directive|ifdef
name|DEBUG_LOSSBSY_HUNG
name|scprobe_loop
label|:
comment|/* s = splsc(); */
name|scop_inquiry
argument_list|(
name|im
operator|->
name|im_intr
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|SCSI_INTDIS
argument_list|,
literal|4
argument_list|,
operator|(
name|caddr_t
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|/* splx(s); */
if|if
condition|(
name|sc
operator|->
name|sc_istatus
operator|!=
name|INST_EP
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_tstatus
operator|==
name|TGST_BUSY
operator|)
operator|&&
operator|(
name|retry
operator|++
operator|<
name|PROBE_MAXRETRY
operator|)
condition|)
block|{
goto|goto
name|scprobe_loop
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|#
directive|else
comment|/* DEBUG_LOSSBSY_HUNG */
comment|/* s = splsc(); */
name|scop_inquiry
argument_list|(
name|im
operator|->
name|im_intr
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|SCSI_INTDIS
argument_list|,
literal|4
argument_list|,
operator|(
name|caddr_t
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|/* splx(s); */
if|if
condition|(
name|sc
operator|->
name|sc_istatus
operator|!=
name|INST_EP
condition|)
return|return
operator|(
literal|0
operator|)
return|;
endif|#
directive|endif
comment|/* DEBUG_LOSSBSY_HUNG */
name|sci
operator|->
name|sci_inthandler
operator|=
name|ctlrintr
expr_stmt|;
name|sci
operator|->
name|sci_ctlr
operator|=
name|im
operator|->
name|im_ctlr
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * ssprobe. probe routine for non-mass storage peripherals.  */
end_comment

begin_macro
name|ssprobe
argument_list|(
argument|ii
argument_list|,
argument|ctlrintr
argument_list|,
argument|sc
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|iop
comment|/**/
name|_device
modifier|*
name|ii
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|ctlrintr
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|scintsw
modifier|*
name|sci
decl_stmt|;
name|int
name|s
decl_stmt|;
name|sci
operator|=
operator|&
name|scintsw
index|[
name|ii
operator|->
name|ii_intr
index|]
expr_stmt|;
if|if
condition|(
name|sci
operator|->
name|sci_inthandler
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* s = splsc(); */
name|scop_inquiry
argument_list|(
name|ii
operator|->
name|ii_intr
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|SCSI_INTDIS
argument_list|,
literal|4
argument_list|,
operator|(
name|caddr_t
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|/* splx(s); */
if|if
condition|(
name|sc
operator|->
name|sc_istatus
operator|!=
name|INST_EP
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sci
operator|->
name|sci_inthandler
operator|=
name|ctlrintr
expr_stmt|;
name|sci
operator|->
name|sci_ctlr
operator|=
name|ii
operator|->
name|ii_unit
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * SCOP_TST request  */
end_comment

begin_expr_stmt
name|scop_tst
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_TST
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_REZERO request  */
end_comment

begin_expr_stmt
name|scop_rezero
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_REZERO
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_REWIND request  */
end_comment

begin_expr_stmt
name|scop_rewind
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|imme
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|,
name|imme
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_REZERO
expr_stmt|;
name|sc
operator|->
name|sc_tucode
operator|=
name|imme
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_RSENSE request  */
end_comment

begin_expr_stmt
name|scop_rsense
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|param
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|count
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_RSENSE
expr_stmt|;
name|sc
operator|->
name|sc_count
operator|=
name|count
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_RASBLK request  */
end_comment

begin_expr_stmt
name|scop_rasblk
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|lad
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|lad
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|sc_rab
modifier|*
name|sca
init|=
operator|(
expr|struct
name|sc_rab
operator|*
operator|)
name|sc
operator|->
name|sc_param
decl_stmt|;
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|sca
operator|->
name|sca_dllen
operator|=
literal|4
expr_stmt|;
name|sca
operator|->
name|sca_dlad
index|[
literal|0
index|]
operator|=
name|lad
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|sca
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
literal|8
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_RASBLK
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_MERASE request  */
end_comment

begin_expr_stmt
name|scop_merase
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_MERASE
expr_stmt|;
name|sc
operator|->
name|sc_mtcount3
operator|=
name|count
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_WFMARK request  */
end_comment

begin_expr_stmt
name|scop_wfmark
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_WFMARK
expr_stmt|;
name|count
operator|&=
literal|0xffffff
expr_stmt|;
name|sc
operator|->
name|sc_tucount3
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
name|count
operator|>>=
literal|8
expr_stmt|;
name|sc
operator|->
name|sc_tucount2
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
name|count
operator|>>=
literal|8
expr_stmt|;
name|sc
operator|->
name|sc_tucount1
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_SPACE request  */
end_comment

begin_expr_stmt
name|scop_space
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|code
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|code
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_SPACE
expr_stmt|;
name|sc
operator|->
name|sc_tucode
operator|=
name|code
expr_stmt|;
name|count
operator|&=
literal|0xffffff
expr_stmt|;
name|sc
operator|->
name|sc_tucount3
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
name|count
operator|>>=
literal|8
expr_stmt|;
name|sc
operator|->
name|sc_tucount2
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
name|count
operator|>>=
literal|8
expr_stmt|;
name|sc
operator|->
name|sc_tucount1
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_INQUIRY request  */
end_comment

begin_expr_stmt
name|scop_inquiry
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|param
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|count
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_INQUIRY
expr_stmt|;
name|sc
operator|->
name|sc_count
operator|=
name|count
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_STST request  */
end_comment

begin_expr_stmt
name|scop_stst
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|sw
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|sw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_STST
expr_stmt|;
name|sc
operator|->
name|sc_switch
operator|=
name|sw
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_RCAP request  */
end_comment

begin_expr_stmt
name|scop_rcap
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|param
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|count
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_RCAP
expr_stmt|;
name|sc
operator|->
name|sc_pmi
operator|=
name|OFF
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_BSSRCH request  */
end_comment

begin_expr_stmt
name|scop_bssrch
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|param
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|count
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_BSSRCH
expr_stmt|;
name|sc
operator|->
name|sc_ladhi
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ladlo
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
operator|(
name|param
operator|+
literal|2
operator|)
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_WSSRCH request  */
end_comment

begin_expr_stmt
name|scop_wssrch
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|param
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|count
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_WSSRCH
expr_stmt|;
name|sc
operator|->
name|sc_ladhi
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ladlo
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
operator|(
name|param
operator|+
literal|2
operator|)
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *  * SCOP_EESENSE request  * Enable/Disable Eject Request Sense  * Write Once only supported.  *  */
end_comment

begin_expr_stmt
name|scop_eesense
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|sw
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|sw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_EESENSE
expr_stmt|;
name|sc
operator|->
name|sc_switch
operator|=
name|sw
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_EJECT  */
end_comment

begin_expr_stmt
name|scop_eject
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_EJECT
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_RBLIM request  */
end_comment

begin_expr_stmt
name|scop_rblim
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|param
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_RBLIM
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_MSENSE request  */
end_comment

begin_expr_stmt
name|scop_msense
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|param
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_MSENSE
expr_stmt|;
name|sc
operator|->
name|sc_lad
operator|=
name|count
operator|>>
literal|8
expr_stmt|;
name|sc
operator|->
name|sc_count
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_MSELECT request  */
end_comment

begin_expr_stmt
name|scop_mselect
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|param
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|u_char
name|psave
index|[
literal|20
index|]
decl_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|sc
operator|->
name|sc_param
argument_list|,
operator|(
name|caddr_t
operator|)
name|psave
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|psave
argument_list|,
operator|(
name|caddr_t
operator|)
name|sc
operator|->
name|sc_param
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_MSELECT
expr_stmt|;
name|sc
operator|->
name|sc_lad
operator|=
name|count
operator|>>
literal|8
expr_stmt|;
name|sc
operator|->
name|sc_count
operator|=
name|count
operator|&
literal|0xff
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|SRD_MSELECT
end_ifdef

begin_comment
comment|/*  * SCOP_MSELECT request  */
end_comment

begin_expr_stmt
name|scop_msense_OTHER_HD
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|param
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|count
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_MSENSE
expr_stmt|;
name|sc
operator|->
name|sc_count
operator|=
name|count
expr_stmt|;
name|sc
operator|->
name|sc_lad
operator|=
literal|0x3f00
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * SCOP_MSELECT request  */
end_comment

begin_expr_stmt
name|scop_mselect_OTHER_HD
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|count
argument_list|,
name|param
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|caddr_t
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|u_char
name|psave
index|[
literal|20
index|]
decl_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|sc
operator|->
name|sc_param
argument_list|,
operator|(
name|caddr_t
operator|)
name|psave
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|psave
argument_list|,
operator|(
name|caddr_t
operator|)
name|sc
operator|->
name|sc_param
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|param
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|count
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_MSELECT
expr_stmt|;
name|sc
operator|->
name|sc_count
operator|=
name|count
expr_stmt|;
name|sc
operator|->
name|sc_lad
operator|=
literal|0
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|SRD_MSELECT
end_endif

begin_expr_stmt
name|scop_erase
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_ERASE
expr_stmt|;
name|sc
operator|->
name|sc_tucode
operator|=
literal|1
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * One sector programmed I/O  */
end_comment

begin_macro
name|scop_rdwr
argument_list|(
argument|intr
argument_list|,
argument|sc
argument_list|,
argument|slave
argument_list|,
argument|ie
argument_list|,
argument|flag
argument_list|,
argument|addr
argument_list|,
argument|lba
argument_list|,
argument|sectsize
argument_list|)
end_macro

begin_decl_stmt
name|int
name|intr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lba
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sectsize
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|sectsize
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|addr
expr_stmt|;
name|sc
operator|->
name|sc_ctrnscnt
operator|=
name|sectsize
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
operator|(
name|flag
operator|&
name|B_READ
operator|)
condition|?
name|SCOP_READ
else|:
name|SCOP_WRITE
expr_stmt|;
name|sc
operator|->
name|sc_lad
operator|=
name|lba
expr_stmt|;
name|sc
operator|->
name|sc_count
operator|=
literal|1
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Medium allow/prevent removable  */
end_comment

begin_expr_stmt
name|scop_medrmv
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|,
name|sw
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|sw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_MEDRMV
expr_stmt|;
name|sc
operator|->
name|sc_count
operator|=
name|sw
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * initialize struct scsi  */
end_comment

begin_expr_stmt
name|scinit
argument_list|(
name|sc
argument_list|,
name|slave
argument_list|,
name|sectsize
argument_list|)
specifier|register
expr|struct
name|scsi
operator|*
name|sc
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sectsize
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|scsi
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_identify
operator|=
name|MSG_IDENT
operator||
name|Scsi_Disconnect
operator||
operator|(
name|slave
operator|&
name|IDT_DRMASK
operator|)
expr_stmt|;
name|sc
operator|->
name|sc_bytesec
operator|=
name|sectsize
expr_stmt|;
name|sc
operator|->
name|sc_lun
operator|=
name|slave
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * ABORT MESSAGE  */
end_comment

begin_expr_stmt
name|scms_abort
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|ie
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|scsi
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_identify
operator|=
name|MSG_ABORT
expr_stmt|;
comment|/* sc_cdb */
name|sc
operator|->
name|sc_opcode
operator|=
name|SCOP_TST
expr_stmt|;
name|sc
operator|->
name|sc_lun
operator|=
name|slave
expr_stmt|;
name|sc_go
argument_list|(
name|intr
argument_list|,
operator|(
expr|struct
name|scsi
operator|*
operator|)
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|sc_go
argument_list|(
argument|intr
argument_list|,
argument|sc
argument_list|,
argument|ie
argument_list|)
end_macro

begin_decl_stmt
name|int
name|intr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|sc_data
modifier|*
name|scdp
decl_stmt|;
name|scdp
operator|=
operator|&
name|sc_data
index|[
name|intr
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_cpoint
condition|)
name|scdp
operator|->
name|scd_vaddr
operator|=
operator|(
name|char
operator|*
operator|)
name|sc
operator|->
name|sc_cpoint
expr_stmt|;
else|else
name|scdp
operator|->
name|scd_vaddr
operator|=
operator|(
name|char
operator|*
operator|)
name|sc
operator|->
name|sc_param
expr_stmt|;
name|scdp
operator|->
name|scd_procp
operator|=
name|curproc
expr_stmt|;
name|scdp
operator|->
name|scd_scaddr
operator|=
operator|(
name|char
operator|*
operator|)
name|sc
expr_stmt|;
name|scdp
operator|->
name|scd_count
operator|=
name|sc
operator|->
name|sc_ctrnscnt
expr_stmt|;
name|sc
operator|->
name|sc_cpoint
operator|=
operator|(
name|u_char
operator|*
operator|)
name|ipc_phys
argument_list|(
name|scdp
operator|->
name|scd_vaddr
argument_list|)
expr_stmt|;
name|_sc_go
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|ie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ie
operator|&
name|SCSI_INTEN
operator|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|mips
comment|/* if (DATAIN_PHASE_FINISHED) */
name|MachFlushDCache
argument_list|(
name|scdp
operator|->
name|scd_scaddr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|scsi
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|MACH_IS_USPACE
argument_list|(
name|scdp
operator|->
name|scd_vaddr
argument_list|)
condition|)
name|panic
argument_list|(
literal|"sc_go: user address is not supported"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|MACH_IS_CACHED
argument_list|(
name|scdp
operator|->
name|scd_vaddr
argument_list|)
condition|)
name|MachFlushDCache
argument_list|(
name|scdp
operator|->
name|scd_vaddr
argument_list|,
name|scdp
operator|->
name|scd_count
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|MACH_IS_MAPPED
argument_list|(
name|scdp
operator|->
name|scd_vaddr
argument_list|)
condition|)
ifdef|#
directive|ifdef
name|notyet
comment|/* KU:XXX */
name|clean_k2dcache
argument_list|(
name|scdp
operator|->
name|scd_vaddr
argument_list|,
name|scdp
operator|->
name|scd_count
argument_list|)
expr_stmt|;
else|#
directive|else
name|MachFlushCache
argument_list|()
expr_stmt|;
comment|/* Flush all caches */
endif|#
directive|endif
endif|#
directive|endif
comment|/* mips */
block|}
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_macro
name|_sc_go
argument_list|(
argument|intr
argument_list|,
argument|sc
argument_list|,
argument|ie
argument_list|)
end_macro

begin_decl_stmt
name|int
name|intr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ie
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|s
decl_stmt|;
if|if
condition|(
operator|(
name|ie
operator|&
name|SCSI_INTEN
operator|)
operator|==
literal|0
condition|)
block|{
name|scsend
argument_list|(
name|intr
argument_list|,
name|ie
operator||
name|SCSI_NOTWAIT
argument_list|,
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc_busy
argument_list|(
name|intr
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|splscon
argument_list|()
argument_list|)
expr_stmt|;
comment|/* splsc -1 */
ifdef|#
directive|ifdef
name|mc68030
name|dcia
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
block|}
else|else
block|{
name|scsend
argument_list|(
name|intr
argument_list|,
name|ie
argument_list|,
operator|(
name|caddr_t
operator|)
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CPU_SINGLE */
end_comment

begin_macro
name|screset
argument_list|(
argument|chan
argument_list|)
end_macro

begin_decl_stmt
name|int
name|chan
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|s
decl_stmt|;
name|s
operator|=
name|splsc
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"SCSI: screset() called "
argument_list|)
expr_stmt|;
name|scop_init
argument_list|(
name|chan
operator|/
literal|8
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
for|for
control|(
name|s
operator|=
literal|0
init|;
name|s
operator|<
literal|10
condition|;
name|s
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|100000
operator|*
literal|10
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|iop
comment|/**/
name|reset
parameter_list|()
function_decl|;
block|}
end_block

begin_macro
name|scsisetup
argument_list|(
argument|bp
argument_list|,
argument|map
argument_list|,
argument|nmap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sc_map
modifier|*
name|map
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nmap
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|iop
comment|/**/
name|setup
argument_list|(
name|bp
argument_list|,
name|map
argument_list|,
name|nmap
argument_list|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * transrate skey / ecode into message display ON/OFF value  *	1 : display message  *	0 : silence  */
end_comment

begin_expr_stmt
name|isdispmsg
argument_list|(
name|code
argument_list|,
name|list
argument_list|,
name|count
argument_list|)
specifier|register
name|int
name|code
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|msg_list
modifier|*
name|list
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|msglvl
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|list
operator|->
name|ml_code
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|code
operator|==
name|list
operator|->
name|ml_code
condition|)
block|{
name|msglvl
operator|=
name|list
operator|->
name|ml_msglvl
expr_stmt|;
break|break;
block|}
name|list
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|count
operator|>=
name|msglvl
operator|)
return|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|NO_SHRINK_RSENSE_MSG
end_ifdef

begin_comment
comment|/*  * transrate skey / ecode into message  */
end_comment

begin_function
name|char
modifier|*
name|getmsg
parameter_list|(
name|code
parameter_list|,
name|list
parameter_list|,
name|defmsg
parameter_list|)
name|int
name|code
decl_stmt|;
name|struct
name|msg_list
modifier|*
name|list
decl_stmt|;
name|char
modifier|*
name|defmsg
decl_stmt|;
block|{
while|while
condition|(
name|list
operator|->
name|ml_code
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|code
operator|==
name|list
operator|->
name|ml_code
condition|)
return|return
operator|(
name|list
operator|->
name|ml_msgstr
operator|)
return|;
name|list
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|defmsg
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NO_SHRINK_RSENSE_MSG */
end_comment

begin_expr_stmt
name|check_chan_busy
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|)
specifier|register
name|int
name|intr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|scsi
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|sc_extnd
modifier|*
name|sce
init|=
operator|(
expr|struct
name|sc_extnd
operator|*
operator|)
name|sc
operator|->
name|sc_param
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_istatus
operator|==
name|INST_EP
condition|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|sc_tstatus
condition|)
block|{
case|case
name|TGST_CC
case|:
name|scop_rsense
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|SCSI_INTDIS
argument_list|,
literal|18
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsense_msg_disp
operator|||
name|isdispmsg
argument_list|(
name|sce
operator|->
name|sce_skey
argument_list|,
name|skeylist
argument_list|,
literal|0
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|NO_SHRINK_RSENSE_MSG
if|if
condition|(
name|sce
operator|->
name|sce_advalid
condition|)
block|{
name|printf
argument_list|(
literal|"SCSI%d(block %d): %s (sense key = 0x%x)\n"
argument_list|,
name|intr
argument_list|,
operator|(
name|sce
operator|->
name|sce_infob1
operator|<<
literal|24
operator|)
operator|+
operator|(
name|sce
operator|->
name|sce_infob2
operator|<<
literal|16
operator|)
operator|+
operator|(
name|sce
operator|->
name|sce_infob3
operator|<<
literal|8
operator|)
operator|+
operator|(
name|sce
operator|->
name|sce_infob4
operator|)
argument_list|,
name|getmsg
argument_list|(
name|sce
operator|->
name|sce_skey
argument_list|,
name|skeylist
argument_list|,
literal|"(reserved)"
argument_list|)
argument_list|,
name|sce
operator|->
name|sce_skey
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"SCSI%d(unknown block): %s (sense key = 0x%x)\n"
argument_list|,
name|intr
argument_list|,
name|getmsg
argument_list|(
name|sce
operator|->
name|sce_skey
argument_list|,
name|skeylist
argument_list|,
literal|"(reserved)"
argument_list|)
argument_list|,
name|sce
operator|->
name|sce_skey
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* NO_SHRINK_RSENSE_MSG */
if|if
condition|(
name|sce
operator|->
name|sce_advalid
condition|)
block|{
name|printf
argument_list|(
literal|"SCSI%d(sn %d): skey=0x%x)\n"
argument_list|,
name|intr
argument_list|,
operator|(
name|sce
operator|->
name|sce_infob1
operator|<<
literal|24
operator|)
operator|+
operator|(
name|sce
operator|->
name|sce_infob2
operator|<<
literal|16
operator|)
operator|+
operator|(
name|sce
operator|->
name|sce_infob3
operator|<<
literal|8
operator|)
operator|+
operator|(
name|sce
operator|->
name|sce_infob4
operator|)
argument_list|,
name|sce
operator|->
name|sce_skey
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"SCSI%d: skey=0x%x)\n"
argument_list|,
name|intr
argument_list|,
name|sce
operator|->
name|sce_skey
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* NO_SHRINK_RSENSE_MSG */
name|printf
argument_list|(
literal|"sense data = "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|18
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%x "
argument_list|,
name|sc
operator|->
name|sc_param
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TGST_GOOD
case|:
break|break;
default|default:
name|printf
argument_list|(
literal|"SCSI%d: bad target status 0x%x\n"
argument_list|,
name|intr
argument_list|,
name|sc
operator|->
name|sc_tstatus
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"SCSI%d: bad initiator status 0x%x\n"
argument_list|,
name|intr
argument_list|,
name|sc
operator|->
name|sc_istatus
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|i
operator|++
operator|<
literal|100000
condition|)
block|{
name|scop_tst
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
name|slave
argument_list|,
name|SCSI_INTDIS
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_tstatus
operator|!=
name|TGST_BUSY
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>
literal|100000
condition|)
name|printf
argument_list|(
literal|"SCSI%d: still busy after rasblk.\n"
argument_list|,
name|intr
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/***/
end_comment

begin_struct
struct|struct
name|scsi_berr_bug_table
block|{
name|int
name|model
decl_stmt|;
name|int
name|serial_l
decl_stmt|;
name|int
name|serial_h
decl_stmt|;
name|int
name|value
decl_stmt|;
comment|/* 1:BUG, 0:NOBUG */
block|}
struct|;
end_struct

begin_comment
comment|/***/
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Sony Corp. and Kazumasa Utashiro of Software Research Associates, Inc.  *  * %sccs.include.redist.c%  *  * from: $Hdr: fb_probe.c,v 4.300 91/06/09 06:32:57 root Rel41 $ SONY  *  *	@(#)fb_probe.c	7.3 (Berkeley) %G%  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_include
include|#
directive|include
file|"../../iop/framebuf.h"
end_include

begin_include
include|#
directive|include
file|"types.h"
end_include

begin_include
include|#
directive|include
file|"exec.h"
end_include

begin_include
include|#
directive|include
file|"romsw.h"
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<news3400/iop/framebuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/exec.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<news3400/fb/fbdefs.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_define
define|#
directive|define
name|SW_CONSOLE
value|0x07
end_define

begin_define
define|#
directive|define
name|SW_NWB512
value|0x04
end_define

begin_define
define|#
directive|define
name|SW_NWB225
value|0x01
end_define

begin_define
define|#
directive|define
name|SW_FBPOP
value|0x02
end_define

begin_define
define|#
directive|define
name|SW_FBPOP1
value|0x06
end_define

begin_define
define|#
directive|define
name|SW_FBPOP2
value|0x03
end_define

begin_define
define|#
directive|define
name|SW_AUTOSEL
value|0x07
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|consfb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nfbdev
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|cons_dev
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|fbdevsw
name|fbdevsw
index|[]
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|news3400
end_ifdef

begin_decl_stmt
name|struct
name|autodev
name|autodev
index|[]
init|=
block|{
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb8600000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb8610000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb8620000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb8630000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb8640000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb8650000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb8660000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb8670000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb8680000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb8690000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb86a0000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb86b0000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb86c0000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb86d0000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb86e0000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xb86f0000
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AUTOSEL
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* news3400 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|news3800
end_ifdef

begin_decl_stmt
name|struct
name|autodev
name|autodev
index|[]
init|=
block|{
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee600000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee610000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee620000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee630000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee640000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee650000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee660000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee670000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee680000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee690000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee6a0000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee6b0000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee6c0000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee6d0000
block|,
operator|-
literal|1
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee6e0000
block|,
operator|(
name|char
operator|*
operator|)
literal|0xee6f0000
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AUTOSEL
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* news3800 */
end_comment

begin_macro
name|search_fbdev
argument_list|(
argument|type
argument_list|,
argument|unit
argument_list|)
end_macro

begin_decl_stmt
name|int
name|type
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|unit
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|type
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cons_dev
operator|<
literal|0
condition|)
return|return
operator|(
name|unit
operator|<
name|nfbdev
condition|?
name|unit
else|:
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|unit
operator|==
literal|0
condition|)
return|return
operator|(
name|cons_dev
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfbdev
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|i
operator|!=
name|cons_dev
operator|&&
operator|--
name|unit
operator|==
literal|0
condition|)
return|return
operator|(
name|i
operator|)
return|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfbdev
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|fbdev
index|[
name|i
index|]
operator|.
name|type
operator|==
name|type
operator|&&
name|fbdev
index|[
name|i
index|]
operator|.
name|unit
operator|==
name|unit
condition|)
return|return
operator|(
name|i
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|AUTOSEL
end_ifdef

begin_macro
name|search_autocons
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|!=
operator|-
literal|1
condition|)
return|return
operator|(
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|)
return|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|fb_auto_probe
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|badaddr
argument_list|(
name|autodev
index|[
name|i
index|]
operator|.
name|base
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
operator|-
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|*
operator|(
name|long
operator|*
operator|)
name|autodev
index|[
name|i
index|]
operator|.
name|base
operator|!=
name|OMAGIC
condition|)
block|{
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
switch|switch
condition|(
operator|(
operator|*
operator|(
name|int
operator|*
operator|)
operator|(
name|autodev
index|[
name|i
index|]
operator|.
name|base
operator|+
literal|0x20
operator|)
operator|)
condition|)
block|{
case|case
literal|0
case|:
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
name|FB_NWB514
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
name|FB_NWB251
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
name|FB_NWB518
expr_stmt|;
break|break;
case|case
literal|3
case|:
case|case
literal|8
case|:
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
name|FB_NWB254
expr_stmt|;
break|break;
case|case
literal|4
case|:
case|case
literal|0x10004
case|:
case|case
literal|0x20004
case|:
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
name|FB_NWB257
expr_stmt|;
break|break;
case|case
literal|0x10005
case|:
case|case
literal|0x20005
case|:
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
name|FB_NWB256
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
name|FB_SLB101
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
name|FB_NWB255
expr_stmt|;
break|break;
default|default:
name|autodev
index|[
name|i
index|]
operator|.
name|type
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* AUTOSEL */
end_comment

begin_macro
name|cons_probe
argument_list|(
argument|dipsw
argument_list|)
end_macro

begin_decl_stmt
name|int
name|dipsw
decl_stmt|;
end_decl_stmt

begin_block
block|{
switch|switch
condition|(
name|dipsw
operator|&
name|SW_CONSOLE
condition|)
block|{
case|case
name|SW_NWB225
case|:
name|cons_dev
operator|=
name|search_fbdev
argument_list|(
name|FB_NWB225
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SW_NWB512
case|:
name|cons_dev
operator|=
name|search_fbdev
argument_list|(
name|FB_NWB512
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CPU_SINGLE
case|case
name|SW_FBPOP
case|:
case|case
name|SW_FBPOP1
case|:
case|case
name|SW_FBPOP2
case|:
if|if
condition|(
operator|(
name|cons_dev
operator|=
name|search_fbdev
argument_list|(
name|FB_LCDM
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|cons_dev
operator|=
name|search_fbdev
argument_list|(
name|FB_POPM
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|cons_dev
operator|=
name|search_fbdev
argument_list|(
name|FB_POPC
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|cons_dev
operator|=
name|search_fbdev
argument_list|(
name|FB_NWB252
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|cons_dev
operator|=
name|search_fbdev
argument_list|(
name|FB_NWB253
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
break|break;
break|break;
endif|#
directive|endif
comment|/* CPU_SINGLE */
ifdef|#
directive|ifdef
name|AUTOSEL
case|case
name|SW_AUTOSEL
case|:
name|cons_dev
operator|=
name|search_fbdev
argument_list|(
name|search_autocons
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|cons_dev
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cons_dev
operator|==
operator|-
literal|1
condition|)
name|consfb
operator|=
literal|0
expr_stmt|;
else|else
name|consfb
operator|=
operator|&
name|fbdev
index|[
name|cons_dev
index|]
expr_stmt|;
block|}
end_block

begin_function
name|void
name|fbbm_probe
parameter_list|(
name|dipsw
parameter_list|)
name|int
name|dipsw
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|struct
name|fbdevsw
modifier|*
name|pfsw
init|=
name|fbdevsw
decl_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|AUTOSEL
name|fb_auto_probe
argument_list|()
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
name|pfsw
operator|->
name|num
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pfsw
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fbdev
index|[
name|j
index|]
operator|.
name|type
operator|=
call|(
modifier|*
name|pfsw
operator|->
name|fb_probe
call|)
argument_list|(
name|i
argument_list|,
operator|&
name|fbdev
index|[
name|j
index|]
argument_list|)
condition|)
block|{
name|fbdev
index|[
name|j
index|]
operator|.
name|unit
operator|=
name|i
expr_stmt|;
call|(
modifier|*
name|pfsw
operator|->
name|fb_setup
call|)
argument_list|(
operator|&
name|fbdev
index|[
name|j
index|]
argument_list|,
name|dipsw
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
block|}
name|pfsw
operator|++
expr_stmt|;
block|}
name|nfbdev
operator|=
name|j
expr_stmt|;
name|cons_probe
argument_list|(
name|dipsw
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


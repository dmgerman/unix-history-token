begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Sony Corp. and Kazumasa Utashiro of Software Research Associates, Inc.  *  * %sccs.include.redist.c%  *  * from: $Hdr: cons.c,v 4.300 91/06/09 06:34:41 root Rel41 $ SONY  *  *	@(#)bmcons.c	7.2 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * console driver  */
end_comment

begin_include
include|#
directive|include
file|"../include/fix_machine_type.h"
end_include

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"../include/pte.h"
end_include

begin_include
include|#
directive|include
file|"conf.h"
end_include

begin_include
include|#
directive|include
file|"proc.h"
end_include

begin_include
include|#
directive|include
file|"user.h"
end_include

begin_include
include|#
directive|include
file|"ioctl.h"
end_include

begin_include
include|#
directive|include
file|"tty.h"
end_include

begin_include
include|#
directive|include
file|"map.h"
end_include

begin_include
include|#
directive|include
file|"buf.h"
end_include

begin_include
include|#
directive|include
file|"clist.h"
end_include

begin_include
include|#
directive|include
file|"file.h"
end_include

begin_include
include|#
directive|include
file|"bm.h"
end_include

begin_include
include|#
directive|include
file|"../hbdev/rsreg.h"
end_include

begin_include
include|#
directive|include
file|"../sio/sccparam.h"
end_include

begin_define
define|#
directive|define
name|CN_RXE
value|RXE
end_define

begin_define
define|#
directive|define
name|CN_TXE
value|TXE
end_define

begin_define
define|#
directive|define
name|CN_ON
value|(RXE|TXE|RTS|DTR)
end_define

begin_define
define|#
directive|define
name|CN_OFF
value|0
end_define

begin_define
define|#
directive|define
name|CN_RTS
value|RTS
end_define

begin_define
define|#
directive|define
name|CN_DTR
value|DTR
end_define

begin_define
define|#
directive|define
name|CN_CTS
value|CTS
end_define

begin_define
define|#
directive|define
name|CN_DCD
value|DCD
end_define

begin_define
define|#
directive|define
name|CN_DSR
value|DSR
end_define

begin_define
define|#
directive|define
name|CN_RI
value|RI
end_define

begin_define
define|#
directive|define
name|CN_BRK
value|XBREAK
end_define

begin_comment
comment|/*  * Local variables for the driver  */
end_comment

begin_define
define|#
directive|define
name|splcons
value|spltty
end_define

begin_decl_stmt
name|char
name|cn_active
index|[
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|cn_stopped
index|[
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|tty
name|cn_tty
index|[
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|cnstart
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|ttrstrt
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|cnrint
argument_list|()
decl_stmt|,
name|cnxint
argument_list|()
decl_stmt|,
name|cnsint
argument_list|()
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Open console. Turn on console if this is the first use of it.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|cnopen
argument_list|(
argument|dev
argument_list|,
argument|flag
argument_list|,
argument|mode
argument_list|,
argument|p
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flag
decl_stmt|,
name|mode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
init|=
operator|&
name|cn_tty
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|cn_active
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cn_init
argument_list|()
operator|<
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|cn_enable
argument_list|()
expr_stmt|;
name|cn_active
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|TS_XCLUDE
operator|&&
name|p
operator|->
name|p_ucred
operator|->
name|cr_uid
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|tp
operator|->
name|t_addr
operator|=
operator|(
name|caddr_t
operator|)
literal|0
expr_stmt|;
name|tp
operator|->
name|t_oproc
operator|=
name|cnstart
expr_stmt|;
name|tp
operator|->
name|t_state
operator||=
name|TS_WOPEN
expr_stmt|;
comment|/* 	 * If this is first open, initialze tty state to default. 	 */
if|if
condition|(
operator|(
name|tp
operator|->
name|t_state
operator|&
name|TS_ISOPEN
operator|)
operator|==
literal|0
condition|)
block|{
name|tp
operator|->
name|t_state
operator||=
name|TS_WOPEN
expr_stmt|;
name|ttychars
argument_list|(
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|t_ispeed
operator|==
literal|0
condition|)
block|{
name|tp
operator|->
name|t_iflag
operator|=
name|TTYDEF_IFLAG
expr_stmt|;
name|tp
operator|->
name|t_oflag
operator|=
name|TTYDEF_OFLAG
expr_stmt|;
name|tp
operator|->
name|t_cflag
operator|=
name|TTYDEF_CFLAG
expr_stmt|;
name|tp
operator|->
name|t_lflag
operator|=
name|TTYDEF_LFLAG
expr_stmt|;
name|tp
operator|->
name|t_ispeed
operator|=
name|tp
operator|->
name|t_ospeed
operator|=
name|TTYDEF_SPEED
expr_stmt|;
block|}
name|cnparam
argument_list|(
name|tp
argument_list|,
operator|&
name|tp
operator|->
name|t_termios
argument_list|)
expr_stmt|;
name|ttsetwater
argument_list|(
name|tp
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Wait receiver and status interrupt 	 */
operator|(
name|void
operator|)
name|cnmctl
argument_list|(
name|CN_ON
argument_list|,
name|DMSET
argument_list|)
expr_stmt|;
name|tp
operator|->
name|t_state
operator||=
name|TS_CARR_ON
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_open
operator|)
operator|(
name|dev
operator|,
name|tp
operator|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * Close console.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|cnclose
argument_list|(
argument|dev
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
init|=
operator|&
name|cn_tty
index|[
literal|0
index|]
decl_stmt|;
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_close
operator|)
operator|(
name|tp
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|cnmctl
argument_list|(
name|CN_BRK
argument_list|,
name|DMBIC
argument_list|)
expr_stmt|;
name|ttyclose
argument_list|(
name|tp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|cnread
argument_list|(
argument|dev
argument_list|,
argument|uio
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
init|=
operator|&
name|cn_tty
index|[
literal|0
index|]
decl_stmt|;
return|return
operator|(
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_read
operator|)
operator|(
name|tp
operator|,
name|uio
operator|,
name|flag
operator|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|cnwrite
argument_list|(
argument|dev
argument_list|,
argument|uio
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
init|=
operator|&
name|cn_tty
index|[
literal|0
index|]
decl_stmt|;
return|return
operator|(
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_write
operator|)
operator|(
name|tp
operator|,
name|uio
operator|,
name|flag
operator|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * console receiver interrupt.  */
end_comment

begin_expr_stmt
name|_cnrint
argument_list|(
name|buf
argument_list|,
name|n
argument_list|)
specifier|register
name|char
operator|*
name|buf
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
init|=
operator|&
name|cn_tty
index|[
literal|0
index|]
decl_stmt|;
specifier|register
name|int
function_decl|(
modifier|*
name|rint
function_decl|)
parameter_list|()
function_decl|;
if|if
condition|(
operator|(
name|tp
operator|->
name|t_state
operator|&
name|TS_ISOPEN
operator|)
operator|==
literal|0
condition|)
block|{
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|tp
operator|->
name|t_rawq
argument_list|)
expr_stmt|;
name|cn_enable
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* 	 * Loop fetching characters from the silo for console 	 * until there are no more in the silo. 	 */
name|rint
operator|=
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_rint
expr_stmt|;
while|while
condition|(
operator|--
name|n
operator|>=
literal|0
condition|)
call|(
modifier|*
name|rint
call|)
argument_list|(
operator|*
name|buf
operator|++
argument_list|,
name|tp
argument_list|)
expr_stmt|;
name|cn_enable
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Ioctl for console.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|cnioctl
argument_list|(
argument|dev
argument_list|,
argument|cmd
argument_list|,
argument|data
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
init|=
operator|&
name|cn_tty
index|[
literal|0
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_ioctl
operator|)
operator|(
name|tp
operator|,
name|cmd
operator|,
name|data
operator|,
name|flag
operator|)
expr_stmt|;
if|if
condition|(
name|error
operator|>=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|ttioctl
argument_list|(
name|tp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|,
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|>=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|TIOCSBRK
case|:
operator|(
name|void
operator|)
name|cnmctl
argument_list|(
name|CN_BRK
argument_list|,
name|DMBIS
argument_list|)
expr_stmt|;
break|break;
case|case
name|TIOCCBRK
case|:
operator|(
name|void
operator|)
name|cnmctl
argument_list|(
name|CN_BRK
argument_list|,
name|DMBIC
argument_list|)
expr_stmt|;
break|break;
case|case
name|TIOCSDTR
case|:
operator|(
name|void
operator|)
name|cnmctl
argument_list|(
name|CN_DTR
operator||
name|CN_RTS
argument_list|,
name|DMBIS
argument_list|)
expr_stmt|;
break|break;
case|case
name|TIOCCDTR
case|:
operator|(
name|void
operator|)
name|cnmctl
argument_list|(
name|CN_DTR
operator||
name|CN_RTS
argument_list|,
name|DMBIC
argument_list|)
expr_stmt|;
break|break;
case|case
name|TIOCMSET
case|:
operator|(
name|void
operator|)
name|cnmctl
argument_list|(
name|dmtocn
argument_list|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
argument_list|)
argument_list|,
name|DMSET
argument_list|)
expr_stmt|;
break|break;
case|case
name|TIOCMBIS
case|:
operator|(
name|void
operator|)
name|cnmctl
argument_list|(
name|dmtocn
argument_list|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
argument_list|)
argument_list|,
name|DMBIS
argument_list|)
expr_stmt|;
break|break;
case|case
name|TIOCMBIC
case|:
operator|(
name|void
operator|)
name|cnmctl
argument_list|(
name|dmtocn
argument_list|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
argument_list|)
argument_list|,
name|DMBIC
argument_list|)
expr_stmt|;
break|break;
case|case
name|TIOCMGET
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|cntodm
argument_list|(
name|cnmctl
argument_list|(
literal|0
argument_list|,
name|DMGET
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENOTTY
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|dmtocn
argument_list|(
name|bits
argument_list|)
specifier|register
name|int
name|bits
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|b
decl_stmt|;
name|b
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|DML_LE
condition|)
name|b
operator||=
name|CN_TXE
operator||
name|CN_RXE
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|DML_DTR
condition|)
name|b
operator||=
name|CN_DTR
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|DML_RTS
condition|)
name|b
operator||=
name|CN_RTS
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|DML_CTS
condition|)
name|b
operator||=
name|CN_CTS
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|DML_CAR
condition|)
name|b
operator||=
name|CN_DCD
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|DML_RNG
condition|)
name|b
operator||=
name|CN_RI
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|DML_DSR
condition|)
name|b
operator||=
name|CN_DSR
expr_stmt|;
return|return
operator|(
name|b
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|cntodm
argument_list|(
name|bits
argument_list|)
specifier|register
name|int
name|bits
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|b
decl_stmt|;
name|b
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bits
operator|&
operator|(
name|CN_TXE
operator||
name|CN_RXE
operator|)
condition|)
name|b
operator||=
name|DML_LE
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|CN_DTR
condition|)
name|b
operator||=
name|DML_DTR
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|CN_RTS
condition|)
name|b
operator||=
name|DML_RTS
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|CN_CTS
condition|)
name|b
operator||=
name|DML_CTS
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|CN_DCD
condition|)
name|b
operator||=
name|DML_CAR
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|CN_RI
condition|)
name|b
operator||=
name|DML_RNG
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|CN_DSR
condition|)
name|b
operator||=
name|DML_DSR
expr_stmt|;
return|return
operator|(
name|b
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * Set parameters from open or stty into the console hardware  * registers.  */
end_comment

begin_expr_stmt
name|cnparam
argument_list|(
name|tp
argument_list|,
name|t
argument_list|)
specifier|register
expr|struct
name|tty
operator|*
name|tp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|termios
modifier|*
name|t
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|param
decl_stmt|;
specifier|register
name|int
name|cflag
init|=
name|t
operator|->
name|c_cflag
decl_stmt|;
name|int
name|s
decl_stmt|;
comment|/* 	 * Block interrupts so parameters will be set 	 * before the line interrupts. 	 */
name|s
operator|=
name|splcons
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|tp
operator|->
name|t_ispeed
operator|)
operator|==
literal|0
condition|)
block|{
name|tp
operator|->
name|t_cflag
operator||=
name|HUPCL
expr_stmt|;
operator|(
name|void
operator|)
name|cnmctl
argument_list|(
name|CN_OFF
argument_list|,
name|DMSET
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|param
operator|=
name|cn_get_param
argument_list|()
operator|&
operator|~
operator|(
name|CHAR_SIZE
operator||
name|PARITY
operator||
name|EVEN
operator||
name|STOPBIT
operator||
name|BAUD_RATE
operator||
name|NOCHECK
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|cflag
operator|&
name|CREAD
operator|)
operator|==
literal|0
condition|)
name|param
operator|&=
operator|~
name|RXE
expr_stmt|;
switch|switch
condition|(
name|cflag
operator|&
name|CSIZE
condition|)
block|{
case|case
name|CS5
case|:
break|break;
case|case
name|CS6
case|:
name|param
operator||=
name|C6BIT
expr_stmt|;
break|break;
case|case
name|CS7
case|:
name|param
operator||=
name|C7BIT
expr_stmt|;
break|break;
case|case
name|CS8
case|:
name|param
operator||=
name|C8BIT
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cflag
operator|&
name|PARENB
condition|)
name|param
operator||=
name|PARITY
expr_stmt|;
if|if
condition|(
operator|(
name|cflag
operator|&
name|PARODD
operator|)
operator|==
literal|0
condition|)
name|param
operator||=
name|EVEN
expr_stmt|;
if|if
condition|(
operator|(
name|tp
operator|->
name|t_iflag
operator|&
name|INPCK
operator|)
operator|==
literal|0
condition|)
name|param
operator||=
name|NOCHECK
expr_stmt|;
if|if
condition|(
name|cflag
operator|&
name|CSTOPB
condition|)
name|param
operator||=
name|STOP2
expr_stmt|;
else|else
name|param
operator||=
name|STOP1
expr_stmt|;
name|cn_set_param
argument_list|(
name|param
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * console transmitter interrupt.  * Restart the idle line.  */
end_comment

begin_macro
name|_cnxint
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
init|=
operator|&
name|cn_tty
index|[
literal|0
index|]
decl_stmt|;
name|int
name|s
decl_stmt|;
name|cn_stopped
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|tp
operator|->
name|t_state
operator|&=
operator|~
name|TS_BUSY
expr_stmt|;
name|s
operator|=
name|splcons
argument_list|()
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|TS_FLUSH
condition|)
name|tp
operator|->
name|t_state
operator|&=
operator|~
name|TS_FLUSH
expr_stmt|;
else|else
name|ndflush
argument_list|(
operator|&
name|tp
operator|->
name|t_outq
argument_list|,
name|count
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|t_line
condition|)
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_start
operator|)
operator|(
name|tp
operator|)
expr_stmt|;
else|else
name|cnstart
argument_list|(
name|tp
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Start (restart) transmission on the console.  */
end_comment

begin_function
name|void
name|cnstart
parameter_list|(
name|tp
parameter_list|)
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
block|{
specifier|register
name|int
name|nch
decl_stmt|;
name|int
name|s
decl_stmt|;
comment|/* 	 * Must hold interrupts in following code to prevent 	 * state of the tp from changing. 	 */
name|s
operator|=
name|splcons
argument_list|()
expr_stmt|;
comment|/* 	 * If it's currently active, or delaying, no need to do anything. 	 */
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
operator|(
name|TS_TIMEOUT
operator||
name|TS_BUSY
operator||
name|TS_TTSTOP
operator|)
condition|)
goto|goto
name|out
goto|;
comment|/* 	 * If ther are still characters in the IOP, 	 * just reenable transmit. 	 */
if|if
condition|(
name|cn_stopped
index|[
literal|0
index|]
condition|)
block|{
name|cn_stopped
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|cn_start
argument_list|()
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * If there are sleepers, and output has drained below low 	 * water mark, wake up the sleepers. 	 */
if|if
condition|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|<=
name|tp
operator|->
name|t_lowat
condition|)
block|{
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|TS_ASLEEP
condition|)
block|{
name|tp
operator|->
name|t_state
operator|&=
operator|~
name|TS_ASLEEP
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|tp
operator|->
name|t_outq
argument_list|)
expr_stmt|;
block|}
name|selwakeup
argument_list|(
operator|&
name|tp
operator|->
name|t_wsel
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Now restart transmission unless the output queue is 	 * empty. 	 */
if|if
condition|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|==
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|tp
operator|->
name|t_flags
operator|&
operator|(
name|RAW
operator||
name|LITOUT
operator|)
condition|)
name|nch
operator|=
name|ndqb
argument_list|(
operator|&
name|tp
operator|->
name|t_outq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|nch
operator|=
name|ndqb
argument_list|(
operator|&
name|tp
operator|->
name|t_outq
argument_list|,
literal|0200
argument_list|)
expr_stmt|;
comment|/* 		 * If first thing on queue is a delay process it. 		 */
if|if
condition|(
name|nch
operator|==
literal|0
condition|)
block|{
name|nch
operator|=
name|getc
argument_list|(
operator|&
name|tp
operator|->
name|t_outq
argument_list|)
expr_stmt|;
name|timeout
argument_list|(
name|ttrstrt
argument_list|,
operator|(
name|caddr_t
operator|)
name|tp
argument_list|,
operator|(
name|nch
operator|&
literal|0x7f
operator|)
operator|+
literal|6
argument_list|)
expr_stmt|;
name|tp
operator|->
name|t_state
operator||=
name|TS_TIMEOUT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
comment|/* 	 * If characters to transmit, restart transmission. 	 */
if|if
condition|(
name|nch
condition|)
block|{
name|tp
operator|->
name|t_state
operator||=
name|TS_BUSY
expr_stmt|;
name|cn_output
argument_list|(
name|tp
argument_list|,
name|nch
argument_list|)
expr_stmt|;
block|}
name|out
label|:
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Stop output on a line, e.g. for ^S/^Q or output flush.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_expr_stmt
name|cnstop
argument_list|(
name|tp
argument_list|,
name|flag
argument_list|)
specifier|register
expr|struct
name|tty
operator|*
name|tp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|s
decl_stmt|;
comment|/* 	 * Block input/output interrupts while messing with state. 	 */
name|s
operator|=
name|splcons
argument_list|()
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|TS_BUSY
condition|)
block|{
name|cn_stop
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|cn_stopped
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|tp
operator|->
name|t_state
operator|&
name|TS_TTSTOP
operator|)
operator|==
literal|0
condition|)
block|{
name|tp
operator|->
name|t_state
operator||=
name|TS_FLUSH
expr_stmt|;
name|cn_stop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * console modem control  */
end_comment

begin_macro
name|cnmctl
argument_list|(
argument|bits
argument_list|,
argument|how
argument_list|)
end_macro

begin_decl_stmt
name|int
name|bits
decl_stmt|,
name|how
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|mbits
decl_stmt|;
name|int
name|s
decl_stmt|;
name|bits
operator|&=
operator|(
name|RXE
operator||
name|TXE
operator||
name|RTS
operator||
name|DTR
operator||
name|XBREAK
operator|)
expr_stmt|;
name|s
operator|=
name|splcons
argument_list|()
expr_stmt|;
name|mbits
operator|=
name|cn_get_param
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|how
condition|)
block|{
case|case
name|DMSET
case|:
name|mbits
operator|=
name|mbits
operator|&
operator|~
operator|(
name|RXE
operator||
name|TXE
operator||
name|RTS
operator||
name|DTR
operator||
name|XBREAK
operator|)
operator||
name|bits
expr_stmt|;
break|break;
case|case
name|DMBIS
case|:
name|mbits
operator||=
name|bits
expr_stmt|;
break|break;
case|case
name|DMBIC
case|:
name|mbits
operator|&=
operator|~
name|bits
expr_stmt|;
break|break;
case|case
name|DMGET
case|:
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|mbits
operator|)
return|;
block|}
name|cn_set_param
argument_list|(
name|mbits
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|mbits
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * console status interrupt  */
end_comment

begin_macro
name|_cnsint
argument_list|(
argument|stat
argument_list|)
end_macro

begin_decl_stmt
name|int
name|stat
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
init|=
operator|&
name|cn_tty
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|stat
operator|&
name|OVERRUN_ERROR
condition|)
name|printf
argument_list|(
literal|"console: fifo overflow\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
operator|&
name|RBREAK
condition|)
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_rint
operator|)
operator|(
name|tp
operator|->
name|t_flags
operator|&
name|RAW
condition|?
literal|'\0'
else|:
name|tp
operator|->
name|t_cc
index|[
name|VINTR
index|]
operator|,
name|tp
operator|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * console control interrupt  */
end_comment

begin_macro
name|cncint
argument_list|()
end_macro

begin_block
block|{
name|printf
argument_list|(
literal|"cncint:\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Machine dependent functions  *  *	cn_init()  *	cnrint()  *	cnxint()  *	cnsint()  *	cn_enable()  *	cn_output()  *	cn_start()  *	cn_stop()  *	cn_get_param()  *	cn_set_param()  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_include
include|#
directive|include
file|"../newsipc/newsipc.h"
end_include

begin_include
include|#
directive|include
file|"../mrx/h/cio.h"
end_include

begin_include
include|#
directive|include
file|"../mrx/h/console.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|mips
end_ifdef

begin_define
define|#
directive|define
name|ipc_phys
parameter_list|(
name|x
parameter_list|)
value|K0_TT0(x)
end_define

begin_define
define|#
directive|define
name|ipc_log
parameter_list|(
name|x
parameter_list|)
value|TT0_K0(x)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|ipc_phys
parameter_list|(
name|x
parameter_list|)
value|(caddr_t)((int)(x)& ~0x80000000)
end_define

begin_define
define|#
directive|define
name|ipc_log
parameter_list|(
name|x
parameter_list|)
value|(caddr_t)((int)(x) | 0x80000000)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|NBM
operator|>
literal|0
end_if

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|ext_fnt_addr
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|ext_fnt24_addr
index|[]
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NBM> 0 */
end_comment

begin_decl_stmt
name|int
name|port_cnrecv
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|port_cnxmit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|port_cnstat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|port_cnctrl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|port_cnfont
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|port_cnrecv_iop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|port_cnxmit_iop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|port_cnstat_iop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|port_cnctrl_iop
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|cnfont
parameter_list|()
function_decl|;
end_function_decl

begin_macro
name|cn_init
argument_list|()
end_macro

begin_block
block|{
name|struct
name|cons_ctrl_req
name|req
decl_stmt|;
name|int
modifier|*
name|reply
decl_stmt|;
name|port_cnrecv
operator|=
name|port_create
argument_list|(
literal|"@cnrecv"
argument_list|,
name|cnrint
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|port_cnxmit
operator|=
name|port_create
argument_list|(
literal|"@cnxmit"
argument_list|,
name|cnxint
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|port_cnctrl
operator|=
name|port_create
argument_list|(
literal|"@cnctrl"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|port_cnstat
operator|=
name|port_create
argument_list|(
literal|"@cnstat"
argument_list|,
name|cnsint
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|port_cnfont
operator|=
name|port_create
argument_list|(
literal|"@cnfont"
argument_list|,
name|cnfont
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* use NULL action port */
name|port_cnrecv_iop
operator|=
name|object_query
argument_list|(
literal|"cons_input"
argument_list|)
expr_stmt|;
name|port_cnxmit_iop
operator|=
name|object_query
argument_list|(
literal|"cons_output"
argument_list|)
expr_stmt|;
name|port_cnctrl_iop
operator|=
name|object_query
argument_list|(
literal|"cons_ctrl"
argument_list|)
expr_stmt|;
name|port_cnstat_iop
operator|=
name|object_query
argument_list|(
literal|"cons_stat"
argument_list|)
expr_stmt|;
name|req
operator|.
name|cons_func
operator|=
name|CIO_ASKDEVICE
expr_stmt|;
name|msg_send
argument_list|(
name|port_cnctrl_iop
argument_list|,
name|port_cnctrl
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msg_recv
argument_list|(
name|port_cnctrl
argument_list|,
name|NULL
argument_list|,
operator|&
name|reply
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tty00_is_console
operator|=
operator|*
name|reply
expr_stmt|;
name|msg_free
argument_list|(
name|port_cnctrl
argument_list|)
expr_stmt|;
if|#
directive|if
name|NBM
operator|>
literal|0
name|req
operator|.
name|cons_func
operator|=
name|CIO_SET16FNT
expr_stmt|;
name|req
operator|.
name|cons_addr
operator|=
operator|(
name|char
operator|*
operator|)
name|ipc_phys
argument_list|(
name|ext_fnt_addr
argument_list|)
expr_stmt|;
name|msg_send
argument_list|(
name|port_cnctrl_iop
argument_list|,
name|port_cnctrl
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msg_recv
argument_list|(
name|port_cnctrl
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|cons_func
operator|=
name|CIO_SET24FNT
expr_stmt|;
name|req
operator|.
name|cons_addr
operator|=
operator|(
name|char
operator|*
operator|)
name|ipc_phys
argument_list|(
name|ext_fnt24_addr
argument_list|)
expr_stmt|;
name|msg_send
argument_list|(
name|port_cnctrl_iop
argument_list|,
name|port_cnctrl
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msg_recv
argument_list|(
name|port_cnctrl
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|cn_enable
argument_list|()
end_macro

begin_block
block|{
name|int
name|len
decl_stmt|;
name|len
operator|=
name|MAX_CIO
expr_stmt|;
name|msg_send
argument_list|(
name|port_cnrecv_iop
argument_list|,
name|port_cnrecv
argument_list|,
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|len
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cnrint
argument_list|(
argument|port
argument_list|)
end_macro

begin_decl_stmt
name|int
name|port
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|len
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|msg_recv
argument_list|(
name|port
argument_list|,
name|NULL
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|mips
name|_cnrint
argument_list|(
operator|(
name|char
operator|*
operator|)
name|MACH_CACHED_TO_UNCACHED
argument_list|(
name|buf
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|#
directive|else
name|dcia
argument_list|()
expr_stmt|;
name|_cnrint
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|msg_free
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cnxint
argument_list|(
argument|port
argument_list|)
end_macro

begin_decl_stmt
name|int
name|port
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
modifier|*
name|len
decl_stmt|;
name|msg_recv
argument_list|(
name|port
argument_list|,
name|NULL
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_cnxint
argument_list|(
operator|*
name|len
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cn_start
argument_list|()
end_macro

begin_block
block|{
name|int
name|func
decl_stmt|;
name|func
operator|=
name|CIO_START
expr_stmt|;
name|msg_send
argument_list|(
name|port_cnctrl_iop
argument_list|,
literal|0
argument_list|,
operator|&
name|func
argument_list|,
sizeof|sizeof
argument_list|(
name|func
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cn_output
argument_list|(
argument|tp
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|msg_send
argument_list|(
name|port_cnxmit_iop
argument_list|,
name|port_cnxmit
argument_list|,
name|tp
operator|->
name|t_outq
operator|.
name|c_cf
argument_list|,
name|min
argument_list|(
name|n
argument_list|,
name|MAX_CIO
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cn_stop
argument_list|(
argument|flush
argument_list|)
end_macro

begin_decl_stmt
name|int
name|flush
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|func
decl_stmt|;
name|func
operator|=
name|flush
condition|?
name|CIO_FLUSH
else|:
name|CIO_STOP
expr_stmt|;
name|msg_send
argument_list|(
name|port_cnctrl_iop
argument_list|,
literal|0
argument_list|,
operator|&
name|func
argument_list|,
sizeof|sizeof
argument_list|(
name|func
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cnsint
argument_list|(
argument|port
argument_list|)
end_macro

begin_decl_stmt
name|int
name|port
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
modifier|*
name|stat
decl_stmt|;
name|msg_recv
argument_list|(
name|port
argument_list|,
name|NULL
argument_list|,
operator|&
name|stat
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_cnsint
argument_list|(
operator|*
name|stat
argument_list|)
expr_stmt|;
name|msg_send
argument_list|(
name|port_cnstat_iop
argument_list|,
name|port_cnstat
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cn_get_param
argument_list|()
end_macro

begin_block
block|{
name|struct
name|cons_ctrl_req
name|req
decl_stmt|;
name|int
modifier|*
name|reply
decl_stmt|,
name|param
decl_stmt|;
name|req
operator|.
name|cons_func
operator|=
name|CIO_GETPARAMS
expr_stmt|;
comment|/* message length 8 means 2 * sizeof(int) : func and status */
name|msg_send
argument_list|(
name|port_cnctrl_iop
argument_list|,
name|port_cnctrl
argument_list|,
operator|&
name|req
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msg_recv
argument_list|(
name|port_cnctrl
argument_list|,
name|NULL
argument_list|,
operator|&
name|reply
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|param
operator|=
operator|*
name|reply
expr_stmt|;
name|msg_free
argument_list|(
name|port_cnctrl
argument_list|)
expr_stmt|;
return|return
operator|(
name|param
operator|)
return|;
block|}
end_block

begin_macro
name|cn_set_param
argument_list|(
argument|param
argument_list|)
end_macro

begin_decl_stmt
name|int
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|cons_ctrl_req
name|req
decl_stmt|;
name|req
operator|.
name|cons_func
operator|=
name|CIO_SETPARAMS
expr_stmt|;
name|req
operator|.
name|cons_status
operator|=
name|param
expr_stmt|;
comment|/* message length 8 means 2 * sizeof(int) : func and status */
name|msg_send
argument_list|(
name|port_cnctrl_iop
argument_list|,
literal|0
argument_list|,
operator|&
name|req
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cnfont
argument_list|(
argument|port
argument_list|)
end_macro

begin_decl_stmt
name|int
name|port
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
modifier|*
name|func
decl_stmt|;
name|msg_recv
argument_list|(
name|port
argument_list|,
name|NULL
argument_list|,
operator|&
name|func
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|#
directive|if
name|NBM
operator|>
literal|0
switch|switch
condition|(
operator|*
name|func
condition|)
block|{
case|case
name|FONT_JISROMAN
case|:
name|font_jisroman
argument_list|()
expr_stmt|;
name|font_jisroman24
argument_list|()
expr_stmt|;
break|break;
case|case
name|FONT_ASCII
case|:
name|font_ascii
argument_list|()
expr_stmt|;
name|font_ascii24
argument_list|()
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* NBM> 0 */
name|msg_free
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IPC_MRX */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_include
include|#
directive|include
file|"../hbdev/rsreg.h"
end_include

begin_include
include|#
directive|include
file|"../iop/framebuf.h"
end_include

begin_include
include|#
directive|include
file|"../fb/fbdefs.h"
end_include

begin_decl_stmt
name|int
name|lastcount
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|start_dimmer
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_macro
name|cn_init
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|start_dimmer
condition|)
block|{
name|auto_dimmer
argument_list|()
expr_stmt|;
name|start_dimmer
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|cn_enable
argument_list|()
end_macro

begin_block
block|{
comment|/* nothing to do */
block|}
end_block

begin_macro
name|cnrint
argument_list|(
argument|code
argument_list|)
end_macro

begin_decl_stmt
name|char
name|code
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|_cnrint
argument_list|(
operator|&
name|code
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cnxint
argument_list|()
end_macro

begin_block
block|{
name|_cnxint
argument_list|(
name|lastcount
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cn_start
argument_list|()
end_macro

begin_block
block|{
comment|/* nothing to do */
block|}
end_block

begin_macro
name|cn_output
argument_list|(
argument|tp
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lastcount
operator|=
name|vt100_write
argument_list|(
literal|0
argument_list|,
name|tp
operator|->
name|t_outq
operator|.
name|c_cf
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|cnxint
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|cn_stop
argument_list|(
argument|flush
argument_list|)
end_macro

begin_decl_stmt
name|int
name|flush
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* nothing to do */
block|}
end_block

begin_macro
name|cnsint
argument_list|(
argument|param
argument_list|)
end_macro

begin_decl_stmt
name|int
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|_cnsint
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cn_get_param
argument_list|()
end_macro

begin_block
block|{
return|return
operator|(
name|bitmap_get_param
argument_list|()
operator|)
return|;
block|}
end_block

begin_macro
name|cn_set_param
argument_list|(
argument|param
argument_list|)
end_macro

begin_decl_stmt
name|int
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|bitmap_set_param
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CPU_SINGLE */
end_comment

end_unit


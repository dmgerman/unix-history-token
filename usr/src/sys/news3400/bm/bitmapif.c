begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, 1993  *	The Regents of the University of California.  All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Sony Corp. and Kazumasa Utashiro of Software Research Associates, Inc.  *  * %sccs.include.redist.c%  *  * from: $Hdr: bitmapif.c,v 4.300 91/06/09 06:14:40 root Rel41 $ SONY  *  *	@(#)bitmapif.c	8.1 (Berkeley) %G%  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iop/framebuf.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iop/fbreg.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iop/framebuf.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iop/fbreg.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<news3400/fb/fbdefs.h>
end_include

begin_include
include|#
directive|include
file|<news3400/bm/vt100.h>
end_include

begin_include
include|#
directive|include
file|<news3400/bm/bitmapif.h>
end_include

begin_decl_stmt
specifier|extern
name|int
name|bm_todo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|tmode
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|ext_fnt_addr
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|ext_fnt24_addr
index|[]
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CPU_SINGLE */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|ext_fnt_addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|ext_fnt24_addr
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|lock_bitmap
parameter_list|()
end_define

begin_define
define|#
directive|define
name|unlock_bitmap
parameter_list|()
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CPU_SINGLE */
end_comment

begin_decl_stmt
specifier|extern
name|SCREEN
name|screen
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|bitmap_use
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_define
define|#
directive|define
name|PRE_EMPT
value|need_resched()
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|PRE_EMPT
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|short
name|zero
index|[
literal|32
operator|*
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|csr_buf
name|local_csr_buf
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_decl_stmt
name|struct
name|fb_map
name|rommap
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_macro
name|bitmapinit
argument_list|()
end_macro

begin_block
block|{
name|fbbm_rop_reset
argument_list|(
name|consfb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|consfb
operator|->
name|Mono
condition|)
block|{
name|lock_bitmap
argument_list|()
expr_stmt|;
name|fbbm_init_palette
argument_list|(
name|consfb
argument_list|)
expr_stmt|;
name|unlock_bitmap
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|bm_pallet_read
argument_list|(
argument|entry
argument_list|)
end_macro

begin_decl_stmt
name|int
name|entry
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPalette
name|lp
decl_stmt|;
name|sPalette
name|palette
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|struct
name|fb_map
name|rommap
decl_stmt|;
endif|#
directive|endif
name|lock_bitmap
argument_list|()
expr_stmt|;
name|lp
operator|.
name|count
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|lp
operator|.
name|palette
operator|=
operator|(
name|sPalette
operator|*
operator|)
operator|&
name|rommap
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|palette
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|lp
operator|.
name|palette
operator|=
operator|&
name|palette
expr_stmt|;
endif|#
directive|endif
name|palette
operator|.
name|index
operator|=
name|entry
expr_stmt|;
name|fbbm_get_palette
argument_list|(
name|consfb
argument_list|,
operator|&
name|lp
argument_list|)
expr_stmt|;
name|unlock_bitmap
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|palette
operator|.
name|rgb
operator|.
name|r
operator|<<
literal|16
operator|)
operator||
operator|(
name|palette
operator|.
name|rgb
operator|.
name|g
operator|<<
literal|8
operator|)
operator||
name|palette
operator|.
name|rgb
operator|.
name|b
operator|)
return|;
block|}
end_block

begin_macro
name|bm_pallet_write
argument_list|(
argument|entry
argument_list|,
argument|val
argument_list|)
end_macro

begin_decl_stmt
name|int
name|entry
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|val
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPalette
name|lp
decl_stmt|;
name|sPalette
name|palette
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|struct
name|fb_map
name|rommap
decl_stmt|;
endif|#
directive|endif
name|lock_bitmap
argument_list|()
expr_stmt|;
name|lp
operator|.
name|count
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|lp
operator|.
name|palette
operator|=
operator|(
name|sPalette
operator|*
operator|)
operator|&
name|rommap
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|palette
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|lp
operator|.
name|palette
operator|=
operator|&
name|palette
expr_stmt|;
endif|#
directive|endif
name|palette
operator|.
name|index
operator|=
name|entry
expr_stmt|;
name|palette
operator|.
name|rgb
operator|.
name|r
operator|=
operator|(
operator|(
name|val
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|palette
operator|.
name|rgb
operator|.
name|g
operator|=
operator|(
operator|(
name|val
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|palette
operator|.
name|rgb
operator|.
name|b
operator|=
operator|(
name|val
operator|&
literal|0xff
operator|)
expr_stmt|;
name|fbbm_set_palette
argument_list|(
name|consfb
argument_list|,
operator|&
name|lp
argument_list|)
expr_stmt|;
name|unlock_bitmap
argument_list|()
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_block

begin_function
name|unsigned
name|sftjis_to_jis
parameter_list|(
name|h
parameter_list|,
name|l
parameter_list|)
specifier|register
name|unsigned
name|int
name|h
decl_stmt|,
name|l
decl_stmt|;
block|{
if|if
condition|(
operator|(
name|h
operator|>=
name|JVR1S
operator|)
operator|&&
operator|(
name|h
operator|<=
name|JVR1E
operator|)
condition|)
name|h
operator|-=
name|JVR1S
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|h
operator|>=
name|JVR2S
operator|)
operator|&&
operator|(
name|h
operator|<=
name|JVR2E
operator|)
condition|)
name|h
operator|=
name|h
operator|-
name|JVR2S
operator|+
literal|0x1f
expr_stmt|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
name|h
operator|<<=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|l
operator|>=
name|JHR1S
operator|)
operator|&&
operator|(
name|l
operator|<=
name|JHR1E
operator|)
condition|)
name|l
operator|-=
name|JHR1S
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|l
operator|>=
name|JHR2S
operator|)
operator|&&
operator|(
name|l
operator|<=
name|JHR2E
operator|)
condition|)
name|l
operator|=
name|l
operator|-
name|JHR2S
operator|+
literal|0x3f
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|l
operator|>=
name|JHR3S
operator|)
operator|&&
operator|(
name|l
operator|<=
name|JHR3E
operator|)
condition|)
block|{
name|l
operator|-=
name|JHR3S
expr_stmt|;
name|h
operator|++
expr_stmt|;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
operator|(
operator|(
name|h
operator|+
literal|0x21
operator|)
operator|<<
literal|8
operator|)
operator|+
name|l
operator|+
literal|0x21
operator|)
return|;
block|}
end_function

begin_macro
name|setropfunc
argument_list|(
argument|func
argument_list|,
argument|transp
argument_list|,
argument|fore
argument_list|,
argument|aux
argument_list|)
end_macro

begin_decl_stmt
name|int
name|func
decl_stmt|,
name|fore
decl_stmt|,
name|aux
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|tmp
index|[
literal|4
index|]
decl_stmt|;
specifier|register
name|int
name|i
init|=
name|consfb
operator|->
name|fbNplane
decl_stmt|;
specifier|register
name|char
modifier|*
name|funcp
init|=
name|consfb
operator|->
name|funcvec
decl_stmt|;
name|consfb
operator|->
name|func
operator|=
name|func
expr_stmt|;
name|consfb
operator|->
name|fore
operator|=
name|fore
expr_stmt|;
name|consfb
operator|->
name|aux
operator|=
name|aux
expr_stmt|;
name|consfb
operator|->
name|trans
operator|=
name|transp
expr_stmt|;
name|tmp
index|[
literal|0
index|]
operator|=
name|TRANS
argument_list|(
name|transp
argument_list|,
operator|(
name|func
operator|&
literal|0x0c
operator|)
operator||
operator|(
name|func
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|1
index|]
operator|=
name|TRANS
argument_list|(
name|transp
argument_list|,
operator|(
name|func
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
name|func
operator|<<
literal|2
operator|)
operator|&
literal|0x0c
operator|)
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|2
index|]
operator|=
name|TRANS
argument_list|(
name|transp
argument_list|,
name|func
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|3
index|]
operator|=
name|TRANS
argument_list|(
name|transp
argument_list|,
operator|(
name|func
operator|<<
literal|2
operator|)
operator|&
literal|0x0c
operator||
name|func
operator|&
literal|3
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
block|{
operator|*
name|funcp
operator|++
operator|=
name|tmp
index|[
operator|(
operator|(
name|fore
operator|&
literal|1
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
name|aux
operator|&
literal|1
operator|)
index|]
expr_stmt|;
name|fore
operator|>>=
literal|1
expr_stmt|;
name|aux
operator|>>=
literal|1
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|move_rect
argument_list|(
argument|src_x
argument_list|,
argument|src_y
argument_list|,
argument|width
argument_list|,
argument|height
argument_list|,
argument|dst_x
argument_list|,
argument|dst_y
argument_list|,
argument|rop
argument_list|)
end_macro

begin_decl_stmt
name|int
name|src_x
decl_stmt|,
name|src_y
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dst_x
decl_stmt|,
name|dst_y
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rop
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lRectangle
name|sr
decl_stmt|;
name|lPoint
name|dp
decl_stmt|;
name|sr
operator|.
name|origin
operator|.
name|x
operator|=
name|src_x
expr_stmt|;
name|sr
operator|.
name|origin
operator|.
name|y
operator|=
name|src_y
expr_stmt|;
name|sr
operator|.
name|extent
operator|.
name|x
operator|=
name|width
expr_stmt|;
name|sr
operator|.
name|extent
operator|.
name|y
operator|=
name|height
expr_stmt|;
name|dp
operator|.
name|x
operator|=
name|dst_x
expr_stmt|;
name|dp
operator|.
name|y
operator|=
name|dst_y
expr_stmt|;
name|lock_bitmap
argument_list|()
expr_stmt|;
name|setropfunc
argument_list|(
name|rop
argument_list|,
literal|0
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fbbm_rop_init
argument_list|(
name|consfb
argument_list|,
name|consfb
operator|->
name|funcvec
argument_list|)
expr_stmt|;
name|fbbm_rop_copy
argument_list|(
name|consfb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dp
argument_list|,
literal|0
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
name|unlock_bitmap
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|clear_rect
argument_list|(
argument|x
argument_list|,
argument|y
argument_list|,
argument|width
argument_list|,
argument|height
argument_list|,
argument|rop
argument_list|,
argument|fore
argument_list|,
argument|aux
argument_list|)
end_macro

begin_decl_stmt
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fore
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|aux
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lRectangle
name|dr
decl_stmt|;
name|dr
operator|.
name|origin
operator|.
name|x
operator|=
name|x
expr_stmt|;
name|dr
operator|.
name|origin
operator|.
name|y
operator|=
name|y
expr_stmt|;
name|dr
operator|.
name|extent
operator|.
name|x
operator|=
name|width
expr_stmt|;
name|dr
operator|.
name|extent
operator|.
name|y
operator|=
name|height
expr_stmt|;
name|lock_bitmap
argument_list|()
expr_stmt|;
name|setropfunc
argument_list|(
name|rop
argument_list|,
literal|0
argument_list|,
name|fore
argument_list|,
name|aux
argument_list|)
expr_stmt|;
name|fbbm_rop_cinit
argument_list|(
name|consfb
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbbm_rop_clear
argument_list|(
name|consfb
argument_list|,
operator|&
name|dr
argument_list|)
expr_stmt|;
name|unlock_bitmap
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|line
argument_list|(
argument|param
argument_list|)
end_macro

begin_decl_stmt
name|short
modifier|*
name|param
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPoint
name|p
index|[
literal|2
index|]
decl_stmt|;
name|lRectangle
name|clip
decl_stmt|;
name|p
index|[
literal|0
index|]
operator|.
name|x
operator|=
name|param
index|[
literal|0
index|]
expr_stmt|;
name|p
index|[
literal|0
index|]
operator|.
name|y
operator|=
name|param
index|[
literal|1
index|]
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|.
name|x
operator|=
name|param
index|[
literal|2
index|]
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|.
name|y
operator|=
name|param
index|[
literal|3
index|]
expr_stmt|;
name|clip
operator|=
name|consfb
operator|->
name|VisRect
expr_stmt|;
name|lock_bitmap
argument_list|()
expr_stmt|;
name|fbbm_rop_vect
argument_list|(
name|consfb
argument_list|,
operator|&
name|clip
argument_list|,
name|param
index|[
literal|4
index|]
operator|&
literal|0xf
argument_list|,
name|fbbm_get_pixel
argument_list|(
name|consfb
argument_list|,
name|param
index|[
literal|5
index|]
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|,
literal|2
argument_list|,
name|p
argument_list|,
name|LINE_SLD
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|unlock_bitmap
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *  cursor on  *  cursor_on(x, y, plane) puts cursor at position (x, y) with color = plane,   *  if cursor sw is off.  *  At the same time the image of cursor position is saved.  */
end_comment

begin_macro
name|cursor_on
argument_list|(
argument|p
argument_list|)
end_macro

begin_decl_stmt
name|lPoint
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|csr_buf
modifier|*
name|csr_bp
init|=
operator|&
name|local_csr_buf
decl_stmt|;
specifier|register
name|lRectangle
modifier|*
name|dr
decl_stmt|;
if|if
condition|(
name|screen
operator|.
name|s_term_mode
operator|&
name|DECCSR_ACTV
operator|&&
name|bm_todo
operator|<=
literal|0
operator|&&
name|csr_bp
operator|->
name|csr_sw
operator|==
name|C_OFF
condition|)
block|{
if|if
condition|(
name|csr_bp
operator|->
name|csr_number
operator|==
literal|2
operator|&&
name|p
operator|->
name|x
operator|!=
name|rit_m
condition|)
name|dr
operator|=
operator|&
name|char_r2
expr_stmt|;
else|else
name|dr
operator|=
operator|&
name|char_r1
expr_stmt|;
name|dr
operator|->
name|origin
operator|=
operator|*
name|p
expr_stmt|;
name|lock_bitmap
argument_list|()
expr_stmt|;
name|setropfunc
argument_list|(
name|BF_DI
argument_list|,
literal|0
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fbbm_rop_init
argument_list|(
name|consfb
argument_list|,
name|consfb
operator|->
name|funcvec
argument_list|)
expr_stmt|;
name|fbbm_rop_copy
argument_list|(
name|consfb
argument_list|,
name|dr
argument_list|,
name|dr
argument_list|,
literal|0
argument_list|,
operator|(
name|fcolor
operator|^
name|bcolor
operator|)
operator|&
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
name|unlock_bitmap
argument_list|()
expr_stmt|;
name|csr_bp
operator|->
name|csr_sw
operator|=
name|C_ON
expr_stmt|;
name|csr_bp
operator|->
name|csr_p
operator|=
operator|*
name|p
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  *  cursor off  *  cursor_off() turns off cursor.  *  The image of cursor position which has previously saved by cursor_on  *  is restored.  */
end_comment

begin_macro
name|cursor_off
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|csr_buf
modifier|*
name|csr_bp
init|=
operator|&
name|local_csr_buf
decl_stmt|;
specifier|register
name|lRectangle
modifier|*
name|dr
decl_stmt|;
if|if
condition|(
name|screen
operator|.
name|s_term_mode
operator|&
name|DECCSR_ACTV
operator|&&
name|csr_bp
operator|->
name|csr_sw
operator|==
name|C_ON
condition|)
block|{
if|if
condition|(
name|csr_bp
operator|->
name|csr_number
operator|==
literal|2
operator|&&
name|csr_bp
operator|->
name|csr_x
operator|!=
name|rit_m
condition|)
name|dr
operator|=
operator|&
name|char_r2
expr_stmt|;
else|else
name|dr
operator|=
operator|&
name|char_r1
expr_stmt|;
name|dr
operator|->
name|origin
operator|=
name|csr_bp
operator|->
name|csr_p
expr_stmt|;
name|lock_bitmap
argument_list|()
expr_stmt|;
name|setropfunc
argument_list|(
name|BF_DI
argument_list|,
literal|0
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fbbm_rop_init
argument_list|(
name|consfb
argument_list|,
name|consfb
operator|->
name|funcvec
argument_list|)
expr_stmt|;
name|fbbm_rop_copy
argument_list|(
name|consfb
argument_list|,
name|dr
argument_list|,
name|dr
argument_list|,
literal|0
argument_list|,
operator|(
name|fcolor
operator|^
name|bcolor
operator|)
operator|&
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
name|unlock_bitmap
argument_list|()
expr_stmt|;
name|csr_bp
operator|->
name|csr_sw
operator|=
name|C_OFF
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  *  move lines  *  move_lines(sl, nl, dl)  moves nl lines starting at line sl to line dl.  */
end_comment

begin_macro
name|move_lines
argument_list|(
argument|sl
argument_list|,
argument|nl
argument_list|,
argument|dl
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sl
decl_stmt|,
name|nl
decl_stmt|,
name|dl
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|move_rect
argument_list|(
name|x_ofst
argument_list|,
name|char_h
operator|*
operator|(
name|sl
operator|-
literal|1
operator|)
operator|+
name|y_ofst
argument_list|,
name|char_w
operator|*
operator|(
name|rit_m
operator|-
name|LFT_M
operator|+
literal|1
operator|)
argument_list|,
name|char_h
operator|*
name|nl
argument_list|,
name|x_ofst
argument_list|,
name|char_h
operator|*
operator|(
name|dl
operator|-
literal|1
operator|)
operator|+
name|y_ofst
argument_list|,
name|BF_S
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *  move chars  *  move_chars(sx, sy, nchar, dx) moves nchar characters at position (sx, sy)  *  to (dx, sy).  */
end_comment

begin_macro
name|move_chars
argument_list|(
argument|sx
argument_list|,
argument|sy
argument_list|,
argument|nchar
argument_list|,
argument|dx
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sx
decl_stmt|,
name|sy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nchar
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dx
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|move_rect
argument_list|(
name|char_w
operator|*
operator|(
name|sx
operator|-
literal|1
operator|)
operator|+
name|x_ofst
argument_list|,
name|char_h
operator|*
operator|(
name|sy
operator|-
literal|1
operator|)
operator|+
name|y_ofst
argument_list|,
name|char_w
operator|*
name|nchar
argument_list|,
name|char_h
argument_list|,
name|char_w
operator|*
operator|(
name|dx
operator|-
literal|1
operator|)
operator|+
name|x_ofst
argument_list|,
name|char_h
operator|*
operator|(
name|sy
operator|-
literal|1
operator|)
operator|+
name|y_ofst
argument_list|,
name|BF_S
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *  clear lines  *  clear_lines(sl, nl, rev) clears nl lines starting at line sl with rev  *  mode. If rev = 0 then normal clear else reverse clear.  */
end_comment

begin_macro
name|clear_lines
argument_list|(
argument|sl
argument_list|,
argument|nl
argument_list|,
argument|rev
argument_list|,
argument|fcol
argument_list|,
argument|bcol
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sl
decl_stmt|,
name|nl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fcol
decl_stmt|,
name|bcol
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|nl
operator|==
name|btm_m
condition|)
block|{
name|clear_rect
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|scr_w
argument_list|,
name|scr_h
argument_list|,
name|BF_S
argument_list|,
name|rev
condition|?
name|fcol
else|:
name|bcol
argument_list|,
name|bcol
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nl
operator|>
literal|0
condition|)
block|{
name|clear_rect
argument_list|(
name|x_ofst
argument_list|,
name|char_h
operator|*
operator|(
name|sl
operator|-
literal|1
operator|)
operator|+
name|y_ofst
argument_list|,
name|char_w
operator|*
operator|(
name|rit_m
operator|-
name|LFT_M
operator|+
literal|1
operator|)
argument_list|,
name|char_h
operator|*
name|nl
argument_list|,
name|BF_S
argument_list|,
name|rev
condition|?
name|fcol
else|:
name|bcol
argument_list|,
name|bcol
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  *  Clear chars  *  clear_chars(x, y, nchar, rev) clears nchar characters following the  *  position (x, y) with rev mode. If rev = 0 then normal clear else   *  reverse clear.  */
end_comment

begin_macro
name|clear_chars
argument_list|(
argument|x
argument_list|,
argument|y
argument_list|,
argument|nchar
argument_list|,
argument|rev
argument_list|,
argument|fcol
argument_list|,
argument|bcol
argument_list|)
end_macro

begin_decl_stmt
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nchar
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fcol
decl_stmt|,
name|bcol
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|nchar
operator|>
literal|0
condition|)
block|{
name|clear_rect
argument_list|(
name|char_w
operator|*
operator|(
name|x
operator|-
literal|1
operator|)
operator|+
name|x_ofst
argument_list|,
name|char_h
operator|*
operator|(
name|y
operator|-
literal|1
operator|)
operator|+
name|y_ofst
argument_list|,
name|char_w
operator|*
name|nchar
argument_list|,
name|char_h
argument_list|,
name|BF_S
argument_list|,
name|rev
condition|?
name|fcol
else|:
name|bcol
argument_list|,
name|bcol
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|reverse_rec
argument_list|(
argument|fcol
argument_list|,
argument|bcol
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fcol
decl_stmt|,
name|bcol
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|clear_rect
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|scr_w
argument_list|,
name|scr_h
argument_list|,
name|BF_SDX
argument_list|,
name|fcol
operator|^
name|bcol
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|copy_char
argument_list|(
name|sp
argument_list|,
name|c
argument_list|,
name|kanji
argument_list|)
specifier|register
name|SCREEN
operator|*
name|sp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|unsigned
name|int
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kanji
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|f_addr
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
specifier|register
name|lRectangle
modifier|*
name|sr
decl_stmt|,
modifier|*
name|dr
decl_stmt|;
name|lRectangle
name|udr
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|fnt_addr
decl_stmt|;
specifier|extern
name|struct
name|fb_map
name|rommap
decl_stmt|;
name|lock_bitmap
argument_list|()
expr_stmt|;
if|if
condition|(
name|consfb
operator|->
name|font_h
operator|==
literal|24
condition|)
name|fnt_addr
operator|=
name|ext_fnt24_addr
expr_stmt|;
else|else
name|fnt_addr
operator|=
name|ext_fnt_addr
expr_stmt|;
if|if
condition|(
name|kanji
condition|)
block|{
name|dr
operator|=
operator|&
name|char_r2
expr_stmt|;
name|sr
operator|=
operator|&
name|font_r2
expr_stmt|;
name|len
operator|=
name|font_len2
expr_stmt|;
block|}
else|else
block|{
name|dr
operator|=
operator|&
name|char_r1
expr_stmt|;
name|sr
operator|=
operator|&
name|font_r1
expr_stmt|;
name|len
operator|=
name|font_len1
expr_stmt|;
block|}
name|dr
operator|->
name|origin
operator|=
name|sp
operator|->
name|s_csr
operator|.
name|csr_p
expr_stmt|;
name|setropfunc
argument_list|(
name|BF_S
argument_list|,
literal|0
argument_list|,
name|fcolor
argument_list|,
name|bcolor
argument_list|)
expr_stmt|;
name|fbbm_rop_cinit
argument_list|(
name|consfb
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fbbm_rop_clear
argument_list|(
name|consfb
argument_list|,
name|dr
argument_list|)
expr_stmt|;
if|if
condition|(
name|kanji
condition|)
block|{
comment|/* 		 * KANJI code... kanji char 		 */
name|f_addr
operator|=
operator|(
name|char
operator|*
operator|)
name|fbbm_Krom_addr
argument_list|(
name|consfb
argument_list|,
name|c
argument_list|,
name|sr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
block|}
elseif|else
if|if
condition|(
name|fnt_addr
operator|==
literal|0
condition|)
block|{
comment|/* 		 * no external fonts... try to use ROM fonts 		 */
name|len
operator|=
name|font_len2
expr_stmt|;
name|f_addr
operator|=
operator|(
name|char
operator|*
operator|)
name|fbbm_Krom_addr
argument_list|(
name|consfb
argument_list|,
name|c
argument_list|,
name|sr
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|KM_ASCII
block|}
elseif|else
if|if
condition|(
name|tmode
operator|==
name|KM_ASCII
condition|)
block|{
comment|/* 		 * terminal mode is ASCII... ASCII (ISO) char 		 */
if|if
condition|(
operator|(
name|c
operator|>=
literal|0x20
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0x7e
operator|)
condition|)
block|{
comment|/* 			 * ASCII char 			 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa0
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xff
operator|)
condition|)
block|{
comment|/* 			 * ISO char 			 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
operator|-
literal|32
index|]
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * UNKNOWN char 			 */
name|f_addr
operator|=
operator|(
name|caddr_t
operator|)
name|zero
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* KM_ASCII */
block|}
else|else
block|{
comment|/* 		 * terminal mode is not ASCII... JIS, SJIS, EUC, ... 		 */
if|if
condition|(
operator|(
name|c
operator|>=
literal|0x20
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0x7e
operator|)
condition|)
block|{
comment|/* 			 * ASCII char 			 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa1
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xdf
operator|)
condition|)
block|{
comment|/* 			 * KANA char 			 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
operator|+
literal|32
index|]
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * UNKNOWN char 			 */
name|f_addr
operator|=
operator|(
name|caddr_t
operator|)
name|zero
expr_stmt|;
block|}
block|}
name|dr
operator|->
name|origin
operator|.
name|y
operator|+=
name|ch_pos
expr_stmt|;
name|setropfunc
argument_list|(
name|BF_S
argument_list|,
literal|1
argument_list|,
name|fcolor
argument_list|,
name|bcolor
argument_list|)
expr_stmt|;
if|if
condition|(
name|f_addr
operator|!=
literal|0
condition|)
block|{
name|fbbm_rop_winit
argument_list|(
name|consfb
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
name|f_addr
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
name|fbbm_rop_write
argument_list|(
name|consfb
argument_list|,
operator|&
name|rommap
argument_list|,
name|rommap
operator|.
name|fm_offset
argument_list|,
name|len
argument_list|,
name|sr
argument_list|,
operator|&
name|dr
operator|->
name|origin
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|s_csr
operator|.
name|csr_attributes
operator|&
name|BOLD
condition|)
block|{
name|dr
operator|->
name|origin
operator|.
name|x
operator|+=
literal|1
expr_stmt|;
name|fbbm_rop_write
argument_list|(
name|consfb
argument_list|,
operator|&
name|rommap
argument_list|,
name|rommap
operator|.
name|fm_offset
argument_list|,
name|len
argument_list|,
name|sr
argument_list|,
operator|&
name|dr
operator|->
name|origin
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fbbm_rop_init
argument_list|(
name|consfb
argument_list|,
name|consfb
operator|->
name|funcvec
argument_list|)
expr_stmt|;
name|fbbm_rop_copy
argument_list|(
name|consfb
argument_list|,
name|sr
argument_list|,
operator|&
name|dr
operator|->
name|origin
argument_list|,
literal|1
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|s_csr
operator|.
name|csr_attributes
operator|&
name|BOLD
condition|)
block|{
name|dr
operator|->
name|origin
operator|.
name|x
operator|+=
literal|1
expr_stmt|;
name|fbbm_rop_copy
argument_list|(
name|consfb
argument_list|,
name|sr
argument_list|,
operator|&
name|dr
operator|->
name|origin
argument_list|,
literal|1
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sp
operator|->
name|s_csr
operator|.
name|csr_attributes
operator|&
name|USCORE
condition|)
block|{
name|udr
operator|.
name|origin
operator|.
name|x
operator|=
name|sp
operator|->
name|s_csr
operator|.
name|csr_p
operator|.
name|x
expr_stmt|;
name|udr
operator|.
name|origin
operator|.
name|y
operator|=
name|sp
operator|->
name|s_csr
operator|.
name|csr_p
operator|.
name|y
operator|+
name|ul_pos
expr_stmt|;
name|udr
operator|.
name|extent
operator|.
name|x
operator|=
name|char_w
expr_stmt|;
name|udr
operator|.
name|extent
operator|.
name|y
operator|=
literal|1
expr_stmt|;
name|setropfunc
argument_list|(
name|BF_S
argument_list|,
literal|1
argument_list|,
name|fcolor
argument_list|,
name|bcolor
argument_list|)
expr_stmt|;
name|fbbm_rop_cinit
argument_list|(
name|consfb
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbbm_rop_clear
argument_list|(
name|consfb
argument_list|,
operator|&
name|udr
argument_list|)
expr_stmt|;
block|}
name|unlock_bitmap
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|vt_flush
argument_list|(
argument|spc
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|cursor
modifier|*
name|spc
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|f_addr
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
specifier|register
name|lRectangle
modifier|*
name|sr
decl_stmt|,
modifier|*
name|dr
decl_stmt|;
name|lRectangle
name|fr
decl_stmt|,
name|cr
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|unsigned
name|int
name|c
decl_stmt|;
name|lRectangle
name|udr
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|fnt_addr
decl_stmt|;
name|char
modifier|*
name|oldf_addr
init|=
operator|(
name|char
operator|*
operator|)
operator|-
literal|1
decl_stmt|;
specifier|extern
name|struct
name|fb_map
name|rommap
decl_stmt|;
if|if
condition|(
name|fp
operator|==
literal|0
condition|)
return|return;
name|cursor_off
argument_list|()
expr_stmt|;
name|lock_bitmap
argument_list|()
expr_stmt|;
if|if
condition|(
name|consfb
operator|->
name|font_h
operator|==
literal|24
condition|)
name|fnt_addr
operator|=
name|ext_fnt24_addr
expr_stmt|;
else|else
name|fnt_addr
operator|=
name|ext_fnt_addr
expr_stmt|;
name|udr
operator|.
name|origin
operator|=
name|fpp
expr_stmt|;
name|udr
operator|.
name|extent
operator|.
name|x
operator|=
name|fpn
operator|*
name|char_w
expr_stmt|;
name|udr
operator|.
name|extent
operator|.
name|y
operator|=
name|char_h
expr_stmt|;
name|setropfunc
argument_list|(
name|BF_S
argument_list|,
literal|0
argument_list|,
name|fcolor
argument_list|,
name|bcolor
argument_list|)
expr_stmt|;
name|fbbm_rop_cinit
argument_list|(
name|consfb
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fbbm_rop_clear
argument_list|(
name|consfb
argument_list|,
operator|&
name|udr
argument_list|)
expr_stmt|;
if|if
condition|(
name|fpa
operator|&
name|BOLD
condition|)
name|setropfunc
argument_list|(
name|BF_S
argument_list|,
literal|1
argument_list|,
name|fcolor
argument_list|,
name|bcolor
argument_list|)
expr_stmt|;
else|else
name|setropfunc
argument_list|(
name|BF_S
argument_list|,
literal|0
argument_list|,
name|fcolor
argument_list|,
name|bcolor
argument_list|)
expr_stmt|;
name|fbbm_rop_winit
argument_list|(
name|consfb
argument_list|)
expr_stmt|;
name|sr
operator|=
operator|&
name|fr
expr_stmt|;
name|dr
operator|=
operator|&
name|cr
expr_stmt|;
name|sr
operator|->
name|origin
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|sr
operator|->
name|origin
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|sr
operator|->
name|extent
operator|.
name|y
operator|=
name|font_h
expr_stmt|;
name|dr
operator|->
name|origin
operator|.
name|x
operator|=
name|fpp
operator|.
name|x
expr_stmt|;
name|dr
operator|->
name|origin
operator|.
name|y
operator|=
name|fpp
operator|.
name|y
operator|+
name|ch_pos
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fp
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
name|fbuf
index|[
name|i
index|]
expr_stmt|;
name|sr
operator|->
name|extent
operator|.
name|x
operator|=
name|font_w
expr_stmt|;
name|dr
operator|->
name|extent
operator|.
name|x
operator|=
name|char_w
expr_stmt|;
if|if
condition|(
name|c
operator|&
literal|0xff00
condition|)
block|{
comment|/* 			 * KANJI code... kanji char 			 */
name|sr
operator|->
name|extent
operator|.
name|x
operator|=
name|font_r2
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|dr
operator|->
name|extent
operator|.
name|x
operator|=
name|char_r2
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|len
operator|=
name|font_len2
expr_stmt|;
name|f_addr
operator|=
operator|(
name|char
operator|*
operator|)
name|fbbm_Krom_addr
argument_list|(
name|consfb
argument_list|,
name|c
argument_list|,
name|sr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
block|}
elseif|else
if|if
condition|(
name|fnt_addr
operator|==
literal|0
condition|)
block|{
comment|/* 			 * no external fonts... try to use ROM fonts 			 */
name|sr
operator|->
name|extent
operator|.
name|x
operator|=
name|font_r1
operator|.
name|extent
operator|.
name|x
expr_stmt|;
comment|/*XXX*/
name|dr
operator|->
name|extent
operator|.
name|x
operator|=
name|char_r1
operator|.
name|extent
operator|.
name|x
expr_stmt|;
comment|/*XXX*/
name|len
operator|=
name|font_len2
expr_stmt|;
name|f_addr
operator|=
operator|(
name|char
operator|*
operator|)
name|fbbm_Krom_addr
argument_list|(
name|consfb
argument_list|,
name|c
argument_list|,
name|sr
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|KM_ASCII
block|}
elseif|else
if|if
condition|(
name|tmode
operator|==
name|KM_ASCII
condition|)
block|{
comment|/* 			 * terminal mode is ASCII... ASCII (ISO) char 			 */
name|len
operator|=
name|font_len1
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|>=
literal|0x20
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0x7e
operator|)
condition|)
block|{
comment|/* 				 * ASCII char 				 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa0
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xff
operator|)
condition|)
block|{
comment|/* 				 * ISO char 				 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
operator|-
literal|32
index|]
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * UNKNOWN char 				 */
name|f_addr
operator|=
operator|(
name|caddr_t
operator|)
name|zero
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* KM_ASCII */
block|}
else|else
block|{
comment|/* 			 * terminal mode is not ASCII... JIS, SJIS, EUC, ... 			 */
name|len
operator|=
name|font_len1
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|>=
literal|0x20
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0x7e
operator|)
condition|)
block|{
comment|/* 				 * ASCII char 				 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa1
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xdf
operator|)
condition|)
block|{
comment|/* 				 * KANA char 				 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
operator|+
literal|64
index|]
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * UNKNOWN char 				 */
name|f_addr
operator|=
operator|(
name|caddr_t
operator|)
name|zero
expr_stmt|;
block|}
block|}
if|if
condition|(
name|f_addr
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|oldf_addr
operator|==
literal|0
condition|)
name|fbbm_rop_winit
argument_list|(
name|consfb
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
name|f_addr
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
name|fbbm_rop_write
argument_list|(
name|consfb
argument_list|,
operator|&
name|rommap
argument_list|,
name|rommap
operator|.
name|fm_offset
argument_list|,
name|len
argument_list|,
name|sr
argument_list|,
operator|&
name|dr
operator|->
name|origin
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
if|if
condition|(
name|fpa
operator|&
name|BOLD
condition|)
block|{
comment|/* 				 * Bold char 				 */
name|dr
operator|->
name|origin
operator|.
name|x
operator|+=
literal|1
expr_stmt|;
name|fbbm_rop_write
argument_list|(
name|consfb
argument_list|,
operator|&
name|rommap
argument_list|,
name|rommap
operator|.
name|fm_offset
argument_list|,
name|len
argument_list|,
name|sr
argument_list|,
operator|&
name|dr
operator|->
name|origin
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
name|dr
operator|->
name|origin
operator|.
name|x
operator|-=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|oldf_addr
operator|!=
literal|0
condition|)
name|fbbm_rop_init
argument_list|(
name|consfb
argument_list|,
name|consfb
operator|->
name|funcvec
argument_list|)
expr_stmt|;
name|fbbm_rop_copy
argument_list|(
name|consfb
argument_list|,
name|sr
argument_list|,
operator|&
name|dr
operator|->
name|origin
argument_list|,
literal|1
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
if|if
condition|(
name|fpa
operator|&
name|BOLD
condition|)
block|{
comment|/* 				 * Bold char 				 */
name|dr
operator|->
name|origin
operator|.
name|x
operator|+=
literal|1
expr_stmt|;
name|fbbm_rop_copy
argument_list|(
name|consfb
argument_list|,
name|sr
argument_list|,
operator|&
name|dr
operator|->
name|origin
argument_list|,
literal|1
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|)
expr_stmt|;
name|dr
operator|->
name|origin
operator|.
name|x
operator|-=
literal|1
expr_stmt|;
block|}
block|}
name|dr
operator|->
name|origin
operator|.
name|x
operator|+=
name|dr
operator|->
name|extent
operator|.
name|x
expr_stmt|;
name|oldf_addr
operator|=
name|f_addr
expr_stmt|;
comment|/* 		 * sr->origin.x and sr->origin.y were changed by 		 * fbpop_Krom_addr(), fb254_Krom_addr(). 		 */
name|sr
operator|->
name|origin
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|sr
operator|->
name|origin
operator|.
name|y
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|fpa
operator|&
name|USCORE
condition|)
block|{
name|udr
operator|.
name|origin
operator|.
name|y
operator|+=
name|ul_pos
expr_stmt|;
name|udr
operator|.
name|extent
operator|.
name|y
operator|=
literal|1
expr_stmt|;
name|setropfunc
argument_list|(
name|BF_S
argument_list|,
literal|1
argument_list|,
name|fcolor
argument_list|,
name|bcolor
argument_list|)
expr_stmt|;
name|fbbm_rop_cinit
argument_list|(
name|consfb
argument_list|,
name|consfb
operator|->
name|planemask
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbbm_rop_clear
argument_list|(
name|consfb
argument_list|,
operator|&
name|udr
argument_list|)
expr_stmt|;
block|}
name|fp
operator|=
literal|0
expr_stmt|;
name|unlock_bitmap
argument_list|()
expr_stmt|;
name|dr
operator|->
name|origin
operator|.
name|y
operator|-=
name|ch_pos
expr_stmt|;
name|cursor_on
argument_list|(
operator|&
operator|(
name|spc
operator|->
name|csr_p
operator|)
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1988 University of Utah.  * Copyright (c) 1990 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * the Systems Programming Group of the University of Utah Computer  * Science Department.  *  * %sccs.include.redist.c%  *  * from: Utah $Hdr: ite.c 1.24 93/06/25$  *  *	@(#)ite.c	7.6 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * Standalone Internal Terminal Emulator (CRT and keyboard)  */
end_comment

begin_include
include|#
directive|include
file|<hp300/stand/samachdep.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|ITECONSOLE
end_ifdef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<hp/dev/cons.h>
end_include

begin_include
include|#
directive|include
file|<hp/dev/device.h>
end_include

begin_include
include|#
directive|include
file|<hp/dev/itevar.h>
end_include

begin_include
include|#
directive|include
file|<hp/dev/grfreg.h>
end_include

begin_function_decl
specifier|extern
name|int
name|nodev
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|u_char
name|ite_readbyte
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|ite_writeglyph
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|int
name|topcat_init
argument_list|()
decl_stmt|,
name|topcat_putc
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|topcat_clear
argument_list|()
decl_stmt|,
name|topcat_cursor
argument_list|()
decl_stmt|,
name|topcat_scroll
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|gbox_init
argument_list|()
decl_stmt|,
name|gbox_clear
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|gbox_putc
argument_list|()
decl_stmt|,
name|gbox_cursor
argument_list|()
decl_stmt|,
name|gbox_scroll
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|rbox_init
argument_list|()
decl_stmt|,
name|rbox_clear
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|rbox_putc
argument_list|()
decl_stmt|,
name|rbox_cursor
argument_list|()
decl_stmt|,
name|rbox_scroll
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|dvbox_init
argument_list|()
decl_stmt|,
name|dvbox_clear
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|dvbox_putc
argument_list|()
decl_stmt|,
name|dvbox_cursor
argument_list|()
decl_stmt|,
name|dvbox_scroll
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|hyper_init
argument_list|()
decl_stmt|,
name|hyper_clear
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|hyper_putc
argument_list|()
decl_stmt|,
name|hyper_cursor
argument_list|()
decl_stmt|,
name|hyper_scroll
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|itesw
name|itesw
index|[]
init|=
block|{
name|GID_TOPCAT
block|,
name|topcat_init
block|,
name|nodev
block|,
name|topcat_clear
block|,
name|topcat_putc
block|,
name|topcat_cursor
block|,
name|topcat_scroll
block|,
name|ite_readbyte
block|,
name|ite_writeglyph
block|,
name|GID_GATORBOX
block|,
name|gbox_init
block|,
name|nodev
block|,
name|gbox_clear
block|,
name|gbox_putc
block|,
name|gbox_cursor
block|,
name|gbox_scroll
block|,
name|ite_readbyte
block|,
name|ite_writeglyph
block|,
name|GID_RENAISSANCE
block|,
name|rbox_init
block|,
name|nodev
block|,
name|rbox_clear
block|,
name|rbox_putc
block|,
name|rbox_cursor
block|,
name|rbox_scroll
block|,
name|ite_readbyte
block|,
name|ite_writeglyph
block|,
name|GID_LRCATSEYE
block|,
name|topcat_init
block|,
name|nodev
block|,
name|topcat_clear
block|,
name|topcat_putc
block|,
name|topcat_cursor
block|,
name|topcat_scroll
block|,
name|ite_readbyte
block|,
name|ite_writeglyph
block|,
name|GID_HRCCATSEYE
block|,
name|topcat_init
block|,
name|nodev
block|,
name|topcat_clear
block|,
name|topcat_putc
block|,
name|topcat_cursor
block|,
name|topcat_scroll
block|,
name|ite_readbyte
block|,
name|ite_writeglyph
block|,
name|GID_HRMCATSEYE
block|,
name|topcat_init
block|,
name|nodev
block|,
name|topcat_clear
block|,
name|topcat_putc
block|,
name|topcat_cursor
block|,
name|topcat_scroll
block|,
name|ite_readbyte
block|,
name|ite_writeglyph
block|,
name|GID_DAVINCI
block|,
name|dvbox_init
block|,
name|nodev
block|,
name|dvbox_clear
block|,
name|dvbox_putc
block|,
name|dvbox_cursor
block|,
name|dvbox_scroll
block|,
name|ite_readbyte
block|,
name|ite_writeglyph
block|,
name|GID_HYPERION
block|,
name|hyper_init
block|,
name|nodev
block|,
name|hyper_clear
block|,
name|hyper_putc
block|,
name|hyper_cursor
block|,
name|hyper_scroll
block|,
name|ite_readbyte
block|,
name|ite_writeglyph
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nitesw
init|=
sizeof|sizeof
argument_list|(
name|itesw
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|itesw
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* these guys need to be in initialized data */
end_comment

begin_decl_stmt
name|int
name|itecons
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ite_softc
name|ite_softc
index|[
name|NITE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Locate all bitmapped displays  */
end_comment

begin_macro
name|iteconfig
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|struct
name|hp_hw
name|sc_table
index|[]
decl_stmt|;
name|int
name|dtype
decl_stmt|,
name|fboff
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|hp_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|grfreg
modifier|*
name|gr
decl_stmt|;
name|struct
name|ite_softc
modifier|*
name|ip
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|hw
operator|=
name|sc_table
init|;
name|hw
operator|<
operator|&
name|sc_table
index|[
name|MAXCTLRS
index|]
condition|;
name|hw
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|HW_ISDEV
argument_list|(
name|hw
argument_list|,
name|D_BITMAP
argument_list|)
condition|)
continue|continue;
name|gr
operator|=
operator|(
expr|struct
name|grfreg
operator|*
operator|)
name|hw
operator|->
name|hw_kva
expr_stmt|;
comment|/* XXX: redundent but safe */
if|if
condition|(
name|badaddr
argument_list|(
operator|(
name|caddr_t
operator|)
name|gr
argument_list|)
operator|||
name|gr
operator|->
name|gr_id
operator|!=
name|GRFHWID
condition|)
continue|continue;
for|for
control|(
name|dtype
operator|=
literal|0
init|;
name|dtype
operator|<
name|nitesw
condition|;
name|dtype
operator|++
control|)
if|if
condition|(
name|itesw
index|[
name|dtype
index|]
operator|.
name|ite_hwid
operator|==
name|gr
operator|->
name|gr_id2
condition|)
break|break;
if|if
condition|(
name|dtype
operator|==
name|nitesw
condition|)
continue|continue;
if|if
condition|(
name|i
operator|>=
name|NITE
condition|)
break|break;
name|ip
operator|=
operator|&
name|ite_softc
index|[
name|i
index|]
expr_stmt|;
name|ip
operator|->
name|isw
operator|=
operator|&
name|itesw
index|[
name|dtype
index|]
expr_stmt|;
name|ip
operator|->
name|regbase
operator|=
operator|(
name|caddr_t
operator|)
name|gr
expr_stmt|;
name|fboff
operator|=
operator|(
name|gr
operator|->
name|gr_fbomsb
operator|<<
literal|8
operator|)
operator||
name|gr
operator|->
name|gr_fbolsb
expr_stmt|;
name|ip
operator|->
name|fbbase
operator|=
call|(
name|caddr_t
call|)
argument_list|(
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
name|ip
operator|->
name|regbase
operator|+
name|fboff
operator|)
operator|<<
literal|16
argument_list|)
expr_stmt|;
comment|/* DIO II: FB offset is relative to select code space */
if|if
condition|(
name|ip
operator|->
name|regbase
operator|>=
operator|(
name|caddr_t
operator|)
name|DIOIIBASE
condition|)
name|ip
operator|->
name|fbbase
operator|+=
operator|(
name|int
operator|)
name|ip
operator|->
name|regbase
expr_stmt|;
name|ip
operator|->
name|fbwidth
operator|=
name|gr
operator|->
name|gr_fbwidth_h
operator|<<
literal|8
operator||
name|gr
operator|->
name|gr_fbwidth_l
expr_stmt|;
name|ip
operator|->
name|fbheight
operator|=
name|gr
operator|->
name|gr_fbheight_h
operator|<<
literal|8
operator||
name|gr
operator|->
name|gr_fbheight_l
expr_stmt|;
name|ip
operator|->
name|dwidth
operator|=
name|gr
operator|->
name|gr_dwidth_h
operator|<<
literal|8
operator||
name|gr
operator|->
name|gr_dwidth_l
expr_stmt|;
name|ip
operator|->
name|dheight
operator|=
name|gr
operator|->
name|gr_dheight_h
operator|<<
literal|8
operator||
name|gr
operator|->
name|gr_dheight_l
expr_stmt|;
comment|/* 		 * XXX some displays (e.g. the davinci) appear 		 * to return a display height greater than the 		 * returned FB height.  Guess we should go back 		 * to getting the display dimensions from the 		 * fontrom... 		 */
if|if
condition|(
name|ip
operator|->
name|dwidth
operator|>
name|ip
operator|->
name|fbwidth
condition|)
name|ip
operator|->
name|dwidth
operator|=
name|ip
operator|->
name|fbwidth
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|dheight
operator|>
name|ip
operator|->
name|fbheight
condition|)
name|ip
operator|->
name|dheight
operator|=
name|ip
operator|->
name|fbheight
expr_stmt|;
name|ip
operator|->
name|flags
operator|=
name|ITE_ALIVE
operator||
name|ITE_CONSOLE
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|CONSDEBUG
end_ifdef

begin_comment
comment|/*  * Allows us to cycle through all possible consoles (NITE ites and serial port)  * by using SHIFT-RESET on the keyboard.  */
end_comment

begin_decl_stmt
name|int
name|whichconsole
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_macro
name|iteprobe
argument_list|(
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|consdev
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|ite
decl_stmt|;
specifier|register
name|struct
name|ite_softc
modifier|*
name|ip
decl_stmt|;
name|int
name|unit
decl_stmt|,
name|pri
decl_stmt|;
ifdef|#
directive|ifdef
name|CONSDEBUG
name|whichconsole
operator|=
operator|++
name|whichconsole
operator|%
operator|(
name|NITE
operator|+
literal|1
operator|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|itecons
operator|!=
operator|-
literal|1
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|iteconfig
argument_list|()
expr_stmt|;
name|unit
operator|=
operator|-
literal|1
expr_stmt|;
name|pri
operator|=
name|CN_DEAD
expr_stmt|;
for|for
control|(
name|ite
operator|=
literal|0
init|;
name|ite
operator|<
name|NITE
condition|;
name|ite
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|CONSDEBUG
if|if
condition|(
name|ite
operator|<
name|whichconsole
condition|)
continue|continue;
endif|#
directive|endif
name|ip
operator|=
operator|&
name|ite_softc
index|[
name|ite
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|ip
operator|->
name|flags
operator|&
operator|(
name|ITE_ALIVE
operator||
name|ITE_CONSOLE
operator|)
operator|)
operator|!=
operator|(
name|ITE_ALIVE
operator||
name|ITE_CONSOLE
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|int
operator|)
name|ip
operator|->
name|regbase
operator|==
name|GRFIADDR
condition|)
block|{
name|pri
operator|=
name|CN_INTERNAL
expr_stmt|;
name|unit
operator|=
name|ite
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|unit
operator|<
literal|0
condition|)
block|{
name|pri
operator|=
name|CN_NORMAL
expr_stmt|;
name|unit
operator|=
name|ite
expr_stmt|;
block|}
block|}
name|cp
operator|->
name|cn_dev
operator|=
name|unit
expr_stmt|;
name|cp
operator|->
name|cn_pri
operator|=
name|pri
expr_stmt|;
block|}
end_block

begin_macro
name|iteinit
argument_list|(
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|consdev
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|ite
init|=
name|cp
operator|->
name|cn_dev
decl_stmt|;
name|struct
name|ite_softc
modifier|*
name|ip
decl_stmt|;
if|if
condition|(
name|itecons
operator|!=
operator|-
literal|1
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|ip
operator|=
operator|&
name|ite_softc
index|[
name|ite
index|]
expr_stmt|;
name|ip
operator|->
name|curx
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|cury
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|cursorx
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|cursory
operator|=
literal|0
expr_stmt|;
call|(
modifier|*
name|ip
operator|->
name|isw
operator|->
name|ite_init
call|)
argument_list|(
name|ip
argument_list|)
expr_stmt|;
call|(
modifier|*
name|ip
operator|->
name|isw
operator|->
name|ite_cursor
call|)
argument_list|(
name|ip
argument_list|,
name|DRAW_CURSOR
argument_list|)
expr_stmt|;
name|itecons
operator|=
name|ite
expr_stmt|;
name|kbdinit
argument_list|()
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|iteputchar
argument_list|(
name|c
argument_list|)
specifier|register
name|int
name|c
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|ite_softc
modifier|*
name|ip
init|=
operator|&
name|ite_softc
index|[
name|itecons
index|]
decl_stmt|;
specifier|register
name|struct
name|itesw
modifier|*
name|sp
init|=
name|ip
operator|->
name|isw
decl_stmt|;
name|c
operator|&=
literal|0x7F
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\n'
case|:
if|if
condition|(
operator|++
name|ip
operator|->
name|cury
operator|==
name|ip
operator|->
name|rows
condition|)
block|{
name|ip
operator|->
name|cury
operator|--
expr_stmt|;
call|(
modifier|*
name|sp
operator|->
name|ite_scroll
call|)
argument_list|(
name|ip
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|SCROLL_UP
argument_list|)
expr_stmt|;
name|ite_clrtoeol
argument_list|(
name|ip
argument_list|,
name|sp
argument_list|,
name|ip
operator|->
name|cury
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
call|(
modifier|*
name|sp
operator|->
name|ite_cursor
call|)
argument_list|(
name|ip
argument_list|,
name|MOVE_CURSOR
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\r'
case|:
name|ip
operator|->
name|curx
operator|=
literal|0
expr_stmt|;
call|(
modifier|*
name|sp
operator|->
name|ite_cursor
call|)
argument_list|(
name|ip
argument_list|,
name|MOVE_CURSOR
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\b'
case|:
if|if
condition|(
operator|--
name|ip
operator|->
name|curx
operator|<
literal|0
condition|)
name|ip
operator|->
name|curx
operator|=
literal|0
expr_stmt|;
else|else
call|(
modifier|*
name|sp
operator|->
name|ite_cursor
call|)
argument_list|(
name|ip
argument_list|,
name|MOVE_CURSOR
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|c
operator|<
literal|' '
operator|||
name|c
operator|==
literal|0177
condition|)
break|break;
call|(
modifier|*
name|sp
operator|->
name|ite_putc
call|)
argument_list|(
name|ip
argument_list|,
name|c
argument_list|,
name|ip
operator|->
name|cury
argument_list|,
name|ip
operator|->
name|curx
argument_list|,
name|ATTR_NOR
argument_list|)
expr_stmt|;
call|(
modifier|*
name|sp
operator|->
name|ite_cursor
call|)
argument_list|(
name|ip
argument_list|,
name|DRAW_CURSOR
argument_list|)
expr_stmt|;
name|itecheckwrap
argument_list|(
name|ip
argument_list|,
name|sp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_expr_stmt
name|itecheckwrap
argument_list|(
name|ip
argument_list|,
name|sp
argument_list|)
specifier|register
expr|struct
name|ite_softc
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|itesw
modifier|*
name|sp
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|++
name|ip
operator|->
name|curx
operator|==
name|ip
operator|->
name|cols
condition|)
block|{
name|ip
operator|->
name|curx
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|++
name|ip
operator|->
name|cury
operator|==
name|ip
operator|->
name|rows
condition|)
block|{
operator|--
name|ip
operator|->
name|cury
expr_stmt|;
call|(
modifier|*
name|sp
operator|->
name|ite_scroll
call|)
argument_list|(
name|ip
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|SCROLL_UP
argument_list|)
expr_stmt|;
name|ite_clrtoeol
argument_list|(
name|ip
argument_list|,
name|sp
argument_list|,
name|ip
operator|->
name|cury
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
call|(
modifier|*
name|sp
operator|->
name|ite_cursor
call|)
argument_list|(
name|ip
argument_list|,
name|MOVE_CURSOR
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ite_clrtoeol
argument_list|(
name|ip
argument_list|,
name|sp
argument_list|,
name|y
argument_list|,
name|x
argument_list|)
specifier|register
expr|struct
name|ite_softc
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|itesw
modifier|*
name|sp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|y
decl_stmt|,
name|x
decl_stmt|;
end_decl_stmt

begin_block
block|{
call|(
modifier|*
name|sp
operator|->
name|ite_clear
call|)
argument_list|(
name|ip
argument_list|,
name|y
argument_list|,
name|x
argument_list|,
literal|1
argument_list|,
name|ip
operator|->
name|cols
operator|-
name|x
argument_list|)
expr_stmt|;
call|(
modifier|*
name|sp
operator|->
name|ite_cursor
call|)
argument_list|(
name|ip
argument_list|,
name|DRAW_CURSOR
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|itegetchar
argument_list|()
end_macro

begin_block
block|{
ifdef|#
directive|ifdef
name|SMALL
return|return
operator|(
literal|0
operator|)
return|;
else|#
directive|else
return|return
operator|(
name|kbdgetc
argument_list|()
operator|)
return|;
endif|#
directive|endif
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


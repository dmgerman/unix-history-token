begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	cy.c	7.1	86/01/12	*/
end_comment

begin_comment
comment|/*	cy.c	Tahoe version 	Mar 1983.	*/
end_comment

begin_comment
comment|/*  * Cypher tape driver. Stand alone version.  *  */
end_comment

begin_include
include|#
directive|include
file|"../machine/pte.h"
end_include

begin_include
include|#
directive|include
file|"../machine/mtpr.h"
end_include

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"inode.h"
end_include

begin_include
include|#
directive|include
file|"fs.h"
end_include

begin_include
include|#
directive|include
file|"saio.h"
end_include

begin_include
include|#
directive|include
file|"cyvar.h"
end_include

begin_decl_stmt
name|long
name|cystd
index|[]
init|=
block|{
literal|0xf4000
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|scp
comment|/* SYSTEM CONFIGURATION POINTER */
block|{
name|char
name|sysbus
decl_stmt|;
comment|/* width of system buss 0=8;1=16 */
name|char
name|nu1
decl_stmt|;
name|char
name|pt_scb
index|[
literal|4
index|]
decl_stmt|;
comment|/* pointer to ->SYSTEM CONFIGURATION BLOCK */
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|scp
modifier|*
name|SCP
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* absolute address - jumpered on the controller */
end_comment

begin_comment
comment|/* set to 0xC06 for Tahoe */
end_comment

begin_struct
struct|struct
name|scb
comment|/* SYSTEM CONFIGUREATION BLOCK */
block|{
name|char
name|sysblk
index|[
literal|1
index|]
decl_stmt|;
comment|/* 0x03 fixed value code */
name|char
name|nu2
index|[
literal|1
index|]
decl_stmt|;
name|char
name|pt_ccb
index|[
literal|4
index|]
decl_stmt|;
comment|/* pointer to ->CHANNEL CONTROL BLOCK */
block|}
name|scb
struct|;
end_struct

begin_struct
struct|struct
name|ccb
comment|/* CHANNEL CONTROL BLOCK */
block|{
name|char
name|ccw
index|[
literal|1
index|]
decl_stmt|;
comment|/* 0x11 normal; 0x09 clear non_vect interrupt */
name|char
name|gate
index|[
literal|1
index|]
decl_stmt|;
comment|/* This is "the" GATE */
name|char
name|pt_tpb
index|[
literal|4
index|]
decl_stmt|;
comment|/* pointer to ->TAPE OPERATION BLOCK or MOVE BLOCK */
block|}
name|ccb
struct|;
end_struct

begin_struct
struct|struct
name|tpb
comment|/* TAPE OPERATIONS PARAMETER BLOCK */
block|{
name|long
name|cmd
decl_stmt|;
comment|/* COMMAND (input) */
name|char
name|control
index|[
literal|2
index|]
decl_stmt|;
comment|/* CONTROL (input) */
name|short
name|count
decl_stmt|;
comment|/* RETURN COUNT (output) */
name|short
name|size
decl_stmt|;
comment|/* BUFFER SIZE (input/output) */
name|short
name|rec_over
decl_stmt|;
comment|/* RECORDS/OVERRUN (input/output) */
name|char
name|pt_data
index|[
literal|4
index|]
decl_stmt|;
comment|/* pointer to ->SOURCE/DEST (input) */
name|char
name|status
index|[
literal|2
index|]
decl_stmt|;
comment|/* STATUS (output) */
name|char
name|pt_link
index|[
literal|4
index|]
decl_stmt|;
comment|/* pointer to ->INTERRUPT/PARAMETER BLOCK (input) */
block|}
name|tpb
struct|;
end_struct

begin_decl_stmt
name|struct
name|tpb
name|cycool
comment|/* tape parameter block to clear interrupts */
init|=
block|{
literal|0L
block|,
comment|/* command */
literal|0
block|,
literal|0
block|,
comment|/* control */
literal|0
block|,
comment|/* count */
literal|0
block|,
comment|/* size */
literal|0
block|,
comment|/* rec_over */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* pt_data */
literal|0
block|,
literal|0
block|,
comment|/* status */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
comment|/* pt_link */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cyblksiz
init|=
literal|1024
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* foreign tape size as found in open routine */
end_comment

begin_decl_stmt
name|long
name|cyblock
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* next block number for i/o */
end_comment

begin_comment
comment|/*  * Reset the controller.  */
end_comment

begin_expr_stmt
name|cyopen
argument_list|(
name|io
argument_list|)
specifier|register
expr|struct
name|iob
operator|*
name|io
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|ctlradr
expr_stmt|;
name|ctlradr
operator|=
name|cystd
index|[
literal|0
index|]
operator|+
operator|(
name|int
operator|)
name|IOBASE
expr_stmt|;
name|SCP
operator|=
operator|(
expr|struct
name|scp
operator|*
operator|)
literal|0xc06
expr_stmt|;
comment|/* absolute - for setup */
name|TM_RESET
argument_list|(
name|ctlradr
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* reset the controller */
comment|/* 	 * Initialize the system configuration pointer 	 */
name|SCP
operator|->
name|sysbus
operator|=
literal|1
expr_stmt|;
comment|/* system width = 16 bits. */
comment|/* initialize the pointer to the system configuration block */
name|set_pointer
argument_list|(
operator|(
name|long
operator|)
operator|&
name|scb
operator|.
name|sysblk
index|[
literal|0
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
name|SCP
operator|->
name|pt_scb
argument_list|)
expr_stmt|;
comment|/* 	 * Initialize the system configuration block. 	 */
name|scb
operator|.
name|sysblk
index|[
literal|0
index|]
operator|=
literal|0x3
expr_stmt|;
comment|/* fixed value */
comment|/* initialize the pointer to the channel control block */
name|set_pointer
argument_list|(
operator|(
name|long
operator|)
operator|&
name|ccb
operator|.
name|ccw
index|[
literal|0
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
name|scb
operator|.
name|pt_ccb
argument_list|)
expr_stmt|;
comment|/* 	 * Initialize the channel control block. 	 */
name|ccb
operator|.
name|ccw
index|[
literal|0
index|]
operator|=
literal|0x11
expr_stmt|;
comment|/* normal interrupts */
comment|/* initialize the pointer to the tape parameter block */
name|set_pointer
argument_list|(
operator|(
name|long
operator|)
operator|&
name|tpb
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ccb
operator|.
name|pt_tpb
argument_list|)
expr_stmt|;
comment|/* 	 * set the command to be NO_OP. 	 */
name|tpb
operator|.
name|cmd
operator|=
name|NO_OP
expr_stmt|;
name|tpb
operator|.
name|control
index|[
literal|0
index|]
operator|=
name|CW_BL
expr_stmt|;
comment|/* TPB not used on first attention */
name|tpb
operator|.
name|control
index|[
literal|1
index|]
operator|=
name|CW_16bits
expr_stmt|;
name|ccb
operator|.
name|gate
index|[
literal|0
index|]
operator|=
name|GATE_CLOSED
expr_stmt|;
name|TM_ATTENTION
argument_list|(
name|ctlradr
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* execute! */
name|cywait
argument_list|(
literal|10
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/* 	 * set the command to be CONFIGURE. 	 */
name|tpb
operator|.
name|cmd
operator|=
name|CONFIG
expr_stmt|;
name|tpb
operator|.
name|control
index|[
literal|0
index|]
operator|=
name|CW_BL
expr_stmt|;
comment|/* NO interrupt on completion */
name|tpb
operator|.
name|control
index|[
literal|1
index|]
operator|=
name|CW_16bits
expr_stmt|;
name|tpb
operator|.
name|status
index|[
literal|0
index|]
operator|=
name|tpb
operator|.
name|status
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|ccb
operator|.
name|gate
index|[
literal|0
index|]
operator|=
name|GATE_CLOSED
expr_stmt|;
name|TM_ATTENTION
argument_list|(
name|ctlradr
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* execute! */
name|cywait
argument_list|(
literal|10
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|uncache
argument_list|(
operator|&
name|tpb
operator|.
name|status
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tpb
operator|.
name|status
index|[
literal|1
index|]
operator|&
name|CS_ERm
condition|)
block|{
name|printf
argument_list|(
literal|"Cypher initialization error!\n"
argument_list|)
expr_stmt|;
name|cy_decode_error
argument_list|(
name|tpb
operator|.
name|status
index|[
literal|1
index|]
operator|&
name|CS_ERm
argument_list|)
expr_stmt|;
name|_stop
argument_list|(
literal|""
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cycmd
argument_list|(
name|io
argument_list|,
name|REWD_TA
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|_stop
argument_list|(
literal|"Rewind failed!\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|io
operator|->
name|i_boff
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|cycmd
argument_list|(
name|io
argument_list|,
name|SPAC_FM
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|_stop
argument_list|(
literal|"cy: seek failure!\n"
argument_list|)
expr_stmt|;
name|io
operator|->
name|i_boff
operator|--
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|NOBLOCK
if|if
condition|(
name|io
operator|->
name|i_flgs
operator|&
name|F_READ
condition|)
block|{
if|if
condition|(
operator|(
name|cyblksiz
operator|=
name|cycmd
argument_list|(
name|io
argument_list|,
name|READ_FO
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|_stop
argument_list|(
literal|"Read foriegn tape failed!\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cycmd
argument_list|(
name|io
argument_list|,
name|REWD_TA
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|_stop
argument_list|(
literal|"Rewind after read failed\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_block

begin_comment
comment|/* if tape was open for writing write a file mark */
end_comment

begin_expr_stmt
name|cyclose
argument_list|(
name|io
argument_list|)
specifier|register
expr|struct
name|iob
operator|*
name|io
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|io
operator|->
name|i_flgs
operator|&
name|F_WRITE
condition|)
name|cycmd
argument_list|(
name|io
argument_list|,
name|WRITE_FMARK
argument_list|)
expr_stmt|;
name|cycmd
argument_list|(
name|io
argument_list|,
name|REWD_TA
argument_list|)
expr_stmt|;
name|cyblock
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|cystrategy
argument_list|(
name|io
argument_list|,
name|func
argument_list|)
specifier|register
expr|struct
name|iob
operator|*
name|io
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|long
name|func
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifndef|#
directive|ifndef
name|NOBLOCK
if|if
condition|(
operator|(
name|func
operator|!=
name|SPACE
operator|)
operator|&&
operator|(
name|func
operator|!=
name|REWD_TA
operator|)
operator|&&
operator|(
name|io
operator|->
name|i_bn
operator|!=
name|cyblock
operator|)
condition|)
block|{
name|cycmd
argument_list|(
name|io
argument_list|,
name|SPACE
argument_list|)
expr_stmt|;
name|tpb
operator|.
name|rec_over
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|func
operator|==
name|READ
operator|||
name|func
operator|==
name|WRITE
condition|)
block|{
name|struct
name|iob
name|liob
decl_stmt|;
specifier|register
name|struct
name|iob
modifier|*
name|lio
init|=
operator|&
name|liob
decl_stmt|;
specifier|register
name|count
expr_stmt|;
name|liob
operator|=
operator|*
name|io
expr_stmt|;
while|while
condition|(
name|lio
operator|->
name|i_cc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|count
operator|=
name|cycmd
argument_list|(
name|lio
argument_list|,
name|func
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|lio
operator|->
name|i_cc
operator|-=
name|count
expr_stmt|;
name|lio
operator|->
name|i_ma
operator|+=
name|count
expr_stmt|;
block|}
return|return
operator|(
name|io
operator|->
name|i_cc
operator|)
return|;
block|}
endif|#
directive|endif
return|return
operator|(
name|cycmd
argument_list|(
name|io
argument_list|,
name|func
argument_list|)
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|cycmd
argument_list|(
name|io
argument_list|,
name|func
argument_list|)
specifier|register
expr|struct
name|iob
operator|*
name|io
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|long
name|func
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|ctlradr
expr_stmt|;
name|short
name|j
decl_stmt|;
name|ctlradr
operator|=
name|cystd
index|[
literal|0
index|]
operator|+
operator|(
name|int
operator|)
name|IOBASE
expr_stmt|;
name|cywait
argument_list|(
literal|9000
argument_list|)
expr_stmt|;
if|if
condition|(
name|func
operator|==
name|READ
condition|)
name|func
operator|=
name|READ_TA
expr_stmt|;
elseif|else
if|if
condition|(
name|func
operator|==
name|WRITE
condition|)
name|func
operator|=
name|WRIT_TA
expr_stmt|;
elseif|else
if|if
condition|(
name|func
operator|==
name|WRITE_FMARK
condition|)
name|func
operator|=
name|WRIT_FM
expr_stmt|;
name|tpb
operator|.
name|cmd
operator|=
name|func
expr_stmt|;
name|uncache
argument_list|(
operator|&
name|ccb
operator|.
name|gate
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|ccb
operator|.
name|gate
index|[
literal|0
index|]
operator|==
name|GATE_CLOSED
condition|)
name|uncache
argument_list|(
operator|&
name|ccb
operator|.
name|gate
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ccb
operator|.
name|gate
index|[
literal|0
index|]
operator|=
name|GATE_CLOSED
expr_stmt|;
name|tpb
operator|.
name|control
index|[
literal|0
index|]
operator|=
name|CW_BL
expr_stmt|;
name|tpb
operator|.
name|control
index|[
literal|1
index|]
operator|=
name|CW_16bits
expr_stmt|;
name|tpb
operator|.
name|status
index|[
literal|0
index|]
operator|=
name|tpb
operator|.
name|status
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|tpb
operator|.
name|count
operator|=
literal|0
expr_stmt|;
name|set_pointer
argument_list|(
operator|(
name|long
operator|)
operator|&
name|tpb
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ccb
operator|.
name|pt_tpb
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|func
condition|)
block|{
case|case
name|READ_TA
case|:
if|if
condition|(
name|io
operator|->
name|i_cc
operator|>
name|cyblksiz
condition|)
name|tpb
operator|.
name|size
operator|=
name|TM_SHORT
argument_list|(
name|cyblksiz
argument_list|)
expr_stmt|;
else|else
name|tpb
operator|.
name|size
operator|=
name|TM_SHORT
argument_list|(
name|io
operator|->
name|i_cc
argument_list|)
expr_stmt|;
name|set_pointer
argument_list|(
operator|(
name|long
operator|)
name|io
operator|->
name|i_ma
argument_list|,
operator|(
name|char
operator|*
operator|)
name|tpb
operator|.
name|pt_data
argument_list|)
expr_stmt|;
name|cyblock
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|WRIT_TA
case|:
name|tpb
operator|.
name|size
operator|=
name|TM_SHORT
argument_list|(
name|io
operator|->
name|i_cc
argument_list|)
expr_stmt|;
name|set_pointer
argument_list|(
operator|(
name|long
operator|)
name|io
operator|->
name|i_ma
argument_list|,
operator|(
name|char
operator|*
operator|)
name|tpb
operator|.
name|pt_data
argument_list|)
expr_stmt|;
name|cyblock
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|SPACE
case|:
if|if
condition|(
operator|(
name|j
operator|=
name|io
operator|->
name|i_bn
operator|-
name|cyblock
operator|)
operator|<
literal|0
condition|)
block|{
name|j
operator|=
operator|-
name|j
expr_stmt|;
name|tpb
operator|.
name|control
index|[
literal|1
index|]
operator||=
name|CW_R
expr_stmt|;
name|cyblock
operator|-=
name|j
expr_stmt|;
block|}
else|else
name|cyblock
operator|+=
name|j
expr_stmt|;
name|tpb
operator|.
name|rec_over
operator|=
name|TM_SHORT
argument_list|(
name|j
argument_list|)
expr_stmt|;
break|break;
case|case
name|REWD_TA
case|:
name|cyblock
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|TM_ATTENTION
argument_list|(
name|ctlradr
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* execute! */
if|if
condition|(
name|func
operator|==
name|REWD_TA
operator|||
name|func
operator|==
name|SPACE
condition|)
block|{
name|cywait
argument_list|(
literal|60
operator|*
literal|5
operator|*
literal|1000
argument_list|)
expr_stmt|;
block|}
else|else
name|cywait
argument_list|(
literal|10
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/* 	 * First we clear the interrupt and close the gate. 	 */
name|mtpr
argument_list|(
name|PADC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ccb
operator|.
name|gate
index|[
literal|0
index|]
operator|=
name|GATE_CLOSED
expr_stmt|;
name|set_pointer
argument_list|(
operator|(
name|int
operator|)
operator|&
name|cycool
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ccb
operator|.
name|pt_tpb
argument_list|)
expr_stmt|;
name|cycool
operator|.
name|cmd
operator|=
name|NO_OP
expr_stmt|;
comment|/* no operation */
name|cycool
operator|.
name|control
index|[
literal|0
index|]
operator|=
name|CW_BL
expr_stmt|;
comment|/* No INTERRUPTS */
name|cycool
operator|.
name|control
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TM_ATTENTION
argument_list|(
name|ctlradr
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* cool it ! */
name|cywait
argument_list|(
literal|20000
argument_list|)
expr_stmt|;
name|uncache
argument_list|(
operator|&
name|tpb
operator|.
name|status
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tpb
operator|.
name|status
index|[
literal|1
index|]
operator|&
name|CS_ERm
condition|)
block|{
name|cy_decode_error
argument_list|(
name|tpb
operator|.
name|status
index|[
literal|1
index|]
operator|&
name|CS_ERm
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|uncache
argument_list|(
operator|&
name|tpb
operator|.
name|count
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|long
operator|)
name|TM_SHORT
argument_list|(
name|tpb
operator|.
name|count
argument_list|)
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|cyprint_error
argument_list|(
name|message
argument_list|)
specifier|register
name|char
operator|*
name|message
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"cy0: %s.\n"
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* */
end_comment

begin_expr_stmt
name|cy_decode_error
argument_list|(
name|status
argument_list|)
specifier|register
name|int
name|status
expr_stmt|;
end_expr_stmt

begin_block
block|{
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|ER_TO1
case|:
case|case
name|ER_TO2
case|:
case|case
name|ER_TO3
case|:
case|case
name|ER_TO4
case|:
case|case
name|ER_TO5
case|:
name|cyprint_error
argument_list|(
literal|"Drive timed out during transfer"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_TO6
case|:
name|cyprint_error
argument_list|(
literal|"Non-existant system memory reference"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_DIAG
case|:
case|case
name|ER_JUMP
case|:
name|cyprint_error
argument_list|(
literal|"Controller micro diagnostics failed"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_HARD
case|:
name|cyprint_error
argument_list|(
literal|"Unrecoverble media error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_TOF
case|:
if|if
condition|(
name|tpb
operator|.
name|cmd
operator|==
name|WRIT_TA
condition|)
name|cyprint_error
argument_list|(
literal|"Unsatisfactory media"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_FIFO
case|:
name|cyprint_error
argument_list|(
literal|"Data transfer over run"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_TRN
case|:
name|cyprint_error
argument_list|(
literal|"Drive is not ready"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_PRO
case|:
name|cyprint_error
argument_list|(
literal|"Tape is write protected"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_PSUM
case|:
name|cyprint_error
argument_list|(
literal|"Checksum error in controller proms"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_PARI
case|:
name|cyprint_error
argument_list|(
literal|"Unrecoverable tape parity error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_BLAN
case|:
name|cyprint_error
argument_list|(
literal|"Blank tape found where data was expected"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ER_ER
case|:
name|cyprint_error
argument_list|(
literal|"Unrecoverble hardware error"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
block|}
end_block

begin_function
name|long
name|cywait
parameter_list|(
name|timeout
parameter_list|)
name|long
name|timeout
decl_stmt|;
block|{
name|long
name|dummy
decl_stmt|;
name|uncache
argument_list|(
operator|&
name|ccb
operator|.
name|gate
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|ccb
operator|.
name|gate
index|[
literal|0
index|]
operator|!=
name|GATE_OPEN
condition|)
block|{
name|uncache
argument_list|(
operator|&
name|ccb
operator|.
name|gate
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|timeout
operator|==
literal|0
condition|)
block|{
name|cyprint_error
argument_list|(
literal|"Transfer timeout"
argument_list|)
expr_stmt|;
name|_stop
argument_list|(
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  *  Set a TAPEMASTER pointer (first parameter), into the  *  4 bytes array pointed by the second parameter.  */
end_comment

begin_macro
name|set_pointer
argument_list|(
argument|pointer
argument_list|,
argument|dest
argument_list|)
end_macro

begin_decl_stmt
name|long
name|pointer
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|dest
decl_stmt|;
end_decl_stmt

begin_block
block|{
operator|*
name|dest
operator|++
operator|=
name|pointer
operator|&
literal|0xff
expr_stmt|;
comment|/* low byte - offset */
operator|*
name|dest
operator|++
operator|=
operator|(
name|pointer
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
comment|/* high byte - offset */
operator|*
name|dest
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|dest
operator|=
operator|(
name|pointer
operator|&
literal|0xf0000
operator|)
operator|>>
literal|12
expr_stmt|;
comment|/* base */
block|}
end_block

end_unit


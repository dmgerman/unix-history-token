begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)correct.c	1.3 (Berkeley/CCI) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"vdfmt.h"
end_include

begin_include
include|#
directive|include
file|"cmd.h"
end_include

begin_comment
comment|/* ** */
end_comment

begin_macro
name|correct
argument_list|()
end_macro

begin_block
block|{
name|cur
operator|.
name|state
operator|=
name|cor
expr_stmt|;
name|print
argument_list|(
literal|"Making corrections to bad sector map on "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"controller %d, drive %d, "
argument_list|,
name|cur
operator|.
name|controller
argument_list|,
name|cur
operator|.
name|drive
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type %s.\n"
argument_list|,
name|lab
operator|->
name|d_typename
argument_list|)
expr_stmt|;
name|indent
argument_list|()
expr_stmt|;
if|if
condition|(
name|is_formatted
argument_list|()
operator|==
name|true
condition|)
if|if
condition|(
name|read_bad_sector_map
argument_list|()
operator|==
name|true
condition|)
block|{
name|get_corrections
argument_list|()
expr_stmt|;
name|cur
operator|.
name|substate
operator|=
name|sub_wmap
expr_stmt|;
name|sync_bad_sector_map
argument_list|()
expr_stmt|;
block|}
else|else
name|print
argument_list|(
literal|"There is no bad sector map on this drive!\n"
argument_list|)
expr_stmt|;
else|else
name|print
argument_list|(
literal|"Drive must be formatted befor corrections are done.\n"
argument_list|)
expr_stmt|;
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|cor_help
argument_list|()
end_macro

begin_block
block|{
name|indent
argument_list|()
expr_stmt|;
name|print
argument_list|(
literal|"Correction commands are in the following form:\n"
argument_list|)
expr_stmt|;
name|indent
argument_list|()
expr_stmt|;
name|print
argument_list|(
literal|"ID              -  Correct module serial number.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"[a-h] (block)   -  UNIX file system format.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"SEctor (sector) -  Absolute sector number on disk.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Track (track)   -  Absolute disk track number.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"(cylinder) (head) (offset) (length) - CDC flaw map format.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"CLEAR           -  Remove all relocations not from flaw map.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"STARt           -  Ends correction process.\n\n"
argument_list|)
expr_stmt|;
name|exdent
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|get_corrections
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|int
name|id_help
parameter_list|()
function_decl|;
name|char
name|line
index|[
literal|256
index|]
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|bs_entry
name|entry
decl_stmt|;
name|dskadr
name|dskaddr
decl_stmt|;
name|fmt_err
name|dskerr
decl_stmt|;
name|int
name|max_track
decl_stmt|;
specifier|register
name|int
name|block
decl_stmt|;
name|dskaddr
operator|.
name|cylinder
operator|=
name|lab
operator|->
name|d_ncylinders
operator|-
literal|1
expr_stmt|;
name|dskaddr
operator|.
name|cylinder
operator|=
name|lab
operator|->
name|d_ntracks
operator|-
literal|1
expr_stmt|;
name|max_track
operator|=
name|to_track
argument_list|(
name|dskaddr
argument_list|)
expr_stmt|;
name|indent
argument_list|()
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|print
argument_list|(
literal|"Location? "
argument_list|)
expr_stmt|;
name|get_string_cmd
argument_list|(
name|line
argument_list|,
name|cor_help
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
break|break;
if|if
condition|(
name|line
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
continue|continue;
name|ptr
operator|=
name|line
expr_stmt|;
name|trim_white
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"he"
argument_list|,
literal|2
argument_list|)
operator|||
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"?"
argument_list|,
literal|1
argument_list|)
operator|||
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"stat"
argument_list|,
literal|4
argument_list|)
operator|||
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"!"
argument_list|,
literal|1
argument_list|)
condition|)
continue|continue;
name|indent
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"id"
argument_list|,
literal|2
argument_list|)
condition|)
block|{
specifier|register
name|int
name|temp
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|print
argument_list|(
literal|"Pack ID is %d. Change to? "
argument_list|,
name|bad_map
operator|->
name|bs_id
argument_list|)
expr_stmt|;
name|temp
operator|=
name|get_digit_cmd
argument_list|(
name|id_help
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|>
literal|0
condition|)
break|break;
block|}
name|D_INFO
operator|->
name|id
operator|=
name|bad_map
operator|->
name|bs_id
operator|=
name|temp
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|ptr
argument_list|,
literal|"clear"
argument_list|)
condition|)
block|{
name|print
argument_list|(
literal|"Confirm removal of ALL relocations installed manually\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_yes_no
argument_list|(
literal|"or by verification"
argument_list|)
operator|==
name|true
condition|)
name|clear_relocations
argument_list|(
name|true
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|ptr
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
operator|*
name|ptr
operator|<=
literal|'h'
operator|)
condition|)
block|{
specifier|register
name|char
name|par
init|=
operator|*
name|ptr
operator|++
decl_stmt|;
name|block
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|dskerr
operator|.
name|err_adr
operator|=
operator|*
name|from_unix
argument_list|(
operator|(
name|unsigned
name|char
operator|)
name|par
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|block
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dskerr
operator|.
name|err_adr
operator|.
name|cylinder
operator|==
operator|-
literal|1
operator|)
operator|||
operator|(
name|block
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|print
argument_list|(
literal|"Invalid UNIX block number!\n"
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
name|print
argument_list|(
literal|"Confirm block %d on file-system '%c'"
argument_list|,
name|block
argument_list|,
name|par
argument_list|)
expr_stmt|;
name|dskerr
operator|.
name|err_stat
operator|=
name|DATA_ERROR
expr_stmt|;
name|doreloc
label|:
name|printf
argument_list|(
literal|" (cn %d tn %d bn %d)"
argument_list|,
name|dskerr
operator|.
name|err_adr
operator|.
name|cylinder
argument_list|,
name|dskerr
operator|.
name|err_adr
operator|.
name|track
argument_list|,
name|dskerr
operator|.
name|err_adr
operator|.
name|sector
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_yes_no
argument_list|(
literal|""
argument_list|)
operator|==
name|true
condition|)
block|{
call|(
modifier|*
name|C_INFO
operator|->
name|code_pos
call|)
argument_list|(
operator|&
name|dskerr
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|remove_user_relocations
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'t'
condition|)
block|{
name|block
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|block
operator|==
operator|-
literal|1
operator|)
operator|||
operator|(
name|block
operator|>=
name|max_track
operator|)
condition|)
block|{
name|print
argument_list|(
literal|"Invalid track number!\n"
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
name|dskerr
operator|.
name|err_adr
operator|=
operator|*
name|from_track
argument_list|(
name|block
argument_list|)
expr_stmt|;
name|dskerr
operator|.
name|err_stat
operator|=
name|HEADER_ERROR
expr_stmt|;
name|print
argument_list|(
literal|"Confirm track %d"
argument_list|,
name|block
argument_list|)
expr_stmt|;
goto|goto
name|doreloc
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"se"
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|block
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|block
operator|==
operator|-
literal|1
operator|||
name|block
operator|>
name|lab
operator|->
name|d_nsectors
operator|*
name|lab
operator|->
name|d_ntracks
operator|*
name|lab
operator|->
name|d_ncylinders
condition|)
block|{
name|print
argument_list|(
literal|"Invalid sector number!\n"
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
name|dskerr
operator|.
name|err_adr
operator|=
operator|*
name|from_sector
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|block
argument_list|)
expr_stmt|;
name|dskerr
operator|.
name|err_stat
operator|=
name|DATA_ERROR
expr_stmt|;
name|print
argument_list|(
literal|"Confirm sector %d"
argument_list|,
name|block
argument_list|)
expr_stmt|;
goto|goto
name|doreloc
goto|;
block|}
elseif|else
if|if
condition|(
name|is_digit
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|entry
operator|.
name|bs_cyl
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|skipdigits
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|finddigit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|entry
operator|.
name|bs_trk
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|skipdigits
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|finddigit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|entry
operator|.
name|bs_offset
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|skipdigits
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|finddigit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|entry
operator|.
name|bs_length
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|entry
operator|.
name|bs_trk
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|entry
operator|.
name|bs_offset
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|entry
operator|.
name|bs_length
operator|!=
operator|-
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|entry
operator|.
name|bs_cyl
operator|>=
name|lab
operator|->
name|d_ncylinders
condition|)
name|print
argument_list|(
literal|"Cylinder number to high!\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|entry
operator|.
name|bs_trk
operator|>=
name|lab
operator|->
name|d_ntracks
condition|)
name|print
argument_list|(
literal|"Head number to high!\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|entry
operator|.
name|bs_offset
operator|>=
name|lab
operator|->
name|d_traksize
condition|)
name|print
argument_list|(
literal|"Offset too long!\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|entry
operator|.
name|bs_length
operator|==
literal|0
condition|)
name|print
argument_list|(
literal|"Can't have a 0 length error!\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|print
argument_list|(
literal|"Confirm  Cyl %d, "
argument_list|,
name|entry
operator|.
name|bs_cyl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Head %d, "
argument_list|,
name|entry
operator|.
name|bs_trk
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"offset %d, "
argument_list|,
name|entry
operator|.
name|bs_offset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"length %d"
argument_list|,
name|entry
operator|.
name|bs_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_yes_no
argument_list|(
literal|""
argument_list|)
operator|==
name|true
condition|)
name|remove_user_relocations
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
else|else
goto|goto
name|bad
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"star"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
name|bad
label|:
name|print
argument_list|(
literal|"What?\n"
argument_list|)
expr_stmt|;
name|next
label|:
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


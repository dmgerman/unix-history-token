begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)proc_cmd.c	1.4 (Berkeley/CCI) 11/23/87"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"vdfmt.h"
end_include

begin_include
include|#
directive|include
file|"cmd.h"
end_include

begin_define
define|#
directive|define
name|RESET
value|1
end_define

begin_define
define|#
directive|define
name|LIST
value|2
end_define

begin_define
define|#
directive|define
name|DELETE
value|3
end_define

begin_define
define|#
directive|define
name|FORMAT
value|4
end_define

begin_define
define|#
directive|define
name|VERIFY
value|5
end_define

begin_define
define|#
directive|define
name|RELOCATE
value|6
end_define

begin_define
define|#
directive|define
name|CORRECT
value|7
end_define

begin_define
define|#
directive|define
name|INFO
value|8
end_define

begin_define
define|#
directive|define
name|PROFILE
value|9
end_define

begin_define
define|#
directive|define
name|EXERCISE
value|10
end_define

begin_define
define|#
directive|define
name|START
value|11
end_define

begin_define
define|#
directive|define
name|EXIT
value|12
end_define

begin_decl_stmt
specifier|static
name|cmd_text_element
name|commands
index|[]
init|=
block|{
block|{
name|RESET
block|,
literal|"RESET"
block|,
literal|"Reinitialize VDFORMAT, and start over"
block|}
block|,
block|{
name|EXIT
block|,
literal|"EXIT"
block|,
literal|"Terminate program"
block|}
block|,
block|{
name|LIST
block|,
literal|"List"
block|,
literal|"List operations specified so far"
block|}
block|,
block|{
name|DELETE
block|,
literal|"Delete"
block|,
literal|"Delete specific operations"
block|}
block|,
block|{
name|FORMAT
block|,
literal|"Format"
block|,
literal|"Format and verify disk surface"
block|}
block|,
block|{
name|VERIFY
block|,
literal|"Verify"
block|,
literal|"Destructively verify disk surface"
block|}
block|,
block|{
name|RELOCATE
block|,
literal|"Relocate"
block|,
literal|"Add known flaws to bad sector map"
block|}
block|,
block|{
name|CORRECT
block|,
literal|"Correct"
block|,
literal|"Correct erroneous relocations or drive ID"
block|}
block|,
block|{
name|INFO
block|,
literal|"Info"
block|,
literal|"Display known disk information"
block|}
block|,
block|{
name|PROFILE
block|,
literal|"Profile"
block|,
literal|"Display seek profile graph of disk"
block|}
block|,
block|{
name|EXERCISE
block|,
literal|"Exercise"
block|,
literal|"Perform seek exercises on disk"
block|}
block|,
block|{
name|START
block|,
literal|"STARt"
block|,
literal|"Start operations"
block|}
block|,
block|{
literal|0
block|,
literal|""
block|,
literal|""
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ** */
end_comment

begin_macro
name|process_commands
argument_list|()
end_macro

begin_block
block|{
name|int
name|tokens
index|[
literal|20
index|]
decl_stmt|;
name|int
modifier|*
name|tok_ptr
decl_stmt|,
name|count
decl_stmt|;
name|int
name|op_mask
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|cptr
decl_stmt|;
name|boolean
name|should_start
init|=
name|false
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
operator|(
name|void
operator|)
name|_setjmp
argument_list|(
name|abort_environ
argument_list|)
expr_stmt|;
name|cur
operator|.
name|state
operator|=
name|cmd
expr_stmt|;
name|kill_processes
operator|=
name|false
expr_stmt|;
name|exdent
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
name|op_mask
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"vdformat> "
argument_list|)
expr_stmt|;
name|count
operator|=
name|get_text_cmd
argument_list|(
name|commands
argument_list|,
name|tokens
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
name|_longjmp
argument_list|(
name|quit_environ
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tok_ptr
operator|=
name|tokens
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|tok_ptr
operator|==
literal|0
operator|)
operator|||
operator|!
name|count
condition|)
continue|continue;
while|while
condition|(
operator|*
name|tok_ptr
condition|)
block|{
switch|switch
condition|(
operator|*
name|tok_ptr
condition|)
block|{
case|case
name|RESET
case|:
name|reset
argument_list|()
expr_stmt|;
break|break;
case|case
name|LIST
case|:
name|list
argument_list|()
expr_stmt|;
break|break;
case|case
name|DELETE
case|:
name|delete
argument_list|()
expr_stmt|;
break|break;
case|case
name|FORMAT
case|:
name|op_mask
operator||=
name|FORMAT_OP
expr_stmt|;
break|break;
case|case
name|VERIFY
case|:
name|op_mask
operator||=
name|VERIFY_OP
expr_stmt|;
break|break;
case|case
name|RELOCATE
case|:
name|op_mask
operator||=
name|RELOCATE_OP
expr_stmt|;
break|break;
case|case
name|CORRECT
case|:
name|op_mask
operator||=
name|CORRECT_OP
expr_stmt|;
break|break;
case|case
name|INFO
case|:
name|op_mask
operator||=
name|INFO_OP
expr_stmt|;
break|break;
case|case
name|PROFILE
case|:
name|op_mask
operator||=
name|PROFILE_OP
expr_stmt|;
break|break;
case|case
name|EXERCISE
case|:
name|op_mask
operator||=
name|EXERCISE_OP
expr_stmt|;
break|break;
case|case
name|START
case|:
name|should_start
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|EXIT
case|:
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
default|default:
comment|/* ignore */
break|break;
block|}
name|tok_ptr
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|op_mask
condition|)
block|{
name|get_drive_parameters
argument_list|(
name|op_mask
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|should_start
condition|)
block|{
name|start_commands
argument_list|()
expr_stmt|;
name|should_start
operator|=
name|false
expr_stmt|;
block|}
block|}
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|header_printed
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_macro
name|get_drive_parameters
argument_list|(
argument|op_mask
argument_list|)
end_macro

begin_decl_stmt
name|int
name|op_mask
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|c_list
index|[
literal|20
index|]
decl_stmt|,
name|i
decl_stmt|,
name|num_pat
decl_stmt|;
name|indent
argument_list|()
expr_stmt|;
name|header_printed
operator|=
name|false
expr_stmt|;
name|get_ctlr_list
argument_list|(
name|c_list
argument_list|,
name|op_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
block|{
name|kill_processes
operator|=
name|false
expr_stmt|;
name|c_list
index|[
literal|0
index|]
operator|=
operator|-
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|c_list
index|[
name|i
index|]
operator|!=
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|int
name|d_list
index|[
literal|40
index|]
decl_stmt|,
name|j
decl_stmt|;
name|indent
argument_list|()
expr_stmt|;
name|get_drive_list
argument_list|(
name|c_list
index|[
name|i
index|]
argument_list|,
name|d_list
argument_list|,
name|op_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
block|{
name|kill_processes
operator|=
name|false
expr_stmt|;
break|break;
block|}
name|indent
argument_list|()
expr_stmt|;
if|if
condition|(
name|op_mask
operator|&
operator|(
name|FORMAT_OP
operator||
name|VERIFY_OP
operator|)
condition|)
block|{
name|num_pat
operator|=
name|get_num_pat
argument_list|()
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
block|{
name|kill_processes
operator|=
name|false
expr_stmt|;
break|break;
block|}
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|d_list
index|[
name|j
index|]
operator|!=
operator|-
literal|1
condition|;
name|j
operator|++
control|)
block|{
name|cur
operator|.
name|controller
operator|=
name|c_list
index|[
name|i
index|]
expr_stmt|;
name|cur
operator|.
name|drive
operator|=
name|d_list
index|[
name|j
index|]
expr_stmt|;
name|C_INFO
operator|=
operator|&
name|c_info
index|[
name|cur
operator|.
name|controller
index|]
expr_stmt|;
name|D_INFO
operator|=
operator|&
name|d_info
index|[
name|cur
operator|.
name|controller
index|]
index|[
name|cur
operator|.
name|drive
index|]
expr_stmt|;
name|lab
operator|=
operator|&
name|D_INFO
operator|->
name|label
expr_stmt|;
name|get_drive_type
argument_list|(
name|cur
operator|.
name|controller
argument_list|,
name|cur
operator|.
name|drive
argument_list|,
name|op_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
block|{
name|kill_processes
operator|=
name|false
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|op_mask
operator|&
operator|~
name|INFO_OP
condition|)
block|{
name|indent
argument_list|()
expr_stmt|;
name|get_drive_id
argument_list|(
name|c_list
index|[
name|i
index|]
argument_list|,
name|d_list
index|[
name|j
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
block|{
name|kill_processes
operator|=
name|false
expr_stmt|;
break|break;
block|}
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ops_to_do
index|[
name|c_list
index|[
name|i
index|]
index|]
index|[
name|d_list
index|[
name|j
index|]
index|]
operator|.
name|op
operator||=
name|op_mask
expr_stmt|;
if|if
condition|(
name|op_mask
operator|&
operator|(
name|FORMAT_OP
operator||
name|VERIFY_OP
operator|)
condition|)
name|ops_to_do
index|[
name|c_list
index|[
name|i
index|]
index|]
index|[
name|d_list
index|[
name|j
index|]
index|]
operator|.
name|numpat
operator|=
name|num_pat
expr_stmt|;
block|}
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|exdent
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|get_ctlr_list
argument_list|(
argument|c_list
argument_list|,
argument|op_mask
argument_list|)
end_macro

begin_decl_stmt
name|int
modifier|*
name|c_list
decl_stmt|,
name|op_mask
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|int
name|ctlr_help
parameter_list|()
function_decl|;
specifier|register
name|int
name|i
decl_stmt|,
name|ctlr
decl_stmt|;
name|int
name|table
index|[
name|MAXCTLR
operator|+
literal|10
index|]
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ctlr
operator|=
literal|0
init|;
name|ctlr
operator|<
name|MAXCTLR
condition|;
name|ctlr
operator|++
control|)
if|if
condition|(
name|c_info
index|[
name|ctlr
index|]
operator|.
name|alive
operator|==
name|u_true
condition|)
name|table
index|[
name|i
operator|++
index|]
operator|=
name|ctlr
expr_stmt|;
name|table
index|[
name|i
index|]
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* If only one controller is possible don't ask */
if|if
condition|(
name|table
index|[
literal|1
index|]
operator|==
operator|-
literal|1
condition|)
block|{
operator|*
name|c_list
operator|++
operator|=
name|table
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|c_list
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|header_printed
operator|=
name|true
expr_stmt|;
name|print
argument_list|(
literal|""
argument_list|)
expr_stmt|;
comment|/* Force indent */
name|print_op_list
argument_list|(
name|op_mask
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" on which controllers? "
argument_list|)
expr_stmt|;
name|get_digit_list
argument_list|(
name|c_list
argument_list|,
name|table
argument_list|,
name|ctlr_help
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
return|return;
if|if
condition|(
operator|*
name|c_list
operator|!=
operator|-
literal|1
condition|)
break|break;
block|}
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|ctlr_help
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|ctlr
decl_stmt|;
name|indent
argument_list|()
expr_stmt|;
name|print
argument_list|(
literal|"The following controllers are attached to the system:\n"
argument_list|)
expr_stmt|;
name|indent
argument_list|()
expr_stmt|;
for|for
control|(
name|ctlr
operator|=
literal|0
init|;
name|ctlr
operator|<
name|MAXCTLR
condition|;
name|ctlr
operator|++
control|)
if|if
condition|(
name|c_info
index|[
name|ctlr
index|]
operator|.
name|alive
operator|==
name|u_true
condition|)
block|{
name|print
argument_list|(
literal|"Controller %d, which is a%s %s controller.\n"
argument_list|,
name|ctlr
argument_list|,
operator|(
name|c_info
index|[
name|ctlr
index|]
operator|.
name|name
index|[
literal|0
index|]
operator|==
literal|'S'
operator|)
condition|?
literal|"n"
else|:
literal|""
argument_list|,
name|c_info
index|[
name|ctlr
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
name|print
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|exdent
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
specifier|static
name|int
name|max_drive
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ** */
end_comment

begin_macro
name|get_drive_list
argument_list|(
argument|ctlr
argument_list|,
argument|d_list
argument_list|,
argument|op_mask
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ctlr
decl_stmt|,
modifier|*
name|d_list
decl_stmt|,
name|op_mask
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|int
name|drive_help
parameter_list|()
function_decl|;
name|int
name|table
index|[
name|MAXDRIVE
operator|+
literal|10
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|max_drive
operator|=
operator|(
name|c_info
index|[
name|ctlr
index|]
operator|.
name|type
operator|==
name|VDTYPE_VDDC
operator|)
condition|?
literal|4
else|:
literal|16
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_drive
condition|;
name|i
operator|++
control|)
name|table
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
name|table
index|[
name|i
index|]
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|header_printed
operator|==
name|true
condition|)
name|print
argument_list|(
literal|"Drives on controller %d? "
argument_list|,
name|ctlr
argument_list|)
expr_stmt|;
else|else
block|{
name|header_printed
operator|=
name|true
expr_stmt|;
name|print
argument_list|(
literal|""
argument_list|)
expr_stmt|;
comment|/* Force indent */
name|print_op_list
argument_list|(
name|op_mask
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" on which drives? "
argument_list|)
expr_stmt|;
block|}
name|get_digit_list
argument_list|(
name|d_list
argument_list|,
name|table
argument_list|,
name|drive_help
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
return|return;
if|if
condition|(
operator|*
name|d_list
operator|!=
operator|-
literal|1
condition|)
break|break;
block|}
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|id_help
argument_list|()
end_macro

begin_block
block|{
name|indent
argument_list|()
expr_stmt|;
name|print
argument_list|(
literal|"The following commands are available:\n"
argument_list|)
expr_stmt|;
name|indent
argument_list|()
expr_stmt|;
name|print
argument_list|(
literal|"STATus - Display formatter state.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"QUIT   - Terminate current operation.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"A module serial can be any number greater than zero.\n"
argument_list|)
expr_stmt|;
name|exdent
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|get_drive_id
argument_list|(
argument|ctlr
argument_list|,
argument|drive
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ctlr
decl_stmt|,
name|drive
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|new_id
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|print
argument_list|(
literal|"Module serial number for controller %d, drive %d? "
argument_list|,
name|ctlr
argument_list|,
name|drive
argument_list|)
expr_stmt|;
if|if
condition|(
name|d_info
index|[
name|ctlr
index|]
index|[
name|drive
index|]
operator|.
name|id
operator|!=
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"(%d) "
argument_list|,
name|d_info
index|[
name|ctlr
index|]
index|[
name|drive
index|]
operator|.
name|id
argument_list|)
expr_stmt|;
name|new_id
operator|=
name|get_digit_cmd
argument_list|(
name|id_help
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_id
operator|>
literal|0
condition|)
block|{
name|d_info
index|[
name|ctlr
index|]
index|[
name|drive
index|]
operator|.
name|id
operator|=
name|new_id
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|d_info
index|[
name|ctlr
index|]
index|[
name|drive
index|]
operator|.
name|id
operator|!=
operator|-
literal|1
condition|)
break|break;
block|}
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|drive_help
argument_list|()
end_macro

begin_block
block|{
name|indent
argument_list|()
expr_stmt|;
name|print
argument_list|(
literal|"Drive numbers 0 through %d may be entered.\n"
argument_list|,
name|max_drive
operator|-
literal|1
argument_list|)
expr_stmt|;
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|pat_help
argument_list|()
end_macro

begin_block
block|{
name|indent
argument_list|()
expr_stmt|;
name|print
argument_list|(
literal|"Between 0 and 16 patterns may be used while verifying.\n"
argument_list|)
expr_stmt|;
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|get_num_pat
argument_list|()
end_macro

begin_block
block|{
name|int
name|table
index|[
literal|17
operator|+
literal|10
index|]
decl_stmt|;
name|int
name|results
index|[
literal|17
operator|+
literal|10
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|16
condition|;
name|i
operator|++
control|)
name|table
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
name|table
index|[
name|i
index|]
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|print
argument_list|(
literal|"Number of patterns to use while verifying? "
argument_list|)
expr_stmt|;
name|get_digit_list
argument_list|(
name|results
argument_list|,
name|table
argument_list|,
name|pat_help
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|results
index|[
literal|0
index|]
operator|!=
operator|-
literal|1
condition|)
break|break;
block|}
return|return
name|results
index|[
literal|0
index|]
return|;
block|}
end_block

end_unit


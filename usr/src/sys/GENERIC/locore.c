begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifdef
ifdef|#
directive|ifdef
name|LOCORE
end_ifdef

begin_define
define|#
directive|define
name|P_LINK
value|0
end_define

begin_define
define|#
directive|define
name|P_RLINK
value|4
end_define

begin_define
define|#
directive|define
name|P_XLINK
value|100
end_define

begin_define
define|#
directive|define
name|P_ADDR
value|8
end_define

begin_define
define|#
directive|define
name|P_PRI
value|13
end_define

begin_define
define|#
directive|define
name|P_STAT
value|15
end_define

begin_define
define|#
directive|define
name|P_WCHAN
value|88
end_define

begin_define
define|#
directive|define
name|P_TSIZE
value|60
end_define

begin_define
define|#
directive|define
name|P_SSIZE
value|68
end_define

begin_define
define|#
directive|define
name|P_P0BR
value|96
end_define

begin_define
define|#
directive|define
name|P_SZPT
value|58
end_define

begin_define
define|#
directive|define
name|P_TEXTP
value|92
end_define

begin_define
define|#
directive|define
name|P_FLAG
value|36
end_define

begin_define
define|#
directive|define
name|SSLEEP
value|1
end_define

begin_define
define|#
directive|define
name|SRUN
value|3
end_define

begin_define
define|#
directive|define
name|UBA_BRRVR
value|48
end_define

begin_define
define|#
directive|define
name|UH_UBA
value|0
end_define

begin_define
define|#
directive|define
name|UH_VEC
value|8
end_define

begin_define
define|#
directive|define
name|UH_SIZE
value|52
end_define

begin_define
define|#
directive|define
name|RP_FLAG
value|12
end_define

begin_define
define|#
directive|define
name|X_CADDR
value|56
end_define

begin_define
define|#
directive|define
name|V_SWTCH
value|0
end_define

begin_define
define|#
directive|define
name|V_TRAP
value|4
end_define

begin_define
define|#
directive|define
name|V_SYSCALL
value|8
end_define

begin_define
define|#
directive|define
name|V_INTR
value|12
end_define

begin_define
define|#
directive|define
name|V_PDMA
value|16
end_define

begin_define
define|#
directive|define
name|V_FAULTS
value|88
end_define

begin_define
define|#
directive|define
name|V_PGREC
value|48
end_define

begin_define
define|#
directive|define
name|V_FASTPGREC
value|108
end_define

begin_define
define|#
directive|define
name|UPAGES
value|8
end_define

begin_define
define|#
directive|define
name|CLSIZE
value|2
end_define

begin_define
define|#
directive|define
name|SYSPTSIZE
value|3584
end_define

begin_define
define|#
directive|define
name|USRPTSIZE
value|1024
end_define

begin_define
define|#
directive|define
name|MSGBUFPTECNT
value|8
end_define

begin_define
define|#
directive|define
name|NMBCLUSTERS
value|256
end_define

begin_define
define|#
directive|define
name|U_PROCP
value|124
end_define

begin_define
define|#
directive|define
name|U_RU
value|1296
end_define

begin_define
define|#
directive|define
name|RU_MINFLT
value|32
end_define

begin_else
else|#
directive|else
end_else

begin_asm
asm|asm(".set	U_ARG,388");
end_asm

begin_asm
asm|asm(".set	U_QSAVE,-1881318947");
end_asm

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*	rpb.s	6.1	83/08/01	*/
end_comment

begin_comment
comment|/*  * This has to get loaded first (physical 0) as 780 memory restart rom  * only looks for rpb on a 64K page boundary (doc isn't wrong,  * it never says what size "page boundary" rpb has to be on).  */
end_comment

begin_expr_stmt
operator|.
name|globl
name|_rpb
name|_rpb
operator|:
operator|.
name|space
literal|508
name|erpb
operator|:
operator|.
name|space
literal|4
comment|/*	scb.s	6.1	83/08/11	*/
include|#
directive|include
file|"uba.h"
comment|/*  * System control block  */
operator|.
name|set
name|INTSTK
operator|,
literal|1
operator|#
name|handle
name|this
name|interrupt
name|on
name|the
name|interrupt
name|stack
operator|.
name|set
name|HALT
operator|,
literal|3
operator|#
name|halt
end_expr_stmt

begin_if
if|if this interrupt occurs  _scb:	.globl	_scb
define|#
directive|define
name|STRAY
value|.long	_Xstray+INTSTK
define|#
directive|define
name|STRAY8
value|STRAY;STRAY;STRAY;STRAY;STRAY;STRAY;STRAY;STRAY
define|#
directive|define
name|STRAY15
value|STRAY;STRAY;STRAY;STRAY;STRAY;STRAY;STRAY;STRAY8
define|#
directive|define
name|KS
parameter_list|(
name|a
parameter_list|)
value|.long	_X
comment|/**/
value|a
define|#
directive|define
name|IS
parameter_list|(
name|a
parameter_list|)
value|.long	_X
comment|/**/
value|a+INTSTK
define|#
directive|define
name|STOP
parameter_list|(
name|a
parameter_list|)
value|.long	_X
comment|/**/
value|a+HALT
comment|/* 000 */
if|STRAY
empty_stmt|;
end_if

begin_expr_stmt
name|IS
argument_list|(
name|machcheck
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IS
argument_list|(
name|kspnotval
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STOP
argument_list|(
name|powfail
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 010 */
end_comment

begin_expr_stmt
name|KS
argument_list|(
name|privinflt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|xfcflt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|resopflt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|resadflt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 020 */
end_comment

begin_expr_stmt
name|KS
argument_list|(
name|protflt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|transflt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|tracep
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|bptflt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 030 */
end_comment

begin_expr_stmt
name|KS
argument_list|(
name|compatflt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|arithtrap
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 040 */
end_comment

begin_expr_stmt
name|KS
argument_list|(
name|syscall
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|chme
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|chms
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|chmu
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 050 */
end_comment

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IS
argument_list|(
name|cmrd
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 060 */
end_comment

begin_expr_stmt
name|IS
argument_list|(
name|wtime
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 070 */
end_comment

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 080 */
end_comment

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|KS
argument_list|(
name|astflt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 090 */
end_comment

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 0a0 */
end_comment

begin_expr_stmt
name|IS
argument_list|(
name|softclock
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 0b0 */
end_comment

begin_expr_stmt
name|IS
argument_list|(
name|netintr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 0c0 */
end_comment

begin_expr_stmt
name|IS
argument_list|(
name|hardclock
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 0d0 */
end_comment

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 0e0 */
end_comment

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 0f0 */
end_comment

begin_expr_stmt
name|IS
argument_list|(
name|consdin
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IS
argument_list|(
name|consdout
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IS
argument_list|(
name|cnrint
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IS
argument_list|(
name|cnxint
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 100 */
end_comment

begin_expr_stmt
name|IS
argument_list|(
name|nexzvec
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY15
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* ipl 0x14, nexus 0-15 */
end_comment

begin_comment
comment|/* 140 */
end_comment

begin_expr_stmt
name|IS
argument_list|(
name|nexzvec
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY15
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* ipl 0x15, nexus 0-15 */
end_comment

begin_comment
comment|/* 180 */
end_comment

begin_expr_stmt
name|IS
argument_list|(
name|nexzvec
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY15
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* ipl 0x16, nexus 0-15 */
end_comment

begin_comment
comment|/* 1c0 */
end_comment

begin_expr_stmt
name|IS
argument_list|(
name|nexzvec
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|STRAY15
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* ipl 0x17, nexus 0-15 */
end_comment

begin_expr_stmt
operator|.
name|globl
name|_UNIvec
name|_UNIvec
operator|:
operator|.
name|space
literal|512
operator|#
literal|750
name|unibus
name|intr
name|vector
empty|# 1st UBA jump table on 780's
if|#
directive|if
name|NUBA
operator|>
literal|1
operator|.
name|globl
name|_UNI1vec
name|_UNI1vec
operator|:
operator|.
name|space
literal|512
operator|#
literal|750
name|second
name|unibus
name|intr
name|vector
empty|# 2nd UBA jump table on 780's
endif|#
directive|endif
comment|/*	locore.s	6.3	83/08/12	*/
include|#
directive|include
file|"../machine/psl.h"
include|#
directive|include
file|"../machine/pte.h"
include|#
directive|include
file|"../h/errno.h"
include|#
directive|include
file|"../vax/mtpr.h"
include|#
directive|include
file|"../vax/trap.h"
include|#
directive|include
file|"../vax/cpu.h"
include|#
directive|include
file|"../vax/nexus.h"
include|#
directive|include
file|"../vax/cons.h"
include|#
directive|include
file|"../vax/clock.h"
include|#
directive|include
file|"../vaxuba/ubareg.h"
include|#
directive|include
file|"dh.h"
include|#
directive|include
file|"dz.h"
include|#
directive|include
file|"uu.h"
include|#
directive|include
file|"ps.h"
include|#
directive|include
file|"mba.h"
operator|.
name|set
name|HIGH
operator|,
literal|0x1f
operator|#
name|mask
end_expr_stmt

begin_for
for|for total disable 	.set	MCKVEC
operator|,
literal|4
operator|#
name|offset
name|into
name|scb
name|of
name|machine
name|check
name|vector
operator|.
name|set
name|NBPG
operator|,
literal|512
operator|.
name|set
name|PGSHIFT
operator|,
literal|9
operator|.
name|set
name|NISP
operator|,
literal|3
operator|#
name|number
name|of
name|interrupt
name|stack
name|pages
comment|/*  * User structure is UPAGES at top of user space.  */
operator|.
name|globl
name|_u
operator|.
name|set
name|_u
operator|,
literal|0x80000000
operator|-
name|UPAGES
operator|*
name|NBPG
operator|.
name|globl
name|_intstack
name|_intstack
operator|:
operator|.
name|space
name|NISP
operator|*
name|NBPG
name|eintstack
operator|:
comment|/*  * Do a dump.  * Called by auto-restart.  * May be called manually.  */
operator|.
name|align
literal|2
operator|.
name|globl
name|_doadump
name|_doadump
operator|:
name|nop
expr_stmt|;
end_for

begin_expr_stmt
name|nop
operator|#
operator|.
name|word
literal|0x0101
define|#
directive|define
name|_rpbmap
value|_Sysmap				# rpb, scb, UNI*vec, istack*4
name|bicl2
name|$PG_PROT
operator|,
name|_rpbmap
name|bisl2
name|$PG_KW
operator|,
name|_rpbmap
name|tstl
name|_rpb
operator|+
name|RP_FLAG
operator|#
name|dump
name|only
name|once
operator|!
name|bneq
literal|1f
name|incl
name|_rpb
operator|+
name|RP_FLAG
name|mtpr
name|$0
operator|,
name|$TBIA
name|movl
name|sp
operator|,
name|erpb
name|movab
name|erpb
operator|,
name|sp
name|mfpr
name|$PCBB
operator|,
operator|-
operator|(
name|sp
operator|)
name|mfpr
name|$MAPEN
operator|,
operator|-
operator|(
name|sp
operator|)
name|mfpr
name|$IPL
operator|,
operator|-
operator|(
name|sp
operator|)
name|mtpr
name|$0
operator|,
name|$MAPEN
name|mtpr
name|$HIGH
operator|,
name|$IPL
name|pushr
name|$0x3fff
name|calls
name|$0
operator|,
name|_dumpsys
literal|1
operator|:
name|mfpr
name|$TXCS
operator|,
name|r0
name|bitl
name|$TXCS_RDY
operator|,
name|r0
name|beql
literal|1b
name|mtpr
name|$TXDB_BOOT
operator|,
name|$TXDB
name|halt
comment|/*  * Interrupt vector routines  */
operator|.
name|globl
name|_waittime
define|#
directive|define
name|SCBVEC
parameter_list|(
name|name
parameter_list|)
value|.align 2; .globl _X
comment|/**/
value|name; _X
comment|/**/
value|name
define|#
directive|define
name|PANIC
parameter_list|(
name|msg
parameter_list|)
value|clrl _waittime; pushab 1f; \ 			calls $1,_panic; 1: .asciz msg
define|#
directive|define
name|PRINTF
parameter_list|(
name|n
parameter_list|,
name|msg
parameter_list|)
value|pushab 1f; calls $n+1,_printf; MSG(msg)
define|#
directive|define
name|MSG
parameter_list|(
name|msg
parameter_list|)
value|.data; 1: .asciz msg; .text
define|#
directive|define
name|PUSHR
value|pushr $0x3f
define|#
directive|define
name|POPR
value|popr $0x3f
name|SCBVEC
argument_list|(
name|machcheck
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|pushab
literal|6
operator|*
literal|4
operator|(
name|sp
operator|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$1
decl_stmt|,
name|_machinecheck
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|POPR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|addl2
argument_list|(
name|sp
argument_list|)
operator|+
operator|,
name|sp
expr_stmt|;
end_expr_stmt

begin_macro
name|rei
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|kspnotval
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PANIC
argument_list|(
literal|"KSP not valid"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SCBVEC
argument_list|(
name|powfail
argument_list|)
operator|:
name|halt
name|SCBVEC
argument_list|(
name|chme
argument_list|)
operator|:
name|SCBVEC
argument_list|(
name|chms
argument_list|)
operator|:
name|SCBVEC
argument_list|(
name|chmu
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PANIC
argument_list|(
literal|"CHM? in kernel"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SCBVEC
argument_list|(
name|stray
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PRINTF
argument_list|(
literal|0
argument_list|,
literal|"stray scb interrupt\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|POPR
expr_stmt|;
end_expr_stmt

begin_macro
name|rei
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|nexzvec
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|mfpr
name|$IPL
decl_stmt|,-
argument_list|(
name|sp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PRINTF
argument_list|(
literal|1
argument_list|,
literal|"nexus stray intr ipl%x\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|POPR
expr_stmt|;
end_expr_stmt

begin_macro
name|rei
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|cmrd
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$0
decl_stmt|,
name|_memerr
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|POPR
expr_stmt|;
end_expr_stmt

begin_macro
name|rei
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|wtime
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|pushl
literal|6
operator|*
literal|4
operator|(
name|sp
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PRINTF
argument_list|(
literal|1
argument_list|,
literal|"write timeout %x\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|POPR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PANIC
argument_list|(
literal|"wtimo"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|#
directive|if
name|NMBA
operator|>
literal|0
end_if

begin_expr_stmt
name|SCBVEC
argument_list|(
name|mba3int
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|pushl
name|$3
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|brb
literal|1f
name|SCBVEC
argument_list|(
name|mba2int
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|pushl
name|$2
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|brb
literal|1f
name|SCBVEC
argument_list|(
name|mba1int
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|pushl
name|$1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|brb
literal|1f
name|SCBVEC
argument_list|(
name|mba0int
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|pushl
name|$0
literal|1
operator|:
name|calls
name|$1
operator|,
name|_mbintr
name|POPR
name|incl
name|_cnt
operator|+
name|V_INTR
name|rei
endif|#
directive|endif
if|#
directive|if
name|VAX780
comment|/*  * Registers for the uba handling code  */
define|#
directive|define
name|rUBANUM
value|r0
define|#
directive|define
name|rUBAHD
value|r1
define|#
directive|define
name|rUVEC
value|r3
define|#
directive|define
name|rUBA
value|r4
comment|/* r2,r5 are scratch */
name|SCBVEC
argument_list|(
name|ua3int
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|movl
name|$3
decl_stmt|,
name|rUBANUM
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|moval
name|_uba_hd
operator|+
operator|(
literal|3
operator|*
name|UH_SIZE
operator|)
operator|,
name|rUBAHD
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|brb
literal|1f
name|SCBVEC
argument_list|(
name|ua2int
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|movl
name|$2
decl_stmt|,
name|rUBANUM
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|moval
name|_uba_hd
operator|+
operator|(
literal|2
operator|*
name|UH_SIZE
operator|)
operator|,
name|rUBAHD
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|brb
literal|1f
name|SCBVEC
argument_list|(
name|ua1int
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|movl
name|$1
decl_stmt|,
name|rUBANUM
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|moval
name|_uba_hd
operator|+
operator|(
literal|1
operator|*
name|UH_SIZE
operator|)
operator|,
name|rUBAHD
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|brb
literal|1f
name|SCBVEC
argument_list|(
name|ua0int
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|movl
name|$0
decl_stmt|,
name|rUBANUM
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|moval
name|_uba_hd
operator|+
operator|(
literal|0
operator|*
name|UH_SIZE
operator|)
operator|,
name|rUBAHD
expr_stmt|;
end_expr_stmt

begin_expr_stmt
literal|1
operator|:
name|incl
name|_cnt
operator|+
name|V_INTR
name|mfpr
name|$IPL
operator|,
name|r2
comment|/* r2 = mfpr(IPL); */
name|movl
name|UH_UBA
argument_list|(
name|rUBAHD
argument_list|)
operator|,
name|rUBA
comment|/* uba = uhp->uh_uba; */
name|movl
name|UBA_BRRVR
operator|-
literal|0x14
operator|*
literal|4
operator|(
name|rUBA
operator|)
index|[
name|r2
index|]
operator|,
name|rUVEC
comment|/* uvec = uba->uba_brrvr[r2-0x14] */
name|ubanorm
operator|:
name|bleq
name|ubaerror
name|addl2
name|UH_VEC
argument_list|(
name|rUBAHD
argument_list|)
operator|,
name|rUVEC
comment|/* uvec += uh->uh_vec */
name|bicl3
name|$3
operator|,
operator|(
name|rUVEC
operator|)
operator|,
name|r1
name|jmp
literal|2
operator|(
name|r1
operator|)
comment|/* 2 skips ``pushr $0x3f'' */
name|ubaerror
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$0
decl_stmt|,
name|_ubaerror
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|POPR
comment|/* ubaerror r/w's r0-r5 */
name|tstl
name|rUVEC
decl_stmt|;
end_decl_stmt

begin_macro
name|jneq
end_macro

begin_macro
name|ubanorm
end_macro

begin_comment
comment|/* rUVEC contains result */
end_comment

begin_macro
name|POPR
end_macro

begin_macro
name|rei
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|SCBVEC
argument_list|(
name|cnrint
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$0
decl_stmt|,
name|_cnrint
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|POPR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|incl
name|_cnt
operator|+
name|V_INTR
expr_stmt|;
end_expr_stmt

begin_macro
name|rei
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|cnxint
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$0
decl_stmt|,
name|_cnxint
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|POPR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|incl
name|_cnt
operator|+
name|V_INTR
expr_stmt|;
end_expr_stmt

begin_macro
name|rei
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|hardclock
argument_list|)
operator|:
name|PUSHR
name|mtpr
name|$ICCS_RUN
operator||
name|ICCS_IE
operator||
name|ICCS_INT
operator||
name|ICCS_ERR
operator|,
name|$ICCS
name|pushl
literal|4
operator|+
literal|6
operator|*
literal|4
operator|(
name|sp
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|pushl
literal|4
operator|+
literal|6
operator|*
literal|4
operator|(
name|sp
operator|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$2
decl_stmt|,
name|_hardclock
decl|#
name|hardclock
argument_list|(
name|pc
argument_list|,
name|psl
argument_list|)
if|#
directive|if
name|NPS
operator|>
literal|0
name|pushl
decl|4+6
modifier|*
decl|4
argument_list|(
name|sp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|pushl
literal|4
operator|+
literal|6
operator|*
literal|4
operator|(
name|sp
operator|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$2
decl_stmt|,
name|_psextsync
endif|#
directive|endif
name|POPR
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|incl
name|_cnt
operator|+
name|V_INTR
operator|#
operator|#
name|temp
name|so
name|not
name|to
end_expr_stmt

begin_break
break|break
name|vmstat
break|-=
name|HZ
name|rei
name|SCBVEC
break|(
name|softclock
end_break

begin_decl_stmt
unit|):
name|PUSHR
if|#
directive|if
name|NDZ
operator|>
literal|0
name|calls
name|$0
decl_stmt|,
name|_dztimer
endif|#
directive|endif
if|#
directive|if
name|NDH
operator|>
literal|0
name|calls
name|$0
decl_stmt|,
name|_dhtimer
endif|#
directive|endif
name|pushl
decl|4+6
modifier|*
decl|4
argument_list|(
name|sp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|pushl
literal|4
operator|+
literal|6
operator|*
literal|4
operator|(
name|sp
operator|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$2
decl_stmt|,
name|_softclock
decl|#
name|softclock
argument_list|(
name|pc
argument_list|,
name|psl
argument_list|)
name|POPR
decl_stmt|;
end_decl_stmt

begin_macro
name|rei
end_macro

begin_include
include|#
directive|include
file|"../net/netisr.h"
end_include

begin_expr_stmt
operator|.
name|globl
name|_netisr
name|SCBVEC
argument_list|(
name|netintr
argument_list|)
operator|:
name|PUSHR
name|bbcc
name|$NETISR_RAW
operator|,
name|_netisr
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$0
decl_stmt|,
name|_rawintr
decl_stmt|;
end_decl_stmt

begin_expr_stmt
literal|1
operator|:
ifdef|#
directive|ifdef
name|INET
include|#
directive|include
file|"../netinet/in_systm.h"
name|bbcc
name|$NETISR_IP
operator|,
name|_netisr
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$0
decl_stmt|,
name|_ipintr
decl_stmt|;
end_decl_stmt

begin_expr_stmt
literal|1
operator|:
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NS
name|bbcc
name|$NETISR_NS
operator|,
name|_netisr
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$0
decl_stmt|,
name|_nsintr
decl_stmt|;
end_decl_stmt

begin_expr_stmt
literal|1
operator|:
endif|#
directive|endif
name|POPR
name|rei
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|SCBVEC
argument_list|(
name|consdin
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|VAX730
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|MRSP
argument_list|)
end_if

begin_decl_stmt
name|jsb
name|tudma
endif|#
directive|endif
name|calls
name|$0
decl_stmt|,
name|_turintr
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|POPR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|incl
name|_cnt
operator|+
name|V_INTR
expr_stmt|;
end_expr_stmt

begin_macro
name|rei
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|consdout
argument_list|)
operator|:
name|PUSHR
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$0
decl_stmt|,
name|_tuxintr
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|POPR
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|incl
name|_cnt
operator|+
name|V_INTR
expr_stmt|;
end_expr_stmt

begin_macro
name|rei
end_macro

begin_else
else|#
directive|else
end_else

begin_expr_stmt
name|SCBVEC
argument_list|(
name|consdin
argument_list|)
operator|:
name|halt
name|SCBVEC
argument_list|(
name|consdout
argument_list|)
operator|:
name|halt
endif|#
directive|endif
if|#
directive|if
name|NDZ
operator|>
literal|0
comment|/*  * DZ pseudo dma routine:  *	r0 - controller number  */
operator|.
name|align
literal|1
operator|.
name|globl
name|dzdma
name|dzdma
operator|:
name|mull2
name|$8
operator|*
literal|20
operator|,
name|r0
name|movab
name|_dzpdma
argument_list|(
name|r0
argument_list|)
operator|,
name|r3
operator|#
name|pdma
name|structure
name|base
empty|# for this controller
name|dzploop
operator|:
name|movl
name|r3
operator|,
name|r0
name|movl
argument_list|(
name|r0
argument_list|)
operator|+
operator|,
name|r1
operator|#
name|device
specifier|register
name|address
name|movzbl
literal|1
operator|(
name|r1
operator|)
operator|,
name|r2
operator|#
name|get
name|line
name|number
name|bitb
name|$0x80
operator|,
name|r2
operator|#
name|TRDY
name|on
condition|?
name|beql
name|dzprei
operator|#
name|no
name|bicb2
name|$0xf8
operator|,
name|r2
operator|#
name|clear
name|garbage
name|bits
name|mull2
name|$20
operator|,
name|r2
name|addl2
name|r2
operator|,
name|r0
operator|#
name|point
name|at
name|line
literal|'s pdma structure 	movl	(r0)+,r2		# p_mem 	cmpl	r2,(r0)+		# p_mem< p_end ? 	bgequ	dzpcall			# no, go call dzxint 	movb	(r2)+,6(r1)		# dztbuf = *p_mem++ 	movl	r2,-8(r0) 	brb 	dzploop			# check for another line dzprei: 	POPR 	incl	_cnt+V_PDMA 	rei  dzpcall: 	pushl	r3 	pushl	(r0)+			# push tty address 	calls	$1,*(r0)		# call interrupt rtn 	movl	(sp)+,r3 	brb 	dzploop			# check for another line #endif  #if NUU> 0&& defined(UUDMA) /*  * Pseudo DMA routine for tu58 (on DL11)  *	r0 - controller number  */ 	.align	1 	.globl	uudma uudma: 	movl	_uudinfo[r0],r2 	movl	16(r2),r2		# r2 = uuaddr 	mull3	$48,r0,r3 	movab	_uu_softc(r3),r5	# r5 = uuc  	cvtwl	2(r2),r1		# c = uuaddr->rdb 	bbc	$15,r1,1f		# if (c& UUDB_ERROR) 	movl	$13,16(r5)		#	uuc->tu_state = TUC_RCVERR; 	rsb				#	let uurintr handle it 1: 	tstl	4(r5)			# if (uuc->tu_rcnt) { 	beql	1f 	movb	r1,*0(r5)		#	*uuc->tu_rbptr++ = r1 	incl	(r5) 	decl	4(r5)			#	if (--uuc->tu_rcnt) 	beql	2f			#		done 	tstl	(sp)+ 	POPR				# 	registers saved in ubglue.s 	rei				# } 2: 	cmpl	16(r5),$8		# if (uuc->tu_state != TUS_GETH) 	beql	2f			# 	let uurintr handle it 1: 	rsb 2: 	mull2	$14,r0			# sizeof(uudata[ctlr]) = 14 	movab	_uudata(r0),r4		# data =&uudata[ctlr]; 	cmpb	$1,(r4)			# if (data->pk_flag != TUF_DATA) 	bneq	1b #ifdef notdef 	/* this is for command packets */ 	beql	1f			# 	r0 = uuc->tu_rbptr 	movl	(r5),r0 	brb	2f 1:					# else #endif 	movl	24(r5),r0		# 	r0 = uuc->tu_addr 2: 	movzbl	1(r4),r3		# counter to r3 (data->pk_count) 	movzwl	(r4),r1			# first word of checksum (=header) 	mfpr	$IPL,-(sp)		# s = spl5(); 	mtpr	$0x15,$IPL		# to keep disk interrupts out 	clrw	(r2)			# disable receiver interrupts 3:	bbc	$7,(r2),3b		# while ((uuaddr->rcs& UUCS_READY)==0); 	cvtwb	2(r2),(r0)+		# *buffer = uuaddr->rdb& 0xff 	sobgtr	r3,1f			# continue with next byte ... 	addw2	2(r2),r1		# unless this was the last (odd count) 	brb	2f  1:	bbc	$7,(r2),1b		# while ((uuaddr->rcs& UUCS_READY)==0); 	cvtwb	2(r2),(r0)+		# *buffer = uuaddr->rdb& 0xff 	addw2	-2(r0),r1		# add to checksum.. 2: 	adwc	$0,r1			# get the carry 	sobgtr	r3,3b			# loop while r3> 0 /*  * We'
name|re
name|ready
name|to
name|get
name|the
name|checksum
operator|*
operator|/
literal|1
operator|:
name|bbc
name|$7
operator|,
operator|(
name|r2
operator|)
operator|,
literal|1b
operator|#
end_expr_stmt

begin_while
while|while
condition|(
operator|(
name|uuaddr
operator|->
name|rcs
operator|&
name|UUCS_READY
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
end_while

begin_expr_stmt
name|cvtwb
literal|2
operator|(
name|r2
operator|)
operator|,
literal|12
operator|(
name|r4
operator|)
operator|#
name|get
name|first
argument_list|(
argument|lower
argument_list|)
name|byte
literal|1
operator|:
name|bbc
name|$7
operator|,
operator|(
name|r2
operator|)
operator|,
literal|1b
name|cvtwb
literal|2
operator|(
name|r2
operator|)
operator|,
literal|13
operator|(
name|r4
operator|)
operator|#
operator|..
name|and
name|second
name|cmpw
literal|12
operator|(
name|r4
operator|)
operator|,
name|r1
operator|#
name|is
name|checksum
name|ok
condition|?
name|beql
literal|1f
name|movl
name|$14
operator|,
literal|16
operator|(
name|r5
operator|)
operator|#
name|uuc
operator|->
name|tu_state
operator|=
name|TUS_CHKERR
name|brb
literal|2f
operator|#
name|exit
literal|1
operator|:
name|movl
name|$11
operator|,
literal|16
operator|(
name|r5
operator|)
operator|#
name|uuc
operator|->
name|tu_state
operator|=
name|TUS_GET
argument_list|(
name|ok
argument_list|)
literal|2
operator|:
name|movw
name|$0x40
operator|,
operator|(
name|r2
operator|)
operator|#
name|enable
name|receiver
name|interrupts
name|mtpr
argument_list|(
name|sp
argument_list|)
operator|+
operator|,
name|$IPL
operator|#
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|rsb
operator|#
end_expr_stmt

begin_continue
continue|continue
name|processing
name|in
name|uurintr
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|VAX730
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|MRSP
argument_list|)
comment|/*  * Pseudo DMA routine for VAX-11/750 console tu58   *   	    (without MRSP)  */
operator|.
name|align
continue|1 	.
name|globl
name|tudma
name|tudma
continue|:
name|movab
name|_tu
operator|,
name|r5
continue|#
name|r5
continue|=
name|tu
name|tstl
continue|4(
name|r5
end_continue

begin_expr_stmt
unit|)
operator|#
end_expr_stmt

begin_if
if|if
condition|(
name|tu
operator|.
name|tu_rcnt
condition|)
block|{
name|beql
literal|3f
name|mfpr
name|$CSRD
operator|,
name|r1
operator|#
name|get
name|data
name|from
name|tu58
name|movb
name|r1
operator|,
operator|*
literal|0
operator|(
name|r5
operator|)
operator|#
operator|*
name|tu
operator|.
name|tu_rbptr
operator|++
operator|=
name|r1
name|incl
argument_list|(
argument|r5
argument_list|)
name|decl
literal|4
operator|(
name|r5
operator|)
operator|#
if|if
condition|(
operator|--
name|tu
operator|.
name|tu_rcnt
condition|)
name|beql
literal|1f
operator|#
name|done
name|tstl
argument_list|(
name|sp
argument_list|)
operator|+
name|POPR
operator|#
name|registers
name|saved
name|in
name|ubglue
operator|.
name|s
name|rei
operator|#
name|data
name|handled
operator|,
name|done
literal|1
operator|:
operator|#
block|}
end_if

begin_expr_stmt
name|cmpl
literal|16
operator|(
name|r5
operator|)
operator|,
name|$8
operator|#
end_expr_stmt

begin_if
if|if
condition|(
name|tu
operator|.
name|tu_state
operator|!=
name|TUS_GETH
condition|)
name|beql
literal|2f
operator|#
name|let
name|turintr
name|handle
name|it
literal|3
operator|:
name|rsb
literal|2
operator|:
name|movab
name|_tudata
operator|,
name|r4
operator|#
name|r4
operator|=
name|tudata
name|cmpb
name|$1
operator|,
operator|(
name|r4
operator|)
operator|#
end_if

begin_if
if|if
condition|(
name|tudata
operator|.
name|pk_flag
operator|!=
name|TUF_DATA
condition|)
name|bneq
literal|3b
operator|#
name|let
name|turintr
name|handle
name|it
literal|1
operator|:
operator|#
else|else
name|movl
literal|24
operator|(
name|r5
operator|)
operator|,
name|r1
operator|#
name|get
name|buffer
name|pointer
name|to
name|r1
name|movzbl
literal|1
operator|(
name|r4
operator|)
operator|,
name|r3
operator|#
name|counter
name|to
name|r3
name|movzwl
argument_list|(
name|r4
argument_list|)
operator|,
name|r0
operator|#
name|first
name|word
name|of
name|checksum
argument_list|(
argument|=header
argument_list|)
name|mtpr
name|$0
operator|,
name|$CSRS
operator|#
name|disable
name|receiver
name|interrupts
literal|3
operator|:
name|bsbw
literal|5f
operator|#
name|wait
end_if

begin_for
for|for next byte 	mfpr	$CSRD
operator|,
name|r5
name|movb
name|r5
decl_stmt|,
argument_list|(
name|r1
argument_list|)
decl_stmt|+		#
modifier|*
name|buffer
init|=
name|rdb
name|sobgtr
name|r3
decl_stmt|,1f			# continue
name|with
name|next
name|byte
modifier|...
name|mfpr
name|$CSRD
decl_stmt|,
name|r2
decl|#
name|unless
name|this
name|was
name|the
name|last
argument_list|(
name|odd
name|count
argument_list|)
name|brb
decl|2f  1
range|:
name|bsbw
literal|5f
operator|#
name|wait
end_for

begin_for
for|for next byte 	mfpr	$CSRD
operator|,
name|r5
name|movb
name|r5
decl_stmt|,
argument_list|(
name|r1
argument_list|)
decl_stmt|+		#
modifier|*
name|buffer
init|=
name|rdb
name|movzwl
operator|-
literal|2
operator|(
name|r1
operator|)
decl_stmt|,
name|r2
decl|#
name|get
name|the
name|last
name|word
name|back
name|from
name|memory
decl|2
range|:
name|addw2
name|r2
decl_stmt|,
name|r0
decl|#
name|add
name|to
name|checksum
decl|..
name|adwc
name|$0
decl_stmt|,
name|r0
decl|#
name|get
name|the
name|carry
name|sobgtr
name|r3
decl_stmt|,3b			#
name|loop
decl|while
name|r3
decl|> 0
comment|/*  * We're ready to get the checksum.  */
name|bsbw
decl|5f
name|movab
name|_tudata
decl_stmt|,
name|r4
name|mfpr
name|$CSRD
decl_stmt|,
name|r5
name|movb
name|r5
decl_stmt|,12
argument_list|(
name|r4
argument_list|)
decl_stmt|#
name|get
name|first
argument_list|(
name|lower
argument_list|)
name|byte
name|bsbw
decl|5f
name|mfpr
name|$CSRD
decl_stmt|,
name|r5
name|movb
name|r5
decl_stmt|,13
argument_list|(
name|r4
argument_list|)
decl_stmt|# ..
name|and
name|second
name|movab
name|_tu
decl_stmt|,
name|r5
name|cmpw
decl|12
argument_list|(
name|r4
argument_list|)
decl_stmt|,
name|r0
decl|#
name|is
name|checksum
name|ok
decl|?
name|beql
decl|1f
name|movl
name|$14
decl_stmt|,16
argument_list|(
name|r5
argument_list|)
decl_stmt|#
name|tu
operator|.
name|tu_state
init|=
name|TUS_CHKERR
name|brb
literal|2f
operator|#
name|exit
literal|1
operator|:
name|movl
name|$11
decl_stmt|,16
argument_list|(
name|r5
argument_list|)
decl_stmt|#
name|tu
operator|.
name|tu_state
init|=
name|TUS_GET
literal|2
operator|:
name|mtpr
name|$0x40
decl_stmt|,
name|$CSRS
decl|#
name|enable
name|receiver
name|interrupts
name|rsb
decl|# continue
name|processing
name|in
name|turintr
comment|/*  * Loop until a new byte is ready from  * the tu58, make sure we don't loop forever  */
decl|5
range|:
name|movl
name|$5000
decl_stmt|,
name|r5
decl|#
name|loop
name|max
decl|5000
name|times
decl|1
range|:
name|mfpr
name|$CSRS
decl_stmt|,
name|r2
name|bbs
name|$7
decl_stmt|,
name|r2
decl_stmt|,1f
name|sobgtr
name|r5
decl_stmt|,1b
name|movab
name|_tu
decl_stmt|,
name|r5
name|movl
name|$13
decl_stmt|,16
argument_list|(
name|r5
argument_list|)
decl_stmt|# return
name|TUS_RCVERR
name|tstl
argument_list|(
name|sp
argument_list|)
decl|+			#
name|and
name|let
name|turintr
name|handle
name|it
decl|1
range|:
name|rsb
endif|#
directive|endif
comment|/*  * Stray UNIBUS interrupt catch routines  */
operator|.
name|data
operator|.
name|align
literal|2
define|#
directive|define
name|PJ
value|PUSHR;jsb _Xustray
operator|.
name|globl
name|_catcher
name|_catcher
operator|:
name|PJ
decl_stmt|;
end_for

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|PJ
name|PJ
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|PJ
name|PJ
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|PJ
name|PJ
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|PJ
name|PJ
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|PJ
name|PJ
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|PJ
name|PJ
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|PJ
name|PJ
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PJ
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|PJ
operator|.
name|globl
name|_cold
name|_cold
range|:
operator|.
name|long
literal|1
operator|.
name|data
operator|.
name|text
name|SCBVEC
argument_list|(
name|ustray
argument_list|)
operator|:
name|blbc
name|_cold
decl_stmt|,1f
name|mfpr
name|$IPL
decl_stmt|,
name|r11
name|subl3
name|$_catcher
decl|+8
decl_stmt|,
argument_list|(
name|sp
argument_list|)
decl_stmt|+,
name|r10
name|ashl
name|$
decl|-1
decl_stmt|,
name|r10
decl_stmt|,
name|r10
name|POPR
name|rei
decl|1
range|:
name|subl3
name|$_catcher
operator|+
literal|8
decl_stmt|,
argument_list|(
name|sp
argument_list|)
decl_stmt|+,
name|r0
name|ashl
name|$
decl|-1
decl_stmt|,
name|r0
decl_stmt|,-
argument_list|(
name|sp
argument_list|)
name|mfpr
name|$IPL
decl_stmt|,-
argument_list|(
name|sp
argument_list|)
name|PRINTF
argument_list|(
literal|2
argument_list|,
literal|"uba?: stray intr ipl %x vec %o\n"
argument_list|)
name|POPR
name|rei
comment|/*  * Trap and fault vector routines  */
define|#
directive|define
name|TRAP
parameter_list|(
name|a
parameter_list|)
value|pushl $T_
comment|/**/
value|a; jbr alltraps
comment|/*  * Ast delivery (profiling and/or reschedule)  */
name|SCBVEC
argument_list|(
name|astflt
argument_list|)
range|:
name|pushl
name|$0
decl_stmt|;
end_decl_stmt

begin_macro
name|TRAP
argument_list|(
argument|ASTFLT
argument_list|)
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|privinflt
argument_list|)
operator|:
name|pushl
name|$0
expr_stmt|;
end_expr_stmt

begin_macro
name|TRAP
argument_list|(
argument|PRIVINFLT
argument_list|)
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|xfcflt
argument_list|)
operator|:
name|pushl
name|$0
expr_stmt|;
end_expr_stmt

begin_macro
name|TRAP
argument_list|(
argument|XFCFLT
argument_list|)
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|resopflt
argument_list|)
operator|:
name|pushl
name|$0
expr_stmt|;
end_expr_stmt

begin_macro
name|TRAP
argument_list|(
argument|RESOPFLT
argument_list|)
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|resadflt
argument_list|)
operator|:
name|pushl
name|$0
expr_stmt|;
end_expr_stmt

begin_macro
name|TRAP
argument_list|(
argument|RESADFLT
argument_list|)
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|bptflt
argument_list|)
operator|:
name|pushl
name|$0
expr_stmt|;
end_expr_stmt

begin_macro
name|TRAP
argument_list|(
argument|BPTFLT
argument_list|)
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|compatflt
argument_list|)
operator|:
name|TRAP
argument_list|(
name|COMPATFLT
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SCBVEC
argument_list|(
name|tracep
argument_list|)
operator|:
name|pushl
name|$0
expr_stmt|;
end_expr_stmt

begin_macro
name|TRAP
argument_list|(
argument|TRCTRAP
argument_list|)
end_macro

begin_expr_stmt
name|SCBVEC
argument_list|(
name|arithtrap
argument_list|)
operator|:
name|TRAP
argument_list|(
argument|ARITHTRAP
argument_list|)
name|SCBVEC
argument_list|(
name|protflt
argument_list|)
operator|:
name|blbs
argument_list|(
name|sp
argument_list|)
operator|+
operator|,
name|segflt
name|TRAP
argument_list|(
argument|PROTFLT
argument_list|)
name|segflt
operator|:
name|TRAP
argument_list|(
argument|SEGFLT
argument_list|)
name|SCBVEC
argument_list|(
name|transflt
argument_list|)
operator|:
name|bitl
name|$2
operator|,
operator|(
name|sp
operator|)
operator|+
name|bnequ
name|tableflt
name|jsb
name|Fastreclaim
operator|#
name|try
name|and
name|avoid
name|pagein
name|TRAP
argument_list|(
argument|PAGEFLT
argument_list|)
name|tableflt
operator|:
name|TRAP
argument_list|(
argument|TABLEFLT
argument_list|)
name|alltraps
operator|:
name|mfpr
name|$USP
operator|,
operator|-
operator|(
name|sp
operator|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$0
decl_stmt|,
name|_trap
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|mtpr
argument_list|(
name|sp
argument_list|)
operator|+
operator|,
name|$USP
name|incl
name|_cnt
operator|+
name|V_TRAP
name|addl2
name|$8
operator|,
name|sp
operator|#
name|pop
name|type
operator|,
name|code
name|mtpr
name|$HIGH
operator|,
name|$IPL
operator|#
operator|#
name|dont
name|go
name|to
name|a
name|higher
name|IPL
argument_list|(
argument|GROT
argument_list|)
name|rei
name|SCBVEC
argument_list|(
name|syscall
argument_list|)
operator|:
name|pushl
name|$T_SYSCALL
name|mfpr
name|$USP
operator|,
operator|-
operator|(
name|sp
operator|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$0
decl_stmt|,
name|_syscall
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|mtpr
argument_list|(
name|sp
argument_list|)
operator|+
operator|,
name|$USP
name|incl
name|_cnt
operator|+
name|V_SYSCALL
name|addl2
name|$8
operator|,
name|sp
operator|#
name|pop
name|type
operator|,
name|code
name|mtpr
name|$HIGH
operator|,
name|$IPL
operator|#
operator|#
name|dont
name|go
name|to
name|a
name|higher
name|IPL
argument_list|(
argument|GROT
argument_list|)
name|rei
comment|/*  * System page table  */
define|#
directive|define
name|vaddr
parameter_list|(
name|x
parameter_list|)
value|((((x)-_Sysmap)/4)*NBPG+0x80000000)
define|#
directive|define
name|SYSMAP
parameter_list|(
name|mname
parameter_list|,
name|vname
parameter_list|,
name|npte
parameter_list|)
define|\
value|_
comment|/**/
value|mname:	.globl	_
comment|/**/
value|mname;		\ 	.space	npte*4;				\ 	.globl	_
comment|/**/
value|vname;			\ 	.set	_
comment|/**/
value|vname,vaddr(_
comment|/**/
value|mname)
operator|.
name|data
operator|.
name|align
literal|2
name|SYSMAP
argument_list|(
argument|Sysmap
argument_list|,
argument|Sysbase
argument_list|,
argument|SYSPTSIZE
argument_list|)
name|SYSMAP
argument_list|(
argument|UMBAbeg
argument_list|,
argument|umbabeg
argument_list|,
literal|0
argument_list|)
name|SYSMAP
argument_list|(
argument|Nexmap
argument_list|,
argument|nexus
argument_list|,
literal|16
argument|*MAXNNEXUS
argument_list|)
name|SYSMAP
argument_list|(
argument|UMEMmap
argument_list|,
argument|umem
argument_list|,
literal|512
argument|*MAXNUBA
argument_list|)
name|SYSMAP
argument_list|(
argument|UMBAend
argument_list|,
argument|umbaend
argument_list|,
literal|0
argument_list|)
name|SYSMAP
argument_list|(
argument|Usrptmap
argument_list|,
argument|usrpt
argument_list|,
argument|USRPTSIZE
argument_list|)
name|SYSMAP
argument_list|(
argument|Forkmap
argument_list|,
argument|forkutl
argument_list|,
argument|UPAGES
argument_list|)
name|SYSMAP
argument_list|(
argument|Xswapmap
argument_list|,
argument|xswaputl
argument_list|,
argument|UPAGES
argument_list|)
name|SYSMAP
argument_list|(
argument|Xswap2map
argument_list|,
argument|xswap2utl
argument_list|,
argument|UPAGES
argument_list|)
name|SYSMAP
argument_list|(
argument|Swapmap
argument_list|,
argument|swaputl
argument_list|,
argument|UPAGES
argument_list|)
name|SYSMAP
argument_list|(
argument|Pushmap
argument_list|,
argument|pushutl
argument_list|,
argument|UPAGES
argument_list|)
name|SYSMAP
argument_list|(
argument|Vfmap
argument_list|,
argument|vfutl
argument_list|,
argument|UPAGES
argument_list|)
name|SYSMAP
argument_list|(
argument|CMAP1
argument_list|,
argument|CADDR1
argument_list|,
literal|1
argument_list|)
name|SYSMAP
argument_list|(
argument|CMAP2
argument_list|,
argument|CADDR2
argument_list|,
literal|1
argument_list|)
name|SYSMAP
argument_list|(
argument|mcrmap
argument_list|,
argument|mcr
argument_list|,
literal|1
argument_list|)
name|SYSMAP
argument_list|(
argument|mmap
argument_list|,
argument|vmmap
argument_list|,
literal|1
argument_list|)
name|SYSMAP
argument_list|(
argument|msgbufmap
argument_list|,
argument|msgbuf
argument_list|,
argument|MSGBUFPTECNT
argument_list|)
name|SYSMAP
argument_list|(
argument|camap
argument_list|,
argument|cabase
argument_list|,
literal|16
argument|*CLSIZE
argument_list|)
name|SYSMAP
argument_list|(
argument|ecamap
argument_list|,
argument|calimit
argument_list|,
literal|0
argument_list|)
name|SYSMAP
argument_list|(
argument|Mbmap
argument_list|,
argument|mbutl
argument_list|,
argument|NMBCLUSTERS*CLSIZE
argument_list|)
name|eSysmap
operator|:
operator|.
name|globl
name|_Syssize
operator|.
name|set
name|_Syssize
operator|,
operator|(
name|eSysmap
operator|-
name|_Sysmap
operator|)
operator|/
literal|4
operator|.
name|text
comment|/*  * Initialization  *  * ipl 0x1f; mapen 0; scbb, pcbb, sbr, slr, isp, ksp not set  */
operator|.
name|data
operator|.
name|globl
name|_cpu
name|_cpu
operator|:
operator|.
name|long
literal|0
operator|.
name|text
operator|.
name|globl
name|start
name|start
operator|:
operator|.
name|word
literal|0
comment|/* set system control block base and system page table params */
name|mtpr
name|$_scb
operator|-
literal|0x80000000
operator|,
name|$SCBB
name|mtpr
name|$_Sysmap
operator|-
literal|0x80000000
operator|,
name|$SBR
name|mtpr
name|$_Syssize
operator|,
name|$SLR
comment|/* double map the kernel into the virtual user addresses of phys mem */
name|mtpr
name|$_Sysmap
operator|,
name|$P0BR
name|mtpr
name|$_Syssize
operator|,
name|$P0LR
comment|/* set ISP and get cpu type */
name|movl
name|$_intstack
operator|+
name|NISP
operator|*
name|NBPG
operator|,
name|sp
name|mfpr
name|$SID
operator|,
name|r0
name|movab
name|_cpu
operator|,
name|r1
name|extzv
name|$24
operator|,
name|$8
operator|,
name|r0
operator|,
operator|(
name|r1
operator|)
comment|/* init RPB */
name|movab
name|_rpb
operator|,
name|r0
name|movl
name|r0
operator|,
operator|(
name|r0
operator|)
operator|+
operator|#
name|rp_selfref
name|movab
name|_doadump
operator|,
name|r1
name|movl
name|r1
operator|,
operator|(
name|r0
operator|)
operator|+
operator|#
name|rp_dumprout
name|movl
name|$0x1f
operator|,
name|r2
name|clrl
name|r3
literal|1
operator|:
name|addl2
argument_list|(
name|r1
argument_list|)
operator|+
operator|,
name|r3
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|sobgtr
name|r2
decl_stmt|,1b
name|movl
name|r3
decl_stmt|,
argument_list|(
name|r0
argument_list|)
decl_stmt|+			#
name|rp_chksum
comment|/* count up memory */
name|clrl
name|r7
decl|1
range|:
name|pushl
name|$4
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|pushl
name|r7
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|calls
name|$2
decl_stmt|,
name|_badaddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|tstl
name|r0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|bneq
literal|9f
name|acbl
name|$8192
operator|*
literal|1024
operator|-
literal|1
operator|,
name|$64
operator|*
literal|1024
operator|,
name|r7
operator|,
literal|1b
literal|9
operator|:
comment|/* clear memory from kernel bss and pages for proc 0 u. and page table */
name|movab
name|_edata
operator|,
name|r6
name|movab
name|_end
operator|,
name|r5
name|bbcc
name|$31
operator|,
name|r5
operator|,
literal|0f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
literal|0
operator|:
name|addl2
name|$
argument_list|(
name|UPAGES
operator|*
name|NBPG
argument_list|)
operator|+
name|NBPG
operator|+
name|NBPG
operator|,
name|r5
literal|1
operator|:
name|clrq
argument_list|(
name|r6
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|acbl
name|r5
decl_stmt|,
name|$8
decl_stmt|,
name|r6
decl_stmt|,1b
comment|/* trap() and syscall() save r0-r11 in the entry mask (per ../h/reg.h) */
name|bisw2
name|$0x0fff
decl_stmt|,
name|_trap
name|bisw2
name|$0x0fff
decl_stmt|,
name|_syscall
name|calls
name|$0
decl_stmt|,
name|_fixctlrmask
comment|/* initialize system page table: scb and int stack writeable */
name|clrl
name|r2
name|movab
name|eintstack
decl_stmt|,
name|r1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bbcc
name|$31
decl_stmt|,
name|r1
decl_stmt|,0f;
end_decl_stmt

begin_expr_stmt
literal|0
operator|:
name|ashl
name|$
operator|-
name|PGSHIFT
operator|,
name|r1
operator|,
name|r1
literal|1
operator|:
name|bisl3
name|$PG_V
operator||
name|PG_KW
operator|,
name|r2
operator|,
name|_Sysmap
index|[
name|r2
index|]
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|aoblss
name|r1
decl_stmt|,
name|r2
decl_stmt|,1b
comment|/* make rpb read-only as red zone for interrupt stack */
name|bicl2
name|$PG_PROT
decl_stmt|,
name|_rpbmap
name|bisl2
name|$PG_KR
decl_stmt|,
name|_rpbmap
comment|/* make kernel text space read-only */
name|movab
name|_etext
decl|+
name|NBPG
decl|-1
decl_stmt|,
name|r1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bbcc
name|$31
decl_stmt|,
name|r1
decl_stmt|,0f;
end_decl_stmt

begin_expr_stmt
literal|0
operator|:
name|ashl
name|$
operator|-
name|PGSHIFT
operator|,
name|r1
operator|,
name|r1
literal|1
operator|:
name|bisl3
name|$PG_V
operator||
name|PG_KR
operator|,
name|r2
operator|,
name|_Sysmap
index|[
name|r2
index|]
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|aoblss
name|r1
decl_stmt|,
name|r2
decl_stmt|,1b
comment|/* make kernel data, bss, read-write */
name|movab
name|_end
decl|+
name|NBPG
decl|-1
decl_stmt|,
name|r1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bbcc
name|$31
decl_stmt|,
name|r1
decl_stmt|,0f;
end_decl_stmt

begin_expr_stmt
literal|0
operator|:
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ashl
name|$
operator|-
name|PGSHIFT
operator|,
name|r1
operator|,
name|r1
literal|1
operator|:
name|bisl3
name|$PG_V
operator||
name|PG_KW
operator|,
name|r2
operator|,
name|_Sysmap
index|[
name|r2
index|]
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|aoblss
name|r1
decl_stmt|,
name|r2
decl_stmt|,1b
comment|/* now go to mapped mode */
name|mtpr
name|$1
decl_stmt|,
name|$TBIA
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|mtpr
name|$1
decl_stmt|,
name|$MAPEN
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|jmp
modifier|*
name|$0f
decl_stmt|;
end_decl_stmt

begin_expr_stmt
literal|0
operator|:
comment|/* init mem sizes */
name|ashl
name|$
operator|-
name|PGSHIFT
operator|,
name|r7
operator|,
name|_maxmem
name|movl
name|_maxmem
operator|,
name|_physmem
name|movl
name|_maxmem
operator|,
name|_freemem
comment|/* setup context for proc[0] == Scheduler */
name|movab
name|_end
operator|+
name|NBPG
operator|-
literal|1
operator|,
name|r6
name|bicl2
name|$NBPG
operator|-
literal|1
operator|,
name|r6
operator|#
name|make
name|page
name|boundary
comment|/* setup page table for proc[0] */
name|bbcc
name|$31
operator|,
name|r6
operator|,
literal|0f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
literal|0
operator|:
name|ashl
name|$
operator|-
name|PGSHIFT
operator|,
name|r6
operator|,
name|r3
operator|#
name|r3
operator|=
name|btoc
argument_list|(
argument|r6
argument_list|)
name|bisl3
name|$PG_V
operator||
name|PG_KW
operator|,
name|r3
operator|,
name|_Usrptmap
operator|#
name|init
name|first
name|upt
name|entry
name|incl
name|r3
name|movab
name|_usrpt
operator|,
name|r0
name|mtpr
name|r0
operator|,
name|$TBIS
comment|/* init p0br, p0lr */
name|mtpr
name|r0
operator|,
name|$P0BR
name|mtpr
name|$0
operator|,
name|$P0LR
comment|/* init p1br, p1lr */
name|movab
name|NBPG
argument_list|(
name|r0
argument_list|)
operator|,
name|r0
name|movl
name|$0x200000
operator|-
name|UPAGES
operator|,
name|r1
name|mtpr
name|r1
operator|,
name|$P1LR
name|mnegl
name|r1
operator|,
name|r1
name|moval
operator|-
literal|4
operator|*
name|UPAGES
argument_list|(
name|r0
argument_list|)
index|[
name|r1
index|]
operator|,
name|r2
name|mtpr
name|r2
operator|,
name|$P1BR
comment|/* setup mapping for UPAGES of _u */
name|movl
name|$UPAGES
operator|,
name|r2
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|movab
name|_u
operator|+
name|NBPG
operator|*
name|UPAGES
operator|,
name|r1
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|addl2
name|$UPAGES
decl_stmt|,
name|r3
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|jbr
literal|2f
literal|1
operator|:
name|decl
name|r3
name|moval
operator|-
name|NBPG
argument_list|(
name|r1
argument_list|)
operator|,
name|r1
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|bisl3
name|$PG_V
operator||
name|PG_URKW
operator|,
name|r3
operator|,
operator|-
operator|(
name|r0
operator|)
name|mtpr
name|r1
operator|,
name|$TBIS
literal|2
operator|:
name|sobgeq
name|r2
operator|,
literal|1b
comment|/* initialize (slightly) the pcb */
name|movab
name|UPAGES
operator|*
name|NBPG
argument_list|(
name|r1
argument_list|)
operator|,
name|PCB_KSP
argument_list|(
argument|r1
argument_list|)
name|mnegl
name|$1
operator|,
name|PCB_ESP
argument_list|(
argument|r1
argument_list|)
name|mnegl
name|$1
operator|,
name|PCB_SSP
argument_list|(
argument|r1
argument_list|)
name|movl
name|r1
operator|,
name|PCB_USP
argument_list|(
argument|r1
argument_list|)
name|mfpr
name|$P0BR
operator|,
name|PCB_P0BR
argument_list|(
argument|r1
argument_list|)
name|mfpr
name|$P0LR
operator|,
name|PCB_P0LR
argument_list|(
argument|r1
argument_list|)
name|movb
name|$4
operator|,
name|PCB_P0LR
operator|+
literal|3
operator|(
name|r1
operator|)
operator|#
name|disable
name|ast
name|mfpr
name|$P1BR
operator|,
name|PCB_P1BR
argument_list|(
argument|r1
argument_list|)
name|mfpr
name|$P1LR
operator|,
name|PCB_P1LR
argument_list|(
argument|r1
argument_list|)
name|movl
name|$CLSIZE
operator|,
name|PCB_SZPT
argument_list|(
name|r1
argument_list|)
operator|#
name|init
name|u
operator|.
name|u_pcb
operator|.
name|pcb_szpt
name|movl
name|r11
operator|,
name|PCB_R11
argument_list|(
argument|r1
argument_list|)
name|movab
literal|1f
operator|,
name|PCB_PC
argument_list|(
name|r1
argument_list|)
operator|#
name|initial
name|pc
name|clrl
name|PCB_PSL
argument_list|(
name|r1
argument_list|)
operator|#
name|mode
argument_list|(
name|k
argument_list|,
name|k
argument_list|)
operator|,
name|ipl
operator|=
literal|0
name|ashl
name|$PGSHIFT
operator|,
name|r3
operator|,
name|r3
name|mtpr
name|r3
operator|,
name|$PCBB
operator|#
name|first
name|pcbb
comment|/* set regs, p0br, p0lr, p1br, p1lr, astlvl, ksp and change to kernel mode */
name|ldpctx
name|rei
comment|/* put signal trampoline code in u. area */
literal|1
operator|:
name|movab
name|_u
operator|,
name|r0
name|movc3
name|$16
operator|,
name|sigcode
operator|,
name|PCB_SIGC
argument_list|(
argument|r0
argument_list|)
comment|/* save reboot flags in global _boothowto */
name|movl
name|r11
operator|,
name|_boothowto
comment|/* calculate firstaddr, and call main() */
name|movab
name|_end
operator|+
name|NBPG
operator|-
literal|1
operator|,
name|r0
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|bbcc
name|$31
decl_stmt|,
name|r0
decl_stmt|,0f;
end_decl_stmt

begin_expr_stmt
literal|0
operator|:
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ashl
name|$
operator|-
name|PGSHIFT
operator|,
name|r0
operator|,
operator|-
operator|(
name|sp
operator|)
name|addl2
name|$UPAGES
operator|+
literal|1
operator|,
operator|(
name|sp
operator|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|calls
name|$1
decl_stmt|,
name|_main
comment|/* proc[1] == /etc/init now running here; run icode */
name|pushl
name|$PSL_CURMOD
decl||
name|PSL_PRVMOD
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|pushl
name|$0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|rei
comment|/* signal trampoline code: it is known that this code takes exactly 16 bytes */
comment|/* in ../vax/pcb.h and in the movc3 above */
name|sigcode
range|:
name|calls
name|$4
decl_stmt|,5
argument_list|(
name|pc
argument_list|)
decl_stmt|#
name|params
name|pushed
name|by
name|sendsig
name|chmk
name|$139
decl|#
name|cleanup
name|mask
name|and
name|onsigstack
name|rei
operator|.
name|word
decl|0x7f				#
name|registers
decl|0-6
argument_list|(
literal|6
operator|==
name|sp
operator|/
name|compat
argument_list|)
name|callg
argument_list|(
name|ap
argument_list|)
decl_stmt|,
modifier|*
decl_stmt|16
argument_list|(
name|ap
argument_list|)
name|ret
comment|/*  * Primitives  */
comment|/*  * badaddr(addr, len)  *	see if access addr with a len type instruction causes a machine check  *	len is length of access (1=byte, 2=short, 4=long)  */
operator|.
name|globl
name|_badaddr
name|_badaddr
range|:
operator|.
name|word
literal|0
name|movl
name|$1
decl_stmt|,
name|r0
name|mfpr
name|$IPL
decl_stmt|,
name|r1
name|mtpr
name|$HIGH
decl_stmt|,
name|$IPL
name|movl
name|_scb
decl|+
name|MCKVEC
decl_stmt|,
name|r2
name|movl
decl|4
argument_list|(
name|ap
argument_list|)
decl_stmt|,
name|r3
name|movl
decl|8
argument_list|(
name|ap
argument_list|)
decl_stmt|,
name|r4
name|movab
decl|9f+
name|INTSTK
decl_stmt|,
name|_scb
decl|+
name|MCKVEC
name|bbc
name|$0
decl_stmt|,
name|r4
decl_stmt|,1f;
end_decl_stmt

begin_expr_stmt
name|tstb
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|bbc
name|$1
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|tstw
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|bbc
name|$2
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|tstl
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|clrl
name|r0
operator|#
name|made
name|it
name|w
operator|/
name|o
name|machine
name|checks
literal|2
operator|:
name|movl
name|r2
operator|,
name|_scb
operator|+
name|MCKVEC
name|mtpr
name|r1
operator|,
name|$IPL
name|ret
operator|.
name|align
literal|2
literal|9
operator|:
name|casel
name|_cpu
operator|,
name|$1
operator|,
name|$VAX_MAX
literal|0
operator|:
operator|.
name|word
literal|8f
operator|-
literal|0b
operator|#
literal|1
name|is
literal|780
operator|.
name|word
literal|5f
operator|-
literal|0b
operator|#
literal|2
name|is
literal|750
operator|.
name|word
literal|5f
operator|-
literal|0b
operator|#
literal|3
name|is
literal|730
literal|5
operator|:
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|mtpr
name|$0xf
operator|,
name|$MCESR
endif|#
directive|endif
name|brb
literal|1f
literal|8
operator|:
if|#
directive|if
name|VAX780
name|mtpr
name|$0
operator|,
name|$SBIFS
endif|#
directive|endif
literal|1
operator|:
name|addl2
argument_list|(
name|sp
argument_list|)
operator|+
operator|,
name|sp
operator|#
name|discard
name|mchchk
name|trash
name|movab
literal|2b
operator|,
operator|(
name|sp
operator|)
name|rei
name|_addupc
operator|:
operator|.
name|globl
name|_addupc
operator|.
name|word
literal|0x0
name|movl
literal|8
operator|(
name|ap
operator|)
operator|,
name|r2
operator|#
operator|&
name|u
operator|.
name|u_prof
name|subl3
literal|8
operator|(
name|r2
operator|)
operator|,
literal|4
operator|(
name|ap
operator|)
operator|,
name|r0
operator|#
name|corrected
name|pc
name|blss
literal|9f
name|extzv
name|$1
operator|,
name|$31
operator|,
name|r0
operator|,
name|r0
operator|#
name|logical
name|right
name|shift
name|extzv
name|$1
operator|,
name|$31
operator|,
literal|12
operator|(
name|r2
operator|)
operator|,
name|r1
operator|#
name|ditto
end_expr_stmt

begin_for
for|for scale 	emul	r1
operator|,
name|r0
operator|,
name|$0
operator|,
name|r0
name|ashq
name|$
operator|-
literal|14
operator|,
name|r0
operator|,
name|r0
name|tstl
name|r1
name|bneq
literal|9f
name|bicl2
name|$1
operator|,
name|r0
name|cmpl
name|r0
operator|,
literal|4
operator|(
name|r2
operator|)
operator|#
name|length
name|bgequ
literal|9f
name|addl2
argument_list|(
name|r2
argument_list|)
operator|,
name|r0
operator|#
name|base
name|probew
name|$3
operator|,
name|$2
operator|,
operator|(
name|r0
operator|)
name|beql
literal|8f
name|addw2
literal|12
operator|(
name|ap
operator|)
operator|,
operator|(
name|r0
operator|)
literal|9
operator|:
name|ret
literal|8
operator|:
name|clrl
literal|12
operator|(
name|r2
operator|)
name|ret
name|_Copyin
operator|:
operator|.
name|globl
name|_Copyin
operator|#
expr|<<<
name|massaged
end_for

begin_for
for|for jsb by asm.sed>>> 	movl	12
control|(
name|sp
control|)
operator|,
name|r0
operator|#
name|copy
name|length
name|blss
name|ersb
name|movl
literal|4
operator|(
name|sp
operator|)
operator|,
name|r1
operator|#
name|copy
name|user
name|address
name|cmpl
name|$NBPG
operator|,
name|r0
operator|#
name|probing
name|one
name|page
name|or
name|less
condition|?
name|bgeq
name|cishort
operator|#
name|yes
name|ciloop
else|:
name|prober
name|$3
operator|,
name|$NBPG
operator|,
operator|(
name|r1
operator|)
operator|#
name|bytes
name|accessible
condition|?
name|beql
name|ersb
operator|#
name|no
name|addl2
name|$NBPG
operator|,
name|r1
operator|#
name|incr
name|user
name|address
name|ptr
name|acbl
name|$NBPG
operator|+
literal|1
operator|,
name|$
operator|-
name|NBPG
operator|,
name|r0
operator|,
name|ciloop
operator|#
name|reduce
name|count
name|and
name|loop
name|cishort
operator|:
name|prober
name|$3
operator|,
name|r0
operator|,
operator|(
name|r1
operator|)
operator|#
name|bytes
name|accessible
condition|?
name|beql
name|ersb
operator|#
name|no
name|movl
literal|4
operator|(
name|sp
operator|)
operator|,
name|r1
name|movl
literal|8
operator|(
name|sp
operator|)
operator|,
name|r3
name|jbr
literal|2f
literal|1
operator|:
name|subl2
name|r0
operator|,
literal|12
operator|(
name|sp
operator|)
name|movc3
name|r0
operator|,
operator|(
name|r1
operator|)
operator|,
operator|(
name|r3
operator|)
literal|2
operator|:
name|movzwl
name|$65535
operator|,
name|r0
name|cmpl
literal|12
operator|(
name|sp
operator|)
operator|,
name|r0
name|jgtr
literal|1b
name|movc3
literal|12
operator|(
name|sp
operator|)
operator|,
operator|(
name|r1
operator|)
operator|,
operator|(
name|r3
operator|)
name|clrl
name|r0
operator|#
name|redundant
name|rsb
name|ersb
operator|:
name|movl
name|$EFAULT
operator|,
name|r0
name|rsb
name|_Copyout
operator|:
operator|.
name|globl
name|_Copyout
operator|#
expr|<<<
name|massaged
end_for

begin_for
for|for jsb by asm.sed>>> 	movl	12
control|(
name|sp
control|)
operator|,
name|r0
operator|#
name|get
name|count
name|blss
name|ersb
name|movl
literal|8
operator|(
name|sp
operator|)
operator|,
name|r1
operator|#
name|get
name|user
name|address
name|cmpl
name|$NBPG
operator|,
name|r0
operator|#
name|can
end_for

begin_do
do|do
name|in
name|one
name|probew
condition|?
name|bgeq
name|coshort
operator|#
name|yes
name|coloop
else|:
name|probew
name|$3
operator|,
name|$NBPG
operator|,
operator|(
name|r1
operator|)
operator|#
name|bytes
name|accessible
condition|?
name|beql
name|ersb
operator|#
name|no
name|addl2
name|$NBPG
operator|,
name|r1
operator|#
name|increment
name|user
name|address
name|acbl
name|$NBPG
operator|+
literal|1
operator|,
name|$
operator|-
name|NBPG
operator|,
name|r0
operator|,
name|coloop
operator|#
name|reduce
name|count
name|and
name|loop
name|coshort
operator|:
name|probew
name|$3
operator|,
name|r0
operator|,
operator|(
name|r1
operator|)
operator|#
name|bytes
name|accessible
condition|?
name|beql
name|ersb
operator|#
name|no
name|movl
literal|4
operator|(
name|sp
operator|)
operator|,
name|r1
name|movl
literal|8
operator|(
name|sp
operator|)
operator|,
name|r3
name|jbr
literal|2f
literal|1
operator|:
name|subl2
name|r0
operator|,
literal|12
operator|(
name|sp
operator|)
name|movc3
name|r0
operator|,
operator|(
name|r1
operator|)
operator|,
operator|(
name|r3
operator|)
literal|2
operator|:
name|movzwl
name|$65535
operator|,
name|r0
name|cmpl
literal|12
operator|(
name|sp
operator|)
operator|,
name|r0
name|jgtr
literal|1b
name|movc3
literal|12
operator|(
name|sp
operator|)
operator|,
operator|(
name|r1
operator|)
operator|,
operator|(
name|r3
operator|)
name|clrl
name|r0
operator|#
name|redundant
name|rsb
comment|/*  * non-local goto's  */
operator|.
name|globl
name|_Setjmp
name|_Setjmp
operator|:
name|movq
name|r6
operator|,
operator|(
name|r0
operator|)
operator|+
name|movq
name|r8
operator|,
operator|(
name|r0
operator|)
operator|+
name|movq
name|r10
operator|,
operator|(
name|r0
operator|)
operator|+
name|movq
name|r12
operator|,
operator|(
name|r0
operator|)
operator|+
name|addl3
name|$4
operator|,
name|sp
operator|,
operator|(
name|r0
operator|)
operator|+
name|movl
argument_list|(
name|sp
argument_list|)
operator|,
operator|(
name|r0
operator|)
name|clrl
name|r0
name|rsb
operator|.
name|globl
name|_Longjmp
name|_Longjmp
operator|:
name|movq
argument_list|(
name|r0
argument_list|)
operator|+
operator|,
name|r6
name|movq
argument_list|(
name|r0
argument_list|)
operator|+
operator|,
name|r8
name|movq
argument_list|(
name|r0
argument_list|)
operator|+
operator|,
name|r10
name|movq
argument_list|(
name|r0
argument_list|)
operator|+
operator|,
name|r12
name|movl
argument_list|(
name|r0
argument_list|)
operator|+
operator|,
name|r1
name|cmpl
name|r1
operator|,
name|sp
operator|#
name|must
name|be
name|a
name|pop
name|bgequ
name|lj2
name|pushab
name|lj1
name|calls
name|$1
operator|,
name|_panic
name|lj2
operator|:
name|movl
name|r1
operator|,
name|sp
name|jmp
operator|*
operator|(
name|r0
operator|)
operator|#
operator|`
operator|`
name|rsb
literal|''
name|lj1
operator|:
operator|.
name|asciz
literal|"longjmp"
operator|.
name|globl
name|_whichqs
operator|.
name|globl
name|_qs
operator|.
name|globl
name|_cnt
operator|.
name|globl
name|_noproc
operator|.
name|comm
name|_noproc
operator|,
literal|4
operator|.
name|globl
name|_runrun
operator|.
name|comm
name|_runrun
operator|,
literal|4
comment|/*  * The following primitives use the fancy VAX instructions  * much like VMS does.  _whichqs tells which of the 32 queues _qs  * have processes in them.  Setrq puts processes into queues, Remrq  * removes them from queues.  The running process is on no queue,  * other processes are on a queue related to p->p_pri, divided by 4  * actually to shrink the 0-127 range of priorities into the 32 available  * queues.  */
comment|/*  * Setrq(p), using fancy VAX instructions.  *  * Call should be made at spl6(), and p->p_stat should be SRUN  */
operator|.
name|globl
name|_Setrq
operator|#
expr|<<<
name|massaged
name|to
name|jsb
name|by
literal|"asm.sed"
operator|>>>
name|_Setrq
operator|:
name|tstl
name|P_RLINK
argument_list|(
name|r0
argument_list|)
operator|#
operator|#
name|firewall
operator|:
name|p
operator|->
name|p_rlink
name|must
name|be
literal|0
name|beql
name|set1
operator|#
operator|#
name|pushab
name|set3
operator|#
operator|#
name|calls
name|$1
operator|,
name|_panic
operator|#
operator|#
name|set1
operator|:
name|movzbl
name|P_PRI
argument_list|(
name|r0
argument_list|)
operator|,
name|r1
operator|#
name|put
name|on
name|queue
name|which
name|is
name|p
operator|->
name|p_pri
operator|/
literal|4
name|ashl
name|$
operator|-
literal|2
operator|,
name|r1
operator|,
name|r1
name|movaq
name|_qs
index|[
name|r1
index|]
operator|,
name|r2
name|insque
argument_list|(
name|r0
argument_list|)
operator|,
operator|*
literal|4
operator|(
name|r2
operator|)
operator|#
name|at
name|end
name|of
name|queue
name|bbss
name|r1
operator|,
name|_whichqs
operator|,
name|set2
operator|#
name|mark
name|queue
name|non
operator|-
name|empty
name|set2
operator|:
name|rsb
name|set3
operator|:
operator|.
name|asciz
literal|"setrq"
comment|/*  * Remrq(p), using fancy VAX instructions  *  * Call should be made at spl6().  */
operator|.
name|globl
name|_Remrq
operator|#
expr|<<<
name|massaged
name|to
name|jsb
name|by
literal|"asm.sed"
operator|>>>
name|_Remrq
operator|:
name|movzbl
name|P_PRI
argument_list|(
name|r0
argument_list|)
operator|,
name|r1
name|ashl
name|$
operator|-
literal|2
operator|,
name|r1
operator|,
name|r1
name|bbsc
name|r1
operator|,
name|_whichqs
operator|,
name|rem1
name|pushab
name|rem3
operator|#
name|it
name|wasn
literal|'t recorded to be on its q 	calls	$1,_panic rem1: 	remque	(r0),r2 	beql	rem2 	bbss	r1,_whichqs,rem2 rem2: 	clrl	P_RLINK(r0)		## for firewall checking 	rsb  rem3:	.asciz	"remrq"  /*  * Masterpaddr is the p->p_addr of the running process on the master  * processor.  When a multiprocessor system, the slave processors will have  * an array of slavepaddr'
name|s
operator|.
modifier|*
expr|/
operator|.
name|globl
name|_masterpaddr
operator|.
name|data
name|_masterpaddr
operator|:
operator|.
name|long
literal|0
operator|.
name|text
name|sw0
operator|:
operator|.
name|asciz
literal|"swtch"
comment|/*  * Swtch(), using fancy VAX instructions  */
operator|.
name|globl
name|_Swtch
name|_Swtch
operator|:
operator|#
expr|<<<
name|massaged
name|to
name|jsb
name|by
literal|"asm.sed"
operator|>>>
name|movl
name|$1
operator|,
name|_noproc
name|clrl
name|_runrun
name|sw1
operator|:
name|ffs
name|$0
operator|,
name|$32
operator|,
name|_whichqs
operator|,
name|r0
operator|#
name|look
for|for non-empty queue 	bneq	sw1a 	mtpr	$0
operator|,
name|$IPL
operator|#
name|must
name|allow
name|interrupts
name|here
name|jbr
name|sw1
operator|#
name|this
name|is
name|an
name|idle
name|loop
operator|!
name|sw1a
operator|:
name|mtpr
name|$0x18
operator|,
name|$IPL
operator|#
name|lock
name|out
name|all
name|so
name|_whichqs
operator|==
name|_qs
name|bbcc
name|r0
operator|,
name|_whichqs
operator|,
name|sw1
operator|#
name|proc
name|moved
name|via
name|lbolt
name|interrupt
name|movaq
name|_qs
index|[
name|r0
index|]
operator|,
name|r1
name|remque
operator|*
operator|(
name|r1
operator|)
operator|,
name|r2
operator|#
name|r2
operator|=
name|p
operator|=
name|highest
name|pri
name|process
name|bvc
name|sw2
operator|#
name|make
name|sure
name|something
name|was
name|there
name|sw1b
operator|:
name|pushab
name|sw0
name|calls
name|$1
operator|,
name|_panic
name|sw2
operator|:
name|beql
name|sw3
name|insv
name|$1
operator|,
name|r0
operator|,
name|$1
operator|,
name|_whichqs
operator|#
name|still
name|more
name|procs
name|in
name|this
name|queue
name|sw3
operator|:
name|clrl
name|_noproc
name|tstl
name|P_WCHAN
argument_list|(
name|r2
argument_list|)
operator|#
operator|#
name|firewalls
name|bneq
name|sw1b
operator|#
operator|#
name|movzbl
name|P_STAT
argument_list|(
name|r2
argument_list|)
operator|,
name|r3
operator|#
operator|#
name|cmpl
name|$SRUN
operator|,
name|r3
operator|#
operator|#
name|bneq
name|sw1b
operator|#
operator|#
name|clrl
name|P_RLINK
argument_list|(
name|r2
argument_list|)
operator|#
operator|#
name|movl
operator|*
name|P_ADDR
argument_list|(
name|r2
argument_list|)
operator|,
name|r0
name|movl
name|r0
operator|,
name|_masterpaddr
name|ashl
name|$PGSHIFT
operator|,
name|r0
operator|,
name|r0
operator|#
name|r0
operator|=
name|pcbb
argument_list|(
argument|p
argument_list|)
comment|/*	mfpr	$PCBB,r1		# resume of current proc is easy  *	cmpl	r0,r1  */
name|beql
name|res0
name|incl
name|_cnt
operator|+
name|V_SWTCH
comment|/* fall into... */
comment|/*  * Resume(pf)  */
operator|.
name|globl
name|_Resume
operator|#
expr|<<<
name|massaged
name|to
name|jsb
name|by
literal|"asm.sed"
operator|>>>
name|_Resume
operator|:
name|mtpr
name|$0x18
operator|,
name|$IPL
operator|#
name|no
name|interrupts
operator|,
name|please
name|movl
name|_CMAP2
operator|,
name|_u
operator|+
name|PCB_CMAP2
operator|#
name|yech
name|svpctx
name|mtpr
name|r0
operator|,
name|$PCBB
name|ldpctx
name|movl
name|_u
operator|+
name|PCB_CMAP2
operator|,
name|_CMAP2
operator|#
name|yech
name|mtpr
name|$_CADDR2
operator|,
name|$TBIS
name|res0
operator|:
name|tstl
name|_u
operator|+
name|PCB_SSWAP
name|beql
name|res1
name|movl
name|_u
operator|+
name|PCB_SSWAP
operator|,
name|r0
name|clrl
name|_u
operator|+
name|PCB_SSWAP
name|movab
name|_Longjmp
operator|,
operator|(
name|sp
operator|)
name|movl
name|$PSL_PRVMOD
operator|,
literal|4
operator|(
name|sp
operator|)
operator|#
operator|`
operator|`
name|cheating
literal|''
operator|(
name|jfr
operator|)
name|res1
operator|:
name|rei
comment|/*  * {fu,su},{byte,word}, all massaged by asm.sed to jsb's  */
operator|.
name|globl
name|_Fuword
name|_Fuword
operator|:
name|prober
name|$3
operator|,
name|$4
operator|,
operator|(
name|r0
operator|)
name|beql
name|fserr
name|movl
argument_list|(
name|r0
argument_list|)
operator|,
name|r0
name|rsb
name|fserr
operator|:
name|mnegl
name|$1
operator|,
name|r0
name|rsb
operator|.
name|globl
name|_Fubyte
name|_Fubyte
operator|:
name|prober
name|$3
operator|,
name|$1
operator|,
operator|(
name|r0
operator|)
name|beql
name|fserr
name|movzbl
argument_list|(
name|r0
argument_list|)
operator|,
name|r0
name|rsb
operator|.
name|globl
name|_Suword
name|_Suword
operator|:
name|probew
name|$3
operator|,
name|$4
operator|,
operator|(
name|r0
operator|)
name|beql
name|fserr
name|movl
name|r1
operator|,
operator|(
name|r0
operator|)
name|clrl
name|r0
name|rsb
operator|.
name|globl
name|_Subyte
name|_Subyte
operator|:
name|probew
name|$3
operator|,
name|$1
operator|,
operator|(
name|r0
operator|)
name|beql
name|fserr
name|movb
name|r1
operator|,
operator|(
name|r0
operator|)
name|clrl
name|r0
name|rsb
comment|/*  * Copy 1 relocation unit (NBPG bytes)  * from user virtual address to physical address  */
name|_copyseg
operator|:
operator|.
name|globl
name|_copyseg
operator|.
name|word
literal|0x0
name|bisl3
name|$PG_V
operator||
name|PG_KW
operator|,
literal|8
operator|(
name|ap
operator|)
operator|,
name|_CMAP2
name|mtpr
name|$_CADDR2
operator|,
name|$TBIS
operator|#
name|invalidate
name|entry
for|for copy  	movc3	$NBPG
operator|,
operator|*
literal|4
operator|(
name|ap
operator|)
operator|,
name|_CADDR2
name|ret
comment|/*  * zero out physical memory  * specified in relocation units (NBPG bytes)  */
name|_clearseg
operator|:
operator|.
name|globl
name|_clearseg
operator|.
name|word
literal|0x0
name|bisl3
name|$PG_V
operator||
name|PG_KW
operator|,
literal|4
operator|(
name|ap
operator|)
operator|,
name|_CMAP1
name|mtpr
name|$_CADDR1
operator|,
name|$TBIS
name|movc5
name|$0
operator|,
operator|(
name|sp
operator|)
operator|,
name|$0
operator|,
name|$NBPG
operator|,
name|_CADDR1
name|ret
comment|/*  * Check address.  * Given virtual address, byte count, and rw flag  * returns 0 on no access.  */
name|_useracc
operator|:
operator|.
name|globl
name|_useracc
operator|.
name|word
literal|0x0
name|movl
literal|4
operator|(
name|ap
operator|)
operator|,
name|r0
operator|#
name|get
name|va
name|movl
literal|8
operator|(
name|ap
operator|)
operator|,
name|r1
operator|#
name|count
name|tstl
literal|12
operator|(
name|ap
operator|)
operator|#
name|test
for|for read access ? 	bneq	userar			# yes 	cmpl	$NBPG
operator|,
name|r1
operator|#
name|can
name|we
do|do
name|it
name|in
name|one
name|probe
condition|?
name|bgeq
name|uaw2
operator|#
name|yes
name|uaw1
else|:
name|probew
name|$3
operator|,
name|$NBPG
operator|,
operator|(
name|r0
operator|)
name|beql
name|uaerr
operator|#
name|no
name|access
name|addl2
name|$NBPG
operator|,
name|r0
name|acbl
name|$NBPG
operator|+
literal|1
operator|,
name|$
operator|-
name|NBPG
operator|,
name|r1
operator|,
name|uaw1
name|uaw2
operator|:
name|probew
name|$3
operator|,
name|r1
operator|,
operator|(
name|r0
operator|)
name|beql
name|uaerr
name|movl
name|$1
operator|,
name|r0
name|ret
name|userar
operator|:
name|cmpl
name|$NBPG
operator|,
name|r1
name|bgeq
name|uar2
name|uar1
operator|:
name|prober
name|$3
operator|,
name|$NBPG
operator|,
operator|(
name|r0
operator|)
name|beql
name|uaerr
name|addl2
name|$NBPG
operator|,
name|r0
name|acbl
name|$NBPG
operator|+
literal|1
operator|,
name|$
operator|-
name|NBPG
operator|,
name|r1
operator|,
name|uar1
name|uar2
operator|:
name|prober
name|$3
operator|,
name|r1
operator|,
operator|(
name|r0
operator|)
name|beql
name|uaerr
name|movl
name|$1
operator|,
name|r0
name|ret
name|uaerr
operator|:
name|clrl
name|r0
name|ret
comment|/*  * kernacc - check for kernel access privileges  *  * We can't use the probe instruction directly because  * it ors together current and previous mode.  */
operator|.
name|globl
name|_kernacc
name|_kernacc
operator|:
operator|.
name|word
literal|0x0
name|movl
literal|4
operator|(
name|ap
operator|)
operator|,
name|r0
operator|#
name|virtual
name|address
name|bbcc
name|$31
operator|,
name|r0
operator|,
name|kacc1
name|bbs
name|$30
operator|,
name|r0
operator|,
name|kacerr
name|mfpr
name|$SBR
operator|,
name|r2
operator|#
name|address
name|and
name|length
name|of
name|page
name|table
argument_list|(
argument|system
argument_list|)
name|bbss
name|$31
operator|,
name|r2
operator|,
literal|0f
expr_stmt|;
do|0: 	mfpr	$SLR
operator|,
do|r3 	brb	kacc2 kacc1: 	bbsc	$30
operator|,
do|r0
operator|,
do|kacc3 	mfpr	$P0BR
operator|,
do|r2	# user P0 	mfpr	$P0LR
operator|,
do|r3 	brb	kacc2 kacc3: 	mfpr	$P1BR
operator|,
do|r2	# user P1 (stack
end_do

begin_decl_stmt
unit|)
name|mfpr
name|$P1LR
decl_stmt|,
name|r3
name|kacc2
range|:
name|addl3
literal|8
operator|(
name|ap
operator|)
decl_stmt|,
name|r0
decl_stmt|,
name|r1
decl|#
name|ending
name|virtual
name|address
name|addl2
name|$NBPG
decl|-1
decl_stmt|,
name|r1
name|ashl
name|$
decl|-
name|PGSHIFT
decl_stmt|,
name|r0
decl_stmt|,
name|r0
name|ashl
name|$
decl|-
name|PGSHIFT
decl_stmt|,
name|r1
decl_stmt|,
name|r1
name|bbs
name|$31
decl_stmt|,4
argument_list|(
name|ap
argument_list|)
decl_stmt|,
name|kacc6
name|bbc
name|$30
decl_stmt|,4
argument_list|(
name|ap
argument_list|)
decl_stmt|,
name|kacc6
name|cmpl
name|r0
decl_stmt|,
name|r3
decl|#
name|user
name|stack
name|blss
name|kacerr
decl|#
name|address
name|too
name|low
name|brb
name|kacc4
name|kacc6
range|:
name|cmpl
name|r1
decl_stmt|,
name|r3
decl|#
name|compare
name|last
name|page
name|to
name|P0LR
name|or
name|SLR
name|bgtr
name|kacerr
decl|#
name|address
name|too
name|high
name|kacc4
range|:
name|movl
argument_list|(
name|r2
argument_list|)
index|[
name|r0
index|]
decl_stmt|,
name|r3
name|bbc
name|$31
decl_stmt|,4
argument_list|(
name|ap
argument_list|)
decl_stmt|,
name|kacc4a
name|bbc
name|$31
decl_stmt|,
name|r3
decl_stmt|,
name|kacerr
decl|#
name|valid
name|bit
name|is
name|off
name|kacc4a
range|:
name|cmpzv
name|$27
decl_stmt|,
name|$4
decl_stmt|,
name|r3
decl_stmt|,
name|$1
decl|#
name|check
name|protection
name|code
name|bleq
name|kacerr
decl|#
name|no
name|access
name|allowed
name|tstb
decl|12
argument_list|(
name|ap
argument_list|)
name|bneq
name|kacc5
decl|#
name|only
name|check
name|read
name|access
name|cmpzv
name|$27
decl_stmt|,
name|$2
decl_stmt|,
name|r3
decl_stmt|,
name|$3
decl|#
name|check
name|low
decl|2
name|bits
name|of
name|prot
name|code
name|beql
name|kacerr
decl|#
name|no
name|write
name|access
name|kacc5
range|:
name|aoblss
name|r1
decl_stmt|,
name|r0
decl_stmt|,
name|kacc4
decl|#
name|next
name|page
name|movl
name|$1
decl_stmt|,
name|r0
decl|#
name|no
name|errors
name|ret
name|kacerr
range|:
name|clrl
name|r0
operator|#
name|error
name|ret
comment|/*  * Extracted and unrolled most common case of pagein (hopefully):  *	resident and not on free list (reclaim of page is purely  *	for the purpose of simulating a reference bit)  *  * Built in constants:  *	CLSIZE of 2, USRSTACK of 0x7ffff000, any bit fields  *	in pte's or the core map  */
operator|.
name|text
operator|.
name|globl
name|Fastreclaim
name|Fastreclaim
operator|:
name|PUSHR
name|extzv
name|$9
decl_stmt|,
name|$23
decl_stmt|,28
argument_list|(
name|sp
argument_list|)
decl_stmt|,
name|r3
decl|#
name|virtual
name|address
name|bicl2
name|$1
decl_stmt|,
name|r3
decl|#
name|v
init|=
name|clbase
argument_list|(
name|btop
argument_list|(
name|virtaddr
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|movl
name|_u
operator|+
name|U_PROCP
operator|,
name|r5
operator|#
name|p
operator|=
name|u
operator|.
name|u_procp
empty|# from vtopte(p, v) ...
name|cmpl
name|r3
operator|,
name|P_TSIZE
argument_list|(
argument|r5
argument_list|)
name|jgequ
literal|2f
operator|#
end_expr_stmt

begin_if
if|if
condition|(
name|isatsv
argument_list|(
name|p
argument_list|,
name|v
argument_list|)
condition|)
block|{
name|ashl
name|$2
decl_stmt|,
name|r3
decl_stmt|,
name|r4
name|addl2
name|P_P0BR
argument_list|(
name|r5
argument_list|)
decl_stmt|,
name|r4
decl|#
name|tptopte
argument_list|(
name|p
argument_list|,
name|vtotp
argument_list|(
name|p
argument_list|,
name|v
argument_list|)
argument_list|)
decl_stmt|;
name|movl
name|$1
decl_stmt|,
name|r2
decl|#
name|type
init|=
name|CTEXT
decl_stmt|;
name|jbr
literal|3f
literal|2
operator|:
name|subl3
name|P_SSIZE
argument_list|(
name|r5
argument_list|)
operator|,
name|$0x3ffff8
operator|,
name|r0
name|cmpl
name|r3
operator|,
name|r0
name|jgequ
literal|2f
operator|#
block|}
elseif|else
if|if
condition|(
name|isadsv
argument_list|(
name|p
argument_list|,
name|v
argument_list|)
condition|)
block|{
name|ashl
name|$2
decl_stmt|,
name|r3
decl_stmt|,
name|r4
name|addl2
name|P_P0BR
argument_list|(
name|r5
argument_list|)
decl_stmt|,
name|r4
decl|#
name|dptopte
argument_list|(
name|p
argument_list|,
name|vtodp
argument_list|(
name|p
argument_list|,
name|v
argument_list|)
argument_list|)
decl_stmt|;
name|clrl
name|r2
operator|#
name|type
operator|=
operator|!
name|CTEXT
expr_stmt|;
name|jbr
literal|3f
literal|2
operator|:
name|cvtwl
name|P_SZPT
argument_list|(
name|r5
argument_list|)
operator|,
name|r4
operator|#
block|}
else|else
operator|(
name|isassv
argument_list|(
name|p
argument_list|,
name|v
argument_list|)
operator|)
block|{
name|ashl
name|$7
block|,
name|r4
block|,
name|r4
name|subl2
name|$
argument_list|(
literal|0x3ffff8
operator|+
name|UPAGES
argument_list|)
block|,
name|r4
name|addl2
name|r3
block|,
name|r4
name|ashl
name|$2
block|,
name|r4
block|,
name|r4
name|addl2
name|P_P0BR
argument_list|(
name|r5
argument_list|)
block|,
name|r4
operator|#
name|sptopte
argument_list|(
name|p
argument_list|,
name|vtosp
argument_list|(
name|p
argument_list|,
name|v
argument_list|)
argument_list|)
block|;
name|clrl
name|r2
operator|#
name|type
operator|=
operator|!
name|CTEXT
expr_stmt|;
end_if

begin_expr_stmt
literal|3
operator|:
operator|#
end_expr_stmt

begin_expr_stmt
unit|} 	bitb
name|$0x82
operator|,
literal|3
operator|(
name|r4
operator|)
name|beql
literal|2f
operator|#
end_expr_stmt

begin_if
if|if
condition|(
name|pte
operator|->
name|pg_v
operator|||
name|pte
operator|->
name|pg_fod
condition|)
name|POPR
expr_stmt|;
end_if

begin_expr_stmt
name|rsb
operator|#
name|let
name|pagein
name|handle
name|it
literal|2
operator|:
name|bicl3
name|$0xffe00000
operator|,
operator|(
name|r4
operator|)
operator|,
name|r0
name|jneq
literal|2f
operator|#
end_expr_stmt

begin_if
if|if
condition|(
name|pte
operator|->
name|pg_pfnum
operator|==
literal|0
condition|)
name|POPR
expr_stmt|;
end_if

begin_expr_stmt
name|rsb
operator|#
name|let
name|pagein
name|handle
name|it
literal|2
operator|:
name|subl2
name|_firstfree
operator|,
name|r0
name|ashl
name|$
operator|-
literal|1
operator|,
name|r0
operator|,
name|r0
name|incl
name|r0
operator|#
name|pgtocm
argument_list|(
argument|pte->pg_pfnum
argument_list|)
name|mull2
name|$12
operator|,
name|r0
name|addl2
name|_cmap
operator|,
name|r0
operator|#
operator|&
name|cmap
index|[
name|pgtocm
argument_list|(
name|pte
operator|->
name|pg_pfnum
argument_list|)
index|]
name|tstl
name|r2
name|jeql
literal|2f
operator|#
end_expr_stmt

begin_if
if|if
condition|(
name|type
operator|==
name|CTEXT
operator|&&
name|jbc
name|$29
operator|,
literal|4
operator|(
name|r0
operator|)
operator|,
literal|2f
operator|#
name|c_intrans
condition|)
name|POPR
expr_stmt|;
end_if

begin_expr_stmt
name|rsb
operator|#
name|let
name|pagein
name|handle
name|it
literal|2
operator|:
name|jbc
name|$30
operator|,
literal|4
operator|(
name|r0
operator|)
operator|,
literal|2f
operator|#
end_expr_stmt

begin_if
if|if
condition|(
name|c_free
condition|)
name|POPR
expr_stmt|;
end_if

begin_expr_stmt
name|rsb
operator|#
name|let
name|pagein
name|handle
name|it
literal|2
operator|:
name|bisb2
name|$0x80
operator|,
literal|3
operator|(
name|r4
operator|)
operator|#
name|pte
operator|->
name|pg_v
operator|=
literal|1
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|jbc
name|$26
decl_stmt|,4
argument_list|(
name|r4
argument_list|)
decl_stmt|,2f		# if
argument_list|(
name|anycl
argument_list|(
argument|pte
argument_list|,
argument|pg_m
argument_list|)
name|bisb2
name|$0x04
argument_list|,
literal|3
operator|(
name|r4
operator|)
operator|#
name|pte
operator|->
name|pg_m
operator|=
literal|1
argument_list|;
literal|2
operator|:
name|bicw3
name|$0x7f
argument_list|,
literal|2
operator|(
name|r4
operator|)
argument_list|,
name|r0
name|bicw3
name|$0xff80
argument_list|,
literal|6
operator|(
name|r4
operator|)
argument_list|,
name|r1
name|bisw3
name|r0
argument_list|,
name|r1
argument_list|,
literal|6
operator|(
name|r4
operator|)
operator|#
name|distcl
argument_list|(
name|pte
argument_list|)
argument_list|;
name|ashl
name|$PGSHIFT
argument_list|,
name|r3
argument_list|,
name|r0
name|mtpr
name|r0
argument_list|,
name|$TBIS
name|addl2
name|$NBPG
argument_list|,
name|r0
name|mtpr
name|r0
argument_list|,
name|$TBIS
operator|#
name|tbiscl
argument_list|(
name|v
argument_list|)
argument_list|;
name|tstl
name|r2
name|jeql
literal|2f
operator|#
if|if
condition|(
name|type
operator|==
name|CTEXT
condition|)
name|movl
name|P_TEXTP
argument_list|(
name|r5
argument_list|)
decl_stmt|,
name|r0
name|movl
name|X_CADDR
argument_list|(
name|r0
argument_list|)
decl_stmt|,
name|r5
decl|# for
argument_list|(
name|p
operator|=
name|p
operator|->
name|p_textp
operator|->
name|x_caddr
argument_list|;
end_decl_stmt

begin_expr_stmt
name|p
expr_stmt|;
end_expr_stmt

begin_block
unit|)
block|{
name|jeql
literal|2f
name|ashl
name|$2
operator|,
name|r3
operator|,
name|r3
literal|3
operator|:
name|addl3
name|P_P0BR
argument_list|(
name|r5
argument_list|)
operator|,
name|r3
operator|,
name|r0
operator|#
name|tpte
operator|=
name|tptopte
argument_list|(
name|p
argument_list|,
name|tp
argument_list|)
expr_stmt|;
name|bisb2
name|$1
decl_stmt|,
name|P_FLAG
decl|+3
argument_list|(
name|r5
argument_list|)
decl|#
name|p
operator|->
name|p_flag
decl||=
name|SPTECHG
decl_stmt|;
name|movl
argument_list|(
name|r4
argument_list|)
operator|,
operator|(
name|r0
operator|)
operator|+
operator|#
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CLSIZE
condition|;
name|i
operator|++
control|)
name|movl
literal|4
operator|(
name|r4
operator|)
operator|,
operator|(
name|r0
operator|)
operator|#
name|tpte
index|[
name|i
index|]
operator|=
name|pte
index|[
name|i
index|]
expr_stmt|;
name|movl
name|P_XLINK
argument_list|(
name|r5
argument_list|)
decl_stmt|,
name|r5
decl|#
name|p
init|=
name|p
operator|->
name|p_xlink
decl_stmt|;
name|jneq
literal|3b
operator|#
block|}
end_block

begin_expr_stmt
literal|2
operator|:
operator|#
name|collect
name|a
name|few
name|statistics
operator|...
name|incl
name|_u
operator|+
name|U_RU
operator|+
name|RU_MINFLT
operator|#
name|u
operator|.
name|u_ru
operator|.
name|ru_minflt
operator|++
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|moval
name|_cnt
decl_stmt|,
name|r0
name|incl
name|V_FAULTS
argument_list|(
name|r0
argument_list|)
decl|#
name|cnt
operator|.
name|v_faults
decl|++
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|incl
name|V_PGREC
argument_list|(
name|r0
argument_list|)
decl|#
name|cnt
operator|.
name|v_pgrec
decl|++
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|incl
name|V_FASTPGREC
argument_list|(
name|r0
argument_list|)
decl|#
name|cnt
operator|.
name|v_fastpgrec
decl|++
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|incl
name|V_TRAP
argument_list|(
name|r0
argument_list|)
decl|#
name|cnt
operator|.
name|v_trap
decl|++
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|POPR
name|addl2
name|$8
decl_stmt|,
name|sp
decl|#
name|pop
name|pc
decl_stmt|,
name|code
name|mtpr
name|$HIGH
decl_stmt|,
name|$IPL
decl|##
name|dont
name|go
name|to
name|a
name|higher
name|IPL
argument_list|(
name|GROT
argument_list|)
name|rei
operator|.
name|globl
name|_Xrkintr0
operator|.
name|align
decl|2
name|_Xrkintr0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_rkintr
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xtmintr0
operator|.
name|align
decl|2
name|_Xtmintr0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_tmintr
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xutintr0
operator|.
name|align
decl|2
name|_Xutintr0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_utintr
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xupintr0
operator|.
name|align
decl|2
name|_Xupintr0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_upintr
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xudintr0
operator|.
name|align
decl|2
name|_Xudintr0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_udintr
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xidcintr0
operator|.
name|align
decl|2
name|_Xidcintr0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_idcintr
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xrlintr0
operator|.
name|align
decl|2
name|_Xrlintr0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_rlintr
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdhrint0
operator|.
name|align
decl|2
name|_Xdhrint0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dhrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdhxint0
operator|.
name|align
decl|2
name|_Xdhxint0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dhxint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdmintr0
operator|.
name|align
decl|2
name|_Xdmintr0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dmintr
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdhrint1
operator|.
name|align
decl|2
name|_Xdhrint1
range|:
name|pushr
name|$0x3f
name|pushl
name|$1
name|calls
name|$1
decl_stmt|,
name|_dhrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdhxint1
operator|.
name|align
decl|2
name|_Xdhxint1
range|:
name|pushr
name|$0x3f
name|pushl
name|$1
name|calls
name|$1
decl_stmt|,
name|_dhxint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdzrint0
operator|.
name|align
decl|2
name|_Xdzrint0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dzrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdzxint0
operator|.
name|align
decl|2
name|_Xdzxint0
range|:
name|pushr
name|$0x3f
name|movl
name|$0
decl_stmt|,
name|r0
name|jmp
name|dzdma
operator|.
name|globl
name|_Xdzrint1
operator|.
name|align
decl|2
name|_Xdzrint1
range|:
name|pushr
name|$0x3f
name|pushl
name|$1
name|calls
name|$1
decl_stmt|,
name|_dzrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdzxint1
operator|.
name|align
decl|2
name|_Xdzxint1
range|:
name|pushr
name|$0x3f
name|movl
name|$1
decl_stmt|,
name|r0
name|jmp
name|dzdma
operator|.
name|globl
name|_Xdzrint2
operator|.
name|align
decl|2
name|_Xdzrint2
range|:
name|pushr
name|$0x3f
name|pushl
name|$2
name|calls
name|$1
decl_stmt|,
name|_dzrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdzxint2
operator|.
name|align
decl|2
name|_Xdzxint2
range|:
name|pushr
name|$0x3f
name|movl
name|$2
decl_stmt|,
name|r0
name|jmp
name|dzdma
operator|.
name|globl
name|_Xdzrint3
operator|.
name|align
decl|2
name|_Xdzrint3
range|:
name|pushr
name|$0x3f
name|pushl
name|$3
name|calls
name|$1
decl_stmt|,
name|_dzrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdzxint3
operator|.
name|align
decl|2
name|_Xdzxint3
range|:
name|pushr
name|$0x3f
name|movl
name|$3
decl_stmt|,
name|r0
name|jmp
name|dzdma
operator|.
name|globl
name|_Xdzrint4
operator|.
name|align
decl|2
name|_Xdzrint4
range|:
name|pushr
name|$0x3f
name|pushl
name|$4
name|calls
name|$1
decl_stmt|,
name|_dzrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdzxint4
operator|.
name|align
decl|2
name|_Xdzxint4
range|:
name|pushr
name|$0x3f
name|movl
name|$4
decl_stmt|,
name|r0
name|jmp
name|dzdma
operator|.
name|globl
name|_Xdzrint5
operator|.
name|align
decl|2
name|_Xdzrint5
range|:
name|pushr
name|$0x3f
name|pushl
name|$5
name|calls
name|$1
decl_stmt|,
name|_dzrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdzxint5
operator|.
name|align
decl|2
name|_Xdzxint5
range|:
name|pushr
name|$0x3f
name|movl
name|$5
decl_stmt|,
name|r0
name|jmp
name|dzdma
operator|.
name|globl
name|_Xdzrint6
operator|.
name|align
decl|2
name|_Xdzrint6
range|:
name|pushr
name|$0x3f
name|pushl
name|$6
name|calls
name|$1
decl_stmt|,
name|_dzrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdzxint6
operator|.
name|align
decl|2
name|_Xdzxint6
range|:
name|pushr
name|$0x3f
name|movl
name|$6
decl_stmt|,
name|r0
name|jmp
name|dzdma
operator|.
name|globl
name|_Xdzrint7
operator|.
name|align
decl|2
name|_Xdzrint7
range|:
name|pushr
name|$0x3f
name|pushl
name|$7
name|calls
name|$1
decl_stmt|,
name|_dzrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdzxint7
operator|.
name|align
decl|2
name|_Xdzxint7
range|:
name|pushr
name|$0x3f
name|movl
name|$7
decl_stmt|,
name|r0
name|jmp
name|dzdma
operator|.
name|globl
name|_Xtsintr0
operator|.
name|align
decl|2
name|_Xtsintr0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_tsintr
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdmfsrint0
operator|.
name|align
decl|2
name|_Xdmfsrint0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dmfsrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdmfsxint0
operator|.
name|align
decl|2
name|_Xdmfsxint0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dmfsxint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdmfdaint0
operator|.
name|align
decl|2
name|_Xdmfdaint0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dmfdaint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdmfdbint0
operator|.
name|align
decl|2
name|_Xdmfdbint0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dmfdbint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdmfrint0
operator|.
name|align
decl|2
name|_Xdmfrint0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dmfrint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdmfxint0
operator|.
name|align
decl|2
name|_Xdmfxint0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dmfxint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xdmflint0
operator|.
name|align
decl|2
name|_Xdmflint0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_dmflint
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
operator|.
name|globl
name|_Xlpintr0
operator|.
name|align
decl|2
name|_Xlpintr0
range|:
name|pushr
name|$0x3f
name|pushl
name|$0
name|calls
name|$1
decl_stmt|,
name|_lpintr
name|popr
name|$0x3f
if|#
directive|if
name|defined
argument_list|(
name|VAX750
argument_list|)
operator|||
name|defined
argument_list|(
name|VAX730
argument_list|)
name|incl
name|_cnt
decl|+
name|V_INTR
endif|#
directive|endif
name|rei
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	raw_usrreq.c	4.1	81/11/29	*/
end_comment

begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/mbuf.h"
end_include

begin_include
include|#
directive|include
file|"../h/socket.h"
end_include

begin_include
include|#
directive|include
file|"../h/socketvar.h"
end_include

begin_include
include|#
directive|include
file|"../h/mtpr.h"
end_include

begin_include
include|#
directive|include
file|"../net/in.h"
end_include

begin_include
include|#
directive|include
file|"../net/in_systm.h"
end_include

begin_include
include|#
directive|include
file|"../net/if.h"
end_include

begin_comment
comment|/*  * Raw protocol interface.  */
end_comment

begin_macro
name|raw_input
argument_list|(
argument|m
argument_list|,
argument|pf
argument_list|,
argument|af
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockproto
name|pf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr
name|af
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|mbuf
modifier|*
name|mh
decl_stmt|;
name|struct
name|sockproto
modifier|*
name|pfp
decl_stmt|;
name|int
name|s
decl_stmt|;
name|mh
operator|=
name|m_get
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mh
operator|==
literal|0
condition|)
goto|goto
name|drop
goto|;
name|mh
operator|->
name|m_next
operator|=
name|m
expr_stmt|;
name|mh
operator|->
name|m_off
operator|=
name|MMINOFF
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sockproto
argument_list|)
expr_stmt|;
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|sockaddr
operator|*
argument_list|)
operator|=
name|af
expr_stmt|;
name|mh
operator|->
name|m_off
operator|=
name|MMINOFF
expr_stmt|;
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|sockproto
operator|*
argument_list|)
operator|=
name|pf
expr_stmt|;
name|mh
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockproto
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
expr_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|IF_ENQUEUE
argument_list|(
operator|&
name|rawintrq
argument_list|,
name|mh
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|setrawintr
argument_list|()
expr_stmt|;
return|return;
name|drop
label|:
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rawintr
argument_list|()
end_macro

begin_block
block|{
name|int
name|s
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|COUNT
argument_list|(
name|RAWINTR
argument_list|)
expr_stmt|;
name|next
label|:
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
comment|/*###45 [cc] rawintrq undefined %%%*/
name|IF_DEQUEUE
argument_list|(
operator|&
name|rawintrq
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return;
comment|/* ... */
goto|goto
name|drop
goto|;
name|drop
label|:
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|raw_usrreq
argument_list|(
argument|so
argument_list|,
argument|req
argument_list|,
argument|m
argument_list|,
argument|addr
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|req
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|COUNT
argument_list|(
name|RAW_USRREQ
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


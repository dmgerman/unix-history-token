begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	if.c	4.13	82/03/30	*/
end_comment

begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/systm.h"
end_include

begin_include
include|#
directive|include
file|"../h/socket.h"
end_include

begin_include
include|#
directive|include
file|"../net/in.h"
end_include

begin_include
include|#
directive|include
file|"../net/in_systm.h"
end_include

begin_include
include|#
directive|include
file|"../net/if.h"
end_include

begin_include
include|#
directive|include
file|"../net/af.h"
end_include

begin_decl_stmt
name|int
name|ifqmaxlen
init|=
name|IFQ_MAXLEN
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Network interface utility routines.  *  * Routines with if_ifwith* names take sockaddr *'s as  * parameters.  Other routines take value parameters,  * e.g. if_ifwithnet takes the network number.  */
end_comment

begin_macro
name|ifinit
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
for|for
control|(
name|ifp
operator|=
name|ifnet
init|;
name|ifp
condition|;
name|ifp
operator|=
name|ifp
operator|->
name|if_next
control|)
if|if
condition|(
name|ifp
operator|->
name|if_init
condition|)
block|{
call|(
modifier|*
name|ifp
operator|->
name|if_init
call|)
argument_list|(
name|ifp
operator|->
name|if_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|==
literal|0
condition|)
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|ifqmaxlen
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * Call each interface on a Unibus reset.  */
end_comment

begin_macro
name|ifubareset
argument_list|(
argument|uban
argument_list|)
end_macro

begin_decl_stmt
name|int
name|uban
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
for|for
control|(
name|ifp
operator|=
name|ifnet
init|;
name|ifp
condition|;
name|ifp
operator|=
name|ifp
operator|->
name|if_next
control|)
if|if
condition|(
name|ifp
operator|->
name|if_ubareset
condition|)
call|(
modifier|*
name|ifp
operator|->
name|if_ubareset
call|)
argument_list|(
name|uban
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Attach an interface to the  * list of "active" interfaces.  */
end_comment

begin_macro
name|if_attach
argument_list|(
argument|ifp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|ifnet
modifier|*
modifier|*
name|p
init|=
operator|&
name|ifnet
decl_stmt|;
name|COUNT
argument_list|(
name|IF_ATTACH
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
name|p
operator|=
operator|&
operator|(
operator|(
operator|*
name|p
operator|)
operator|->
name|if_next
operator|)
expr_stmt|;
operator|*
name|p
operator|=
name|ifp
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Locate an interface based on a complete address.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
name|struct
name|ifnet
modifier|*
name|if_ifwithaddr
parameter_list|(
name|addr
parameter_list|)
name|struct
name|sockaddr
modifier|*
name|addr
decl_stmt|;
block|{
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|COUNT
argument_list|(
name|IF_IFWITHADDR
argument_list|)
expr_stmt|;
define|#
directive|define
name|equal
parameter_list|(
name|a1
parameter_list|,
name|a2
parameter_list|)
define|\
value|(bcmp((caddr_t)((a1)->sa_data), (caddr_t)((a2)->sa_data), 14) == 0)
for|for
control|(
name|ifp
operator|=
name|ifnet
init|;
name|ifp
condition|;
name|ifp
operator|=
name|ifp
operator|->
name|if_next
control|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_addr
operator|.
name|sa_family
operator|!=
name|addr
operator|->
name|sa_family
condition|)
continue|continue;
if|if
condition|(
name|equal
argument_list|(
operator|&
name|ifp
operator|->
name|if_addr
argument_list|,
name|addr
argument_list|)
condition|)
break|break;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_BROADCAST
operator|)
operator|&&
name|equal
argument_list|(
operator|&
name|ifp
operator|->
name|if_broadaddr
argument_list|,
name|addr
argument_list|)
condition|)
break|break;
block|}
return|return
operator|(
name|ifp
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find an interface on a specific network.  If many, choice  * is first found.  */
end_comment

begin_function
name|struct
name|ifnet
modifier|*
name|if_ifwithnet
parameter_list|(
name|addr
parameter_list|)
specifier|register
name|struct
name|sockaddr
modifier|*
name|addr
decl_stmt|;
block|{
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
specifier|register
name|int
name|af
init|=
name|addr
operator|->
name|sa_family
decl_stmt|;
specifier|register
name|int
function_decl|(
modifier|*
name|netmatch
function_decl|)
parameter_list|()
init|=
name|afswitch
index|[
name|af
index|]
operator|.
name|af_netmatch
function_decl|;
for|for
control|(
name|ifp
operator|=
name|ifnet
init|;
name|ifp
condition|;
name|ifp
operator|=
name|ifp
operator|->
name|if_next
control|)
block|{
if|if
condition|(
name|af
operator|!=
name|ifp
operator|->
name|if_addr
operator|.
name|sa_family
condition|)
continue|continue;
if|if
condition|(
call|(
modifier|*
name|netmatch
call|)
argument_list|(
name|addr
argument_list|,
operator|&
name|ifp
operator|->
name|if_addr
argument_list|)
condition|)
break|break;
block|}
return|return
operator|(
name|ifp
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * As above, but parameter is network number.  */
end_comment

begin_function
name|struct
name|ifnet
modifier|*
name|if_ifonnetof
parameter_list|(
name|net
parameter_list|)
specifier|register
name|int
name|net
decl_stmt|;
block|{
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
for|for
control|(
name|ifp
operator|=
name|ifnet
init|;
name|ifp
condition|;
name|ifp
operator|=
name|ifp
operator|->
name|if_next
control|)
if|if
condition|(
name|ifp
operator|->
name|if_net
operator|==
name|net
condition|)
break|break;
return|return
operator|(
name|ifp
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find an interface using a specific address family  */
end_comment

begin_function
name|struct
name|ifnet
modifier|*
name|if_ifwithaf
parameter_list|(
name|af
parameter_list|)
specifier|register
name|int
name|af
decl_stmt|;
block|{
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
for|for
control|(
name|ifp
operator|=
name|ifnet
init|;
name|ifp
condition|;
name|ifp
operator|=
name|ifp
operator|->
name|if_next
control|)
if|if
condition|(
name|ifp
operator|->
name|if_addr
operator|.
name|sa_family
operator|==
name|af
condition|)
break|break;
return|return
operator|(
name|ifp
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Formulate an Internet address from network + host.  Used in  * building addresses stored in the ifnet structure.  */
end_comment

begin_function
name|struct
name|in_addr
name|if_makeaddr
parameter_list|(
name|net
parameter_list|,
name|host
parameter_list|)
name|int
name|net
decl_stmt|,
name|host
decl_stmt|;
block|{
name|u_long
name|addr
decl_stmt|;
if|if
condition|(
name|net
operator|<
literal|128
condition|)
name|addr
operator|=
operator|(
name|net
operator|<<
literal|24
operator|)
operator||
name|host
expr_stmt|;
elseif|else
if|if
condition|(
name|net
operator|<
literal|65536
condition|)
name|addr
operator|=
operator|(
name|net
operator|<<
literal|16
operator|)
operator||
name|host
expr_stmt|;
else|else
name|addr
operator|=
operator|(
name|net
operator|<<
literal|8
operator|)
operator||
name|host
expr_stmt|;
ifdef|#
directive|ifdef
name|vax
name|addr
operator|=
name|htonl
argument_list|(
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
operator|*
operator|(
expr|struct
name|in_addr
operator|*
operator|)
operator|&
name|addr
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Initialize an interface's routing  * table entry according to the network.  * INTERNET SPECIFIC.  */
end_comment

begin_expr_stmt
name|if_rtinit
argument_list|(
name|ifp
argument_list|,
name|flags
argument_list|)
specifier|register
expr|struct
name|ifnet
operator|*
name|ifp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|flags
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_ROUTE
condition|)
return|return;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|sin
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|.
name|sin_addr
operator|=
name|if_makeaddr
argument_list|(
name|ifp
operator|->
name|if_net
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtinit
argument_list|(
operator|&
name|sin
argument_list|,
operator|&
name|ifp
operator|->
name|if_addr
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	machdep.c	1.3	87/10/27	*/
end_comment

begin_include
include|#
directive|include
file|"../tahoe/mem.h"
end_include

begin_include
include|#
directive|include
file|"../tahoe/mtpr.h"
end_include

begin_include
include|#
directive|include
file|"../tahoe/SYS.h"
end_include

begin_expr_stmt
operator|.
name|set
name|_scb
operator|,
literal|0x0
operator|.
name|set
name|HIGH
operator|,
literal|0x1f
operator|#
name|mask
end_expr_stmt

begin_for
for|for total disable 	.set	BERVEC
operator|,
literal|0x80
operator|#
name|offset
name|into
name|scb
name|of
name|the
name|bus
name|error
name|vector
operator|.
name|set
name|RESTVEC
operator|,
literal|0x8
operator|#
name|offset
name|into
name|scb
name|of
name|the
name|restart
name|vector
name|ENTRY
argument_list|(
argument|mtpr
argument_list|,
literal|0
argument_list|)
name|mtpr
literal|8
operator|(
name|fp
operator|)
operator|,
literal|4
operator|(
name|fp
operator|)
name|ret
name|ENTRY
argument_list|(
argument|mfpr
argument_list|,
literal|0
argument_list|)
name|mfpr
literal|4
operator|(
name|fp
operator|)
operator|,
name|r0
name|ret
name|ENTRY
argument_list|(
argument|bcopy
argument_list|,
argument|R2|R1|R0
argument_list|)
name|movl
literal|4
operator|(
name|fp
operator|)
operator|,
name|r0
name|movl
literal|8
operator|(
name|fp
operator|)
operator|,
name|r1
name|movl
literal|12
operator|(
name|fp
operator|)
operator|,
name|r2
name|movblk
name|ret
comment|/*  * badaddr(addr, len)  *	see if access addr with a len type instruction causes a machine check  *	len is length of access (1=byte, 2=short, 4=long)  *	r0 = 0 means good(exists); r0 =1 means does not exist.  */
name|ENTRY
argument_list|(
argument|badaddr
argument_list|,
argument|R5|R4|R3|R2|R1
argument_list|)
name|mfpr
name|$IPL
operator|,
name|r1
name|mtpr
name|$HIGH
operator|,
name|$IPL
name|mfpr
name|$SCBB
operator|,
name|r5
name|mtpr
name|$0
operator|,
name|$SCBB
name|movl
operator|*
name|$BERVEC
operator|,
name|r2
name|movl
literal|4
operator|(
name|fp
operator|)
operator|,
name|r3
name|movl
literal|8
operator|(
name|fp
operator|)
operator|,
name|r4
name|movab
literal|9f
operator|,
operator|*
name|$BERVEC
name|bbc
name|$0
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_for

begin_expr_stmt
name|tstb
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|bbc
name|$1
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|tstw
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|bbc
name|$2
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|tstl
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|clrl
name|r0
operator|#
name|made
name|it
name|w
operator|/
name|o
name|machine
name|checks
literal|2
operator|:
name|movl
name|r2
operator|,
operator|*
name|$BERVEC
name|mtpr
name|r1
operator|,
name|$IPL
name|mtpr
name|r5
operator|,
name|$SCBB
name|ret
comment|/*  * wbadaddr(addr, len, value)  *	see if write of value to addr with a len type instruction causes  *	a machine check  *	len is length of access (1=byte, 2=short, 4=long)  *	r0 = 0 means good(exists); r0 =1 means does not exist.  */
name|ENTRY
argument_list|(
argument|wbadaddr
argument_list|,
argument|R5|R4|R3|R2|R1
argument_list|)
name|mfpr
name|$IPL
operator|,
name|r1
name|mtpr
name|$HIGH
operator|,
name|$IPL
name|mfpr
name|$SCBB
operator|,
name|r5
name|mtpr
name|$0
operator|,
name|$SCBB
name|movl
operator|*
name|$BERVEC
operator|,
name|r2
name|movl
literal|4
operator|(
name|fp
operator|)
operator|,
name|r3
name|movl
literal|8
operator|(
name|fp
operator|)
operator|,
name|r4
name|movab
literal|9f
operator|,
operator|*
name|$BERVEC
name|bbc
name|$0
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|movb
literal|15
operator|(
name|fp
operator|)
operator|,
operator|(
name|r3
operator|)
literal|1
operator|:
name|bbc
name|$1
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|movw
literal|14
operator|(
name|fp
operator|)
operator|,
operator|(
name|r3
operator|)
literal|1
operator|:
name|bbc
name|$2
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|movl
literal|12
operator|(
name|fp
operator|)
operator|,
operator|(
name|r3
operator|)
literal|1
operator|:
name|clrl
name|r0
operator|#
name|made
name|it
name|w
operator|/
name|o
name|machine
name|checks
literal|2
operator|:
name|movl
name|r2
operator|,
operator|*
name|$BERVEC
name|mtpr
name|r1
operator|,
name|$IPL
name|mtpr
name|r5
operator|,
name|$SCBB
name|ret
operator|.
name|align
literal|2
literal|9
operator|:
operator|#
name|Here
name|we
name|catch
name|buss
name|error
argument_list|(
argument|if it comes
argument_list|)
name|andl3
literal|4
operator|(
name|sp
operator|)
operator|,
name|$ERRCD
operator|,
name|r0
name|cmpl
name|r0
operator|,
name|$APE
name|jneq
literal|1f
name|halt
operator|#
name|Address
name|parity
name|error
operator|!
operator|!
operator|!
literal|1
operator|:
name|cmpl
name|r0
operator|,
name|$VBE
name|jneq
literal|1f
name|halt
operator|#
name|Versabus
name|error
literal|1
operator|:
name|movl
name|$1
operator|,
name|r0
operator|#
name|Anything
end_expr_stmt

begin_else
else|else
operator|=
name|bad
name|address
name|movab
literal|8
operator|(
name|sp
operator|)
operator|,
name|sp
operator|#
name|discard
name|buss
name|error
name|trash
name|movab
literal|2b
operator|,
operator|(
name|sp
operator|)
operator|#
name|new
name|program
name|counter
name|on
name|stack
operator|.
name|rei
name|ENTRY
argument_list|(
argument|movow
argument_list|,
literal|0
argument_list|)
name|movow
literal|10
operator|(
name|fp
operator|)
operator|,
operator|*
literal|4
operator|(
name|fp
operator|)
name|ret
name|ENTRY
argument_list|(
argument|movob
argument_list|,
literal|0
argument_list|)
name|movob
literal|11
operator|(
name|fp
operator|)
operator|,
operator|*
literal|4
operator|(
name|fp
operator|)
name|ret
end_else

end_unit


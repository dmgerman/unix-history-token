begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)relocate.c	1.7 (Berkeley/CCI) 6/24/90"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"vdfmt.h"
end_include

begin_include
include|#
directive|include
file|"cmd.h"
end_include

begin_comment
comment|/* ** */
end_comment

begin_macro
name|relocate
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|boolean
name|is_formatted
parameter_list|()
function_decl|;
name|cur
operator|.
name|state
operator|=
name|rel
expr_stmt|;
name|print
argument_list|(
literal|"Adding flaws to bad sector map on "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"controller %d, drive %d, "
argument_list|,
name|cur
operator|.
name|controller
argument_list|,
name|cur
operator|.
name|drive
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type %s.\n"
argument_list|,
name|lab
operator|->
name|d_typename
argument_list|)
expr_stmt|;
name|indent
argument_list|()
expr_stmt|;
if|if
condition|(
name|is_formatted
argument_list|()
operator|==
name|true
condition|)
block|{
if|if
condition|(
name|read_bad_sector_map
argument_list|()
operator|==
name|true
condition|)
if|if
condition|(
name|bad_map
operator|->
name|bs_id
operator|!=
name|D_INFO
operator|->
name|id
condition|)
block|{
name|print
argument_list|(
literal|"Drive serial numbers do not match!\n"
argument_list|)
expr_stmt|;
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|_longjmp
argument_list|(
name|abort_environ
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|get_new_relocations
argument_list|()
expr_stmt|;
name|cur
operator|.
name|substate
operator|=
name|sub_wmap
expr_stmt|;
name|sync_bad_sector_map
argument_list|()
expr_stmt|;
block|}
else|else
name|print
argument_list|(
literal|"Drive must be formatted befor relocations are done.\n"
argument_list|)
expr_stmt|;
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|rel_help
argument_list|()
end_macro

begin_block
block|{
name|indent
argument_list|()
expr_stmt|;
name|print
argument_list|(
literal|"Relocation commands are in the following form:\n"
argument_list|)
expr_stmt|;
name|indent
argument_list|()
expr_stmt|;
name|print
argument_list|(
literal|"[a-h] (block)   -  UNIX file system block (%s-byte) number.\n"
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"SEctor (sector) -  Absolute sector number on disk.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Track (track)   -  Absolute disk track number.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"(cylinder) (head) (offset) (length) - CDC flaw map format.\n"
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"STARt           -  Starts relocation process.\n\n"
argument_list|)
expr_stmt|;
name|exdent
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|get_new_relocations
argument_list|()
end_macro

begin_block
block|{
name|char
name|line
index|[
literal|256
index|]
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|bs_entry
name|entry
decl_stmt|;
name|dskadr
name|dskaddr
decl_stmt|;
name|fmt_err
name|dskerr
decl_stmt|;
name|int
name|max_track
decl_stmt|;
specifier|register
name|int
name|block
decl_stmt|;
name|dskaddr
operator|.
name|cylinder
operator|=
name|lab
operator|->
name|d_ncylinders
operator|-
literal|1
expr_stmt|;
name|dskaddr
operator|.
name|track
operator|=
name|lab
operator|->
name|d_ntracks
operator|-
literal|1
expr_stmt|;
name|max_track
operator|=
name|to_track
argument_list|(
name|dskaddr
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|print
argument_list|(
literal|"Location? "
argument_list|)
expr_stmt|;
name|get_string_cmd
argument_list|(
name|line
argument_list|,
name|rel_help
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
name|_longjmp
argument_list|(
name|quit_environ
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|line
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
continue|continue;
name|ptr
operator|=
name|line
expr_stmt|;
name|trim_white
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"he"
argument_list|,
literal|2
argument_list|)
operator|||
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"?"
argument_list|,
literal|1
argument_list|)
operator|||
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"stat"
argument_list|,
literal|4
argument_list|)
operator|||
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"!"
argument_list|,
literal|1
argument_list|)
condition|)
continue|continue;
name|indent
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ptr
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
operator|*
name|ptr
operator|<=
literal|'h'
operator|)
condition|)
block|{
specifier|register
name|char
name|par
init|=
operator|*
operator|(
name|ptr
operator|++
operator|)
decl_stmt|;
name|block
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|dskerr
operator|.
name|err_adr
operator|=
operator|*
name|from_unix
argument_list|(
operator|(
name|unsigned
name|char
operator|)
name|par
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|block
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dskerr
operator|.
name|err_adr
operator|.
name|cylinder
operator|==
operator|-
literal|1
operator|)
operator|||
operator|(
name|block
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|print
argument_list|(
literal|"Invalid UNIX block number!\n"
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
name|print
argument_list|(
literal|"Confirm block %d on file-system '%c'"
argument_list|,
name|block
argument_list|,
name|par
argument_list|)
expr_stmt|;
name|dskerr
operator|.
name|err_stat
operator|=
name|DATA_ERROR
expr_stmt|;
name|doreloc
label|:
name|printf
argument_list|(
literal|" (cn %d tn %d sn %d)"
argument_list|,
name|dskerr
operator|.
name|err_adr
operator|.
name|cylinder
argument_list|,
name|dskerr
operator|.
name|err_adr
operator|.
name|track
argument_list|,
name|dskerr
operator|.
name|err_adr
operator|.
name|sector
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_yes_no
argument_list|(
literal|""
argument_list|)
operator|==
name|true
condition|)
block|{
call|(
modifier|*
name|C_INFO
operator|->
name|code_pos
call|)
argument_list|(
operator|&
name|dskerr
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|add_user_relocations
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'t'
condition|)
block|{
name|block
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|block
operator|==
operator|-
literal|1
operator|)
operator|||
operator|(
name|block
operator|>=
name|max_track
operator|)
condition|)
block|{
name|print
argument_list|(
literal|"Invalid track number!\n"
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
name|dskerr
operator|.
name|err_adr
operator|=
operator|*
name|from_track
argument_list|(
name|block
argument_list|)
expr_stmt|;
name|dskerr
operator|.
name|err_stat
operator|=
name|HEADER_ERROR
expr_stmt|;
name|print
argument_list|(
literal|"Confirm track %d"
argument_list|,
name|block
argument_list|)
expr_stmt|;
goto|goto
name|doreloc
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"se"
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|block
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|block
operator|==
operator|-
literal|1
operator|)
operator|||
operator|(
operator|(
name|lab
operator|->
name|d_nsectors
operator|*
name|lab
operator|->
name|d_ntracks
operator|*
name|lab
operator|->
name|d_ncylinders
operator|)
operator|<
name|block
operator|)
condition|)
block|{
name|print
argument_list|(
literal|"Invalid sector number!\n"
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
name|dskerr
operator|.
name|err_adr
operator|=
operator|*
name|from_sector
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|block
argument_list|)
expr_stmt|;
name|dskerr
operator|.
name|err_stat
operator|=
name|DATA_ERROR
expr_stmt|;
goto|goto
name|doreloc
goto|;
block|}
elseif|else
if|if
condition|(
name|is_digit
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|entry
operator|.
name|bs_cyl
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|skipdigits
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|finddigit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|entry
operator|.
name|bs_trk
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|skipdigits
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|finddigit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|entry
operator|.
name|bs_offset
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|skipdigits
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|finddigit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|entry
operator|.
name|bs_length
operator|=
name|get_next_digit
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|entry
operator|.
name|bs_trk
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|entry
operator|.
name|bs_offset
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|entry
operator|.
name|bs_length
operator|!=
operator|-
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|entry
operator|.
name|bs_cyl
operator|>=
name|lab
operator|->
name|d_ncylinders
condition|)
name|print
argument_list|(
literal|"Cylinder number to high!\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|entry
operator|.
name|bs_trk
operator|>=
name|lab
operator|->
name|d_ntracks
condition|)
name|print
argument_list|(
literal|"Head number to high!\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|entry
operator|.
name|bs_offset
operator|>=
name|lab
operator|->
name|d_traksize
condition|)
name|print
argument_list|(
literal|"Offset too long!\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|entry
operator|.
name|bs_length
operator|==
literal|0
condition|)
name|print
argument_list|(
literal|"Can't have a 0 length error!\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|print
argument_list|(
literal|"Confirm  Cyl %d, "
argument_list|,
name|entry
operator|.
name|bs_cyl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Head %d, "
argument_list|,
name|entry
operator|.
name|bs_trk
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"offset %d, "
argument_list|,
name|entry
operator|.
name|bs_offset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"length %d"
argument_list|,
name|entry
operator|.
name|bs_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_yes_no
argument_list|(
literal|""
argument_list|)
operator|==
name|true
condition|)
name|add_user_relocations
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
else|else
goto|goto
name|bad
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"start"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
name|bad
label|:
name|print
argument_list|(
literal|"What?\n"
argument_list|)
expr_stmt|;
name|next
label|:
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|dskadr
name|check_track_for_relocations
parameter_list|(
name|entry
parameter_list|,
name|i
parameter_list|)
name|bs_entry
name|entry
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
block|{
specifier|register
name|int
name|j
init|=
name|i
decl_stmt|;
name|fmt_err
name|temp
decl_stmt|,
name|cmp
decl_stmt|;
name|boolean
name|bad_track
init|=
name|false
decl_stmt|;
call|(
modifier|*
name|C_INFO
operator|->
name|decode_pos
call|)
argument_list|(
operator|&
name|entry
argument_list|,
operator|&
name|cmp
argument_list|)
expr_stmt|;
comment|/* Check to see if a alternate track is or will be on this track */
while|while
condition|(
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_cyl
operator|==
name|entry
operator|.
name|bs_cyl
operator|)
operator|&&
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_trk
operator|==
name|entry
operator|.
name|bs_trk
operator|)
condition|)
block|{
call|(
modifier|*
name|C_INFO
operator|->
name|decode_pos
call|)
argument_list|(
operator|&
name|bad_map
operator|->
name|list
index|[
name|j
index|]
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|.
name|err_stat
operator|&
name|HEADER_ERROR
condition|)
block|{
name|bad_track
operator|=
name|true
expr_stmt|;
comment|/* if track was mapped out (it can't be us) */
if|if
condition|(
operator|(
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_alt
operator|.
name|cylinder
operator|!=
literal|0
operator|)
operator|)
operator|||
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_alt
operator|.
name|track
operator|!=
literal|0
operator|)
operator|||
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_alt
operator|.
name|sector
operator|!=
literal|0
operator|)
condition|)
block|{
return|return
name|cmp
operator|.
name|err_adr
return|;
block|}
block|}
name|j
operator|++
expr_stmt|;
block|}
comment|/* 	**    If it was a bad track and it was not the current entry 	** that produced it then then map it 	** to itself and forget about it for now since it will be taken 	** care of later. 	** 	**    If it was the current entry return zero and the track will be 	** mapped out correctly. 	*/
if|if
condition|(
name|bad_track
operator|==
name|true
condition|)
block|{
if|if
condition|(
name|cmp
operator|.
name|err_stat
operator|&
name|HEADER_ERROR
condition|)
return|return
name|entry
operator|.
name|bs_alt
return|;
comment|/* better known as zero */
else|else
return|return
name|cmp
operator|.
name|err_adr
return|;
block|}
comment|/* 	**   if we made it through all the bad track stuff then check for 	** multiple errors on the same sector that are already mapped! 	*/
name|j
operator|=
name|i
expr_stmt|;
while|while
condition|(
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_cyl
operator|==
name|entry
operator|.
name|bs_cyl
operator|)
operator|&&
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_trk
operator|==
name|entry
operator|.
name|bs_trk
operator|)
condition|)
block|{
call|(
modifier|*
name|C_INFO
operator|->
name|decode_pos
call|)
argument_list|(
operator|&
name|bad_map
operator|->
name|list
index|[
name|j
index|]
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|.
name|err_adr
operator|.
name|sector
operator|==
name|cmp
operator|.
name|err_adr
operator|.
name|sector
condition|)
block|{
comment|/* if it is not really the current entry */
if|if
condition|(
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_offset
operator|!=
name|entry
operator|.
name|bs_offset
operator|)
operator|||
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_length
operator|!=
name|entry
operator|.
name|bs_length
operator|)
condition|)
block|{
comment|/* if the sector is already mapped out */
if|if
condition|(
operator|(
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_alt
operator|.
name|cylinder
operator|!=
literal|0
operator|)
operator|)
operator|||
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_alt
operator|.
name|track
operator|!=
literal|0
operator|)
operator|||
operator|(
name|bad_map
operator|->
name|list
index|[
name|j
index|]
operator|.
name|bs_alt
operator|.
name|sector
operator|!=
literal|0
operator|)
condition|)
block|{
return|return
name|temp
operator|.
name|err_adr
return|;
block|}
block|}
block|}
name|j
operator|++
expr_stmt|;
block|}
return|return
name|entry
operator|.
name|bs_alt
return|;
block|}
end_function

begin_comment
comment|/* ** */
end_comment

begin_function
name|dskadr
name|is_relocated
parameter_list|(
name|entry
parameter_list|)
name|bs_entry
name|entry
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bad_map
operator|->
name|bs_count
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_cyl
operator|==
name|entry
operator|.
name|bs_cyl
operator|)
operator|&&
operator|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_trk
operator|==
name|entry
operator|.
name|bs_trk
operator|)
condition|)
return|return
name|check_track_for_relocations
argument_list|(
name|entry
argument_list|,
name|i
argument_list|)
return|;
return|return
name|entry
operator|.
name|bs_alt
return|;
block|}
end_function

begin_comment
comment|/* ** */
end_comment

begin_macro
name|sync_bad_sector_map
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|dskadr
name|dskaddr
decl_stmt|;
comment|/* 	** do all the relocation cylinders first to allocate all flaws in 	** relocation area. 	*/
for|for
control|(
name|i
operator|=
name|bad_map
operator|->
name|bs_count
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_cyl
operator|>=
name|lab
operator|->
name|d_ncylinders
operator|-
name|NUMSYS
operator|)
operator|&&
operator|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_cyl
operator|<
name|lab
operator|->
name|d_ncylinders
operator|-
name|NUMMAP
operator|-
name|NUMMNT
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_alt
operator|.
name|cylinder
operator|==
literal|0
operator|)
operator|&&
operator|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_alt
operator|.
name|track
operator|==
literal|0
operator|)
operator|&&
operator|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_alt
operator|.
name|sector
operator|==
literal|0
operator|)
condition|)
block|{
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_alt
operator|=
operator|*
name|new_location
argument_list|(
operator|&
name|bad_map
operator|->
name|list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
for|for
control|(
name|i
operator|=
name|bad_map
operator|->
name|bs_count
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_alt
operator|.
name|cylinder
operator|==
literal|0
operator|)
operator|&&
operator|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_alt
operator|.
name|track
operator|==
literal|0
operator|)
operator|&&
operator|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_alt
operator|.
name|sector
operator|==
literal|0
operator|)
condition|)
block|{
name|dskaddr
operator|=
name|is_relocated
argument_list|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dskaddr
operator|.
name|cylinder
operator|==
literal|0
operator|)
operator|&&
operator|(
name|dskaddr
operator|.
name|track
operator|==
literal|0
operator|)
operator|&&
operator|(
name|dskaddr
operator|.
name|sector
operator|==
literal|0
operator|)
condition|)
block|{
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_alt
operator|=
operator|*
name|new_location
argument_list|(
operator|&
name|bad_map
operator|->
name|list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|do_relocation
argument_list|(
name|bad_map
operator|->
name|list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
name|bad_map
operator|->
name|list
index|[
name|i
index|]
operator|.
name|bs_alt
operator|=
name|dskaddr
expr_stmt|;
block|}
block|}
name|write_bad_sector_map
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|do_relocation
argument_list|(
argument|entry
argument_list|)
end_macro

begin_decl_stmt
name|bs_entry
name|entry
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fmt_err
name|temp
decl_stmt|;
if|if
condition|(
name|entry
operator|.
name|bs_cyl
operator|>=
name|lab
operator|->
name|d_ncylinders
operator|-
name|NUMSYS
condition|)
if|if
condition|(
name|entry
operator|.
name|bs_cyl
operator|!=
operator|(
name|lab
operator|->
name|d_ncylinders
operator|-
name|NUMMAP
operator|-
name|NUMMNT
operator|)
condition|)
return|return;
call|(
modifier|*
name|C_INFO
operator|->
name|decode_pos
call|)
argument_list|(
operator|&
name|entry
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|entry
operator|.
name|bs_alt
operator|.
name|cylinder
operator|==
literal|0
operator|)
operator|&&
operator|(
name|entry
operator|.
name|bs_alt
operator|.
name|track
operator|==
literal|0
operator|)
operator|&&
operator|(
name|entry
operator|.
name|bs_alt
operator|.
name|sector
operator|==
literal|0
operator|)
condition|)
name|print_unix_block
argument_list|(
name|temp
operator|.
name|err_adr
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|temp
operator|.
name|err_stat
operator|&
name|HEADER_ERROR
condition|)
if|if
condition|(
name|C_INFO
operator|->
name|type
operator|==
name|VDTYPE_VDDC
condition|)
block|{
name|print
argument_list|(
literal|"Can't relocate tracks on VDDC controllers.\n"
argument_list|)
expr_stmt|;
name|print_unix_block
argument_list|(
name|temp
operator|.
name|err_adr
argument_list|)
expr_stmt|;
block|}
else|else
name|relocate_track
argument_list|(
name|entry
argument_list|)
expr_stmt|;
else|else
name|relocate_sector
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|relocate_sector
argument_list|(
argument|entry
argument_list|)
end_macro

begin_decl_stmt
name|bs_entry
name|entry
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dskadr
name|phys
decl_stmt|,
name|reloc
decl_stmt|;
name|fmt_err
name|temp
decl_stmt|;
specifier|register
name|long
name|status
decl_stmt|;
call|(
modifier|*
name|C_INFO
operator|->
name|decode_pos
call|)
argument_list|(
operator|&
name|entry
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
name|phys
operator|=
name|temp
operator|.
name|err_adr
expr_stmt|;
name|reloc
operator|=
name|entry
operator|.
name|bs_alt
expr_stmt|;
name|format_sectors
argument_list|(
operator|&
name|phys
argument_list|,
operator|&
name|reloc
argument_list|,
name|RELOC_SECTOR
argument_list|,
operator|(
name|long
operator|)
literal|1
argument_list|)
expr_stmt|;
name|format_sectors
argument_list|(
operator|&
name|reloc
argument_list|,
operator|&
name|phys
argument_list|,
name|ALT_SECTOR
argument_list|,
operator|(
name|long
operator|)
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|access_dsk
argument_list|(
operator|(
name|char
operator|*
operator|)
name|save
argument_list|,
operator|&
name|temp
operator|.
name|err_adr
argument_list|,
name|VDOP_WD
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|(
name|status
operator|&
name|DCBS_ATA
operator|)
operator|&&
operator|!
operator|(
name|status
operator|&
operator|(
name|DCBS_HARD
operator||
name|DCBS_SOFT
operator|)
operator|)
operator|)
condition|)
block|{
name|print
argument_list|(
literal|"Sector relocation failed (c %d t %d s %d).  Status = 0x%x.\n"
argument_list|,
name|phys
operator|.
name|cylinder
argument_list|,
name|phys
operator|.
name|track
argument_list|,
name|phys
operator|.
name|sector
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|print_unix_block
argument_list|(
name|phys
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|relocate_track
argument_list|(
argument|entry
argument_list|)
end_macro

begin_decl_stmt
name|bs_entry
name|entry
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dskadr
name|phys
decl_stmt|,
name|reloc
decl_stmt|;
name|fmt_err
name|temp
decl_stmt|;
specifier|register
name|long
name|status
decl_stmt|;
call|(
modifier|*
name|C_INFO
operator|->
name|decode_pos
call|)
argument_list|(
operator|&
name|entry
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
name|temp
operator|.
name|err_adr
operator|.
name|sector
operator|=
literal|0
expr_stmt|;
name|phys
operator|=
name|temp
operator|.
name|err_adr
expr_stmt|;
name|reloc
operator|=
name|entry
operator|.
name|bs_alt
expr_stmt|;
name|reloc
operator|.
name|sector
operator|=
literal|0xff
expr_stmt|;
name|format_sectors
argument_list|(
operator|&
name|phys
argument_list|,
operator|&
name|reloc
argument_list|,
name|RELOC_SECTOR
argument_list|,
operator|(
name|long
operator|)
name|lab
operator|->
name|d_nsectors
argument_list|)
expr_stmt|;
name|reloc
operator|.
name|sector
operator|=
literal|0x00
expr_stmt|;
name|format_sectors
argument_list|(
operator|&
name|reloc
argument_list|,
operator|&
name|phys
argument_list|,
name|ALT_SECTOR
argument_list|,
operator|(
name|long
operator|)
name|lab
operator|->
name|d_nsectors
argument_list|)
expr_stmt|;
name|status
operator|=
name|access_dsk
argument_list|(
operator|(
name|char
operator|*
operator|)
name|save
argument_list|,
operator|&
name|temp
operator|.
name|err_adr
argument_list|,
name|VDOP_WD
argument_list|,
name|lab
operator|->
name|d_nsectors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|(
name|status
operator|&
name|DCBS_ATA
operator|)
operator|&&
operator|!
operator|(
name|status
operator|&
operator|(
name|DCBS_HARD
operator||
name|DCBS_SOFT
operator|)
operator|)
operator|)
condition|)
block|{
name|print
argument_list|(
literal|"Track relocation failed.  Status = 0x%x.\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|print_unix_block
argument_list|(
name|phys
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit


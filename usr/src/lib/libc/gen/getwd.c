begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	@(#)getwd.c	4.8	(Berkeley)	3/2/83	*/
end_comment

begin_comment
comment|/*  * getwd() returns the pathname of the current working directory. On error  * an error message is copied to pathname and null pointer is returned.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_define
define|#
directive|define
name|CURDIR
value|"."
end_define

begin_define
define|#
directive|define
name|GETWDERR
parameter_list|(
name|s
parameter_list|)
value|strcpy(pathname, (s));
end_define

begin_define
define|#
directive|define
name|PARENTDIR
value|".."
end_define

begin_define
define|#
directive|define
name|PATHSEP
value|"/"
end_define

begin_define
define|#
directive|define
name|ROOTDIR
value|"/"
end_define

begin_function_decl
name|char
modifier|*
name|strcpy
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|pathsize
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* pathname length */
end_comment

begin_function
name|char
modifier|*
name|getwd
parameter_list|(
name|pathname
parameter_list|)
name|char
modifier|*
name|pathname
decl_stmt|;
block|{
name|char
name|pathbuf
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
comment|/* temporary pathname buffer */
name|char
modifier|*
name|pnptr
init|=
operator|&
name|pathbuf
index|[
operator|(
sizeof|sizeof
name|pathbuf
operator|)
operator|-
literal|1
index|]
decl_stmt|;
comment|/* pathname pointer */
name|char
modifier|*
name|prepend
parameter_list|()
function_decl|;
comment|/* prepend dirname to pathname */
name|dev_t
name|rdev
decl_stmt|;
comment|/* root device number */
name|DIR
modifier|*
name|dirp
decl_stmt|;
comment|/* directory stream */
name|ino_t
name|rino
decl_stmt|;
comment|/* root inode number */
name|struct
name|direct
modifier|*
name|dir
decl_stmt|;
comment|/* directory entry struct */
name|struct
name|stat
name|d
decl_stmt|,
name|dd
decl_stmt|;
comment|/* file status struct */
name|pathsize
operator|=
literal|0
expr_stmt|;
operator|*
name|pnptr
operator|=
literal|'\0'
expr_stmt|;
name|stat
argument_list|(
name|ROOTDIR
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
name|rdev
operator|=
name|d
operator|.
name|st_dev
expr_stmt|;
name|rino
operator|=
name|d
operator|.
name|st_ino
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|stat
argument_list|(
name|CURDIR
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|.
name|st_ino
operator|==
name|rino
operator|&&
name|d
operator|.
name|st_dev
operator|==
name|rdev
condition|)
break|break;
comment|/* reached root directory */
if|if
condition|(
operator|(
name|dirp
operator|=
name|opendir
argument_list|(
name|PARENTDIR
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|GETWDERR
argument_list|(
literal|"getwd: can't open .."
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|chdir
argument_list|(
name|PARENTDIR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|GETWDERR
argument_list|(
literal|"getwd: can't chdir to .."
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|fstat
argument_list|(
name|dirp
operator|->
name|dd_fd
argument_list|,
operator|&
name|dd
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|.
name|st_dev
operator|==
name|dd
operator|.
name|st_dev
condition|)
block|{
if|if
condition|(
name|d
operator|.
name|st_ino
operator|==
name|dd
operator|.
name|st_ino
condition|)
block|{
comment|/* reached root directory */
name|closedir
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
break|break;
block|}
do|do
block|{
if|if
condition|(
operator|(
name|dir
operator|=
name|readdir
argument_list|(
name|dirp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|closedir
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|GETWDERR
argument_list|(
literal|"getwd: read error in .."
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
do|while
condition|(
name|dir
operator|->
name|d_ino
operator|!=
name|d
operator|.
name|st_ino
condition|)
do|;
block|}
else|else
do|do
block|{
if|if
condition|(
operator|(
name|dir
operator|=
name|readdir
argument_list|(
name|dirp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|closedir
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|GETWDERR
argument_list|(
literal|"getwd: read error in .."
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|stat
argument_list|(
name|dir
operator|->
name|d_name
argument_list|,
operator|&
name|dd
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|dd
operator|.
name|st_ino
operator|!=
name|d
operator|.
name|st_ino
operator|||
name|dd
operator|.
name|st_dev
operator|!=
name|d
operator|.
name|st_dev
condition|)
do|;
name|closedir
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|pnptr
operator|=
name|prepend
argument_list|(
name|PATHSEP
argument_list|,
name|prepend
argument_list|(
name|dir
operator|->
name|d_name
argument_list|,
name|pnptr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|pnptr
operator|==
literal|'\0'
condition|)
comment|/* current dir == root dir */
name|strcpy
argument_list|(
name|pathname
argument_list|,
name|ROOTDIR
argument_list|)
expr_stmt|;
else|else
block|{
name|strcpy
argument_list|(
name|pathname
argument_list|,
name|pnptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|pnptr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|GETWDERR
argument_list|(
literal|"getwd: can't change back to ."
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
return|return
operator|(
name|pathname
operator|)
return|;
name|fail
label|:
name|chdir
argument_list|(
name|prepend
argument_list|(
name|CURDIR
argument_list|,
name|pnptr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * prepend() tacks a directory name onto the front of a pathname.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|prepend
parameter_list|(
name|dirname
parameter_list|,
name|pathname
parameter_list|)
specifier|register
name|char
modifier|*
name|dirname
decl_stmt|;
specifier|register
name|char
modifier|*
name|pathname
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
comment|/* directory name size counter */
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|*
name|dirname
operator|!=
literal|'\0'
condition|;
name|i
operator|++
operator|,
name|dirname
operator|++
control|)
continue|continue;
if|if
condition|(
operator|(
name|pathsize
operator|+=
name|i
operator|)
operator|<
name|MAXPATHLEN
condition|)
while|while
condition|(
name|i
operator|--
operator|>
literal|0
condition|)
operator|*
operator|--
name|pathname
operator|=
operator|*
operator|--
name|dirname
expr_stmt|;
return|return
operator|(
name|pathname
operator|)
return|;
block|}
end_function

end_unit


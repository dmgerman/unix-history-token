begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1985 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|LIBC_SCCS
end_ifdef

begin_label
name|_sccsid
label|:
end_label

begin_expr_stmt
operator|.
name|asciz
literal|"@(#)puts.c	5.4 (Berkeley) 4/1/86"
endif|#
directive|endif
endif|LIBC_SCCS
comment|/*  * puts(s);  * char *s;  *  * argument: a source string.  * side effects: writes to the standard output using the data in  *	the null-terminated source string; a newline is appended.  * result: technically void; for compatibility we return 0 for the null  *	string, non-zero otherwise.  We return zero for errors too.  */
include|#
directive|include
file|"DEFS.h"
define|#
directive|define
name|NBF
value|04
define|#
directive|define
name|LBF
value|0200
define|#
directive|define
name|NL
value|012
name|ENTRY
argument_list|(
argument|puts
argument_list|,
argument|R11|R10|R9
argument_list|)
define|#
directive|define
name|S
value|r11
name|movl
literal|4
operator|(
name|ap
operator|)
operator|,
name|S
define|#
directive|define
name|IOP
value|r10
define|#
directive|define
name|_CNT
define|#
directive|define
name|_PTR
value|4
define|#
directive|define
name|_BASE
value|8
define|#
directive|define
name|_BUFSIZ
value|12
define|#
directive|define
name|_FLAG
value|16
name|movab
name|__iob
operator|+
literal|20
operator|,
name|IOP
define|#
directive|define
name|UNBUF
value|-4(fp)
define|#
directive|define
name|COUNT
value|r9
comment|/* 	 * For unbuffered I/O, line buffer the output line. 	 * Ugly but fast -- and doesn't CURRENTLY break anything (sigh). 	 */
name|movab
operator|-
literal|1028
operator|(
name|sp
operator|)
operator|,
name|sp
name|bicw3
name|$
operator|~
name|NBF
operator|,
name|_FLAG
argument_list|(
name|IOP
argument_list|)
operator|,
name|UNBUF
name|jeql
literal|1f
name|bicw2
name|$NBF
operator|,
name|_FLAG
argument_list|(
argument|IOP
argument_list|)
comment|/* Clear no-buffering flag */
name|movl
name|sp
operator|,
name|_BASE
argument_list|(
argument|IOP
argument_list|)
comment|/* Create a buffer */
name|movl
name|sp
operator|,
name|_PTR
argument_list|(
argument|IOP
argument_list|)
name|cvtwl
name|$1024
operator|,
name|_BUFSIZ
argument_list|(
argument|IOP
argument_list|)
name|jbr
literal|2f
literal|1
operator|:
name|tstl
name|_CNT
argument_list|(
argument|IOP
argument_list|)
comment|/* Has a buffer been allocated? */
name|jgtr
literal|2f
name|pushl
name|IOP
comment|/* Get _flsbuf() to make one */
name|pushl
name|$0
name|calls
name|$2
operator|,
name|__flsbuf
name|tstl
name|r0
name|jlss
name|Lerror
name|incl
name|_CNT
argument_list|(
argument|IOP
argument_list|)
comment|/* Unput the char we sent */
name|decl
name|_PTR
argument_list|(
name|IOP
argument_list|)
literal|2
operator|:
comment|/* 	 * Search for the terminating null. 	 */
name|Lloop
operator|:
name|addl3
name|_BASE
argument_list|(
name|IOP
argument_list|)
operator|,
name|_BUFSIZ
argument_list|(
name|IOP
argument_list|)
operator|,
name|COUNT
comment|/* How many bytes? */
name|subl2
name|_PTR
argument_list|(
name|IOP
argument_list|)
operator|,
name|COUNT
name|locc
name|$0
operator|,
name|COUNT
operator|,
operator|(
name|S
operator|)
comment|/* Look for a null */
name|jeql
name|Lagain
name|subl2
name|r0
operator|,
name|COUNT
comment|/* Copy the data */
name|movc3
name|COUNT
operator|,
operator|(
name|S
operator|)
operator|,
operator|*
name|_PTR
argument_list|(
argument|IOP
argument_list|)
name|movl
name|r3
operator|,
name|_PTR
argument_list|(
argument|IOP
argument_list|)
comment|/* Fix up IOP */
name|subl2
name|COUNT
operator|,
name|_CNT
argument_list|(
argument|IOP
argument_list|)
name|Lnl
operator|:
name|movb
name|$NL
operator|,
operator|*
name|_PTR
argument_list|(
argument|IOP
argument_list|)
comment|/* Append a newline */
name|incl
name|_PTR
argument_list|(
argument|IOP
argument_list|)
name|decl
name|_CNT
argument_list|(
argument|IOP
argument_list|)
name|bitw
name|$LBF
operator|,
name|_FLAG
argument_list|(
argument|IOP
argument_list|)
comment|/* If line buffered... */
name|jneq
literal|1f
name|tstw
name|UNBUF
comment|/* or unbuffered... */
name|jneq
literal|1f
name|tstl
name|_CNT
argument_list|(
argument|IOP
argument_list|)
comment|/* or a full buffer... */
name|jgtr
literal|2f
literal|1
operator|:
name|pushl
name|IOP
comment|/* ... flush the buffer */
name|calls
name|$1
operator|,
name|_fflush
name|tstl
name|r0
name|jlss
name|Lerror
literal|2
operator|:
comment|/* 	 * Fix up buffering again. 	 */
name|tstw
name|UNBUF
name|jeql
literal|1f
name|bisw2
name|$NBF
operator|,
name|_FLAG
argument_list|(
argument|IOP
argument_list|)
comment|/* Reset flag */
name|clrl
name|_BASE
argument_list|(
argument|IOP
argument_list|)
comment|/* Clear data structure */
name|clrl
name|_BUFSIZ
argument_list|(
argument|IOP
argument_list|)
name|clrl
name|_CNT
argument_list|(
name|IOP
argument_list|)
literal|1
operator|:
name|cvtbl
name|$NL
operator|,
name|r0
comment|/* Compatibility hack */
name|ret
comment|/* 	 * We didn't find the null -- loop. 	 */
name|Lagain
operator|:
name|movc3
name|COUNT
operator|,
operator|(
name|S
operator|)
operator|,
operator|*
name|_PTR
argument_list|(
argument|IOP
argument_list|)
comment|/* Copy the data */
name|movl
name|r1
operator|,
name|S
name|movl
name|r3
operator|,
name|_PTR
argument_list|(
argument|IOP
argument_list|)
comment|/* Fix up IOP */
name|subl2
name|COUNT
operator|,
name|_CNT
argument_list|(
argument|IOP
argument_list|)
name|pushl
name|IOP
comment|/* The buffer is full -- flush it */
name|calls
name|$1
operator|,
name|_fflush
name|tstl
name|r0
name|jlss
name|Lerror
name|tstb
argument_list|(
argument|S
argument_list|)
comment|/* More data? */
name|jneq
name|Lloop
name|jbr
name|Lnl
comment|/* 	 * Bomb out.  Return 0 (why not? that's what the old one did). 	 */
name|Lerror
operator|:
name|clrl
name|r0
name|ret
end_expr_stmt

end_unit


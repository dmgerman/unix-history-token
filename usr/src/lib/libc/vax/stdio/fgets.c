begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1985 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|LIBC_SCCS
end_ifdef

begin_label
name|_sccsid
label|:
end_label

begin_expr_stmt
operator|.
name|asciz
literal|"@(#)fgets.c	5.3 (Berkeley) 3/9/86"
endif|#
directive|endif
endif|LIBC_SCCS
comment|/*  * char *fgets(s, n, iptr);  * char *s;  * int n;  * FILE *iptr;  *  * arguments: a target string, a length, and a file pointer.  * side effects: reads up to and including a newline, or up to n-1 bytes,  *	whichever is less, from the file indicated by iptr into the target  *	string and null terminates.  * result: the target string if successful, 0 otherwise.  */
include|#
directive|include
file|"DEFS.h"
define|#
directive|define
name|NL
value|0xa
name|ENTRY
argument_list|(
argument|fgets
argument_list|,
argument|R11|R10|R9
argument_list|)
define|#
directive|define
name|OLD_S
value|4(ap)
define|#
directive|define
name|S
value|r11
name|movl
name|OLD_S
operator|,
name|S
define|#
directive|define
name|N
value|8(ap)
define|#
directive|define
name|IPTR
value|r10
define|#
directive|define
name|_CNT
define|#
directive|define
name|_PTR
value|4
define|#
directive|define
name|_BASE
value|8
name|movl
literal|12
operator|(
name|ap
operator|)
operator|,
name|IPTR
define|#
directive|define
name|COUNT
value|r9
comment|/* 	 * Sanity check -- is the buffer big enough? 	 */
name|cmpl
name|N
operator|,
name|$1
name|jleq
name|Lerror
name|subl3
name|$1
operator|,
name|N
operator|,
name|COUNT
comment|/* We scan at most COUNT chars */
comment|/* 	 * If no characters, call _filbuf() to get some. 	 */
name|tstl
name|_CNT
argument_list|(
argument|IPTR
argument_list|)
name|jgtr
name|Lscan
name|Lloop
operator|:
name|pushl
name|IPTR
name|calls
name|$1
operator|,
name|__filbuf
name|tstl
name|r0
name|jlss
name|Leof
name|movb
name|r0
operator|,
operator|(
name|S
operator|)
operator|+
comment|/* Save the returned character */
name|decl
name|N
name|decl
name|COUNT
name|jleq
literal|1f
name|cmpb
name|r0
operator|,
name|$NL
comment|/* If it was a newline, we're done */
name|jneq
literal|2f
literal|1
operator|:
name|clrb
argument_list|(
argument|S
argument_list|)
name|jbr
name|Lret
literal|2
operator|:
name|tstl
name|_BASE
argument_list|(
argument|IPTR
argument_list|)
comment|/* Is the input buffered? */
name|jeql
name|Lloop
comment|/* If not, loop inefficiently */
comment|/* 	 * Look for a newline in the buffer. 	 */
name|Lscan
operator|:
name|cmpl
name|_CNT
argument_list|(
name|IPTR
argument_list|)
operator|,
name|COUNT
comment|/* Is buffer bigger than N-1? */
name|jgeq
literal|1f
name|movl
name|_CNT
argument_list|(
name|IPTR
argument_list|)
operator|,
name|COUNT
comment|/* If not, don't read off the end */
literal|1
operator|:
name|locc
name|$NL
operator|,
name|COUNT
operator|,
operator|*
name|_PTR
argument_list|(
argument|IPTR
argument_list|)
comment|/* Scan the buffer */
name|jeql
name|Lagain
comment|/* 	 * Success -- copy the data and return. 	 */
name|decl
name|r0
comment|/* How many characters did we read? */
name|subl2
name|r0
operator|,
name|COUNT
name|movc3
name|COUNT
operator|,
operator|*
name|_PTR
argument_list|(
name|IPTR
argument_list|)
operator|,
operator|(
name|S
operator|)
comment|/* Copy the data */
name|clrb
argument_list|(
argument|r3
argument_list|)
name|subl2
name|COUNT
operator|,
name|_CNT
argument_list|(
argument|IPTR
argument_list|)
comment|/* Fix up the I/O buffer */
name|movl
name|r1
operator|,
name|_PTR
argument_list|(
argument|IPTR
argument_list|)
name|Lret
operator|:
name|movl
name|OLD_S
operator|,
name|r0
name|ret
comment|/* 	 * If we run out of characters, copy the buffer and loop if needed. 	 */
name|Lagain
operator|:
name|movc3
name|COUNT
operator|,
operator|*
name|_PTR
argument_list|(
name|IPTR
argument_list|)
operator|,
operator|(
name|S
operator|)
comment|/* Copy the data */
name|subl2
name|COUNT
operator|,
name|_CNT
argument_list|(
argument|IPTR
argument_list|)
comment|/* Adjust the buffers and counts */
name|movl
name|r1
operator|,
name|_PTR
argument_list|(
argument|IPTR
argument_list|)
name|subl2
name|COUNT
operator|,
name|N
name|movl
name|r3
operator|,
name|S
name|subl3
name|$1
operator|,
name|N
operator|,
name|COUNT
name|jgtr
name|Lloop
comment|/* 	 * End of file?  Check to see if we copied any data. 	 */
name|Leof
operator|:
name|cmpl
name|S
operator|,
name|OLD_S
name|jeql
name|Lerror
name|clrb
argument_list|(
argument|S
argument_list|)
name|jbr
name|Lret
comment|/* 	 * Error return -- null pointer. 	 */
name|Lerror
operator|:
name|clrl
name|r0
name|ret
end_expr_stmt

end_unit


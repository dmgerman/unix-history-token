begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1985 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|LIBC_SCCS
end_ifdef

begin_label
name|_sccsid
label|:
end_label

begin_expr_stmt
operator|.
name|asciz
literal|"@(#)gets.c	5.2 (Berkeley) 3/9/86"
endif|#
directive|endif
endif|LIBC_SCCS
comment|/*  * char *gets(s);  * char *s;  *  * argument: a target string  * side effects: reads bytes up to and including a newline from the  *	standard input into the target string and replaces the newline  *	with a null to null-terminate the string.  * result: the target string if successful, 0 otherwise.  */
include|#
directive|include
file|"DEFS.h"
define|#
directive|define
name|NL
value|0xa
name|ENTRY
argument_list|(
argument|gets
argument_list|,
argument|R11|R10
argument_list|)
define|#
directive|define
name|S
value|r11
name|movl
literal|4
operator|(
name|ap
operator|)
operator|,
name|S
define|#
directive|define
name|IPTR
value|r10
define|#
directive|define
name|_CNT
define|#
directive|define
name|_PTR
value|4
define|#
directive|define
name|_BASE
value|8
define|#
directive|define
name|_BUFSIZ
value|12
define|#
directive|define
name|_FLAG
value|16
name|movab
name|__iob
operator|,
name|IPTR
define|#
directive|define
name|OLD_S
value|4(ap)
comment|/* 	 * If no characters, call _filbuf() to get some. 	 */
name|tstl
name|_CNT
argument_list|(
argument|IPTR
argument_list|)
name|jgtr
name|Lscan
name|Lloop
operator|:
name|pushl
name|IPTR
name|calls
name|$1
operator|,
name|__filbuf
name|tstl
name|r0
comment|/* What did _filbuf() return? */
name|jlss
name|Leof
name|cmpb
name|r0
operator|,
name|$NL
name|jneq
literal|1f
name|clrb
argument_list|(
argument|S
argument_list|)
name|jbr
name|Lret
literal|1
operator|:
name|movb
name|r0
operator|,
operator|(
name|S
operator|)
operator|+
comment|/* Save the returned character */
name|tstl
name|_BASE
argument_list|(
argument|IPTR
argument_list|)
comment|/* Is input buffered? */
name|jeql
name|Lloop
comment|/* 	 * Look for a newline in the buffer. 	 */
name|Lscan
operator|:
name|locc
name|$NL
operator|,
name|_CNT
argument_list|(
name|IPTR
argument_list|)
operator|,
operator|*
name|_PTR
argument_list|(
argument|IPTR
argument_list|)
name|jeql
name|Lagain
comment|/* 	 * Success -- copy the data and return. 	 */
name|subl3
name|r0
operator|,
name|_CNT
argument_list|(
name|IPTR
argument_list|)
operator|,
name|r2
name|subl2
name|r2
operator|,
name|_CNT
argument_list|(
argument|IPTR
argument_list|)
name|movc3
name|r2
operator|,
operator|*
name|_PTR
argument_list|(
name|IPTR
argument_list|)
operator|,
operator|(
name|S
operator|)
comment|/* Copy the data */
name|clrb
argument_list|(
argument|r3
argument_list|)
name|movl
name|r1
operator|,
name|_PTR
argument_list|(
argument|IPTR
argument_list|)
name|decl
name|_CNT
argument_list|(
argument|IPTR
argument_list|)
comment|/* Skip the newline */
name|incl
name|_PTR
argument_list|(
argument|IPTR
argument_list|)
comment|/* 	 * Normal return. 	 */
name|Lret
operator|:
name|movl
name|OLD_S
operator|,
name|r0
name|ret
comment|/* 	 * If we run out of characters, copy the buffer and loop. 	 */
name|Lagain
operator|:
name|movc3
name|_CNT
argument_list|(
name|IPTR
argument_list|)
operator|,
operator|*
name|_PTR
argument_list|(
name|IPTR
argument_list|)
operator|,
operator|(
name|S
operator|)
comment|/* Copy the data */
name|movl
name|r3
operator|,
name|S
name|movl
name|_BASE
argument_list|(
name|IPTR
argument_list|)
operator|,
name|_PTR
argument_list|(
argument|IPTR
argument_list|)
comment|/* Reset stdio */
name|clrl
name|_CNT
argument_list|(
argument|IPTR
argument_list|)
name|jbr
name|Lloop
comment|/* 	 * End of file?  Check to see if we copied any data. 	 */
name|Leof
operator|:
name|cmpl
name|S
operator|,
name|OLD_S
name|jeql
name|Lerror
name|clrb
argument_list|(
argument|S
argument_list|)
name|jbr
name|Lret
comment|/* 	 * Error/eof return -- null pointer. 	 */
name|Lerror
operator|:
name|clrl
name|r0
name|ret
end_expr_stmt

end_unit


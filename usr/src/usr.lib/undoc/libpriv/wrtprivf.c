begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	@(#)wrtprivf.c	4.9	(Melbourne)	82/07/17	*/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/vlimit.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/quota.h>
end_include

begin_include
include|#
directive|include
file|<udata.h>
end_include

begin_include
include|#
directive|include
file|<lpdquota.h>
end_include

begin_include
include|#
directive|include
file|<mushmuck.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_decl_stmt
specifier|static
name|struct
name|udata
name|udata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|mushmuck
name|mm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|lpquota
name|lpdq
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|dquot
name|dqb
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|dqfn
index|[
literal|16
index|]
index|[
literal|32
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|psval
argument_list|()
decl_stmt|,
name|plval
argument_list|()
decl_stmt|,
name|psecs
argument_list|()
decl_stmt|,
name|pmins
argument_list|()
decl_stmt|,
name|pdate
argument_list|()
decl_stmt|,
name|pbits
argument_list|()
decl_stmt|,
name|pflags
argument_list|()
decl_stmt|,
name|pgrps
argument_list|()
decl_stmt|,
name|psflags
argument_list|()
decl_stmt|,
name|pchar
argument_list|()
decl_stmt|,
name|pdquot
argument_list|()
decl_stmt|,
name|praise
argument_list|()
decl_stmt|,
name|pmem
argument_list|()
decl_stmt|,
name|psoct
argument_list|()
decl_stmt|,
name|pnolog
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|fd
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
name|kwtab
block|{
name|char
modifier|*
name|kwname
decl_stmt|;
name|int
function_decl|(
modifier|*
name|kwfunc
function_decl|)
parameter_list|()
function_decl|;
name|char
modifier|*
name|kwcmt
decl_stmt|;
name|char
modifier|*
name|kwptr
decl_stmt|;
block|}
name|kwtab
index|[]
init|=
block|{
literal|"shares"
block|,
name|psval
block|,
literal|""
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_qu
operator|.
name|qu_shares
block|,
literal|"plimit"
block|,
name|psval
block|,
literal|"max number of processes"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_qu
operator|.
name|qu_plim
block|,
literal|"class"
block|,
name|pbits
block|,
literal|"user classes"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_qu
operator|.
name|qu_class
block|,
literal|"groups"
block|,
name|pgrps
block|,
literal|"system file access groups"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_grps
block|,
literal|"umask"
block|,
name|psoct
block|,
literal|"initial umask"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_umask
block|,
literal|"syflags"
block|,
name|psflags
block|,
literal|"system flags"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_qu
operator|.
name|qu_syflags
block|,
literal|"flags"
block|,
name|pflags
block|,
literal|"other flags"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_flags
index|[
literal|0
index|]
block|,
literal|"ttyclass"
block|,
name|pbits
block|,
literal|"permitted terminal classes"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_ttys
block|,
literal|"expires"
block|,
name|pdate
block|,
literal|"Account expiry date"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_expires
block|,
literal|"nologins"
block|,
name|pnolog
block|,
literal|""
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
literal|"maxsimul"
block|,
name|pchar
block|,
literal|"maximum simultaneous logins"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_maxlogin
block|,
literal|"maxlogin"
block|,
name|psecs
block|,
literal|"maximum login time (hr:min:sec)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_maxuse
block|,
literal|"maxlsess"
block|,
name|pmins
block|,
literal|"maximum login session (hr:min)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_smax
block|,
literal|"sessgap"
block|,
name|pmins
block|,
literal|"gap between sessions (hr:min)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_lgap
block|,
literal|"sessleft"
block|,
name|pmins
block|,
literal|"time left in current session (hr:min)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_left
block|,
literal|"weeklmax"
block|,
name|pmins
block|,
literal|"max week's login time (hr:min)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_wmax
block|,
literal|"weeklinc"
block|,
name|pmins
block|,
literal|"weekly login allowance (hr:min)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_winc
block|,
literal|"weeklrem"
block|,
name|pmins
block|,
literal|"weekly allowance remaining (hr:min)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_wrem
block|,
literal|"daylmax"
block|,
name|pmins
block|,
literal|"Max day's login time (hr:min)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_dmax
block|,
literal|"daylinc"
block|,
name|pmins
block|,
literal|"daily login allowance (hr:min)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_dinc
block|,
literal|"daylrem"
block|,
name|pmins
block|,
literal|"daily allowance remaining (hr:min)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mm
operator|.
name|mm_drem
block|,
literal|"prclass"
block|,
name|pbits
block|,
literal|"permitted printer classes"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lpdq
operator|.
name|lpq_prclass
block|,
literal|"lpdwmax"
block|,
name|psval
block|,
literal|"maximum pages in a week"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lpdq
operator|.
name|lpq_wmax
block|,
literal|"lpdwinc"
block|,
name|psval
block|,
literal|"weekly page allowance"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lpdq
operator|.
name|lpq_allow
block|,
literal|"lpdwrem"
block|,
name|psval
block|,
literal|"pages left this week"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lpdq
operator|.
name|lpq_week
block|,
literal|"lpddmax"
block|,
name|psval
block|,
literal|"maximum pages in a day"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lpdq
operator|.
name|lpq_dmax
block|,
literal|"lpddinc"
block|,
name|psval
block|,
literal|"daily page allowance"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lpdq
operator|.
name|lpq_daily
block|,
literal|"lpddrem"
block|,
name|psval
block|,
literal|"pages left today"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lpdq
operator|.
name|lpq_today
block|,
literal|"lpdlimit"
block|,
name|plval
block|,
literal|"absolute page limit"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lpdq
operator|.
name|lpq_limit
block|,
literal|"maxrss"
block|,
name|pmem
block|,
literal|"expected largest proc size"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_maxrss
block|,
literal|"maxdata"
block|,
name|pmem
block|,
literal|"maximum data segment"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_maxdata
block|,
literal|"maxstack"
block|,
name|pmem
block|,
literal|"maximum stack segment"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_maxstack
block|,
literal|"maxcore"
block|,
name|pmem
block|,
literal|"largest core file generated"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_maxcore
block|,
literal|"maxfile"
block|,
name|pmem
block|,
literal|"largest file allowed"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_maxfile
block|,
literal|"maxcpu"
block|,
name|psecs
block|,
literal|"cpu time limit (hr:min:sec)"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_maxcpu
block|,
literal|"noraise"
block|,
name|praise
block|,
literal|"can't raise maximums"
block|,
operator|(
name|char
operator|*
operator|)
operator|&
name|udata
operator|.
name|ud_raise
block|,
literal|"disc"
block|,
name|pdquot
block|,
literal|""
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|}
struct|;
end_struct

begin_struct
specifier|static
struct|struct
name|syf
block|{
name|char
modifier|*
name|syfname
decl_stmt|;
name|char
modifier|*
name|syfcmt
decl_stmt|;
name|long
name|syfval
decl_stmt|;
block|}
name|syf
index|[]
init|=
block|{
literal|"modtty"
block|,
literal|"modify terminals other than login tty"
block|,
name|QF_MODTTY
block|,
literal|"ttyfast"
block|,
literal|"increase tty speed> 1200 baud"
block|,
name|QF_FASTTY
block|,
literal|"nasync"
block|,
literal|"remaining procs niced at logout"
block|,
name|QF_NASYNC
block|,
literal|"kasync"
block|,
literal|"remaining procs killed at logout"
block|,
name|QF_KASYNC
block|,
literal|"noumask"
block|,
literal|"not permitted to alter umask"
block|,
name|QF_UMASK
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|}
struct|;
end_struct

begin_struct
specifier|static
struct|struct
name|flg
block|{
name|char
modifier|*
name|flgname
decl_stmt|;
name|char
modifier|*
name|flgcmt
decl_stmt|;
name|enum
name|u_priv
name|flgval
decl_stmt|;
block|}
name|flg
index|[]
init|=
block|{
literal|"usecu"
block|,
literal|"use 'cu' to connect to remote machine"
block|,
name|USE_REMOTE
block|,
literal|"useuucp"
block|,
literal|"use 'uucp' to transfer files"
block|,
name|USE_UUCP
block|,
literal|"tutor"
block|,
literal|"various tutor priveleges"
block|,
name|TUTOR
block|,
literal|"supertute"
block|,
literal|"special tutor privs (incl modify privs)"
block|,
name|SUPER_TUTE
block|,
literal|"student"
block|,
literal|"account is a student (misc restrictions)"
block|,
name|STUDENT
block|,
literal|"stumail"
block|,
literal|"students permitted to send mail to user"
block|,
name|GET_STU_MAIL
block|,
literal|"mailstu"
block|,
literal|"permitted to send mail to students"
block|,
name|SEND_STU_MAIL
block|,
literal|"uucpmail"
block|,
literal|"permitted to mail to remote machines"
block|,
name|UUCP_MAIL
block|,
literal|"nonewgrp"
block|,
literal|"not permitted to alter login group"
block|,
name|NO_NEWGRP
block|,
literal|"studsu"
block|,
literal|"students can 'su' to this account"
block|,
name|STUD_SU
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|}
struct|;
end_struct

begin_struct
specifier|static
struct|struct
name|vnm
block|{
name|char
modifier|*
name|valname
decl_stmt|;
name|long
name|valval
index|[
literal|4
index|]
decl_stmt|;
block|}
name|vnm
index|[]
init|=
block|{
comment|/* char data */
comment|/* short data */
comment|/* long data */
literal|"none"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"unlimited"
block|,
name|INFINITY
operator|>>
literal|24
block|,
name|INFINITY
operator|>>
literal|16
block|,
literal|0
block|,
name|INFINITY
block|,
literal|"all"
block|,
operator|~
literal|0
block|,
operator|~
literal|0
block|,
literal|0
block|,
operator|~
literal|0
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|}
struct|;
end_struct

begin_macro
name|wrtprivf
argument_list|(
argument|name
argument_list|,
argument|mp
argument_list|,
argument|lp
argument_list|,
argument|dp
argument_list|,
argument|dnp
argument_list|,
argument|up
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|mushmuck
modifier|*
name|mp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|lpquota
modifier|*
name|lp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|dquot
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|char
argument_list|(
operator|*
name|dnp
argument_list|)
index|[
literal|32
index|]
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|udata
modifier|*
name|up
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|kwtab
modifier|*
name|k
decl_stmt|;
name|char
name|keyw
index|[
literal|32
index|]
decl_stmt|;
specifier|register
name|n
expr_stmt|;
name|udata
operator|=
operator|*
name|up
expr_stmt|;
name|mm
operator|=
operator|*
name|mp
expr_stmt|;
name|lpdq
operator|=
operator|*
name|lp
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|16
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|dnp
index|[
literal|0
index|]
index|[
literal|0
index|]
condition|)
block|{
name|strcpy
argument_list|(
name|dqfn
index|[
name|n
index|]
argument_list|,
name|dnp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|dqb
index|[
name|n
index|]
operator|=
operator|*
name|dp
operator|++
expr_stmt|;
name|dnp
operator|++
expr_stmt|;
block|}
else|else
break|break;
block|}
if|if
condition|(
name|n
operator|<
literal|16
condition|)
name|dqfn
index|[
name|n
index|]
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|fopen
argument_list|(
name|name
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|k
operator|=
name|kwtab
init|;
name|k
operator|->
name|kwname
condition|;
name|k
operator|++
control|)
call|(
modifier|*
name|k
operator|->
name|kwfunc
call|)
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|fd
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|plval
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|nameval
argument_list|(
name|k
argument_list|,
operator|*
operator|(
name|long
operator|*
operator|)
name|k
operator|->
name|kwptr
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
condition|)
return|return;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %ld		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwname
argument_list|,
operator|*
operator|(
name|long
operator|*
operator|)
name|k
operator|->
name|kwptr
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|psval
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|nameval
argument_list|(
name|k
argument_list|,
operator|(
name|long
operator|)
operator|*
operator|(
name|short
operator|*
operator|)
name|k
operator|->
name|kwptr
argument_list|,
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
condition|)
return|return;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %d		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwname
argument_list|,
operator|*
operator|(
name|short
operator|*
operator|)
name|k
operator|->
name|kwptr
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|pchar
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|nameval
argument_list|(
name|k
argument_list|,
operator|(
name|long
operator|)
operator|*
operator|(
name|char
operator|*
operator|)
name|k
operator|->
name|kwptr
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
condition|)
return|return;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %d		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwname
argument_list|,
operator|*
operator|(
name|char
operator|*
operator|)
name|k
operator|->
name|kwptr
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|psoct
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|nameval
argument_list|(
name|k
argument_list|,
operator|(
name|long
operator|)
operator|*
operator|(
name|short
operator|*
operator|)
name|k
operator|->
name|kwptr
argument_list|,
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
condition|)
return|return;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %o		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwname
argument_list|,
operator|*
operator|(
name|short
operator|*
operator|)
name|k
operator|->
name|kwptr
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|pmem
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|long
name|n
decl_stmt|;
name|n
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|k
operator|->
name|kwptr
expr_stmt|;
if|if
condition|(
name|nameval
argument_list|(
name|k
argument_list|,
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
condition|)
return|return;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s "
argument_list|,
name|k
operator|->
name|kwname
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|&&
operator|(
name|n
operator|&
operator|(
literal|1
operator|<<
literal|20
operator|)
operator|-
literal|1
operator|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%ldM"
argument_list|,
name|n
operator|>>
literal|20
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|&&
operator|(
name|n
operator|&
operator|(
literal|1
operator|<<
literal|10
operator|)
operator|-
literal|1
operator|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%ldK"
argument_list|,
name|n
operator|>>
literal|10
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%ld"
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|psecs
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|long
name|secs
decl_stmt|;
name|secs
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|k
operator|->
name|kwptr
expr_stmt|;
if|if
condition|(
name|nameval
argument_list|(
name|k
argument_list|,
name|secs
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
condition|)
return|return;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %ld:%02ld:%02ld		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwname
argument_list|,
name|secs
operator|/
literal|3600
argument_list|,
operator|(
name|secs
operator|%
literal|3600
operator|)
operator|/
literal|60
argument_list|,
name|secs
operator|%
literal|60
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|pmins
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|mins
expr_stmt|;
name|mins
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
name|k
operator|->
name|kwptr
expr_stmt|;
if|if
condition|(
name|nameval
argument_list|(
name|k
argument_list|,
operator|(
name|long
operator|)
name|mins
argument_list|,
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
condition|)
return|return;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %d:%02d		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwname
argument_list|,
name|mins
operator|/
literal|60
argument_list|,
name|mins
operator|%
literal|60
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|pbits
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|unsigned
name|long
name|bits
decl_stmt|;
specifier|register
name|ch
operator|=
literal|'a'
expr_stmt|;
name|bits
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|k
operator|->
name|kwptr
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s "
argument_list|,
name|k
operator|->
name|kwname
argument_list|)
expr_stmt|;
while|while
condition|(
name|bits
condition|)
block|{
if|if
condition|(
name|bits
operator|&
literal|1
condition|)
name|putc
argument_list|(
name|ch
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|bits
operator|>>=
literal|1
expr_stmt|;
name|ch
operator|++
expr_stmt|;
if|if
condition|(
name|ch
operator|>
literal|'z'
condition|)
break|break;
block|}
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|pnolog
argument_list|(
argument|k
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|kwtab
modifier|*
name|k
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|t_range
modifier|*
name|rp
init|=
name|udata
operator|.
name|ud_logon
decl_stmt|;
specifier|register
name|ok
operator|=
literal|1
expr_stmt|;
specifier|static
name|char
modifier|*
name|dofw
index|[]
init|=
block|{
literal|"Sun"
block|,
literal|"Mon"
block|,
literal|"Tue"
block|,
literal|"Wed"
block|,
literal|"Thu"
block|,
literal|"Fri"
block|,
literal|"Sat"
block|,
literal|""
block|}
decl_stmt|;
if|if
condition|(
name|rp
operator|->
name|tr_low
operator|.
name|xt_ok
operator|==
name|rp
operator|->
name|tr_high
operator|.
name|xt_ok
condition|)
return|return;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s "
argument_list|,
name|k
operator|->
name|kwname
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|rp
operator|->
name|tr_low
operator|.
name|xt_ok
operator|!=
name|ok
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"except "
argument_list|)
expr_stmt|;
name|ok
operator|=
name|rp
operator|->
name|tr_low
operator|.
name|xt_ok
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s "
argument_list|,
name|dofw
index|[
name|rp
operator|->
name|tr_low
operator|.
name|xt_day
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rp
operator|->
name|tr_low
operator|.
name|xt_day
operator|!=
name|rp
operator|->
name|tr_high
operator|.
name|xt_day
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"- %s "
argument_list|,
name|dofw
index|[
name|rp
operator|->
name|tr_high
operator|.
name|xt_day
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rp
operator|->
name|tr_low
operator|.
name|xt_min
operator|!=
literal|0
operator|||
name|rp
operator|->
name|tr_high
operator|.
name|xt_min
operator|!=
literal|24
operator|*
literal|60
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%02d:%02d-%02d:%02d "
argument_list|,
name|rp
operator|->
name|tr_low
operator|.
name|xt_min
operator|/
literal|60
argument_list|,
name|rp
operator|->
name|tr_low
operator|.
name|xt_min
operator|%
literal|60
argument_list|,
name|rp
operator|->
name|tr_high
operator|.
name|xt_min
operator|/
literal|60
argument_list|,
name|rp
operator|->
name|tr_high
operator|.
name|xt_min
operator|%
literal|60
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|rp
operator|>=
operator|&
name|udata
operator|.
name|ud_logon
index|[
literal|4
index|]
operator|||
name|rp
operator|->
name|tr_low
operator|.
name|xt_ok
operator|==
name|rp
operator|->
name|tr_high
operator|.
name|xt_ok
condition|)
break|break;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"	/* %s */\n"
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|pdate
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|time_t
name|date
decl_stmt|;
name|char
modifier|*
name|ctime
parameter_list|()
function_decl|;
name|date
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|k
operator|->
name|kwptr
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %.20s		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwname
argument_list|,
name|date
condition|?
name|ctime
argument_list|(
operator|&
name|date
argument_list|)
operator|+
literal|4
else|:
literal|"never"
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|pdquot
argument_list|()
block|{
specifier|register
name|char
argument_list|(
operator|*
name|fs
argument_list|)
index|[
literal|32
index|]
block|;
specifier|register
expr|struct
name|dquot
operator|*
name|dqp
operator|=
name|dqb
block|;
for|for
control|(
name|fs
operator|=
name|dqfn
init|;
name|fs
index|[
literal|0
index|]
index|[
literal|0
index|]
condition|;
name|fs
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"disc %.32s blks = %d blim = %d iq = %d ilim = %d\n"
argument_list|,
name|fs
index|[
literal|0
index|]
argument_list|,
name|dqp
operator|->
name|dq_quot
argument_list|,
name|dqp
operator|->
name|dq_blim
argument_list|,
name|dqp
operator|->
name|dq_iq
argument_list|,
name|dqp
operator|->
name|dq_ilim
argument_list|)
expr_stmt|;
name|dqp
operator|++
expr_stmt|;
block|}
end_expr_stmt

begin_macro
unit|}  static
name|pflags
argument_list|(
argument|k
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|kwtab
modifier|*
name|k
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|long
name|f
decl_stmt|;
specifier|register
name|struct
name|flg
modifier|*
name|fp
decl_stmt|;
specifier|register
name|n
operator|=
literal|0
expr_stmt|;
name|f
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|k
operator|->
name|kwptr
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"flags"
argument_list|)
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|flg
init|;
name|fp
operator|->
name|flgname
condition|;
name|fp
operator|++
control|)
if|if
condition|(
name|f
operator|&
operator|(
literal|1
operator|<<
operator|(
name|int
operator|)
name|fp
operator|->
name|flgval
operator|)
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %s"
argument_list|,
name|n
operator|++
condition|?
literal|","
else|:
literal|""
argument_list|,
name|fp
operator|->
name|flgname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"	/* %s */\n"
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|psflags
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|long
name|f
decl_stmt|;
specifier|register
name|struct
name|syf
modifier|*
name|fp
decl_stmt|;
specifier|register
name|n
operator|=
literal|0
expr_stmt|;
name|f
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|k
operator|->
name|kwptr
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"syflags"
argument_list|)
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|syf
init|;
name|fp
operator|->
name|syfname
condition|;
name|fp
operator|++
control|)
if|if
condition|(
name|f
operator|&
name|fp
operator|->
name|syfval
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %s"
argument_list|,
name|n
operator|++
condition|?
literal|","
else|:
literal|""
argument_list|,
name|fp
operator|->
name|syfname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"	/* %s */\n"
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|praise
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
operator|*
operator|(
name|long
operator|*
operator|)
name|k
operator|->
name|kwptr
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s			/* %s */\n"
argument_list|,
name|k
operator|->
name|kwname
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|nameval
argument_list|(
argument|k
argument_list|,
argument|val
argument_list|,
argument|size
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|kwtab
modifier|*
name|k
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|long
name|val
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|register
name|size
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|vnm
modifier|*
name|vp
decl_stmt|;
for|for
control|(
name|vp
operator|=
name|vnm
init|;
name|vp
operator|->
name|valname
condition|;
name|vp
operator|++
control|)
if|if
condition|(
name|val
operator|==
name|vp
operator|->
name|valval
index|[
name|size
operator|-
literal|1
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %s		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwname
argument_list|,
name|vp
operator|->
name|valname
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|pgrps
argument_list|(
argument|k
argument_list|)
expr|struct
name|kwtab
operator|*
name|k
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|long
name|grps
decl_stmt|;
specifier|register
name|struct
name|group
modifier|*
name|gp
decl_stmt|;
specifier|register
name|char
modifier|*
name|sep
init|=
literal|""
decl_stmt|;
name|grps
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|k
operator|->
name|kwptr
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s"
argument_list|,
name|k
operator|->
name|kwname
argument_list|)
expr_stmt|;
name|setgrent
argument_list|()
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|128
init|;
name|n
operator|<
literal|128
operator|+
literal|32
condition|;
name|n
operator|++
control|)
block|{
comment|/* much magic here */
if|if
condition|(
name|grps
operator|&
literal|1
condition|)
block|{
name|gp
operator|=
name|getgrgid
argument_list|(
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|gp
condition|)
block|{
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s %s"
argument_list|,
name|sep
argument_list|,
name|gp
operator|->
name|gr_name
argument_list|)
expr_stmt|;
name|sep
operator|=
literal|","
expr_stmt|;
block|}
block|}
name|grps
operator|>>=
literal|1
expr_stmt|;
comment|/* any sort of shift will do */
block|}
name|endgrent
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"		/* %s */\n"
argument_list|,
name|k
operator|->
name|kwcmt
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


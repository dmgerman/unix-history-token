begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1985 Regents of the University of California.  * All rights reserved.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the University of California, Berkeley.  The name of the  * University may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1985 Regents of the University of California.\n\  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)driver.c	5.3 (Berkeley) 6/27/88"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*  *  Hunt  *  Copyright (c) 1985 Conrad C. Huang, Gregory S. Couch, Kenneth C.R.C. Arnold  *  San Francisco, California  */
end_comment

begin_include
include|#
directive|include
file|"hunt.h"
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|pdp11
end_ifndef

begin_define
define|#
directive|define
name|RN
value|(((Seed = Seed * 11109 + 13849)>> 16)& 0xffff)
end_define

begin_else
else|#
directive|else
else|pdp11
end_else

begin_define
define|#
directive|define
name|RN
value|((Seed = Seed * 11109 + 13849)& 0x7fff)
end_define

begin_endif
endif|#
directive|endif
endif|pdp11
end_endif

begin_decl_stmt
name|int
name|Seed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CONSTANT_MOVE
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|itimerval
name|Timing
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|CONSTANT_MOVE
end_endif

begin_decl_stmt
name|SOCKET
name|Daemon
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|INTERNET
end_ifdef

begin_decl_stmt
name|int
name|Test_socket
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* test socket to answer datagrams */
end_comment

begin_define
define|#
directive|define
name|DAEMON_SIZE
value|(sizeof Daemon)
end_define

begin_else
else|#
directive|else
else|INTERNET
end_else

begin_define
define|#
directive|define
name|DAEMON_SIZE
value|(sizeof Daemon - 1)
end_define

begin_endif
endif|#
directive|endif
endif|INTERNET
end_endif

begin_comment
comment|/*  * main:  *	The main program.  */
end_comment

begin_function
name|main
parameter_list|()
block|{
specifier|register
name|PLAYER
modifier|*
name|pp
decl_stmt|;
specifier|register
name|int
name|had_char
decl_stmt|;
ifdef|#
directive|ifdef
name|INTERNET
specifier|register
name|long
name|test_mask
decl_stmt|;
name|int
name|msg
decl_stmt|;
name|int
name|namelen
decl_stmt|;
name|SOCKET
name|test
decl_stmt|;
endif|#
directive|endif
endif|INTERNET
ifdef|#
directive|ifdef
name|CONSTANT_MOVE
specifier|register
name|int
name|enable_alarm
decl_stmt|,
name|disable_alarm
decl_stmt|;
endif|#
directive|endif
endif|CONSTANT_MOVE
specifier|static
name|long
name|read_fds
decl_stmt|;
name|init
argument_list|()
expr_stmt|;
name|Sock_mask
operator|=
operator|(
literal|1
operator|<<
name|Socket
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INTERNET
name|test_mask
operator|=
operator|(
literal|1
operator|<<
name|Test_socket
operator|)
expr_stmt|;
endif|#
directive|endif
endif|INTERNET
ifdef|#
directive|ifdef
name|CONSTANT_MOVE
name|enable_alarm
operator|=
name|sigblock
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|disable_alarm
operator|=
name|enable_alarm
operator||
operator|(
literal|1
operator|<<
operator|(
name|SIGALRM
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|sigsetmask
argument_list|(
name|disable_alarm
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|moveshots
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|CONSTANT_MOVE
while|while
condition|(
name|Nplayer
operator|>
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|CONSTANT_MOVE
operator|(
name|void
operator|)
name|sigsetmask
argument_list|(
name|enable_alarm
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|CONSTANT_MOVE
name|read_fds
operator|=
name|Fds_mask
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|OLDIPC
while|while
condition|(
name|select
argument_list|(
name|Num_fds
argument_list|,
operator|&
name|read_fds
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
operator|(
expr|struct
name|timeval
operator|*
operator|)
name|NULL
argument_list|)
operator|<
literal|0
condition|)
else|#
directive|else
else|OLDIPC
while|while
condition|(
name|select
argument_list|(
literal|20
argument_list|,
operator|&
name|read_fds
argument_list|,
name|NULL
argument_list|,
literal|32767
argument_list|)
operator|<
literal|0
condition|)
endif|#
directive|endif
endif|OLDIPC
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
condition|)
name|perror
argument_list|(
literal|"select"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Nplayer
operator|==
literal|0
condition|)
goto|goto
name|out
goto|;
name|errno
operator|=
literal|0
expr_stmt|;
block|}
name|Have_inp
operator|=
name|read_fds
expr_stmt|;
ifdef|#
directive|ifdef
name|CONSTANT_MOVE
operator|(
name|void
operator|)
name|sigsetmask
argument_list|(
name|disable_alarm
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|CONSTANT_MOVE
ifdef|#
directive|ifdef
name|INTERNET
if|if
condition|(
name|read_fds
operator|&
name|test_mask
condition|)
block|{
name|namelen
operator|=
name|DAEMON_SIZE
expr_stmt|;
ifndef|#
directive|ifndef
name|OLDIPC
operator|(
name|void
operator|)
name|recvfrom
argument_list|(
name|Test_socket
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|test
argument_list|,
operator|&
name|namelen
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sendto
argument_list|(
name|Test_socket
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|test
argument_list|,
name|DAEMON_SIZE
argument_list|)
expr_stmt|;
else|#
directive|else
else|OLDIPC
operator|(
name|void
operator|)
name|receive
argument_list|(
name|Test_socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|test
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send
argument_list|(
name|Test_socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|test
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|OLDIPC
block|}
endif|#
directive|endif
endif|INTERNET
for|for
control|(
init|;
condition|;
control|)
block|{
name|had_char
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|pp
operator|=
name|Player
init|;
name|pp
operator|<
name|End_player
condition|;
name|pp
operator|++
control|)
if|if
condition|(
name|havechar
argument_list|(
name|pp
argument_list|)
condition|)
block|{
name|execute
argument_list|(
name|pp
argument_list|)
expr_stmt|;
name|pp
operator|->
name|p_nexec
operator|++
expr_stmt|;
name|had_char
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MONITOR
for|for
control|(
name|pp
operator|=
name|Monitor
init|;
name|pp
operator|<
name|End_monitor
condition|;
name|pp
operator|++
control|)
if|if
condition|(
name|havechar
argument_list|(
name|pp
argument_list|)
condition|)
block|{
name|mon_execute
argument_list|(
name|pp
argument_list|)
expr_stmt|;
name|pp
operator|->
name|p_nexec
operator|++
expr_stmt|;
name|had_char
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
endif|MONITOR
if|if
condition|(
operator|!
name|had_char
condition|)
break|break;
ifdef|#
directive|ifdef
name|CONSTANT_MOVE
for|for
control|(
name|pp
operator|=
name|Player
init|;
name|pp
operator|<
name|End_player
condition|;
name|pp
operator|++
control|)
block|{
name|look
argument_list|(
name|pp
argument_list|)
expr_stmt|;
name|sendcom
argument_list|(
name|pp
argument_list|,
name|REFRESH
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MONITOR
for|for
control|(
name|pp
operator|=
name|Monitor
init|;
name|pp
operator|<
name|End_monitor
condition|;
name|pp
operator|++
control|)
name|sendcom
argument_list|(
name|pp
argument_list|,
name|REFRESH
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MONITOR
else|#
directive|else
else|CONSTANT_MOVE
name|moveshots
argument_list|()
expr_stmt|;
endif|#
directive|endif
endif|CONSTANT_MOVE
for|for
control|(
name|pp
operator|=
name|Player
init|;
name|pp
operator|<
name|End_player
condition|;
control|)
if|if
condition|(
name|pp
operator|->
name|p_death
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|zap
argument_list|(
name|pp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
else|else
name|pp
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|MONITOR
for|for
control|(
name|pp
operator|=
name|Monitor
init|;
name|pp
operator|<
name|End_monitor
condition|;
control|)
if|if
condition|(
name|pp
operator|->
name|p_death
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|zap
argument_list|(
name|pp
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
else|else
name|pp
operator|++
expr_stmt|;
endif|#
directive|endif
endif|MONITOR
block|}
if|if
condition|(
name|read_fds
operator|&
name|Sock_mask
condition|)
name|answer
argument_list|()
expr_stmt|;
for|for
control|(
name|pp
operator|=
name|Player
init|;
name|pp
operator|<
name|End_player
condition|;
name|pp
operator|++
control|)
block|{
if|if
condition|(
name|read_fds
operator|&
name|pp
operator|->
name|p_mask
condition|)
name|sendcom
argument_list|(
name|pp
argument_list|,
name|READY
argument_list|,
name|pp
operator|->
name|p_nexec
argument_list|)
expr_stmt|;
name|pp
operator|->
name|p_nexec
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|pp
operator|->
name|p_output
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MONITOR
for|for
control|(
name|pp
operator|=
name|Monitor
init|;
name|pp
operator|<
name|End_monitor
condition|;
name|pp
operator|++
control|)
block|{
if|if
condition|(
name|read_fds
operator|&
name|pp
operator|->
name|p_mask
condition|)
name|sendcom
argument_list|(
name|pp
argument_list|,
name|READY
argument_list|,
name|pp
operator|->
name|p_nexec
argument_list|)
expr_stmt|;
name|pp
operator|->
name|p_nexec
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|pp
operator|->
name|p_output
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|MONITOR
block|}
name|out
label|:
ifdef|#
directive|ifdef
name|CONSTANT_MOVE
name|bul_alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|CONSTANT_MOVE
ifdef|#
directive|ifdef
name|MONITOR
for|for
control|(
name|pp
operator|=
name|Monitor
init|;
name|pp
operator|<
name|End_monitor
condition|;
control|)
name|zap
argument_list|(
name|pp
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MONITOR
name|cleanup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * init:  *	Initialize the global parameters.  */
end_comment

begin_macro
name|init
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|INTERNET
name|SOCKET
name|test_port
decl_stmt|;
specifier|auto
name|int
name|msg
decl_stmt|;
endif|#
directive|endif
endif|INTERNET
name|int
name|cleanup
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|DEBUG
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|,
name|TIOCNOTTY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setpgrp
argument_list|(
name|getpid
argument_list|()
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|cleanup
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
operator|(
name|void
operator|)
name|chdir
argument_list|(
literal|"/usr/tmp"
argument_list|)
expr_stmt|;
comment|/* just in case it core dumps */
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INTERNET
name|Daemon
operator|.
name|sin_family
operator|=
name|SOCK_FAMILY
expr_stmt|;
ifdef|#
directive|ifdef
name|OLD
if|if
condition|(
name|gethostname
argument_list|(
name|local_name
argument_list|,
sizeof|sizeof
name|local_name
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"gethostname"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hp
operator|=
name|gethostbyname
argument_list|(
name|local_name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown host %s\n"
argument_list|,
name|local_name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr
argument_list|,
operator|&
operator|(
name|Daemon
operator|.
name|sin_addr
operator|.
name|s_addr
operator|)
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
else|#
directive|else
name|Daemon
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
endif|#
directive|endif
endif|OLD
name|Daemon
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|Sock_port
argument_list|)
expr_stmt|;
else|#
directive|else
else|INTERNET
name|Daemon
operator|.
name|sun_family
operator|=
name|SOCK_FAMILY
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|Daemon
operator|.
name|sun_path
argument_list|,
name|Sock_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|INTERNET
ifndef|#
directive|ifndef
name|OLDIPC
name|Socket
operator|=
name|socket
argument_list|(
name|SOCK_FAMILY
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
else|OLDIPC
name|Socket
operator|=
name|socket
argument_list|(
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|Daemon
argument_list|,
name|SO_ACCEPTCONN
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|OLDIPC
if|#
directive|if
name|defined
argument_list|(
name|INTERNET
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OLDIPC
argument_list|)
if|if
condition|(
name|setsockopt
argument_list|(
name|Socket
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_USELOOPBACK
argument_list|,
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"setsockopt loopback"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|INTERNET
ifndef|#
directive|ifndef
name|OLDIPC
if|if
condition|(
name|bind
argument_list|(
name|Socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|Daemon
argument_list|,
name|DAEMON_SIZE
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EADDRINUSE
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|perror
argument_list|(
literal|"bind"
argument_list|)
expr_stmt|;
name|cleanup
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|listen
argument_list|(
name|Socket
argument_list|,
literal|5
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|OLDIPC
name|Fds_mask
operator|=
operator|(
literal|1
operator|<<
name|Socket
operator|)
expr_stmt|;
name|Num_fds
operator|=
name|Socket
operator|+
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|INTERNET
name|test_port
operator|=
name|Daemon
expr_stmt|;
name|test_port
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|Test_port
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OLDIPC
name|Test_socket
operator|=
name|socket
argument_list|(
name|SOCK_FAMILY
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|Test_socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|test_port
argument_list|,
name|DAEMON_SIZE
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|listen
argument_list|(
name|Test_socket
argument_list|,
literal|5
argument_list|)
expr_stmt|;
else|#
directive|else
else|OLDIPC
name|Test_socket
operator|=
name|socket
argument_list|(
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|test_port
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|OLDIPC
name|Fds_mask
operator||=
operator|(
literal|1
operator|<<
name|Test_socket
operator|)
expr_stmt|;
if|if
condition|(
name|Test_socket
operator|>
name|Socket
condition|)
name|Num_fds
operator|=
name|Test_socket
operator|+
literal|1
expr_stmt|;
endif|#
directive|endif
endif|INTERNET
name|Seed
operator|=
name|getpid
argument_list|()
operator|+
name|time
argument_list|(
operator|(
name|time_t
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|makemaze
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NASCII
condition|;
name|i
operator|++
control|)
name|See_over
index|[
name|i
index|]
operator|=
name|TRUE
expr_stmt|;
name|See_over
index|[
name|DOOR
index|]
operator|=
name|FALSE
expr_stmt|;
name|See_over
index|[
name|WALL1
index|]
operator|=
name|FALSE
expr_stmt|;
name|See_over
index|[
name|WALL2
index|]
operator|=
name|FALSE
expr_stmt|;
name|See_over
index|[
name|WALL3
index|]
operator|=
name|FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|REFLECT
name|See_over
index|[
name|WALL4
index|]
operator|=
name|FALSE
expr_stmt|;
name|See_over
index|[
name|WALL5
index|]
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
endif|REFLECT
ifdef|#
directive|ifdef
name|CONSTANT_MOVE
name|getitimer
argument_list|(
name|ITIMER_REAL
argument_list|,
operator|&
name|Timing
argument_list|)
expr_stmt|;
name|Timing
operator|.
name|it_interval
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|Timing
operator|.
name|it_interval
operator|.
name|tv_usec
operator|=
literal|500
expr_stmt|;
name|Timing
operator|.
name|it_value
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|Timing
operator|.
name|it_value
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|setitimer
argument_list|(
name|ITIMER_REAL
argument_list|,
operator|&
name|Timing
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|CONSTANT_MOVE
name|answer
argument_list|()
expr_stmt|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|CONSTANT_MOVE
end_ifdef

begin_comment
comment|/*  * bul_alarm:  *	Set up the alarm for the bullets  */
end_comment

begin_macro
name|bul_alarm
argument_list|(
argument|val
argument_list|)
end_macro

begin_decl_stmt
name|int
name|val
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Timing
operator|.
name|it_value
operator|.
name|tv_usec
operator|=
name|val
operator|*
name|Timing
operator|.
name|it_interval
operator|.
name|tv_usec
expr_stmt|;
name|setitimer
argument_list|(
name|ITIMER_REAL
argument_list|,
operator|&
name|Timing
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|CONSTANT_MOVE
end_endif

begin_comment
comment|/*  * checkdam:  *	Check the damage to the given player, and see if s/he is killed  */
end_comment

begin_expr_stmt
name|checkdam
argument_list|(
name|ouch
argument_list|,
name|gotcha
argument_list|,
name|credit
argument_list|,
name|amt
argument_list|,
name|shot_type
argument_list|)
specifier|register
name|PLAYER
operator|*
name|ouch
operator|,
operator|*
name|gotcha
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|IDENT
modifier|*
name|credit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|amt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|shot_type
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
name|ouch
operator|->
name|p_death
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
return|return;
if|if
condition|(
name|rand_num
argument_list|(
literal|100
argument_list|)
operator|<
literal|5
condition|)
block|{
name|message
argument_list|(
name|ouch
argument_list|,
literal|"Missed you by a hair"
argument_list|)
expr_stmt|;
if|if
condition|(
name|gotcha
operator|!=
name|NULL
condition|)
name|message
argument_list|(
name|gotcha
argument_list|,
literal|"Missed him"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ouch
operator|->
name|p_damage
operator|+=
name|amt
expr_stmt|;
if|if
condition|(
name|ouch
operator|->
name|p_damage
operator|<=
name|ouch
operator|->
name|p_damcap
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|Buf
argument_list|,
literal|"%2d"
argument_list|,
name|ouch
operator|->
name|p_damage
argument_list|)
expr_stmt|;
name|cgoto
argument_list|(
name|ouch
argument_list|,
name|STAT_DAM_ROW
argument_list|,
name|STAT_VALUE_COL
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|ouch
argument_list|,
name|Buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Someone DIED */
switch|switch
condition|(
name|shot_type
condition|)
block|{
default|default:
name|cp
operator|=
literal|"Killed"
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|FLY
case|case
name|FALL
case|:
name|cp
operator|=
literal|"Killed on impact"
expr_stmt|;
break|break;
endif|#
directive|endif
endif|FLY
case|case
name|KNIFE
case|:
name|cp
operator|=
literal|"Stabbed to death"
expr_stmt|;
break|break;
case|case
name|SHOT
case|:
name|cp
operator|=
literal|"Shot to death"
expr_stmt|;
break|break;
case|case
name|GRENADE
case|:
case|case
name|SATCHEL
case|:
case|case
name|BOMB
case|:
name|cp
operator|=
literal|"Bombed"
expr_stmt|;
break|break;
case|case
name|MINE
case|:
case|case
name|GMINE
case|:
name|cp
operator|=
literal|"Blown apart"
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|OOZE
case|case
name|SLIME
case|:
name|cp
operator|=
literal|"Slimed"
expr_stmt|;
break|break;
endif|#
directive|endif
endif|OOZE
ifdef|#
directive|ifdef
name|VOLCANO
case|case
name|LAVA
case|:
name|cp
operator|=
literal|"Baked"
expr_stmt|;
break|break;
endif|#
directive|endif
endif|VOLCANO
block|}
if|if
condition|(
name|credit
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|ouch
operator|->
name|p_death
argument_list|,
literal|"| %s by %s |"
argument_list|,
name|cp
argument_list|,
operator|(
name|shot_type
operator|==
name|MINE
operator|||
name|shot_type
operator|==
name|GMINE
operator|)
condition|?
literal|"a mine"
else|:
literal|"act of God"
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|ouch
operator|->
name|p_death
argument_list|,
literal|"| %s by %s |"
argument_list|,
name|cp
argument_list|,
name|credit
operator|->
name|i_name
argument_list|)
expr_stmt|;
name|credit
operator|->
name|i_kills
operator|++
expr_stmt|;
name|credit
operator|->
name|i_score
operator|=
name|credit
operator|->
name|i_kills
operator|/
operator|(
name|double
operator|)
name|credit
operator|->
name|i_entries
expr_stmt|;
if|if
condition|(
name|gotcha
operator|==
name|NULL
condition|)
return|return;
name|gotcha
operator|->
name|p_damcap
operator|+=
name|STABDAM
expr_stmt|;
name|gotcha
operator|->
name|p_damage
operator|-=
name|STABDAM
expr_stmt|;
if|if
condition|(
name|gotcha
operator|->
name|p_damage
operator|<
literal|0
condition|)
name|gotcha
operator|->
name|p_damage
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|Buf
argument_list|,
literal|"%2d/%2d"
argument_list|,
name|gotcha
operator|->
name|p_damage
argument_list|,
name|gotcha
operator|->
name|p_damcap
argument_list|)
expr_stmt|;
name|cgoto
argument_list|(
name|gotcha
argument_list|,
name|STAT_DAM_ROW
argument_list|,
name|STAT_VALUE_COL
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|gotcha
argument_list|,
name|Buf
argument_list|,
literal|5
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|Buf
argument_list|,
literal|"%3d"
argument_list|,
operator|(
name|gotcha
operator|->
name|p_damcap
operator|-
name|MAXDAM
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
name|cgoto
argument_list|(
name|gotcha
argument_list|,
name|STAT_KILL_ROW
argument_list|,
name|STAT_VALUE_COL
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|gotcha
argument_list|,
name|Buf
argument_list|,
literal|3
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|Buf
argument_list|,
literal|"%5.2f"
argument_list|,
name|gotcha
operator|->
name|p_ident
operator|->
name|i_score
argument_list|)
expr_stmt|;
for|for
control|(
name|ouch
operator|=
name|Player
init|;
name|ouch
operator|<
name|End_player
condition|;
name|ouch
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|ouch
argument_list|,
name|STAT_PLAY_ROW
operator|+
literal|1
operator|+
operator|(
name|gotcha
operator|-
name|Player
operator|)
argument_list|,
name|STAT_NAME_COL
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|ouch
argument_list|,
name|Buf
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * zap:  *	Kill off a player and take him out of the game.  */
end_comment

begin_expr_stmt
name|zap
argument_list|(
name|pp
argument_list|,
name|was_player
argument_list|)
specifier|register
name|PLAYER
operator|*
name|pp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|FLAG
name|was_player
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
specifier|register
name|BULLET
modifier|*
name|bp
decl_stmt|;
specifier|register
name|PLAYER
modifier|*
name|np
decl_stmt|;
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|int
name|savefd
decl_stmt|,
name|savemask
decl_stmt|;
if|if
condition|(
name|was_player
condition|)
block|{
name|drawplayer
argument_list|(
name|pp
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|Nplayer
operator|--
expr_stmt|;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|pp
operator|->
name|p_death
argument_list|)
expr_stmt|;
comment|/* Display the cause of death */
name|x
operator|=
operator|(
name|WIDTH
operator|-
name|len
operator|)
operator|/
literal|2
expr_stmt|;
name|cgoto
argument_list|(
name|pp
argument_list|,
name|HEIGHT
operator|/
literal|2
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|pp
argument_list|,
name|pp
operator|->
name|p_death
argument_list|,
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|pp
operator|->
name|p_death
index|[
name|i
index|]
operator|=
literal|'-'
expr_stmt|;
name|pp
operator|->
name|p_death
index|[
literal|0
index|]
operator|=
literal|'+'
expr_stmt|;
name|pp
operator|->
name|p_death
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|'+'
expr_stmt|;
name|cgoto
argument_list|(
name|pp
argument_list|,
name|HEIGHT
operator|/
literal|2
operator|-
literal|1
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|pp
argument_list|,
name|pp
operator|->
name|p_death
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|cgoto
argument_list|(
name|pp
argument_list|,
name|HEIGHT
operator|/
literal|2
operator|+
literal|1
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|pp
argument_list|,
name|pp
operator|->
name|p_death
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|cgoto
argument_list|(
name|pp
argument_list|,
name|HEIGHT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|Nplayer
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|CONSTANT_MOVE
name|bul_alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|CONSTANT_MOVE
name|cleanup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
name|savefd
operator|=
name|pp
operator|->
name|p_fd
expr_stmt|;
name|savemask
operator|=
name|pp
operator|->
name|p_mask
expr_stmt|;
ifdef|#
directive|ifdef
name|MONITOR
if|if
condition|(
name|was_player
condition|)
block|{
endif|#
directive|endif
endif|MONITOR
for|for
control|(
name|bp
operator|=
name|Bullets
init|;
name|bp
operator|!=
name|NULL
condition|;
name|bp
operator|=
name|bp
operator|->
name|b_next
control|)
block|{
if|if
condition|(
name|bp
operator|->
name|b_owner
operator|==
name|pp
condition|)
name|bp
operator|->
name|b_owner
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|b_x
operator|==
name|pp
operator|->
name|p_x
operator|&&
name|bp
operator|->
name|b_y
operator|==
name|pp
operator|->
name|p_y
condition|)
name|bp
operator|->
name|b_over
operator|=
name|SPACE
expr_stmt|;
block|}
name|i
operator|=
name|rand_num
argument_list|(
name|pp
operator|->
name|p_ammo
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|pp
operator|->
name|p_ammo
operator|-
literal|1
condition|)
block|{
name|x
operator|=
name|pp
operator|->
name|p_ammo
expr_stmt|;
name|len
operator|=
name|SLIME
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|>=
name|BOMBREQ
condition|)
block|{
name|x
operator|=
name|BOMBREQ
expr_stmt|;
name|len
operator|=
name|BOMB
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|>=
name|SSLIMEREQ
condition|)
block|{
name|x
operator|=
name|SSLIMEREQ
expr_stmt|;
name|len
operator|=
name|SLIME
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|>=
name|SATREQ
condition|)
block|{
name|x
operator|=
name|SATREQ
expr_stmt|;
name|len
operator|=
name|SATCHEL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|>=
name|SLIMEREQ
condition|)
block|{
name|x
operator|=
name|SLIMEREQ
expr_stmt|;
name|len
operator|=
name|SLIME
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|>=
name|GRENREQ
condition|)
block|{
name|x
operator|=
name|GRENREQ
expr_stmt|;
name|len
operator|=
name|GRENADE
expr_stmt|;
block|}
else|else
name|x
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|x
operator|>
literal|0
condition|)
block|{
name|add_shot
argument_list|(
name|len
argument_list|,
name|pp
operator|->
name|p_y
argument_list|,
name|pp
operator|->
name|p_x
argument_list|,
name|pp
operator|->
name|p_face
argument_list|,
name|x
argument_list|,
operator|(
name|PLAYER
operator|*
operator|)
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|SPACE
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|Buf
argument_list|,
literal|"%s detonated."
argument_list|,
name|pp
operator|->
name|p_ident
operator|->
name|i_name
argument_list|)
expr_stmt|;
for|for
control|(
name|np
operator|=
name|Player
init|;
name|np
operator|<
name|End_player
condition|;
name|np
operator|++
control|)
name|message
argument_list|(
name|np
argument_list|,
name|Buf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MONITOR
for|for
control|(
name|np
operator|=
name|Monitor
init|;
name|np
operator|<
name|End_monitor
condition|;
name|np
operator|++
control|)
name|message
argument_list|(
name|np
argument_list|,
name|Buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MONITOR
block|}
ifdef|#
directive|ifdef
name|VOLCANO
name|volcano
operator|+=
name|pp
operator|->
name|p_ammo
operator|-
name|x
expr_stmt|;
if|if
condition|(
name|rand_num
argument_list|(
literal|100
argument_list|)
operator|<
name|volcano
operator|/
literal|50
condition|)
block|{
do|do
block|{
name|x
operator|=
name|rand_num
argument_list|(
name|WIDTH
operator|/
literal|2
argument_list|)
operator|+
name|WIDTH
operator|/
literal|4
expr_stmt|;
name|y
operator|=
name|rand_num
argument_list|(
name|HEIGHT
operator|/
literal|2
argument_list|)
operator|+
name|HEIGHT
operator|/
literal|4
expr_stmt|;
block|}
do|while
condition|(
name|Maze
index|[
name|y
index|]
index|[
name|x
index|]
operator|!=
name|SPACE
condition|)
do|;
name|add_shot
argument_list|(
name|LAVA
argument_list|,
name|y
argument_list|,
name|x
argument_list|,
name|LEFTS
argument_list|,
name|volcano
argument_list|,
operator|(
name|PLAYER
operator|*
operator|)
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|SPACE
argument_list|)
expr_stmt|;
for|for
control|(
name|np
operator|=
name|Player
init|;
name|np
operator|<
name|End_player
condition|;
name|np
operator|++
control|)
name|message
argument_list|(
name|np
argument_list|,
literal|"Volcano eruption."
argument_list|)
expr_stmt|;
name|volcano
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
endif|VOLCANO
name|sendcom
argument_list|(
name|pp
argument_list|,
name|ENDWIN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|pp
operator|->
name|p_output
argument_list|)
expr_stmt|;
name|End_player
operator|--
expr_stmt|;
if|if
condition|(
name|pp
operator|!=
name|End_player
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|End_player
argument_list|,
operator|(
name|char
operator|*
operator|)
name|pp
argument_list|,
sizeof|sizeof
argument_list|(
name|PLAYER
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|Buf
argument_list|,
literal|"%5.2f%c%-10.10s"
argument_list|,
name|pp
operator|->
name|p_ident
operator|->
name|i_score
argument_list|,
name|stat_char
argument_list|(
name|pp
argument_list|)
argument_list|,
name|pp
operator|->
name|p_ident
operator|->
name|i_name
argument_list|)
expr_stmt|;
name|i
operator|=
name|STAT_PLAY_ROW
operator|+
literal|1
operator|+
operator|(
name|pp
operator|-
name|Player
operator|)
expr_stmt|;
for|for
control|(
name|np
operator|=
name|Player
init|;
name|np
operator|<
name|End_player
condition|;
name|np
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|np
argument_list|,
name|i
argument_list|,
name|STAT_NAME_COL
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|np
argument_list|,
name|Buf
argument_list|,
name|STAT_NAME_LEN
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MONITOR
for|for
control|(
name|np
operator|=
name|Monitor
init|;
name|np
operator|<
name|End_monitor
condition|;
name|np
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|np
argument_list|,
name|i
argument_list|,
name|STAT_NAME_COL
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|np
argument_list|,
name|Buf
argument_list|,
name|STAT_NAME_LEN
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|MONITOR
block|}
comment|/* Erase the last player */
name|i
operator|=
name|STAT_PLAY_ROW
operator|+
literal|1
operator|+
name|Nplayer
expr_stmt|;
for|for
control|(
name|np
operator|=
name|Player
init|;
name|np
operator|<
name|End_player
condition|;
name|np
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|np
argument_list|,
name|i
argument_list|,
name|STAT_NAME_COL
argument_list|)
expr_stmt|;
name|ce
argument_list|(
name|np
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MONITOR
for|for
control|(
name|np
operator|=
name|Monitor
init|;
name|np
operator|<
name|End_monitor
condition|;
name|np
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|np
argument_list|,
name|i
argument_list|,
name|STAT_NAME_COL
argument_list|)
expr_stmt|;
name|ce
argument_list|(
name|np
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|sendcom
argument_list|(
name|pp
argument_list|,
name|ENDWIN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putc
argument_list|(
name|LAST_PLAYER
argument_list|,
name|pp
operator|->
name|p_output
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|pp
operator|->
name|p_output
argument_list|)
expr_stmt|;
name|End_monitor
operator|--
expr_stmt|;
if|if
condition|(
name|pp
operator|!=
name|End_monitor
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|End_monitor
argument_list|,
operator|(
name|char
operator|*
operator|)
name|pp
argument_list|,
sizeof|sizeof
argument_list|(
name|PLAYER
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|Buf
argument_list|,
literal|"%5.5s %-10.10s"
argument_list|,
literal|" "
argument_list|,
name|pp
operator|->
name|p_ident
operator|->
name|i_name
argument_list|)
expr_stmt|;
name|i
operator|=
name|STAT_MON_ROW
operator|+
literal|1
operator|+
operator|(
name|pp
operator|-
name|Player
operator|)
expr_stmt|;
for|for
control|(
name|np
operator|=
name|Player
init|;
name|np
operator|<
name|End_player
condition|;
name|np
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|np
argument_list|,
name|i
argument_list|,
name|STAT_NAME_COL
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|np
argument_list|,
name|Buf
argument_list|,
name|STAT_NAME_LEN
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|np
operator|=
name|Monitor
init|;
name|np
operator|<
name|End_monitor
condition|;
name|np
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|np
argument_list|,
name|i
argument_list|,
name|STAT_NAME_COL
argument_list|)
expr_stmt|;
name|outstr
argument_list|(
name|np
argument_list|,
name|Buf
argument_list|,
name|STAT_NAME_LEN
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Erase the last monitor */
name|i
operator|=
name|STAT_MON_ROW
operator|+
literal|1
operator|+
operator|(
name|End_monitor
operator|-
name|Monitor
operator|)
expr_stmt|;
for|for
control|(
name|np
operator|=
name|Player
init|;
name|np
operator|<
name|End_player
condition|;
name|np
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|np
argument_list|,
name|i
argument_list|,
name|STAT_NAME_COL
argument_list|)
expr_stmt|;
name|ce
argument_list|(
name|np
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|np
operator|=
name|Monitor
init|;
name|np
operator|<
name|End_monitor
condition|;
name|np
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|np
argument_list|,
name|i
argument_list|,
name|STAT_NAME_COL
argument_list|)
expr_stmt|;
name|ce
argument_list|(
name|np
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
endif|MONITOR
name|Fds_mask
operator|&=
operator|~
name|savemask
expr_stmt|;
if|if
condition|(
name|Num_fds
operator|==
name|savefd
operator|+
literal|1
condition|)
block|{
name|Num_fds
operator|=
name|Socket
expr_stmt|;
ifdef|#
directive|ifdef
name|INTERNET
if|if
condition|(
name|Test_socket
operator|>
name|Socket
condition|)
name|Num_fds
operator|=
name|Test_socket
expr_stmt|;
endif|#
directive|endif
endif|INTERNET
for|for
control|(
name|np
operator|=
name|Player
init|;
name|np
operator|<
name|End_player
condition|;
name|np
operator|++
control|)
if|if
condition|(
name|np
operator|->
name|p_fd
operator|>
name|Num_fds
condition|)
name|Num_fds
operator|=
name|np
operator|->
name|p_fd
expr_stmt|;
ifdef|#
directive|ifdef
name|MONITOR
for|for
control|(
name|np
operator|=
name|Monitor
init|;
name|np
operator|<
name|End_monitor
condition|;
name|np
operator|++
control|)
if|if
condition|(
name|np
operator|->
name|p_fd
operator|>
name|Num_fds
condition|)
name|Num_fds
operator|=
name|np
operator|->
name|p_fd
expr_stmt|;
endif|#
directive|endif
endif|MONITOR
name|Num_fds
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * rand_num:  *	Return a random number in a given range.  */
end_comment

begin_macro
name|rand_num
argument_list|(
argument|range
argument_list|)
end_macro

begin_decl_stmt
name|int
name|range
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|range
operator|==
literal|0
condition|?
literal|0
else|:
name|RN
operator|%
name|range
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * havechar:  *	Check to see if we have any characters in the input queue; if  *	we do, read them, stash them away, and return TRUE; else return  *	FALSE.  */
end_comment

begin_expr_stmt
name|havechar
argument_list|(
name|pp
argument_list|)
specifier|register
name|PLAYER
operator|*
name|pp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|extern
name|int
name|errno
decl_stmt|;
if|if
condition|(
name|pp
operator|->
name|p_ncount
operator|<
name|pp
operator|->
name|p_nchar
condition|)
return|return
name|TRUE
return|;
if|if
condition|(
operator|!
operator|(
name|Have_inp
operator|&
name|pp
operator|->
name|p_mask
operator|)
condition|)
return|return
name|FALSE
return|;
name|Have_inp
operator|&=
operator|~
name|pp
operator|->
name|p_mask
expr_stmt|;
name|check_again
label|:
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|pp
operator|->
name|p_nchar
operator|=
name|read
argument_list|(
name|pp
operator|->
name|p_fd
argument_list|,
name|pp
operator|->
name|p_cbuf
argument_list|,
sizeof|sizeof
name|pp
operator|->
name|p_cbuf
argument_list|)
operator|)
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINTR
condition|)
goto|goto
name|check_again
goto|;
name|pp
operator|->
name|p_cbuf
index|[
literal|0
index|]
operator|=
literal|'q'
expr_stmt|;
block|}
name|pp
operator|->
name|p_ncount
operator|=
literal|0
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_block

begin_comment
comment|/*  * cleanup:  *	Exit with the given value, cleaning up any droppings lying around  */
end_comment

begin_macro
name|cleanup
argument_list|(
argument|eval
argument_list|)
end_macro

begin_decl_stmt
name|int
name|eval
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|PLAYER
modifier|*
name|pp
decl_stmt|;
for|for
control|(
name|pp
operator|=
name|Player
init|;
name|pp
operator|<
name|End_player
condition|;
name|pp
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|pp
argument_list|,
name|HEIGHT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sendcom
argument_list|(
name|pp
argument_list|,
name|ENDWIN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putc
argument_list|(
name|LAST_PLAYER
argument_list|,
name|pp
operator|->
name|p_output
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|pp
operator|->
name|p_output
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MONITOR
for|for
control|(
name|pp
operator|=
name|Monitor
init|;
name|pp
operator|<
name|End_monitor
condition|;
name|pp
operator|++
control|)
block|{
name|cgoto
argument_list|(
name|pp
argument_list|,
name|HEIGHT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sendcom
argument_list|(
name|pp
argument_list|,
name|ENDWIN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putc
argument_list|(
name|LAST_PLAYER
argument_list|,
name|pp
operator|->
name|p_output
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|pp
operator|->
name|p_output
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|MONITOR
operator|(
name|void
operator|)
name|close
argument_list|(
name|Socket
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AF_UNIX_HACK
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|Sock_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|AF_UNIX_HACK
name|exit
argument_list|(
name|eval
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


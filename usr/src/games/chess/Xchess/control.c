begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* This file contains code for X-CHESS.    Copyright (C) 1986 Free Software Foundation, Inc.  This file is part of X-CHESS.  X-CHESS is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the X-CHESS General Public License for full details.  Everyone is granted permission to copy, modify and redistribute X-CHESS, but only under the conditions described in the X-CHESS General Public License.   A copy of this license is supposed to have been given to you along with X-CHESS so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* RCS Info: $Revision: 1.4 $ on $Date: 86/11/23 17:17:32 $  *           $Source: /users/faustus/xchess/RCS/control.c,v $  * Copyright (c) 1986 Wayne A. Christopher, U. C. Berkeley CAD Group  *	Permission is granted to do anything with this code except sell it  *	or remove this message.  *  * Deal with input from the user.  */
end_comment

begin_include
include|#
directive|include
file|"xchess.h"
end_include

begin_decl_stmt
name|move
modifier|*
name|moves
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|move
modifier|*
name|foremoves
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|color
name|nexttomove
init|=
name|WHITE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bool
name|noisyflag
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|move
modifier|*
name|lastmove
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|move
modifier|*
name|thismove
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|screen_move
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|void
name|button_pressed
parameter_list|(
name|event
parameter_list|,
name|win
parameter_list|)
name|XEvent
modifier|*
name|event
decl_stmt|;
name|windata
modifier|*
name|win
decl_stmt|;
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|XKeyEvent
modifier|*
name|ev
init|=
operator|(
name|XKeyEvent
operator|*
operator|)
name|event
decl_stmt|;
if|if
condition|(
operator|!
name|oneboard
operator|&&
operator|(
name|win
operator|->
name|color
operator|!=
name|nexttomove
operator|)
condition|)
block|{
name|message_add
argument_list|(
name|win
argument_list|,
literal|"Wrong player!\n"
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|progflag
operator|&&
operator|(
name|nexttomove
operator|==
operator|(
name|blackflag
condition|?
name|WHITE
else|:
name|BLACK
operator|)
operator|)
condition|)
block|{
name|message_add
argument_list|(
name|win
argument_list|,
literal|"Wait for the computer...\n"
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|loading_flag
condition|)
block|{
name|message_add
argument_list|(
name|win
argument_list|,
literal|"You'd better not do that now...\n"
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Figure out what piece he is pointing at. */
name|x
operator|=
name|ev
operator|->
name|x
operator|/
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
expr_stmt|;
name|y
operator|=
name|ev
operator|->
name|y
operator|/
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
expr_stmt|;
if|if
condition|(
name|win
operator|->
name|flipped
condition|)
block|{
name|y
operator|=
name|SIZE
operator|-
name|y
operator|-
literal|1
expr_stmt|;
name|x
operator|=
name|SIZE
operator|-
name|x
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|x
operator|<
literal|0
operator|)
operator|||
operator|(
name|x
operator|>=
name|SIZE
operator|)
operator|||
operator|(
name|y
operator|<
literal|0
operator|)
operator|||
operator|(
name|y
operator|>=
name|SIZE
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad coords (%d, %d)\n"
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneboard
operator|&&
operator|(
name|chessboard
operator|->
name|square
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|color
operator|!=
name|nexttomove
operator|)
condition|)
block|{
name|message_add
argument_list|(
name|win
argument_list|,
literal|"Wrong player!\n"
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
operator|!
name|oneboard
operator|&&
operator|(
name|chessboard
operator|->
name|square
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|color
operator|!=
name|win
operator|->
name|color
operator|)
condition|)
block|{
name|message_add
argument_list|(
name|win
argument_list|,
literal|"Can't move that\n"
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return;
block|}
name|thismove
operator|=
name|alloc
argument_list|(
name|move
argument_list|)
expr_stmt|;
name|thismove
operator|->
name|fromx
operator|=
name|x
expr_stmt|;
name|thismove
operator|->
name|fromy
operator|=
name|y
expr_stmt|;
name|thismove
operator|->
name|piece
operator|.
name|color
operator|=
name|chessboard
operator|->
name|square
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|color
expr_stmt|;
name|thismove
operator|->
name|piece
operator|.
name|type
operator|=
name|chessboard
operator|->
name|square
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|type
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s selected his %s at (%d, %d)...\n"
argument_list|,
name|colornames
index|[
operator|(
name|int
operator|)
name|thismove
operator|->
name|piece
operator|.
name|color
index|]
argument_list|,
name|piecenames
index|[
operator|(
name|int
operator|)
name|thismove
operator|->
name|piece
operator|.
name|type
index|]
argument_list|,
name|thismove
operator|->
name|fromy
argument_list|,
name|thismove
operator|->
name|fromx
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|button_released
parameter_list|(
name|event
parameter_list|,
name|win
parameter_list|)
name|XEvent
modifier|*
name|event
decl_stmt|;
name|windata
modifier|*
name|win
decl_stmt|;
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|XKeyEvent
modifier|*
name|ev
init|=
operator|(
name|XKeyEvent
operator|*
operator|)
name|event
decl_stmt|;
if|if
condition|(
operator|!
name|thismove
condition|)
block|{
comment|/* fprintf(stderr, "Error: button hasn't been pressed\n"); */
return|return;
block|}
if|if
condition|(
name|loading_flag
condition|)
return|return;
comment|/* Figure out what piece he is pointing at. */
name|x
operator|=
name|ev
operator|->
name|x
operator|/
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
expr_stmt|;
name|y
operator|=
name|ev
operator|->
name|y
operator|/
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
expr_stmt|;
if|if
condition|(
name|win
operator|->
name|flipped
condition|)
block|{
name|y
operator|=
name|SIZE
operator|-
name|y
operator|-
literal|1
expr_stmt|;
name|x
operator|=
name|SIZE
operator|-
name|x
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|x
operator|<
literal|0
operator|)
operator|||
operator|(
name|x
operator|>=
name|SIZE
operator|)
operator|||
operator|(
name|y
operator|<
literal|0
operator|)
operator|||
operator|(
name|y
operator|>=
name|SIZE
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad coords (%d, %d)\n"
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|thismove
operator|->
name|fromx
operator|==
name|x
operator|)
operator|&&
operator|(
name|thismove
operator|->
name|fromy
operator|==
name|y
operator|)
condition|)
block|{
name|message_add
argument_list|(
name|win
argument_list|,
literal|"Hey, you touch it, you move it, buddy.\n"
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|chessboard
operator|->
name|square
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|color
operator|==
name|thismove
operator|->
name|piece
operator|.
name|color
condition|)
block|{
name|message_add
argument_list|(
name|win
argument_list|,
literal|"Can't put one piece on top of another\n"
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return;
block|}
name|thismove
operator|->
name|tox
operator|=
name|x
expr_stmt|;
name|thismove
operator|->
name|toy
operator|=
name|y
expr_stmt|;
name|thismove
operator|->
name|taken
operator|.
name|color
operator|=
name|chessboard
operator|->
name|square
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|color
expr_stmt|;
name|thismove
operator|->
name|taken
operator|.
name|type
operator|=
name|chessboard
operator|->
name|square
index|[
name|y
index|]
index|[
name|x
index|]
operator|.
name|type
expr_stmt|;
if|if
condition|(
name|thismove
operator|->
name|taken
operator|.
name|color
operator|!=
name|NONE
condition|)
name|thismove
operator|->
name|type
operator|=
name|CAPTURE
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|thismove
operator|->
name|piece
operator|.
name|type
operator|==
name|KING
operator|)
operator|&&
operator|(
name|thismove
operator|->
name|fromx
operator|==
literal|4
operator|)
operator|&&
operator|(
name|thismove
operator|->
name|tox
operator|==
literal|6
operator|)
operator|&&
operator|(
name|thismove
operator|->
name|toy
operator|==
name|thismove
operator|->
name|fromy
operator|)
condition|)
name|thismove
operator|->
name|type
operator|=
name|KCASTLE
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|thismove
operator|->
name|piece
operator|.
name|type
operator|==
name|KING
operator|)
operator|&&
operator|(
name|thismove
operator|->
name|tox
operator|==
literal|2
operator|)
operator|&&
operator|(
name|thismove
operator|->
name|fromx
operator|==
literal|4
operator|)
operator|&&
operator|(
name|thismove
operator|->
name|toy
operator|==
name|thismove
operator|->
name|fromy
operator|)
condition|)
name|thismove
operator|->
name|type
operator|=
name|QCASTLE
expr_stmt|;
else|else
name|thismove
operator|->
name|type
operator|=
name|MOVE
expr_stmt|;
comment|/* Now check the en-passant case... */
if|if
condition|(
operator|(
name|thismove
operator|->
name|type
operator|==
name|MOVE
operator|)
operator|&&
operator|(
operator|(
name|thismove
operator|->
name|tox
operator|==
name|thismove
operator|->
name|fromx
operator|+
literal|1
operator|)
operator|||
operator|(
name|thismove
operator|->
name|tox
operator|==
name|thismove
operator|->
name|fromx
operator|-
literal|1
operator|)
operator|)
operator|&&
operator|(
name|thismove
operator|->
name|piece
operator|.
name|type
operator|==
name|PAWN
operator|)
operator|&&
name|lastmove
operator|&&
operator|(
name|lastmove
operator|->
name|tox
operator|==
name|lastmove
operator|->
name|fromx
operator|)
operator|&&
operator|(
name|lastmove
operator|->
name|fromx
operator|==
name|thismove
operator|->
name|tox
operator|)
operator|&&
operator|(
operator|(
name|lastmove
operator|->
name|fromy
operator|+
name|lastmove
operator|->
name|toy
operator|)
operator|/
literal|2
operator|==
name|thismove
operator|->
name|toy
operator|)
condition|)
block|{
name|thismove
operator|->
name|type
operator|=
name|CAPTURE
expr_stmt|;
name|thismove
operator|->
name|enpassant
operator|=
name|true
expr_stmt|;
name|thismove
operator|->
name|taken
operator|=
name|lastmove
operator|->
name|piece
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|valid_move
argument_list|(
name|thismove
argument_list|,
name|chessboard
argument_list|)
condition|)
block|{
name|message_add
argument_list|(
name|win
argument_list|,
literal|"Invalid move.\n"
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t... and moved it to (%d, %d), type %s\n"
argument_list|,
name|thismove
operator|->
name|toy
argument_list|,
name|thismove
operator|->
name|tox
argument_list|,
name|movetypenames
index|[
operator|(
name|int
operator|)
name|thismove
operator|->
name|type
index|]
argument_list|)
expr_stmt|;
name|move_piece
argument_list|(
name|thismove
argument_list|)
expr_stmt|;
if|if
condition|(
name|thismove
operator|->
name|check
condition|)
block|{
name|message_add
argument_list|(
name|win1
argument_list|,
literal|"Check.\n"
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|message_add
argument_list|(
name|win2
argument_list|,
literal|"Check.\n"
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|moves
condition|)
name|moves
operator|=
name|lastmove
operator|=
name|thismove
expr_stmt|;
else|else
name|lastmove
operator|=
name|lastmove
operator|->
name|next
operator|=
name|thismove
expr_stmt|;
if|if
condition|(
name|progflag
condition|)
name|program_send
argument_list|(
name|thismove
argument_list|)
expr_stmt|;
name|thismove
operator|=
name|NULL
expr_stmt|;
name|nexttomove
operator|=
operator|(
operator|(
name|nexttomove
operator|==
name|WHITE
operator|)
condition|?
name|BLACK
else|:
name|WHITE
operator|)
expr_stmt|;
name|clock_switch
argument_list|()
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|prog_move
parameter_list|(
name|m
parameter_list|)
name|move
modifier|*
name|m
decl_stmt|;
block|{
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"program moves from (%d, %d) to (%d, %d)\n"
argument_list|,
name|m
operator|->
name|fromy
argument_list|,
name|m
operator|->
name|fromx
argument_list|,
name|m
operator|->
name|toy
argument_list|,
name|m
operator|->
name|tox
argument_list|)
expr_stmt|;
name|move_piece
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|moves
condition|)
name|moves
operator|=
name|lastmove
operator|=
name|m
expr_stmt|;
else|else
name|lastmove
operator|=
name|lastmove
operator|->
name|next
operator|=
name|m
expr_stmt|;
name|nexttomove
operator|=
operator|(
operator|(
name|nexttomove
operator|==
name|WHITE
operator|)
condition|?
name|BLACK
else|:
name|WHITE
operator|)
expr_stmt|;
name|clock_switch
argument_list|()
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|move_piece
parameter_list|(
name|m
parameter_list|)
name|move
modifier|*
name|m
decl_stmt|;
block|{
comment|/* Update the screen... */
name|screen_move
argument_list|(
name|m
argument_list|)
expr_stmt|;
comment|/* Move the piece on the board... */
name|board_move
argument_list|(
name|chessboard
argument_list|,
name|m
argument_list|)
expr_stmt|;
comment|/* And record it... */
name|record_move
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|noisyflag
condition|)
block|{
name|XBell
argument_list|(
name|win1
operator|->
name|display
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|XBell
argument_list|(
name|win2
operator|->
name|display
argument_list|,
literal|50
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|screen_move
parameter_list|(
name|m
parameter_list|)
name|move
modifier|*
name|m
decl_stmt|;
block|{
name|piece
name|pp
decl_stmt|;
switch|switch
condition|(
name|m
operator|->
name|type
condition|)
block|{
case|case
name|CAPTURE
case|:
name|jail_add
argument_list|(
operator|&
name|m
operator|->
name|taken
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|MOVE
case|:
name|win_erasepiece
argument_list|(
name|m
operator|->
name|fromy
argument_list|,
name|m
operator|->
name|fromx
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|win_flashmove
condition|)
name|win_flash
argument_list|(
name|m
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
name|m
operator|->
name|toy
argument_list|,
name|m
operator|->
name|tox
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|enpassant
condition|)
name|win_erasepiece
argument_list|(
name|m
operator|->
name|toy
operator|+
operator|(
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
operator|)
condition|?
literal|1
else|:
operator|-
literal|1
operator|)
argument_list|,
name|m
operator|->
name|tox
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|win_erasepiece
argument_list|(
name|m
operator|->
name|fromy
argument_list|,
name|m
operator|->
name|fromx
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|win_flashmove
condition|)
name|win_flash
argument_list|(
name|m
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
name|m
operator|->
name|toy
argument_list|,
name|m
operator|->
name|tox
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|enpassant
condition|)
name|win_erasepiece
argument_list|(
name|m
operator|->
name|toy
operator|+
operator|(
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
operator|)
condition|?
literal|1
else|:
operator|-
literal|1
operator|)
argument_list|,
name|m
operator|->
name|tox
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|m
operator|->
name|piece
operator|.
name|type
operator|==
name|PAWN
operator|)
operator|&&
operator|(
operator|(
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|BLACK
operator|)
operator|&&
operator|(
name|m
operator|->
name|toy
operator|==
literal|7
operator|)
operator|)
operator|||
operator|(
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
operator|)
operator|&&
operator|(
name|m
operator|->
name|toy
operator|==
literal|0
operator|)
operator|)
operator|)
condition|)
block|{
name|pp
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|pp
operator|.
name|type
operator|=
name|QUEEN
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|pp
argument_list|,
name|m
operator|->
name|toy
argument_list|,
name|m
operator|->
name|tox
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
name|m
operator|->
name|toy
argument_list|,
name|m
operator|->
name|tox
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|KCASTLE
case|:
if|if
condition|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
condition|)
block|{
name|win_erasepiece
argument_list|(
literal|7
argument_list|,
literal|4
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_erasepiece
argument_list|(
literal|7
argument_list|,
literal|7
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|win_flashmove
condition|)
name|win_flash
argument_list|(
name|m
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
literal|7
argument_list|,
literal|6
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|7
index|]
argument_list|,
literal|7
argument_list|,
literal|5
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|win_erasepiece
argument_list|(
literal|7
argument_list|,
literal|4
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_erasepiece
argument_list|(
literal|7
argument_list|,
literal|7
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|win_flashmove
condition|)
name|win_flash
argument_list|(
name|m
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
literal|7
argument_list|,
literal|6
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|7
index|]
argument_list|,
literal|7
argument_list|,
literal|5
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|win_erasepiece
argument_list|(
literal|0
argument_list|,
literal|4
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_erasepiece
argument_list|(
literal|0
argument_list|,
literal|7
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|win_flashmove
condition|)
name|win_flash
argument_list|(
name|m
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|7
index|]
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|win_erasepiece
argument_list|(
literal|0
argument_list|,
literal|4
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_erasepiece
argument_list|(
literal|0
argument_list|,
literal|7
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|win_flashmove
condition|)
name|win_flash
argument_list|(
name|m
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|7
index|]
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|QCASTLE
case|:
if|if
condition|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
condition|)
block|{
name|win_erasepiece
argument_list|(
literal|7
argument_list|,
literal|4
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_erasepiece
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|win_flashmove
condition|)
name|win_flash
argument_list|(
name|m
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
literal|7
argument_list|,
literal|2
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|0
index|]
argument_list|,
literal|7
argument_list|,
literal|3
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|win_erasepiece
argument_list|(
literal|7
argument_list|,
literal|4
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_erasepiece
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|win_flashmove
condition|)
name|win_flash
argument_list|(
name|m
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
literal|7
argument_list|,
literal|2
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|7
index|]
argument_list|,
literal|7
argument_list|,
literal|3
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|win_erasepiece
argument_list|(
literal|0
argument_list|,
literal|4
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_erasepiece
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|win_flashmove
condition|)
name|win_flash
argument_list|(
name|m
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|win_erasepiece
argument_list|(
literal|0
argument_list|,
literal|4
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_erasepiece
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|win_flashmove
condition|)
name|win_flash
argument_list|(
name|m
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|m
operator|->
name|piece
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|7
index|]
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad move type %d\n"
argument_list|,
name|m
operator|->
name|type
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* Retract the last move made... */
end_comment

begin_function
name|void
name|replay
parameter_list|()
block|{
name|move
modifier|*
name|m
init|=
name|lastmove
decl_stmt|,
name|bm
decl_stmt|;
name|memset
argument_list|(
operator|&
name|bm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bm
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|m
operator|->
name|type
condition|)
block|{
case|case
name|MOVE
case|:
name|bm
operator|.
name|type
operator|=
name|MOVE
expr_stmt|;
name|bm
operator|.
name|piece
operator|=
name|m
operator|->
name|piece
expr_stmt|;
name|bm
operator|.
name|fromx
operator|=
name|m
operator|->
name|tox
expr_stmt|;
name|bm
operator|.
name|fromy
operator|=
name|m
operator|->
name|toy
expr_stmt|;
name|bm
operator|.
name|tox
operator|=
name|m
operator|->
name|fromx
expr_stmt|;
name|bm
operator|.
name|toy
operator|=
name|m
operator|->
name|fromy
expr_stmt|;
name|board_move
argument_list|(
name|chessboard
argument_list|,
operator|&
name|bm
argument_list|)
expr_stmt|;
name|screen_move
argument_list|(
operator|&
name|bm
argument_list|)
expr_stmt|;
break|break;
case|case
name|CAPTURE
case|:
name|bm
operator|.
name|type
operator|=
name|MOVE
expr_stmt|;
name|bm
operator|.
name|piece
operator|=
name|m
operator|->
name|piece
expr_stmt|;
name|bm
operator|.
name|fromx
operator|=
name|m
operator|->
name|tox
expr_stmt|;
name|bm
operator|.
name|fromy
operator|=
name|m
operator|->
name|toy
expr_stmt|;
name|bm
operator|.
name|tox
operator|=
name|m
operator|->
name|fromx
expr_stmt|;
name|bm
operator|.
name|toy
operator|=
name|m
operator|->
name|fromy
expr_stmt|;
name|board_move
argument_list|(
name|chessboard
argument_list|,
operator|&
name|bm
argument_list|)
expr_stmt|;
name|screen_move
argument_list|(
operator|&
name|bm
argument_list|)
expr_stmt|;
name|chessboard
operator|->
name|square
index|[
name|m
operator|->
name|toy
index|]
index|[
name|m
operator|->
name|tox
index|]
operator|=
name|m
operator|->
name|taken
expr_stmt|;
name|bm
operator|.
name|piece
operator|=
name|m
operator|->
name|taken
expr_stmt|;
name|bm
operator|.
name|fromx
operator|=
name|bm
operator|.
name|tox
operator|=
name|m
operator|->
name|tox
expr_stmt|;
name|bm
operator|.
name|fromy
operator|=
name|bm
operator|.
name|toy
operator|=
name|m
operator|->
name|toy
expr_stmt|;
name|screen_move
argument_list|(
operator|&
name|bm
argument_list|)
expr_stmt|;
name|jail_remove
argument_list|(
operator|&
name|m
operator|->
name|taken
argument_list|)
expr_stmt|;
break|break;
case|case
name|KCASTLE
case|:
name|bm
operator|.
name|type
operator|=
name|MOVE
expr_stmt|;
name|bm
operator|.
name|piece
operator|.
name|type
operator|=
name|KING
expr_stmt|;
name|bm
operator|.
name|piece
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|bm
operator|.
name|fromx
operator|=
literal|6
expr_stmt|;
name|bm
operator|.
name|tox
operator|=
literal|4
expr_stmt|;
name|bm
operator|.
name|fromy
operator|=
name|bm
operator|.
name|toy
operator|=
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
operator|)
condition|?
literal|7
else|:
literal|0
expr_stmt|;
name|board_move
argument_list|(
name|chessboard
argument_list|,
operator|&
name|bm
argument_list|)
expr_stmt|;
name|screen_move
argument_list|(
operator|&
name|bm
argument_list|)
expr_stmt|;
name|bm
operator|.
name|type
operator|=
name|MOVE
expr_stmt|;
name|bm
operator|.
name|piece
operator|.
name|type
operator|=
name|ROOK
expr_stmt|;
name|bm
operator|.
name|piece
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|bm
operator|.
name|fromx
operator|=
literal|5
expr_stmt|;
name|bm
operator|.
name|tox
operator|=
literal|7
expr_stmt|;
name|bm
operator|.
name|fromy
operator|=
name|bm
operator|.
name|toy
operator|=
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
operator|)
condition|?
literal|7
else|:
literal|0
expr_stmt|;
name|board_move
argument_list|(
name|chessboard
argument_list|,
operator|&
name|bm
argument_list|)
expr_stmt|;
name|screen_move
argument_list|(
operator|&
name|bm
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
condition|)
name|chessboard
operator|->
name|white_cant_castle_k
operator|=
name|false
expr_stmt|;
else|else
name|chessboard
operator|->
name|black_cant_castle_k
operator|=
name|false
expr_stmt|;
break|break;
case|case
name|QCASTLE
case|:
name|bm
operator|.
name|type
operator|=
name|MOVE
expr_stmt|;
name|bm
operator|.
name|piece
operator|.
name|type
operator|=
name|KING
expr_stmt|;
name|bm
operator|.
name|piece
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|bm
operator|.
name|fromx
operator|=
literal|2
expr_stmt|;
name|bm
operator|.
name|tox
operator|=
literal|4
expr_stmt|;
name|bm
operator|.
name|fromy
operator|=
name|bm
operator|.
name|toy
operator|=
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
operator|)
condition|?
literal|7
else|:
literal|0
expr_stmt|;
name|board_move
argument_list|(
name|chessboard
argument_list|,
operator|&
name|bm
argument_list|)
expr_stmt|;
name|screen_move
argument_list|(
operator|&
name|bm
argument_list|)
expr_stmt|;
name|bm
operator|.
name|type
operator|=
name|MOVE
expr_stmt|;
name|bm
operator|.
name|piece
operator|.
name|type
operator|=
name|ROOK
expr_stmt|;
name|bm
operator|.
name|piece
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|bm
operator|.
name|fromx
operator|=
literal|3
expr_stmt|;
name|bm
operator|.
name|tox
operator|=
literal|0
expr_stmt|;
name|bm
operator|.
name|fromy
operator|=
name|bm
operator|.
name|toy
operator|=
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
operator|)
condition|?
literal|7
else|:
literal|0
expr_stmt|;
name|board_move
argument_list|(
name|chessboard
argument_list|,
operator|&
name|bm
argument_list|)
expr_stmt|;
name|screen_move
argument_list|(
operator|&
name|bm
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
condition|)
name|chessboard
operator|->
name|white_cant_castle_q
operator|=
name|false
expr_stmt|;
else|else
name|chessboard
operator|->
name|black_cant_castle_q
operator|=
name|false
expr_stmt|;
break|break;
block|}
name|record_back
argument_list|()
expr_stmt|;
name|nexttomove
operator|=
operator|(
operator|(
name|nexttomove
operator|==
name|WHITE
operator|)
condition|?
name|BLACK
else|:
name|WHITE
operator|)
expr_stmt|;
name|clock_switch
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|moves
operator|->
name|next
condition|)
block|{
name|moves
operator|->
name|next
operator|=
name|foremoves
expr_stmt|;
name|foremoves
operator|=
name|moves
expr_stmt|;
name|moves
operator|=
name|lastmove
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|m
operator|=
name|moves
init|;
name|m
operator|->
name|next
condition|;
name|m
operator|=
name|m
operator|->
name|next
control|)
name|lastmove
operator|=
name|m
expr_stmt|;
name|lastmove
operator|->
name|next
operator|->
name|next
operator|=
name|foremoves
expr_stmt|;
name|foremoves
operator|=
name|lastmove
operator|->
name|next
expr_stmt|;
name|lastmove
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|progflag
condition|)
name|program_undo
argument_list|()
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* Put back the last move undone. */
end_comment

begin_function
name|void
name|forward
parameter_list|()
block|{
name|prog_move
argument_list|(
name|foremoves
argument_list|)
expr_stmt|;
name|foremoves
operator|=
name|foremoves
operator|->
name|next
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* End the game. */
end_comment

begin_function
name|void
name|cleanup
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
if|if
condition|(
name|progflag
condition|)
name|program_end
argument_list|()
expr_stmt|;
name|record_end
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|XSync
argument_list|(
name|win1
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|XSync
argument_list|(
name|win2
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|restart
parameter_list|()
block|{
name|moves
operator|=
name|lastmove
operator|=
name|thismove
operator|=
name|NULL
expr_stmt|;
name|nexttomove
operator|=
name|WHITE
expr_stmt|;
name|clock_init
argument_list|(
name|win1
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|clock_init
argument_list|(
name|win1
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|jail_init
argument_list|(
name|win1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|clock_init
argument_list|(
name|win2
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|clock_init
argument_list|(
name|win2
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
name|jail_init
argument_list|(
name|win2
argument_list|)
expr_stmt|;
block|}
name|board_init
argument_list|(
name|chessboard
argument_list|)
expr_stmt|;
name|win_restart
argument_list|()
expr_stmt|;
name|record_reset
argument_list|()
expr_stmt|;
if|if
condition|(
name|progflag
condition|)
block|{
name|program_end
argument_list|()
expr_stmt|;
name|program_init
argument_list|(
name|progname
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

end_unit


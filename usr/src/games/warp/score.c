begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Header: /usr/src/games/warp/RCS/score.c,v 1.1 87/07/03 02:13:26 games Exp $ */
end_comment

begin_comment
comment|/* $Log:	score.c,v $  * Revision 7.0.1.2a  87/07/03  02:13:26  games  * Fixed numerous long vs. int bugs in printfs, etc.  *   * Revision 7.0.1.2  86/10/20  12:06:56  lwall  * Made all exits reset tty.  *   * Revision 7.0.1.1  86/10/16  10:52:47  lwall  * Added Damage.  Fixed random bugs.  *   * Revision 7.0  86/10/08  15:13:14  lwall  * Split into separate files.  Added amoebas and pirates.  *   */
end_comment

begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_include
include|#
directive|include
file|"warp.h"
end_include

begin_include
include|#
directive|include
file|"intrp.h"
end_include

begin_include
include|#
directive|include
file|"object.h"
end_include

begin_include
include|#
directive|include
file|"play.h"
end_include

begin_include
include|#
directive|include
file|"sig.h"
end_include

begin_include
include|#
directive|include
file|"term.h"
end_include

begin_include
include|#
directive|include
file|"us.h"
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"weapon.h"
end_include

begin_include
include|#
directive|include
file|"INTERN.h"
end_include

begin_include
include|#
directive|include
file|"score.h"
end_include

begin_function
name|void
name|score_init
parameter_list|()
block|{
name|Reg1
name|char
modifier|*
name|s
decl_stmt|;
name|Reg2
name|int
name|i
decl_stmt|;
name|FILE
modifier|*
name|savfil
decl_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|SAVEDIR
argument_list|,
operator|&
name|filestat
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Cannot access %s\r\n"
argument_list|,
name|SAVEDIR
argument_list|)
expr_stmt|;
name|finalize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|filestat
operator|.
name|st_uid
operator|!=
name|geteuid
argument_list|()
condition|)
block|{
name|printf
argument_list|(
literal|"Warp will not run right without being setuid.\r\n"
argument_list|)
expr_stmt|;
name|finalize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|filestat
operator|.
name|st_mode
operator|&
literal|0605
operator|)
operator|!=
literal|0605
condition|)
block|{
name|printf
argument_list|(
literal|"%s is not protected correctly (must be u+rw o+rx).\r\n"
argument_list|,
name|SAVEDIR
argument_list|)
expr_stmt|;
name|finalize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SCOREFULL
name|interp
argument_list|(
name|longlognam
argument_list|,
sizeof|sizeof
name|longlognam
argument_list|,
literal|"%N"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|strlen
argument_list|(
name|longlognam
argument_list|)
init|;
name|i
operator|<
literal|24
condition|;
name|i
operator|++
control|)
name|longlognam
index|[
name|i
index|]
operator|=
literal|' '
expr_stmt|;
comment|/* make sure it is 24 long for strncmp */
name|longlognam
index|[
literal|24
index|]
operator|=
literal|'\0'
expr_stmt|;
else|#
directive|else
name|interp
argument_list|(
name|longlognam
argument_list|,
sizeof|sizeof
name|longlognam
argument_list|,
literal|"%L"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|strlen
argument_list|(
name|longlognam
argument_list|)
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|longlognam
index|[
name|i
index|]
operator|=
literal|' '
expr_stmt|;
comment|/* make sure it is 8 long for strncmp */
name|longlognam
index|[
literal|8
index|]
operator|=
literal|'\0'
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|scorespec
condition|)
name|wscore
argument_list|()
expr_stmt|;
name|Sprintf
argument_list|(
name|savefilename
argument_list|,
literal|"save.%s"
argument_list|,
name|logname
argument_list|)
expr_stmt|;
name|savfil
operator|=
name|experimenting
condition|?
name|NULL
else|:
name|fopen
argument_list|(
name|savefilename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|savfil
operator|!=
name|NULL
operator|&&
name|fgets
argument_list|(
name|spbuf
argument_list|,
literal|100
argument_list|,
name|savfil
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|char
name|tmpbuf
index|[
literal|80
index|]
decl_stmt|;
name|spbuf
index|[
name|strlen
argument_list|(
name|spbuf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|tmpbuf
argument_list|,
literal|80
argument_list|,
name|savfil
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|int
name|processnum
decl_stmt|;
name|tmpbuf
index|[
name|strlen
argument_list|(
name|tmpbuf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|"You seem to have left a game %s.\r\n"
argument_list|,
name|tmpbuf
operator|+
literal|9
argument_list|)
expr_stmt|;
name|s
operator|=
name|index
argument_list|(
name|tmpbuf
operator|+
literal|9
argument_list|,
literal|','
argument_list|)
expr_stmt|;
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
name|processnum
operator|=
name|atoi
argument_list|(
name|s
operator|+
literal|11
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill
argument_list|(
name|processnum
argument_list|,
name|SIGINT
argument_list|)
condition|)
block|{
comment|/* does process not exist? */
comment|/* (warp ignores SIGINT) */
name|printf
argument_list|(
literal|"\r\n\ That process does not seem to exist anymore, so you'll have to start the\r\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"last wave over.\r\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                      [type anything to continue]"
argument_list|)
expr_stmt|;
name|Fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|eat_typeahead
argument_list|()
expr_stmt|;
name|getcmd
argument_list|(
name|tmpbuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|tmpbuf
operator|==
name|INTRCH
condition|)
name|finalize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|term
operator|+
literal|8
argument_list|,
name|tmpbuf
operator|+
literal|23
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"That is not your current terminal--you are on %s.\r\n"
argument_list|,
name|term
operator|+
literal|5
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\r\nYour options:\r\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   1) Exit and find the terminal it's running on\r\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\r\nYour options:\r\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   1) Exit and try to foreground it\r\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"   2) Let me terminate the other game\r\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"What do you want to do? "
argument_list|)
expr_stmt|;
name|Fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|eat_typeahead
argument_list|()
expr_stmt|;
name|getcmd
argument_list|(
name|tmpbuf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|tmpbuf
operator|==
name|INTRCH
condition|)
name|finalize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|tmpbuf
operator|==
literal|'1'
condition|)
block|{
name|printf
argument_list|(
literal|"If you don't succeed, come back and do option 2 instead.  Good luck.\r\n"
argument_list|)
expr_stmt|;
name|finalize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Ok, hang on a few moments \r\n"
argument_list|)
expr_stmt|;
name|Fclose
argument_list|(
name|savfil
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill
argument_list|(
name|processnum
argument_list|,
name|SIGQUIT
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to kill process #%d!\r\n"
argument_list|,
name|processnum
argument_list|)
expr_stmt|;
name|roundsleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|SIGCONT
name|kill
argument_list|(
name|processnum
argument_list|,
name|SIGCONT
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|15
init|;
name|i
condition|;
operator|--
name|i
control|)
block|{
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill
argument_list|(
name|processnum
argument_list|,
name|SIGINT
argument_list|)
condition|)
comment|/* does process not exist? */
comment|/* (warp ignores SIGINT) */
break|break;
block|}
name|didkill
operator|++
expr_stmt|;
block|}
name|savfil
operator|=
name|fopen
argument_list|(
name|savefilename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|savfil
operator|!=
name|NULL
condition|)
block|{
name|Fgets
argument_list|(
name|spbuf
argument_list|,
literal|100
argument_list|,
name|savfil
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
name|savfil
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|savfil
operator|==
name|NULL
condition|)
block|{
name|totalscore
operator|=
name|smarts
operator|=
name|cumsmarts
operator|=
name|wave
operator|=
literal|0
expr_stmt|;
name|numents
operator|=
literal|5
expr_stmt|;
name|numbases
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|totalscore
operator|=
name|atol
argument_list|(
name|spbuf
operator|+
literal|9
argument_list|)
expr_stmt|;
name|smarts
operator|=
name|atoi
argument_list|(
name|spbuf
operator|+
literal|20
argument_list|)
expr_stmt|;
name|cumsmarts
operator|=
name|atoi
argument_list|(
name|spbuf
operator|+
literal|24
argument_list|)
expr_stmt|;
name|numents
operator|=
name|atoi
argument_list|(
name|spbuf
operator|+
literal|30
argument_list|)
expr_stmt|;
name|numbases
operator|=
name|atoi
argument_list|(
name|spbuf
operator|+
literal|33
argument_list|)
expr_stmt|;
name|wave
operator|=
name|atoi
argument_list|(
name|spbuf
operator|+
literal|36
argument_list|)
expr_stmt|;
name|apolspec
operator|=
operator|(
name|spbuf
index|[
literal|40
index|]
operator|==
literal|'a'
operator|)
expr_stmt|;
name|beginner
operator|=
operator|(
name|spbuf
index|[
literal|41
index|]
operator|==
literal|'b'
operator|)
expr_stmt|;
name|crushspec
operator|=
operator|(
name|spbuf
index|[
literal|42
index|]
operator|==
literal|'c'
operator|)
expr_stmt|;
name|gornspec
operator|=
operator|(
name|spbuf
index|[
literal|43
index|]
operator|==
literal|'g'
operator|)
expr_stmt|;
name|massacre
operator|=
operator|(
name|spbuf
index|[
literal|44
index|]
operator|==
literal|'m'
operator|)
expr_stmt|;
name|romspec
operator|=
operator|(
name|spbuf
index|[
literal|45
index|]
operator|==
literal|'r'
operator|)
expr_stmt|;
name|tholspec
operator|=
operator|(
name|spbuf
index|[
literal|46
index|]
operator|==
literal|'t'
operator|)
expr_stmt|;
name|lowspeed
operator|=
operator|(
name|spbuf
index|[
literal|47
index|]
operator|==
literal|'l'
operator|)
operator|||
name|lowspeed
expr_stmt|;
name|amoebaspec
operator|=
operator|(
name|spbuf
index|[
literal|48
index|]
operator|==
literal|'&'
operator|)
expr_stmt|;
name|Fclose
argument_list|(
name|savfil
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ismarts
condition|)
block|{
name|ismarts
operator|=
literal|1
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|page
argument_list|(
name|NEWSFILE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|smarts
condition|)
block|{
name|printf
argument_list|(
literal|"\r\nSaved game: SCORE DIFF CUMDIFF ENTERPRISES BASES WAVE"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\r\n          %7ld  %2d   %4d        %1d        %1d   %3d"
argument_list|,
name|totalscore
argument_list|,
name|smarts
argument_list|,
name|cumsmarts
argument_list|,
name|numents
argument_list|,
name|numbases
argument_list|,
name|wave
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\r\nWould you like instructions? "
argument_list|)
expr_stmt|;
name|Fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|eat_typeahead
argument_list|()
expr_stmt|;
name|getcmd
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|buf
operator|==
name|INTRCH
condition|)
name|finalize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|buf
operator|==
literal|'Y'
operator|||
operator|*
name|buf
operator|==
literal|'y'
condition|)
block|{
name|page
argument_list|(
name|HELPFILE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\r\nWould you like to play easy games for a while? "
argument_list|)
expr_stmt|;
name|Fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|eat_typeahead
argument_list|()
expr_stmt|;
name|getcmd
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|buf
operator|==
literal|'Y'
operator|||
operator|*
name|buf
operator|==
literal|'y'
condition|)
block|{
name|beginner
operator|=
name|TRUE
expr_stmt|;
name|lowspeed
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|smarts
condition|)
name|smarts
operator|=
name|ismarts
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wscore
parameter_list|()
block|{
name|clear
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"                             TOP WARPISTS\r\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"RANK  WHO                     AKA        SCORE DIFF  CUMDIFF  WHEN\r\n"
argument_list|)
expr_stmt|;
name|page
argument_list|(
name|SCOREBOARD
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                     [Type anything to continue]"
argument_list|)
expr_stmt|;
name|Fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|getcmd
argument_list|(
name|spbuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|spbuf
operator|==
name|INTRCH
condition|)
name|finalize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"                        TOP LOW-SPEED WARPISTS\r\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"RANK  WHO                     AKA        SCORE DIFF  CUMDIFF  WHEN\r\n"
argument_list|)
expr_stmt|;
name|page
argument_list|(
name|LSCOREBOARD
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                     [Type anything to continue]"
argument_list|)
expr_stmt|;
name|Fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|getcmd
argument_list|(
name|spbuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|spbuf
operator|==
name|INTRCH
condition|)
name|finalize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"                          TOP FUNNY WARPISTS\r\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"RANK  WHO                     AKA        SCORE DIFF  CUMDIFF  WHEN\r\n"
argument_list|)
expr_stmt|;
name|page
argument_list|(
name|FSCOREBOARD
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                     [Type anything to continue]"
argument_list|)
expr_stmt|;
name|Fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|getcmd
argument_list|(
name|spbuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|spbuf
operator|==
name|INTRCH
condition|)
name|finalize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"          GAMES SAVED OR IN PROGRESS\r\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"WHO           SCORE  DF   CDF  E  B  WV  FLAGS\r\n"
argument_list|)
expr_stmt|;
name|resetty
argument_list|()
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"/bin/cat %ssave.*"
argument_list|,
name|SAVEDIR
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|lint
name|execl
argument_list|(
literal|"/bin/sh"
argument_list|,
literal|"sh"
argument_list|,
literal|"-c"
argument_list|,
name|spbuf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|finalize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|display_status
parameter_list|()
block|{
name|Reg1
name|int
name|tmp
decl_stmt|;
specifier|static
name|char
modifier|*
name|status_names
index|[]
init|=
block|{
literal|"Impl"
block|,
literal|"Warp"
block|,
literal|"Base"
block|,
literal|"****"
block|}
decl_stmt|;
if|if
condition|(
name|oldstatus
operator|!=
name|status
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%-4s"
argument_list|,
name|status_names
index|[
name|status
index|]
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|oldstatus
operator|=
name|status
expr_stmt|;
block|}
if|if
condition|(
name|ent
condition|)
block|{
if|if
condition|(
name|ent
operator|->
name|energy
operator|!=
name|oldeenergy
condition|)
block|{
name|oldeenergy
operator|=
name|ent
operator|->
name|energy
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%4ld"
argument_list|,
name|oldeenergy
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|8
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|etorp
operator|!=
name|oldetorp
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%2d"
argument_list|,
name|etorp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|13
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|oldetorp
operator|=
name|etorp
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|etorp
operator|>=
literal|0
condition|)
block|{
name|etorp
operator|=
operator|-
literal|1
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|8
argument_list|,
literal|"*******"
argument_list|)
expr_stmt|;
name|damage
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|base
condition|)
block|{
if|if
condition|(
name|base
operator|->
name|energy
operator|!=
name|oldbenergy
condition|)
block|{
name|oldbenergy
operator|=
name|base
operator|->
name|energy
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%5ld"
argument_list|,
name|oldbenergy
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|19
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|btorp
operator|!=
name|oldbtorp
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%3d"
argument_list|,
name|btorp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|25
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|oldbtorp
operator|=
name|btorp
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|btorp
operator|>=
literal|0
condition|)
block|{
name|btorp
operator|=
operator|-
literal|1
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|19
argument_list|,
literal|"*********"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|damage
condition|)
block|{
if|if
condition|(
operator|!
name|olddamage
condition|)
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|42
argument_list|,
literal|"*** "
argument_list|)
expr_stmt|;
if|if
condition|(
name|damage
operator|>
literal|1
operator|||
operator|!
name|damflag
index|[
name|dam
index|]
condition|)
block|{
do|do
block|{
if|if
condition|(
operator|++
name|dam
operator|==
name|MAXDAMAGE
condition|)
name|dam
operator|=
literal|0
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|damflag
index|[
name|dam
index|]
condition|)
do|;
block|}
if|if
condition|(
operator|!
operator|--
name|damflag
index|[
name|dam
index|]
condition|)
block|{
name|olddamage
operator|=
name|damage
expr_stmt|;
name|damage
operator|--
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%s OK ***       "
argument_list|,
name|dammess
index|[
name|dam
index|]
argument_list|)
expr_stmt|;
name|spbuf
index|[
literal|15
index|]
operator|=
literal|'\0'
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|46
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dam
operator|==
name|NOSHIELDS
condition|)
block|{
name|olddamage
operator|=
name|damage
expr_stmt|;
name|tmp
operator|=
operator|(
literal|34
operator|-
name|damflag
index|[
name|dam
index|]
operator|)
operator|*
literal|3
operator|-
name|rand_mod
argument_list|(
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
literal|0
condition|)
name|tmp
operator|=
literal|0
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%d%% %s ***       "
argument_list|,
name|tmp
argument_list|,
name|dammess
index|[
name|dam
index|]
argument_list|)
expr_stmt|;
name|spbuf
index|[
literal|15
index|]
operator|=
literal|'\0'
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|46
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dam
operator|!=
name|lastdam
operator|||
operator|!
name|olddamage
condition|)
block|{
name|olddamage
operator|=
name|damage
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"NO %s ***       "
argument_list|,
name|dammess
index|[
name|dam
index|]
argument_list|)
expr_stmt|;
name|spbuf
index|[
literal|15
index|]
operator|=
literal|'\0'
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|46
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|<
literal|2
condition|)
block|{
if|if
condition|(
name|dam
operator|==
name|NOIMPULSE
operator|&&
operator|!
name|entmode
condition|)
name|status
operator|=
name|entmode
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|dam
operator|==
name|NOWARP
operator|&&
name|entmode
condition|)
name|status
operator|=
name|entmode
operator|=
literal|0
expr_stmt|;
block|}
name|tmp
operator|=
name|damflag
index|[
name|dam
index|]
operator|*
name|damage
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%3d.%1d ETR"
argument_list|,
name|tmp
operator|/
literal|10
argument_list|,
name|tmp
operator|%
literal|10
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|69
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|lastdam
operator|=
name|dam
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|olddamage
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Stars: %-3d Stardate"
argument_list|,
name|numstars
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|42
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|lastdam
operator|=
operator|-
literal|1
expr_stmt|;
name|olddamage
operator|=
literal|0
expr_stmt|;
name|oldcurscore
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numstars
operator|!=
name|oldstrs
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%-3d"
argument_list|,
name|numstars
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|49
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
block|}
name|oldstrs
operator|=
name|numstars
expr_stmt|;
block|}
if|if
condition|(
name|numenemies
operator|!=
name|oldenemies
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%-3d"
argument_list|,
name|numenemies
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|38
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|oldenemies
operator|=
name|numenemies
expr_stmt|;
block|}
if|if
condition|(
name|tmp
operator|=
name|timer
operator|%
literal|10
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%1d"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|67
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%5d.%1d"
argument_list|,
name|timer
operator|/
literal|10
operator|+
name|smarts
operator|*
literal|100
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|61
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|!
name|damage
operator|||
operator|!
name|damflag
index|[
name|dam
index|]
operator|)
operator|&&
name|curscore
operator|!=
name|oldcurscore
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%9ld"
argument_list|,
name|curscore
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|69
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|oldcurscore
operator|=
name|curscore
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wavescore
parameter_list|()
block|{
name|double
name|power
decl_stmt|,
name|effectscore
decl_stmt|,
name|starscore
decl_stmt|,
name|pi_over_2
decl_stmt|;
name|long
name|bonuses
decl_stmt|;
name|long
name|tmp
decl_stmt|;
name|FILE
modifier|*
name|mapfp
decl_stmt|;
name|int
name|row
decl_stmt|;
name|double
name|pow
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|lint
name|double
name|atan2
parameter_list|()
function_decl|;
endif|#
directive|endif
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|curscore
operator|>
name|possiblescore
condition|)
name|curscore
operator|=
name|possiblescore
expr_stmt|;
name|pi_over_2
operator|=
literal|3.14159265
operator|/
literal|2.0
expr_stmt|;
name|power
operator|=
name|pow
argument_list|(
operator|(
name|double
operator|)
name|inumenemies
operator|+
comment|/* total number of enemies */
name|inumroms
operator|*
literal|2
operator|+
comment|/* count roms 3 times */
name|inumgorns
operator|+
comment|/* count gorns 2 times */
name|inumthols
operator|+
comment|/* count thols 2 times */
name|inumapollos
operator|*
literal|4
operator|+
comment|/* count apollo 5 times */
name|inumcrushes
operator|*
literal|3
operator|+
comment|/* count crushers 4 times */
name|inumamoebas
operator|*
literal|5
comment|/* count amoebas 6 times */
argument_list|,
literal|0.50
argument_list|)
operator|*
comment|/* skew it a little */
operator|(
name|double
operator|)
name|smarts
expr_stmt|;
comment|/* average energy and intelligence */
if|if
condition|(
name|inumstars
operator|<
literal|350
operator|&&
name|inumenemies
operator|>
literal|5
condition|)
name|power
operator|+=
operator|(
literal|350.0
operator|-
operator|(
name|double
operator|)
name|inumstars
operator|)
operator|*
operator|(
operator|(
name|double
operator|)
name|inumenemies
operator|-
literal|5.0
operator|)
expr_stmt|;
if|if
condition|(
name|inumstars
operator|>
literal|850
operator|&&
name|inumenemies
operator|>
literal|2
condition|)
name|power
operator|+=
operator|(
operator|(
name|double
operator|)
name|inumstars
operator|-
literal|850.0
operator|)
operator|*
operator|(
operator|(
name|double
operator|)
name|inumenemies
operator|-
literal|2.0
operator|)
expr_stmt|;
ifndef|#
directive|ifndef
name|lint
name|effectscore
operator|=
operator|(
operator|(
name|double
operator|)
name|curscore
operator|/
name|possiblescore
operator|)
operator|*
name|atan2
argument_list|(
name|power
argument_list|,
operator|(
name|double
operator|)
name|timer
operator|+
literal|1.0
argument_list|)
operator|/
name|pi_over_2
expr_stmt|;
else|#
directive|else
name|effectscore
operator|=
name|pi_over_2
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|inumstars
condition|)
name|starscore
operator|=
operator|(
name|double
operator|)
name|numstars
operator|/
operator|(
name|double
operator|)
name|inumstars
expr_stmt|;
else|else
name|starscore
operator|=
literal|1.0
expr_stmt|;
name|wave
operator|++
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Wave = %d, Difficulty = %d, cumulative difficulty = %d"
argument_list|,
name|wave
argument_list|,
name|smarts
argument_list|,
name|cumsmarts
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|1
argument_list|,
literal|13
operator|+
operator|(
name|smarts
operator|<
literal|10
operator|)
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|68
argument_list|,
literal|" BONUS"
argument_list|)
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Efficiency rating:       %1.8f (diff=%0.2f,time=%d)"
argument_list|,
name|effectscore
argument_list|,
name|power
argument_list|,
name|timer
operator|+
literal|1
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|5
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|effectscore
operator|<
literal|0.8
condition|)
name|bonuses
operator|=
name|tmp
operator|=
literal|0
expr_stmt|;
else|else
name|bonuses
operator|=
name|tmp
operator|=
call|(
name|long
call|)
argument_list|(
operator|(
name|effectscore
operator|-
literal|0.8
operator|)
operator|*
name|smarts
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%6ld"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|68
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Star save ratio:         %1.8f (%d/%d)"
argument_list|,
name|starscore
argument_list|,
name|numstars
argument_list|,
name|inumstars
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|6
argument_list|,
literal|5
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|lint
name|bonuses
operator|+=
name|tmp
operator|=
call|(
name|long
call|)
argument_list|(
operator|(
operator|(
name|double
operator|)
name|curscore
operator|/
name|possiblescore
operator|)
operator|*
operator|(
name|starscore
operator|*
name|starscore
operator|)
operator|*
name|smarts
operator|*
literal|20
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%6ld"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|6
argument_list|,
literal|68
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|row
operator|=
literal|7
expr_stmt|;
if|if
condition|(
name|inuminhab
operator|!=
name|numinhab
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Inhabited stars depopulated:  %5d"
argument_list|,
name|inuminhab
operator|-
name|numinhab
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|5
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|bonuses
operator|+=
name|tmp
operator|=
call|(
name|long
call|)
argument_list|(
name|inuminhab
operator|-
name|numinhab
argument_list|)
operator|*
operator|-
literal|500
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%6ld"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|68
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|row
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|inumfriends
operator|!=
name|numfriends
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Friendly craft destroyed:     %5d"
argument_list|,
name|inumfriends
operator|-
name|numfriends
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|5
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|bonuses
operator|+=
name|tmp
operator|=
call|(
name|long
call|)
argument_list|(
name|inumfriends
operator|-
name|numfriends
argument_list|)
operator|*
operator|-
literal|250
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%6ld"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|68
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|row
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|deadmudds
condition|)
block|{
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|5
argument_list|,
literal|"For destroying Harry Mudd:"
argument_list|)
expr_stmt|;
name|bonuses
operator|+=
name|tmp
operator|=
operator|(
name|long
operator|)
name|rand_mod
argument_list|(
name|deadmudds
operator|*
literal|20
operator|+
literal|1
argument_list|)
operator|-
name|deadmudds
operator|*
literal|10
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%6ld"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|68
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|row
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|bombed_out
condition|)
block|{
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|5
argument_list|,
literal|"For running away from reality:"
argument_list|)
expr_stmt|;
name|bonuses
operator|+=
name|tmp
operator|=
operator|(
name|long
operator|)
operator|-
name|possiblescore
operator|/
literal|2
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%6ld"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|68
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|row
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|row
operator|<
literal|9
condition|)
name|row
operator|++
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Enterprise: %-9s%5d remaining"
argument_list|,
operator|!
name|ient
condition|?
literal|""
else|:
name|ent
condition|?
literal|"saved"
else|:
literal|"destroyed"
argument_list|,
name|numents
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|5
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|bonuses
operator|+=
name|tmp
operator|=
name|ent
operator|&&
operator|!
name|bombed_out
condition|?
operator|(
name|smarts
operator|+
literal|1
operator|)
operator|*
literal|15
else|:
literal|0
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%6ld"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|68
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|row
operator|++
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Base: %-9s      %5d remaining"
argument_list|,
operator|!
name|ibase
condition|?
literal|""
else|:
name|base
condition|?
literal|"saved"
else|:
literal|"destroyed"
argument_list|,
name|numbases
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|5
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|bonuses
operator|+=
name|tmp
operator|=
name|base
operator|&&
operator|!
name|bombed_out
condition|?
operator|(
name|smarts
operator|+
literal|1
operator|)
operator|*
literal|10
else|:
literal|0
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"%6ld"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|68
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|beginner
condition|)
block|{
name|mvaddstr
argument_list|(
literal|13
operator|+
operator|(
name|row
operator|>
literal|11
operator|)
argument_list|,
literal|19
argument_list|,
literal|"(Special games count only a tenth as much)"
argument_list|)
expr_stmt|;
name|curscore
operator|/=
literal|10
expr_stmt|;
name|bonuses
operator|/=
literal|10
expr_stmt|;
block|}
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Previous point total:%10ld"
argument_list|,
name|lastscore
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|15
argument_list|,
literal|24
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Points this round:   %10ld"
argument_list|,
name|curscore
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|16
argument_list|,
literal|24
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"Bonuses:             %10ld"
argument_list|,
name|bonuses
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|17
argument_list|,
literal|24
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|totalscore
operator|=
name|lastscore
operator|+
name|curscore
operator|+
name|bonuses
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"New point total:     %10ld"
argument_list|,
name|totalscore
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|18
argument_list|,
literal|24
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|lastscore
operator|/
name|ENTBOUNDARY
operator|<
name|totalscore
operator|/
name|ENTBOUNDARY
condition|)
block|{
name|mvaddstr
argument_list|(
name|row
operator|-
literal|1
argument_list|,
literal|42
argument_list|,
literal|"+ 1 new"
argument_list|)
expr_stmt|;
name|numents
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numents
operator|>
literal|0
operator|&&
name|lastscore
operator|/
name|ENTBOUNDARY
operator|>
name|totalscore
operator|/
name|ENTBOUNDARY
condition|)
block|{
name|mvaddstr
argument_list|(
name|row
operator|-
literal|1
argument_list|,
literal|42
argument_list|,
literal|"- 1 obsolete"
argument_list|)
expr_stmt|;
name|numents
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|lastscore
operator|/
name|BASEBOUNDARY
operator|<
name|totalscore
operator|/
name|BASEBOUNDARY
condition|)
block|{
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|42
argument_list|,
literal|"+ 1 new"
argument_list|)
expr_stmt|;
name|numbases
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numbases
operator|>
literal|0
operator|&&
name|lastscore
operator|/
name|BASEBOUNDARY
operator|>
name|totalscore
operator|/
name|BASEBOUNDARY
condition|)
block|{
name|mvaddstr
argument_list|(
name|row
argument_list|,
literal|42
argument_list|,
literal|"- 1 obsolete"
argument_list|)
expr_stmt|;
name|numbases
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|starscore
operator|<
literal|0.8
operator|&&
name|inumstars
operator|>
literal|200
operator|&&
name|numstars
operator|>
literal|50
condition|)
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"smap.%d"
argument_list|,
name|rand_mod
argument_list|(
name|MAPS
operator|-
name|PERMMAPS
argument_list|)
operator|+
name|PERMMAPS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mapfp
operator|=
name|fopen
argument_list|(
name|spbuf
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|Reg1
name|OBJECT
modifier|*
name|obj
decl_stmt|;
name|fprintf
argument_list|(
name|mapfp
argument_list|,
literal|"%d\n"
argument_list|,
name|numstars
argument_list|)
expr_stmt|;
for|for
control|(
name|obj
operator|=
name|root
operator|.
name|next
init|;
name|obj
operator|!=
operator|&
name|root
condition|;
name|obj
operator|=
name|obj
operator|->
name|next
control|)
block|{
if|if
condition|(
name|obj
operator|->
name|type
operator|==
name|Star
condition|)
block|{
name|fprintf
argument_list|(
name|mapfp
argument_list|,
literal|"%d %d\n"
argument_list|,
name|obj
operator|->
name|posy
argument_list|,
name|obj
operator|->
name|posx
argument_list|)
expr_stmt|;
block|}
block|}
name|Fclose
argument_list|(
name|mapfp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|score
parameter_list|()
block|{
name|char
name|tmp
decl_stmt|,
modifier|*
name|retval
decl_stmt|,
name|cdate
index|[
literal|30
index|]
decl_stmt|;
name|Reg1
name|FILE
modifier|*
name|logfd
decl_stmt|;
name|Reg2
name|FILE
modifier|*
name|outfd
decl_stmt|;
name|Reg3
name|int
name|i
decl_stmt|;
name|long
name|nowtime
decl_stmt|,
name|time
argument_list|()
decl_stmt|;
name|char
modifier|*
name|scoreboard
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|link
argument_list|(
name|LOGFILE
argument_list|,
name|LOCKFILE
argument_list|)
operator|==
operator|-
literal|1
operator|&&
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|nowtime
operator|=
name|time
argument_list|(
operator|(
name|long
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|cdate
argument_list|,
name|ctime
argument_list|(
operator|&
name|nowtime
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|logfd
operator|=
name|fopen
argument_list|(
name|LOGFILE
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|logfd
argument_list|,
literal|"%-24s%-9s%7ld%c%2d %4d %s"
argument_list|,
name|realname
argument_list|,
name|logname
argument_list|,
name|totalscore
argument_list|,
name|c
argument_list|,
name|smarts
argument_list|,
name|cumsmarts
argument_list|,
name|cdate
argument_list|)
expr_stmt|;
name|Fclose
argument_list|(
name|logfd
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|cdate
operator|+
literal|11
argument_list|,
name|cdate
operator|+
literal|20
argument_list|)
expr_stmt|;
if|if
condition|(
name|beginner
condition|)
name|scoreboard
operator|=
name|FSCOREBOARD
expr_stmt|;
elseif|else
if|if
condition|(
name|lowspeed
condition|)
name|scoreboard
operator|=
name|LSCOREBOARD
expr_stmt|;
else|else
name|scoreboard
operator|=
name|SCOREBOARD
expr_stmt|;
if|if
condition|(
name|eaccess
argument_list|(
name|scoreboard
argument_list|,
literal|0
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|logfd
operator|=
name|fopen
argument_list|(
name|scoreboard
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|Fclose
argument_list|(
name|logfd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|logfd
operator|=
name|fopen
argument_list|(
name|scoreboard
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|(
name|outfd
operator|=
name|fopen
argument_list|(
name|TMPSCOREBOARD
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|retval
operator|=
name|fgets
argument_list|(
name|buf
argument_list|,
literal|100
argument_list|,
name|logfd
argument_list|)
operator|)
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|atol
argument_list|(
name|buf
operator|+
literal|32
argument_list|)
operator|<
name|totalscore
condition|)
break|break;
if|if
condition|(
name|strnEQ
argument_list|(
name|buf
operator|+
name|COMPOFF
argument_list|,
name|COMPNAME
argument_list|,
name|COMPLEN
argument_list|)
condition|)
block|{
name|i
operator|=
literal|100
expr_stmt|;
break|break;
block|}
name|fprintf
argument_list|(
name|outfd
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|100
condition|)
block|{
name|mvaddstr
argument_list|(
literal|20
argument_list|,
literal|21
argument_list|,
literal|"You did not better your previous score"
argument_list|)
expr_stmt|;
name|Fclose
argument_list|(
name|outfd
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|TMPSCOREBOARD
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|<
literal|20
condition|)
block|{
name|fprintf
argument_list|(
name|outfd
argument_list|,
literal|"%-24s%-8s%8ld%c %2d    %4d    %s"
argument_list|,
name|realname
argument_list|,
name|logname
argument_list|,
name|totalscore
argument_list|,
name|c
argument_list|,
name|smarts
argument_list|,
name|cumsmarts
argument_list|,
name|cdate
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"    Congratulations--you've placed %d%s"
argument_list|,
name|i
argument_list|,
name|i
operator|==
literal|1
condition|?
literal|"st"
else|:
operator|(
name|i
operator|==
literal|2
condition|?
literal|"nd"
else|:
operator|(
name|i
operator|==
literal|3
condition|?
literal|"rd"
else|:
literal|"th"
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strnNE
argument_list|(
name|buf
operator|+
name|COMPOFF
argument_list|,
name|COMPNAME
argument_list|,
name|COMPLEN
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|outfd
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
name|strcpy
argument_list|(
name|spbuf
argument_list|,
literal|"Congratulations--you've bettered your score"
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|<
literal|20
condition|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
literal|100
argument_list|,
name|logfd
argument_list|)
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|strnNE
argument_list|(
name|buf
operator|+
name|COMPOFF
argument_list|,
name|COMPNAME
argument_list|,
name|COMPLEN
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|outfd
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
block|}
name|mvaddstr
argument_list|(
literal|20
argument_list|,
literal|19
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
name|Fclose
argument_list|(
name|logfd
argument_list|)
expr_stmt|;
name|Fclose
argument_list|(
name|outfd
argument_list|)
expr_stmt|;
while|while
condition|(
name|unlink
argument_list|(
name|scoreboard
argument_list|)
operator|==
literal|0
condition|)
empty_stmt|;
name|link
argument_list|(
name|TMPSCOREBOARD
argument_list|,
name|scoreboard
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|TMPSCOREBOARD
argument_list|)
expr_stmt|;
name|logfd
operator|=
name|fopen
argument_list|(
name|scoreboard
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mvaddstr
argument_list|(
literal|20
argument_list|,
literal|22
argument_list|,
literal|"You did not place within the top 20"
argument_list|)
expr_stmt|;
name|Fclose
argument_list|(
name|outfd
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|"(Cannot access %s file, error %d)"
argument_list|,
operator|(
name|logfd
operator|==
name|NULL
condition|?
literal|"log"
else|:
literal|"tmp"
operator|)
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|20
argument_list|,
literal|22
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
block|}
name|move
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
name|mvaddstr
argument_list|(
literal|23
argument_list|,
literal|11
argument_list|,
literal|"[Hit space for scoreboard, 'r' for new game, 'q' to quit]"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|LOCKFILE
argument_list|)
expr_stmt|;
name|Fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|eat_typeahead
argument_list|()
expr_stmt|;
do|do
block|{
name|getcmd
argument_list|(
operator|&
name|tmp
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|tmp
operator|!=
name|INTRCH
operator|&&
name|tmp
operator|!=
name|BREAKCH
operator|&&
operator|!
name|index
argument_list|(
literal|" rqQ"
argument_list|,
name|tmp
argument_list|)
condition|)
do|;
if|if
condition|(
name|index
argument_list|(
literal|"qQr"
argument_list|,
name|tmp
argument_list|)
condition|)
block|{
name|justonemoretime
operator|=
operator|(
name|tmp
operator|==
literal|'r'
operator|)
expr_stmt|;
if|if
condition|(
name|logfd
operator|!=
name|NULL
condition|)
name|Fclose
argument_list|(
name|logfd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|logfd
operator|!=
name|NULL
condition|)
block|{
name|fseek
argument_list|(
name|logfd
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|beginner
condition|)
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|31
argument_list|,
literal|"TOP FUNNY WARPISTS"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|lowspeed
condition|)
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|29
argument_list|,
literal|"TOP LOW-SPEED WARPISTS"
argument_list|)
expr_stmt|;
else|else
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|33
argument_list|,
literal|"TOP WARPISTS"
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|"RANK  WHO                     AKA        SCORE DIFF  CUMDIFF  WHEN"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|20
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
literal|100
argument_list|,
name|logfd
argument_list|)
operator|==
name|NULL
condition|)
break|break;
name|buf
index|[
name|strlen
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|Sprintf
argument_list|(
name|spbuf
argument_list|,
literal|" %2d   %s"
argument_list|,
name|i
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|i
operator|+
literal|2
argument_list|,
literal|0
argument_list|,
name|spbuf
argument_list|)
expr_stmt|;
block|}
name|Fclose
argument_list|(
name|logfd
argument_list|)
expr_stmt|;
block|}
name|roundsleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|23
argument_list|,
literal|25
argument_list|,
literal|"Would you like to play again?"
argument_list|)
expr_stmt|;
name|eat_typeahead
argument_list|()
expr_stmt|;
do|do
block|{
name|getcmd
argument_list|(
operator|&
name|tmp
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|tmp
operator|!=
name|INTRCH
operator|&&
name|tmp
operator|!=
name|BREAKCH
operator|&&
operator|!
name|index
argument_list|(
literal|"nNyY \n\r"
argument_list|,
name|tmp
argument_list|)
condition|)
do|;
if|if
condition|(
name|tmp
operator|==
literal|'n'
operator|||
name|tmp
operator|==
literal|'N'
operator|||
name|tmp
operator|==
name|INTRCH
operator|||
name|tmp
operator|==
name|BREAKCH
condition|)
name|justonemoretime
operator|=
name|FALSE
expr_stmt|;
block|}
name|smarts
operator|=
name|ismarts
expr_stmt|;
name|totalscore
operator|=
name|cumsmarts
operator|=
name|wave
operator|=
literal|0
expr_stmt|;
name|numents
operator|=
literal|5
expr_stmt|;
name|numbases
operator|=
literal|3
expr_stmt|;
name|apolspec
operator|=
name|FALSE
expr_stmt|;
name|beginner
operator|=
name|FALSE
expr_stmt|;
name|crushspec
operator|=
name|FALSE
expr_stmt|;
name|gornspec
operator|=
name|FALSE
expr_stmt|;
name|massacre
operator|=
operator|(
name|ismarts
operator|>=
literal|40
operator|)
expr_stmt|;
name|romspec
operator|=
name|FALSE
expr_stmt|;
name|tholspec
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
name|void
name|save_game
parameter_list|()
block|{
name|FILE
modifier|*
name|savfil
decl_stmt|;
if|if
condition|(
name|experimenting
condition|)
return|return;
if|if
condition|(
operator|(
name|savfil
operator|=
name|fopen
argument_list|(
name|savefilename
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|resetty
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"Cannot save game\r\n"
argument_list|)
expr_stmt|;
name|finalize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|savfil
argument_list|,
literal|"%-8s %10ld, %2d,%5d,%2d,%2d,%3d %c%c%c%c%c%c%c%c\n"
argument_list|,
name|logname
argument_list|,
name|totalscore
argument_list|,
name|smarts
argument_list|,
name|cumsmarts
argument_list|,
name|numents
argument_list|,
name|numbases
argument_list|,
name|wave
argument_list|,
name|apolspec
condition|?
literal|'a'
else|:
literal|' '
argument_list|,
name|beginner
condition|?
literal|'b'
else|:
literal|' '
argument_list|,
name|crushspec
condition|?
literal|'c'
else|:
literal|' '
argument_list|,
name|gornspec
condition|?
literal|'g'
else|:
literal|' '
argument_list|,
name|massacre
condition|?
literal|'m'
else|:
literal|' '
argument_list|,
name|romspec
condition|?
literal|'r'
else|:
literal|' '
argument_list|,
name|tholspec
condition|?
literal|'t'
else|:
literal|' '
argument_list|,
name|lowspeed
condition|?
literal|'l'
else|:
literal|' '
argument_list|,
name|amoebaspec
condition|?
literal|'&'
else|:
literal|' '
argument_list|)
expr_stmt|;
name|Fclose
argument_list|(
name|savfil
argument_list|)
expr_stmt|;
name|resetty
argument_list|()
expr_stmt|;
if|if
condition|(
name|panic
condition|)
name|finalize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|finalize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


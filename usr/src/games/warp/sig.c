begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Header: /usr/src/games/warp/RCS/sig.c,v 1.1 87/07/03 01:47:11 games Exp $ */
end_comment

begin_comment
comment|/* $Log:	sig.c,v $  * Revision 7.0.1.1a  87/07/03  01:47:11  games  * Changed sigsetmask to use sigmask instead of calculating it (incorrectly)  * by hand.  *   * Revision 7.0.1.1  86/12/12  17:02:44  lwall  * Baseline for net release.  *   * Revision 7.0  86/10/08  15:13:24  lwall  * Split into separate files.  Added amoebas and pirates.  *   */
end_comment

begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_include
include|#
directive|include
file|"warp.h"
end_include

begin_include
include|#
directive|include
file|"play.h"
end_include

begin_include
include|#
directive|include
file|"score.h"
end_include

begin_include
include|#
directive|include
file|"term.h"
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"INTERN.h"
end_include

begin_include
include|#
directive|include
file|"sig.h"
end_include

begin_function
name|void
name|sig_init
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|lint
empty_stmt|;
else|#
directive|else
name|sigignore
argument_list|(
name|SIGINT
argument_list|)
expr_stmt|;
comment|/* for inquiry of existence via kill call */
ifdef|#
directive|ifdef
name|SIGTTOU
name|sigignore
argument_list|(
name|SIGTTOU
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sigset
argument_list|(
name|SIGHUP
argument_list|,
name|sig_catcher
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|debugging
condition|)
block|{
name|sigset
argument_list|(
name|SIGQUIT
argument_list|,
name|sig_catcher
argument_list|)
expr_stmt|;
name|sigset
argument_list|(
name|SIGILL
argument_list|,
name|sig_catcher
argument_list|)
expr_stmt|;
name|sigset
argument_list|(
name|SIGFPE
argument_list|,
name|sig_catcher
argument_list|)
expr_stmt|;
name|sigset
argument_list|(
name|SIGBUS
argument_list|,
name|sig_catcher
argument_list|)
expr_stmt|;
name|sigset
argument_list|(
name|SIGSEGV
argument_list|,
name|sig_catcher
argument_list|)
expr_stmt|;
name|sigset
argument_list|(
name|SIGSYS
argument_list|,
name|sig_catcher
argument_list|)
expr_stmt|;
name|sigset
argument_list|(
name|SIGTERM
argument_list|,
name|sig_catcher
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SIGXCPU
name|sigset
argument_list|(
name|SIGXCPU
argument_list|,
name|sig_catcher
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGCONT
name|sigset
argument_list|(
name|SIGCONT
argument_list|,
name|cont_catcher
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGTSTP
name|sigset
argument_list|(
name|SIGTSTP
argument_list|,
name|stop_catcher
argument_list|)
expr_stmt|;
name|sigset
argument_list|(
name|SIGSTOP
argument_list|,
name|stop_catcher
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* lint */
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SIGTSTP
end_ifdef

begin_function
name|void
name|cont_catcher
parameter_list|()
block|{
ifndef|#
directive|ifndef
name|lint
name|sigset
argument_list|(
name|SIGCONT
argument_list|,
name|cont_catcher
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|savetty
argument_list|()
expr_stmt|;
name|crmode
argument_list|()
expr_stmt|;
name|raw
argument_list|()
expr_stmt|;
name|noecho
argument_list|()
expr_stmt|;
name|nonl
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|mytstp
parameter_list|()
block|{
name|resetty
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|SIGTSTP
name|kill
argument_list|(
literal|0
argument_list|,
name|SIGTSTP
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|fork
argument_list|()
condition|)
name|wait
argument_list|(
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|char
modifier|*
name|shell
init|=
name|getenv
argument_list|(
literal|"SHELL"
argument_list|)
decl_stmt|;
name|setuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|shell
condition|)
name|shell
operator|=
literal|"/bin/sh"
expr_stmt|;
name|execl
argument_list|(
name|shell
argument_list|,
name|shell
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|rewrite
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
comment|/* very much void */
name|finalize
parameter_list|(
name|status
parameter_list|)
name|int
name|status
decl_stmt|;
block|{
if|if
condition|(
name|bizarre
condition|)
name|resetty
argument_list|()
expr_stmt|;
if|if
condition|(
name|status
operator|<
literal|0
condition|)
block|{
name|chdir
argument_list|(
literal|"/usr/tmp"
argument_list|)
expr_stmt|;
name|sigset
argument_list|(
name|SIGILL
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
name|exit
argument_list|(
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* come here on signal other than interrupt, stop, or cont */
end_comment

begin_function
name|void
name|sig_catcher
parameter_list|(
name|signo
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|VERBOSE
specifier|static
name|char
modifier|*
name|signame
index|[]
init|=
block|{
literal|""
block|,
literal|"HUP"
block|,
literal|"INT"
block|,
literal|"QUIT"
block|,
literal|"ILL"
block|,
literal|"TRAP"
block|,
literal|"IOT"
block|,
literal|"EMT"
block|,
literal|"FPE"
block|,
literal|"KILL"
block|,
literal|"BUS"
block|,
literal|"SEGV"
block|,
literal|"SYS"
block|,
literal|"PIPE"
block|,
literal|"ALRM"
block|,
literal|"TERM"
block|,
literal|"???"
ifdef|#
directive|ifdef
name|SIGTSTP
block|,
literal|"STOP"
block|,
literal|"TSTP"
block|,
literal|"CONT"
block|,
literal|"CHLD"
block|,
literal|"TTIN"
block|,
literal|"TTOU"
block|,
literal|"TINT"
block|,
literal|"XCPU"
block|,
literal|"XFSZ"
ifdef|#
directive|ifdef
name|SIGPROF
block|,
literal|"VTALARM"
block|,
literal|"PROF"
endif|#
directive|endif
endif|#
directive|endif
block|}
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGTTOU
ifndef|#
directive|ifndef
name|lint
name|sigignore
argument_list|(
name|SIGTTOU
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* lint */
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DEBUGGING
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"\r\nSIG%s--game not saved in debug\r\n"
argument_list|,
name|signame
index|[
name|signo
index|]
argument_list|)
expr_stmt|;
name|finalize
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|panic
operator|++
expr_stmt|;
if|if
condition|(
name|panic
operator|>=
literal|2
condition|)
block|{
if|if
condition|(
name|panic
operator|>=
literal|3
condition|)
name|abort
argument_list|()
expr_stmt|;
name|chdir
argument_list|(
name|SAVEDIR
argument_list|)
expr_stmt|;
name|kill
argument_list|(
literal|0
argument_list|,
name|SIGIOT
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sigset
argument_list|(
name|SIGILL
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
if|if
condition|(
name|signo
operator|==
name|SIGHUP
operator|&&
operator|(
name|timer
operator|<
literal|10
operator|||
name|didkill
operator|)
condition|)
name|signo
operator|=
name|SIGQUIT
expr_stmt|;
if|if
condition|(
name|signo
operator|==
name|SIGQUIT
condition|)
block|{
comment|/* can't let them bomb out without penalty */
if|if
condition|(
name|smarts
operator|<
literal|20
condition|)
name|smarts
operator|+=
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
name|smarts
operator|<
literal|35
condition|)
name|smarts
operator|+=
literal|2
expr_stmt|;
else|else
name|smarts
operator|++
expr_stmt|;
name|totalscore
operator|-=
name|possiblescore
operator|/
literal|2
expr_stmt|;
block|}
name|save_game
argument_list|()
expr_stmt|;
if|if
condition|(
name|signo
operator|!=
name|SIGHUP
operator|&&
name|signo
operator|!=
name|SIGQUIT
condition|)
ifdef|#
directive|ifdef
name|VERBOSE
name|IF
argument_list|(
argument|verbose
argument_list|)
name|printf
argument_list|(
literal|"\r\nCaught %s%s--%s\r\n"
argument_list|,
name|signo
condition|?
literal|"a SIG"
else|:
literal|"an internal error"
argument_list|,
name|signame
index|[
name|signo
index|]
argument_list|,
name|experimenting
condition|?
literal|"game saved"
else|:
literal|"bye bye"
argument_list|)
expr_stmt|;
name|ELSE
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TERSE
name|printf
argument_list|(
literal|"\r\nSignal %d--bye bye\r\n"
argument_list|,
name|signo
argument_list|)
decl_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|signo
condition|)
block|{
case|case
name|SIGBUS
case|:
case|case
name|SIGILL
case|:
case|case
name|SIGSEGV
case|:
name|finalize
argument_list|(
operator|-
name|signo
argument_list|)
expr_stmt|;
block|}
name|finalize
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* and blow up */
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SIGTSTP
end_ifdef

begin_comment
comment|/* come here on stop signal */
end_comment

begin_function
name|void
name|stop_catcher
parameter_list|()
block|{
if|if
condition|(
operator|!
name|waiting
condition|)
block|{
name|resetty
argument_list|()
expr_stmt|;
comment|/* this is the point of all this */
ifdef|#
directive|ifdef
name|DEBUGGING
if|if
condition|(
name|debug
condition|)
name|write
argument_list|(
literal|2
argument_list|,
literal|"stop_catcher\r\n"
argument_list|,
literal|13
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sigset
argument_list|(
name|SIGTSTP
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
comment|/* enable stop */
ifdef|#
directive|ifdef
name|BSD42
name|sigsetmask
argument_list|(
name|sigblock
argument_list|(
literal|0L
argument_list|)
operator|&
operator|~
name|sigmask
argument_list|(
name|SIGTSTP
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|kill
argument_list|(
literal|0
argument_list|,
name|SIGTSTP
argument_list|)
expr_stmt|;
comment|/* and do the stop */
block|}
ifndef|#
directive|ifndef
name|lint
name|sigset
argument_list|(
name|SIGTSTP
argument_list|,
name|stop_catcher
argument_list|)
expr_stmt|;
comment|/* unenable the stop */
endif|#
directive|endif
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


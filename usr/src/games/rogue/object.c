begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1988, 1993  *	The Regents of the University of California.  All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Timothy C. Stoehr.  *  * %sccs.include.redist.c%  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)object.c	8.1 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*  * object.c  *  * This source herein may be modified and/or distributed by anybody who  * so desires, with the following restrictions:  *    1.)  No portion of this notice shall be removed.  *    2.)  Credit shall not be taken for the creation of this source.  *    3.)  This code is not to be traded, sold, or used for personal  *         gain or profit.  *  */
end_comment

begin_include
include|#
directive|include
file|"rogue.h"
end_include

begin_decl_stmt
name|object
name|level_objects
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|dungeon
index|[
name|DROWS
index|]
index|[
name|DCOLS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|foods
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|object
modifier|*
name|free_list
init|=
operator|(
name|object
operator|*
operator|)
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fruit
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|fighter
name|rogue
init|=
block|{
name|INIT_AW
block|,
comment|/* armor, weapon */
name|INIT_RINGS
block|,
comment|/* rings */
name|INIT_HP
block|,
comment|/* Hp current,max */
name|INIT_STR
block|,
comment|/* Str current,max */
name|INIT_PACK
block|,
comment|/* pack */
name|INIT_GOLD
block|,
comment|/* gold */
name|INIT_EXP
block|,
comment|/* exp level,points */
literal|0
block|,
literal|0
block|,
comment|/* row, col */
name|INIT_CHAR
block|,
comment|/* char */
name|INIT_MOVES
comment|/* moves */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|id
name|id_potions
index|[
name|POTIONS
index|]
init|=
block|{
block|{
literal|100
block|,
literal|"blue \0                           "
block|,
literal|"of increase strength "
block|,
literal|0
block|}
block|,
block|{
literal|250
block|,
literal|"red \0                            "
block|,
literal|"of restore strength "
block|,
literal|0
block|}
block|,
block|{
literal|100
block|,
literal|"green \0                          "
block|,
literal|"of healing "
block|,
literal|0
block|}
block|,
block|{
literal|200
block|,
literal|"grey \0                           "
block|,
literal|"of extra healing "
block|,
literal|0
block|}
block|,
block|{
literal|10
block|,
literal|"brown \0                          "
block|,
literal|"of poison "
block|,
literal|0
block|}
block|,
block|{
literal|300
block|,
literal|"clear \0                          "
block|,
literal|"of raise level "
block|,
literal|0
block|}
block|,
block|{
literal|10
block|,
literal|"pink \0                           "
block|,
literal|"of blindness "
block|,
literal|0
block|}
block|,
block|{
literal|25
block|,
literal|"white \0                          "
block|,
literal|"of hallucination "
block|,
literal|0
block|}
block|,
block|{
literal|100
block|,
literal|"purple \0                         "
block|,
literal|"of detect monster "
block|,
literal|0
block|}
block|,
block|{
literal|100
block|,
literal|"black \0                          "
block|,
literal|"of detect things "
block|,
literal|0
block|}
block|,
block|{
literal|10
block|,
literal|"yellow \0                         "
block|,
literal|"of confusion "
block|,
literal|0
block|}
block|,
block|{
literal|80
block|,
literal|"plaid \0                          "
block|,
literal|"of levitation "
block|,
literal|0
block|}
block|,
block|{
literal|150
block|,
literal|"burgundy \0                       "
block|,
literal|"of haste self "
block|,
literal|0
block|}
block|,
block|{
literal|145
block|,
literal|"beige \0                          "
block|,
literal|"of see invisible "
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|id
name|id_scrolls
index|[
name|SCROLS
index|]
init|=
block|{
block|{
literal|505
block|,
literal|"                                   "
block|,
literal|"of protect armor "
block|,
literal|0
block|}
block|,
block|{
literal|200
block|,
literal|"                                   "
block|,
literal|"of hold monster "
block|,
literal|0
block|}
block|,
block|{
literal|235
block|,
literal|"                                   "
block|,
literal|"of enchant weapon "
block|,
literal|0
block|}
block|,
block|{
literal|235
block|,
literal|"                                   "
block|,
literal|"of enchant armor "
block|,
literal|0
block|}
block|,
block|{
literal|175
block|,
literal|"                                   "
block|,
literal|"of identify "
block|,
literal|0
block|}
block|,
block|{
literal|190
block|,
literal|"                                   "
block|,
literal|"of teleportation "
block|,
literal|0
block|}
block|,
block|{
literal|25
block|,
literal|"                                   "
block|,
literal|"of sleep "
block|,
literal|0
block|}
block|,
block|{
literal|610
block|,
literal|"                                   "
block|,
literal|"of scare monster "
block|,
literal|0
block|}
block|,
block|{
literal|210
block|,
literal|"                                   "
block|,
literal|"of remove curse "
block|,
literal|0
block|}
block|,
block|{
literal|80
block|,
literal|"                                   "
block|,
literal|"of create monster "
block|,
literal|0
block|}
block|,
block|{
literal|25
block|,
literal|"                                   "
block|,
literal|"of aggravate monster "
block|,
literal|0
block|}
block|,
block|{
literal|180
block|,
literal|"                                   "
block|,
literal|"of magic mapping "
block|,
literal|0
block|}
block|,
block|{
literal|90
block|,
literal|"                                   "
block|,
literal|"of confuse monster "
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|id
name|id_weapons
index|[
name|WEAPONS
index|]
init|=
block|{
block|{
literal|150
block|,
literal|"short bow "
block|,
literal|""
block|,
literal|0
block|}
block|,
block|{
literal|8
block|,
literal|"darts "
block|,
literal|""
block|,
literal|0
block|}
block|,
block|{
literal|15
block|,
literal|"arrows "
block|,
literal|""
block|,
literal|0
block|}
block|,
block|{
literal|27
block|,
literal|"daggers "
block|,
literal|""
block|,
literal|0
block|}
block|,
block|{
literal|35
block|,
literal|"shurikens "
block|,
literal|""
block|,
literal|0
block|}
block|,
block|{
literal|360
block|,
literal|"mace "
block|,
literal|""
block|,
literal|0
block|}
block|,
block|{
literal|470
block|,
literal|"long sword "
block|,
literal|""
block|,
literal|0
block|}
block|,
block|{
literal|580
block|,
literal|"two-handed sword "
block|,
literal|""
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|id
name|id_armors
index|[
name|ARMORS
index|]
init|=
block|{
block|{
literal|300
block|,
literal|"leather armor "
block|,
literal|""
block|,
operator|(
name|UNIDENTIFIED
operator|)
block|}
block|,
block|{
literal|300
block|,
literal|"ring mail "
block|,
literal|""
block|,
operator|(
name|UNIDENTIFIED
operator|)
block|}
block|,
block|{
literal|400
block|,
literal|"scale mail "
block|,
literal|""
block|,
operator|(
name|UNIDENTIFIED
operator|)
block|}
block|,
block|{
literal|500
block|,
literal|"chain mail "
block|,
literal|""
block|,
operator|(
name|UNIDENTIFIED
operator|)
block|}
block|,
block|{
literal|600
block|,
literal|"banded mail "
block|,
literal|""
block|,
operator|(
name|UNIDENTIFIED
operator|)
block|}
block|,
block|{
literal|600
block|,
literal|"splint mail "
block|,
literal|""
block|,
operator|(
name|UNIDENTIFIED
operator|)
block|}
block|,
block|{
literal|700
block|,
literal|"plate mail "
block|,
literal|""
block|,
operator|(
name|UNIDENTIFIED
operator|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|id
name|id_wands
index|[
name|WANDS
index|]
init|=
block|{
block|{
literal|25
block|,
literal|"                                 "
block|,
literal|"of teleport away "
block|,
literal|0
block|}
block|,
block|{
literal|50
block|,
literal|"                                 "
block|,
literal|"of slow monster "
block|,
literal|0
block|}
block|,
block|{
literal|8
block|,
literal|"                                 "
block|,
literal|"of invisibility "
block|,
literal|0
block|}
block|,
block|{
literal|55
block|,
literal|"                                 "
block|,
literal|"of polymorph "
block|,
literal|0
block|}
block|,
block|{
literal|2
block|,
literal|"                                 "
block|,
literal|"of haste monster "
block|,
literal|0
block|}
block|,
block|{
literal|20
block|,
literal|"                                 "
block|,
literal|"of magic missile "
block|,
literal|0
block|}
block|,
block|{
literal|20
block|,
literal|"                                 "
block|,
literal|"of cancellation "
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|"                                 "
block|,
literal|"of do nothing "
block|,
literal|0
block|}
block|,
block|{
literal|35
block|,
literal|"                                 "
block|,
literal|"of drain life "
block|,
literal|0
block|}
block|,
block|{
literal|20
block|,
literal|"                                 "
block|,
literal|"of cold "
block|,
literal|0
block|}
block|,
block|{
literal|20
block|,
literal|"                                 "
block|,
literal|"of fire "
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|id
name|id_rings
index|[
name|RINGS
index|]
init|=
block|{
block|{
literal|250
block|,
literal|"                                 "
block|,
literal|"of stealth "
block|,
literal|0
block|}
block|,
block|{
literal|100
block|,
literal|"                                 "
block|,
literal|"of teleportation "
block|,
literal|0
block|}
block|,
block|{
literal|255
block|,
literal|"                                 "
block|,
literal|"of regeneration "
block|,
literal|0
block|}
block|,
block|{
literal|295
block|,
literal|"                                 "
block|,
literal|"of slow digestion "
block|,
literal|0
block|}
block|,
block|{
literal|200
block|,
literal|"                                 "
block|,
literal|"of add strength "
block|,
literal|0
block|}
block|,
block|{
literal|250
block|,
literal|"                                 "
block|,
literal|"of sustain strength "
block|,
literal|0
block|}
block|,
block|{
literal|250
block|,
literal|"                                 "
block|,
literal|"of dexterity "
block|,
literal|0
block|}
block|,
block|{
literal|25
block|,
literal|"                                 "
block|,
literal|"of adornment "
block|,
literal|0
block|}
block|,
block|{
literal|300
block|,
literal|"                                 "
block|,
literal|"of see invisible "
block|,
literal|0
block|}
block|,
block|{
literal|290
block|,
literal|"                                 "
block|,
literal|"of maintain armor "
block|,
literal|0
block|}
block|,
block|{
literal|270
block|,
literal|"                                 "
block|,
literal|"of searching "
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|cur_level
decl_stmt|,
name|max_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|party_room
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|error_file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|boolean
name|is_wood
index|[]
decl_stmt|;
end_decl_stmt

begin_macro
name|put_objects
argument_list|()
end_macro

begin_block
block|{
name|short
name|i
decl_stmt|,
name|n
decl_stmt|;
name|object
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
name|cur_level
operator|<
name|max_level
condition|)
block|{
return|return;
block|}
name|n
operator|=
name|coin_toss
argument_list|()
condition|?
name|get_rand
argument_list|(
literal|2
argument_list|,
literal|4
argument_list|)
else|:
name|get_rand
argument_list|(
literal|3
argument_list|,
literal|5
argument_list|)
expr_stmt|;
while|while
condition|(
name|rand_percent
argument_list|(
literal|33
argument_list|)
condition|)
block|{
name|n
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|party_room
operator|!=
name|NO_ROOM
condition|)
block|{
name|make_party
argument_list|()
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|obj
operator|=
name|gr_object
argument_list|()
expr_stmt|;
name|rand_place
argument_list|(
name|obj
argument_list|)
expr_stmt|;
block|}
name|put_gold
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|put_gold
argument_list|()
end_macro

begin_block
block|{
name|short
name|i
decl_stmt|,
name|j
decl_stmt|;
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
name|boolean
name|is_maze
decl_stmt|,
name|is_room
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXROOMS
condition|;
name|i
operator|++
control|)
block|{
name|is_maze
operator|=
operator|(
name|rooms
index|[
name|i
index|]
operator|.
name|is_room
operator|&
name|R_MAZE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|is_room
operator|=
operator|(
name|rooms
index|[
name|i
index|]
operator|.
name|is_room
operator|&
name|R_ROOM
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|is_room
operator|||
name|is_maze
operator|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|is_maze
operator|||
name|rand_percent
argument_list|(
name|GOLD_PERCENT
argument_list|)
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|50
condition|;
name|j
operator|++
control|)
block|{
name|row
operator|=
name|get_rand
argument_list|(
name|rooms
index|[
name|i
index|]
operator|.
name|top_row
operator|+
literal|1
argument_list|,
name|rooms
index|[
name|i
index|]
operator|.
name|bottom_row
operator|-
literal|1
argument_list|)
expr_stmt|;
name|col
operator|=
name|get_rand
argument_list|(
name|rooms
index|[
name|i
index|]
operator|.
name|left_col
operator|+
literal|1
argument_list|,
name|rooms
index|[
name|i
index|]
operator|.
name|right_col
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dungeon
index|[
name|row
index|]
index|[
name|col
index|]
operator|==
name|FLOOR
operator|)
operator|||
operator|(
name|dungeon
index|[
name|row
index|]
index|[
name|col
index|]
operator|==
name|TUNNEL
operator|)
condition|)
block|{
name|plant_gold
argument_list|(
name|row
argument_list|,
name|col
argument_list|,
name|is_maze
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
block|}
end_block

begin_macro
name|plant_gold
argument_list|(
argument|row
argument_list|,
argument|col
argument_list|,
argument|is_maze
argument_list|)
end_macro

begin_decl_stmt
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|is_maze
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|object
modifier|*
name|obj
decl_stmt|;
name|obj
operator|=
name|alloc_object
argument_list|()
expr_stmt|;
name|obj
operator|->
name|row
operator|=
name|row
expr_stmt|;
name|obj
operator|->
name|col
operator|=
name|col
expr_stmt|;
name|obj
operator|->
name|what_is
operator|=
name|GOLD
expr_stmt|;
name|obj
operator|->
name|quantity
operator|=
name|get_rand
argument_list|(
operator|(
literal|2
operator|*
name|cur_level
operator|)
argument_list|,
operator|(
literal|16
operator|*
name|cur_level
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_maze
condition|)
block|{
name|obj
operator|->
name|quantity
operator|+=
name|obj
operator|->
name|quantity
operator|/
literal|2
expr_stmt|;
block|}
name|dungeon
index|[
name|row
index|]
index|[
name|col
index|]
operator||=
name|OBJECT
expr_stmt|;
operator|(
name|void
operator|)
name|add_to_pack
argument_list|(
name|obj
argument_list|,
operator|&
name|level_objects
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|place_at
argument_list|(
argument|obj
argument_list|,
argument|row
argument_list|,
argument|col
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|obj
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|obj
operator|->
name|row
operator|=
name|row
expr_stmt|;
name|obj
operator|->
name|col
operator|=
name|col
expr_stmt|;
name|dungeon
index|[
name|row
index|]
index|[
name|col
index|]
operator||=
name|OBJECT
expr_stmt|;
operator|(
name|void
operator|)
name|add_to_pack
argument_list|(
name|obj
argument_list|,
operator|&
name|level_objects
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|object
modifier|*
name|object_at
parameter_list|(
name|pack
parameter_list|,
name|row
parameter_list|,
name|col
parameter_list|)
specifier|register
name|object
modifier|*
name|pack
decl_stmt|;
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
block|{
name|object
modifier|*
name|obj
init|=
operator|(
name|object
operator|*
operator|)
literal|0
decl_stmt|;
if|if
condition|(
name|dungeon
index|[
name|row
index|]
index|[
name|col
index|]
operator|&
operator|(
name|MONSTER
operator||
name|OBJECT
operator|)
condition|)
block|{
name|obj
operator|=
name|pack
operator|->
name|next_object
expr_stmt|;
while|while
condition|(
name|obj
operator|&&
operator|(
operator|(
name|obj
operator|->
name|row
operator|!=
name|row
operator|)
operator|||
operator|(
name|obj
operator|->
name|col
operator|!=
name|col
operator|)
operator|)
condition|)
block|{
name|obj
operator|=
name|obj
operator|->
name|next_object
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|obj
condition|)
block|{
name|message
argument_list|(
literal|"object_at(): inconsistent"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|obj
operator|)
return|;
block|}
end_function

begin_function
name|object
modifier|*
name|get_letter_object
parameter_list|(
name|ch
parameter_list|)
block|{
name|object
modifier|*
name|obj
decl_stmt|;
name|obj
operator|=
name|rogue
operator|.
name|pack
operator|.
name|next_object
expr_stmt|;
while|while
condition|(
name|obj
operator|&&
operator|(
name|obj
operator|->
name|ichar
operator|!=
name|ch
operator|)
condition|)
block|{
name|obj
operator|=
name|obj
operator|->
name|next_object
expr_stmt|;
block|}
return|return
operator|(
name|obj
operator|)
return|;
block|}
end_function

begin_macro
name|free_stuff
argument_list|(
argument|objlist
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|objlist
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|object
modifier|*
name|obj
decl_stmt|;
while|while
condition|(
name|objlist
operator|->
name|next_object
condition|)
block|{
name|obj
operator|=
name|objlist
operator|->
name|next_object
expr_stmt|;
name|objlist
operator|->
name|next_object
operator|=
name|objlist
operator|->
name|next_object
operator|->
name|next_object
expr_stmt|;
name|free_object
argument_list|(
name|obj
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|char
modifier|*
name|name_of
parameter_list|(
name|obj
parameter_list|)
name|object
modifier|*
name|obj
decl_stmt|;
block|{
name|char
modifier|*
name|retstring
decl_stmt|;
switch|switch
condition|(
name|obj
operator|->
name|what_is
condition|)
block|{
case|case
name|SCROL
case|:
name|retstring
operator|=
name|obj
operator|->
name|quantity
operator|>
literal|1
condition|?
literal|"scrolls "
else|:
literal|"scroll "
expr_stmt|;
break|break;
case|case
name|POTION
case|:
name|retstring
operator|=
name|obj
operator|->
name|quantity
operator|>
literal|1
condition|?
literal|"potions "
else|:
literal|"potion "
expr_stmt|;
break|break;
case|case
name|FOOD
case|:
if|if
condition|(
name|obj
operator|->
name|which_kind
operator|==
name|RATION
condition|)
block|{
name|retstring
operator|=
literal|"food "
expr_stmt|;
block|}
else|else
block|{
name|retstring
operator|=
name|fruit
expr_stmt|;
block|}
break|break;
case|case
name|WAND
case|:
name|retstring
operator|=
name|is_wood
index|[
name|obj
operator|->
name|which_kind
index|]
condition|?
literal|"staff "
else|:
literal|"wand "
expr_stmt|;
break|break;
case|case
name|WEAPON
case|:
switch|switch
condition|(
name|obj
operator|->
name|which_kind
condition|)
block|{
case|case
name|DART
case|:
name|retstring
operator|=
name|obj
operator|->
name|quantity
operator|>
literal|1
condition|?
literal|"darts "
else|:
literal|"dart "
expr_stmt|;
break|break;
case|case
name|ARROW
case|:
name|retstring
operator|=
name|obj
operator|->
name|quantity
operator|>
literal|1
condition|?
literal|"arrows "
else|:
literal|"arrow "
expr_stmt|;
break|break;
case|case
name|DAGGER
case|:
name|retstring
operator|=
name|obj
operator|->
name|quantity
operator|>
literal|1
condition|?
literal|"daggers "
else|:
literal|"dagger "
expr_stmt|;
break|break;
case|case
name|SHURIKEN
case|:
name|retstring
operator|=
name|obj
operator|->
name|quantity
operator|>
literal|1
condition|?
literal|"shurikens "
else|:
literal|"shuriken "
expr_stmt|;
break|break;
default|default:
name|retstring
operator|=
name|id_weapons
index|[
name|obj
operator|->
name|which_kind
index|]
operator|.
name|title
expr_stmt|;
block|}
break|break;
case|case
name|ARMOR
case|:
name|retstring
operator|=
literal|"armor "
expr_stmt|;
break|break;
case|case
name|RING
case|:
name|retstring
operator|=
literal|"ring "
expr_stmt|;
break|break;
case|case
name|AMULET
case|:
name|retstring
operator|=
literal|"amulet "
expr_stmt|;
break|break;
default|default:
name|retstring
operator|=
literal|"unknown "
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|retstring
operator|)
return|;
block|}
end_function

begin_function
name|object
modifier|*
name|gr_object
parameter_list|()
block|{
name|object
modifier|*
name|obj
decl_stmt|;
name|obj
operator|=
name|alloc_object
argument_list|()
expr_stmt|;
if|if
condition|(
name|foods
operator|<
operator|(
name|cur_level
operator|/
literal|3
operator|)
condition|)
block|{
name|obj
operator|->
name|what_is
operator|=
name|FOOD
expr_stmt|;
name|foods
operator|++
expr_stmt|;
block|}
else|else
block|{
name|obj
operator|->
name|what_is
operator|=
name|gr_what_is
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|obj
operator|->
name|what_is
condition|)
block|{
case|case
name|SCROL
case|:
name|gr_scroll
argument_list|(
name|obj
argument_list|)
expr_stmt|;
break|break;
case|case
name|POTION
case|:
name|gr_potion
argument_list|(
name|obj
argument_list|)
expr_stmt|;
break|break;
case|case
name|WEAPON
case|:
name|gr_weapon
argument_list|(
name|obj
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|ARMOR
case|:
name|gr_armor
argument_list|(
name|obj
argument_list|)
expr_stmt|;
break|break;
case|case
name|WAND
case|:
name|gr_wand
argument_list|(
name|obj
argument_list|)
expr_stmt|;
break|break;
case|case
name|FOOD
case|:
name|get_food
argument_list|(
name|obj
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RING
case|:
name|gr_ring
argument_list|(
name|obj
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|obj
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|short
name|gr_what_is
parameter_list|()
block|{
name|short
name|percent
decl_stmt|;
name|unsigned
name|short
name|what_is
decl_stmt|;
name|percent
operator|=
name|get_rand
argument_list|(
literal|1
argument_list|,
literal|91
argument_list|)
expr_stmt|;
if|if
condition|(
name|percent
operator|<=
literal|30
condition|)
block|{
name|what_is
operator|=
name|SCROL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|60
condition|)
block|{
name|what_is
operator|=
name|POTION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|64
condition|)
block|{
name|what_is
operator|=
name|WAND
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|74
condition|)
block|{
name|what_is
operator|=
name|WEAPON
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|83
condition|)
block|{
name|what_is
operator|=
name|ARMOR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|88
condition|)
block|{
name|what_is
operator|=
name|FOOD
expr_stmt|;
block|}
else|else
block|{
name|what_is
operator|=
name|RING
expr_stmt|;
block|}
return|return
operator|(
name|what_is
operator|)
return|;
block|}
end_function

begin_macro
name|gr_scroll
argument_list|(
argument|obj
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|obj
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|percent
decl_stmt|;
name|percent
operator|=
name|get_rand
argument_list|(
literal|0
argument_list|,
literal|91
argument_list|)
expr_stmt|;
name|obj
operator|->
name|what_is
operator|=
name|SCROL
expr_stmt|;
if|if
condition|(
name|percent
operator|<=
literal|5
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|PROTECT_ARMOR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|10
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|HOLD_MONSTER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|20
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|CREATE_MONSTER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|35
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|IDENTIFY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|43
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|TELEPORT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|50
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|SLEEP
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|55
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|SCARE_MONSTER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|64
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|REMOVE_CURSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|69
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|ENCH_ARMOR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|74
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|ENCH_WEAPON
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|80
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|AGGRAVATE_MONSTER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|86
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|CON_MON
expr_stmt|;
block|}
else|else
block|{
name|obj
operator|->
name|which_kind
operator|=
name|MAGIC_MAPPING
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|gr_potion
argument_list|(
argument|obj
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|obj
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|percent
decl_stmt|;
name|percent
operator|=
name|get_rand
argument_list|(
literal|1
argument_list|,
literal|118
argument_list|)
expr_stmt|;
name|obj
operator|->
name|what_is
operator|=
name|POTION
expr_stmt|;
if|if
condition|(
name|percent
operator|<=
literal|5
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|RAISE_LEVEL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|15
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|DETECT_OBJECTS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|25
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|DETECT_MONSTER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|35
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|INCREASE_STRENGTH
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|45
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|RESTORE_STRENGTH
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|55
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|HEALING
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|65
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|EXTRA_HEALING
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|75
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|BLINDNESS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|85
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|HALLUCINATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|95
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|CONFUSION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|105
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|POISON
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|110
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|LEVITATION
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|114
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|HASTE_SELF
expr_stmt|;
block|}
else|else
block|{
name|obj
operator|->
name|which_kind
operator|=
name|SEE_INVISIBLE
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|gr_weapon
argument_list|(
argument|obj
argument_list|,
argument|assign_wk
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|obj
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|assign_wk
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|percent
decl_stmt|;
name|short
name|i
decl_stmt|;
name|short
name|blessing
decl_stmt|,
name|increment
decl_stmt|;
name|obj
operator|->
name|what_is
operator|=
name|WEAPON
expr_stmt|;
if|if
condition|(
name|assign_wk
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|get_rand
argument_list|(
literal|0
argument_list|,
operator|(
name|WEAPONS
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|obj
operator|->
name|which_kind
operator|==
name|ARROW
operator|)
operator|||
operator|(
name|obj
operator|->
name|which_kind
operator|==
name|DAGGER
operator|)
operator|||
operator|(
name|obj
operator|->
name|which_kind
operator|==
name|SHURIKEN
operator|)
operator||
operator|(
name|obj
operator|->
name|which_kind
operator|==
name|DART
operator|)
condition|)
block|{
name|obj
operator|->
name|quantity
operator|=
name|get_rand
argument_list|(
literal|3
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|obj
operator|->
name|quiver
operator|=
name|get_rand
argument_list|(
literal|0
argument_list|,
literal|126
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|obj
operator|->
name|quantity
operator|=
literal|1
expr_stmt|;
block|}
name|obj
operator|->
name|hit_enchant
operator|=
name|obj
operator|->
name|d_enchant
operator|=
literal|0
expr_stmt|;
name|percent
operator|=
name|get_rand
argument_list|(
literal|1
argument_list|,
literal|96
argument_list|)
expr_stmt|;
name|blessing
operator|=
name|get_rand
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|percent
operator|<=
literal|16
condition|)
block|{
name|increment
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|32
condition|)
block|{
name|increment
operator|=
operator|-
literal|1
expr_stmt|;
name|obj
operator|->
name|is_cursed
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|percent
operator|<=
literal|32
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|blessing
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|coin_toss
argument_list|()
condition|)
block|{
name|obj
operator|->
name|hit_enchant
operator|+=
name|increment
expr_stmt|;
block|}
else|else
block|{
name|obj
operator|->
name|d_enchant
operator|+=
name|increment
expr_stmt|;
block|}
block|}
block|}
switch|switch
condition|(
name|obj
operator|->
name|which_kind
condition|)
block|{
case|case
name|BOW
case|:
case|case
name|DART
case|:
name|obj
operator|->
name|damage
operator|=
literal|"1d1"
expr_stmt|;
break|break;
case|case
name|ARROW
case|:
name|obj
operator|->
name|damage
operator|=
literal|"1d2"
expr_stmt|;
break|break;
case|case
name|DAGGER
case|:
name|obj
operator|->
name|damage
operator|=
literal|"1d3"
expr_stmt|;
break|break;
case|case
name|SHURIKEN
case|:
name|obj
operator|->
name|damage
operator|=
literal|"1d4"
expr_stmt|;
break|break;
case|case
name|MACE
case|:
name|obj
operator|->
name|damage
operator|=
literal|"2d3"
expr_stmt|;
break|break;
case|case
name|LONG_SWORD
case|:
name|obj
operator|->
name|damage
operator|=
literal|"3d4"
expr_stmt|;
break|break;
case|case
name|TWO_HANDED_SWORD
case|:
name|obj
operator|->
name|damage
operator|=
literal|"4d5"
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_macro
name|gr_armor
argument_list|(
argument|obj
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|obj
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|percent
decl_stmt|;
name|short
name|blessing
decl_stmt|;
name|obj
operator|->
name|what_is
operator|=
name|ARMOR
expr_stmt|;
name|obj
operator|->
name|which_kind
operator|=
name|get_rand
argument_list|(
literal|0
argument_list|,
operator|(
name|ARMORS
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|obj
operator|->
name|class
operator|=
name|obj
operator|->
name|which_kind
operator|+
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|obj
operator|->
name|which_kind
operator|==
name|PLATE
operator|)
operator|||
operator|(
name|obj
operator|->
name|which_kind
operator|==
name|SPLINT
operator|)
condition|)
block|{
name|obj
operator|->
name|class
operator|--
expr_stmt|;
block|}
name|obj
operator|->
name|is_protected
operator|=
literal|0
expr_stmt|;
name|obj
operator|->
name|d_enchant
operator|=
literal|0
expr_stmt|;
name|percent
operator|=
name|get_rand
argument_list|(
literal|1
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|blessing
operator|=
name|get_rand
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|percent
operator|<=
literal|16
condition|)
block|{
name|obj
operator|->
name|is_cursed
operator|=
literal|1
expr_stmt|;
name|obj
operator|->
name|d_enchant
operator|-=
name|blessing
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|percent
operator|<=
literal|33
condition|)
block|{
name|obj
operator|->
name|d_enchant
operator|+=
name|blessing
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|gr_wand
argument_list|(
argument|obj
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|obj
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|obj
operator|->
name|what_is
operator|=
name|WAND
expr_stmt|;
name|obj
operator|->
name|which_kind
operator|=
name|get_rand
argument_list|(
literal|0
argument_list|,
operator|(
name|WANDS
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|obj
operator|->
name|class
operator|=
name|get_rand
argument_list|(
literal|3
argument_list|,
literal|7
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|get_food
argument_list|(
argument|obj
argument_list|,
argument|force_ration
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|obj
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|force_ration
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|obj
operator|->
name|what_is
operator|=
name|FOOD
expr_stmt|;
if|if
condition|(
name|force_ration
operator|||
name|rand_percent
argument_list|(
literal|80
argument_list|)
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
name|RATION
expr_stmt|;
block|}
else|else
block|{
name|obj
operator|->
name|which_kind
operator|=
name|FRUIT
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|put_stairs
argument_list|()
end_macro

begin_block
block|{
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
name|gr_row_col
argument_list|(
operator|&
name|row
argument_list|,
operator|&
name|col
argument_list|,
operator|(
name|FLOOR
operator||
name|TUNNEL
operator|)
argument_list|)
expr_stmt|;
name|dungeon
index|[
name|row
index|]
index|[
name|col
index|]
operator||=
name|STAIRS
expr_stmt|;
block|}
end_block

begin_macro
name|get_armor_class
argument_list|(
argument|obj
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|obj
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|obj
condition|)
block|{
return|return
operator|(
name|obj
operator|->
name|class
operator|+
name|obj
operator|->
name|d_enchant
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_function
name|object
modifier|*
name|alloc_object
parameter_list|()
block|{
name|object
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
name|free_list
condition|)
block|{
name|obj
operator|=
name|free_list
expr_stmt|;
name|free_list
operator|=
name|free_list
operator|->
name|next_object
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|obj
operator|=
operator|(
name|object
operator|*
operator|)
name|md_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|object
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|message
argument_list|(
literal|"cannot allocate object, saving game"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|save_into_file
argument_list|(
name|error_file
argument_list|)
expr_stmt|;
block|}
name|obj
operator|->
name|quantity
operator|=
literal|1
expr_stmt|;
name|obj
operator|->
name|ichar
operator|=
literal|'L'
expr_stmt|;
name|obj
operator|->
name|picked_up
operator|=
name|obj
operator|->
name|is_cursed
operator|=
literal|0
expr_stmt|;
name|obj
operator|->
name|in_use_flags
operator|=
name|NOT_USED
expr_stmt|;
name|obj
operator|->
name|identified
operator|=
name|UNIDENTIFIED
expr_stmt|;
name|obj
operator|->
name|damage
operator|=
literal|"1d1"
expr_stmt|;
return|return
operator|(
name|obj
operator|)
return|;
block|}
end_function

begin_macro
name|free_object
argument_list|(
argument|obj
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|obj
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|obj
operator|->
name|next_object
operator|=
name|free_list
expr_stmt|;
name|free_list
operator|=
name|obj
expr_stmt|;
block|}
end_block

begin_macro
name|make_party
argument_list|()
end_macro

begin_block
block|{
name|short
name|n
decl_stmt|;
name|party_room
operator|=
name|gr_room
argument_list|()
expr_stmt|;
name|n
operator|=
name|rand_percent
argument_list|(
literal|99
argument_list|)
condition|?
name|party_objects
argument_list|(
name|party_room
argument_list|)
else|:
literal|11
expr_stmt|;
if|if
condition|(
name|rand_percent
argument_list|(
literal|99
argument_list|)
condition|)
block|{
name|party_monsters
argument_list|(
name|party_room
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|show_objects
argument_list|()
end_macro

begin_block
block|{
name|object
modifier|*
name|obj
decl_stmt|;
name|short
name|mc
decl_stmt|,
name|rc
decl_stmt|,
name|row
decl_stmt|,
name|col
decl_stmt|;
name|object
modifier|*
name|monster
decl_stmt|;
name|obj
operator|=
name|level_objects
operator|.
name|next_object
expr_stmt|;
while|while
condition|(
name|obj
condition|)
block|{
name|row
operator|=
name|obj
operator|->
name|row
expr_stmt|;
name|col
operator|=
name|obj
operator|->
name|col
expr_stmt|;
name|rc
operator|=
name|get_mask_char
argument_list|(
name|obj
operator|->
name|what_is
argument_list|)
expr_stmt|;
if|if
condition|(
name|dungeon
index|[
name|row
index|]
index|[
name|col
index|]
operator|&
name|MONSTER
condition|)
block|{
if|if
condition|(
name|monster
operator|=
name|object_at
argument_list|(
operator|&
name|level_monsters
argument_list|,
name|row
argument_list|,
name|col
argument_list|)
condition|)
block|{
name|monster
operator|->
name|trail_char
operator|=
name|rc
expr_stmt|;
block|}
block|}
name|mc
operator|=
name|mvinch
argument_list|(
name|row
argument_list|,
name|col
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mc
operator|<
literal|'A'
operator|)
operator|||
operator|(
name|mc
operator|>
literal|'Z'
operator|)
operator|)
operator|&&
operator|(
operator|(
name|row
operator|!=
name|rogue
operator|.
name|row
operator|)
operator|||
operator|(
name|col
operator|!=
name|rogue
operator|.
name|col
operator|)
operator|)
condition|)
block|{
name|mvaddch
argument_list|(
name|row
argument_list|,
name|col
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
name|obj
operator|=
name|obj
operator|->
name|next_object
expr_stmt|;
block|}
name|monster
operator|=
name|level_monsters
operator|.
name|next_object
expr_stmt|;
while|while
condition|(
name|monster
condition|)
block|{
if|if
condition|(
name|monster
operator|->
name|m_flags
operator|&
name|IMITATES
condition|)
block|{
name|mvaddch
argument_list|(
name|monster
operator|->
name|row
argument_list|,
name|monster
operator|->
name|col
argument_list|,
operator|(
name|int
operator|)
name|monster
operator|->
name|disguise
argument_list|)
expr_stmt|;
block|}
name|monster
operator|=
name|monster
operator|->
name|next_monster
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|put_amulet
argument_list|()
end_macro

begin_block
block|{
name|object
modifier|*
name|obj
decl_stmt|;
name|obj
operator|=
name|alloc_object
argument_list|()
expr_stmt|;
name|obj
operator|->
name|what_is
operator|=
name|AMULET
expr_stmt|;
name|rand_place
argument_list|(
name|obj
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rand_place
argument_list|(
argument|obj
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|obj
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
name|gr_row_col
argument_list|(
operator|&
name|row
argument_list|,
operator|&
name|col
argument_list|,
operator|(
name|FLOOR
operator||
name|TUNNEL
operator|)
argument_list|)
expr_stmt|;
name|place_at
argument_list|(
name|obj
argument_list|,
name|row
argument_list|,
name|col
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|c_object_for_wizard
argument_list|()
end_macro

begin_block
block|{
name|short
name|ch
decl_stmt|,
name|max
decl_stmt|,
name|wk
decl_stmt|;
name|object
modifier|*
name|obj
decl_stmt|;
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
if|if
condition|(
name|pack_count
argument_list|(
operator|(
name|object
operator|*
operator|)
literal|0
argument_list|)
operator|>=
name|MAX_PACK_COUNT
condition|)
block|{
name|message
argument_list|(
literal|"pack full"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|message
argument_list|(
literal|"type of object?"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|r_index
argument_list|(
literal|"!?:)]=/,\033"
argument_list|,
operator|(
name|ch
operator|=
name|rgetchar
argument_list|()
operator|)
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sound_bell
argument_list|()
expr_stmt|;
block|}
name|check_message
argument_list|()
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'\033'
condition|)
block|{
return|return;
block|}
name|obj
operator|=
name|alloc_object
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'!'
case|:
name|obj
operator|->
name|what_is
operator|=
name|POTION
expr_stmt|;
name|max
operator|=
name|POTIONS
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|obj
operator|->
name|what_is
operator|=
name|SCROL
expr_stmt|;
name|max
operator|=
name|SCROLS
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|','
case|:
name|obj
operator|->
name|what_is
operator|=
name|AMULET
expr_stmt|;
break|break;
case|case
literal|':'
case|:
name|get_food
argument_list|(
name|obj
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|')'
case|:
name|gr_weapon
argument_list|(
name|obj
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|max
operator|=
name|WEAPONS
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|']'
case|:
name|gr_armor
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|max
operator|=
name|ARMORS
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'/'
case|:
name|gr_wand
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|max
operator|=
name|WANDS
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'='
case|:
name|max
operator|=
name|RINGS
operator|-
literal|1
expr_stmt|;
name|obj
operator|->
name|what_is
operator|=
name|RING
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|ch
operator|!=
literal|','
operator|)
operator|&&
operator|(
name|ch
operator|!=
literal|':'
operator|)
condition|)
block|{
name|GIL
label|:
if|if
condition|(
name|get_input_line
argument_list|(
literal|"which kind?"
argument_list|,
literal|""
argument_list|,
name|buf
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|wk
operator|=
name|get_number
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wk
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|wk
operator|<=
name|max
operator|)
condition|)
block|{
name|obj
operator|->
name|which_kind
operator|=
operator|(
name|unsigned
name|short
operator|)
name|wk
expr_stmt|;
if|if
condition|(
name|obj
operator|->
name|what_is
operator|==
name|RING
condition|)
block|{
name|gr_ring
argument_list|(
name|obj
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|sound_bell
argument_list|()
expr_stmt|;
goto|goto
name|GIL
goto|;
block|}
block|}
else|else
block|{
name|free_object
argument_list|(
name|obj
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|get_desc
argument_list|(
name|obj
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|message
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|add_to_pack
argument_list|(
name|obj
argument_list|,
operator|&
name|rogue
operator|.
name|pack
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * curses.c  *  * This source herein may be modified and/or distributed by anybody who  * so desires, with the following restrictions:  *    1.)  No portion of this notice shall be removed.  *    2.)  Credit shall not be taken for the creation of this source.  *    3.)  This code is not to be traded, sold, or used for personal  *         gain or profit.  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)curses.c	5.1 (Berkeley) 11/25/87"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CURSES
end_ifdef

begin_comment
comment|/* The following is a curses emulation package suitable for the rogue program  * in which it is included.  No other suitability is claimed or suspected.  * Only those routines currently needed by this rogue program are included.  * This is being provided for those systems that don't have a suitable  * curses package and want to run this rogue program.  *  * Compile the entire program with -DCURSES to incorporate this package.  *  * The following is NOT supported:  *   "%D", "%B", "%n", or "%>" inside a cursor motion (cm) termcap string.  *   Terminals in which the cursor motion addresses the row differently from  *       the column, as in ":cm=\E%2,%3" or ":cm=\EY%+x;%+y"  *   Termcap database stored in the TERMCAP environ variable as returned  *       from md_getenv().  Only the termcap file name can be stored there.  *       See the comments for md_getenv() in machdep.c.  *   Terminals without non-destructive backspace.  Backspace (^H) is used  *       for cursor motion regardless of any termcap entries.  *   The ":tc=" termcap entry is ignored.  *  * Suggestions:  *   Use line-feed as your termcap "do" entry: ":do=^J", ":do=\012" or  *      ":do=\n"  This will help cursor motion optimization.  If line-feed  *      won't work, then a short escape sequence will do.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"rogue.h"
end_include

begin_function_decl
name|boolean
name|tc_tname
parameter_list|()
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|BS
value|010
end_define

begin_define
define|#
directive|define
name|LF
value|012
end_define

begin_define
define|#
directive|define
name|CR
value|015
end_define

begin_define
define|#
directive|define
name|ESC
value|'\033'
end_define

begin_define
define|#
directive|define
name|TAB
value|'\011'
end_define

begin_define
define|#
directive|define
name|ST_MASK
value|0x80
end_define

begin_define
define|#
directive|define
name|BUFLEN
value|256
end_define

begin_decl_stmt
name|char
name|terminal
index|[
name|DROWS
index|]
index|[
name|DCOLS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|buffer
index|[
name|DROWS
index|]
index|[
name|DCOLS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tc_file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|cm_esc
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|cm_sep
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|cm_end
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|cm_reverse
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|cm_two
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|cm_three
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|cm_char
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|cm_inc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|screen_dirty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|lines_dirty
index|[
name|DROWS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|buf_stand_out
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|term_stand_out
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|LINES
init|=
name|DROWS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|COLS
init|=
name|DCOLS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|WINDOW
name|scr_buf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|WINDOW
modifier|*
name|curscr
init|=
operator|&
name|scr_buf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|CL
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|CM
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|UC
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* UP */
end_comment

begin_decl_stmt
name|char
modifier|*
name|DO
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|VS
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|VE
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|TI
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|TE
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|SO
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|SE
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|cur_row
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|cur_col
decl_stmt|;
end_decl_stmt

begin_macro
name|initscr
argument_list|()
end_macro

begin_block
block|{
name|clear
argument_list|()
expr_stmt|;
name|get_term_info
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|TI
argument_list|,
name|VS
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|endwin
argument_list|()
end_macro

begin_block
block|{
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|TE
argument_list|,
name|VE
argument_list|)
expr_stmt|;
name|md_cbreak_no_echo_nonl
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|move
argument_list|(
argument|row
argument_list|,
argument|col
argument_list|)
end_macro

begin_decl_stmt
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|curscr
operator|->
name|_cury
operator|=
name|row
expr_stmt|;
name|curscr
operator|->
name|_curx
operator|=
name|col
expr_stmt|;
name|screen_dirty
operator|=
literal|1
expr_stmt|;
block|}
end_block

begin_macro
name|mvaddstr
argument_list|(
argument|row
argument_list|,
argument|col
argument_list|,
argument|str
argument_list|)
end_macro

begin_decl_stmt
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|move
argument_list|(
name|row
argument_list|,
name|col
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|addstr
argument_list|(
argument|str
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|str
condition|)
block|{
name|addch
argument_list|(
operator|(
name|int
operator|)
operator|*
name|str
operator|++
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|addch
argument_list|(
name|ch
argument_list|)
specifier|register
name|int
name|ch
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
name|row
operator|=
name|curscr
operator|->
name|_cury
expr_stmt|;
name|col
operator|=
name|curscr
operator|->
name|_curx
operator|++
expr_stmt|;
if|if
condition|(
name|buf_stand_out
condition|)
block|{
name|ch
operator||=
name|ST_MASK
expr_stmt|;
block|}
name|buffer
index|[
name|row
index|]
index|[
name|col
index|]
operator|=
operator|(
name|char
operator|)
name|ch
expr_stmt|;
name|lines_dirty
index|[
name|row
index|]
operator|=
literal|1
expr_stmt|;
name|screen_dirty
operator|=
literal|1
expr_stmt|;
block|}
end_block

begin_macro
name|mvaddch
argument_list|(
argument|row
argument_list|,
argument|col
argument_list|,
argument|ch
argument_list|)
end_macro

begin_decl_stmt
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ch
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|move
argument_list|(
name|row
argument_list|,
name|col
argument_list|)
expr_stmt|;
name|addch
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|refresh
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|i
operator|,
name|j
operator|,
name|line
expr_stmt|;
name|short
name|old_row
decl_stmt|,
name|old_col
decl_stmt|,
name|first_row
decl_stmt|;
if|if
condition|(
name|screen_dirty
condition|)
block|{
name|old_row
operator|=
name|curscr
operator|->
name|_cury
expr_stmt|;
name|old_col
operator|=
name|curscr
operator|->
name|_curx
expr_stmt|;
name|first_row
operator|=
name|cur_row
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DROWS
condition|;
name|i
operator|++
control|)
block|{
name|line
operator|=
operator|(
name|first_row
operator|+
name|i
operator|)
operator|%
name|DROWS
expr_stmt|;
if|if
condition|(
name|lines_dirty
index|[
name|line
index|]
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|DCOLS
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|buffer
index|[
name|line
index|]
index|[
name|j
index|]
operator|!=
name|terminal
index|[
name|line
index|]
index|[
name|j
index|]
condition|)
block|{
name|put_char_at
argument_list|(
name|line
argument_list|,
name|j
argument_list|,
name|buffer
index|[
name|line
index|]
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|lines_dirty
index|[
name|line
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|put_cursor
argument_list|(
name|old_row
argument_list|,
name|old_col
argument_list|)
expr_stmt|;
name|screen_dirty
operator|=
literal|0
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|wrefresh
argument_list|(
argument|scr
argument_list|)
end_macro

begin_decl_stmt
name|WINDOW
modifier|*
name|scr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|i
decl_stmt|,
name|col
decl_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|CL
argument_list|)
expr_stmt|;
name|cur_row
operator|=
name|cur_col
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DROWS
condition|;
name|i
operator|++
control|)
block|{
name|col
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|col
operator|<
name|DCOLS
condition|)
block|{
while|while
condition|(
operator|(
name|col
operator|<
name|DCOLS
operator|)
operator|&&
operator|(
name|buffer
index|[
name|i
index|]
index|[
name|col
index|]
operator|==
literal|' '
operator|)
condition|)
block|{
name|col
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|col
operator|<
name|DCOLS
condition|)
block|{
name|put_cursor
argument_list|(
name|i
argument_list|,
name|col
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|col
operator|<
name|DCOLS
operator|)
operator|&&
operator|(
name|buffer
index|[
name|i
index|]
index|[
name|col
index|]
operator|!=
literal|' '
operator|)
condition|)
block|{
name|put_st_char
argument_list|(
operator|(
name|int
operator|)
name|buffer
index|[
name|i
index|]
index|[
name|col
index|]
argument_list|)
expr_stmt|;
name|cur_col
operator|++
expr_stmt|;
name|col
operator|++
expr_stmt|;
block|}
block|}
block|}
name|put_cursor
argument_list|(
name|curscr
operator|->
name|_cury
argument_list|,
name|curscr
operator|->
name|_curx
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|scr
operator|=
name|scr
expr_stmt|;
comment|/* make lint happy */
block|}
end_block

begin_macro
name|mvinch
argument_list|(
argument|row
argument_list|,
argument|col
argument_list|)
end_macro

begin_decl_stmt
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|move
argument_list|(
name|row
argument_list|,
name|col
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|buffer
index|[
name|row
index|]
index|[
name|col
index|]
operator|)
return|;
block|}
end_block

begin_macro
name|clear
argument_list|()
end_macro

begin_block
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|CL
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|cur_row
operator|=
name|cur_col
operator|=
literal|0
expr_stmt|;
name|move
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clear_buffers
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|clrtoeol
argument_list|()
end_macro

begin_block
block|{
name|short
name|row
decl_stmt|,
name|col
decl_stmt|;
name|row
operator|=
name|curscr
operator|->
name|_cury
expr_stmt|;
for|for
control|(
name|col
operator|=
name|curscr
operator|->
name|_curx
init|;
name|col
operator|<
name|DCOLS
condition|;
name|col
operator|++
control|)
block|{
name|buffer
index|[
name|row
index|]
index|[
name|col
index|]
operator|=
literal|' '
expr_stmt|;
block|}
name|lines_dirty
index|[
name|row
index|]
operator|=
literal|1
expr_stmt|;
block|}
end_block

begin_macro
name|standout
argument_list|()
end_macro

begin_block
block|{
name|buf_stand_out
operator|=
literal|1
expr_stmt|;
block|}
end_block

begin_macro
name|standend
argument_list|()
end_macro

begin_block
block|{
name|buf_stand_out
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|crmode
argument_list|()
end_macro

begin_block
block|{
name|md_cbreak_no_echo_nonl
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|noecho
argument_list|()
end_macro

begin_block
block|{
comment|/* crmode() takes care of this */
block|}
end_block

begin_macro
name|nonl
argument_list|()
end_macro

begin_block
block|{
comment|/* crmode() takes care of this */
block|}
end_block

begin_macro
name|clear_buffers
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|i
operator|,
name|j
expr_stmt|;
name|screen_dirty
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DROWS
condition|;
name|i
operator|++
control|)
block|{
name|lines_dirty
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|DCOLS
condition|;
name|j
operator|++
control|)
block|{
name|terminal
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
literal|' '
expr_stmt|;
name|buffer
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
literal|' '
expr_stmt|;
block|}
block|}
block|}
end_block

begin_expr_stmt
name|put_char_at
argument_list|(
name|row
argument_list|,
name|col
argument_list|,
name|ch
argument_list|)
specifier|register
name|row
operator|,
name|col
operator|,
name|ch
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|put_cursor
argument_list|(
name|row
argument_list|,
name|col
argument_list|)
expr_stmt|;
name|put_st_char
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|terminal
index|[
name|row
index|]
index|[
name|col
index|]
operator|=
operator|(
name|char
operator|)
name|ch
expr_stmt|;
name|cur_col
operator|++
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|put_cursor
argument_list|(
name|row
argument_list|,
name|col
argument_list|)
specifier|register
name|row
operator|,
name|col
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|i
operator|,
name|rdif
operator|,
name|cdif
expr_stmt|;
name|short
name|ch
decl_stmt|,
name|t
decl_stmt|;
name|rdif
operator|=
operator|(
name|row
operator|>
name|cur_row
operator|)
condition|?
name|row
operator|-
name|cur_row
else|:
name|cur_row
operator|-
name|row
expr_stmt|;
name|cdif
operator|=
operator|(
name|col
operator|>
name|cur_col
operator|)
condition|?
name|col
operator|-
name|cur_col
else|:
name|cur_col
operator|-
name|col
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|row
operator|>
name|cur_row
operator|)
operator|&&
name|DO
operator|)
operator|||
operator|(
operator|(
name|cur_row
operator|>
name|row
operator|)
operator|&&
name|UC
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|rdif
operator|<
literal|4
operator|)
operator|&&
operator|(
name|cdif
operator|<
literal|4
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdif
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
operator|(
operator|(
name|row
operator|<
name|cur_row
operator|)
condition|?
name|UC
else|:
name|DO
operator|)
argument_list|)
expr_stmt|;
block|}
name|cur_row
operator|=
name|row
expr_stmt|;
if|if
condition|(
name|col
operator|==
name|cur_col
condition|)
block|{
return|return;
block|}
block|}
block|}
if|if
condition|(
name|row
operator|==
name|cur_row
condition|)
block|{
if|if
condition|(
name|cdif
operator|<=
literal|6
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cdif
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|=
operator|(
name|col
operator|<
name|cur_col
operator|)
condition|?
name|BS
else|:
name|terminal
index|[
name|row
index|]
index|[
name|cur_col
operator|+
name|i
index|]
expr_stmt|;
name|put_st_char
argument_list|(
operator|(
name|int
operator|)
name|ch
argument_list|)
expr_stmt|;
block|}
name|cur_row
operator|=
name|row
expr_stmt|;
name|cur_col
operator|=
name|col
expr_stmt|;
return|return;
block|}
block|}
name|cur_row
operator|=
name|row
expr_stmt|;
name|cur_col
operator|=
name|col
expr_stmt|;
name|row
operator|+=
name|cm_inc
expr_stmt|;
name|col
operator|+=
name|cm_inc
expr_stmt|;
if|if
condition|(
name|cm_reverse
condition|)
block|{
name|t
operator|=
name|row
expr_stmt|;
name|row
operator|=
name|col
expr_stmt|;
name|col
operator|=
name|t
expr_stmt|;
block|}
if|if
condition|(
name|cm_two
condition|)
block|{
name|printf
argument_list|(
literal|"%s%02d%s%02d%s"
argument_list|,
name|cm_esc
argument_list|,
name|row
argument_list|,
name|cm_sep
argument_list|,
name|col
argument_list|,
name|cm_end
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cm_three
condition|)
block|{
name|printf
argument_list|(
literal|"%s%03d%s%03d%s"
argument_list|,
name|cm_esc
argument_list|,
name|row
argument_list|,
name|cm_sep
argument_list|,
name|col
argument_list|,
name|cm_end
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cm_char
condition|)
block|{
name|printf
argument_list|(
literal|"%s%c%s%c%s"
argument_list|,
name|cm_esc
argument_list|,
name|row
argument_list|,
name|cm_sep
argument_list|,
name|col
argument_list|,
name|cm_end
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s%d%s%d%s"
argument_list|,
name|cm_esc
argument_list|,
name|row
argument_list|,
name|cm_sep
argument_list|,
name|col
argument_list|,
name|cm_end
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|put_st_char
argument_list|(
name|ch
argument_list|)
specifier|register
name|ch
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
operator|(
name|ch
operator|&
name|ST_MASK
operator|)
operator|&&
operator|(
operator|!
name|term_stand_out
operator|)
condition|)
block|{
name|ch
operator|&=
operator|~
name|ST_MASK
expr_stmt|;
name|printf
argument_list|(
literal|"%s%c"
argument_list|,
name|SO
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|term_stand_out
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|!
operator|(
name|ch
operator|&
name|ST_MASK
operator|)
operator|)
operator|&&
name|term_stand_out
condition|)
block|{
name|printf
argument_list|(
literal|"%s%c"
argument_list|,
name|SE
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|term_stand_out
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ch
operator|&=
operator|~
name|ST_MASK
expr_stmt|;
name|putchar
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|get_term_info
argument_list|()
end_macro

begin_block
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|term
decl_stmt|,
modifier|*
name|tcf
decl_stmt|;
name|char
name|buf
index|[
name|BUFLEN
index|]
decl_stmt|;
if|if
condition|(
name|tcf
operator|=
name|md_getenv
argument_list|(
literal|"TERMCAP"
argument_list|)
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|tcf
argument_list|)
operator|>
literal|40
condition|)
block|{
name|clean_up
argument_list|(
literal|"TERMCAP file name too long"
argument_list|)
expr_stmt|;
block|}
name|tc_file
operator|=
name|tcf
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|tc_file
operator|=
name|md_gdtcf
argument_list|()
operator|)
condition|)
block|{
name|clean_up
argument_list|(
literal|"I need a termcap file"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
operator|(
name|term
operator|=
name|md_getenv
argument_list|(
literal|"TERM"
argument_list|)
operator|)
condition|)
block|{
name|clean_up
argument_list|(
literal|"Cannot find TERM variable in environ"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|tc_file
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"Cannot open TERMCAP file: %s"
argument_list|,
name|tc_file
argument_list|)
expr_stmt|;
name|clean_up
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|tc_tname
argument_list|(
name|fp
argument_list|,
name|term
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"Cannot find TERM type: %s in TERMCAP file: %s"
argument_list|,
name|term
argument_list|,
name|tc_file
argument_list|)
expr_stmt|;
name|clean_up
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
name|tc_gtdata
argument_list|(
name|fp
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|boolean
name|tc_tname
parameter_list|(
name|fp
parameter_list|,
name|term
parameter_list|,
name|buf
parameter_list|)
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|term
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
block|{
name|short
name|i
decl_stmt|,
name|j
decl_stmt|;
name|boolean
name|found
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|fg
decl_stmt|;
while|while
condition|(
operator|!
name|found
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
name|fg
operator|=
name|fgets
argument_list|(
name|buf
argument_list|,
name|BUFLEN
argument_list|,
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|fg
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|'#'
operator|)
operator|&&
operator|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|' '
operator|)
operator|&&
operator|(
name|buf
index|[
literal|0
index|]
operator|!=
name|TAB
operator|)
operator|&&
operator|(
name|buf
index|[
literal|0
index|]
operator|!=
name|CR
operator|)
operator|&&
operator|(
name|buf
index|[
literal|0
index|]
operator|!=
name|LF
operator|)
condition|)
block|{
while|while
condition|(
name|buf
index|[
name|i
index|]
operator|&&
operator|(
operator|!
name|found
operator|)
condition|)
block|{
name|j
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|buf
index|[
name|i
index|]
operator|==
name|term
index|[
name|j
index|]
condition|)
block|{
name|i
operator|++
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|!
name|term
index|[
name|j
index|]
operator|)
operator|&&
operator|(
operator|(
name|buf
index|[
name|i
index|]
operator|==
literal|'|'
operator|)
operator|||
operator|(
name|buf
index|[
name|i
index|]
operator|==
literal|':'
operator|)
operator|)
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|buf
index|[
name|i
index|]
operator|&&
operator|(
name|buf
index|[
name|i
index|]
operator|!=
literal|'|'
operator|)
operator|&&
operator|(
name|buf
index|[
name|i
index|]
operator|!=
literal|':'
operator|)
condition|)
block|{
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
name|i
index|]
condition|)
block|{
name|i
operator|++
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
else|else
block|{
break|break;
block|}
block|}
return|return
operator|(
name|found
operator|)
return|;
block|}
end_function

begin_macro
name|tc_gtdata
argument_list|(
argument|fp
argument_list|,
argument|buf
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|i
decl_stmt|;
name|boolean
name|first
init|=
literal|1
decl_stmt|;
do|do
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|!=
name|TAB
operator|)
operator|&&
operator|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|' '
operator|)
condition|)
block|{
break|break;
block|}
block|}
name|first
operator|=
literal|0
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|buf
index|[
name|i
index|]
condition|)
block|{
while|while
condition|(
name|buf
index|[
name|i
index|]
operator|&&
operator|(
name|buf
index|[
name|i
index|]
operator|!=
literal|':'
operator|)
condition|)
block|{
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
name|i
index|]
operator|==
literal|':'
condition|)
block|{
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":cl="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|CL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":cm="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|CM
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":up="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|UC
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":do="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|DO
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":vs="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|VS
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":ve="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|VE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":ti="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|TI
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":te="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|TE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":vs="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|VS
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":ve="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|VE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":so="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|SO
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":se="
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gets
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|SE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":li#"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gnum
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|LINES
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
literal|":co#"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|tc_gnum
argument_list|(
name|buf
operator|+
name|i
argument_list|,
operator|&
name|COLS
argument_list|)
expr_stmt|;
block|}
name|i
operator|++
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
name|BUFLEN
argument_list|,
name|fp
argument_list|)
operator|!=
name|NULL
condition|)
do|;
if|if
condition|(
operator|(
operator|!
name|CM
operator|)
operator|||
operator|(
operator|!
name|CL
operator|)
condition|)
block|{
name|clean_up
argument_list|(
literal|"Terminal and termcap must have cm and cl"
argument_list|)
expr_stmt|;
block|}
name|tc_cmget
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|tc_gets
argument_list|(
argument|ibuf
argument_list|,
argument|tcstr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|ibuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|tcstr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|n
decl_stmt|;
name|char
name|obuf
index|[
name|BUFLEN
index|]
decl_stmt|;
name|i
operator|=
literal|4
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|ibuf
index|[
name|i
index|]
operator|&&
name|is_digit
argument_list|(
name|ibuf
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|i
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|ibuf
index|[
name|i
index|]
operator|&&
operator|(
name|ibuf
index|[
name|i
index|]
operator|!=
literal|':'
operator|)
condition|)
block|{
if|if
condition|(
name|ibuf
index|[
name|i
index|]
operator|==
literal|'\\'
condition|)
block|{
name|i
operator|++
expr_stmt|;
switch|switch
condition|(
name|ibuf
index|[
name|i
index|]
condition|)
block|{
case|case
literal|'E'
case|:
name|obuf
index|[
name|j
index|]
operator|=
name|ESC
expr_stmt|;
name|i
operator|++
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|obuf
index|[
name|j
index|]
operator|=
name|LF
expr_stmt|;
name|i
operator|++
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|obuf
index|[
name|j
index|]
operator|=
name|CR
expr_stmt|;
name|i
operator|++
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|obuf
index|[
name|j
index|]
operator|=
name|BS
expr_stmt|;
name|i
operator|++
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|obuf
index|[
name|j
index|]
operator|=
name|TAB
expr_stmt|;
name|i
operator|++
expr_stmt|;
break|break;
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
name|n
operator|=
literal|0
expr_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|k
operator|<
literal|3
operator|&&
name|ibuf
index|[
name|i
index|]
operator|&&
name|is_digit
argument_list|(
name|ibuf
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|n
operator|=
operator|(
literal|8
operator|*
name|n
operator|)
operator|+
operator|(
name|ibuf
index|[
name|i
index|]
operator|-
literal|'0'
operator|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|k
operator|++
expr_stmt|;
block|}
name|obuf
index|[
name|j
index|]
operator|=
operator|(
name|char
operator|)
name|n
expr_stmt|;
break|break;
default|default:
name|obuf
index|[
name|j
index|]
operator|=
name|ibuf
index|[
name|i
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ibuf
index|[
name|i
index|]
operator|==
literal|'^'
condition|)
block|{
name|obuf
index|[
name|j
index|]
operator|=
name|ibuf
index|[
name|i
operator|+
literal|1
index|]
operator|-
literal|64
expr_stmt|;
name|i
operator|+=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|obuf
index|[
name|j
index|]
operator|=
name|ibuf
index|[
name|i
operator|++
index|]
expr_stmt|;
block|}
name|j
operator|++
expr_stmt|;
block|}
name|obuf
index|[
name|j
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|*
name|tcstr
operator|=
name|md_malloc
argument_list|(
name|j
operator|+
literal|1
argument_list|)
operator|)
condition|)
block|{
name|clean_up
argument_list|(
literal|"cannot alloc() memory"
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|strcpy
argument_list|(
operator|*
name|tcstr
argument_list|,
name|obuf
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|tc_gnum
argument_list|(
argument|ibuf
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|ibuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|i
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
name|i
operator|=
literal|4
expr_stmt|;
while|while
condition|(
name|is_digit
argument_list|(
name|ibuf
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|r
operator|=
operator|(
name|r
operator|*
literal|10
operator|)
operator|+
operator|(
name|ibuf
index|[
name|i
index|]
operator|-
literal|'0'
operator|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
operator|*
name|n
operator|=
name|r
expr_stmt|;
block|}
end_block

begin_macro
name|tstp
argument_list|()
end_macro

begin_block
block|{
name|endwin
argument_list|()
expr_stmt|;
name|md_tstp
argument_list|()
expr_stmt|;
name|start_window
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|TI
argument_list|,
name|VS
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|curscr
argument_list|)
expr_stmt|;
name|md_slurp
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|tc_cmget
argument_list|()
end_macro

begin_block
block|{
name|short
name|i
init|=
literal|0
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|,
name|rc_spec
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|CM
index|[
name|i
index|]
operator|&&
operator|(
name|CM
index|[
name|i
index|]
operator|!=
literal|'%'
operator|)
operator|&&
operator|(
name|j
operator|<
literal|15
operator|)
condition|)
block|{
name|cm_esc
index|[
name|j
operator|++
index|]
operator|=
name|CM
index|[
name|i
operator|++
index|]
expr_stmt|;
block|}
name|cm_esc
index|[
name|j
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|CM
index|[
name|i
index|]
operator|&&
operator|(
name|rc_spec
operator|<
literal|2
operator|)
condition|)
block|{
if|if
condition|(
name|CM
index|[
name|i
index|]
operator|==
literal|'%'
condition|)
block|{
name|i
operator|++
expr_stmt|;
switch|switch
condition|(
name|CM
index|[
name|i
index|]
condition|)
block|{
case|case
literal|'d'
case|:
name|rc_spec
operator|++
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|cm_inc
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'2'
case|:
name|cm_two
operator|=
literal|1
expr_stmt|;
name|rc_spec
operator|++
expr_stmt|;
break|break;
case|case
literal|'3'
case|:
name|cm_three
operator|=
literal|1
expr_stmt|;
name|rc_spec
operator|++
expr_stmt|;
break|break;
case|case
literal|'.'
case|:
name|cm_char
operator|=
literal|1
expr_stmt|;
name|rc_spec
operator|++
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|cm_reverse
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'+'
case|:
name|i
operator|++
expr_stmt|;
name|cm_inc
operator|=
name|CM
index|[
name|i
index|]
expr_stmt|;
name|cm_char
operator|=
literal|1
expr_stmt|;
name|rc_spec
operator|++
expr_stmt|;
break|break;
block|}
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|j
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|CM
index|[
name|i
index|]
operator|&&
operator|(
name|CM
index|[
name|i
index|]
operator|!=
literal|'%'
operator|)
condition|)
block|{
name|cm_sep
index|[
name|j
operator|++
index|]
operator|=
name|CM
index|[
name|i
operator|++
index|]
expr_stmt|;
block|}
name|cm_sep
index|[
name|j
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|j
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rc_spec
operator|==
literal|2
condition|)
block|{
while|while
condition|(
name|CM
index|[
name|i
index|]
operator|&&
operator|(
name|j
operator|<
literal|15
operator|)
condition|)
block|{
name|cm_end
index|[
name|j
operator|++
index|]
operator|=
name|CM
index|[
name|i
operator|++
index|]
expr_stmt|;
block|}
block|}
name|cm_end
index|[
name|j
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


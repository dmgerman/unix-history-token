begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|sccsid
init|=
literal|"@(#)screen.c	1.2 83/05/20"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"externs.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_function_decl
specifier|extern
name|int
name|choke
parameter_list|()
function_decl|;
end_function_decl

begin_macro
name|readpos
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|postype
modifier|*
name|p
init|=
name|pos
decl_stmt|;
specifier|register
name|ships
modifier|*
name|s
init|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
decl_stmt|;
for|for
control|(
name|n
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|vessels
init|;
name|n
operator|>
literal|0
condition|;
name|n
operator|--
operator|,
name|p
operator|++
operator|,
name|s
operator|++
control|)
block|{
name|p
operator|->
name|row
operator|=
name|s
operator|->
name|shiprow
expr_stmt|;
name|p
operator|->
name|col
operator|=
name|s
operator|->
name|shipcol
expr_stmt|;
name|p
operator|->
name|dir
operator|=
name|s
operator|->
name|shipdir
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|file
operator|->
name|explode
operator|==
literal|2
operator|||
name|s
operator|->
name|file
operator|->
name|sink
operator|==
literal|2
condition|)
name|p
operator|->
name|dir
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|makesignal
argument_list|(
argument|fmt
argument_list|,
argument|shipnum
argument_list|,
argument|owner
argument_list|)
end_macro

begin_decl_stmt
name|int
name|shipnum
decl_stmt|,
name|owner
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fmt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|junk
decl_stmt|;
name|char
name|message
index|[
literal|60
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|message
argument_list|,
name|fmt
argument_list|,
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|shipnum
index|]
operator|.
name|shipname
argument_list|,
name|colours
argument_list|(
name|shipnum
argument_list|)
argument_list|,
name|sterncolor
argument_list|(
name|shipnum
argument_list|,
operator|&
name|junk
argument_list|,
operator|&
name|junk
argument_list|)
argument_list|)
expr_stmt|;
name|Write
argument_list|(
name|FILES
operator|+
name|owner
argument_list|,
literal|1
argument_list|,
literal|164
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|PI
value|3.1415926535
end_define

begin_decl_stmt
name|float
name|contable
index|[
literal|8
index|]
init|=
block|{
literal|1.5708
block|,
literal|0.7854
block|,
literal|0.0
block|,
operator|-
literal|0.7854
block|,
operator|-
literal|1.5708
block|,
operator|-
literal|2.3562
block|,
operator|-
name|PI
block|,
literal|2.3562
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|angle
argument_list|(
name|dr
argument_list|,
name|dc
argument_list|)
specifier|register
name|dr
operator|,
name|dc
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|i
expr_stmt|;
if|if
condition|(
name|dc
operator|>=
literal|0
operator|&&
name|dr
operator|>
literal|0
condition|)
name|i
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|dr
operator|<=
literal|0
operator|&&
name|dc
operator|>
literal|0
condition|)
name|i
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|dc
operator|<=
literal|0
operator|&&
name|dr
operator|<
literal|0
condition|)
name|i
operator|=
literal|4
expr_stmt|;
else|else
name|i
operator|=
literal|6
expr_stmt|;
name|dr
operator|=
name|abs
argument_list|(
name|dr
argument_list|)
expr_stmt|;
name|dc
operator|=
name|abs
argument_list|(
name|dc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|==
literal|0
operator|||
name|i
operator|==
literal|4
operator|)
operator|&&
name|dc
operator|*
literal|2.4
operator|>
name|dr
condition|)
block|{
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|dc
operator|>
name|dr
operator|*
literal|2.4
condition|)
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|i
operator|==
literal|2
operator|||
name|i
operator|==
literal|6
operator|)
operator|&&
name|dr
operator|*
literal|2.4
operator|>
name|dc
condition|)
block|{
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|dr
operator|>
name|dc
operator|*
literal|2.4
condition|)
name|i
operator|++
expr_stmt|;
block|}
return|return
name|i
operator|%
literal|8
operator|+
literal|1
return|;
block|}
end_block

begin_function
name|char
name|gunsbear
parameter_list|(
name|fromship
parameter_list|,
name|toship
parameter_list|)
comment|/* checks for target bow or stern */
block|{
name|int
name|dr
decl_stmt|,
name|dc
decl_stmt|,
name|i
decl_stmt|;
specifier|register
name|ang
expr_stmt|;
specifier|register
name|postype
modifier|*
name|from
init|=
operator|&
name|pos
index|[
name|fromship
index|]
decl_stmt|;
specifier|register
name|postype
modifier|*
name|to
init|=
operator|&
name|pos
index|[
name|toship
index|]
decl_stmt|;
name|dr
operator|=
name|from
operator|->
name|row
operator|-
name|to
operator|->
name|row
expr_stmt|;
name|dc
operator|=
name|to
operator|->
name|col
operator|-
name|from
operator|->
name|col
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|ang
operator|=
name|angle
argument_list|(
name|dr
argument_list|,
name|dc
argument_list|)
operator|-
name|from
operator|->
name|dir
operator|+
literal|1
operator|)
operator|<
literal|1
condition|)
name|ang
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|ang
operator|>=
literal|2
operator|&&
name|ang
operator|<=
literal|4
condition|)
return|return
literal|'r'
return|;
if|if
condition|(
name|ang
operator|>=
literal|6
operator|&&
name|ang
operator|<=
literal|7
condition|)
return|return
literal|'l'
return|;
name|drdc
argument_list|(
operator|&
name|dr
argument_list|,
operator|&
name|dc
argument_list|,
name|to
operator|->
name|dir
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|portside
argument_list|(
name|fromship
argument_list|,
name|onship
argument_list|,
name|quick
argument_list|)
specifier|register
name|fromship
operator|,
name|onship
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|quick
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* returns true if fromship is */
end_comment

begin_block
block|{
comment|/* shooting at onship's starboard side */
specifier|register
name|ang
expr_stmt|;
name|int
name|dr
decl_stmt|,
name|dc
decl_stmt|;
name|dr
operator|=
name|pos
index|[
name|fromship
index|]
operator|.
name|row
operator|-
name|pos
index|[
name|onship
index|]
operator|.
name|row
expr_stmt|;
name|dc
operator|=
name|pos
index|[
name|onship
index|]
operator|.
name|col
operator|-
name|pos
index|[
name|fromship
index|]
operator|.
name|col
expr_stmt|;
if|if
condition|(
name|quick
operator|==
operator|-
literal|1
condition|)
name|drdc
argument_list|(
operator|&
name|dr
argument_list|,
operator|&
name|dc
argument_list|,
name|pos
index|[
name|onship
index|]
operator|.
name|dir
argument_list|)
expr_stmt|;
name|ang
operator|=
name|angle
argument_list|(
name|dr
argument_list|,
name|dc
argument_list|)
expr_stmt|;
if|if
condition|(
name|quick
operator|!=
literal|0
condition|)
return|return
name|ang
return|;
name|ang
operator|=
operator|(
name|ang
operator|+
literal|4
operator|-
name|pos
index|[
name|onship
index|]
operator|.
name|dir
operator|-
literal|1
operator|)
operator|%
literal|8
operator|+
literal|1
expr_stmt|;
return|return
name|ang
operator|<
literal|5
return|;
block|}
end_block

begin_decl_stmt
name|int
name|tantable
index|[
literal|40
index|]
init|=
block|{
literal|0
block|,
literal|100
block|,
literal|197
block|,
literal|291
block|,
literal|381
block|,
literal|464
block|,
literal|540
block|,
literal|610
block|,
literal|675
block|,
literal|733
block|,
literal|785
block|,
literal|833
block|,
literal|876
block|,
literal|915
block|,
literal|951
block|,
literal|983
block|,
literal|1012
block|,
literal|1039
block|,
literal|1064
block|,
literal|1086
block|,
literal|1107
block|,
literal|1126
block|,
literal|1144
block|,
literal|1161
block|,
literal|1176
block|,
literal|1190
block|,
literal|1204
block|,
literal|1216
block|,
literal|1227
block|,
literal|1239
block|,
literal|1249
block|,
literal|1259
block|,
literal|1268
block|,
literal|1277
block|,
literal|1285
block|,
literal|1293
block|,
literal|1300
block|,
literal|1307
block|,
literal|1313
block|,
literal|1470
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|double
name|arctan
parameter_list|(
name|y
parameter_list|,
name|x
parameter_list|)
name|int
name|y
decl_stmt|,
name|x
decl_stmt|;
block|{
name|int
name|sx
decl_stmt|,
name|sy
decl_stmt|;
specifier|register
name|int
name|index
decl_stmt|;
name|sy
operator|=
name|y
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|1
expr_stmt|;
name|sx
operator|=
name|x
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|1
expr_stmt|;
name|y
operator|*=
name|sy
expr_stmt|;
name|x
operator|*=
name|sx
expr_stmt|;
if|if
condition|(
operator|!
name|x
condition|)
return|return
operator|(
operator|(
name|double
operator|)
name|PI
operator|/
literal|2
operator|*
name|sy
operator|)
return|;
name|index
operator|=
operator|(
literal|10
operator|*
name|y
operator|)
operator|/
name|x
operator|+
literal|0.5
expr_stmt|;
if|if
condition|(
name|index
operator|>
literal|39
condition|)
name|index
operator|=
literal|39
expr_stmt|;
return|return
operator|(
call|(
name|double
call|)
argument_list|(
name|sy
operator|*
operator|(
name|sx
operator|<
literal|0
condition|?
name|PI
else|:
literal|0
operator|+
name|sx
operator|*
operator|(
name|tantable
index|[
name|index
index|]
operator|/
literal|1000
operator|)
operator|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_macro
name|boarders
argument_list|(
argument|from
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|from
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
name|struct
name|BP
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|key
condition|?
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|from
index|]
operator|.
name|file
operator|->
name|DBP
else|:
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|from
index|]
operator|.
name|file
operator|->
name|OBP
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|3
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|ptr
index|[
name|n
index|]
operator|.
name|turnsent
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|lengthof
argument_list|(
argument|string
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|string
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|string
index|[
name|n
index|]
condition|;
name|n
operator|++
control|)
empty_stmt|;
return|return
operator|(
name|n
operator|)
return|;
block|}
end_block

begin_macro
name|Write
argument_list|(
argument|address
argument_list|,
argument|string
argument_list|,
argument|offset
argument_list|,
argument|value
argument_list|)
end_macro

begin_decl_stmt
name|int
name|string
decl_stmt|,
name|address
decl_stmt|,
name|offset
decl_stmt|,
name|value
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|fd
decl_stmt|;
name|char
name|file
index|[
literal|25
index|]
decl_stmt|;
name|int
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|cptr
decl_stmt|;
name|struct
name|BP
modifier|*
name|bptr
decl_stmt|;
name|struct
name|snag
modifier|*
name|sptr
decl_stmt|;
if|if
condition|(
name|string
condition|)
block|{
name|sprintf
argument_list|(
name|Outbuf
operator|+
name|buffercount
argument_list|,
literal|"%d %d %d %s\n"
argument_list|,
name|address
argument_list|,
name|string
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|Outbuf
operator|+
name|buffercount
argument_list|,
literal|"%d %d %d %d\n"
argument_list|,
name|address
argument_list|,
name|string
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
name|buffercount
operator|+=
name|lengthof
argument_list|(
name|Outbuf
operator|+
name|buffercount
argument_list|)
expr_stmt|;
if|if
condition|(
name|address
operator|<
literal|32
condition|)
block|{
name|ptr
operator|=
operator|&
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|shipnum
expr_stmt|;
operator|*
operator|(
name|ptr
operator|+
operator|(
name|offset
operator|-
literal|2
operator|)
operator|/
literal|2
operator|)
operator|=
name|value
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|address
operator|<
literal|64
condition|)
block|{
name|address
operator|-=
name|SPECS
expr_stmt|;
name|ptr
operator|=
operator|&
name|specs
index|[
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|shipnum
index|]
operator|.
name|bs
expr_stmt|;
operator|*
operator|(
name|ptr
operator|+
name|offset
operator|/
literal|2
operator|)
operator|=
name|value
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|address
operator|<
literal|128
condition|)
block|{
name|address
operator|-=
name|FILES
expr_stmt|;
name|ptr
operator|=
operator|&
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|points
expr_stmt|;
if|if
condition|(
name|offset
operator|>=
literal|30
operator|&&
name|offset
operator|<
literal|48
condition|)
block|{
name|bptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|OBP
expr_stmt|;
switch|switch
condition|(
operator|(
operator|(
name|offset
operator|-
literal|30
operator|)
operator|%
literal|6
operator|)
operator|/
literal|2
condition|)
block|{
case|case
literal|0
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|30
operator|)
operator|/
literal|6
index|]
operator|.
name|turnsent
operator|=
name|value
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|30
operator|)
operator|/
literal|6
index|]
operator|.
name|toship
operator|=
name|value
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|30
operator|)
operator|/
literal|6
index|]
operator|.
name|mensent
operator|=
name|value
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|offset
operator|>=
literal|48
operator|&&
name|offset
operator|<
literal|66
condition|)
block|{
name|bptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|DBP
expr_stmt|;
switch|switch
condition|(
operator|(
operator|(
name|offset
operator|-
literal|48
operator|)
operator|%
literal|6
operator|)
operator|/
literal|2
condition|)
block|{
case|case
literal|0
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|48
operator|)
operator|/
literal|6
index|]
operator|.
name|turnsent
operator|=
name|value
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|48
operator|)
operator|/
literal|6
index|]
operator|.
name|toship
operator|=
name|value
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|48
operator|)
operator|/
literal|6
index|]
operator|.
name|mensent
operator|=
name|value
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|offset
operator|>=
literal|84
operator|&&
name|offset
operator|<
literal|124
condition|)
block|{
name|sptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|fouls
expr_stmt|;
switch|switch
condition|(
operator|(
operator|(
name|offset
operator|-
literal|84
operator|)
operator|%
literal|4
operator|)
operator|/
literal|2
condition|)
block|{
case|case
literal|0
case|:
name|sptr
index|[
operator|(
name|offset
operator|-
literal|84
operator|)
operator|/
literal|4
index|]
operator|.
name|turnfoul
operator|=
name|value
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|sptr
index|[
operator|(
name|offset
operator|-
literal|84
operator|)
operator|/
literal|4
index|]
operator|.
name|toship
operator|=
name|value
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|offset
operator|>=
literal|124
operator|&&
name|offset
operator|<
literal|164
condition|)
block|{
name|sptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|grapples
expr_stmt|;
switch|switch
condition|(
operator|(
operator|(
name|offset
operator|-
literal|124
operator|)
operator|%
literal|4
operator|)
operator|/
literal|2
condition|)
block|{
case|case
literal|0
case|:
name|sptr
index|[
operator|(
name|offset
operator|-
literal|124
operator|)
operator|/
literal|4
index|]
operator|.
name|turnfoul
operator|=
name|value
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|sptr
index|[
operator|(
name|offset
operator|-
literal|124
operator|)
operator|/
literal|4
index|]
operator|.
name|toship
operator|=
name|value
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|offset
operator|>
literal|72
condition|)
name|ptr
operator|=
operator|&
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|drift
expr_stmt|;
if|if
condition|(
name|offset
operator|>
literal|164
condition|)
name|ptr
operator|=
operator|&
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|RH
expr_stmt|;
name|cptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|captain
expr_stmt|;
if|if
condition|(
name|offset
operator|==
literal|72
condition|)
name|cptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|last
expr_stmt|;
if|if
condition|(
name|offset
operator|==
literal|164
condition|)
name|cptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|signal
expr_stmt|;
if|if
condition|(
operator|!
name|string
condition|)
operator|*
operator|(
name|ptr
operator|+
operator|(
name|offset
operator|-
operator|(
name|offset
operator|>
literal|72
condition|?
operator|(
name|offset
operator|<
literal|164
condition|?
literal|82
else|:
literal|224
operator|)
else|:
literal|20
operator|)
operator|)
operator|/
literal|2
operator|)
operator|=
name|value
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|cptr
argument_list|,
operator|(
name|char
operator|*
operator|)
name|value
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ptr
operator|=
operator|&
name|scene
index|[
name|game
index|]
operator|.
name|winddir
expr_stmt|;
operator|*
operator|(
name|ptr
operator|+
name|offset
operator|/
literal|2
operator|)
operator|=
name|value
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|sync
argument_list|()
end_macro

begin_block
block|{
name|char
name|file
index|[
literal|25
index|]
decl_stmt|;
name|char
name|source
index|[
literal|25
index|]
decl_stmt|;
name|int
name|address
decl_stmt|,
name|string
decl_stmt|;
name|int
name|offset
decl_stmt|,
name|value
index|[
literal|40
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|cptr
decl_stmt|;
name|struct
name|BP
modifier|*
name|bptr
decl_stmt|;
name|struct
name|snag
modifier|*
name|sptr
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
name|int
argument_list|(
operator|*
name|sig1
argument_list|)
argument_list|()
decl_stmt|,
argument_list|(
operator|*
name|sig2
argument_list|)
argument_list|()
decl_stmt|;
name|sig1
operator|=
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|sig2
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|file
argument_list|,
literal|"/tmp/sync.%d"
argument_list|,
name|game
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|source
argument_list|,
literal|"/tmp/.%d"
argument_list|,
name|game
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|link
argument_list|(
name|source
argument_list|,
name|file
argument_list|)
operator|==
operator|-
literal|1
operator|&&
name|n
operator|<
literal|30
condition|;
name|n
operator|++
control|)
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|syncfile
argument_list|,
name|lastsync
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|fscanf
argument_list|(
name|syncfile
argument_list|,
literal|"%d%d%d"
argument_list|,
operator|&
name|address
argument_list|,
operator|&
name|string
argument_list|,
operator|&
name|offset
argument_list|)
operator|!=
name|EOF
condition|)
block|{
if|if
condition|(
name|string
condition|)
block|{
name|fgets
argument_list|(
operator|(
name|char
operator|*
operator|)
name|value
argument_list|,
literal|60
argument_list|,
name|syncfile
argument_list|)
expr_stmt|;
name|rmend
argument_list|(
operator|(
name|char
operator|*
operator|)
name|value
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
operator|(
name|char
operator|*
operator|)
name|value
operator|==
literal|' '
condition|)
name|strcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|value
argument_list|,
operator|(
name|char
operator|*
operator|)
name|value
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|fscanf
argument_list|(
name|syncfile
argument_list|,
literal|"%d"
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|address
operator|<
literal|32
condition|)
block|{
name|ptr
operator|=
operator|&
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|shipnum
expr_stmt|;
operator|*
operator|(
name|ptr
operator|+
operator|(
name|offset
operator|-
literal|2
operator|)
operator|/
literal|2
operator|)
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|address
operator|<
literal|64
condition|)
block|{
name|address
operator|-=
name|SPECS
expr_stmt|;
name|ptr
operator|=
operator|&
name|specs
index|[
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|shipnum
index|]
operator|.
name|bs
expr_stmt|;
operator|*
operator|(
name|ptr
operator|+
name|offset
operator|/
literal|2
operator|)
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|address
operator|<
literal|128
condition|)
block|{
name|address
operator|-=
name|FILES
expr_stmt|;
name|ptr
operator|=
operator|&
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|points
expr_stmt|;
if|if
condition|(
name|offset
operator|>=
literal|30
operator|&&
name|offset
operator|<
literal|48
condition|)
block|{
name|bptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|OBP
expr_stmt|;
switch|switch
condition|(
operator|(
operator|(
name|offset
operator|-
literal|30
operator|)
operator|%
literal|6
operator|)
operator|/
literal|2
condition|)
block|{
case|case
literal|0
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|30
operator|)
operator|/
literal|6
index|]
operator|.
name|turnsent
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|30
operator|)
operator|/
literal|6
index|]
operator|.
name|toship
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|30
operator|)
operator|/
literal|6
index|]
operator|.
name|mensent
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|offset
operator|>=
literal|48
operator|&&
name|offset
operator|<
literal|66
condition|)
block|{
name|bptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|DBP
expr_stmt|;
switch|switch
condition|(
operator|(
operator|(
name|offset
operator|-
literal|48
operator|)
operator|%
literal|6
operator|)
operator|/
literal|2
condition|)
block|{
case|case
literal|0
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|48
operator|)
operator|/
literal|6
index|]
operator|.
name|turnsent
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|48
operator|)
operator|/
literal|6
index|]
operator|.
name|toship
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|bptr
index|[
operator|(
name|offset
operator|-
literal|48
operator|)
operator|/
literal|6
index|]
operator|.
name|mensent
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|offset
operator|>=
literal|84
operator|&&
name|offset
operator|<
literal|124
condition|)
block|{
name|sptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|fouls
expr_stmt|;
switch|switch
condition|(
operator|(
operator|(
name|offset
operator|-
literal|84
operator|)
operator|%
literal|4
operator|)
operator|/
literal|2
condition|)
block|{
case|case
literal|0
case|:
name|sptr
index|[
operator|(
name|offset
operator|-
literal|84
operator|)
operator|/
literal|4
index|]
operator|.
name|turnfoul
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|sptr
index|[
operator|(
name|offset
operator|-
literal|84
operator|)
operator|/
literal|4
index|]
operator|.
name|toship
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|offset
operator|>=
literal|124
operator|&&
name|offset
operator|<
literal|164
condition|)
block|{
name|sptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|grapples
expr_stmt|;
switch|switch
condition|(
operator|(
operator|(
name|offset
operator|-
literal|124
operator|)
operator|%
literal|4
operator|)
operator|/
literal|2
condition|)
block|{
case|case
literal|0
case|:
name|sptr
index|[
operator|(
name|offset
operator|-
literal|124
operator|)
operator|/
literal|4
index|]
operator|.
name|turnfoul
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|sptr
index|[
operator|(
name|offset
operator|-
literal|124
operator|)
operator|/
literal|4
index|]
operator|.
name|toship
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|offset
operator|>
literal|72
condition|)
name|ptr
operator|=
operator|&
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|drift
expr_stmt|;
if|if
condition|(
name|offset
operator|>
literal|164
condition|)
name|ptr
operator|=
operator|&
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|RH
expr_stmt|;
name|cptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|captain
expr_stmt|;
if|if
condition|(
name|offset
operator|==
literal|72
condition|)
name|cptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|last
expr_stmt|;
if|if
condition|(
name|offset
operator|==
literal|164
condition|)
name|cptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|address
index|]
operator|.
name|file
operator|->
name|signal
expr_stmt|;
if|if
condition|(
operator|!
name|string
condition|)
operator|*
operator|(
name|ptr
operator|+
operator|(
name|offset
operator|-
operator|(
name|offset
operator|>
literal|72
condition|?
operator|(
name|offset
operator|<
literal|164
condition|?
literal|82
else|:
literal|224
operator|)
else|:
literal|20
operator|)
operator|)
operator|/
literal|2
operator|)
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|cptr
argument_list|,
operator|(
name|char
operator|*
operator|)
name|value
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ptr
operator|=
operator|&
name|scene
index|[
name|game
index|]
operator|.
name|winddir
expr_stmt|;
operator|*
operator|(
name|ptr
operator|+
name|offset
operator|/
literal|2
operator|)
operator|=
name|value
index|[
literal|0
index|]
expr_stmt|;
block|}
if|if
condition|(
name|buffercount
condition|)
block|{
name|fseek
argument_list|(
name|syncfile
argument_list|,
literal|0L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|syncfile
argument_list|,
literal|"%s"
argument_list|,
name|Outbuf
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|syncfile
argument_list|)
expr_stmt|;
name|buffercount
operator|=
literal|0
expr_stmt|;
block|}
name|lastsync
operator|=
name|ftell
argument_list|(
name|syncfile
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|sig1
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|sig2
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rmend
argument_list|(
argument|str
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
operator|*
operator|(
name|str
operator|+
name|n
operator|)
condition|;
name|n
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|n
condition|)
operator|*
operator|(
name|str
operator|+
name|n
operator|-
literal|1
operator|)
operator|=
literal|'\0'
expr_stmt|;
block|}
end_block

begin_function
name|char
name|colours
parameter_list|(
name|ship
parameter_list|)
name|int
name|ship
decl_stmt|;
block|{
name|char
name|flag
decl_stmt|;
name|int
name|index
decl_stmt|;
name|struct
name|File
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|ship
index|]
operator|.
name|file
expr_stmt|;
if|if
condition|(
name|ptr
operator|->
name|struck
condition|)
name|flag
operator|=
literal|'!'
expr_stmt|;
if|if
condition|(
name|ptr
operator|->
name|explode
condition|)
name|flag
operator|=
literal|'#'
expr_stmt|;
if|if
condition|(
name|ptr
operator|->
name|sink
condition|)
name|flag
operator|=
literal|'~'
expr_stmt|;
if|if
condition|(
name|ptr
operator|->
name|struck
condition|)
return|return
operator|(
name|flag
operator|)
return|;
if|if
condition|(
name|ptr
operator|->
name|captured
operator|>
operator|-
literal|1
condition|)
name|index
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|ptr
operator|->
name|captured
index|]
operator|.
name|nationality
expr_stmt|;
else|else
name|index
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|ship
index|]
operator|.
name|nationality
expr_stmt|;
switch|switch
condition|(
name|index
condition|)
block|{
case|case
literal|0
case|:
name|flag
operator|=
literal|'a'
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|flag
operator|=
literal|'b'
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|flag
operator|=
literal|'s'
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|flag
operator|=
literal|'f'
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ptr
operator|->
name|FS
condition|?
name|flag
operator|-
literal|32
else|:
name|flag
operator|)
return|;
block|}
end_function

begin_function
name|char
name|sterncolor
parameter_list|(
name|ship
parameter_list|,
name|sternr
parameter_list|,
name|sternc
parameter_list|)
name|int
name|ship
decl_stmt|,
decl|*
name|sternr
decl_stmt|,
modifier|*
name|sternc
decl_stmt|;
end_function

begin_block
block|{
name|int
name|sr
decl_stmt|,
name|sc
decl_stmt|;
name|int
name|cap
decl_stmt|;
name|cap
operator|=
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|ship
index|]
operator|.
name|file
operator|->
name|captured
expr_stmt|;
name|sr
operator|=
name|pos
index|[
name|ship
index|]
operator|.
name|row
expr_stmt|;
name|sc
operator|=
name|pos
index|[
name|ship
index|]
operator|.
name|col
expr_stmt|;
name|drdc
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sc
argument_list|,
name|pos
index|[
name|ship
index|]
operator|.
name|dir
argument_list|)
expr_stmt|;
operator|*
name|sternr
operator|=
name|sr
expr_stmt|;
operator|*
name|sternc
operator|=
name|sc
expr_stmt|;
name|ship
operator|-=
name|nation
index|[
name|scene
index|[
name|game
index|]
operator|.
name|ship
index|[
name|ship
index|]
operator|.
name|nationality
index|]
expr_stmt|;
return|return
operator|(
name|ship
operator|+
literal|'0'
operator|-
literal|10
operator|*
operator|(
name|cap
operator|>
operator|-
literal|1
operator|)
operator|)
return|;
block|}
end_block

end_unit


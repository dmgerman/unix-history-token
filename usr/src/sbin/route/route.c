begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1983, 1989 The Regents of the University of California.  * All rights reserved.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the University of California, Berkeley.  The name of the  * University may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1983 The Regents of the University of California.\n\  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)route.c	5.23 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kinfo.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netns/ns.h>
end_include

begin_include
include|#
directive|include
file|<netiso/iso.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_struct
struct|struct
name|keytab
block|{
name|char
modifier|*
name|kt_cp
decl_stmt|;
name|int
name|kt_i
decl_stmt|;
block|}
name|keywords
index|[]
init|=
block|{
include|#
directive|include
file|"keywords.h"
block|{
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|ortentry
name|route
decl_stmt|;
end_decl_stmt

begin_union
union|union
name|sockunion
block|{
name|struct
name|sockaddr
name|sa
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|struct
name|sockaddr_ns
name|sns
decl_stmt|;
name|struct
name|sockaddr_iso
name|siso
decl_stmt|;
name|struct
name|sockaddr_dl
name|sdl
decl_stmt|;
block|}
name|so_dst
union|,
name|so_gate
union|,
name|so_mask
union|,
name|so_genmask
union|,
name|so_ifa
union|,
name|so_ifp
union|,
modifier|*
name|so_addrs
index|[]
init|=
block|{
operator|&
name|so_dst
block|,
operator|&
name|so_gate
block|,
operator|&
name|so_mask
block|,
operator|&
name|so_genmask
block|,
operator|&
name|so_ifa
block|,
operator|&
name|so_ifp
block|,
literal|0
block|}
union|;
end_union

begin_typedef
typedef|typedef
name|union
name|sockunion
modifier|*
name|sup
typedef|;
end_typedef

begin_decl_stmt
name|int
name|pid
decl_stmt|,
name|rtm_addrs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|forcehost
decl_stmt|,
name|forcenet
decl_stmt|,
name|doflush
decl_stmt|,
name|nflag
decl_stmt|,
name|af
decl_stmt|,
name|qflag
decl_stmt|,
name|Cflag
decl_stmt|,
name|keyword
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|iflag
decl_stmt|,
name|verbose
decl_stmt|,
name|aflen
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|locking
decl_stmt|,
name|lockrest
decl_stmt|,
name|debugonly
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr_in
name|sin
init|=
block|{
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
block|,
name|AF_INET
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|rt_metrics
name|rt_metrics
decl_stmt|;
end_decl_stmt

begin_function_decl
name|struct
name|in_addr
name|inet_makeaddr
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
modifier|*
name|malloc
argument_list|()
decl_stmt|,
modifier|*
name|routename
argument_list|()
decl_stmt|,
modifier|*
name|netname
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|iso_ntoa
argument_list|()
decl_stmt|,
modifier|*
name|link_ntoa
argument_list|()
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|kget
parameter_list|(
name|p
parameter_list|,
name|d
parameter_list|)
define|\
value|(lseek(kmem, (off_t)(p), 0), read(kmem, (char *)&(d), sizeof (d)))
end_define

begin_macro
name|usage
argument_list|(
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: route [ -nqCv ]  cmd [[ -<qualifers> ] args ]\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"(botched keyword: %s)\n"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|char
modifier|*
name|argvp
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
for|for
control|(
init|;
name|argc
operator|>
literal|0
operator|&&
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|;
name|argc
operator|--
operator|,
name|argv
operator|++
control|)
block|{
for|for
control|(
name|argvp
operator|=
name|argv
index|[
literal|0
index|]
operator|++
init|;
operator|*
name|argvp
condition|;
name|argvp
operator|++
control|)
switch|switch
condition|(
operator|*
name|argv
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'n'
case|:
name|nflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|qflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|Cflag
operator|++
expr_stmt|;
comment|/* Use old ioctls */
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
block|}
block|}
name|pid
operator|=
name|getpid
argument_list|()
expr_stmt|;
if|if
condition|(
name|Cflag
condition|)
name|s
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_RAW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|s
operator|=
name|socket
argument_list|(
name|PF_ROUTE
argument_list|,
name|SOCK_RAW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"route: socket"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
switch|switch
condition|(
name|keyword
argument_list|(
operator|*
name|argv
argument_list|)
condition|)
block|{
case|case
name|K_ADD
case|:
case|case
name|K_CHANGE
case|:
case|case
name|K_DELETE
case|:
name|newroute
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
case|case
name|K_MONITOR
case|:
name|monitor
argument_list|()
expr_stmt|;
case|case
name|K_FLUSH
case|:
name|flushroutes
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
block|}
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Purge all entries in the routing tables not  * associated with network interfaces.  */
end_comment

begin_macro
name|flushroutes
argument_list|(
argument|argc
argument_list|,
argument|argv
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|bufsize
decl_stmt|,
name|needed
decl_stmt|,
name|seqno
decl_stmt|,
name|rlen
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|next
decl_stmt|,
modifier|*
name|lim
decl_stmt|;
specifier|register
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
struct|struct
block|{
name|struct
name|rt_msghdr
name|m_rtm
decl_stmt|;
union|union
block|{
name|char
name|u_saddrs
index|[
literal|200
index|]
decl_stmt|;
name|struct
name|sockaddr
name|u_sa
decl_stmt|;
block|}
name|m_u
union|;
block|}
name|m
struct|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
operator|&&
operator|*
operator|*
name|argv
operator|==
literal|'-'
condition|)
switch|switch
condition|(
name|keyword
argument_list|(
literal|1
operator|+
operator|*
name|argv
argument_list|)
condition|)
block|{
case|case
name|K_INET
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
break|break;
case|case
name|K_XNS
case|:
name|af
operator|=
name|AF_NS
expr_stmt|;
break|break;
case|case
name|K_LINK
case|:
name|af
operator|=
name|AF_LINK
expr_stmt|;
break|break;
case|case
name|K_ISO
case|:
case|case
name|K_OSI
case|:
name|af
operator|=
name|AF_ISO
expr_stmt|;
break|break;
default|default:
goto|goto
name|bad
goto|;
block|}
else|else
name|bad
label|:
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|needed
operator|=
name|getkerninfo
argument_list|(
name|KINFO_RT_DUMP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"route-getkerninfo-estimate"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|needed
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"out of space\n"
argument_list|)
expr_stmt|;
empty_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rlen
operator|=
name|getkerninfo
argument_list|(
name|KINFO_RT_DUMP
argument_list|,
name|buf
argument_list|,
operator|&
name|needed
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"actual retrieval of routing table"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|lim
operator|=
name|buf
operator|+
name|rlen
expr_stmt|;
for|for
control|(
name|next
operator|=
name|buf
init|;
name|next
operator|<
name|lim
condition|;
name|next
operator|+=
name|rtm
operator|->
name|rtm_msglen
control|)
block|{
name|rtm
operator|=
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
name|next
expr_stmt|;
if|if
condition|(
operator|(
name|rtm
operator|->
name|rtm_flags
operator|&
name|RTF_GATEWAY
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|af
condition|)
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
decl_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|!=
name|af
condition|)
continue|continue;
block|}
name|rtm
operator|->
name|rtm_type
operator|=
name|RTM_DELETE
expr_stmt|;
name|rtm
operator|->
name|rtm_seq
operator|=
name|seqno
expr_stmt|;
if|if
condition|(
operator|(
name|rlen
operator|=
name|write
argument_list|(
name|s
argument_list|,
name|next
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"writing to routing socket"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"got only %d for rlen\n"
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
break|break;
block|}
name|again
label|:
if|if
condition|(
operator|(
name|rlen
operator|=
name|read
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m
argument_list|,
sizeof|sizeof
argument_list|(
name|m
argument_list|)
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"reading from routing socket"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"got only %d for rlen\n"
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|m
operator|.
name|m_rtm
operator|.
name|rtm_pid
operator|!=
name|pid
operator|)
operator|||
operator|(
name|m
operator|.
name|m_rtm
operator|.
name|rtm_seq
operator|!=
name|seqno
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Got response for somebody else's request"
argument_list|)
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|seqno
operator|++
expr_stmt|;
if|if
condition|(
name|qflag
condition|)
continue|continue;
if|if
condition|(
name|verbose
condition|)
block|{
name|print_rtmsg
argument_list|(
name|rtm
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
operator|&
name|m
operator|.
name|m_u
operator|.
name|u_sa
decl_stmt|;
name|printf
argument_list|(
literal|"%-20.20s "
argument_list|,
operator|(
name|rtm
operator|->
name|rtm_flags
operator|&
name|RTF_HOST
operator|)
condition|?
name|routename
argument_list|(
name|sa
argument_list|)
else|:
name|netname
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|sa
operator|->
name|sa_len
operator|+
operator|(
name|char
operator|*
operator|)
name|sa
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-20.20s "
argument_list|,
name|routename
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|routename
parameter_list|(
name|sa
parameter_list|)
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|static
name|char
name|line
index|[
literal|50
index|]
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
specifier|static
name|char
name|domain
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|int
name|first
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|index
parameter_list|()
function_decl|;
name|char
modifier|*
name|ns_print
parameter_list|()
function_decl|;
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|gethostname
argument_list|(
name|domain
argument_list|,
name|MAXHOSTNAMELEN
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|cp
operator|=
name|index
argument_list|(
name|domain
argument_list|,
literal|'.'
argument_list|)
operator|)
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|domain
argument_list|,
name|cp
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|domain
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|in
decl_stmt|;
name|in
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
expr_stmt|;
name|cp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|in
operator|.
name|s_addr
operator|==
name|INADDR_ANY
condition|)
name|cp
operator|=
literal|"default"
expr_stmt|;
if|if
condition|(
name|cp
operator|==
literal|0
operator|&&
operator|!
name|nflag
condition|)
block|{
name|hp
operator|=
name|gethostbyaddr
argument_list|(
operator|&
name|in
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
condition|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|index
argument_list|(
name|hp
operator|->
name|h_name
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|&&
operator|!
name|strcmp
argument_list|(
name|cp
operator|+
literal|1
argument_list|,
name|domain
argument_list|)
condition|)
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
name|cp
operator|=
name|hp
operator|->
name|h_name
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cp
condition|)
name|strcpy
argument_list|(
name|line
argument_list|,
name|cp
argument_list|)
expr_stmt|;
else|else
block|{
define|#
directive|define
name|C
parameter_list|(
name|x
parameter_list|)
value|((x)& 0xff)
name|in
operator|.
name|s_addr
operator|=
name|ntohl
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u.%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|8
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|AF_NS
case|:
return|return
operator|(
name|ns_print
argument_list|(
operator|(
expr|struct
name|sockaddr_ns
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
case|case
name|AF_LINK
case|:
return|return
operator|(
name|link_ntoa
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
case|case
name|AF_ISO
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"iso %s"
argument_list|,
name|iso_ntoa
argument_list|(
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_iso
operator|*
operator|)
name|sa
operator|)
operator|->
name|siso_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
block|{
name|u_short
modifier|*
name|s
init|=
operator|(
name|u_short
operator|*
operator|)
name|sa
operator|->
name|sa_data
decl_stmt|;
name|u_short
modifier|*
name|slim
init|=
name|s
operator|+
operator|(
operator|(
name|sa
operator|->
name|sa_len
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|line
operator|+
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"(%d)"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
decl_stmt|;
name|int
name|n
decl_stmt|;
while|while
condition|(
name|s
operator|<
name|slim
condition|)
block|{
name|n
operator|=
name|sprintf
argument_list|(
name|cp
argument_list|,
literal|" %x"
argument_list|,
operator|*
name|s
argument_list|)
expr_stmt|;
name|s
operator|++
expr_stmt|;
name|cp
operator|+=
name|n
expr_stmt|;
block|}
break|break;
block|}
block|}
return|return
operator|(
name|line
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return the name of the network whose address is given.  * The address is assumed to be that of a net or subnet, not a host.  */
end_comment

begin_function
name|char
modifier|*
name|netname
parameter_list|(
name|sa
parameter_list|)
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
block|{
name|char
modifier|*
name|cp
init|=
literal|0
decl_stmt|;
specifier|static
name|char
name|line
index|[
literal|50
index|]
decl_stmt|;
name|struct
name|netent
modifier|*
name|np
init|=
literal|0
decl_stmt|;
name|u_long
name|net
decl_stmt|,
name|mask
decl_stmt|;
specifier|register
name|u_long
name|i
decl_stmt|;
name|int
name|subnetshift
decl_stmt|;
name|char
modifier|*
name|ns_print
parameter_list|()
function_decl|;
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|in
decl_stmt|;
name|in
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
expr_stmt|;
name|i
operator|=
name|in
operator|.
name|s_addr
operator|=
name|ntohl
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|.
name|s_addr
operator|==
literal|0
condition|)
name|cp
operator|=
literal|"default"
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|nflag
condition|)
block|{
if|if
condition|(
name|IN_CLASSA
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|mask
operator|=
name|IN_CLASSA_NET
expr_stmt|;
name|subnetshift
operator|=
literal|8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IN_CLASSB
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|mask
operator|=
name|IN_CLASSB_NET
expr_stmt|;
name|subnetshift
operator|=
literal|8
expr_stmt|;
block|}
else|else
block|{
name|mask
operator|=
name|IN_CLASSC_NET
expr_stmt|;
name|subnetshift
operator|=
literal|4
expr_stmt|;
block|}
comment|/* 			 * If there are more bits than the standard mask 			 * would suggest, subnets must be in use. 			 * Guess at the subnet mask, assuming reasonable 			 * width subnet fields. 			 */
while|while
condition|(
name|in
operator|.
name|s_addr
operator|&
operator|~
name|mask
condition|)
name|mask
operator|=
operator|(
name|long
operator|)
name|mask
operator|>>
name|subnetshift
expr_stmt|;
name|net
operator|=
name|in
operator|.
name|s_addr
operator|&
name|mask
expr_stmt|;
while|while
condition|(
operator|(
name|mask
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|mask
operator|>>=
literal|1
operator|,
name|net
operator|>>=
literal|1
expr_stmt|;
name|np
operator|=
name|getnetbyaddr
argument_list|(
name|net
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
condition|)
name|cp
operator|=
name|np
operator|->
name|n_name
expr_stmt|;
block|}
if|if
condition|(
name|cp
condition|)
name|strcpy
argument_list|(
name|line
argument_list|,
name|cp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xffffff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xffff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|8
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u.%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|8
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AF_NS
case|:
return|return
operator|(
name|ns_print
argument_list|(
operator|(
expr|struct
name|sockaddr_ns
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
break|break;
case|case
name|AF_LINK
case|:
return|return
operator|(
name|link_ntoa
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
case|case
name|AF_ISO
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"iso %s"
argument_list|,
name|iso_ntoa
argument_list|(
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_iso
operator|*
operator|)
name|sa
operator|)
operator|->
name|siso_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
block|{
name|u_short
modifier|*
name|s
init|=
operator|(
name|u_short
operator|*
operator|)
name|sa
operator|->
name|sa_data
decl_stmt|;
name|u_short
modifier|*
name|slim
init|=
name|s
operator|+
operator|(
operator|(
name|sa
operator|->
name|sa_len
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|line
operator|+
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"af %d:"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
decl_stmt|;
name|int
name|n
decl_stmt|;
while|while
condition|(
name|s
operator|<
name|slim
condition|)
block|{
name|n
operator|=
name|sprintf
argument_list|(
name|cp
argument_list|,
literal|" %x"
argument_list|,
operator|*
name|s
argument_list|)
expr_stmt|;
name|s
operator|++
expr_stmt|;
name|cp
operator|+=
name|n
expr_stmt|;
block|}
break|break;
block|}
block|}
return|return
operator|(
name|line
operator|)
return|;
block|}
end_function

begin_macro
name|set_metric
argument_list|(
argument|value
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|value
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|flag
init|=
literal|0
decl_stmt|;
name|u_long
name|noval
decl_stmt|,
modifier|*
name|valp
init|=
operator|&
name|noval
decl_stmt|;
switch|switch
condition|(
name|key
condition|)
block|{
define|#
directive|define
name|caseof
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|case x: valp =&rt_metrics.z; flag = y; break
name|caseof
argument_list|(
name|K_MTU
argument_list|,
name|RTV_MTU
argument_list|,
name|rmx_mtu
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_HOPCOUNT
argument_list|,
name|RTV_HOPCOUNT
argument_list|,
name|rmx_hopcount
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_EXPIRE
argument_list|,
name|RTV_EXPIRE
argument_list|,
name|rmx_expire
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RECVPIPE
argument_list|,
name|RTV_RPIPE
argument_list|,
name|rmx_recvpipe
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_SENDPIPE
argument_list|,
name|RTV_SPIPE
argument_list|,
name|rmx_sendpipe
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_SSTHRESH
argument_list|,
name|RTV_SSTHRESH
argument_list|,
name|rmx_ssthresh
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RTT
argument_list|,
name|RTV_RTT
argument_list|,
name|rmx_rtt
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RTTVAR
argument_list|,
name|RTV_RTTVAR
argument_list|,
name|rmx_rttvar
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lockrest
operator|||
name|locking
condition|)
name|rt_metrics
operator|.
name|rmx_locks
operator||=
name|flag
expr_stmt|;
if|if
condition|(
name|locking
condition|)
name|locking
operator|=
literal|0
expr_stmt|;
operator|*
name|valp
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|newroute
argument_list|(
argument|argc
argument_list|,
argument|argv
argument_list|)
end_macro

begin_decl_stmt
name|int
name|argc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|char
modifier|*
name|cmd
decl_stmt|,
modifier|*
name|dest
decl_stmt|,
modifier|*
name|gateway
decl_stmt|,
modifier|*
name|mask
decl_stmt|;
name|int
name|ishost
decl_stmt|,
name|metric
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|,
name|attempts
decl_stmt|,
name|oerrno
decl_stmt|,
name|flags
init|=
literal|0
decl_stmt|,
name|next
decl_stmt|;
name|int
name|key
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
init|=
literal|0
decl_stmt|;
specifier|extern
name|int
name|errno
decl_stmt|;
name|cmd
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|(
operator|++
name|argv
operator|)
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
name|key
operator|=
name|keyword
argument_list|(
literal|1
operator|+
operator|*
name|argv
argument_list|)
condition|)
block|{
case|case
name|K_LINK
case|:
name|af
operator|=
name|AF_LINK
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_dl
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_OSI
case|:
case|case
name|K_ISO
case|:
name|af
operator|=
name|AF_ISO
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_iso
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_INET
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_XNS
case|:
name|af
operator|=
name|AF_NS
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_ns
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_IFACE
case|:
case|case
name|K_INTERFACE
case|:
name|iflag
operator|++
expr_stmt|;
break|break;
case|case
name|K_LOCK
case|:
name|locking
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|K_LOCKREST
case|:
name|lockrest
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|K_HOST
case|:
name|forcehost
operator|++
expr_stmt|;
break|break;
case|case
name|K_NETMASK
case|:
name|argc
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_NETMASK
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|K_NET
case|:
name|forcenet
operator|++
expr_stmt|;
break|break;
case|case
name|K_CLONING
case|:
name|flags
operator||=
name|RTF_CLONING
expr_stmt|;
break|break;
case|case
name|K_XRESOLVE
case|:
name|flags
operator||=
name|RTF_XRESOLVE
expr_stmt|;
break|break;
case|case
name|K_GENMASK
case|:
name|argc
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_GENMASK
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_MTU
case|:
case|case
name|K_HOPCOUNT
case|:
case|case
name|K_EXPIRE
case|:
case|case
name|K_RECVPIPE
case|:
case|case
name|K_SENDPIPE
case|:
case|case
name|K_SSTHRESH
case|:
case|case
name|K_RTT
case|:
case|case
name|K_RTTVAR
case|:
name|argc
operator|--
expr_stmt|;
name|set_metric
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
name|key
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
literal|1
operator|+
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|rtm_addrs
operator|&
name|RTA_DST
operator|)
operator|==
literal|0
condition|)
block|{
name|dest
operator|=
operator|*
name|argv
expr_stmt|;
name|ishost
operator|=
name|getaddr
argument_list|(
name|RTA_DST
argument_list|,
operator|*
name|argv
argument_list|,
operator|&
name|hp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rtm_addrs
operator|&
name|RTA_GATEWAY
operator|)
operator|==
literal|0
condition|)
block|{
name|gateway
operator|=
operator|*
name|argv
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_GATEWAY
argument_list|,
operator|*
name|argv
argument_list|,
operator|&
name|hp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|ret
init|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s,%s"
argument_list|,
literal|"old usage of trailing 0"
argument_list|,
literal|"assuming route to if\n"
argument_list|)
expr_stmt|;
name|iflag
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|ret
operator|>
literal|0
operator|&&
name|ret
operator|<
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|"old usage of trailing digit, "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"assuming route via gateway\n"
argument_list|)
expr_stmt|;
name|iflag
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_NETMASK
argument_list|,
operator|*
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|forcehost
condition|)
name|ishost
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|forcenet
condition|)
name|ishost
operator|=
literal|0
expr_stmt|;
name|flags
operator||=
name|RTF_UP
expr_stmt|;
if|if
condition|(
name|ishost
condition|)
name|flags
operator||=
name|RTF_HOST
expr_stmt|;
if|if
condition|(
name|iflag
operator|==
literal|0
condition|)
name|flags
operator||=
name|RTF_GATEWAY
expr_stmt|;
for|for
control|(
name|attempts
operator|=
literal|1
init|;
condition|;
name|attempts
operator|++
control|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|Cflag
operator|&&
operator|(
name|af
operator|==
name|AF_INET
operator|||
name|af
operator|==
name|AF_NS
operator|)
condition|)
block|{
name|route
operator|.
name|rt_flags
operator|=
name|flags
expr_stmt|;
name|route
operator|.
name|rt_dst
operator|=
name|so_dst
operator|.
name|sa
expr_stmt|;
name|route
operator|.
name|rt_gateway
operator|=
name|so_gate
operator|.
name|sa
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|s
argument_list|,
operator|*
name|cmd
operator|==
literal|'a'
condition|?
name|SIOCADDRT
else|:
name|SIOCDELRT
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|route
argument_list|)
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ret
operator|=
name|rtmsg
argument_list|(
operator|*
name|cmd
argument_list|,
name|flags
argument_list|)
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
break|break;
block|}
if|if
condition|(
name|errno
operator|!=
name|ENETUNREACH
operator|&&
name|errno
operator|!=
name|ESRCH
condition|)
break|break;
if|if
condition|(
name|hp
operator|&&
name|hp
operator|->
name|h_addr_list
index|[
literal|1
index|]
condition|)
block|{
name|hp
operator|->
name|h_addr_list
operator|++
expr_stmt|;
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr_list
index|[
literal|0
index|]
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|so_dst
operator|.
name|sin
operator|.
name|sin_addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
block|}
else|else
break|break;
block|}
name|oerrno
operator|=
name|errno
expr_stmt|;
name|printf
argument_list|(
literal|"%s %s %s: gateway %s"
argument_list|,
name|cmd
argument_list|,
name|ishost
condition|?
literal|"host"
else|:
literal|"net"
argument_list|,
name|dest
argument_list|,
name|gateway
argument_list|)
expr_stmt|;
if|if
condition|(
name|attempts
operator|>
literal|1
operator|&&
name|ret
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|" (%s)"
argument_list|,
name|inet_ntoa
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|route
operator|.
name|rt_gateway
operator|)
operator|->
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|": "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|errno
operator|=
name|oerrno
expr_stmt|;
name|error
argument_list|(
literal|""
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|error
argument_list|(
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|int
name|errno
decl_stmt|;
switch|switch
condition|(
name|errno
condition|)
block|{
case|case
name|ESRCH
case|:
name|printf
argument_list|(
literal|"not in table\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|EBUSY
case|:
name|printf
argument_list|(
literal|"entry in use\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ENOBUFS
case|:
name|printf
argument_list|(
literal|"routing table overflow\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"ioctl returns %d\n"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|savestr
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|char
modifier|*
name|sav
decl_stmt|;
name|sav
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sav
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
literal|"route: out of memory\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|sav
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|sav
operator|)
return|;
block|}
end_function

begin_macro
name|inet_makenetandmask
argument_list|(
argument|net
argument_list|,
argument|sin
argument_list|)
end_macro

begin_decl_stmt
name|u_long
name|net
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|u_long
name|addr
decl_stmt|;
name|u_long
name|mask
init|=
literal|0
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
if|if
condition|(
name|net
operator|==
literal|0
condition|)
name|mask
operator|=
name|addr
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|net
operator|<
literal|128
condition|)
block|{
name|addr
operator|=
name|net
operator|<<
name|IN_CLASSA_NSHIFT
expr_stmt|;
name|mask
operator|=
name|IN_CLASSA_NET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|net
operator|<
literal|65536
condition|)
block|{
name|addr
operator|=
name|net
operator|<<
name|IN_CLASSB_NSHIFT
expr_stmt|;
name|mask
operator|=
name|IN_CLASSB_NET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|net
operator|<
literal|16777216L
condition|)
block|{
name|addr
operator|=
name|net
operator|<<
name|IN_CLASSC_NSHIFT
expr_stmt|;
name|mask
operator|=
name|IN_CLASSC_NET
expr_stmt|;
block|}
else|else
block|{
name|addr
operator|=
name|net
expr_stmt|;
if|if
condition|(
operator|(
name|addr
operator|&
name|IN_CLASSA_HOST
operator|)
operator|==
literal|0
condition|)
name|mask
operator|=
name|IN_CLASSA_NET
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|addr
operator|&
name|IN_CLASSB_HOST
operator|)
operator|==
literal|0
condition|)
name|mask
operator|=
name|IN_CLASSB_NET
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|addr
operator|&
name|IN_CLASSC_HOST
operator|)
operator|==
literal|0
condition|)
name|mask
operator|=
name|IN_CLASSC_NET
expr_stmt|;
else|else
name|mask
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|sin
operator|=
operator|&
name|so_mask
operator|.
name|sin
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|mask
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_len
operator|=
literal|0
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
literal|0
expr_stmt|;
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
literal|1
operator|+
operator|&
operator|(
name|sin
operator|->
name|sin_addr
operator|)
operator|)
expr_stmt|;
while|while
condition|(
operator|*
operator|--
name|cp
operator|==
literal|0
operator|&&
name|cp
operator|>
operator|(
name|char
operator|*
operator|)
name|sin
condition|)
empty_stmt|;
name|sin
operator|->
name|sin_len
operator|=
literal|1
operator|+
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
name|sin
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Interpret an argument as a network address of some kind,  * returning 1 if a host address, 0 if a network address.  */
end_comment

begin_macro
name|getaddr
argument_list|(
argument|which
argument_list|,
argument|s
argument_list|,
argument|hpp
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|hostent
modifier|*
modifier|*
name|hpp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|union
name|sockunion
modifier|*
name|su
decl_stmt|;
name|struct
name|ns_addr
name|ns_addr
parameter_list|()
function_decl|;
name|struct
name|iso_addr
modifier|*
name|iso_addr
parameter_list|()
function_decl|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|netent
modifier|*
name|np
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|af
operator|==
literal|0
condition|)
block|{
name|af
operator|=
name|AF_INET
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
block|}
name|rtm_addrs
operator||=
name|which
expr_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|RTA_DST
case|:
name|su
operator|=
name|so_addrs
index|[
literal|0
index|]
expr_stmt|;
name|su
operator|->
name|sa
operator|.
name|sa_family
operator|=
name|af
expr_stmt|;
break|break;
case|case
name|RTA_GATEWAY
case|:
name|su
operator|=
name|so_addrs
index|[
literal|1
index|]
expr_stmt|;
name|su
operator|->
name|sa
operator|.
name|sa_family
operator|=
name|af
expr_stmt|;
break|break;
case|case
name|RTA_NETMASK
case|:
name|su
operator|=
name|so_addrs
index|[
literal|2
index|]
expr_stmt|;
break|break;
case|case
name|RTA_GENMASK
case|:
name|su
operator|=
name|so_addrs
index|[
literal|3
index|]
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
literal|"Internal Error"
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
name|su
operator|->
name|sa
operator|.
name|sa_len
operator|=
name|aflen
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|s
argument_list|,
literal|"default"
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|RTA_DST
case|:
name|forcenet
operator|++
expr_stmt|;
name|getaddr
argument_list|(
name|RTA_NETMASK
argument_list|,
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTA_NETMASK
case|:
case|case
name|RTA_GENMASK
case|:
name|su
operator|->
name|sa
operator|.
name|sa_len
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|af
operator|==
name|AF_NS
condition|)
goto|goto
name|do_xns
goto|;
if|if
condition|(
name|af
operator|==
name|AF_OSI
condition|)
goto|goto
name|do_osi
goto|;
if|if
condition|(
name|af
operator|==
name|AF_LINK
condition|)
goto|goto
name|do_link
goto|;
if|if
condition|(
name|hpp
operator|==
literal|0
condition|)
name|hpp
operator|=
operator|&
name|hp
expr_stmt|;
operator|*
name|hpp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|val
operator|=
name|inet_addr
argument_list|(
name|s
argument_list|)
operator|)
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|which
operator|!=
name|RTA_DST
operator|||
name|forcenet
operator|==
literal|0
operator|)
condition|)
block|{
name|su
operator|->
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|val
expr_stmt|;
if|if
condition|(
name|inet_lnaof
argument_list|(
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|)
operator|!=
name|INADDR_ANY
condition|)
return|return
operator|(
literal|1
operator|)
return|;
else|else
block|{
name|val
operator|=
name|ntohl
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|which
operator|==
name|RTA_DST
condition|)
name|inet_makenetandmask
argument_list|(
name|val
argument_list|,
operator|&
name|su
operator|->
name|sin
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|val
operator|=
name|inet_network
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
operator|-
literal|1
condition|)
block|{
goto|goto
name|out
goto|;
block|}
name|np
operator|=
name|getnetbyname
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
condition|)
block|{
name|val
operator|=
name|np
operator|->
name|n_net
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|hp
operator|=
name|gethostbyname
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
condition|)
block|{
operator|*
name|hpp
operator|=
name|hp
expr_stmt|;
name|su
operator|->
name|sin
operator|.
name|sin_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr
argument_list|,
operator|&
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad value\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|do_xns
label|:
if|if
condition|(
name|val
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|which
operator|==
name|RTA_DST
condition|)
block|{
specifier|extern
name|short
name|ns_bh
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|sockaddr_ns
modifier|*
name|sms
init|=
operator|&
operator|(
name|so_mask
operator|.
name|sns
operator|)
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sms
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sms
argument_list|)
argument_list|)
expr_stmt|;
name|sms
operator|->
name|sns_family
operator|=
literal|0
expr_stmt|;
name|sms
operator|->
name|sns_len
operator|=
literal|6
expr_stmt|;
name|sms
operator|->
name|sns_addr
operator|.
name|x_net
operator|=
operator|*
operator|(
expr|union
name|ns_net
operator|*
operator|)
name|ns_bh
expr_stmt|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
block|}
name|su
operator|->
name|sns
operator|.
name|sns_addr
operator|=
name|ns_addr
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
operator|!
name|ns_nullhost
argument_list|(
name|su
operator|->
name|sns
operator|.
name|sns_addr
argument_list|)
operator|)
return|;
name|do_osi
label|:
name|su
operator|->
name|siso
operator|.
name|siso_addr
operator|=
operator|*
name|iso_addr
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|which
operator|==
name|RTA_NETMASK
operator|||
name|which
operator|==
name|RTA_GENMASK
condition|)
block|{
specifier|register
name|char
modifier|*
name|cp
init|=
operator|(
name|char
operator|*
operator|)
name|TSEL
argument_list|(
operator|&
name|su
operator|->
name|siso
argument_list|)
decl_stmt|;
name|su
operator|->
name|siso
operator|.
name|siso_nlen
operator|=
literal|0
expr_stmt|;
do|do
block|{
operator|--
name|cp
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|cp
operator|>
operator|(
name|char
operator|*
operator|)
name|su
operator|)
operator|&&
operator|(
operator|*
name|cp
operator|==
literal|0
operator|)
condition|)
do|;
name|su
operator|->
name|siso
operator|.
name|siso_len
operator|=
literal|1
operator|+
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
name|su
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
name|do_link
label|:
name|link_addr
argument_list|(
name|s
argument_list|,
operator|&
name|su
operator|->
name|sdl
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_decl_stmt
name|short
name|ns_nullh
index|[]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|ns_bh
index|[]
init|=
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|char
modifier|*
name|ns_print
parameter_list|(
name|sns
parameter_list|)
name|struct
name|sockaddr_ns
modifier|*
name|sns
decl_stmt|;
block|{
name|struct
name|ns_addr
name|work
decl_stmt|;
union|union
block|{
name|union
name|ns_net
name|net_e
decl_stmt|;
name|u_long
name|long_e
decl_stmt|;
block|}
name|net
union|;
name|u_short
name|port
decl_stmt|;
specifier|static
name|char
name|mybuf
index|[
literal|50
index|]
decl_stmt|,
name|cport
index|[
literal|10
index|]
decl_stmt|,
name|chost
index|[
literal|25
index|]
decl_stmt|;
name|char
modifier|*
name|host
init|=
literal|""
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|u_char
modifier|*
name|q
decl_stmt|;
name|u_char
modifier|*
name|q_lim
decl_stmt|;
name|work
operator|=
name|sns
operator|->
name|sns_addr
expr_stmt|;
name|port
operator|=
name|ntohs
argument_list|(
name|work
operator|.
name|x_port
argument_list|)
expr_stmt|;
name|work
operator|.
name|x_port
operator|=
literal|0
expr_stmt|;
name|net
operator|.
name|net_e
operator|=
name|work
operator|.
name|x_net
expr_stmt|;
if|if
condition|(
name|ns_nullhost
argument_list|(
name|work
argument_list|)
operator|&&
name|net
operator|.
name|long_e
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|port
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|mybuf
argument_list|,
literal|"*.%xH"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|upHex
argument_list|(
name|mybuf
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|mybuf
argument_list|,
literal|"*.*"
argument_list|)
expr_stmt|;
return|return
operator|(
name|mybuf
operator|)
return|;
block|}
if|if
condition|(
name|bcmp
argument_list|(
name|ns_bh
argument_list|,
name|work
operator|.
name|x_host
operator|.
name|c_host
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|host
operator|=
literal|"any"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bcmp
argument_list|(
name|ns_nullh
argument_list|,
name|work
operator|.
name|x_host
operator|.
name|c_host
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|host
operator|=
literal|"*"
expr_stmt|;
block|}
else|else
block|{
name|q
operator|=
name|work
operator|.
name|x_host
operator|.
name|c_host
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|chost
argument_list|,
literal|"%02x%02x%02x%02x%02x%02xH"
argument_list|,
name|q
index|[
literal|0
index|]
argument_list|,
name|q
index|[
literal|1
index|]
argument_list|,
name|q
index|[
literal|2
index|]
argument_list|,
name|q
index|[
literal|3
index|]
argument_list|,
name|q
index|[
literal|4
index|]
argument_list|,
name|q
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|chost
init|;
operator|*
name|p
operator|==
literal|'0'
operator|&&
name|p
operator|<
name|chost
operator|+
literal|12
condition|;
name|p
operator|++
control|)
empty_stmt|;
name|host
operator|=
name|p
expr_stmt|;
block|}
if|if
condition|(
name|port
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|cport
argument_list|,
literal|".%xH"
argument_list|,
name|htons
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|*
name|cport
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|mybuf
argument_list|,
literal|"%xH.%s%s"
argument_list|,
name|ntohl
argument_list|(
name|net
operator|.
name|long_e
argument_list|)
argument_list|,
name|host
argument_list|,
name|cport
argument_list|)
expr_stmt|;
name|upHex
argument_list|(
name|mybuf
argument_list|)
expr_stmt|;
return|return
operator|(
name|mybuf
operator|)
return|;
block|}
end_function

begin_macro
name|upHex
argument_list|(
argument|p0
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|p0
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
init|=
name|p0
decl_stmt|;
for|for
control|(
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
switch|switch
condition|(
operator|*
name|p
condition|)
block|{
case|case
literal|'a'
case|:
case|case
literal|'b'
case|:
case|case
literal|'c'
case|:
case|case
literal|'d'
case|:
case|case
literal|'e'
case|:
case|case
literal|'f'
case|:
operator|*
name|p
operator|+=
operator|(
literal|'A'
operator|-
literal|'a'
operator|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|monitor
argument_list|()
end_macro

begin_block
block|{
name|int
name|n
decl_stmt|;
name|char
name|msg
index|[
literal|2048
index|]
decl_stmt|;
name|verbose
operator|=
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|n
operator|=
name|read
argument_list|(
name|s
argument_list|,
name|msg
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"got message of size %d\n"
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|print_rtmsg
argument_list|(
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_struct
struct|struct
block|{
name|struct
name|rt_msghdr
name|m_rtm
decl_stmt|;
name|char
name|m_space
index|[
literal|512
index|]
decl_stmt|;
block|}
name|m_rtmsg
struct|;
end_struct

begin_macro
name|rtmsg
argument_list|(
argument|cmd
argument_list|,
argument|flags
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|int
name|seq
decl_stmt|;
name|int
name|rlen
decl_stmt|;
specifier|extern
name|int
name|errno
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
init|=
name|m_rtmsg
operator|.
name|m_space
decl_stmt|;
specifier|register
name|int
name|l
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
argument_list|,
sizeof|sizeof
argument_list|(
name|m_rtmsg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
literal|'a'
condition|)
name|cmd
operator|=
name|RTM_ADD
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|==
literal|'c'
condition|)
name|cmd
operator|=
name|RTM_CHANGE
expr_stmt|;
else|else
name|cmd
operator|=
name|RTM_DELETE
expr_stmt|;
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_flags
operator|=
name|flags
expr_stmt|;
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_version
operator|=
name|RTM_VERSION
expr_stmt|;
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_seq
operator|=
operator|++
name|seq
expr_stmt|;
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_addrs
operator|=
name|rtm_addrs
expr_stmt|;
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_rmx
operator|=
name|rt_metrics
expr_stmt|;
define|#
directive|define
name|ROUND
parameter_list|(
name|a
parameter_list|)
value|(1 + (((a) - 1) | (sizeof(long) - 1)))
define|#
directive|define
name|NEXTADDR
parameter_list|(
name|w
parameter_list|,
name|u
parameter_list|)
value|{ if (rtm_addrs& (w)) {l = (u).sa.sa_len;\ 	if(verbose)sodump(&(u),"u");if(l == 0) l = sizeof(int); l = ROUND(l);\ 		bcopy((char *)&(u), cp, l); cp += l;}}
name|NEXTADDR
argument_list|(
name|RTA_DST
argument_list|,
name|so_dst
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_GATEWAY
argument_list|,
name|so_gate
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_NETMASK
argument_list|,
name|so_mask
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_GENMASK
argument_list|,
name|so_genmask
argument_list|)
expr_stmt|;
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_msglen
operator|=
name|l
operator|=
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
expr_stmt|;
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_type
operator|=
name|cmd
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_rtmsg
argument_list|(
operator|&
name|m_rtmsg
operator|.
name|m_rtm
argument_list|,
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|debugonly
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|rlen
operator|=
name|write
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
argument_list|,
name|l
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"writing to routing socket"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"got only %d for rlen\n"
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|again
label|:
if|if
condition|(
operator|(
name|rlen
operator|=
name|read
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
argument_list|,
name|l
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"reading from routing socket"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"got only %d for rlen\n"
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_pid
operator|!=
name|pid
operator|)
operator|||
operator|(
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_seq
operator|!=
name|seq
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Got response for somebody else's request"
argument_list|)
expr_stmt|;
goto|goto
name|again
goto|;
block|}
if|if
condition|(
name|qflag
operator|==
literal|0
condition|)
name|print_rtmsg
argument_list|(
operator|&
name|m_rtmsg
operator|.
name|m_rtm
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_flags
operator|&
name|RTF_DONE
operator|)
operator|==
literal|0
condition|)
block|{
name|errno
operator|=
name|m_rtmsg
operator|.
name|m_rtm
operator|.
name|rtm_errno
expr_stmt|;
name|perror
argument_list|(
literal|"response from routing socket turned down"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|msgtypes
index|[]
init|=
block|{
literal|""
block|,
literal|"RTM_ADD: Add Route"
block|,
literal|"RTM_DELETE: Delete Route"
block|,
literal|"RTM_CHANGE: Change Metrics or flags"
block|,
literal|"RTM_GET: Report Metrics"
block|,
literal|"RTM_LOSING: Kernel Suspects Partitioning"
block|,
literal|"RTM_REDIRECT: Told to use different route"
block|,
literal|"RTM_MISS: Lookup failed on this address"
block|,
literal|"RTM_LOCK: fix specified metrics"
block|,
literal|"RTM_OLDADD: caused by SIOCADDRT"
block|,
literal|"RTM_OLDDEL: caused by SIOCDELRT"
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|metricnames
index|[]
init|=
literal|"\010rttvar\7rtt\6ssthresh\5sendpipe\4recvpipe\3expire\2hopcount\1mtu"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|routeflags
index|[]
init|=
literal|"\1UP\2GATEWAY\3HOST\5DYNAMIC\6MODIFIED\7DONE\010MASK_PRESENT\011CLONING\012XRESOLVE"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ROUNDUP
parameter_list|(
name|a
parameter_list|)
value|((char *)(1 + (((((int)a)) - 1) | (sizeof(long) - 1))))
end_define

begin_expr_stmt
name|print_rtmsg
argument_list|(
name|rtm
argument_list|,
name|n
argument_list|)
specifier|register
expr|struct
name|rt_msghdr
operator|*
name|rtm
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|verbose
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|rtm
operator|->
name|rtm_version
operator|!=
name|RTM_VERSION
condition|)
block|{
name|printf
argument_list|(
literal|"routing message version %d not understood\n"
argument_list|,
name|rtm
operator|->
name|rtm_version
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s\npid: %d, len %d, seq %d, errno %d, flags:"
argument_list|,
name|msgtypes
index|[
name|rtm
operator|->
name|rtm_type
index|]
argument_list|,
name|rtm
operator|->
name|rtm_pid
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|,
name|rtm
operator|->
name|rtm_seq
argument_list|,
name|rtm
operator|->
name|rtm_errno
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_flags
argument_list|,
name|routeflags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nlocks: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_locks
argument_list|,
name|metricnames
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" inits: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_inits
argument_list|,
name|metricnames
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nsockaddrs: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_addrs
argument_list|,
literal|"\1DST\2GATEWAY\3NETMASK\4GENMASK\5IFP\6IFA\7AUTHOR"
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|rtm
operator|->
name|rtm_addrs
condition|)
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
condition|;
name|i
operator|<<=
literal|1
control|)
if|if
condition|(
name|i
operator|&
name|rtm
operator|->
name|rtm_addrs
condition|)
block|{
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|cp
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|routename
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ROUNDUP
argument_list|(
name|cp
operator|+
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|bprintf
argument_list|(
name|fp
argument_list|,
name|b
argument_list|,
name|s
argument_list|)
specifier|register
name|FILE
operator|*
name|fp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|b
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|u_char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|gotsome
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|b
operator|==
literal|0
condition|)
return|return;
while|while
condition|(
name|i
operator|=
operator|*
name|s
operator|++
condition|)
block|{
if|if
condition|(
name|b
operator|&
operator|(
literal|1
operator|<<
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|gotsome
operator|==
literal|0
condition|)
name|i
operator|=
literal|'<'
expr_stmt|;
else|else
name|i
operator|=
literal|','
expr_stmt|;
name|putc
argument_list|(
name|i
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|gotsome
operator|=
literal|1
expr_stmt|;
for|for
control|(
init|;
operator|(
name|i
operator|=
operator|*
name|s
operator|)
operator|>
literal|32
condition|;
name|s
operator|++
control|)
name|putc
argument_list|(
name|i
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
else|else
while|while
condition|(
operator|*
name|s
operator|>
literal|32
condition|)
name|s
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|gotsome
condition|)
name|putc
argument_list|(
literal|'>'
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|int
name|keyword
parameter_list|(
name|cp
parameter_list|)
name|char
modifier|*
name|cp
decl_stmt|;
block|{
specifier|register
name|struct
name|keytab
modifier|*
name|kt
init|=
name|keywords
decl_stmt|;
while|while
condition|(
name|kt
operator|->
name|kt_cp
operator|&&
name|strcmp
argument_list|(
name|kt
operator|->
name|kt_cp
argument_list|,
name|cp
argument_list|)
condition|)
name|kt
operator|++
expr_stmt|;
return|return
name|kt
operator|->
name|kt_i
return|;
block|}
end_function

begin_expr_stmt
name|sodump
argument_list|(
name|su
argument_list|,
name|which
argument_list|)
specifier|register
expr|union
name|sockunion
operator|*
name|su
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|which
decl_stmt|;
end_decl_stmt

begin_block
block|{
switch|switch
condition|(
name|su
operator|->
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_LINK
case|:
name|printf
argument_list|(
literal|"%s: link %s; "
argument_list|,
name|which
argument_list|,
name|link_ntoa
argument_list|(
operator|&
name|su
operator|->
name|sdl
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_ISO
case|:
name|printf
argument_list|(
literal|"%s: iso %s; "
argument_list|,
name|which
argument_list|,
name|iso_ntoa
argument_list|(
operator|&
name|su
operator|->
name|siso
operator|.
name|siso_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET
case|:
name|printf
argument_list|(
literal|"%s: inet %s; "
argument_list|,
name|which
argument_list|,
name|inet_ntoa
argument_list|(
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_NS
case|:
name|printf
argument_list|(
literal|"%s: xns %s; "
argument_list|,
name|which
argument_list|,
name|ns_ntoa
argument_list|(
operator|&
name|su
operator|->
name|sns
operator|.
name|sns_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Copyright (c) 1990 Regents of the University of California.  * All rights reserved.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the University of California, Berkeley.  The name of the  * University may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|LIBC_SCCS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)linkaddr.c	5.1 (Berkeley) 4/1/90"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* LIBC_SCCS and not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|AF_LINK
end_ifndef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* States*/
end_comment

begin_define
define|#
directive|define
name|NAMING
value|0
end_define

begin_define
define|#
directive|define
name|GOTONE
value|1
end_define

begin_define
define|#
directive|define
name|GOTTWO
value|2
end_define

begin_define
define|#
directive|define
name|RESET
value|3
end_define

begin_comment
comment|/* Inputs */
end_comment

begin_define
define|#
directive|define
name|DIGIT
value|(4*0)
end_define

begin_define
define|#
directive|define
name|END
value|(4*1)
end_define

begin_define
define|#
directive|define
name|DELIM
value|(4*2)
end_define

begin_define
define|#
directive|define
name|LETTER
value|(4*3)
end_define

begin_expr_stmt
name|link_addr
argument_list|(
name|addr
argument_list|,
name|sdl
argument_list|)
specifier|register
name|char
operator|*
name|addr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|sockaddr_dl
modifier|*
name|sdl
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
init|=
name|sdl
operator|->
name|sdl_data
decl_stmt|;
name|char
modifier|*
name|cplim
init|=
name|sdl
operator|->
name|sdl_len
operator|+
operator|(
name|char
operator|*
operator|)
name|sdl
decl_stmt|;
specifier|register
name|int
name|byte
init|=
literal|0
decl_stmt|,
name|state
init|=
name|NAMING
decl_stmt|,
name|new
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sdl
operator|->
name|sdl_family
argument_list|,
name|sdl
operator|->
name|sdl_len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|sdl
operator|->
name|sdl_family
operator|=
name|AF_LINK
expr_stmt|;
do|do
block|{
name|state
operator|&=
operator|~
name|LETTER
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'f'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'a'
operator|+
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'A'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'F'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'A'
operator|+
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|addr
operator|==
literal|0
condition|)
block|{
name|state
operator||=
name|END
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|NAMING
operator|&&
operator|(
operator|(
operator|(
operator|*
name|addr
operator|>=
literal|'A'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'Z'
operator|)
operator|)
operator|||
operator|(
operator|(
operator|*
name|addr
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'z'
operator|)
operator|)
operator|)
condition|)
name|state
operator||=
name|LETTER
expr_stmt|;
else|else
name|state
operator||=
name|DELIM
expr_stmt|;
name|addr
operator|++
expr_stmt|;
switch|switch
condition|(
name|state
comment|/* | INPUT */
condition|)
block|{
case|case
name|NAMING
operator||
name|DIGIT
case|:
case|case
name|NAMING
operator||
name|LETTER
case|:
operator|*
name|cp
operator|++
operator|=
name|addr
index|[
operator|-
literal|1
index|]
expr_stmt|;
continue|continue;
case|case
name|NAMING
operator||
name|DELIM
case|:
name|state
operator|=
name|RESET
expr_stmt|;
name|sdl
operator|->
name|sdl_nlen
operator|=
name|cp
operator|-
name|sdl
operator|->
name|sdl_data
expr_stmt|;
continue|continue;
case|case
name|GOTTWO
operator||
name|DIGIT
case|:
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|RESET
operator||
name|DIGIT
case|:
name|state
operator|=
name|GOTONE
expr_stmt|;
name|byte
operator|=
name|new
expr_stmt|;
continue|continue;
case|case
name|GOTONE
operator||
name|DIGIT
case|:
name|state
operator|=
name|GOTTWO
expr_stmt|;
name|byte
operator|=
name|new
operator|+
operator|(
name|byte
operator|<<
literal|4
operator|)
expr_stmt|;
continue|continue;
default|default:
comment|/* | DELIM */
name|state
operator|=
name|RESET
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
name|byte
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|GOTONE
operator||
name|END
case|:
case|case
name|GOTTWO
operator||
name|END
case|:
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|RESET
operator||
name|END
case|:
break|break;
block|}
break|break;
block|}
do|while
condition|(
name|cp
operator|<
name|cplim
condition|)
do|;
name|sdl
operator|->
name|sdl_alen
operator|=
name|cp
operator|-
name|LLADDR
argument_list|(
name|sdl
argument_list|)
expr_stmt|;
name|new
operator|=
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
name|sdl
expr_stmt|;
if|if
condition|(
name|new
operator|>
sizeof|sizeof
argument_list|(
operator|*
name|sdl
argument_list|)
condition|)
name|sdl
operator|->
name|sdl_len
operator|=
name|new
expr_stmt|;
return|return;
block|}
end_block

begin_decl_stmt
specifier|static
name|char
name|hexlist
index|[]
init|=
literal|"0123456789abcdef"
decl_stmt|;
end_decl_stmt

begin_function
name|char
modifier|*
name|link_ntoa
parameter_list|(
name|sdl
parameter_list|)
specifier|register
name|struct
name|sockaddr_dl
modifier|*
name|sdl
decl_stmt|;
block|{
specifier|static
name|char
name|obuf
index|[
literal|64
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|out
init|=
name|obuf
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|u_char
modifier|*
name|in
init|=
operator|(
name|u_char
operator|*
operator|)
name|LLADDR
argument_list|(
name|sdl
argument_list|)
decl_stmt|;
name|u_char
modifier|*
name|inlim
init|=
name|in
operator|+
name|sdl
operator|->
name|sdl_nlen
decl_stmt|;
name|int
name|firsttime
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|sdl
operator|->
name|sdl_nlen
condition|)
block|{
name|bcopy
argument_list|(
name|sdl
operator|->
name|sdl_data
argument_list|,
name|obuf
argument_list|,
name|sdl
operator|->
name|sdl_nlen
argument_list|)
expr_stmt|;
name|out
operator|+=
name|sdl
operator|->
name|sdl_nlen
expr_stmt|;
operator|*
name|out
operator|++
operator|=
literal|':'
expr_stmt|;
block|}
while|while
condition|(
name|in
operator|<
name|inlim
condition|)
block|{
if|if
condition|(
name|firsttime
condition|)
name|firsttime
operator|=
literal|0
expr_stmt|;
else|else
operator|*
name|out
operator|++
operator|=
literal|'.'
expr_stmt|;
name|i
operator|=
operator|*
name|in
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0xf
condition|)
block|{
name|out
index|[
literal|1
index|]
operator|=
name|hexlist
index|[
name|i
operator|&
literal|0xf
index|]
expr_stmt|;
name|i
operator|>>=
literal|4
expr_stmt|;
name|out
index|[
literal|0
index|]
operator|=
name|hexlist
index|[
name|i
index|]
expr_stmt|;
name|out
operator|+=
literal|2
expr_stmt|;
block|}
else|else
operator|*
name|out
operator|++
operator|=
name|hexlist
index|[
name|i
index|]
expr_stmt|;
block|}
operator|*
name|out
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|obuf
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|version
index|[]
init|=
literal|"@(#)main.c	3.1 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/inode.h>
end_include

begin_include
include|#
directive|include
file|<sys/fs.h>
end_include

begin_include
include|#
directive|include
file|"fsck.h"
end_include

begin_macro
name|checkfilesys
argument_list|(
argument|filesys
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|filesys
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|devname
operator|=
name|filesys
expr_stmt|;
if|if
condition|(
name|setup
argument_list|(
name|filesys
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|preen
condition|)
name|pfatal
argument_list|(
literal|"CAN'T CHECK FILE SYSTEM."
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 1: scan inodes tallying blocks used */
if|if
condition|(
name|preen
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"** Last Mounted on %s\n"
argument_list|,
name|sblock
operator|.
name|fs_fsmnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|hotroot
condition|)
name|printf
argument_list|(
literal|"** Root file system\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"** Phase 1 - Check Blocks and Sizes\n"
argument_list|)
expr_stmt|;
block|}
name|pass1
argument_list|()
expr_stmt|;
comment|/* 1b: locate first references to duplicates, if any */
if|if
condition|(
name|enddup
operator|!=
operator|&
name|duplist
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|preen
condition|)
name|pfatal
argument_list|(
literal|"INTERNAL ERROR: dups with -p"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"** Phase 1b - Rescan For More DUPS\n"
argument_list|)
expr_stmt|;
name|pass1b
argument_list|()
expr_stmt|;
block|}
comment|/* 2: traverse directories from root to mark all connected directories */
if|if
condition|(
name|preen
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"** Phase 2 - Check Pathnames\n"
argument_list|)
expr_stmt|;
name|pass2
argument_list|()
expr_stmt|;
comment|/* 3: scan inodes looking for disconnected directories */
if|if
condition|(
name|preen
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"** Phase 3 - Check Connectivity\n"
argument_list|)
expr_stmt|;
name|pass3
argument_list|()
expr_stmt|;
comment|/* 4: scan inodes looking for disconnected files; check reference counts */
if|if
condition|(
name|preen
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"** Phase 4 - Check Reference Counts\n"
argument_list|)
expr_stmt|;
name|pass4
argument_list|()
expr_stmt|;
comment|/* 5: check resource counts in cylinder groups */
if|if
condition|(
name|preen
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"** Phase 5 - Check Cyl groups\n"
argument_list|)
expr_stmt|;
name|pass5
argument_list|()
expr_stmt|;
if|if
condition|(
name|fixcg
condition|)
block|{
if|if
condition|(
name|preen
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"** Phase 6 - Salvage Cylinder Groups\n"
argument_list|)
expr_stmt|;
name|makecg
argument_list|()
expr_stmt|;
name|n_ffree
operator|=
name|sblock
operator|.
name|fs_cstotal
operator|.
name|cs_nffree
expr_stmt|;
name|n_bfree
operator|=
name|sblock
operator|.
name|fs_cstotal
operator|.
name|cs_nbfree
expr_stmt|;
block|}
name|pwarn
argument_list|(
literal|"%d files, %d used, %d free (%d frags, %d blocks)\n"
argument_list|,
name|n_files
argument_list|,
name|n_blks
operator|-
name|howmany
argument_list|(
name|sblock
operator|.
name|fs_cssize
argument_list|,
name|sblock
operator|.
name|fs_fsize
argument_list|)
argument_list|,
name|n_ffree
operator|+
name|sblock
operator|.
name|fs_frag
operator|*
name|n_bfree
argument_list|,
name|n_ffree
argument_list|,
name|n_bfree
argument_list|)
expr_stmt|;
if|if
condition|(
name|dfile
operator|.
name|mod
condition|)
block|{
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|sblock
operator|.
name|fs_time
argument_list|)
expr_stmt|;
name|sbdirty
argument_list|()
expr_stmt|;
block|}
name|ckfini
argument_list|()
expr_stmt|;
name|free
argument_list|(
name|blockmap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|freemap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|statemap
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|lncntp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dfile
operator|.
name|mod
condition|)
return|return;
if|if
condition|(
operator|!
name|preen
condition|)
block|{
name|printf
argument_list|(
literal|"\n***** FILE SYSTEM WAS MODIFIED *****\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hotroot
condition|)
name|printf
argument_list|(
literal|"\n***** REBOOT UNIX *****\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hotroot
condition|)
block|{
name|sync
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit


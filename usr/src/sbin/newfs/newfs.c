begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1983 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1983 Regents of the University of California.\n\  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|not lint
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)newfs.c	5.1 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|not lint
end_endif

begin_comment
comment|/*  * newfs: friendly front end to mkfs  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/fs.h>
end_include

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<disktab.h>
end_include

begin_define
define|#
directive|define
name|BOOTDIR
value|"/usr/mdec"
end_define

begin_comment
comment|/* directory for boot blocks */
end_comment

begin_decl_stmt
name|int
name|Nflag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* run mkfs without writing file system */
end_comment

begin_decl_stmt
name|int
name|verbose
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* show mkfs line before exec */
end_comment

begin_decl_stmt
name|int
name|noboot
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* do not fill boot blocks */
end_comment

begin_decl_stmt
name|int
name|fssize
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file system size */
end_comment

begin_decl_stmt
name|int
name|fsize
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* fragment size */
end_comment

begin_decl_stmt
name|int
name|bsize
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* block size */
end_comment

begin_decl_stmt
name|int
name|ntracks
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* # tracks/cylinder */
end_comment

begin_decl_stmt
name|int
name|nsectors
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* # sectors/track */
end_comment

begin_decl_stmt
name|int
name|sectorsize
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* bytes/sector */
end_comment

begin_decl_stmt
name|int
name|cpg
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* cylinders/cylinder group */
end_comment

begin_decl_stmt
name|int
name|minfree
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* free space threshold */
end_comment

begin_decl_stmt
name|int
name|rpm
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* revolutions/minute of drive */
end_comment

begin_decl_stmt
name|int
name|density
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of bytes per inode */
end_comment

begin_decl_stmt
name|char
modifier|*
name|av
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* argv array and buffers for exec */
end_comment

begin_decl_stmt
name|char
name|a2
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|a3
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|a4
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|a5
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|a6
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|a7
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|a8
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|a9
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|a10
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|device
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|cmd
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
name|char
modifier|*
name|index
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|rindex
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|sprintf
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|special
decl_stmt|;
specifier|register
name|struct
name|disktab
modifier|*
name|dp
decl_stmt|;
specifier|register
name|struct
name|partition
modifier|*
name|pp
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|status
decl_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|0
operator|&&
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
for|for
control|(
name|cp
operator|=
operator|&
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
init|;
operator|*
name|cp
condition|;
name|cp
operator|++
control|)
switch|switch
condition|(
operator|*
name|cp
condition|)
block|{
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|Nflag
operator|++
expr_stmt|;
comment|/* fall through to */
case|case
literal|'n'
case|:
name|noboot
operator|++
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|fatal
argument_list|(
literal|"-s: missing file system size"
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
name|fssize
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|fssize
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: bad file system size"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
case|case
literal|'t'
case|:
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|fatal
argument_list|(
literal|"-t: missing track total"
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
name|ntracks
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntracks
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: bad total tracks"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
case|case
literal|'b'
case|:
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|fatal
argument_list|(
literal|"-b: missing block size"
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
name|bsize
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsize
operator|<
literal|0
operator|||
name|bsize
operator|<
name|MINBSIZE
condition|)
name|fatal
argument_list|(
literal|"%s: bad block size"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
case|case
literal|'f'
case|:
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|fatal
argument_list|(
literal|"-f: missing frag size"
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
name|fsize
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|fsize
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: bad frag size"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
case|case
literal|'S'
case|:
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|fatal
argument_list|(
literal|"-S: missing sector size"
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
name|sectorsize
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sectorsize
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: bad sector size"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
case|case
literal|'c'
case|:
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|fatal
argument_list|(
literal|"-c: missing cylinders/group"
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
name|cpg
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpg
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: bad cylinders/group"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
case|case
literal|'m'
case|:
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|fatal
argument_list|(
literal|"-m: missing free space %%\n"
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
name|minfree
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|minfree
operator|<
literal|0
operator|||
name|minfree
operator|>
literal|99
condition|)
name|fatal
argument_list|(
literal|"%s: bad free space %%\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
case|case
literal|'r'
case|:
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|fatal
argument_list|(
literal|"-r: missing revs/minute\n"
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
name|rpm
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpm
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: bad revs/minute\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
case|case
literal|'i'
case|:
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|fatal
argument_list|(
literal|"-i: missing bytes per inode\n"
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
name|density
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|density
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: bad bytes per inode\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
default|default:
name|fatal
argument_list|(
literal|"-%c: unknown flag"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
name|next
label|:
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: newfs [ -v ] [ mkfs-options ] %s\n"
argument_list|,
literal|"special-device device-type"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"where mkfs-options are:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-N do not create file system, %s\n"
argument_list|,
literal|"just print out parameters"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-s file system size (sectors)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-b block size\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-f frag size\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-t tracks/cylinder\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-c cylinders/group\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-m minimum free space %%\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-r revolutions/minute\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-S sector size\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-i number of bytes per inode\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|special
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|cp
operator|=
name|rindex
argument_list|(
name|special
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|!=
literal|0
condition|)
name|special
operator|=
name|cp
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|special
operator|==
literal|'r'
operator|&&
name|special
index|[
literal|1
index|]
operator|!=
literal|'a'
operator|&&
name|special
index|[
literal|1
index|]
operator|!=
literal|'b'
condition|)
name|special
operator|++
expr_stmt|;
name|special
operator|=
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"/dev/r%s"
argument_list|,
name|special
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|special
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"newfs: "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|special
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFCHR
condition|)
name|fatal
argument_list|(
literal|"%s: not a character device"
argument_list|,
name|special
argument_list|)
expr_stmt|;
name|dp
operator|=
name|getdiskbyname
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: unknown disk type"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|cp
operator|=
name|index
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|'\0'
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|cp
operator|==
literal|0
operator|||
operator|*
name|cp
operator|<
literal|'a'
operator|||
operator|*
name|cp
operator|>
literal|'h'
condition|)
name|fatal
argument_list|(
literal|"%s: can't figure out file system partition"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|pp
operator|=
operator|&
name|dp
operator|->
name|d_partitions
index|[
operator|*
name|cp
operator|-
literal|'a'
index|]
expr_stmt|;
if|if
condition|(
name|fssize
operator|==
literal|0
condition|)
block|{
name|fssize
operator|=
name|pp
operator|->
name|p_size
expr_stmt|;
if|if
condition|(
name|fssize
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: no default size for `%c' partition"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nsectors
operator|==
literal|0
condition|)
block|{
name|nsectors
operator|=
name|dp
operator|->
name|d_nsectors
expr_stmt|;
if|if
condition|(
name|nsectors
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: no default #sectors/track"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntracks
operator|==
literal|0
condition|)
block|{
name|ntracks
operator|=
name|dp
operator|->
name|d_ntracks
expr_stmt|;
if|if
condition|(
name|ntracks
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: no default #tracks"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sectorsize
operator|==
literal|0
condition|)
block|{
name|sectorsize
operator|=
name|dp
operator|->
name|d_secsize
expr_stmt|;
if|if
condition|(
name|sectorsize
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: no default sector size"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bsize
operator|==
literal|0
condition|)
block|{
name|bsize
operator|=
name|pp
operator|->
name|p_bsize
expr_stmt|;
if|if
condition|(
name|bsize
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: no default block size for `%c' partition"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fsize
operator|==
literal|0
condition|)
block|{
name|fsize
operator|=
name|pp
operator|->
name|p_fsize
expr_stmt|;
if|if
condition|(
name|fsize
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: no default frag size for `%c' partition"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rpm
operator|==
literal|0
condition|)
block|{
name|rpm
operator|=
name|dp
operator|->
name|d_rpm
expr_stmt|;
if|if
condition|(
name|rpm
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: no default revolutions/minute value"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|density
operator|<=
literal|0
condition|)
name|density
operator|=
literal|2048
expr_stmt|;
if|if
condition|(
name|minfree
operator|<
literal|0
condition|)
name|minfree
operator|=
literal|10
expr_stmt|;
if|if
condition|(
name|cpg
operator|==
literal|0
condition|)
name|cpg
operator|=
literal|16
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|Nflag
condition|)
name|av
index|[
name|i
operator|++
index|]
operator|=
literal|"-N"
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
name|special
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
name|sprintf
argument_list|(
name|a2
argument_list|,
literal|"%d"
argument_list|,
name|fssize
argument_list|)
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
name|sprintf
argument_list|(
name|a3
argument_list|,
literal|"%d"
argument_list|,
name|nsectors
argument_list|)
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
name|sprintf
argument_list|(
name|a4
argument_list|,
literal|"%d"
argument_list|,
name|ntracks
argument_list|)
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
name|sprintf
argument_list|(
name|a5
argument_list|,
literal|"%d"
argument_list|,
name|bsize
argument_list|)
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
name|sprintf
argument_list|(
name|a6
argument_list|,
literal|"%d"
argument_list|,
name|fsize
argument_list|)
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
name|sprintf
argument_list|(
name|a7
argument_list|,
literal|"%d"
argument_list|,
name|cpg
argument_list|)
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
name|sprintf
argument_list|(
name|a8
argument_list|,
literal|"%d"
argument_list|,
name|minfree
argument_list|)
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
name|sprintf
argument_list|(
name|a9
argument_list|,
literal|"%d"
argument_list|,
name|rpm
operator|/
literal|60
argument_list|)
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
name|sprintf
argument_list|(
name|a10
argument_list|,
literal|"%d"
argument_list|,
name|density
argument_list|)
expr_stmt|;
name|av
index|[
name|i
operator|++
index|]
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|cmd
argument_list|,
literal|"/etc/mkfs"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|av
index|[
name|i
index|]
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|strcat
argument_list|(
name|cmd
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|cmd
argument_list|,
name|av
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|=
name|system
argument_list|(
name|cmd
argument_list|)
condition|)
name|exit
argument_list|(
name|status
operator|>>
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'a'
operator|&&
operator|!
name|noboot
condition|)
block|{
name|char
name|type
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|cp
operator|=
name|rindex
argument_list|(
name|special
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: can't figure out disk type from name"
argument_list|,
name|special
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|special
argument_list|,
operator|&
name|sb
argument_list|)
operator|>=
literal|0
operator|&&
operator|(
name|sb
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|==
name|S_IFCHR
condition|)
name|cp
operator|++
expr_stmt|;
name|type
index|[
literal|0
index|]
operator|=
operator|*
operator|++
name|cp
expr_stmt|;
name|type
index|[
literal|1
index|]
operator|=
operator|*
operator|++
name|cp
expr_stmt|;
name|type
index|[
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
name|installboot
argument_list|(
name|special
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|installboot
argument_list|(
argument|dev
argument_list|,
argument|type
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dev
decl_stmt|,
modifier|*
name|type
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|fd
decl_stmt|;
name|char
name|bootblock
index|[
name|MAXPATHLEN
index|]
decl_stmt|,
name|standalonecode
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|char
name|bootimage
index|[
name|BBSIZE
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|bootblock
argument_list|,
literal|"%s/%sboot"
argument_list|,
name|BOOTDIR
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|standalonecode
argument_list|,
literal|"%s/boot%s"
argument_list|,
name|BOOTDIR
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"installing boot code\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"sector 0 boot = %s\n"
argument_list|,
name|bootblock
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"1st level boot = %s\n"
argument_list|,
name|standalonecode
argument_list|)
expr_stmt|;
block|}
name|fd
operator|=
name|open
argument_list|(
name|bootblock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"newfs: "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|bootblock
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
name|bootimage
argument_list|,
name|DEV_BSIZE
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"newfs: "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|bootblock
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|standalonecode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"newfs: "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|standalonecode
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
operator|&
name|bootimage
index|[
name|DEV_BSIZE
index|]
argument_list|,
name|BBSIZE
operator|-
name|DEV_BSIZE
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"newfs: "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|standalonecode
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"newfs: "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|bootimage
argument_list|,
name|BBSIZE
argument_list|)
operator|!=
name|BBSIZE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"newfs: "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*VARARGS*/
end_comment

begin_macro
name|fatal
argument_list|(
argument|fmt
argument_list|,
argument|arg1
argument_list|,
argument|arg2
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|fmt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"newfs: "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|fmt
argument_list|,
name|arg1
argument_list|,
name|arg2
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


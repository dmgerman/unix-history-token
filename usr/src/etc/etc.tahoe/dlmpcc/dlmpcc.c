begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)dlmpcc.c	1.1 (Berkeley from CCI) 11/15/87"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * MPCC Download and Configuration Program.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<tahoevba/mpreg.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"scnhdr.h"
end_include

begin_define
define|#
directive|define
name|MAXMPCC
value|16
end_define

begin_decl_stmt
name|char
modifier|*
name|MPCCTAB
init|=
literal|"/etc/mpcctab"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|resetflg
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|bd
decl_stmt|;
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
for|for
control|(
name|bd
operator|=
literal|0
init|;
name|bd
operator|<
name|MAXMPCC
condition|;
name|bd
operator|++
control|)
if|if
condition|(
name|bldmap
argument_list|(
name|bd
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|download
argument_list|(
name|bd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|argc
operator|--
operator|,
name|argv
operator|++
init|;
name|argc
operator|>
literal|0
condition|;
name|argc
operator|--
operator|,
name|argv
operator|++
control|)
block|{
name|bd
operator|=
name|atoi
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-r"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|resetflg
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|bd
operator|>
name|MAXMPCC
operator|||
name|bd
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Illegal Board Number=> %d\n"
argument_list|,
name|bd
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|bldmap
argument_list|(
name|bd
argument_list|)
operator|==
operator|-
literal|1
condition|)
continue|continue;
name|download
argument_list|(
name|bd
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*	  * Build Load Module Map  */
end_comment

begin_decl_stmt
name|struct
name|bdcf
name|cf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|abdcf
name|bdasy
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|LINESIZE
value|128
end_define

begin_macro
name|bldmap
argument_list|(
argument|dlbd
argument_list|)
end_macro

begin_decl_stmt
name|int
name|dlbd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* board to be downloaded */
end_comment

begin_block
block|{
name|FILE
modifier|*
name|tabfp
decl_stmt|;
name|int
name|bd
decl_stmt|,
name|port
decl_stmt|,
name|count
decl_stmt|;
name|char
modifier|*
name|bdstr
decl_stmt|,
modifier|*
name|strtok
argument_list|()
decl_stmt|,
name|protocol
decl_stmt|,
name|line
index|[
name|LINESIZE
index|]
decl_stmt|;
name|char
modifier|*
name|lptr
decl_stmt|,
modifier|*
name|lptr1
decl_stmt|,
modifier|*
name|lptr2
decl_stmt|;
name|protocol
operator|=
literal|'\0'
expr_stmt|;
comment|/* open the configuration file for reading */
if|if
condition|(
operator|(
name|tabfp
operator|=
name|fopen
argument_list|(
name|MPCCTAB
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No Configuration File: %s\n"
argument_list|,
name|MPCCTAB
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|fgets
argument_list|(
operator|&
name|line
index|[
literal|0
index|]
argument_list|,
name|LINESIZE
operator|-
literal|1
argument_list|,
name|tabfp
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fclose
argument_list|(
name|tabfp
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|count
operator|++
expr_stmt|;
name|line
index|[
name|strlen
argument_list|(
name|line
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|lptr
operator|=
name|strtok
argument_list|(
name|line
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|tolower
argument_list|(
operator|*
name|lptr
argument_list|)
operator|!=
literal|'m'
condition|)
continue|continue;
name|lptr
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
name|bd
operator|=
name|atoi
argument_list|(
name|lptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bd
operator|==
name|dlbd
condition|)
break|break;
block|}
name|cf
operator|.
name|fccstimer
operator|=
literal|20
expr_stmt|;
comment|/* default to 1 sec (20 * 50ms) */
name|cf
operator|.
name|fccsports
operator|=
literal|0
expr_stmt|;
comment|/* no ports are fccs */
name|cf
operator|.
name|fccssoc
operator|=
literal|0
expr_stmt|;
comment|/* no ports switch on close */
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|MPMAXPORT
condition|;
name|port
operator|++
control|)
name|cf
operator|.
name|protoports
index|[
name|port
index|]
operator|=
name|MPPROTO_UNUSED
expr_stmt|;
comment|/* check for the keywords following the board number */
name|lptr1
operator|=
operator|(
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|lptr2
operator|=
operator|(
name|char
operator|*
operator|)
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|lptr
condition|)
block|{
name|lptr
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|lptr
argument_list|,
literal|"FCCS"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|lptr1
operator|=
name|lptr
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|lptr
argument_list|,
literal|"SOC"
argument_list|,
literal|3
argument_list|)
condition|)
block|{
name|lptr2
operator|=
name|lptr
expr_stmt|;
continue|continue;
block|}
block|}
comment|/* process the board and port characteristics */
while|while
condition|(
name|fgets
argument_list|(
operator|&
name|line
index|[
literal|0
index|]
argument_list|,
name|LINESIZE
operator|-
literal|1
argument_list|,
name|tabfp
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|count
operator|++
expr_stmt|;
name|line
index|[
name|strlen
argument_list|(
name|line
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|line
index|[
literal|0
index|]
condition|)
comment|/* if newline only */
continue|continue;
name|lptr
operator|=
name|strtok
argument_list|(
name|line
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|tolower
argument_list|(
operator|*
name|lptr
argument_list|)
operator|==
literal|'m'
condition|)
break|break;
if|if
condition|(
operator|*
name|lptr
operator|==
literal|'#'
condition|)
comment|/* ignore comment */
continue|continue;
if|if
condition|(
name|tolower
argument_list|(
operator|*
name|lptr
argument_list|)
operator|==
literal|'p'
operator|&&
name|tolower
argument_list|(
operator|*
operator|(
name|lptr
operator|+
literal|1
operator|)
argument_list|)
operator|==
literal|'o'
condition|)
block|{
comment|/* PORT */
name|port
operator|=
name|atoi
argument_list|(
name|lptr
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
literal|':'
argument_list|)
argument_list|)
expr_stmt|;
name|protocol
operator|=
operator|*
operator|(
name|lptr
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
literal|':'
argument_list|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|cf
operator|.
name|protoports
index|[
name|port
index|]
operator|=
name|protocol
condition|)
block|{
case|case
literal|'3'
case|:
comment|/* ASYNCH 32 port */
case|case
literal|'A'
case|:
comment|/* ASYNCH */
break|break;
case|case
literal|'B'
case|:
comment|/* BISYNCH */
break|break;
case|case
literal|'S'
case|:
comment|/* SDLC */
name|snapargs
argument_list|(
name|port
argument_list|,
name|lptr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
comment|/* X25 */
name|x25pargs
argument_list|(
name|port
argument_list|,
name|lptr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"No protocol specified on PROTOCOL line in configuration file %s:%d: %s\n"
argument_list|,
name|MPCCTAB
argument_list|,
name|count
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|protocol
operator|=
literal|'A'
expr_stmt|;
break|break;
block|}
continue|continue;
block|}
if|if
condition|(
name|tolower
argument_list|(
operator|*
name|lptr
argument_list|)
operator|==
literal|'p'
operator|&&
name|tolower
argument_list|(
operator|*
operator|(
name|lptr
operator|+
literal|1
operator|)
argument_list|)
operator|==
literal|'r'
condition|)
block|{
comment|/* PROTOCOL */
ifdef|#
directive|ifdef
name|notdef
if|if
condition|(
name|protocol
condition|)
block|{
name|printf
argument_list|(
literal|"second protocol specified on PROTOCOL line in configuration file %s:%d: %s\n"
argument_list|,
name|MPCCTAB
argument_list|,
name|count
argument_list|,
name|line
argument_list|)
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
name|lptr
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|protocol
operator|=
operator|*
name|lptr
condition|)
block|{
case|case
literal|'3'
case|:
comment|/* ASYNCH 32 port */
case|case
literal|'A'
case|:
comment|/* ASYNCH */
name|asybargs
argument_list|(
name|lptr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* BISYNCH */
break|break;
case|case
literal|'S'
case|:
comment|/* SDLC */
name|snabargs
argument_list|(
name|lptr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
comment|/* X25 */
name|x25bargs
argument_list|(
name|lptr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"No protocol specified on PROTOCOL line in configuration file %s:%d: %s\n"
argument_list|,
name|MPCCTAB
argument_list|,
name|count
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|protocol
operator|=
literal|'A'
expr_stmt|;
break|break;
block|}
continue|continue;
block|}
name|printf
argument_list|(
literal|"Error in configuration file %s,line %d, %s\n"
argument_list|,
name|MPCCTAB
argument_list|,
name|count
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|tabfp
argument_list|)
expr_stmt|;
name|mkldnm
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * decode x25 arguments for board  *  * for X.25, the arguments are N1, N2, T1, T2, T3, T4, K).  */
end_comment

begin_macro
name|x25bargs
argument_list|(
argument|args
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|args
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_comment
comment|/*  * decode sna arguments for board  * for SNA, the arguments are N1, N2, T1, T2, T3, T4, K).  */
end_comment

begin_macro
name|snabargs
argument_list|(
argument|args
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|args
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_comment
comment|/*  * decode async arguments for board  */
end_comment

begin_macro
name|asybargs
argument_list|(
argument|args
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|args
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|bdasy
operator|.
name|xmtbsz
operator|=
name|atoi
argument_list|(
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
literal|':'
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * decode x25 arguments for port  */
end_comment

begin_macro
name|x25pargs
argument_list|(
argument|port
argument_list|,
argument|args
argument_list|)
end_macro

begin_decl_stmt
name|int
name|port
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|args
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_comment
comment|/*  * decode sna arguments for port  */
end_comment

begin_macro
name|snapargs
argument_list|(
argument|port
argument_list|,
argument|args
argument_list|)
end_macro

begin_decl_stmt
name|int
name|port
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|args
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_macro
name|gethi
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|MPMAXPORT
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
operator|&&
name|cf
operator|.
name|protoports
index|[
name|i
index|]
operator|==
literal|0
condition|;
name|i
operator|--
control|)
empty_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_block

begin_macro
name|getlo
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MPMAXPORT
operator|&&
name|cf
operator|.
name|protoports
index|[
name|i
index|]
operator|==
literal|0
condition|;
name|i
operator|++
control|)
empty_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_block

begin_macro
name|prntmap
argument_list|(
argument|board
argument_list|)
end_macro

begin_decl_stmt
name|int
name|board
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|j
decl_stmt|;
name|printf
argument_list|(
literal|"\nMPCC #: %d\n"
argument_list|,
name|board
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MPMAXPORT
condition|;
name|j
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"port: %d  %c"
argument_list|,
name|j
argument_list|,
name|cf
operator|.
name|protoports
index|[
name|j
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cf
operator|.
name|protoports
index|[
name|j
index|]
condition|)
block|{
case|case
literal|'3'
case|:
case|case
literal|'A'
case|:
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
break|break;
case|case
literal|'S'
case|:
break|break;
case|case
literal|'X'
case|:
break|break;
default|default:
name|printf
argument_list|(
literal|"Unused\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|printf
argument_list|(
literal|"ldname: %s, "
argument_list|,
name|cf
operator|.
name|loadname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"hiport: %d, loport: %d\n"
argument_list|,
name|gethi
argument_list|()
argument_list|,
name|getlo
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|cf
operator|.
name|fccsports
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"FCCS\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cf
operator|.
name|protoports
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'3'
case|:
case|case
literal|'A'
case|:
name|printf
argument_list|(
literal|"xmtsize: %d\n"
argument_list|,
name|bdasy
operator|.
name|xmtbsz
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
break|break;
case|case
literal|'S'
case|:
break|break;
case|case
literal|'X'
case|:
break|break;
block|}
name|printf
argument_list|(
literal|"protoports: %s\n"
argument_list|,
name|cf
operator|.
name|protoports
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Make Load Module Name  *  * if any port is 'ASYNCH"  * 	add 'a' to load module name  * if any port is 'BISYNCH'  * 	add 'b' to load module name  * if any port is 'SDLC'  * 	add 's' to load module name  * if any port is 'X25'  * 	add 'x' to load module name  */
end_comment

begin_macro
name|mkldnm
argument_list|()
end_macro

begin_block
block|{
specifier|static
name|char
modifier|*
name|pcols
init|=
literal|"ABSX3"
decl_stmt|;
name|char
modifier|*
name|proto
decl_stmt|;
name|int
name|j
decl_stmt|,
name|offset
decl_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|proto
operator|=
name|pcols
init|;
operator|*
name|proto
condition|;
name|proto
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MPMAXPORT
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|cf
operator|.
name|protoports
index|[
name|j
index|]
operator|==
operator|*
name|proto
condition|)
block|{
if|if
condition|(
operator|*
name|proto
operator|==
literal|'3'
condition|)
name|cf
operator|.
name|loadname
index|[
name|offset
index|]
operator|=
literal|'3'
expr_stmt|;
else|else
name|cf
operator|.
name|loadname
index|[
name|offset
index|]
operator|=
name|tolower
argument_list|(
operator|*
name|proto
argument_list|)
expr_stmt|;
name|offset
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|cf
operator|.
name|loadname
index|[
name|offset
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * if a string is passed as an argument,  * 	save it in the local string area  * 	set the local index to the start of the string  * else  * 	set start to the current character in the string  * 	while the character is not the separator,  * 		and the character is not NULL  * 			skip the character  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|strtok
parameter_list|(
name|s
parameter_list|,
name|c
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|,
name|c
decl_stmt|;
block|{
specifier|static
name|char
name|locals
index|[
name|LINESIZE
index|]
decl_stmt|;
specifier|static
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|start
decl_stmt|;
if|if
condition|(
name|s
operator|!=
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|locals
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|start
operator|=
operator|&
name|locals
index|[
name|i
index|]
init|;
name|locals
index|[
name|i
index|]
operator|&&
name|locals
index|[
name|i
index|]
operator|!=
name|c
condition|;
name|i
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|locals
index|[
name|i
index|]
condition|)
block|{
name|locals
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
while|while
condition|(
operator|*
name|start
operator|==
literal|' '
condition|)
name|start
operator|++
expr_stmt|;
return|return
operator|(
name|start
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|short
name|bits
index|[]
init|=
block|{
literal|1
block|,
literal|2
block|,
literal|4
block|,
literal|8
block|,
literal|16
block|,
literal|32
block|,
literal|64
block|,
literal|128
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|fccs
argument_list|(
argument|line
argument_list|,
argument|tptr
argument_list|,
argument|pptr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|line
decl_stmt|,
modifier|*
name|tptr
decl_stmt|,
modifier|*
name|pptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|u_short
name|ports
decl_stmt|,
name|num
decl_stmt|,
name|time
decl_stmt|;
name|ports
operator|=
literal|0
expr_stmt|;
name|line
operator|=
name|strtok
argument_list|(
name|line
argument_list|,
literal|','
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
operator|(
name|line
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
literal|','
argument_list|)
operator|)
operator|!=
literal|'\0'
condition|)
block|{
name|num
operator|=
operator|(
name|short
operator|)
name|atoi
argument_list|(
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|>=
literal|0
operator|&&
name|num
operator|<
literal|8
condition|)
name|ports
operator||=
name|bits
index|[
name|num
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|num
operator|>=
literal|50
operator|&&
name|num
operator|<
literal|6400
condition|)
name|time
operator|=
name|num
operator|/
literal|50
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"bad value for FCCS: %d\n"
argument_list|,
name|num
argument_list|)
expr_stmt|;
block|}
operator|*
name|pptr
operator|=
name|ports
expr_stmt|;
operator|*
name|tptr
operator|=
name|time
expr_stmt|;
block|}
end_block

begin_macro
name|soc
argument_list|(
argument|line
argument_list|,
argument|sptr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|line
decl_stmt|,
modifier|*
name|sptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|u_short
name|ports
decl_stmt|,
name|num
decl_stmt|;
name|ports
operator|=
literal|0
expr_stmt|;
name|line
operator|=
name|strtok
argument_list|(
name|line
argument_list|,
literal|','
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
operator|(
name|line
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
literal|','
argument_list|)
operator|)
operator|!=
literal|'\0'
condition|)
block|{
name|num
operator|=
name|atoi
argument_list|(
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|>=
literal|0
operator|&&
name|num
operator|<
literal|8
condition|)
name|ports
operator||=
name|bits
index|[
name|num
index|]
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"bad value for SOC: %d\n"
argument_list|,
name|num
argument_list|)
expr_stmt|;
block|}
operator|*
name|sptr
operator|=
name|ports
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
name|buffer
index|[
name|MPDLBUFSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|head1
block|{
name|long
name|magic
decl_stmt|;
name|long
name|fill
index|[
literal|12
index|]
decl_stmt|;
name|struct
name|scnhdr
name|text
decl_stmt|;
name|struct
name|scnhdr
name|data
decl_stmt|;
name|struct
name|scnhdr
name|bss
decl_stmt|;
block|}
name|header1
struct|;
end_struct

begin_macro
name|download
argument_list|(
argument|mpccnum
argument_list|)
end_macro

begin_decl_stmt
name|int
name|mpccnum
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|dlname
index|[
name|LINESIZE
index|]
decl_stmt|,
name|fullname
index|[
name|LINESIZE
index|]
decl_stmt|;
name|char
modifier|*
name|ldname
decl_stmt|,
modifier|*
name|ppmap
decl_stmt|;
name|int
name|dlfd
decl_stmt|,
name|ldfd
decl_stmt|;
name|char
modifier|*
name|it
decl_stmt|;
name|short
name|i
decl_stmt|;
name|char
name|hilo
index|[
literal|2
index|]
decl_stmt|;
name|long
name|realsize
decl_stmt|;
name|sprintf
argument_list|(
name|dlname
argument_list|,
literal|"/dev/mpcc%d"
argument_list|,
name|mpccnum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|cf
operator|.
name|loadname
operator|==
literal|'3'
condition|)
name|sprintf
argument_list|(
name|fullname
argument_list|,
literal|"/etc/mpcc32"
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|fullname
argument_list|,
literal|"/etc/mpcc%s"
argument_list|,
name|cf
operator|.
name|loadname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cf
operator|.
name|loadname
index|[
literal|0
index|]
operator|)
operator|==
literal|'\0'
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|(
name|dlfd
operator|=
name|open
argument_list|(
name|dlname
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|==
name|MP_DLERROR
condition|)
block|{
name|printf
argument_list|(
literal|"Can not open %s\n"
argument_list|,
name|dlname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ldfd
operator|=
name|open
argument_list|(
name|fullname
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
name|MP_DLERROR
condition|)
block|{
name|close
argument_list|(
name|dlfd
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Can not access protocol code file: %s\n"
argument_list|,
name|fullname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|dlokay
argument_list|(
name|dlfd
argument_list|,
name|mpccnum
argument_list|)
operator|==
name|MP_DLERROR
condition|)
block|{
name|close
argument_list|(
name|ldfd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|dlfd
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"Downloading MPCC #%x\n"
argument_list|,
name|mpccnum
argument_list|)
expr_stmt|;
comment|/* read executable file header */
if|if
condition|(
name|read
argument_list|(
name|ldfd
argument_list|,
operator|&
name|header1
argument_list|,
sizeof|sizeof
argument_list|(
name|header1
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|header1
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Can not read %s\n"
argument_list|,
name|fullname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* place at start of text space */
if|if
condition|(
name|lseek
argument_list|(
name|ldfd
argument_list|,
name|header1
operator|.
name|text
operator|.
name|s_scnptr
argument_list|,
operator|(
name|int
operator|)
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"lseek error(text): %d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* send text */
name|realsize
operator|=
name|header1
operator|.
name|data
operator|.
name|s_paddr
operator|-
name|header1
operator|.
name|text
operator|.
name|s_paddr
expr_stmt|;
if|if
condition|(
name|dl
argument_list|(
name|ldfd
argument_list|,
name|dlfd
argument_list|,
name|realsize
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ioctl
argument_list|(
name|dlfd
argument_list|,
name|MPIORESETBOARD
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* place at start of data space	*/
if|if
condition|(
name|lseek
argument_list|(
name|ldfd
argument_list|,
name|header1
operator|.
name|data
operator|.
name|s_scnptr
argument_list|,
operator|(
name|int
operator|)
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"lseek error(data): %d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* send initialized data */
name|realsize
operator|=
name|header1
operator|.
name|bss
operator|.
name|s_paddr
operator|-
name|header1
operator|.
name|data
operator|.
name|s_paddr
expr_stmt|;
if|if
condition|(
name|dl
argument_list|(
name|ldfd
argument_list|,
name|dlfd
argument_list|,
name|realsize
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ioctl
argument_list|(
name|dlfd
argument_list|,
name|MPIORESETBOARD
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* signal end of code */
if|if
condition|(
name|ioctl
argument_list|(
name|dlfd
argument_list|,
name|MPIOENDCODE
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|)
operator|==
name|MP_DLERROR
condition|)
block|{
name|printf
argument_list|(
literal|"MPIOENDCODE ioctl failed\n"
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|dlfd
argument_list|,
name|MPIORESETBOARD
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* download configuration information	*/
if|if
condition|(
name|config
argument_list|(
name|dlfd
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ioctl
argument_list|(
name|dlfd
argument_list|,
name|MPIORESETBOARD
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* write port/protocol map */
name|ppmap
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|cf
operator|.
name|protoports
index|[
literal|0
index|]
expr_stmt|;
name|tknzmap
argument_list|(
name|ppmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|dlfd
argument_list|,
name|MPIOPORTMAP
argument_list|,
name|ppmap
argument_list|)
operator|==
name|MP_DLERROR
condition|)
block|{
name|printf
argument_list|(
literal|"MPIOPORTMAP ioctl failed\n"
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|dlfd
argument_list|,
name|MPIORESETBOARD
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* signal end of download */
if|if
condition|(
name|ioctl
argument_list|(
name|dlfd
argument_list|,
name|MPIOENDDL
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|)
operator|==
name|MP_DLERROR
condition|)
block|{
name|printf
argument_list|(
literal|"MPIOENDDL ioctl failed\n"
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|dlfd
argument_list|,
name|MPIORESETBOARD
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|close
argument_list|(
name|dlfd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|ldfd
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Download Complete and Successful\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|dlokay
argument_list|(
argument|bdfd
argument_list|,
argument|mpccnum
argument_list|)
end_macro

begin_decl_stmt
name|int
name|bdfd
decl_stmt|,
name|mpccnum
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|answer
decl_stmt|;
if|if
condition|(
name|resetflg
condition|)
block|{
name|printf
argument_list|(
literal|"Reseting MPCC #%x\n"
argument_list|,
name|mpccnum
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|bdfd
argument_list|,
name|MPIORESETBOARD
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|bdfd
argument_list|,
name|MPIOSTARTDL
argument_list|,
literal|0
argument_list|)
operator|==
name|MP_DLERROR
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EBUSY
condition|)
block|{
name|printf
argument_list|(
literal|"MPCC #%x has already been downloaded.\n"
argument_list|,
name|mpccnum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Do you want to re-download it?: "
argument_list|)
expr_stmt|;
name|fscanf
argument_list|(
name|stdin
argument_list|,
literal|"%c"
argument_list|,
operator|&
name|answer
argument_list|)
expr_stmt|;
while|while
condition|(
name|getchar
argument_list|()
operator|!=
literal|'\n'
condition|)
empty_stmt|;
if|if
condition|(
operator|(
name|answer
operator||
literal|0x60
operator|)
operator|!=
literal|'y'
condition|)
return|return
operator|(
name|MP_DLERROR
operator|)
return|;
name|ioctl
argument_list|(
name|bdfd
argument_list|,
name|MPIORESETBOARD
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|bdfd
argument_list|,
name|MPIOSTARTDL
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|)
operator|==
name|MP_DLERROR
condition|)
block|{
name|printf
argument_list|(
literal|"Can't download MPCC #%x\n"
argument_list|,
name|mpccnum
argument_list|)
expr_stmt|;
return|return
operator|(
name|MP_DLERROR
operator|)
return|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|errno
condition|)
block|{
case|case
name|ENODEV
case|:
name|printf
argument_list|(
literal|"MPCC #%x not in system\n"
argument_list|,
name|mpccnum
argument_list|)
expr_stmt|;
break|break;
case|case
name|EACCES
case|:
name|printf
argument_list|(
literal|"Download area in use, try later\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ENOSPC
case|:
name|printf
argument_list|(
literal|"MPCC #%x already being downloaded\n"
argument_list|,
name|mpccnum
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown response from MPCC #%x\n"
argument_list|,
name|mpccnum
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|MP_DLERROR
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|dl
argument_list|(
argument|dskfd
argument_list|,
argument|bdfd
argument_list|,
argument|size
argument_list|)
end_macro

begin_decl_stmt
name|int
name|dskfd
decl_stmt|,
name|bdfd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|size
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|bytes
decl_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|bytes
operator|=
operator|(
name|size
operator|<
name|MPDLBUFSIZE
operator|)
condition|?
operator|(
name|int
operator|)
name|size
else|:
name|MPDLBUFSIZE
expr_stmt|;
if|if
condition|(
operator|(
name|bytes
operator|=
name|read
argument_list|(
name|dskfd
argument_list|,
name|buffer
argument_list|,
name|bytes
argument_list|)
operator|)
operator|==
name|MP_DLERROR
condition|)
block|{
name|close
argument_list|(
name|dskfd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|bdfd
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Download-Can't read buffer\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|write
argument_list|(
name|bdfd
argument_list|,
name|buffer
argument_list|,
name|bytes
argument_list|)
operator|==
name|MP_DLERROR
condition|)
block|{
name|close
argument_list|(
name|dskfd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|bdfd
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Download-Can't write buffer\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|size
operator|-=
name|bytes
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * download each protocol's configuration data  * and the configuration data for tboard.  */
end_comment

begin_macro
name|config
argument_list|(
argument|dlfd
argument_list|)
end_macro

begin_decl_stmt
name|int
name|dlfd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|ldname
decl_stmt|;
for|for
control|(
name|ldname
operator|=
name|cf
operator|.
name|loadname
init|;
operator|*
name|ldname
condition|;
name|ldname
operator|++
control|)
block|{
switch|switch
condition|(
operator|*
name|ldname
condition|)
block|{
case|case
literal|'3'
case|:
case|case
literal|'a'
case|:
if|if
condition|(
name|ioctl
argument_list|(
name|dlfd
argument_list|,
name|MPIOASYNCNF
argument_list|,
operator|&
name|bdasy
argument_list|)
operator|==
name|MP_DLERROR
condition|)
block|{
name|printf
argument_list|(
literal|"async ioctl failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
break|break;
case|case
literal|'b'
case|:
break|break;
case|case
literal|'x'
case|:
break|break;
case|case
literal|'s'
case|:
break|break;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  * tokenize the protoport string,  * (change from the letter to the corresponding number).  */
end_comment

begin_macro
name|tknzmap
argument_list|(
argument|map
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|map
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MPMAXPORT
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
operator|*
name|map
condition|)
block|{
case|case
literal|'3'
case|:
operator|*
name|map
operator|=
name|MPPROTO_ASYNC
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
operator|*
name|map
operator|=
name|MPPROTO_ASYNC
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
operator|*
name|map
operator|=
name|MPPROTO_BISYNC
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
operator|*
name|map
operator|=
name|MPPROTO_SNA
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
operator|*
name|map
operator|=
name|MPPROTO_X25
expr_stmt|;
break|break;
default|default:
operator|*
name|map
operator|=
name|MPPROTO_UNUSED
expr_stmt|;
break|break;
block|}
name|map
operator|++
expr_stmt|;
block|}
block|}
end_block

end_unit


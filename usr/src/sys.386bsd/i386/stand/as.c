begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * sys/i386/stand/as.c  *  * Standalone driver for Adaptech 1542 SCSI  *   * Pace Willisson        pace@blitz.com       April 8, 1992  */
end_comment

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"disklabel.h"
end_include

begin_include
include|#
directive|include
file|"i386/isa/asreg.h"
end_include

begin_include
include|#
directive|include
file|"saio.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|ASDEBUG
end_ifdef

begin_define
define|#
directive|define
name|ASPRINT
parameter_list|(
name|x
parameter_list|)
value|{ printf x; DELAY (10000); }
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|ASPRINT
parameter_list|(
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|NRETRIES
value|3
end_define

begin_decl_stmt
name|int
name|as_port
init|=
literal|0x330
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|mailbox_entry
name|mailbox
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|asopen
parameter_list|(
name|io
parameter_list|)
name|struct
name|iob
modifier|*
name|io
decl_stmt|;
block|{
name|struct
name|disklabel
modifier|*
name|dd
decl_stmt|;
name|char
name|cdb
index|[
literal|6
index|]
decl_stmt|;
name|char
name|data
index|[
literal|12
index|]
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|oval
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|iob
name|aio
decl_stmt|;
if|if
condition|(
name|io
operator|->
name|i_unit
operator|<
literal|0
operator|||
name|io
operator|->
name|i_unit
operator|>
literal|8
operator|||
name|io
operator|->
name|i_part
operator|<
literal|0
operator|||
name|io
operator|->
name|i_part
operator|>
literal|8
operator|||
name|io
operator|->
name|i_ctlr
operator|<
literal|0
operator|||
name|io
operator|->
name|i_ctlr
operator|>
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* dma setup: see page 5-31 in the Adaptech manual */
name|outb
argument_list|(
literal|0xd6
argument_list|,
literal|0xc1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0xd4
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|ASPRINT
argument_list|(
operator|(
literal|"resetting adaptech card... "
operator|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|as_port
operator|+
name|AS_CONTROL
argument_list|,
name|AS_CONTROL_SRST
argument_list|)
expr_stmt|;
comment|/* delay a little */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
while|while
condition|(
name|inb
argument_list|(
name|as_port
operator|+
name|AS_STATUS
argument_list|)
operator|!=
operator|(
name|AS_STATUS_INIT
operator||
name|AS_STATUS_IDLE
operator|)
condition|)
empty_stmt|;
name|ASPRINT
argument_list|(
operator|(
literal|"reset ok "
operator|)
argument_list|)
expr_stmt|;
name|as_put_byte
argument_list|(
name|AS_CMD_MAILBOX_INIT
argument_list|)
expr_stmt|;
name|as_put_byte
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* one mailbox out, one in */
name|as_put_byte
argument_list|(
operator|(
name|int
operator|)
name|mailbox
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|as_put_byte
argument_list|(
operator|(
name|int
operator|)
name|mailbox
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|as_put_byte
argument_list|(
operator|(
name|int
operator|)
name|mailbox
argument_list|)
expr_stmt|;
while|while
condition|(
name|inb
argument_list|(
name|as_port
operator|+
name|AS_STATUS
argument_list|)
operator|&
name|AS_STATUS_INIT
condition|)
empty_stmt|;
name|ASPRINT
argument_list|(
operator|(
literal|"mailbox init ok "
operator|)
argument_list|)
expr_stmt|;
comment|/* do mode select to set the logical block size */
name|bzero
argument_list|(
name|cdb
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|cdb
index|[
literal|0
index|]
operator|=
literal|0x15
expr_stmt|;
comment|/* MODE SELECT */
name|cdb
index|[
literal|4
index|]
operator|=
literal|12
expr_stmt|;
comment|/* parameter list length */
name|bzero
argument_list|(
name|data
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|data
index|[
literal|3
index|]
operator|=
literal|8
expr_stmt|;
comment|/* block descriptor length */
name|data
index|[
literal|9
index|]
operator|=
name|DEV_BSIZE
operator|>>
literal|16
expr_stmt|;
name|data
index|[
literal|10
index|]
operator|=
name|DEV_BSIZE
operator|>>
literal|8
expr_stmt|;
name|data
index|[
literal|11
index|]
operator|=
name|DEV_BSIZE
expr_stmt|;
if|if
condition|(
name|ascmd
argument_list|(
name|io
operator|->
name|i_unit
argument_list|,
literal|0
argument_list|,
name|cdb
argument_list|,
literal|6
argument_list|,
name|data
argument_list|,
literal|12
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"as%d: error setting logical block size\n"
argument_list|,
name|io
operator|->
name|i_unit
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|aio
operator|=
operator|*
name|io
expr_stmt|;
name|aio
operator|.
name|i_bn
operator|=
name|LABELSECTOR
expr_stmt|;
name|aio
operator|.
name|i_cc
operator|=
name|DEV_BSIZE
expr_stmt|;
comment|/*io->i_ma = buf;*/
name|aio
operator|.
name|i_boff
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|was
if|if
condition|(
name|asstrategy
argument_list|(
operator|&
name|aio
argument_list|,
name|F_READ
argument_list|)
operator|==
name|DEV_BSIZE
condition|)
block|{
name|dd
operator|=
operator|(
expr|struct
name|disklabel
operator|*
operator|)
name|aio
operator|.
name|i_ma
expr_stmt|;
name|io
operator|->
name|i_boff
operator|=
name|dd
operator|->
name|d_partitions
index|[
name|io
operator|->
name|i_part
index|]
operator|.
name|p_offset
expr_stmt|;
name|ASPRINT
argument_list|(
operator|(
literal|"partition offset %d "
operator|,
name|io
operator|->
name|i_boff
operator|)
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
block|{
specifier|extern
name|struct
name|disklabel
name|disklabel
decl_stmt|;
name|io
operator|->
name|i_boff
operator|=
name|disklabel
operator|.
name|d_partitions
index|[
name|io
operator|->
name|i_part
index|]
operator|.
name|p_offset
expr_stmt|;
name|ASPRINT
argument_list|(
operator|(
literal|"partition offset %d "
operator|,
name|io
operator|->
name|i_boff
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|ASPRINT
argument_list|(
operator|(
literal|"asopen ok "
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* func is F_WRITE or F_READ  * io->i_unit, io->i_part, io->i_bn is starting block  * io->i_cc is byte count  * io->i_ma is memory address  * io->i_boff is block offset for this partition (set up in asopen)  */
end_comment

begin_function
name|int
name|asstrategy
parameter_list|(
name|io
parameter_list|,
name|func
parameter_list|)
name|struct
name|iob
modifier|*
name|io
decl_stmt|;
block|{
name|char
name|cdb
index|[
literal|6
index|]
decl_stmt|;
name|int
name|blkno
decl_stmt|;
name|int
name|retry
decl_stmt|;
name|ASPRINT
argument_list|(
operator|(
literal|"asstrategy(target=%d, block=%d+%d, count=%d) "
operator|,
name|io
operator|->
name|i_unit
operator|,
name|io
operator|->
name|i_bn
operator|,
name|io
operator|->
name|i_boff
operator|,
name|io
operator|->
name|i_cc
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|func
operator|==
name|F_WRITE
condition|)
block|{
name|printf
argument_list|(
literal|"as%d: write not supported\n"
argument_list|,
name|io
operator|->
name|i_unit
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|io
operator|->
name|i_cc
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|io
operator|->
name|i_cc
operator|%
name|DEV_BSIZE
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"as%d: transfer size not multiple of %d\n"
argument_list|,
name|io
operator|->
name|i_unit
argument_list|,
name|DEV_BSIZE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* retry in case we get a unit-attention error, which just 	 * means the drive has been reset since the last command 	 */
for|for
control|(
name|retry
operator|=
literal|0
init|;
name|retry
operator|<
name|NRETRIES
condition|;
name|retry
operator|++
control|)
block|{
name|blkno
operator|=
name|io
operator|->
name|i_bn
operator|+
name|io
operator|->
name|i_boff
expr_stmt|;
name|cdb
index|[
literal|0
index|]
operator|=
literal|8
expr_stmt|;
comment|/* scsi read opcode */
name|cdb
index|[
literal|1
index|]
operator|=
operator|(
name|blkno
operator|>>
literal|16
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|cdb
index|[
literal|2
index|]
operator|=
name|blkno
operator|>>
literal|8
expr_stmt|;
name|cdb
index|[
literal|3
index|]
operator|=
name|blkno
expr_stmt|;
name|cdb
index|[
literal|4
index|]
operator|=
name|io
operator|->
name|i_cc
operator|/
name|DEV_BSIZE
expr_stmt|;
name|cdb
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
comment|/* control byte (used in linking) */
if|if
condition|(
name|ascmd
argument_list|(
name|io
operator|->
name|i_unit
argument_list|,
literal|1
argument_list|,
name|cdb
argument_list|,
literal|6
argument_list|,
name|io
operator|->
name|i_ma
argument_list|,
name|io
operator|->
name|i_cc
argument_list|,
name|retry
operator|==
name|NRETRIES
operator|-
literal|1
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|ASPRINT
argument_list|(
operator|(
literal|"asstrategy ok "
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|io
operator|->
name|i_cc
operator|)
return|;
block|}
block|}
name|ASPRINT
argument_list|(
operator|(
literal|"asstrategy failed "
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ascmd
parameter_list|(
name|target
parameter_list|,
name|readflag
parameter_list|,
name|cdb
parameter_list|,
name|cdblen
parameter_list|,
name|data
parameter_list|,
name|datalen
parameter_list|,
name|printerr
parameter_list|)
name|int
name|target
decl_stmt|;
name|int
name|readflag
decl_stmt|;
name|char
modifier|*
name|cdb
decl_stmt|;
name|int
name|cdblen
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|datalen
decl_stmt|;
name|int
name|printerr
decl_stmt|;
block|{
name|struct
name|ccb
name|ccb
decl_stmt|;
name|int
name|physaddr
decl_stmt|;
name|unsigned
name|char
modifier|*
name|sp
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|mailbox
index|[
literal|0
index|]
operator|.
name|cmd
operator|!=
literal|0
condition|)
comment|/* this can't happen, unless the card flakes */
name|_stop
argument_list|(
literal|"asstart: mailbox not available\n"
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ccb
argument_list|,
sizeof|sizeof
name|ccb
argument_list|)
expr_stmt|;
name|ccb
operator|.
name|ccb_opcode
operator|=
literal|3
expr_stmt|;
name|ccb
operator|.
name|ccb_addr_and_control
operator|=
name|target
operator|<<
literal|5
expr_stmt|;
if|if
condition|(
name|datalen
operator|!=
literal|0
condition|)
name|ccb
operator|.
name|ccb_addr_and_control
operator||=
name|readflag
condition|?
literal|8
else|:
literal|0x10
expr_stmt|;
else|else
name|ccb
operator|.
name|ccb_addr_and_control
operator||=
literal|0x18
expr_stmt|;
name|ccb
operator|.
name|ccb_data_len_msb
operator|=
name|datalen
operator|>>
literal|16
expr_stmt|;
name|ccb
operator|.
name|ccb_data_len_mid
operator|=
name|datalen
operator|>>
literal|8
expr_stmt|;
name|ccb
operator|.
name|ccb_data_len_lsb
operator|=
name|datalen
expr_stmt|;
name|ccb
operator|.
name|ccb_requst_sense_allocation_len
operator|=
name|MAXSENSE
expr_stmt|;
name|physaddr
operator|=
operator|(
name|int
operator|)
name|data
expr_stmt|;
name|ccb
operator|.
name|ccb_data_ptr_msb
operator|=
name|physaddr
operator|>>
literal|16
expr_stmt|;
name|ccb
operator|.
name|ccb_data_ptr_mid
operator|=
name|physaddr
operator|>>
literal|8
expr_stmt|;
name|ccb
operator|.
name|ccb_data_ptr_lsb
operator|=
name|physaddr
expr_stmt|;
name|ccb
operator|.
name|ccb_scsi_command_len
operator|=
name|cdblen
expr_stmt|;
name|bcopy
argument_list|(
name|cdb
argument_list|,
name|ccb
operator|.
name|ccb_cdb
argument_list|,
name|cdblen
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ASDEBUG
name|printf
argument_list|(
literal|"ccb: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|48
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%x "
argument_list|,
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|ccb
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/*getchar ();*/
endif|#
directive|endif
name|physaddr
operator|=
operator|(
name|int
operator|)
operator|&
name|ccb
expr_stmt|;
name|mailbox
index|[
literal|0
index|]
operator|.
name|msb
operator|=
name|physaddr
operator|>>
literal|16
expr_stmt|;
name|mailbox
index|[
literal|0
index|]
operator|.
name|mid
operator|=
name|physaddr
operator|>>
literal|8
expr_stmt|;
name|mailbox
index|[
literal|0
index|]
operator|.
name|lsb
operator|=
name|physaddr
expr_stmt|;
name|mailbox
index|[
literal|0
index|]
operator|.
name|cmd
operator|=
literal|1
expr_stmt|;
comment|/* tell controller to look in its mailbox */
name|outb
argument_list|(
name|as_port
operator|+
name|AS_CONTROL
argument_list|,
name|AS_CONTROL_IRST
argument_list|)
expr_stmt|;
name|as_put_byte
argument_list|(
name|AS_CMD_START_SCSI_COMMAND
argument_list|)
expr_stmt|;
comment|/* wait for status */
name|ASPRINT
argument_list|(
operator|(
literal|"waiting for status..."
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|mailbox
index|[
literal|1
index|]
operator|.
name|cmd
operator|==
literal|0
condition|)
empty_stmt|;
name|mailbox
index|[
literal|1
index|]
operator|.
name|cmd
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ccb
operator|.
name|ccb_host_status
operator|!=
literal|0
operator|||
name|ccb
operator|.
name|ccb_target_status
operator|!=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|ASDEBUG
name|printerr
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|printerr
condition|)
block|{
name|printf
argument_list|(
literal|"as%d error: hst=%x tst=%x sense="
argument_list|,
name|target
argument_list|,
name|ccb
operator|.
name|ccb_host_status
argument_list|,
name|ccb
operator|.
name|ccb_target_status
argument_list|)
expr_stmt|;
name|sp
operator|=
name|ccb_sense
argument_list|(
operator|&
name|ccb
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%x "
argument_list|,
name|sp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ASDEBUG
comment|/*getchar ();*/
endif|#
directive|endif
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ASPRINT
argument_list|(
operator|(
literal|"ascmd ok "
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as_put_byte
parameter_list|(
name|val
parameter_list|)
name|int
name|val
decl_stmt|;
block|{
while|while
condition|(
name|inb
argument_list|(
name|as_port
operator|+
name|AS_STATUS
argument_list|)
operator|&
name|AS_STATUS_CDF
condition|)
empty_stmt|;
name|outb
argument_list|(
name|as_port
operator|+
name|AS_DATA_OUT
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


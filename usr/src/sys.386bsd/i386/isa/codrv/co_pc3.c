begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*      Copyright 1992 by Holger Veit  *	May be freely used with Bill Jolitz's port of   *	386bsd and may be included in a 386bsd collection  *	as long as binary and source are available and reproduce the above  *	copyright.  *  *	You may freely modify this code and contribute improvements based  *	on this code as long as you don't claim to be the original author.  *	Commercial use of this source requires permittance of the copyright   *	holder. A general license for 386bsd will override this restriction.  *  *	Use at your own risk. The copyright holder or any person who makes  *	this code available for the public (administrators of public archives  *	for instance) are not responsible for any harm to hardware or software  *	that might happen due to wrong application or program faults.  *  *	@(#) $RCSfile: co_pc3.c,v $	$Revision: 1.6 $ (Contributed to 386bsd) $Date: 93/01/23 23:14:46 $  *  *	History: see CO_HISTORY  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /usr/src/sys.386bsd/i386/isa/codrv/RCS/co_pc3.c,v 1.6 93/01/23 23:14:46 root Exp Locker: root $"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* This file provides a plug-in interface for different terminal emulations.  * As a reference, the pc3/pc3x/pc3n/pc3nc interface is shown.  *   * Programmers are invited to provide different emulations, e.g.   * vt100/vt220/vt320, adm3a/adm31, hp262x, etc.  *  * The following conventions have to be met:  *  * The video subsystem provides a number of support functions to   * manipulate screen data, such as writing to a VTY screen, or moving the   * cursor, etc.  *  * All these routines are named "emul_*". See co_hdr.h for a list of available  * facilities. You will see that these are defines to either a set of  * "vga_*" or "gfx_*" routines (not yet available). To make a migration to  * the future graphics console as smooth as possible, avoid using other  * routines to access the screen, even if you know tricky code  * that runs 10 times as fast. There is time enough to do optimizations  * when the graphics subsystem is running.  *  ***************************************************************************  *  * This file contains one central routine, 'vtemul_exec', which is called  * by the console driver, with the following arguments:  *  * vp:	Pointer to the actual vty  * ch:	Character to be processed (note that this is not a "u_char"!)  *  ***************************************************************************  *  * A second call is used during coattach: 'vtemul_init', which   * can be used for local initialisation. vtemul_init also MUST fill an  * identifier into the field 'emul_name' of struct consinfo cons_capabilities.  *  ***************************************************************************  *  * Only use the PUBLIC fields in struct vty!  * Don't rely on the PRIVATE members of the structure, even if you  * can access them (PRIVATE and PUBLIC are #defines only).  * The reason is, that a future version may run in graphics mode, and  * will interpret these fields in a different way you may think they  * might be used. This holds in particular for Crtat and Crtat!!!!  *  * If you need more special variables, use a local structure  * use #include "vty.h" to find out the number of vtys available.  * But even in the local structure, don't think that there is   * direct accessible video memory, even if using this this speeds up   * everything extremely!  */
end_comment

begin_comment
comment|/* example code follows: */
end_comment

begin_comment
comment|/* check my optional symbol to avoid multiple inclusions */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PC3
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|MINITERM
end_ifndef

begin_include
include|#
directive|include
file|"co_hdr.h"
end_include

begin_include
include|#
directive|include
file|"vty.h"
end_include

begin_define
define|#
directive|define
name|ESC_NONE
value|0
end_define

begin_comment
comment|/* No esc in progress */
end_comment

begin_define
define|#
directive|define
name|ESC_WBRAC
value|1
end_define

begin_comment
comment|/* got esc, wait for '[' or 'c' */
end_comment

begin_define
define|#
directive|define
name|ESC_WPARAM
value|2
end_define

begin_comment
comment|/* got esc [, wait for param, ';' or letter */
end_comment

begin_comment
comment|/* !!! this may look like a Keycap_def, like in co_kbd.c, but isn't ! :-) */
end_comment

begin_struct
specifier|static
struct|struct
name|Keycap2
block|{
name|short
name|key
decl_stmt|;
name|u_short
name|type
decl_stmt|;
comment|/* type of key */
name|XCHAR
name|unshift
index|[
name|KBDDEFOVLKEYSIZE
operator|+
literal|1
index|]
decl_stmt|;
comment|/* default codes */
name|XCHAR
name|shift
index|[
name|KBDDEFOVLKEYSIZE
operator|+
literal|1
index|]
decl_stmt|;
name|XCHAR
name|ctrl
index|[
name|KBDDEFOVLKEYSIZE
operator|+
literal|1
index|]
decl_stmt|;
block|}
name|pc3keys
index|[]
init|=
block|{
literal|75
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'L'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'a'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'b'
argument_list|)
block|,
comment|/* INS */
literal|76
block|,
name|KBD_FUNC
block|,
name|XC1
argument_list|(
literal|'\177'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'c'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'d'
argument_list|)
block|,
comment|/* DEL */
literal|79
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'D'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'e'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'f'
argument_list|)
block|,
comment|/* CU<- */
literal|80
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'H'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'g'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'h'
argument_list|)
block|,
comment|/* HOME */
literal|81
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'F'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'i'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'j'
argument_list|)
block|,
comment|/* END */
literal|83
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'A'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'k'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'l'
argument_list|)
block|,
comment|/* CU ^ */
literal|84
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'B'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'m'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'n'
argument_list|)
block|,
comment|/* CU v */
literal|85
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'I'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'o'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'p'
argument_list|)
block|,
comment|/* PG UP */
literal|86
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'G'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'q'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'r'
argument_list|)
block|,
comment|/* PG DN */
literal|89
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'C'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'s'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'|'
argument_list|,
literal|'t'
argument_list|)
block|,
comment|/* CU -> */
literal|91
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'7'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'H'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'7'
argument_list|)
block|,
literal|92
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'4'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'D'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'4'
argument_list|)
block|,
literal|93
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'1'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'F'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'1'
argument_list|)
block|,
literal|95
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'/'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'/'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'/'
argument_list|)
block|,
literal|96
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'8'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'A'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'8'
argument_list|)
block|,
literal|97
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'5'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'E'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'5'
argument_list|)
block|,
literal|98
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'2'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'B'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'2'
argument_list|)
block|,
literal|99
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'0'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'L'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'0'
argument_list|)
block|,
literal|100
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'*'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'*'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'*'
argument_list|)
block|,
literal|101
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'9'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'I'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'9'
argument_list|)
block|,
literal|102
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'6'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'C'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'6'
argument_list|)
block|,
literal|103
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'3'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'G'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'3'
argument_list|)
block|,
literal|104
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'.'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'\177'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'.'
argument_list|)
block|,
literal|105
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'-'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'-'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'-'
argument_list|)
block|,
literal|106
block|,
name|KBD_KP
block|,
name|XC1
argument_list|(
literal|'+'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'+'
argument_list|)
block|,
name|XC1
argument_list|(
literal|'+'
argument_list|)
block|,
literal|112
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'M'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'Y'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'k'
argument_list|)
block|,
comment|/* F1 */
literal|113
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'N'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'Z'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'l'
argument_list|)
block|,
comment|/* F2 */
literal|114
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'O'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'a'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'m'
argument_list|)
block|,
comment|/* F3 */
literal|115
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'P'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'b'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'n'
argument_list|)
block|,
comment|/* F4 */
literal|116
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'Q'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'c'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'o'
argument_list|)
block|,
comment|/* F5 */
literal|117
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'R'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'d'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'p'
argument_list|)
block|,
comment|/* F6 */
literal|118
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'S'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'e'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'q'
argument_list|)
block|,
comment|/* F7 */
literal|119
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'T'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'f'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'r'
argument_list|)
block|,
comment|/* F8 */
literal|120
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'U'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'g'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'s'
argument_list|)
block|,
comment|/* F9 */
literal|121
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'V'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'h'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'t'
argument_list|)
block|,
comment|/* F10 */
literal|122
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'W'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'i'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'u'
argument_list|)
block|,
comment|/* F11 */
literal|123
block|,
name|KBD_FUNC
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'X'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'j'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'v'
argument_list|)
block|,
comment|/* F12 */
literal|124
block|,
name|KBD_KP
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'w'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'x'
argument_list|)
block|,
name|XE3
argument_list|(
literal|'['
argument_list|,
literal|'y'
argument_list|)
block|,
literal|0
block|,
name|KBD_NONE
block|,
name|XC0
block|,
name|XC0
block|,
name|XC0
block|}
struct|;
end_struct

begin_comment
comment|/*  *	Do the local initialisations. Notice that many things are already done  *	in vty_init  */
end_comment

begin_function
name|void
name|vtemul_init
parameter_list|()
block|{
name|char
modifier|*
name|c
decl_stmt|,
modifier|*
name|id
init|=
literal|"pc3n"
decl_stmt|;
name|XCHAR
modifier|*
name|xc
decl_stmt|;
name|Keycap_def
modifier|*
name|kp
decl_stmt|;
name|struct
name|Keycap2
modifier|*
name|k2
decl_stmt|;
comment|/* fill the cons_capabilities structure 	 * Don't use strcpy here! 	 */
name|c
operator|=
name|id
expr_stmt|;
name|xc
operator|=
name|cons_capabilities
operator|.
name|emul_name
expr_stmt|;
while|while
condition|(
operator|*
name|xc
operator|++
operator|=
name|xc_char2xc
argument_list|(
operator|*
name|c
operator|++
argument_list|)
condition|)
empty_stmt|;
define|#
directive|define
name|copydef
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|)
define|\
value|xc_bcopy(src,dst,KBDDEFOVLKEYSIZE)
comment|/* set the function keys new */
for|for
control|(
name|k2
operator|=
name|pc3keys
init|;
name|k2
operator|->
name|key
condition|;
name|k2
operator|++
control|)
block|{
name|kp
operator|=
operator|&
name|kbd_keytab
index|[
name|k2
operator|->
name|key
index|]
expr_stmt|;
name|kp
operator|->
name|type
operator|=
name|k2
operator|->
name|type
expr_stmt|;
name|kp
operator|->
name|ovlptr
operator|=
literal|0
expr_stmt|;
name|copydef
argument_list|(
name|k2
operator|->
name|unshift
argument_list|,
name|kp
operator|->
name|unshift
argument_list|)
expr_stmt|;
name|copydef
argument_list|(
name|k2
operator|->
name|shift
argument_list|,
name|kp
operator|->
name|shift
argument_list|)
expr_stmt|;
name|copydef
argument_list|(
name|k2
operator|->
name|ctrl
argument_list|,
name|kp
operator|->
name|ctrl
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  *	this routine does all the ESC and character processing stuff  */
end_comment

begin_function
name|void
name|vtemul_exec
parameter_list|(
name|struct
name|vty
modifier|*
name|vp
parameter_list|,
name|XCHAR
name|ch
parameter_list|)
block|{
name|int
name|inccol
decl_stmt|,
name|par1
decl_stmt|,
name|par2
decl_stmt|;
name|int
name|sc
init|=
literal|1
decl_stmt|;
comment|/* do scroll check */
name|u_short
name|at
decl_stmt|,
name|sat
decl_stmt|;
name|struct
name|outmode
modifier|*
name|sk
init|=
name|vp
operator|->
name|op
decl_stmt|;
comment|/* which attributes do we use? */
name|at
operator|=
name|sk
operator|->
name|fg_at
operator||
name|sk
operator|->
name|bg_at
expr_stmt|;
name|sat
operator|=
name|vp
operator|->
name|so_at
expr_stmt|;
comment|/* translate to proper font */
name|ch
operator|=
name|vga_xlatiso646
argument_list|(
name|vp
argument_list|,
operator|&
name|at
argument_list|,
operator|&
name|sat
argument_list|,
name|ch
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|016
case|:
comment|/* SO, select font 2 */
name|emul_selectfont
argument_list|(
name|vp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|017
case|:
comment|/* SI, select font 1 */
name|emul_selectfont
argument_list|(
name|vp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1B
case|:
if|if
condition|(
name|sk
operator|->
name|escstate
operator|!=
name|ESC_NONE
condition|)
name|emul_wrtchar
argument_list|(
name|vp
argument_list|,
name|ch
argument_list|,
name|sat
argument_list|)
expr_stmt|;
else|else
name|sk
operator|->
name|escstate
operator|=
name|ESC_WBRAC
expr_stmt|;
break|break;
case|case
literal|'\t'
case|:
name|inccol
operator|=
operator|(
literal|8
operator|-
name|vp
operator|->
name|col
operator|%
literal|8
operator|)
expr_stmt|;
comment|/* non-destructive tab */
name|emul_cursorrelative
argument_list|(
name|vp
argument_list|,
name|inccol
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\010'
case|:
name|emul_cursorleft
argument_list|(
name|vp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\r'
case|:
name|emul_cursorrelative
argument_list|(
name|vp
argument_list|,
operator|-
name|vp
operator|->
name|col
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
name|emul_cursorrelative
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x07
case|:
comment|/* different sounds for different vtys possible */
name|sysbeep
argument_list|(
name|vp
operator|->
name|pitch
argument_list|,
name|vp
operator|->
name|duration
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* ESC Processing */
switch|switch
condition|(
name|sk
operator|->
name|escstate
condition|)
block|{
default|default:
case|case
name|ESC_NONE
case|:
comment|/* NO ESC, normal processing */
name|emul_wrtchar
argument_list|(
name|vp
argument_list|,
name|ch
argument_list|,
name|vp
operator|->
name|so
condition|?
name|sat
else|:
name|at
argument_list|)
expr_stmt|;
if|if
condition|(
name|vp
operator|->
name|col
operator|>=
name|vp
operator|->
name|ncol
condition|)
name|vp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ESC_WBRAC
case|:
comment|/* has seen ESC, wait for [ or 'c' */
if|if
condition|(
name|ch
operator|==
literal|'['
condition|)
block|{
name|sk
operator|->
name|escstate
operator|=
name|ESC_WPARAM
expr_stmt|;
name|sk
operator|->
name|parcnt
operator|=
literal|0
expr_stmt|;
name|sk
operator|->
name|param
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|sk
operator|->
name|param
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'c'
condition|)
block|{
comment|/* Clear screen& home */
name|emul_clearcursor
argument_list|(
name|vp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|emul_cursormove
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sk
operator|->
name|escstate
operator|=
name|ESC_NONE
expr_stmt|;
block|}
else|else
block|{
comment|/* error */
name|sk
operator|->
name|escstate
operator|=
name|ESC_NONE
expr_stmt|;
name|emul_wrtchar
argument_list|(
name|vp
argument_list|,
name|ch
argument_list|,
name|sat
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ESC_WPARAM
case|:
comment|/* has seen ESC [ wait for digit, ';' or letter */
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
block|{
name|sk
operator|->
name|param
index|[
name|sk
operator|->
name|parcnt
index|]
operator|*=
literal|10
expr_stmt|;
name|sk
operator|->
name|param
index|[
name|sk
operator|->
name|parcnt
index|]
operator|+=
name|ch
operator|-
literal|'0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|';'
condition|)
block|{
if|if
condition|(
name|sk
operator|->
name|parcnt
operator|>=
literal|2
condition|)
block|{
name|sk
operator|->
name|escstate
operator|=
name|ESC_NONE
expr_stmt|;
comment|/* error */
name|emul_wrtchar
argument_list|(
name|vp
argument_list|,
name|ch
argument_list|,
name|sat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sk
operator|->
name|parcnt
operator|++
expr_stmt|;
name|sk
operator|->
name|param
index|[
name|sk
operator|->
name|parcnt
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ch
operator|>=
literal|' '
operator|&&
name|ch
operator|<=
literal|'~'
condition|)
block|{
name|par1
operator|=
name|sk
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
name|par2
operator|=
name|sk
operator|->
name|param
index|[
literal|1
index|]
expr_stmt|;
name|sk
operator|->
name|parcnt
operator|++
expr_stmt|;
name|sk
operator|->
name|param
index|[
name|sk
operator|->
name|parcnt
index|]
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'A'
case|:
comment|/* back cx rows */
name|emul_cursorup
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|)
expr_stmt|;
name|sc
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* down cx rows */
name|emul_cursordown
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|)
expr_stmt|;
name|sc
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
comment|/* right cursor */
name|emul_cursorright
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* left cursor */
name|emul_cursorleft
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|)
expr_stmt|;
name|sc
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* in system V consoles */
case|case
literal|'H'
case|:
comment|/* Cursor move */
name|emul_cursormove
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|,
name|par2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'J'
case|:
comment|/* Clear ... */
name|emul_clearcursor
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
comment|/* Clear line ... */
name|emul_clearline
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
comment|/* Insert Line */
name|emul_insertline
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
comment|/* Delete Line */
name|emul_deleteline
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
comment|/* delete spaces */
name|emul_deletechars
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* scroll up cx lines */
name|emul_scrollup
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
comment|/* scroll down cx lines */
name|emul_scrolldown
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* standout mode */
if|if
condition|(
name|par1
condition|)
name|vp
operator|->
name|so
operator|=
literal|1
expr_stmt|;
else|else
name|vp
operator|->
name|so
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|vp
operator|->
name|so_at
operator|=
operator|(
name|par1
operator|&
literal|0x0f
operator|)
operator||
operator|(
operator|(
name|par2
operator|&
literal|0x0f
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
comment|/* set attributes */
name|emul_setattributes
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|,
name|par2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'@'
case|:
comment|/* insert spaces */
name|emul_insertchars
argument_list|(
name|vp
argument_list|,
name|par1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'!'
case|:
comment|/* set beep pitch and duration */
name|kbd_cvtsound
argument_list|(
name|par1
argument_list|,
operator|&
name|vp
operator|->
name|pitch
argument_list|,
name|par2
argument_list|,
operator|&
name|vp
operator|->
name|duration
argument_list|)
expr_stmt|;
break|break;
default|default:
name|emul_wrtchar
argument_list|(
name|vp
argument_list|,
name|ch
argument_list|,
name|sat
argument_list|)
expr_stmt|;
block|}
name|sk
operator|->
name|escstate
operator|=
name|ESC_NONE
expr_stmt|;
block|}
break|break;
block|}
block|}
if|if
condition|(
name|sc
operator|&&
name|emul_checkcursor
argument_list|(
name|vp
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|consoftc
operator|.
name|cs_flags
operator|&
name|CO_OPEN
condition|)
do|do
operator|(
name|void
operator|)
name|kbd_sgetc
argument_list|(
literal|1
argument_list|)
expr_stmt|;
do|while
condition|(
name|vp
operator|->
name|scroll
condition|)
do|;
name|emul_scrollup
argument_list|(
name|vp
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !MINITERM */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PC3 */
end_comment

end_unit


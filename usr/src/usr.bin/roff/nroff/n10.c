begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)n10.c	4.3 4/27/88"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|"tdef.h"
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_decl_stmt
specifier|extern
include|#
directive|include
file|"d.h"
specifier|extern
include|#
directive|include
file|"v.h"
specifier|extern
include|#
directive|include
file|"tw.h"
comment|/* nroff10.c  Device interfaces */
specifier|extern
name|int
name|lss
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|obuf
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|obufp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|xfont
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|esc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|lead
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|oline
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
modifier|*
name|olinep
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|ulfont
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|esct
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|sps
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|ics
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|ttysave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|sgttyb
name|ttys
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|termtab
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|ptid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|waitf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|pipeflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|eqflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|hflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|tabtab
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|ascii
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|xxx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dtab
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bdmode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|plotmode
decl_stmt|;
end_decl_stmt

begin_macro
name|ptinit
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|i
operator|,
name|j
expr_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|p
decl_stmt|;
name|char
modifier|*
name|q
decl_stmt|;
name|int
name|x
index|[
literal|8
index|]
decl_stmt|;
specifier|extern
name|char
modifier|*
name|setbrk
parameter_list|()
function_decl|;
if|if
condition|(
operator|(
operator|(
name|i
operator|=
name|open
argument_list|(
name|termtab
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
operator|)
operator|&&
operator|(
name|i
operator|=
name|open
argument_list|(
literal|"/usr/lib/term/tablpr"
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|prstr
argument_list|(
literal|"Cannot open "
argument_list|)
expr_stmt|;
name|prstr
argument_list|(
name|termtab
argument_list|)
expr_stmt|;
name|prstr
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|read
argument_list|(
name|i
argument_list|,
operator|(
name|char
operator|*
operator|)
name|x
argument_list|,
literal|8
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|i
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|t
operator|.
name|bset
argument_list|,
name|j
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
operator|&
name|t
operator|.
name|zzz
operator|-
operator|&
name|t
operator|.
name|bset
operator|)
argument_list|)
expr_stmt|;
name|x
index|[
literal|2
index|]
operator|-=
name|j
expr_stmt|;
name|q
operator|=
name|setbrk
argument_list|(
name|x
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|i
argument_list|,
operator|(
name|long
operator|)
name|t
operator|.
name|twinit
operator|+
literal|8
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|i
operator|=
name|read
argument_list|(
name|i
argument_list|,
name|q
argument_list|,
name|x
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|j
operator|=
name|q
operator|-
name|t
operator|.
name|twinit
expr_stmt|;
for|for
control|(
name|p
operator|=
operator|&
name|t
operator|.
name|twinit
init|;
name|p
operator|<
operator|&
name|t
operator|.
name|zzz
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
condition|)
operator|*
name|p
operator|+=
name|j
expr_stmt|;
else|else
operator|*
name|p
operator|=
literal|""
expr_stmt|;
block|}
name|sps
operator|=
name|EM
expr_stmt|;
name|ics
operator|=
name|EM
operator|*
literal|2
expr_stmt|;
name|dtab
operator|=
literal|8
operator|*
name|t
operator|.
name|Em
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|tabtab
index|[
name|i
index|]
operator|=
name|dtab
operator|*
operator|(
name|i
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|eqflg
condition|)
name|t
operator|.
name|Adj
operator|=
name|t
operator|.
name|Hor
expr_stmt|;
block|}
end_block

begin_macro
name|twdone
argument_list|()
end_macro

begin_block
block|{
name|obufp
operator|=
name|obuf
expr_stmt|;
name|oputs
argument_list|(
name|t
operator|.
name|twrest
argument_list|)
expr_stmt|;
name|flusho
argument_list|()
expr_stmt|;
if|if
condition|(
name|pipeflg
condition|)
block|{
name|close
argument_list|(
name|ptid
argument_list|)
expr_stmt|;
name|wait
argument_list|(
operator|&
name|waitf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ttysave
operator|!=
operator|-
literal|1
condition|)
block|{
name|ttys
operator|.
name|sg_flags
operator|=
name|ttysave
expr_stmt|;
name|stty
argument_list|(
literal|1
argument_list|,
operator|&
name|ttys
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|ptout
argument_list|(
argument|i
argument_list|)
end_macro

begin_decl_stmt
name|int
name|i
decl_stmt|;
end_decl_stmt

begin_block
block|{
operator|*
name|olinep
operator|++
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|olinep
operator|>=
operator|&
name|oline
index|[
name|LNSIZE
index|]
condition|)
name|olinep
operator|--
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|&
name|CMASK
operator|)
operator|!=
literal|'\n'
condition|)
return|return;
name|olinep
operator|--
expr_stmt|;
name|lead
operator|+=
name|dip
operator|->
name|blss
operator|+
name|lss
operator|-
name|t
operator|.
name|Newline
expr_stmt|;
name|dip
operator|->
name|blss
operator|=
literal|0
expr_stmt|;
name|esct
operator|=
name|esc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|olinep
operator|>
name|oline
condition|)
block|{
name|move
argument_list|()
expr_stmt|;
name|ptout1
argument_list|()
expr_stmt|;
name|oputs
argument_list|(
name|t
operator|.
name|twnl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lead
operator|+=
name|t
operator|.
name|Newline
expr_stmt|;
name|move
argument_list|()
expr_stmt|;
block|}
name|lead
operator|+=
name|dip
operator|->
name|alss
expr_stmt|;
name|dip
operator|->
name|alss
operator|=
literal|0
expr_stmt|;
name|olinep
operator|=
name|oline
expr_stmt|;
block|}
end_block

begin_macro
name|ptout1
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|i
operator|,
name|k
expr_stmt|;
specifier|register
name|char
modifier|*
name|codep
decl_stmt|;
specifier|extern
name|char
modifier|*
name|plot
parameter_list|()
function_decl|;
name|int
modifier|*
name|q
decl_stmt|,
name|w
decl_stmt|,
name|j
decl_stmt|,
name|phyw
decl_stmt|;
for|for
control|(
name|q
operator|=
name|oline
init|;
name|q
operator|<
name|olinep
condition|;
name|q
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|i
operator|=
operator|*
name|q
operator|)
operator|&
name|MOT
condition|)
block|{
name|j
operator|=
name|i
operator|&
operator|~
name|MOTV
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|NMOT
condition|)
name|j
operator|=
operator|-
name|j
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|VMOT
condition|)
name|lead
operator|+=
name|j
expr_stmt|;
else|else
name|esc
operator|+=
name|j
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|k
operator|=
operator|(
name|i
operator|&
name|CMASK
operator|)
operator|)
operator|<=
literal|040
condition|)
block|{
switch|switch
condition|(
name|k
condition|)
block|{
case|case
literal|' '
case|:
comment|/*space*/
name|esc
operator|+=
name|t
operator|.
name|Char
expr_stmt|;
break|break;
block|}
continue|continue;
block|}
name|codep
operator|=
name|t
operator|.
name|codetab
index|[
name|k
operator|-
literal|32
index|]
expr_stmt|;
name|w
operator|=
name|t
operator|.
name|Char
operator|*
operator|(
operator|*
name|codep
operator|++
operator|&
literal|0177
operator|)
expr_stmt|;
name|phyw
operator|=
name|w
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|ZBIT
condition|)
name|w
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|codep
operator|&&
operator|(
name|esc
operator|||
name|lead
operator|)
condition|)
name|move
argument_list|()
expr_stmt|;
name|esct
operator|+=
name|w
expr_stmt|;
if|if
condition|(
name|i
operator|&
literal|074000
condition|)
name|xfont
operator|=
operator|(
name|i
operator|>>
literal|9
operator|)
operator|&
literal|03
expr_stmt|;
if|if
condition|(
operator|*
name|t
operator|.
name|bdon
operator|&
literal|0377
condition|)
block|{
if|if
condition|(
operator|!
name|bdmode
operator|&&
operator|(
name|xfont
operator|==
literal|2
operator|)
condition|)
block|{
name|oputs
argument_list|(
name|t
operator|.
name|bdon
argument_list|)
expr_stmt|;
name|bdmode
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|bdmode
operator|&&
operator|(
name|xfont
operator|!=
literal|2
operator|)
condition|)
block|{
name|oputs
argument_list|(
name|t
operator|.
name|bdoff
argument_list|)
expr_stmt|;
name|bdmode
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|xfont
operator|==
name|ulfont
condition|)
block|{
for|for
control|(
name|k
operator|=
name|w
operator|/
name|t
operator|.
name|Char
init|;
name|k
operator|>
literal|0
condition|;
name|k
operator|--
control|)
name|oput
argument_list|(
literal|'_'
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
name|w
operator|/
name|t
operator|.
name|Char
init|;
name|k
operator|>
literal|0
condition|;
name|k
operator|--
control|)
name|oput
argument_list|(
literal|'\b'
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|*
name|codep
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|codep
operator|&
literal|0200
condition|)
block|{
name|codep
operator|=
name|plot
argument_list|(
name|codep
argument_list|)
expr_stmt|;
name|oputs
argument_list|(
name|t
operator|.
name|plotoff
argument_list|)
expr_stmt|;
name|oput
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|plotmode
condition|)
name|oputs
argument_list|(
name|t
operator|.
name|plotoff
argument_list|)
expr_stmt|;
comment|/* 			 * simulate bold font as overstrike if no t.bdon 			 */
if|if
condition|(
name|xfont
operator|==
literal|2
operator|&&
operator|!
operator|(
operator|*
name|t
operator|.
name|bdon
operator|&
literal|0377
operator|)
condition|)
block|{
name|oput
argument_list|(
operator|*
name|codep
argument_list|)
expr_stmt|;
name|oput
argument_list|(
literal|'\b'
argument_list|)
expr_stmt|;
block|}
operator|*
name|obufp
operator|++
operator|=
operator|*
name|codep
operator|++
expr_stmt|;
if|if
condition|(
name|obufp
operator|==
operator|(
name|obuf
operator|+
name|OBUFSZ
operator|+
name|ascii
operator|-
literal|1
operator|)
condition|)
name|flusho
argument_list|()
expr_stmt|;
comment|/*			oput(*codep++);*/
block|}
block|}
if|if
condition|(
operator|!
name|w
condition|)
for|for
control|(
name|k
operator|=
name|phyw
operator|/
name|t
operator|.
name|Char
init|;
name|k
operator|>
literal|0
condition|;
name|k
operator|--
control|)
name|oput
argument_list|(
literal|'\b'
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|char
modifier|*
name|plot
parameter_list|(
name|x
parameter_list|)
name|char
modifier|*
name|x
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|j
decl_stmt|,
modifier|*
name|k
decl_stmt|;
if|if
condition|(
operator|!
name|plotmode
condition|)
name|oputs
argument_list|(
name|t
operator|.
name|ploton
argument_list|)
expr_stmt|;
name|k
operator|=
name|x
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|k
operator|&
literal|0377
operator|)
operator|==
literal|0200
condition|)
name|k
operator|++
expr_stmt|;
for|for
control|(
init|;
operator|*
name|k
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|k
operator|&
literal|0200
condition|)
block|{
if|if
condition|(
operator|*
name|k
operator|&
literal|0100
condition|)
block|{
if|if
condition|(
operator|*
name|k
operator|&
literal|040
condition|)
name|j
operator|=
name|t
operator|.
name|up
expr_stmt|;
else|else
name|j
operator|=
name|t
operator|.
name|down
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|k
operator|&
literal|040
condition|)
name|j
operator|=
name|t
operator|.
name|left
expr_stmt|;
else|else
name|j
operator|=
name|t
operator|.
name|right
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|i
operator|=
operator|*
name|k
operator|&
literal|037
operator|)
condition|)
return|return
operator|(
operator|++
name|k
operator|)
return|;
while|while
condition|(
name|i
operator|--
condition|)
name|oputs
argument_list|(
name|j
argument_list|)
expr_stmt|;
block|}
else|else
name|oput
argument_list|(
operator|*
name|k
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|k
operator|)
return|;
block|}
end_function

begin_macro
name|move
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|k
expr_stmt|;
specifier|register
name|char
modifier|*
name|i
decl_stmt|,
modifier|*
name|j
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|int
name|iesct
decl_stmt|,
name|dt
decl_stmt|;
name|iesct
operator|=
name|esct
expr_stmt|;
if|if
condition|(
name|esct
operator|+=
name|esc
condition|)
name|i
operator|=
literal|"\0"
expr_stmt|;
else|else
name|i
operator|=
literal|"\n\0"
expr_stmt|;
name|j
operator|=
name|t
operator|.
name|hlf
expr_stmt|;
name|p
operator|=
name|t
operator|.
name|right
expr_stmt|;
name|q
operator|=
name|t
operator|.
name|down
expr_stmt|;
if|if
condition|(
name|lead
condition|)
block|{
if|if
condition|(
name|lead
operator|<
literal|0
condition|)
block|{
name|lead
operator|=
operator|-
name|lead
expr_stmt|;
name|i
operator|=
name|t
operator|.
name|flr
expr_stmt|;
comment|/*	if(!esct)i = t.flr; else i = "\0";*/
name|j
operator|=
name|t
operator|.
name|hlr
expr_stmt|;
name|q
operator|=
name|t
operator|.
name|up
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|i
operator|&
literal|0377
condition|)
block|{
name|k
operator|=
name|lead
operator|/
name|t
operator|.
name|Newline
expr_stmt|;
name|lead
operator|=
name|lead
operator|%
name|t
operator|.
name|Newline
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
name|oputs
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|j
operator|&
literal|0377
condition|)
block|{
name|k
operator|=
name|lead
operator|/
name|t
operator|.
name|Halfline
expr_stmt|;
name|lead
operator|=
name|lead
operator|%
name|t
operator|.
name|Halfline
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
name|oputs
argument_list|(
name|j
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no half-line forward, not at line begining */
name|k
operator|=
name|lead
operator|/
name|t
operator|.
name|Newline
expr_stmt|;
name|lead
operator|=
name|lead
operator|%
name|t
operator|.
name|Newline
expr_stmt|;
if|if
condition|(
name|k
operator|>
literal|0
condition|)
name|esc
operator|=
name|esct
expr_stmt|;
name|i
operator|=
literal|"\n"
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
name|oputs
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|esc
condition|)
block|{
if|if
condition|(
name|esc
operator|<
literal|0
condition|)
block|{
name|esc
operator|=
operator|-
name|esc
expr_stmt|;
name|j
operator|=
literal|"\b"
expr_stmt|;
name|p
operator|=
name|t
operator|.
name|left
expr_stmt|;
block|}
else|else
block|{
name|j
operator|=
literal|" "
expr_stmt|;
if|if
condition|(
name|hflg
condition|)
while|while
condition|(
operator|(
name|dt
operator|=
name|dtab
operator|-
operator|(
name|iesct
operator|%
name|dtab
operator|)
operator|)
operator|<=
name|esc
condition|)
block|{
if|if
condition|(
name|dt
operator|%
name|t
operator|.
name|Em
operator|||
name|dt
operator|==
name|t
operator|.
name|Em
condition|)
break|break;
name|oput
argument_list|(
name|TAB
argument_list|)
expr_stmt|;
name|esc
operator|-=
name|dt
expr_stmt|;
name|iesct
operator|+=
name|dt
expr_stmt|;
block|}
block|}
name|k
operator|=
name|esc
operator|/
name|t
operator|.
name|Em
expr_stmt|;
name|esc
operator|=
name|esc
operator|%
name|t
operator|.
name|Em
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
name|oputs
argument_list|(
name|j
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|t
operator|.
name|ploton
operator|&
literal|0377
operator|)
operator|&&
operator|(
name|esc
operator|||
name|lead
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|plotmode
condition|)
name|oputs
argument_list|(
name|t
operator|.
name|ploton
argument_list|)
expr_stmt|;
name|esc
operator|/=
name|t
operator|.
name|Hor
expr_stmt|;
name|lead
operator|/=
name|t
operator|.
name|Vert
expr_stmt|;
while|while
condition|(
name|esc
operator|--
condition|)
name|oputs
argument_list|(
name|p
argument_list|)
expr_stmt|;
while|while
condition|(
name|lead
operator|--
condition|)
name|oputs
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|oputs
argument_list|(
name|t
operator|.
name|plotoff
argument_list|)
expr_stmt|;
block|}
name|esc
operator|=
name|lead
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|ptlead
argument_list|()
end_macro

begin_block
block|{
name|move
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|dostop
argument_list|()
end_macro

begin_block
block|{
name|char
name|junk
decl_stmt|;
name|flusho
argument_list|()
expr_stmt|;
name|read
argument_list|(
literal|2
argument_list|,
operator|&
name|junk
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


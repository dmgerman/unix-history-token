begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// -*- C++ -*-
end_comment

begin_comment
comment|/* Copyright (C) 1989, 1990 Free Software Foundation, Inc.      Written by James Clark (jjc@jclark.uucp)  This file is part of groff.  groff is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 1, or (at your option) any later version.  groff is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with groff; see the file LICENSE.  If not, write to the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA. */
end_comment

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_define
define|#
directive|define
name|DEFAULT_LINEWIDTH
value|40
end_define

begin_decl_stmt
specifier|static
name|int
name|linewidth
init|=
name|DEFAULT_LINEWIDTH
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|draw_flag
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* These values were chosen because:  (MULTIPLIER*SIZESCALE)/(RES*UNITWIDTH) == 1/(2^20 * 72.27)  and 57816 is an exact multiple of both 72.27*SIZESCALE and 72.  The width in the groff font file is the product of MULTIPLIER and the width in the tfm file. */
end_comment

begin_define
define|#
directive|define
name|RES
value|57816
end_define

begin_define
define|#
directive|define
name|RES_7227
value|(RES/7227)
end_define

begin_define
define|#
directive|define
name|UNITWIDTH
value|131072
end_define

begin_define
define|#
directive|define
name|SIZESCALE
value|100
end_define

begin_define
define|#
directive|define
name|MULTIPLIER
value|1
end_define

begin_define
define|#
directive|define
name|FILL_MAX
value|1000
end_define

begin_decl_stmt
name|class
name|dvi_font
range|:
name|public
name|font
block|{
name|dvi_font
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
block|;
name|public
operator|:
name|int
name|checksum
block|;
name|int
name|design_size
block|;
operator|~
name|dvi_font
argument_list|()
block|;
name|void
name|handle_unknown_font_command
argument_list|(
argument|int argc
argument_list|,
argument|const char **argv
argument_list|)
block|;
specifier|static
name|dvi_font
operator|*
name|load_dvi_font
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
block|; }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|dvi_font
operator|*
name|dvi_font
operator|::
name|load_dvi_font
argument_list|(
argument|const char *s
argument_list|)
block|{
name|dvi_font
operator|*
name|f
operator|=
name|new
name|dvi_font
argument_list|(
name|s
argument_list|)
block|;
if|if
condition|(
operator|!
name|f
operator|->
name|load
argument_list|()
condition|)
block|{
name|delete
name|f
decl_stmt|;
return|return
literal|0
return|;
block|}
end_expr_stmt

begin_return
return|return
name|f
return|;
end_return

begin_expr_stmt
unit|}  dvi_font
operator|::
name|dvi_font
argument_list|(
specifier|const
name|char
operator|*
name|nm
argument_list|)
operator|:
name|font
argument_list|(
name|nm
argument_list|)
operator|,
name|checksum
argument_list|(
literal|0
argument_list|)
operator|,
name|design_size
argument_list|(
literal|0
argument_list|)
block|{ }
name|dvi_font
operator|::
operator|~
name|dvi_font
argument_list|()
block|{ }
name|void
name|dvi_font
operator|::
name|handle_unknown_font_command
argument_list|(
argument|int argc
argument_list|,
argument|const char **argv
argument_list|)
block|{
name|char
operator|*
name|ptr
block|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"checksum"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
name|fatal
argument_list|(
literal|"`checksum' command requires exactly 1 argument"
argument_list|)
expr_stmt|;
name|checksum
operator|=
name|int
argument_list|(
name|strtol
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|ptr
argument_list|,
literal|10
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|checksum
operator|==
literal|0
operator|&&
name|ptr
operator|==
name|argv
index|[
literal|1
index|]
condition|)
block|{
name|fatal
argument_list|(
literal|"bad checksum"
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_if
unit|}   else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"designsize"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
name|fatal
argument_list|(
literal|"`designsize' command requires exactly 1 argument"
argument_list|)
expr_stmt|;
name|design_size
operator|=
name|int
argument_list|(
name|strtol
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|ptr
argument_list|,
literal|10
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|design_size
operator|==
literal|0
operator|&&
name|ptr
operator|==
name|argv
index|[
literal|1
index|]
condition|)
block|{
name|fatal
argument_list|(
literal|"bad design size"
argument_list|)
expr_stmt|;
block|}
block|}
end_if

begin_define
unit|}
define|#
directive|define
name|FONTS_MAX
value|256
end_define

begin_macro
unit|struct
name|output_font
end_macro

begin_block
block|{
name|dvi_font
modifier|*
name|f
decl_stmt|;
name|int
name|point_size
decl_stmt|;
name|output_font
argument_list|()
operator|:
name|f
argument_list|(
literal|0
argument_list|)
block|{ }
block|}
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|class
name|dvi_printer
range|:
name|public
name|printer
block|{
name|FILE
operator|*
name|fp
block|;
name|int
name|max_drift
block|;
name|int
name|byte_count
block|;
name|int
name|last_bop
block|;
name|int
name|page_count
block|;
name|int
name|cur_h
block|;
name|int
name|cur_v
block|;
name|int
name|end_h
block|;
name|int
name|max_h
block|;
name|int
name|max_v
block|;
name|output_font
name|output_font_table
index|[
name|FONTS_MAX
index|]
block|;
name|font
operator|*
name|cur_font
block|;
name|int
name|cur_point_size
block|;
name|int
name|pushed
block|;
name|int
name|pushed_h
block|;
name|int
name|pushed_v
block|;
name|int
name|have_pushed
block|;
name|void
name|preamble
argument_list|()
block|;
name|void
name|postamble
argument_list|()
block|;
name|void
name|define_font
argument_list|(
name|int
argument_list|)
block|;
name|void
name|set_font
argument_list|(
name|int
argument_list|)
block|;
name|void
name|possibly_begin_line
argument_list|()
block|;
name|protected
operator|:
expr|enum
block|{
name|id_byte
operator|=
literal|2
block|,
name|set1
operator|=
literal|128
block|,
name|put1
operator|=
literal|133
block|,
name|put_rule
operator|=
literal|137
block|,
name|bop
operator|=
literal|139
block|,
name|eop
operator|=
literal|140
block|,
name|push
operator|=
literal|141
block|,
name|pop
operator|=
literal|142
block|,
name|right1
operator|=
literal|143
block|,
name|down1
operator|=
literal|157
block|,
name|fnt_num_0
operator|=
literal|171
block|,
name|fnt1
operator|=
literal|235
block|,
name|xxx1
operator|=
literal|239
block|,
name|fnt_def1
operator|=
literal|243
block|,
name|pre
operator|=
literal|247
block|,
name|post
operator|=
literal|248
block|,
name|post_post
operator|=
literal|249
block|,
name|filler
operator|=
literal|223
block|,   }
block|;
name|int
name|line_thickness
block|;
name|void
name|out1
argument_list|(
name|int
argument_list|)
block|;
name|void
name|out2
argument_list|(
name|int
argument_list|)
block|;
name|void
name|out3
argument_list|(
name|int
argument_list|)
block|;
name|void
name|out4
argument_list|(
name|int
argument_list|)
block|;
name|void
name|moveto
argument_list|(
name|int
argument_list|,
name|int
argument_list|)
block|;
name|void
name|out_string
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
block|;
name|void
name|out_signed
argument_list|(
argument|unsigned char
argument_list|,
argument|int
argument_list|)
block|;
name|void
name|out_unsigned
argument_list|(
argument|unsigned char
argument_list|,
argument|int
argument_list|)
block|;
name|void
name|do_special
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
block|;
name|public
operator|:
name|dvi_printer
argument_list|()
block|;
operator|~
name|dvi_printer
argument_list|()
block|;
name|font
operator|*
name|make_font
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
block|;
name|void
name|begin_page
argument_list|(
name|int
argument_list|)
block|;
name|void
name|end_page
argument_list|()
block|;
name|void
name|set_char
argument_list|(
argument|int
argument_list|,
argument|font *
argument_list|,
argument|const environment *
argument_list|,
argument|int w
argument_list|)
block|;
name|void
name|special
argument_list|(
name|char
operator|*
name|arg
argument_list|,
specifier|const
name|environment
operator|*
name|env
argument_list|)
block|;
name|void
name|end_of_line
argument_list|()
block|;
name|void
name|draw
argument_list|(
argument|int code
argument_list|,
argument|int *p
argument_list|,
argument|int np
argument_list|,
argument|const environment *env
argument_list|)
block|; }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|class
name|draw_dvi_printer
range|:
name|public
name|dvi_printer
block|{
name|int
name|output_pen_size
block|;
name|int
name|fill
block|;
name|void
name|set_line_thickness
argument_list|(
specifier|const
name|environment
operator|*
argument_list|)
block|;
name|void
name|fill_next
argument_list|()
block|;
name|public
operator|:
name|draw_dvi_printer
argument_list|()
block|;
operator|~
name|draw_dvi_printer
argument_list|()
block|;
name|void
name|draw
argument_list|(
argument|int code
argument_list|,
argument|int *p
argument_list|,
argument|int np
argument_list|,
argument|const environment *env
argument_list|)
block|;
name|void
name|end_page
argument_list|()
block|; }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|dvi_printer
operator|::
name|dvi_printer
argument_list|()
operator|:
name|byte_count
argument_list|(
literal|0
argument_list|)
operator|,
name|last_bop
argument_list|(
operator|-
literal|1
argument_list|)
operator|,
name|page_count
argument_list|(
literal|0
argument_list|)
operator|,
name|cur_font
argument_list|(
literal|0
argument_list|)
operator|,
name|fp
argument_list|(
name|stdout
argument_list|)
operator|,
name|max_h
argument_list|(
literal|0
argument_list|)
operator|,
name|max_v
argument_list|(
literal|0
argument_list|)
operator|,
name|pushed
argument_list|(
literal|0
argument_list|)
operator|,
name|line_thickness
argument_list|(
argument|-
literal|1
argument_list|)
block|{
if|if
condition|(
name|font
operator|::
name|res
operator|!=
name|RES
condition|)
name|fatal
argument_list|(
literal|"resolution must be %1"
argument_list|,
name|RES
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|font
operator|::
name|unitwidth
operator|!=
name|UNITWIDTH
condition|)
name|fatal
argument_list|(
literal|"unitwidth must be %1"
argument_list|,
name|UNITWIDTH
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|font
operator|::
name|hor
operator|!=
literal|1
condition|)
name|fatal
argument_list|(
literal|"hor must be equal to 1"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|font
operator|::
name|vert
operator|!=
literal|1
condition|)
name|fatal
argument_list|(
literal|"vert must be equal to 1"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|font
operator|::
name|sizescale
operator|!=
name|SIZESCALE
condition|)
name|fatal
argument_list|(
literal|"sizescale must be equal to %1"
argument_list|,
name|SIZESCALE
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|max_drift
operator|=
name|font
operator|::
name|res
operator|/
literal|1000
expr_stmt|;
end_expr_stmt

begin_comment
comment|// this is fairly arbitrary
end_comment

begin_expr_stmt
name|preamble
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  dvi_printer
operator|::
operator|~
name|dvi_printer
argument_list|()
block|{
name|postamble
argument_list|()
block|; }
name|draw_dvi_printer
operator|::
name|draw_dvi_printer
argument_list|()
operator|:
name|output_pen_size
argument_list|(
operator|-
literal|1
argument_list|)
operator|,
name|fill
argument_list|(
argument|FILL_MAX
argument_list|)
block|{ }
name|draw_dvi_printer
operator|::
operator|~
name|draw_dvi_printer
argument_list|()
block|{ }
name|void
name|dvi_printer
operator|::
name|out1
argument_list|(
argument|int n
argument_list|)
block|{
name|byte_count
operator|+=
literal|1
block|;
name|putc
argument_list|(
name|n
operator|&
literal|0xff
argument_list|,
name|fp
argument_list|)
block|; }
name|void
name|dvi_printer
operator|::
name|out2
argument_list|(
argument|int n
argument_list|)
block|{
name|byte_count
operator|+=
literal|2
block|;
name|putc
argument_list|(
operator|(
name|n
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|fp
argument_list|)
block|;
name|putc
argument_list|(
name|n
operator|&
literal|0xff
argument_list|,
name|fp
argument_list|)
block|; }
name|void
name|dvi_printer
operator|::
name|out3
argument_list|(
argument|int n
argument_list|)
block|{
name|byte_count
operator|+=
literal|3
block|;
name|putc
argument_list|(
operator|(
name|n
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
name|fp
argument_list|)
block|;
name|putc
argument_list|(
operator|(
name|n
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|fp
argument_list|)
block|;
name|putc
argument_list|(
name|n
operator|&
literal|0xff
argument_list|,
name|fp
argument_list|)
block|; }
name|void
name|dvi_printer
operator|::
name|out4
argument_list|(
argument|int n
argument_list|)
block|{
name|byte_count
operator|+=
literal|4
block|;
name|putc
argument_list|(
operator|(
name|n
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
name|fp
argument_list|)
block|;
name|putc
argument_list|(
operator|(
name|n
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
name|fp
argument_list|)
block|;
name|putc
argument_list|(
operator|(
name|n
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|fp
argument_list|)
block|;
name|putc
argument_list|(
name|n
operator|&
literal|0xff
argument_list|,
name|fp
argument_list|)
block|; }
name|void
name|dvi_printer
operator|::
name|out_string
argument_list|(
argument|const char *s
argument_list|)
block|{
name|out1
argument_list|(
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|)
block|;
while|while
condition|(
operator|*
name|s
operator|!=
literal|0
condition|)
name|out1
argument_list|(
operator|*
name|s
operator|++
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_expr_stmt
name|void
name|dvi_printer
operator|::
name|end_of_line
argument_list|()
block|{
if|if
condition|(
name|pushed
condition|)
block|{
name|out1
argument_list|(
name|pop
argument_list|)
expr_stmt|;
name|pushed
operator|=
literal|0
expr_stmt|;
name|cur_h
operator|=
name|pushed_h
expr_stmt|;
name|cur_v
operator|=
name|pushed_v
expr_stmt|;
block|}
end_expr_stmt

begin_expr_stmt
unit|}  void
name|dvi_printer
operator|::
name|possibly_begin_line
argument_list|()
block|{
if|if
condition|(
operator|!
name|pushed
condition|)
block|{
name|have_pushed
operator|=
name|pushed
operator|=
literal|1
expr_stmt|;
name|pushed_h
operator|=
name|cur_h
expr_stmt|;
name|pushed_v
operator|=
name|cur_v
expr_stmt|;
name|out1
argument_list|(
name|push
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_macro
unit|}  int
name|scale
argument_list|(
argument|int x
argument_list|,
argument|int z
argument_list|)
end_macro

begin_block
block|{
name|int
name|sw
decl_stmt|;
name|int
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|;
name|int
name|alpha
decl_stmt|,
name|beta
decl_stmt|;
name|alpha
operator|=
literal|16
operator|*
name|z
expr_stmt|;
name|beta
operator|=
literal|16
expr_stmt|;
while|while
condition|(
name|z
operator|>=
literal|040000000L
condition|)
block|{
name|z
operator|/=
literal|2
expr_stmt|;
name|beta
operator|/=
literal|2
expr_stmt|;
block|}
name|d
operator|=
name|x
operator|&
literal|255
expr_stmt|;
name|c
operator|=
operator|(
name|x
operator|>>
literal|8
operator|)
operator|&
literal|255
expr_stmt|;
name|b
operator|=
operator|(
name|x
operator|>>
literal|16
operator|)
operator|&
literal|255
expr_stmt|;
name|a
operator|=
operator|(
name|x
operator|>>
literal|24
operator|)
operator|&
literal|255
expr_stmt|;
name|sw
operator|=
operator|(
operator|(
operator|(
operator|(
operator|(
name|d
operator|*
name|z
operator|)
operator|/
literal|0400
operator|)
operator|+
operator|(
name|c
operator|*
name|z
operator|)
operator|)
operator|/
literal|0400
operator|)
operator|+
operator|(
name|b
operator|*
name|z
operator|)
operator|)
operator|/
name|beta
expr_stmt|;
if|if
condition|(
name|a
operator|==
literal|255
condition|)
name|sw
operator|-=
name|alpha
expr_stmt|;
else|else
name|assert
argument_list|(
name|a
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
name|sw
return|;
block|}
end_block

begin_expr_stmt
name|void
name|dvi_printer
operator|::
name|set_char
argument_list|(
argument|int index
argument_list|,
argument|font *f
argument_list|,
argument|const environment *env
argument_list|,
argument|int w
argument_list|)
block|{
name|unsigned
name|char
name|code
operator|=
name|f
operator|->
name|get_code
argument_list|(
name|index
argument_list|)
block|;
if|if
condition|(
name|env
operator|->
name|size
operator|!=
name|cur_point_size
operator|||
name|f
operator|!=
name|cur_font
condition|)
block|{
name|cur_font
operator|=
name|f
expr_stmt|;
name|cur_point_size
operator|=
name|env
operator|->
name|size
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|FONTS_MAX
condition|)
block|{
name|fatal
argument_list|(
literal|"too many output fonts required"
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_if
if|if
condition|(
name|output_font_table
index|[
name|i
index|]
operator|.
name|f
operator|==
literal|0
condition|)
block|{
name|output_font_table
index|[
name|i
index|]
operator|.
name|f
operator|=
operator|(
name|dvi_font
operator|*
operator|)
name|cur_font
expr_stmt|;
name|output_font_table
index|[
name|i
index|]
operator|.
name|point_size
operator|=
name|cur_point_size
expr_stmt|;
name|define_font
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|output_font_table
index|[
name|i
index|]
operator|.
name|f
operator|==
name|cur_font
operator|&&
name|output_font_table
index|[
name|i
index|]
operator|.
name|point_size
operator|==
name|cur_point_size
condition|)
break|break;
end_if

begin_expr_stmt
unit|}     set_font
operator|(
name|i
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}   int
name|distance
operator|=
name|env
operator|->
name|hpos
operator|-
name|cur_h
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|env
operator|->
name|hpos
operator|!=
name|end_h
operator|&&
name|distance
operator|!=
literal|0
condition|)
block|{
name|out_signed
argument_list|(
name|right1
argument_list|,
name|distance
argument_list|)
expr_stmt|;
name|cur_h
operator|=
name|env
operator|->
name|hpos
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|distance
operator|>
name|max_drift
condition|)
block|{
name|out_signed
argument_list|(
name|right1
argument_list|,
name|distance
operator|-
name|max_drift
argument_list|)
expr_stmt|;
name|cur_h
operator|=
name|env
operator|->
name|hpos
operator|-
name|max_drift
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|distance
operator|<
operator|-
name|max_drift
condition|)
block|{
name|out_signed
argument_list|(
name|right1
argument_list|,
name|distance
operator|+
name|max_drift
argument_list|)
expr_stmt|;
name|cur_h
operator|=
name|env
operator|->
name|hpos
operator|+
name|max_drift
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|env
operator|->
name|vpos
operator|!=
name|cur_v
condition|)
block|{
name|out_signed
argument_list|(
name|down1
argument_list|,
name|env
operator|->
name|vpos
operator|-
name|cur_v
argument_list|)
expr_stmt|;
name|cur_v
operator|=
name|env
operator|->
name|vpos
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|possibly_begin_line
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|end_h
operator|=
name|env
operator|->
name|hpos
operator|+
name|w
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|cur_h
operator|+=
name|scale
argument_list|(
name|f
operator|->
name|get_width
argument_list|(
name|index
argument_list|,
name|UNITWIDTH
argument_list|)
operator|/
name|MULTIPLIER
argument_list|,
name|cur_point_size
operator|*
name|RES_7227
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|cur_h
operator|>
name|max_h
condition|)
name|max_h
operator|=
name|cur_h
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|cur_v
operator|>
name|max_v
condition|)
name|max_v
operator|=
name|cur_v
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|code
operator|<=
literal|127
condition|)
name|out1
argument_list|(
name|code
argument_list|)
expr_stmt|;
else|else
name|out_unsigned
argument_list|(
name|set1
argument_list|,
name|code
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
unit|}  void
name|dvi_printer
operator|::
name|define_font
argument_list|(
argument|int i
argument_list|)
block|{
name|out_unsigned
argument_list|(
name|fnt_def1
argument_list|,
name|i
argument_list|)
block|;
name|dvi_font
operator|*
name|f
operator|=
name|output_font_table
index|[
name|i
index|]
operator|.
name|f
block|;
name|out4
argument_list|(
name|f
operator|->
name|checksum
argument_list|)
block|;
name|out4
argument_list|(
name|output_font_table
index|[
name|i
index|]
operator|.
name|point_size
operator|*
name|RES_7227
argument_list|)
block|;
name|out4
argument_list|(
name|int
argument_list|(
operator|(
name|double
argument_list|(
name|f
operator|->
name|design_size
argument_list|)
operator|/
operator|(
literal|1
operator|<<
literal|20
operator|)
operator|)
operator|*
name|RES_7227
operator|*
literal|100
operator|+
literal|.5
argument_list|)
argument_list|)
block|;
specifier|const
name|char
operator|*
name|nm
operator|=
name|f
operator|->
name|get_internal_name
argument_list|()
block|;
name|out1
argument_list|(
literal|0
argument_list|)
block|;
name|out_string
argument_list|(
name|nm
argument_list|)
block|; }
name|void
name|dvi_printer
operator|::
name|set_font
argument_list|(
argument|int i
argument_list|)
block|{
if|if
condition|(
name|i
operator|>=
literal|0
operator|&&
name|i
operator|<=
literal|63
condition|)
name|out1
argument_list|(
name|fnt_num_0
operator|+
name|i
argument_list|)
expr_stmt|;
else|else
name|out_unsigned
argument_list|(
name|fnt1
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_expr_stmt
name|void
name|dvi_printer
operator|::
name|out_signed
argument_list|(
argument|unsigned char base
argument_list|,
argument|int param
argument_list|)
block|{
if|if
condition|(
operator|-
literal|128
operator|<=
name|param
operator|&&
name|param
operator|<
literal|128
condition|)
block|{
name|out1
argument_list|(
name|base
argument_list|)
expr_stmt|;
name|out1
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_elseif
elseif|else
if|if
condition|(
operator|-
literal|32768
operator|<=
name|param
operator|&&
name|param
operator|<
literal|32768
condition|)
block|{
name|out1
argument_list|(
name|base
operator|+
literal|1
argument_list|)
expr_stmt|;
name|out2
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_elseif

begin_elseif
elseif|else
if|if
condition|(
operator|-
operator|(
literal|1
operator|<<
literal|23
operator|)
operator|<=
name|param
operator|&&
name|param
operator|<
operator|(
literal|1
operator|<<
literal|23
operator|)
condition|)
block|{
name|out1
argument_list|(
name|base
operator|+
literal|2
argument_list|)
expr_stmt|;
name|out3
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_elseif

begin_else
else|else
block|{
name|out1
argument_list|(
name|base
operator|+
literal|3
argument_list|)
expr_stmt|;
name|out4
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_else

begin_expr_stmt
unit|}  void
name|dvi_printer
operator|::
name|out_unsigned
argument_list|(
argument|unsigned char base
argument_list|,
argument|int param
argument_list|)
block|{
if|if
condition|(
name|param
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|param
operator|<
literal|256
condition|)
block|{
name|out1
argument_list|(
name|base
argument_list|)
expr_stmt|;
name|out1
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_elseif
elseif|else
if|if
condition|(
name|param
operator|<
literal|65536
condition|)
block|{
name|out1
argument_list|(
name|base
operator|+
literal|1
argument_list|)
expr_stmt|;
name|out2
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_elseif

begin_elseif
elseif|else
if|if
condition|(
name|param
operator|<
operator|(
literal|1
operator|<<
literal|24
operator|)
condition|)
block|{
name|out1
argument_list|(
name|base
operator|+
literal|2
argument_list|)
expr_stmt|;
name|out3
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_elseif

begin_else
else|else
block|{
name|out1
argument_list|(
name|base
operator|+
literal|3
argument_list|)
expr_stmt|;
name|out4
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_else

begin_block
unit|}   else
block|{
name|out1
argument_list|(
name|base
operator|+
literal|3
argument_list|)
expr_stmt|;
name|out4
argument_list|(
name|param
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
unit|}  void
name|dvi_printer
operator|::
name|preamble
argument_list|()
block|{
name|out1
argument_list|(
name|pre
argument_list|)
block|;
name|out1
argument_list|(
name|id_byte
argument_list|)
block|;
name|out4
argument_list|(
literal|254000
argument_list|)
block|;
name|out4
argument_list|(
name|font
operator|::
name|res
argument_list|)
block|;
name|out4
argument_list|(
literal|1000
argument_list|)
block|;
name|out1
argument_list|(
literal|0
argument_list|)
block|; }
name|void
name|dvi_printer
operator|::
name|postamble
argument_list|()
block|{
name|int
name|tem
operator|=
name|byte_count
block|;
name|out1
argument_list|(
name|post
argument_list|)
block|;
name|out4
argument_list|(
name|last_bop
argument_list|)
block|;
name|out4
argument_list|(
literal|254000
argument_list|)
block|;
name|out4
argument_list|(
name|font
operator|::
name|res
argument_list|)
block|;
name|out4
argument_list|(
literal|1000
argument_list|)
block|;
name|out4
argument_list|(
name|max_v
argument_list|)
block|;
name|out4
argument_list|(
name|max_h
argument_list|)
block|;
name|out2
argument_list|(
name|have_pushed
argument_list|)
block|;
comment|// stack depth
name|out2
argument_list|(
name|page_count
argument_list|)
block|;
name|int
name|i
block|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FONTS_MAX
operator|&&
name|output_font_table
index|[
name|i
index|]
operator|.
name|f
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
name|define_font
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|out1
argument_list|(
name|post_post
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|out4
argument_list|(
name|tem
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|out1
argument_list|(
name|id_byte
argument_list|)
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
operator|||
name|byte_count
operator|%
literal|4
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
name|out1
argument_list|(
name|filler
argument_list|)
expr_stmt|;
end_for

begin_expr_stmt
unit|}      void
name|dvi_printer
operator|::
name|begin_page
argument_list|(
argument|int i
argument_list|)
block|{
name|page_count
operator|++
block|;
name|int
name|tem
operator|=
name|byte_count
block|;
name|out1
argument_list|(
name|bop
argument_list|)
block|;
name|out4
argument_list|(
name|i
argument_list|)
block|;
for|for
control|(
name|int
name|j
init|=
literal|1
init|;
name|j
operator|<
literal|10
condition|;
name|j
operator|++
control|)
name|out4
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|out4
argument_list|(
name|last_bop
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|last_bop
operator|=
name|tem
expr_stmt|;
end_expr_stmt

begin_comment
comment|// By convention position (0,0) in a dvi file is placed at (1in, 1in).
end_comment

begin_expr_stmt
name|cur_h
operator|=
name|font
operator|::
name|res
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|cur_v
operator|=
name|font
operator|::
name|res
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|end_h
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  void
name|dvi_printer
operator|::
name|end_page
argument_list|()
block|{
if|if
condition|(
name|pushed
condition|)
name|end_of_line
argument_list|()
expr_stmt|;
name|out1
argument_list|(
name|eop
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|cur_font
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  void
name|draw_dvi_printer
operator|::
name|end_page
argument_list|()
block|{
name|dvi_printer
operator|::
name|end_page
argument_list|()
block|;
name|output_pen_size
operator|=
operator|-
literal|1
block|; }
name|void
name|dvi_printer
operator|::
name|do_special
argument_list|(
argument|const char *s
argument_list|)
block|{
name|int
name|len
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
block|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return;
name|possibly_begin_line
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|out_unsigned
argument_list|(
name|xxx1
argument_list|,
name|len
argument_list|)
expr_stmt|;
end_expr_stmt

begin_while
while|while
condition|(
operator|*
name|s
condition|)
name|out1
argument_list|(
operator|*
name|s
operator|++
argument_list|)
expr_stmt|;
end_while

begin_expr_stmt
unit|}  void
name|dvi_printer
operator|::
name|special
argument_list|(
argument|char *arg
argument_list|,
argument|const environment *env
argument_list|)
block|{
name|moveto
argument_list|(
name|env
operator|->
name|hpos
argument_list|,
name|env
operator|->
name|vpos
argument_list|)
block|;
name|do_special
argument_list|(
name|arg
argument_list|)
block|; }
name|void
name|dvi_printer
operator|::
name|moveto
argument_list|(
argument|int h
argument_list|,
argument|int v
argument_list|)
block|{
if|if
condition|(
name|h
operator|!=
name|cur_h
condition|)
block|{
name|out_signed
argument_list|(
name|right1
argument_list|,
name|h
operator|-
name|cur_h
argument_list|)
expr_stmt|;
name|cur_h
operator|=
name|h
expr_stmt|;
if|if
condition|(
name|cur_h
operator|>
name|max_h
condition|)
name|max_h
operator|=
name|cur_h
expr_stmt|;
block|}
end_expr_stmt

begin_if
if|if
condition|(
name|v
operator|!=
name|cur_v
condition|)
block|{
name|out_signed
argument_list|(
name|down1
argument_list|,
name|v
operator|-
name|cur_v
argument_list|)
expr_stmt|;
name|cur_v
operator|=
name|v
expr_stmt|;
if|if
condition|(
name|cur_v
operator|>
name|max_v
condition|)
name|max_v
operator|=
name|cur_v
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|end_h
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  void
name|dvi_printer
operator|::
name|draw
argument_list|(
argument|int code
argument_list|,
argument|int *p
argument_list|,
argument|int np
argument_list|,
argument|const environment *env
argument_list|)
block|{
if|if
condition|(
name|code
operator|==
literal|'l'
condition|)
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|int
name|height
init|=
literal|0
decl_stmt|,
name|width
decl_stmt|;
name|int
name|thickness
decl_stmt|;
if|if
condition|(
name|line_thickness
operator|<
literal|0
condition|)
name|thickness
operator|=
name|env
operator|->
name|size
operator|*
name|RES_7227
operator|*
name|linewidth
operator|/
literal|1000
expr_stmt|;
elseif|else
if|if
condition|(
name|line_thickness
operator|>
literal|0
condition|)
name|thickness
operator|=
name|line_thickness
expr_stmt|;
else|else
name|thickness
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|np
operator|!=
literal|2
condition|)
block|{
name|error
argument_list|(
literal|"2 arguments required for line"
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_elseif
elseif|else
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
comment|// vertical rule
if|if
condition|(
name|p
index|[
literal|1
index|]
operator|>
literal|0
condition|)
block|{
name|x
operator|=
name|env
operator|->
name|hpos
operator|-
name|thickness
operator|/
literal|2
expr_stmt|;
name|y
operator|=
name|env
operator|->
name|vpos
operator|+
name|p
index|[
literal|1
index|]
operator|+
name|thickness
operator|/
literal|2
expr_stmt|;
name|height
operator|=
name|p
index|[
literal|1
index|]
operator|+
name|thickness
expr_stmt|;
name|width
operator|=
name|thickness
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
index|[
literal|1
index|]
operator|<
literal|0
condition|)
block|{
name|x
operator|=
name|env
operator|->
name|hpos
operator|-
name|thickness
operator|/
literal|2
expr_stmt|;
name|y
operator|=
name|env
operator|->
name|vpos
operator|+
name|thickness
operator|/
literal|2
expr_stmt|;
name|height
operator|=
name|thickness
operator|-
name|p
index|[
literal|1
index|]
expr_stmt|;
name|width
operator|=
name|thickness
expr_stmt|;
block|}
block|}
end_elseif

begin_elseif
elseif|else
if|if
condition|(
name|p
index|[
literal|1
index|]
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|>
literal|0
condition|)
block|{
name|x
operator|=
name|env
operator|->
name|hpos
operator|-
name|thickness
operator|/
literal|2
expr_stmt|;
name|y
operator|=
name|env
operator|->
name|vpos
operator|+
name|thickness
operator|/
literal|2
expr_stmt|;
name|height
operator|=
name|thickness
expr_stmt|;
name|width
operator|=
name|p
index|[
literal|0
index|]
operator|+
name|thickness
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|<
literal|0
condition|)
block|{
name|x
operator|=
name|env
operator|->
name|hpos
operator|-
name|p
index|[
literal|0
index|]
operator|-
name|thickness
operator|/
literal|2
expr_stmt|;
name|y
operator|=
name|env
operator|->
name|vpos
operator|+
name|thickness
operator|/
literal|2
expr_stmt|;
name|height
operator|=
name|thickness
expr_stmt|;
name|width
operator|=
name|thickness
operator|-
name|p
index|[
literal|0
index|]
expr_stmt|;
block|}
block|}
end_elseif

begin_if
if|if
condition|(
name|height
operator|!=
literal|0
condition|)
block|{
name|moveto
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|out1
argument_list|(
name|put_rule
argument_list|)
expr_stmt|;
name|out4
argument_list|(
name|height
argument_list|)
expr_stmt|;
name|out4
argument_list|(
name|width
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
unit|}   else
if|if
condition|(
name|code
operator|==
literal|'t'
condition|)
block|{
if|if
condition|(
name|np
operator|==
literal|0
condition|)
block|{
name|line_thickness
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|// troff gratuitously adds an extra 0
if|if
condition|(
name|np
operator|!=
literal|1
operator|&&
name|np
operator|!=
literal|2
condition|)
name|error
argument_list|(
literal|"0 or 1 argument required for thickness"
argument_list|)
expr_stmt|;
else|else
name|line_thickness
operator|=
name|p
index|[
literal|0
index|]
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|code
operator|==
literal|'R'
condition|)
block|{
if|if
condition|(
name|np
operator|!=
literal|2
condition|)
name|error
argument_list|(
literal|"2 arguments required for rule"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|!=
literal|0
operator|||
name|p
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
block|{
name|int
name|dh
init|=
name|p
index|[
literal|0
index|]
decl_stmt|;
name|int
name|dv
init|=
name|p
index|[
literal|1
index|]
decl_stmt|;
name|int
name|oh
init|=
name|env
operator|->
name|hpos
decl_stmt|;
name|int
name|ov
init|=
name|env
operator|->
name|vpos
decl_stmt|;
if|if
condition|(
name|dv
operator|>
literal|0
condition|)
block|{
name|ov
operator|+=
name|dv
expr_stmt|;
name|dv
operator|=
operator|-
name|dv
expr_stmt|;
block|}
if|if
condition|(
name|dh
operator|<
literal|0
condition|)
block|{
name|oh
operator|+=
name|dh
expr_stmt|;
name|dh
operator|=
operator|-
name|dh
expr_stmt|;
block|}
name|moveto
argument_list|(
name|oh
argument_list|,
name|ov
argument_list|)
expr_stmt|;
name|out1
argument_list|(
name|put_rule
argument_list|)
expr_stmt|;
name|out4
argument_list|(
operator|-
name|dv
argument_list|)
expr_stmt|;
name|out4
argument_list|(
name|dh
argument_list|)
expr_stmt|;
block|}
block|}
end_if

begin_comment
unit|}
comment|// XXX Will this overflow?
end_comment

begin_function
unit|inline
name|int
name|milliinches
parameter_list|(
name|int
name|n
parameter_list|)
block|{
return|return
operator|(
name|n
operator|*
literal|1000
operator|+
name|font
operator|::
name|res
operator|/
literal|2
operator|)
operator|/
name|font
operator|::
name|res
return|;
block|}
end_function

begin_expr_stmt
name|void
name|draw_dvi_printer
operator|::
name|set_line_thickness
argument_list|(
argument|const environment *env
argument_list|)
block|{
name|int
name|desired_pen_size
operator|=
name|milliinches
argument_list|(
name|line_thickness
operator|<
literal|0
comment|// Will this overflow?
operator|?
name|env
operator|->
name|size
operator|*
name|RES_7227
operator|*
name|linewidth
operator|/
literal|1000
operator|:
name|line_thickness
argument_list|)
block|;
if|if
condition|(
name|desired_pen_size
operator|!=
name|output_pen_size
condition|)
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"pn %d"
argument_list|,
name|desired_pen_size
argument_list|)
expr_stmt|;
name|do_special
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|output_pen_size
operator|=
name|desired_pen_size
expr_stmt|;
block|}
end_expr_stmt

begin_expr_stmt
unit|}  void
name|draw_dvi_printer
operator|::
name|fill_next
argument_list|()
block|{
name|char
name|buf
index|[
literal|256
index|]
block|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"sh %.3f"
argument_list|,
name|double
argument_list|(
name|fill
argument_list|)
operator|/
name|FILL_MAX
argument_list|)
block|;
name|do_special
argument_list|(
name|buf
argument_list|)
block|; }
name|void
name|draw_dvi_printer
operator|::
name|draw
argument_list|(
argument|int code
argument_list|,
argument|int *p
argument_list|,
argument|int np
argument_list|,
argument|const environment *env
argument_list|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
block|;
name|int
name|fill_flag
operator|=
literal|0
block|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
literal|'C'
case|:
name|fill_flag
operator|=
literal|1
expr_stmt|;
comment|// fall through
case|case
literal|'c'
case|:
comment|// troff adds an extra argument to C
if|if
condition|(
name|np
operator|!=
literal|1
operator|&&
operator|!
operator|(
name|code
operator|==
literal|'C'
operator|&&
name|np
operator|==
literal|2
operator|)
condition|)
block|{
name|error
argument_list|(
literal|"1 argument required for circle"
argument_list|)
expr_stmt|;
break|break;
block|}
name|moveto
argument_list|(
name|env
operator|->
name|hpos
operator|+
name|p
index|[
literal|0
index|]
operator|/
literal|2
argument_list|,
name|env
operator|->
name|vpos
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|fill_flag
condition|)
name|fill_next
argument_list|()
expr_stmt|;
else|else
name|set_line_thickness
argument_list|(
name|env
argument_list|)
expr_stmt|;
end_if

begin_decl_stmt
name|int
name|rad
init|=
name|milliinches
argument_list|(
name|p
index|[
literal|0
index|]
operator|/
literal|2
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s 0 0 %d %d 0 6.28319"
argument_list|,
operator|(
name|fill_flag
condition|?
literal|"ia"
else|:
literal|"ar"
operator|)
argument_list|,
name|rad
argument_list|,
name|rad
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|do_special
argument_list|(
name|buf
argument_list|)
expr_stmt|;
end_expr_stmt

begin_break
break|break;
end_break

begin_case
case|case
literal|'l'
case|:
end_case

begin_if
if|if
condition|(
name|np
operator|!=
literal|2
condition|)
block|{
name|error
argument_list|(
literal|"2 arguments required for line"
argument_list|)
expr_stmt|;
break|break;
block|}
end_if

begin_expr_stmt
name|moveto
argument_list|(
name|env
operator|->
name|hpos
argument_list|,
name|env
operator|->
name|vpos
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|set_line_thickness
argument_list|(
name|env
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|do_special
argument_list|(
literal|"pa 0 0"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"pa %d %d"
argument_list|,
name|milliinches
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|milliinches
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|do_special
argument_list|(
name|buf
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|do_special
argument_list|(
literal|"fp"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_break
break|break;
end_break

begin_case
case|case
literal|'E'
case|:
end_case

begin_expr_stmt
name|fill_flag
operator|=
literal|1
expr_stmt|;
end_expr_stmt

begin_comment
comment|// fall through
end_comment

begin_case
case|case
literal|'e'
case|:
end_case

begin_if
if|if
condition|(
name|np
operator|!=
literal|2
condition|)
block|{
name|error
argument_list|(
literal|"2 arguments required for ellipse"
argument_list|)
expr_stmt|;
break|break;
block|}
end_if

begin_expr_stmt
name|moveto
argument_list|(
name|env
operator|->
name|hpos
operator|+
name|p
index|[
literal|0
index|]
operator|/
literal|2
argument_list|,
name|env
operator|->
name|vpos
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|fill_flag
condition|)
name|fill_next
argument_list|()
expr_stmt|;
end_if

begin_expr_stmt
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s 0 0 %d %d 0 6.28319"
argument_list|,
operator|(
name|fill_flag
condition|?
literal|"ia"
else|:
literal|"ar"
operator|)
argument_list|,
name|milliinches
argument_list|(
name|p
index|[
literal|0
index|]
operator|/
literal|2
argument_list|)
argument_list|,
name|milliinches
argument_list|(
name|p
index|[
literal|1
index|]
operator|/
literal|2
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|do_special
argument_list|(
name|buf
argument_list|)
expr_stmt|;
end_expr_stmt

begin_break
break|break;
end_break

begin_case
case|case
literal|'P'
case|:
end_case

begin_expr_stmt
name|fill_flag
operator|=
literal|1
expr_stmt|;
end_expr_stmt

begin_comment
comment|// fall through
end_comment

begin_case
case|case
literal|'p'
case|:
end_case

begin_block
block|{
if|if
condition|(
name|np
operator|&
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"even number of arguments required for polygon"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|np
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"no arguments for polygon"
argument_list|)
expr_stmt|;
break|break;
block|}
name|moveto
argument_list|(
name|env
operator|->
name|hpos
argument_list|,
name|env
operator|->
name|vpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|fill_flag
condition|)
name|fill_next
argument_list|()
expr_stmt|;
else|else
name|set_line_thickness
argument_list|(
name|env
argument_list|)
expr_stmt|;
name|do_special
argument_list|(
literal|"pa 0 0"
argument_list|)
expr_stmt|;
name|int
name|h
init|=
literal|0
decl_stmt|,
name|v
init|=
literal|0
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|np
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|h
operator|+=
name|p
index|[
name|i
index|]
expr_stmt|;
name|v
operator|+=
name|p
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"pa %d %d"
argument_list|,
name|milliinches
argument_list|(
name|h
argument_list|)
argument_list|,
name|milliinches
argument_list|(
name|v
argument_list|)
argument_list|)
expr_stmt|;
name|do_special
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
name|do_special
argument_list|(
literal|"pa 0 0"
argument_list|)
expr_stmt|;
name|do_special
argument_list|(
name|fill_flag
condition|?
literal|"ip"
else|:
literal|"fp"
argument_list|)
expr_stmt|;
break|break;
block|}
end_block

begin_case
case|case
literal|'~'
case|:
end_case

begin_block
block|{
if|if
condition|(
name|np
operator|&
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"even number of arguments required for spline"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|np
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"no arguments for spline"
argument_list|)
expr_stmt|;
break|break;
block|}
name|moveto
argument_list|(
name|env
operator|->
name|hpos
argument_list|,
name|env
operator|->
name|vpos
argument_list|)
expr_stmt|;
name|set_line_thickness
argument_list|(
name|env
argument_list|)
expr_stmt|;
name|do_special
argument_list|(
literal|"pa 0 0"
argument_list|)
expr_stmt|;
name|int
name|h
init|=
literal|0
decl_stmt|,
name|v
init|=
literal|0
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|np
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|h
operator|+=
name|p
index|[
name|i
index|]
expr_stmt|;
name|v
operator|+=
name|p
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"pa %d %d"
argument_list|,
name|milliinches
argument_list|(
name|h
argument_list|)
argument_list|,
name|milliinches
argument_list|(
name|v
argument_list|)
argument_list|)
expr_stmt|;
name|do_special
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
name|do_special
argument_list|(
literal|"sp"
argument_list|)
expr_stmt|;
break|break;
block|}
end_block

begin_case
case|case
literal|'a'
case|:
end_case

begin_block
block|{
if|if
condition|(
name|np
operator|!=
literal|4
condition|)
block|{
name|error
argument_list|(
literal|"4 arguments required for arc"
argument_list|)
expr_stmt|;
break|break;
block|}
name|set_line_thickness
argument_list|(
name|env
argument_list|)
expr_stmt|;
name|int
name|ch
init|=
name|p
index|[
literal|0
index|]
decl_stmt|;
name|int
name|cv
init|=
name|p
index|[
literal|1
index|]
decl_stmt|;
name|int
name|eh
init|=
name|p
index|[
literal|0
index|]
operator|+
name|p
index|[
literal|2
index|]
decl_stmt|;
name|int
name|ev
init|=
name|p
index|[
literal|1
index|]
operator|+
name|p
index|[
literal|3
index|]
decl_stmt|;
name|double
name|n
init|=
operator|(
name|double
argument_list|(
name|ch
argument_list|)
operator|*
name|eh
operator|)
operator|+
operator|(
name|double
argument_list|(
name|cv
argument_list|)
operator|*
name|ev
operator|)
decl_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|moveto
argument_list|(
name|env
operator|->
name|hpos
argument_list|,
name|env
operator|->
name|vpos
argument_list|)
expr_stmt|;
name|do_special
argument_list|(
literal|"pa 0 0"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"pa %d %d"
argument_list|,
name|milliinches
argument_list|(
name|eh
argument_list|)
argument_list|,
name|milliinches
argument_list|(
name|ev
argument_list|)
argument_list|)
expr_stmt|;
name|do_special
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|do_special
argument_list|(
literal|"fp"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|double
name|k
init|=
operator|(
name|double
argument_list|(
name|eh
argument_list|)
operator|*
name|eh
operator|+
name|double
argument_list|(
name|ev
argument_list|)
operator|*
name|ev
operator|)
operator|/
operator|(
literal|2.0
operator|*
name|n
operator|)
decl_stmt|;
name|double
name|h
init|=
name|k
operator|*
name|ch
decl_stmt|;
name|double
name|v
init|=
name|k
operator|*
name|cv
decl_stmt|;
name|double
name|start_angle
init|=
name|atan2
argument_list|(
operator|-
name|v
argument_list|,
operator|-
name|h
argument_list|)
decl_stmt|;
name|double
name|end_angle
init|=
name|atan2
argument_list|(
name|ev
operator|-
name|v
argument_list|,
name|eh
operator|-
name|h
argument_list|)
decl_stmt|;
name|int
name|rad
init|=
name|milliinches
argument_list|(
name|int
argument_list|(
name|sqrt
argument_list|(
name|h
operator|*
name|h
operator|+
name|v
operator|*
name|v
argument_list|)
operator|+
literal|.5
argument_list|)
argument_list|)
decl_stmt|;
name|moveto
argument_list|(
name|env
operator|->
name|hpos
operator|+
name|int
argument_list|(
name|h
argument_list|)
argument_list|,
name|env
operator|->
name|vpos
operator|+
name|int
argument_list|(
name|v
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"ar 0 0 %d %d %f %f"
argument_list|,
name|rad
argument_list|,
name|rad
argument_list|,
name|end_angle
argument_list|,
name|start_angle
argument_list|)
expr_stmt|;
name|do_special
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
end_block

begin_case
case|case
literal|'t'
case|:
end_case

begin_block
block|{
if|if
condition|(
name|np
operator|==
literal|0
condition|)
block|{
name|line_thickness
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|// troff gratuitously adds an extra 0
if|if
condition|(
name|np
operator|!=
literal|1
operator|&&
name|np
operator|!=
literal|2
condition|)
block|{
name|error
argument_list|(
literal|"0 or 1 argument required for thickness"
argument_list|)
expr_stmt|;
break|break;
block|}
name|line_thickness
operator|=
name|p
index|[
literal|0
index|]
expr_stmt|;
block|}
break|break;
block|}
end_block

begin_case
case|case
literal|'f'
case|:
end_case

begin_block
block|{
if|if
condition|(
name|np
operator|!=
literal|1
operator|&&
name|np
operator|!=
literal|2
condition|)
block|{
name|error
argument_list|(
literal|"1 argument required for fill"
argument_list|)
expr_stmt|;
break|break;
block|}
name|fill
operator|=
name|p
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|fill
operator|<
literal|0
operator|||
name|fill
operator|>
name|FILL_MAX
condition|)
name|fill
operator|=
name|FILL_MAX
expr_stmt|;
break|break;
block|}
end_block

begin_case
case|case
literal|'R'
case|:
end_case

begin_block
block|{
if|if
condition|(
name|np
operator|!=
literal|2
condition|)
block|{
name|error
argument_list|(
literal|"2 arguments required for rule"
argument_list|)
expr_stmt|;
break|break;
block|}
name|int
name|dh
init|=
name|p
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|dh
operator|==
literal|0
condition|)
break|break;
name|int
name|dv
init|=
name|p
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|dv
operator|==
literal|0
condition|)
break|break;
name|int
name|oh
init|=
name|env
operator|->
name|hpos
decl_stmt|;
name|int
name|ov
init|=
name|env
operator|->
name|vpos
decl_stmt|;
if|if
condition|(
name|dv
operator|>
literal|0
condition|)
block|{
name|ov
operator|+=
name|dv
expr_stmt|;
name|dv
operator|=
operator|-
name|dv
expr_stmt|;
block|}
if|if
condition|(
name|dh
operator|<
literal|0
condition|)
block|{
name|oh
operator|+=
name|dh
expr_stmt|;
name|dh
operator|=
operator|-
name|dh
expr_stmt|;
block|}
name|moveto
argument_list|(
name|oh
argument_list|,
name|ov
argument_list|)
expr_stmt|;
name|out1
argument_list|(
name|put_rule
argument_list|)
expr_stmt|;
name|out4
argument_list|(
operator|-
name|dv
argument_list|)
expr_stmt|;
name|out4
argument_list|(
name|dh
argument_list|)
expr_stmt|;
break|break;
block|}
end_block

begin_default
default|default:
end_default

begin_expr_stmt
name|error
argument_list|(
literal|"unrecognised drawing command `%1'"
argument_list|,
name|char
argument_list|(
name|code
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_break
break|break;
end_break

begin_expr_stmt
unit|} }
name|font
operator|*
name|dvi_printer
operator|::
name|make_font
argument_list|(
argument|const char *nm
argument_list|)
block|{
return|return
name|dvi_font
operator|::
name|load_dvi_font
argument_list|(
name|nm
argument_list|)
return|;
block|}
end_expr_stmt

begin_function
name|printer
modifier|*
name|make_printer
parameter_list|()
block|{
if|if
condition|(
name|draw_flag
condition|)
return|return
name|new
name|draw_dvi_printer
return|;
else|else
return|return
name|new
name|dvi_printer
return|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|usage
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|program_name
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
specifier|static
name|char
name|stderr_buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|setbuf
argument_list|(
name|stderr
argument_list|,
name|stderr_buf
argument_list|)
expr_stmt|;
name|int
name|c
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"F:vw:d"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'v'
case|:
block|{
specifier|extern
specifier|const
name|char
modifier|*
name|version_string
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"grodvi version %s\n"
argument_list|,
name|version_string
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|'w'
case|:
if|if
condition|(
name|sscanf
argument_list|(
name|optarg
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|linewidth
argument_list|)
operator|!=
literal|1
operator|||
name|linewidth
operator|<
literal|0
operator|||
name|linewidth
operator|>
literal|1000
condition|)
block|{
name|error
argument_list|(
literal|"bad line width"
argument_list|)
expr_stmt|;
name|linewidth
operator|=
name|DEFAULT_LINEWIDTH
expr_stmt|;
block|}
break|break;
case|case
literal|'d'
case|:
name|draw_flag
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
name|font
operator|::
name|command_line_font_dir
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|usage
argument_list|()
expr_stmt|;
break|break;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|optind
operator|>=
name|argc
condition|)
name|do_file
argument_list|(
literal|"-"
argument_list|)
expr_stmt|;
else|else
block|{
for|for
control|(
name|int
name|i
init|=
name|optind
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
name|do_file
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|delete
name|pr
decl_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [-dv] [-F dir] [-w n] [files ...]\n"
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


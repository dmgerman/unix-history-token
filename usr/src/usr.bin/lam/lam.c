begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 1983 Regents of the University of California */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)lam.c	4.5	(Berkeley)	%G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|not lint
end_endif

begin_comment
comment|/*  *	lam - laminate files  *	Author:  John Kunze, UCB  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_define
define|#
directive|define
name|MAXOFILES
value|20
end_define

begin_define
define|#
directive|define
name|BIGBUFSIZ
value|5 * BUFSIZ
end_define

begin_struct
struct|struct
name|openfile
block|{
comment|/* open file structure */
name|FILE
modifier|*
name|fp
decl_stmt|;
comment|/* file pointer */
name|short
name|eof
decl_stmt|;
comment|/* eof flag */
name|short
name|pad
decl_stmt|;
comment|/* pad flag for missing columns */
name|char
name|eol
decl_stmt|;
comment|/* end of line character */
name|char
modifier|*
name|sepstring
decl_stmt|;
comment|/* string to print before each line */
name|char
modifier|*
name|format
decl_stmt|;
comment|/* printf(3) style string spec. */
block|}
name|input
index|[
name|MAXOFILES
index|]
struct|;
end_struct

begin_decl_stmt
name|int
name|morefiles
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* set by getargs(), changed by gatherline() */
end_comment

begin_decl_stmt
name|int
name|nofinalnl
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* normally append \n to each output line */
end_comment

begin_decl_stmt
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|line
index|[
name|BIGBUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|linep
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|register
name|struct
name|openfile
modifier|*
name|ip
decl_stmt|;
name|char
modifier|*
name|gatherline
parameter_list|()
function_decl|;
name|setbuf
argument_list|(
name|stdout
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|getargs
argument_list|(
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|morefiles
condition|)
name|error
argument_list|(
literal|"lam - laminate files"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|linep
operator|=
name|line
expr_stmt|;
for|for
control|(
name|ip
operator|=
name|input
init|;
name|ip
operator|->
name|fp
operator|!=
name|NULL
condition|;
name|ip
operator|++
control|)
name|linep
operator|=
name|gatherline
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|morefiles
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|line
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|ip
operator|->
name|sepstring
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nofinalnl
condition|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_macro
name|getargs
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|openfile
modifier|*
name|ip
init|=
name|input
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|char
modifier|*
name|c
decl_stmt|;
specifier|static
name|char
name|fmtbuf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
modifier|*
name|fmtp
init|=
name|fmtbuf
decl_stmt|;
name|int
name|P
decl_stmt|,
name|S
decl_stmt|,
name|F
decl_stmt|,
name|T
decl_stmt|;
name|P
operator|=
name|S
operator|=
name|F
operator|=
name|T
operator|=
literal|0
expr_stmt|;
comment|/* capitalized options */
while|while
condition|(
name|p
operator|=
operator|*
operator|++
name|av
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|!=
literal|'-'
operator|||
operator|!
name|p
index|[
literal|1
index|]
condition|)
block|{
name|morefiles
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'-'
condition|)
name|ip
operator|->
name|fp
operator|=
name|stdin
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|ip
operator|->
name|fp
operator|=
name|fopen
argument_list|(
name|p
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ip
operator|->
name|pad
operator|=
name|P
expr_stmt|;
if|if
condition|(
operator|!
name|ip
operator|->
name|sepstring
condition|)
name|ip
operator|->
name|sepstring
operator|=
operator|(
name|S
condition|?
operator|(
name|ip
operator|-
literal|1
operator|)
operator|->
name|sepstring
else|:
literal|""
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|ip
operator|->
name|format
condition|)
name|ip
operator|->
name|format
operator|=
operator|(
operator|(
name|P
operator|||
name|F
operator|)
condition|?
operator|(
name|ip
operator|-
literal|1
operator|)
operator|->
name|format
else|:
literal|"%s"
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|ip
operator|->
name|eol
condition|)
name|ip
operator|->
name|eol
operator|=
operator|(
name|T
condition|?
operator|(
name|ip
operator|-
literal|1
operator|)
operator|->
name|eol
else|:
literal|'\n'
operator|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
continue|continue;
block|}
switch|switch
condition|(
operator|*
operator|(
name|c
operator|=
operator|++
name|p
operator|)
operator||
literal|040
condition|)
block|{
case|case
literal|'s'
case|:
if|if
condition|(
operator|*
operator|++
name|p
operator|||
operator|(
name|p
operator|=
operator|*
operator|++
name|av
operator|)
condition|)
name|ip
operator|->
name|sepstring
operator|=
name|p
expr_stmt|;
else|else
name|error
argument_list|(
literal|"Need string after -%s"
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|S
operator|=
operator|(
operator|*
name|c
operator|==
literal|'S'
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
if|if
condition|(
operator|*
operator|++
name|p
operator|||
operator|(
name|p
operator|=
operator|*
operator|++
name|av
operator|)
condition|)
name|ip
operator|->
name|eol
operator|=
operator|*
name|p
expr_stmt|;
else|else
name|error
argument_list|(
literal|"Need character after -%s"
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|T
operator|=
operator|(
operator|*
name|c
operator|==
literal|'T'
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
name|nofinalnl
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|ip
operator|->
name|pad
operator|=
literal|1
expr_stmt|;
name|P
operator|=
operator|(
operator|*
name|c
operator|==
literal|'P'
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
case|case
literal|'f'
case|:
name|F
operator|=
operator|(
operator|*
name|c
operator|==
literal|'F'
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|p
operator|||
operator|(
name|p
operator|=
operator|*
operator|++
name|av
operator|)
condition|)
block|{
name|fmtp
operator|+=
name|strlen
argument_list|(
name|fmtp
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|fmtp
operator|>
name|fmtbuf
operator|+
name|BUFSIZ
condition|)
name|error
argument_list|(
literal|"No more format space"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|fmtp
argument_list|,
literal|"%%%ss"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ip
operator|->
name|format
operator|=
name|fmtp
expr_stmt|;
block|}
else|else
name|error
argument_list|(
literal|"Need string after -%s"
argument_list|,
name|c
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
argument_list|(
literal|"What do you mean by -%s?"
argument_list|,
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|ip
operator|->
name|fp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|ip
operator|->
name|sepstring
condition|)
name|ip
operator|->
name|sepstring
operator|=
literal|""
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|pad
parameter_list|(
name|ip
parameter_list|)
name|struct
name|openfile
modifier|*
name|ip
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|p
init|=
name|ip
operator|->
name|sepstring
decl_stmt|;
specifier|register
name|char
modifier|*
name|lp
init|=
name|linep
decl_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
operator|*
name|lp
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|pad
condition|)
block|{
name|sprintf
argument_list|(
name|lp
argument_list|,
name|ip
operator|->
name|format
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|lp
operator|+=
name|strlen
argument_list|(
name|lp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|lp
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|gatherline
parameter_list|(
name|ip
parameter_list|)
name|struct
name|openfile
modifier|*
name|ip
decl_stmt|;
block|{
name|char
name|s
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|char
modifier|*
name|lp
init|=
name|linep
decl_stmt|;
name|char
modifier|*
name|end
init|=
name|s
operator|+
name|BUFSIZ
decl_stmt|;
if|if
condition|(
name|ip
operator|->
name|eof
condition|)
return|return
operator|(
name|pad
argument_list|(
name|ip
argument_list|)
operator|)
return|;
for|for
control|(
name|p
operator|=
name|s
init|;
operator|(
name|c
operator|=
name|fgetc
argument_list|(
name|ip
operator|->
name|fp
argument_list|)
operator|)
operator|!=
name|EOF
operator|&&
name|p
operator|<
name|end
condition|;
name|p
operator|++
control|)
if|if
condition|(
operator|(
operator|*
name|p
operator|=
name|c
operator|)
operator|==
name|ip
operator|->
name|eol
condition|)
break|break;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|EOF
condition|)
block|{
name|ip
operator|->
name|eof
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|fp
operator|==
name|stdin
condition|)
name|fclose
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|morefiles
operator|--
expr_stmt|;
return|return
operator|(
name|pad
argument_list|(
name|ip
argument_list|)
operator|)
return|;
block|}
name|p
operator|=
name|ip
operator|->
name|sepstring
expr_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
operator|*
name|lp
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|sprintf
argument_list|(
name|lp
argument_list|,
name|ip
operator|->
name|format
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|lp
operator|+=
name|strlen
argument_list|(
name|lp
argument_list|)
expr_stmt|;
return|return
operator|(
name|lp
operator|)
return|;
block|}
end_function

begin_macro
name|error
argument_list|(
argument|msg
argument_list|,
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|msg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|setbuf
argument_list|(
name|stderr
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"lam: "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|msg
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nUsage:  lam [ -[fp] min.max ] [ -s sepstring ] [ -t c ] file ...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
literal|"lam - "
argument_list|,
name|msg
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Options:\n\t%s\t%s\t%s\t%s\t%s"
argument_list|,
literal|"-f min.max	field widths for file fragments\n"
argument_list|,
literal|"-p min.max	like -f, but pad missing fragments\n"
argument_list|,
literal|"-s sepstring	fragment separator\n"
argument_list|,
literal|"-t c		input line terminator is c, no \\n after output lines\n"
argument_list|,
literal|"Capitalized options affect more than one file.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


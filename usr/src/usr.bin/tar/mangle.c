begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"tar.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__STDC__
end_ifdef

begin_define
define|#
directive|define
name|VOIDSTAR
value|void *
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|VOIDSTAR
value|char *
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|extern
name|VOIDSTAR
name|ck_malloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|VOIDSTAR
name|init_buffer
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|quote_copy_string
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|get_buffer
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|index
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|union
name|record
modifier|*
name|start_header
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|struct
name|stat
name|hstat
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Stat struct corresponding */
end_comment

begin_struct
struct|struct
name|mangled
block|{
name|struct
name|mangled
modifier|*
name|next
decl_stmt|;
name|int
name|type
decl_stmt|;
name|char
name|mangled
index|[
name|NAMSIZ
index|]
decl_stmt|;
name|char
modifier|*
name|linked_to
decl_stmt|;
name|char
name|normal
index|[
literal|1
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Should use a hash table, etc. .  */
end_comment

begin_decl_stmt
name|struct
name|mangled
modifier|*
name|first_mangle
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mangled_num
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|char
modifier|*
name|find_mangled
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|struct
name|mangled
modifier|*
name|munge
decl_stmt|;
for|for
control|(
name|munge
operator|=
name|first_mangle
init|;
name|munge
condition|;
name|munge
operator|=
name|munge
operator|->
name|next
control|)
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
name|munge
operator|->
name|normal
argument_list|)
condition|)
return|return
name|munge
operator|->
name|mangled
return|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|S_IFLNK
end_ifdef

begin_function
name|void
name|add_symlink_mangle
parameter_list|(
name|symlink
parameter_list|,
name|linkto
parameter_list|,
name|buffer
parameter_list|)
name|char
modifier|*
name|symlink
decl_stmt|;
name|char
modifier|*
name|linkto
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
block|{
name|struct
name|mangled
modifier|*
name|munge
decl_stmt|,
modifier|*
name|kludge
decl_stmt|;
name|munge
operator|=
operator|(
expr|struct
name|mangled
operator|*
operator|)
name|ck_malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mangled
argument_list|)
operator|+
name|strlen
argument_list|(
name|symlink
argument_list|)
operator|+
name|strlen
argument_list|(
name|linkto
argument_list|)
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|first_mangle
condition|)
name|first_mangle
operator|=
name|munge
expr_stmt|;
else|else
block|{
for|for
control|(
name|kludge
operator|=
name|first_mangle
init|;
name|kludge
operator|->
name|next
condition|;
name|kludge
operator|=
name|kludge
operator|->
name|next
control|)
empty_stmt|;
name|kludge
operator|->
name|next
operator|=
name|munge
expr_stmt|;
block|}
name|munge
operator|->
name|type
operator|=
literal|1
expr_stmt|;
name|munge
operator|->
name|next
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|munge
operator|->
name|normal
argument_list|,
name|symlink
argument_list|)
expr_stmt|;
name|munge
operator|->
name|linked_to
operator|=
name|munge
operator|->
name|normal
operator|+
name|strlen
argument_list|(
name|symlink
argument_list|)
operator|+
literal|1
expr_stmt|;
name|strcpy
argument_list|(
name|munge
operator|->
name|linked_to
argument_list|,
name|linkto
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|munge
operator|->
name|mangled
argument_list|,
literal|"@@MaNgLeD.%d"
argument_list|,
name|mangled_num
operator|++
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|buffer
argument_list|,
name|munge
operator|->
name|mangled
argument_list|,
name|NAMSIZ
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|add_mangle
parameter_list|(
name|name
parameter_list|,
name|buffer
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
block|{
name|struct
name|mangled
modifier|*
name|munge
decl_stmt|,
modifier|*
name|kludge
decl_stmt|;
name|munge
operator|=
operator|(
expr|struct
name|mangled
operator|*
operator|)
name|ck_malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mangled
argument_list|)
operator|+
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|first_mangle
condition|)
name|first_mangle
operator|=
name|munge
expr_stmt|;
else|else
block|{
for|for
control|(
name|kludge
operator|=
name|first_mangle
init|;
name|kludge
operator|->
name|next
condition|;
name|kludge
operator|=
name|kludge
operator|->
name|next
control|)
empty_stmt|;
name|kludge
operator|->
name|next
operator|=
name|munge
expr_stmt|;
block|}
name|munge
operator|->
name|next
operator|=
literal|0
expr_stmt|;
name|munge
operator|->
name|type
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|munge
operator|->
name|normal
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|munge
operator|->
name|mangled
argument_list|,
literal|"@@MaNgLeD.%d"
argument_list|,
name|mangled_num
operator|++
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|buffer
argument_list|,
name|munge
operator|->
name|mangled
argument_list|,
name|NAMSIZ
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|write_mangled
parameter_list|()
block|{
name|struct
name|mangled
modifier|*
name|munge
decl_stmt|;
name|struct
name|stat
name|hstat
decl_stmt|;
name|union
name|record
modifier|*
name|header
decl_stmt|;
name|char
modifier|*
name|ptr1
decl_stmt|,
modifier|*
name|ptr2
decl_stmt|;
name|VOIDSTAR
name|the_buffer
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|bufsize
decl_stmt|;
if|if
condition|(
operator|!
name|first_mangle
condition|)
return|return;
name|the_buffer
operator|=
name|init_buffer
argument_list|()
expr_stmt|;
for|for
control|(
name|munge
operator|=
name|first_mangle
operator|,
name|size
operator|=
literal|0
init|;
name|munge
condition|;
name|munge
operator|=
name|munge
operator|->
name|next
control|)
block|{
name|ptr1
operator|=
name|quote_copy_string
argument_list|(
name|munge
operator|->
name|normal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptr1
condition|)
name|ptr1
operator|=
name|munge
operator|->
name|normal
expr_stmt|;
if|if
condition|(
name|munge
operator|->
name|type
condition|)
block|{
name|add_buffer
argument_list|(
name|the_buffer
argument_list|,
literal|"Symlink "
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|add_buffer
argument_list|(
name|the_buffer
argument_list|,
name|ptr1
argument_list|,
name|strlen
argument_list|(
name|ptr1
argument_list|)
argument_list|)
expr_stmt|;
name|add_buffer
argument_list|(
name|the_buffer
argument_list|,
literal|" to "
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr2
operator|=
name|quote_copy_string
argument_list|(
name|munge
operator|->
name|linked_to
argument_list|)
condition|)
block|{
name|add_buffer
argument_list|(
name|the_buffer
argument_list|,
name|ptr2
argument_list|,
name|strlen
argument_list|(
name|ptr2
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr2
argument_list|)
expr_stmt|;
block|}
else|else
name|add_buffer
argument_list|(
name|the_buffer
argument_list|,
name|munge
operator|->
name|linked_to
argument_list|,
name|strlen
argument_list|(
name|munge
operator|->
name|linked_to
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|add_buffer
argument_list|(
name|the_buffer
argument_list|,
literal|"Rename "
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|add_buffer
argument_list|(
name|the_buffer
argument_list|,
name|munge
operator|->
name|mangled
argument_list|,
name|strlen
argument_list|(
name|munge
operator|->
name|mangled
argument_list|)
argument_list|)
expr_stmt|;
name|add_buffer
argument_list|(
name|the_buffer
argument_list|,
literal|" to "
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|add_buffer
argument_list|(
name|the_buffer
argument_list|,
name|ptr1
argument_list|,
name|strlen
argument_list|(
name|ptr1
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|add_buffer
argument_list|(
name|the_buffer
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr1
operator|!=
name|munge
operator|->
name|normal
condition|)
name|free
argument_list|(
name|ptr1
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|&
name|hstat
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|stat
argument_list|)
argument_list|)
expr_stmt|;
name|hstat
operator|.
name|st_atime
operator|=
name|hstat
operator|.
name|st_mtime
operator|=
name|hstat
operator|.
name|st_ctime
operator|=
name|time
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ptr1
operator|=
name|get_buffer
argument_list|(
name|the_buffer
argument_list|)
expr_stmt|;
name|hstat
operator|.
name|st_size
operator|=
name|strlen
argument_list|(
name|ptr1
argument_list|)
expr_stmt|;
name|header
operator|=
name|start_header
argument_list|(
literal|"././@MaNgLeD_NaMeS"
argument_list|,
operator|&
name|hstat
argument_list|)
expr_stmt|;
name|header
operator|->
name|header
operator|.
name|linkflag
operator|=
name|LF_NAMES
expr_stmt|;
name|finish_header
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|size
operator|=
name|hstat
operator|.
name|st_size
expr_stmt|;
name|header
operator|=
name|findrec
argument_list|()
expr_stmt|;
name|bufsize
operator|=
name|endofrecs
argument_list|()
operator|->
name|charptr
operator|-
name|header
operator|->
name|charptr
expr_stmt|;
while|while
condition|(
name|bufsize
operator|<
name|size
condition|)
block|{
name|bcopy
argument_list|(
name|ptr1
argument_list|,
name|header
operator|->
name|charptr
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
name|ptr1
operator|+=
name|bufsize
expr_stmt|;
name|size
operator|-=
name|bufsize
expr_stmt|;
name|userec
argument_list|(
name|header
operator|+
operator|(
name|bufsize
operator|-
literal|1
operator|)
operator|/
name|RECORDSIZE
argument_list|)
expr_stmt|;
name|header
operator|=
name|findrec
argument_list|()
expr_stmt|;
name|bufsize
operator|=
name|endofrecs
argument_list|()
operator|->
name|charptr
operator|-
name|header
operator|->
name|charptr
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|ptr1
argument_list|,
name|header
operator|->
name|charptr
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|header
operator|->
name|charptr
operator|+
name|size
argument_list|,
name|bufsize
operator|-
name|size
argument_list|)
expr_stmt|;
name|userec
argument_list|(
name|header
operator|+
operator|(
name|size
operator|-
literal|1
operator|)
operator|/
name|RECORDSIZE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|extract_mangle
parameter_list|(
name|head
parameter_list|)
name|union
name|record
modifier|*
name|head
decl_stmt|;
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|fromtape
decl_stmt|;
name|char
modifier|*
name|to
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|ptrend
decl_stmt|;
name|char
modifier|*
name|nam1
decl_stmt|,
modifier|*
name|nam1end
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|copied
decl_stmt|;
name|size
operator|=
name|hstat
operator|.
name|st_size
expr_stmt|;
name|buf
operator|=
name|to
operator|=
name|ck_malloc
argument_list|(
name|size
operator|+
literal|1
argument_list|)
expr_stmt|;
name|buf
index|[
name|size
index|]
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|fromtape
operator|=
name|findrec
argument_list|()
operator|->
name|charptr
expr_stmt|;
if|if
condition|(
name|fromtape
operator|==
literal|0
condition|)
block|{
name|msg
argument_list|(
literal|"Unexpected EOF in mangled names!"
argument_list|)
expr_stmt|;
return|return;
block|}
name|copied
operator|=
name|endofrecs
argument_list|()
operator|->
name|charptr
operator|-
name|fromtape
expr_stmt|;
if|if
condition|(
name|copied
operator|>
name|size
condition|)
name|copied
operator|=
name|size
expr_stmt|;
name|bcopy
argument_list|(
name|fromtape
argument_list|,
name|to
argument_list|,
name|copied
argument_list|)
expr_stmt|;
name|to
operator|+=
name|copied
expr_stmt|;
name|size
operator|-=
name|copied
expr_stmt|;
name|userec
argument_list|(
operator|(
expr|union
name|record
operator|*
operator|)
operator|(
name|fromtape
operator|+
name|copied
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|ptr
operator|=
name|buf
init|;
operator|*
name|ptr
condition|;
name|ptr
operator|=
name|ptrend
control|)
block|{
name|ptrend
operator|=
name|index
argument_list|(
name|ptr
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
operator|*
name|ptrend
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"Rename "
argument_list|,
literal|7
argument_list|)
condition|)
block|{
name|nam1
operator|=
name|ptr
operator|+
literal|7
expr_stmt|;
name|nam1end
operator|=
name|index
argument_list|(
name|nam1
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
while|while
condition|(
name|strncmp
argument_list|(
name|nam1end
argument_list|,
literal|" to "
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|nam1end
operator|++
expr_stmt|;
name|nam1end
operator|=
name|index
argument_list|(
name|nam1end
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
block|}
operator|*
name|nam1end
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|ptrend
index|[
operator|-
literal|2
index|]
operator|==
literal|'/'
condition|)
name|ptrend
index|[
operator|-
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
name|un_quote_string
argument_list|(
name|nam1end
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
name|nam1
argument_list|,
name|nam1end
operator|+
literal|4
argument_list|)
condition|)
name|msg_perror
argument_list|(
literal|"Can't rename %s to %s"
argument_list|,
name|nam1
argument_list|,
name|nam1end
operator|+
literal|4
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|f_verbose
condition|)
name|msg
argument_list|(
literal|"Renamed %s to %s"
argument_list|,
name|nam1
argument_list|,
name|nam1end
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|S_IFLNK
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ptr
argument_list|,
literal|"Symlink "
argument_list|,
literal|8
argument_list|)
condition|)
block|{
name|nam1
operator|=
name|ptr
operator|+
literal|8
expr_stmt|;
name|nam1end
operator|=
name|index
argument_list|(
name|nam1
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
while|while
condition|(
name|strncmp
argument_list|(
name|nam1end
argument_list|,
literal|" to "
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|nam1end
operator|++
expr_stmt|;
name|nam1end
operator|=
name|index
argument_list|(
name|nam1end
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
block|}
name|un_quote_string
argument_list|(
name|nam1
argument_list|)
expr_stmt|;
name|un_quote_string
argument_list|(
name|nam1end
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|symlink
argument_list|(
name|nam1
argument_list|,
name|nam1end
operator|+
literal|4
argument_list|)
operator|&&
operator|(
name|unlink
argument_list|(
name|nam1end
operator|+
literal|4
argument_list|)
operator|||
name|symlink
argument_list|(
name|nam1
argument_list|,
name|nam1end
operator|+
literal|4
argument_list|)
operator|)
condition|)
name|msg_perror
argument_list|(
literal|"Can't symlink %s to %s"
argument_list|,
name|nam1
argument_list|,
name|nam1end
operator|+
literal|4
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|f_verbose
condition|)
name|msg
argument_list|(
literal|"Symlinkd %s to %s"
argument_list|,
name|nam1
argument_list|,
name|nam1end
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
name|msg
argument_list|(
literal|"Unknown demangling command %s"
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


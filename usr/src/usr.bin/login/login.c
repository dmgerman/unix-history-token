begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1980, 1987, 1988 The Regents of the University of California.  * All rights reserved.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the University of California, Berkeley.  The name of the  * University may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1980, 1987, 1988 The Regents of the University of California.\n\  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)login.c	5.44 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*  * login [ name ]  * login -r hostname	(for rlogind)  * login -h hostname	(for telnetd, etc.)  * login -f name	(for pre-authenticated login: datakit, xterm, etc.)  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<ufs/quota.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ttyent.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<tzfile.h>
end_include

begin_include
include|#
directive|include
file|"pathnames.h"
end_include

begin_define
define|#
directive|define
name|TTYGRPNAME
value|"tty"
end_define

begin_comment
comment|/* name of group to own ttys */
end_comment

begin_comment
comment|/*  * This bounds the time given to login.  Not a define so it can  * be patched on machines where it's too small.  */
end_comment

begin_decl_stmt
name|int
name|timeout
init|=
literal|300
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|failures
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|term
index|[
literal|64
index|]
decl_stmt|,
modifier|*
name|hostname
decl_stmt|,
modifier|*
name|username
decl_stmt|,
modifier|*
name|tty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sgttyb
name|sgttyb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|tchars
name|tc
init|=
block|{
name|CINTR
block|,
name|CQUIT
block|,
name|CSTART
block|,
name|CSTOP
block|,
name|CEOT
block|,
name|CBRK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ltchars
name|ltc
init|=
block|{
name|CSUSP
block|,
name|CDSUSP
block|,
name|CRPRNT
block|,
name|CFLUSH
block|,
name|CWERASE
block|,
name|CLNEXT
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|months
index|[]
init|=
block|{
literal|"Jan"
block|,
literal|"Feb"
block|,
literal|"Mar"
block|,
literal|"Apr"
block|,
literal|"May"
block|,
literal|"Jun"
block|,
literal|"Jul"
block|,
literal|"Aug"
block|,
literal|"Sep"
block|,
literal|"Oct"
block|,
literal|"Nov"
block|,
literal|"Dec"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|months
index|[]
init|=
block|{
literal|"Jan"
block|,
literal|"Feb"
block|,
literal|"Mar"
block|,
literal|"Apr"
block|,
literal|"May"
block|,
literal|"Jun"
block|,
literal|"Jul"
block|,
literal|"Aug"
block|,
literal|"Sep"
block|,
literal|"Oct"
block|,
literal|"Nov"
block|,
literal|"Dec"
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|extern
name|int
name|errno
decl_stmt|,
name|optind
decl_stmt|;
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|,
modifier|*
modifier|*
name|environ
decl_stmt|;
name|struct
name|timeval
name|tp
decl_stmt|;
name|struct
name|tm
modifier|*
name|ttp
decl_stmt|;
name|struct
name|timeval
name|tp
decl_stmt|;
name|struct
name|tm
modifier|*
name|ttp
decl_stmt|;
name|struct
name|group
modifier|*
name|gr
decl_stmt|;
specifier|register
name|int
name|ch
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|ask
decl_stmt|,
name|fflag
decl_stmt|,
name|hflag
decl_stmt|,
name|pflag
decl_stmt|,
name|rflag
decl_stmt|,
name|cnt
decl_stmt|;
name|int
name|quietlog
decl_stmt|,
name|passwd_req
decl_stmt|,
name|ioctlval
decl_stmt|,
name|timedout
argument_list|()
decl_stmt|;
name|char
modifier|*
name|domain
decl_stmt|,
modifier|*
name|salt
decl_stmt|,
modifier|*
name|envinit
index|[
literal|1
index|]
decl_stmt|,
modifier|*
name|ttyn
decl_stmt|,
modifier|*
name|pp
decl_stmt|;
name|char
name|tbuf
index|[
name|MAXPATHLEN
operator|+
literal|2
index|]
decl_stmt|,
name|tname
index|[
sizeof|sizeof
argument_list|(
name|_PATH_TTY
argument_list|)
operator|+
literal|10
index|]
decl_stmt|;
name|char
name|localhost
index|[
name|MAXHOSTNAMELEN
index|]
decl_stmt|;
name|char
modifier|*
name|ctime
argument_list|()
decl_stmt|,
modifier|*
name|ttyname
argument_list|()
decl_stmt|,
modifier|*
name|stypeof
argument_list|()
decl_stmt|,
modifier|*
name|crypt
argument_list|()
decl_stmt|,
modifier|*
name|getpass
argument_list|()
decl_stmt|;
name|time_t
name|time
parameter_list|()
function_decl|;
name|off_t
name|lseek
parameter_list|()
function_decl|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|timedout
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|alarm
argument_list|(
operator|(
name|u_int
operator|)
name|timeout
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setpriority
argument_list|(
name|PRIO_PROCESS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|quota
argument_list|(
name|Q_SETUID
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * -p is used by getty to tell login not to destroy the environment 	 * -r is used by rlogind to cause the autologin protocol;  	 * -f is used to skip a second login authentication  	 * -h is used by other servers to pass the name of the remote 	 *    host to login so that it may be placed in utmp and wtmp 	 */
name|domain
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|gethostname
argument_list|(
name|localhost
argument_list|,
sizeof|sizeof
argument_list|(
name|localhost
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"couldn't get local hostname: %m"
argument_list|)
expr_stmt|;
else|else
name|domain
operator|=
name|index
argument_list|(
name|localhost
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
name|fflag
operator|=
name|hflag
operator|=
name|pflag
operator|=
name|rflag
operator|=
literal|0
expr_stmt|;
name|passwd_req
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"fh:pr:"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'f'
case|:
if|if
condition|(
name|rflag
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"login: only one of -r and -f allowed.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
if|if
condition|(
name|getuid
argument_list|()
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"login: -h for super-user only.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rflag
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"login: only one of -r and -h allowed.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|hflag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|domain
operator|&&
operator|(
name|p
operator|=
name|index
argument_list|(
name|optarg
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|&&
name|strcasecmp
argument_list|(
name|p
argument_list|,
name|domain
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|p
operator|=
literal|0
expr_stmt|;
name|hostname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|pflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
if|if
condition|(
name|hflag
operator|||
name|fflag
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"login: -f and -h not allowed with -r.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|getuid
argument_list|()
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"login: -r for super-user only.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* "-r hostname" must be last args */
if|if
condition|(
name|optind
operator|!=
name|argc
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Syntax error.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|rflag
operator|=
literal|1
expr_stmt|;
name|passwd_req
operator|=
operator|(
name|doremotelogin
argument_list|(
name|optarg
argument_list|)
operator|==
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|domain
operator|&&
operator|(
name|p
operator|=
name|index
argument_list|(
name|optarg
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|&&
operator|!
name|strcmp
argument_list|(
name|p
argument_list|,
name|domain
argument_list|)
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|hostname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"invalid flag"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: login [-fp] [username]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
operator|*
name|argv
condition|)
block|{
name|username
operator|=
operator|*
name|argv
expr_stmt|;
name|ask
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|ask
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|rflag
condition|)
name|ask
operator|=
literal|0
expr_stmt|;
name|ioctlval
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCLSET
argument_list|,
operator|&
name|ioctlval
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCNXCL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fcntl
argument_list|(
literal|0
argument_list|,
name|F_SETFL
argument_list|,
name|ioctlval
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCGETP
argument_list|,
operator|&
name|sgttyb
argument_list|)
expr_stmt|;
comment|/* 	 * If talking to an rlogin process, propagate the terminal type and 	 * baud rate across the network. 	 */
if|if
condition|(
name|rflag
condition|)
name|doremoteterm
argument_list|(
operator|&
name|sgttyb
argument_list|)
expr_stmt|;
name|sgttyb
operator|.
name|sg_erase
operator|=
name|CERASE
expr_stmt|;
name|sgttyb
operator|.
name|sg_kill
operator|=
name|CKILL
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSLTC
argument_list|,
operator|&
name|ltc
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETC
argument_list|,
operator|&
name|tc
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETP
argument_list|,
operator|&
name|sgttyb
argument_list|)
expr_stmt|;
for|for
control|(
name|cnt
operator|=
name|getdtablesize
argument_list|()
init|;
name|cnt
operator|>
literal|2
condition|;
name|cnt
operator|--
control|)
name|close
argument_list|(
name|cnt
argument_list|)
expr_stmt|;
name|ttyn
operator|=
name|ttyname
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttyn
operator|==
name|NULL
operator|||
operator|*
name|ttyn
operator|==
literal|'\0'
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tname
argument_list|,
literal|"%s??"
argument_list|,
name|_PATH_TTY
argument_list|)
expr_stmt|;
name|ttyn
operator|=
name|tname
expr_stmt|;
block|}
if|if
condition|(
name|tty
operator|=
name|rindex
argument_list|(
name|ttyn
argument_list|,
literal|'/'
argument_list|)
condition|)
operator|++
name|tty
expr_stmt|;
else|else
name|tty
operator|=
name|ttyn
expr_stmt|;
name|openlog
argument_list|(
literal|"login"
argument_list|,
name|LOG_ODELAY
argument_list|,
name|LOG_AUTH
argument_list|)
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
condition|;
name|ask
operator|=
literal|1
control|)
block|{
name|ioctlval
operator|=
name|TTYDISC
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETD
argument_list|,
operator|&
name|ioctlval
argument_list|)
expr_stmt|;
if|if
condition|(
name|ask
condition|)
block|{
name|fflag
operator|=
literal|0
expr_stmt|;
name|getloginname
argument_list|()
expr_stmt|;
block|}
comment|/* 		 * Note if trying multiple user names; 		 * log failures for previous user name, 		 * but don't bother logging one failure 		 * for nonexistent name (mistyped username). 		 */
if|if
condition|(
name|failures
operator|&&
name|strcmp
argument_list|(
name|tbuf
argument_list|,
name|username
argument_list|)
condition|)
block|{
if|if
condition|(
name|failures
operator|>
operator|(
name|pwd
condition|?
literal|0
else|:
literal|1
operator|)
condition|)
name|badlogin
argument_list|(
name|tbuf
argument_list|)
expr_stmt|;
name|failures
operator|=
literal|0
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|username
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|=
name|getpwnam
argument_list|(
name|username
argument_list|)
condition|)
name|salt
operator|=
name|pwd
operator|->
name|pw_passwd
expr_stmt|;
else|else
name|salt
operator|=
literal|"xx"
expr_stmt|;
comment|/* if user not super-user, check for disabled logins */
if|if
condition|(
name|pwd
operator|==
name|NULL
operator|||
name|pwd
operator|->
name|pw_uid
condition|)
name|checknologin
argument_list|()
expr_stmt|;
comment|/* 		 * Disallow automatic login to root; if not invoked by 		 * root, disallow if the uid's differ. 		 */
if|if
condition|(
name|fflag
operator|&&
name|pwd
condition|)
block|{
name|int
name|uid
init|=
name|getuid
argument_list|()
decl_stmt|;
name|passwd_req
operator|=
ifndef|#
directive|ifndef
name|KERBEROS
name|pwd
operator|->
name|pw_uid
operator|==
literal|0
operator|||
endif|#
directive|endif
operator|(
name|uid
operator|&&
name|uid
operator|!=
name|pwd
operator|->
name|pw_uid
operator|)
expr_stmt|;
block|}
comment|/* 		 * If no pre-authentication and a password exists 		 * for this user, prompt for one and verify it. 		 */
if|if
condition|(
operator|!
name|passwd_req
operator|||
operator|(
name|pwd
operator|&&
operator|!
operator|*
name|pwd
operator|->
name|pw_passwd
operator|)
condition|)
break|break;
name|setpriority
argument_list|(
name|PRIO_PROCESS
argument_list|,
literal|0
argument_list|,
operator|-
literal|4
argument_list|)
expr_stmt|;
name|pp
operator|=
name|getpass
argument_list|(
literal|"Password:"
argument_list|)
expr_stmt|;
name|p
operator|=
name|crypt
argument_list|(
name|pp
argument_list|,
name|salt
argument_list|)
expr_stmt|;
name|setpriority
argument_list|(
name|PRIO_PROCESS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|bzero
argument_list|(
name|pp
argument_list|,
name|strlen
argument_list|(
name|pp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|&&
operator|!
name|strcmp
argument_list|(
name|p
argument_list|,
name|pwd
operator|->
name|pw_passwd
argument_list|)
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Login incorrect\n"
argument_list|)
expr_stmt|;
name|failures
operator|++
expr_stmt|;
comment|/* we allow 10 tries, but after 3 we start backing off */
if|if
condition|(
operator|++
name|cnt
operator|>
literal|3
condition|)
block|{
if|if
condition|(
name|cnt
operator|>=
literal|10
condition|)
block|{
name|badlogin
argument_list|(
name|username
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCHPCL
argument_list|,
operator|(
expr|struct
name|sgttyb
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|sleepexit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sleep
argument_list|(
call|(
name|u_int
call|)
argument_list|(
operator|(
name|cnt
operator|-
literal|3
operator|)
operator|*
literal|5
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* committed to login -- turn off timeout */
operator|(
name|void
operator|)
name|alarm
argument_list|(
operator|(
name|u_int
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|/* paranoia... */
name|endpwent
argument_list|()
expr_stmt|;
comment|/* 	 * If valid so far and root is logging in, see if root logins on 	 * this terminal are permitted. 	 */
if|if
condition|(
name|pwd
operator|->
name|pw_uid
operator|==
literal|0
operator|&&
operator|!
name|rootterm
argument_list|(
name|tty
argument_list|)
condition|)
block|{
if|if
condition|(
name|hostname
condition|)
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"ROOT LOGIN REFUSED FROM %s"
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
else|else
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"ROOT LOGIN REFUSED ON %s"
argument_list|,
name|tty
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Login incorrect\n"
argument_list|)
expr_stmt|;
name|sleepexit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|quota
argument_list|(
name|Q_SETUID
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|EINVAL
condition|)
block|{
switch|switch
condition|(
name|errno
condition|)
block|{
case|case
name|EUSERS
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too many users logged on already.\nTry again later.\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|EPROCLIM
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"You have too many processes running.\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|perror
argument_list|(
literal|"quota (Q_SETUID)"
argument_list|)
expr_stmt|;
block|}
name|sleepexit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|chdir
argument_list|(
name|pwd
operator|->
name|pw_dir
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"No directory %s!\n"
argument_list|,
name|pwd
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
literal|"/"
argument_list|)
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|pwd
operator|->
name|pw_dir
operator|=
literal|"/"
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Logging in with home = \"/\".\n"
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|BSD
operator|>
literal|43
define|#
directive|define
name|TWOWEEKS
value|(14*24*60*60)
if|if
condition|(
name|pwd
operator|->
name|pw_change
operator|||
name|pwd
operator|->
name|pw_expire
condition|)
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|tp
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|->
name|pw_change
condition|)
if|if
condition|(
name|tp
operator|.
name|tv_sec
operator|>=
name|pwd
operator|->
name|pw_change
condition|)
block|{
name|printf
argument_list|(
literal|"Sorry -- your password has expired.\n"
argument_list|)
expr_stmt|;
name|sleepexit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tp
operator|.
name|tv_sec
operator|-
name|pwd
operator|->
name|pw_change
operator|<
name|TWOWEEKS
condition|)
block|{
name|ttp
operator|=
name|localtime
argument_list|(
operator|&
name|pwd
operator|->
name|pw_change
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Warning: your password expires on %s %d, 19%d\n"
argument_list|,
name|months
index|[
name|ttp
operator|->
name|tm_mon
index|]
argument_list|,
name|ttp
operator|->
name|tm_mday
argument_list|,
name|ttp
operator|->
name|tm_year
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pwd
operator|->
name|pw_expire
condition|)
if|if
condition|(
name|tp
operator|.
name|tv_sec
operator|>=
name|pwd
operator|->
name|pw_expire
condition|)
block|{
name|printf
argument_list|(
literal|"Sorry -- your account has expired.\n"
argument_list|)
expr_stmt|;
name|sleepexit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tp
operator|.
name|tv_sec
operator|-
name|pwd
operator|->
name|pw_expire
operator|<
name|TWOWEEKS
condition|)
block|{
name|ttp
operator|=
name|localtime
argument_list|(
operator|&
name|pwd
operator|->
name|pw_expire
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Warning: your account expires on %s %d, 19%d\n"
argument_list|,
name|months
index|[
name|ttp
operator|->
name|tm_mon
index|]
argument_list|,
name|ttp
operator|->
name|tm_mday
argument_list|,
name|ttp
operator|->
name|tm_year
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pwd
operator|->
name|pw_change
operator|||
name|pwd
operator|->
name|pw_expire
condition|)
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|tp
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|->
name|pw_change
condition|)
if|if
condition|(
name|tp
operator|.
name|tv_sec
operator|>=
name|pwd
operator|->
name|pw_change
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Sorry -- your password has expired.\n"
argument_list|)
expr_stmt|;
name|sleepexit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pwd
operator|->
name|pw_change
operator|-
name|tp
operator|.
name|tv_sec
operator|<
literal|2
operator|*
name|DAYSPERWEEK
operator|*
name|SECSPERDAY
operator|&&
operator|!
name|quietlog
condition|)
block|{
name|ttp
operator|=
name|localtime
argument_list|(
operator|&
name|pwd
operator|->
name|pw_change
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Warning: your password expires on %s %d, %d\n"
argument_list|,
name|months
index|[
name|ttp
operator|->
name|tm_mon
index|]
argument_list|,
name|ttp
operator|->
name|tm_mday
argument_list|,
name|TM_YEAR_BASE
operator|+
name|ttp
operator|->
name|tm_year
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pwd
operator|->
name|pw_expire
condition|)
if|if
condition|(
name|tp
operator|.
name|tv_sec
operator|>=
name|pwd
operator|->
name|pw_expire
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Sorry -- your account has expired.\n"
argument_list|)
expr_stmt|;
name|sleepexit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pwd
operator|->
name|pw_expire
operator|-
name|tp
operator|.
name|tv_sec
operator|<
literal|2
operator|*
name|DAYSPERWEEK
operator|*
name|SECSPERDAY
operator|&&
operator|!
name|quietlog
condition|)
block|{
name|ttp
operator|=
name|localtime
argument_list|(
operator|&
name|pwd
operator|->
name|pw_expire
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Warning: your account expires on %s %d, %d\n"
argument_list|,
name|months
index|[
name|ttp
operator|->
name|tm_mon
index|]
argument_list|,
name|ttp
operator|->
name|tm_mday
argument_list|,
name|TM_YEAR_BASE
operator|+
name|ttp
operator|->
name|tm_year
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* nothing else left to fail -- really log in */
block|{
name|struct
name|utmp
name|utmp
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|utmp
argument_list|,
sizeof|sizeof
argument_list|(
name|utmp
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|utmp
operator|.
name|ut_time
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|utmp
operator|.
name|ut_name
argument_list|,
name|username
argument_list|,
sizeof|sizeof
argument_list|(
name|utmp
operator|.
name|ut_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostname
condition|)
name|strncpy
argument_list|(
name|utmp
operator|.
name|ut_host
argument_list|,
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|utmp
operator|.
name|ut_host
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|utmp
operator|.
name|ut_line
argument_list|,
name|tty
argument_list|,
sizeof|sizeof
argument_list|(
name|utmp
operator|.
name|ut_line
argument_list|)
argument_list|)
expr_stmt|;
name|login
argument_list|(
operator|&
name|utmp
argument_list|)
expr_stmt|;
block|}
name|dolastlog
argument_list|(
name|quietlog
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hflag
operator|&&
operator|!
name|rflag
condition|)
block|{
comment|/* XXX */
specifier|static
name|struct
name|winsize
name|win
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSWINSZ
argument_list|,
operator|&
name|win
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|chown
argument_list|(
name|ttyn
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|,
operator|(
name|gr
operator|=
name|getgrnam
argument_list|(
name|TTYGRPNAME
argument_list|)
operator|)
condition|?
name|gr
operator|->
name|gr_gid
else|:
name|pwd
operator|->
name|pw_gid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|chmod
argument_list|(
name|ttyn
argument_list|,
literal|0620
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setgid
argument_list|(
name|pwd
operator|->
name|pw_gid
argument_list|)
expr_stmt|;
name|initgroups
argument_list|(
name|username
argument_list|,
name|pwd
operator|->
name|pw_gid
argument_list|)
expr_stmt|;
name|quota
argument_list|(
name|Q_DOWARN
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|,
operator|(
name|dev_t
operator|)
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pwd
operator|->
name|pw_shell
operator|==
literal|'\0'
condition|)
name|pwd
operator|->
name|pw_shell
operator|=
name|_PATH_BSHELL
expr_stmt|;
comment|/* destroy environment unless user has requested preservation */
if|if
condition|(
operator|!
name|pflag
condition|)
name|environ
operator|=
name|envinit
expr_stmt|;
operator|(
name|void
operator|)
name|setenv
argument_list|(
literal|"HOME"
argument_list|,
name|pwd
operator|->
name|pw_dir
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setenv
argument_list|(
literal|"SHELL"
argument_list|,
name|pwd
operator|->
name|pw_shell
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|term
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|strncpy
argument_list|(
name|term
argument_list|,
name|stypeof
argument_list|(
name|tty
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|term
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setenv
argument_list|(
literal|"TERM"
argument_list|,
name|term
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setenv
argument_list|(
literal|"USER"
argument_list|,
name|pwd
operator|->
name|pw_name
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setenv
argument_list|(
literal|"PATH"
argument_list|,
name|_PATH_DEFPATH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tty
index|[
sizeof|sizeof
argument_list|(
literal|"tty"
argument_list|)
operator|-
literal|1
index|]
operator|==
literal|'d'
condition|)
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"DIALUP %s, %s"
argument_list|,
name|tty
argument_list|,
name|pwd
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|->
name|pw_uid
operator|==
literal|0
condition|)
if|if
condition|(
name|hostname
condition|)
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"ROOT LOGIN ON %s FROM %s"
argument_list|,
name|tty
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
else|else
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"ROOT LOGIN ON %s"
argument_list|,
name|tty
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|quietlog
condition|)
block|{
name|struct
name|stat
name|st
decl_stmt|;
name|motd
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%s/%s"
argument_list|,
name|_PATH_MAILDIR
argument_list|,
name|pwd
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|tbuf
argument_list|,
operator|&
name|st
argument_list|)
operator|==
literal|0
operator|&&
name|st
operator|.
name|st_size
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"You have %smail.\n"
argument_list|,
operator|(
name|st
operator|.
name|st_mtime
operator|>
name|st
operator|.
name|st_atime
operator|)
condition|?
literal|"new "
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGTSTP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|tbuf
index|[
literal|0
index|]
operator|=
literal|'-'
expr_stmt|;
name|strcpy
argument_list|(
name|tbuf
operator|+
literal|1
argument_list|,
operator|(
name|p
operator|=
name|rindex
argument_list|(
name|pwd
operator|->
name|pw_shell
argument_list|,
literal|'/'
argument_list|)
operator|)
condition|?
name|p
operator|+
literal|1
else|:
name|pwd
operator|->
name|pw_shell
argument_list|)
expr_stmt|;
if|#
directive|if
name|BSD
operator|>
literal|43
if|if
condition|(
name|setlogname
argument_list|(
name|pwd
operator|->
name|pw_name
argument_list|,
name|strlen
argument_list|(
name|pwd
operator|->
name|pw_name
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"setlogname() failure: %m"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* discard permissions last so can't get killed and drop core */
operator|(
name|void
operator|)
name|setuid
argument_list|(
name|pwd
operator|->
name|pw_uid
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
name|pwd
operator|->
name|pw_shell
argument_list|,
name|tbuf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"login: no shell: %s.\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|getloginname
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|ch
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|static
name|char
name|nbuf
index|[
name|UT_NAMESIZE
operator|+
literal|1
index|]
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"login: "
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|nbuf
init|;
operator|(
name|ch
operator|=
name|getchar
argument_list|()
operator|)
operator|!=
literal|'\n'
condition|;
control|)
block|{
if|if
condition|(
name|ch
operator|==
name|EOF
condition|)
block|{
name|badlogin
argument_list|(
name|username
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|<
name|nbuf
operator|+
name|UT_NAMESIZE
condition|)
operator|*
name|p
operator|++
operator|=
name|ch
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|>
name|nbuf
condition|)
if|if
condition|(
name|nbuf
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"login names may not start with '-'.\n"
argument_list|)
expr_stmt|;
else|else
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|username
operator|=
name|nbuf
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_macro
name|timedout
argument_list|()
end_macro

begin_block
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Login timed out after %d seconds\n"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rootterm
argument_list|(
argument|ttyn
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|ttyn
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|ttyent
modifier|*
name|t
decl_stmt|;
return|return
operator|(
operator|(
name|t
operator|=
name|getttynam
argument_list|(
name|ttyn
argument_list|)
operator|)
operator|&&
name|t
operator|->
name|ty_status
operator|&
name|TTY_SECURE
operator|)
return|;
block|}
end_block

begin_decl_stmt
name|jmp_buf
name|motdinterrupt
decl_stmt|;
end_decl_stmt

begin_macro
name|motd
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|fd
decl_stmt|,
name|nchars
decl_stmt|;
name|sig_t
name|oldint
decl_stmt|;
name|int
name|sigint
parameter_list|()
function_decl|;
name|char
name|tbuf
index|[
literal|8192
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|_PATH_MOTDFILE
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return;
name|oldint
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|sigint
argument_list|)
expr_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|motdinterrupt
argument_list|)
operator|==
literal|0
condition|)
while|while
condition|(
operator|(
name|nchars
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|tbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tbuf
argument_list|)
argument_list|)
operator|)
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|write
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|,
name|tbuf
argument_list|,
name|nchars
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldint
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|sigint
argument_list|()
end_macro

begin_block
block|{
name|longjmp
argument_list|(
name|motdinterrupt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|checknologin
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|fd
decl_stmt|,
name|nchars
decl_stmt|;
name|char
name|tbuf
index|[
literal|8192
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|_PATH_NOLOGIN
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
while|while
condition|(
operator|(
name|nchars
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|tbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tbuf
argument_list|)
argument_list|)
operator|)
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|write
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|,
name|tbuf
argument_list|,
name|nchars
argument_list|)
expr_stmt|;
name|sleepexit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|dolastlog
argument_list|(
argument|quiet
argument_list|)
end_macro

begin_decl_stmt
name|int
name|quiet
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|lastlog
name|ll
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|char
modifier|*
name|ctime
parameter_list|()
function_decl|;
name|char
modifier|*
name|ctime
parameter_list|()
function_decl|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|_PATH_LASTLOG
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fd
argument_list|,
operator|(
name|off_t
operator|)
name|pwd
operator|->
name|pw_uid
operator|*
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|,
name|L_SET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|quiet
condition|)
block|{
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ll
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
operator|&&
name|ll
operator|.
name|ll_time
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Last login: %.*s "
argument_list|,
literal|24
operator|-
literal|5
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ctime
argument_list|(
operator|&
name|ll
operator|.
name|ll_time
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ll
operator|.
name|ll_host
operator|!=
literal|'\0'
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"from %.*s\n"
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
operator|.
name|ll_host
argument_list|)
argument_list|,
name|ll
operator|.
name|ll_host
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"on %.*s\n"
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
operator|.
name|ll_line
argument_list|)
argument_list|,
name|ll
operator|.
name|ll_line
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fd
argument_list|,
operator|(
name|off_t
operator|)
name|pwd
operator|->
name|pw_uid
operator|*
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|,
name|L_SET
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ll
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|ll
operator|.
name|ll_time
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ll
operator|.
name|ll_line
argument_list|,
name|tty
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
operator|.
name|ll_line
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostname
condition|)
name|strncpy
argument_list|(
name|ll
operator|.
name|ll_host
argument_list|,
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
operator|.
name|ll_host
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ll
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|badlogin
argument_list|(
argument|name
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|failures
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|hostname
condition|)
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"%d LOGIN FAILURE%s FROM %s, %s"
argument_list|,
name|failures
argument_list|,
name|failures
operator|>
literal|1
condition|?
literal|"S"
else|:
literal|""
argument_list|,
name|hostname
argument_list|,
name|name
argument_list|)
expr_stmt|;
else|else
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"%d LOGIN FAILURE%s ON %s, %s"
argument_list|,
name|failures
argument_list|,
name|failures
operator|>
literal|1
condition|?
literal|"S"
else|:
literal|""
argument_list|,
name|tty
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_block

begin_undef
undef|#
directive|undef
name|UNKNOWN
end_undef

begin_define
define|#
directive|define
name|UNKNOWN
value|"su"
end_define

begin_function
name|char
modifier|*
name|stypeof
parameter_list|(
name|ttyid
parameter_list|)
name|char
modifier|*
name|ttyid
decl_stmt|;
block|{
name|struct
name|ttyent
modifier|*
name|t
decl_stmt|;
return|return
operator|(
name|ttyid
operator|&&
operator|(
name|t
operator|=
name|getttynam
argument_list|(
name|ttyid
argument_list|)
operator|)
condition|?
name|t
operator|->
name|ty_type
else|:
name|UNKNOWN
operator|)
return|;
block|}
end_function

begin_macro
name|getstr
argument_list|(
argument|buf
argument_list|,
argument|cnt
argument_list|,
argument|err
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|err
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cnt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|ch
decl_stmt|;
do|do
block|{
if|if
condition|(
name|read
argument_list|(
literal|0
argument_list|,
operator|&
name|ch
argument_list|,
sizeof|sizeof
argument_list|(
name|ch
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|ch
argument_list|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|cnt
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s too long\r\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|sleepexit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|*
name|buf
operator|++
operator|=
name|ch
expr_stmt|;
block|}
do|while
condition|(
name|ch
condition|)
do|;
block|}
end_block

begin_macro
name|sleepexit
argument_list|(
argument|eval
argument_list|)
end_macro

begin_decl_stmt
name|int
name|eval
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|sleep
argument_list|(
operator|(
name|u_int
operator|)
literal|5
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|eval
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|doremotelogin
argument_list|(
argument|host
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|host
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|char
name|lusername
index|[
name|UT_NAMESIZE
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|rusername
index|[
name|UT_NAMESIZE
operator|+
literal|1
index|]
decl_stmt|;
name|getstr
argument_list|(
name|rusername
argument_list|,
sizeof|sizeof
argument_list|(
name|rusername
argument_list|)
argument_list|,
literal|"remuser"
argument_list|)
expr_stmt|;
name|getstr
argument_list|(
name|lusername
argument_list|,
sizeof|sizeof
argument_list|(
name|lusername
argument_list|)
argument_list|,
literal|"locuser"
argument_list|)
expr_stmt|;
name|getstr
argument_list|(
name|term
argument_list|,
sizeof|sizeof
argument_list|(
name|term
argument_list|)
argument_list|,
literal|"Terminal type"
argument_list|)
expr_stmt|;
name|username
operator|=
name|lusername
expr_stmt|;
name|pwd
operator|=
name|getpwnam
argument_list|(
name|username
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|ruserok
argument_list|(
name|host
argument_list|,
operator|(
name|pwd
operator|->
name|pw_uid
operator|==
literal|0
operator|)
argument_list|,
name|rusername
argument_list|,
name|username
argument_list|)
operator|)
return|;
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|speeds
index|[]
init|=
block|{
literal|"0"
block|,
literal|"50"
block|,
literal|"75"
block|,
literal|"110"
block|,
literal|"134"
block|,
literal|"150"
block|,
literal|"200"
block|,
literal|"300"
block|,
literal|"600"
block|,
literal|"1200"
block|,
literal|"1800"
block|,
literal|"2400"
block|,
literal|"4800"
block|,
literal|"9600"
block|,
literal|"19200"
block|,
literal|"38400"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NSPEEDS
value|(sizeof(speeds) / sizeof(speeds[0]))
end_define

begin_macro
name|doremoteterm
argument_list|(
argument|tp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|sgttyb
modifier|*
name|tp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
init|=
name|index
argument_list|(
name|term
argument_list|,
literal|'/'
argument_list|)
decl_stmt|,
modifier|*
modifier|*
name|cpp
decl_stmt|;
name|char
modifier|*
name|speed
decl_stmt|;
if|if
condition|(
name|cp
condition|)
block|{
operator|*
name|cp
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|speed
operator|=
name|cp
expr_stmt|;
name|cp
operator|=
name|index
argument_list|(
name|speed
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|cpp
operator|=
name|speeds
init|;
name|cpp
operator|<
operator|&
name|speeds
index|[
name|NSPEEDS
index|]
condition|;
name|cpp
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|cpp
argument_list|,
name|speed
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tp
operator|->
name|sg_ispeed
operator|=
name|tp
operator|->
name|sg_ospeed
operator|=
name|cpp
operator|-
name|speeds
expr_stmt|;
break|break;
block|}
block|}
name|tp
operator|->
name|sg_flags
operator|=
name|ECHO
operator||
name|CRMOD
operator||
name|ANYP
operator||
name|XTABS
expr_stmt|;
block|}
end_block

end_unit


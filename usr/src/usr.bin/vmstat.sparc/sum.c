begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, 1993  *	The Regents of the University of California.  All rights reserved.  *  * %sccs.include.redist.c%  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)sum.c	8.1 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<kvm.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|tahoe
end_ifdef

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"extern.h"
end_include

begin_decl_stmt
name|int
name|pct
name|__P
argument_list|(
operator|(
name|long
operator|,
name|long
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PCT
parameter_list|(
name|top
parameter_list|,
name|bot
parameter_list|)
value|pct((long)(top), (long)(bot))
end_define

begin_decl_stmt
specifier|static
name|struct
name|nlist
name|nl
index|[]
init|=
block|{
define|#
directive|define
name|X_CNT
value|0
block|{
literal|"_cnt"
block|}
block|,
define|#
directive|define
name|X_NCHSTATS
value|1
block|{
literal|"_nchstats"
block|}
block|,
ifdef|#
directive|ifdef
name|tahoe
comment|/* XXX */
define|#
directive|define
name|X_CKEYSTATS
value|2
block|{
literal|"_ckeystats"
block|}
block|,
define|#
directive|define
name|X_DKEYSTATS
value|3
block|{
literal|"_dkeystats"
block|}
block|,
endif|#
directive|endif
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|dosum
parameter_list|()
block|{
name|long
name|nchtotal
decl_stmt|;
name|struct
name|nchstats
name|nchstats
decl_stmt|;
name|struct
name|vmmeter
name|cnt
decl_stmt|;
ifdef|#
directive|ifdef
name|tahoe
name|struct
name|keystats
name|keystats
decl_stmt|;
endif|#
directive|endif
name|knlist
argument_list|(
name|nl
argument_list|)
expr_stmt|;
name|kread
argument_list|(
name|nl
index|[
name|X_CNT
index|]
operator|.
name|n_value
argument_list|,
operator|&
name|cnt
argument_list|,
sizeof|sizeof
name|cnt
argument_list|,
literal|"cnt"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u cpu context switches\n"
argument_list|,
name|cnt
operator|.
name|v_swtch
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u device interrupts\n"
argument_list|,
name|cnt
operator|.
name|v_intr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u software interrupts\n"
argument_list|,
name|cnt
operator|.
name|v_soft
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|vax
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pseudo-dma dz interrupts\n"
argument_list|,
name|cnt
operator|.
name|v_pdma
argument_list|)
expr_stmt|;
endif|#
directive|endif
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u traps\n"
argument_list|,
name|cnt
operator|.
name|v_trap
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u system calls\n"
argument_list|,
name|cnt
operator|.
name|v_syscall
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u total faults taken\n"
argument_list|,
name|cnt
operator|.
name|v_faults
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u swap ins\n"
argument_list|,
name|cnt
operator|.
name|v_swpin
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u swap outs\n"
argument_list|,
name|cnt
operator|.
name|v_swpout
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages swapped in\n"
argument_list|,
name|cnt
operator|.
name|v_pswpin
operator|/
name|CLSIZE
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages swapped out\n"
argument_list|,
name|cnt
operator|.
name|v_pswpout
operator|/
name|CLSIZE
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u page ins\n"
argument_list|,
name|cnt
operator|.
name|v_pageins
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u page outs\n"
argument_list|,
name|cnt
operator|.
name|v_pageouts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages paged in\n"
argument_list|,
name|cnt
operator|.
name|v_pgpgin
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages paged out\n"
argument_list|,
name|cnt
operator|.
name|v_pgpgout
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages reactivated\n"
argument_list|,
name|cnt
operator|.
name|v_reactivated
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u intransit blocking page faults\n"
argument_list|,
name|cnt
operator|.
name|v_intrans
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u zero fill pages created\n"
argument_list|,
name|cnt
operator|.
name|v_nzfod
operator|/
name|CLSIZE
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u zero fill page faults\n"
argument_list|,
name|cnt
operator|.
name|v_zfod
operator|/
name|CLSIZE
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages examined by the clock daemon\n"
argument_list|,
name|cnt
operator|.
name|v_scan
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u revolutions of the clock hand\n"
argument_list|,
name|cnt
operator|.
name|v_rev
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u VM object cache lookups\n"
argument_list|,
name|cnt
operator|.
name|v_lookups
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u VM object hits\n"
argument_list|,
name|cnt
operator|.
name|v_hits
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u total VM faults taken\n"
argument_list|,
name|cnt
operator|.
name|v_vm_faults
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u copy-on-write faults\n"
argument_list|,
name|cnt
operator|.
name|v_cow_faults
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages freed by daemon\n"
argument_list|,
name|cnt
operator|.
name|v_dfree
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages freed by exiting processes\n"
argument_list|,
name|cnt
operator|.
name|v_pfree
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages free\n"
argument_list|,
name|cnt
operator|.
name|v_free_count
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages wired down\n"
argument_list|,
name|cnt
operator|.
name|v_wire_count
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages active\n"
argument_list|,
name|cnt
operator|.
name|v_active_count
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u pages inactive\n"
argument_list|,
name|cnt
operator|.
name|v_inactive_count
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9u bytes per page\n"
argument_list|,
name|cnt
operator|.
name|v_page_size
argument_list|)
expr_stmt|;
name|kread
argument_list|(
name|nl
index|[
name|X_NCHSTATS
index|]
operator|.
name|n_value
argument_list|,
operator|&
name|nchstats
argument_list|,
sizeof|sizeof
name|nchstats
argument_list|,
literal|"nchstats"
argument_list|)
expr_stmt|;
name|nchtotal
operator|=
name|nchstats
operator|.
name|ncs_goodhits
operator|+
name|nchstats
operator|.
name|ncs_neghits
operator|+
name|nchstats
operator|.
name|ncs_badhits
operator|+
name|nchstats
operator|.
name|ncs_falsehits
operator|+
name|nchstats
operator|.
name|ncs_miss
operator|+
name|nchstats
operator|.
name|ncs_long
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9ld total name lookups\n"
argument_list|,
name|nchtotal
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9s cache hits (%d%% pos + %d%% neg) system %d%% per-process\n"
argument_list|,
literal|""
argument_list|,
name|PCT
argument_list|(
name|nchstats
operator|.
name|ncs_goodhits
argument_list|,
name|nchtotal
argument_list|)
argument_list|,
name|PCT
argument_list|(
name|nchstats
operator|.
name|ncs_neghits
argument_list|,
name|nchtotal
argument_list|)
argument_list|,
name|PCT
argument_list|(
name|nchstats
operator|.
name|ncs_pass2
argument_list|,
name|nchtotal
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9s deletions %d%%, falsehits %d%%, toolong %d%%\n"
argument_list|,
literal|""
argument_list|,
name|PCT
argument_list|(
name|nchstats
operator|.
name|ncs_badhits
argument_list|,
name|nchtotal
argument_list|)
argument_list|,
name|PCT
argument_list|(
name|nchstats
operator|.
name|ncs_falsehits
argument_list|,
name|nchtotal
argument_list|)
argument_list|,
name|PCT
argument_list|(
name|nchstats
operator|.
name|ncs_long
argument_list|,
name|nchtotal
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|tahoe
argument_list|)
name|kread
argument_list|(
name|nl
index|[
name|X_CKEYSTATS
index|]
operator|.
name|n_value
argument_list|,
operator|&
name|keystats
argument_list|,
sizeof|sizeof
name|keystats
argument_list|,
literal|"ckeystats"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9d %s (free %d%% norefs %d%% taken %d%% shared %d%%)\n"
argument_list|,
name|keystats
operator|.
name|ks_allocs
argument_list|,
literal|"code cache keys allocated"
argument_list|,
name|PCT
argument_list|(
name|keystats
operator|.
name|ks_allocfree
argument_list|,
name|keystats
operator|.
name|ks_allocs
argument_list|)
argument_list|,
name|PCT
argument_list|(
name|keystats
operator|.
name|ks_norefs
argument_list|,
name|keystats
operator|.
name|ks_allocs
argument_list|)
argument_list|,
name|PCT
argument_list|(
name|keystats
operator|.
name|ks_taken
argument_list|,
name|keystats
operator|.
name|ks_allocs
argument_list|)
argument_list|,
name|PCT
argument_list|(
name|keystats
operator|.
name|ks_shared
argument_list|,
name|keystats
operator|.
name|ks_allocs
argument_list|)
argument_list|)
expr_stmt|;
name|kread
argument_list|(
name|nl
index|[
name|X_DKEYSTATS
index|]
operator|.
name|n_value
argument_list|,
operator|&
name|keystats
argument_list|,
sizeof|sizeof
name|keystats
argument_list|,
literal|"ckeystats"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%9d %s (free %d%% norefs %d%% taken %d%% shared %d%%)\n"
argument_list|,
name|keystats
operator|.
name|ks_allocs
argument_list|,
literal|"data cache keys allocated"
argument_list|,
name|PCT
argument_list|(
name|keystats
operator|.
name|ks_allocfree
argument_list|,
name|keystats
operator|.
name|ks_allocs
argument_list|)
argument_list|,
name|PCT
argument_list|(
name|keystats
operator|.
name|ks_norefs
argument_list|,
name|keystats
operator|.
name|ks_allocs
argument_list|)
argument_list|,
name|PCT
argument_list|(
name|keystats
operator|.
name|ks_taken
argument_list|,
name|keystats
operator|.
name|ks_allocs
argument_list|)
argument_list|,
name|PCT
argument_list|(
name|keystats
operator|.
name|ks_shared
argument_list|,
name|keystats
operator|.
name|ks_allocs
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|pct
parameter_list|(
name|top
parameter_list|,
name|bot
parameter_list|)
name|long
name|top
decl_stmt|,
name|bot
decl_stmt|;
block|{
if|if
condition|(
name|bot
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|bot
operator|>
operator|(
name|LONG_MAX
operator|/
literal|100
operator|)
condition|)
return|return
operator|(
name|top
operator|/
operator|(
name|bot
operator|/
literal|100
operator|)
operator|)
return|;
return|return
operator|(
operator|(
name|top
operator|*
literal|100
operator|)
operator|/
name|bot
operator|)
return|;
block|}
end_function

end_unit


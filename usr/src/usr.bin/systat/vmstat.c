begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)vmstat.c	1.1 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Cursed vmstat -- from Robert Elz.  */
end_comment

begin_include
include|#
directive|include
file|<curses.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_comment
comment|/*					this is STUPID! #include<sys/time.h> */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/vm.h>
end_include

begin_include
include|#
directive|include
file|<sys/dk.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<vaxuba/ubavar.h>
end_include

begin_include
include|#
directive|include
file|<vaxmba/mbavar.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<vax/pte.h>
end_include

begin_include
include|#
directive|include
file|<sys/nami.h>
end_include

begin_if
if|#
directive|if
name|DK_NDRIVE
operator|>
literal|6
end_if

begin_undef
undef|#
directive|undef
name|DK_NDRIVE
end_undef

begin_define
define|#
directive|define
name|DK_NDRIVE
value|6
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|char
modifier|*
name|fread
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|long
name|time
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|float
name|cputime
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|asctime
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|tm
modifier|*
name|localtime
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|finish
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|docmd
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|utmp
name|utmp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|nlist
name|name
index|[]
init|=
block|{
block|{
literal|"_cp_time"
block|}
block|,
define|#
directive|define
name|X_CPTIME
value|0
block|{
literal|"_rate"
block|}
block|,
define|#
directive|define
name|X_RATE
value|1
block|{
literal|"_total"
block|}
block|,
define|#
directive|define
name|X_TOTAL
value|2
block|{
literal|"_avenrun"
block|}
block|,
define|#
directive|define
name|X_AVENRUN
value|3
block|{
literal|"_proc"
block|}
block|,
define|#
directive|define
name|X_PROC
value|4
block|{
literal|"_nproc"
block|}
block|,
define|#
directive|define
name|X_NPROC
value|5
block|{
literal|"_bootime"
block|}
block|,
define|#
directive|define
name|X_BOOTIME
value|6
block|{
literal|"_deficit"
block|}
block|,
define|#
directive|define
name|X_DEFICIT
value|7
block|{
literal|"_ubdinit"
block|}
block|,
define|#
directive|define
name|X_UBDINIT
value|8
block|{
literal|"_mbdinit"
block|}
block|,
define|#
directive|define
name|X_MBDINIT
value|9
block|{
literal|"_sum"
block|}
block|,
define|#
directive|define
name|X_SUM
value|10
block|{
literal|"_dk_busy"
block|}
block|,
define|#
directive|define
name|X_DK_BUSY
value|11
block|{
literal|"_dk_time"
block|}
block|,
define|#
directive|define
name|X_DK_TIME
value|12
block|{
literal|"_dk_xfer"
block|}
block|,
define|#
directive|define
name|X_DK_XFER
value|13
block|{
literal|"_dk_wds"
block|}
block|,
define|#
directive|define
name|X_DK_WDS
value|14
block|{
literal|"_tk_nin"
block|}
block|,
define|#
directive|define
name|X_TK_NIN
value|15
block|{
literal|"_tk_nout"
block|}
block|,
define|#
directive|define
name|X_TK_NOUT
value|16
block|{
literal|"_dk_seek"
block|}
block|,
define|#
directive|define
name|X_DK_SEEK
value|17
block|{
literal|"_dk_mspw"
block|}
block|,
define|#
directive|define
name|X_DK_MSPW
value|18
block|{
literal|"_hz"
block|}
block|,
define|#
directive|define
name|X_HZ
value|19
block|{
literal|"_phz"
block|}
block|,
define|#
directive|define
name|X_PHZ
value|20
block|{
literal|"_nchstats"
block|}
block|,
define|#
directive|define
name|X_NCHSTATS
value|21
block|{
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|Info
block|{
name|long
name|time
index|[
name|CPUSTATES
index|]
decl_stmt|;
name|struct
name|vmmeter
name|Rate
decl_stmt|;
name|struct
name|vmtotal
name|Total
decl_stmt|;
name|struct
name|vmmeter
name|Sum
decl_stmt|;
name|struct
name|forkstat
name|Forkstat
decl_stmt|;
name|long
name|dk_time
index|[
name|DK_NDRIVE
index|]
decl_stmt|;
name|long
name|dk_wds
index|[
name|DK_NDRIVE
index|]
decl_stmt|;
name|long
name|dk_seek
index|[
name|DK_NDRIVE
index|]
decl_stmt|;
name|long
name|dk_xfer
index|[
name|DK_NDRIVE
index|]
decl_stmt|;
name|float
name|dk_mspw
index|[
name|DK_NDRIVE
index|]
decl_stmt|;
name|int
name|dk_busy
decl_stmt|;
name|long
name|tk_nin
decl_stmt|;
name|long
name|tk_nout
decl_stmt|;
name|struct
name|nchstats
name|nchstats
decl_stmt|;
name|long
name|nchcount
decl_stmt|;
block|}
name|s
struct|,
name|s1
struct|,
name|s2
struct|,
name|z
struct|;
end_struct

begin_define
define|#
directive|define
name|total
value|s.Total
end_define

begin_define
define|#
directive|define
name|sum
value|s.Sum
end_define

begin_define
define|#
directive|define
name|sumold
value|s1.Sum
end_define

begin_define
define|#
directive|define
name|rate
value|s.Rate
end_define

begin_define
define|#
directive|define
name|nchtotal
value|s.nchstats
end_define

begin_define
define|#
directive|define
name|oldnchtotal
value|s1.nchstats
end_define

begin_define
define|#
directive|define
name|oldrate
value|s1.Rate
end_define

begin_define
define|#
directive|define
name|X
parameter_list|(
name|fld
parameter_list|)
value|{t=s.fld[i]; s.fld[i]-=s1.fld[i]; if(state==TIME) s1.fld[i]=t;}
end_define

begin_define
define|#
directive|define
name|Y
parameter_list|(
name|fld
parameter_list|)
value|{t = s.fld; s.fld -= s1.fld; if(state == TIME) s1.fld = t;}
end_define

begin_define
define|#
directive|define
name|Z
parameter_list|(
name|fld
parameter_list|)
value|{t = s.nchstats.fld; s.nchstats.fld -= s1.nchstats.fld; \ 	if(state == TIME) s1.nchstats.fld = t;}
end_define

begin_decl_stmt
name|int
name|ut
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kmem
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|deficit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|avenrun
index|[
literal|3
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|buf
index|[
literal|26
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|time_t
name|t
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|time_t
name|bootime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|etime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|secs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|delay
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|hz
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|phz
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|float
name|hertz
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|dr_name
index|[
name|DK_NDRIVE
index|]
index|[
literal|10
index|]
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|state
block|{
name|BOOT
block|,
name|TIME
block|,
name|RUN
block|,
name|STOP
block|}
name|state
init|=
name|TIME
enum|;
end_enum

begin_enum
enum|enum
block|{
name|NONE
block|,
name|SOME
block|}
name|dr_state
index|[
name|DK_NDRIVE
index|]
enum|;
end_enum

begin_decl_stmt
name|char
name|cpuchar
index|[
name|CPUSTATES
index|]
init|=
block|{
literal|'='
block|,
literal|'>'
block|,
literal|'-'
block|,
literal|' '
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|cpuorder
index|[
name|CPUSTATES
index|]
init|=
block|{
name|CP_SYS
block|,
name|CP_USER
block|,
name|CP_NICE
block|,
name|CP_IDLE
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|time_t
name|now
decl_stmt|,
name|lastime
decl_stmt|,
name|starttime
decl_stmt|;
name|int
name|i
decl_stmt|,
name|l
decl_stmt|,
name|c
decl_stmt|;
name|int
name|psiz
decl_stmt|;
name|int
name|interv
decl_stmt|;
name|int
name|hits
decl_stmt|;
name|float
name|f1
decl_stmt|,
name|f2
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
switch|switch
condition|(
name|c
operator|=
name|argv
index|[
literal|1
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|?
name|argv
index|[
literal|1
index|]
index|[
literal|1
index|]
else|:
name|argv
index|[
literal|1
index|]
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'t'
case|:
name|state
operator|=
name|TIME
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|state
operator|=
name|RUN
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|state
operator|=
name|BOOT
expr_stmt|;
break|break;
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
name|delay
operator|=
name|c
operator|-
literal|'0'
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|kmem
operator|=
name|open
argument_list|(
literal|"/dev/kmem"
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No /dev/kmem \n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ut
operator|=
name|open
argument_list|(
literal|"/etc/utmp"
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No utmp\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|nlist
argument_list|(
literal|"/vmunix"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
index|[
literal|0
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No namelist\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_HZ
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|hz
argument_list|,
sizeof|sizeof
name|hz
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_PHZ
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|phz
argument_list|,
sizeof|sizeof
name|phz
argument_list|)
expr_stmt|;
name|hertz
operator|=
name|phz
condition|?
name|phz
else|:
name|hz
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_DK_MSPW
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
name|s
operator|.
name|dk_mspw
argument_list|,
sizeof|sizeof
name|s
operator|.
name|dk_mspw
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DK_NDRIVE
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|s
operator|.
name|dk_mspw
index|[
name|i
index|]
operator|==
literal|0.0
condition|)
name|dr_state
index|[
name|i
index|]
operator|=
name|NONE
expr_stmt|;
else|else
name|dr_state
index|[
name|i
index|]
operator|=
name|SOME
expr_stmt|;
name|read_names
argument_list|()
expr_stmt|;
name|initscr
argument_list|()
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|finish
argument_list|)
expr_stmt|;
name|noecho
argument_list|()
expr_stmt|;
name|crmode
argument_list|()
expr_stmt|;
name|layout
argument_list|()
expr_stmt|;
name|time
argument_list|(
operator|&
name|lastime
argument_list|)
expr_stmt|;
name|starttime
operator|=
name|lastime
expr_stmt|;
name|getinfo
argument_list|(
operator|&
name|s2
argument_list|,
name|RUN
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|RUN
condition|)
name|s1
operator|=
name|s2
expr_stmt|;
comment|/*			if included, this starts TIME at zeroes, else == boot 	else if (state == TIME) 		getinfo(&s1, TIME) */
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_BOOTIME
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|bootime
argument_list|,
sizeof|sizeof
name|bootime
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
while|while
condition|(
name|state
operator|==
name|STOP
condition|)
name|waittty
argument_list|(
name|delay
operator|*
literal|10
argument_list|)
expr_stmt|;
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|buf
argument_list|,
name|ctime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|buf
index|[
literal|16
index|]
operator|=
literal|'\0'
expr_stmt|;
name|getinfo
argument_list|(
operator|&
name|s
argument_list|,
name|state
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DK_NDRIVE
condition|;
name|i
operator|++
control|)
block|{
name|X
argument_list|(
name|dk_xfer
argument_list|)
expr_stmt|;
name|X
argument_list|(
name|dk_seek
argument_list|)
expr_stmt|;
name|X
argument_list|(
name|dk_wds
argument_list|)
expr_stmt|;
name|X
argument_list|(
name|dk_time
argument_list|)
expr_stmt|;
block|}
name|Y
argument_list|(
name|tk_nin
argument_list|)
expr_stmt|;
name|Y
argument_list|(
name|tk_nout
argument_list|)
expr_stmt|;
name|etime
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPUSTATES
condition|;
name|i
operator|++
control|)
block|{
name|X
argument_list|(
name|time
argument_list|)
expr_stmt|;
name|etime
operator|+=
name|s
operator|.
name|time
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|etime
operator|<
literal|5.0
condition|)
comment|/*< 5 ticks - ignore this trash */
continue|continue;
comment|/* 		if (etime == 0.0) 			etime = 1.0; 	*/
name|etime
operator|/=
name|hertz
expr_stmt|;
name|Z
argument_list|(
name|ncs_goodhits
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_badhits
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_miss
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_long
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_pass2
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_2passes
argument_list|)
expr_stmt|;
name|s
operator|.
name|nchcount
operator|=
name|nchtotal
operator|.
name|ncs_goodhits
operator|+
name|nchtotal
operator|.
name|ncs_badhits
operator|+
name|nchtotal
operator|.
name|ncs_miss
operator|+
name|nchtotal
operator|.
name|ncs_long
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|TIME
condition|)
name|s1
operator|.
name|nchcount
operator|=
name|s
operator|.
name|nchcount
expr_stmt|;
name|psiz
operator|=
literal|0
expr_stmt|;
name|f2
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|CPUSTATES
condition|;
name|c
operator|++
control|)
block|{
name|i
operator|=
name|cpuorder
index|[
name|c
index|]
expr_stmt|;
name|f1
operator|=
name|cputime
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|f2
operator|+=
name|f1
expr_stmt|;
name|l
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|f2
operator|+
literal|1.0
operator|)
operator|/
literal|2.0
argument_list|)
operator|-
name|psiz
expr_stmt|;
name|putfloat
argument_list|(
name|f1
argument_list|,
literal|15
argument_list|,
literal|10
operator|+
literal|11
operator|*
name|c
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|move
argument_list|(
literal|17
argument_list|,
literal|5
operator|+
name|psiz
argument_list|)
expr_stmt|;
name|psiz
operator|+=
name|l
expr_stmt|;
while|while
condition|(
name|l
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
name|cpuchar
index|[
name|c
index|]
argument_list|)
expr_stmt|;
block|}
name|putint
argument_list|(
name|ucount
argument_list|()
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|avenrun
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|,
literal|18
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|avenrun
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|,
literal|24
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|avenrun
index|[
literal|2
index|]
argument_list|,
literal|1
argument_list|,
literal|30
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|1
argument_list|,
literal|58
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_arm
operator|/
literal|2
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_armtxt
operator|/
literal|2
argument_list|,
literal|5
argument_list|,
literal|10
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_avm
operator|/
literal|2
argument_list|,
literal|5
argument_list|,
literal|15
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_avmtxt
operator|/
literal|2
argument_list|,
literal|5
argument_list|,
literal|20
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_rm
operator|/
literal|2
argument_list|,
literal|6
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_rmtxt
operator|/
literal|2
argument_list|,
literal|6
argument_list|,
literal|10
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_vm
operator|/
literal|2
argument_list|,
literal|6
argument_list|,
literal|15
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_vmtxt
operator|/
literal|2
argument_list|,
literal|6
argument_list|,
literal|20
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_free
operator|/
literal|2
argument_list|,
literal|5
argument_list|,
literal|27
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_rq
argument_list|,
literal|17
argument_list|,
literal|62
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_pw
argument_list|,
literal|17
argument_list|,
literal|65
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_dw
argument_list|,
literal|17
argument_list|,
literal|68
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_sl
argument_list|,
literal|17
argument_list|,
literal|71
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_sw
argument_list|,
literal|17
argument_list|,
literal|74
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_swtch
argument_list|,
name|oldrate
operator|.
name|v_swtch
argument_list|,
literal|3
argument_list|,
literal|75
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_trap
argument_list|,
name|oldrate
operator|.
name|v_trap
argument_list|,
literal|4
argument_list|,
literal|75
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_syscall
argument_list|,
name|oldrate
operator|.
name|v_syscall
argument_list|,
literal|5
argument_list|,
literal|75
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_intr
argument_list|,
name|oldrate
operator|.
name|v_intr
argument_list|,
literal|6
argument_list|,
literal|75
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_pdma
argument_list|,
name|oldrate
operator|.
name|v_pdma
argument_list|,
literal|7
argument_list|,
literal|75
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_faults
argument_list|,
name|oldrate
operator|.
name|v_faults
argument_list|,
literal|8
argument_list|,
literal|75
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_scan
argument_list|,
name|oldrate
operator|.
name|v_scan
argument_list|,
literal|9
argument_list|,
literal|75
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_rev
argument_list|,
name|oldrate
operator|.
name|v_rev
argument_list|,
literal|10
argument_list|,
literal|75
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_pgin
argument_list|,
name|oldrate
operator|.
name|v_pgin
argument_list|,
literal|5
argument_list|,
literal|45
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_pgout
argument_list|,
name|oldrate
operator|.
name|v_pgout
argument_list|,
literal|5
argument_list|,
literal|50
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_swpin
argument_list|,
name|oldrate
operator|.
name|v_swpin
argument_list|,
literal|5
argument_list|,
literal|55
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_swpout
argument_list|,
name|oldrate
operator|.
name|v_swpout
argument_list|,
literal|5
argument_list|,
literal|60
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_pgpgin
argument_list|,
name|oldrate
operator|.
name|v_pgpgin
argument_list|,
literal|6
argument_list|,
literal|45
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_pgpgout
argument_list|,
name|oldrate
operator|.
name|v_pgpgout
argument_list|,
literal|6
argument_list|,
literal|50
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_pswpin
argument_list|,
name|oldrate
operator|.
name|v_pswpin
argument_list|,
literal|6
argument_list|,
literal|55
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_pswpout
argument_list|,
name|oldrate
operator|.
name|v_pswpout
argument_list|,
literal|6
argument_list|,
literal|60
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_pgrec
argument_list|,
name|oldrate
operator|.
name|v_pgrec
argument_list|,
literal|9
argument_list|,
literal|40
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_intrans
argument_list|,
name|oldrate
operator|.
name|v_intrans
argument_list|,
literal|9
argument_list|,
literal|44
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_xsfrec
argument_list|,
name|oldrate
operator|.
name|v_xsfrec
argument_list|,
literal|9
argument_list|,
literal|47
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_xifrec
argument_list|,
name|oldrate
operator|.
name|v_xifrec
argument_list|,
literal|9
argument_list|,
literal|51
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_pgfrec
argument_list|,
name|oldrate
operator|.
name|v_pgfrec
argument_list|,
literal|9
argument_list|,
literal|55
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_dfree
argument_list|,
name|oldrate
operator|.
name|v_dfree
argument_list|,
literal|9
argument_list|,
literal|59
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_seqfree
argument_list|,
name|oldrate
operator|.
name|v_seqfree
argument_list|,
literal|9
argument_list|,
literal|63
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_zfod
argument_list|,
name|oldrate
operator|.
name|v_zfod
argument_list|,
literal|11
argument_list|,
literal|40
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_nzfod
argument_list|,
name|oldrate
operator|.
name|v_nzfod
argument_list|,
literal|12
argument_list|,
literal|40
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_exfod
argument_list|,
name|oldrate
operator|.
name|v_exfod
argument_list|,
literal|11
argument_list|,
literal|54
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|putrate
argument_list|(
name|rate
operator|.
name|v_nexfod
argument_list|,
name|oldrate
operator|.
name|v_nexfod
argument_list|,
literal|12
argument_list|,
literal|54
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|rate
operator|.
name|v_nzfod
operator|==
literal|0
condition|?
literal|0.0
else|:
name|state
operator|!=
name|RUN
condition|?
operator|(
literal|100.0
operator|*
name|rate
operator|.
name|v_zfod
operator|/
name|rate
operator|.
name|v_nzfod
operator|)
else|:
name|rate
operator|.
name|v_nzfod
operator|==
name|oldrate
operator|.
name|v_nzfod
condition|?
literal|0.0
else|:
operator|(
literal|100.0
operator|*
operator|(
name|rate
operator|.
name|v_zfod
operator|-
name|oldrate
operator|.
name|v_zfod
operator|)
operator|/
operator|(
name|rate
operator|.
name|v_nzfod
operator|-
name|oldrate
operator|.
name|v_nzfod
operator|)
operator|)
argument_list|,
literal|13
argument_list|,
literal|40
argument_list|,
literal|8
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|rate
operator|.
name|v_nexfod
operator|==
literal|0
condition|?
literal|0.0
else|:
name|state
operator|!=
name|RUN
condition|?
operator|(
literal|100.0
operator|*
name|rate
operator|.
name|v_exfod
operator|/
name|rate
operator|.
name|v_nexfod
operator|)
else|:
name|rate
operator|.
name|v_nexfod
operator|==
name|oldrate
operator|.
name|v_nexfod
condition|?
literal|0.0
else|:
operator|(
literal|100.0
operator|*
operator|(
name|rate
operator|.
name|v_exfod
operator|-
name|oldrate
operator|.
name|v_exfod
operator|)
operator|/
operator|(
name|rate
operator|.
name|v_nexfod
operator|-
name|oldrate
operator|.
name|v_nexfod
operator|)
operator|)
argument_list|,
literal|13
argument_list|,
literal|54
argument_list|,
literal|8
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|c
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DK_NDRIVE
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|dr_state
index|[
name|i
index|]
operator|==
name|SOME
condition|)
name|dinfo
argument_list|(
name|i
argument_list|,
name|c
operator|++
operator|*
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|s
operator|.
name|nchcount
argument_list|,
literal|21
argument_list|,
literal|6
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|nchtotal
operator|.
name|ncs_goodhits
argument_list|,
literal|21
argument_list|,
literal|14
argument_list|,
literal|4
argument_list|)
expr_stmt|;
define|#
directive|define
name|nz
parameter_list|(
name|x
parameter_list|)
value|((x) ? (x) : 1)
name|putfloat
argument_list|(
name|nchtotal
operator|.
name|ncs_goodhits
operator|*
literal|100.0
operator|/
name|nz
argument_list|(
name|s
operator|.
name|nchcount
argument_list|)
argument_list|,
literal|21
argument_list|,
literal|19
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|nchtotal
operator|.
name|ncs_pass2
argument_list|,
literal|21
argument_list|,
literal|28
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|nchtotal
operator|.
name|ncs_pass2
operator|*
literal|100.0
operator|/
name|nz
argument_list|(
name|s
operator|.
name|nchcount
argument_list|)
argument_list|,
literal|21
argument_list|,
literal|34
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|nz
name|move
argument_list|(
name|LINES
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
name|waittty
argument_list|(
name|delay
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* calculate number of users on the system */
end_comment

begin_macro
name|ucount
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|nusers
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|read
argument_list|(
name|ut
argument_list|,
operator|&
name|utmp
argument_list|,
sizeof|sizeof
argument_list|(
name|utmp
argument_list|)
argument_list|)
condition|)
if|if
condition|(
name|utmp
operator|.
name|ut_name
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|nusers
operator|++
expr_stmt|;
name|lseek
argument_list|(
name|ut
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|nusers
operator|)
return|;
block|}
end_block

begin_function
name|float
name|cputime
parameter_list|(
name|indx
parameter_list|)
name|int
name|indx
decl_stmt|;
block|{
name|double
name|t
decl_stmt|;
specifier|register
name|i
expr_stmt|;
name|t
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPUSTATES
condition|;
name|i
operator|++
control|)
name|t
operator|+=
name|s
operator|.
name|time
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|t
operator|==
literal|0.0
condition|)
name|t
operator|=
literal|1.0
expr_stmt|;
return|return
operator|(
name|s
operator|.
name|time
index|[
name|indx
index|]
operator|*
literal|100.0
operator|/
name|t
operator|)
return|;
block|}
end_function

begin_function
name|void
name|finish
parameter_list|()
block|{
name|mvcur
argument_list|(
literal|0
argument_list|,
name|COLS
operator|-
literal|1
argument_list|,
name|LINES
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|endwin
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|waittty
argument_list|(
argument|period
argument_list|)
end_macro

begin_block
block|{
name|int
name|inbits
init|=
literal|1
operator|<<
literal|0
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
name|period
expr_stmt|;
name|select
argument_list|(
literal|32
argument_list|,
operator|&
name|inbits
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|inbits
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
condition|)
name|docmd
argument_list|()
expr_stmt|;
block|}
end_block

begin_function
name|void
name|docmd
parameter_list|()
block|{
name|int
name|c
decl_stmt|;
specifier|static
name|enum
name|state
name|oldstate
decl_stmt|;
name|c
operator|=
name|getchar
argument_list|()
operator|&
literal|0177
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
name|delay
operator|=
name|c
operator|-
literal|'0'
expr_stmt|;
name|state
operator|=
name|TIME
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|s1
operator|=
name|s2
expr_stmt|;
name|state
operator|=
name|RUN
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|state
operator|=
name|BOOT
expr_stmt|;
name|s1
operator|=
name|z
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|state
operator|=
name|TIME
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
case|case
literal|'l'
operator|&
literal|037
case|:
name|layout
argument_list|()
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|STOP
condition|)
name|state
operator|=
name|oldstate
expr_stmt|;
break|break;
case|case
literal|'z'
case|:
if|if
condition|(
name|state
operator|==
name|RUN
condition|)
name|getinfo
argument_list|(
operator|&
name|s1
argument_list|,
name|RUN
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|state
operator|==
name|STOP
condition|)
name|state
operator|=
name|oldstate
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
case|case
literal|0177
case|:
name|finish
argument_list|()
expr_stmt|;
comment|/* NOTREACHED */
case|case
literal|' '
case|:
case|case
literal|'0'
case|:
if|if
condition|(
name|state
operator|==
name|STOP
condition|)
block|{
name|state
operator|=
name|oldstate
expr_stmt|;
break|break;
block|}
name|oldstate
operator|=
name|state
expr_stmt|;
name|state
operator|=
name|STOP
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|state
operator|==
name|STOP
condition|)
name|state
operator|=
name|oldstate
expr_stmt|;
block|}
block|}
end_function

begin_macro
name|layout
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|i
operator|,
name|j
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
literal|1
argument_list|,
literal|5
argument_list|,
literal|"users    Load"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|,
literal|"Mem     REAL    VIRTUAL "
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|4
argument_list|,
literal|1
argument_list|,
literal|"      Tot Text  Tot Text"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|1
argument_list|,
literal|"Act"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|6
argument_list|,
literal|1
argument_list|,
literal|"All"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|4
argument_list|,
literal|28
argument_list|,
literal|"Free"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|3
argument_list|,
literal|40
argument_list|,
literal|"        PAGING    SWAPING "
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|4
argument_list|,
literal|40
argument_list|,
literal|"        in  out   in  out "
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|40
argument_list|,
literal|"count"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|6
argument_list|,
literal|40
argument_list|,
literal|"pages"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|3
argument_list|,
literal|71
argument_list|,
literal|"Csw"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|4
argument_list|,
literal|71
argument_list|,
literal|"Trp"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|71
argument_list|,
literal|"Sys"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|6
argument_list|,
literal|71
argument_list|,
literal|"Int"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|7
argument_list|,
literal|71
argument_list|,
literal|"Pdm"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|8
argument_list|,
literal|71
argument_list|,
literal|"Flt"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|9
argument_list|,
literal|71
argument_list|,
literal|"Scn"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|10
argument_list|,
literal|71
argument_list|,
literal|"Rev"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|8
argument_list|,
literal|40
argument_list|,
literal|"Rec It F/S F/F RFL Fre SFr"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|11
argument_list|,
literal|49
argument_list|,
literal|" zf"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|12
argument_list|,
literal|49
argument_list|,
literal|"nzf"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|13
argument_list|,
literal|49
argument_list|,
literal|"%%zf"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|11
argument_list|,
literal|63
argument_list|,
literal|" xf"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|12
argument_list|,
literal|63
argument_list|,
literal|"nxf"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|13
argument_list|,
literal|63
argument_list|,
literal|"%%xf"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|15
argument_list|,
literal|5
argument_list|,
literal|" Sys   . %% User   . %% Nice   . %% Idle   . %%"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|15
argument_list|,
literal|57
argument_list|,
literal|"Procs  r  p  d  s  w"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|16
argument_list|,
literal|5
argument_list|,
literal|"|    |    |    |    |    |    |    |    |    |    |"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|19
argument_list|,
literal|0
argument_list|,
literal|"Namei         Sys-cache     Proc-cache"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|20
argument_list|,
literal|0
argument_list|,
literal|"      Calls   hits    %%     hits     %%"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|8
argument_list|,
literal|0
argument_list|,
literal|"Discs"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|9
argument_list|,
literal|0
argument_list|,
literal|"seeks"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|10
argument_list|,
literal|0
argument_list|,
literal|"xfers"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|11
argument_list|,
literal|0
argument_list|,
literal|" blks"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|12
argument_list|,
literal|0
argument_list|,
literal|" msps"
argument_list|)
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DK_NDRIVE
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|dr_state
index|[
name|i
index|]
operator|==
name|SOME
condition|)
block|{
name|mvprintw
argument_list|(
literal|8
argument_list|,
literal|5
operator|+
literal|5
operator|*
name|j
argument_list|,
literal|"  %3.3s"
argument_list|,
name|dr_name
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|putrate
argument_list|(
argument|r
argument_list|,
argument|or
argument_list|,
argument|l
argument_list|,
argument|c
argument_list|,
argument|w
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|state
operator|!=
name|TIME
condition|)
block|{
if|if
condition|(
name|state
operator|==
name|RUN
condition|)
name|r
operator|-=
name|or
expr_stmt|;
name|putint
argument_list|(
call|(
name|int
call|)
argument_list|(
operator|(
name|float
operator|)
name|r
operator|/
name|etime
operator|+
literal|0.5
argument_list|)
argument_list|,
name|l
argument_list|,
name|c
argument_list|,
name|w
argument_list|)
expr_stmt|;
block|}
else|else
name|putint
argument_list|(
name|r
argument_list|,
name|l
argument_list|,
name|c
argument_list|,
name|w
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|putint
argument_list|(
argument|n
argument_list|,
argument|l
argument_list|,
argument|c
argument_list|,
argument|w
argument_list|)
end_macro

begin_block
block|{
name|char
name|b
index|[
literal|128
index|]
decl_stmt|;
name|move
argument_list|(
name|l
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
while|while
condition|(
name|w
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
return|return;
block|}
name|sprintf
argument_list|(
name|b
argument_list|,
literal|"%*d"
argument_list|,
name|w
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|b
argument_list|)
operator|>
name|w
condition|)
block|{
while|while
condition|(
name|w
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
return|return;
block|}
name|addstr
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|putfloat
argument_list|(
argument|f
argument_list|,
argument|l
argument_list|,
argument|c
argument_list|,
argument|w
argument_list|,
argument|d
argument_list|,
argument|nz
argument_list|)
end_macro

begin_decl_stmt
name|float
name|f
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|b
index|[
literal|128
index|]
decl_stmt|;
name|move
argument_list|(
name|l
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|nz
operator|&&
name|f
operator|==
literal|0.0
condition|)
block|{
while|while
condition|(
name|w
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
return|return;
block|}
name|sprintf
argument_list|(
name|b
argument_list|,
literal|"%*.*f"
argument_list|,
name|w
argument_list|,
name|d
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|b
argument_list|)
operator|>
name|w
condition|)
block|{
while|while
condition|(
name|w
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
return|return;
block|}
name|addstr
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Read the drive names out of kmem.  * ARGH ARGH ARGH ARGH !!!!!!!!!!!!  */
end_comment

begin_define
define|#
directive|define
name|steal
parameter_list|(
name|where
parameter_list|,
name|var
parameter_list|)
value|lseek(kmem, where, 0); read(kmem,&var, sizeof var);
end_define

begin_macro
name|read_names
argument_list|()
end_macro

begin_block
block|{
name|struct
name|mba_device
name|mdev
decl_stmt|;
specifier|register
name|struct
name|mba_device
modifier|*
name|mp
decl_stmt|;
name|struct
name|mba_driver
name|mdrv
decl_stmt|;
name|short
name|two_char
decl_stmt|;
name|char
modifier|*
name|cp
init|=
operator|(
name|char
operator|*
operator|)
operator|&
name|two_char
decl_stmt|;
name|struct
name|uba_device
name|udev
decl_stmt|,
modifier|*
name|up
decl_stmt|;
name|struct
name|uba_driver
name|udrv
decl_stmt|;
name|mp
operator|=
operator|(
expr|struct
name|mba_device
operator|*
operator|)
name|name
index|[
name|X_MBDINIT
index|]
operator|.
name|n_value
expr_stmt|;
name|up
operator|=
operator|(
expr|struct
name|uba_device
operator|*
operator|)
name|name
index|[
name|X_UBDINIT
index|]
operator|.
name|n_value
expr_stmt|;
if|if
condition|(
name|up
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"vsta: Disk init info not in namelist\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mp
condition|)
while|while
condition|(
literal|1
condition|)
block|{
name|steal
argument_list|(
name|mp
operator|++
argument_list|,
name|mdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdev
operator|.
name|mi_driver
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|mdev
operator|.
name|mi_dk
operator|<
literal|0
operator|||
name|mdev
operator|.
name|mi_alive
operator|==
literal|0
condition|)
continue|continue;
name|steal
argument_list|(
name|mdev
operator|.
name|mi_driver
argument_list|,
name|mdrv
argument_list|)
expr_stmt|;
name|steal
argument_list|(
name|mdrv
operator|.
name|md_dname
argument_list|,
name|two_char
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|dr_name
index|[
name|mdev
operator|.
name|mi_dk
index|]
argument_list|,
literal|"%c%c%d"
argument_list|,
name|cp
index|[
literal|0
index|]
argument_list|,
name|cp
index|[
literal|1
index|]
argument_list|,
name|mdev
operator|.
name|mi_unit
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|steal
argument_list|(
name|up
operator|++
argument_list|,
name|udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|udev
operator|.
name|ui_driver
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|udev
operator|.
name|ui_dk
operator|<
literal|0
operator|||
name|udev
operator|.
name|ui_alive
operator|==
literal|0
condition|)
continue|continue;
name|steal
argument_list|(
name|udev
operator|.
name|ui_driver
argument_list|,
name|udrv
argument_list|)
expr_stmt|;
name|steal
argument_list|(
name|udrv
operator|.
name|ud_dname
argument_list|,
name|two_char
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|dr_name
index|[
name|udev
operator|.
name|ui_dk
index|]
argument_list|,
literal|"%c%c%d"
argument_list|,
name|cp
index|[
literal|0
index|]
argument_list|,
name|cp
index|[
literal|1
index|]
argument_list|,
name|udev
operator|.
name|ui_unit
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|getinfo
argument_list|(
argument|s
argument_list|,
argument|st
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|Info
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|enum
name|state
name|st
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_CPTIME
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
name|s
operator|->
name|time
argument_list|,
sizeof|sizeof
name|s
operator|->
name|time
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|!=
name|TIME
condition|)
block|{
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_SUM
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|s
operator|->
name|Rate
argument_list|,
sizeof|sizeof
expr|&
name|s
operator|->
name|Rate
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_RATE
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|s
operator|->
name|Rate
argument_list|,
sizeof|sizeof
name|s
operator|->
name|Rate
argument_list|)
expr_stmt|;
block|}
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_DEFICIT
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
name|deficit
argument_list|,
sizeof|sizeof
name|deficit
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_AVENRUN
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
name|avenrun
argument_list|,
sizeof|sizeof
argument_list|(
name|avenrun
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_TOTAL
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|s
operator|->
name|Total
argument_list|,
sizeof|sizeof
name|s
operator|->
name|Total
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_DK_BUSY
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|s
operator|->
name|dk_busy
argument_list|,
sizeof|sizeof
name|s
operator|->
name|dk_busy
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_DK_TIME
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
name|s
operator|->
name|dk_time
argument_list|,
sizeof|sizeof
name|s
operator|->
name|dk_time
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_DK_XFER
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
name|s
operator|->
name|dk_xfer
argument_list|,
sizeof|sizeof
name|s
operator|->
name|dk_xfer
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_DK_WDS
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
name|s
operator|->
name|dk_wds
argument_list|,
sizeof|sizeof
name|s
operator|->
name|dk_wds
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_TK_NIN
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|s
operator|->
name|tk_nin
argument_list|,
sizeof|sizeof
name|s
operator|->
name|tk_nin
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_TK_NOUT
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|s
operator|->
name|tk_nout
argument_list|,
sizeof|sizeof
name|s
operator|->
name|tk_nout
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_DK_SEEK
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
name|s
operator|->
name|dk_seek
argument_list|,
sizeof|sizeof
name|s
operator|->
name|dk_seek
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|name
index|[
name|X_NCHSTATS
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|s
operator|->
name|nchstats
argument_list|,
sizeof|sizeof
name|s
operator|->
name|nchstats
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|dinfo
argument_list|(
argument|dn
argument_list|,
argument|c
argument_list|)
end_macro

begin_block
block|{
name|double
name|words
decl_stmt|,
name|atime
decl_stmt|,
name|itime
decl_stmt|,
name|xtime
decl_stmt|;
name|atime
operator|=
name|s
operator|.
name|dk_time
index|[
name|dn
index|]
expr_stmt|;
name|atime
operator|/=
literal|60.0
expr_stmt|;
name|words
operator|=
name|s
operator|.
name|dk_wds
index|[
name|dn
index|]
operator|*
literal|32.0
expr_stmt|;
comment|/* number of words transferred */
name|xtime
operator|=
name|s
operator|.
name|dk_mspw
index|[
name|dn
index|]
operator|*
name|words
expr_stmt|;
comment|/* transfer time */
name|itime
operator|=
name|atime
operator|-
name|xtime
expr_stmt|;
comment|/* time not transferring */
if|if
condition|(
name|xtime
operator|<
literal|0
condition|)
name|itime
operator|+=
name|xtime
operator|,
name|xtime
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|itime
operator|<
literal|0
condition|)
name|xtime
operator|+=
name|itime
operator|,
name|itime
operator|=
literal|0
expr_stmt|;
name|putint
argument_list|(
call|(
name|int
call|)
argument_list|(
operator|(
name|float
operator|)
name|s
operator|.
name|dk_seek
index|[
name|dn
index|]
operator|/
name|etime
operator|+
literal|0.5
argument_list|)
argument_list|,
literal|9
argument_list|,
name|c
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
call|(
name|int
call|)
argument_list|(
operator|(
name|float
operator|)
name|s
operator|.
name|dk_xfer
index|[
name|dn
index|]
operator|/
name|etime
operator|+
literal|0.5
argument_list|)
argument_list|,
literal|10
argument_list|,
name|c
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
call|(
name|int
call|)
argument_list|(
name|words
operator|/
name|etime
operator|/
literal|512.0
operator|+
literal|0.5
argument_list|)
argument_list|,
literal|11
argument_list|,
name|c
argument_list|,
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|.
name|dk_seek
index|[
name|dn
index|]
condition|)
name|putfloat
argument_list|(
name|itime
operator|*
literal|1000.0
operator|/
name|s
operator|.
name|dk_seek
index|[
name|dn
index|]
argument_list|,
literal|12
argument_list|,
name|c
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|putint
argument_list|(
literal|0
argument_list|,
literal|12
argument_list|,
name|c
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


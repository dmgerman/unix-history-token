begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1983, 1989, 1992, 1993  *	The Regents of the University of California.  All rights reserved.  *  * %sccs.include.redist.c%  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)vmstat.c	8.1 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*  * Cursed vmstat -- from Robert Elz.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/dkstat.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"systat.h"
end_include

begin_include
include|#
directive|include
file|"extern.h"
end_include

begin_struct
specifier|static
struct|struct
name|Info
block|{
name|long
name|time
index|[
name|CPUSTATES
index|]
decl_stmt|;
name|struct
name|vmmeter
name|Cnt
decl_stmt|;
name|struct
name|vmtotal
name|Total
decl_stmt|;
name|long
modifier|*
name|dk_time
decl_stmt|;
name|long
modifier|*
name|dk_wds
decl_stmt|;
name|long
modifier|*
name|dk_seek
decl_stmt|;
name|long
modifier|*
name|dk_xfer
decl_stmt|;
name|int
name|dk_busy
decl_stmt|;
name|struct
name|nchstats
name|nchstats
decl_stmt|;
name|long
name|nchcount
decl_stmt|;
name|long
modifier|*
name|intrcnt
decl_stmt|;
block|}
name|s
struct|,
name|s1
struct|,
name|s2
struct|,
name|z
struct|;
end_struct

begin_define
define|#
directive|define
name|cnt
value|s.Cnt
end_define

begin_define
define|#
directive|define
name|oldcnt
value|s1.Cnt
end_define

begin_define
define|#
directive|define
name|total
value|s.Total
end_define

begin_define
define|#
directive|define
name|nchtotal
value|s.nchstats
end_define

begin_define
define|#
directive|define
name|oldnchtotal
value|s1.nchstats
end_define

begin_enum
specifier|static
enum|enum
name|state
block|{
name|BOOT
block|,
name|TIME
block|,
name|RUN
block|}
name|state
init|=
name|TIME
enum|;
end_enum

begin_decl_stmt
specifier|static
name|void
name|allocinfo
name|__P
argument_list|(
operator|(
expr|struct
name|Info
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|copyinfo
name|__P
argument_list|(
operator|(
expr|struct
name|Info
operator|*
operator|,
expr|struct
name|Info
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|float
name|cputime
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|dinfo
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|getinfo
name|__P
argument_list|(
operator|(
expr|struct
name|Info
operator|*
operator|,
expr|enum
name|state
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|putint
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|putfloat
name|__P
argument_list|(
operator|(
name|double
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ucount
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ut
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|buf
index|[
literal|26
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|time_t
name|t
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|double
name|etime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|float
name|hertz
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nintr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
modifier|*
name|intrloc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|intrname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nextintsrow
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|utmp
name|utmp
decl_stmt|;
end_decl_stmt

begin_function
name|WINDOW
modifier|*
name|openkre
parameter_list|()
block|{
name|ut
operator|=
name|open
argument_list|(
name|_PATH_UTMP
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|ut
operator|<
literal|0
condition|)
name|error
argument_list|(
literal|"No utmp"
argument_list|)
expr_stmt|;
return|return
operator|(
name|stdscr
operator|)
return|;
block|}
end_function

begin_function
name|void
name|closekre
parameter_list|(
name|w
parameter_list|)
name|WINDOW
modifier|*
name|w
decl_stmt|;
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|ut
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|==
name|NULL
condition|)
return|return;
name|wclear
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|nlist
name|namelist
index|[]
init|=
block|{
define|#
directive|define
name|X_CPTIME
value|0
block|{
literal|"_cp_time"
block|}
block|,
define|#
directive|define
name|X_CNT
value|1
block|{
literal|"_cnt"
block|}
block|,
define|#
directive|define
name|X_TOTAL
value|2
block|{
literal|"_total"
block|}
block|,
define|#
directive|define
name|X_DK_BUSY
value|3
block|{
literal|"_dk_busy"
block|}
block|,
define|#
directive|define
name|X_DK_TIME
value|4
block|{
literal|"_dk_time"
block|}
block|,
define|#
directive|define
name|X_DK_XFER
value|5
block|{
literal|"_dk_xfer"
block|}
block|,
define|#
directive|define
name|X_DK_WDS
value|6
block|{
literal|"_dk_wds"
block|}
block|,
define|#
directive|define
name|X_DK_SEEK
value|7
block|{
literal|"_dk_seek"
block|}
block|,
define|#
directive|define
name|X_NCHSTATS
value|8
block|{
literal|"_nchstats"
block|}
block|,
define|#
directive|define
name|X_INTRNAMES
value|9
block|{
literal|"_intrnames"
block|}
block|,
define|#
directive|define
name|X_EINTRNAMES
value|10
block|{
literal|"_eintrnames"
block|}
block|,
define|#
directive|define
name|X_INTRCNT
value|11
block|{
literal|"_intrcnt"
block|}
block|,
define|#
directive|define
name|X_EINTRCNT
value|12
block|{
literal|"_eintrcnt"
block|}
block|,
block|{
literal|""
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * These constants define where the major pieces are laid out  */
end_comment

begin_define
define|#
directive|define
name|STATROW
value|0
end_define

begin_comment
comment|/* uses 1 row and 68 cols */
end_comment

begin_define
define|#
directive|define
name|STATCOL
value|2
end_define

begin_define
define|#
directive|define
name|MEMROW
value|2
end_define

begin_comment
comment|/* uses 4 rows and 31 cols */
end_comment

begin_define
define|#
directive|define
name|MEMCOL
value|0
end_define

begin_define
define|#
directive|define
name|PAGEROW
value|2
end_define

begin_comment
comment|/* uses 4 rows and 26 cols */
end_comment

begin_define
define|#
directive|define
name|PAGECOL
value|36
end_define

begin_define
define|#
directive|define
name|INTSROW
value|2
end_define

begin_comment
comment|/* uses all rows to bottom and 17 cols */
end_comment

begin_define
define|#
directive|define
name|INTSCOL
value|63
end_define

begin_define
define|#
directive|define
name|PROCSROW
value|7
end_define

begin_comment
comment|/* uses 2 rows and 20 cols */
end_comment

begin_define
define|#
directive|define
name|PROCSCOL
value|0
end_define

begin_define
define|#
directive|define
name|GENSTATROW
value|7
end_define

begin_comment
comment|/* uses 2 rows and 30 cols */
end_comment

begin_define
define|#
directive|define
name|GENSTATCOL
value|20
end_define

begin_define
define|#
directive|define
name|VMSTATROW
value|7
end_define

begin_comment
comment|/* uses 16 rows and 12 cols */
end_comment

begin_define
define|#
directive|define
name|VMSTATCOL
value|48
end_define

begin_define
define|#
directive|define
name|GRAPHROW
value|10
end_define

begin_comment
comment|/* uses 3 rows and 51 cols */
end_comment

begin_define
define|#
directive|define
name|GRAPHCOL
value|0
end_define

begin_define
define|#
directive|define
name|NAMEIROW
value|14
end_define

begin_comment
comment|/* uses 3 rows and 38 cols */
end_comment

begin_define
define|#
directive|define
name|NAMEICOL
value|0
end_define

begin_define
define|#
directive|define
name|DISKROW
value|18
end_define

begin_comment
comment|/* uses 5 rows and 50 cols (for 9 drives) */
end_comment

begin_define
define|#
directive|define
name|DISKCOL
value|0
end_define

begin_define
define|#
directive|define
name|DRIVESPACE
value|9
end_define

begin_comment
comment|/* max # for space */
end_comment

begin_if
if|#
directive|if
name|DK_NDRIVE
operator|>
name|DRIVESPACE
end_if

begin_define
define|#
directive|define
name|MAXDRIVES
value|DRIVESPACE
end_define

begin_comment
comment|/* max # to display */
end_comment

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|MAXDRIVES
value|DK_NDRIVE
end_define

begin_comment
comment|/* max # to display */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|initkre
parameter_list|()
block|{
name|char
modifier|*
name|intrnamebuf
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|static
name|int
name|once
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|namelist
index|[
literal|0
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|kvm_nlist
argument_list|(
name|kd
argument_list|,
name|namelist
argument_list|)
condition|)
block|{
name|nlisterr
argument_list|(
name|namelist
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|namelist
index|[
literal|0
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"No namelist"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|hertz
operator|=
name|stathz
condition|?
name|stathz
else|:
name|hz
expr_stmt|;
if|if
condition|(
operator|!
name|dkinit
argument_list|()
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|dk_ndrive
operator|&&
operator|!
name|once
condition|)
block|{
define|#
directive|define
name|allocate
parameter_list|(
name|e
parameter_list|,
name|t
parameter_list|)
define|\
value|s.
comment|/**/
value|e = (t *)calloc(dk_ndrive, sizeof (t)); \     s1.
comment|/**/
value|e = (t *)calloc(dk_ndrive, sizeof (t)); \     s2.
comment|/**/
value|e = (t *)calloc(dk_ndrive, sizeof (t)); \     z.
comment|/**/
value|e = (t *)calloc(dk_ndrive, sizeof (t));
name|allocate
argument_list|(
name|dk_time
argument_list|,
name|long
argument_list|)
expr_stmt|;
name|allocate
argument_list|(
name|dk_wds
argument_list|,
name|long
argument_list|)
expr_stmt|;
name|allocate
argument_list|(
name|dk_seek
argument_list|,
name|long
argument_list|)
expr_stmt|;
name|allocate
argument_list|(
name|dk_xfer
argument_list|,
name|long
argument_list|)
expr_stmt|;
name|once
operator|=
literal|1
expr_stmt|;
undef|#
directive|undef
name|allocate
block|}
if|if
condition|(
name|nintr
operator|==
literal|0
condition|)
block|{
name|nintr
operator|=
operator|(
name|namelist
index|[
name|X_EINTRCNT
index|]
operator|.
name|n_value
operator|-
name|namelist
index|[
name|X_INTRCNT
index|]
operator|.
name|n_value
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
name|intrloc
operator|=
name|calloc
argument_list|(
name|nintr
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|intrname
operator|=
name|calloc
argument_list|(
name|nintr
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|intrnamebuf
operator|=
name|malloc
argument_list|(
name|namelist
index|[
name|X_EINTRNAMES
index|]
operator|.
name|n_value
operator|-
name|namelist
index|[
name|X_INTRNAMES
index|]
operator|.
name|n_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|intrnamebuf
operator|==
literal|0
operator|||
name|intrname
operator|==
literal|0
operator|||
name|intrloc
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"Out of memory\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|intrnamebuf
condition|)
name|free
argument_list|(
name|intrnamebuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|intrname
condition|)
name|free
argument_list|(
name|intrname
argument_list|)
expr_stmt|;
if|if
condition|(
name|intrloc
condition|)
name|free
argument_list|(
name|intrloc
argument_list|)
expr_stmt|;
name|nintr
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NREAD
argument_list|(
name|X_INTRNAMES
argument_list|,
name|intrnamebuf
argument_list|,
name|NVAL
argument_list|(
name|X_EINTRNAMES
argument_list|)
operator|-
name|NVAL
argument_list|(
name|X_INTRNAMES
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|intrnamebuf
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nintr
condition|;
name|i
operator|++
control|)
block|{
name|intrname
index|[
name|i
index|]
operator|=
name|cp
expr_stmt|;
name|cp
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
name|nextintsrow
operator|=
name|INTSROW
operator|+
literal|2
expr_stmt|;
name|allocinfo
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
name|allocinfo
argument_list|(
operator|&
name|s1
argument_list|)
expr_stmt|;
name|allocinfo
argument_list|(
operator|&
name|s2
argument_list|)
expr_stmt|;
name|allocinfo
argument_list|(
operator|&
name|z
argument_list|)
expr_stmt|;
block|}
name|getinfo
argument_list|(
operator|&
name|s2
argument_list|,
name|RUN
argument_list|)
expr_stmt|;
name|copyinfo
argument_list|(
operator|&
name|s2
argument_list|,
operator|&
name|s1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|void
name|fetchkre
parameter_list|()
block|{
name|time_t
name|now
decl_stmt|;
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|buf
argument_list|,
name|ctime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|buf
index|[
literal|16
index|]
operator|=
literal|'\0'
expr_stmt|;
name|getinfo
argument_list|(
operator|&
name|s
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|labelkre
parameter_list|()
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
name|STATROW
argument_list|,
name|STATCOL
operator|+
literal|4
argument_list|,
literal|"users    Load"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|MEMROW
argument_list|,
name|MEMCOL
argument_list|,
literal|"Mem:KB  REAL        VIRTUAL"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|MEMROW
operator|+
literal|1
argument_list|,
name|MEMCOL
argument_list|,
literal|"      Tot Share    Tot  Share"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
argument_list|,
literal|"Act"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|MEMROW
operator|+
literal|3
argument_list|,
name|MEMCOL
argument_list|,
literal|"All"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|MEMROW
operator|+
literal|1
argument_list|,
name|MEMCOL
operator|+
literal|31
argument_list|,
literal|"Free"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|PAGEROW
argument_list|,
name|PAGECOL
argument_list|,
literal|"        PAGING   SWAPPING "
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|PAGEROW
operator|+
literal|1
argument_list|,
name|PAGECOL
argument_list|,
literal|"        in  out   in  out "
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|PAGEROW
operator|+
literal|2
argument_list|,
name|PAGECOL
argument_list|,
literal|"count"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|PAGEROW
operator|+
literal|3
argument_list|,
name|PAGECOL
argument_list|,
literal|"pages"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|INTSROW
argument_list|,
name|INTSCOL
operator|+
literal|3
argument_list|,
literal|" Interrupts"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|INTSROW
operator|+
literal|1
argument_list|,
name|INTSCOL
operator|+
literal|9
argument_list|,
literal|"total"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"vmflt"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|1
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"cow"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|2
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"objlk"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|3
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"objht"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|4
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"zfod"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|5
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"nzfod"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|6
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"%%zfod"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|7
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"kern"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|8
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"wire"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|9
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"act"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|10
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"inact"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|11
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"free"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|12
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"daefr"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|13
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"prcfr"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|14
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"react"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|15
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"scan"
argument_list|)
expr_stmt|;
if|if
condition|(
name|LINES
operator|-
literal|1
operator|>
name|VMSTATROW
operator|+
literal|16
condition|)
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|16
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"hdrev"
argument_list|)
expr_stmt|;
if|if
condition|(
name|LINES
operator|-
literal|1
operator|>
name|VMSTATROW
operator|+
literal|17
condition|)
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|17
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"intrn"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|GENSTATROW
argument_list|,
name|GENSTATCOL
argument_list|,
literal|"  Csw  Trp  Sys  Int  Sof  Flt"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|GRAPHROW
argument_list|,
name|GRAPHCOL
argument_list|,
literal|"    . %% Sys    . %% User    . %% Nice    . %% Idle"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|PROCSROW
argument_list|,
name|PROCSCOL
argument_list|,
literal|"Proc:r  p  d  s  w"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|GRAPHROW
operator|+
literal|1
argument_list|,
name|GRAPHCOL
argument_list|,
literal|"|    |    |    |    |    |    |    |    |    |    |"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|NAMEIROW
argument_list|,
name|NAMEICOL
argument_list|,
literal|"Namei         Sys-cache     Proc-cache"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|NAMEIROW
operator|+
literal|1
argument_list|,
name|NAMEICOL
argument_list|,
literal|"    Calls     hits    %%     hits     %%"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
argument_list|,
name|DISKCOL
argument_list|,
literal|"Discs"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
operator|+
literal|1
argument_list|,
name|DISKCOL
argument_list|,
literal|"seeks"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
operator|+
literal|2
argument_list|,
name|DISKCOL
argument_list|,
literal|"xfers"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
operator|+
literal|3
argument_list|,
name|DISKCOL
argument_list|,
literal|" blks"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
operator|+
literal|4
argument_list|,
name|DISKCOL
argument_list|,
literal|" msps"
argument_list|)
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dk_ndrive
operator|&&
name|j
operator|<
name|MAXDRIVES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|dk_select
index|[
name|i
index|]
condition|)
block|{
name|mvprintw
argument_list|(
name|DISKROW
argument_list|,
name|DISKCOL
operator|+
literal|5
operator|+
literal|5
operator|*
name|j
argument_list|,
literal|"  %3.3s"
argument_list|,
name|dr_name
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nintr
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|intrloc
index|[
name|i
index|]
operator|==
literal|0
condition|)
continue|continue;
name|mvprintw
argument_list|(
name|intrloc
index|[
name|i
index|]
argument_list|,
name|INTSCOL
operator|+
literal|9
argument_list|,
literal|"%-8.8s"
argument_list|,
name|intrname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|X
parameter_list|(
name|fld
parameter_list|)
value|{t=s.fld[i]; s.fld[i]-=s1.fld[i]; if(state==TIME) s1.fld[i]=t;}
end_define

begin_define
define|#
directive|define
name|Y
parameter_list|(
name|fld
parameter_list|)
value|{t = s.fld; s.fld -= s1.fld; if(state == TIME) s1.fld = t;}
end_define

begin_define
define|#
directive|define
name|Z
parameter_list|(
name|fld
parameter_list|)
value|{t = s.nchstats.fld; s.nchstats.fld -= s1.nchstats.fld; \ 	if(state == TIME) s1.nchstats.fld = t;}
end_define

begin_define
define|#
directive|define
name|PUTRATE
parameter_list|(
name|fld
parameter_list|,
name|l
parameter_list|,
name|c
parameter_list|,
name|w
parameter_list|)
define|\
value|Y(fld); \ 	putint((int)((float)s.fld/etime + 0.5), l, c, w)
end_define

begin_define
define|#
directive|define
name|MAXFAIL
value|5
end_define

begin_decl_stmt
specifier|static
name|char
name|cpuchar
index|[
name|CPUSTATES
index|]
init|=
block|{
literal|'='
block|,
literal|'>'
block|,
literal|'-'
block|,
literal|' '
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|cpuorder
index|[
name|CPUSTATES
index|]
init|=
block|{
name|CP_SYS
block|,
name|CP_USER
block|,
name|CP_NICE
block|,
name|CP_IDLE
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|showkre
parameter_list|()
block|{
name|float
name|f1
decl_stmt|,
name|f2
decl_stmt|;
name|int
name|psiz
decl_stmt|,
name|inttotal
decl_stmt|;
name|int
name|i
decl_stmt|,
name|l
decl_stmt|,
name|c
decl_stmt|;
specifier|static
name|int
name|failcnt
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dk_ndrive
condition|;
name|i
operator|++
control|)
block|{
name|X
argument_list|(
name|dk_xfer
argument_list|)
expr_stmt|;
name|X
argument_list|(
name|dk_seek
argument_list|)
expr_stmt|;
name|X
argument_list|(
name|dk_wds
argument_list|)
expr_stmt|;
name|X
argument_list|(
name|dk_time
argument_list|)
expr_stmt|;
block|}
name|etime
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPUSTATES
condition|;
name|i
operator|++
control|)
block|{
name|X
argument_list|(
name|time
argument_list|)
expr_stmt|;
name|etime
operator|+=
name|s
operator|.
name|time
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|etime
operator|<
literal|5.0
condition|)
block|{
comment|/*< 5 ticks - ignore this trash */
if|if
condition|(
name|failcnt
operator|++
operator|>=
name|MAXFAIL
condition|)
block|{
name|clear
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
literal|2
argument_list|,
literal|10
argument_list|,
literal|"The alternate system clock has died!"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|3
argument_list|,
literal|10
argument_list|,
literal|"Reverting to ``pigs'' display."
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|CMDLINE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
name|failcnt
operator|=
literal|0
expr_stmt|;
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|command
argument_list|(
literal|"pigs"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|failcnt
operator|=
literal|0
expr_stmt|;
name|etime
operator|/=
name|hertz
expr_stmt|;
name|inttotal
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nintr
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|s
operator|.
name|intrcnt
index|[
name|i
index|]
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|intrloc
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|nextintsrow
operator|==
name|LINES
condition|)
continue|continue;
name|intrloc
index|[
name|i
index|]
operator|=
name|nextintsrow
operator|++
expr_stmt|;
name|mvprintw
argument_list|(
name|intrloc
index|[
name|i
index|]
argument_list|,
name|INTSCOL
operator|+
literal|9
argument_list|,
literal|"%-8.8s"
argument_list|,
name|intrname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|X
argument_list|(
name|intrcnt
argument_list|)
expr_stmt|;
name|l
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|float
operator|)
name|s
operator|.
name|intrcnt
index|[
name|i
index|]
operator|/
name|etime
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|inttotal
operator|+=
name|l
expr_stmt|;
name|putint
argument_list|(
name|l
argument_list|,
name|intrloc
index|[
name|i
index|]
argument_list|,
name|INTSCOL
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
name|putint
argument_list|(
name|inttotal
argument_list|,
name|INTSROW
operator|+
literal|1
argument_list|,
name|INTSCOL
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_goodhits
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_badhits
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_miss
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_long
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_pass2
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_2passes
argument_list|)
expr_stmt|;
name|s
operator|.
name|nchcount
operator|=
name|nchtotal
operator|.
name|ncs_goodhits
operator|+
name|nchtotal
operator|.
name|ncs_badhits
operator|+
name|nchtotal
operator|.
name|ncs_miss
operator|+
name|nchtotal
operator|.
name|ncs_long
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|TIME
condition|)
name|s1
operator|.
name|nchcount
operator|=
name|s
operator|.
name|nchcount
expr_stmt|;
name|psiz
operator|=
literal|0
expr_stmt|;
name|f2
operator|=
literal|0.0
expr_stmt|;
comment|/*  	 * Last CPU state not calculated yet. 	 */
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|CPUSTATES
operator|-
literal|1
condition|;
name|c
operator|++
control|)
block|{
name|i
operator|=
name|cpuorder
index|[
name|c
index|]
expr_stmt|;
name|f1
operator|=
name|cputime
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|f2
operator|+=
name|f1
expr_stmt|;
name|l
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|f2
operator|+
literal|1.0
operator|)
operator|/
literal|2.0
argument_list|)
operator|-
name|psiz
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
condition|)
name|putfloat
argument_list|(
name|f1
argument_list|,
name|GRAPHROW
argument_list|,
name|GRAPHCOL
operator|+
literal|1
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|putfloat
argument_list|(
name|f1
argument_list|,
name|GRAPHROW
argument_list|,
name|GRAPHCOL
operator|+
literal|12
operator|*
name|c
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|GRAPHROW
operator|+
literal|2
argument_list|,
name|psiz
argument_list|)
expr_stmt|;
name|psiz
operator|+=
name|l
expr_stmt|;
while|while
condition|(
name|l
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
name|cpuchar
index|[
name|c
index|]
argument_list|)
expr_stmt|;
block|}
name|putint
argument_list|(
name|ucount
argument_list|()
argument_list|,
name|STATROW
argument_list|,
name|STATCOL
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|avenrun
index|[
literal|0
index|]
argument_list|,
name|STATROW
argument_list|,
name|STATCOL
operator|+
literal|17
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|avenrun
index|[
literal|1
index|]
argument_list|,
name|STATROW
argument_list|,
name|STATCOL
operator|+
literal|23
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|avenrun
index|[
literal|2
index|]
argument_list|,
name|STATROW
argument_list|,
name|STATCOL
operator|+
literal|29
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|STATROW
argument_list|,
name|STATCOL
operator|+
literal|53
argument_list|,
name|buf
argument_list|)
expr_stmt|;
define|#
directive|define
name|pgtokb
parameter_list|(
name|pg
parameter_list|)
value|((pg) * cnt.v_page_size / 1024)
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_arm
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
operator|+
literal|3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_armshr
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
operator|+
literal|9
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_avm
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
operator|+
literal|15
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_avmshr
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
operator|+
literal|22
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_rm
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|3
argument_list|,
name|MEMCOL
operator|+
literal|3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_rmshr
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|3
argument_list|,
name|MEMCOL
operator|+
literal|9
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_vm
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|3
argument_list|,
name|MEMCOL
operator|+
literal|15
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_vmshr
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|3
argument_list|,
name|MEMCOL
operator|+
literal|22
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_free
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
operator|+
literal|29
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_rq
operator|-
literal|1
argument_list|,
name|PROCSROW
operator|+
literal|1
argument_list|,
name|PROCSCOL
operator|+
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_pw
argument_list|,
name|PROCSROW
operator|+
literal|1
argument_list|,
name|PROCSCOL
operator|+
literal|6
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_dw
argument_list|,
name|PROCSROW
operator|+
literal|1
argument_list|,
name|PROCSCOL
operator|+
literal|9
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_sl
argument_list|,
name|PROCSROW
operator|+
literal|1
argument_list|,
name|PROCSCOL
operator|+
literal|12
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_sw
argument_list|,
name|PROCSROW
operator|+
literal|1
argument_list|,
name|PROCSCOL
operator|+
literal|15
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_vm_faults
argument_list|,
name|VMSTATROW
argument_list|,
name|VMSTATCOL
operator|+
literal|3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_cow_faults
argument_list|,
name|VMSTATROW
operator|+
literal|1
argument_list|,
name|VMSTATCOL
operator|+
literal|3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_lookups
argument_list|,
name|VMSTATROW
operator|+
literal|2
argument_list|,
name|VMSTATCOL
operator|+
literal|3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_hits
argument_list|,
name|VMSTATROW
operator|+
literal|3
argument_list|,
name|VMSTATCOL
operator|+
literal|3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_zfod
argument_list|,
name|VMSTATROW
operator|+
literal|4
argument_list|,
name|VMSTATCOL
operator|+
literal|4
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_nzfod
argument_list|,
name|VMSTATROW
operator|+
literal|5
argument_list|,
name|VMSTATCOL
operator|+
literal|3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|cnt
operator|.
name|v_nzfod
operator|==
literal|0
condition|?
literal|0.0
else|:
operator|(
literal|100.0
operator|*
name|cnt
operator|.
name|v_zfod
operator|/
name|cnt
operator|.
name|v_nzfod
operator|)
argument_list|,
name|VMSTATROW
operator|+
literal|6
argument_list|,
name|VMSTATCOL
operator|+
literal|2
argument_list|,
literal|7
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|cnt
operator|.
name|v_kernel_pages
argument_list|)
argument_list|,
name|VMSTATROW
operator|+
literal|7
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|cnt
operator|.
name|v_wire_count
argument_list|)
argument_list|,
name|VMSTATROW
operator|+
literal|8
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|cnt
operator|.
name|v_active_count
argument_list|)
argument_list|,
name|VMSTATROW
operator|+
literal|9
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|cnt
operator|.
name|v_inactive_count
argument_list|)
argument_list|,
name|VMSTATROW
operator|+
literal|10
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|cnt
operator|.
name|v_free_count
argument_list|)
argument_list|,
name|VMSTATROW
operator|+
literal|11
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_dfree
argument_list|,
name|VMSTATROW
operator|+
literal|12
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_pfree
argument_list|,
name|VMSTATROW
operator|+
literal|13
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_reactivated
argument_list|,
name|VMSTATROW
operator|+
literal|14
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_scan
argument_list|,
name|VMSTATROW
operator|+
literal|15
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
if|if
condition|(
name|LINES
operator|-
literal|1
operator|>
name|VMSTATROW
operator|+
literal|16
condition|)
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_rev
argument_list|,
name|VMSTATROW
operator|+
literal|16
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
if|if
condition|(
name|LINES
operator|-
literal|1
operator|>
name|VMSTATROW
operator|+
literal|17
condition|)
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_intrans
argument_list|,
name|VMSTATROW
operator|+
literal|17
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_pageins
argument_list|,
name|PAGEROW
operator|+
literal|2
argument_list|,
name|PAGECOL
operator|+
literal|5
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_pageouts
argument_list|,
name|PAGEROW
operator|+
literal|2
argument_list|,
name|PAGECOL
operator|+
literal|10
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_swpin
argument_list|,
name|PAGEROW
operator|+
literal|2
argument_list|,
name|PAGECOL
operator|+
literal|15
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* - */
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_swpout
argument_list|,
name|PAGEROW
operator|+
literal|2
argument_list|,
name|PAGECOL
operator|+
literal|20
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* - */
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_pgpgin
argument_list|,
name|PAGEROW
operator|+
literal|3
argument_list|,
name|PAGECOL
operator|+
literal|5
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* ? */
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_pgpgout
argument_list|,
name|PAGEROW
operator|+
literal|3
argument_list|,
name|PAGECOL
operator|+
literal|10
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* ? */
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_pswpin
argument_list|,
name|PAGEROW
operator|+
literal|3
argument_list|,
name|PAGECOL
operator|+
literal|15
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* - */
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_pswpout
argument_list|,
name|PAGEROW
operator|+
literal|3
argument_list|,
name|PAGECOL
operator|+
literal|20
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* - */
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_swtch
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_trap
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
operator|+
literal|5
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_syscall
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
operator|+
literal|10
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_intr
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
operator|+
literal|15
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_soft
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
operator|+
literal|20
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/*	PUTRATE(Cnt.v_faults, GENSTATROW + 1, GENSTATCOL + 25, 5);*/
name|mvprintw
argument_list|(
name|DISKROW
argument_list|,
name|DISKCOL
operator|+
literal|5
argument_list|,
literal|"                              "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|c
operator|=
literal|0
init|;
name|i
operator|<
name|dk_ndrive
operator|&&
name|c
operator|<
name|MAXDRIVES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|dk_select
index|[
name|i
index|]
condition|)
block|{
name|mvprintw
argument_list|(
name|DISKROW
argument_list|,
name|DISKCOL
operator|+
literal|5
operator|+
literal|5
operator|*
name|c
argument_list|,
literal|"  %3.3s"
argument_list|,
name|dr_name
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|dinfo
argument_list|(
name|i
argument_list|,
operator|++
name|c
argument_list|)
expr_stmt|;
block|}
name|putint
argument_list|(
name|s
operator|.
name|nchcount
argument_list|,
name|NAMEIROW
operator|+
literal|2
argument_list|,
name|NAMEICOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|nchtotal
operator|.
name|ncs_goodhits
argument_list|,
name|NAMEIROW
operator|+
literal|2
argument_list|,
name|NAMEICOL
operator|+
literal|9
argument_list|,
literal|9
argument_list|)
expr_stmt|;
define|#
directive|define
name|nz
parameter_list|(
name|x
parameter_list|)
value|((x) ? (x) : 1)
name|putfloat
argument_list|(
name|nchtotal
operator|.
name|ncs_goodhits
operator|*
literal|100.0
operator|/
name|nz
argument_list|(
name|s
operator|.
name|nchcount
argument_list|)
argument_list|,
name|NAMEIROW
operator|+
literal|2
argument_list|,
name|NAMEICOL
operator|+
literal|19
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|nchtotal
operator|.
name|ncs_pass2
argument_list|,
name|NAMEIROW
operator|+
literal|2
argument_list|,
name|NAMEICOL
operator|+
literal|23
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|nchtotal
operator|.
name|ncs_pass2
operator|*
literal|100.0
operator|/
name|nz
argument_list|(
name|s
operator|.
name|nchcount
argument_list|)
argument_list|,
name|NAMEIROW
operator|+
literal|2
argument_list|,
name|NAMEICOL
operator|+
literal|34
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|nz
block|}
end_function

begin_function
name|int
name|cmdkre
parameter_list|(
name|cmd
parameter_list|,
name|args
parameter_list|)
name|char
modifier|*
name|cmd
decl_stmt|,
decl|*
name|args
decl_stmt|;
end_function

begin_block
block|{
if|if
condition|(
name|prefix
argument_list|(
name|cmd
argument_list|,
literal|"run"
argument_list|)
condition|)
block|{
name|copyinfo
argument_list|(
operator|&
name|s2
argument_list|,
operator|&
name|s1
argument_list|)
expr_stmt|;
name|state
operator|=
name|RUN
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|prefix
argument_list|(
name|cmd
argument_list|,
literal|"boot"
argument_list|)
condition|)
block|{
name|state
operator|=
name|BOOT
expr_stmt|;
name|copyinfo
argument_list|(
operator|&
name|z
argument_list|,
operator|&
name|s1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|prefix
argument_list|(
name|cmd
argument_list|,
literal|"time"
argument_list|)
condition|)
block|{
name|state
operator|=
name|TIME
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|prefix
argument_list|(
name|cmd
argument_list|,
literal|"zero"
argument_list|)
condition|)
block|{
if|if
condition|(
name|state
operator|==
name|RUN
condition|)
name|getinfo
argument_list|(
operator|&
name|s1
argument_list|,
name|RUN
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|dkcmd
argument_list|(
name|cmd
argument_list|,
name|args
argument_list|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/* calculate number of users on the system */
end_comment

begin_function
specifier|static
name|int
name|ucount
parameter_list|()
block|{
specifier|register
name|int
name|nusers
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ut
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
name|read
argument_list|(
name|ut
argument_list|,
operator|&
name|utmp
argument_list|,
sizeof|sizeof
argument_list|(
name|utmp
argument_list|)
argument_list|)
condition|)
if|if
condition|(
name|utmp
operator|.
name|ut_name
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|nusers
operator|++
expr_stmt|;
name|lseek
argument_list|(
name|ut
argument_list|,
literal|0L
argument_list|,
name|L_SET
argument_list|)
expr_stmt|;
return|return
operator|(
name|nusers
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|float
name|cputime
parameter_list|(
name|indx
parameter_list|)
name|int
name|indx
decl_stmt|;
block|{
name|double
name|t
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|t
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPUSTATES
condition|;
name|i
operator|++
control|)
name|t
operator|+=
name|s
operator|.
name|time
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|t
operator|==
literal|0.0
condition|)
name|t
operator|=
literal|1.0
expr_stmt|;
return|return
operator|(
name|s
operator|.
name|time
index|[
name|indx
index|]
operator|*
literal|100.0
operator|/
name|t
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|putint
parameter_list|(
name|n
parameter_list|,
name|l
parameter_list|,
name|c
parameter_list|,
name|w
parameter_list|)
name|int
name|n
decl_stmt|,
name|l
decl_stmt|,
name|c
decl_stmt|,
name|w
decl_stmt|;
block|{
name|char
name|b
index|[
literal|128
index|]
decl_stmt|;
name|move
argument_list|(
name|l
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
while|while
condition|(
name|w
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
return|return;
block|}
name|sprintf
argument_list|(
name|b
argument_list|,
literal|"%*d"
argument_list|,
name|w
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|b
argument_list|)
operator|>
name|w
condition|)
block|{
while|while
condition|(
name|w
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
return|return;
block|}
name|addstr
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|putfloat
parameter_list|(
name|f
parameter_list|,
name|l
parameter_list|,
name|c
parameter_list|,
name|w
parameter_list|,
name|d
parameter_list|,
name|nz
parameter_list|)
name|double
name|f
decl_stmt|;
name|int
name|l
decl_stmt|,
name|c
decl_stmt|,
name|w
decl_stmt|,
name|d
decl_stmt|,
name|nz
decl_stmt|;
block|{
name|char
name|b
index|[
literal|128
index|]
decl_stmt|;
name|move
argument_list|(
name|l
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|nz
operator|&&
name|f
operator|==
literal|0.0
condition|)
block|{
while|while
condition|(
operator|--
name|w
operator|>=
literal|0
condition|)
name|addch
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
return|return;
block|}
name|sprintf
argument_list|(
name|b
argument_list|,
literal|"%*.*f"
argument_list|,
name|w
argument_list|,
name|d
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|b
argument_list|)
operator|>
name|w
condition|)
block|{
while|while
condition|(
operator|--
name|w
operator|>=
literal|0
condition|)
name|addch
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
return|return;
block|}
name|addstr
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|getinfo
parameter_list|(
name|s
parameter_list|,
name|st
parameter_list|)
name|struct
name|Info
modifier|*
name|s
decl_stmt|;
name|enum
name|state
name|st
decl_stmt|;
block|{
name|int
name|mib
index|[
literal|2
index|]
decl_stmt|,
name|size
decl_stmt|;
specifier|extern
name|int
name|errno
decl_stmt|;
name|NREAD
argument_list|(
name|X_CPTIME
argument_list|,
name|s
operator|->
name|time
argument_list|,
sizeof|sizeof
name|s
operator|->
name|time
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_CNT
argument_list|,
operator|&
name|s
operator|->
name|Cnt
argument_list|,
sizeof|sizeof
name|s
operator|->
name|Cnt
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_DK_BUSY
argument_list|,
operator|&
name|s
operator|->
name|dk_busy
argument_list|,
name|LONG
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_DK_TIME
argument_list|,
name|s
operator|->
name|dk_time
argument_list|,
name|dk_ndrive
operator|*
name|LONG
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_DK_XFER
argument_list|,
name|s
operator|->
name|dk_xfer
argument_list|,
name|dk_ndrive
operator|*
name|LONG
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_DK_WDS
argument_list|,
name|s
operator|->
name|dk_wds
argument_list|,
name|dk_ndrive
operator|*
name|LONG
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_DK_SEEK
argument_list|,
name|s
operator|->
name|dk_seek
argument_list|,
name|dk_ndrive
operator|*
name|LONG
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_NCHSTATS
argument_list|,
operator|&
name|s
operator|->
name|nchstats
argument_list|,
sizeof|sizeof
name|s
operator|->
name|nchstats
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_INTRCNT
argument_list|,
name|s
operator|->
name|intrcnt
argument_list|,
name|nintr
operator|*
name|LONG
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|s
operator|->
name|Total
argument_list|)
expr_stmt|;
name|mib
index|[
literal|0
index|]
operator|=
name|CTL_VM
expr_stmt|;
name|mib
index|[
literal|1
index|]
operator|=
name|VM_METER
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
literal|2
argument_list|,
operator|&
name|s
operator|->
name|Total
argument_list|,
operator|&
name|size
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"Can't get kernel info: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|s
operator|->
name|Total
argument_list|,
sizeof|sizeof
argument_list|(
name|s
operator|->
name|Total
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|allocinfo
parameter_list|(
name|s
parameter_list|)
name|struct
name|Info
modifier|*
name|s
decl_stmt|;
block|{
name|s
operator|->
name|intrcnt
operator|=
operator|(
name|long
operator|*
operator|)
name|malloc
argument_list|(
name|nintr
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|intrcnt
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"systat: out of memory\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|copyinfo
parameter_list|(
name|from
parameter_list|,
name|to
parameter_list|)
specifier|register
name|struct
name|Info
modifier|*
name|from
decl_stmt|,
decl|*
name|to
decl_stmt|;
end_function

begin_block
block|{
name|long
modifier|*
name|time
decl_stmt|,
modifier|*
name|wds
decl_stmt|,
modifier|*
name|seek
decl_stmt|,
modifier|*
name|xfer
decl_stmt|;
name|long
modifier|*
name|intrcnt
decl_stmt|;
comment|/* 	 * time, wds, seek, and xfer are malloc'd so we have to 	 * save the pointers before the structure copy and then  	 * copy by hand. 	 */
name|time
operator|=
name|to
operator|->
name|dk_time
expr_stmt|;
name|wds
operator|=
name|to
operator|->
name|dk_wds
expr_stmt|;
name|seek
operator|=
name|to
operator|->
name|dk_seek
expr_stmt|;
name|xfer
operator|=
name|to
operator|->
name|dk_xfer
expr_stmt|;
name|intrcnt
operator|=
name|to
operator|->
name|intrcnt
expr_stmt|;
operator|*
name|to
operator|=
operator|*
name|from
expr_stmt|;
name|bcopy
argument_list|(
name|from
operator|->
name|dk_time
argument_list|,
name|to
operator|->
name|dk_time
operator|=
name|time
argument_list|,
name|dk_ndrive
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|from
operator|->
name|dk_wds
argument_list|,
name|to
operator|->
name|dk_wds
operator|=
name|wds
argument_list|,
name|dk_ndrive
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|from
operator|->
name|dk_seek
argument_list|,
name|to
operator|->
name|dk_seek
operator|=
name|seek
argument_list|,
name|dk_ndrive
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|from
operator|->
name|dk_xfer
argument_list|,
name|to
operator|->
name|dk_xfer
operator|=
name|xfer
argument_list|,
name|dk_ndrive
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|from
operator|->
name|intrcnt
argument_list|,
name|to
operator|->
name|intrcnt
operator|=
name|intrcnt
argument_list|,
name|nintr
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|void
name|dinfo
parameter_list|(
name|dn
parameter_list|,
name|c
parameter_list|)
name|int
name|dn
decl_stmt|,
name|c
decl_stmt|;
block|{
name|double
name|words
decl_stmt|,
name|atime
decl_stmt|,
name|itime
decl_stmt|,
name|xtime
decl_stmt|;
name|c
operator|=
name|DISKCOL
operator|+
name|c
operator|*
literal|5
expr_stmt|;
name|atime
operator|=
name|s
operator|.
name|dk_time
index|[
name|dn
index|]
expr_stmt|;
name|atime
operator|/=
name|hertz
expr_stmt|;
name|words
operator|=
name|s
operator|.
name|dk_wds
index|[
name|dn
index|]
operator|*
literal|32.0
expr_stmt|;
comment|/* number of words transferred */
name|xtime
operator|=
name|dk_mspw
index|[
name|dn
index|]
operator|*
name|words
expr_stmt|;
comment|/* transfer time */
name|itime
operator|=
name|atime
operator|-
name|xtime
expr_stmt|;
comment|/* time not transferring */
if|if
condition|(
name|xtime
operator|<
literal|0
condition|)
name|itime
operator|+=
name|xtime
operator|,
name|xtime
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|itime
operator|<
literal|0
condition|)
name|xtime
operator|+=
name|itime
operator|,
name|itime
operator|=
literal|0
expr_stmt|;
name|putint
argument_list|(
call|(
name|int
call|)
argument_list|(
operator|(
name|float
operator|)
name|s
operator|.
name|dk_seek
index|[
name|dn
index|]
operator|/
name|etime
operator|+
literal|0.5
argument_list|)
argument_list|,
name|DISKROW
operator|+
literal|1
argument_list|,
name|c
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
call|(
name|int
call|)
argument_list|(
operator|(
name|float
operator|)
name|s
operator|.
name|dk_xfer
index|[
name|dn
index|]
operator|/
name|etime
operator|+
literal|0.5
argument_list|)
argument_list|,
name|DISKROW
operator|+
literal|2
argument_list|,
name|c
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|putint
argument_list|(
call|(
name|int
call|)
argument_list|(
name|words
operator|/
name|etime
operator|/
literal|512.0
operator|+
literal|0.5
argument_list|)
argument_list|,
name|DISKROW
operator|+
literal|3
argument_list|,
name|c
argument_list|,
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|.
name|dk_seek
index|[
name|dn
index|]
condition|)
name|putfloat
argument_list|(
name|itime
operator|*
literal|1000.0
operator|/
name|s
operator|.
name|dk_seek
index|[
name|dn
index|]
argument_list|,
name|DISKROW
operator|+
literal|4
argument_list|,
name|c
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|putint
argument_list|(
literal|0
argument_list|,
name|DISKROW
operator|+
literal|4
argument_list|,
name|c
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


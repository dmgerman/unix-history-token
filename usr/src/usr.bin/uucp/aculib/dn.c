begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)dn.c	4.3 (Berkeley) 2/24/88"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"../condevs.h"
end_include

begin_define
define|#
directive|define
name|ACULAST
value|"-<"
end_define

begin_comment
comment|/***  *	dnopn(ph, flds, dev)	dial remote machine  *  *	return codes:  *		file descriptor  -  succeeded  *		FAIL  -  failed  */
end_comment

begin_macro
name|dnopn
argument_list|(
argument|ph
argument_list|,
argument|flds
argument_list|,
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|ph
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|flds
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|Devices
modifier|*
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|dcname
index|[
literal|20
index|]
decl_stmt|,
name|dnname
index|[
literal|20
index|]
decl_stmt|,
name|phone
index|[
name|MAXPH
operator|+
literal|2
index|]
decl_stmt|,
name|c
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|USG
name|struct
name|termio
name|ttbuf
decl_stmt|;
endif|#
directive|endif
endif|USG
name|int
name|dnf
decl_stmt|,
name|dcf
decl_stmt|;
name|int
name|nw
decl_stmt|,
name|lt
decl_stmt|,
name|pid
decl_stmt|,
name|status
decl_stmt|;
name|unsigned
name|timelim
decl_stmt|;
ifdef|#
directive|ifdef
name|TIOCFLUSH
name|int
name|zero
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
endif|TIOCFLUSH
name|sprintf
argument_list|(
name|dnname
argument_list|,
literal|"/dev/%s"
argument_list|,
name|dev
operator|->
name|D_calldev
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|Sjbuf
argument_list|)
condition|)
block|{
name|logent
argument_list|(
name|dnname
argument_list|,
literal|"CAN'T OPEN"
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"%s Open timed out\n"
argument_list|,
name|dnname
argument_list|)
expr_stmt|;
return|return
operator|(
name|CF_NODEV
operator|)
return|;
block|}
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|alarmtr
argument_list|)
expr_stmt|;
name|getnextfd
argument_list|()
expr_stmt|;
name|alarm
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|dnf
operator|=
name|open
argument_list|(
name|dnname
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|next_fd
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|dnf
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EACCES
condition|)
block|{
name|logent
argument_list|(
name|dnname
argument_list|,
literal|"CAN'T OPEN"
argument_list|)
expr_stmt|;
name|logent
argument_list|(
literal|"DEVICE"
argument_list|,
literal|"NO"
argument_list|)
expr_stmt|;
return|return
name|CF_NODEV
return|;
block|}
name|fioclex
argument_list|(
name|dnf
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|dcname
argument_list|,
literal|"/dev/%s"
argument_list|,
name|dev
operator|->
name|D_line
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|phone
argument_list|,
literal|"%s%s"
argument_list|,
name|ph
argument_list|,
name|ACULAST
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"dc - %s, "
argument_list|,
name|dcname
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"acu - %s\n"
argument_list|,
name|dnname
argument_list|)
expr_stmt|;
name|pid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|Sjbuf
argument_list|)
condition|)
block|{
name|logent
argument_list|(
literal|"DIALUP DN write"
argument_list|,
literal|"TIMEOUT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
condition|)
name|kill
argument_list|(
name|pid
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|delock
argument_list|(
name|dev
operator|->
name|D_line
argument_list|)
expr_stmt|;
if|if
condition|(
name|dnf
condition|)
name|close
argument_list|(
name|dnf
argument_list|)
expr_stmt|;
return|return
name|CF_DIAL
return|;
block|}
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|alarmtr
argument_list|)
expr_stmt|;
name|timelim
operator|=
literal|5
operator|*
name|strlen
argument_list|(
name|phone
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
name|timelim
operator|<
literal|30
condition|?
literal|30
else|:
name|timelim
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIOCFLUSH
name|ioctl
argument_list|(
name|dnf
argument_list|,
name|TIOCFLUSH
argument_list|,
operator|&
name|zero
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|TIOCFLUSH
name|nw
operator|=
name|write
argument_list|(
name|dnf
argument_list|,
name|phone
argument_list|,
name|lt
operator|=
name|strlen
argument_list|(
name|phone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nw
operator|!=
name|lt
condition|)
block|{
name|logent
argument_list|(
literal|"DIALUP ACU write"
argument_list|,
name|_FAILED
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"ACU write ok\n"
argument_list|,
name|CNULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/*  open line - will return on carrier */
comment|/* RT needs a sleep here because it returns immediately from open */
if|#
directive|if
name|RT
name|sleep
argument_list|(
literal|15
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|getnextfd
argument_list|()
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|dcf
operator|=
name|open
argument_list|(
name|dcname
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|next_fd
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|dcf
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EACCES
condition|)
name|logent
argument_list|(
name|dcname
argument_list|,
literal|"CAN'T OPEN"
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"dcf is %d\n"
argument_list|,
name|dcf
argument_list|)
expr_stmt|;
if|if
condition|(
name|dcf
operator|<
literal|0
condition|)
block|{
name|logent
argument_list|(
literal|"DIALUP LINE open"
argument_list|,
name|_FAILED
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|kill
argument_list|(
name|pid
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|dnf
argument_list|)
expr_stmt|;
name|delock
argument_list|(
name|dev
operator|->
name|D_line
argument_list|)
expr_stmt|;
return|return
name|CF_DIAL
return|;
block|}
while|while
condition|(
operator|(
name|nw
operator|=
name|wait
argument_list|(
operator|&
name|lt
argument_list|)
operator|)
operator|!=
name|pid
operator|&&
name|nw
operator|!=
operator|-
literal|1
condition|)
empty_stmt|;
ifdef|#
directive|ifdef
name|USG
name|ioctl
argument_list|(
name|dcf
argument_list|,
name|TCGETA
argument_list|,
operator|&
name|ttbuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ttbuf
operator|.
name|c_cflag
operator|&
name|HUPCL
operator|)
condition|)
block|{
name|ttbuf
operator|.
name|c_cflag
operator||=
name|HUPCL
expr_stmt|;
name|ioctl
argument_list|(
name|dcf
argument_list|,
name|TCSETA
argument_list|,
operator|&
name|ttbuf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|USG
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|fixline
argument_list|(
name|dcf
argument_list|,
name|dev
operator|->
name|D_speed
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"Fork Stat %o\n"
argument_list|,
name|lt
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
operator|!=
literal|0
condition|)
block|{
name|close
argument_list|(
name|dcf
argument_list|)
expr_stmt|;
if|if
condition|(
name|dnf
condition|)
name|close
argument_list|(
name|dnf
argument_list|)
expr_stmt|;
name|delock
argument_list|(
name|dev
operator|->
name|D_line
argument_list|)
expr_stmt|;
return|return
name|CF_DIAL
return|;
block|}
return|return
name|dcf
return|;
block|}
end_block

begin_comment
comment|/***  *	dncls()		close dn type call unit  *  *	return codes:	None  */
end_comment

begin_expr_stmt
name|dncls
argument_list|(
name|fd
argument_list|)
specifier|register
name|int
name|fd
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|fd
operator|>
literal|0
condition|)
block|{
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|delock
argument_list|(
name|devSel
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit


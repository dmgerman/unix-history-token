begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"../api/api.h"
end_include

begin_include
include|#
directive|include
file|"apilib.h"
end_include

begin_include
include|#
directive|include
file|"../ctlr/oia.h"
end_include

begin_macro
name|api_perror
argument_list|(
argument|string
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|string
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: [0x%x/0x%x:0x%x/0x%x] from %s.\n"
argument_list|,
name|api_sup_fcn_id
argument_list|,
name|api_sup_errno
argument_list|,
name|api_fcn_fcn_id
argument_list|,
name|api_fcn_errno
argument_list|,
name|string
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|session_type
parameter_list|(
name|type
parameter_list|)
name|int
name|type
decl_stmt|;
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|TYPE_WSCTL
case|:
return|return
literal|"work station control"
return|;
case|case
name|TYPE_DFT
case|:
return|return
literal|"distributed function terminal"
return|;
case|case
name|TYPE_CUT
case|:
return|return
literal|"control unit terminal"
return|;
case|case
name|TYPE_NOTEPAD
case|:
return|return
literal|"notepad"
return|;
case|case
name|TYPE_PC
case|:
return|return
literal|"personal computer"
return|;
default|default:
return|return
literal|"(UNKNOWN)"
return|;
block|}
block|}
end_function

begin_function
name|main
parameter_list|()
block|{
name|int
name|session_id
decl_stmt|;
name|OIA
name|oia
decl_stmt|;
name|QuerySessionIdParms
name|id
decl_stmt|;
name|QuerySessionParametersParms
name|pa
decl_stmt|;
name|QuerySessionCursorParms
name|cu
decl_stmt|;
name|ConnectToKeyboardParms
name|conn
decl_stmt|;
name|DisconnectFromKeyboardParms
name|disc
decl_stmt|;
name|WriteKeystrokeParms
name|wr
decl_stmt|;
name|DisableInputParms
name|disable
decl_stmt|;
name|EnableInputParms
name|enable
decl_stmt|;
name|CopyStringParms
name|copy
decl_stmt|;
name|ReadOiaGroupParms
name|re
decl_stmt|;
name|NameArray
name|namearray
decl_stmt|;
if|if
condition|(
name|api_init
argument_list|()
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"API function not available.\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|id
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|id
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|id
operator|.
name|option_code
operator|=
name|ID_OPTION_BY_NAME
expr_stmt|;
name|id
operator|.
name|data_code
operator|=
literal|'E'
expr_stmt|;
name|id
operator|.
name|name_array
operator|=
operator|&
name|namearray
expr_stmt|;
name|namearray
operator|.
name|length
operator|=
sizeof|sizeof
name|namearray
expr_stmt|;
if|if
condition|(
name|api_query_session_id
argument_list|(
operator|&
name|id
argument_list|)
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_query_session_id"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|namearray
operator|.
name|number_matching_session
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"query_session_id:  No matching sessions!\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Session short name 0x%x, type is "
argument_list|,
name|namearray
operator|.
name|name_array_element
operator|.
name|short_name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|session_type
argument_list|(
name|namearray
operator|.
name|name_array_element
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", session ID is: 0x%x\n"
argument_list|,
name|namearray
operator|.
name|name_array_element
operator|.
name|session_id
argument_list|)
expr_stmt|;
block|}
name|session_id
operator|=
name|namearray
operator|.
name|name_array_element
operator|.
name|session_id
expr_stmt|;
name|pa
operator|.
name|rc
operator|=
name|pa
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|pa
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
if|if
condition|(
name|api_query_session_parameters
argument_list|(
operator|&
name|pa
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_query_session_parameters"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Session type %s, "
argument_list|,
name|session_type
argument_list|(
name|pa
operator|.
name|session_type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pa
operator|.
name|session_characteristics
operator|&
name|CHARACTERISTIC_EAB
condition|)
block|{
name|printf
argument_list|(
literal|" has EAB, "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pa
operator|.
name|session_characteristics
operator|&
name|CHARACTERISTIC_PSS
condition|)
block|{
name|printf
argument_list|(
literal|" has PSS, "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%d rows, %d columns "
argument_list|,
name|pa
operator|.
name|rows
argument_list|,
name|pa
operator|.
name|columns
argument_list|)
expr_stmt|;
if|if
condition|(
name|pa
operator|.
name|presentation_space
condition|)
block|{
name|printf
argument_list|(
literal|"presentation space at 0x%x:0x%x.\n"
argument_list|,
name|FP_SEG
argument_list|(
name|pa
operator|.
name|presentation_space
argument_list|)
argument_list|,
name|FP_OFF
argument_list|(
name|pa
operator|.
name|presentation_space
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"(no direct presentation space access).\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|cu
operator|.
name|rc
operator|=
name|cu
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|cu
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
if|if
condition|(
name|api_query_session_cursor
argument_list|(
operator|&
name|cu
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_query_session_cursor"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"cursor"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cu
operator|.
name|cursor_type
operator|&
name|CURSOR_INHIBITED_AUTOSCROLL
condition|)
block|{
name|printf
argument_list|(
literal|" inhibited autoscroll"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cu
operator|.
name|cursor_type
operator|&
name|CURSOR_INHIBITED
condition|)
block|{
name|printf
argument_list|(
literal|" inhibited"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cu
operator|.
name|cursor_type
operator|&
name|CURSOR_BLINKING
condition|)
block|{
name|printf
argument_list|(
literal|" blinking"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" not blinking"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cu
operator|.
name|cursor_type
operator|&
name|CURSOR_BOX
condition|)
block|{
name|printf
argument_list|(
literal|" box "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" not box "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"at row %d, column %d.\n"
argument_list|,
name|cu
operator|.
name|row_address
argument_list|,
name|cu
operator|.
name|column_address
argument_list|)
expr_stmt|;
block|}
name|re
operator|.
name|rc
operator|=
name|re
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|re
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|re
operator|.
name|oia_buffer
operator|=
operator|(
name|char
name|far
operator|*
operator|)
operator|&
name|oia
expr_stmt|;
name|re
operator|.
name|oia_group_number
operator|=
name|API_OIA_ALL_GROUPS
expr_stmt|;
if|if
condition|(
name|api_read_oia_group
argument_list|(
operator|&
name|re
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_read_oia_group"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|IsOiaReady3274
argument_list|(
operator|&
name|oia
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"3274 ready, "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IsOiaMyJob
argument_list|(
operator|&
name|oia
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"my job, "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IsOiaInsert
argument_list|(
operator|&
name|oia
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"insert mode, "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IsOiaSystemLocked
argument_list|(
operator|&
name|oia
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"system locked, "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IsOiaTWait
argument_list|(
operator|&
name|oia
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"terminal wait, "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"are some bits from the OIA.\n"
argument_list|)
expr_stmt|;
block|}
name|conn
operator|.
name|rc
operator|=
name|conn
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|conn
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|conn
operator|.
name|event_queue_id
operator|=
name|conn
operator|.
name|input_queue_id
operator|=
literal|0
expr_stmt|;
name|conn
operator|.
name|intercept_options
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|api_connect_to_keyboard
argument_list|(
operator|&
name|conn
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_connect_to_keyboard"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|conn
operator|.
name|first_connection_identifier
condition|)
block|{
name|printf
argument_list|(
literal|"First keyboard connection.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Not first keyboard connection.\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|disable
operator|.
name|rc
operator|=
name|disable
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|disable
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|disable
operator|.
name|connectors_task_id
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|api_disable_input
argument_list|(
operator|&
name|disable
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_disable_input"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Disabled.\n"
argument_list|)
expr_stmt|;
block|}
name|wr
operator|.
name|rc
operator|=
name|wr
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|wr
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|wr
operator|.
name|connectors_task_id
operator|=
literal|0
expr_stmt|;
name|wr
operator|.
name|options
operator|=
name|OPTION_SINGLE_KEYSTROKE
expr_stmt|;
name|wr
operator|.
name|number_of_keys_sent
operator|=
literal|0
expr_stmt|;
name|wr
operator|.
name|keystroke_specifier
operator|.
name|keystroke_entry
operator|.
name|scancode
operator|=
literal|0x3a
expr_stmt|;
name|wr
operator|.
name|keystroke_specifier
operator|.
name|keystroke_entry
operator|.
name|shift_state
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|api_write_keystroke
argument_list|(
operator|&
name|wr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_write_keystroke"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|wr
operator|.
name|number_of_keys_sent
operator|!=
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"write_keystroke claims to have sent %d keystrokes.\n"
argument_list|,
name|wr
operator|.
name|number_of_keys_sent
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Keystroke sent.\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|enable
operator|.
name|rc
operator|=
name|enable
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|enable
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|enable
operator|.
name|connectors_task_id
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|api_enable_input
argument_list|(
operator|&
name|enable
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_enable"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Enabled.\n"
argument_list|)
expr_stmt|;
block|}
name|disc
operator|.
name|rc
operator|=
name|disc
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|disc
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|disc
operator|.
name|connectors_task_id
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|api_disconnect_from_keyboard
argument_list|(
operator|&
name|disc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_disconnect_from_keyboard"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Disconnected from keyboard.\n"
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|api_finish
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


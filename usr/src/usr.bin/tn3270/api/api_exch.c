begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"api_exch.h"
end_include

begin_decl_stmt
specifier|static
name|char
name|ibuffer
index|[
literal|40
index|]
decl_stmt|,
modifier|*
name|ibuf_next
decl_stmt|,
modifier|*
name|ibuf_last
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|IBUFADDED
parameter_list|(
name|i
parameter_list|)
value|ibuf_last += (i)
end_define

begin_define
define|#
directive|define
name|IBUFAVAILABLE
parameter_list|()
value|(ibuf_last -ibuf_next)
end_define

begin_define
define|#
directive|define
name|IBUFFER
parameter_list|()
value|ibuffer
end_define

begin_define
define|#
directive|define
name|IBUFGETCHAR
parameter_list|()
value|(*ibuf_next++)
end_define

begin_define
define|#
directive|define
name|IBUFGETSHORT
parameter_list|()
value|((*ibuf_next++<<8)|(*ibuf_next++&0xff))
end_define

begin_define
define|#
directive|define
name|IBUFRESET
parameter_list|()
value|(ibuf_next = ibuf_last = ibuffer)
end_define

begin_decl_stmt
name|char
name|obuffer
index|[
literal|40
index|]
decl_stmt|,
modifier|*
name|obuf_next
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|OBUFADDBYTES
parameter_list|(
name|w
parameter_list|,
name|l
parameter_list|)
value|{ memcpy(obuf_next, w, l); obuf_next += l; }
end_define

begin_define
define|#
directive|define
name|OBUFADDCHAR
parameter_list|(
name|c
parameter_list|)
value|(*obuf_next++ = c)
end_define

begin_define
define|#
directive|define
name|OBUFADDSHORT
parameter_list|(
name|s
parameter_list|)
value|{*obuf_next++ = (s)>>8; *obuf_next++ = s; }
end_define

begin_define
define|#
directive|define
name|OBUFAVAILABLE
parameter_list|()
value|(obuf_next - obuffer)
end_define

begin_define
define|#
directive|define
name|OBUFFER
parameter_list|()
value|obuffer
end_define

begin_define
define|#
directive|define
name|OBUFRESET
parameter_list|()
value|obuf_next = obuffer
end_define

begin_define
define|#
directive|define
name|OBUFROOM
parameter_list|()
value|(obuffer+sizeof obuffer-obuf_next)
end_define

begin_function
specifier|static
name|int
name|outflush
parameter_list|()
block|{
name|int
name|length
init|=
name|OBUFAVAILABLE
argument_list|()
decl_stmt|;
if|if
condition|(
name|length
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|write
argument_list|(
name|sock
argument_list|,
name|OBUFFER
argument_list|()
argument_list|,
name|length
argument_list|)
operator|!=
name|length
condition|)
block|{
name|perror
argument_list|(
literal|"writing to API client"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|OBUFRESET
argument_list|()
expr_stmt|;
block|}
return|return
literal|0
return|;
comment|/* All OK */
block|}
end_function

begin_function
specifier|static
name|int
name|infill
parameter_list|(
name|count
parameter_list|)
name|int
name|count
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|OBUFAVAILABLE
argument_list|()
condition|)
block|{
if|if
condition|(
name|outflush
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|ibuf_next
operator|==
name|ibuf_last
condition|)
block|{
name|IBUFRESET
argument_list|()
expr_stmt|;
block|}
while|while
condition|(
name|count
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|=
name|read
argument_list|(
name|sock
argument_list|,
name|IBUFFER
argument_list|()
argument_list|,
name|count
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"reading from API client"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|count
operator|-=
name|i
expr_stmt|;
name|IBUFADDED
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|api_exch_incommand
parameter_list|(
name|command
parameter_list|)
name|int
name|command
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|IBUFAVAILABLE
argument_list|()
operator|<
literal|1
condition|)
block|{
if|if
condition|(
name|infill
argument_list|(
literal|1
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
name|i
operator|=
name|IBUFGETCHAR
argument_list|()
expr_stmt|;
if|if
condition|(
name|i
operator|!=
name|command
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Expected API command 0x%x, got API command 0x%x.\n"
argument_list|,
name|command
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|api_exch_outcommand
parameter_list|(
name|command
parameter_list|)
name|int
name|command
decl_stmt|;
block|{
if|if
condition|(
name|OBUFROOM
argument_list|()
operator|<
literal|1
condition|)
block|{
if|if
condition|(
name|outflush
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
name|OBUFADDCHAR
argument_list|(
name|command
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|api_exch_outtype
parameter_list|(
name|type
parameter_list|,
name|length
parameter_list|,
name|location
parameter_list|)
name|int
name|type
decl_stmt|,
name|length
decl_stmt|;
name|char
modifier|*
name|location
decl_stmt|;
block|{
name|int
name|netleng
init|=
name|htons
argument_list|(
name|length
argument_list|)
decl_stmt|;
if|if
condition|(
name|OBUFROOM
argument_list|()
operator|<
literal|3
condition|)
block|{
if|if
condition|(
name|outflush
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
name|OBUFADDCHAR
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|OBUFADDSHORT
argument_list|(
name|netleng
argument_list|)
expr_stmt|;
if|if
condition|(
name|OBUFROOM
argument_list|()
operator|>
name|length
condition|)
block|{
name|OBUFADDBYTES
argument_list|(
name|location
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|outflush
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|write
argument_list|(
name|sock
argument_list|,
name|location
argument_list|,
name|length
argument_list|)
operator|!=
name|length
condition|)
block|{
name|perror
argument_list|(
literal|"writing to API client"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|api_exch_intype
parameter_list|(
name|type
parameter_list|,
name|length
parameter_list|,
name|location
parameter_list|)
name|int
name|type
decl_stmt|,
name|length
decl_stmt|;
name|char
modifier|*
name|location
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|netleng
init|=
name|htons
argument_list|(
name|length
argument_list|)
decl_stmt|;
if|if
condition|(
name|IBUFAVAILABLE
argument_list|()
operator|<
literal|3
condition|)
block|{
if|if
condition|(
name|infill
argument_list|(
literal|3
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
operator|(
name|i
operator|=
name|IBUFGETCHAR
argument_list|()
operator|)
operator|!=
name|type
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Expected type 0x%x, got type 0x%x.\n"
argument_list|,
name|type
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|i
operator|=
name|IBUFGETSHORT
argument_list|()
operator|)
operator|!=
name|netleng
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Type 0x%x - expected length %d, received length %d.\n"
argument_list|,
name|type
argument_list|,
name|length
argument_list|,
name|ntohs
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|length
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|=
name|read
argument_list|(
name|sock
argument_list|,
name|location
argument_list|,
name|length
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"reading from API client"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|length
operator|-=
name|i
expr_stmt|;
name|location
operator|+=
name|i
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * %sccs.include.proprietary.c%  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)hunt1.c	4.4 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_decl_stmt
specifier|extern
name|char
name|refdir
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|keepold
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|fgnames
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|fgnamp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fd
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lmaster
init|=
literal|500
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|hfreq
decl_stmt|,
name|hfrflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|colevel
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|measure
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|soutlen
init|=
literal|1000
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|reached
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|iflong
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|prfreqs
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|usedir
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
name|char
modifier|*
name|calloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|todir
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
name|gfile
index|[
literal|50
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|full
init|=
literal|1000
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tags
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|sinput
decl_stmt|,
modifier|*
name|soutput
decl_stmt|,
modifier|*
name|tagout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|indexdate
init|=
literal|0
decl_stmt|,
name|gdate
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
comment|/* read query from stdin, expect name of indexes in argv[1] */
specifier|static
name|FILE
modifier|*
name|fa
decl_stmt|,
modifier|*
name|fb
decl_stmt|,
modifier|*
name|fc
decl_stmt|;
name|char
name|nma
index|[
literal|100
index|]
decl_stmt|,
name|nmb
index|[
literal|100
index|]
decl_stmt|,
name|nmc
index|[
literal|100
index|]
decl_stmt|,
modifier|*
name|qitem
index|[
literal|100
index|]
decl_stmt|,
modifier|*
name|rprog
init|=
name|NULL
decl_stmt|;
name|char
name|nmd
index|[
literal|100
index|]
decl_stmt|,
name|grepquery
index|[
literal|256
index|]
decl_stmt|;
specifier|static
name|char
name|oldname
index|[
literal|30
index|]
decl_stmt|;
specifier|static
name|int
name|was
init|=
literal|0
decl_stmt|;
comment|/* these pointers are unions of pointer to int and pointer to long */
name|long
modifier|*
name|hpt
decl_stmt|;
name|unsigned
modifier|*
name|master
init|=
literal|0
decl_stmt|;
name|int
name|falseflg
decl_stmt|,
name|nhash
decl_stmt|,
name|nitem
decl_stmt|,
name|nfound
decl_stmt|,
name|frtbl
decl_stmt|,
name|kk
decl_stmt|;
comment|/* special wart for refpart: default is tags only */
while|while
condition|(
name|argv
index|[
literal|1
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
name|argv
index|[
literal|1
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'a'
case|:
comment|/* all output, incl. false drops */
name|falseflg
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|rprog
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
comment|/* put out full text */
name|full
operator|=
name|setfrom
argument_list|(
name|argv
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
comment|/* put out tags */
name|tags
operator|=
name|setfrom
argument_list|(
name|argv
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
comment|/* input in argument string */
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|sinput
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
comment|/*text output to string */
case|case
literal|'o'
case|:
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|soutput
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|argv
index|[
literal|2
index|]
operator|<
literal|16000
condition|)
block|{
name|soutlen
operator|=
operator|(
name|int
operator|)
name|argv
index|[
literal|2
index|]
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
break|break;
case|case
literal|'t'
case|:
comment|/*tag output to string */
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|tagout
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
comment|/* length of internal lists */
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|lmaster
operator|=
name|atoi
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
comment|/* suppress fgrep search on old files */
name|keepold
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
comment|/* coordination level */
name|colevel
operator|=
name|atoi
argument_list|(
name|argv
index|[
literal|1
index|]
operator|+
literal|2
argument_list|)
expr_stmt|;
if|#
directive|if
name|D1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"colevel set to %d\n"
argument_list|,
name|colevel
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'P'
case|:
comment|/* print term freqs */
name|prfreqs
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|measure
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|nma
argument_list|,
name|todir
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|was
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|oldname
argument_list|,
name|nma
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|oldname
argument_list|,
name|nma
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|nmb
argument_list|,
name|nma
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|nmc
argument_list|,
name|nmb
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|nmd
argument_list|,
name|nma
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|nma
argument_list|,
literal|".ia"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|nmb
argument_list|,
literal|".ib"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|nmc
argument_list|,
literal|".ic"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|nmd
argument_list|,
literal|".id"
argument_list|)
expr_stmt|;
if|if
condition|(
name|was
condition|)
block|{
name|fclose
argument_list|(
name|fa
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fc
argument_list|)
expr_stmt|;
block|}
name|fa
operator|=
name|fopen
argument_list|(
name|nma
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fa
operator|==
name|NULL
condition|)
block|{
name|strcpy
argument_list|(
operator|*
name|fgnamp
operator|++
operator|=
name|calloc
argument_list|(
name|strlen
argument_list|(
name|oldname
argument_list|)
operator|+
literal|2
argument_list|,
literal|1
argument_list|)
argument_list|,
name|oldname
argument_list|)
expr_stmt|;
name|fb
operator|=
name|NULL
expr_stmt|;
goto|goto
name|search
goto|;
block|}
name|fb
operator|=
name|fopen
argument_list|(
name|nmb
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
name|fc
operator|=
name|fopen
argument_list|(
name|nmc
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
name|was
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|fb
operator|==
name|NULL
operator|||
name|fc
operator|==
name|NULL
condition|)
block|{
name|err
argument_list|(
literal|"Index incomplete %s"
argument_list|,
name|nmb
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|indexdate
operator|=
name|gdate
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|fd
operator|=
name|fopen
argument_list|(
name|nmd
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
block|}
name|fseek
argument_list|(
name|fa
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fread
argument_list|(
operator|&
name|nhash
argument_list|,
sizeof|sizeof
argument_list|(
name|nhash
argument_list|)
argument_list|,
literal|1
argument_list|,
name|fa
argument_list|)
expr_stmt|;
name|fread
argument_list|(
operator|&
name|iflong
argument_list|,
sizeof|sizeof
argument_list|(
name|iflong
argument_list|)
argument_list|,
literal|1
argument_list|,
name|fa
argument_list|)
expr_stmt|;
if|if
condition|(
name|master
operator|==
literal|0
condition|)
name|master
operator|=
operator|(
name|unsigned
operator|*
operator|)
name|calloc
argument_list|(
name|lmaster
argument_list|,
name|iflong
condition|?
sizeof|sizeof
argument_list|(
name|long
argument_list|)
else|:
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
argument_list|)
expr_stmt|;
name|hpt
operator|=
operator|(
name|long
operator|*
operator|)
name|calloc
argument_list|(
name|nhash
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hpt
argument_list|)
argument_list|)
expr_stmt|;
name|kk
operator|=
name|fread
argument_list|(
name|hpt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hpt
argument_list|)
argument_list|,
name|nhash
argument_list|,
name|fa
argument_list|)
expr_stmt|;
if|#
directive|if
name|D1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"read %d hashes, iflong %d, nhash %d\n"
argument_list|,
name|kk
argument_list|,
name|iflong
argument_list|,
name|nhash
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|_assert
argument_list|(
name|kk
operator|==
name|nhash
argument_list|)
expr_stmt|;
name|hfreq
operator|=
operator|(
name|int
operator|*
operator|)
name|calloc
argument_list|(
name|nhash
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hfreq
argument_list|)
argument_list|)
expr_stmt|;
name|_assert
argument_list|(
name|hfreq
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|frtbl
operator|=
name|fread
argument_list|(
name|hfreq
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hfreq
argument_list|)
argument_list|,
name|nhash
argument_list|,
name|fa
argument_list|)
expr_stmt|;
name|hfrflg
operator|=
operator|(
name|frtbl
operator|==
name|nhash
operator|)
expr_stmt|;
if|#
directive|if
name|D1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"read freqs %d\n"
argument_list|,
name|frtbl
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|search
label|:
while|while
condition|(
literal|1
condition|)
block|{
name|nitem
operator|=
name|getq
argument_list|(
name|qitem
argument_list|)
expr_stmt|;
if|if
condition|(
name|measure
condition|)
name|tick
argument_list|()
expr_stmt|;
if|if
condition|(
name|nitem
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|nitem
operator|<
literal|0
condition|)
break|break;
if|if
condition|(
name|tagout
condition|)
name|tagout
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fb
operator|!=
name|NULL
condition|)
block|{
name|nfound
operator|=
name|doquery
argument_list|(
name|hpt
argument_list|,
name|nhash
argument_list|,
name|fb
argument_list|,
name|nitem
argument_list|,
name|qitem
argument_list|,
name|master
argument_list|)
expr_stmt|;
if|#
directive|if
name|D1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"after doquery nfound %d\n"
argument_list|,
name|nfound
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fgnamp
operator|=
name|fgnames
expr_stmt|;
if|if
condition|(
name|falseflg
operator|==
literal|0
condition|)
name|nfound
operator|=
name|baddrop
argument_list|(
name|master
argument_list|,
name|nfound
argument_list|,
name|fc
argument_list|,
name|nitem
argument_list|,
name|qitem
argument_list|,
name|rprog
argument_list|,
name|full
argument_list|)
expr_stmt|;
if|#
directive|if
name|D1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"after baddrop nfound %d\n"
argument_list|,
name|nfound
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|fgnamp
operator|>
name|fgnames
condition|)
block|{
name|char
modifier|*
modifier|*
name|fgp
decl_stmt|,
name|tgbuff
index|[
literal|100
index|]
decl_stmt|;
name|int
name|k
decl_stmt|;
if|#
directive|if
name|D1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"were %d bad files\n"
argument_list|,
name|fgnamp
operator|-
name|fgnames
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|grepquery
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|nitem
condition|;
name|k
operator|++
control|)
block|{
name|strcat
argument_list|(
name|grepquery
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|grepquery
argument_list|,
name|qitem
index|[
name|k
index|]
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|D1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"grepquery %s\n"
argument_list|,
name|grepquery
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|fgp
operator|=
name|fgnames
init|;
name|fgp
operator|<
name|fgnamp
condition|;
name|fgp
operator|++
control|)
block|{
if|#
directive|if
name|D1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Now on %s query /%s/\n"
argument_list|,
operator|*
name|fgp
argument_list|,
name|grepquery
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|makefgrep
argument_list|(
operator|*
name|fgp
argument_list|)
expr_stmt|;
if|#
directive|if
name|D1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"grepmade\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|tagout
operator|==
literal|0
condition|)
name|tagout
operator|=
name|tgbuff
expr_stmt|;
name|grepcall
argument_list|(
name|grepquery
argument_list|,
name|tagout
argument_list|,
operator|*
name|fgp
argument_list|)
expr_stmt|;
if|#
directive|if
name|D1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"tagout now /%s/\n"
argument_list|,
name|tagout
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|full
condition|)
block|{
name|char
name|bout
index|[
literal|1000
index|]
decl_stmt|;
name|char
modifier|*
name|tagp
decl_stmt|;
name|char
modifier|*
name|oldtagp
decl_stmt|;
name|tagp
operator|=
name|tagout
expr_stmt|;
while|while
condition|(
operator|*
name|tagp
condition|)
block|{
name|oldtagp
operator|=
name|tagp
expr_stmt|;
while|while
condition|(
operator|*
name|tagp
operator|&&
operator|(
operator|*
name|tagp
operator|!=
literal|'\n'
operator|)
condition|)
name|tagp
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|tagp
condition|)
name|tagp
operator|++
expr_stmt|;
name|findline
argument_list|(
name|oldtagp
argument_list|,
name|bout
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|bout
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|tags
condition|)
name|result
argument_list|(
name|master
argument_list|,
name|nfound
operator|>
name|tags
condition|?
name|tags
else|:
name|nfound
argument_list|,
name|fc
argument_list|)
expr_stmt|;
if|if
condition|(
name|measure
condition|)
name|tock
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|todir
parameter_list|(
name|t
parameter_list|)
name|char
modifier|*
name|t
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|t
expr_stmt|;
while|while
condition|(
operator|*
name|s
condition|)
name|s
operator|++
expr_stmt|;
while|while
condition|(
name|s
operator|>=
name|t
operator|&&
operator|*
name|s
operator|!=
literal|'/'
condition|)
name|s
operator|--
expr_stmt|;
if|if
condition|(
name|s
operator|<
name|t
condition|)
return|return
operator|(
name|t
operator|)
return|;
operator|*
name|s
operator|++
operator|=
literal|0
expr_stmt|;
name|t
operator|=
operator|(
operator|*
name|t
condition|?
name|t
else|:
literal|"/"
operator|)
expr_stmt|;
name|chdir
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|usedir
argument_list|,
name|t
argument_list|)
expr_stmt|;
return|return
operator|(
name|s
operator|)
return|;
block|}
end_function

begin_macro
name|setfrom
argument_list|(
argument|c
argument_list|)
end_macro

begin_block
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'y'
case|:
case|case
literal|'\0'
case|:
default|default:
return|return
operator|(
literal|1000
operator|)
return|;
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
return|return
operator|(
name|c
operator|-
literal|'0'
operator|)
return|;
case|case
literal|'n'
case|:
case|case
literal|'0'
case|:
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_block

end_unit


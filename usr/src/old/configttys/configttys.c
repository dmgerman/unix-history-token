begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * configttys - configure "tty" ports  *  * David L. Wasley  * U.C.Berkeley  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
name|char
name|sccsid
index|[]
init|=
literal|"@(#)configttys.c	4.2 Berkeley %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<getty.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_define
define|#
directive|define
name|exists
parameter_list|(
name|file
parameter_list|)
value|(access(file, 0) == 0)
end_define

begin_decl_stmt
name|char
modifier|*
name|etc_ttys
init|=
literal|"/etc/ttys"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* active port speed table */
end_comment

begin_decl_stmt
name|char
modifier|*
name|etc_ttytype
init|=
literal|"/etc/ttytype"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* terminal type table */
end_comment

begin_decl_stmt
name|char
modifier|*
name|etc_conf
init|=
literal|"/etc/ttyconf"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* master config file */
end_comment

begin_decl_stmt
name|char
modifier|*
name|lockfile
init|=
literal|"/etc/ttyconf.lock"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* interlock file */
end_comment

begin_struct
struct|struct
name|ttys
block|{
name|char
name|ty_active
decl_stmt|;
comment|/* active login port */
name|char
name|ty_speed
decl_stmt|;
comment|/* speed table character */
name|char
name|ty_port
index|[
literal|32
index|]
decl_stmt|;
comment|/* port name */
block|}
name|ttys
index|[
literal|256
index|]
struct|;
end_struct

begin_struct
struct|struct
name|ttytype
block|{
name|char
name|tp_term
index|[
literal|64
index|]
decl_stmt|;
comment|/* terminal type name */
name|char
name|tp_port
index|[
literal|32
index|]
decl_stmt|;
comment|/* port name */
block|}
name|ttytype
index|[
literal|256
index|]
struct|;
end_struct

begin_decl_stmt
name|char
name|conformat
index|[]
init|=
literal|"%s\t%s\t%s\t%s\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|error
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|renamed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* debug mode */
end_comment

begin_decl_stmt
name|int
name|backup
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* create backup copies of old data */
end_comment

begin_decl_stmt
name|int
name|interactive
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* interactive mode */
end_comment

begin_function_decl
name|char
modifier|*
name|speedname
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* port speed code name */
end_comment

begin_function_decl
name|char
name|speedchar
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* getty table name */
end_comment

begin_function_decl
name|char
modifier|*
name|termname
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* name of terminal on this port */
end_comment

begin_function_decl
name|char
modifier|*
name|rindex
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|ttytype
modifier|*
name|type
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* find ttytype for port */
end_comment

begin_function_decl
name|FILE
modifier|*
name|fopen
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|lineno
decl_stmt|;
name|int
name|child
decl_stmt|;
name|int
name|status
decl_stmt|;
name|char
name|c
decl_stmt|;
name|struct
name|ttys
modifier|*
name|ty
decl_stmt|;
name|struct
name|ttytype
modifier|*
name|tp
decl_stmt|;
name|char
name|port
index|[
literal|32
index|]
decl_stmt|;
name|char
name|active
index|[
literal|16
index|]
decl_stmt|;
name|char
name|speed
index|[
literal|32
index|]
decl_stmt|;
name|char
name|term
index|[
literal|64
index|]
decl_stmt|;
name|FILE
modifier|*
name|tyf
decl_stmt|,
modifier|*
name|tpf
decl_stmt|,
modifier|*
name|conf
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|ans
index|[
literal|32
index|]
decl_stmt|;
while|while
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|++
name|argv
operator|==
literal|'-'
condition|)
switch|switch
condition|(
operator|*
operator|++
operator|*
name|argv
condition|)
block|{
case|case
literal|'d'
case|:
name|debug
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* non-interactive */
name|interactive
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
comment|/* backup old databases */
name|backup
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown option %c\n"
argument_list|,
operator|*
operator|*
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|debug
condition|)
block|{
name|etc_ttys
operator|=
name|rindex
argument_list|(
name|etc_ttys
argument_list|,
literal|'/'
argument_list|)
operator|+
literal|1
expr_stmt|;
name|etc_ttytype
operator|=
name|rindex
argument_list|(
name|etc_ttytype
argument_list|,
literal|'/'
argument_list|)
operator|+
literal|1
expr_stmt|;
name|etc_conf
operator|=
name|rindex
argument_list|(
name|etc_conf
argument_list|,
literal|'/'
argument_list|)
operator|+
literal|1
expr_stmt|;
name|lockfile
operator|=
name|rindex
argument_list|(
name|lockfile
argument_list|,
literal|'/'
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
comment|/* 	 * create backup copies of the databases? 	 */
if|if
condition|(
name|backup
condition|)
block|{
if|if
condition|(
name|exists
argument_list|(
name|etc_ttys
argument_list|)
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/bin/cp %s %s.bak"
argument_list|,
name|etc_ttys
argument_list|,
name|etc_ttys
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|exists
argument_list|(
name|etc_ttys
argument_list|)
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/bin/cp %s %s.bak"
argument_list|,
name|etc_ttytype
argument_list|,
name|etc_ttytype
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|exists
argument_list|(
name|etc_conf
argument_list|)
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/bin/cp %s %s.bak"
argument_list|,
name|etc_conf
argument_list|,
name|etc_conf
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * create interlock file 	 */
name|getlockfile
argument_list|(
name|lockfile
argument_list|)
expr_stmt|;
comment|/* 	 * always read ttys file for comparison 	 * It is afterall what really counts! 	 */
if|if
condition|(
name|readttys
argument_list|()
operator|!=
literal|0
condition|)
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * read old ttytypes if necessary 	 */
if|if
condition|(
operator|!
name|exists
argument_list|(
name|etc_conf
argument_list|)
condition|)
block|{
comment|/* 		 * open old ttytype file 		 */
if|if
condition|(
operator|(
name|tpf
operator|=
name|fopen
argument_list|(
name|etc_ttytype
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|etc_ttytype
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * read ttytype file 		 */
name|lineno
operator|=
literal|0
expr_stmt|;
name|tp
operator|=
name|ttytype
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|tpf
argument_list|)
condition|)
block|{
name|lineno
operator|++
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%s %s"
argument_list|,
name|tp
operator|->
name|tp_term
argument_list|,
name|tp
operator|->
name|tp_port
argument_list|)
operator|==
literal|2
condition|)
name|tp
operator|++
expr_stmt|;
else|else
block|{
name|error
operator|++
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad line %d in %s: %s"
argument_list|,
name|lineno
argument_list|,
name|etc_ttytype
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|tpf
argument_list|)
expr_stmt|;
name|tp
operator|->
name|tp_term
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|error
operator|>
literal|0
condition|)
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* 		 * create master config file 		 */
if|if
condition|(
operator|(
name|conf
operator|=
name|fopen
argument_list|(
name|etc_conf
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|etc_conf
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|conf
argument_list|,
name|conformat
argument_list|,
literal|"port"
argument_list|,
literal|"login"
argument_list|,
literal|"speed\t"
argument_list|,
literal|"terminal type"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|conf
argument_list|,
name|conformat
argument_list|,
literal|"----"
argument_list|,
literal|"-----"
argument_list|,
literal|"-----\t"
argument_list|,
literal|"-------------"
argument_list|)
expr_stmt|;
for|for
control|(
name|ty
operator|=
name|ttys
init|;
name|ty
operator|->
name|ty_active
condition|;
name|ty
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|conf
argument_list|,
name|conformat
argument_list|,
name|ty
operator|->
name|ty_port
argument_list|,
name|ty
operator|->
name|ty_active
operator|==
literal|'1'
condition|?
literal|"active"
else|:
literal|"-"
argument_list|,
name|speedname
argument_list|(
name|ty
operator|->
name|ty_speed
argument_list|)
argument_list|,
name|termname
argument_list|(
name|ty
operator|->
name|ty_port
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * open master config file 	 */
if|if
condition|(
operator|(
name|conf
operator|=
name|fopen
argument_list|(
name|etc_conf
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|etc_conf
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|interactive
condition|)
name|edit
argument_list|()
expr_stmt|;
comment|/* 	 * read conf file 	 */
name|re_read
label|:
name|rewind
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|ty
operator|=
name|ttys
expr_stmt|;
name|renamed
operator|=
literal|0
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|lineno
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|conf
argument_list|)
condition|)
comment|/* skip heading */
block|{
name|lineno
operator|++
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
break|break;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|conf
argument_list|)
condition|)
block|{
name|lineno
operator|++
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%s %s %s %s"
argument_list|,
name|port
argument_list|,
name|active
argument_list|,
name|speed
argument_list|,
name|term
argument_list|)
operator|<
literal|4
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"line %d: field(s) missing: %s"
argument_list|,
name|lineno
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|error
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|port
argument_list|,
name|ty
operator|->
name|ty_port
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|ty
operator|->
name|ty_active
operator|||
name|renamed
condition|)
name|strcpy
argument_list|(
name|ty
operator|->
name|ty_port
argument_list|,
name|port
argument_list|)
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"line %d: port name changed! %s -> %s\n"
argument_list|,
name|lineno
argument_list|,
name|ty
operator|->
name|ty_port
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Are you sure this is OK? "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|ans
argument_list|)
expr_stmt|;
if|if
condition|(
name|ans
index|[
literal|0
index|]
operator|!=
literal|'y'
condition|)
block|{
name|edit
argument_list|()
expr_stmt|;
goto|goto
name|re_read
goto|;
block|}
name|renamed
operator|++
expr_stmt|;
name|strcpy
argument_list|(
name|ty
operator|->
name|ty_port
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|active
argument_list|,
literal|"active"
argument_list|)
operator|==
literal|0
condition|)
name|ty
operator|->
name|ty_active
operator|=
literal|'1'
expr_stmt|;
else|else
name|ty
operator|->
name|ty_active
operator|=
literal|'0'
expr_stmt|;
if|if
condition|(
name|c
operator|=
name|speedchar
argument_list|(
name|speed
argument_list|)
condition|)
name|ty
operator|->
name|ty_speed
operator|=
name|c
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"line %d: speed name not known: %s\n"
argument_list|,
name|lineno
argument_list|,
name|speed
argument_list|)
expr_stmt|;
name|error
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|tp
operator|=
name|type
argument_list|(
name|port
argument_list|)
condition|)
name|strcpy
argument_list|(
name|tp
operator|->
name|tp_term
argument_list|,
name|term
argument_list|)
expr_stmt|;
comment|/* else ?? */
name|ty
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ty
operator|==
name|ttys
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s empty??\n"
argument_list|,
name|etc_conf
argument_list|)
expr_stmt|;
name|error
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|interactive
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"re-edit? "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|ans
argument_list|)
expr_stmt|;
if|if
condition|(
name|ans
index|[
literal|0
index|]
operator|==
literal|'y'
condition|)
block|{
name|edit
argument_list|()
expr_stmt|;
goto|goto
name|re_read
goto|;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Files not modified.\n"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|writettys
argument_list|()
expr_stmt|;
name|quit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|readttys
argument_list|()
end_macro

begin_block
block|{
comment|/* 	 * read ttys file 	 */
name|FILE
modifier|*
name|tyf
decl_stmt|;
specifier|register
name|struct
name|ttys
modifier|*
name|ty
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|lineno
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|tyf
operator|=
name|fopen
argument_list|(
name|etc_ttys
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|etc_ttys
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|lineno
operator|=
literal|0
expr_stmt|;
name|ty
operator|=
name|ttys
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|tyf
argument_list|)
condition|)
block|{
name|lineno
operator|++
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%c%c%s"
argument_list|,
operator|&
name|ty
operator|->
name|ty_active
argument_list|,
operator|&
name|ty
operator|->
name|ty_speed
argument_list|,
name|ty
operator|->
name|ty_port
argument_list|)
operator|==
literal|3
condition|)
name|ty
operator|++
expr_stmt|;
else|else
block|{
name|error
operator|++
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad line %d in %s: %s"
argument_list|,
name|lineno
argument_list|,
name|etc_ttys
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|tyf
argument_list|)
expr_stmt|;
name|ty
operator|->
name|ty_active
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_macro
name|writettys
argument_list|()
end_macro

begin_block
block|{
name|int
name|rtn
init|=
literal|0
decl_stmt|;
name|char
name|temp
index|[
literal|1024
index|]
decl_stmt|;
name|FILE
modifier|*
name|tyf
decl_stmt|,
modifier|*
name|tpf
decl_stmt|;
specifier|register
name|struct
name|ttys
modifier|*
name|ty
decl_stmt|;
name|sprintf
argument_list|(
name|temp
argument_list|,
literal|"%s.tmp"
argument_list|,
name|etc_ttys
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tyf
operator|=
name|fopen
argument_list|(
name|temp
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|ty
operator|=
name|ttys
init|;
name|ty
operator|->
name|ty_active
condition|;
name|ty
operator|++
control|)
name|fprintf
argument_list|(
name|tyf
argument_list|,
literal|"%c%c%s\n"
argument_list|,
name|ty
operator|->
name|ty_active
argument_list|,
name|ty
operator|->
name|ty_speed
argument_list|,
name|ty
operator|->
name|ty_port
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|tyf
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
name|temp
argument_list|,
name|etc_ttys
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't rename %s\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|rtn
operator|=
literal|1
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|temp
argument_list|,
literal|"%s.tmp"
argument_list|,
name|etc_ttytype
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tpf
operator|=
name|fopen
argument_list|(
name|temp
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|ty
operator|=
name|ttys
init|;
name|ty
operator|->
name|ty_active
condition|;
name|ty
operator|++
control|)
comment|/* same ports! */
name|fprintf
argument_list|(
name|tpf
argument_list|,
literal|"%s %s\n"
argument_list|,
name|type
argument_list|(
name|ty
operator|->
name|ty_port
argument_list|)
operator|->
name|tp_term
argument_list|,
name|ty
operator|->
name|ty_port
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|tpf
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
name|temp
argument_list|,
name|etc_ttytype
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't rename %s\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|rtn
operator|=
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|rtn
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|edit
argument_list|()
end_macro

begin_block
block|{
comment|/* 	 * invoke editor 	 */
name|int
name|child
decl_stmt|;
name|int
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|child
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|execl
argument_list|(
literal|"/usr/ucb/vi"
argument_list|,
literal|"vi"
argument_list|,
name|etc_conf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/bin/ed"
argument_list|,
literal|"ed"
argument_list|,
name|etc_conf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|child
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"can't fork editor"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * wait for editor 	 */
while|while
condition|(
name|wait
argument_list|(
operator|&
name|status
argument_list|)
operator|>=
literal|0
condition|)
empty_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|quit
argument_list|(
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unlink
argument_list|(
name|lockfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|1
condition|)
block|{
name|signal
argument_list|(
name|n
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|kill
argument_list|(
name|getpid
argument_list|()
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
name|n
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|getlockfile
argument_list|()
end_macro

begin_block
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|char
name|locktmp
index|[
literal|64
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|strcpy
argument_list|(
name|locktmp
argument_list|,
name|lockfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|=
name|rindex
argument_list|(
name|locktmp
argument_list|,
literal|'/'
argument_list|)
condition|)
name|p
operator|++
expr_stmt|;
else|else
name|p
operator|=
name|locktmp
expr_stmt|;
name|strcpy
argument_list|(
name|p
argument_list|,
literal|"confttysXXXXXX"
argument_list|)
expr_stmt|;
name|mktemp
argument_list|(
name|locktmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|creat
argument_list|(
name|locktmp
argument_list|,
literal|0600
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|locktmp
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|link
argument_list|(
name|locktmp
argument_list|,
name|lockfile
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|lockfile
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|locktmp
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|quit
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|quit
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|locktmp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_struct
struct|struct
name|speeds
block|{
name|char
modifier|*
name|sp_name
decl_stmt|;
comment|/* human readable name */
name|char
name|sp_table
decl_stmt|;
comment|/* getty table name */
block|}
name|speeds
index|[]
init|=
block|{
block|{
literal|"dialup"
block|,
name|GT_DIALUP
block|}
block|,
comment|/* normal dialup rotation */
block|{
literal|"selector"
block|,
name|GT_SELECTOR
block|}
block|,
comment|/* port selector pseudo-table autobaud*/
block|{
literal|"b110"
block|,
name|GT_B110
block|}
block|,
comment|/* 110 baud */
block|{
literal|"b134"
block|,
name|GT_B134
block|}
block|,
comment|/* 134.5 baud selectric */
block|{
literal|"b150"
block|,
name|GT_B150
block|}
block|,
comment|/* 150 baud */
block|{
literal|"b300"
block|,
name|GT_B300
block|}
block|,
comment|/* 300 baud */
block|{
literal|"b600"
block|,
name|GT_B600
block|}
block|,
comment|/* 600 baud */
block|{
literal|"b1200"
block|,
name|GT_B1200
block|}
block|,
comment|/* 1200 baud */
block|{
literal|"b2400"
block|,
name|GT_B2400
block|}
block|,
comment|/* 2400 baud */
block|{
literal|"b4800"
block|,
name|GT_B4800
block|}
block|,
comment|/* 4800 baud */
block|{
literal|"b9600"
block|,
name|GT_B9600
block|}
block|,
comment|/* 9600 baud */
block|{
literal|"dw2console"
block|,
name|GT_DW2CONSOLE
block|}
block|,
comment|/* Decwriter Console - 300 baud */
block|{
literal|"fastdialup"
block|,
name|GT_FASTDIALUP
block|}
block|,
comment|/* 1200-300 baud rotation for dialup */
block|{
literal|"fastdialup1"
block|,
name|GT_FASTDIALUP1
block|}
block|,
comment|/* 300-1200  "     "       "     "    */
block|{
literal|"crt_hcpy"
block|,
name|GT_CRT_HCPY
block|}
block|,
comment|/* 9600-300 CRT + hardcopy rotation */
block|{
literal|"hcpy_crt"
block|,
name|GT_HCPY_CRT
block|}
block|,
comment|/* 300-9600  "      "        "      */
block|{
literal|"plugboard"
block|,
name|GT_PLUGBOARD
block|}
block|,
comment|/* 9600-300-1200 rotation */
block|{
literal|"plugboard1"
block|,
name|GT_PLUGBOARD2
block|}
block|,
comment|/* 300-1200-9600 rotation */
block|{
literal|"plugboard2"
block|,
name|GT_PLUGBOARD2
block|}
block|,
comment|/* 1200-9600-300 rotation */
block|{
literal|"interdata"
block|,
name|GT_INTERDATA
block|}
block|,
comment|/* Interdata Console */
block|{
literal|"chess"
block|,
name|GT_CHESS
block|}
block|,
comment|/* LSI Chess Terminal */
block|{
literal|"tty33"
block|,
name|GT_TTY33
block|}
block|,
comment|/* 110 baud Model 33 TTY */
block|{
literal|"network"
block|,
name|GT_NETWORK
block|}
block|,
comment|/* ethernet port */
block|{
literal|""
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_function
name|char
modifier|*
name|speedname
parameter_list|(
name|c
parameter_list|)
name|char
name|c
decl_stmt|;
block|{
name|struct
name|speeds
modifier|*
name|sp
decl_stmt|;
specifier|static
name|char
name|sbuf
index|[
literal|32
index|]
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|speeds
init|;
name|sp
operator|->
name|sp_table
condition|;
name|sp
operator|++
control|)
if|if
condition|(
name|sp
operator|->
name|sp_table
operator|==
name|c
condition|)
break|break;
if|if
condition|(
name|sp
operator|->
name|sp_table
condition|)
name|strcpy
argument_list|(
name|sbuf
argument_list|,
name|sp
operator|->
name|sp_name
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|sbuf
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|sbuf
argument_list|)
operator|<
literal|8
condition|)
name|strcat
argument_list|(
name|sbuf
argument_list|,
literal|"\t"
argument_list|)
expr_stmt|;
return|return
operator|(
name|sbuf
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|termname
parameter_list|(
name|port
parameter_list|)
name|char
modifier|*
name|port
decl_stmt|;
block|{
specifier|register
name|struct
name|ttytype
modifier|*
name|tp
decl_stmt|;
for|for
control|(
name|tp
operator|=
name|ttytype
init|;
name|tp
operator|->
name|tp_term
index|[
literal|0
index|]
condition|;
name|tp
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|port
argument_list|,
name|tp
operator|->
name|tp_port
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|tp
operator|->
name|tp_term
operator|)
return|;
if|if
condition|(
name|tp
operator|<
operator|&
name|ttytype
index|[
operator|(
sizeof|sizeof
name|ttytype
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ttytype
argument_list|)
operator|)
operator|-
literal|1
index|]
condition|)
block|{
name|strcpy
argument_list|(
name|tp
operator|->
name|tp_port
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|tp
operator|->
name|tp_term
argument_list|,
literal|"unknown"
argument_list|)
expr_stmt|;
operator|(
operator|++
name|tp
operator|)
operator|->
name|tp_term
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
return|return
operator|(
literal|"unknown"
operator|)
return|;
block|}
end_function

begin_function
name|char
name|speedchar
parameter_list|(
name|speed
parameter_list|)
name|char
modifier|*
name|speed
decl_stmt|;
block|{
specifier|register
name|struct
name|speeds
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|speeds
init|;
name|sp
operator|->
name|sp_table
condition|;
name|sp
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|sp
operator|->
name|sp_name
argument_list|,
name|speed
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|sp
operator|->
name|sp_table
operator|)
return|;
return|return
operator|(
literal|'\0'
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|ttytype
modifier|*
name|type
parameter_list|(
name|port
parameter_list|)
name|char
modifier|*
name|port
decl_stmt|;
block|{
specifier|register
name|struct
name|ttytype
modifier|*
name|tp
decl_stmt|;
for|for
control|(
name|tp
operator|=
name|ttytype
init|;
name|tp
operator|->
name|tp_term
index|[
literal|0
index|]
condition|;
name|tp
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|tp
operator|->
name|tp_port
argument_list|,
name|port
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|tp
operator|)
return|;
if|if
condition|(
name|tp
operator|<
operator|&
name|ttytype
index|[
operator|(
sizeof|sizeof
name|ttytype
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ttytype
argument_list|)
operator|)
operator|-
literal|1
index|]
condition|)
block|{
name|strcpy
argument_list|(
name|tp
operator|->
name|tp_port
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|tp
operator|->
name|tp_term
argument_list|,
literal|"unknown"
argument_list|)
expr_stmt|;
return|return
operator|(
name|tp
operator|)
return|;
block|}
return|return
operator|(
operator|(
expr|struct
name|ttytype
operator|*
operator|)
literal|0
operator|)
return|;
block|}
end_function

end_unit


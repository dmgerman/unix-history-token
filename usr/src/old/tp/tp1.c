begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)tp1.c	4.1 %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"tp.h"
end_include

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|register
name|char
name|c
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
extern|extern cmd(
block|)
operator|,
function|cmr
parameter_list|()
operator|,
function|cmx
parameter_list|()
operator|,
function|cmt
parameter_list|()
function|;
end_function

begin_expr_stmt
name|tname
operator|=
name|tc
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|command
operator|=
name|cmr
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|(
name|narg
operator|=
name|rnarg
operator|=
name|argc
operator|)
operator|<
literal|2
condition|)
name|narg
operator|=
literal|2
expr_stmt|;
else|else
block|{
name|ptr
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
comment|/* get first argument */
name|parg
operator|=
operator|&
name|argv
index|[
literal|2
index|]
expr_stmt|;
comment|/* pointer to second argument */
while|while
condition|(
name|c
operator|=
operator|*
name|ptr
operator|++
condition|)
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
name|tc
index|[
literal|8
index|]
operator|=
name|c
expr_stmt|;
name|mt
index|[
literal|8
index|]
operator|=
name|c
expr_stmt|;
continue|continue;
case|case
literal|'f'
case|:
name|tname
operator|=
operator|*
name|parg
operator|++
expr_stmt|;
name|flags
operator||=
name|flm
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|rnarg
operator|--
expr_stmt|;
continue|continue;
case|case
literal|'c'
case|:
name|flags
operator||=
name|flc
expr_stmt|;
continue|continue;
case|case
literal|'d'
case|:
name|setcom
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'i'
case|:
name|flags
operator||=
name|fli
expr_stmt|;
continue|continue;
case|case
literal|'m'
case|:
name|tname
operator|=
name|mt
expr_stmt|;
name|flags
operator||=
name|flm
expr_stmt|;
continue|continue;
case|case
literal|'r'
case|:
name|flags
operator|&=
operator|~
name|flu
expr_stmt|;
name|setcom
argument_list|(
name|cmr
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'s'
case|:
name|flags
operator||=
name|fls
expr_stmt|;
continue|continue;
case|case
literal|'t'
case|:
name|setcom
argument_list|(
name|cmt
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'u'
case|:
name|flags
operator||=
name|flu
expr_stmt|;
name|setcom
argument_list|(
name|cmr
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'v'
case|:
name|flags
operator||=
name|flv
expr_stmt|;
continue|continue;
case|case
literal|'w'
case|:
name|flags
operator||=
name|flw
expr_stmt|;
continue|continue;
case|case
literal|'x'
case|:
name|setcom
argument_list|(
name|cmx
argument_list|)
expr_stmt|;
continue|continue;
default|default:
name|useerr
argument_list|()
expr_stmt|;
block|}
block|}
end_if

begin_expr_stmt
name|optap
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|nptr
operator|=
name|nameblk
operator|=
name|malloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|top
operator|=
name|nptr
operator|+
literal|1000
expr_stmt|;
end_expr_stmt

begin_expr_stmt
call|(
modifier|*
name|command
call|)
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  optap
operator|(
operator|)
block|{
specifier|extern
name|cmr
argument_list|()
block|;
if|if
condition|(
operator|(
name|flags
operator|&
name|flm
operator|)
operator|==
literal|0
condition|)
block|{
comment|/*  DECTAPE */
name|tapsiz
operator|=
name|TCSIZ
expr_stmt|;
name|ndirent
operator|=
name|TCDIRS
expr_stmt|;
name|fio
operator|=
name|open
argument_list|(
name|tc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_else
else|else
block|{
comment|/* MAGTAPE */
name|tapsiz
operator|=
name|MTSIZ
expr_stmt|;
name|ndirent
operator|=
name|MDIRENT
expr_stmt|;
if|if
condition|(
name|command
operator|==
name|cmr
condition|)
block|{
name|fio
operator|=
name|open
argument_list|(
name|tname
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fio
operator|<
literal|0
condition|)
name|fio
operator|=
name|creat
argument_list|(
name|tname
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
block|}
else|else
name|fio
operator|=
name|open
argument_list|(
name|tname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_else

begin_if
if|if
condition|(
name|fio
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Tape open error\n"
argument_list|)
expr_stmt|;
name|done
argument_list|()
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|ndentb
operator|=
name|ndirent
operator|/
name|TPB
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|edir
operator|=
operator|&
name|dir
index|[
name|ndirent
index|]
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  setcom
call|(
name|newcom
call|)
name|int
argument_list|(
argument|*newcom
argument_list|)
argument_list|()
expr_stmt|;
end_expr_stmt

begin_block
block|{
extern|extern cmr(
block|)
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_if
if|if
condition|(
name|command
operator|!=
name|cmr
condition|)
name|useerr
argument_list|()
expr_stmt|;
end_if

begin_expr_stmt
name|command
operator|=
name|newcom
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  useerr
operator|(
operator|)
block|{
name|printf
argument_list|(
literal|"Bad usage\n"
argument_list|)
block|;
name|done
argument_list|()
block|; }
comment|/*
comment|/* COMMANDS */
name|cmd
argument_list|()
block|{
specifier|extern
name|delete
argument_list|()
block|;
if|if
condition|(
name|flags
operator|&
operator|(
name|flm
operator||
name|flc
operator|)
condition|)
name|useerr
argument_list|()
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|narg
operator|<=
literal|2
condition|)
name|useerr
argument_list|()
expr_stmt|;
end_if

begin_expr_stmt
name|rddir
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gettape
argument_list|(
name|delete
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|wrdir
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|check
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  cmr
operator|(
operator|)
block|{
if|if
condition|(
name|flags
operator|&
operator|(
name|flc
operator||
name|flm
operator|)
condition|)
name|clrdir
argument_list|()
expr_stmt|;
else|else
name|rddir
argument_list|()
expr_stmt|;
name|getfiles
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|update
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|check
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  cmt
operator|(
operator|)
block|{
specifier|extern
name|taboc
argument_list|()
block|;
if|if
condition|(
name|flags
operator|&
operator|(
name|flc
operator||
name|flw
operator|)
condition|)
name|useerr
argument_list|()
expr_stmt|;
name|rddir
argument_list|()
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|flags
operator|&
name|flv
condition|)
name|printf
argument_list|(
literal|"   mode    uid gid tapa    size   date    time name\n"
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|gettape
argument_list|(
name|taboc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|check
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  cmx
operator|(
operator|)
block|{
specifier|extern
name|extract
argument_list|()
block|;
if|if
condition|(
name|flags
operator|&
operator|(
name|flc
operator|)
condition|)
name|useerr
argument_list|()
expr_stmt|;
name|rddir
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|gettape
argument_list|(
name|extract
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|done
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  check
operator|(
operator|)
block|{
name|usage
argument_list|()
block|;
name|done
argument_list|()
block|; }
name|done
argument_list|()
block|{
name|printf
argument_list|(
literal|"End\n"
argument_list|)
block|;
name|exit
argument_list|(
literal|0
argument_list|)
block|; }
name|encode
argument_list|(
argument|pname
argument_list|,
argument|dptr
argument_list|)
comment|/* pname points to the pathname 			 * nptr points to next location in nameblk 			 * dptr points to the dir entry		   */
name|char
operator|*
name|pname
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|dent
modifier|*
name|dptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|np
decl_stmt|;
specifier|register
name|n
expr_stmt|;
name|dptr
operator|->
name|d_namep
operator|=
name|np
operator|=
name|nptr
expr_stmt|;
if|if
condition|(
name|np
operator|>
name|top
operator|-
name|NAMELEN
condition|)
block|{
name|int
name|size
init|=
name|top
operator|-
name|nptr
decl_stmt|;
if|if
condition|(
name|nptr
operator|=
name|realloc
argument_list|(
name|nptr
argument_list|,
literal|2
operator|*
name|size
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Out of core\n"
argument_list|)
expr_stmt|;
name|done
argument_list|()
expr_stmt|;
block|}
name|top
operator|=
name|nptr
operator|+
literal|2
operator|*
name|size
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|n
operator|=
name|strlen
argument_list|(
name|pname
argument_list|)
operator|)
operator|>
name|NAMELEN
condition|)
block|{
name|printf
argument_list|(
literal|"Pathname too long - %s\nFile ignored\n"
argument_list|,
name|pname
argument_list|)
expr_stmt|;
name|clrent
argument_list|(
name|dptr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nptr
operator|+=
name|n
operator|+
literal|1
expr_stmt|;
name|strcpy
argument_list|(
name|np
argument_list|,
name|pname
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|decode
argument_list|(
argument|pname
argument_list|,
argument|dptr
argument_list|)
end_macro

begin_comment
comment|/* dptr points to the dir entry 			 * name is placed in pname[] */
end_comment

begin_decl_stmt
name|char
modifier|*
name|pname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|dent
modifier|*
name|dptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|strcpy
argument_list|(
name|pname
argument_list|,
name|dptr
operator|->
name|d_namep
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)tree.c	4.4 (Berkeley) 8/25/84"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"compact.h"
end_include

begin_macro
name|insert
argument_list|(
argument|ch
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ch
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|node
modifier|*
name|pp
decl_stmt|;
specifier|register
name|struct
name|son
modifier|*
name|pson
decl_stmt|,
modifier|*
name|bson
decl_stmt|;
name|union
name|cio
name|d
decl_stmt|;
specifier|register
name|struct
name|index
modifier|*
name|wt
decl_stmt|;
name|wt
operator|=
name|NEW
expr_stmt|;
name|pp
operator|=
name|bottom
operator|++
expr_stmt|;
name|pson
operator|=
operator|&
name|pp
operator|->
name|sons
index|[
name|RIGHT
index|]
expr_stmt|;
name|bson
operator|=
operator|&
name|bottom
operator|->
name|sons
index|[
name|LEFT
index|]
expr_stmt|;
name|bottom
operator|->
name|fath
operator|.
name|fp
operator|=
name|pp
expr_stmt|;
name|in
index|[
name|ch
index|]
operator|.
name|flags
operator|=
operator|(
name|SEEN
operator||
name|FBIT
operator|)
expr_stmt|;
name|d
operator|.
name|integ
operator|=
name|bson
operator|->
name|sp
operator|.
name|ch
operator|=
name|pson
operator|->
name|sp
operator|.
name|ch
expr_stmt|;
name|in
index|[
name|ch
index|]
operator|.
name|fp
operator|=
name|in
index|[
name|d
operator|.
name|integ
index|]
operator|.
name|fp
operator|=
name|pson
operator|->
name|sp
operator|.
name|p
operator|=
name|wt
operator|->
name|pt
operator|=
name|bottom
expr_stmt|;
name|bottom
operator|->
name|fath
operator|.
name|flags
operator|=
operator|(
name|LLEAF
operator||
name|RLEAF
operator||
name|FBIT
operator|)
expr_stmt|;
name|pp
operator|->
name|fath
operator|.
name|flags
operator|&=
operator|~
name|RLEAF
expr_stmt|;
name|in
index|[
name|d
operator|.
name|integ
index|]
operator|.
name|flags
operator|=
name|SEEN
expr_stmt|;
name|bson
operator|->
name|count
operator|=
name|pson
operator|->
name|count
expr_stmt|;
name|bson
operator|->
name|top
operator|=
name|pson
operator|->
name|top
expr_stmt|;
name|bson
operator|++
expr_stmt|;
name|bson
operator|->
name|sp
operator|.
name|ch
operator|=
name|ch
expr_stmt|;
name|bson
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|bson
operator|->
name|top
operator|=
name|pson
operator|->
name|top
operator|->
name|next
operator|=
name|wt
expr_stmt|;
name|wt
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
block|}
end_block

begin_macro
name|uptree
argument_list|(
argument|ch
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ch
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|node
modifier|*
name|r
decl_stmt|;
name|union
name|treep
name|q
decl_stmt|,
name|s
decl_stmt|;
name|int
name|rs
decl_stmt|,
name|ts
decl_stmt|,
name|rflags
decl_stmt|,
name|tflags
decl_stmt|;
name|longint
name|rc
decl_stmt|,
name|qc
decl_stmt|,
name|sc
decl_stmt|;
name|struct
name|node
modifier|*
name|t
decl_stmt|;
specifier|register
name|struct
name|son
modifier|*
name|rson
decl_stmt|,
modifier|*
name|tson
decl_stmt|;
specifier|register
name|struct
name|index
modifier|*
name|rt
decl_stmt|,
modifier|*
name|qt
decl_stmt|,
modifier|*
name|st
decl_stmt|;
name|r
operator|=
name|in
index|[
name|ch
index|]
operator|.
name|fp
expr_stmt|;
name|rs
operator|=
name|in
index|[
name|ch
index|]
operator|.
name|flags
operator|&
name|FBIT
expr_stmt|;
do|do
block|{
name|rson
operator|=
operator|&
name|r
operator|->
name|sons
index|[
name|rs
index|]
expr_stmt|;
name|rc
operator|=
operator|++
name|rson
operator|->
name|count
expr_stmt|;
name|rt
operator|=
name|rson
operator|->
name|top
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|rs
condition|)
block|{
name|s
operator|.
name|p
operator|=
name|r
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|bottom
condition|)
block|{
name|sc
operator|=
name|rc
operator|-
literal|2
expr_stmt|;
name|st
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|=
operator|(
name|r
operator|+
literal|1
operator|)
operator|->
name|sons
index|[
name|LEFT
index|]
operator|.
name|count
expr_stmt|;
name|st
operator|=
operator|(
name|r
operator|+
literal|1
operator|)
operator|->
name|sons
index|[
name|LEFT
index|]
operator|.
name|top
expr_stmt|;
block|}
name|qc
operator|=
name|r
operator|->
name|sons
index|[
name|LEFT
index|]
operator|.
name|count
expr_stmt|;
name|qt
operator|=
name|r
operator|->
name|sons
index|[
name|LEFT
index|]
operator|.
name|top
expr_stmt|;
block|}
else|else
block|{
name|s
operator|.
name|p
operator|=
name|r
expr_stmt|;
name|sc
operator|=
name|r
operator|->
name|sons
index|[
name|RIGHT
index|]
operator|.
name|count
expr_stmt|;
name|st
operator|=
name|r
operator|->
name|sons
index|[
name|RIGHT
index|]
operator|.
name|top
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|dict
condition|)
block|{
name|qc
operator|=
name|rc
operator|+
literal|1
expr_stmt|;
name|qt
operator|=
name|head
expr_stmt|;
break|break;
block|}
else|else
block|{
name|qc
operator|=
operator|(
name|r
operator|-
literal|1
operator|)
operator|->
name|sons
index|[
name|RIGHT
index|]
operator|.
name|count
expr_stmt|;
name|qt
operator|=
operator|(
name|r
operator|-
literal|1
operator|)
operator|->
name|sons
index|[
name|RIGHT
index|]
operator|.
name|top
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rc
operator|<=
name|qc
condition|)
break|break;
name|t
operator|=
name|qt
operator|->
name|pt
expr_stmt|;
name|ts
operator|=
name|LEFT
expr_stmt|;
name|tson
operator|=
operator|&
name|t
operator|->
name|sons
index|[
name|LEFT
index|]
expr_stmt|;
if|if
condition|(
name|rc
operator|<=
name|tson
operator|->
name|count
condition|)
block|{
name|tson
operator|++
expr_stmt|;
name|ts
operator|++
expr_stmt|;
block|}
comment|/* exchange pointers of (t, ts) and (r, rs) */
name|q
operator|.
name|ch
operator|=
name|tson
operator|->
name|sp
operator|.
name|ch
expr_stmt|;
name|s
operator|.
name|ch
operator|=
name|rson
operator|->
name|sp
operator|.
name|ch
expr_stmt|;
name|tson
operator|->
name|sp
operator|.
name|ch
operator|=
name|s
operator|.
name|ch
expr_stmt|;
name|rson
operator|->
name|sp
operator|.
name|ch
operator|=
name|q
operator|.
name|ch
expr_stmt|;
name|exch
argument_list|(
name|t
argument_list|,
name|ts
argument_list|,
name|q
operator|.
name|ch
argument_list|,
name|r
argument_list|,
name|rs
argument_list|)
expr_stmt|;
name|exch
argument_list|(
name|r
argument_list|,
name|rs
argument_list|,
name|s
operator|.
name|ch
argument_list|,
name|t
argument_list|,
name|ts
argument_list|)
expr_stmt|;
name|rflags
operator|=
operator|(
name|rs
condition|?
name|RLEAF
else|:
name|LLEAF
operator|)
expr_stmt|;
name|tflags
operator|=
operator|(
name|ts
condition|?
name|RLEAF
else|:
name|LLEAF
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|r
operator|->
name|fath
operator|.
name|flags
operator|&
name|rflags
operator|)
operator|<<
name|rs
operator|)
operator|^
operator|(
operator|(
name|t
operator|->
name|fath
operator|.
name|flags
operator|&
name|tflags
operator|)
operator|<<
name|ts
operator|)
condition|)
block|{
name|r
operator|->
name|fath
operator|.
name|flags
operator|^=
name|rflags
expr_stmt|;
name|t
operator|->
name|fath
operator|.
name|flags
operator|^=
name|tflags
expr_stmt|;
block|}
name|tson
operator|->
name|count
operator|++
expr_stmt|;
name|rson
operator|->
name|count
operator|--
expr_stmt|;
if|if
condition|(
name|ts
condition|)
name|qt
operator|->
name|pt
operator|++
expr_stmt|;
name|r
operator|=
name|t
expr_stmt|;
name|rs
operator|=
name|ts
expr_stmt|;
name|rson
operator|=
name|tson
expr_stmt|;
block|}
if|if
condition|(
name|rc
operator|==
name|qc
condition|)
block|{
name|rson
operator|->
name|top
operator|=
name|qt
expr_stmt|;
if|if
condition|(
name|rc
operator|>
name|sc
operator|+
literal|1
condition|)
block|{
name|qt
operator|->
name|next
operator|=
name|st
expr_stmt|;
comment|/* dispose of rt */
name|rt
operator|->
name|next
operator|=
name|flist
expr_stmt|;
name|flist
operator|=
name|rt
expr_stmt|;
block|}
else|else
name|st
operator|->
name|pt
operator|=
name|s
operator|.
name|p
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rc
operator|==
name|sc
operator|+
literal|1
condition|)
block|{
comment|/* create new index at rt */
name|rt
operator|=
name|NEW
expr_stmt|;
name|rt
operator|->
name|next
operator|=
name|st
expr_stmt|;
name|rt
operator|->
name|pt
operator|=
name|r
expr_stmt|;
name|qt
operator|->
name|next
operator|=
name|rt
expr_stmt|;
if|if
condition|(
name|st
condition|)
name|st
operator|->
name|pt
operator|=
name|s
operator|.
name|p
expr_stmt|;
name|rson
operator|->
name|top
operator|=
name|rt
expr_stmt|;
block|}
name|rs
operator|=
name|r
operator|->
name|fath
operator|.
name|flags
operator|&
name|FBIT
expr_stmt|;
name|r
operator|=
name|r
operator|->
name|fath
operator|.
name|fp
expr_stmt|;
block|}
do|while
condition|(
name|r
condition|)
do|;
name|dirp
operator|=
name|head
operator|->
name|next
expr_stmt|;
name|dirq
operator|=
name|dirp
operator|->
name|next
expr_stmt|;
block|}
end_block

begin_macro
name|exch
argument_list|(
argument|v
argument_list|,
argument|vs
argument_list|,
argument|x
argument_list|,
argument|w
argument_list|,
argument|ws
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|node
modifier|*
name|v
decl_stmt|,
modifier|*
name|w
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|union
name|treep
name|x
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|vs
decl_stmt|,
name|ws
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|v
operator|->
name|fath
operator|.
name|flags
operator|&
operator|(
name|vs
condition|?
name|RLEAF
else|:
name|LLEAF
operator|)
condition|)
block|{
name|in
index|[
name|x
operator|.
name|ch
index|]
operator|.
name|fp
operator|=
name|w
expr_stmt|;
name|in
index|[
name|x
operator|.
name|ch
index|]
operator|.
name|flags
operator|&=
operator|~
literal|01
expr_stmt|;
if|if
condition|(
name|ws
condition|)
name|in
index|[
name|x
operator|.
name|ch
index|]
operator|.
name|flags
operator||=
name|ws
expr_stmt|;
block|}
else|else
block|{
name|x
operator|.
name|p
operator|->
name|fath
operator|.
name|fp
operator|=
name|w
expr_stmt|;
name|x
operator|.
name|p
operator|->
name|fath
operator|.
name|flags
operator|&=
operator|~
literal|01
expr_stmt|;
if|if
condition|(
name|ws
condition|)
name|x
operator|.
name|p
operator|->
name|fath
operator|.
name|flags
operator||=
name|ws
expr_stmt|;
block|}
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1983,1988 Regents of the University of California.  * All rights reserved.  *  * Redistribution and use in source and binary forms are permitted  * provided that this notice is preserved and that due credit is given  * to the University of California at Berkeley. The name of the University  * may not be used to endorse or promote products derived from this  * software without specific prior written permission. This software  * is provided ``as is'' without express or implied warranty.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1983,1988 Regents of the University of California.\n\  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|not lint
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)implog.c	5.9 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|not lint
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_define
define|#
directive|define
name|IMPMESSAGES
end_define

begin_define
define|#
directive|define
name|IMPLEADERS
end_define

begin_include
include|#
directive|include
file|<netimp/if_imp.h>
end_include

begin_define
define|#
directive|define
name|min
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)< (b) ? (a) : (b))
end_define

begin_decl_stmt
name|u_char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|showdata
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|showcontents
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rawheader
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|follow
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|skip
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|link
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|host
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|imp
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|packettype
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|log
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|logfile
init|=
literal|"/usr/adm/implog"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Socket address, internet style, with  * unused space taken by timestamp and packet  * size.  */
end_comment

begin_struct
struct|struct
name|sockstamp
block|{
name|short
name|sin_family
decl_stmt|;
name|u_short
name|sin_port
decl_stmt|;
name|struct
name|in_addr
name|sin_addr
decl_stmt|;
name|time_t
name|sin_time
decl_stmt|;
name|int
name|sin_cc
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|sockstamp
name|from
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|struct
name|stat
name|b
decl_stmt|;
name|off_t
name|size
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|hostfrom
decl_stmt|,
name|impfrom
decl_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|0
operator|&&
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-D"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|showdata
operator|=
literal|0
expr_stmt|;
name|argv
operator|++
operator|,
name|argc
operator|--
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-f"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|follow
operator|++
expr_stmt|;
name|argv
operator|++
operator|,
name|argc
operator|--
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-F"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|skip
operator|++
expr_stmt|;
name|follow
operator|++
expr_stmt|;
name|argv
operator|++
operator|,
name|argc
operator|--
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-c"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|showcontents
operator|++
expr_stmt|;
name|argv
operator|++
operator|,
name|argc
operator|--
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-r"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rawheader
operator|++
expr_stmt|;
name|argv
operator|++
operator|,
name|argc
operator|--
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-l"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|link
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
block|}
else|else
name|link
operator|=
name|IMPLINK_IP
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-h"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"-h: missing host #\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|host
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
name|argv
operator|++
operator|,
name|argc
operator|--
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-i"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"-i: missing imp #\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|imp
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
name|argv
operator|++
operator|,
name|argc
operator|--
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-t"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
empty_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"-t: missing packet type\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|packettype
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
name|argv
operator|++
operator|,
name|argc
operator|--
expr_stmt|;
empty_stmt|;
continue|continue;
block|}
name|printf
argument_list|(
literal|"usage: implog [ -D ] [ -c ] [ -f ] [ -F ] [ -r ] [-h #] [-i #] [ -t # ] [-l [#]] [logfile]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|logfile
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|log
operator|=
name|open
argument_list|(
name|logfile
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fstat
argument_list|(
name|log
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|size
operator|=
name|b
operator|.
name|st_size
expr_stmt|;
if|if
condition|(
name|skip
condition|)
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|log
argument_list|,
name|size
argument_list|,
name|L_SET
argument_list|)
expr_stmt|;
name|again
label|:
while|while
condition|(
name|read
argument_list|(
name|log
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|from
argument_list|,
sizeof|sizeof
argument_list|(
name|from
argument_list|)
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|from
argument_list|)
condition|)
block|{
if|if
condition|(
name|from
operator|.
name|sin_family
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"restarted: %.24s\n"
argument_list|,
name|ctime
argument_list|(
operator|&
name|from
operator|.
name|sin_time
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|host
operator|>=
literal|0
condition|)
block|{
name|long
name|addr
init|=
name|ntohs
argument_list|(
name|from
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|IN_CLASSA
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|hostfrom
operator|=
operator|(
operator|(
name|addr
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
operator|)
expr_stmt|;
name|impfrom
operator|=
name|addr
operator|&
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IN_CLASSB
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|hostfrom
operator|=
operator|(
operator|(
name|addr
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
operator|)
expr_stmt|;
name|impfrom
operator|=
name|addr
operator|&
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
name|hostfrom
operator|=
operator|(
operator|(
name|addr
operator|>>
literal|4
operator|)
operator|&
literal|0xF
operator|)
expr_stmt|;
name|impfrom
operator|=
name|addr
operator|&
literal|0xF
expr_stmt|;
block|}
block|}
if|if
condition|(
name|host
operator|>=
literal|0
operator|&&
name|hostfrom
operator|!=
name|host
condition|)
block|{
name|lseek
argument_list|(
name|log
argument_list|,
name|from
operator|.
name|sin_cc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|imp
operator|>=
literal|0
operator|&&
name|impfrom
operator|!=
name|imp
condition|)
block|{
name|lseek
argument_list|(
name|log
argument_list|,
name|from
operator|.
name|sin_cc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|process
argument_list|(
name|log
argument_list|,
operator|&
name|from
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|follow
condition|)
block|{
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|fstat
argument_list|(
name|log
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|.
name|st_size
operator|>
name|size
condition|)
block|{
name|size
operator|=
name|b
operator|.
name|st_size
expr_stmt|;
goto|goto
name|again
goto|;
block|}
block|}
block|}
end_function

begin_decl_stmt
name|int
name|impdata
argument_list|()
decl_stmt|,
name|impbadleader
argument_list|()
decl_stmt|,
name|impdown
argument_list|()
decl_stmt|,
name|impnoop
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|imprfnm
argument_list|()
decl_stmt|,
name|impincomplete
argument_list|()
decl_stmt|,
name|imphostdead
argument_list|()
decl_stmt|,
name|imphostunreach
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|impbaddata
argument_list|()
decl_stmt|,
name|impreset
argument_list|()
decl_stmt|,
name|impretry
argument_list|()
decl_stmt|,
name|impnotify
argument_list|()
decl_stmt|,
name|imptrying
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|impready
argument_list|()
decl_stmt|,
name|impundef
argument_list|()
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|messages
block|{
name|u_char
name|m_type
decl_stmt|;
comment|/* type of message */
name|int
function_decl|(
modifier|*
name|m_func
function_decl|)
parameter_list|()
function_decl|;
comment|/* routine to process message */
block|}
name|mtypes
index|[]
init|=
block|{
block|{
name|IMPTYPE_DATA
block|,
name|impdata
block|}
block|,
block|{
name|IMPTYPE_BADLEADER
block|,
name|impbadleader
block|}
block|,
block|{
name|IMPTYPE_DOWN
block|,
name|impdown
block|}
block|,
block|{
name|IMPTYPE_NOOP
block|,
name|impnoop
block|}
block|,
block|{
name|IMPTYPE_RFNM
block|,
name|imprfnm
block|}
block|,
block|{
name|IMPTYPE_INCOMPLETE
block|,
name|impincomplete
block|}
block|,
block|{
name|IMPTYPE_HOSTDEAD
block|,
name|imphostdead
block|}
block|,
block|{
name|IMPTYPE_HOSTUNREACH
block|,
name|imphostunreach
block|}
block|,
block|{
name|IMPTYPE_BADDATA
block|,
name|impbaddata
block|}
block|,
block|{
name|IMPTYPE_RESET
block|,
name|impreset
block|}
block|,
block|{
name|IMPTYPE_RETRY
block|,
name|impretry
block|}
block|,
block|{
name|IMPTYPE_NOTIFY
block|,
name|impnotify
block|}
block|,
block|{
name|IMPTYPE_TRYING
block|,
name|imptrying
block|}
block|,
block|{
name|IMPTYPE_READY
block|,
name|impready
block|}
block|,
block|{
operator|-
literal|1
block|,
name|impundef
block|}
block|}
struct|;
end_struct

begin_comment
comment|/*  * Print a packet.  */
end_comment

begin_macro
name|process
argument_list|(
argument|l
argument_list|,
argument|f
argument_list|)
end_macro

begin_decl_stmt
name|int
name|l
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockstamp
modifier|*
name|f
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|messages
modifier|*
name|mp
decl_stmt|;
name|struct
name|imp_leader
modifier|*
name|ip
decl_stmt|;
name|int
function_decl|(
modifier|*
name|fn
function_decl|)
parameter_list|()
function_decl|;
if|if
condition|(
name|read
argument_list|(
name|l
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|f
operator|->
name|sin_cc
argument_list|)
operator|!=
name|f
operator|->
name|sin_cc
condition|)
block|{
name|perror
argument_list|(
literal|"read"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ip
operator|=
operator|(
expr|struct
name|imp_leader
operator|*
operator|)
name|buf
expr_stmt|;
name|ip
operator|->
name|il_imp
operator|=
name|ntohs
argument_list|(
name|ip
operator|->
name|il_imp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_format
operator|!=
name|IMP_NFF
condition|)
name|fn
operator|=
name|impundef
expr_stmt|;
else|else
block|{
for|for
control|(
name|mp
operator|=
name|mtypes
init|;
name|mp
operator|->
name|m_type
operator|!=
operator|(
name|u_char
operator|)
operator|-
literal|1
condition|;
name|mp
operator|++
control|)
if|if
condition|(
name|mp
operator|->
name|m_type
operator|==
name|ip
operator|->
name|il_mtype
condition|)
break|break;
name|fn
operator|=
name|mp
operator|->
name|m_func
expr_stmt|;
block|}
if|if
condition|(
name|ip
operator|->
name|il_mtype
operator|==
name|IMPTYPE_DATA
condition|)
block|{
if|if
condition|(
name|link
operator|>=
literal|0
operator|&&
name|ip
operator|->
name|il_link
operator|!=
name|link
condition|)
return|return;
if|if
condition|(
operator|!
name|showdata
condition|)
return|return;
block|}
if|if
condition|(
name|packettype
operator|>=
literal|0
operator|&&
name|ip
operator|->
name|il_mtype
operator|!=
name|packettype
condition|)
return|return;
name|printf
argument_list|(
literal|"%.24s: "
argument_list|,
name|ctime
argument_list|(
operator|&
name|f
operator|->
name|sin_time
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|sin_cc
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|control_leader
argument_list|)
condition|)
name|printf
argument_list|(
literal|"(truncated header, %d bytes): "
argument_list|,
name|f
operator|->
name|sin_cc
argument_list|)
expr_stmt|;
call|(
modifier|*
name|fn
call|)
argument_list|(
name|ip
argument_list|,
name|f
operator|->
name|sin_cc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rawheader
operator|&&
name|fn
operator|!=
name|impundef
condition|)
block|{
name|putchar
argument_list|(
literal|'\t'
argument_list|)
expr_stmt|;
name|impundef
argument_list|(
name|ip
argument_list|,
name|f
operator|->
name|sin_cc
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|impdata
argument_list|(
name|ip
argument_list|,
name|cc
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"<DATA, source=%d/%d, link="
argument_list|,
name|ip
operator|->
name|il_host
argument_list|,
operator|(
name|u_short
operator|)
name|ip
operator|->
name|il_imp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_link
operator|==
name|IMPLINK_IP
condition|)
name|printf
argument_list|(
literal|"ip,"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%d,"
argument_list|,
name|ip
operator|->
name|il_link
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" len=%d bytes>\n"
argument_list|,
name|ntohs
argument_list|(
operator|(
name|u_short
operator|)
name|ip
operator|->
name|il_length
argument_list|)
operator|>>
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|showcontents
condition|)
block|{
specifier|register
name|u_char
modifier|*
name|cp
init|=
operator|(
operator|(
name|u_char
operator|*
operator|)
name|ip
operator|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|i
operator|=
operator|(
name|ntohs
argument_list|(
name|ip
operator|->
name|il_length
argument_list|)
operator|>>
literal|3
operator|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|imp_leader
argument_list|)
expr_stmt|;
name|cc
operator|=
name|min
argument_list|(
name|i
argument_list|,
name|cc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"data: (%d bytes)"
argument_list|,
name|cc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cc
condition|;
name|i
operator|++
operator|,
name|cp
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|25
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02x "
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|badleader
index|[]
init|=
block|{
literal|"error flip-flop set"
block|,
literal|"message< 80 bits"
block|,
literal|"illegal type field"
block|,
literal|"opposite leader type"
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|impbadleader
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"bad leader: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_subtype
operator|>
name|IMPLEADER_OPPOSITE
condition|)
name|printf
argument_list|(
literal|"%x\n"
argument_list|,
name|ip
operator|->
name|il_subtype
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|badleader
index|[
name|ip
operator|->
name|il_subtype
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|impdown
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|tdown
decl_stmt|,
name|tbackup
decl_stmt|;
name|printf
argument_list|(
literal|"imp going down %s"
argument_list|,
name|impmessage
index|[
name|ip
operator|->
name|il_link
operator|&
name|IMP_DMASK
index|]
argument_list|)
expr_stmt|;
name|tdown
operator|=
operator|(
operator|(
name|ip
operator|->
name|il_link
operator|>>
name|IMPDOWN_WHENSHIFT
operator|)
operator|&
name|IMPDOWN_WHENMASK
operator|)
operator|*
name|IMPDOWN_WHENUNIT
expr_stmt|;
if|if
condition|(
operator|(
name|ip
operator|->
name|il_link
operator|&
name|IMP_DMASK
operator|)
operator|!=
name|IMPDOWN_GOING
condition|)
name|printf
argument_list|(
literal|" in %d minutes"
argument_list|,
name|tdown
argument_list|)
expr_stmt|;
name|tbackup
operator|=
name|ip
operator|->
name|il_subtype
operator|*
name|IMPDOWN_WHENUNIT
expr_stmt|;
name|printf
argument_list|(
literal|": back up "
argument_list|)
expr_stmt|;
if|if
condition|(
name|tbackup
condition|)
name|printf
argument_list|(
literal|"%d minutes\n"
argument_list|,
name|tbackup
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"immediately\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|impnoop
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"noop: host %d, imp %d\n"
argument_list|,
name|ip
operator|->
name|il_host
argument_list|,
operator|(
name|u_short
operator|)
name|ip
operator|->
name|il_imp
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|imprfnm
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"rfnm: htype=%x, source=%d/%d, link="
argument_list|,
name|ip
operator|->
name|il_htype
argument_list|,
name|ip
operator|->
name|il_host
argument_list|,
name|ip
operator|->
name|il_imp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_link
operator|==
name|IMPLINK_IP
condition|)
name|printf
argument_list|(
literal|"ip,"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%d,"
argument_list|,
name|ip
operator|->
name|il_link
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" subtype=%x\n"
argument_list|,
name|ip
operator|->
name|il_subtype
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|hostdead
index|[]
init|=
block|{
literal|"#0"
block|,
literal|"ready-line negated"
block|,
literal|"tardy receiving messages"
block|,
literal|"ncc doesn't know host"
block|,
literal|"imp software won't allow messages"
block|,
literal|"host down for scheduled pm"
block|,
literal|"host down for hardware work"
block|,
literal|"host down for software work"
block|,
literal|"host down for emergency restart"
block|,
literal|"host down because of power outage"
block|,
literal|"host stopped at a breakpoint"
block|,
literal|"host down due to hardware failure"
block|,
literal|"host not scheduled to be up"
block|,
literal|"#13"
block|,
literal|"#14"
block|,
literal|"host in the process of coming up"
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|imphostdead
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"host %d/%d dead: "
argument_list|,
name|ip
operator|->
name|il_host
argument_list|,
name|ip
operator|->
name|il_imp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_link
operator|&
name|IMP_DMASK
condition|)
name|printf
argument_list|(
literal|"down %s, "
argument_list|,
name|impmessage
index|[
name|ip
operator|->
name|il_link
operator|&
name|IMP_DMASK
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_subtype
operator|<=
name|IMPHOST_COMINGUP
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|hostdead
index|[
name|ip
operator|->
name|il_subtype
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"subtype=%x\n"
argument_list|,
name|ip
operator|->
name|il_subtype
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|hostunreach
index|[]
init|=
block|{
literal|"destination imp can't be reached"
block|,
literal|"destination host isn't up"
block|,
literal|"host doesn't support long leader"
block|,
literal|"communication is prohibited"
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|imphostunreach
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"host %d/%d unreachable: "
argument_list|,
name|ip
operator|->
name|il_host
argument_list|,
name|ip
operator|->
name|il_imp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_subtype
operator|<=
name|IMPREACH_PROHIBITED
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|hostunreach
index|[
name|ip
operator|->
name|il_subtype
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"subtype=%x\n"
argument_list|,
name|ip
operator|->
name|il_subtype
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|impbaddata
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"error in data: htype=%x, source=%d/%d, link="
argument_list|,
name|ip
operator|->
name|il_htype
argument_list|,
name|ip
operator|->
name|il_host
argument_list|,
name|ip
operator|->
name|il_imp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_link
operator|==
name|IMPLINK_IP
condition|)
name|printf
argument_list|(
literal|"ip, "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%d, "
argument_list|,
name|ip
operator|->
name|il_link
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"subtype=%x\n"
argument_list|,
name|ip
operator|->
name|il_subtype
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|incomplete
index|[]
init|=
block|{
literal|"host didn't take data fast enough"
block|,
literal|"message was too long"
block|,
literal|"message transmission time> 15 seconds"
block|,
literal|"imp/circuit failure"
block|,
literal|"no resources within 15 seconds"
block|,
literal|"source imp i/o failure during receipt"
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|impincomplete
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"incomplete: htype=%x, source=%d/%d, link="
argument_list|,
name|ip
operator|->
name|il_htype
argument_list|,
name|ip
operator|->
name|il_host
argument_list|,
name|ip
operator|->
name|il_imp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_link
operator|==
name|IMPLINK_IP
condition|)
name|printf
argument_list|(
literal|"ip,"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%d,"
argument_list|,
name|ip
operator|->
name|il_link
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_subtype
operator|<=
name|IMPCOMPLETE_IMPIO
condition|)
name|printf
argument_list|(
literal|" %s\n"
argument_list|,
name|incomplete
index|[
name|ip
operator|->
name|il_subtype
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" subtype=%x\n"
argument_list|,
name|ip
operator|->
name|il_subtype
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|impreset
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"reset complete\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|retry
index|[]
init|=
block|{
literal|"imp buffer wasn't available"
block|,
literal|"connection block unavailable"
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|impretry
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"refused, try again: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_subtype
operator|<=
name|IMPRETRY_BLOCK
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|retry
index|[
name|ip
operator|->
name|il_subtype
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"subtype=%x\n"
argument_list|,
name|ip
operator|->
name|il_subtype
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|notify
index|[]
init|=
block|{
literal|"#0"
block|,
literal|"#1"
block|,
literal|"connection not available"
block|,
literal|"reassembly space not available at destination"
block|,
literal|"message number not available"
block|,
literal|"transaction block for message not available"
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|impnotify
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"refused, will notify: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_subtype
operator|<=
literal|5
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|notify
index|[
name|ip
operator|->
name|il_subtype
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"subtype=%x\n"
argument_list|,
name|ip
operator|->
name|il_subtype
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|imptrying
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"refused, still trying\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|impready
argument_list|(
name|ip
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"ready\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|impundef
argument_list|(
name|ip
argument_list|,
name|len
argument_list|)
specifier|register
expr|struct
name|imp_leader
operator|*
name|ip
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"<fmt=%x, net=%x, flags=%x, mtype="
argument_list|,
name|ip
operator|->
name|il_format
argument_list|,
name|ip
operator|->
name|il_network
argument_list|,
name|ip
operator|->
name|il_flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%x, htype=%x,\n\t host=%d(x%x), imp=%d(x%x), link="
argument_list|,
name|ip
operator|->
name|il_mtype
argument_list|,
name|ip
operator|->
name|il_htype
argument_list|,
name|ip
operator|->
name|il_host
argument_list|,
name|ip
operator|->
name|il_host
argument_list|,
name|ip
operator|->
name|il_imp
argument_list|,
name|ip
operator|->
name|il_imp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|il_link
operator|==
name|IMPLINK_IP
condition|)
name|printf
argument_list|(
literal|"ip,"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%d (x%x),"
argument_list|,
name|ip
operator|->
name|il_link
argument_list|,
name|ip
operator|->
name|il_link
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" subtype=%x"
argument_list|,
name|ip
operator|->
name|il_subtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|imp_leader
argument_list|)
operator|&&
name|ip
operator|->
name|il_length
condition|)
name|printf
argument_list|(
literal|" len=%d bytes"
argument_list|,
name|ntohs
argument_list|(
operator|(
name|u_short
operator|)
name|ip
operator|->
name|il_length
argument_list|)
operator|>>
literal|3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|">\n"
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/uba.h"
end_include

begin_include
include|#
directive|include
file|"../h/map.h"
end_include

begin_function
name|int
name|uballoc
parameter_list|(
name|baddr
parameter_list|,
name|bcnt
parameter_list|,
name|bdpflg
parameter_list|)
name|char
name|bdpflg
decl_stmt|;
name|char
modifier|*
name|baddr
decl_stmt|;
name|unsigned
name|short
name|bcnt
decl_stmt|;
block|{
comment|/* *  Allocate as many contiguous UBA mapping registers *  as are necessary to do transfer of 'bcnt' bytes *  to/from location 'baddr'. *  Wait for enough map registers. *  'bdpflg' is non-zero if a "buffered data path" (BDP) is *  to be used, else 0 -> use direct data path (DDP) . *  Return * *    |31 - - 28|27 - - 18|17 - - - 9|8 - - 0| *    |         |         |          |       | *    |  BDP    |   no.   |  start   | byte  | *    |   no.   | mapping |   map    | offset| *    |         |  reg's  | reg. no. |       | *    |         |         |          |       | * */
specifier|register
name|regnum
operator|,
name|nmreg
operator|,
name|bdp
operator|,
name|pfn
operator|,
name|j
expr_stmt|;
comment|/* calculate no. of mapping reg's required */
name|nmreg
operator|=
name|btoc
argument_list|(
name|bcnt
argument_list|)
operator|+
literal|2
expr_stmt|;
name|pfn
operator|=
operator|(
operator|(
name|int
operator|)
name|baddr
operator|>>
literal|9
operator|)
operator|&
literal|0xfff
expr_stmt|;
comment|/* start page frame no. */
name|spl6
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|regnum
operator|=
name|malloc
argument_list|(
name|ubamap
argument_list|,
name|nmreg
argument_list|)
operator|-
literal|1
operator|)
operator|<
literal|0
condition|)
block|{
comment|/* wait for no. of mapping reg's requested */
name|umrwant
operator|++
expr_stmt|;
name|sleep
argument_list|(
name|ubamap
argument_list|,
name|PSWP
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bdpflg
condition|)
comment|/* buffered data path BDP 1-15 */
while|while
condition|(
operator|(
name|bdp
operator|=
name|malloc
argument_list|(
name|bdpmap
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|bdpwant
operator|++
expr_stmt|;
name|sleep
argument_list|(
name|bdpmap
argument_list|,
name|PSWP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* BDP 0 = DDP */
name|bdp
operator|=
literal|0
expr_stmt|;
block|}
name|spl0
argument_list|()
expr_stmt|;
name|j
operator|=
operator|(
name|bdp
operator|<<
literal|28
operator|)
operator||
operator|(
name|nmreg
operator|<<
literal|18
operator|)
operator||
operator|(
name|regnum
operator|<<
literal|9
operator|)
operator||
operator|(
operator|(
name|int
operator|)
name|baddr
operator|&
literal|0x01ff
operator|)
expr_stmt|;
name|pfn
operator||=
operator|(
name|MRV
operator||
operator|(
name|bdp
operator|<<
literal|21
operator|)
operator|)
expr_stmt|;
comment|/* map reg entry */
if|if
condition|(
name|bdp
operator|&&
operator|(
operator|(
name|int
operator|)
name|baddr
operator|&
literal|01
operator|)
condition|)
name|pfn
operator||=
name|BO
expr_stmt|;
comment|/* byte offset */
while|while
condition|(
operator|--
name|nmreg
condition|)
comment|/* fill the memory mapping reg's */
operator|(
operator|(
expr|struct
name|uba_regs
operator|*
operator|)
name|UBA0
operator|)
operator|->
name|uba_map
index|[
name|regnum
operator|++
index|]
operator|=
name|pfn
operator|++
expr_stmt|;
operator|(
operator|(
expr|struct
name|uba_regs
operator|*
operator|)
name|UBA0
operator|)
operator|->
name|uba_map
index|[
name|regnum
index|]
operator|=
literal|0
expr_stmt|;
comment|/* last entry is invalid */
return|return
operator|(
name|j
operator|)
return|;
block|}
end_function

begin_comment
comment|/*							*/
end_comment

begin_macro
name|ubafree
argument_list|(
argument|mr
argument_list|)
end_macro

begin_decl_stmt
name|int
name|mr
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* *  Free UBA memory mapping reg's and a BDP no.. *    mr : *		bits 0 - 3 :  bdp no. *	    	 4 - 15 : start map reg. no. *			16 - 31 : no. of mapping reg's * */
specifier|register
name|bdp
operator|,
name|nmreg
operator|,
name|regnum
expr_stmt|;
name|spl6
argument_list|()
expr_stmt|;
name|bdp
operator|=
operator|(
name|mr
operator|>>
literal|28
operator|)
operator|&
literal|0x0f
expr_stmt|;
comment|/* BDP no. */
if|if
condition|(
name|bdp
condition|)
block|{
operator|(
operator|(
expr|struct
name|uba_regs
operator|*
operator|)
name|UBA0
operator|)
operator|->
name|uba_dpr
index|[
name|bdp
index|]
operator||=
name|BNE
expr_stmt|;
comment|/* purge */
name|mfree
argument_list|(
name|bdpmap
argument_list|,
literal|1
argument_list|,
name|bdp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bdpwant
condition|)
block|{
name|bdpwant
operator|=
literal|0
expr_stmt|;
name|wakeup
argument_list|(
name|bdpmap
argument_list|)
expr_stmt|;
block|}
block|}
name|nmreg
operator|=
operator|(
name|mr
operator|>>
literal|18
operator|)
operator|&
literal|0x3ff
expr_stmt|;
comment|/* no. of mapping reg's */
name|regnum
operator|=
operator|(
name|mr
operator|>>
literal|9
operator|)
operator|&
literal|0x1ff
expr_stmt|;
comment|/* 1st map reg. no. */
comment|/* free mapping reg's */
name|mfree
argument_list|(
name|ubamap
argument_list|,
name|nmreg
argument_list|,
name|regnum
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|umrwant
condition|)
block|{
name|umrwant
operator|=
literal|0
expr_stmt|;
name|wakeup
argument_list|(
name|ubamap
argument_list|)
expr_stmt|;
block|}
name|spl0
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|ubainit
argument_list|()
end_macro

begin_block
block|{
name|mfree
argument_list|(
name|ubamap
argument_list|,
literal|496
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mfree
argument_list|(
name|bdpmap
argument_list|,
literal|15
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


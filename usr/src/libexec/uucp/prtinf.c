begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* prtinf.c    Routines to gather information about ports and dialers from    configuration files.     Copyright (C) 1991, 1992 Ian Lance Taylor     This file is part of the Taylor UUCP package.     This program is free software; you can redistribute it and/or    modify it under the terms of the GNU General Public License as    published by the Free Software Foundation; either version 2 of the    License, or (at your option) any later version.     This program is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.     The author of the program may be contacted at ian@airs.com or    c/o AIRS, P.O. Box 520, Waltham, MA 02254.     $Log: prtinf.c,v $    Revision 1.20  1992/04/02  22:51:09  ian    Add gcc 2.0 format checking to ulog, and fixed discovered problems     Revision 1.19  1992/03/28  21:47:55  ian    David J. MacKenzie: allow backslash to quote newline in config files     Revision 1.18  1992/03/10  21:47:39  ian    Added protocol command for ports     Revision 1.17  1992/03/08  04:56:21  ian    Peter da Silva: added ``lockname'' command for ports     Revision 1.16  1992/03/03  06:06:48  ian    T. William Wells: don't complain about missing configuration files     Revision 1.15  1992/02/08  03:54:18  ian    Include<string.h> only in<uucp.h>, added 1992 copyright     Revision 1.14  1992/01/14  04:04:17  ian    Chip Salzenberg: strcmp is a macro on AIX     Revision 1.13  1992/01/11  17:11:11  ian    Hannu Strang: avoid compiler bug by not using -> in address constant     Revision 1.12  1991/12/22  20:57:57  ian    Added externs for strcasecmp or strncasecmp     Revision 1.11  1991/12/17  23:14:08  ian    T. William Wells: allow dialer complete and abort to be chat scripts     Revision 1.10  1991/12/17  17:08:02  ian    Marc Unangst: allow true and false for boolean strings as documented     Revision 1.9  1991/12/15  03:42:33  ian    Added tprocess_chat_cmd for all chat commands, and added CMDTABTYPE_PREFIX     Revision 1.8  1991/12/09  18:26:33  ian    Richard Todd: handle "#" command generated by multiple dialer files     Revision 1.7  1991/12/02  21:25:36  ian    Niels Baggesen: protocol-parameter for ports and dialers didn't work     Revision 1.6  1991/11/30  22:55:03  ian    Marty Shannon: blew up if more than one port in port file!     Revision 1.5  1991/11/14  03:20:13  ian    Added seven-bit and reliable commands to help when selecting protocols     Revision 1.4  1991/11/13  20:38:00  ian    Added TCP port type for connections over TCP     Revision 1.3  1991/11/11  23:47:24  ian    Added chat-program to run a program to do a chat script     Revision 1.2  1991/11/11  16:59:05  ian    Eliminate fread_port_info, allow NULL pflock arg to ffind_port     Revision 1.1  1991/09/10  19:40:31  ian    Initial revision     */
end_comment

begin_include
include|#
directive|include
file|"uucp.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
name|char
name|prtinf_rcsid
index|[]
init|=
literal|"$Id: prtinf.c,v 1.20 1992/04/02 22:51:09 ian Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"port.h"
end_include

begin_comment
comment|/* External functions.  */
end_comment

begin_function_decl
specifier|extern
name|int
name|strcasecmp
parameter_list|()
function_decl|;
end_function_decl

begin_escape
end_escape

begin_comment
comment|/* Ports are defined in a file.  This file has to be both flexible and    easy to use.  The format is described in a separate documentation    file.  */
end_comment

begin_escape
end_escape

begin_if
if|#
directive|if
name|HAVE_TAYLOR_CONFIG
end_if

begin_comment
comment|/* The string names of the port types.  This array corresponds to the    tporttype enumeration.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|azPtype_names
index|[]
init|=
block|{
literal|"stdin"
block|,
literal|"modem"
block|,
literal|"direct"
block|,
if|#
directive|if
name|HAVE_TCP
literal|"tcp"
block|,
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CPORT_TYPES
value|(sizeof azPtype_names / sizeof azPtype_names[0])
end_define

begin_escape
end_escape

begin_comment
comment|/* The port structure used by the command tables.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|sport
name|sPort
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The generic port command table.  */
end_comment

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpexit
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpdup_type
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpproto_param
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpseven_bit
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpreliable
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scmdtab
name|asPort_cmds
index|[]
init|=
block|{
block|{
literal|"type"
block|,
name|CMDTABTYPE_FN
operator||
literal|2
block|,
name|NULL
block|,
name|tpdup_type
block|}
block|,
block|{
literal|"protocol"
block|,
name|CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|zprotocols
block|,
name|NULL
block|}
block|,
block|{
literal|"protocol-parameter"
block|,
name|CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|tpproto_param
block|}
block|,
block|{
literal|"seven-bit"
block|,
name|CMDTABTYPE_FN
operator||
literal|2
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|ireliable
block|,
name|tpseven_bit
block|}
block|,
block|{
literal|"reliable"
block|,
name|CMDTABTYPE_FN
operator||
literal|2
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|ireliable
block|,
name|tpreliable
block|}
block|,
block|{
literal|"lockname"
block|,
name|CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|zlockname
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CPORT_CMDS
value|(sizeof asPort_cmds / sizeof asPort_cmds[0])
end_define

begin_comment
comment|/* The stdin port command table.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|scmdtab
name|asPstdin_cmds
index|[]
init|=
block|{
ifdef|#
directive|ifdef
name|SYSDEP_STDIN_CMDS
name|SYSDEP_STDIN_CMDS
argument_list|(
name|sPort
operator|.
name|u
operator|.
name|sstdin
operator|.
name|s
argument_list|)
block|,
endif|#
directive|endif
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CSTDIN_CMDS
value|(sizeof asPstdin_cmds / sizeof asPstdin_cmds[0])
end_define

begin_comment
comment|/* The modem port command table.  */
end_comment

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpdialer
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpbaud_range
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scmdtab
name|asPmodem_cmds
index|[]
init|=
block|{
block|{
literal|"device"
block|,
name|CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|zdevice
block|,
name|NULL
block|}
block|,
block|{
literal|"baud"
block|,
name|CMDTABTYPE_LONG
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|ibaud
block|,
name|NULL
block|}
block|,
block|{
literal|"speed"
block|,
name|CMDTABTYPE_LONG
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|ibaud
block|,
name|NULL
block|}
block|,
block|{
literal|"baud-range"
block|,
name|CMDTABTYPE_FN
operator||
literal|3
block|,
name|NULL
block|,
name|tpbaud_range
block|}
block|,
block|{
literal|"speed-range"
block|,
name|CMDTABTYPE_FN
operator||
literal|3
block|,
name|NULL
block|,
name|tpbaud_range
block|}
block|,
block|{
literal|"carrier"
block|,
name|CMDTABTYPE_BOOLEAN
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|fcarrier
block|,
name|NULL
block|}
block|,
block|{
literal|"dial-device"
block|,
name|CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|zdial_device
block|,
name|NULL
block|}
block|,
block|{
literal|"dialer"
block|,
name|CMDTABTYPE_FN
operator||
literal|0
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|qdialer
block|,
name|tpdialer
block|}
block|,
block|{
literal|"dialer-sequence"
block|,
name|CMDTABTYPE_FULLSTRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|zdialer
block|,
name|NULL
block|}
block|,
ifdef|#
directive|ifdef
name|SYSDEP_MODEM_CMDS
name|SYSDEP_MODEM_CMDS
argument_list|(
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|s
argument_list|)
block|;
endif|#
directive|endif
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CMODEM_CMDS
value|(sizeof asPmodem_cmds / sizeof asPmodem_cmds[0])
end_define

begin_comment
comment|/* The direct port command table.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|scmdtab
name|asPdirect_cmds
index|[]
init|=
block|{
block|{
literal|"device"
block|,
name|CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|sdirect
operator|.
name|zdevice
block|,
name|NULL
block|}
block|,
block|{
literal|"baud"
block|,
name|CMDTABTYPE_LONG
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|sdirect
operator|.
name|ibaud
block|,
name|NULL
block|}
block|,
block|{
literal|"speed"
block|,
name|CMDTABTYPE_LONG
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|sdirect
operator|.
name|ibaud
block|,
name|NULL
block|}
block|,
ifdef|#
directive|ifdef
name|SYSDEP_DIRECT_CMDS
name|SYSDEP_DIRECT_CMDS
argument_list|(
name|sPort
operator|.
name|u
operator|.
name|sdirect
operator|.
name|s
argument_list|)
block|;
endif|#
directive|endif
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CDIRECT_CMDS
value|(sizeof asPdirect_cmds / sizeof asPdirect_cmds[0])
end_define

begin_if
if|#
directive|if
name|HAVE_TCP
end_if

begin_comment
comment|/* The TCP port command table.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|scmdtab
name|asPtcp_cmds
index|[]
init|=
block|{
block|{
literal|"service"
block|,
name|CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPort
operator|.
name|u
operator|.
name|stcp
operator|.
name|zport
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CTCP_CMDS
value|(sizeof asPtcp_cmds / sizeof asPtcp_cmds[0])
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* ! HAVE_TCP */
end_comment

begin_define
define|#
directive|define
name|CTCP_CMDS
value|(0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ! HAVE_TCP */
end_comment

begin_escape
end_escape

begin_comment
comment|/* A little routine to exit when another port command is seen.  This    will cause confusion if somebody types ``port port foo'' in the    system file.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpexit
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
return|return
name|CMDTABRET_EXIT
return|;
block|}
end_function

begin_comment
comment|/* A little routine to give a warning about duplicate type commands.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpdup_type
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: type: Ignoring extraneous command"
argument_list|,
name|zerr
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
end_function

begin_comment
comment|/* Handle protocol parameter settings for ports.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpproto_param
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
return|return
name|tadd_proto_param
argument_list|(
operator|&
name|sPort
operator|.
name|cproto_params
argument_list|,
operator|&
name|sPort
operator|.
name|qproto_params
argument_list|,
name|zerr
argument_list|,
name|argc
operator|-
literal|1
argument_list|,
name|argv
operator|+
literal|1
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Handle the ``seven-bit'' command for ports or dialers.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpseven_bit
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
name|char
name|b
decl_stmt|;
name|boolean
name|fset
decl_stmt|;
name|int
modifier|*
name|pi
init|=
operator|(
name|int
operator|*
operator|)
name|pvar
decl_stmt|;
name|b
operator|=
name|argv
index|[
literal|1
index|]
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|b
operator|==
literal|'y'
operator|||
name|b
operator|==
literal|'Y'
operator|||
name|b
operator|==
literal|'t'
operator|||
name|b
operator|==
literal|'T'
condition|)
name|fset
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|==
literal|'n'
operator|||
name|b
operator|==
literal|'N'
operator|||
name|b
operator|==
literal|'f'
operator|||
name|b
operator|==
literal|'F'
condition|)
name|fset
operator|=
name|FALSE
expr_stmt|;
else|else
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: %s: %s: Bad boolean"
argument_list|,
name|zerr
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
operator|*
name|pi
operator||=
name|RELIABLE_SPECIFIED
expr_stmt|;
if|if
condition|(
name|fset
condition|)
operator|*
name|pi
operator||=
name|RELIABLE_EIGHT
expr_stmt|;
else|else
operator|*
name|pi
operator|&=
operator|~
name|RELIABLE_EIGHT
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
end_function

begin_comment
comment|/* Handle the ``reliable'' command for ports or dialers.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpreliable
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
name|char
name|b
decl_stmt|;
name|boolean
name|fset
decl_stmt|;
name|int
modifier|*
name|pi
init|=
operator|(
name|int
operator|*
operator|)
name|pvar
decl_stmt|;
name|b
operator|=
name|argv
index|[
literal|1
index|]
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|b
operator|==
literal|'y'
operator|||
name|b
operator|==
literal|'Y'
operator|||
name|b
operator|==
literal|'t'
operator|||
name|b
operator|==
literal|'T'
condition|)
name|fset
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|==
literal|'n'
operator|||
name|b
operator|==
literal|'N'
operator|||
name|b
operator|==
literal|'f'
operator|||
name|b
operator|==
literal|'F'
condition|)
name|fset
operator|=
name|FALSE
expr_stmt|;
else|else
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: %s: %s: Bad boolean"
argument_list|,
name|zerr
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
operator|*
name|pi
operator||=
name|RELIABLE_SPECIFIED
expr_stmt|;
if|if
condition|(
name|fset
condition|)
operator|*
name|pi
operator||=
name|RELIABLE_RELIABLE
expr_stmt|;
else|else
operator|*
name|pi
operator|&=
operator|~
name|RELIABLE_RELIABLE
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Handle the ``baud-range'' command for a modem port.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpbaud_range
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
comment|/* This should do more error checking.  */
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|ilowbaud
operator|=
name|atol
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|ihighbaud
operator|=
name|atol
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Process a port command found while reading the system information    file.  */
end_comment

begin_function
name|enum
name|tcmdtabret
name|tprocess_port_cmd
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
name|struct
name|sport
modifier|*
modifier|*
name|pqport
init|=
operator|(
expr|struct
name|sport
operator|*
operator|*
operator|)
name|pvar
decl_stmt|;
name|enum
name|tcmdtabret
name|tret
decl_stmt|;
specifier|const
name|struct
name|scmdtab
modifier|*
name|qcmds
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|*
name|pqport
operator|==
name|NULL
condition|)
block|{
name|enum
name|tporttype
name|ttype
decl_stmt|;
name|struct
name|sport
modifier|*
name|qnew
decl_stmt|;
name|boolean
name|fgottype
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"type"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ttype
operator|=
name|PORTTYPE_MODEM
expr_stmt|;
name|fgottype
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: port type: Wrong number of arguments"
argument_list|,
name|zerr
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPORT_TYPES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|azPtype_names
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|CPORT_TYPES
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: Unknown port type"
argument_list|,
name|zerr
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
name|ttype
operator|=
operator|(
expr|enum
name|tporttype
operator|)
name|i
expr_stmt|;
name|fgottype
operator|=
name|TRUE
expr_stmt|;
block|}
name|qnew
operator|=
operator|(
expr|struct
name|sport
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sport
argument_list|)
argument_list|)
expr_stmt|;
name|qnew
operator|->
name|zname
operator|=
name|NULL
expr_stmt|;
name|qnew
operator|->
name|ttype
operator|=
name|ttype
expr_stmt|;
name|qnew
operator|->
name|zprotocols
operator|=
name|NULL
expr_stmt|;
name|qnew
operator|->
name|cproto_params
operator|=
literal|0
expr_stmt|;
name|qnew
operator|->
name|qproto_params
operator|=
name|NULL
expr_stmt|;
name|qnew
operator|->
name|zlockname
operator|=
name|NULL
expr_stmt|;
comment|/* Note that we do not set RELIABLE_SPECIFIED; this just sets 	 defaults, so that ``seven-bit true'' does not imply 	 ``reliable false''.  */
name|qnew
operator|->
name|ireliable
operator|=
name|RELIABLE_RELIABLE
operator||
name|RELIABLE_EIGHT
expr_stmt|;
switch|switch
condition|(
name|ttype
condition|)
block|{
case|case
name|PORTTYPE_STDIN
case|:
ifdef|#
directive|ifdef
name|SYSDEP_STDIN_INIT
name|SYSDEP_STDIN_INIT
argument_list|(
operator|&
name|qnew
operator|->
name|u
operator|.
name|sstdin
operator|.
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|PORTTYPE_MODEM
case|:
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|zdevice
operator|=
name|NULL
expr_stmt|;
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|zdial_device
operator|=
name|NULL
expr_stmt|;
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|ibaud
operator|=
literal|0L
expr_stmt|;
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|ilowbaud
operator|=
literal|0L
expr_stmt|;
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|ihighbaud
operator|=
literal|0L
expr_stmt|;
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|fcarrier
operator|=
name|TRUE
expr_stmt|;
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|zdialer
operator|=
name|NULL
expr_stmt|;
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|qdialer
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|SYSDEP_MODEM_INIT
name|SYSDEP_MODEM_INIT
argument_list|(
operator|&
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|PORTTYPE_DIRECT
case|:
name|qnew
operator|->
name|u
operator|.
name|sdirect
operator|.
name|zdevice
operator|=
name|NULL
expr_stmt|;
name|qnew
operator|->
name|u
operator|.
name|sdirect
operator|.
name|ibaud
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|SYSDEP_DIRECT_INIT
name|SYSDEP_DIRECT_INIT
argument_list|(
operator|&
name|qnew
operator|->
name|u
operator|.
name|sdirect
operator|.
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
if|#
directive|if
name|HAVE_TCP
case|case
name|PORTTYPE_TCP
case|:
name|qnew
operator|->
name|u
operator|.
name|stcp
operator|.
name|o
operator|=
operator|-
literal|1
expr_stmt|;
name|qnew
operator|->
name|u
operator|.
name|stcp
operator|.
name|zport
operator|=
literal|"uucp"
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* HAVE_TCP */
block|}
operator|*
name|pqport
operator|=
name|qnew
expr_stmt|;
if|if
condition|(
name|fgottype
condition|)
return|return
name|CMDTABRET_FREE
return|;
block|}
comment|/* See if this command is one of the generic ones.  */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPORT_CMDS
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|asPort_cmds
index|[
name|i
index|]
operator|.
name|zcmd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sPort
operator|=
operator|*
operator|*
name|pqport
expr_stmt|;
name|tret
operator|=
name|tprocess_one_cmd
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|asPort_cmds
argument_list|,
name|zerr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
operator|*
name|pqport
operator|=
name|sPort
expr_stmt|;
return|return
name|tret
return|;
block|}
block|}
comment|/* Now check the port commands for specific types.  */
switch|switch
condition|(
operator|(
operator|*
name|pqport
operator|)
operator|->
name|ttype
condition|)
block|{
case|case
name|PORTTYPE_STDIN
case|:
name|qcmds
operator|=
name|asPstdin_cmds
expr_stmt|;
break|break;
case|case
name|PORTTYPE_MODEM
case|:
name|qcmds
operator|=
name|asPmodem_cmds
expr_stmt|;
break|break;
case|case
name|PORTTYPE_DIRECT
case|:
name|qcmds
operator|=
name|asPdirect_cmds
expr_stmt|;
break|break;
if|#
directive|if
name|HAVE_TCP
case|case
name|PORTTYPE_TCP
case|:
name|qcmds
operator|=
name|asPtcp_cmds
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* HAVE_TCP */
default|default:
if|#
directive|if
name|DEBUG
operator|>
literal|0
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"tprocess_port_cmd: Can't happen"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|CMDTABRET_FREE
return|;
block|}
name|sPort
operator|=
operator|*
operator|*
name|pqport
expr_stmt|;
name|tret
operator|=
name|tprocess_one_cmd
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|qcmds
argument_list|,
name|zerr
argument_list|,
name|CMDFLAG_WARNUNRECOG
argument_list|)
expr_stmt|;
operator|*
operator|*
name|pqport
operator|=
name|sPort
expr_stmt|;
return|return
name|tret
return|;
block|}
end_function

begin_comment
comment|/* Fill in an scmdtab structure to pass every possible port command    to tprocess_port_cmd.  The argument must be large enough.  */
end_comment

begin_decl_stmt
specifier|static
name|void
name|uport_cmdtab
name|P
argument_list|(
operator|(
expr|struct
name|scmdtab
operator|*
name|qcmds
operator|,
expr|struct
name|sport
operator|*
operator|*
name|pqnew
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|uport_cmdtab
parameter_list|(
name|qcmds
parameter_list|,
name|pqnew
parameter_list|)
name|struct
name|scmdtab
modifier|*
name|qcmds
decl_stmt|;
name|struct
name|sport
modifier|*
modifier|*
name|pqnew
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|int
name|ibase
decl_stmt|;
name|ibase
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPORT_CMDS
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|zcmd
operator|=
name|asPort_cmds
index|[
name|i
index|]
operator|.
name|zcmd
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|itype
operator|=
name|CMDTABTYPE_FN
operator||
literal|0
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|pvar
operator|=
operator|(
name|pointer
operator|)
name|pqnew
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|ptfn
operator|=
name|tprocess_port_cmd
expr_stmt|;
block|}
name|ibase
operator|+=
name|CPORT_CMDS
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CSTDIN_CMDS
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|zcmd
operator|=
name|asPstdin_cmds
index|[
name|i
index|]
operator|.
name|zcmd
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|itype
operator|=
name|CMDTABTYPE_FN
operator||
literal|0
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|pvar
operator|=
operator|(
name|pointer
operator|)
name|pqnew
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|ptfn
operator|=
name|tprocess_port_cmd
expr_stmt|;
block|}
name|ibase
operator|+=
name|CSTDIN_CMDS
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CMODEM_CMDS
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|zcmd
operator|=
name|asPmodem_cmds
index|[
name|i
index|]
operator|.
name|zcmd
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|itype
operator|=
name|CMDTABTYPE_FN
operator||
literal|0
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|pvar
operator|=
operator|(
name|pointer
operator|)
name|pqnew
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|ptfn
operator|=
name|tprocess_port_cmd
expr_stmt|;
block|}
name|ibase
operator|+=
name|CMODEM_CMDS
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CDIRECT_CMDS
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|zcmd
operator|=
name|asPdirect_cmds
index|[
name|i
index|]
operator|.
name|zcmd
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|itype
operator|=
name|CMDTABTYPE_FN
operator||
literal|0
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|pvar
operator|=
operator|(
name|pointer
operator|)
name|pqnew
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|ptfn
operator|=
name|tprocess_port_cmd
expr_stmt|;
block|}
name|ibase
operator|+=
name|CDIRECT_CMDS
operator|-
literal|1
expr_stmt|;
if|#
directive|if
name|HAVE_TCP
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CTCP_CMDS
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|zcmd
operator|=
name|asPtcp_cmds
index|[
name|i
index|]
operator|.
name|zcmd
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|itype
operator|=
name|CMDTABTYPE_FN
operator||
literal|0
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|pvar
operator|=
operator|(
name|pointer
operator|)
name|pqnew
expr_stmt|;
name|qcmds
index|[
name|ibase
operator|+
name|i
index|]
operator|.
name|ptfn
operator|=
name|tprocess_port_cmd
expr_stmt|;
block|}
name|ibase
operator|+=
name|CTCP_CMDS
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_TCP */
name|qcmds
index|[
name|ibase
index|]
operator|.
name|zcmd
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_TAYLOR_CONFIG */
end_comment

begin_escape
end_escape

begin_if
if|#
directive|if
name|HAVE_TAYLOR_CONFIG
end_if

begin_comment
comment|/* Save a port name so that we can use it when looking for a port    with a particular baud rate.  */
end_comment

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpport_for_baud
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zport_for_baud_name
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpport_for_baud
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
name|zport_for_baud_name
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
return|return
name|CMDTABRET_EXIT
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_TAYLOR_CONFIG */
end_comment

begin_comment
comment|/* Find and lock a port.  The arguments specify a port name and a baud    rate, and the port found must match both.  If the name passed in is    NULL, all ports match.  If the baud rate passed in is 0, all ports    match.  The lock routine is passed in so that it doesn't have to be    linked in by programs which don't need this call (yes, it's a    hack).  The freport argument is actually only used for testing    purposes.  */
end_comment

begin_function_decl
name|boolean
name|ffind_port
parameter_list|(
name|zfind
parameter_list|,
name|ibaud
parameter_list|,
name|ihighbaud
parameter_list|,
name|qport
parameter_list|,
name|pflock
parameter_list|,
name|freport
parameter_list|)
specifier|const
name|char
modifier|*
name|zfind
decl_stmt|;
name|long
name|ibaud
decl_stmt|;
name|long
name|ihighbaud
decl_stmt|;
name|struct
name|sport
modifier|*
name|qport
decl_stmt|;
function_decl|boolean
parameter_list|(
function_decl|*pflock
end_function_decl

begin_expr_stmt
unit|)
name|P
argument_list|(
operator|(
expr|struct
name|sport
operator|*
operator|,
name|boolean
name|fin
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|boolean
name|freport
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|boolean
name|ffound
decl_stmt|;
if|if
condition|(
name|ihighbaud
operator|==
literal|0
condition|)
name|ihighbaud
operator|=
name|ibaud
expr_stmt|;
name|ffound
operator|=
name|FALSE
expr_stmt|;
if|#
directive|if
name|HAVE_TAYLOR_CONFIG
if|if
condition|(
name|zPortfile
operator|==
name|NULL
condition|)
block|{
name|boolean
name|fmore
decl_stmt|;
comment|/* Only warn about a missing file if we're not going to read the 	 V2 or BNU files.  */
name|fmore
operator|=
name|FALSE
expr_stmt|;
if|#
directive|if
name|HAVE_V2_CONFIG
if|if
condition|(
name|fV2
condition|)
name|fmore
operator|=
name|TRUE
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|HAVE_BNU_CONFIG
if|if
condition|(
name|fBnu
condition|)
name|fmore
operator|=
name|TRUE
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|fmore
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s%s: file not found"
argument_list|,
name|NEWCONFIGLIB
argument_list|,
name|PORTFILE
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
else|else
block|{
name|struct
name|smulti_file
modifier|*
name|qmulti
decl_stmt|;
name|struct
name|scmdtab
name|ascmds
index|[
name|CPORT_CMDS
operator|+
name|CSTDIN_CMDS
operator|+
name|CMODEM_CMDS
operator|+
name|CDIRECT_CMDS
operator|+
name|CTCP_CMDS
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|sport
modifier|*
name|qnew
decl_stmt|;
specifier|const
name|char
modifier|*
name|zname
decl_stmt|;
name|qmulti
operator|=
name|qmulti_open
argument_list|(
name|zPortfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|qmulti
operator|!=
name|NULL
condition|)
block|{
comment|/* Set up such that each command is routed to 	     tprocess_port_cmd.  Route "port" to tpport_for_baud, 	     which will record the name of the port.  */
name|qnew
operator|=
name|NULL
expr_stmt|;
name|ascmds
index|[
literal|0
index|]
operator|.
name|zcmd
operator|=
literal|"port"
expr_stmt|;
name|ascmds
index|[
literal|0
index|]
operator|.
name|itype
operator|=
name|CMDTABTYPE_FN
operator||
literal|2
expr_stmt|;
name|ascmds
index|[
literal|0
index|]
operator|.
name|pvar
operator|=
name|NULL
expr_stmt|;
name|ascmds
index|[
literal|0
index|]
operator|.
name|ptfn
operator|=
name|tpport_for_baud
expr_stmt|;
name|uport_cmdtab
argument_list|(
name|ascmds
operator|+
literal|1
argument_list|,
operator|&
name|qnew
argument_list|)
expr_stmt|;
comment|/* Look for the first command in the file (which should be 	     ``port'') to get the name of the first port.  */
name|zport_for_baud_name
operator|=
name|NULL
expr_stmt|;
name|uprocesscmds
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|NULL
argument_list|,
name|qmulti
argument_list|,
name|ascmds
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|CMDFLAG_BACKSLASH
argument_list|)
expr_stmt|;
if|if
condition|(
name|qnew
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fmulti_close
argument_list|(
name|qmulti
argument_list|)
expr_stmt|;
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"First command in port file is not `port'"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|/* Look through the files until we can't find any more.  */
name|zname
operator|=
name|zport_for_baud_name
expr_stmt|;
while|while
condition|(
name|zname
operator|!=
name|NULL
condition|)
block|{
name|zport_for_baud_name
operator|=
name|NULL
expr_stmt|;
name|uprocesscmds
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|NULL
argument_list|,
name|qmulti
argument_list|,
name|ascmds
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|CMDFLAG_BACKSLASH
argument_list|)
expr_stmt|;
if|if
condition|(
name|qnew
operator|!=
name|NULL
operator|&&
operator|(
name|zfind
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|zfind
argument_list|,
name|zname
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ibaud
operator|==
literal|0
operator|||
operator|(
name|qnew
operator|->
name|ttype
operator|==
name|PORTTYPE_MODEM
operator|&&
operator|(
operator|(
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|ibaud
operator|==
literal|0
operator|&&
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|ilowbaud
operator|==
literal|0
operator|&&
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|ihighbaud
operator|==
literal|0
operator|)
operator|||
operator|(
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|ibaud
operator|>=
name|ibaud
operator|&&
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|ibaud
operator|<=
name|ihighbaud
operator|)
operator|||
operator|(
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|ilowbaud
operator|<=
name|ihighbaud
operator|&&
name|qnew
operator|->
name|u
operator|.
name|smodem
operator|.
name|ihighbaud
operator|>=
name|ibaud
operator|)
operator|)
operator|)
operator|||
operator|(
name|qnew
operator|->
name|ttype
operator|==
name|PORTTYPE_DIRECT
operator|&&
operator|(
name|qnew
operator|->
name|u
operator|.
name|sdirect
operator|.
name|ibaud
operator|==
literal|0
operator|||
name|qnew
operator|->
name|u
operator|.
name|sdirect
operator|.
name|ibaud
operator|==
name|ibaud
operator|)
operator|)
operator|)
condition|)
block|{
name|ffound
operator|=
name|TRUE
expr_stmt|;
name|qnew
operator|->
name|zname
operator|=
name|zname
expr_stmt|;
if|if
condition|(
name|pflock
operator|==
name|NULL
operator|||
call|(
modifier|*
name|pflock
call|)
argument_list|(
name|qnew
argument_list|,
name|FALSE
argument_list|)
condition|)
block|{
operator|*
name|qport
operator|=
operator|*
name|qnew
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|qnew
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fmulti_close
argument_list|(
name|qmulti
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
block|}
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|qnew
argument_list|)
expr_stmt|;
name|qnew
operator|=
name|NULL
expr_stmt|;
name|zname
operator|=
name|zport_for_baud_name
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fmulti_close
argument_list|(
name|qmulti
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* HAVE_TAYLOR_CONFIG */
if|#
directive|if
name|HAVE_V2_CONFIG
if|if
condition|(
name|fV2
condition|)
block|{
if|if
condition|(
name|fv2_find_port
argument_list|(
name|zfind
argument_list|,
name|ibaud
argument_list|,
name|ihighbaud
argument_list|,
name|qport
argument_list|,
name|pflock
argument_list|,
operator|&
name|ffound
argument_list|)
condition|)
return|return
name|TRUE
return|;
block|}
endif|#
directive|endif
comment|/* HAVE_V2_CONFIG */
if|#
directive|if
name|HAVE_BNU_CONFIG
if|if
condition|(
name|fBnu
condition|)
block|{
if|if
condition|(
name|fbnu_find_port
argument_list|(
name|zfind
argument_list|,
name|ibaud
argument_list|,
name|ihighbaud
argument_list|,
name|qport
argument_list|,
name|pflock
argument_list|,
operator|&
name|ffound
argument_list|)
condition|)
return|return
name|TRUE
return|;
block|}
endif|#
directive|endif
comment|/* HAVE_BNU_CONFIG */
if|if
condition|(
name|freport
condition|)
block|{
if|if
condition|(
name|ffound
condition|)
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"All matching ports in use"
argument_list|)
expr_stmt|;
else|else
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"No matching ports defined"
argument_list|)
expr_stmt|;
block|}
return|return
name|FALSE
return|;
block|}
end_block

begin_escape
end_escape

begin_if
if|#
directive|if
name|HAVE_TAYLOR_CONFIG
end_if

begin_comment
comment|/* Read dialer commands.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|sdialer
name|sPdialer
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The dialer command table.  */
end_comment

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpdtr_toggle
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpcomplete
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tpdialer_proto_param
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scmdtab
name|asPdialer_cmds
index|[]
init|=
block|{
block|{
literal|"dialer"
block|,
name|CMDTABTYPE_FN
operator||
literal|2
block|,
name|NULL
block|,
name|tpexit
block|}
block|,
block|{
literal|"#"
block|,
name|CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|tpexit
block|}
block|,
block|{
literal|"chat"
block|,
name|CMDTABTYPE_PREFIX
operator||
literal|0
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|schat
block|,
name|tprocess_chat_cmd
block|}
block|,
block|{
literal|"dialtone"
block|,
name|CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|zdialtone
block|,
name|NULL
block|}
block|,
block|{
literal|"pause"
block|,
name|CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|zpause
block|,
name|NULL
block|}
block|,
block|{
literal|"carrier"
block|,
name|CMDTABTYPE_BOOLEAN
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|fcarrier
block|,
name|NULL
block|}
block|,
block|{
literal|"carrier-wait"
block|,
name|CMDTABTYPE_INT
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|ccarrier_wait
block|,
name|NULL
block|}
block|,
block|{
literal|"dtr-toggle"
block|,
name|CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|tpdtr_toggle
block|}
block|,
block|{
literal|"complete"
block|,
name|CMDTABTYPE_FN
operator||
literal|2
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|scomplete
block|,
name|tpcomplete
block|}
block|,
block|{
literal|"complete-chat"
block|,
name|CMDTABTYPE_PREFIX
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|scomplete
block|,
name|tprocess_chat_cmd
block|}
block|,
block|{
literal|"abort"
block|,
name|CMDTABTYPE_FN
operator||
literal|2
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|sabort
block|,
name|tpcomplete
block|}
block|,
block|{
literal|"abort-chat"
block|,
name|CMDTABTYPE_PREFIX
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|sabort
block|,
name|tprocess_chat_cmd
block|}
block|,
block|{
literal|"protocol-parameter"
block|,
name|CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|tpdialer_proto_param
block|}
block|,
block|{
literal|"seven-bit"
block|,
name|CMDTABTYPE_FN
operator||
literal|2
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|ireliable
block|,
name|tpseven_bit
block|}
block|,
block|{
literal|"reliable"
block|,
name|CMDTABTYPE_FN
operator||
literal|2
block|,
operator|(
name|pointer
operator|)
operator|&
name|sPdialer
operator|.
name|ireliable
block|,
name|tpreliable
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CDIALER_CMDS
value|(sizeof asPdialer_cmds / sizeof asPdialer_cmds[0])
end_define

begin_comment
comment|/* Handle the dtr-toggle command.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpdtr_toggle
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
name|char
name|b
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
operator|||
name|argc
operator|>
literal|3
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: %s: Wrong number of arguments"
argument_list|,
name|zerr
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
name|b
operator|=
name|argv
index|[
literal|1
index|]
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|b
operator|==
literal|'y'
operator|||
name|b
operator|==
literal|'Y'
operator|||
name|b
operator|==
literal|'t'
operator|||
name|b
operator|==
literal|'T'
condition|)
name|sPdialer
operator|.
name|fdtr_toggle
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|==
literal|'n'
operator|||
name|b
operator|==
literal|'N'
operator|||
name|b
operator|==
literal|'f'
operator|||
name|b
operator|==
literal|'F'
condition|)
name|sPdialer
operator|.
name|fdtr_toggle
operator|=
name|FALSE
expr_stmt|;
else|else
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: %s: Bad boolean"
argument_list|,
name|zerr
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
if|if
condition|(
name|argc
operator|==
literal|3
condition|)
block|{
name|b
operator|=
name|argv
index|[
literal|2
index|]
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|b
operator|==
literal|'y'
operator|||
name|b
operator|==
literal|'Y'
operator|||
name|b
operator|==
literal|'t'
operator|||
name|b
operator|==
literal|'T'
condition|)
name|sPdialer
operator|.
name|fdtr_toggle_wait
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|==
literal|'n'
operator|||
name|b
operator|==
literal|'N'
operator|||
name|b
operator|==
literal|'f'
operator|||
name|b
operator|==
literal|'F'
condition|)
name|sPdialer
operator|.
name|fdtr_toggle_wait
operator|=
name|FALSE
expr_stmt|;
else|else
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: %s: Bad boolean"
argument_list|,
name|zerr
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
block|}
return|return
name|CMDTABRET_FREE
return|;
block|}
end_function

begin_comment
comment|/* Handle the complete and abort commands.  These just turn a string    into a trivial chat script.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpcomplete
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
name|struct
name|schat_info
modifier|*
name|qchat
init|=
operator|(
expr|struct
name|schat_info
operator|*
operator|)
name|pvar
decl_stmt|;
name|qchat
operator|->
name|zchat
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
operator|+
sizeof|sizeof
expr|"\"\" "
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|qchat
operator|->
name|zchat
argument_list|,
literal|"\"\" %s"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
end_function

begin_comment
comment|/* Handle protocol parameters for dialers.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpdialer_proto_param
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
return|return
name|tadd_proto_param
argument_list|(
operator|&
name|sPdialer
operator|.
name|cproto_params
argument_list|,
operator|&
name|sPdialer
operator|.
name|qproto_params
argument_list|,
name|zerr
argument_list|,
name|argc
operator|-
literal|1
argument_list|,
name|argv
operator|+
literal|1
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Process one dialer command.  */
end_comment

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tprocess_dialer_cmd
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tprocess_dialer_cmd
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
name|struct
name|sdialer
modifier|*
modifier|*
name|pq
init|=
operator|(
expr|struct
name|sdialer
operator|*
operator|*
operator|)
name|pvar
decl_stmt|;
name|enum
name|tcmdtabret
name|tret
decl_stmt|;
if|if
condition|(
operator|*
name|pq
operator|==
name|NULL
condition|)
block|{
name|struct
name|sdialer
modifier|*
name|qnew
decl_stmt|;
name|qnew
operator|=
operator|(
expr|struct
name|sdialer
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sdialer
argument_list|)
argument_list|)
expr_stmt|;
name|qnew
operator|->
name|zname
operator|=
name|NULL
expr_stmt|;
name|INIT_CHAT
argument_list|(
operator|&
name|qnew
operator|->
name|schat
argument_list|)
expr_stmt|;
name|qnew
operator|->
name|zdialtone
operator|=
literal|","
expr_stmt|;
name|qnew
operator|->
name|zpause
operator|=
literal|","
expr_stmt|;
name|qnew
operator|->
name|fcarrier
operator|=
name|TRUE
expr_stmt|;
name|qnew
operator|->
name|ccarrier_wait
operator|=
literal|60
expr_stmt|;
name|qnew
operator|->
name|fdtr_toggle
operator|=
name|FALSE
expr_stmt|;
name|qnew
operator|->
name|fdtr_toggle_wait
operator|=
name|FALSE
expr_stmt|;
name|INIT_CHAT
argument_list|(
operator|&
name|qnew
operator|->
name|scomplete
argument_list|)
expr_stmt|;
name|INIT_CHAT
argument_list|(
operator|&
name|qnew
operator|->
name|sabort
argument_list|)
expr_stmt|;
name|qnew
operator|->
name|cproto_params
operator|=
literal|0
expr_stmt|;
name|qnew
operator|->
name|qproto_params
operator|=
name|NULL
expr_stmt|;
comment|/* Note that we do not set RELIABLE_SPECIFIED; this just sets 	 defaults, so that ``seven-bit true'' does not imply 	 ``reliable false''.  */
name|qnew
operator|->
name|ireliable
operator|=
name|RELIABLE_RELIABLE
operator||
name|RELIABLE_EIGHT
expr_stmt|;
operator|*
name|pq
operator|=
name|qnew
expr_stmt|;
block|}
name|sPdialer
operator|=
operator|*
operator|*
name|pq
expr_stmt|;
name|tret
operator|=
name|tprocess_one_cmd
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|asPdialer_cmds
argument_list|,
name|zerr
argument_list|,
name|CMDFLAG_WARNUNRECOG
argument_list|)
expr_stmt|;
operator|*
operator|*
name|pq
operator|=
name|sPdialer
expr_stmt|;
return|return
name|tret
return|;
block|}
end_function

begin_comment
comment|/* Handle a dialer command seen in the port file.  */
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tpdialer
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: %s: Wrong number of arguments"
argument_list|,
name|zerr
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
name|CMDTABRET_FREE
return|;
block|}
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
return|return
name|tprocess_dialer_cmd
argument_list|(
name|argc
operator|-
literal|1
argument_list|,
name|argv
operator|+
literal|1
argument_list|,
name|pvar
argument_list|,
name|zerr
argument_list|)
return|;
name|sPort
operator|.
name|u
operator|.
name|smodem
operator|.
name|zdialer
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
return|return
name|CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_comment
comment|/* Read the information for a particular item.  */
end_comment

begin_struct
struct|struct
name|splook
block|{
specifier|const
name|char
modifier|*
name|zlook
decl_stmt|;
name|boolean
name|ffound
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Look for a particular dialer.  */
end_comment

begin_decl_stmt
specifier|static
name|enum
name|tcmdtabret
name|tplook
name|P
argument_list|(
operator|(
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
specifier|const
name|char
operator|*
name|zerr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|enum
name|tcmdtabret
name|tplook
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|zerr
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerr
decl_stmt|;
block|{
name|struct
name|splook
modifier|*
name|q
init|=
operator|(
expr|struct
name|splook
operator|*
operator|)
name|pvar
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|q
operator|->
name|zlook
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|q
operator|->
name|ffound
operator|=
name|TRUE
expr_stmt|;
return|return
name|CMDTABRET_FREE_AND_EXIT
return|;
block|}
return|return
name|CMDTABRET_FREE
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_TAYLOR_CONFIG */
end_comment

begin_comment
comment|/* Read information about a specific dialer.  */
end_comment

begin_function
name|boolean
name|fread_dialer_info
parameter_list|(
name|zdialer
parameter_list|,
name|qdialer
parameter_list|)
specifier|const
name|char
modifier|*
name|zdialer
decl_stmt|;
name|struct
name|sdialer
modifier|*
name|qdialer
decl_stmt|;
block|{
if|#
directive|if
name|HAVE_TAYLOR_CONFIG
comment|/* If we haven't got a dialer file, then only complain if we aren't      going to try the BNU dialer file.  */
if|if
condition|(
name|zDialfile
operator|==
name|NULL
condition|)
block|{
if|#
directive|if
name|HAVE_BNU_CONFIG
if|if
condition|(
operator|!
name|fBnu
condition|)
endif|#
directive|endif
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s%s: file not found"
argument_list|,
name|NEWCONFIGLIB
argument_list|,
name|DIALFILE
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
else|else
block|{
name|struct
name|smulti_file
modifier|*
name|qmulti
decl_stmt|;
name|struct
name|scmdtab
name|as
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|splook
name|s
decl_stmt|;
name|struct
name|sdialer
modifier|*
name|qnew
decl_stmt|;
name|struct
name|scmdtab
name|ascmds
index|[
name|CDIALER_CMDS
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|qmulti
operator|=
name|qmulti_open
argument_list|(
name|zDialfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|qmulti
operator|!=
name|NULL
condition|)
block|{
name|s
operator|.
name|zlook
operator|=
name|zdialer
expr_stmt|;
name|s
operator|.
name|ffound
operator|=
name|FALSE
expr_stmt|;
name|as
index|[
literal|0
index|]
operator|.
name|zcmd
operator|=
literal|"dialer"
expr_stmt|;
name|as
index|[
literal|0
index|]
operator|.
name|itype
operator|=
name|CMDTABTYPE_FN
operator||
literal|2
expr_stmt|;
name|as
index|[
literal|0
index|]
operator|.
name|pvar
operator|=
operator|(
name|pointer
operator|)
operator|&
name|s
expr_stmt|;
name|as
index|[
literal|0
index|]
operator|.
name|ptfn
operator|=
name|tplook
expr_stmt|;
name|as
index|[
literal|1
index|]
operator|.
name|zcmd
operator|=
name|NULL
expr_stmt|;
name|uprocesscmds
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|NULL
argument_list|,
name|qmulti
argument_list|,
name|as
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|CMDFLAG_BACKSLASH
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|.
name|ffound
condition|)
block|{
name|qnew
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CDIALER_CMDS
condition|;
name|i
operator|++
control|)
block|{
name|ascmds
index|[
name|i
index|]
operator|.
name|zcmd
operator|=
name|asPdialer_cmds
index|[
name|i
index|]
operator|.
name|zcmd
expr_stmt|;
if|if
condition|(
name|TTYPE_CMDTABTYPE
argument_list|(
name|asPdialer_cmds
index|[
name|i
index|]
operator|.
name|itype
argument_list|)
operator|==
name|CMDTABTYPE_PREFIX
condition|)
name|ascmds
index|[
name|i
index|]
operator|.
name|itype
operator|=
name|CMDTABTYPE_PREFIX
operator||
literal|0
expr_stmt|;
else|else
name|ascmds
index|[
name|i
index|]
operator|.
name|itype
operator|=
name|CMDTABTYPE_FN
operator||
literal|0
expr_stmt|;
name|ascmds
index|[
name|i
index|]
operator|.
name|pvar
operator|=
operator|(
name|pointer
operator|)
operator|&
name|qnew
expr_stmt|;
name|ascmds
index|[
name|i
index|]
operator|.
name|ptfn
operator|=
name|tprocess_dialer_cmd
expr_stmt|;
block|}
name|uprocesscmds
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|NULL
argument_list|,
name|qmulti
argument_list|,
name|ascmds
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|CMDFLAG_WARNUNRECOG
operator||
name|CMDFLAG_BACKSLASH
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fmulti_close
argument_list|(
name|qmulti
argument_list|)
expr_stmt|;
if|if
condition|(
name|qnew
operator|==
name|NULL
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"No information for dialer %s"
argument_list|,
name|zdialer
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
operator|*
name|qdialer
operator|=
operator|*
name|qnew
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|qnew
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
operator|(
name|void
operator|)
name|fmulti_close
argument_list|(
name|qmulti
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* HAVE_TAYLOR_CONFIG */
if|#
directive|if
name|HAVE_BNU_CONFIG
if|if
condition|(
name|fBnu
condition|)
block|{
if|if
condition|(
name|fbnu_read_dialer_info
argument_list|(
name|zdialer
argument_list|,
name|qdialer
argument_list|)
condition|)
return|return
name|TRUE
return|;
block|}
endif|#
directive|endif
comment|/* HAVE_BNU_CONFIG */
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: No such dialer"
argument_list|,
name|zdialer
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

end_unit


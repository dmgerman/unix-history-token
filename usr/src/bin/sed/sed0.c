begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	%M%	%I%	%E%	*/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"sed.h"
end_include

begin_decl_stmt
name|struct
name|label
modifier|*
name|labtab
init|=
name|ltab
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|CGMES
index|[]
init|=
literal|"command garbled: %s\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|TMMES
index|[]
init|=
literal|"Too much text: %s\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|LTL
index|[]
init|=
literal|"Label too long: %s\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|AD0MES
index|[]
init|=
literal|"No addresses allowed: %s\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|AD1MES
index|[]
init|=
literal|"Only one address allowed: %s\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|bittab
index|[]
init|=
block|{
literal|1
block|,
literal|2
block|,
literal|4
block|,
literal|8
block|,
literal|16
block|,
literal|32
block|,
literal|64
block|,
literal|128
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|eargc
operator|=
name|argc
expr_stmt|;
name|eargv
operator|=
name|argv
expr_stmt|;
name|badp
operator|=
operator|&
name|bad
expr_stmt|;
name|aptr
operator|=
name|abuf
expr_stmt|;
name|lab
operator|=
name|labtab
operator|+
literal|1
expr_stmt|;
comment|/* 0 reserved for end-pointer */
name|rep
operator|=
name|ptrspace
expr_stmt|;
name|rep
operator|->
name|ad1
operator|=
name|respace
expr_stmt|;
name|lbend
operator|=
operator|&
name|linebuf
index|[
name|LBSIZE
index|]
expr_stmt|;
name|hend
operator|=
operator|&
name|holdsp
index|[
name|LBSIZE
index|]
expr_stmt|;
name|lcomend
operator|=
operator|&
name|genbuf
index|[
literal|71
index|]
expr_stmt|;
name|ptrend
operator|=
operator|&
name|ptrspace
index|[
name|PTRSIZE
index|]
expr_stmt|;
name|reend
operator|=
operator|&
name|respace
index|[
name|RESIZE
index|]
expr_stmt|;
name|labend
operator|=
operator|&
name|labtab
index|[
name|LABSIZE
index|]
expr_stmt|;
name|lnum
operator|=
literal|0
expr_stmt|;
name|pending
operator|=
literal|0
expr_stmt|;
name|depth
operator|=
literal|0
expr_stmt|;
name|spend
operator|=
name|linebuf
expr_stmt|;
name|hspend
operator|=
name|holdsp
expr_stmt|;
name|fcode
index|[
literal|0
index|]
operator|=
name|stdout
expr_stmt|;
name|nfiles
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|eargc
operator|==
literal|1
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|eargc
operator|>
literal|0
operator|&&
operator|(
operator|++
name|eargv
operator|)
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
switch|switch
condition|(
name|eargv
index|[
literal|0
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'n'
case|:
name|nflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'f'
case|:
if|if
condition|(
name|eargc
operator|--
operator|<=
literal|0
condition|)
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fin
operator|=
name|fopen
argument_list|(
operator|*
operator|++
name|eargv
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot open pattern-file: %s\n"
argument_list|,
operator|*
name|eargv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|fcomp
argument_list|()
expr_stmt|;
name|fclose
argument_list|(
name|fin
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'e'
case|:
name|eflag
operator|++
expr_stmt|;
name|fcomp
argument_list|()
expr_stmt|;
name|eflag
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
literal|'g'
case|:
name|gflag
operator|++
expr_stmt|;
continue|continue;
default|default:
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Unknown flag: %c\n"
argument_list|,
name|eargv
index|[
literal|0
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|compfl
operator|==
literal|0
condition|)
block|{
name|eargv
operator|--
expr_stmt|;
name|eargc
operator|++
expr_stmt|;
name|eflag
operator|++
expr_stmt|;
name|fcomp
argument_list|()
expr_stmt|;
name|eargv
operator|++
expr_stmt|;
name|eargc
operator|--
expr_stmt|;
name|eflag
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|depth
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too many {'s"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|labtab
operator|->
name|address
operator|=
name|rep
expr_stmt|;
name|dechain
argument_list|()
expr_stmt|;
comment|/*	abort();	/*DEBUG*/
if|if
condition|(
name|eargc
operator|<=
literal|0
condition|)
name|execute
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
else|else
while|while
condition|(
operator|--
name|eargc
operator|>=
literal|0
condition|)
block|{
name|execute
argument_list|(
operator|*
name|eargv
operator|++
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|fcomp
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|op
decl_stmt|,
modifier|*
name|tp
decl_stmt|;
name|char
modifier|*
name|address
parameter_list|()
function_decl|;
name|union
name|reptr
modifier|*
name|pt
decl_stmt|,
modifier|*
name|pt1
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|label
modifier|*
name|lpt
decl_stmt|;
name|compfl
operator|=
literal|1
expr_stmt|;
name|op
operator|=
name|lastre
expr_stmt|;
if|if
condition|(
name|rline
argument_list|(
name|linebuf
argument_list|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
operator|*
name|linebuf
operator|==
literal|'#'
condition|)
block|{
if|if
condition|(
name|linebuf
index|[
literal|1
index|]
operator|==
literal|'n'
condition|)
name|nflag
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|cp
operator|=
name|linebuf
expr_stmt|;
goto|goto
name|comploop
goto|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|rline
argument_list|(
name|linebuf
argument_list|)
operator|<
literal|0
condition|)
break|break;
name|cp
operator|=
name|linebuf
expr_stmt|;
name|comploop
label|:
comment|/*	fprintf(stdout, "cp: %s\n", cp);	/*DEBUG*/
while|while
condition|(
operator|*
name|cp
operator|==
literal|' '
operator|||
operator|*
name|cp
operator|==
literal|'\t'
condition|)
name|cp
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\0'
operator|||
operator|*
name|cp
operator|==
literal|'#'
condition|)
continue|continue;
if|if
condition|(
operator|*
name|cp
operator|==
literal|';'
condition|)
block|{
name|cp
operator|++
expr_stmt|;
goto|goto
name|comploop
goto|;
block|}
name|p
operator|=
name|address
argument_list|(
name|rep
operator|->
name|ad1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|badp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|==
name|rep
operator|->
name|ad1
condition|)
block|{
if|if
condition|(
name|op
condition|)
name|rep
operator|->
name|ad1
operator|=
name|op
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"First RE may not be null\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|p
operator|==
literal|0
condition|)
block|{
name|p
operator|=
name|rep
operator|->
name|ad1
expr_stmt|;
name|rep
operator|->
name|ad1
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|op
operator|=
name|rep
operator|->
name|ad1
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|','
operator|||
operator|*
name|cp
operator|==
literal|';'
condition|)
block|{
name|cp
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|rep
operator|->
name|ad2
operator|=
name|p
operator|)
operator|>
name|reend
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|TMMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|address
argument_list|(
name|rep
operator|->
name|ad2
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|badp
operator|||
name|p
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|==
name|rep
operator|->
name|ad2
condition|)
name|rep
operator|->
name|ad2
operator|=
name|op
expr_stmt|;
else|else
name|op
operator|=
name|rep
operator|->
name|ad2
expr_stmt|;
block|}
else|else
name|rep
operator|->
name|ad2
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|>
name|reend
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too much text: %s\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|*
name|cp
operator|==
literal|' '
operator|||
operator|*
name|cp
operator|==
literal|'\t'
condition|)
name|cp
operator|++
expr_stmt|;
name|swit
label|:
switch|switch
condition|(
operator|*
name|cp
operator|++
condition|)
block|{
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unrecognized command: %s\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
case|case
literal|'!'
case|:
name|rep
operator|->
name|negfl
operator|=
literal|1
expr_stmt|;
goto|goto
name|swit
goto|;
case|case
literal|'{'
case|:
name|rep
operator|->
name|command
operator|=
name|BCOM
expr_stmt|;
name|rep
operator|->
name|negfl
operator|=
operator|!
operator|(
name|rep
operator|->
name|negfl
operator|)
expr_stmt|;
name|cmpend
index|[
name|depth
operator|++
index|]
operator|=
operator|&
name|rep
operator|->
name|lb1
expr_stmt|;
if|if
condition|(
operator|++
name|rep
operator|>=
name|ptrend
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too many commands: %s\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|rep
operator|->
name|ad1
operator|=
name|p
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\0'
condition|)
continue|continue;
goto|goto
name|comploop
goto|;
case|case
literal|'}'
case|:
if|if
condition|(
name|rep
operator|->
name|ad1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|AD0MES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|--
name|depth
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too many }'s\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
operator|*
name|cmpend
index|[
name|depth
index|]
operator|=
name|rep
expr_stmt|;
name|rep
operator|->
name|ad1
operator|=
name|p
expr_stmt|;
continue|continue;
case|case
literal|'='
case|:
name|rep
operator|->
name|command
operator|=
name|EQCOM
expr_stmt|;
if|if
condition|(
name|rep
operator|->
name|ad2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|AD1MES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|':'
case|:
if|if
condition|(
name|rep
operator|->
name|ad1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|AD0MES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|*
name|cp
operator|++
operator|==
literal|' '
condition|)
empty_stmt|;
name|cp
operator|--
expr_stmt|;
name|tp
operator|=
name|lab
operator|->
name|asc
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|tp
operator|++
operator|=
operator|*
name|cp
operator|++
operator|)
condition|)
if|if
condition|(
name|tp
operator|>=
operator|&
operator|(
name|lab
operator|->
name|asc
index|[
literal|8
index|]
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|LTL
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
operator|*
operator|--
name|tp
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|lpt
operator|=
name|search
argument_list|(
name|lab
argument_list|)
condition|)
block|{
if|if
condition|(
name|lpt
operator|->
name|address
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Duplicate labels: %s\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|lab
operator|->
name|chain
operator|=
literal|0
expr_stmt|;
name|lpt
operator|=
name|lab
expr_stmt|;
if|if
condition|(
operator|++
name|lab
operator|>=
name|labend
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too many labels: %s\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
name|lpt
operator|->
name|address
operator|=
name|rep
expr_stmt|;
name|rep
operator|->
name|ad1
operator|=
name|p
expr_stmt|;
continue|continue;
case|case
literal|'a'
case|:
name|rep
operator|->
name|command
operator|=
name|ACOM
expr_stmt|;
if|if
condition|(
name|rep
operator|->
name|ad2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|AD1MES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\\'
condition|)
name|cp
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|++
operator|!=
literal|'\n'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|rep
operator|->
name|re1
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|text
argument_list|(
name|rep
operator|->
name|re1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|rep
operator|->
name|command
operator|=
name|CCOM
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\\'
condition|)
name|cp
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|++
operator|!=
operator|(
literal|'\n'
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|rep
operator|->
name|re1
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|text
argument_list|(
name|rep
operator|->
name|re1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|rep
operator|->
name|command
operator|=
name|ICOM
expr_stmt|;
if|if
condition|(
name|rep
operator|->
name|ad2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|AD1MES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\\'
condition|)
name|cp
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|++
operator|!=
operator|(
literal|'\n'
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|rep
operator|->
name|re1
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|text
argument_list|(
name|rep
operator|->
name|re1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|rep
operator|->
name|command
operator|=
name|GCOM
expr_stmt|;
break|break;
case|case
literal|'G'
case|:
name|rep
operator|->
name|command
operator|=
name|CGCOM
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|rep
operator|->
name|command
operator|=
name|HCOM
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|rep
operator|->
name|command
operator|=
name|CHCOM
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|rep
operator|->
name|command
operator|=
name|TCOM
expr_stmt|;
goto|goto
name|jtcommon
goto|;
case|case
literal|'b'
case|:
name|rep
operator|->
name|command
operator|=
name|BCOM
expr_stmt|;
name|jtcommon
label|:
while|while
condition|(
operator|*
name|cp
operator|++
operator|==
literal|' '
condition|)
empty_stmt|;
name|cp
operator|--
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\0'
condition|)
block|{
if|if
condition|(
name|pt
operator|=
name|labtab
operator|->
name|chain
condition|)
block|{
while|while
condition|(
name|pt1
operator|=
name|pt
operator|->
name|lb1
condition|)
name|pt
operator|=
name|pt1
expr_stmt|;
name|pt
operator|->
name|lb1
operator|=
name|rep
expr_stmt|;
block|}
else|else
name|labtab
operator|->
name|chain
operator|=
name|rep
expr_stmt|;
break|break;
block|}
name|tp
operator|=
name|lab
operator|->
name|asc
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|tp
operator|++
operator|=
operator|*
name|cp
operator|++
operator|)
condition|)
if|if
condition|(
name|tp
operator|>=
operator|&
operator|(
name|lab
operator|->
name|asc
index|[
literal|8
index|]
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|LTL
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|cp
operator|--
expr_stmt|;
operator|*
operator|--
name|tp
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|lpt
operator|=
name|search
argument_list|(
name|lab
argument_list|)
condition|)
block|{
if|if
condition|(
name|lpt
operator|->
name|address
condition|)
block|{
name|rep
operator|->
name|lb1
operator|=
name|lpt
operator|->
name|address
expr_stmt|;
block|}
else|else
block|{
name|pt
operator|=
name|lpt
operator|->
name|chain
expr_stmt|;
while|while
condition|(
name|pt1
operator|=
name|pt
operator|->
name|lb1
condition|)
name|pt
operator|=
name|pt1
expr_stmt|;
name|pt
operator|->
name|lb1
operator|=
name|rep
expr_stmt|;
block|}
block|}
else|else
block|{
name|lab
operator|->
name|chain
operator|=
name|rep
expr_stmt|;
name|lab
operator|->
name|address
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|++
name|lab
operator|>=
name|labend
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too many labels: %s\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'n'
case|:
name|rep
operator|->
name|command
operator|=
name|NCOM
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|rep
operator|->
name|command
operator|=
name|CNCOM
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|rep
operator|->
name|command
operator|=
name|PCOM
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|rep
operator|->
name|command
operator|=
name|CPCOM
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|rep
operator|->
name|command
operator|=
name|RCOM
expr_stmt|;
if|if
condition|(
name|rep
operator|->
name|ad2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|AD1MES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cp
operator|++
operator|!=
literal|' '
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|rep
operator|->
name|re1
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|text
argument_list|(
name|rep
operator|->
name|re1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|rep
operator|->
name|command
operator|=
name|DCOM
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|rep
operator|->
name|command
operator|=
name|CDCOM
expr_stmt|;
name|rep
operator|->
name|lb1
operator|=
name|ptrspace
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|rep
operator|->
name|command
operator|=
name|QCOM
expr_stmt|;
if|if
condition|(
name|rep
operator|->
name|ad2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|AD1MES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'l'
case|:
name|rep
operator|->
name|command
operator|=
name|LCOM
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|rep
operator|->
name|command
operator|=
name|SCOM
expr_stmt|;
name|seof
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
name|rep
operator|->
name|re1
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|compile
argument_list|(
name|rep
operator|->
name|re1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|badp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|==
name|rep
operator|->
name|re1
condition|)
block|{
name|rep
operator|->
name|re1
operator|=
name|op
expr_stmt|;
block|}
else|else
block|{
name|op
operator|=
name|rep
operator|->
name|re1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rep
operator|->
name|rhs
operator|=
name|p
operator|)
operator|>
name|reend
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|TMMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|p
operator|=
name|compsub
argument_list|(
name|rep
operator|->
name|rhs
argument_list|)
operator|)
operator|==
name|badp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cp
operator|==
literal|'g'
condition|)
block|{
name|cp
operator|++
expr_stmt|;
name|rep
operator|->
name|gfl
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|gflag
condition|)
name|rep
operator|->
name|gfl
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'p'
condition|)
block|{
name|cp
operator|++
expr_stmt|;
name|rep
operator|->
name|pfl
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cp
operator|==
literal|'P'
condition|)
block|{
name|cp
operator|++
expr_stmt|;
name|rep
operator|->
name|pfl
operator|=
literal|2
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cp
operator|==
literal|'w'
condition|)
block|{
name|cp
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|++
operator|!=
literal|' '
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nfiles
operator|>=
literal|10
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too many files in w commands\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|text
argument_list|(
name|fname
index|[
name|nfiles
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|nfiles
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
if|if
condition|(
name|cmp
argument_list|(
name|fname
index|[
name|nfiles
index|]
argument_list|,
name|fname
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rep
operator|->
name|fcode
operator|=
name|fcode
index|[
name|i
index|]
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|(
name|rep
operator|->
name|fcode
operator|=
name|fopen
argument_list|(
name|fname
index|[
name|nfiles
index|]
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cannot open %s\n"
argument_list|,
name|fname
index|[
name|nfiles
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|fcode
index|[
name|nfiles
operator|++
index|]
operator|=
name|rep
operator|->
name|fcode
expr_stmt|;
block|}
break|break;
case|case
literal|'w'
case|:
name|rep
operator|->
name|command
operator|=
name|WCOM
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|++
operator|!=
literal|' '
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nfiles
operator|>=
literal|10
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too many files in w commands\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|text
argument_list|(
name|fname
index|[
name|nfiles
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|nfiles
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
if|if
condition|(
name|cmp
argument_list|(
name|fname
index|[
name|nfiles
index|]
argument_list|,
name|fname
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rep
operator|->
name|fcode
operator|=
name|fcode
index|[
name|i
index|]
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|(
name|rep
operator|->
name|fcode
operator|=
name|fopen
argument_list|(
name|fname
index|[
name|nfiles
index|]
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot create %s\n"
argument_list|,
name|fname
index|[
name|nfiles
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|fcode
index|[
name|nfiles
operator|++
index|]
operator|=
name|rep
operator|->
name|fcode
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|rep
operator|->
name|command
operator|=
name|XCOM
expr_stmt|;
break|break;
case|case
literal|'y'
case|:
name|rep
operator|->
name|command
operator|=
name|YCOM
expr_stmt|;
name|seof
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
name|rep
operator|->
name|re1
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|ycomp
argument_list|(
name|rep
operator|->
name|re1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|badp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|>
name|reend
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|TMMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|done
label|:
if|if
condition|(
operator|++
name|rep
operator|>=
name|ptrend
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too many commands, last: %s\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|rep
operator|->
name|ad1
operator|=
name|p
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|++
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|cp
index|[
operator|-
literal|1
index|]
operator|==
literal|';'
condition|)
goto|goto
name|comploop
goto|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
name|rep
operator|->
name|command
operator|=
literal|0
expr_stmt|;
name|lastre
operator|=
name|op
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|compsub
parameter_list|(
name|rhsbuf
parameter_list|)
name|char
modifier|*
name|rhsbuf
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|p
operator|=
name|rhsbuf
expr_stmt|;
name|q
operator|=
name|cp
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
operator|*
name|p
operator|=
operator|*
name|q
operator|++
operator|)
operator|==
literal|'\\'
condition|)
block|{
operator|*
name|p
operator|=
operator|*
name|q
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|>
name|numbra
operator|+
literal|'0'
operator|&&
operator|*
name|p
operator|<=
literal|'9'
condition|)
return|return
operator|(
name|badp
operator|)
return|;
operator|*
name|p
operator|++
operator||=
literal|0200
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|*
name|p
operator|==
name|seof
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|cp
operator|=
name|q
expr_stmt|;
return|return
operator|(
name|p
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|p
operator|++
operator|==
literal|'\0'
condition|)
block|{
return|return
operator|(
name|badp
operator|)
return|;
block|}
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|compile
parameter_list|(
name|expbuf
parameter_list|)
name|char
modifier|*
name|expbuf
decl_stmt|;
block|{
specifier|register
name|c
expr_stmt|;
specifier|register
name|char
modifier|*
name|ep
decl_stmt|,
modifier|*
name|sp
decl_stmt|;
name|char
name|neg
decl_stmt|;
name|char
modifier|*
name|lastep
decl_stmt|,
modifier|*
name|cstart
decl_stmt|;
name|int
name|cclcnt
decl_stmt|;
name|int
name|closed
decl_stmt|;
name|char
name|bracket
index|[
name|NBRA
index|]
decl_stmt|,
modifier|*
name|bracketp
decl_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
name|seof
condition|)
block|{
name|cp
operator|++
expr_stmt|;
return|return
operator|(
name|expbuf
operator|)
return|;
block|}
name|ep
operator|=
name|expbuf
expr_stmt|;
name|lastep
operator|=
literal|0
expr_stmt|;
name|bracketp
operator|=
name|bracket
expr_stmt|;
name|closed
operator|=
name|numbra
operator|=
literal|0
expr_stmt|;
name|sp
operator|=
name|cp
expr_stmt|;
if|if
condition|(
operator|*
name|sp
operator|==
literal|'^'
condition|)
block|{
operator|*
name|ep
operator|++
operator|=
literal|1
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
else|else
block|{
operator|*
name|ep
operator|++
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|ep
operator|>=
operator|&
name|expbuf
index|[
name|ESIZE
index|]
condition|)
block|{
name|cp
operator|=
name|sp
expr_stmt|;
return|return
operator|(
name|badp
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|c
operator|=
operator|*
name|sp
operator|++
operator|)
operator|==
name|seof
condition|)
block|{
if|if
condition|(
name|bracketp
operator|!=
name|bracket
condition|)
block|{
name|cp
operator|=
name|sp
expr_stmt|;
return|return
operator|(
name|badp
operator|)
return|;
block|}
name|cp
operator|=
name|sp
expr_stmt|;
operator|*
name|ep
operator|++
operator|=
name|CEOF
expr_stmt|;
return|return
operator|(
name|ep
operator|)
return|;
block|}
if|if
condition|(
name|c
operator|!=
literal|'*'
condition|)
name|lastep
operator|=
name|ep
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\\'
case|:
if|if
condition|(
operator|(
name|c
operator|=
operator|*
name|sp
operator|++
operator|)
operator|==
literal|'('
condition|)
block|{
if|if
condition|(
name|numbra
operator|>=
name|NBRA
condition|)
block|{
name|cp
operator|=
name|sp
expr_stmt|;
return|return
operator|(
name|badp
operator|)
return|;
block|}
operator|*
name|bracketp
operator|++
operator|=
name|numbra
expr_stmt|;
operator|*
name|ep
operator|++
operator|=
name|CBRA
expr_stmt|;
operator|*
name|ep
operator|++
operator|=
name|numbra
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|c
operator|==
literal|')'
condition|)
block|{
if|if
condition|(
name|bracketp
operator|<=
name|bracket
condition|)
block|{
name|cp
operator|=
name|sp
expr_stmt|;
return|return
operator|(
name|badp
operator|)
return|;
block|}
operator|*
name|ep
operator|++
operator|=
name|CKET
expr_stmt|;
operator|*
name|ep
operator|++
operator|=
operator|*
operator|--
name|bracketp
expr_stmt|;
name|closed
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|c
operator|>=
literal|'1'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|-=
literal|'1'
operator|)
operator|>=
name|closed
condition|)
return|return
operator|(
name|badp
operator|)
return|;
operator|*
name|ep
operator|++
operator|=
name|CBACK
expr_stmt|;
operator|*
name|ep
operator|++
operator|=
name|c
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
block|{
name|cp
operator|=
name|sp
expr_stmt|;
return|return
operator|(
name|badp
operator|)
return|;
block|}
if|if
condition|(
name|c
operator|==
literal|'n'
condition|)
block|{
name|c
operator|=
literal|'\n'
expr_stmt|;
block|}
goto|goto
name|defchar
goto|;
case|case
literal|'\0'
case|:
continue|continue;
case|case
literal|'\n'
case|:
name|cp
operator|=
name|sp
expr_stmt|;
return|return
operator|(
name|badp
operator|)
return|;
case|case
literal|'.'
case|:
operator|*
name|ep
operator|++
operator|=
name|CDOT
expr_stmt|;
continue|continue;
case|case
literal|'*'
case|:
if|if
condition|(
name|lastep
operator|==
literal|0
condition|)
goto|goto
name|defchar
goto|;
if|if
condition|(
operator|*
name|lastep
operator|==
name|CKET
condition|)
block|{
name|cp
operator|=
name|sp
expr_stmt|;
return|return
operator|(
name|badp
operator|)
return|;
block|}
operator|*
name|lastep
operator||=
name|STAR
expr_stmt|;
continue|continue;
case|case
literal|'$'
case|:
if|if
condition|(
operator|*
name|sp
operator|!=
name|seof
condition|)
goto|goto
name|defchar
goto|;
operator|*
name|ep
operator|++
operator|=
name|CDOL
expr_stmt|;
continue|continue;
case|case
literal|'['
case|:
if|if
condition|(
operator|&
name|ep
index|[
literal|17
index|]
operator|>=
operator|&
name|expbuf
index|[
name|ESIZE
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"RE too long: %s\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
operator|*
name|ep
operator|++
operator|=
name|CCL
expr_stmt|;
name|neg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
operator|*
name|sp
operator|++
operator|)
operator|==
literal|'^'
condition|)
block|{
name|neg
operator|=
literal|1
expr_stmt|;
name|c
operator|=
operator|*
name|sp
operator|++
expr_stmt|;
block|}
name|cstart
operator|=
name|sp
expr_stmt|;
do|do
block|{
if|if
condition|(
name|c
operator|==
literal|'\0'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|CGMES
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|==
literal|'-'
operator|&&
name|sp
operator|>
name|cstart
operator|&&
operator|*
name|sp
operator|!=
literal|']'
condition|)
block|{
for|for
control|(
name|c
operator|=
name|sp
index|[
operator|-
literal|2
index|]
init|;
name|c
operator|<
operator|*
name|sp
condition|;
name|c
operator|++
control|)
name|ep
index|[
name|c
operator|>>
literal|3
index|]
operator||=
name|bittab
index|[
name|c
operator|&
literal|07
index|]
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
block|{
switch|switch
condition|(
name|c
operator|=
operator|*
name|sp
operator|++
condition|)
block|{
case|case
literal|'n'
case|:
name|c
operator|=
literal|'\n'
expr_stmt|;
break|break;
block|}
block|}
name|ep
index|[
name|c
operator|>>
literal|3
index|]
operator||=
name|bittab
index|[
name|c
operator|&
literal|07
index|]
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|c
operator|=
operator|*
name|sp
operator|++
operator|)
operator|!=
literal|']'
condition|)
do|;
if|if
condition|(
name|neg
condition|)
for|for
control|(
name|cclcnt
operator|=
literal|0
init|;
name|cclcnt
operator|<
literal|16
condition|;
name|cclcnt
operator|++
control|)
name|ep
index|[
name|cclcnt
index|]
operator|^=
operator|-
literal|1
expr_stmt|;
name|ep
index|[
literal|0
index|]
operator|&=
literal|0376
expr_stmt|;
name|ep
operator|+=
literal|16
expr_stmt|;
continue|continue;
name|defchar
label|:
default|default:
operator|*
name|ep
operator|++
operator|=
name|CCHR
expr_stmt|;
operator|*
name|ep
operator|++
operator|=
name|c
expr_stmt|;
block|}
block|}
block|}
end_function

begin_macro
name|rline
argument_list|(
argument|lbuf
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|lbuf
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
specifier|register
name|t
expr_stmt|;
specifier|static
name|char
modifier|*
name|saveq
decl_stmt|;
name|p
operator|=
name|lbuf
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|eflag
condition|)
block|{
if|if
condition|(
name|eflag
operator|>
literal|0
condition|)
block|{
name|eflag
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|eargc
operator|--
operator|<=
literal|0
condition|)
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|q
operator|=
operator|*
operator|++
name|eargv
expr_stmt|;
while|while
condition|(
operator|*
operator|++
name|p
operator|=
operator|*
name|q
operator|++
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|'\\'
condition|)
block|{
if|if
condition|(
operator|(
operator|*
operator|++
name|p
operator|=
operator|*
name|q
operator|++
operator|)
operator|==
literal|'\0'
condition|)
block|{
name|saveq
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
continue|continue;
block|}
if|if
condition|(
operator|*
name|p
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|saveq
operator|=
name|q
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
name|saveq
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|q
operator|=
name|saveq
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
while|while
condition|(
operator|*
operator|++
name|p
operator|=
operator|*
name|q
operator|++
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|'\\'
condition|)
block|{
if|if
condition|(
operator|(
operator|*
operator|++
name|p
operator|=
operator|*
name|q
operator|++
operator|)
operator|==
literal|'0'
condition|)
block|{
name|saveq
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
continue|continue;
block|}
if|if
condition|(
operator|*
name|p
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|saveq
operator|=
name|q
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
name|saveq
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
while|while
condition|(
operator|(
name|t
operator|=
name|getc
argument_list|(
name|fin
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
operator|*
operator|++
name|p
operator|=
name|t
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'\\'
condition|)
block|{
name|t
operator|=
name|getc
argument_list|(
name|fin
argument_list|)
expr_stmt|;
operator|*
operator|++
name|p
operator|=
name|t
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|p
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
operator|*
operator|++
name|p
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_function
name|char
modifier|*
name|address
parameter_list|(
name|expbuf
parameter_list|)
name|char
modifier|*
name|expbuf
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|rcp
decl_stmt|;
name|long
name|lno
decl_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'$'
condition|)
block|{
name|cp
operator|++
expr_stmt|;
operator|*
name|expbuf
operator|++
operator|=
name|CEND
expr_stmt|;
operator|*
name|expbuf
operator|++
operator|=
name|CEOF
expr_stmt|;
return|return
operator|(
name|expbuf
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|cp
operator|==
literal|'/'
condition|)
block|{
name|seof
operator|=
literal|'/'
expr_stmt|;
name|cp
operator|++
expr_stmt|;
return|return
operator|(
name|compile
argument_list|(
name|expbuf
argument_list|)
operator|)
return|;
block|}
name|rcp
operator|=
name|cp
expr_stmt|;
name|lno
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|rcp
operator|>=
literal|'0'
operator|&&
operator|*
name|rcp
operator|<=
literal|'9'
condition|)
name|lno
operator|=
name|lno
operator|*
literal|10
operator|+
operator|*
name|rcp
operator|++
operator|-
literal|'0'
expr_stmt|;
if|if
condition|(
name|rcp
operator|>
name|cp
condition|)
block|{
operator|*
name|expbuf
operator|++
operator|=
name|CLNUM
expr_stmt|;
operator|*
name|expbuf
operator|++
operator|=
name|nlno
expr_stmt|;
name|tlno
index|[
name|nlno
operator|++
index|]
operator|=
name|lno
expr_stmt|;
if|if
condition|(
name|nlno
operator|>=
name|NLINES
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Too many line numbers\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
operator|*
name|expbuf
operator|++
operator|=
name|CEOF
expr_stmt|;
name|cp
operator|=
name|rcp
expr_stmt|;
return|return
operator|(
name|expbuf
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_macro
name|cmp
argument_list|(
argument|a
argument_list|,
argument|b
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|ra
decl_stmt|,
modifier|*
name|rb
decl_stmt|;
name|ra
operator|=
name|a
operator|-
literal|1
expr_stmt|;
name|rb
operator|=
name|b
operator|-
literal|1
expr_stmt|;
while|while
condition|(
operator|*
operator|++
name|ra
operator|==
operator|*
operator|++
name|rb
condition|)
if|if
condition|(
operator|*
name|ra
operator|==
literal|'\0'
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_function
name|char
modifier|*
name|text
parameter_list|(
name|textbuf
parameter_list|)
name|char
modifier|*
name|textbuf
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|p
operator|=
name|textbuf
expr_stmt|;
name|q
operator|=
name|cp
expr_stmt|;
while|while
condition|(
operator|*
name|q
operator|==
literal|'\t'
operator|||
operator|*
name|q
operator|==
literal|' '
condition|)
name|q
operator|++
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
operator|*
name|p
operator|=
operator|*
name|q
operator|++
operator|)
operator|==
literal|'\\'
condition|)
operator|*
name|p
operator|=
operator|*
name|q
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
block|{
name|cp
operator|=
operator|--
name|q
expr_stmt|;
return|return
operator|(
operator|++
name|p
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|p
operator|==
literal|'\n'
condition|)
block|{
while|while
condition|(
operator|*
name|q
operator|==
literal|'\t'
operator|||
operator|*
name|q
operator|==
literal|' '
condition|)
name|q
operator|++
expr_stmt|;
block|}
name|p
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|struct
name|label
modifier|*
name|search
parameter_list|(
name|ptr
parameter_list|)
name|struct
name|label
modifier|*
name|ptr
decl_stmt|;
block|{
name|struct
name|label
modifier|*
name|rp
decl_stmt|;
name|rp
operator|=
name|labtab
expr_stmt|;
while|while
condition|(
name|rp
operator|<
name|ptr
condition|)
block|{
if|if
condition|(
name|cmp
argument_list|(
name|rp
operator|->
name|asc
argument_list|,
name|ptr
operator|->
name|asc
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|rp
operator|)
return|;
name|rp
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_macro
name|dechain
argument_list|()
end_macro

begin_block
block|{
name|struct
name|label
modifier|*
name|lptr
decl_stmt|;
name|union
name|reptr
modifier|*
name|rptr
decl_stmt|,
modifier|*
name|trptr
decl_stmt|;
for|for
control|(
name|lptr
operator|=
name|labtab
init|;
name|lptr
operator|<
name|lab
condition|;
name|lptr
operator|++
control|)
block|{
if|if
condition|(
name|lptr
operator|->
name|address
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Undefined label: %s\n"
argument_list|,
name|lptr
operator|->
name|asc
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lptr
operator|->
name|chain
condition|)
block|{
name|rptr
operator|=
name|lptr
operator|->
name|chain
expr_stmt|;
while|while
condition|(
name|trptr
operator|=
name|rptr
operator|->
name|lb1
condition|)
block|{
name|rptr
operator|->
name|lb1
operator|=
name|lptr
operator|->
name|address
expr_stmt|;
name|rptr
operator|=
name|trptr
expr_stmt|;
block|}
name|rptr
operator|->
name|lb1
operator|=
name|lptr
operator|->
name|address
expr_stmt|;
block|}
block|}
block|}
end_block

begin_function
name|char
modifier|*
name|ycomp
parameter_list|(
name|expbuf
parameter_list|)
name|char
modifier|*
name|expbuf
decl_stmt|;
block|{
specifier|register
name|char
name|c
decl_stmt|,
modifier|*
name|ep
decl_stmt|,
modifier|*
name|tsp
decl_stmt|;
name|char
modifier|*
name|sp
decl_stmt|;
name|ep
operator|=
name|expbuf
expr_stmt|;
name|sp
operator|=
name|cp
expr_stmt|;
for|for
control|(
name|tsp
operator|=
name|cp
init|;
operator|*
name|tsp
operator|!=
name|seof
condition|;
name|tsp
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|tsp
operator|==
literal|'\\'
condition|)
name|tsp
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|tsp
operator|==
literal|'\n'
condition|)
return|return
operator|(
name|badp
operator|)
return|;
block|}
name|tsp
operator|++
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|sp
operator|++
operator|&
literal|0177
operator|)
operator|!=
name|seof
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\\'
operator|&&
operator|*
name|sp
operator|==
literal|'n'
condition|)
block|{
name|sp
operator|++
expr_stmt|;
name|c
operator|=
literal|'\n'
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ep
index|[
name|c
index|]
operator|=
operator|*
name|tsp
operator|++
operator|)
operator|==
literal|'\\'
operator|&&
operator|*
name|tsp
operator|==
literal|'n'
condition|)
block|{
name|ep
index|[
name|c
index|]
operator|=
literal|'\n'
expr_stmt|;
name|tsp
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ep
index|[
name|c
index|]
operator|==
name|seof
operator|||
name|ep
index|[
name|c
index|]
operator|==
literal|'\0'
condition|)
return|return
operator|(
name|badp
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|tsp
operator|!=
name|seof
condition|)
return|return
operator|(
name|badp
operator|)
return|;
name|cp
operator|=
operator|++
name|tsp
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
operator|!
operator|(
name|c
operator|&
literal|0200
operator|)
condition|;
name|c
operator|++
control|)
if|if
condition|(
name|ep
index|[
name|c
index|]
operator|==
literal|0
condition|)
name|ep
index|[
name|c
index|]
operator|=
name|c
expr_stmt|;
return|return
operator|(
name|ep
operator|+
literal|0200
operator|)
return|;
block|}
end_function

end_unit


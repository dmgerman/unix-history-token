begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_empty
empty|#
end_empty

begin_comment
comment|/*  *  *	UNIX debugger  *  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_decl_stmt
name|MSG
name|NOEOR
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|mkfault
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|executing
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|infile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|CHAR
modifier|*
name|lp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|maxoff
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|maxpos
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|sigint
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|sigqit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|wtflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|maxfile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|maxstor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|txtsiz
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|datsiz
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|datbas
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|stksiz
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STRING
name|errflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|exitflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|magic
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|entrypt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|CHAR
name|lastc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|eof
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|lastcom
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|var
index|[
literal|36
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STRING
name|symfil
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STRING
name|corfil
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|CHAR
name|printbuf
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|CHAR
modifier|*
name|printptr
decl_stmt|;
end_decl_stmt

begin_function
name|L_INT
name|round
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
name|L_INT
name|a
decl_stmt|,
name|b
decl_stmt|;
block|{
name|L_INT
name|w
decl_stmt|;
name|w
operator|=
operator|(
operator|(
name|a
operator|+
name|b
operator|-
literal|1
operator|)
operator|/
name|b
operator|)
operator|*
name|b
expr_stmt|;
return|return
operator|(
name|w
operator|)
return|;
block|}
end_function

begin_comment
comment|/* error handling */
end_comment

begin_macro
name|chkerr
argument_list|()
end_macro

begin_block
block|{
name|IF
name|errflg
name|ORF
name|mkfault
name|THEN
name|error
parameter_list|(
name|errflg
parameter_list|)
function_decl|;
name|FI
block|}
end_block

begin_macro
name|error
argument_list|(
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|STRING
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|errflg
operator|=
name|n
expr_stmt|;
name|iclose
argument_list|()
expr_stmt|;
name|oclose
argument_list|()
expr_stmt|;
name|longjmp
argument_list|(
name|erradb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|fault
argument_list|(
argument|a
argument_list|)
end_macro

begin_block
block|{
name|signal
argument_list|(
name|a
argument_list|,
name|fault
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|infile
argument_list|,
literal|0L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|mkfault
operator|++
expr_stmt|;
block|}
end_block

begin_comment
comment|/* set up files and initial address mappings */
end_comment

begin_decl_stmt
name|INT
name|argcount
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|REG
name|STRING
modifier|*
name|argv
decl_stmt|;
name|REG
name|INT
name|argc
decl_stmt|;
block|{
name|maxfile
operator|=
literal|1L
operator|<<
literal|24
expr_stmt|;
name|maxstor
operator|=
literal|1L
operator|<<
literal|16
expr_stmt|;
name|gtty
argument_list|(
literal|0
argument_list|,
operator|&
name|adbtty
argument_list|)
expr_stmt|;
name|gtty
argument_list|(
literal|0
argument_list|,
operator|&
name|usrtty
argument_list|)
expr_stmt|;
name|WHILE
name|argc
operator|>
literal|1
name|DO
name|IF
name|eqstr
argument_list|(
literal|"-w"
argument_list|,
argument|argv[
literal|1
argument|]
argument_list|)
name|THEN
name|wtflag
operator|=
literal|2
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|ELSE
break|break;
name|FI
name|OD
name|IF
name|argc
operator|>
literal|1
name|THEN
name|symfil
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|FI
name|IF
name|argc
operator|>
literal|2
name|THEN
name|corfil
operator|=
name|argv
index|[
literal|2
index|]
expr_stmt|;
name|FI
name|argcount
init|=
name|argc
decl_stmt|;
name|setsym
argument_list|()
expr_stmt|;
name|setcor
argument_list|()
expr_stmt|;
comment|/* set up variables for user */
name|maxoff
operator|=
name|MAXOFF
expr_stmt|;
name|maxpos
operator|=
name|MAXPOS
expr_stmt|;
name|var
index|[
name|VARB
index|]
operator|=
name|datbas
expr_stmt|;
name|var
index|[
name|VARD
index|]
operator|=
name|datsiz
expr_stmt|;
name|var
index|[
name|VARE
index|]
operator|=
name|entrypt
expr_stmt|;
name|var
index|[
name|VARM
index|]
operator|=
name|magic
expr_stmt|;
name|var
index|[
name|VARS
index|]
operator|=
name|stksiz
expr_stmt|;
name|var
index|[
name|VART
index|]
operator|=
name|txtsiz
expr_stmt|;
name|IF
argument_list|(
name|sigint
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
literal|01
argument_list|)
argument_list|)
operator|!=
literal|01
name|THEN
name|sigint
operator|=
name|fault
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|fault
argument_list|)
expr_stmt|;
name|FI
name|sigqit
init|=
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|setjmp
argument_list|(
name|erradb
argument_list|)
expr_stmt|;
name|IF
name|executing
name|THEN
name|delbp
parameter_list|()
function_decl|;
name|FI
name|executing
init|=
name|FALSE
decl_stmt|;
name|LOOP
name|flushbuf
parameter_list|()
function_decl|;
name|IF
name|errflg
name|THEN
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|errflg
argument_list|)
decl_stmt|;
name|exitflg
operator|=
name|errflg
expr_stmt|;
name|errflg
operator|=
literal|0
expr_stmt|;
name|FI
name|IF
name|mkfault
name|THEN
name|mkfault
init|=
literal|0
decl_stmt|;
name|printc
argument_list|(
name|EOR
argument_list|)
expr_stmt|;
name|prints
argument_list|(
name|DBNAME
argument_list|)
expr_stmt|;
name|FI
name|lp
init|=
literal|0
decl_stmt|;
name|rdc
argument_list|()
expr_stmt|;
name|lp
operator|--
expr_stmt|;
name|IF
name|eof
name|THEN
name|IF
name|infile
name|THEN
name|iclose
parameter_list|()
function_decl|;
name|eof
operator|=
literal|0
expr_stmt|;
name|longjmp
argument_list|(
name|erradb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ELSE
name|done
parameter_list|()
function_decl|;
name|FI
name|ELSE
name|exitflg
init|=
literal|0
decl_stmt|;
name|FI
name|command
argument_list|(
literal|0
argument_list|,
name|lastcom
argument_list|)
decl_stmt|;
name|IF
name|lp
name|ANDF
name|lastc
operator|!=
name|EOR
name|THEN
name|error
argument_list|(
name|NOEOR
argument_list|)
expr_stmt|;
name|FI
name|POOL
block|}
end_function

begin_macro
name|done
argument_list|()
end_macro

begin_block
block|{
name|endpcs
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|exitflg
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


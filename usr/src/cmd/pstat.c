begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Print system stuff  */
end_comment

begin_define
define|#
directive|define
name|mask
parameter_list|(
name|x
parameter_list|)
value|(x&0377)
end_define

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_decl_stmt
name|char
modifier|*
name|fcore
init|=
literal|"/dev/kmem"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fnlist
init|=
literal|"/unix"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fc
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|setup
block|{
name|char
name|name
index|[
literal|8
index|]
decl_stmt|;
name|int
name|type
decl_stmt|;
name|unsigned
name|value
decl_stmt|;
block|}
name|setup
index|[]
init|=
block|{
define|#
directive|define
name|SINODE
value|0
literal|"_inode"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|STEXT
value|1
literal|"_text"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|SPROC
value|2
literal|"_proc"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|SDZ
value|3
literal|"_dz_tty"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|SNDZ
value|4
literal|"_dz_cnt"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|SKL
value|5
literal|"_cons"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|SFIL
value|6
literal|"_file"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|SMPXC
value|7
literal|"_mpx_chan"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|SMPXM
value|8
literal|"_mpx_mach"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|SMPXB1
value|9
literal|"_mptbc"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|SMPXB2
value|10
literal|"_mptbuf"
block|,
literal|0
block|,
literal|0
block|,
define|#
directive|define
name|SMPSM
value|11
literal|"_mpsm"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
struct|;
end_struct

begin_decl_stmt
name|int
name|inof
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|txtf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|prcf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ttyf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mpxf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|usrf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|ubase
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|filf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|partab
index|[
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cdevsw
name|cdevsw
index|[
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|bdevsw
name|bdevsw
index|[
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|allflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kflg
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
while|while
condition|(
operator|--
name|argc
operator|&&
operator|*
operator|*
operator|++
name|argv
operator|==
literal|'-'
condition|)
block|{
while|while
condition|(
operator|*
operator|++
operator|*
name|argv
condition|)
switch|switch
condition|(
operator|*
operator|*
name|argv
condition|)
block|{
case|case
literal|'a'
case|:
name|allflg
operator|++
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|inof
operator|++
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|kflg
operator|++
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|txtf
operator|++
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|prcf
operator|++
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|ttyf
operator|++
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|mpxf
operator|++
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|printf
argument_list|(
literal|"pstat: -u not implemented\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|==
literal|0
condition|)
break|break;
name|usrf
operator|++
expr_stmt|;
name|sscanf
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
literal|"%x"
argument_list|,
operator|&
name|ubase
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|filf
operator|++
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|fcore
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|fc
operator|=
name|open
argument_list|(
name|fcore
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Can't find %s\n"
argument_list|,
name|fcore
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|fnlist
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|nlist
argument_list|(
name|fnlist
argument_list|,
name|setup
argument_list|)
expr_stmt|;
if|if
condition|(
name|kflg
condition|)
block|{
specifier|register
name|struct
name|setup
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|setup
init|;
name|sp
operator|->
name|value
condition|;
name|sp
operator|++
control|)
name|sp
operator|->
name|value
operator|&=
literal|0x7fffffff
expr_stmt|;
block|}
if|if
condition|(
name|setup
index|[
name|SINODE
index|]
operator|.
name|type
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"no namelist\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inof
condition|)
name|doinode
argument_list|()
expr_stmt|;
if|if
condition|(
name|txtf
condition|)
name|dotext
argument_list|()
expr_stmt|;
if|if
condition|(
name|ttyf
condition|)
name|dotty
argument_list|()
expr_stmt|;
if|if
condition|(
name|prcf
condition|)
name|doproc
argument_list|()
expr_stmt|;
comment|/* 	if (usrf) 		dousr();  */
if|if
condition|(
name|filf
condition|)
name|dofil
argument_list|()
expr_stmt|;
comment|/* 	if(mpxf) 		dompx(); */
block|}
end_function

begin_macro
name|doinode
argument_list|()
end_macro

begin_block
block|{
include|#
directive|include
file|<sys/inode.h>
specifier|register
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
name|struct
name|inode
name|xinode
index|[
name|NINODE
index|]
decl_stmt|;
specifier|register
name|int
name|nin
decl_stmt|,
name|loc
decl_stmt|;
name|nin
operator|=
literal|0
expr_stmt|;
name|lseek
argument_list|(
name|fc
argument_list|,
operator|(
name|long
operator|)
name|setup
index|[
name|SINODE
index|]
operator|.
name|value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|fc
argument_list|,
name|xinode
argument_list|,
sizeof|sizeof
argument_list|(
name|xinode
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ip
operator|=
name|xinode
init|;
name|ip
operator|<
operator|&
name|xinode
index|[
name|NINODE
index|]
condition|;
name|ip
operator|++
control|)
if|if
condition|(
name|ip
operator|->
name|i_count
condition|)
name|nin
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"%d active xinodes\n"
argument_list|,
name|nin
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   LOC    FLAGS  CNT DEVICE  INO  MODE  NLK UID   SIZE/DEV\n"
argument_list|)
expr_stmt|;
name|loc
operator|=
name|setup
index|[
name|SINODE
index|]
operator|.
name|value
expr_stmt|;
for|for
control|(
name|ip
operator|=
name|xinode
init|;
name|ip
operator|<
operator|&
name|xinode
index|[
name|NINODE
index|]
condition|;
name|ip
operator|++
operator|,
name|loc
operator|+=
sizeof|sizeof
argument_list|(
name|xinode
index|[
literal|0
index|]
argument_list|)
control|)
block|{
if|if
condition|(
name|ip
operator|->
name|i_count
operator|==
literal|0
condition|)
continue|continue;
name|printf
argument_list|(
literal|"%8.1x "
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|ip
operator|->
name|i_flag
operator|&
name|ILOCK
argument_list|,
literal|'L'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|ip
operator|->
name|i_flag
operator|&
name|IUPD
argument_list|,
literal|'U'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|ip
operator|->
name|i_flag
operator|&
name|IACC
argument_list|,
literal|'A'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|ip
operator|->
name|i_flag
operator|&
name|IMOUNT
argument_list|,
literal|'M'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|ip
operator|->
name|i_flag
operator|&
name|IWANT
argument_list|,
literal|'W'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|ip
operator|->
name|i_flag
operator|&
name|ITEXT
argument_list|,
literal|'T'
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|ip
operator|->
name|i_count
operator|&
literal|0377
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d,%3d"
argument_list|,
name|major
argument_list|(
name|ip
operator|->
name|i_dev
argument_list|)
argument_list|,
name|minor
argument_list|(
name|ip
operator|->
name|i_dev
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%5l"
argument_list|,
name|ip
operator|->
name|i_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%6x"
argument_list|,
name|ip
operator|->
name|i_mode
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|ip
operator|->
name|i_nlink
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|ip
operator|->
name|i_uid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ip
operator|->
name|i_mode
operator|&
name|IFMT
operator|)
operator|==
name|IFBLK
operator|||
operator|(
name|ip
operator|->
name|i_mode
operator|&
name|IFMT
operator|)
operator|==
name|IFCHR
condition|)
name|printf
argument_list|(
literal|"%6d,%3d"
argument_list|,
name|major
argument_list|(
name|ip
operator|->
name|i_un
operator|.
name|i_rdev
argument_list|)
argument_list|,
name|minor
argument_list|(
name|ip
operator|->
name|i_un
operator|.
name|i_rdev
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%10ld"
argument_list|,
name|ip
operator|->
name|i_size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|putf
argument_list|(
argument|v
argument_list|,
argument|n
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|v
condition|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|n
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|dotext
argument_list|()
end_macro

begin_block
block|{
include|#
directive|include
file|<sys/text.h>
name|struct
name|text
name|xtext
index|[
name|NTEXT
index|]
decl_stmt|,
modifier|*
name|xp
decl_stmt|;
specifier|register
name|loc
expr_stmt|;
name|int
name|ntx
decl_stmt|;
name|ntx
operator|=
literal|0
expr_stmt|;
name|lseek
argument_list|(
name|fc
argument_list|,
operator|(
name|long
operator|)
name|setup
index|[
name|STEXT
index|]
operator|.
name|value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|fc
argument_list|,
name|xtext
argument_list|,
sizeof|sizeof
argument_list|(
name|xtext
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|xp
operator|=
name|xtext
init|;
name|xp
operator|<
operator|&
name|xtext
index|[
name|NTEXT
index|]
condition|;
name|xp
operator|++
control|)
if|if
condition|(
name|xp
operator|->
name|x_iptr
operator|!=
name|NULL
condition|)
name|ntx
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"%d text segments\n"
argument_list|,
name|ntx
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   LOC   FLAGS  DADDR   CADDR   SIZE   ITPR    CNT CCNT\n"
argument_list|)
expr_stmt|;
name|loc
operator|=
name|setup
index|[
name|STEXT
index|]
operator|.
name|value
expr_stmt|;
for|for
control|(
name|xp
operator|=
name|xtext
init|;
name|xp
operator|<
operator|&
name|xtext
index|[
name|NTEXT
index|]
condition|;
name|xp
operator|++
operator|,
name|loc
operator|+=
sizeof|sizeof
argument_list|(
name|xtext
index|[
literal|0
index|]
argument_list|)
control|)
block|{
if|if
condition|(
name|xp
operator|->
name|x_iptr
operator|==
name|NULL
condition|)
continue|continue;
name|printf
argument_list|(
literal|"%8.1x"
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|xp
operator|->
name|x_flag
operator|&
name|XTRC
argument_list|,
literal|'T'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|xp
operator|->
name|x_flag
operator|&
name|XWRIT
argument_list|,
literal|'W'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|xp
operator|->
name|x_flag
operator|&
name|XLOAD
argument_list|,
literal|'L'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|xp
operator|->
name|x_flag
operator|&
name|XLOCK
argument_list|,
literal|'K'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|xp
operator|->
name|x_flag
operator|&
name|XWANT
argument_list|,
literal|'w'
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%5u"
argument_list|,
name|xp
operator|->
name|x_daddr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%11x"
argument_list|,
name|xp
operator|->
name|x_caddr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%5d"
argument_list|,
name|xp
operator|->
name|x_size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%10.1x"
argument_list|,
name|xp
operator|->
name|x_iptr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%5d"
argument_list|,
name|xp
operator|->
name|x_count
operator|&
literal|0377
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|xp
operator|->
name|x_ccount
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|doproc
argument_list|()
end_macro

begin_block
block|{
include|#
directive|include
file|<sys/proc.h>
name|struct
name|proc
name|xproc
index|[
name|NPROC
index|]
decl_stmt|;
specifier|register
name|struct
name|proc
modifier|*
name|pp
decl_stmt|;
specifier|register
name|loc
operator|,
name|np
expr_stmt|;
name|lseek
argument_list|(
name|fc
argument_list|,
operator|(
name|long
operator|)
name|setup
index|[
name|SPROC
index|]
operator|.
name|value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|fc
argument_list|,
name|xproc
argument_list|,
sizeof|sizeof
argument_list|(
name|xproc
argument_list|)
argument_list|)
expr_stmt|;
name|np
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|pp
operator|=
name|xproc
init|;
name|pp
operator|<
operator|&
name|xproc
index|[
name|NPROC
index|]
condition|;
name|pp
operator|++
control|)
if|if
condition|(
name|pp
operator|->
name|p_stat
condition|)
name|np
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"%d processes\n"
argument_list|,
name|np
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   LOC   S  F   PRI SIGNAL UID TIM CPU NI   PGRP  PID  PPID   ADDR  SIZE  WCHAN      LINK    TEXTP  CLKT\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|loc
operator|=
name|setup
index|[
name|SPROC
index|]
operator|.
name|value
operator|,
name|pp
operator|=
name|xproc
init|;
name|pp
operator|<
operator|&
name|xproc
index|[
name|NPROC
index|]
condition|;
name|pp
operator|++
operator|,
name|loc
operator|+=
sizeof|sizeof
argument_list|(
name|xproc
index|[
literal|0
index|]
argument_list|)
control|)
block|{
if|if
condition|(
name|pp
operator|->
name|p_stat
operator|==
literal|0
operator|&&
name|allflg
operator|==
literal|0
condition|)
continue|continue;
name|printf
argument_list|(
literal|"%8x"
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%2d"
argument_list|,
name|pp
operator|->
name|p_stat
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%3o"
argument_list|,
name|pp
operator|->
name|p_flag
operator|&
literal|0377
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%5d"
argument_list|,
name|pp
operator|->
name|p_pri
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7o"
argument_list|,
name|pp
operator|->
name|p_sig
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|pp
operator|->
name|p_uid
operator|&
literal|0377
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%5d"
argument_list|,
name|pp
operator|->
name|p_time
operator|&
literal|0377
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|pp
operator|->
name|p_cpu
operator|&
literal|0377
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%3d"
argument_list|,
name|pp
operator|->
name|p_nice
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%6d"
argument_list|,
name|pp
operator|->
name|p_pgrp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%6d"
argument_list|,
name|pp
operator|->
name|p_pid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%6d"
argument_list|,
name|pp
operator|->
name|p_ppid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8x"
argument_list|,
name|pp
operator|->
name|p_addr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%5x"
argument_list|,
name|pp
operator|->
name|p_size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%9x"
argument_list|,
name|pp
operator|->
name|p_wchan
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%9x"
argument_list|,
name|pp
operator|->
name|p_link
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%9x"
argument_list|,
name|pp
operator|->
name|p_textp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   %u"
argument_list|,
name|pp
operator|->
name|p_clktim
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|dotty
argument_list|()
end_macro

begin_block
block|{
name|struct
name|tty
name|dz_tty
index|[
literal|32
index|]
decl_stmt|;
name|int
name|ndz
decl_stmt|;
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
specifier|register
name|char
modifier|*
name|mesg
decl_stmt|;
name|printf
argument_list|(
literal|"1 cons\n"
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|fc
argument_list|,
operator|(
name|long
operator|)
name|setup
index|[
name|SKL
index|]
operator|.
name|value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|fc
argument_list|,
name|dz_tty
argument_list|,
sizeof|sizeof
argument_list|(
name|dz_tty
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|mesg
operator|=
literal|" RAW CAN OUT   MODE    ADDR   DEL COL  STATE   PGRP\n"
expr_stmt|;
name|printf
argument_list|(
name|mesg
argument_list|)
expr_stmt|;
name|ttyprt
argument_list|(
operator|&
name|dz_tty
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|setup
index|[
name|SNDZ
index|]
operator|.
name|type
operator|==
operator|-
literal|1
condition|)
return|return;
name|lseek
argument_list|(
name|fc
argument_list|,
operator|(
name|long
operator|)
name|setup
index|[
name|SNDZ
index|]
operator|.
name|value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|fc
argument_list|,
operator|&
name|ndz
argument_list|,
sizeof|sizeof
argument_list|(
name|ndz
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d dz lines\n"
argument_list|,
name|ndz
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|fc
argument_list|,
operator|(
name|long
operator|)
name|setup
index|[
name|SDZ
index|]
operator|.
name|value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|fc
argument_list|,
name|dz_tty
argument_list|,
sizeof|sizeof
argument_list|(
name|dz_tty
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|tp
operator|=
name|dz_tty
init|;
name|tp
operator|<
operator|&
name|dz_tty
index|[
name|ndz
index|]
condition|;
name|tp
operator|++
control|)
name|ttyprt
argument_list|(
name|tp
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ttyprt
argument_list|(
argument|atp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|tty
modifier|*
name|atp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
name|tp
operator|=
name|atp
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|tp
operator|->
name|t_rawq
operator|.
name|c_cc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|tp
operator|->
name|t_canq
operator|.
name|c_cc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8.1o"
argument_list|,
name|tp
operator|->
name|t_flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %8.1x"
argument_list|,
name|tp
operator|->
name|t_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%3d"
argument_list|,
name|tp
operator|->
name|t_delct
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d "
argument_list|,
name|tp
operator|->
name|t_col
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|tp
operator|->
name|t_state
operator|&
name|TIMEOUT
argument_list|,
literal|'T'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|tp
operator|->
name|t_state
operator|&
name|WOPEN
argument_list|,
literal|'W'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|tp
operator|->
name|t_state
operator|&
name|ISOPEN
argument_list|,
literal|'O'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|tp
operator|->
name|t_state
operator|&
name|CARR_ON
argument_list|,
literal|'C'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|tp
operator|->
name|t_state
operator|&
name|BUSY
argument_list|,
literal|'B'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|tp
operator|->
name|t_state
operator|&
name|ASLEEP
argument_list|,
literal|'A'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|tp
operator|->
name|t_state
operator|&
name|XCLUDE
argument_list|,
literal|'X'
argument_list|)
expr_stmt|;
comment|/* 	putf(tp->t_state&HUPCLS, 'H');  */
name|printf
argument_list|(
literal|"%6d"
argument_list|,
name|tp
operator|->
name|t_pgrp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|dousr
argument_list|()
end_macro

begin_block
block|{
include|#
directive|include
file|<sys/dir.h>
include|#
directive|include
file|<sys/user.h>
name|struct
name|user
name|U
decl_stmt|;
specifier|register
name|i
operator|,
name|j
operator|,
operator|*
name|ip
expr_stmt|;
name|lseek
argument_list|(
name|fc
argument_list|,
name|ubase
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|fc
argument_list|,
operator|&
name|U
argument_list|,
sizeof|sizeof
argument_list|(
name|U
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	printf("rsav %.1o %.1o\n", U.u_rsav[0], U.u_rsav[1]);  */
name|printf
argument_list|(
literal|"segflg, error %d, %d\n"
argument_list|,
name|U
operator|.
name|u_segflg
argument_list|,
name|U
operator|.
name|u_error
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"uids %d,%d,%d,%d\n"
argument_list|,
name|U
operator|.
name|u_uid
argument_list|,
name|U
operator|.
name|u_gid
argument_list|,
name|U
operator|.
name|u_ruid
argument_list|,
name|U
operator|.
name|u_rgid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"procp %.1x\n"
argument_list|,
name|U
operator|.
name|u_procp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"base, count, offset %.1x %.1x %ld\n"
argument_list|,
name|U
operator|.
name|u_base
argument_list|,
name|U
operator|.
name|u_count
argument_list|,
name|U
operator|.
name|u_offset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cdir %.1x\n"
argument_list|,
name|U
operator|.
name|u_cdir
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dbuf %.14s\n"
argument_list|,
name|U
operator|.
name|u_dbuf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dirp %.1x\n"
argument_list|,
name|U
operator|.
name|u_dirp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dent %d %.14s\n"
argument_list|,
name|U
operator|.
name|u_dent
operator|.
name|d_ino
argument_list|,
name|U
operator|.
name|u_dent
operator|.
name|d_name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"pdir %.1o\n"
argument_list|,
name|U
operator|.
name|u_pdir
argument_list|)
expr_stmt|;
comment|/* 	printf("dseg"); 	for (i=0; i<8; i++) 		printf("%8.1o", U.u_uisa[i]); 	printf("\n    "); 	for (i=0; i<8; i++) 		printf("%8.1o", U.u_uisd[i]); 	if (U.u_sep) { 		printf("\ntseg"); 		for (i=8; i<16; i++) 			printf("%8.1o", U.u_uisa[i]); 		printf("\n    "); 		for (i=8; i<16; i++) 			printf("%8.1o", U.u_uisd[i]); 	}  */
name|printf
argument_list|(
literal|"\nfile"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%9.1x"
argument_list|,
name|U
operator|.
name|u_ofile
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n    "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|10
init|;
name|i
operator|<
name|NOFILE
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%9.1x"
argument_list|,
name|U
operator|.
name|u_ofile
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nargs"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %.1x"
argument_list|,
name|U
operator|.
name|u_arg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nsizes %.1x %.1x %.1x\n"
argument_list|,
name|U
operator|.
name|u_tsize
argument_list|,
name|U
operator|.
name|u_dsize
argument_list|,
name|U
operator|.
name|u_ssize
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"sep %d\n"
argument_list|,
name|U
operator|.
name|u_sep
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"qsav %.1x %.1x\n"
argument_list|,
name|U
operator|.
name|u_qsav
index|[
literal|0
index|]
argument_list|,
name|U
operator|.
name|u_qsav
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ssav %.1x %.1x\n"
argument_list|,
name|U
operator|.
name|u_ssav
index|[
literal|0
index|]
argument_list|,
name|U
operator|.
name|u_ssav
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"sigs"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NSIG
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %.1x"
argument_list|,
name|U
operator|.
name|u_signal
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\ntimes %ld %ld\n"
argument_list|,
name|U
operator|.
name|u_utime
operator|/
literal|60
argument_list|,
name|U
operator|.
name|u_stime
operator|/
literal|60
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ctimes %ld %ld\n"
argument_list|,
name|U
operator|.
name|u_cutime
operator|/
literal|60
argument_list|,
name|U
operator|.
name|u_cstime
operator|/
literal|60
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ar0 %.1x\n"
argument_list|,
name|U
operator|.
name|u_ar0
argument_list|)
expr_stmt|;
comment|/* 	printf("prof"); 	for (i=0; i<4; i++) 		printf(" %.1o", U.u_prof[i]); */
name|printf
argument_list|(
literal|"\nintflg %d\n"
argument_list|,
name|U
operator|.
name|u_intflg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ttyp %.1x\n"
argument_list|,
name|U
operator|.
name|u_ttyp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ttydev %d,%d\n"
argument_list|,
name|major
argument_list|(
name|U
operator|.
name|u_ttyd
argument_list|)
argument_list|,
name|minor
argument_list|(
name|U
operator|.
name|u_ttyd
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"comm %.14s\n"
argument_list|,
name|U
operator|.
name|u_comm
argument_list|)
expr_stmt|;
comment|/* 	i =  U.u_stack -&U; 	while (U[++i] == 0); 	i&= ~07; 	while (i< 512) { 		printf("%x ", 0140000+2*i); 		for (j=0; j<8; j++) 			printf("%9x", U[i++]); 		printf("\n"); 	} */
block|}
end_block

begin_macro
name|oatoi
argument_list|(
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|v
expr_stmt|;
name|v
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|s
condition|)
name|v
operator|=
operator|(
name|v
operator|<<
literal|3
operator|)
operator|+
operator|*
name|s
operator|++
operator|-
literal|'0'
expr_stmt|;
return|return
operator|(
name|v
operator|)
return|;
block|}
end_block

begin_macro
name|dofil
argument_list|()
end_macro

begin_block
block|{
include|#
directive|include
file|<sys/file.h>
name|struct
name|file
name|xfile
index|[
name|NFILE
index|]
decl_stmt|;
specifier|register
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
specifier|register
name|nf
expr_stmt|;
name|int
name|loc
decl_stmt|;
name|nf
operator|=
literal|0
expr_stmt|;
name|lseek
argument_list|(
name|fc
argument_list|,
operator|(
name|long
operator|)
name|setup
index|[
name|SFIL
index|]
operator|.
name|value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|fc
argument_list|,
name|xfile
argument_list|,
sizeof|sizeof
argument_list|(
name|xfile
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|xfile
init|;
name|fp
operator|<
operator|&
name|xfile
index|[
name|NFILE
index|]
condition|;
name|fp
operator|++
control|)
if|if
condition|(
name|fp
operator|->
name|f_count
condition|)
name|nf
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"%d open files\n"
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   LOC   FLG  CNT   INO    OFFS\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|xfile
operator|,
name|loc
operator|=
name|setup
index|[
name|SFIL
index|]
operator|.
name|value
init|;
name|fp
operator|<
operator|&
name|xfile
index|[
name|NFILE
index|]
condition|;
name|fp
operator|++
operator|,
name|loc
operator|+=
sizeof|sizeof
argument_list|(
name|xfile
index|[
literal|0
index|]
argument_list|)
control|)
block|{
if|if
condition|(
name|fp
operator|->
name|f_count
operator|==
literal|0
condition|)
continue|continue;
name|printf
argument_list|(
literal|"%8x "
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|fp
operator|->
name|f_flag
operator|&
name|FREAD
argument_list|,
literal|'R'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|fp
operator|->
name|f_flag
operator|&
name|FWRITE
argument_list|,
literal|'W'
argument_list|)
expr_stmt|;
name|putf
argument_list|(
name|fp
operator|->
name|f_flag
operator|&
name|FPIPE
argument_list|,
literal|'P'
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|mask
argument_list|(
name|fp
operator|->
name|f_count
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%9.1x"
argument_list|,
name|fp
operator|->
name|f_inode
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %ld\n"
argument_list|,
name|fp
operator|->
name|f_un
operator|.
name|f_offset
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/********* dompx() { #include<sys/mpx.h> 	struct chan chan[C]; 	struct mach mach[M]; 	struct line line[M-1]; 	int mptbc; 	char mptbuf[TBSIZ]; 	register struct chan *cp; 	register struct mach *mp; 	register struct line *lp; 	int loc, nc;  	lseek(fc, (long)setup[SMPXC].value, 0); 	read(fc, chan, sizeof(chan)); 	lseek(fc, (long)setup[SMPXM].value, 0); 	read(fc, mach, sizeof(mach)); 	lseek(fc, (long)setup[SMPXB1].value, 0); 	read(fc,&mptbc, sizeof(mptbc)); 	lseek(fc, (long)setup[SMPXB2].value, 0); 	read(fc, mptbuf, sizeof(mptbuf)); 	lseek(fc, (long)setup[SMPSM].value, 0); 	read(fc, line, sizeof(line)); 	nc = 0; 	for(cp=chan; cp<&chan[C]; cp++) 		if(cp->cflag&ALLOC) 			nc++; 	printf("%d mpx channels\n", nc); 	printf("   LOC      FLG M   C    DEST\n"); 	for(cp=chan,loc=setup[SMPXC].value; cp<&chan[C]; cp++,loc=+sizeof(chan[0])) { 		if((cp->cflag&ALLOC) == 0) 			continue; 		printf("%7.1o ", loc); 		putf(cp->cflag&BLOCK, 'B'); 		putf(cp->cflag&WWAIT, 'B'); 		putf(cp->cflag&CRUN, 'R'); 		putf(cp->cflag&RWAIT, 'W'); 		putf(cp->cflag&ALLOC, 'A'); 		putf(cp->cflag&DIS, 'D'); 		putf(cp->cflag&DLY, 'D'); 		printf(" %1d %3d ", mask(cp->m), mask(cp->c)); 		printf("%7.1o ", cp->dest); 		printf("\n"); 	}  	printf("%d mpx machines\n", M); 	printf("   LOC  FLG RCH RCN XCH XCN\n"); 	for(mp=mach,loc=setup[SMPXM].value; mp<&mach[M]; mp++,loc=+sizeof(mach[0])) { 		printf("%7.1o ", loc); 		putf(mp->mflag&RNEXT, 'N'); 		putf(mp->mflag&MRUN, 'R'); 		putf(mp->mflag&XNEXT, 'N'); 		printf(" %3d", mask(mp->rchan)); 		printf(" %3d", mask(mp->rcount)); 		printf(" %3d", mask(mp->xchan)); 		printf(" %3d", mask(mp->xcount)); 		for(nc=0; nc<128; nc++) { 			cp = mp->chanp[nc]; 			if(cp == 0) 				continue; 			printf(" %d-%o", nc, cp); 		} 		printf("\n"); 	} 	printf("%d mpx lines\n", M-1); 	printf("   LOC  RSQ XSQ AKF XMF STE TIM SUM\n"); 	for(lp=line,loc=setup[SMPSM].value; lp<&line[M-1]; lp++, loc =+ sizeof(line[0])) { 		printf("%7.1o ", loc); 		printf("%3o ", lp->rseq); 		printf("%3o ", lp->xseq); 		printf("%3o ", lp->ackf); 		printf("%3o ", lp->xflag); 		printf("%3d ", lp->state); 		printf("%3d ", lp->time); 		printf("%7o\n", lp->sum); 	} 	printf("last characters recieved\n"); 	nc = -1; 	loc = mptbc; 	for(;;) { 		if(nc != mptbuf[loc]) { 			if(nc>= 0) 				printf(")\n"); 			nc = mptbuf[loc]; 			printf("%d(", nc); 		} else 			printf(","); 		loc++; 		if(loc>= TBSIZ) 			loc = 0; 		if(loc == mptbc) 			break; 		printf("%o", mask(mptbuf[loc])); 		loc++; 		if(loc>= TBSIZ) 			loc = 0; 		if(loc == mptbc) 			break; 	} 	printf(")\n"); } *********/
end_comment

end_unit


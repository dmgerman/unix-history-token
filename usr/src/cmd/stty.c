begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * set teletype modes  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_struct
struct|struct
block|{
name|char
modifier|*
name|string
decl_stmt|;
name|int
name|speed
decl_stmt|;
block|}
name|speeds
index|[]
init|=
block|{
literal|"0"
block|,
name|B0
block|,
literal|"50"
block|,
name|B50
block|,
literal|"75"
block|,
name|B75
block|,
literal|"110"
block|,
name|B110
block|,
literal|"134"
block|,
name|B134
block|,
literal|"134.5"
block|,
name|B134
block|,
literal|"150"
block|,
name|B150
block|,
literal|"200"
block|,
name|B200
block|,
literal|"300"
block|,
name|B300
block|,
literal|"600"
block|,
name|B600
block|,
literal|"1200"
block|,
name|B1200
block|,
literal|"1800"
block|,
name|B1800
block|,
literal|"2400"
block|,
name|B2400
block|,
literal|"4800"
block|,
name|B4800
block|,
literal|"9600"
block|,
name|B9600
block|,
literal|"exta"
block|,
name|EXTA
block|,
literal|"extb"
block|,
name|EXTB
block|,
literal|0
block|, }
struct|;
end_struct

begin_struct
struct|struct
block|{
name|char
modifier|*
name|string
decl_stmt|;
name|int
name|set
decl_stmt|;
name|int
name|reset
decl_stmt|;
block|}
name|modes
index|[]
init|=
block|{
literal|"even"
block|,
name|EVENP
block|,
literal|0
block|,
literal|"-even"
block|,
literal|0
block|,
name|EVENP
block|,
literal|"odd"
block|,
name|ODDP
block|,
literal|0
block|,
literal|"-odd"
block|,
literal|0
block|,
name|ODDP
block|,
literal|"raw"
block|,
name|RAW
block|,
literal|0
block|,
literal|"-raw"
block|,
literal|0
block|,
name|RAW
block|,
literal|"cooked"
block|,
literal|0
block|,
name|RAW
block|,
literal|"-nl"
block|,
name|CRMOD
block|,
literal|0
block|,
literal|"nl"
block|,
literal|0
block|,
name|CRMOD
block|,
literal|"echo"
block|,
name|ECHO
block|,
literal|0
block|,
literal|"-echo"
block|,
literal|0
block|,
name|ECHO
block|,
literal|"LCASE"
block|,
name|LCASE
block|,
literal|0
block|,
literal|"lcase"
block|,
name|LCASE
block|,
literal|0
block|,
literal|"-LCASE"
block|,
literal|0
block|,
name|LCASE
block|,
literal|"-lcase"
block|,
literal|0
block|,
name|LCASE
block|,
literal|"-tabs"
block|,
name|XTABS
block|,
literal|0
block|,
literal|"tabs"
block|,
literal|0
block|,
name|XTABS
block|,
literal|"cbreak"
block|,
name|CBREAK
block|,
literal|0
block|,
literal|"-cbreak"
block|,
literal|0
block|,
name|CBREAK
block|,
literal|"cr0"
block|,
name|CR0
block|,
name|CR3
block|,
literal|"cr1"
block|,
name|CR1
block|,
name|CR3
block|,
literal|"cr2"
block|,
name|CR2
block|,
name|CR3
block|,
literal|"cr3"
block|,
name|CR3
block|,
name|CR3
block|,
literal|"tab0"
block|,
name|TAB0
block|,
name|XTABS
block|,
literal|"tab1"
block|,
name|TAB1
block|,
name|XTABS
block|,
literal|"tab2"
block|,
name|TAB2
block|,
name|XTABS
block|,
literal|"nl0"
block|,
name|NL0
block|,
name|NL3
block|,
literal|"nl1"
block|,
name|NL1
block|,
name|NL3
block|,
literal|"nl2"
block|,
name|NL2
block|,
name|NL3
block|,
literal|"nl3"
block|,
name|NL3
block|,
name|NL3
block|,
literal|"ff0"
block|,
name|FF0
block|,
name|FF1
block|,
literal|"ff1"
block|,
name|FF1
block|,
name|FF1
block|,
literal|"bs0"
block|,
name|BS0
block|,
name|BS1
block|,
literal|"bs1"
block|,
name|BS1
block|,
name|BS1
block|,
literal|"33"
block|,
name|CR1
block|,
name|ALLDELAY
block|,
literal|"tty33"
block|,
name|CR1
block|,
name|ALLDELAY
block|,
literal|"37"
block|,
name|FF1
operator|+
name|CR2
operator|+
name|TAB1
operator|+
name|NL1
block|,
name|ALLDELAY
block|,
literal|"tty37"
block|,
name|FF1
operator|+
name|CR2
operator|+
name|TAB1
operator|+
name|NL1
block|,
name|ALLDELAY
block|,
literal|"05"
block|,
name|NL2
block|,
name|ALLDELAY
block|,
literal|"vt05"
block|,
name|NL2
block|,
name|ALLDELAY
block|,
literal|"tn"
block|,
name|CR1
block|,
name|ALLDELAY
block|,
literal|"tn300"
block|,
name|CR1
block|,
name|ALLDELAY
block|,
literal|"ti"
block|,
name|CR2
block|,
name|ALLDELAY
block|,
literal|"ti700"
block|,
name|CR2
block|,
name|ALLDELAY
block|,
literal|"tek"
block|,
name|FF1
block|,
name|ALLDELAY
block|,
literal|0
block|, 	}
struct|;
end_struct

begin_decl_stmt
name|char
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sgttyb
name|mode
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|gtty
argument_list|(
literal|1
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
name|prmodes
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
name|arg
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
if|if
condition|(
name|eq
argument_list|(
literal|"ek"
argument_list|)
condition|)
block|{
name|mode
operator|.
name|sg_erase
operator|=
literal|'#'
expr_stmt|;
name|mode
operator|.
name|sg_kill
operator|=
literal|'@'
expr_stmt|;
block|}
if|if
condition|(
name|eq
argument_list|(
literal|"erase"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|++
name|argv
operator|==
literal|'^'
condition|)
name|mode
operator|.
name|sg_erase
operator|=
operator|(
operator|*
name|argv
operator|)
index|[
literal|1
index|]
operator|&
literal|037
expr_stmt|;
else|else
name|mode
operator|.
name|sg_erase
operator|=
operator|*
operator|*
name|argv
expr_stmt|;
name|argc
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|eq
argument_list|(
literal|"kill"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|++
name|argv
operator|==
literal|'^'
condition|)
name|mode
operator|.
name|sg_kill
operator|=
operator|(
operator|*
name|argv
operator|)
index|[
literal|1
index|]
operator|&
literal|037
expr_stmt|;
else|else
name|mode
operator|.
name|sg_kill
operator|=
operator|*
operator|*
name|argv
expr_stmt|;
name|argc
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|eq
argument_list|(
literal|"gspeed"
argument_list|)
condition|)
block|{
name|mode
operator|.
name|sg_ispeed
operator|=
name|B300
expr_stmt|;
name|mode
operator|.
name|sg_ospeed
operator|=
name|B9600
expr_stmt|;
block|}
if|if
condition|(
name|eq
argument_list|(
literal|"hup"
argument_list|)
condition|)
block|{
name|ioctl
argument_list|(
literal|1
argument_list|,
name|TIOCHPCL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
for|for
control|(
name|i
operator|=
literal|0
init|;
name|speeds
index|[
name|i
index|]
operator|.
name|string
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|eq
argument_list|(
name|speeds
index|[
name|i
index|]
operator|.
name|string
argument_list|)
condition|)
name|mode
operator|.
name|sg_ispeed
operator|=
name|mode
operator|.
name|sg_ospeed
operator|=
name|speeds
index|[
name|i
index|]
operator|.
name|speed
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|modes
index|[
name|i
index|]
operator|.
name|string
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|eq
argument_list|(
name|modes
index|[
name|i
index|]
operator|.
name|string
argument_list|)
condition|)
block|{
name|mode
operator|.
name|sg_flags
operator|&=
operator|~
name|modes
index|[
name|i
index|]
operator|.
name|reset
expr_stmt|;
name|mode
operator|.
name|sg_flags
operator||=
name|modes
index|[
name|i
index|]
operator|.
name|set
expr_stmt|;
block|}
if|if
condition|(
name|arg
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown mode: %s\n"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
name|stty
argument_list|(
literal|1
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|eq
argument_list|(
argument|string
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|string
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|arg
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|i
operator|=
literal|0
expr_stmt|;
name|loop
label|:
if|if
condition|(
name|arg
index|[
name|i
index|]
operator|!=
name|string
index|[
name|i
index|]
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|arg
index|[
name|i
operator|++
index|]
operator|!=
literal|'\0'
condition|)
goto|goto
name|loop
goto|;
name|arg
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|prmodes
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|m
expr_stmt|;
if|if
condition|(
name|mode
operator|.
name|sg_ispeed
operator|!=
name|mode
operator|.
name|sg_ospeed
condition|)
block|{
name|prspeed
argument_list|(
literal|"input speed  "
argument_list|,
name|mode
operator|.
name|sg_ispeed
argument_list|)
expr_stmt|;
name|prspeed
argument_list|(
literal|"output speed "
argument_list|,
name|mode
operator|.
name|sg_ospeed
argument_list|)
expr_stmt|;
block|}
else|else
name|prspeed
argument_list|(
literal|"speed "
argument_list|,
name|mode
operator|.
name|sg_ispeed
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|.
name|sg_erase
operator|<
literal|' '
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"erase = '^%c'; "
argument_list|,
literal|'@'
operator|+
name|mode
operator|.
name|sg_erase
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"erase = '%c'; "
argument_list|,
name|mode
operator|.
name|sg_erase
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|.
name|sg_kill
operator|<
literal|' '
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"kill = '^%c'\n"
argument_list|,
literal|'@'
operator|+
name|mode
operator|.
name|sg_kill
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"kill = '%c'\n"
argument_list|,
name|mode
operator|.
name|sg_kill
argument_list|)
expr_stmt|;
name|m
operator|=
name|mode
operator|.
name|sg_flags
expr_stmt|;
if|if
condition|(
name|m
operator|&
name|EVENP
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"even "
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|&
name|ODDP
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"odd "
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|&
name|RAW
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"raw "
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|&
name|CRMOD
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"-nl "
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|&
name|ECHO
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"echo "
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|&
name|LCASE
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"lcase "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|m
operator|&
name|XTABS
operator|)
operator|==
name|XTABS
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"-tabs "
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|&
name|CBREAK
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cbreak "
argument_list|)
expr_stmt|;
name|delay
argument_list|(
operator|(
name|m
operator|&
name|NLDELAY
operator|)
operator|/
name|NL1
argument_list|,
literal|"nl"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|m
operator|&
name|TBDELAY
operator|)
operator|!=
name|XTABS
condition|)
name|delay
argument_list|(
operator|(
name|m
operator|&
name|TBDELAY
operator|)
operator|/
name|TAB1
argument_list|,
literal|"tab"
argument_list|)
expr_stmt|;
name|delay
argument_list|(
operator|(
name|m
operator|&
name|CRDELAY
operator|)
operator|/
name|CR1
argument_list|,
literal|"cr"
argument_list|)
expr_stmt|;
name|delay
argument_list|(
operator|(
name|m
operator|&
name|VTDELAY
operator|)
operator|/
name|FF1
argument_list|,
literal|"ff"
argument_list|)
expr_stmt|;
name|delay
argument_list|(
operator|(
name|m
operator|&
name|BSDELAY
operator|)
operator|/
name|BS1
argument_list|,
literal|"bs"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|delay
argument_list|(
argument|m
argument_list|,
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|m
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s%d "
argument_list|,
name|s
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|int
name|speed
index|[]
init|=
block|{
literal|0
block|,
literal|50
block|,
literal|75
block|,
literal|110
block|,
literal|134
block|,
literal|150
block|,
literal|200
block|,
literal|300
block|,
literal|600
block|,
literal|1200
block|,
literal|1800
block|,
literal|2400
block|,
literal|4800
block|,
literal|9600
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|prspeed
argument_list|(
argument|c
argument_list|,
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s%d baud\n"
argument_list|,
name|c
argument_list|,
name|speed
index|[
name|s
index|]
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


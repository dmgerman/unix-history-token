begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	ps - process status  *	examine and print certain things about processes  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<a.out.h>
end_include

begin_include
include|#
directive|include
file|<core.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_decl_stmt
name|struct
name|nlist
name|nl
index|[]
init|=
block|{
block|{
literal|"_proc"
block|}
block|,
block|{
literal|"_swapdev"
block|}
block|,
block|{
literal|"_swplo"
block|}
block|,
block|{
literal|""
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|proc
name|mproc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|user
name|u
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|chkpid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|retcode
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|vflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|xflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tptr
decl_stmt|;
end_decl_stmt

begin_function_decl
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|gettty
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|getptr
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|strncmp
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|aflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mem
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|swmem
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|swap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|daddr_t
name|swplo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ndev
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|devl
block|{
name|char
name|dname
index|[
name|DIRSIZ
index|]
decl_stmt|;
name|dev_t
name|dev
decl_stmt|;
block|}
name|devl
index|[
literal|256
index|]
struct|;
end_struct

begin_decl_stmt
name|char
modifier|*
name|coref
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|ap
decl_stmt|;
name|int
name|uid
decl_stmt|,
name|puid
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|ap
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
while|while
condition|(
operator|*
name|ap
condition|)
switch|switch
condition|(
operator|*
name|ap
operator|++
condition|)
block|{
case|case
literal|'v'
case|:
name|vflg
operator|++
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|aflg
operator|++
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
if|if
condition|(
operator|*
name|ap
condition|)
name|tptr
operator|=
name|ap
expr_stmt|;
name|aflg
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|tptr
operator|==
literal|'?'
condition|)
name|xflg
operator|++
expr_stmt|;
goto|goto
name|bbreak
goto|;
case|case
literal|'x'
case|:
name|xflg
operator|++
expr_stmt|;
break|break;
case|case
literal|'-'
case|:
break|break;
case|case
literal|'l'
case|:
name|lflg
operator|++
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|kflg
operator|++
expr_stmt|;
break|break;
default|default:
name|chkpid
operator|=
name|atoi
argument_list|(
name|ap
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|bbreak
goto|;
break|break;
block|}
block|}
name|bbreak
label|:
if|if
condition|(
name|chdir
argument_list|(
literal|"/dev"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't change to /dev\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|nlist
argument_list|(
name|argc
operator|>
literal|2
condition|?
name|argv
index|[
literal|2
index|]
else|:
literal|"/unix"
argument_list|,
name|nl
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl
index|[
literal|0
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No namelist\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|coref
operator|=
literal|"/dev/mem"
expr_stmt|;
if|if
condition|(
name|kflg
condition|)
name|coref
operator|=
literal|"/usr/sys/core"
expr_stmt|;
if|if
condition|(
operator|(
name|mem
operator|=
name|open
argument_list|(
name|coref
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No mem\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|swmem
operator|=
name|open
argument_list|(
name|coref
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * read mem to find swap dev. 	 */
name|lseek
argument_list|(
name|mem
argument_list|,
operator|(
name|long
operator|)
name|nl
index|[
literal|1
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|mem
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|nl
index|[
literal|1
index|]
operator|.
name|n_value
argument_list|,
sizeof|sizeof
argument_list|(
name|nl
index|[
literal|1
index|]
operator|.
name|n_value
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Find base of swap 	 */
name|lseek
argument_list|(
name|mem
argument_list|,
operator|(
name|long
operator|)
name|nl
index|[
literal|2
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|mem
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|swplo
argument_list|,
sizeof|sizeof
argument_list|(
name|swplo
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Locate proc table 	 */
name|lseek
argument_list|(
name|mem
argument_list|,
operator|(
name|long
operator|)
name|nl
index|[
literal|0
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|getdev
argument_list|()
expr_stmt|;
name|uid
operator|=
name|getuid
argument_list|()
expr_stmt|;
if|if
condition|(
name|lflg
condition|)
name|printf
argument_list|(
literal|" F S UID   PID  PPID CPU PRI NICE  ADDR  SZ  WCHAN TTY TIME CMD\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|chkpid
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"   PID TTY TIME CMD\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPROC
condition|;
name|i
operator|++
control|)
block|{
name|read
argument_list|(
name|mem
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mproc
argument_list|,
sizeof|sizeof
name|mproc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mproc
operator|.
name|p_stat
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|mproc
operator|.
name|p_pgrp
operator|==
literal|0
operator|&&
name|xflg
operator|==
literal|0
operator|&&
name|mproc
operator|.
name|p_uid
operator|==
literal|0
condition|)
continue|continue;
name|puid
operator|=
name|mproc
operator|.
name|p_uid
expr_stmt|;
if|if
condition|(
operator|(
name|uid
operator|!=
name|puid
operator|&&
name|aflg
operator|==
literal|0
operator|)
operator|||
operator|(
name|chkpid
operator|!=
literal|0
operator|&&
name|chkpid
operator|!=
name|mproc
operator|.
name|p_pid
operator|)
condition|)
continue|continue;
if|if
condition|(
name|prcom
argument_list|(
name|puid
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|retcode
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|exit
argument_list|(
name|retcode
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|getdev
argument_list|()
end_macro

begin_block
block|{
include|#
directive|include
file|<sys/stat.h>
specifier|register
name|FILE
modifier|*
name|df
decl_stmt|;
name|struct
name|stat
name|sbuf
decl_stmt|;
name|struct
name|direct
name|dbuf
decl_stmt|;
if|if
condition|(
operator|(
name|df
operator|=
name|fopen
argument_list|(
literal|"/dev"
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open /dev\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ndev
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|dbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|dbuf
argument_list|)
argument_list|,
literal|1
argument_list|,
name|df
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|dbuf
operator|.
name|d_ino
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|stat
argument_list|(
name|dbuf
operator|.
name|d_name
argument_list|,
operator|&
name|sbuf
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|(
name|sbuf
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFCHR
condition|)
continue|continue;
name|strcpy
argument_list|(
name|devl
index|[
name|ndev
index|]
operator|.
name|dname
argument_list|,
name|dbuf
operator|.
name|d_name
argument_list|)
expr_stmt|;
name|devl
index|[
name|ndev
index|]
operator|.
name|dev
operator|=
name|sbuf
operator|.
name|st_rdev
expr_stmt|;
name|ndev
operator|++
expr_stmt|;
block|}
name|fclose
argument_list|(
name|df
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|swap
operator|=
name|open
argument_list|(
literal|"/dev/swap"
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open /dev/swap\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|long
name|round
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
name|long
name|a
decl_stmt|,
name|b
decl_stmt|;
block|{
name|long
name|w
init|=
operator|(
operator|(
name|a
operator|+
name|b
operator|-
literal|1
operator|)
operator|/
name|b
operator|)
operator|*
name|b
decl_stmt|;
return|return
operator|(
name|w
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|map
block|{
name|long
name|b1
decl_stmt|,
name|e1
decl_stmt|;
name|long
name|f1
decl_stmt|;
name|long
name|b2
decl_stmt|,
name|e2
decl_stmt|;
name|long
name|f2
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|map
name|datmap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|file
decl_stmt|;
end_decl_stmt

begin_macro
name|prcom
argument_list|(
argument|puid
argument_list|)
end_macro

begin_block
block|{
name|char
name|abuf
index|[
literal|512
index|]
decl_stmt|;
name|long
name|addr
decl_stmt|;
specifier|register
name|int
modifier|*
name|ip
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|cp1
decl_stmt|;
name|long
name|tm
decl_stmt|;
name|int
name|c
decl_stmt|,
name|nbad
decl_stmt|;
specifier|register
name|char
modifier|*
name|tp
decl_stmt|;
name|long
name|txtsiz
decl_stmt|,
name|datsiz
decl_stmt|,
name|stksiz
decl_stmt|;
name|int
name|septxt
decl_stmt|;
name|int
name|lw
init|=
operator|(
name|lflg
condition|?
literal|35
else|:
literal|80
operator|)
decl_stmt|;
name|char
modifier|*
modifier|*
name|ap
decl_stmt|;
if|if
condition|(
name|mproc
operator|.
name|p_flag
operator|&
name|SLOAD
condition|)
block|{
name|addr
operator|=
name|ctob
argument_list|(
operator|(
name|long
operator|)
name|mproc
operator|.
name|p_addr
argument_list|)
expr_stmt|;
name|file
operator|=
name|swmem
expr_stmt|;
block|}
else|else
block|{
name|addr
operator|=
operator|(
name|mproc
operator|.
name|p_addr
operator|+
name|swplo
operator|)
operator|<<
literal|9
expr_stmt|;
name|file
operator|=
name|swap
expr_stmt|;
block|}
name|lseek
argument_list|(
name|file
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|file
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|u
argument_list|,
sizeof|sizeof
argument_list|(
name|u
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|u
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* set up address maps for user pcs */
name|txtsiz
operator|=
name|ctob
argument_list|(
name|u
operator|.
name|u_tsize
argument_list|)
expr_stmt|;
name|datsiz
operator|=
name|ctob
argument_list|(
name|u
operator|.
name|u_dsize
argument_list|)
expr_stmt|;
name|stksiz
operator|=
name|ctob
argument_list|(
name|u
operator|.
name|u_ssize
argument_list|)
expr_stmt|;
name|septxt
operator|=
name|u
operator|.
name|u_sep
expr_stmt|;
name|datmap
operator|.
name|b1
operator|=
operator|(
name|septxt
condition|?
literal|0
else|:
name|round
argument_list|(
name|txtsiz
argument_list|,
name|TXTRNDSIZ
argument_list|)
operator|)
expr_stmt|;
name|datmap
operator|.
name|e1
operator|=
name|datmap
operator|.
name|b1
operator|+
name|datsiz
expr_stmt|;
name|datmap
operator|.
name|f1
operator|=
name|ctob
argument_list|(
name|USIZE
argument_list|)
operator|+
name|addr
expr_stmt|;
name|datmap
operator|.
name|b2
operator|=
name|stackbas
argument_list|(
name|stksiz
argument_list|)
expr_stmt|;
name|datmap
operator|.
name|e2
operator|=
name|stacktop
argument_list|(
name|stksiz
argument_list|)
expr_stmt|;
name|datmap
operator|.
name|f2
operator|=
name|ctob
argument_list|(
name|USIZE
argument_list|)
operator|+
operator|(
name|datmap
operator|.
name|e1
operator|-
name|datmap
operator|.
name|b1
operator|)
operator|+
name|addr
expr_stmt|;
name|tp
operator|=
name|gettty
argument_list|()
expr_stmt|;
if|if
condition|(
name|tptr
operator|&&
name|strncmp
argument_list|(
name|tptr
argument_list|,
name|tp
argument_list|,
literal|2
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|lflg
condition|)
block|{
name|printf
argument_list|(
literal|"%2o %c%4d"
argument_list|,
name|mproc
operator|.
name|p_flag
argument_list|,
literal|"0SWRIZT"
index|[
name|mproc
operator|.
name|p_stat
index|]
argument_list|,
name|puid
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%6u"
argument_list|,
name|mproc
operator|.
name|p_pid
argument_list|)
expr_stmt|;
if|if
condition|(
name|lflg
condition|)
block|{
name|printf
argument_list|(
literal|"%6u%4d%4d%5d%6o%4d"
argument_list|,
name|mproc
operator|.
name|p_ppid
argument_list|,
name|mproc
operator|.
name|p_cpu
operator|&
literal|0377
argument_list|,
name|mproc
operator|.
name|p_pri
argument_list|,
name|mproc
operator|.
name|p_nice
argument_list|,
name|mproc
operator|.
name|p_addr
argument_list|,
operator|(
name|mproc
operator|.
name|p_size
operator|+
literal|7
operator|)
operator|>>
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|mproc
operator|.
name|p_wchan
condition|)
name|printf
argument_list|(
literal|"%7o"
argument_list|,
name|mproc
operator|.
name|p_wchan
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"       "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" %-2.2s"
argument_list|,
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mproc
operator|.
name|p_stat
operator|==
name|SZOMB
condition|)
block|{
name|printf
argument_list|(
literal|"<defunct>"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|tm
operator|=
operator|(
name|u
operator|.
name|u_utime
operator|+
name|u
operator|.
name|u_stime
operator|+
literal|30
operator|)
operator|/
literal|60
expr_stmt|;
name|printf
argument_list|(
literal|" %2ld:"
argument_list|,
name|tm
operator|/
literal|60
argument_list|)
expr_stmt|;
name|tm
operator|%=
literal|60
expr_stmt|;
name|printf
argument_list|(
name|tm
operator|<
literal|10
condition|?
literal|"0%ld"
else|:
literal|"%ld"
argument_list|,
name|tm
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflg
operator|&&
name|lflg
operator|==
literal|0
condition|)
block|{
comment|/* 0 == old tflg (print long times) */
name|tm
operator|=
operator|(
name|u
operator|.
name|u_cstime
operator|+
literal|30
operator|)
operator|/
literal|60
expr_stmt|;
name|printf
argument_list|(
literal|" %2ld:"
argument_list|,
name|tm
operator|/
literal|60
argument_list|)
expr_stmt|;
name|tm
operator|%=
literal|60
expr_stmt|;
name|printf
argument_list|(
name|tm
operator|<
literal|10
condition|?
literal|"0%ld"
else|:
literal|"%ld"
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|tm
operator|=
operator|(
name|u
operator|.
name|u_cutime
operator|+
literal|30
operator|)
operator|/
literal|60
expr_stmt|;
name|printf
argument_list|(
literal|" %2ld:"
argument_list|,
name|tm
operator|/
literal|60
argument_list|)
expr_stmt|;
name|tm
operator|%=
literal|60
expr_stmt|;
name|printf
argument_list|(
name|tm
operator|<
literal|10
condition|?
literal|"0%ld"
else|:
literal|"%ld"
argument_list|,
name|tm
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mproc
operator|.
name|p_pid
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" swapper"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|addr
operator|+=
name|ctob
argument_list|(
operator|(
name|long
operator|)
name|mproc
operator|.
name|p_size
argument_list|)
operator|-
literal|512
expr_stmt|;
comment|/* look for sh special */
name|lseek
argument_list|(
name|file
argument_list|,
name|addr
operator|+
literal|512
operator|-
sizeof|sizeof
argument_list|(
name|char
operator|*
operator|*
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|file
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ap
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|ap
condition|)
block|{
name|char
name|b
index|[
literal|82
index|]
decl_stmt|;
name|char
modifier|*
name|bp
init|=
name|b
decl_stmt|;
while|while
condition|(
operator|(
name|cp
operator|=
name|getptr
argument_list|(
name|ap
operator|++
argument_list|)
operator|)
operator|&&
name|cp
operator|&&
operator|(
name|bp
operator|<
name|b
operator|+
name|lw
operator|)
condition|)
block|{
name|nbad
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getbyte
argument_list|(
name|cp
operator|++
argument_list|)
operator|)
operator|&&
operator|(
name|bp
operator|<
name|b
operator|+
name|lw
operator|)
condition|)
block|{
if|if
condition|(
name|c
operator|<
literal|' '
operator|||
name|c
operator|>
literal|'~'
condition|)
block|{
if|if
condition|(
name|nbad
operator|++
operator|>
literal|3
condition|)
break|break;
continue|continue;
block|}
operator|*
name|bp
operator|++
operator|=
name|c
expr_stmt|;
block|}
operator|*
name|bp
operator|++
operator|=
literal|' '
expr_stmt|;
block|}
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
name|lflg
condition|?
literal|" %.30s"
else|:
literal|" %.60s"
argument_list|,
name|b
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|lseek
argument_list|(
name|file
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|file
argument_list|,
name|abuf
argument_list|,
sizeof|sizeof
argument_list|(
name|abuf
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|abuf
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
for|for
control|(
name|ip
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|abuf
index|[
literal|512
index|]
operator|-
literal|2
init|;
name|ip
operator|>
operator|(
name|int
operator|*
operator|)
name|abuf
condition|;
control|)
block|{
if|if
condition|(
operator|*
operator|--
name|ip
operator|==
operator|-
literal|1
operator|||
operator|*
name|ip
operator|==
literal|0
condition|)
block|{
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|ip
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|0
condition|)
name|cp
operator|++
expr_stmt|;
name|nbad
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cp1
operator|=
name|cp
init|;
name|cp1
operator|<
operator|&
name|abuf
index|[
literal|512
index|]
condition|;
name|cp1
operator|++
control|)
block|{
name|c
operator|=
operator|*
name|cp1
operator|&
literal|0177
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
condition|)
operator|*
name|cp1
operator|=
literal|' '
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|<
literal|' '
operator|||
name|c
operator|>
literal|0176
condition|)
block|{
if|if
condition|(
operator|++
name|nbad
operator|>=
literal|5
condition|)
block|{
operator|*
name|cp1
operator|++
operator|=
literal|' '
expr_stmt|;
break|break;
block|}
operator|*
name|cp1
operator|=
literal|'?'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'='
condition|)
block|{
operator|*
name|cp1
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|cp1
operator|>
name|cp
operator|&&
operator|*
operator|--
name|cp1
operator|!=
literal|' '
condition|)
operator|*
name|cp1
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
while|while
condition|(
operator|*
operator|--
name|cp1
operator|==
literal|' '
condition|)
operator|*
name|cp1
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
name|lflg
condition|?
literal|" %.30s"
else|:
literal|" %.60s"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_function
name|char
modifier|*
name|gettty
parameter_list|()
block|{
specifier|register
name|i
expr_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|u
operator|.
name|u_ttyp
operator|==
literal|0
condition|)
return|return
operator|(
literal|"?"
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndev
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|devl
index|[
name|i
index|]
operator|.
name|dev
operator|==
name|u
operator|.
name|u_ttyd
condition|)
block|{
name|p
operator|=
name|devl
index|[
name|i
index|]
operator|.
name|dname
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|'t'
operator|&&
name|p
index|[
literal|1
index|]
operator|==
literal|'t'
operator|&&
name|p
index|[
literal|2
index|]
operator|==
literal|'y'
condition|)
name|p
operator|+=
literal|3
expr_stmt|;
return|return
operator|(
name|p
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|"?"
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|getptr
parameter_list|(
name|adr
parameter_list|)
name|char
modifier|*
modifier|*
name|adr
decl_stmt|;
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|pa
decl_stmt|;
specifier|register
name|i
expr_stmt|;
name|ptr
operator|=
literal|0
expr_stmt|;
name|pa
operator|=
operator|(
name|char
operator|*
operator|)
name|adr
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|ptr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|ptr
argument_list|)
condition|;
name|i
operator|++
control|)
operator|*
name|p
operator|++
operator|=
name|getbyte
argument_list|(
name|pa
operator|++
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_macro
name|getbyte
argument_list|(
argument|adr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|adr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|map
modifier|*
name|amap
init|=
operator|&
name|datmap
decl_stmt|;
name|char
name|b
decl_stmt|;
name|long
name|saddr
decl_stmt|;
if|if
condition|(
operator|!
name|within
argument_list|(
name|adr
argument_list|,
name|amap
operator|->
name|b1
argument_list|,
name|amap
operator|->
name|e1
argument_list|)
condition|)
block|{
if|if
condition|(
name|within
argument_list|(
name|adr
argument_list|,
name|amap
operator|->
name|b2
argument_list|,
name|amap
operator|->
name|e2
argument_list|)
condition|)
block|{
name|saddr
operator|=
operator|(
name|unsigned
operator|)
name|adr
operator|+
name|amap
operator|->
name|f2
operator|-
name|amap
operator|->
name|b2
expr_stmt|;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
name|saddr
operator|=
operator|(
name|unsigned
operator|)
name|adr
operator|+
name|amap
operator|->
name|f1
operator|-
name|amap
operator|->
name|b1
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|file
argument_list|,
name|saddr
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|read
argument_list|(
name|file
argument_list|,
operator|&
name|b
argument_list|,
literal|1
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|(
name|unsigned
operator|)
name|b
operator|)
return|;
block|}
end_block

begin_macro
name|within
argument_list|(
argument|adr
argument_list|,
argument|lbd
argument_list|,
argument|ubd
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|adr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|lbd
decl_stmt|,
name|ubd
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
operator|(
name|unsigned
operator|)
name|adr
operator|>=
name|lbd
operator|&&
operator|(
name|unsigned
operator|)
name|adr
operator|<
name|ubd
operator|)
return|;
block|}
end_block

end_unit


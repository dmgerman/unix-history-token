begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"head.h"
end_include

begin_include
include|#
directive|include
file|<a.out.h>
end_include

begin_include
include|#
directive|include
file|"cdefs.h"
end_include

begin_decl_stmt
name|struct
name|user
name|u
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BKPTR
name|bkpthead
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* initialize frame pointers to top of call stack */
end_comment

begin_function
name|struct
name|proct
modifier|*
name|initframe
parameter_list|()
block|{
name|argp
operator|=
operator|*
operator|(
name|ADDR
operator|*
operator|)
operator|(
operator|(
operator|(
name|ADDR
operator|)
operator|&
name|u
operator|)
operator|+
name|AP
operator|)
expr_stmt|;
name|frame
operator|=
operator|*
operator|(
name|ADDR
operator|*
operator|)
operator|(
operator|(
operator|(
name|ADDR
operator|)
operator|&
name|u
operator|)
operator|+
name|FP
operator|)
expr_stmt|;
name|callpc
operator|=
operator|*
operator|(
name|ADDR
operator|*
operator|)
operator|(
operator|(
operator|(
name|ADDR
operator|)
operator|&
name|u
operator|)
operator|+
name|PC
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|frame
operator|==
literal|0
operator|)
operator|||
operator|(
name|frame
operator|&
literal|0xf0000000
operator|!=
literal|0x70000000
operator|)
condition|)
return|return
operator|(
name|badproc
operator|)
return|;
return|return
operator|(
name|adrtoproc
argument_list|(
name|callpc
operator|++
argument_list|)
operator|)
return|;
comment|/* ++ because UNIX backs up instrs */
block|}
end_function

begin_function
name|struct
name|proct
modifier|*
name|nextframe
parameter_list|()
block|{
name|callpc
operator|=
name|get
argument_list|(
name|frame
operator|+
literal|16
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
name|argp
operator|=
name|get
argument_list|(
name|frame
operator|+
literal|8
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
name|frame
operator|=
name|get
argument_list|(
name|frame
operator|+
literal|12
argument_list|,
name|DSP
argument_list|)
operator|&
name|EVEN
expr_stmt|;
if|if
condition|(
operator|(
name|frame
operator|==
literal|0
operator|)
operator|||
operator|(
name|frame
operator|&
literal|0xf0000000
operator|!=
literal|0x70000000
operator|)
condition|)
return|return
operator|(
name|badproc
operator|)
return|;
return|return
operator|(
name|adrtoproc
argument_list|(
name|callpc
operator|-
literal|1
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* print call frame */
end_comment

begin_macro
name|prframe
argument_list|()
end_macro

begin_block
block|{
name|int
name|narg
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|struct
name|proct
modifier|*
name|procp
decl_stmt|;
if|if
condition|(
operator|(
name|procp
operator|=
name|initframe
argument_list|()
operator|)
operator|==
name|badproc
condition|)
return|return;
do|do
block|{
if|if
condition|(
name|get
argument_list|(
name|frame
operator|+
literal|12
argument_list|,
name|DSP
argument_list|)
operator|==
literal|0
condition|)
return|return;
name|p
operator|=
name|procp
operator|->
name|pname
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|'_'
condition|)
name|printf
argument_list|(
literal|"%.7s("
argument_list|,
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%.8s("
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|narg
operator|=
name|get
argument_list|(
name|argp
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
if|if
condition|(
name|narg
operator|&
operator|~
literal|0xff
condition|)
name|narg
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|narg
condition|)
block|{
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|get
argument_list|(
name|argp
operator|+=
literal|4
argument_list|,
name|DSP
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|narg
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|","
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
if|if
condition|(
name|procp
operator|->
name|sfptr
operator|!=
name|badfile
condition|)
name|printf
argument_list|(
literal|"   [%s:%d]"
argument_list|,
name|adrtofilep
argument_list|(
name|callpc
operator|-
literal|1
argument_list|)
operator|->
name|sfilename
argument_list|,
name|adrtolineno
argument_list|(
name|callpc
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|procp
operator|=
name|nextframe
argument_list|()
operator|)
operator|!=
name|badproc
condition|)
do|;
block|}
end_block

begin_decl_stmt
name|STRING
name|signals
index|[]
init|=
block|{
literal|""
block|,
literal|"hangup"
block|,
literal|"interrupt"
block|,
literal|"quit"
block|,
literal|"illegal instruction"
block|,
literal|"trace/BPT"
block|,
literal|"IOT"
block|,
literal|"EMT"
block|,
literal|"floating exception"
block|,
literal|"killed"
block|,
literal|"bus error"
block|,
literal|"memory fault"
block|,
literal|"bad system call"
block|,
literal|"broken pipe"
block|,
literal|"alarm call"
block|,
literal|"terminated"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|signo
decl_stmt|;
end_decl_stmt

begin_macro
name|sigprint
argument_list|()
end_macro

begin_block
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|signals
index|[
name|signo
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* returns core image address for variable */
end_comment

begin_expr_stmt
name|formaddr
argument_list|(
name|proc
argument_list|,
name|class
argument_list|,
name|addr
argument_list|)
specifier|register
name|char
operator|*
name|proc
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|char
name|class
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ADDR
name|addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"formaddr(%s, %o, %d)\n"
argument_list|,
name|proc
argument_list|,
name|class
operator|&
literal|0377
argument_list|,
name|addr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|class
operator|&
name|STABMASK
condition|)
block|{
case|case
name|N_RSYM
case|:
if|if
condition|(
name|getframe
argument_list|(
name|proc
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
case|case
name|N_GSYM
case|:
case|case
name|N_SSYM
case|:
case|case
name|N_STSYM
case|:
return|return
operator|(
name|addr
operator|)
return|;
case|case
name|N_PSYM
case|:
if|if
condition|(
name|getframe
argument_list|(
name|proc
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|argp
operator|+
name|addr
operator|)
return|;
case|case
name|N_LSYM
case|:
if|if
condition|(
name|getframe
argument_list|(
name|proc
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|frame
operator|+
name|addr
operator|)
return|;
default|default:
name|printf
argument_list|(
literal|"Bad class in formaddr: 0%o: (%d, %d)\n"
argument_list|,
name|class
operator|&
literal|0377
argument_list|,
name|proc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_block

begin_comment
comment|/* sets frame pointers to procedure proc */
end_comment

begin_expr_stmt
name|getframe
argument_list|(
name|proc
argument_list|)
specifier|register
name|char
operator|*
name|proc
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|proct
modifier|*
name|procp
decl_stmt|,
modifier|*
name|fprocp
decl_stmt|;
name|procp
operator|=
name|findproc
argument_list|(
name|proc
argument_list|)
expr_stmt|;
if|if
condition|(
name|procp
operator|==
name|badproc
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Bad procedure name\n"
argument_list|,
name|proc
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
name|fprocp
operator|=
name|initframe
argument_list|()
init|;
name|fprocp
operator|!=
name|badproc
condition|;
name|fprocp
operator|=
name|nextframe
argument_list|()
control|)
block|{
if|if
condition|(
name|procp
operator|==
name|fprocp
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"%s: Not an active procedure\n"
argument_list|,
name|proc
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_decl_stmt
name|char
name|class
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* returns address of proc:var. Sets externals class and subflag */
end_comment

begin_function
name|ADDR
name|varaddr
parameter_list|(
name|proc
parameter_list|,
name|var
parameter_list|)
name|char
modifier|*
name|proc
decl_stmt|,
decl|*
name|var
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|struct
name|proct
modifier|*
name|procp
decl_stmt|;
specifier|register
name|ADDR
name|addr
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|localflag
decl_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"varaddr(%s,%s)\n"
argument_list|,
name|proc
argument_list|,
name|var
argument_list|)
expr_stmt|;
name|localflag
operator|=
literal|0
expr_stmt|;
name|subflag
operator|=
literal|0
expr_stmt|;
name|procp
operator|=
name|initframe
argument_list|()
expr_stmt|;
do|do
block|{
if|if
condition|(
name|eqstr
argument_list|(
name|proc
argument_list|,
name|procp
operator|->
name|pname
argument_list|)
condition|)
goto|goto
name|found
goto|;
block|}
do|while
condition|(
operator|(
name|procp
operator|=
name|nextframe
argument_list|()
operator|)
operator|!=
name|badproc
condition|)
do|;
name|localflag
operator|=
literal|1
expr_stmt|;
name|found
label|:
if|if
condition|(
name|eqany
argument_list|(
name|var
index|[
literal|0
index|]
argument_list|,
literal|".->"
argument_list|)
condition|)
block|{
name|class
operator|=
name|N_GSYM
expr_stmt|;
name|addr
operator|=
name|integ
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|localflag
operator|||
name|slookup
argument_list|(
name|var
argument_list|,
name|adrtostoffset
argument_list|(
name|callpc
operator|-
literal|1
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|globallookup
argument_list|(
name|var
argument_list|,
name|findfile
argument_list|(
name|curfile
argument_list|)
operator|->
name|stf_offset
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|localflag
condition|)
name|printf
argument_list|(
literal|"%.8s not found\n"
argument_list|,
name|var
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%.8s:%s not found\n"
argument_list|,
name|proc
argument_list|,
name|var
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|class
operator|=
name|sl_class
operator|&
name|STABMASK
expr_stmt|;
name|addr
operator|=
operator|(
name|class
operator|==
name|N_LSYM
operator|)
condition|?
operator|-
name|sl_addr
else|:
name|sl_addr
expr_stmt|;
name|addr
operator|=
name|formaddr
argument_list|(
name|proc
argument_list|,
name|class
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|addr
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|p
operator|=
name|var
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|'.'
operator|&&
operator|*
operator|(
name|p
operator|+
literal|1
operator|)
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|class
operator|==
name|N_RSYM
condition|)
block|{
name|error
argument_list|(
literal|"Not with a register variable"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|localflag
operator|||
name|slookup
argument_list|(
name|p
argument_list|,
name|adrtostoffset
argument_list|(
name|callpc
operator|-
literal|1
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|globallookup
argument_list|(
name|p
argument_list|,
name|findfile
argument_list|(
name|curfile
argument_list|)
operator|->
name|stf_offset
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|localflag
condition|)
name|printf
argument_list|(
literal|"%s not found\n"
argument_list|,
name|var
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%.8s:%s not found\n"
argument_list|,
name|proc
argument_list|,
name|var
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
if|if
condition|(
operator|(
name|sl_class
operator|&
name|STABMASK
operator|)
operator|!=
name|N_SSYM
condition|)
block|{
name|error
argument_list|(
literal|"Not a structure element"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|addr
operator|+=
name|sl_addr
expr_stmt|;
name|subflag
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|eqany
argument_list|(
operator|*
name|p
argument_list|,
literal|"->"
argument_list|)
operator|!=
literal|'\0'
condition|)
block|{
name|addr
operator|=
name|getindir
argument_list|(
name|class
argument_list|,
name|addr
argument_list|,
name|sl_type
argument_list|)
expr_stmt|;
name|class
operator|=
name|N_GSYM
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"Address %d after getval\n"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|eqany
argument_list|(
operator|*
name|p
argument_list|,
literal|"->"
argument_list|)
condition|;
name|p
operator|++
control|)
empty_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
break|break;
if|if
condition|(
name|localflag
operator|||
name|slookup
argument_list|(
name|p
argument_list|,
name|adrtostoffset
argument_list|(
name|callpc
operator|-
literal|1
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|globallookup
argument_list|(
name|p
argument_list|,
name|findfile
argument_list|(
name|curfile
argument_list|)
operator|->
name|stf_offset
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|localflag
condition|)
name|printf
argument_list|(
literal|"%s not found\n"
argument_list|,
name|var
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%.8s:%s not found\n"
argument_list|,
name|proc
argument_list|,
name|var
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|addr
operator|+=
name|sl_addr
expr_stmt|;
name|subflag
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|==
literal|'['
operator|&&
operator|*
operator|(
name|p
operator|+
literal|1
operator|)
operator|!=
literal|'\0'
condition|)
block|{
name|long
name|i
decl_stmt|;
name|p
operator|++
expr_stmt|;
name|i
operator|=
name|readint
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"Size %d\n"
argument_list|,
name|typetosize
argument_list|(
name|sl_type
argument_list|,
name|sl_size
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|=
name|getindir
argument_list|(
name|class
argument_list|,
name|addr
argument_list|,
name|sl_type
argument_list|)
expr_stmt|;
name|addr
operator|+=
name|typetosize
argument_list|(
name|sl_type
argument_list|,
name|sl_size
argument_list|)
operator|*
name|i
expr_stmt|;
name|class
operator|=
name|N_GSYM
expr_stmt|;
name|subflag
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
name|addr
operator|)
return|;
block|}
end_block

begin_comment
comment|/* displays value of proc:var, returns its address */
end_comment

begin_function
name|ADDR
name|dispvar
parameter_list|(
name|proc
parameter_list|,
name|var
parameter_list|,
name|fmt
parameter_list|)
name|char
modifier|*
name|proc
decl_stmt|,
decl|*
name|var
decl_stmt|,
modifier|*
name|fmt
decl_stmt|;
end_function

begin_block
block|{
name|ADDR
name|addr
decl_stmt|;
name|addr
operator|=
name|varaddr
argument_list|(
name|proc
argument_list|,
name|var
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|prvar
argument_list|(
name|sl_type
argument_list|,
name|addr
argument_list|,
name|fmt
argument_list|,
name|class
argument_list|,
name|subflag
argument_list|)
expr_stmt|;
return|return
operator|(
name|addr
operator|)
return|;
block|}
end_block

begin_macro
name|prvar
argument_list|(
argument|type
argument_list|,
argument|addr
argument_list|,
argument|fmt
argument_list|,
argument|class
argument_list|,
argument|subflag
argument_list|)
end_macro

begin_decl_stmt
name|ADDR
name|addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fmt
decl_stmt|,
name|class
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|type
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dispf
argument_list|(
name|addr
argument_list|,
name|fmt
argument_list|,
name|class
argument_list|,
name|type
argument_list|,
name|subflag
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|prdebug
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|proct
modifier|*
name|procp
decl_stmt|;
specifier|register
name|struct
name|filet
modifier|*
name|filep
decl_stmt|;
name|printf
argument_list|(
literal|"dot=%d\n"
argument_list|,
name|dot
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"extstart = %d\n"
argument_list|,
name|extstart
argument_list|)
expr_stmt|;
for|for
control|(
name|filep
operator|=
name|files
init|;
name|filep
operator|->
name|sfilename
index|[
literal|0
index|]
condition|;
name|filep
operator|++
control|)
name|printf
argument_list|(
literal|"%s offs %d @ %d flag %d addr %d\n"
argument_list|,
name|filep
operator|->
name|sfilename
argument_list|,
name|filep
operator|->
name|stf_offset
argument_list|,
name|filep
argument_list|,
name|filep
operator|->
name|lineflag
argument_list|,
name|filep
operator|->
name|faddr
argument_list|)
expr_stmt|;
for|for
control|(
name|procp
operator|=
name|procs
init|;
name|procp
operator|->
name|pname
index|[
literal|0
index|]
condition|;
name|procp
operator|++
control|)
name|printf
argument_list|(
literal|"%8.8s addr %d; offs %d; sfptr %d; line %d\n"
argument_list|,
name|procp
operator|->
name|pname
argument_list|,
name|procp
operator|->
name|paddr
argument_list|,
name|procp
operator|->
name|st_offset
argument_list|,
name|procp
operator|->
name|sfptr
argument_list|,
name|procp
operator|->
name|lineno
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* display addr using format desc or class s */
end_comment

begin_decl_stmt
name|char
name|pd
index|[]
init|=
literal|"%x\n"
decl_stmt|;
end_decl_stmt

begin_macro
name|dispf
argument_list|(
argument|addr
argument_list|,
argument|desc
argument_list|,
argument|class
argument_list|,
argument|type
argument_list|,
argument|subflag
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|desc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|type
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ADDR
name|addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|char
name|dlen
decl_stmt|,
name|dfmt
decl_stmt|;
name|long
name|value
decl_stmt|;
union|union
block|{
struct|struct
block|{
name|char
name|c
index|[
name|WORDSIZE
index|]
decl_stmt|;
block|}
struct|;
struct|struct
block|{
name|int
name|w
decl_stmt|;
block|}
struct|;
struct|struct
block|{
name|float
name|f
decl_stmt|;
block|}
block|}
name|word
union|;
union|union
block|{
struct|struct
block|{
name|int
name|w1
decl_stmt|,
name|w2
decl_stmt|;
block|}
struct|;
struct|struct
block|{
name|double
name|d
decl_stmt|;
block|}
struct|;
block|}
name|dbl
union|;
name|class
operator|&=
name|STABMASK
expr_stmt|;
if|if
condition|(
name|desc
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|desc
operator|=
name|typetodesc
argument_list|(
name|type
argument_list|,
name|subflag
argument_list|)
expr_stmt|;
name|odesc
operator|=
name|desc
expr_stmt|;
name|otype
operator|=
name|type
expr_stmt|;
name|oclass
operator|=
name|class
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"dispf(%d,%s,0%o,0%o)\n"
argument_list|,
name|addr
argument_list|,
name|desc
argument_list|,
name|class
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|pd
index|[
literal|1
index|]
operator|=
name|dfmt
operator|=
literal|'d'
expr_stmt|;
name|dlen
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|p
operator|=
name|desc
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
switch|switch
condition|(
operator|*
name|p
condition|)
block|{
case|case
literal|'l'
case|:
case|case
literal|'h'
case|:
case|case
literal|'b'
case|:
name|dlen
operator|=
operator|*
name|p
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
case|case
literal|'d'
case|:
case|case
literal|'o'
case|:
case|case
literal|'x'
case|:
case|case
literal|'u'
case|:
case|case
literal|'s'
case|:
case|case
literal|'a'
case|:
case|case
literal|'f'
case|:
case|case
literal|'g'
case|:
name|pd
index|[
literal|1
index|]
operator|=
name|dfmt
operator|=
operator|*
name|p
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Illegal descriptor: %c\n"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
switch|switch
condition|(
name|dfmt
condition|)
block|{
default|default:
if|if
condition|(
name|class
operator|==
name|N_RSYM
condition|)
block|{
if|if
condition|(
operator|(
name|addr
operator|>
literal|0
operator|&&
name|addr
operator|<
literal|6
operator|)
operator|||
name|addr
operator|>
literal|11
condition|)
block|{
name|printf
argument_list|(
literal|"Bad register var %d\n"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
return|return;
block|}
name|value
operator|=
operator|*
operator|(
name|ADDR
operator|*
operator|)
operator|(
operator|(
operator|(
name|ADDR
operator|)
operator|&
name|u
operator|)
operator|+
name|R0
operator|+
operator|(
name|WORDSIZE
operator|)
operator|*
name|addr
operator|)
expr_stmt|;
block|}
else|else
block|{
name|value
operator|=
name|getval
argument_list|(
name|addr
argument_list|,
name|dfmt
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|dfmt
condition|)
block|{
case|case
literal|'u'
case|:
case|case
literal|'x'
case|:
case|case
literal|'o'
case|:
switch|switch
condition|(
name|dlen
condition|)
block|{
case|case
literal|'h'
case|:
name|value
operator|=
operator|(
name|unsigned
name|short
operator|)
name|value
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|value
operator|=
operator|(
name|unsigned
name|char
operator|)
name|value
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|value
operator|=
operator|(
name|unsigned
name|long
operator|)
name|value
expr_stmt|;
break|break;
block|}
break|break;
default|default:
switch|switch
condition|(
name|dlen
condition|)
block|{
case|case
literal|'h'
case|:
name|value
operator|=
operator|(
name|short
operator|)
name|value
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|value
operator|=
operator|(
name|char
operator|)
name|value
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|value
operator|=
operator|(
name|long
operator|)
name|value
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|value
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|value
operator|>
literal|9
operator|&&
name|dfmt
operator|==
literal|'x'
condition|)
name|printf
argument_list|(
literal|"0x"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|value
operator|>
literal|7
operator|&&
name|dfmt
operator|==
literal|'o'
condition|)
name|printf
argument_list|(
literal|"0"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dfmt
operator|==
literal|'c'
condition|)
block|{
if|if
condition|(
operator|(
name|value
operator|&
literal|0177
operator|)
operator|<
literal|' '
condition|)
name|printf
argument_list|(
literal|"^%c\n"
argument_list|,
name|value
operator|+
operator|(
literal|'A'
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|value
operator|&
literal|0177
operator|)
operator|==
literal|0177
condition|)
name|printf
argument_list|(
literal|"^?\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
name|pd
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
name|pd
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'f'
case|:
name|pd
index|[
literal|1
index|]
operator|=
literal|'g'
expr_stmt|;
name|word
operator|.
name|w
operator|=
name|getval
argument_list|(
name|addr
argument_list|,
name|dfmt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|pd
argument_list|,
name|word
operator|.
name|f
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'g'
case|:
name|pd
index|[
literal|1
index|]
operator|=
literal|'g'
expr_stmt|;
name|dbl
operator|.
name|w1
operator|=
name|getval
argument_list|(
name|addr
argument_list|,
name|dfmt
argument_list|)
expr_stmt|;
name|dbl
operator|.
name|w2
operator|=
name|getval
argument_list|(
name|addr
operator|+
name|WORDSIZE
argument_list|,
name|dfmt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|pd
argument_list|,
name|dbl
operator|.
name|d
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'s'
case|:
name|addr
operator|=
name|getindir
argument_list|(
name|class
argument_list|,
name|addr
argument_list|,
name|type
argument_list|)
expr_stmt|;
case|case
literal|'a'
case|:
for|for
control|(
init|;
condition|;
control|)
block|{
name|word
operator|.
name|w
operator|=
name|getval
argument_list|(
name|addr
argument_list|,
literal|'d'
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|WORDSIZE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|word
operator|.
name|c
index|[
name|i
index|]
operator|==
literal|0
condition|)
goto|goto
name|l1
goto|;
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|word
operator|.
name|c
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|addr
operator|+=
name|WORDSIZE
expr_stmt|;
block|}
name|l1
label|:
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_block

begin_comment
comment|/* print breakpoints */
end_comment

begin_macro
name|prbkpt
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|BKPTR
name|bkptr
decl_stmt|;
specifier|register
name|int
name|cnt
decl_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|bkptr
operator|=
name|bkpthead
init|;
name|bkptr
condition|;
name|bkptr
operator|=
name|bkptr
operator|->
name|nxtbkpt
control|)
if|if
condition|(
name|bkptr
operator|->
name|flag
condition|)
block|{
name|cnt
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"%.8s:%d\n"
argument_list|,
name|adrtoprocp
argument_list|(
name|bkptr
operator|->
name|loc
argument_list|)
operator|->
name|pname
argument_list|,
name|adrtolineno
argument_list|(
name|bkptr
operator|->
name|loc
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"No breakpoints set\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|idbkpt
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|BKPTR
name|bkptr
decl_stmt|;
specifier|register
name|int
name|yesflg
decl_stmt|,
name|cnt
decl_stmt|;
specifier|register
name|char
name|c
decl_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|bkptr
operator|=
name|bkpthead
init|;
name|bkptr
condition|;
name|bkptr
operator|=
name|bkptr
operator|->
name|nxtbkpt
control|)
if|if
condition|(
name|bkptr
operator|->
name|flag
condition|)
block|{
name|printf
argument_list|(
literal|"%.8s:%d ? "
argument_list|,
name|adrtoprocp
argument_list|(
name|bkptr
operator|->
name|loc
argument_list|)
operator|->
name|pname
argument_list|,
name|adrtolineno
argument_list|(
name|bkptr
operator|->
name|loc
argument_list|)
argument_list|)
expr_stmt|;
name|yesflg
operator|=
literal|0
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
do|do
block|{
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'y'
operator|||
name|c
operator|==
literal|'d'
condition|)
name|yesflg
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|c
operator|!=
literal|'\n'
condition|)
do|;
if|if
condition|(
name|yesflg
condition|)
name|bkptr
operator|->
name|flag
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"No breakpoints set\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|typetodesc
parameter_list|(
name|type
parameter_list|,
name|subflag
parameter_list|)
name|short
name|type
decl_stmt|;
block|{
specifier|register
name|int
name|ptr
decl_stmt|,
name|ftn
decl_stmt|,
name|ary
decl_stmt|;
specifier|register
name|char
modifier|*
name|desc
decl_stmt|;
specifier|static
name|char
modifier|*
name|typedesc
index|[]
init|=
block|{
literal|"d"
block|,
comment|/* undef */
literal|"d"
block|,
comment|/* farg */
literal|"c"
block|,
comment|/* char */
literal|"hd"
block|,
comment|/* short */
literal|"d"
block|,
comment|/* int */
literal|"ld"
block|,
comment|/* long */
literal|"f"
block|,
comment|/* float */
literal|"g"
block|,
comment|/* double */
literal|"d"
block|,
comment|/* strty */
literal|"d"
block|,
comment|/* unionty */
literal|"d"
block|,
comment|/* enumty */
literal|"d"
block|,
comment|/* moety */
literal|"bu"
block|,
comment|/* uchar */
literal|"hu"
block|,
comment|/* ushort */
literal|"u"
block|,
comment|/* unsigned */
literal|"lu"
block|,
comment|/* ulong */
literal|"d"
comment|/* ? */
block|}
decl_stmt|;
name|ptr
operator|=
name|ftn
operator|=
name|ary
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
name|type
operator|=
name|DECREF
argument_list|(
name|type
argument_list|)
control|)
block|{
if|if
condition|(
name|ISPTR
argument_list|(
name|type
argument_list|)
condition|)
name|ptr
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|ISFTN
argument_list|(
name|type
argument_list|)
condition|)
name|ftn
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|ISARY
argument_list|(
name|type
argument_list|)
condition|)
name|ary
operator|++
expr_stmt|;
else|else
block|{
name|desc
operator|=
name|typedesc
index|[
name|type
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|ptr
operator|-
name|subflag
operator|==
literal|1
operator|||
name|ary
operator|-
name|subflag
operator|==
literal|1
operator|)
operator|&&
name|desc
index|[
literal|0
index|]
operator|==
literal|'c'
condition|)
return|return
operator|(
literal|"s"
operator|)
return|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"PTR %d; FTN %d; ARY %d; DESC %s\n"
argument_list|,
name|ptr
argument_list|,
name|ftn
argument_list|,
name|ary
argument_list|,
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
condition|)
return|return
operator|(
literal|"x"
operator|)
return|;
return|return
operator|(
name|desc
operator|)
return|;
block|}
end_function

begin_macro
name|typetosize
argument_list|(
argument|type
argument_list|,
argument|stsize
argument_list|)
end_macro

begin_decl_stmt
name|short
name|type
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|ptr
decl_stmt|,
name|ftn
decl_stmt|,
name|ary
decl_stmt|;
specifier|register
name|int
name|size
decl_stmt|;
specifier|static
name|char
name|typesize
index|[]
init|=
block|{
literal|4
block|,
comment|/* undef */
literal|4
block|,
comment|/* farg */
literal|1
block|,
comment|/* char */
literal|2
block|,
comment|/* short */
name|WORDSIZE
block|,
comment|/* int */
literal|4
block|,
comment|/* long */
literal|4
block|,
comment|/* float */
literal|8
block|,
comment|/* double */
literal|0
block|,
comment|/* strty */
literal|0
block|,
comment|/* unionty */
literal|4
block|,
comment|/* enumty */
literal|4
block|,
comment|/* moety */
literal|1
block|,
comment|/* uchar */
literal|2
block|,
comment|/* ushort */
literal|4
block|,
comment|/* unsigned */
literal|4
block|,
comment|/* ulong */
literal|4
comment|/* ? */
block|}
decl_stmt|;
name|ptr
operator|=
name|ftn
operator|=
name|ary
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
name|type
operator|=
name|DECREF
argument_list|(
name|type
argument_list|)
control|)
block|{
if|if
condition|(
name|ISPTR
argument_list|(
name|type
argument_list|)
condition|)
name|ptr
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|ISFTN
argument_list|(
name|type
argument_list|)
condition|)
name|ftn
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|ISARY
argument_list|(
name|type
argument_list|)
condition|)
name|ary
operator|++
expr_stmt|;
else|else
block|{
name|size
operator|=
name|typesize
index|[
name|type
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"PTR %d; FTN %d; ARY %d; SIZE %d; STSIZE %d\n"
argument_list|,
name|ptr
argument_list|,
name|ftn
argument_list|,
name|ary
argument_list|,
name|size
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|>
literal|1
condition|)
return|return
operator|(
literal|4
operator|)
return|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
return|return
operator|(
name|stsize
condition|?
name|stsize
else|:
literal|1
operator|)
return|;
else|else
return|return
operator|(
name|size
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  netlpr [-m mach] [-l login] [-p password] [-f] [-n] [-q] [-c ?pr] [file1 ... filen]  	send a set of files to the lineprinter on the mach machine. 	if between CC machines, no account is needed, so no login 	or passwd is prompted. 	Other flags are simply passed thru. 	Flags: 		-m mach		remote machine 		-l login	remote login name, ignored on CC 		-p passwd	remote password,     "     "   " 		-f		force prompting of user name 		-n		don't send anything back 		-q		quiet option 		-c printer	use the "printer" command instead of "lpr" */
end_comment

begin_comment
comment|/* also, netlpr should check the remote lpr's other user execute    bit to see if it is down */
end_comment

begin_comment
comment|/* must run setuid root on CC machines only */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_comment
comment|/* global variables */
end_comment

begin_decl_stmt
name|struct
name|userinfo
name|status
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
comment|/* parms are flags to the lpr command on the rem mach */
name|int
name|rcode
decl_stmt|,
name|uid
decl_stmt|,
name|pid
decl_stmt|;
name|char
name|parms
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|fnoacct
decl_stmt|,
modifier|*
name|sn
decl_stmt|,
name|suid
index|[
literal|20
index|]
decl_stmt|,
name|sLprCommand
index|[
literal|20
index|]
decl_stmt|;
specifier|static
name|char
name|tomachstr
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|realcmd
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|tempbuf
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|sCmdAct
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|argv
index|[
name|argc
index|]
operator|=
literal|0
expr_stmt|;
name|parms
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|debugflg
operator|=
name|DBV
expr_stmt|;
name|strcpy
argument_list|(
name|sLprCommand
argument_list|,
literal|"lpr"
argument_list|)
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|0
operator|&&
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'b'
case|:
name|status
operator|.
name|nonotify
operator|++
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|harg
argument_list|(
name|sLprCommand
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|status
operator|.
name|force
operator|++
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|harg
argument_list|(
name|status
operator|.
name|login
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|harg
argument_list|(
name|tempbuf
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
name|remote
operator|=
name|lookup
argument_list|(
name|tempbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|remote
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown machine %s\n"
argument_list|,
name|tempbuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_NOHOST
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'n'
case|:
name|status
operator|.
name|nowrite
operator|++
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|harg
argument_list|(
name|status
operator|.
name|mpasswd
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|status
operator|.
name|quiet
operator|++
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|parms
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|parms
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
break|break;
block|}
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
block|}
comment|/* read the .netrc file, to get a value for "remote" */
name|commandfile
argument_list|()
expr_stmt|;
if|if
condition|(
name|remote
operator|==
literal|0
condition|)
name|remote
operator|=
name|getremote
argument_list|(
name|local
argument_list|)
expr_stmt|;
comment|/* fnoacct is true if no password is needed to netlpr */
name|fnoacct
operator|=
name|machtype
index|[
name|remote
operator|-
literal|'a'
index|]
operator|==
name|M_CC
operator|&&
name|machtype
index|[
name|local
operator|-
literal|'a'
index|]
operator|==
name|M_CC
expr_stmt|;
if|if
condition|(
name|fnoacct
condition|)
block|{
comment|/* no acct needed. */
comment|/* look in passwd file for jobno */
name|uid
operator|=
name|getuid
argument_list|()
expr_stmt|;
name|passwdent
argument_list|()
expr_stmt|;
name|sprintf
argument_list|(
name|suid
argument_list|,
literal|"%d"
argument_list|,
name|uid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* get status.localname */
name|sn
operator|=
name|SnFromUid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|sn
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown userid\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_OSFILE
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|status
operator|.
name|localname
argument_list|,
name|sn
argument_list|)
expr_stmt|;
comment|/* prompt for login and passwd */
name|envloginpasswd
argument_list|(
name|remote
argument_list|,
name|status
operator|.
name|login
argument_list|,
name|status
operator|.
name|mpasswd
argument_list|)
expr_stmt|;
name|promptlogin
argument_list|(
name|remote
argument_list|)
expr_stmt|;
block|}
comment|/* check to see that the lpr command is one of the approved set */
if|if
condition|(
name|strcmp
argument_list|(
name|sLprCommand
argument_list|,
literal|"lpr"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|sLprCommand
argument_list|,
literal|"vpr"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|sLprCommand
argument_list|,
literal|"epr"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|sLprCommand
argument_list|,
literal|"bpr"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"May not execute the '%s' command from netlpr.\n"
argument_list|,
name|sLprCommand
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
block|}
do|do
block|{
if|if
condition|(
name|fnoacct
condition|)
name|sprintf
argument_list|(
name|sCmdAct
argument_list|,
literal|"%s -c%04d,%s %s"
argument_list|,
name|sLprCommand
argument_list|,
name|status
operator|.
name|jobno
argument_list|,
name|status
operator|.
name|localname
argument_list|,
name|parms
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|sCmdAct
argument_list|,
literal|"%s %s"
argument_list|,
name|sLprCommand
argument_list|,
name|parms
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|tomachstr
argument_list|,
literal|"-m%c"
argument_list|,
name|remote
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|realcmd
argument_list|,
literal|"netlpr %s%s"
argument_list|,
name|parms
argument_list|,
operator|(
name|argc
operator|>
literal|0
condition|?
name|argv
index|[
literal|0
index|]
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
operator|-
literal|1
condition|)
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|access
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|04
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|NOREMACCT
if|if
condition|(
name|fnoacct
condition|)
block|{
name|setuid
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|mexecl
argument_list|(
name|netcmd
argument_list|,
literal|"net"
argument_list|,
name|tomachstr
argument_list|,
literal|"-y"
argument_list|,
literal|"-l"
argument_list|,
name|status
operator|.
name|localname
argument_list|,
literal|"-u"
argument_list|,
name|suid
argument_list|,
literal|"-s"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-c"
argument_list|,
name|realcmd
argument_list|,
name|sCmdAct
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|netcmd
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|kexecl
argument_list|(
name|netcmd
argument_list|,
literal|"net"
argument_list|,
name|tomachstr
argument_list|,
literal|"-s"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-c"
argument_list|,
name|realcmd
argument_list|,
name|sCmdAct
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|netcmd
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|NOREMACCT
if|if
condition|(
name|fnoacct
condition|)
block|{
name|setuid
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|mexecl
argument_list|(
name|netcmd
argument_list|,
literal|"net"
argument_list|,
name|tomachstr
argument_list|,
literal|"-y"
argument_list|,
literal|"-"
argument_list|,
literal|"-l"
argument_list|,
name|status
operator|.
name|localname
argument_list|,
literal|"-u"
argument_list|,
name|suid
argument_list|,
literal|"-c"
argument_list|,
name|realcmd
argument_list|,
name|sCmdAct
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|netcmd
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|kexecl
argument_list|(
name|netcmd
argument_list|,
literal|"net"
argument_list|,
name|tomachstr
argument_list|,
literal|"-"
argument_list|,
literal|"-c"
argument_list|,
name|realcmd
argument_list|,
name|sCmdAct
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|netcmd
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Network is down\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_UNAVAILABLE
argument_list|)
expr_stmt|;
block|}
name|wait
argument_list|(
operator|&
name|rcode
argument_list|)
expr_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|argc
operator|>
literal|0
condition|)
do|;
name|exit
argument_list|(
name|rcode
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


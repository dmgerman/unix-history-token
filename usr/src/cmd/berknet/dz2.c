begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	     DZ-11 driver  *	     ------------  *  *		Written to handle single dz - `carrier'|`ring' support non-existent  *  *					Piers Lauder  *					SYDNEY UNIVERSITY  *					July 1977  *  *		Re-written to handle multiple dz's and `carrier'|`ring'.  *  *					Ian Johnstone  *					UNSW  *					December 1977  *					January  1978  *  *		General tidy up, new comments etc. Removal of ifdefs  *		for CARRIER and RING. If you don't want them, tough.  *  *					Chris Maltby  *					Basser October 1979  */
end_comment

begin_comment
comment|/* ( no messages ) #define	MESSAGES 	/* 	 * Define this if you want parity and framing errors 	 * to be logged (via printf). It can be very wordy. 	 */
end_comment

begin_define
define|#
directive|define
name|INTR_ON_BREAK
end_define

begin_comment
comment|/* 	 * Define this to translate framing errors (breaks) 	 * to CINTR for terminals which lack a DEL key. 	 * Can be nasty if you get lots of line errors. 	 */
end_comment

begin_comment
comment|/* (not	DEBUG) #define	DEBUG 	/* 	 * Define to debug info for dialup lines. 	 * costs approximately 128 bytes  	 */
end_comment

begin_include
include|#
directive|include
file|"../defines.h"
end_include

begin_include
include|#
directive|include
file|"../param.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|AUSAML
end_ifdef

begin_include
include|#
directive|include
file|"../lnode.h"
end_include

begin_endif
endif|#
directive|endif
endif|AUSAML
end_endif

begin_include
include|#
directive|include
file|"../systm.h"
end_include

begin_endif
endif|#
directive|endif
endif|DEBUG
end_endif

begin_include
include|#
directive|include
file|"../conf.h"
end_include

begin_include
include|#
directive|include
file|"../user.h"
end_include

begin_include
include|#
directive|include
file|"../tty.h"
end_include

begin_include
include|#
directive|include
file|"../proc.h"
end_include

begin_define
define|#
directive|define
name|NDZ
value|2
end_define

begin_comment
comment|/* number of DZ-11s */
end_comment

begin_define
define|#
directive|define
name|NLINES
value|8*NDZ
end_define

begin_comment
comment|/* total number of lines */
end_comment

begin_define
define|#
directive|define
name|TSCANRATE
value|2
end_define

begin_comment
comment|/* dzscan called every 2 tics */
end_comment

begin_comment
comment|/* Must be>= 2 always	      */
end_comment

begin_define
define|#
directive|define
name|RESPONDTIME
value|(25*HZ)
end_define

begin_comment
comment|/* Carrier must be raised inside this */
end_comment

begin_define
define|#
directive|define
name|CARRIERTIME
value|(1*HZ)
end_define

begin_comment
comment|/* Carrier must drop for this before hangup */
end_comment

begin_define
define|#
directive|define
name|FLUSHTIME
value|5
end_define

begin_comment
comment|/* time required to allow hardware buffered 					 * characters to flush before setting speed */
end_comment

begin_define
define|#
directive|define
name|SSPEED
value|12
end_define

begin_comment
comment|/* standard speed 4800 bd */
end_comment

begin_struct
struct|struct
name|dz
comment|/* one for each dz-11 */
block|{
name|int
modifier|*
name|dzaddr
decl_stmt|;
comment|/* dz device address */
name|char
name|sopen
decl_stmt|;
comment|/* bit set for single open lines */
name|char
name|carrier
decl_stmt|;
comment|/* bits set for carrier controlled lines */
name|char
name|ring
decl_stmt|;
comment|/* bits set for lines with dial in modems */
name|char
name|active
decl_stmt|;
comment|/* bits set for active dialup lines */
name|char
name|openl
decl_stmt|;
comment|/* bits set for open lines */
name|unsigned
name|pyerrors
decl_stmt|;
comment|/* count of of parity errors on input */
name|unsigned
name|overrors
decl_stmt|;
comment|/* count of of overrun errors on input */
block|}
name|dz
index|[
name|NDZ
index|]
block|{
comment|/* dzaddr  sopen  carr  ring */
block|{
literal|0160040
operator|,
literal|0002
operator|,
literal|0077
operator|,
literal|0074
block|}
operator|,
block|{
literal|0160050
operator|,
literal|0000
operator|,
literal|0000
operator|,
literal|0000
block|}
block|}
struct|;
end_struct

begin_decl_stmt
name|int
name|dzscanning
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* set when scanning for input and modem change */
end_comment

begin_comment
comment|/*  *	DZ11 register layout  */
end_comment

begin_struct
struct|struct
name|dzr_read
block|{
name|int
name|dzcsr
decl_stmt|;
comment|/* r/w */
name|int
name|dzrbuf
decl_stmt|;
comment|/* no bit, byte, or tst ops */
name|char
name|dztcr
decl_stmt|;
comment|/* r/w */
name|char
name|dzdtr
decl_stmt|;
comment|/* r/w */
name|char
name|dzring
decl_stmt|;
name|char
name|dzcarr
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|dzr_write
block|{
name|int
name|dzcsr
decl_stmt|;
comment|/* r/w */
name|int
name|dzlpr
decl_stmt|;
comment|/* no bit or byte ops */
name|char
name|dztcr
decl_stmt|;
comment|/* r/w */
name|char
name|dzdtr
decl_stmt|;
comment|/* r/w */
name|char
name|dztbuf
decl_stmt|;
comment|/* no bit ops */
name|char
name|dzbrk
decl_stmt|;
comment|/* no bit ops */
block|}
struct|;
end_struct

begin_comment
comment|/*  *	register control bits  */
end_comment

begin_define
define|#
directive|define
name|TRDY
value|0100000
end_define

begin_comment
comment|/* dzcsr */
end_comment

begin_define
define|#
directive|define
name|TIE
value|040000
end_define

begin_define
define|#
directive|define
name|SA
value|020000
end_define

begin_define
define|#
directive|define
name|SAE
value|010000
end_define

begin_define
define|#
directive|define
name|TLINE
value|03400
end_define

begin_define
define|#
directive|define
name|RDONE
value|0200
end_define

begin_define
define|#
directive|define
name|RIE
value|0100
end_define

begin_define
define|#
directive|define
name|MSE
value|040
end_define

begin_define
define|#
directive|define
name|CLR
value|020
end_define

begin_define
define|#
directive|define
name|RCVR_ON
value|010000
end_define

begin_comment
comment|/* dzlpr */
end_comment

begin_define
define|#
directive|define
name|S9600
value|07000
end_define

begin_define
define|#
directive|define
name|S300
value|02400
end_define

begin_define
define|#
directive|define
name|S134_5
value|01400
end_define

begin_define
define|#
directive|define
name|S110
value|01000
end_define

begin_define
define|#
directive|define
name|ODD_PAR
value|0300
end_define

begin_define
define|#
directive|define
name|EVN_PAR
value|0100
end_define

begin_define
define|#
directive|define
name|TWOSBIT
value|040
end_define

begin_define
define|#
directive|define
name|C8BIT
value|030
end_define

begin_define
define|#
directive|define
name|C7BIT
value|020
end_define

begin_define
define|#
directive|define
name|C6BIT
value|010
end_define

begin_comment
comment|/* #define IBM2741		RCVR_ON|S134_5|ODD_PAR|C6BIT	/* if you must */
end_comment

begin_define
define|#
directive|define
name|RERROR
value|070000
end_define

begin_comment
comment|/* dzrbuf */
end_comment

begin_define
define|#
directive|define
name|OVR_RUN
value|040000
end_define

begin_define
define|#
directive|define
name|FRAME
value|020000
end_define

begin_define
define|#
directive|define
name|PARITY
value|010000
end_define

begin_define
define|#
directive|define
name|LINE_NO
value|03400
end_define

begin_comment
comment|/*  *	table to map UNIX standard speeds to DZ11 speeds  *	illegal speeds are ignored.  */
end_comment

begin_decl_stmt
name|char
name|dzspeedmap
index|[
literal|16
index|]
block|{
literal|0
comment|/*  0 - zero */
operator|,
literal|020
comment|/*  1 -   50 */
operator|,
literal|021
comment|/*  2 -   75 */
operator|,
literal|022
comment|/*  3 -  110 */
operator|,
literal|023
comment|/*  4 -  134.5 */
operator|,
literal|024
comment|/*  5 -  150 */
operator|,
literal|0200
comment|/*  6 -  200 -- ## ILLEGAL ## */
operator|,
literal|025
comment|/*  7 -  300 */
operator|,
literal|026
comment|/*  8 -  600 */
operator|,
literal|027
comment|/*  9 - 1200 */
operator|,
literal|030
comment|/* 10 - 1800 */
operator|,
literal|032
comment|/* 11 - 2400 */
operator|,
literal|034
comment|/* 12 - 4800 */
operator|,
literal|036
comment|/* 13 - 9600 */
operator|,
literal|031
comment|/* 14 - ext A - maps to 2000 */
operator|,
literal|037
comment|/* 15 - ext B - maps to 19200 */
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|struct
name|tty
name|dz11
index|[
name|NLINES
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|dzdelays
index|[
name|NLINES
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Count of clock ticks for per-line 					 * delays. Count of<= 0 means no delay. 					 * Reduces requirement of timeouts. 					 */
end_comment

begin_decl_stmt
name|int
name|dzringt
index|[
name|NLINES
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Delay counts for modem control */
end_comment

begin_comment
comment|/*  *	open a DZ11 line  */
end_comment

begin_macro
name|dzopen
argument_list|(
argument|dev
argument_list|,
argument|flag
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
specifier|register
name|struct
name|dz
modifier|*
name|dzp
decl_stmt|;
specifier|register
name|int
name|t_bit
decl_stmt|;
extern|extern	dzstart(
block|)
end_block

begin_operator
operator|,
end_operator

begin_expr_stmt
name|dzscan
argument_list|()
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|dev
operator|.
name|d_minor
operator|>=
name|NLINES
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|ENXIO
expr_stmt|;
return|return;
block|}
end_if

begin_expr_stmt
name|dzp
operator|=
operator|&
name|dz
index|[
name|dev
operator|.
name|d_minor
operator|>>
literal|3
index|]
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|t_bit
operator|=
operator|(
literal|1
operator|<<
operator|(
name|dev
operator|.
name|d_minor
operator|&
literal|07
operator|)
operator|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|(
name|dzp
operator|->
name|sopen
operator|&
name|t_bit
operator|)
operator|&&
operator|(
name|dzp
operator|->
name|openl
operator|&
name|t_bit
operator|)
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|EOPENFAIL
expr_stmt|;
return|return;
block|}
end_if

begin_expr_stmt
name|tp
operator|=
operator|&
name|dz11
index|[
name|dev
operator|.
name|d_minor
index|]
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|u
operator|.
name|u_procp
operator|->
name|p_ttyp
operator|==
literal|0
condition|)
name|u
operator|.
name|u_procp
operator|->
name|p_ttyp
operator|=
name|tp
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|(
name|tp
operator|->
name|t_state
operator|&
name|ISOPEN
operator|)
operator|==
literal|0
condition|)
block|{
name|tp
operator|->
name|t_dev
operator|=
name|dev
expr_stmt|;
name|tp
operator|->
name|t_addr
operator|=
operator|&
name|dzstart
expr_stmt|;
name|tp
operator|->
name|t_speeds
operator|=
name|SSPEED
operator||
operator|(
name|SSPEED
operator|<<
literal|8
operator|)
expr_stmt|;
name|tp
operator|->
name|t_flags
operator|=
name|ODDP
operator||
name|EVENP
operator||
name|XTABS
operator||
name|RAW
expr_stmt|;
name|tp
operator|->
name|t_erase
operator|=
name|CERASE
expr_stmt|;
name|tp
operator|->
name|t_kill
operator|=
name|CKILL
expr_stmt|;
if|if
condition|(
name|dzp
operator|->
name|openl
operator|==
literal|0
condition|)
name|dzp
operator|->
name|dzaddr
operator|->
name|dzcsr
operator|=
operator||
operator|(
name|TIE
operator||
name|RIE
operator||
name|SAE
operator||
name|MSE
operator|)
expr_stmt|;
comment|/* reciever interrupt every 16 chars */
name|dzp
operator|->
name|openl
operator|=
operator||
name|t_bit
expr_stmt|;
name|spl5
argument_list|()
expr_stmt|;
if|if
condition|(
name|dzscanning
operator|==
literal|0
condition|)
name|dzscan
argument_list|()
expr_stmt|;
comment|/* start scanning */
if|if
condition|(
operator|!
operator|(
name|dzp
operator|->
name|ring
operator|&
name|t_bit
operator|)
operator|&&
operator|!
operator|(
name|dzp
operator|->
name|carrier
operator|&
name|t_bit
operator|)
condition|)
name|dzp
operator|->
name|dzaddr
operator|->
name|dzdtr
operator|=
operator||
name|t_bit
expr_stmt|;
comment|/* turn on DTR for non-dialup lines */
else|else
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"%d wo%d\n"
argument_list|,
name|time
operator|.
name|loint
argument_list|,
name|dev
operator|.
name|d_minor
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
while|while
condition|(
operator|!
operator|(
name|dzp
operator|->
name|dzaddr
operator|->
name|dzcarr
operator|&
name|t_bit
operator|)
condition|)
block|{
name|tp
operator|->
name|t_state
operator|=
operator||
name|WOPEN
expr_stmt|;
name|sleep
argument_list|(
operator|&
name|tp
operator|->
name|t_rawq
argument_list|,
name|TTIPRI
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"%d op%d\n"
argument_list|,
name|time
operator|.
name|loint
argument_list|,
name|dev
operator|.
name|d_minor
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
block|}
name|spl0
argument_list|()
expr_stmt|;
name|tp
operator|->
name|t_state
operator|=
operator|(
name|ISOPEN
operator||
name|CARR_ON
operator||
name|SSTART
operator|)
expr_stmt|;
name|dzparam
argument_list|(
name|tp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_if

begin_comment
unit|}
comment|/*  *	scan open lines for:  *			1.  modem status changes  *			2.  process timeouts as dictated by dzdelays  *			3.  input by calling dzrint  */
end_comment

begin_expr_stmt
unit|dzscan
operator|(
operator|)
comment|/* at spl5 */
block|{
specifier|register
expr|struct
name|dz
operator|*
name|dzp
block|; 	struct
name|tty
operator|*
name|tp
block|;
name|int
operator|*
name|p
block|;
specifier|extern
name|dzstart
argument_list|()
block|,
name|dzrint
argument_list|()
block|,
name|dzscan
argument_list|()
block|;
define|#
directive|define
name|openring
value|(dzp->openl& dzp->ring)
define|#
directive|define
name|opencarrier
value|(dzp->openl& dzp->carrier)
comment|/* 	 *	scan open dialup/carrier lines. 	 */
name|tp
operator|=
operator|&
name|dz11
index|[
literal|0
index|]
block|;
name|p
operator|=
operator|&
name|dzringt
index|[
literal|0
index|]
block|;
for|for
control|(
name|dzp
operator|=
name|dz
init|;
name|dzp
operator|<
operator|&
name|dz
index|[
name|NDZ
index|]
condition|;
name|dzp
operator|++
control|)
block|{
specifier|register
name|int
modifier|*
name|dzaddr
decl_stmt|;
name|char
name|scanl
decl_stmt|,
name|scanc
decl_stmt|;
name|dzaddr
operator|=
name|dzp
operator|->
name|dzaddr
expr_stmt|;
if|if
condition|(
operator|(
name|scanl
operator|=
name|openring
operator|)
operator||
operator|(
name|scanc
operator|=
name|opencarrier
operator|)
condition|)
block|{
specifier|register
name|int
name|t_bit
decl_stmt|;
for|for
control|(
name|t_bit
operator|=
literal|1
init|;
name|t_bit
operator|&
literal|0377
condition|;
name|t_bit
operator|=
operator|<<
literal|1
operator|,
name|tp
operator|++
operator|,
name|p
operator|++
control|)
block|{
if|if
condition|(
name|scanl
operator|&
name|t_bit
condition|)
block|{
comment|/* this is an open `dialup' line */
if|if
condition|(
name|dzp
operator|->
name|active
operator|&
name|t_bit
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|dzaddr
operator|->
name|dzcarr
operator|&
name|t_bit
operator|)
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|0
condition|)
operator|*
name|p
operator|=
name|CARRIERTIME
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
operator|*
name|p
operator|=
operator|-
name|TSCANRATE
operator|)
operator|<=
literal|0
condition|)
block|{
operator|*
name|p
operator|=
literal|0
expr_stmt|;
comment|/* disable */
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"%d hu%d\n"
argument_list|,
name|time
operator|.
name|loint
argument_list|,
name|tp
operator|->
name|t_dev
operator|.
name|d_minor
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|dzaddr
operator|->
name|dzdtr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
comment|/* hang up the phone */
name|signal
argument_list|(
name|tp
argument_list|,
name|SIGHUP
argument_list|)
expr_stmt|;
name|flushtty
argument_list|(
name|tp
argument_list|)
expr_stmt|;
name|dzaddr
operator|->
name|dztcr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
comment|/* disable transmit */
name|dzp
operator|->
name|active
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
block|}
end_expr_stmt

begin_block
unit|} 			    else
block|{
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|WOPEN
condition|)
name|wakeup
argument_list|(
operator|&
name|tp
operator|->
name|t_rawq
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tp
operator|->
name|t_state
operator|&
name|TIMEOUT
operator|)
operator|&&
operator|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|)
condition|)
name|dzaddr
operator|->
name|dztcr
operator|=
operator||
name|t_bit
expr_stmt|;
block|}
end_block

begin_block
unit|} 			else
block|{
if|if
condition|(
operator|!
operator|(
name|dzaddr
operator|->
name|dzdtr
operator|&
name|t_bit
operator|)
operator|&&
operator|(
name|dzaddr
operator|->
name|dzring
operator|&
name|t_bit
operator|)
condition|)
block|{
name|dzaddr
operator|->
name|dzdtr
operator|=
operator||
name|t_bit
expr_stmt|;
comment|/* answer the phone */
operator|*
name|p
operator|=
name|RESPONDTIME
expr_stmt|;
name|dzp
operator|->
name|active
operator|=
operator||
name|t_bit
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"%d ap%d\n"
argument_list|,
name|time
operator|.
name|loint
argument_list|,
name|tp
operator|->
name|t_dev
operator|.
name|d_minor
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
block|}
block|}
end_block

begin_if
unit|} 		    else
if|if
condition|(
operator|(
name|scanc
operator|&
name|t_bit
operator|)
operator|&&
operator|(
name|dzaddr
operator|->
name|dzcarr
operator|&
name|t_bit
operator|)
condition|)
block|{
comment|/* carrier only line */
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|WOPEN
condition|)
block|{
name|dzaddr
operator|->
name|dzdtr
operator|=
operator||
name|t_bit
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|tp
operator|->
name|t_rawq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|!
operator|(
name|tp
operator|->
name|t_state
operator|&
name|TIMEOUT
operator|)
operator|)
operator|&&
operator|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|)
condition|)
name|dzaddr
operator|->
name|dztcr
operator|=
operator||
name|t_bit
expr_stmt|;
block|}
end_if

begin_else
unit|} 	    }
else|else
block|{
name|tp
operator|=
operator|+
literal|8
expr_stmt|;
name|p
operator|=
operator|+
literal|8
expr_stmt|;
comment|/* in the case where no dialup/carrier lines on current dz */
block|}
end_else

begin_comment
unit|}
comment|/* 	 *	process timeouts for each line 	 */
end_comment

begin_expr_stmt
unit|{
specifier|register
name|i
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NLINES
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|dzdelays
index|[
name|i
index|]
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|--
name|dzdelays
index|[
name|i
index|]
operator|<=
literal|0
operator|)
condition|)
block|{
name|dz11
index|[
name|i
index|]
operator|.
name|t_state
operator|=
operator|&
operator|~
name|TIMEOUT
expr_stmt|;
name|dzstart
argument_list|(
operator|&
name|dz11
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_for

begin_comment
unit|}
comment|/* 	 *	scan each dz for input 	 */
end_comment

begin_expr_stmt
unit|dzrint
operator|(
literal|0
operator|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 	 *	restart scanning if necessary 	 */
end_comment

begin_expr_stmt
name|dzp
operator|=
name|dz
expr_stmt|;
end_expr_stmt

begin_do
do|do
block|{
if|if
condition|(
name|dzp
operator|->
name|openl
condition|)
block|{
name|dzscanning
operator|=
name|timeout
argument_list|(
operator|&
name|dzscan
argument_list|,
literal|0
argument_list|,
name|TSCANRATE
argument_list|)
expr_stmt|;
return|return;
block|}
name|dzp
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|dzp
operator|<
operator|&
name|dz
index|[
name|NDZ
index|]
condition|)
do|;
end_do

begin_expr_stmt
name|dzscanning
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_comment
unit|}
comment|/*  *	close a DZ11 line  */
end_comment

begin_expr_stmt
unit|dzclose
operator|(
name|dev
operator|)
block|{
specifier|register
expr|struct
name|tty
operator|*
name|tp
block|;
specifier|register
name|t_bit
block|;
specifier|register
expr|struct
name|dz
operator|*
name|dzp
block|;
name|tp
operator|=
operator|&
name|dz11
index|[
name|dev
operator|.
name|d_minor
index|]
block|;
name|wflushtty
argument_list|(
name|tp
argument_list|)
block|;
name|tp
operator|->
name|t_state
operator|=
name|SSTART
block|;
name|dzp
operator|=
operator|&
name|dz
index|[
name|dev
operator|.
name|d_minor
operator|>>
literal|3
index|]
block|;
name|t_bit
operator|=
literal|1
operator|<<
operator|(
name|dev
operator|.
name|d_minor
operator|&
literal|07
operator|)
block|;
if|if
condition|(
name|dzp
operator|->
name|ring
operator|&
name|t_bit
condition|)
block|{
if|if
condition|(
name|tp
operator|->
name|t_flags
operator|&
name|HUPCL
condition|)
name|dzp
operator|->
name|dzaddr
operator|->
name|dzdtr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
comment|/* hang up the phone */
block|}
end_expr_stmt

begin_else
else|else
block|{
name|dzp
operator|->
name|dzaddr
operator|->
name|dzdtr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
comment|/* turn off dtr for non-dialup lines */
block|}
end_else

begin_if
if|if
condition|(
operator|(
name|dzp
operator|->
name|openl
operator|=
operator|&
operator|~
name|t_bit
operator|)
operator|==
literal|0
condition|)
name|dzp
operator|->
name|dzaddr
operator|->
name|dzcsr
operator|=
literal|0
expr_stmt|;
end_if

begin_comment
comment|/* disable receive on final close */
end_comment

begin_comment
unit|}
comment|/*  *	read from a DZ11 line  */
end_comment

begin_expr_stmt
unit|dzread
operator|(
name|dev
operator|)
block|{
name|ttread
argument_list|(
operator|&
name|dz11
index|[
name|dev
operator|.
name|d_minor
index|]
argument_list|)
block|; }
comment|/*  *	write on a DZ11 line  */
name|dzwrite
argument_list|(
argument|dev
argument_list|)
block|{
name|ttwrite
argument_list|(
operator|&
name|dz11
index|[
name|dev
operator|.
name|d_minor
index|]
argument_list|)
block|; }
comment|/*  *	stty/gtty for DZ11  */
name|dzsgtty
argument_list|(
argument|dev
argument_list|,
argument|av
argument_list|)
name|int
operator|*
name|av
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
if|if
condition|(
operator|(
name|av
operator|==
literal|0
operator|)
operator|&&
operator|(
name|dzspeedmap
index|[
name|u
operator|.
name|u_arg
index|[
literal|0
index|]
operator|&
literal|017
index|]
operator|<
literal|0
operator|)
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|ENXIO
expr_stmt|;
comment|/* illegal speed */
return|return;
block|}
name|tp
operator|=
operator|&
name|dz11
index|[
name|dev
operator|.
name|d_minor
index|]
expr_stmt|;
if|if
condition|(
name|ttystty
argument_list|(
name|tp
argument_list|,
name|av
argument_list|)
condition|)
return|return;
name|dzparam
argument_list|(
name|tp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *	set parameters from open or stty into DZ hardware registers  */
end_comment

begin_expr_stmt
name|dzparam
argument_list|(
name|tp
argument_list|,
name|dflag
argument_list|)
specifier|register
expr|struct
name|tty
operator|*
name|tp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|lpr
operator|,
name|x
expr_stmt|;
extern|extern wakeup(
block|)
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_expr_stmt
name|lpr
operator|=
name|dzspeedmap
index|[
name|tp
operator|->
name|t_speeds
operator|&
literal|017
index|]
operator|<<
literal|8
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|IBM2741
end_ifdef

begin_if
if|if
condition|(
name|lpr
operator|==
operator|(
name|RCVR_ON
operator||
name|S134_5
operator|)
condition|)
name|lpr
operator|=
name|IBM2741
expr_stmt|;
else|else
block|{
endif|#
directive|endif
endif|IBM2741
if|if
condition|(
name|lpr
operator|==
operator|(
name|RCVR_ON
operator||
name|S110
operator|)
condition|)
name|lpr
operator|=
operator||
name|TWOSBIT
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|=
name|tp
operator|->
name|t_flags
operator|)
operator|&
name|EVENP
condition|)
if|if
condition|(
operator|(
name|x
operator|&
name|ODDP
operator|)
operator|==
literal|0
condition|)
name|lpr
operator|=
operator||
operator|(
name|EVN_PAR
operator||
name|C7BIT
operator|)
expr_stmt|;
else|else
name|lpr
operator|=
operator||
name|C8BIT
expr_stmt|;
elseif|else
if|if
condition|(
name|x
operator|&
name|ODDP
condition|)
name|lpr
operator|=
operator||
operator|(
name|ODD_PAR
operator||
name|C7BIT
operator|)
expr_stmt|;
else|else
name|lpr
operator|=
operator||
name|C8BIT
expr_stmt|;
ifdef|#
directive|ifdef
name|IBM2741
block|}
end_if

begin_endif
endif|#
directive|endif
endif|IBM2741
end_endif

begin_if
if|if
condition|(
name|dflag
condition|)
block|{
comment|/* delay only if it is permissible */
ifndef|#
directive|ifndef
name|DELAY
name|timeout
argument_list|(
operator|&
name|wakeup
argument_list|,
name|tp
argument_list|,
name|FLUSHTIME
argument_list|)
expr_stmt|;
comment|/* wakeup in 5 tics */
name|sleep
argument_list|(
name|tp
argument_list|,
name|TTOPRI
argument_list|)
expr_stmt|;
comment|/* delay while controller flushes */
else|#
directive|else
name|delay
argument_list|(
name|FLUSHTIME
argument_list|)
expr_stmt|;
comment|/* hang 5 */
endif|#
directive|endif
endif|DELAY
block|}
end_if

begin_expr_stmt
name|dz
index|[
name|tp
operator|->
name|t_dev
operator|.
name|d_minor
operator|>>
literal|3
index|]
operator|.
name|dzaddr
operator|->
name|dzlpr
operator|=
name|lpr
operator||
operator|(
name|tp
operator|->
name|t_dev
operator|.
name|d_minor
operator|&
literal|07
operator|)
expr_stmt|;
end_expr_stmt

begin_comment
unit|}
comment|/*  *	start (restart) transmission on a DZ11 line  */
end_comment

begin_expr_stmt
unit|dzstart
operator|(
name|tp
operator|)
specifier|register
expr|struct
name|tty
operator|*
name|tp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|t_bit
expr_stmt|;
specifier|register
name|struct
name|dz
modifier|*
name|dzp
decl_stmt|;
name|t_bit
operator|=
literal|1
operator|<<
operator|(
name|tp
operator|->
name|t_dev
operator|.
name|d_minor
operator|&
literal|07
operator|)
expr_stmt|;
name|dzp
operator|=
operator|&
name|dz
index|[
name|tp
operator|->
name|t_dev
operator|.
name|d_minor
operator|>>
literal|3
index|]
expr_stmt|;
if|if
condition|(
operator|(
operator|!
operator|(
name|dzp
operator|->
name|carrier
operator|&
name|t_bit
operator|)
operator|)
operator|||
operator|(
name|dzp
operator|->
name|dzaddr
operator|->
name|dzcarr
operator|&
name|t_bit
operator|)
condition|)
name|dzp
operator|->
name|dzaddr
operator|->
name|dztcr
operator|=
operator||
name|t_bit
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *	DZ11 transmitter interrupt.  *  *	Scan every line on each dz.  *	Commencing with the device that caused  *	dzxint to be called.  */
end_comment

begin_macro
name|dzxint
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
specifier|register
name|c
expr_stmt|;
specifier|register
name|struct
name|dzr_read
modifier|*
name|dzaddr
decl_stmt|;
name|struct
name|dz
modifier|*
name|dzp
decl_stmt|;
name|struct
name|tty
modifier|*
name|dzbase
decl_stmt|;
name|int
name|t_bit
decl_stmt|,
name|lino
decl_stmt|,
name|i
decl_stmt|,
name|n
decl_stmt|;
name|n
operator|=
name|dev
operator|.
name|d_minor
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NDZ
condition|;
name|i
operator|++
control|)
block|{
name|dzaddr
operator|=
operator|(
name|dzp
operator|=
operator|&
name|dz
index|[
name|n
index|]
operator|)
operator|->
name|dzaddr
expr_stmt|;
name|dzbase
operator|=
operator|&
name|dz11
index|[
name|n
operator|*
literal|8
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|dzaddr
operator|->
name|dzcsr
operator|)
operator|<
literal|0
condition|)
comment|/* xmit line ready */
block|{
name|t_bit
operator|=
literal|1
operator|<<
operator|(
name|lino
operator|=
operator|(
name|c
operator|>>
literal|8
operator|)
operator|&
literal|07
operator|)
expr_stmt|;
name|tp
operator|=
operator|&
name|dzbase
index|[
name|lino
index|]
expr_stmt|;
if|if
condition|(
operator|(
operator|!
operator|(
name|dzp
operator|->
name|carrier
operator|&
name|t_bit
operator|)
operator|||
operator|(
name|dzaddr
operator|->
name|dzcarr
operator|&
name|t_bit
operator|)
operator|)
operator|&&
operator|(
name|c
operator|=
name|getc
argument_list|(
operator|&
name|tp
operator|->
name|t_outq
argument_list|)
operator|)
operator|>=
literal|0
condition|)
if|if
condition|(
name|c
operator|<=
literal|0177
operator|||
name|tp
operator|->
name|t_flags
operator|==
name|RAW
condition|)
name|dzaddr
operator|->
name|dztbuf
operator|=
name|c
expr_stmt|;
else|else
block|{
name|dzaddr
operator|->
name|dztcr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
name|tp
operator|->
name|t_state
operator|=
operator||
name|TIMEOUT
expr_stmt|;
name|dzdelays
index|[
name|tp
operator|-
name|dz11
index|]
operator|=
operator|(
operator|(
name|c
operator|&
literal|0177
operator|)
operator|+
operator|(
name|TSCANRATE
operator|-
literal|1
operator|)
operator|)
operator|/
name|TSCANRATE
operator|+
literal|1
expr_stmt|;
comment|/* set up timeout */
continue|continue;
block|}
else|else
name|dzaddr
operator|->
name|dztcr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
ifdef|#
directive|ifdef
name|TTY_HISPEED
if|if
condition|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|<=
operator|(
operator|(
name|tp
operator|->
name|t_speeds
operator|&
literal|017
operator|)
operator|>
name|B1200
condition|?
name|TTHSLOWAT
else|:
name|TTLOWAT
operator|)
operator|&&
operator|(
name|tp
operator|->
name|t_state
operator|&
name|ASLEEP
operator|)
condition|)
else|#
directive|else
if|if
condition|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|<=
name|TTLOWAT
operator|&&
operator|(
name|tp
operator|->
name|t_state
operator|&
name|ASLEEP
operator|)
condition|)
endif|#
directive|endif
endif|TTY_HISPEED
block|{
name|tp
operator|->
name|t_state
operator|=
operator|&
operator|~
name|ASLEEP
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|tp
operator|->
name|t_outq
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|++
name|n
operator|>=
name|NDZ
condition|)
name|n
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  *	DZ11 receiver interrupt  *  *	Scan each dz commencing with the  *	particular device that caused this call.  *	Storing each charater as it comes.  */
end_comment

begin_macro
name|dzrint
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
specifier|register
name|c
expr_stmt|;
specifier|register
name|struct
name|dzr_read
modifier|*
name|dzaddr
decl_stmt|;
name|struct
name|dz
modifier|*
name|dzp
decl_stmt|;
name|struct
name|tty
modifier|*
name|dzbase
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
name|lino
decl_stmt|,
name|t_bit
decl_stmt|;
name|n
operator|=
name|dev
operator|.
name|d_minor
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NDZ
condition|;
name|i
operator|++
control|)
block|{
name|dzp
operator|=
operator|&
name|dz
index|[
name|n
index|]
expr_stmt|;
if|if
condition|(
name|dzp
operator|->
name|openl
condition|)
block|{
name|dzbase
operator|=
operator|&
name|dz11
index|[
name|n
operator|*
literal|8
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|dzp
operator|->
name|dzaddr
operator|->
name|dzrbuf
operator|)
operator|<
literal|0
condition|)
comment|/* char present in silo */
block|{
name|tp
operator|=
operator|&
name|dzbase
index|[
name|lino
operator|=
operator|(
operator|(
name|c
operator|>>
literal|8
operator|)
operator|&
literal|07
operator|)
index|]
expr_stmt|;
name|t_bit
operator|=
literal|1
operator|<<
name|lino
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|RERROR
condition|)
block|{
if|if
condition|(
name|c
operator|&
name|OVR_RUN
condition|)
block|{
name|dzp
operator|->
name|overrors
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|MESSAGES
name|printf
argument_list|(
literal|"over run on dz %d/%d\n"
argument_list|,
name|n
argument_list|,
name|lino
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MESSAGES
block|}
if|if
condition|(
name|c
operator|&
name|FRAME
condition|)
comment|/* break */
if|if
condition|(
name|tp
operator|->
name|t_flags
operator|&
name|RAW
condition|)
name|c
operator|=
literal|0
expr_stmt|;
comment|/* null ( for getty ) */
else|else
ifdef|#
directive|ifdef
name|INTR_ON_BREAK
name|c
operator|=
name|CINTR
expr_stmt|;
comment|/* del for NCRs. */
else|#
directive|else
continue|continue;
comment|/* ignore framing errors if not raw */
endif|#
directive|endif
endif|INTR_ON_BREAK
elseif|else
if|if
condition|(
name|c
operator|&
name|PARITY
condition|)
block|{
name|dzp
operator|->
name|pyerrors
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|MESSAGES
name|printf
argument_list|(
literal|"parity on dz %d/%d\n"
argument_list|,
name|n
argument_list|,
name|lino
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MESSAGES
continue|continue;
comment|/* throw away bad chars */
block|}
block|}
if|if
condition|(
operator|(
operator|!
operator|(
name|dzp
operator|->
name|carrier
operator|&
name|t_bit
operator|)
operator|)
operator|||
operator|(
name|dzp
operator|->
name|dzaddr
operator|->
name|dzcarr
operator|&
name|t_bit
operator|)
condition|)
name|ttyinput
argument_list|(
name|c
argument_list|,
name|tp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|++
name|n
operator|>=
name|NDZ
condition|)
name|n
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_empty
empty|#
end_empty

begin_comment
comment|/*  ps - show process status - iiasa version (jek) 	originally from harvard and/or CULC  	flags are single letters 	multiple flags can occur in one argument 	dashes are optional but are needed to delimit lists of things 		multiple lists are present(???) 	flags that imply other arguments read the following arguments 		until the end of the list or until an argument starts with dash 	certain flags read exactly one argument 	initialization (i flag) should be done for: 		new users, 		new kernel 	parameters here must change to indicate: 		new tty devices, max tty lines, tty letter changes 		max users 		new things to wait for 	this program should be changed if: 		proc structure makes this obsolete 		etc 	recompilation should occur if: 		kernel structures and or paramters (nproc etc.) change 		any above changes of course  	flags are: 		a - show all processes that have pgrps except shells 		b - show background (not detached) 		c - show child times instead of process times 		d - show detached processes inherited by init 		e - show the environment with the args 		f - show foreground jobs, connected to tty 		g - show processes in given pgrps 		h - unused 		i - perform initialization (implies 'n') 		j,k - unused 		l - print long format. includes most good stuff 		m - specify different memory file (file is next arg) 		n - show no processes 		o - unused 		p - show only processes whose id's are in list (following args) 		q - unused 		r - repeat indefinitely (number of r's = seconds or r#) 		s - show stopped processes 		t - show only processes associated with ttys in list (following) 		u - show only processes (or ancestors of) for users in list 		v - be verbose - show the most information 		w - wide format, show entire argument list (up to 512 chars) 		x - show unattached processes - no pgrp. a+x gives shells also 		y - unused 		z - show zombies 		A - show ALL information possible 		B - show busy processes 		F - go fast, avoid swap space. 		G - print pgrp 		U - use different UNIX file (next arg) 		S - show size 		T - show tty information 		W - print wait channels in hex */
end_comment

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<h/param.h>
end_include

begin_include
include|#
directive|include
file|<h/dir.h>
end_include

begin_include
include|#
directive|include
file|<h/user.h>
end_include

begin_include
include|#
directive|include
file|<h/proc.h>
end_include

begin_include
include|#
directive|include
file|<h/pte.h>
end_include

begin_include
include|#
directive|include
file|<h/vm.h>
end_include

begin_include
include|#
directive|include
file|<h/inode.h>
end_include

begin_include
include|#
directive|include
file|<h/file.h>
end_include

begin_include
include|#
directive|include
file|<h/buf.h>
end_include

begin_include
include|#
directive|include
file|<h/text.h>
end_include

begin_include
include|#
directive|include
file|<h/tty.h>
end_include

begin_include
include|#
directive|include
file|<h/conf.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_define
define|#
directive|define
name|TRUE
value|1
end_define

begin_define
define|#
directive|define
name|FALSE
value|0
end_define

begin_define
define|#
directive|define
name|INTPPG
value|(NBPG/sizeof(int))
end_define

begin_define
define|#
directive|define
name|MAXARGPG
value|5
end_define

begin_define
define|#
directive|define
name|Usrptmap
value|((struct pte *)info.kaddr[ausrptmap])
end_define

begin_define
define|#
directive|define
name|usrpt
value|((struct pte *)info.kaddr[ausrpt])
end_define

begin_define
define|#
directive|define
name|cswitch
value|((struct cdevsw *)info.kaddr[acdevsw])
end_define

begin_decl_stmt
name|struct
name|proc
modifier|*
name|proc
decl_stmt|,
modifier|*
name|kproc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|text
modifier|*
name|text
decl_stmt|,
modifier|*
name|ktext
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|buf
modifier|*
name|buf
decl_stmt|,
modifier|*
name|swbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|inode
modifier|*
name|inode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nproc
decl_stmt|,
name|ntext
decl_stmt|,
name|hz
decl_stmt|,
name|nbuf
decl_stmt|,
name|ninode
decl_stmt|,
name|nfile
decl_stmt|,
name|nswbuf
decl_stmt|;
end_decl_stmt

begin_union
union|union
block|{
name|struct
name|user
name|user
decl_stmt|;
name|char
name|upages
index|[
name|UPAGES
index|]
index|[
name|NBPG
index|]
decl_stmt|;
block|}
name|user
union|;
end_union

begin_decl_stmt
name|int
name|pad1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* supposedly to aviod hardware problem reading /dev/mem */
end_comment

begin_decl_stmt
name|struct
name|pte
name|pagetable
index|[
name|UPAGES
operator|+
name|MAXARGPG
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* for users page table */
end_comment

begin_decl_stmt
name|int
name|pad2
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* supposedly to aviod hardware problem reading /dev/mem */
end_comment

begin_define
define|#
directive|define
name|u
value|user.user
end_define

begin_define
define|#
directive|define
name|MSPID
value|2
end_define

begin_comment
comment|/* max system pid, not to considered BUSY */
end_comment

begin_define
define|#
directive|define
name|MAXUSERS
value|256
end_define

begin_comment
comment|/* total different users */
end_comment

begin_define
define|#
directive|define
name|UNAMELENGTH
value|8
end_define

begin_comment
comment|/* length of a user name */
end_comment

begin_define
define|#
directive|define
name|NSPEC
value|15
end_define

begin_comment
comment|/* number of specified things (proc, user, tty */
end_comment

begin_define
define|#
directive|define
name|MAXTTYS
value|100
end_define

begin_comment
comment|/* definitions to reuse uninteresting proc table entries for linked lists */
end_comment

begin_struct
struct|struct
name|procinfo
block|{
comment|/* structure to use for */
name|char
modifier|*
name|pi_cmd
decl_stmt|;
comment|/* attaching a time */
name|struct
name|ttyline
modifier|*
name|pi_tty
decl_stmt|;
name|long
name|pi_time
decl_stmt|;
comment|/* and an arg string to a proc */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|p_next
value|p_link
end_define

begin_comment
comment|/* pointer to next proc in global list */
end_comment

begin_define
define|#
directive|define
name|p_bro
value|p_rlink
end_define

begin_comment
comment|/* next process with same parent */
end_comment

begin_define
define|#
directive|define
name|p_son
value|p_xlink
end_define

begin_comment
comment|/* first child of this process */
end_comment

begin_define
define|#
directive|define
name|pinfo
parameter_list|(
name|p
parameter_list|)
value|(*((struct procinfo **)&p->p_sig))
end_define

begin_define
define|#
directive|define
name|procsize
parameter_list|(
name|p
parameter_list|)
value|((p)->p_tsize + (p)->p_dsize + (p)->p_ssize)
end_define

begin_comment
comment|/* size of process */
end_comment

begin_define
define|#
directive|define
name|ABS
parameter_list|(
name|x
parameter_list|)
value|((int)(x)& ~0x80000000)
end_define

begin_comment
comment|/* clear top bit - type int */
end_comment

begin_define
define|#
directive|define
name|K
value|1024
end_define

begin_define
define|#
directive|define
name|KSHIFT
value|10
end_define

begin_define
define|#
directive|define
name|msize
parameter_list|(
name|x
parameter_list|)
value|(x>> (KSHIFT-PGSHIFT))
end_define

begin_define
define|#
directive|define
name|USERPAGE
value|0
end_define

begin_comment
comment|/* flag for pread - read user page */
end_comment

begin_define
define|#
directive|define
name|TOPMEM
value|1
end_define

begin_comment
comment|/* flag for pread - read top of mem */
end_comment

begin_decl_stmt
name|struct
name|proc
modifier|*
name|plist
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mypid
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* pid of this process */
end_comment

begin_decl_stmt
name|char
name|Aflag
decl_stmt|,
name|aflag
decl_stmt|,
name|Bflag
decl_stmt|,
name|bflag
decl_stmt|,
name|cflag
decl_stmt|,
name|dflag
decl_stmt|,
name|eflag
decl_stmt|,
name|fflag
decl_stmt|,
name|Fflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Gflag
decl_stmt|,
name|iflag
decl_stmt|,
name|lflag
decl_stmt|,
name|mflag
decl_stmt|,
name|nflag
decl_stmt|,
name|rflag
decl_stmt|,
name|Sflag
decl_stmt|,
name|sflag
decl_stmt|,
name|Tflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Uflag
decl_stmt|,
name|uflag
decl_stmt|,
name|vflag
decl_stmt|,
name|wflag
decl_stmt|,
name|xflag
decl_stmt|,
name|nxflag
decl_stmt|,
name|Wflag
decl_stmt|,
name|zflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|select
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* flag indicating process selection */
end_comment

begin_decl_stmt
name|int
name|ntotal
decl_stmt|,
name|nbusy
decl_stmt|,
name|nloaded
decl_stmt|,
name|nswapped
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ktotal
decl_stmt|,
name|kbusy
decl_stmt|,
name|kloaded
decl_stmt|,
name|kswapped
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* specified users, ttys, pids, pgrps */
end_comment

begin_union
union|union
name|numptr
block|{
name|int
name|nm_int
decl_stmt|;
name|char
modifier|*
name|nm_ptr
decl_stmt|;
block|}
union|;
end_union

begin_union
union|union
name|ttyptr
block|{
name|struct
name|ttyline
modifier|*
name|ty_line
decl_stmt|;
name|char
modifier|*
name|ty_ptr
decl_stmt|;
block|}
union|;
end_union

begin_decl_stmt
name|union
name|numptr
name|pids
index|[
name|NSPEC
index|]
decl_stmt|,
modifier|*
name|ppids
init|=
name|pids
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* specified process ids */
end_comment

begin_decl_stmt
name|union
name|numptr
name|grps
index|[
name|NSPEC
index|]
decl_stmt|,
modifier|*
name|pgrps
init|=
name|grps
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* specified groups */
end_comment

begin_decl_stmt
name|union
name|numptr
name|uids
index|[
name|NSPEC
index|]
decl_stmt|,
modifier|*
name|puids
init|=
name|uids
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* specified user ids */
end_comment

begin_decl_stmt
name|union
name|ttyptr
name|ttys
index|[
name|NSPEC
index|]
decl_stmt|,
modifier|*
name|pttys
init|=
name|ttys
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* specified ttys */
end_comment

begin_comment
comment|/* files needed by ps */
end_comment

begin_decl_stmt
name|char
modifier|*
name|memf
init|=
literal|"/dev/mem"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default memory file */
end_comment

begin_decl_stmt
name|int
name|mem
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* memory file descriptor */
end_comment

begin_decl_stmt
name|char
modifier|*
name|kmemf
init|=
literal|"/dev/kmem"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* virtual memory file */
end_comment

begin_decl_stmt
name|int
name|kmem
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* virtual memory file descriptor */
end_comment

begin_decl_stmt
name|char
modifier|*
name|symf
init|=
literal|"/vmunix"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default symbol file */
end_comment

begin_decl_stmt
name|char
modifier|*
name|swapf
init|=
literal|"/dev/swap"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default swap file */
end_comment

begin_decl_stmt
name|int
name|swap
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* swap area file descriptor */
end_comment

begin_decl_stmt
name|char
modifier|*
name|infof
init|=
literal|"/etc/spsinfo"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default info save file */
end_comment

begin_decl_stmt
name|int
name|infofd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* info file descriptor */
end_comment

begin_comment
comment|/* variables read from the kernel */
end_comment

begin_decl_stmt
name|struct
name|nlist
name|namelist
index|[]
init|=
block|{
define|#
directive|define
name|aproc
value|0
block|{
literal|"_proc"
block|}
block|,
define|#
directive|define
name|aswapdev
value|1
block|{
literal|"_swapdev"
block|}
block|,
define|#
directive|define
name|aswplo
value|2
block|{
literal|"_swplo"
block|}
block|,
define|#
directive|define
name|answbuf
value|3
block|{
literal|"_nswbuf"
block|}
block|,
define|#
directive|define
name|atext
value|4
block|{
literal|"_text"
block|}
block|,
define|#
directive|define
name|abuf
value|5
block|{
literal|"_buf"
block|}
block|,
define|#
directive|define
name|abfreeli
value|6
block|{
literal|"_bfreelist"
block|}
block|,
define|#
directive|define
name|akl11
value|7
block|{
literal|"_kl11"
block|}
block|,
define|#
directive|define
name|adh11
value|8
block|{
literal|"_dh11"
block|}
block|,
define|#
directive|define
name|alpdt
value|9
block|{
literal|"_lp_softc"
block|}
block|,
define|#
directive|define
name|albolt
value|10
block|{
literal|"_lbolt"
block|}
block|,
define|#
directive|define
name|atout
value|11
block|{
literal|"_tout"
block|}
block|,
define|#
directive|define
name|arunin
value|12
block|{
literal|"_runin"
block|}
block|,
define|#
directive|define
name|arunout
value|13
block|{
literal|"_runout"
block|}
block|,
define|#
directive|define
name|aipc
value|14
block|{
literal|"_ipc"
block|}
block|,
define|#
directive|define
name|afile
value|15
block|{
literal|"_file"
block|}
block|,
define|#
directive|define
name|ainode
value|16
block|{
literal|"_inode"
block|}
block|,
define|#
directive|define
name|amaplock
value|17
block|{
literal|"_maplock"
block|}
block|,
define|#
directive|define
name|acoremap
value|18
block|{
literal|"_coremap"
block|}
block|,
define|#
directive|define
name|aswapmap
value|19
block|{
literal|"_swapmap"
block|}
block|,
define|#
directive|define
name|au
value|20
block|{
literal|"_u"
block|}
block|,
define|#
directive|define
name|adz11
value|21
block|{
literal|"_dz_tty"
block|}
block|,
define|#
directive|define
name|aetext
value|22
block|{
literal|"_etext"
block|}
block|,
define|#
directive|define
name|ausrptmap
value|23
block|{
literal|"_Usrptmap"
block|}
block|,
define|#
directive|define
name|ausrpt
value|24
block|{
literal|"_usrpt"
block|}
block|,
define|#
directive|define
name|achtbuf
value|25
block|{
literal|"_chtbuf"
block|}
block|,
define|#
directive|define
name|arhtbuf
value|26
block|{
literal|"_rhtbuf"
block|}
block|,
define|#
directive|define
name|ahpbuf
value|27
block|{
literal|"_hpbuf"
block|}
block|,
define|#
directive|define
name|aswbuf
value|28
block|{
literal|"_swbuf"
block|}
block|,
define|#
directive|define
name|arswbuf
value|29
block|{
literal|"_rswbuf"
block|}
block|,
define|#
directive|define
name|acons
value|30
block|{
literal|"_cons"
block|}
block|,
define|#
directive|define
name|ark7
value|31
block|{
literal|"_rrk7buf"
block|}
block|,
define|#
directive|define
name|achrfclist
value|32
block|{
literal|"_Chrfclist"
block|}
block|,
define|#
directive|define
name|anproc
value|33
block|{
literal|"_nproc"
block|}
block|,
define|#
directive|define
name|antext
value|34
block|{
literal|"_ntext"
block|}
block|,
define|#
directive|define
name|anbuf
value|35
block|{
literal|"_nbuf"
block|}
block|,
define|#
directive|define
name|ahz
value|36
block|{
literal|"_hz"
block|}
block|,
define|#
directive|define
name|aninode
value|37
block|{
literal|"_ninode"
block|}
block|,
define|#
directive|define
name|anfile
value|38
block|{
literal|"_nfile"
block|}
block|,
define|#
directive|define
name|answap
value|39
block|{
literal|"_nswap"
block|}
block|,
define|#
directive|define
name|acdevsw
value|40
block|{
literal|"_cdevsw"
block|}
block|,
define|#
directive|define
name|aChconntab
value|41
block|{
literal|"_Chconntab"
block|}
block|,
define|#
directive|define
name|MAXSYMBOLS
value|42
block|{
literal|""
block|,
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* this structure is read from info file or initialized (iflag) */
end_comment

begin_struct
struct|struct
block|{
name|caddr_t
name|kaddr
index|[
name|MAXSYMBOLS
index|]
decl_stmt|;
comment|/* useful kernel addresses */
name|char
name|unames
index|[
name|MAXUSERS
index|]
index|[
name|UNAMELENGTH
index|]
decl_stmt|;
comment|/* user names */
struct|struct
name|ttyline
block|{
name|struct
name|tty
modifier|*
name|l_addr
decl_stmt|;
comment|/* address of ttystruct */
name|unsigned
name|l_pgrp
decl_stmt|;
comment|/* process group */
name|char
name|l_name
index|[
literal|2
index|]
decl_stmt|;
comment|/* name */
name|dev_t
name|l_dev
decl_stmt|;
comment|/* device number */
block|}
name|ttyline
index|[
name|MAXTTYS
index|]
struct|;
block|}
name|info
struct|;
end_struct

begin_decl_stmt
name|int
name|swapdev
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* major, minor of swap device */
end_comment

begin_decl_stmt
name|int
name|swplo
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* unix swap disk offset */
end_comment

begin_decl_stmt
name|int
name|nswap
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* unix swap space size */
end_comment

begin_decl_stmt
name|struct
name|ttyline
name|notty
init|=
block|{
literal|0
block|,
literal|0
block|,
block|{
literal|"- "
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* flags for once only activities (once per repeat) */
end_comment

begin_decl_stmt
name|int
name|heading
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|coreinit
decl_stmt|,
name|core
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|topmem
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|arglength
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|getcore
argument_list|()
decl_stmt|,
modifier|*
name|store
argument_list|()
decl_stmt|,
modifier|*
name|waitingfor
argument_list|()
decl_stmt|,
modifier|*
name|getcmd
argument_list|()
decl_stmt|,
modifier|*
name|strcat
argument_list|()
decl_stmt|,
modifier|*
name|brk
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
modifier|*
name|ap
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|myuid
decl_stmt|;
specifier|extern
name|char
name|_sobuf
index|[]
decl_stmt|;
if|if
condition|(
operator|(
name|myuid
operator|=
name|getuid
argument_list|()
operator|)
operator|==
literal|0
condition|)
name|nice
argument_list|(
operator|-
literal|100
argument_list|)
expr_stmt|;
name|setbuf
argument_list|(
name|stdout
argument_list|,
name|_sobuf
argument_list|)
expr_stmt|;
name|select
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ap
operator|=
operator|&
name|argv
index|[
literal|1
index|]
init|;
operator|--
name|argc
condition|;
name|ap
operator|++
control|)
block|{
for|for
control|(
name|cp
operator|=
operator|*
name|ap
init|;
operator|*
name|cp
condition|;
control|)
block|{
switch|switch
condition|(
operator|*
name|cp
operator|++
condition|)
block|{
case|case
literal|'-'
case|:
continue|continue;
case|case
literal|'A'
case|:
comment|/* EVERYTHING */
name|Aflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'a'
case|:
comment|/* all procs attached to ttys */
name|bflag
operator|++
expr_stmt|;
comment|/* include background */
name|fflag
operator|++
expr_stmt|;
comment|/* include foreground */
name|dflag
operator|++
expr_stmt|;
comment|/* include detached */
name|aflag
operator|++
expr_stmt|;
comment|/* include shells */
name|select
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'b'
case|:
comment|/* all background processes */
name|bflag
operator|++
expr_stmt|;
name|select
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'B'
case|:
comment|/* all busy processes */
name|Bflag
operator|++
expr_stmt|;
name|select
operator|++
expr_stmt|;
name|lflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'c'
case|:
name|cflag
operator|++
expr_stmt|;
name|lflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'d'
case|:
comment|/* detached processes */
name|dflag
operator|++
expr_stmt|;
name|select
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'e'
case|:
name|eflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'f'
case|:
comment|/* foreground only */
name|fflag
operator|++
expr_stmt|;
name|select
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'F'
case|:
comment|/* go fast, don't touch swap */
name|Fflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'G'
case|:
comment|/* print pgrp */
name|Gflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'g'
case|:
comment|/* specify process gourp */
name|select
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|++
name|ap
operator|==
literal|'-'
condition|)
block|{
name|ap
operator|--
expr_stmt|;
break|break;
block|}
operator|--
name|argc
expr_stmt|;
if|if
condition|(
name|pgrps
operator|>=
operator|&
name|grps
index|[
name|NSPEC
index|]
condition|)
name|prexit
argument_list|(
literal|"%a: too many groups\n"
argument_list|)
expr_stmt|;
operator|(
name|pgrps
operator|++
operator|)
operator|->
name|nm_int
operator|=
name|atoi
argument_list|(
operator|*
name|ap
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pgrps
operator|==
name|grps
condition|)
operator|(
name|pgrps
operator|++
operator|)
operator|->
name|nm_int
operator|=
name|getpgrp
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'i'
case|:
comment|/* initialize info file */
if|if
condition|(
name|myuid
operator|!=
literal|0
condition|)
comment|/* must be super user */
goto|goto
name|def
goto|;
name|iflag
operator|++
expr_stmt|;
name|nflag
operator|++
expr_stmt|;
name|Uflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'l'
case|:
comment|/* long output */
name|lflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'m'
case|:
comment|/* use designated memory file */
if|if
condition|(
name|myuid
operator|!=
literal|0
condition|)
comment|/* must be super user */
goto|goto
name|def
goto|;
if|if
condition|(
name|argc
operator|--
operator|<
literal|2
operator|||
operator|*
operator|*
operator|++
name|ap
operator|==
literal|'-'
condition|)
name|prexit
argument_list|(
literal|"%a: missing memory file\n"
argument_list|)
expr_stmt|;
name|memf
operator|=
operator|*
name|ap
expr_stmt|;
name|mflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'n'
case|:
name|select
operator|++
expr_stmt|;
name|nflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'p'
case|:
comment|/* only designated processes */
name|select
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|++
name|ap
operator|==
literal|'-'
condition|)
block|{
name|ap
operator|--
expr_stmt|;
break|break;
block|}
operator|--
name|argc
expr_stmt|;
if|if
condition|(
name|ppids
operator|>=
operator|&
name|pids
index|[
name|NSPEC
index|]
condition|)
name|prexit
argument_list|(
literal|"%a: too many pids\n"
argument_list|)
expr_stmt|;
operator|(
name|ppids
operator|++
operator|)
operator|->
name|nm_int
operator|=
name|atoi
argument_list|(
operator|*
name|ap
argument_list|)
expr_stmt|;
block|}
continue|continue;
case|case
literal|'r'
case|:
comment|/* repeat every<number> seconds */
if|if
condition|(
name|myuid
operator|!=
literal|0
condition|)
goto|goto
name|def
goto|;
name|rflag
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|*
name|cp
operator|>=
literal|'0'
operator|&&
operator|*
name|cp
operator|<=
literal|'9'
condition|;
name|cp
operator|++
control|)
name|i
operator|=
name|i
operator|*
literal|10
operator|+
operator|*
name|cp
operator|-
literal|'0'
expr_stmt|;
if|if
condition|(
name|i
condition|)
name|rflag
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
literal|'U'
case|:
comment|/* use designated symbol file */
if|if
condition|(
name|myuid
operator|!=
literal|0
condition|)
goto|goto
name|def
goto|;
if|if
condition|(
name|argc
operator|--
operator|<
literal|2
operator|||
operator|*
operator|*
operator|++
name|ap
operator|==
literal|'-'
condition|)
name|prexit
argument_list|(
literal|"%a: missing symbol file\n"
argument_list|)
expr_stmt|;
name|symf
operator|=
operator|*
name|ap
expr_stmt|;
name|Uflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'s'
case|:
name|sflag
operator|++
expr_stmt|;
name|select
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'S'
case|:
name|Sflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'T'
case|:
name|Tflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'t'
case|:
comment|/* on designated tty(s) */
name|select
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|++
name|ap
operator|==
literal|'-'
condition|)
block|{
name|ap
operator|--
expr_stmt|;
break|break;
block|}
operator|--
name|argc
expr_stmt|;
if|if
condition|(
name|pttys
operator|>=
operator|&
name|ttys
index|[
name|NSPEC
index|]
condition|)
name|prexit
argument_list|(
literal|"%a: too many ttys\n"
argument_list|)
expr_stmt|;
operator|(
name|pttys
operator|++
operator|)
operator|->
name|ty_ptr
operator|=
operator|*
name|ap
expr_stmt|;
block|}
if|if
condition|(
name|pttys
operator|==
name|ttys
condition|)
block|{
name|char
modifier|*
name|ttyname
parameter_list|()
function_decl|;
if|if
condition|(
operator|(
name|pttys
operator|->
name|ty_ptr
operator|=
name|ttyname
argument_list|(
literal|2
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|prexit
argument_list|(
literal|"%a: unknown tty\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
literal|"/dev/console"
argument_list|,
name|pttys
operator|->
name|ty_ptr
argument_list|)
operator|==
literal|0
condition|)
operator|(
name|pttys
operator|++
operator|)
operator|->
name|ty_ptr
operator|=
literal|"co"
expr_stmt|;
else|else
operator|(
name|pttys
operator|++
operator|)
operator|->
name|ty_ptr
operator|+=
sizeof|sizeof
argument_list|(
literal|"/dev/tty"
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
continue|continue;
case|case
literal|'u'
case|:
comment|/* specific user name */
name|aflag
operator|++
expr_stmt|;
name|select
operator|++
expr_stmt|;
name|puids
operator|=
operator|&
name|uids
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|++
name|ap
operator|==
literal|'-'
condition|)
block|{
name|ap
operator|--
expr_stmt|;
break|break;
block|}
operator|--
name|argc
expr_stmt|;
if|if
condition|(
name|puids
operator|>=
operator|&
name|uids
index|[
name|NSPEC
index|]
condition|)
name|prexit
argument_list|(
literal|"%a: too many users\n"
argument_list|)
expr_stmt|;
operator|(
name|puids
operator|++
operator|)
operator|->
name|nm_ptr
operator|=
operator|*
name|ap
expr_stmt|;
block|}
if|if
condition|(
name|puids
operator|==
operator|&
name|uids
index|[
literal|0
index|]
condition|)
operator|(
name|puids
operator|++
operator|)
operator|->
name|nm_int
operator|=
name|myuid
expr_stmt|;
continue|continue;
case|case
literal|'v'
case|:
comment|/* most verbose output */
name|vflag
operator|++
expr_stmt|;
name|lflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'W'
case|:
name|Wflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'w'
case|:
comment|/* wide form (all arguments) */
name|wflag
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'x'
case|:
comment|/* include un-owned procs */
name|xflag
operator|++
expr_stmt|;
name|select
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'z'
case|:
comment|/* include only zombies */
name|zflag
operator|++
expr_stmt|;
name|select
operator|++
expr_stmt|;
continue|continue;
name|def
label|:
default|default:
name|prexit
argument_list|(
literal|"%a: unknown switch: %c\n"
argument_list|,
operator|*
operator|--
name|cp
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
comment|/* these lengths are kludgely tuned to make things not exceed 79 columns */
name|arglength
operator|=
literal|60
expr_stmt|;
if|if
condition|(
name|lflag
condition|)
name|arglength
operator|-=
literal|28
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
name|arglength
operator|-=
literal|14
expr_stmt|;
if|if
condition|(
operator|(
name|mem
operator|=
name|open
argument_list|(
name|memf
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|prexit
argument_list|(
literal|"%a: cannot read system memory: %s\n"
argument_list|,
name|memf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|kmem
operator|=
name|open
argument_list|(
name|kmemf
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|prexit
argument_list|(
literal|"%a: cannot read system virtural memory: %s\n"
argument_list|,
name|kmemf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Fflag
operator|&&
operator|(
name|swap
operator|=
name|open
argument_list|(
name|swapf
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|prexit
argument_list|(
literal|"%a: cannot read swap device: %s\n"
argument_list|,
name|swapf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iflag
condition|)
if|if
condition|(
operator|(
name|i
operator|=
name|open
argument_list|(
name|infof
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|prexit
argument_list|(
literal|"%a: cannot open info file\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|read
argument_list|(
name|i
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
name|info
argument_list|)
operator|!=
sizeof|sizeof
name|info
condition|)
name|prexit
argument_list|(
literal|"%a: cannot read info file\n"
argument_list|)
expr_stmt|;
else|else
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|Uflag
condition|)
block|{
name|struct
name|nlist
modifier|*
name|np
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|open
argument_list|(
name|symf
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|prexit
argument_list|(
literal|"%a: can't read symbol file\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|nlist
argument_list|(
name|symf
argument_list|,
name|namelist
argument_list|)
expr_stmt|;
for|for
control|(
name|np
operator|=
name|namelist
init|;
name|np
operator|<
operator|&
name|namelist
index|[
name|MAXSYMBOLS
index|]
condition|;
name|np
operator|++
control|)
if|if
condition|(
name|np
operator|->
name|n_value
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%a: can't find symbol: %s\n"
argument_list|,
name|np
operator|->
name|n_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|namelist
index|[
literal|0
index|]
operator|.
name|n_value
operator|==
operator|-
literal|1
condition|)
name|prexit
argument_list|(
literal|"%a: cannot read symbol file: %s\n"
argument_list|,
name|symf
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXSYMBOLS
condition|;
name|i
operator|++
control|)
name|info
operator|.
name|kaddr
index|[
name|i
index|]
operator|=
operator|(
name|caddr_t
operator|)
name|namelist
index|[
name|i
index|]
operator|.
name|n_value
expr_stmt|;
name|info
operator|.
name|kaddr
index|[
name|aetext
index|]
operator|=
call|(
name|caddr_t
call|)
argument_list|(
operator|(
operator|(
name|unsigned
operator|)
name|info
operator|.
name|kaddr
index|[
name|aetext
index|]
operator|+
literal|63
operator|)
operator|&
operator|~
literal|63
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iflag
condition|)
block|{
name|readusers
argument_list|()
expr_stmt|;
name|ttyinit
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|infofd
operator|=
name|creat
argument_list|(
name|infof
argument_list|,
literal|0600
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|prexit
argument_list|(
literal|"%a: cannot create info file\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|write
argument_list|(
name|infofd
argument_list|,
operator|&
name|info
argument_list|,
sizeof|sizeof
name|info
argument_list|)
operator|)
operator|!=
sizeof|sizeof
name|info
condition|)
block|{
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|prexit
argument_list|(
literal|"%a: cannot write info file: %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|infofd
argument_list|)
expr_stmt|;
block|}
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|aswapdev
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|swapdev
argument_list|,
sizeof|sizeof
argument_list|(
name|swapdev
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|aswplo
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|swplo
argument_list|,
sizeof|sizeof
argument_list|(
name|swplo
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|answap
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|nswap
argument_list|,
sizeof|sizeof
argument_list|(
name|nswap
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|anproc
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|nproc
argument_list|,
sizeof|sizeof
argument_list|(
name|nproc
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|antext
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|ntext
argument_list|,
sizeof|sizeof
argument_list|(
name|ntext
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|anbuf
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|nbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|nbuf
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|abuf
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|answbuf
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|nswbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|nswbuf
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|aswbuf
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|swbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|swbuf
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|aninode
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|ninode
argument_list|,
sizeof|sizeof
argument_list|(
name|ninode
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|ainode
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|inode
argument_list|,
sizeof|sizeof
argument_list|(
name|inode
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|ahz
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|hz
argument_list|,
sizeof|sizeof
argument_list|(
name|hz
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|aproc
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|kproc
argument_list|,
sizeof|sizeof
argument_list|(
name|kproc
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|atext
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|ktext
argument_list|,
sizeof|sizeof
argument_list|(
name|ktext
argument_list|)
argument_list|)
expr_stmt|;
name|proc
operator|=
operator|(
expr|struct
name|proc
operator|*
operator|)
name|getcore
argument_list|(
name|nproc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|proc
argument_list|)
argument_list|)
expr_stmt|;
name|text
operator|=
operator|(
expr|struct
name|text
operator|*
operator|)
name|getcore
argument_list|(
name|ntext
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|text
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|puids
operator|!=
operator|&
name|uids
index|[
literal|0
index|]
operator|&&
name|uids
index|[
literal|0
index|]
operator|.
name|nm_int
operator|!=
name|myuid
condition|)
name|usersetup
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|select
condition|)
block|{
name|mypid
operator|=
name|getpid
argument_list|()
expr_stmt|;
operator|(
name|puids
operator|++
operator|)
operator|->
name|nm_int
operator|=
name|myuid
expr_stmt|;
name|nxflag
operator|++
expr_stmt|;
name|select
operator|++
expr_stmt|;
block|}
name|ttysetup
argument_list|()
expr_stmt|;
name|topmem
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|heading
operator|=
literal|0
expr_stmt|;
comment|/* reset heading flag (for repeat) */
name|core
operator|=
name|coreinit
operator|=
literal|0
expr_stmt|;
comment|/* reset core flag (for repeat) */
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|kproc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
name|proc
argument_list|,
name|nproc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|proc
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|ktext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
name|text
argument_list|,
name|ntext
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|text
argument_list|)
argument_list|)
expr_stmt|;
name|needed
argument_list|()
expr_stmt|;
name|mktree
argument_list|()
expr_stmt|;
name|action
argument_list|(
name|plist
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d processes (%dkb), %d busy (%dkb), %d loaded (%dkb)\n"
argument_list|,
name|ntotal
argument_list|,
operator|(
name|ctob
argument_list|(
name|ktotal
argument_list|)
operator|+
literal|1023
operator|)
operator|/
literal|1024
argument_list|,
name|nbusy
argument_list|,
operator|(
name|ctob
argument_list|(
name|kbusy
argument_list|)
operator|+
literal|1023
operator|)
operator|/
literal|1024
argument_list|,
name|nloaded
argument_list|,
operator|(
name|ctob
argument_list|(
name|kloaded
argument_list|)
operator|+
literal|1023
operator|)
operator|/
literal|1024
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|rflag
operator|&&
name|sleep
argument_list|(
name|rflag
argument_list|)
operator|==
literal|0
condition|)
do|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* read the passwd file and fill in the user name arrays */
end_comment

begin_macro
name|readusers
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|struct
name|passwd
modifier|*
name|getpwent
parameter_list|()
function_decl|;
while|while
condition|(
operator|(
name|pw
operator|=
name|getpwent
argument_list|()
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|info
operator|.
name|unames
index|[
name|pw
operator|->
name|pw_uid
index|]
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|strcpyn
argument_list|(
name|info
operator|.
name|unames
index|[
name|pw
operator|->
name|pw_uid
index|]
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|,
name|UNAMELENGTH
argument_list|)
expr_stmt|;
block|}
name|endpwent
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* check for specified user names */
end_comment

begin_macro
name|usersetup
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|union
name|numptr
modifier|*
name|ip
decl_stmt|;
for|for
control|(
name|ip
operator|=
name|uids
init|;
name|ip
operator|<
name|puids
condition|;
name|ip
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXUSERS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|equalu
argument_list|(
name|ip
operator|->
name|nm_ptr
argument_list|,
name|info
operator|.
name|unames
index|[
name|i
index|]
argument_list|)
condition|)
goto|goto
name|cont2
goto|;
name|prexit
argument_list|(
literal|"%a: unknown user: %s\n"
argument_list|,
name|ip
operator|->
name|nm_ptr
argument_list|)
expr_stmt|;
name|cont2
label|:
name|ip
operator|->
name|nm_int
operator|=
name|i
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* compare a fixed length user name */
end_comment

begin_expr_stmt
name|equalu
argument_list|(
name|u1
argument_list|,
name|u2
argument_list|)
specifier|register
name|char
operator|*
name|u1
operator|,
operator|*
name|u2
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|*
name|u1
operator|++
operator|==
operator|*
name|u2
condition|)
if|if
condition|(
operator|!
operator|*
name|u2
operator|++
operator|||
operator|++
name|i
operator|==
name|UNAMELENGTH
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_block

begin_comment
comment|/*  * Initialize the tty part of the info structure  */
end_comment

begin_macro
name|ttyinit
argument_list|()
end_macro

begin_block
block|{
name|struct
name|direct
name|dir
decl_stmt|;
name|struct
name|stat
name|sbuf
decl_stmt|;
name|int
name|fd
decl_stmt|;
specifier|register
name|struct
name|ttyline
modifier|*
name|lp
init|=
name|info
operator|.
name|ttyline
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
literal|"/dev"
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|prexit
argument_list|(
literal|"%a: can't open /dev\n"
argument_list|)
expr_stmt|;
name|chdir
argument_list|(
literal|"/dev"
argument_list|)
expr_stmt|;
while|while
condition|(
name|read
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|dir
argument_list|,
sizeof|sizeof
argument_list|(
name|dir
argument_list|)
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|dir
argument_list|)
condition|)
block|{
if|if
condition|(
name|dir
operator|.
name|d_ino
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
literal|"tty"
argument_list|,
name|dir
operator|.
name|d_name
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
literal|"console"
argument_list|,
name|dir
operator|.
name|d_name
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|dir
operator|.
name|d_name
index|[
sizeof|sizeof
argument_list|(
literal|"tty"
argument_list|)
operator|-
literal|1
index|]
operator|==
literal|'C'
condition|)
continue|continue;
if|if
condition|(
name|lp
operator|>=
operator|&
name|info
operator|.
name|ttyline
index|[
name|MAXTTYS
index|]
condition|)
name|prexit
argument_list|(
literal|"%a: too many ttys in /dev\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|.
name|d_name
index|[
literal|0
index|]
operator|==
literal|'c'
condition|)
block|{
name|lp
operator|->
name|l_name
index|[
literal|0
index|]
operator|=
literal|'c'
expr_stmt|;
name|lp
operator|->
name|l_name
index|[
literal|1
index|]
operator|=
literal|'o'
expr_stmt|;
block|}
else|else
block|{
name|lp
operator|->
name|l_name
index|[
literal|0
index|]
operator|=
name|dir
operator|.
name|d_name
index|[
literal|3
index|]
expr_stmt|;
name|lp
operator|->
name|l_name
index|[
literal|1
index|]
operator|=
name|dir
operator|.
name|d_name
index|[
literal|4
index|]
expr_stmt|;
block|}
name|stat
argument_list|(
name|dir
operator|.
name|d_name
argument_list|,
operator|&
name|sbuf
argument_list|)
expr_stmt|;
name|lp
operator|->
name|l_dev
operator|=
name|sbuf
operator|.
name|st_rdev
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
operator|&
name|cswitch
index|[
name|major
argument_list|(
name|sbuf
operator|.
name|st_rdev
argument_list|)
index|]
operator|.
name|d_ttys
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lp
operator|->
name|l_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|lp
operator|->
name|l_addr
argument_list|)
argument_list|)
expr_stmt|;
name|lp
operator|->
name|l_addr
operator|+=
name|minor
argument_list|(
name|sbuf
operator|.
name|st_rdev
argument_list|)
expr_stmt|;
name|lp
operator|++
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ttysetup
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|ttyline
modifier|*
name|lp
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|union
name|ttyptr
modifier|*
name|tp
decl_stmt|;
name|struct
name|tty
name|tty
decl_stmt|;
for|for
control|(
name|lp
operator|=
name|info
operator|.
name|ttyline
init|;
name|lp
operator|->
name|l_name
index|[
literal|0
index|]
condition|;
name|lp
operator|++
control|)
block|{
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|lp
operator|->
name|l_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|kmem
argument_list|,
operator|&
name|tty
argument_list|,
sizeof|sizeof
name|tty
argument_list|)
operator|!=
sizeof|sizeof
name|tty
condition|)
name|prexit
argument_list|(
literal|"%a: read error in kmem\n"
argument_list|)
expr_stmt|;
name|lp
operator|->
name|l_pgrp
operator|=
name|tty
operator|.
name|t_pgrp
expr_stmt|;
if|if
condition|(
name|Tflag
condition|)
name|printf
argument_list|(
literal|"tty%-.2s: dev:%2d,%2d addr:%6x, rawq:%4d, canq:%d, outq:%4d, pgrp:%5d\n"
argument_list|,
name|lp
operator|->
name|l_name
argument_list|,
name|major
argument_list|(
name|lp
operator|->
name|l_dev
argument_list|)
argument_list|,
name|minor
argument_list|(
name|lp
operator|->
name|l_dev
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|lp
operator|->
name|l_addr
argument_list|)
argument_list|,
name|tty
operator|.
name|t_rawq
operator|.
name|c_cc
argument_list|,
name|tty
operator|.
name|t_canq
operator|.
name|c_cc
argument_list|,
name|tty
operator|.
name|t_outq
operator|.
name|c_cc
argument_list|,
name|tty
operator|.
name|t_pgrp
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CHAOS
name|mkchttys
argument_list|(
name|lp
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* now fix up specified ttys */
for|for
control|(
name|tp
operator|=
operator|&
name|ttys
index|[
literal|0
index|]
init|;
name|tp
operator|<
name|pttys
condition|;
name|tp
operator|++
control|)
block|{
for|for
control|(
name|lp
operator|=
name|info
operator|.
name|ttyline
init|;
name|lp
operator|->
name|l_name
index|[
literal|0
index|]
condition|;
name|lp
operator|++
control|)
if|if
condition|(
name|strcmpn
argument_list|(
name|tp
operator|->
name|ty_ptr
argument_list|,
name|lp
operator|->
name|l_name
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tp
operator|->
name|ty_line
operator|=
name|lp
expr_stmt|;
goto|goto
name|cont2
goto|;
block|}
name|prexit
argument_list|(
literal|"%a: unknown tty name: %c\n"
argument_list|,
name|tp
operator|->
name|ty_ptr
argument_list|)
expr_stmt|;
name|cont2
label|:
empty_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * Determine which procs are needed for the printout  * and add these to a list of needed processes (plist)  */
end_comment

begin_macro
name|needed
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|proc
modifier|*
name|p
decl_stmt|,
modifier|*
name|pp
decl_stmt|;
specifier|register
name|struct
name|text
modifier|*
name|tp
decl_stmt|;
name|struct
name|ttyline
modifier|*
name|lp
decl_stmt|;
name|int
name|ok
decl_stmt|;
name|plist
operator|=
literal|0
expr_stmt|;
name|nswapped
operator|=
name|ntotal
operator|=
name|nbusy
operator|=
name|nloaded
operator|=
literal|0
expr_stmt|;
name|kswapped
operator|=
name|ktotal
operator|=
name|kbusy
operator|=
name|kloaded
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|tp
operator|=
name|text
init|;
name|tp
operator|<
name|text
operator|+
name|ntext
condition|;
name|tp
operator|++
control|)
if|if
condition|(
name|tp
operator|->
name|x_count
condition|)
block|{
name|ktotal
operator|+=
name|tp
operator|->
name|x_size
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tp
operator|->
name|x_ccount
operator|)
condition|)
name|kswapped
operator|+=
name|tp
operator|->
name|x_size
expr_stmt|;
block|}
for|for
control|(
name|p
operator|=
name|proc
init|;
name|p
operator|<
name|proc
operator|+
name|nproc
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|p
operator|->
name|p_stat
condition|)
continue|continue;
if|if
condition|(
name|p
operator|->
name|p_textp
condition|)
name|p
operator|->
name|p_textp
operator|=
operator|&
name|text
index|[
name|p
operator|->
name|p_textp
operator|-
name|ktext
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_pptr
condition|)
block|{
name|p
operator|->
name|p_pptr
operator|=
operator|&
name|proc
index|[
name|p
operator|->
name|p_pptr
operator|-
name|kproc
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_pptr
operator|<
name|proc
operator|||
name|p
operator|->
name|p_pptr
operator|>=
operator|&
name|proc
index|[
name|nproc
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"proc %d bad pptr\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|)
expr_stmt|;
name|p
operator|->
name|p_pptr
operator|=
name|proc
expr_stmt|;
block|}
block|}
else|else
name|p
operator|->
name|p_pptr
operator|=
name|proc
expr_stmt|;
block|}
for|for
control|(
name|p
operator|=
operator|&
name|proc
index|[
literal|0
index|]
init|;
name|p
operator|<
operator|&
name|proc
index|[
name|nproc
index|]
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|p
operator|->
name|p_stat
condition|)
continue|continue;
name|ntotal
operator|++
expr_stmt|;
name|ktotal
operator|+=
name|procsize
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_flag
operator|!=
name|SZOMB
condition|)
if|if
condition|(
name|p
operator|->
name|p_flag
operator|&
name|SLOAD
condition|)
block|{
name|nloaded
operator|++
expr_stmt|;
name|kloaded
operator|+=
name|procsize
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tp
operator|=
name|p
operator|->
name|p_textp
operator|)
operator|&&
name|tp
operator|->
name|x_count
condition|)
block|{
name|tp
operator|->
name|x_count
operator|=
literal|0
expr_stmt|;
name|kloaded
operator|+=
name|tp
operator|->
name|x_size
expr_stmt|;
block|}
block|}
else|else
block|{
name|nswapped
operator|++
expr_stmt|;
name|kswapped
operator|+=
name|procsize
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|ok
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_stat
operator|==
name|SRUN
operator|||
name|p
operator|->
name|p_stat
operator|==
name|SSLEEP
operator|&&
operator|(
name|p
operator|->
name|p_pri
operator|<
name|PZERO
operator|&&
name|p
operator|->
name|p_pid
operator|>
name|MSPID
operator|)
condition|)
block|{
name|nbusy
operator|++
expr_stmt|;
name|kbusy
operator|+=
name|procsize
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tp
operator|=
name|p
operator|->
name|p_textp
operator|)
operator|&&
name|tp
operator|->
name|x_ccount
condition|)
block|{
name|tp
operator|->
name|x_ccount
operator|=
literal|0
expr_stmt|;
name|kbusy
operator|+=
name|tp
operator|->
name|x_size
expr_stmt|;
block|}
if|if
condition|(
name|Bflag
condition|)
name|ok
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|nflag
condition|)
continue|continue;
if|if
condition|(
name|zflag
operator|&&
name|p
operator|->
name|p_stat
operator|==
name|SZOMB
condition|)
name|ok
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|sflag
operator|&&
name|p
operator|->
name|p_stat
operator|==
name|SSTOP
condition|)
name|ok
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|select
operator|==
literal|0
operator|&&
name|mypid
operator|&&
name|p
operator|->
name|p_pid
operator|==
name|mypid
condition|)
continue|continue;
if|if
condition|(
name|p
operator|->
name|p_pgrp
operator|==
literal|0
condition|)
if|if
condition|(
name|xflag
condition|)
name|ok
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|nxflag
condition|)
continue|continue;
if|if
condition|(
name|dflag
operator|&&
name|p
operator|->
name|p_pgrp
operator|!=
literal|0
operator|&&
operator|(
name|p
operator|->
name|p_flag
operator|&
name|SDETACH
operator|)
operator|!=
literal|0
condition|)
name|ok
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|aflag
operator|&&
name|xflag
operator|&&
name|p
operator|->
name|p_pgrp
operator|!=
literal|0
operator|&&
operator|(
name|p
operator|->
name|p_flag
operator|&
name|SDETACH
operator|)
operator|==
literal|0
operator|&&
name|p
operator|->
name|p_pptr
operator|==
operator|&
name|proc
index|[
literal|1
index|]
condition|)
name|ok
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|puids
operator|!=
name|uids
condition|)
block|{
specifier|register
name|union
name|numptr
modifier|*
name|ip
decl_stmt|;
for|for
control|(
name|pp
operator|=
name|p
init|;
name|pp
operator|>
operator|&
name|proc
index|[
literal|1
index|]
condition|;
name|pp
operator|=
name|pp
operator|->
name|p_pptr
control|)
for|for
control|(
name|ip
operator|=
name|uids
init|;
name|ip
operator|<
name|puids
condition|;
name|ip
operator|++
control|)
if|if
condition|(
operator|(
name|pp
operator|->
name|p_uid
operator|&
literal|0377
operator|)
operator|==
name|ip
operator|->
name|nm_int
condition|)
block|{
name|ok
operator|=
name|TRUE
expr_stmt|;
goto|goto
name|uidok
goto|;
block|}
block|}
name|uidok
label|:
if|if
condition|(
name|pgrps
operator|!=
name|grps
condition|)
block|{
specifier|register
name|union
name|numptr
modifier|*
name|ip
decl_stmt|;
for|for
control|(
name|pp
operator|=
name|p
init|;
name|pp
operator|>
operator|&
name|proc
index|[
literal|1
index|]
condition|;
name|pp
operator|=
name|pp
operator|->
name|p_pptr
control|)
for|for
control|(
name|ip
operator|=
name|grps
init|;
name|ip
operator|<
name|pgrps
condition|;
name|ip
operator|++
control|)
if|if
condition|(
name|pp
operator|->
name|p_pgrp
operator|==
name|ip
operator|->
name|nm_int
condition|)
block|{
name|ok
operator|=
name|TRUE
expr_stmt|;
goto|goto
name|pgrpok
goto|;
block|}
block|}
name|pgrpok
label|:
if|if
condition|(
name|ppids
operator|!=
name|pids
condition|)
block|{
specifier|register
name|union
name|numptr
modifier|*
name|ip
decl_stmt|;
for|for
control|(
name|ip
operator|=
name|pids
init|;
name|ip
operator|<
name|ppids
condition|;
name|ip
operator|++
control|)
if|if
condition|(
name|ip
operator|->
name|nm_int
operator|==
name|p
operator|->
name|p_pid
condition|)
block|{
name|ok
operator|=
name|TRUE
expr_stmt|;
goto|goto
name|procok
goto|;
block|}
block|}
name|procok
label|:
if|if
condition|(
name|select
operator|&&
name|pttys
operator|==
name|ttys
operator|&&
operator|!
name|fflag
operator|&&
operator|!
name|bflag
operator|&&
operator|!
name|ok
condition|)
continue|continue;
if|if
condition|(
name|getu
argument_list|(
name|p
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|static
name|struct
name|procinfo
name|fakep
init|=
block|{
literal|"--no upage--"
block|,
operator|&
name|notty
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|select
operator|&&
operator|!
name|ok
condition|)
continue|continue;
name|pinfo
argument_list|(
name|p
argument_list|)
operator|=
operator|&
name|fakep
expr_stmt|;
goto|goto
name|putonlist
goto|;
block|}
if|if
condition|(
name|pttys
operator|!=
name|ttys
operator|&&
name|p
operator|->
name|p_pgrp
operator|!=
literal|0
condition|)
block|{
name|union
name|ttyptr
modifier|*
name|ip
decl_stmt|;
for|for
control|(
name|ip
operator|=
name|ttys
init|;
name|ip
operator|<
name|pttys
condition|;
name|ip
operator|++
control|)
if|if
condition|(
name|p
operator|->
name|p_pgrp
operator|&&
name|p
operator|->
name|p_pgrp
operator|==
name|ip
operator|->
name|ty_line
operator|->
name|l_pgrp
operator|||
name|p
operator|->
name|p_stat
operator|==
name|SSLEEP
operator|&&
name|p
operator|->
name|p_wchan
operator|>=
operator|(
name|char
operator|*
operator|)
name|ip
operator|->
name|ty_line
operator|->
name|l_addr
operator|&&
name|p
operator|->
name|p_wchan
operator|<
operator|(
name|char
operator|*
operator|)
name|ip
operator|->
name|ty_line
operator|->
name|l_addr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tty
argument_list|)
operator|||
name|u
operator|.
name|u_ttyd
operator|==
name|ip
operator|->
name|ty_line
operator|->
name|l_dev
condition|)
block|{
name|ok
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|p
operator|->
name|p_pgrp
operator|==
literal|0
condition|)
name|lp
operator|=
operator|&
name|notty
expr_stmt|;
else|else
block|{
for|for
control|(
name|lp
operator|=
name|info
operator|.
name|ttyline
init|;
name|lp
operator|->
name|l_name
index|[
literal|0
index|]
operator|!=
literal|0
condition|;
name|lp
operator|++
control|)
if|if
condition|(
name|lp
operator|->
name|l_dev
operator|==
name|u
operator|.
name|u_ttyd
condition|)
break|break;
if|if
condition|(
name|lp
operator|->
name|l_name
index|[
literal|0
index|]
operator|==
literal|0
condition|)
name|lp
operator|=
operator|&
name|notty
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|->
name|p_pptr
operator|!=
operator|&
name|proc
index|[
literal|1
index|]
condition|)
block|{
if|if
condition|(
name|fflag
operator|&&
name|p
operator|->
name|p_pgrp
operator|==
name|lp
operator|->
name|l_pgrp
condition|)
name|ok
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|bflag
operator|&&
name|p
operator|->
name|p_pgrp
operator|!=
name|lp
operator|->
name|l_pgrp
operator|&&
operator|(
name|p
operator|->
name|p_flag
operator|&
name|SDETACH
operator|)
operator|==
literal|0
operator|&&
name|p
operator|->
name|p_stat
operator|!=
name|SSTOP
condition|)
name|ok
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|select
operator|&&
operator|!
name|ok
condition|)
continue|continue;
name|pinfo
argument_list|(
name|p
argument_list|)
operator|=
operator|(
expr|struct
name|procinfo
operator|*
operator|)
name|getcore
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|procinfo
argument_list|)
argument_list|)
expr_stmt|;
name|pinfo
argument_list|(
name|p
argument_list|)
operator|->
name|pi_time
operator|=
name|u
operator|.
name|u_vm
operator|.
name|vm_utime
operator|+
name|u
operator|.
name|u_vm
operator|.
name|vm_stime
expr_stmt|;
name|pinfo
argument_list|(
name|p
argument_list|)
operator|->
name|pi_tty
operator|=
name|lp
expr_stmt|;
name|pinfo
argument_list|(
name|p
argument_list|)
operator|->
name|pi_cmd
operator|=
name|getcmd
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|putonlist
label|:
comment|/* we have a needed proc! */
name|p
operator|->
name|p_next
operator|=
name|plist
expr_stmt|;
name|plist
operator|=
name|p
expr_stmt|;
name|p
operator|->
name|p_son
operator|=
name|p
operator|->
name|p_bro
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * mktree - sort the needed processes by subtree and at the top by user  */
end_comment

begin_macro
name|mktree
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|proc
modifier|*
name|p
decl_stmt|,
modifier|*
name|pp
decl_stmt|,
modifier|*
name|lp
decl_stmt|;
name|struct
name|proc
modifier|*
name|op
decl_stmt|;
name|struct
name|proc
name|proot
decl_stmt|;
name|proot
operator|.
name|p_bro
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|p
operator|=
name|plist
init|;
name|p
condition|;
name|p
operator|=
name|p
operator|->
name|p_next
control|)
block|{
comment|/* for all needed processes */
if|if
condition|(
name|p
operator|->
name|p_pptr
operator|>
operator|&
name|proc
index|[
literal|1
index|]
condition|)
block|{
for|for
control|(
name|pp
operator|=
name|plist
init|;
name|pp
condition|;
name|pp
operator|=
name|pp
operator|->
name|p_next
control|)
if|if
condition|(
name|pp
operator|==
name|p
operator|->
name|p_pptr
condition|)
block|{
comment|/* if my parent */
if|if
condition|(
name|lp
operator|=
name|pp
operator|->
name|p_son
condition|)
block|{
comment|/* if siblings */
for|for
control|(
name|op
operator|=
literal|0
init|;
name|lp
operator|&&
name|lp
operator|->
name|p_pid
operator|<
name|p
operator|->
name|p_pid
condition|;
name|lp
operator|=
operator|(
name|op
operator|=
name|lp
operator|)
operator|->
name|p_bro
control|)
empty_stmt|;
if|if
condition|(
name|op
condition|)
block|{
name|p
operator|->
name|p_bro
operator|=
name|lp
expr_stmt|;
name|op
operator|->
name|p_bro
operator|=
name|p
expr_stmt|;
break|break;
block|}
block|}
name|p
operator|->
name|p_bro
operator|=
name|lp
expr_stmt|;
comment|/* here if first or only */
name|pp
operator|->
name|p_son
operator|=
name|p
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|pp
condition|)
comment|/* if we found the parent */
continue|continue;
block|}
comment|/* we have a top level process, sort into top level list */
for|for
control|(
name|pp
operator|=
operator|(
name|lp
operator|=
operator|&
name|proot
operator|)
operator|->
name|p_bro
init|;
name|pp
condition|;
name|pp
operator|=
operator|(
name|lp
operator|=
name|pp
operator|)
operator|->
name|p_bro
control|)
if|if
condition|(
operator|(
name|p
operator|->
name|p_uid
operator|&
literal|0377
operator|)
operator|<
operator|(
name|pp
operator|->
name|p_uid
operator|&
literal|0377
operator|)
operator|||
operator|(
name|p
operator|->
name|p_uid
operator|&
literal|0377
operator|)
operator|==
operator|(
name|pp
operator|->
name|p_uid
operator|&
literal|0377
operator|)
operator|&&
name|p
operator|->
name|p_pid
operator|<
name|pp
operator|->
name|p_pid
condition|)
break|break;
name|p
operator|->
name|p_bro
operator|=
name|lp
operator|->
name|p_bro
expr_stmt|;
name|lp
operator|->
name|p_bro
operator|=
name|p
expr_stmt|;
block|}
name|plist
operator|=
name|proot
operator|.
name|p_bro
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|action
argument_list|(
name|p
argument_list|,
name|md
argument_list|)
specifier|register
expr|struct
name|proc
operator|*
name|p
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|md
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|p
condition|)
block|{
name|printp
argument_list|(
name|p
argument_list|,
name|md
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_son
condition|)
name|action
argument_list|(
name|p
operator|->
name|p_son
argument_list|,
name|md
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_bro
condition|)
name|action
argument_list|(
name|p
operator|->
name|p_bro
argument_list|,
name|md
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * Pretty print the output according to the switches.  */
end_comment

begin_expr_stmt
name|printp
argument_list|(
name|p
argument_list|,
name|md
argument_list|)
specifier|register
expr|struct
name|proc
operator|*
name|p
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|cp1
decl_stmt|;
name|char
name|stat
index|[
literal|10
index|]
decl_stmt|;
specifier|static
name|int
name|lastuid
decl_stmt|;
specifier|static
name|char
modifier|*
name|statnames
index|[]
init|=
block|{
literal|"Unk "
block|,
literal|"Wait"
block|,
literal|"Wait"
block|,
literal|"Run "
block|,
literal|"Init"
block|,
literal|"Exit"
block|,
literal|"Stop"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|heading
condition|)
block|{
name|heading
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"Ty User     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|lflag
condition|)
block|{
name|printf
argument_list|(
literal|"Stat"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|" Flgs Nice Pri "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Memory-kb  Time Wait?  "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Aflag
condition|)
name|printf
argument_list|(
literal|"Address Proc.  Clock Alarm "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Sflag
condition|)
name|printf
argument_list|(
literal|"Size  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Gflag
condition|)
name|printf
argument_list|(
literal|"Group "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Proc#  Command\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%.2s%c"
argument_list|,
name|pinfo
argument_list|(
name|p
argument_list|)
operator|->
name|pi_tty
operator|->
name|l_name
argument_list|,
name|p
operator|->
name|p_pgrp
operator|==
literal|0
condition|?
literal|' '
else|:
name|p
operator|->
name|p_flag
operator|&
name|SDETACH
condition|?
literal|'_'
else|:
name|p
operator|->
name|p_pgrp
operator|==
name|pinfo
argument_list|(
name|p
argument_list|)
operator|->
name|pi_tty
operator|->
name|l_pgrp
condition|?
literal|'.'
else|:
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|md
operator|==
literal|0
condition|)
block|{
name|lastuid
operator|=
name|p
operator|->
name|p_uid
operator|&
literal|0377
expr_stmt|;
name|cp
operator|=
name|info
operator|.
name|unames
index|[
name|lastuid
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|cp
condition|)
name|printf
argument_list|(
literal|"%-8.8s "
argument_list|,
name|cp
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"user%-4.4d "
argument_list|,
name|lastuid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|md
operator|>
literal|8
condition|)
name|md
operator|=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"%*s*"
argument_list|,
name|md
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|p_uid
operator|&
literal|0377
operator|)
operator|!=
name|lastuid
condition|)
block|{
comment|/* setuid process! */
name|lastuid
operator|=
name|p
operator|->
name|p_uid
operator|&
literal|0377
expr_stmt|;
name|cp
operator|=
name|info
operator|.
name|unames
index|[
name|lastuid
index|]
expr_stmt|;
block|}
else|else
name|cp
operator|=
literal|""
expr_stmt|;
name|md
operator|=
literal|8
operator|-
name|md
expr_stmt|;
name|printf
argument_list|(
literal|"%-*.*s"
argument_list|,
name|md
argument_list|,
name|md
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lflag
condition|)
block|{
name|cp
operator|=
name|statnames
index|[
name|p
operator|->
name|p_stat
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_flag
operator|&
name|SLOAD
condition|)
block|{
for|for
control|(
name|cp1
operator|=
name|stat
init|;
operator|*
name|cp1
operator|=
operator|*
name|cp
condition|;
name|cp1
operator|++
operator|,
name|cp
operator|++
control|)
if|if
condition|(
operator|*
name|cp
operator|>=
literal|'a'
operator|&&
operator|*
name|cp
operator|<=
literal|'z'
condition|)
operator|*
name|cp1
operator|-=
literal|'a'
operator|-
literal|'A'
expr_stmt|;
name|cp
operator|=
name|stat
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%-4.4s "
argument_list|,
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|cp
operator|=
name|stat
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_flag
operator|&
name|SSYS
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'U'
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_flag
operator|&
name|SLOCK
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'L'
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_flag
operator|&
name|STRC
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'T'
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_flag
operator|&
name|SWTED
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'W'
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_flag
operator|&
name|SSWAP
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'S'
expr_stmt|;
while|while
condition|(
name|cp
operator|<
operator|&
name|stat
index|[
literal|5
index|]
condition|)
operator|*
name|cp
operator|++
operator|=
literal|' '
expr_stmt|;
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"%-4.4s "
argument_list|,
name|stat
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_nice
operator|!=
name|NZERO
condition|)
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|p
operator|->
name|p_nice
operator|-
name|NZERO
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"    "
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_stat
operator|!=
name|SZOMB
condition|)
name|printf
argument_list|(
literal|"%4d "
argument_list|,
name|p
operator|->
name|p_pri
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|p_stat
operator|!=
name|SZOMB
condition|)
block|{
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|msize
argument_list|(
name|procsize
argument_list|(
name|p
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_textp
condition|)
name|printf
argument_list|(
literal|"+%4d "
argument_list|,
name|msize
argument_list|(
name|p
operator|->
name|p_textp
operator|->
name|x_size
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"      "
argument_list|)
expr_stmt|;
name|prcpu
argument_list|(
name|pinfo
argument_list|(
name|p
argument_list|)
operator|->
name|pi_time
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"                "
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|p_stat
operator|!=
name|SZOMB
operator|&&
name|p
operator|->
name|p_stat
operator|!=
name|SRUN
operator|&&
name|p
operator|->
name|p_stat
operator|!=
name|SSTOP
condition|)
if|if
condition|(
operator|!
name|Wflag
operator|&&
operator|(
name|cp
operator|=
name|waitingfor
argument_list|(
name|p
argument_list|)
operator|)
condition|)
name|printf
argument_list|(
literal|"%-6.6s "
argument_list|,
name|cp
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%6x "
argument_list|,
name|ABS
argument_list|(
operator|(
name|int
operator|)
name|p
operator|->
name|p_wchan
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"       "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Aflag
condition|)
name|printf
argument_list|(
literal|"%6x %6x %6d%6d "
argument_list|,
name|p
operator|->
name|p_addr
argument_list|,
operator|(
name|p
operator|-
name|proc
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|proc
argument_list|)
operator|+
name|info
operator|.
name|kaddr
index|[
name|aproc
index|]
argument_list|,
name|p
operator|->
name|p_time
argument_list|,
name|p
operator|->
name|p_clktim
argument_list|)
expr_stmt|;
if|if
condition|(
name|Sflag
condition|)
name|printf
argument_list|(
literal|"%5x "
argument_list|,
name|procsize
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Gflag
condition|)
name|printf
argument_list|(
literal|"%5D "
argument_list|,
name|p
operator|->
name|p_pgrp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%5D  "
argument_list|,
name|p
operator|->
name|p_pid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wflag
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|pinfo
argument_list|(
name|p
argument_list|)
operator|->
name|pi_cmd
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%-.*s\n"
argument_list|,
name|arglength
argument_list|,
name|pinfo
argument_list|(
name|p
argument_list|)
operator|->
name|pi_cmd
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* print cpu time */
end_comment

begin_macro
name|prcpu
argument_list|(
argument|time
argument_list|)
end_macro

begin_decl_stmt
name|long
name|time
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|unsigned
name|i
decl_stmt|;
if|if
condition|(
name|time
operator|<
literal|0
condition|)
name|printf
argument_list|(
literal|" ---- "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|time
operator|<
operator|(
name|long
operator|)
name|hz
operator|*
literal|60
operator|*
literal|10
condition|)
comment|/* less than 10 minutes */
name|printf
argument_list|(
literal|"%3d.%1d "
argument_list|,
call|(
name|int
call|)
argument_list|(
name|time
operator|/
name|hz
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
name|time
operator|%
name|hz
operator|/
operator|(
name|hz
operator|/
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|time
operator|<
operator|(
name|long
operator|)
name|hz
operator|*
literal|60
operator|*
literal|60
operator|*
literal|10
condition|)
comment|/* less than 10 hours */
name|printf
argument_list|(
literal|"%3d M "
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|time
operator|+
operator|(
name|hz
operator|*
literal|60
operator|)
operator|/
literal|2
operator|)
operator|/
operator|(
name|hz
operator|*
literal|60
operator|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|i
operator|=
operator|(
name|time
operator|+
operator|(
operator|(
name|long
operator|)
name|hz
operator|*
literal|60
operator|*
literal|60
operator|)
operator|/
literal|2
operator|)
operator|/
operator|(
operator|(
name|long
operator|)
name|hz
operator|*
literal|60
operator|*
literal|60
operator|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|1000
condition|)
name|printf
argument_list|(
literal|"%3d H "
argument_list|,
name|i
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" ---- "
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Determine what a process is waiting for and describe it. */
end_comment

begin_function
name|char
modifier|*
name|waitingfor
parameter_list|(
name|p
parameter_list|)
specifier|register
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
specifier|register
name|caddr_t
name|w
decl_stmt|;
specifier|register
name|struct
name|ttyline
modifier|*
name|lp
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|w
operator|=
name|p
operator|->
name|p_wchan
expr_stmt|;
if|if
condition|(
name|w
operator|==
operator|(
name|caddr_t
operator|)
literal|0
condition|)
return|return
literal|"null"
return|;
if|if
condition|(
name|w
operator|>=
operator|(
name|char
operator|*
operator|)
name|kproc
operator|&&
name|w
operator|<
operator|(
name|char
operator|*
operator|)
operator|(
name|kproc
operator|+
name|nproc
operator|)
condition|)
return|return
literal|"child"
return|;
if|if
condition|(
name|w
operator|>=
operator|(
name|char
operator|*
operator|)
name|swbuf
operator|&&
name|w
operator|<
operator|(
name|char
operator|*
operator|)
operator|(
name|swbuf
operator|+
name|nswbuf
operator|)
condition|)
return|return
literal|"swap"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|arswbuf
index|]
condition|)
return|return
literal|"rswap"
return|;
if|if
condition|(
name|w
operator|>=
operator|(
name|char
operator|*
operator|)
name|buf
operator|&&
name|w
operator|<
operator|(
name|char
operator|*
operator|)
operator|(
name|buf
operator|+
name|nbuf
operator|)
condition|)
return|return
literal|"diskio"
return|;
if|if
condition|(
name|w
operator|>=
name|info
operator|.
name|kaddr
index|[
name|afile
index|]
operator|&&
name|w
operator|<
name|info
operator|.
name|kaddr
index|[
name|afile
index|]
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|file
argument_list|)
operator|*
name|nfile
condition|)
return|return
literal|"file"
return|;
if|if
condition|(
name|w
operator|>=
operator|(
name|char
operator|*
operator|)
name|inode
operator|&&
name|w
operator|<
operator|(
name|char
operator|*
operator|)
operator|(
name|inode
operator|+
name|ninode
operator|)
condition|)
switch|switch
condition|(
operator|(
name|w
operator|-
operator|(
name|char
operator|*
operator|)
name|inode
operator|)
operator|%
sizeof|sizeof
argument_list|(
expr|struct
name|inode
argument_list|)
condition|)
block|{
case|case
literal|1
case|:
return|return
literal|"wpipe"
return|;
case|case
literal|2
case|:
return|return
literal|"rpipe"
return|;
case|case
literal|3
case|:
return|return
literal|"mutex"
return|;
case|case
operator|(
name|int
operator|)
operator|&
operator|(
operator|(
expr|struct
name|inode
operator|*
operator|)
literal|0
operator|)
operator|->
name|i_un
operator|.
name|i_group
operator|.
name|g_datq
case|:
return|return
literal|"rmux"
return|;
default|default:
return|return
literal|"inode"
return|;
block|}
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|achtbuf
index|]
condition|)
return|return
literal|"tapecn"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|ahpbuf
index|]
condition|)
return|return
literal|"rpdisk"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|ark7
index|]
condition|)
return|return
literal|"rkdisk"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|arhtbuf
index|]
condition|)
return|return
literal|"tapeio"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|alpdt
index|]
condition|)
return|return
literal|"printr"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|albolt
index|]
condition|)
return|return
literal|"lbolt"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|arunin
index|]
condition|)
return|return
literal|"runin"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|arunout
index|]
condition|)
return|return
literal|"runout"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|atout
index|]
condition|)
return|return
literal|"sleep"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|aipc
index|]
condition|)
return|return
literal|"ptrace"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|abfreeli
index|]
condition|)
return|return
literal|"buffer"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|amaplock
index|]
condition|)
return|return
literal|"ubmap"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|au
index|]
condition|)
return|return
literal|"pause"
return|;
if|if
condition|(
name|w
operator|==
name|info
operator|.
name|kaddr
index|[
name|achrfclist
index|]
condition|)
return|return
literal|"chrfc"
return|;
for|for
control|(
name|lp
operator|=
name|info
operator|.
name|ttyline
init|;
name|lp
operator|->
name|l_name
index|[
literal|0
index|]
condition|;
name|lp
operator|++
control|)
if|if
condition|(
name|w
operator|>=
operator|(
name|char
operator|*
operator|)
name|lp
operator|->
name|l_addr
operator|&&
name|w
operator|<
operator|(
name|char
operator|*
operator|)
name|lp
operator|->
name|l_addr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tty
argument_list|)
condition|)
block|{
define|#
directive|define
name|TTY0
value|((struct tty *)0)
switch|switch
condition|(
name|w
operator|-
operator|(
name|char
operator|*
operator|)
name|lp
operator|->
name|l_addr
condition|)
block|{
case|case
operator|(
name|int
operator|)
operator|&
name|TTY0
operator|->
name|t_rawq
case|:
name|cp
operator|=
literal|"rtty??"
expr_stmt|;
break|break;
case|case
operator|(
name|int
operator|)
operator|&
name|TTY0
operator|->
name|t_outq
case|:
name|cp
operator|=
literal|"wtty??"
expr_stmt|;
break|break;
case|case
operator|(
name|int
operator|)
operator|&
name|TTY0
operator|->
name|t_state
case|:
name|cp
operator|=
literal|"otty??"
expr_stmt|;
break|break;
default|default:
name|cp
operator|=
literal|"?tty??"
expr_stmt|;
block|}
name|cp
index|[
literal|4
index|]
operator|=
name|lp
operator|->
name|l_name
index|[
literal|0
index|]
expr_stmt|;
name|cp
index|[
literal|5
index|]
operator|=
name|lp
operator|->
name|l_name
index|[
literal|1
index|]
expr_stmt|;
return|return
name|cp
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|getu
argument_list|(
name|mproc
argument_list|)
specifier|register
expr|struct
name|proc
operator|*
name|mproc
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|struct
name|pte
modifier|*
name|pteaddr
decl_stmt|,
name|apte
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|ncl
decl_stmt|,
name|size
decl_stmt|;
name|size
operator|=
name|Sflag
condition|?
name|ctob
argument_list|(
name|UPAGES
argument_list|)
else|:
sizeof|sizeof
argument_list|(
expr|struct
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mproc
operator|->
name|p_flag
operator|&
name|SLOAD
operator|)
operator|==
literal|0
condition|)
block|{
name|lseek
argument_list|(
name|swap
argument_list|,
operator|(
name|long
operator|)
name|ctob
argument_list|(
name|mproc
operator|->
name|p_swaddr
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|swap
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|user
operator|.
name|user
argument_list|,
name|size
argument_list|)
operator|!=
name|size
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%a: cant read u for pid %d from %s\n"
argument_list|,
name|mproc
operator|->
name|p_pid
argument_list|,
name|swapf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|pteaddr
operator|=
operator|&
name|Usrptmap
index|[
name|btokmx
argument_list|(
name|mproc
operator|->
name|p_p0br
argument_list|)
operator|+
name|mproc
operator|->
name|p_szpt
operator|-
literal|1
index|]
expr_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
call|(
name|long
call|)
argument_list|(
name|mflag
condition|?
name|ABS
argument_list|(
name|pteaddr
argument_list|)
else|:
operator|(
name|int
operator|)
name|pteaddr
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|kmem
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|apte
argument_list|,
sizeof|sizeof
argument_list|(
name|apte
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|apte
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%a: cant read indir pte to get u for pid %d from %s\n"
argument_list|,
name|mproc
operator|->
name|p_pid
argument_list|,
name|swapf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|lseek
argument_list|(
name|mem
argument_list|,
call|(
name|long
call|)
argument_list|(
name|ctob
argument_list|(
name|apte
operator|.
name|pg_pfnum
operator|+
literal|1
argument_list|)
operator|-
operator|(
name|UPAGES
operator|+
name|MAXARGPG
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|pte
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|mem
argument_list|,
operator|(
name|char
operator|*
operator|)
name|pagetable
argument_list|,
sizeof|sizeof
argument_list|(
name|pagetable
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|pagetable
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%a: cant read page table for u of pid %d from %s\n"
argument_list|,
name|mproc
operator|->
name|p_pid
argument_list|,
name|swapf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ncl
operator|=
operator|(
name|size
operator|+
name|NBPG
operator|*
name|CLSIZE
operator|-
literal|1
operator|)
operator|/
operator|(
name|NBPG
operator|*
name|CLSIZE
operator|)
expr_stmt|;
while|while
condition|(
operator|--
name|ncl
operator|>=
literal|0
condition|)
block|{
name|i
operator|=
name|ncl
operator|*
name|CLSIZE
expr_stmt|;
name|lseek
argument_list|(
name|mem
argument_list|,
operator|(
name|long
operator|)
name|ctob
argument_list|(
name|pagetable
index|[
name|MAXARGPG
operator|+
name|i
index|]
operator|.
name|pg_pfnum
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|mem
argument_list|,
name|user
operator|.
name|upages
index|[
name|i
index|]
argument_list|,
name|CLSIZE
operator|*
name|NBPG
argument_list|)
operator|!=
name|CLSIZE
operator|*
name|NBPG
condition|)
block|{
name|printf
argument_list|(
literal|"%a: cant read page %d of u of pid %d from %s\n"
argument_list|,
name|pagetable
index|[
name|MAXARGPG
operator|+
name|i
index|]
operator|.
name|pg_pfnum
argument_list|,
name|mproc
operator|->
name|p_pid
argument_list|,
name|memf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_function
name|char
modifier|*
name|getcmd
parameter_list|(
name|p
parameter_list|)
specifier|register
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
name|struct
name|pte
name|apte
decl_stmt|;
name|char
name|argbuf
index|[
name|MAXARGPG
operator|*
name|NBPG
index|]
decl_stmt|,
modifier|*
name|argptr
decl_stmt|;
specifier|register
name|int
modifier|*
name|ip
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|cp1
decl_stmt|;
name|int
name|cc
decl_stmt|,
name|nbad
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|p_stat
operator|==
name|SZOMB
condition|)
return|return
literal|"--Defunct--"
return|;
if|if
condition|(
operator|(
name|p
operator|->
name|p_flag
operator|&
name|SLOAD
operator|)
operator|==
literal|0
operator|&&
name|Fflag
condition|)
return|return
literal|"--Swapped--"
return|;
if|if
condition|(
name|p
operator|->
name|p_flag
operator|&
name|SSYS
condition|)
return|return
name|p
operator|->
name|p_pid
operator|==
literal|0
condition|?
literal|"UNIX Swapper"
else|:
name|p
operator|->
name|p_pid
operator|==
literal|2
condition|?
literal|"UNIX Pager"
else|:
literal|"UNIX"
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXARGPG
condition|;
name|i
operator|++
control|)
block|{
name|argptr
operator|=
operator|&
name|argbuf
index|[
operator|(
name|MAXARGPG
operator|-
literal|1
operator|-
name|i
operator|)
operator|*
name|NBPG
index|]
expr_stmt|;
name|apte
operator|=
name|pagetable
index|[
name|MAXARGPG
operator|-
literal|1
operator|-
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|p_flag
operator|&
name|SLOAD
operator|)
operator|&&
name|apte
operator|.
name|pg_fod
operator|==
literal|0
operator|&&
name|apte
operator|.
name|pg_pfnum
condition|)
block|{
name|lseek
argument_list|(
name|mem
argument_list|,
operator|(
name|long
operator|)
name|ctob
argument_list|(
name|apte
operator|.
name|pg_pfnum
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|mem
argument_list|,
name|argptr
argument_list|,
name|NBPG
argument_list|)
operator|!=
name|NBPG
condition|)
return|return
literal|"---Mem read error (args)---"
return|;
block|}
elseif|else
if|if
condition|(
name|Fflag
condition|)
goto|goto
name|cheap
goto|;
else|else
block|{
name|lseek
argument_list|(
name|swap
argument_list|,
operator|(
name|long
operator|)
name|ctob
argument_list|(
name|u
operator|.
name|u_smap
operator|.
name|dm_map
index|[
literal|0
index|]
operator|+
name|DMMIN
operator|-
literal|1
operator|-
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|swap
argument_list|,
name|argptr
argument_list|,
name|NBPG
argument_list|)
operator|!=
name|NBPG
condition|)
return|return
literal|"---Swap read error (args)---"
return|;
block|}
comment|/* Here block of stack is at argptr */
name|ip
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|argptr
index|[
name|NBPG
index|]
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
operator|*
operator|--
name|ip
operator|=
literal|0
expr_stmt|;
name|ip
operator|--
expr_stmt|;
block|}
while|while
condition|(
name|ip
operator|>
operator|(
name|int
operator|*
operator|)
name|argptr
operator|&&
operator|*
operator|--
name|ip
operator|!=
literal|0
condition|)
empty_stmt|;
if|if
condition|(
name|ip
operator|>
operator|(
name|int
operator|*
operator|)
name|argptr
operator|||
operator|*
name|ip
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|MAXARGPG
condition|)
block|{
name|cheap
label|:
name|argbuf
index|[
literal|0
index|]
operator|=
literal|'('
expr_stmt|;
name|strncpy
argument_list|(
operator|&
name|argbuf
index|[
literal|1
index|]
argument_list|,
name|u
operator|.
name|u_comm
argument_list|,
sizeof|sizeof
argument_list|(
name|u
operator|.
name|u_comm
argument_list|)
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|argbuf
argument_list|,
literal|")"
argument_list|)
expr_stmt|;
return|return
name|store
argument_list|(
name|argbuf
argument_list|)
return|;
block|}
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|ip
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\0'
condition|)
name|cp
operator|++
expr_stmt|;
name|nbad
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cp1
operator|=
name|cp
init|;
name|cp1
operator|<
operator|&
name|argbuf
index|[
name|MAXARGPG
operator|*
name|NBPG
index|]
condition|;
name|cp1
operator|++
control|)
block|{
name|cc
operator|=
operator|*
name|cp1
operator|&
literal|0177
expr_stmt|;
if|if
condition|(
name|cc
operator|==
literal|0
condition|)
operator|*
name|cp1
operator|=
literal|' '
expr_stmt|;
elseif|else
if|if
condition|(
name|cc
operator|<
literal|' '
operator|||
name|cc
operator|==
literal|0177
condition|)
block|{
if|if
condition|(
operator|++
name|nbad
operator|>=
literal|5
condition|)
block|{
operator|*
name|cp1
operator|++
operator|=
literal|' '
expr_stmt|;
break|break;
block|}
operator|*
name|cp1
operator|=
literal|'?'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|eflag
operator|&&
name|cc
operator|==
literal|'='
condition|)
block|{
operator|*
name|cp1
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|cp1
operator|>
name|cp
operator|&&
operator|*
operator|--
name|cp1
operator|!=
literal|' '
condition|)
operator|*
name|cp1
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
while|while
condition|(
operator|*
operator|--
name|cp1
operator|==
literal|' '
condition|)
operator|*
name|cp1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|wflag
operator|&&
operator|&
name|cp
index|[
name|arglength
index|]
operator|<
operator|(
name|char
operator|*
operator|)
operator|&
name|argbuf
index|[
name|MAXARGPG
operator|*
name|NBPG
operator|-
literal|1
index|]
condition|)
name|cp
index|[
name|arglength
index|]
operator|=
literal|0
expr_stmt|;
return|return
name|store
argument_list|(
name|cp
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Store a string in core for later use.  */
end_comment

begin_function
name|char
modifier|*
name|store
parameter_list|(
name|cp
parameter_list|)
name|char
modifier|*
name|cp
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|,
modifier|*
name|svdst
decl_stmt|;
name|src
operator|=
name|cp
expr_stmt|;
while|while
condition|(
operator|*
name|src
operator|++
condition|)
empty_stmt|;
name|svdst
operator|=
name|getcore
argument_list|(
name|src
operator|-
name|cp
argument_list|)
expr_stmt|;
name|dst
operator|=
name|svdst
expr_stmt|;
name|src
operator|=
name|cp
expr_stmt|;
while|while
condition|(
operator|*
name|dst
operator|++
operator|=
operator|*
name|src
operator|++
condition|)
empty_stmt|;
return|return
operator|(
name|svdst
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Allocate and return a pointer to the asked for amount of core  */
end_comment

begin_function
name|char
modifier|*
name|getcore
parameter_list|(
name|cnt
parameter_list|)
specifier|register
name|int
name|cnt
decl_stmt|;
block|{
specifier|static
name|char
modifier|*
name|corep
decl_stmt|;
specifier|register
name|char
modifier|*
name|ip
decl_stmt|;
specifier|register
name|int
name|incr
decl_stmt|;
name|char
modifier|*
name|sbrk
parameter_list|()
function_decl|;
if|if
condition|(
name|cnt
operator|>
name|core
condition|)
block|{
if|if
condition|(
name|coreinit
operator|==
literal|0
condition|)
block|{
name|coreinit
operator|++
expr_stmt|;
if|if
condition|(
name|topmem
condition|)
name|brk
argument_list|(
name|topmem
argument_list|)
expr_stmt|;
comment|/* after repeat!! */
else|else
name|topmem
operator|=
name|sbrk
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|corep
operator|=
name|topmem
expr_stmt|;
block|}
name|incr
operator|=
name|cnt
operator|>
literal|4096
condition|?
name|cnt
else|:
literal|4096
expr_stmt|;
if|if
condition|(
name|sbrk
argument_list|(
name|incr
argument_list|)
operator|==
literal|0
condition|)
name|prexit
argument_list|(
literal|"%a: out of memory!\n"
argument_list|)
expr_stmt|;
name|core
operator|+=
name|incr
expr_stmt|;
block|}
name|ip
operator|=
name|corep
expr_stmt|;
name|core
operator|-=
name|cnt
expr_stmt|;
name|corep
operator|+=
name|cnt
expr_stmt|;
return|return
operator|(
name|ip
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CHAOS
end_ifdef

begin_include
include|#
directive|include
file|"chunix/chsys.h"
end_include

begin_include
include|#
directive|include
file|<chaos/chaos.h>
end_include

begin_expr_stmt
name|mkchttys
argument_list|(
name|lp
argument_list|)
specifier|register
expr|struct
name|ttyline
operator|*
name|lp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|connection
modifier|*
modifier|*
name|cnp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|struct
name|tty
name|tty
decl_stmt|;
name|struct
name|connection
modifier|*
name|Chconntab
index|[
name|CHNCONNS
index|]
decl_stmt|;
name|struct
name|connection
name|conn
decl_stmt|;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|info
operator|.
name|kaddr
index|[
name|aChconntab
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|(
name|char
operator|*
operator|)
name|Chconntab
argument_list|,
sizeof|sizeof
argument_list|(
name|Chconntab
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|cnp
operator|=
name|Chconntab
init|;
name|cnp
operator|<
operator|&
name|Chconntab
index|[
name|CHNCONNS
index|]
condition|;
name|i
operator|++
operator|,
name|cnp
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|*
name|cnp
condition|)
continue|continue;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
operator|*
name|cnp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|conn
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|.
name|cn_flags
operator|&
name|CHTTY
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|long
operator|)
name|conn
operator|.
name|cn_ttyp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|kmem
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|tty
argument_list|,
sizeof|sizeof
argument_list|(
name|tty
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lp
operator|>=
operator|&
name|info
operator|.
name|ttyline
index|[
name|MAXTTYS
index|]
condition|)
name|prexit
argument_list|(
literal|"%a: too many ttys\n"
argument_list|)
expr_stmt|;
name|lp
operator|->
name|l_addr
operator|=
name|conn
operator|.
name|cn_ttyp
expr_stmt|;
name|lp
operator|->
name|l_pgrp
operator|=
name|tty
operator|.
name|t_pgrp
expr_stmt|;
name|lp
operator|->
name|l_dev
operator|=
name|tty
operator|.
name|t_dev
expr_stmt|;
name|lp
operator|->
name|l_name
index|[
literal|0
index|]
operator|=
literal|'C'
expr_stmt|;
name|lp
operator|->
name|l_name
index|[
literal|1
index|]
operator|=
name|i
operator|<
literal|10
condition|?
literal|'0'
operator|+
name|i
else|:
name|i
operator|-
literal|10
operator|<=
literal|'z'
operator|-
literal|'a'
condition|?
name|i
operator|-
literal|10
operator|+
literal|'a'
else|:
name|i
operator|-
literal|10
operator|-
operator|(
literal|'z'
operator|-
literal|'a'
operator|)
operator|+
literal|'A'
expr_stmt|;
if|if
condition|(
name|Tflag
condition|)
name|printf
argument_list|(
literal|"tty%-.2s: dev:%2d,%2d addr:%6x, rawq:%4d, canq:%d, outq:%4d, pgrp:%5d\n"
argument_list|,
name|lp
operator|->
name|l_name
argument_list|,
name|major
argument_list|(
name|lp
operator|->
name|l_dev
argument_list|)
argument_list|,
name|minor
argument_list|(
name|lp
operator|->
name|l_dev
argument_list|)
argument_list|,
name|ABS
argument_list|(
name|lp
operator|->
name|l_addr
argument_list|)
argument_list|,
name|tty
operator|.
name|t_rawq
operator|.
name|c_cc
argument_list|,
name|tty
operator|.
name|t_canq
operator|.
name|c_cc
argument_list|,
name|tty
operator|.
name|t_outq
operator|.
name|c_cc
argument_list|,
name|tty
operator|.
name|t_pgrp
argument_list|)
expr_stmt|;
name|lp
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


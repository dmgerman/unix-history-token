begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $XConsortium: XcmsCmap.c,v 1.11 91/07/25 01:08:28 rws Exp $" */
end_comment

begin_comment
comment|/*  * Code and supporting documentation (c) Copyright 1990 1991 Tektronix, Inc.  * 	All Rights Reserved  *   * This file is a component of an X Window System-specific implementation  * of Xcms based on the TekColor Color Management System.  Permission is  * hereby granted to use, copy, modify, sell, and otherwise distribute this  * software and its documentation for any purpose and without fee, provided  * that this copyright, permission, and disclaimer notice is reproduced in  * all copies of this software and in supporting documentation.  TekColor  * is a trademark of Tektronix, Inc.  *   * Tektronix makes no representation about the suitability of this software  * for any purpose.  It is provided "as is" and with all faults.  *   * TEKTRONIX DISCLAIMS ALL WARRANTIES APPLICABLE TO THIS SOFTWARE,  * INCLUDING THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A  * PARTICULAR PURPOSE.  IN NO EVENT SHALL TEKTRONIX BE LIABLE FOR ANY  * SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER  * RESULTING FROM LOSS OF USE, DATA, OR PROFITS, WHETHER IN AN ACTION OF  * CONTRACT, NEGLIGENCE, OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN  * CONNECTION WITH THE USE OR THE PERFORMANCE OF THIS SOFTWARE.  *  *  *	NAME  *		XcmsCmap.c - Client Colormap Management Routines  *  *	DESCRIPTION  *		Routines that store additional information about  *		colormaps being used by the X Client.  *  *  */
end_comment

begin_define
define|#
directive|define
name|NEED_EVENTS
end_define

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_include
include|#
directive|include
file|"Xcmsint.h"
end_include

begin_include
include|#
directive|include
file|"Xutil.h"
end_include

begin_comment
comment|/*  *      FORWARD DECLARATIONS  */
end_comment

begin_function_decl
name|XcmsCmapRec
modifier|*
name|_XcmsAddCmapRec
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|_XcmsFreeClientCmaps
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  *      LOCAL VARIABLES  */
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|CreateWindowStatus
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/************************************************************************  *									*  *			PRIVATE INTERFACES				*  *									*  ************************************************************************/
end_comment

begin_comment
comment|/*  *	NAME  *		CreateWindowErrorHandler  *  *	SYNOPSIS  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|CreateWindowErrorHandler
parameter_list|(
name|dpy
parameter_list|,
name|errorp
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|XErrorEvent
modifier|*
name|errorp
decl_stmt|;
comment|/*  *	DESCRIPTION  *		Error Hander used in CmapRecForColormap() to catch  *		errors occuring when creating a window with a foreign  *		colormap.  *  *	RETURNS  *		1  *  */
block|{
if|if
condition|(
name|errorp
operator|->
name|request_code
operator|==
name|X_CreateWindow
condition|)
block|{
name|CreateWindowStatus
operator|=
name|errorp
operator|->
name|error_code
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *	NAME  *		CmapRecForColormap  *  *	SYNOPSIS  */
end_comment

begin_function
specifier|static
name|XcmsCmapRec
modifier|*
name|CmapRecForColormap
parameter_list|(
name|dpy
parameter_list|,
name|cmap
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|Colormap
name|cmap
decl_stmt|;
comment|/*  *	DESCRIPTION  *		Find the corresponding XcmsCmapRec for cmap.  In not found  *		this routines attempts to create one.  *  *	RETURNS  *		Returns NULL if failed; otherwise the address to  *		the corresponding XcmsCmapRec.  *  */
block|{
name|XcmsCmapRec
modifier|*
name|pRec
decl_stmt|;
name|int
name|nScrn
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|XVisualInfo
name|visualTemplate
decl_stmt|;
comment|/* Template of the visual we want */
name|XVisualInfo
modifier|*
name|visualList
decl_stmt|;
comment|/* List for visuals that match */
name|int
name|nVisualsMatched
decl_stmt|;
comment|/* Number of visuals that match */
name|XSetWindowAttributes
name|windowAttr
decl_stmt|;
name|Window
name|tmpWindow
decl_stmt|;
name|int
function_decl|(
modifier|*
name|oldErrorHandler
function_decl|)
parameter_list|()
function_decl|;
for|for
control|(
name|pRec
operator|=
operator|(
name|XcmsCmapRec
operator|*
operator|)
name|dpy
operator|->
name|cms
operator|.
name|clientCmaps
init|;
name|pRec
operator|!=
name|NULL
condition|;
name|pRec
operator|=
name|pRec
operator|->
name|pNext
control|)
block|{
if|if
condition|(
name|pRec
operator|->
name|cmapID
operator|==
name|cmap
condition|)
block|{
return|return
operator|(
name|pRec
operator|)
return|;
block|}
block|}
comment|/*      * Can't find an XcmsCmapRec associated with cmap in our records.      * Let's try to see if its a default colormap      */
name|nScrn
operator|=
name|ScreenCount
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nScrn
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cmap
operator|==
name|DefaultColormap
argument_list|(
name|dpy
argument_list|,
name|i
argument_list|)
condition|)
block|{
comment|/* It is ... lets go ahead and store that info */
if|if
condition|(
operator|(
name|pRec
operator|=
name|_XcmsAddCmapRec
argument_list|(
name|dpy
argument_list|,
name|cmap
argument_list|,
name|RootWindow
argument_list|(
name|dpy
argument_list|,
name|i
argument_list|)
argument_list|,
name|DefaultVisual
argument_list|(
name|dpy
argument_list|,
name|i
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
operator|(
name|XcmsCmapRec
operator|*
operator|)
name|NULL
operator|)
return|;
block|}
name|pRec
operator|->
name|ccc
operator|=
name|XcmsCreateCCC
argument_list|(
name|dpy
argument_list|,
name|i
argument_list|,
comment|/* screenNumber */
name|DefaultVisual
argument_list|(
name|dpy
argument_list|,
name|i
argument_list|)
argument_list|,
operator|(
name|XcmsColor
operator|*
operator|)
name|NULL
argument_list|,
comment|/* clientWhitePt */
operator|(
name|XcmsCompressionProc
operator|)
name|NULL
argument_list|,
comment|/* gamutCompProc */
operator|(
name|XPointer
operator|)
name|NULL
argument_list|,
comment|/* gamutCompClientData */
operator|(
name|XcmsWhiteAdjustProc
operator|)
name|NULL
argument_list|,
comment|/* whitePtAdjProc */
operator|(
name|XPointer
operator|)
name|NULL
comment|/* whitePtAdjClientData */
argument_list|)
expr_stmt|;
return|return
operator|(
name|pRec
operator|)
return|;
block|}
block|}
comment|/*      * Nope, its not a default colormap, so it's probably a foreign color map      * of which we have no specific details.  Let's go through the      * rigorous process of finding this colormap:      *        for each screen      *            for each screen's visual types      *                create a window      *                attempt to set the window's colormap to cmap      *                if successful      *                    Add a CmapRec      *                    Create an XcmsCCC      *                    return the CmapRec      *                else      *                    continue      */
comment|/*      * Before we start into this ugly process, let's sync up.      */
name|XSync
argument_list|(
name|dpy
argument_list|,
name|False
argument_list|)
expr_stmt|;
comment|/*      * Setup Temporary Error Handler      */
name|oldErrorHandler
operator|=
name|XSetErrorHandler
argument_list|(
name|CreateWindowErrorHandler
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nScrn
condition|;
name|i
operator|++
control|)
block|{
name|visualTemplate
operator|.
name|screen
operator|=
name|i
expr_stmt|;
name|visualList
operator|=
name|XGetVisualInfo
argument_list|(
name|dpy
argument_list|,
name|VisualScreenMask
argument_list|,
operator|&
name|visualTemplate
argument_list|,
operator|&
name|nVisualsMatched
argument_list|)
expr_stmt|;
if|if
condition|(
name|nVisualsMatched
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
name|j
operator|=
literal|0
expr_stmt|;
name|windowAttr
operator|.
name|colormap
operator|=
name|cmap
expr_stmt|;
comment|/* 	 * Call routine that attempts to create a window with cmap 	 */
do|do
block|{
name|CreateWindowStatus
operator|=
name|Success
expr_stmt|;
name|tmpWindow
operator|=
name|XCreateWindow
argument_list|(
name|dpy
argument_list|,
name|RootWindow
argument_list|(
name|dpy
argument_list|,
name|i
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|,
operator|(
name|visualList
operator|+
name|j
operator|)
operator|->
name|depth
argument_list|,
name|CopyFromParent
argument_list|,
operator|(
name|visualList
operator|+
name|j
operator|)
operator|->
name|visual
argument_list|,
name|CWColormap
argument_list|,
operator|&
name|windowAttr
argument_list|)
expr_stmt|;
name|XSync
argument_list|(
name|dpy
argument_list|,
name|False
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|CreateWindowStatus
operator|!=
name|Success
operator|&&
operator|++
name|j
operator|<
name|nVisualsMatched
condition|)
do|;
comment|/* 	 * if successful 	 */
if|if
condition|(
name|CreateWindowStatus
operator|==
name|Success
condition|)
block|{
if|if
condition|(
operator|(
name|pRec
operator|=
name|_XcmsAddCmapRec
argument_list|(
name|dpy
argument_list|,
name|cmap
argument_list|,
name|tmpWindow
argument_list|,
operator|(
name|visualList
operator|+
name|j
operator|)
operator|->
name|visual
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
operator|(
name|XcmsCmapRec
operator|*
operator|)
name|NULL
operator|)
return|;
block|}
name|pRec
operator|->
name|ccc
operator|=
name|XcmsCreateCCC
argument_list|(
name|dpy
argument_list|,
name|i
argument_list|,
comment|/* screenNumber */
operator|(
name|visualList
operator|+
name|j
operator|)
operator|->
name|visual
argument_list|,
operator|(
name|XcmsColor
operator|*
operator|)
name|NULL
argument_list|,
comment|/* clientWhitePt */
operator|(
name|XcmsCompressionProc
operator|)
name|NULL
argument_list|,
comment|/* gamutCompProc */
operator|(
name|XPointer
operator|)
name|NULL
argument_list|,
comment|/* gamutCompClientData */
operator|(
name|XcmsWhiteAdjustProc
operator|)
name|NULL
argument_list|,
comment|/* whitePtAdjProc */
operator|(
name|XPointer
operator|)
name|NULL
comment|/* whitePtAdjClientData */
argument_list|)
expr_stmt|;
name|XSetErrorHandler
argument_list|(
name|oldErrorHandler
argument_list|)
expr_stmt|;
name|XDestroyWindow
argument_list|(
name|dpy
argument_list|,
name|tmpWindow
argument_list|)
expr_stmt|;
name|XFree
argument_list|(
operator|(
name|XPointer
operator|)
name|visualList
argument_list|)
expr_stmt|;
return|return
operator|(
name|pRec
operator|)
return|;
block|}
comment|/* 	 * Otherwise continue .... 	 */
name|XFree
argument_list|(
operator|(
name|XPointer
operator|)
name|visualList
argument_list|)
expr_stmt|;
block|}
comment|/*      * Unsetup Temporary Error Handler      */
name|XSetErrorHandler
argument_list|(
name|oldErrorHandler
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************  *									*  *			API PRIVATE INTERFACES				*  *									*  ************************************************************************/
end_comment

begin_comment
comment|/*  *	NAME  *		_XcmsAddCmapRec  *  *	SYNOPSIS  */
end_comment

begin_function
name|XcmsCmapRec
modifier|*
name|_XcmsAddCmapRec
parameter_list|(
name|dpy
parameter_list|,
name|cmap
parameter_list|,
name|windowID
parameter_list|,
name|visual
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|Colormap
name|cmap
decl_stmt|;
name|Window
name|windowID
decl_stmt|;
name|Visual
modifier|*
name|visual
decl_stmt|;
comment|/*  *	DESCRIPTION  *		Create an XcmsCmapRec for the specified cmap, windowID,  *		and visual, then adds it to its list of CmapRec's.  *  *	RETURNS  *		Returns NULL if failed; otherwise the address to  *		the added XcmsCmapRec.  *  */
block|{
name|XcmsCmapRec
modifier|*
name|pNew
decl_stmt|;
if|if
condition|(
operator|(
name|pNew
operator|=
operator|(
name|XcmsCmapRec
operator|*
operator|)
name|Xcalloc
argument_list|(
literal|1
argument_list|,
operator|(
name|unsigned
operator|)
sizeof|sizeof
argument_list|(
name|XcmsCmapRec
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
operator|(
name|XcmsCmapRec
operator|*
operator|)
name|NULL
operator|)
return|;
block|}
name|pNew
operator|->
name|cmapID
operator|=
name|cmap
expr_stmt|;
name|pNew
operator|->
name|dpy
operator|=
name|dpy
expr_stmt|;
name|pNew
operator|->
name|windowID
operator|=
name|windowID
expr_stmt|;
name|pNew
operator|->
name|visual
operator|=
name|visual
expr_stmt|;
name|pNew
operator|->
name|pNext
operator|=
operator|(
name|XcmsCmapRec
operator|*
operator|)
name|dpy
operator|->
name|cms
operator|.
name|clientCmaps
expr_stmt|;
name|dpy
operator|->
name|cms
operator|.
name|clientCmaps
operator|=
operator|(
name|XPointer
operator|)
name|pNew
expr_stmt|;
name|dpy
operator|->
name|free_funcs
operator|->
name|clientCmaps
operator|=
name|_XcmsFreeClientCmaps
expr_stmt|;
comment|/*      * Note, we don't create the XcmsCCC for pNew->ccc here because      * it may require the use of XGetWindowAttributes (a round trip request)      * to determine the screen.      */
return|return
operator|(
name|pNew
operator|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *	NAME  *		_XcmsCopyCmapRecAndFree  *  *	SYNOPSIS  */
end_comment

begin_function
name|XcmsCmapRec
modifier|*
name|_XcmsCopyCmapRecAndFree
parameter_list|(
name|dpy
parameter_list|,
name|src_cmap
parameter_list|,
name|copy_cmap
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|Colormap
name|src_cmap
decl_stmt|;
name|Colormap
name|copy_cmap
decl_stmt|;
comment|/*  *	DESCRIPTION  *		Augments Xlib's XCopyColormapAndFree() to copy  *		XcmsCmapRecs.  *  *	RETURNS  *		Returns NULL if failed; otherwise the address to  *		the copy XcmsCmapRec.  *  */
block|{
name|XcmsCmapRec
modifier|*
name|pRec_src
decl_stmt|;
name|XcmsCmapRec
modifier|*
name|pRec_copy
decl_stmt|;
if|if
condition|(
operator|(
name|pRec_src
operator|=
name|CmapRecForColormap
argument_list|(
name|dpy
argument_list|,
name|src_cmap
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|pRec_copy
operator|=
name|_XcmsAddCmapRec
argument_list|(
name|dpy
argument_list|,
name|copy_cmap
argument_list|,
name|pRec_src
operator|->
name|windowID
argument_list|,
name|pRec_src
operator|->
name|visual
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRec_copy
operator|!=
name|NULL
operator|&&
name|pRec_src
operator|->
name|ccc
condition|)
block|{
name|pRec_copy
operator|->
name|ccc
operator|=
operator|(
name|XcmsCCC
operator|)
name|Xcalloc
argument_list|(
literal|1
argument_list|,
operator|(
name|unsigned
operator|)
sizeof|sizeof
argument_list|(
name|XcmsCCCRec
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pRec_src
operator|->
name|ccc
argument_list|,
operator|(
name|char
operator|*
operator|)
name|pRec_copy
operator|->
name|ccc
argument_list|,
sizeof|sizeof
argument_list|(
name|XcmsCCCRec
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|pRec_copy
operator|)
return|;
block|}
return|return
operator|(
operator|(
name|XcmsCmapRec
operator|*
operator|)
name|NULL
operator|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *	NAME  *		_XcmsDeleteCmapRec  *  *	SYNOPSIS  */
end_comment

begin_function
name|void
name|_XcmsDeleteCmapRec
parameter_list|(
name|dpy
parameter_list|,
name|cmap
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|Colormap
name|cmap
decl_stmt|;
comment|/*  *	DESCRIPTION  *		Removes and frees the specified XcmsCmapRec structure  *		from the linked list of structures.  *  *	RETURNS  *		void  *  */
block|{
name|XcmsCmapRec
modifier|*
modifier|*
name|pPrevPtr
decl_stmt|;
name|XcmsCmapRec
modifier|*
name|pRec
decl_stmt|;
name|int
name|scr
decl_stmt|;
comment|/* If it is the default cmap for a screen, do not delete it,      * because the server will not actually free it */
for|for
control|(
name|scr
operator|=
name|ScreenCount
argument_list|(
name|dpy
argument_list|)
init|;
operator|--
name|scr
operator|>=
literal|0
condition|;
control|)
block|{
if|if
condition|(
name|cmap
operator|==
name|DefaultColormap
argument_list|(
name|dpy
argument_list|,
name|scr
argument_list|)
condition|)
return|return;
block|}
comment|/* search for it in the list */
name|pPrevPtr
operator|=
operator|(
name|XcmsCmapRec
operator|*
operator|*
operator|)
operator|&
name|dpy
operator|->
name|cms
operator|.
name|clientCmaps
expr_stmt|;
while|while
condition|(
operator|(
name|pRec
operator|=
operator|*
name|pPrevPtr
operator|)
operator|&&
operator|(
name|pRec
operator|->
name|cmapID
operator|!=
name|cmap
operator|)
condition|)
block|{
name|pPrevPtr
operator|=
operator|&
name|pRec
operator|->
name|pNext
expr_stmt|;
block|}
if|if
condition|(
name|pRec
condition|)
block|{
if|if
condition|(
name|pRec
operator|->
name|ccc
condition|)
block|{
name|XcmsFreeCCC
argument_list|(
name|pRec
operator|->
name|ccc
argument_list|)
expr_stmt|;
block|}
operator|*
name|pPrevPtr
operator|=
name|pRec
operator|->
name|pNext
expr_stmt|;
name|Xfree
argument_list|(
name|pRec
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  *	NAME  *		_XcmsFreeClientCmaps  *  *	SYNOPSIS  */
end_comment

begin_function
specifier|static
name|void
name|_XcmsFreeClientCmaps
parameter_list|(
name|dpy
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
comment|/*  *	DESCRIPTION  *		Frees all XcmsCmapRec structures in the linked list  *		and sets dpy->cms.clientCmaps to NULL.  *  *	RETURNS  *		void  *  */
block|{
name|XcmsCmapRec
modifier|*
name|pRecNext
decl_stmt|,
modifier|*
name|pRecFree
decl_stmt|;
name|pRecNext
operator|=
operator|(
name|XcmsCmapRec
operator|*
operator|)
name|dpy
operator|->
name|cms
operator|.
name|clientCmaps
expr_stmt|;
while|while
condition|(
name|pRecNext
operator|!=
name|NULL
condition|)
block|{
name|pRecFree
operator|=
name|pRecNext
expr_stmt|;
name|pRecNext
operator|=
name|pRecNext
operator|->
name|pNext
expr_stmt|;
if|if
condition|(
name|pRecFree
operator|->
name|ccc
condition|)
block|{
comment|/* Free the XcmsCCC structure */
name|XcmsFreeCCC
argument_list|(
name|pRecFree
operator|->
name|ccc
argument_list|)
expr_stmt|;
block|}
comment|/* Now free the XcmsCmapRec structure */
name|Xfree
argument_list|(
name|pRecFree
argument_list|)
expr_stmt|;
block|}
name|dpy
operator|->
name|cms
operator|.
name|clientCmaps
operator|=
operator|(
name|XPointer
operator|)
name|NULL
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************  *									*  *			PUBLIC INTERFACES				*  *									*  ************************************************************************/
end_comment

begin_comment
comment|/*  *	NAME  *		XcmsCCCOfColormap  *  *	SYNOPSIS  */
end_comment

begin_function
name|XcmsCCC
name|XcmsCCCOfColormap
parameter_list|(
name|dpy
parameter_list|,
name|cmap
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|Colormap
name|cmap
decl_stmt|;
comment|/*  *	DESCRIPTION  *		Finds the XcmsCCC associated with the specified colormap.  *  *	RETURNS  *		Returns NULL if failed; otherwise the address to  *		the associated XcmsCCC structure.  *  */
block|{
name|XWindowAttributes
name|windowAttr
decl_stmt|;
name|XcmsCmapRec
modifier|*
name|pRec
decl_stmt|;
name|int
name|nScrn
init|=
name|ScreenCount
argument_list|(
name|dpy
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|pRec
operator|=
name|CmapRecForColormap
argument_list|(
name|dpy
argument_list|,
name|cmap
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|pRec
operator|->
name|ccc
condition|)
block|{
comment|/* XcmsCmapRec already has a XcmsCCC */
return|return
operator|(
name|pRec
operator|->
name|ccc
operator|)
return|;
block|}
comment|/* 	 * The XcmsCmapRec does not have a XcmsCCC yet, so let's create 	 * one.  But first, we need to know the screen associated with 	 * cmap, so use XGetWindowAttributes() to extract that 	 * information.  Unless, of course there is only one screen!! 	 */
if|if
condition|(
name|nScrn
operator|==
literal|1
condition|)
block|{
comment|/* Assume screenNumber == 0 */
return|return
operator|(
name|pRec
operator|->
name|ccc
operator|=
name|XcmsCreateCCC
argument_list|(
name|dpy
argument_list|,
literal|0
argument_list|,
comment|/* screenNumber */
name|pRec
operator|->
name|visual
argument_list|,
operator|(
name|XcmsColor
operator|*
operator|)
name|NULL
argument_list|,
comment|/* clientWhitePt */
operator|(
name|XcmsCompressionProc
operator|)
name|NULL
argument_list|,
comment|/* gamutCompProc */
operator|(
name|XPointer
operator|)
name|NULL
argument_list|,
comment|/* gamutCompClientData */
operator|(
name|XcmsWhiteAdjustProc
operator|)
name|NULL
argument_list|,
comment|/* whitePtAdjProc */
operator|(
name|XPointer
operator|)
name|NULL
comment|/* whitePtAdjClientData */
argument_list|)
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|XGetWindowAttributes
argument_list|(
name|dpy
argument_list|,
name|pRec
operator|->
name|windowID
argument_list|,
operator|&
name|windowAttr
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nScrn
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ScreenOfDisplay
argument_list|(
name|dpy
argument_list|,
name|i
argument_list|)
operator|==
name|windowAttr
operator|.
name|screen
condition|)
block|{
return|return
operator|(
name|pRec
operator|->
name|ccc
operator|=
name|XcmsCreateCCC
argument_list|(
name|dpy
argument_list|,
name|i
argument_list|,
comment|/* screenNumber */
name|pRec
operator|->
name|visual
argument_list|,
operator|(
name|XcmsColor
operator|*
operator|)
name|NULL
argument_list|,
comment|/* clientWhitePt */
operator|(
name|XcmsCompressionProc
operator|)
name|NULL
argument_list|,
comment|/* gamutCompProc */
operator|(
name|XPointer
operator|)
name|NULL
argument_list|,
comment|/* gamutCompClientData */
operator|(
name|XcmsWhiteAdjustProc
operator|)
name|NULL
argument_list|,
comment|/* whitePtAdjProc */
operator|(
name|XPointer
operator|)
name|NULL
comment|/* whitePtAdjClientData */
argument_list|)
operator|)
return|;
block|}
block|}
block|}
block|}
block|}
comment|/*      * No such cmap      */
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

end_unit


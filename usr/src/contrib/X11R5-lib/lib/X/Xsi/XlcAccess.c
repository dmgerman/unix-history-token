begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $XConsortium: XlcAccess.c,v 1.21 91/09/18 16:29:59 rws Exp $  */
end_comment

begin_comment
comment|/*  * Copyright 1990, 1991 by OMRON Corporation, NTT Software Corporation,  *                      and Nippon Telegraph and Telephone Corporation  * Copyright 1991 by the Massachusetts Institute of Technology  *  * Permission to use, copy, modify, distribute, and sell this software and its  * documentation for any purpose is hereby granted without fee, provided that  * the above copyright notice appear in all copies and that both that  * copyright notice and this permission notice appear in supporting  * documentation, and that the names of OMRON, NTT Software, NTT, and M.I.T.  * not be used in advertising or publicity pertaining to distribution of the  * software without specific, written prior permission. OMRON, NTT Software,  * NTT, and M.I.T. make no representations about the suitability of this  * software for any purpose.  It is provided "as is" without express or  * implied warranty.  *  * OMRON, NTT SOFTWARE, NTT, AND M.I.T. DISCLAIM ALL WARRANTIES WITH REGARD  * TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS, IN NO EVENT SHALL OMRON, NTT SOFTWARE, NTT, OR M.I.T. BE  * LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES   * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  *	Authors: Li Yuhong		OMRON Corporation  *		 Hiroshi Kuribayashi	OMRON Corporation  *     */
end_comment

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_include
include|#
directive|include
file|<X11/Xos.h>
end_include

begin_include
include|#
directive|include
file|"Xlocaleint.h"
end_include

begin_define
define|#
directive|define
name|SO
value|0x0E
end_define

begin_define
define|#
directive|define
name|SI
value|0x0F
end_define

begin_define
define|#
directive|define
name|SS2
value|0x8E
end_define

begin_define
define|#
directive|define
name|SS3
value|0x8F
end_define

begin_define
define|#
directive|define
name|ESC
value|0x1B
end_define

begin_define
define|#
directive|define
name|NotInvokeOrEsc
parameter_list|(
name|c
parameter_list|)
value|(c != SO&& c != SI&&                      \                                  c != SS2&& c != SS3&& c != ESC)
end_define

begin_function
name|int
name|_Xmbmsbon
parameter_list|(
name|xlocale
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
return|return
operator|(
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
operator|->
name|cds_msbon
operator|)
return|;
block|}
end_function

begin_function
name|_CSID
name|_Xmbctid
parameter_list|(
name|xlocale
parameter_list|,
name|csid
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
block|{
name|Fontset
modifier|*
name|flist
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|flist
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_fontset
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|csid
operator|>=
name|flist
operator|->
name|fs_num
operator|)
condition|?
name|ND
else|:
name|flist
operator|->
name|fs_cset
index|[
name|csid
index|]
operator|->
name|cs_id
return|;
block|}
end_function

begin_function
name|_CSID
name|_Xmbctidtocsid
parameter_list|(
name|xlocale
parameter_list|,
name|ctid
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
name|_CSID
name|ctid
decl_stmt|;
block|{
name|_CSID
name|csid
decl_stmt|;
name|int
name|fs_num
decl_stmt|;
name|Fontset
modifier|*
name|fontset
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|fontset
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_fontset
expr_stmt|;
name|fs_num
operator|=
name|fontset
operator|->
name|fs_num
expr_stmt|;
for|for
control|(
name|csid
operator|=
literal|0
init|;
operator|(
name|int
operator|)
name|csid
operator|<
name|fs_num
condition|;
name|csid
operator|++
control|)
block|{
if|if
condition|(
name|fontset
operator|->
name|fs_cset
index|[
name|csid
index|]
operator|->
name|cs_id
operator|==
name|ctid
condition|)
return|return
operator|(
name|csid
operator|)
return|;
block|}
return|return
operator|(
name|ND
operator|)
return|;
block|}
end_function

begin_function
name|_CSID
name|_Xmbcsid
parameter_list|(
name|xlocale
parameter_list|,
name|mbstr
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
name|unsigned
name|char
modifier|*
name|mbstr
decl_stmt|;
block|{
specifier|register
name|Codeset
modifier|*
name|codeset
decl_stmt|;
specifier|register
name|char
modifier|*
name|dsg
decl_stmt|;
specifier|register
name|unsigned
name|char
name|c
decl_stmt|;
name|_CSID
name|numcs
decl_stmt|;
name|_CSID
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
comment|/*      * set initial state for state-dependent codeset.      */
if|if
condition|(
operator|!
name|mbstr
condition|)
block|{
name|_Xmbinit
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
return|return
operator|(
name|mbGetid
argument_list|(
name|xlocale
argument_list|)
operator|)
return|;
block|}
name|codeset
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
expr_stmt|;
comment|/*      * state-independent codeset      */
if|if
condition|(
name|codeset
operator|->
name|cds_type
operator|==
name|CDS_STATELESS
condition|)
block|{
return|return
operator|(
name|xlocale
operator|->
name|mb_state
operator|=
name|codeset
operator|->
name|cds_map
index|[
operator|*
name|mbstr
index|]
operator|)
return|;
block|}
comment|/*      * state-dependent codeset.      */
name|c
operator|=
operator|*
name|mbstr
expr_stmt|;
comment|/* for macro parameter */
comment|/*       * DEL(0x7F), not 0xFF, is control character.      */
if|if
condition|(
operator|!
name|iscntrl
argument_list|(
name|c
operator|&
literal|0x7f
argument_list|)
operator|||
operator|(
name|c
operator|==
literal|0xFF
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|&
literal|0x80
operator|)
operator|!=
name|mbGetGLorGR
argument_list|(
name|xlocale
argument_list|)
condition|)
block|{
name|mbSetGLorGR
argument_list|(
name|xlocale
argument_list|,
name|c
operator|&
literal|0x80
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|mbGetid
argument_list|(
name|xlocale
argument_list|)
operator|)
return|;
block|}
comment|/*      * control characters      */
if|if
condition|(
name|NotInvokeOrEsc
argument_list|(
name|c
argument_list|)
condition|)
return|return
operator|(
operator|(
name|c
operator|&
literal|0x80
operator|)
operator|==
literal|0
operator|)
condition|?
name|C0
else|:
name|C1
return|;
comment|/*      * invoker or escape means a possible designation sequence.      */
name|numcs
operator|=
name|codeset
operator|->
name|cds_num
expr_stmt|;
for|for
control|(
name|i
operator|=
name|CODESET0
init|;
name|i
operator|<
name|numcs
condition|;
name|i
operator|++
control|)
block|{
name|dsg
operator|=
name|codeset
operator|->
name|cds_dsg
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|mbstr
argument_list|,
name|dsg
argument_list|,
name|strlen
argument_list|(
name|dsg
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|_XctisGLdsg
argument_list|(
name|dsg
argument_list|)
condition|)
block|{
name|mbSetGLorGR
argument_list|(
name|xlocale
argument_list|,
name|GL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mbSetGLorGR
argument_list|(
name|xlocale
argument_list|,
name|GR
argument_list|)
expr_stmt|;
block|}
name|mbSetid
argument_list|(
name|xlocale
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|i
return|;
block|}
block|}
return|return
name|ND
return|;
block|}
end_function

begin_function
name|void
name|_XmbSetCsid
parameter_list|(
name|xlocale
parameter_list|,
name|csid
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
block|{
name|Codeset
modifier|*
name|codeset
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|codeset
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
expr_stmt|;
if|if
condition|(
name|codeset
operator|->
name|cds_type
operator|==
name|CDS_STATEFUL
condition|)
block|{
if|if
condition|(
name|_XctisGLdsg
argument_list|(
name|codeset
operator|->
name|cds_dsg
index|[
name|csid
index|]
argument_list|)
condition|)
block|{
name|mbSetGLorGR
argument_list|(
name|xlocale
argument_list|,
name|GL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mbSetGLorGR
argument_list|(
name|xlocale
argument_list|,
name|GR
argument_list|)
expr_stmt|;
block|}
block|}
name|mbSetid
argument_list|(
name|xlocale
argument_list|,
name|csid
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|_CSID
name|_XmbctGLorGR
parameter_list|(
name|xlocale
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
block|{
name|Fontset
modifier|*
name|flist
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|flist
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_fontset
expr_stmt|;
name|csid
operator|=
name|mbGetid
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|csid
operator|>=
name|flist
operator|->
name|fs_num
operator|)
condition|?
operator|-
literal|1
else|:
name|flist
operator|->
name|fs_cset
index|[
name|csid
index|]
operator|->
name|cs_GLorGR
return|;
block|}
end_function

begin_function
name|Charset
modifier|*
name|_Xmbfscs
parameter_list|(
name|xlocale
parameter_list|,
name|csid
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
block|{
name|Fontset
modifier|*
name|flist
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|flist
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_fontset
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|csid
operator|>=
name|flist
operator|->
name|fs_num
operator|)
condition|?
operator|(
name|Charset
operator|*
operator|)
literal|0
else|:
name|flist
operator|->
name|fs_cset
index|[
name|csid
index|]
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|_Xmbfsname
parameter_list|(
name|xlocale
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
block|{
name|Fontset
modifier|*
name|flist
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|flist
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_fontset
expr_stmt|;
name|csid
operator|=
name|mbGetid
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|csid
operator|>=
name|flist
operator|->
name|fs_num
operator|)
condition|?
operator|(
name|char
operator|*
operator|)
literal|0
else|:
name|flist
operator|->
name|fs_cset
index|[
name|csid
index|]
operator|->
name|cs_name
return|;
block|}
end_function

begin_function
name|int
name|_Xmblen
parameter_list|(
name|xlocale
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
block|{
name|_CSID
name|csid
decl_stmt|;
name|Codeset
modifier|*
name|codeset
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|csid
operator|=
name|mbGetid
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
name|codeset
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
expr_stmt|;
return|return
operator|(
name|csid
operator|>=
name|codeset
operator|->
name|cds_num
operator|)
condition|?
literal|1
else|:
name|codeset
operator|->
name|cds_mblen
index|[
name|csid
index|]
return|;
block|}
end_function

begin_function
name|int
name|_Xmbfslen
parameter_list|(
name|xlocale
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
block|{
name|Fontset
modifier|*
name|flist
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|flist
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_fontset
expr_stmt|;
name|csid
operator|=
name|mbGetid
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|csid
operator|>=
name|flist
operator|->
name|fs_num
operator|)
condition|?
literal|0
else|:
name|flist
operator|->
name|fs_cset
index|[
name|csid
index|]
operator|->
name|cs_len
return|;
block|}
end_function

begin_function
name|int
name|_Xmbctocsc
parameter_list|(
name|xlocale
parameter_list|,
name|mbstr
parameter_list|,
name|cscode
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
name|unsigned
name|char
modifier|*
name|mbstr
decl_stmt|;
name|int
modifier|*
name|cscode
decl_stmt|;
block|{
specifier|register
name|Range
modifier|*
name|cds_cnvlist
decl_stmt|;
name|int
modifier|*
name|cds_cnvindex
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|Codeset
modifier|*
name|codeset
decl_stmt|;
specifier|register
name|unsigned
name|code
decl_stmt|;
specifier|register
name|unsigned
name|c
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
name|int
name|start
decl_stmt|,
name|stop
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
name|codeset
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
expr_stmt|;
if|if
condition|(
name|xlocale
operator|->
name|mb_state
operator|&
literal|0xff0000
condition|)
comment|/* GR */
name|csid
operator|=
operator|(
name|xlocale
operator|->
name|mb_state
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
expr_stmt|;
else|else
comment|/* GL */
name|csid
operator|=
name|xlocale
operator|->
name|mb_state
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|csid
operator|>=
name|codeset
operator|->
name|cds_num
condition|)
return|return
operator|(
name|BadEncoding
operator|)
return|;
name|cds_cnvindex
operator|=
name|codeset
operator|->
name|cds_cnvindex
expr_stmt|;
name|cds_cnvlist
operator|=
name|codeset
operator|->
name|cds_cnvlist
expr_stmt|;
name|start
operator|=
name|cds_cnvindex
index|[
name|csid
index|]
expr_stmt|;
name|stop
operator|=
name|cds_cnvindex
index|[
name|csid
operator|+
literal|1
index|]
expr_stmt|;
name|len
operator|=
name|codeset
operator|->
name|cds_mblen
index|[
name|csid
index|]
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|1
condition|)
block|{
name|code
operator|=
operator|*
name|mbstr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|len
operator|==
literal|2
condition|)
block|{
name|code
operator|=
operator|(
operator|*
name|mbstr
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|mbstr
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|*
operator|(
name|mbstr
operator|+
literal|1
operator|)
operator|)
condition|)
block|{
operator|*
name|cscode
operator|=
name|codeset
operator|->
name|cds_cnvlist
index|[
name|start
index|]
operator|.
name|cs_start
expr_stmt|;
return|return
operator|(
name|BadEncoding
operator|)
return|;
block|}
block|}
else|else
block|{
name|code
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|len
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|(
name|c
operator|=
operator|*
name|mbstr
operator|++
operator|)
operator|)
condition|)
block|{
name|code
operator|=
operator|(
name|code
operator|<<
literal|8
operator|)
operator||
name|c
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
comment|/* recover codepoint if expect more bytes from mbstr. */
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
operator|*
name|cscode
operator|=
name|codeset
operator|->
name|cds_cnvlist
index|[
name|start
index|]
operator|.
name|cs_start
expr_stmt|;
return|return
operator|(
name|BadEncoding
operator|)
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<
name|stop
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|code
operator|<
name|cds_cnvlist
index|[
name|i
index|]
operator|.
name|mb_start
condition|)
break|break;
block|}
comment|/*      * recover wrong code always with the first codepoint of the      * charset id.      */
if|if
condition|(
name|i
operator|==
name|start
operator|||
name|code
operator|>
name|cds_cnvlist
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|mb_end
condition|)
block|{
operator|*
name|cscode
operator|=
name|cds_cnvlist
index|[
name|start
index|]
operator|.
name|cs_start
expr_stmt|;
return|return
operator|(
name|BadEncoding
operator|)
return|;
block|}
else|else
block|{
operator|*
name|cscode
operator|=
operator|(
name|cds_cnvlist
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|cs_start
operator|+
name|code
operator|-
name|cds_cnvlist
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|mb_start
operator|)
expr_stmt|;
return|return
operator|(
name|Success
operator|)
return|;
block|}
block|}
end_function

begin_function
name|int
name|_Xcsctombc
parameter_list|(
name|xlocale
parameter_list|,
name|cscode
parameter_list|,
name|code
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
name|int
name|cscode
decl_stmt|;
name|int
modifier|*
name|code
decl_stmt|;
block|{
specifier|register
name|int
name|start
decl_stmt|,
name|stop
decl_stmt|,
name|i
decl_stmt|;
specifier|register
name|Codeset
modifier|*
name|codeset
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
name|codeset
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
expr_stmt|;
name|csid
operator|=
name|mbGetid
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
if|if
condition|(
name|csid
operator|>=
name|codeset
operator|->
name|cds_num
condition|)
return|return
operator|(
name|BadEncoding
operator|)
return|;
name|cscode
operator||=
name|codeset
operator|->
name|cs_offset
index|[
name|csid
index|]
expr_stmt|;
name|start
operator|=
name|codeset
operator|->
name|cds_cnvindex
index|[
name|csid
index|]
expr_stmt|;
name|stop
operator|=
name|codeset
operator|->
name|cds_cnvindex
index|[
name|csid
operator|+
literal|1
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<
name|stop
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cscode
operator|>=
name|codeset
operator|->
name|cds_cnvlist
index|[
name|i
index|]
operator|.
name|cs_start
operator|&&
name|cscode
operator|<=
name|codeset
operator|->
name|cds_cnvlist
index|[
name|i
index|]
operator|.
name|cs_end
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|stop
condition|)
return|return
name|BadEncoding
return|;
operator|*
name|code
operator|=
name|codeset
operator|->
name|cds_cnvlist
index|[
name|i
index|]
operator|.
name|mb_start
operator|+
name|cscode
operator|-
name|codeset
operator|->
name|cds_cnvlist
index|[
name|i
index|]
operator|.
name|cs_start
expr_stmt|;
return|return
name|Success
return|;
block|}
end_function

begin_comment
comment|/*  * get the designation sequence of state-dependent codeset.  * any error should be controlled by caller.  */
end_comment

begin_function
name|char
modifier|*
name|_Xmbdsg
parameter_list|(
name|xlocale
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
block|{
name|_CSID
name|csid
decl_stmt|;
name|Codeset
modifier|*
name|codeset
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|codeset
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
expr_stmt|;
name|csid
operator|=
name|mbGetid
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
return|return
operator|(
name|csid
operator|>=
name|codeset
operator|->
name|cds_num
operator|)
condition|?
operator|(
name|char
operator|*
operator|)
literal|0
else|:
name|codeset
operator|->
name|cds_dsg
index|[
name|csid
index|]
return|;
block|}
end_function

begin_comment
comment|/*  * get the designation sequence of the font charset which   * is registered by X in CT encoding.  * any error should be controlled by caller.  */
end_comment

begin_function
name|char
modifier|*
name|_Xmbfsdsg
parameter_list|(
name|xlocale
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
block|{
name|Fontset
modifier|*
name|flist
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|flist
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_fontset
expr_stmt|;
name|csid
operator|=
name|mbGetid
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|csid
operator|>=
name|flist
operator|->
name|fs_num
operator|)
condition|?
operator|(
name|char
operator|*
operator|)
literal|0
else|:
name|flist
operator|->
name|fs_cset
index|[
name|csid
index|]
operator|->
name|cs_des
return|;
block|}
end_function

begin_comment
comment|/*  * return the woffset of the font charset.  */
end_comment

begin_function
name|wchar
name|_Xmbfswf
parameter_list|(
name|xlocale
parameter_list|,
name|csid
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
block|{
name|Fontset
modifier|*
name|flist
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|flist
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_fontset
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|csid
operator|>=
name|flist
operator|->
name|fs_num
operator|)
condition|?
operator|(
operator|~
literal|0L
operator|)
else|:
name|flist
operator|->
name|fs_cset
index|[
name|csid
index|]
operator|->
name|cs_woff
return|;
block|}
end_function

begin_comment
comment|/*  * if the mbstr points to the designation sequence, return the length  * of the designation, otherwise return 0;  */
end_comment

begin_function
name|int
name|_Xmbdlen
parameter_list|(
name|xlocale
parameter_list|,
name|mbstr
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
name|unsigned
name|char
modifier|*
name|mbstr
decl_stmt|;
block|{
specifier|register
name|int
name|len
decl_stmt|;
name|_CSID
name|csid
decl_stmt|;
name|Codeset
modifier|*
name|codeset
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|codeset
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
expr_stmt|;
name|csid
operator|=
name|mbGetid
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
if|if
condition|(
name|csid
operator|>=
name|codeset
operator|->
name|cds_num
operator|||
name|codeset
operator|->
name|cds_type
operator|!=
name|CDS_STATEFUL
condition|)
return|return
literal|0
return|;
name|len
operator|=
name|strlen
argument_list|(
name|codeset
operator|->
name|cds_dsg
index|[
name|csid
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|mbstr
argument_list|,
name|codeset
operator|->
name|cds_dsg
index|[
name|csid
index|]
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|(
name|len
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|Bool
name|_XmbCheck
parameter_list|(
name|xlocale
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
block|{
name|Codeset
modifier|*
name|codeset
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|codeset
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
expr_stmt|;
if|if
condition|(
name|mbGetGLid
argument_list|(
name|xlocale
argument_list|)
operator|>=
name|codeset
operator|->
name|cds_num
operator|||
name|mbGetGRid
argument_list|(
name|xlocale
argument_list|)
operator|>=
name|codeset
operator|->
name|cds_num
condition|)
return|return
operator|(
name|False
operator|)
return|;
return|return
operator|(
name|True
operator|)
return|;
block|}
end_function

begin_function
name|void
name|_XmbGetDefaultEncoding
parameter_list|(
name|xlocale
parameter_list|,
name|dsg
parameter_list|)
name|XLocale
name|xlocale
decl_stmt|;
name|char
modifier|*
name|dsg
decl_stmt|;
block|{
name|_CSID
name|id
decl_stmt|;
name|_CSID
name|gl
decl_stmt|,
name|gr
decl_stmt|;
name|_State
name|mb_init
decl_stmt|;
name|Codeset
modifier|*
name|codeset
decl_stmt|;
if|if
condition|(
operator|!
name|xlocale
condition|)
name|xlocale
operator|=
name|_XFallBackConvert
argument_list|()
expr_stmt|;
name|codeset
operator|=
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
expr_stmt|;
operator|*
name|dsg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|codeset
operator|->
name|cds_type
operator|!=
name|CDS_STATEFUL
condition|)
return|return;
name|mb_init
operator|=
name|_XmbDefaultState
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
name|gl
operator|=
name|mb_init
operator|&
literal|0xff
expr_stmt|;
name|gr
operator|=
operator|(
name|mb_init
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|id
operator|=
name|mbGetGLid
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|!=
name|gl
operator|&&
name|id
operator|<
name|codeset
operator|->
name|cds_num
condition|)
name|strcpy
argument_list|(
name|dsg
argument_list|,
name|codeset
operator|->
name|cds_dsg
index|[
name|gl
index|]
argument_list|)
expr_stmt|;
name|id
operator|=
name|mbGetGRid
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
if|if
condition|(
name|gl
operator|!=
name|gr
operator|&&
name|id
operator|!=
name|gr
operator|&&
name|id
operator|<
name|codeset
operator|->
name|cds_num
condition|)
name|strcat
argument_list|(
name|dsg
argument_list|,
name|codeset
operator|->
name|cds_dsg
index|[
name|gr
index|]
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


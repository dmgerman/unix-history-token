begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $XConsortium: XCrFntSet.c,v 1.48 92/09/10 17:06:53 rws Exp $  */
end_comment

begin_comment
comment|/*  * Copyright 1990, 1991 by OMRON Corporation, NTT Software Corporation,  *                      and Nippon Telegraph and Telephone Corporation  * Copyright 1991 by the Massachusetts Institute of Technology  *  * Permission to use, copy, modify, distribute, and sell this software and its  * documentation for any purpose is hereby granted without fee, provided that  * the above copyright notice appear in all copies and that both that  * copyright notice and this permission notice appear in supporting  * documentation, and that the names of OMRON, NTT Software, NTT, and M.I.T.  * not be used in advertising or publicity pertaining to distribution of the  * software without specific, written prior permission. OMRON, NTT Software,  * NTT, and M.I.T. make no representations about the suitability of this  * software for any purpose.  It is provided "as is" without express or  * implied warranty.  *  * OMRON, NTT SOFTWARE, NTT, AND M.I.T. DISCLAIM ALL WARRANTIES WITH REGARD  * TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS, IN NO EVENT SHALL OMRON, NTT SOFTWARE, NTT, OR M.I.T. BE  * LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES   * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *   *	Authors: Li Yuhong		OMRON Corporation  *		 Tatsuya Kato		NTT Software Corporation  *		 Hiroshi Kuribayashi	OMRON Coproration  *		 Muneiyoshi Suzuki	Nippon Telegraph and Telephone Co.  *     */
end_comment

begin_comment
comment|/*  * _XsiCreateFontSet()  * XmlCreateFontSet()  * _XsiQueryFontSetFromId()  * _XsiQueryFontSetWithName()  *  */
end_comment

begin_include
include|#
directive|include
file|<X11/Xatom.h>
end_include

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_include
include|#
directive|include
file|"Xi18nint.h"
end_include

begin_include
include|#
directive|include
file|<X11/Xos.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_define
define|#
directive|define
name|PRELOAD
value|1
end_define

begin_comment
comment|/* preload fonts if locale exists */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|dbg_printf
parameter_list|(
name|f
parameter_list|,
name|p1
parameter_list|,
name|p2
parameter_list|)
value|fprintf(stderr, f, p1, p2)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|dbg_printf
parameter_list|(
name|f
parameter_list|,
name|p1
parameter_list|,
name|p2
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|XFNEXT_PREFIX
value|'+'
end_define

begin_comment
comment|/* XLFD External prefix */
end_comment

begin_define
define|#
directive|define
name|XFNDELIM
value|'-'
end_define

begin_comment
comment|/* XLFD Delimiter */
end_comment

begin_define
define|#
directive|define
name|DELIM_COUNT
value|13
end_define

begin_comment
comment|/* Number of delimiters */
end_comment

begin_define
define|#
directive|define
name|CSETPOS
value|13
end_define

begin_comment
comment|/* CHARSET-REGISTRY position */
end_comment

begin_if
if|#
directive|if
name|__STDC__
operator|&&
operator|!
name|defined
argument_list|(
name|NORCONST
argument_list|)
end_if

begin_define
define|#
directive|define
name|RConst
value|const
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|RConst
end_define

begin_comment
comment|/**/
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|_XsiFreeFontSet
parameter_list|(
name|dpy
parameter_list|,
name|font_set
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|XFontSet
name|font_set
decl_stmt|;
block|{
if|if
condition|(
operator|(
operator|(
name|XsiFontSet
operator|)
name|font_set
operator|)
operator|->
name|xlc
condition|)
name|_XlcFreeLocale
argument_list|(
operator|(
operator|(
name|XsiFontSet
operator|)
name|font_set
operator|)
operator|->
name|xlc
argument_list|)
expr_stmt|;
if|if
condition|(
name|font_set
operator|->
name|core
operator|.
name|num_of_fonts
operator|>
literal|0
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
operator|(
name|XsiFontSet
operator|)
name|font_set
operator|)
operator|->
name|ctid
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|RConst
name|XFontSetMethodsRec
name|fs_methods
init|=
block|{
name|_XsiFreeFontSet
block|,
name|_XsimbTextEscapement
block|,
name|_XsimbTextExtents
block|,
name|_XsimbTextPerCharExtents
block|,
name|_XsimbDrawString
block|,
name|_XsimbDrawImageString
block|,
name|_XsiwcTextEscapement
block|,
name|_XsiwcTextExtents
block|,
name|_XsiwcTextPerCharExtents
block|,
name|_XsiwcDrawString
block|,
name|_XsiwcDrawImageString
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|RConst
name|XFontSetMethodsRec
name|fs8_methods
init|=
block|{
name|_XsiFreeFontSet
block|,
name|_Xsimb8TextEscapement
block|,
name|_Xsimb8TextExtents
block|,
name|_XsimbTextPerCharExtents
block|,
name|_Xsimb8DrawString
block|,
name|_Xsimb8DrawImageString
block|,
name|_XsiwcTextEscapement
block|,
name|_XsiwcTextExtents
block|,
name|_XsiwcTextPerCharExtents
block|,
name|_XsiwcDrawString
block|,
name|_XsiwcDrawImageString
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|lowercase
parameter_list|(
name|c
parameter_list|)
value|((isalpha(c)&& isupper(c)) ? tolower(c) : c)
end_define

begin_if
if|#
directive|if
name|defined
argument_list|(
name|MUSTCOPY
argument_list|)
end_if

begin_function
specifier|static
name|void
name|SetFontInfo
parameter_list|(
name|des
parameter_list|,
name|src
parameter_list|)
name|XFontStruct
modifier|*
name|des
decl_stmt|,
decl|*
name|src
decl_stmt|;
end_function

begin_block
block|{
name|des
operator|->
name|ext_data
operator|=
name|src
operator|->
name|ext_data
expr_stmt|;
name|des
operator|->
name|fid
operator|=
name|src
operator|->
name|fid
expr_stmt|;
name|des
operator|->
name|direction
operator|=
name|src
operator|->
name|direction
expr_stmt|;
name|des
operator|->
name|min_char_or_byte2
operator|=
name|src
operator|->
name|min_char_or_byte2
expr_stmt|;
name|des
operator|->
name|max_char_or_byte2
operator|=
name|src
operator|->
name|max_char_or_byte2
expr_stmt|;
name|des
operator|->
name|min_byte1
operator|=
name|src
operator|->
name|min_byte1
expr_stmt|;
name|des
operator|->
name|max_byte1
operator|=
name|src
operator|->
name|max_byte1
expr_stmt|;
name|des
operator|->
name|all_chars_exist
operator|=
name|src
operator|->
name|all_chars_exist
expr_stmt|;
name|des
operator|->
name|default_char
operator|=
name|src
operator|->
name|default_char
expr_stmt|;
name|des
operator|->
name|n_properties
operator|=
name|src
operator|->
name|n_properties
expr_stmt|;
name|des
operator|->
name|properties
operator|=
name|src
operator|->
name|properties
expr_stmt|;
name|des
operator|->
name|min_bounds
operator|=
name|src
operator|->
name|min_bounds
expr_stmt|;
name|des
operator|->
name|max_bounds
operator|=
name|src
operator|->
name|max_bounds
expr_stmt|;
name|des
operator|->
name|per_char
operator|=
name|src
operator|->
name|per_char
expr_stmt|;
name|des
operator|->
name|ascent
operator|=
name|src
operator|->
name|ascent
expr_stmt|;
name|des
operator|->
name|descent
operator|=
name|src
operator|->
name|descent
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|compareLowercase
parameter_list|(
name|s1
parameter_list|,
name|s2
parameter_list|)
name|char
modifier|*
name|s1
decl_stmt|;
name|char
modifier|*
name|s2
decl_stmt|;
block|{
specifier|register
name|char
name|c1
decl_stmt|,
name|c2
decl_stmt|;
while|while
condition|(
operator|(
name|c1
operator|=
operator|*
name|s1
operator|)
operator|&&
operator|(
name|c2
operator|=
operator|*
name|s2
operator|)
condition|)
block|{
name|c1
operator|=
name|lowercase
argument_list|(
name|c1
argument_list|)
expr_stmt|;
name|c2
operator|=
name|lowercase
argument_list|(
name|c2
argument_list|)
expr_stmt|;
if|if
condition|(
name|c1
operator|!=
name|c2
condition|)
break|break;
name|s1
operator|++
operator|,
name|s2
operator|++
expr_stmt|;
block|}
comment|/*      * do not use c1 and c2 here.      */
return|return
operator|(
operator|*
name|s1
operator|-
operator|*
name|s2
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compareNLowercase
parameter_list|(
name|s1
parameter_list|,
name|s2
parameter_list|,
name|n
parameter_list|)
name|char
modifier|*
name|s1
decl_stmt|;
name|char
modifier|*
name|s2
decl_stmt|;
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|char
name|c1
decl_stmt|,
name|c2
decl_stmt|;
while|while
condition|(
operator|(
name|n
operator|>
literal|0
operator|)
operator|&&
operator|(
name|c1
operator|=
operator|*
name|s1
operator|)
operator|&&
operator|(
name|c2
operator|=
operator|*
name|s2
operator|)
condition|)
block|{
name|c1
operator|=
name|lowercase
argument_list|(
name|c1
argument_list|)
expr_stmt|;
name|c2
operator|=
name|lowercase
argument_list|(
name|c2
argument_list|)
expr_stmt|;
if|if
condition|(
name|c1
operator|!=
name|c2
condition|)
break|break;
name|s1
operator|++
operator|,
name|s2
operator|++
operator|,
name|n
operator|--
expr_stmt|;
block|}
comment|/*      * do not use c1 and c2 here.      * in the case, if (c1 = *s1) is NULL, stop while, so no value of c2.      */
return|return
operator|(
name|n
operator|==
literal|0
operator|)
condition|?
literal|0
else|:
operator|(
operator|*
name|s1
operator|-
operator|*
name|s2
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|XML
end_ifdef

begin_function
specifier|static
name|char
modifier|*
name|copyLowercase
parameter_list|(
name|s1
parameter_list|,
name|s2
parameter_list|)
name|char
modifier|*
name|s1
decl_stmt|,
decl|*
name|s2
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|char
name|c
decl_stmt|;
while|while
condition|(
name|c
operator|=
operator|*
name|s2
operator|++
condition|)
operator|*
name|s1
operator|++
operator|=
name|lowercase
argument_list|(
name|c
argument_list|)
expr_stmt|;
operator|*
name|s1
operator|=
literal|0
expr_stmt|;
return|return
name|s1
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|char
modifier|*
modifier|*
name|reallocList
parameter_list|(
name|list
parameter_list|,
name|count
parameter_list|)
name|char
modifier|*
name|list
index|[]
decl_stmt|;
name|int
name|count
decl_stmt|;
block|{
name|char
modifier|*
modifier|*
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|datalen
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|ret
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|count
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
name|NULL
return|;
name|datalen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|list
index|[
name|i
index|]
condition|)
block|{
name|datalen
operator|+=
name|strlen
argument_list|(
name|list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
block|}
name|data
operator|=
operator|(
name|char
operator|*
operator|)
name|Xmalloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|datalen
operator|+
name|count
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
block|{
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ret
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|list
index|[
name|i
index|]
condition|)
block|{
name|ret
index|[
name|j
index|]
operator|=
name|data
expr_stmt|;
name|strcpy
argument_list|(
name|data
argument_list|,
name|list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|data
operator|+=
name|strlen
argument_list|(
name|list
index|[
name|i
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
block|}
name|ret
index|[
name|j
index|]
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|XFontStruct
modifier|*
modifier|*
name|reallocFontStruct
parameter_list|(
name|font
parameter_list|,
name|count
parameter_list|)
name|XFontStruct
modifier|*
name|font
index|[]
decl_stmt|;
name|int
name|count
decl_stmt|;
block|{
name|XFontStruct
modifier|*
modifier|*
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|PRELOAD
argument_list|)
operator|||
name|defined
argument_list|(
name|XML
argument_list|)
name|XFontStruct
modifier|*
name|data
decl_stmt|;
endif|#
directive|endif
name|ret
operator|=
operator|(
name|XFontStruct
operator|*
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
sizeof|sizeof
argument_list|(
name|XFontStruct
operator|*
argument_list|)
operator|*
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
name|NULL
return|;
if|#
directive|if
name|defined
argument_list|(
name|PRELOAD
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|XML
argument_list|)
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|font
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|font
index|[
name|i
index|]
operator|->
name|fid
operator|>
literal|0
condition|)
block|{
name|ret
index|[
name|j
index|]
operator|=
name|font
index|[
name|i
index|]
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
block|}
block|}
else|#
directive|else
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|font
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|font
index|[
name|i
index|]
operator|->
name|fid
operator|>
literal|0
condition|)
block|{
name|ret
index|[
name|j
index|]
operator|=
name|font
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
name|data
operator|=
operator|(
name|XFontStruct
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XFontStruct
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
block|{
for|for
control|(
name|j
operator|--
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
block|{
if|if
condition|(
name|ret
index|[
name|j
index|]
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ret
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ret
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ret
index|[
name|j
index|]
operator|=
name|data
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|font
index|[
name|i
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|XFontStruct
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|j
operator|++
expr_stmt|;
block|}
block|}
endif|#
directive|endif
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
modifier|*
name|reallocCtidList
parameter_list|(
name|fn
parameter_list|,
name|list
parameter_list|,
name|count
parameter_list|)
name|char
modifier|*
name|fn
index|[]
decl_stmt|;
name|int
name|list
index|[]
decl_stmt|;
name|int
name|count
decl_stmt|;
block|{
name|int
modifier|*
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ret
operator|=
operator|(
name|int
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fn
index|[
name|i
index|]
condition|)
block|{
name|ret
index|[
name|j
index|]
operator|=
name|list
index|[
name|i
index|]
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|isXLFDname
parameter_list|(
name|font_name
parameter_list|)
name|char
modifier|*
name|font_name
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|ptr
init|=
name|font_name
decl_stmt|;
if|if
condition|(
operator|*
name|ptr
operator|==
name|XFNEXT_PREFIX
condition|)
block|{
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
name|ptr
argument_list|,
name|XFNDELIM
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
name|False
return|;
block|}
block|}
if|if
condition|(
operator|*
name|ptr
operator|!=
name|XFNDELIM
condition|)
block|{
return|return
name|False
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DELIM_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
name|ptr
operator|+
literal|1
argument_list|,
name|XFNDELIM
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
name|False
return|;
block|}
block|}
return|return
name|True
return|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|isBaseFontName
parameter_list|(
name|font_name
parameter_list|)
name|char
modifier|*
name|font_name
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|ptr
init|=
name|font_name
decl_stmt|;
if|if
condition|(
operator|*
name|ptr
operator|==
name|XFNEXT_PREFIX
condition|)
block|{
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
name|ptr
argument_list|,
name|XFNDELIM
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
name|False
return|;
block|}
block|}
if|if
condition|(
operator|*
name|ptr
operator|!=
name|XFNDELIM
condition|)
block|{
return|return
name|False
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DELIM_COUNT
operator|-
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
name|ptr
operator|+
literal|1
argument_list|,
name|XFNDELIM
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
name|False
return|;
block|}
block|}
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
name|ptr
operator|+
literal|1
argument_list|,
name|XFNDELIM
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
name|True
return|;
block|}
return|return
name|False
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|getXLFDName
parameter_list|(
name|dpy
parameter_list|,
name|info
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|XFontStruct
modifier|*
name|info
decl_stmt|;
block|{
name|char
modifier|*
name|return_value
decl_stmt|;
name|unsigned
name|long
name|val
decl_stmt|;
if|if
condition|(
name|XGetFontProperty
argument_list|(
name|info
argument_list|,
name|XA_FONT
argument_list|,
operator|&
name|val
argument_list|)
operator|==
name|False
condition|)
block|{
name|dbg_printf
argument_list|(
literal|"getXLFD: XGetFontProperty == False\n"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|return_value
operator|=
name|XGetAtomName
argument_list|(
name|dpy
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|isXLFDname
argument_list|(
name|return_value
argument_list|)
condition|)
block|{
return|return
name|return_value
return|;
block|}
else|else
block|{
name|dbg_printf
argument_list|(
literal|"getXLFD: isXLFDname == Not XLFD\n"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
name|return_value
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|Bool
name|matchCharset
parameter_list|(
name|font_name
parameter_list|,
name|cset
parameter_list|,
name|GLorGR
parameter_list|)
name|char
modifier|*
name|font_name
decl_stmt|,
decl|*
name|cset
decl_stmt|;
end_function

begin_decl_stmt
name|_CSID
name|GLorGR
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|start
init|=
name|font_name
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CSETPOS
condition|;
name|i
operator|++
control|)
block|{
name|start
operator|=
name|index
argument_list|(
name|start
argument_list|,
name|XFNDELIM
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|==
name|NULL
condition|)
block|{
return|return
name|False
return|;
block|}
name|start
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|compareLowercase
argument_list|(
name|start
argument_list|,
name|cset
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|True
operator|)
return|;
comment|/* jisx0208.1990-0 is super set of jisx0208.1983-0 */
if|if
condition|(
name|strlen
argument_list|(
name|cset
argument_list|)
operator|==
literal|15
operator|&&
name|strlen
argument_list|(
name|start
argument_list|)
operator|==
literal|15
operator|&&
operator|*
operator|(
name|cset
operator|+
literal|14
operator|)
operator|==
operator|*
operator|(
name|start
operator|+
literal|14
operator|)
operator|&&
operator|!
name|strncmp
argument_list|(
name|cset
argument_list|,
literal|"jisx0208.1983"
argument_list|,
literal|13
argument_list|)
condition|)
block|{
return|return
operator|(
operator|(
name|compareNLowercase
argument_list|(
name|start
argument_list|,
literal|"jisx0208.1990"
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
operator|)
condition|?
name|True
else|:
name|False
operator|)
return|;
block|}
comment|/* GL of ISO8859.* is same as GL of ISO8859.1 */
if|if
condition|(
name|GLorGR
operator|==
name|GL
operator|&&
operator|!
name|strncmp
argument_list|(
name|cset
argument_list|,
literal|"iso8859-"
argument_list|,
literal|8
argument_list|)
condition|)
block|{
return|return
operator|(
operator|(
name|compareNLowercase
argument_list|(
name|start
argument_list|,
name|cset
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
operator|)
condition|?
name|True
else|:
name|False
operator|)
return|;
block|}
return|return
operator|(
name|False
operator|)
return|;
block|}
end_block

begin_function
specifier|static
name|int
name|findFont
parameter_list|(
name|dpy
parameter_list|,
name|fname
parameter_list|,
name|xlocale
parameter_list|,
name|f_tmp
parameter_list|,
name|s_tmp
parameter_list|,
name|id_tmp
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|char
modifier|*
name|fname
decl_stmt|;
name|XLocale
name|xlocale
decl_stmt|;
name|char
modifier|*
name|f_tmp
index|[]
decl_stmt|;
name|XFontStruct
modifier|*
name|s_tmp
index|[]
decl_stmt|;
name|int
name|id_tmp
index|[]
decl_stmt|;
block|{
name|XFontStruct
modifier|*
name|info
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
modifier|*
name|list
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|cset_count
decl_stmt|;
name|char
modifier|*
name|fn
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|_CSID
name|i
decl_stmt|;
if|if
condition|(
name|isXLFDname
argument_list|(
name|fname
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fn
operator|=
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|strlen
argument_list|(
name|fname
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
name|strcpy
argument_list|(
name|fn
argument_list|,
name|fname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|list
operator|=
name|XListFontsWithInfo
argument_list|(
name|dpy
argument_list|,
name|fname
argument_list|,
literal|1
argument_list|,
operator|&
name|count
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|!=
literal|1
condition|)
block|{
comment|/* never go to here. */
goto|goto
name|_err_return
goto|;
block|}
if|if
condition|(
operator|(
name|fn
operator|=
name|getXLFDName
argument_list|(
name|dpy
argument_list|,
operator|&
name|info
index|[
literal|0
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
goto|goto
name|_err_return
goto|;
block|}
block|}
name|dbg_printf
argument_list|(
literal|"findFont: %s\n"
argument_list|,
name|fn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cset_count
operator|=
name|_Xmbfsnum
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|CODESET0
init|;
operator|(
name|int
operator|)
name|i
operator|<
name|cset_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|s_tmp
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|Charset
modifier|*
name|cset
init|=
name|_Xmbfscs
argument_list|(
name|xlocale
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|dbg_printf
argument_list|(
literal|"findFont: charset[%d] = %s\n"
argument_list|,
name|i
argument_list|,
name|cset
operator|->
name|cs_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|matchCharset
argument_list|(
name|fn
argument_list|,
name|cset
operator|->
name|cs_name
argument_list|,
name|cset
operator|->
name|cs_GLorGR
argument_list|)
operator|==
name|True
condition|)
block|{
name|dbg_printf
argument_list|(
literal|"findFont: matched\n"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|PRELOAD
if|if
condition|(
operator|!
operator|(
name|s_tmp
index|[
name|i
index|]
operator|=
name|XLoadQueryFont
argument_list|(
name|dpy
argument_list|,
name|fn
argument_list|)
operator|)
condition|)
name|ret
operator|--
expr_stmt|;
else|#
directive|else
comment|/* PRELOAD */
if|if
condition|(
operator|!
name|info
condition|)
name|list
operator|=
name|XListFontsWithInfo
argument_list|(
name|dpy
argument_list|,
name|fname
argument_list|,
literal|1
argument_list|,
operator|&
name|count
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|!=
literal|1
condition|)
block|{
comment|/* never go to here. */
goto|goto
name|_err_return
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|s_tmp
index|[
name|i
index|]
operator|=
operator|(
name|XFontStruct
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XFontStruct
argument_list|)
argument_list|)
operator|)
condition|)
block|{
goto|goto
name|_err_return
goto|;
block|}
ifndef|#
directive|ifndef
name|MUSTCOPY
name|s_tmp
index|[
name|i
index|]
operator|=
name|info
index|[
literal|0
index|]
expr_stmt|;
else|#
directive|else
comment|/* MUSTCOPY */
name|SetFontInfo
argument_list|(
operator|&
name|s_tmp
index|[
name|i
index|]
argument_list|,
operator|&
name|info
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* MUSTCOPY */
comment|/* indicate the font has not loaded, only info. */
name|s_tmp
index|[
name|i
index|]
operator|->
name|fid
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* PRELOAD */
name|id_tmp
index|[
name|i
index|]
operator|=
name|cset
operator|->
name|cs_id
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|f_tmp
index|[
name|i
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|Xmalloc
argument_list|(
name|strlen
argument_list|(
name|fn
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
condition|)
block|{
operator|--
name|ret
expr_stmt|;
goto|goto
name|_err_return
goto|;
block|}
name|strcpy
argument_list|(
name|f_tmp
index|[
name|i
index|]
argument_list|,
name|fn
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|f_tmp
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
name|_err_return
label|:
if|if
condition|(
name|info
condition|)
block|{
name|XFreeFontInfo
argument_list|(
name|list
argument_list|,
name|info
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fn
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fn
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|MIN
end_undef

begin_undef
undef|#
directive|undef
name|MAX
end_undef

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a) = (((a)> (b))? (b): (a)))
end_define

begin_define
define|#
directive|define
name|MAX
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a) = (((a)< (b))? (b): (a)))
end_define

begin_comment
comment|/* _MinBounds: if any element of src XCharStruct is less than           */
end_comment

begin_comment
comment|/*             that of des, replace the des XCharStruct's               */
end_comment

begin_comment
comment|/*             corresponding element with that of src                   */
end_comment

begin_comment
comment|/*       des:  destination min_bound                                    */
end_comment

begin_comment
comment|/*       src:  source min_bound                                         */
end_comment

begin_function
specifier|static
name|void
name|_MinBounds
parameter_list|(
name|des
parameter_list|,
name|src
parameter_list|)
name|XCharStruct
modifier|*
name|des
decl_stmt|;
name|XCharStruct
modifier|*
name|src
decl_stmt|;
block|{
name|MIN
argument_list|(
name|des
operator|->
name|lbearing
argument_list|,
name|src
operator|->
name|lbearing
argument_list|)
expr_stmt|;
name|MIN
argument_list|(
name|des
operator|->
name|rbearing
argument_list|,
name|src
operator|->
name|rbearing
argument_list|)
expr_stmt|;
name|MIN
argument_list|(
name|des
operator|->
name|width
argument_list|,
name|src
operator|->
name|width
argument_list|)
expr_stmt|;
name|MIN
argument_list|(
name|des
operator|->
name|ascent
argument_list|,
name|src
operator|->
name|ascent
argument_list|)
expr_stmt|;
name|MIN
argument_list|(
name|des
operator|->
name|descent
argument_list|,
name|src
operator|->
name|descent
argument_list|)
expr_stmt|;
name|MIN
argument_list|(
name|des
operator|->
name|attributes
argument_list|,
name|src
operator|->
name|attributes
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* _MinBounds: if any element of src XCharStruct is greater than        */
end_comment

begin_comment
comment|/*             that of des, replace the des XCharStruct's               */
end_comment

begin_comment
comment|/*             corresponding element with that of src                   */
end_comment

begin_comment
comment|/*       des:  destination min_bound                                    */
end_comment

begin_comment
comment|/*       src:  source min_bound                                         */
end_comment

begin_function
specifier|static
name|void
name|_MaxBounds
parameter_list|(
name|des
parameter_list|,
name|src
parameter_list|)
name|XCharStruct
modifier|*
name|des
decl_stmt|;
name|XCharStruct
modifier|*
name|src
decl_stmt|;
block|{
name|MAX
argument_list|(
name|des
operator|->
name|lbearing
argument_list|,
name|src
operator|->
name|lbearing
argument_list|)
expr_stmt|;
name|MAX
argument_list|(
name|des
operator|->
name|rbearing
argument_list|,
name|src
operator|->
name|rbearing
argument_list|)
expr_stmt|;
name|MAX
argument_list|(
name|des
operator|->
name|width
argument_list|,
name|src
operator|->
name|width
argument_list|)
expr_stmt|;
name|MAX
argument_list|(
name|des
operator|->
name|ascent
argument_list|,
name|src
operator|->
name|ascent
argument_list|)
expr_stmt|;
name|MAX
argument_list|(
name|des
operator|->
name|descent
argument_list|,
name|src
operator|->
name|descent
argument_list|)
expr_stmt|;
name|MAX
argument_list|(
name|des
operator|->
name|attributes
argument_list|,
name|src
operator|->
name|attributes
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|getFontCharStruct
parameter_list|(
name|font_strct
parameter_list|,
name|font_count
parameter_list|,
name|min_bounds
parameter_list|,
name|max_bounds
parameter_list|,
name|ascent
parameter_list|,
name|descent
parameter_list|)
name|XFontStruct
modifier|*
modifier|*
name|font_strct
decl_stmt|;
name|int
name|font_count
decl_stmt|;
name|XCharStruct
modifier|*
name|min_bounds
decl_stmt|,
decl|*
name|max_bounds
decl_stmt|;
end_function

begin_decl_stmt
name|int
modifier|*
name|ascent
decl_stmt|,
modifier|*
name|descent
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
operator|*
name|min_bounds
operator|=
name|font_strct
index|[
literal|0
index|]
operator|->
name|min_bounds
expr_stmt|;
operator|*
name|max_bounds
operator|=
name|font_strct
index|[
literal|0
index|]
operator|->
name|max_bounds
expr_stmt|;
operator|*
name|ascent
operator|=
name|font_strct
index|[
literal|0
index|]
operator|->
name|ascent
expr_stmt|;
operator|*
name|descent
operator|=
name|font_strct
index|[
literal|0
index|]
operator|->
name|descent
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|font_count
condition|;
name|i
operator|++
control|)
block|{
name|_MinBounds
argument_list|(
name|min_bounds
argument_list|,
operator|&
name|font_strct
index|[
name|i
index|]
operator|->
name|min_bounds
argument_list|)
expr_stmt|;
name|_MaxBounds
argument_list|(
name|max_bounds
argument_list|,
operator|&
name|font_strct
index|[
name|i
index|]
operator|->
name|max_bounds
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ascent
operator|<
name|font_strct
index|[
name|i
index|]
operator|->
name|ascent
condition|)
block|{
operator|*
name|ascent
operator|=
name|font_strct
index|[
name|i
index|]
operator|->
name|ascent
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|descent
operator|<
name|font_strct
index|[
name|i
index|]
operator|->
name|descent
condition|)
block|{
operator|*
name|descent
operator|=
name|font_strct
index|[
name|i
index|]
operator|->
name|descent
expr_stmt|;
block|}
block|}
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|XML
end_ifdef

begin_function
specifier|static
name|int
name|AlreadyLoad
parameter_list|(
name|id_tmp
parameter_list|,
name|found
parameter_list|,
name|charset
parameter_list|,
name|GLorGR
parameter_list|)
name|int
name|id_tmp
index|[]
decl_stmt|;
name|int
name|found
decl_stmt|;
name|char
modifier|*
name|charset
decl_stmt|;
name|_CSID
name|GLorGR
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|id_tmp
index|[
name|found
index|]
operator|=
name|_XcwNameGetGLorGRId
argument_list|(
name|charset
argument_list|,
name|GLorGR
argument_list|)
operator|)
operator|==
name|ND
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|found
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|id_tmp
index|[
name|i
index|]
operator|==
name|id_tmp
index|[
name|found
index|]
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TryLoad
parameter_list|(
name|s_tmp
parameter_list|,
name|id_tmp
parameter_list|,
name|found
parameter_list|,
name|info
parameter_list|,
name|charset
parameter_list|,
name|GLorGR
parameter_list|)
name|XFontStruct
modifier|*
name|s_tmp
index|[]
decl_stmt|;
name|int
name|id_tmp
index|[]
decl_stmt|;
name|int
name|found
decl_stmt|;
name|XFontStruct
modifier|*
name|info
decl_stmt|;
name|char
modifier|*
name|charset
decl_stmt|;
name|_CSID
name|GLorGR
decl_stmt|;
block|{
if|if
condition|(
operator|!
operator|(
name|s_tmp
index|[
name|found
index|]
operator|=
operator|(
name|XFontStruct
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XFontStruct
argument_list|)
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
ifndef|#
directive|ifndef
name|MUSTCOPY
operator|*
name|s_tmp
index|[
name|found
index|]
operator|=
name|info
index|[
literal|0
index|]
expr_stmt|;
else|#
directive|else
comment|/* MUSTCOPY */
name|SetFontInfo
argument_list|(
name|s_tmp
index|[
name|found
index|]
argument_list|,
operator|&
name|info
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* MUSTCOPY */
name|s_tmp
index|[
name|found
index|]
operator|->
name|fid
operator|=
literal|0
expr_stmt|;
comment|/* make sure unloaded */
return|return
literal|1
return|;
block|}
end_function

begin_function
name|XFontSet
name|_XsimlCreateFontSet
parameter_list|(
name|lcd
parameter_list|,
name|dpy
parameter_list|,
name|base_font_name_list
parameter_list|,
name|font_list
parameter_list|,
name|font_count
parameter_list|,
name|missing_charset_list
parameter_list|,
name|missing_charset_count
parameter_list|)
name|XLCd
name|lcd
decl_stmt|;
name|Display
modifier|*
name|dpy
decl_stmt|;
name|char
modifier|*
name|base_font_name_list
decl_stmt|;
name|char
modifier|*
modifier|*
name|font_list
decl_stmt|;
name|int
name|font_count
decl_stmt|;
name|char
modifier|*
modifier|*
modifier|*
name|missing_charset_list
decl_stmt|;
name|int
modifier|*
name|missing_charset_count
decl_stmt|;
block|{
name|XsiFontSet
name|font_set
decl_stmt|;
name|char
modifier|*
name|m_tmp
index|[
name|MAXCHARSETS
index|]
decl_stmt|,
modifier|*
name|f_tmp
index|[
name|MAXCHARSETS
index|]
decl_stmt|;
name|XFontStruct
modifier|*
name|s_tmp
index|[
name|MAXCHARSETS
index|]
decl_stmt|;
name|int
name|id_tmp
index|[
name|MAXCHARSETS
index|]
decl_stmt|;
name|int
name|found
init|=
literal|1
decl_stmt|,
name|miss
init|=
literal|0
decl_stmt|,
name|loadASCIIFONT
init|=
literal|0
decl_stmt|;
name|int
name|count
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|notfound
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|font_count
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
modifier|*
name|list
decl_stmt|;
name|char
name|tmp
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|isBaseFontName
argument_list|(
name|font_list
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|font_list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|tmp
argument_list|,
literal|"-*-*"
argument_list|)
expr_stmt|;
name|list
operator|=
name|XListFonts
argument_list|(
name|dpy
argument_list|,
name|tmp
argument_list|,
literal|1024
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|list
operator|=
name|XListFonts
argument_list|(
name|dpy
argument_list|,
name|font_list
index|[
name|i
index|]
argument_list|,
literal|1024
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
block|}
name|notfound
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|count
condition|;
name|j
operator|++
control|)
block|{
name|XFontStruct
modifier|*
name|info
decl_stmt|;
name|char
modifier|*
modifier|*
name|info_list
decl_stmt|;
name|int
name|count_list
decl_stmt|;
if|if
condition|(
name|found
operator|>=
operator|(
name|MAXCHARSETS
operator|-
literal|1
operator|)
condition|)
break|break;
name|info
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|isXLFDname
argument_list|(
name|list
index|[
name|j
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|f_tmp
index|[
name|found
index|]
operator|=
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|strlen
argument_list|(
name|list
index|[
name|j
index|]
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|strcpy
argument_list|(
name|f_tmp
index|[
name|found
index|]
argument_list|,
name|list
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|info_list
operator|=
name|XListFontsWithInfo
argument_list|(
name|dpy
argument_list|,
name|list
index|[
name|j
index|]
argument_list|,
literal|1
argument_list|,
operator|&
name|count_list
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|count_list
operator|!=
literal|1
condition|)
block|{
comment|/* never go to here. */
continue|continue;
block|}
name|f_tmp
index|[
name|found
index|]
operator|=
name|getXLFDName
argument_list|(
name|dpy
argument_list|,
operator|&
name|info
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|f_tmp
index|[
name|found
index|]
operator|!=
name|NULL
condition|)
block|{
name|char
name|charset
index|[
literal|64
index|]
decl_stmt|;
name|char
modifier|*
name|start
init|=
name|f_tmp
index|[
name|found
index|]
decl_stmt|;
name|int
name|k
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|CSETPOS
condition|;
name|k
operator|++
control|)
block|{
name|start
operator|=
name|index
argument_list|(
name|start
argument_list|,
name|XFNDELIM
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|==
name|NULL
condition|)
comment|/* not goes here */
return|return
name|NULL
return|;
name|start
operator|++
expr_stmt|;
block|}
name|copyLowercase
argument_list|(
name|charset
argument_list|,
name|start
argument_list|)
expr_stmt|;
comment|/* If font name is ISO8859.* Treate for ISO8859.1 GL */
if|if
condition|(
name|strncmp
argument_list|(
name|charset
argument_list|,
literal|"iso8859-"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|loadASCIIFONT
condition|)
block|{
name|f_tmp
index|[
literal|0
index|]
operator|=
name|f_tmp
index|[
name|found
index|]
expr_stmt|;
name|s_tmp
index|[
literal|0
index|]
operator|=
name|XLoadQueryFont
argument_list|(
name|dpy
argument_list|,
name|f_tmp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|id_tmp
index|[
literal|0
index|]
operator|=
name|CODESET0
expr_stmt|;
name|loadASCIIFONT
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|AlreadyLoad
argument_list|(
name|id_tmp
argument_list|,
name|found
argument_list|,
name|charset
argument_list|,
name|GL
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|info
condition|)
name|info_list
operator|=
name|XListFontsWithInfo
argument_list|(
name|dpy
argument_list|,
name|list
index|[
name|j
index|]
argument_list|,
literal|1
argument_list|,
operator|&
name|count_list
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|count_list
operator|!=
literal|1
condition|)
comment|/* never go to here. */
continue|continue;
name|f_tmp
index|[
name|found
operator|+
literal|1
index|]
operator|=
name|f_tmp
index|[
name|found
index|]
expr_stmt|;
name|found
operator|+=
name|TryLoad
argument_list|(
name|s_tmp
argument_list|,
name|id_tmp
argument_list|,
name|found
argument_list|,
name|info
argument_list|,
name|charset
argument_list|,
name|GL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|AlreadyLoad
argument_list|(
name|id_tmp
argument_list|,
name|found
argument_list|,
name|charset
argument_list|,
name|GR
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|info
condition|)
name|info_list
operator|=
name|XListFontsWithInfo
argument_list|(
name|dpy
argument_list|,
name|list
index|[
name|j
index|]
argument_list|,
literal|1
argument_list|,
operator|&
name|count_list
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|count_list
operator|!=
literal|1
condition|)
comment|/* never go to here. */
continue|continue;
name|found
operator|+=
name|TryLoad
argument_list|(
name|s_tmp
argument_list|,
name|id_tmp
argument_list|,
name|found
argument_list|,
name|info
argument_list|,
name|charset
argument_list|,
name|GR
argument_list|)
expr_stmt|;
block|}
name|notfound
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|info
condition|)
name|XFreeFontInfo
argument_list|(
name|info_list
argument_list|,
name|info
argument_list|,
name|count_list
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|notfound
condition|)
name|m_tmp
index|[
name|miss
operator|++
index|]
operator|=
name|font_list
index|[
name|i
index|]
expr_stmt|;
name|XFreeFontNames
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
operator|*
name|missing_charset_list
operator|=
name|reallocList
argument_list|(
name|m_tmp
argument_list|,
name|miss
argument_list|)
expr_stmt|;
operator|*
name|missing_charset_count
operator|=
name|miss
expr_stmt|;
if|if
condition|(
name|miss
operator|==
name|font_count
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|loadASCIIFONT
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|f_tmp
index|[
literal|0
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|Xmalloc
argument_list|(
name|strlen
argument_list|(
literal|"fixed"
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
condition|)
return|return
name|NULL
return|;
name|strcpy
argument_list|(
name|f_tmp
index|[
literal|0
index|]
argument_list|,
literal|"fixed"
argument_list|)
expr_stmt|;
comment|/* use defalt font */
name|s_tmp
index|[
literal|0
index|]
operator|=
name|XLoadQueryFont
argument_list|(
name|dpy
argument_list|,
name|f_tmp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|font_set
operator|=
operator|(
name|XsiFontSet
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XsiFontSetRec
argument_list|)
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|s_tmp
index|[
literal|0
index|]
operator|&&
name|s_tmp
index|[
literal|0
index|]
operator|->
name|fid
condition|)
block|{
name|XFreeFont
argument_list|(
name|dpy
argument_list|,
name|s_tmp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
name|XFreeStringList
argument_list|(
name|font_list
argument_list|)
expr_stmt|;
name|font_set
operator|->
name|methods
operator|=
operator|(
name|XFontSetMethods
operator|)
operator|&
name|fs_methods
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|base_name_list
operator|=
name|base_font_name_list
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|num_of_fonts
operator|=
name|found
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|lcd
operator|=
name|lcd
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_name_list
operator|=
name|reallocList
argument_list|(
name|f_tmp
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_struct_list
operator|=
name|reallocFontStruct
argument_list|(
name|s_tmp
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|context_dependent
operator|=
name|False
expr_stmt|;
name|font_set
operator|->
name|display
operator|=
name|dpy
expr_stmt|;
name|font_set
operator|->
name|xlc
operator|=
name|NULL
expr_stmt|;
name|font_set
operator|->
name|ctid
operator|=
name|reallocCtidList
argument_list|(
name|f_tmp
argument_list|,
name|id_tmp
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|getFontCharStruct
argument_list|(
name|font_set
operator|->
name|core
operator|.
name|font_struct_list
argument_list|,
name|found
argument_list|,
operator|&
name|font_set
operator|->
name|min_bounds
argument_list|,
operator|&
name|font_set
operator|->
name|max_bounds
argument_list|,
operator|&
name|font_set
operator|->
name|ascent
argument_list|,
operator|&
name|font_set
operator|->
name|descent
argument_list|)
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|default_string
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|int
operator|)
name|i
operator|<
name|found
condition|;
name|i
operator|++
control|)
block|{
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|f_tmp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/*      * set the ink bounding box of font_set.      */
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_ink_extent
operator|.
name|x
operator|=
name|font_set
operator|->
name|min_bounds
operator|.
name|lbearing
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_ink_extent
operator|.
name|y
operator|=
operator|-
name|font_set
operator|->
name|max_bounds
operator|.
name|ascent
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_ink_extent
operator|.
name|width
operator|=
name|font_set
operator|->
name|max_bounds
operator|.
name|rbearing
operator|-
name|font_set
operator|->
name|min_bounds
operator|.
name|lbearing
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_ink_extent
operator|.
name|height
operator|=
name|font_set
operator|->
name|max_bounds
operator|.
name|ascent
operator|+
name|font_set
operator|->
name|max_bounds
operator|.
name|descent
expr_stmt|;
comment|/*      * set the logical bounding box of font_set.      * suppose the lbearing>= 0;      */
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_logical_extent
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_logical_extent
operator|.
name|y
operator|=
operator|-
name|font_set
operator|->
name|ascent
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_logical_extent
operator|.
name|width
operator|=
name|font_set
operator|->
name|max_bounds
operator|.
name|width
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_logical_extent
operator|.
name|height
operator|=
name|font_set
operator|->
name|ascent
operator|+
name|font_set
operator|->
name|descent
expr_stmt|;
return|return
operator|(
name|XFontSet
operator|)
name|font_set
return|;
block|}
end_function

begin_function
name|XFontSet
name|XmlCreateFontSet
parameter_list|(
name|dpy
parameter_list|,
name|base_font_name_list
parameter_list|,
name|missing_charset_list
parameter_list|,
name|missing_charset_count
parameter_list|,
name|def_string
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|char
modifier|*
name|base_font_name_list
decl_stmt|;
name|char
modifier|*
modifier|*
modifier|*
name|missing_charset_list
decl_stmt|;
name|int
modifier|*
name|missing_charset_count
decl_stmt|;
name|char
modifier|*
modifier|*
name|def_string
decl_stmt|;
block|{
name|XLCd
name|lcd
init|=
name|_XlcCurrentLC
argument_list|()
decl_stmt|;
name|char
modifier|*
name|base_name
decl_stmt|;
name|char
modifier|*
modifier|*
name|name_list
decl_stmt|;
name|int
name|count
decl_stmt|;
name|XFontSet
name|font_set
decl_stmt|;
operator|*
name|missing_charset_list
operator|=
name|NULL
expr_stmt|;
operator|*
name|missing_charset_count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|lcd
condition|)
return|return
name|NULL
return|;
name|base_name
operator|=
operator|(
name|char
operator|*
operator|)
name|Xmalloc
argument_list|(
name|strlen
argument_list|(
name|base_font_name_list
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|base_name
condition|)
return|return
name|NULL
return|;
name|strcpy
argument_list|(
name|base_name
argument_list|,
name|base_font_name_list
argument_list|)
expr_stmt|;
name|name_list
operator|=
name|_XParseBaseFontNameList
argument_list|(
name|base_name
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|name_list
condition|)
block|{
name|Xfree
argument_list|(
name|base_name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|font_set
operator|=
name|_XsimlCreateFontSet
argument_list|(
name|lcd
argument_list|,
name|dpy
argument_list|,
name|base_name
argument_list|,
name|name_list
argument_list|,
name|count
argument_list|,
name|missing_charset_list
argument_list|,
name|missing_charset_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|font_set
condition|)
block|{
name|XFreeStringList
argument_list|(
name|name_list
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
name|base_name
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|def_string
condition|)
block|{
operator|*
name|def_string
operator|=
name|font_set
operator|->
name|core
operator|.
name|default_string
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|def_string
condition|)
operator|*
name|def_string
operator|=
literal|""
expr_stmt|;
block|}
return|return
name|font_set
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XML */
end_comment

begin_function
name|XFontSet
name|_XsiCreateFontSet
parameter_list|(
name|lcd
parameter_list|,
name|dpy
parameter_list|,
name|base_font_name_list
parameter_list|,
name|font_list
parameter_list|,
name|font_count
parameter_list|,
name|missing_charset_list
parameter_list|,
name|missing_charset_count
parameter_list|)
name|XLCd
name|lcd
decl_stmt|;
name|Display
modifier|*
name|dpy
decl_stmt|;
name|char
modifier|*
name|base_font_name_list
decl_stmt|;
name|char
modifier|*
modifier|*
name|font_list
decl_stmt|;
name|int
name|font_count
decl_stmt|;
name|char
modifier|*
modifier|*
modifier|*
name|missing_charset_list
decl_stmt|;
name|int
modifier|*
name|missing_charset_count
decl_stmt|;
block|{
name|XsiFontSet
name|font_set
decl_stmt|;
name|int
name|cset_count
decl_stmt|;
name|char
modifier|*
name|m_tmp
index|[
name|MAXCHARSETS
index|]
decl_stmt|,
modifier|*
name|f_tmp
index|[
name|MAXCHARSETS
index|]
decl_stmt|;
name|XFontStruct
modifier|*
name|s_tmp
index|[
name|MAXCHARSETS
index|]
decl_stmt|;
name|int
name|id_tmp
index|[
name|MAXCHARSETS
index|]
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|,
name|miss
init|=
literal|0
decl_stmt|,
name|j
decl_stmt|;
name|_CSID
name|i
decl_stmt|;
name|XLocale
name|xlocale
init|=
operator|(
operator|(
name|XsiLCd
operator|)
name|lcd
operator|)
operator|->
name|xlc
decl_stmt|;
name|cset_count
operator|=
name|_Xmbfsnum
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|int
operator|)
name|i
operator|<
name|cset_count
condition|;
name|i
operator|++
control|)
block|{
name|s_tmp
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|font_count
operator|&&
name|found
operator|<
name|cset_count
condition|;
name|j
operator|++
control|)
block|{
name|char
modifier|*
modifier|*
name|list
decl_stmt|;
name|int
name|k
decl_stmt|,
name|count
decl_stmt|;
name|char
name|tmp
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|isBaseFontName
argument_list|(
name|font_list
index|[
name|j
index|]
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|font_list
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|tmp
argument_list|,
literal|"-*-*"
argument_list|)
expr_stmt|;
name|list
operator|=
name|XListFonts
argument_list|(
name|dpy
argument_list|,
name|tmp
argument_list|,
literal|1024
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|list
operator|=
name|XListFonts
argument_list|(
name|dpy
argument_list|,
name|font_list
index|[
name|j
index|]
argument_list|,
literal|1024
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|count
operator|&&
name|found
operator|<
name|cset_count
condition|;
name|k
operator|++
control|)
block|{
name|dbg_printf
argument_list|(
literal|"XCreateFontSet: font = %s\n"
argument_list|,
name|list
index|[
name|k
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|found
operator|+=
name|findFont
argument_list|(
name|dpy
argument_list|,
name|list
index|[
name|k
index|]
argument_list|,
name|xlocale
argument_list|,
name|f_tmp
argument_list|,
name|s_tmp
argument_list|,
name|id_tmp
argument_list|)
expr_stmt|;
block|}
name|XFreeFontNames
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|<
name|cset_count
condition|)
block|{
comment|/* find missing charset */
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|int
operator|)
name|i
operator|<
name|cset_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|s_tmp
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|Charset
modifier|*
name|cset
init|=
name|_Xmbfscs
argument_list|(
name|xlocale
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|m_tmp
index|[
name|miss
index|]
operator|=
name|cset
operator|->
name|cs_name
expr_stmt|;
name|dbg_printf
argument_list|(
literal|"XCreateFontSet: m_tmp[%d] = %s\n"
argument_list|,
name|miss
argument_list|,
name|m_tmp
index|[
name|miss
index|]
argument_list|)
expr_stmt|;
name|miss
operator|++
expr_stmt|;
block|}
block|}
block|}
operator|*
name|missing_charset_list
operator|=
name|reallocList
argument_list|(
name|m_tmp
argument_list|,
name|miss
argument_list|)
expr_stmt|;
operator|*
name|missing_charset_count
operator|=
name|miss
expr_stmt|;
if|if
condition|(
name|miss
operator|==
name|cset_count
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|font_set
operator|=
operator|(
name|XsiFontSet
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XsiFontSetRec
argument_list|)
argument_list|)
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|int
operator|)
name|i
operator|<
name|found
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|s_tmp
index|[
name|i
index|]
operator|&&
name|s_tmp
index|[
name|i
index|]
operator|->
name|fid
condition|)
name|XFreeFont
argument_list|(
name|dpy
argument_list|,
name|s_tmp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
name|XFreeStringList
argument_list|(
name|font_list
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PRELOAD
if|if
condition|(
operator|!
name|miss
operator|&&
name|_Xmbtype
argument_list|(
name|xlocale
argument_list|)
operator|==
name|CDS_STATELESS
operator|&&
name|cset_count
operator|<=
literal|2
operator|&&
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
operator|->
name|cds_mblen
index|[
literal|0
index|]
operator|==
literal|1
operator|&&
operator|(
name|cset_count
operator|==
literal|1
operator|||
name|xlocale
operator|->
name|xlc_db
operator|->
name|lc_codeset
operator|->
name|cds_mblen
index|[
literal|1
index|]
operator|==
literal|1
operator|)
operator|&&
name|found
operator|<=
literal|2
operator|&&
operator|(
name|found
operator|==
literal|1
operator|||
operator|!
name|strcmp
argument_list|(
name|f_tmp
index|[
literal|0
index|]
argument_list|,
name|f_tmp
index|[
literal|1
index|]
argument_list|)
operator|)
condition|)
name|font_set
operator|->
name|methods
operator|=
operator|(
name|XFontSetMethods
operator|)
operator|&
name|fs8_methods
expr_stmt|;
else|else
endif|#
directive|endif
name|font_set
operator|->
name|methods
operator|=
operator|(
name|XFontSetMethods
operator|)
operator|&
name|fs_methods
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|base_name_list
operator|=
name|base_font_name_list
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|num_of_fonts
operator|=
name|found
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|lcd
operator|=
name|lcd
expr_stmt|;
name|font_set
operator|->
name|display
operator|=
name|dpy
expr_stmt|;
name|font_set
operator|->
name|xlc
operator|=
name|_XlcDupLocale
argument_list|(
name|xlocale
argument_list|)
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_name_list
operator|=
name|reallocList
argument_list|(
name|f_tmp
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_struct_list
operator|=
name|reallocFontStruct
argument_list|(
name|s_tmp
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|context_dependent
operator|=
name|False
expr_stmt|;
name|font_set
operator|->
name|ctid
operator|=
name|reallocCtidList
argument_list|(
name|f_tmp
argument_list|,
name|id_tmp
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|getFontCharStruct
argument_list|(
name|font_set
operator|->
name|core
operator|.
name|font_struct_list
argument_list|,
name|found
argument_list|,
operator|&
name|font_set
operator|->
name|min_bounds
argument_list|,
operator|&
name|font_set
operator|->
name|max_bounds
argument_list|,
operator|&
name|font_set
operator|->
name|ascent
argument_list|,
operator|&
name|font_set
operator|->
name|descent
argument_list|)
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|default_string
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|int
operator|)
name|i
operator|<
name|found
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|f_tmp
index|[
name|i
index|]
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|f_tmp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/*      * set the ink bounding box of font_set.      */
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_ink_extent
operator|.
name|x
operator|=
name|font_set
operator|->
name|min_bounds
operator|.
name|lbearing
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_ink_extent
operator|.
name|y
operator|=
operator|-
name|font_set
operator|->
name|max_bounds
operator|.
name|ascent
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_ink_extent
operator|.
name|width
operator|=
name|font_set
operator|->
name|max_bounds
operator|.
name|rbearing
operator|-
name|font_set
operator|->
name|min_bounds
operator|.
name|lbearing
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_ink_extent
operator|.
name|height
operator|=
name|font_set
operator|->
name|max_bounds
operator|.
name|ascent
operator|+
name|font_set
operator|->
name|max_bounds
operator|.
name|descent
expr_stmt|;
comment|/*      * set the logical bounding box of font_set.      * suppose the lbearing>= 0;      */
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_logical_extent
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_logical_extent
operator|.
name|y
operator|=
operator|-
name|font_set
operator|->
name|ascent
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_logical_extent
operator|.
name|width
operator|=
name|font_set
operator|->
name|max_bounds
operator|.
name|width
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_set_extents
operator|.
name|max_logical_extent
operator|.
name|height
operator|=
name|font_set
operator|->
name|ascent
operator|+
name|font_set
operator|->
name|descent
expr_stmt|;
return|return
operator|(
name|XFontSet
operator|)
name|font_set
return|;
block|}
end_function

begin_function
name|XFontStruct
modifier|*
name|_XsiQueryFontSetFromId
parameter_list|(
name|font_set
parameter_list|,
name|ctid
parameter_list|)
name|XFontSet
name|font_set
decl_stmt|;
name|int
name|ctid
decl_stmt|;
block|{
name|XFontStruct
modifier|*
name|font
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|font_set
operator|->
name|core
operator|.
name|num_of_fonts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|XsiFontSet
operator|)
name|font_set
operator|)
operator|->
name|ctid
index|[
name|i
index|]
operator|==
name|ctid
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|font_set
operator|->
name|core
operator|.
name|num_of_fonts
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|font_set
operator|->
name|core
operator|.
name|font_struct_list
index|[
name|i
index|]
operator|->
name|fid
operator|>
literal|0
condition|)
comment|/* already loaded */
return|return
name|font_set
operator|->
name|core
operator|.
name|font_struct_list
index|[
name|i
index|]
return|;
if|if
condition|(
operator|(
name|font
operator|=
name|XLoadQueryFont
argument_list|(
operator|(
operator|(
name|XsiFontSet
operator|)
name|font_set
operator|)
operator|->
name|display
argument_list|,
name|font_set
operator|->
name|core
operator|.
name|font_name_list
index|[
name|i
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|font_set
operator|->
name|core
operator|.
name|font_struct_list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|font_set
operator|->
name|core
operator|.
name|font_struct_list
index|[
name|i
index|]
operator|=
name|font
expr_stmt|;
return|return
name|font
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|XML
end_ifdef

begin_function
name|void
name|_XsiQueryFontSetWithName
parameter_list|(
name|font_set
parameter_list|,
name|font_name
parameter_list|)
name|XFontSet
name|font_set
decl_stmt|;
name|char
modifier|*
name|font_name
decl_stmt|;
comment|/* font name or charset name */
block|{
name|Display
modifier|*
name|dpy
init|=
operator|(
operator|(
name|XsiFontSet
operator|)
name|font_set
operator|)
operator|->
name|display
decl_stmt|;
name|char
modifier|*
name|fname
decl_stmt|;
name|int
name|ctid
decl_stmt|;
name|int
name|count
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
modifier|*
name|list
decl_stmt|;
name|char
name|tmp
index|[
literal|256
index|]
decl_stmt|;
name|char
name|charset
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
name|isBaseFontName
argument_list|(
name|font_name
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|font_name
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|tmp
argument_list|,
literal|"-*-*"
argument_list|)
expr_stmt|;
name|list
operator|=
name|XListFonts
argument_list|(
name|dpy
argument_list|,
name|tmp
argument_list|,
literal|1024
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|list
operator|=
name|XListFonts
argument_list|(
name|dpy
argument_list|,
name|font_name
argument_list|,
literal|1024
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
comment|/* charset name */
name|copyLowercase
argument_list|(
name|charset
argument_list|,
name|font_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctid
operator|=
name|_XcwNameGetGLorGRId
argument_list|(
name|charset
argument_list|,
name|GL
argument_list|)
operator|)
operator|!=
name|ND
condition|)
block|{
name|_XsiQueryFontSetFromId
argument_list|(
name|font_set
argument_list|,
name|ctid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ctid
operator|=
name|_XcwNameGetGLorGRId
argument_list|(
name|charset
argument_list|,
name|GR
argument_list|)
operator|)
operator|!=
name|ND
condition|)
block|{
name|_XsiQueryFontSetFromId
argument_list|(
name|font_set
argument_list|,
name|ctid
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* font name */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isXLFDname
argument_list|(
name|list
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|fname
operator|=
name|list
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
modifier|*
name|info_list
decl_stmt|;
name|XFontStruct
modifier|*
name|font
decl_stmt|;
name|info_list
operator|=
name|XListFontsWithInfo
argument_list|(
name|dpy
argument_list|,
name|list
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|,
operator|&
name|count
argument_list|,
operator|&
name|font
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|!=
literal|1
condition|)
comment|/* not goes here */
return|return;
name|fname
operator|=
name|getXLFDName
argument_list|(
name|dpy
argument_list|,
name|font
argument_list|)
expr_stmt|;
name|XFreeFontInfo
argument_list|(
name|info_list
argument_list|,
name|font
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fname
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|start
init|=
name|fname
decl_stmt|;
name|int
name|k
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|CSETPOS
condition|;
name|k
operator|++
control|)
block|{
name|start
operator|=
name|index
argument_list|(
name|start
argument_list|,
name|XFNDELIM
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|==
name|NULL
condition|)
comment|/* not goes here */
return|return;
name|start
operator|++
expr_stmt|;
block|}
name|copyLowercase
argument_list|(
name|charset
argument_list|,
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctid
operator|=
name|_XcwNameGetGLorGRId
argument_list|(
name|charset
argument_list|,
name|GL
argument_list|)
operator|)
operator|!=
name|ND
condition|)
block|{
name|_XsiQueryFontSetFromId
argument_list|(
name|font_set
argument_list|,
name|ctid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ctid
operator|=
name|_XcwNameGetGLorGRId
argument_list|(
name|charset
argument_list|,
name|GR
argument_list|)
operator|)
operator|!=
name|ND
condition|)
block|{
name|_XsiQueryFontSetFromId
argument_list|(
name|font_set
argument_list|,
name|ctid
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|XFreeFontNames
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XML */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $XConsortium: XGetDflt.c,v 1.27 91/07/09 14:54:15 rws Exp $  */
end_comment

begin_comment
comment|/*********************************************************** Copyright 1987, 1988 by Digital Equipment Corporation, Maynard, Massachusetts, and the Massachusetts Institute of Technology, Cambridge, Massachusetts.                          All Rights Reserved  Permission to use, copy, modify, and distribute this software and its  documentation for any purpose and without fee is hereby granted,  provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in  supporting documentation, and that the names of Digital or MIT not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.    DIGITAL DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL DIGITAL BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  ******************************************************************/
end_comment

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_include
include|#
directive|include
file|<X11/Xos.h>
end_include

begin_include
include|#
directive|include
file|<X11/Xresource.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|X_NOT_STDC_ENV
end_ifdef

begin_function_decl
specifier|extern
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|char
modifier|*
name|GetHomeDir
parameter_list|(
name|dest
parameter_list|)
name|char
modifier|*
name|dest
decl_stmt|;
block|{
ifndef|#
directive|ifndef
name|X_NOT_POSIX
name|uid_t
name|uid
decl_stmt|;
else|#
directive|else
name|int
name|uid
decl_stmt|;
specifier|extern
name|int
name|getuid
parameter_list|()
function_decl|;
ifndef|#
directive|ifndef
name|SYSV386
specifier|extern
name|struct
name|passwd
modifier|*
name|getpwuid
argument_list|()
decl_stmt|,
modifier|*
name|getpwnam
argument_list|()
decl_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
specifier|register
name|char
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|getenv
argument_list|(
literal|"HOME"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|dest
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ptr
operator|=
name|getenv
argument_list|(
literal|"USER"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|pw
operator|=
name|getpwnam
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uid
operator|=
name|getuid
argument_list|()
expr_stmt|;
name|pw
operator|=
name|getpwuid
argument_list|(
name|uid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pw
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|dest
argument_list|,
name|pw
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|dest
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
return|return
name|dest
return|;
block|}
end_function

begin_function
specifier|static
name|XrmDatabase
name|InitDefaults
parameter_list|(
name|dpy
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
comment|/* display for defaults.... */
block|{
name|XrmDatabase
name|userdb
decl_stmt|;
name|XrmDatabase
name|xdb
decl_stmt|;
name|char
name|fname
index|[
name|BUFSIZ
index|]
decl_stmt|;
comment|/* longer than any conceivable size */
name|char
modifier|*
name|xenv
decl_stmt|;
name|XrmInitialize
argument_list|()
expr_stmt|;
comment|/*      * See lib/Xtk/Initialize.c      *      * First, get the defaults from the server; if none, then load from      * ~/.Xdefaults.  Next, if there is an XENVIRONMENT environment variable,      * then load that file.      */
if|if
condition|(
name|dpy
operator|->
name|xdefaults
operator|==
name|NULL
condition|)
block|{
name|fname
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|GetHomeDir
argument_list|(
name|fname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|fname
argument_list|,
literal|"/.Xdefaults"
argument_list|)
expr_stmt|;
name|xdb
operator|=
name|XrmGetFileDatabase
argument_list|(
name|fname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xdb
operator|=
name|XrmGetStringDatabase
argument_list|(
name|dpy
operator|->
name|xdefaults
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|xenv
operator|=
name|getenv
argument_list|(
literal|"XENVIRONMENT"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|int
name|len
decl_stmt|;
name|fname
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|GetHomeDir
argument_list|(
name|fname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|fname
argument_list|,
literal|"/.Xdefaults-"
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|fname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|_XGetHostname
argument_list|(
name|fname
operator|+
name|len
argument_list|,
name|BUFSIZ
operator|-
name|len
argument_list|)
expr_stmt|;
name|xenv
operator|=
name|fname
expr_stmt|;
block|}
name|userdb
operator|=
name|XrmGetFileDatabase
argument_list|(
name|xenv
argument_list|)
expr_stmt|;
name|XrmMergeDatabases
argument_list|(
name|userdb
argument_list|,
operator|&
name|xdb
argument_list|)
expr_stmt|;
return|return
operator|(
name|xdb
operator|)
return|;
ifdef|#
directive|ifdef
name|old
if|if
condition|(
name|fname
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|userdb
operator|=
name|XrmGetFileDatabase
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|xdb
operator|=
name|XrmGetStringDatabase
argument_list|(
name|dpy
operator|->
name|xdefaults
argument_list|)
expr_stmt|;
name|XrmMergeDatabases
argument_list|(
name|userdb
argument_list|,
operator|&
name|xdb
argument_list|)
expr_stmt|;
return|return
name|xdb
return|;
endif|#
directive|endif
block|}
end_function

begin_if
if|#
directive|if
name|NeedFunctionPrototypes
end_if

begin_function
name|char
modifier|*
name|XGetDefault
parameter_list|(
name|Display
modifier|*
name|dpy
parameter_list|,
comment|/* display for defaults.... */
name|char
name|_Xconst
modifier|*
name|prog
parameter_list|,
comment|/* name of program for option	*/
specifier|register
name|_Xconst
name|char
modifier|*
name|name
parameter_list|)
comment|/* name of option program wants */
else|#
directive|else
function|char *XGetDefault
parameter_list|(
name|dpy
parameter_list|,
name|prog
parameter_list|,
name|name
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
comment|/* display for defaults.... */
name|char
modifier|*
name|prog
decl_stmt|;
comment|/* name of program for option	*/
specifier|register
name|char
modifier|*
name|name
decl_stmt|;
comment|/* name of option program wants */
endif|#
directive|endif
block|{
comment|/* to get, for example, "font"  */
name|XrmName
name|names
index|[
literal|3
index|]
decl_stmt|;
name|XrmClass
name|classes
index|[
literal|3
index|]
decl_stmt|;
name|XrmRepresentation
name|fromType
decl_stmt|;
name|XrmValue
name|result
decl_stmt|;
name|char
modifier|*
name|progname
decl_stmt|;
comment|/* 	 * strip path off of program name (XXX - this is OS specific) 	 */
name|progname
operator|=
name|rindex
argument_list|(
name|prog
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|progname
condition|)
name|progname
operator|++
expr_stmt|;
else|else
name|progname
operator|=
operator|(
name|char
operator|*
operator|)
name|prog
expr_stmt|;
comment|/* 	 * see if database has ever been initialized.  Lookups can be done 	 * without locks held. 	 */
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
if|if
condition|(
name|dpy
operator|->
name|db
operator|==
name|NULL
condition|)
block|{
name|dpy
operator|->
name|db
operator|=
name|InitDefaults
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
block|}
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|names
index|[
literal|0
index|]
operator|=
name|XrmStringToName
argument_list|(
name|progname
argument_list|)
expr_stmt|;
name|names
index|[
literal|1
index|]
operator|=
name|XrmStringToName
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|names
index|[
literal|2
index|]
operator|=
name|NULLQUARK
expr_stmt|;
name|classes
index|[
literal|0
index|]
operator|=
name|XrmStringToClass
argument_list|(
literal|"Program"
argument_list|)
expr_stmt|;
name|classes
index|[
literal|1
index|]
operator|=
name|XrmStringToClass
argument_list|(
literal|"Name"
argument_list|)
expr_stmt|;
name|classes
index|[
literal|2
index|]
operator|=
name|NULLQUARK
expr_stmt|;
operator|(
name|void
operator|)
name|XrmQGetResource
argument_list|(
name|dpy
operator|->
name|db
argument_list|,
name|names
argument_list|,
name|classes
argument_list|,
operator|&
name|fromType
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|.
name|addr
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * random stuff for atariST  */
end_comment

begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_include
include|#
directive|include
file|"perl.h"
end_include

begin_comment
comment|/* call back stuff, atari specific stuff below */
end_comment

begin_comment
comment|/* Be sure to refetch the stack pointer after calling these routines. */
end_comment

begin_function
name|int
name|callback
parameter_list|(
name|subname
parameter_list|,
name|sp
parameter_list|,
name|gimme
parameter_list|,
name|hasargs
parameter_list|,
name|numargs
parameter_list|)
name|char
modifier|*
name|subname
decl_stmt|;
name|int
name|sp
decl_stmt|;
comment|/* stack pointer after args are pushed */
name|int
name|gimme
decl_stmt|;
comment|/* called in array or scalar context */
name|int
name|hasargs
decl_stmt|;
comment|/* whether to create a @_ array for routine */
name|int
name|numargs
decl_stmt|;
comment|/* how many args are pushed on the stack */
block|{
specifier|static
name|ARG
name|myarg
index|[
literal|3
index|]
decl_stmt|;
comment|/* fake syntax tree node */
name|int
name|arglast
index|[
literal|3
index|]
decl_stmt|;
name|arglast
index|[
literal|2
index|]
operator|=
name|sp
expr_stmt|;
name|sp
operator|-=
name|numargs
expr_stmt|;
name|arglast
index|[
literal|1
index|]
operator|=
name|sp
operator|--
expr_stmt|;
name|arglast
index|[
literal|0
index|]
operator|=
name|sp
expr_stmt|;
if|if
condition|(
operator|!
name|myarg
index|[
literal|0
index|]
operator|.
name|arg_ptr
operator|.
name|arg_str
condition|)
name|myarg
index|[
literal|0
index|]
operator|.
name|arg_ptr
operator|.
name|arg_str
operator|=
name|str_make
argument_list|(
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|myarg
index|[
literal|1
index|]
operator|.
name|arg_type
operator|=
name|A_WORD
expr_stmt|;
name|myarg
index|[
literal|1
index|]
operator|.
name|arg_ptr
operator|.
name|arg_stab
operator|=
name|stabent
argument_list|(
name|subname
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|myarg
index|[
literal|2
index|]
operator|.
name|arg_type
operator|=
name|hasargs
condition|?
name|A_EXPR
else|:
name|A_NULL
expr_stmt|;
return|return
name|do_subr
argument_list|(
name|myarg
argument_list|,
name|gimme
argument_list|,
name|arglast
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|callv
parameter_list|(
name|subname
parameter_list|,
name|sp
parameter_list|,
name|gimme
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|subname
decl_stmt|;
specifier|register
name|int
name|sp
decl_stmt|;
comment|/* current stack pointer */
name|int
name|gimme
decl_stmt|;
comment|/* called in array or scalar context */
specifier|register
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
comment|/* null terminated arg list, NULL for no arglist */
block|{
specifier|register
name|int
name|items
init|=
literal|0
decl_stmt|;
name|int
name|hasargs
init|=
operator|(
name|argv
operator|!=
literal|0
operator|)
decl_stmt|;
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|Nullstr
argument_list|)
expr_stmt|;
comment|/* reserve spot for 1st return arg */
if|if
condition|(
name|hasargs
condition|)
block|{
while|while
condition|(
operator|*
name|argv
condition|)
block|{
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_make
argument_list|(
operator|*
name|argv
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|items
operator|++
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
block|}
return|return
name|callback
argument_list|(
name|subname
argument_list|,
name|sp
argument_list|,
name|gimme
argument_list|,
name|hasargs
argument_list|,
name|items
argument_list|)
return|;
block|}
end_function

begin_include
include|#
directive|include
file|<process.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_decl_stmt
name|long
name|_stksize
init|=
literal|64
operator|*
literal|1024L
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|__DEFAULT_BUFSIZ__
init|=
literal|4
operator|*
literal|1024L
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * The following code is based on the do_exec and do_aexec functions  * in file doio.c  */
end_comment

begin_function
name|int
name|do_aspawn
parameter_list|(
name|really
parameter_list|,
name|arglast
parameter_list|)
name|STR
modifier|*
name|really
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
specifier|register
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|1
index|]
decl_stmt|;
specifier|register
name|int
name|items
init|=
name|arglast
index|[
literal|2
index|]
operator|-
name|sp
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|a
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|char
modifier|*
name|tmps
decl_stmt|;
name|int
name|status
decl_stmt|;
if|if
condition|(
name|items
condition|)
block|{
name|New
argument_list|(
literal|1101
argument_list|,
name|argv
argument_list|,
name|items
operator|+
literal|1
argument_list|,
name|char
operator|*
argument_list|)
expr_stmt|;
name|a
operator|=
name|argv
expr_stmt|;
for|for
control|(
name|st
operator|+=
operator|++
name|sp
init|;
name|items
operator|>
literal|0
condition|;
name|items
operator|--
operator|,
name|st
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|st
condition|)
operator|*
name|a
operator|++
operator|=
name|str_get
argument_list|(
operator|*
name|st
argument_list|)
expr_stmt|;
else|else
operator|*
name|a
operator|++
operator|=
literal|""
expr_stmt|;
block|}
operator|*
name|a
operator|=
name|Nullch
expr_stmt|;
if|if
condition|(
name|really
operator|&&
operator|*
operator|(
name|tmps
operator|=
name|str_get
argument_list|(
name|really
argument_list|)
operator|)
condition|)
name|status
operator|=
name|spawnvp
argument_list|(
operator|-
name|P_WAIT
argument_list|,
name|tmps
argument_list|,
name|argv
argument_list|)
expr_stmt|;
comment|/* -P_WAIT is a hack, see spawnvp.c in the lib */
else|else
name|status
operator|=
name|spawnvp
argument_list|(
operator|-
name|P_WAIT
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|Safefree
argument_list|(
name|argv
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|int
name|do_spawn
parameter_list|(
name|cmd
parameter_list|)
name|char
modifier|*
name|cmd
decl_stmt|;
block|{
return|return
name|system
argument_list|(
name|cmd
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* patchlevel 79 onwards we can */
end_comment

begin_comment
comment|/*  * we unfortunately cannot use the super efficient fread/write from the lib  */
end_comment

begin_endif
unit|size_t fread(void *data, size_t size, size_t count, FILE *fp) {     size_t i, j;     unsigned char *buf = (unsigned char *)data;     int c;      for(i = 0; i< count; i++)     { 	for(j = 0; j< size; j++) 	{ 	    if((c = getc(fp)) == EOF) 	       return 0; 	    *buf++ = c;         }     }     return i; }  size_t fwrite(const void *data, size_t size, size_t count, FILE *fp) {     size_t i, j;     const unsigned char *buf = (const unsigned char *)data;      for(i = 0; i< count; i++)     { 	for(j = 0; j< size; j++) 	{ 	    if(fputc(*buf++, fp) == EOF) 	       return 0;         }     }     return i; }
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAS_SYSCALL
end_ifdef

begin_define
define|#
directive|define
name|__NO_INLINE__
end_define

begin_include
include|#
directive|include
file|<osbind.h>
end_include

begin_comment
comment|/* must include this for proper protos */
end_comment

begin_comment
comment|/* these must match osbind.pl */
end_comment

begin_define
define|#
directive|define
name|TRAP_1_W
value|1
end_define

begin_define
define|#
directive|define
name|TRAP_1_WW
value|2
end_define

begin_define
define|#
directive|define
name|TRAP_1_WL
value|3
end_define

begin_define
define|#
directive|define
name|TRAP_1_WLW
value|4
end_define

begin_define
define|#
directive|define
name|TRAP_1_WWW
value|5
end_define

begin_define
define|#
directive|define
name|TRAP_1_WLL
value|6
end_define

begin_define
define|#
directive|define
name|TRAP_1_WWLL
value|7
end_define

begin_define
define|#
directive|define
name|TRAP_1_WLWW
value|8
end_define

begin_define
define|#
directive|define
name|TRAP_1_WWLLL
value|9
end_define

begin_define
define|#
directive|define
name|TRAP_13_W
value|10
end_define

begin_define
define|#
directive|define
name|TRAP_13_WW
value|11
end_define

begin_define
define|#
directive|define
name|TRAP_13_WL
value|12
end_define

begin_define
define|#
directive|define
name|TRAP_13_WWW
value|13
end_define

begin_define
define|#
directive|define
name|TRAP_13_WWL
value|14
end_define

begin_define
define|#
directive|define
name|TRAP_13_WWLWWW
value|15
end_define

begin_define
define|#
directive|define
name|TRAP_14_W
value|16
end_define

begin_define
define|#
directive|define
name|TRAP_14_WW
value|17
end_define

begin_define
define|#
directive|define
name|TRAP_14_WL
value|18
end_define

begin_define
define|#
directive|define
name|TRAP_14_WWW
value|19
end_define

begin_define
define|#
directive|define
name|TRAP_14_WWL
value|20
end_define

begin_define
define|#
directive|define
name|TRAP_14_WWLL
value|21
end_define

begin_define
define|#
directive|define
name|TRAP_14_WLLW
value|22
end_define

begin_define
define|#
directive|define
name|TRAP_14_WLLL
value|23
end_define

begin_define
define|#
directive|define
name|TRAP_14_WWWL
value|24
end_define

begin_define
define|#
directive|define
name|TRAP_14_WWWWL
value|25
end_define

begin_define
define|#
directive|define
name|TRAP_14_WLLWW
value|26
end_define

begin_define
define|#
directive|define
name|TRAP_14_WWWWWWW
value|27
end_define

begin_define
define|#
directive|define
name|TRAP_14_WLLWWWWW
value|28
end_define

begin_define
define|#
directive|define
name|TRAP_14_WLLWWWWLW
value|29
end_define

begin_define
define|#
directive|define
name|TRAP_14_WLLWWWWWLW
value|30
end_define

begin_function
name|int
name|syscall
parameter_list|(
name|trap
parameter_list|,
name|fn
parameter_list|,
name|a1
parameter_list|,
name|a2
parameter_list|,
name|a3
parameter_list|,
name|a4
parameter_list|,
name|a5
parameter_list|,
name|a6
parameter_list|,
name|a7
parameter_list|,
name|a8
parameter_list|,
name|a9
parameter_list|,
name|a10
parameter_list|,
name|a11
parameter_list|,
name|a12
parameter_list|)
name|unsigned
name|long
name|trap
decl_stmt|,
name|fn
decl_stmt|,
name|a1
decl_stmt|,
name|a2
decl_stmt|,
name|a3
decl_stmt|,
name|a4
decl_stmt|,
name|a5
decl_stmt|,
name|a6
decl_stmt|,
name|a7
decl_stmt|,
name|a8
decl_stmt|,
name|a9
decl_stmt|,
name|a10
decl_stmt|,
name|a11
decl_stmt|,
name|a12
decl_stmt|;
block|{
comment|/* for now */
switch|switch
condition|(
name|trap
condition|)
block|{
case|case
name|TRAP_1_W
case|:
return|return
name|trap_1_w
argument_list|(
name|fn
argument_list|)
return|;
case|case
name|TRAP_1_WW
case|:
return|return
name|trap_1_ww
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|)
return|;
case|case
name|TRAP_1_WL
case|:
return|return
name|trap_1_wl
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|)
return|;
case|case
name|TRAP_1_WLW
case|:
return|return
name|trap_1_wlw
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
return|;
case|case
name|TRAP_1_WWW
case|:
return|return
name|trap_1_www
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
return|;
case|case
name|TRAP_1_WLL
case|:
return|return
name|trap_1_wll
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
return|;
case|case
name|TRAP_1_WWLL
case|:
return|return
name|trap_1_wwll
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|)
return|;
case|case
name|TRAP_1_WLWW
case|:
return|return
name|trap_1_wlww
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|)
return|;
case|case
name|TRAP_1_WWLLL
case|:
return|return
name|trap_1_wwlll
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|)
return|;
case|case
name|TRAP_13_W
case|:
return|return
name|trap_13_w
argument_list|(
name|fn
argument_list|)
return|;
case|case
name|TRAP_13_WW
case|:
return|return
name|trap_13_ww
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|)
return|;
case|case
name|TRAP_13_WL
case|:
return|return
name|trap_13_wl
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|)
return|;
case|case
name|TRAP_13_WWW
case|:
return|return
name|trap_13_www
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
return|;
case|case
name|TRAP_13_WWL
case|:
return|return
name|trap_13_wwl
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
return|;
case|case
name|TRAP_13_WWLWWW
case|:
return|return
name|trap_13_wwlwww
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|)
return|;
case|case
name|TRAP_14_W
case|:
return|return
name|trap_14_w
argument_list|(
name|fn
argument_list|)
return|;
case|case
name|TRAP_14_WW
case|:
return|return
name|trap_14_ww
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|)
return|;
case|case
name|TRAP_14_WL
case|:
return|return
name|trap_14_wl
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|)
return|;
case|case
name|TRAP_14_WWW
case|:
return|return
name|trap_14_www
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
return|;
case|case
name|TRAP_14_WWL
case|:
return|return
name|trap_14_wwl
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
return|;
case|case
name|TRAP_14_WWLL
case|:
return|return
name|trap_14_wwll
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|)
return|;
case|case
name|TRAP_14_WLLW
case|:
return|return
name|trap_14_wllw
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|)
return|;
case|case
name|TRAP_14_WLLL
case|:
return|return
name|trap_14_wlll
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|)
return|;
case|case
name|TRAP_14_WWWL
case|:
return|return
name|trap_14_wwwl
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|)
return|;
case|case
name|TRAP_14_WWWWL
case|:
return|return
name|trap_14_wwwwl
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|)
return|;
case|case
name|TRAP_14_WLLWW
case|:
return|return
name|trap_14_wllww
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|)
return|;
case|case
name|TRAP_14_WWWWWWW
case|:
return|return
name|trap_14_wwwwwww
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|,
name|a6
argument_list|)
return|;
case|case
name|TRAP_14_WLLWWWWW
case|:
return|return
name|trap_14_wllwwwww
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|,
name|a6
argument_list|,
name|a7
argument_list|)
return|;
case|case
name|TRAP_14_WLLWWWWLW
case|:
return|return
name|trap_14_wllwwwwlw
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|,
name|a6
argument_list|,
name|a7
argument_list|,
name|a8
argument_list|)
return|;
case|case
name|TRAP_14_WLLWWWWWLW
case|:
return|return
name|trap_14_wllwwwwwlw
argument_list|(
name|fn
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|,
name|a6
argument_list|,
name|a7
argument_list|,
name|a8
argument_list|,
name|a9
argument_list|)
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


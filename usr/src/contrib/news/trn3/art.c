begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Id: art.c,v 3.0 1992/02/01 03:09:32 davison Trn $  */
end_comment

begin_comment
comment|/* This software is Copyright 1991 by Stan Barber.   *  * Permission is hereby granted to copy, reproduce, redistribute or otherwise  * use this software as long as: there is no monetary profit gained  * specifically from the use or reproduction of this software, it is not  * sold, rented, traded or otherwise marketed, and this copyright notice is  * included prominently in any copy made.   *  * The author make no claims as to the fitness or correctness of this software  * for any use whatsoever, and it is provided as is. Any use of this software  * is at the user's own risk.   */
end_comment

begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"trn.h"
end_include

begin_include
include|#
directive|include
file|"ngstuff.h"
end_include

begin_include
include|#
directive|include
file|"ngdata.h"
end_include

begin_include
include|#
directive|include
file|"cache.h"
end_include

begin_include
include|#
directive|include
file|"bits.h"
end_include

begin_include
include|#
directive|include
file|"head.h"
end_include

begin_include
include|#
directive|include
file|"help.h"
end_include

begin_include
include|#
directive|include
file|"search.h"
end_include

begin_include
include|#
directive|include
file|"artio.h"
end_include

begin_include
include|#
directive|include
file|"ng.h"
end_include

begin_include
include|#
directive|include
file|"final.h"
end_include

begin_include
include|#
directive|include
file|"artstate.h"
end_include

begin_include
include|#
directive|include
file|"rcstuff.h"
end_include

begin_include
include|#
directive|include
file|"term.h"
end_include

begin_include
include|#
directive|include
file|"sw.h"
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"backpage.h"
end_include

begin_include
include|#
directive|include
file|"intrp.h"
end_include

begin_include
include|#
directive|include
file|"rthread.h"
end_include

begin_include
include|#
directive|include
file|"rt-select.h"
end_include

begin_include
include|#
directive|include
file|"rt-util.h"
end_include

begin_include
include|#
directive|include
file|"rt-wumpus.h"
end_include

begin_include
include|#
directive|include
file|"INTERN.h"
end_include

begin_include
include|#
directive|include
file|"art.h"
end_include

begin_comment
comment|/* page_switch() return values */
end_comment

begin_define
define|#
directive|define
name|PS_NORM
value|0
end_define

begin_define
define|#
directive|define
name|PS_ASK
value|1
end_define

begin_define
define|#
directive|define
name|PS_RAISE
value|2
end_define

begin_define
define|#
directive|define
name|PS_TOEND
value|3
end_define

begin_decl_stmt
name|bool
name|special
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* is next page special length? */
end_comment

begin_decl_stmt
name|int
name|slines
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* how long to make page when special */
end_comment

begin_decl_stmt
name|ART_LINE
name|highlight
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* next line to be highlighted */
end_comment

begin_decl_stmt
name|char
modifier|*
name|restart
init|=
name|Nullch
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* if nonzero, the place where last */
end_comment

begin_comment
comment|/* line left off on line split */
end_comment

begin_decl_stmt
name|char
modifier|*
name|blinebeg
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* where in buffer current line began */
end_comment

begin_decl_stmt
name|ART_POS
name|alinebeg
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* where in file current line began */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INNERSEARCH
end_ifdef

begin_decl_stmt
name|ART_POS
name|innersearch
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* artpos of end of line we found */
end_comment

begin_comment
comment|/* for 'g' command */
end_comment

begin_decl_stmt
name|ART_LINE
name|isrchline
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* last line to display */
end_comment

begin_decl_stmt
name|bool
name|hide_everything
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* if set, do not write page now, */
end_comment

begin_comment
comment|/* but refresh when done with page */
end_comment

begin_decl_stmt
name|COMPEX
name|gcompex
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* in article search pattern */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|bool
name|firstpage
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* is this the 1st page of article? */
end_comment

begin_decl_stmt
name|char
name|art_buf
index|[
name|LBUFLEN
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* place for article lines */
end_comment

begin_function
name|void
name|art_init
parameter_list|()
block|{
empty_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|METAMAIL
end_ifdef

begin_define
define|#
directive|define
name|VERY_LONG_STRING
value|200
end_define

begin_function
name|int
name|display_mime
parameter_list|()
block|{
if|if
condition|(
operator|!
name|getenv
argument_list|(
literal|"NOMETAMAIL"
argument_list|)
condition|)
block|{
name|int
name|code
decl_stmt|;
name|interp
argument_list|(
name|cmd_buf
argument_list|,
operator|(
sizeof|sizeof
name|cmd_buf
operator|)
argument_list|,
name|getval
argument_list|(
literal|"MIMESHOW"
argument_list|,
name|MIMESHOW
argument_list|)
argument_list|)
expr_stmt|;
name|termlib_reset
argument_list|()
expr_stmt|;
name|resetty
argument_list|()
expr_stmt|;
name|code
operator|=
name|doshell
argument_list|(
name|SH
argument_list|,
name|cmd_buf
argument_list|)
expr_stmt|;
name|noecho
argument_list|()
expr_stmt|;
name|crmode
argument_list|()
expr_stmt|;
name|termlib_init
argument_list|()
expr_stmt|;
return|return
name|code
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|do_article
parameter_list|()
block|{
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
name|ART_POS
name|artsize
decl_stmt|;
comment|/* size in bytes of article */
name|bool
name|hide_this_line
init|=
name|FALSE
decl_stmt|;
comment|/* hidden header line? */
name|ART_LINE
name|linenum
decl_stmt|;
comment|/* line # on page, 1 origin */
ifdef|#
directive|ifdef
name|ULSMARTS
name|bool
name|under_lining
init|=
name|FALSE
decl_stmt|;
comment|/* are we underlining a word? */
endif|#
directive|endif
specifier|register
name|char
modifier|*
name|bufptr
init|=
name|art_buf
decl_stmt|;
comment|/* pointer to input buffer */
specifier|register
name|int
name|outpos
decl_stmt|;
comment|/* column position of output */
specifier|static
name|char
name|prompt_buf
index|[
literal|64
index|]
decl_stmt|;
comment|/* place to hold prompt */
name|bool
name|notesfiles
init|=
name|FALSE
decl_stmt|;
comment|/* might there be notesfiles junk? */
name|char
name|oldmode
init|=
name|mode
decl_stmt|;
name|char
modifier|*
name|ctime
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|METAMAIL
name|bool
name|tried_display_mime
init|=
name|FALSE
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INNERSEARCH
specifier|register
name|int
name|outputok
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|METAMAIL
name|mime_article
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|artfp
argument_list|)
argument_list|,
operator|&
name|filestat
argument_list|)
condition|)
comment|/* get article file stats */
return|return
name|DA_CLEAN
return|;
if|if
condition|(
operator|(
name|filestat
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFREG
condition|)
return|return
name|DA_NORM
return|;
name|artsize
operator|=
name|filestat
operator|.
name|st_size
expr_stmt|;
comment|/* from that get article size */
name|sprintf
argument_list|(
name|prompt_buf
argument_list|,
literal|"%%sEnd of article %ld (of %ld) -- what next? [%%s]"
argument_list|,
operator|(
name|long
operator|)
name|art
argument_list|,
operator|(
name|long
operator|)
name|lastart
argument_list|)
expr_stmt|;
comment|/* format prompt string */
name|prompt
operator|=
name|prompt_buf
expr_stmt|;
name|int_count
operator|=
literal|0
expr_stmt|;
comment|/* interrupt count is 0 */
if|if
condition|(
operator|(
name|firstpage
operator|=
operator|(
name|topline
operator|<
literal|0
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|parseheader
argument_list|(
name|art
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|artfp
argument_list|,
name|htype
index|[
name|PAST_HEADER
index|]
operator|.
name|ht_minpos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* for each page */
if|if
condition|(
name|ThreadedGroup
operator|&&
name|max_tree_lines
condition|)
name|init_tree
argument_list|()
expr_stmt|;
comment|/* init tree display */
name|assert
argument_list|(
name|art
operator|==
name|openart
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_fseek
condition|)
block|{
name|parseheader
argument_list|(
name|art
argument_list|)
expr_stmt|;
comment|/* make sure header is ours */
name|artpos
operator|=
name|vrdary
argument_list|(
name|artline
argument_list|)
expr_stmt|;
if|if
condition|(
name|artpos
operator|<
literal|0
condition|)
name|artpos
operator|=
operator|-
name|artpos
expr_stmt|;
comment|/* labs(), anyone? */
if|if
condition|(
name|firstpage
condition|)
name|artpos
operator|=
operator|(
name|ART_POS
operator|)
literal|0
expr_stmt|;
if|if
condition|(
name|artpos
operator|<
name|htype
index|[
name|PAST_HEADER
index|]
operator|.
name|ht_minpos
condition|)
block|{
name|in_header
operator|=
name|SOME_LINE
expr_stmt|;
name|fseek
argument_list|(
name|artfp
argument_list|,
name|htype
index|[
name|PAST_HEADER
index|]
operator|.
name|ht_minpos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|fseek
argument_list|(
name|artfp
argument_list|,
name|artpos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|do_fseek
operator|=
name|FALSE
expr_stmt|;
name|restart
operator|=
name|Nullch
expr_stmt|;
block|}
name|linenum
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|firstpage
condition|)
block|{
if|if
condition|(
name|firstline
condition|)
block|{
name|interp
argument_list|(
name|art_buf
argument_list|,
operator|(
sizeof|sizeof
name|art_buf
operator|)
argument_list|,
name|firstline
argument_list|)
expr_stmt|;
name|linenum
operator|+=
name|tree_puts
argument_list|(
name|art_buf
argument_list|,
name|linenum
operator|+
name|topline
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|artopen
argument_list|(
name|art
argument_list|)
expr_stmt|;
comment|/* rewind article in case interp */
comment|/* forced a header parse */
block|}
else|else
block|{
name|ART_NUM
name|i
decl_stmt|;
name|int
name|selected
decl_stmt|,
name|unseen
decl_stmt|;
name|selected
operator|=
operator|(
name|curr_artp
operator|->
name|flags
operator|&
name|AF_SEL
operator|)
expr_stmt|;
name|unseen
operator|=
operator|!
name|was_read
argument_list|(
name|art
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|art_buf
argument_list|,
literal|"%s%s #%ld"
argument_list|,
name|ngname
argument_list|,
name|moderated
argument_list|,
operator|(
name|long
operator|)
name|art
argument_list|)
expr_stmt|;
if|if
condition|(
name|selected_only
condition|)
block|{
name|i
operator|=
name|selected_count
operator|-
operator|(
name|unseen
operator|&&
name|selected
operator|)
expr_stmt|;
name|sprintf
argument_list|(
name|art_buf
operator|+
name|strlen
argument_list|(
name|art_buf
argument_list|)
argument_list|,
literal|" (%ld + %ld more)"
argument_list|,
operator|(
name|long
operator|)
name|i
argument_list|,
operator|(
name|long
operator|)
name|toread
index|[
name|ng
index|]
operator|-
name|selected_count
operator|-
operator|(
operator|!
name|selected
operator|&&
name|unseen
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|i
operator|=
call|(
name|ART_NUM
call|)
argument_list|(
name|toread
index|[
name|ng
index|]
operator|-
name|unseen
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
operator|!
name|ThreadedGroup
operator|&&
name|dmcount
operator|)
condition|)
name|sprintf
argument_list|(
name|art_buf
operator|+
name|strlen
argument_list|(
name|art_buf
argument_list|)
argument_list|,
literal|" (%ld more)"
argument_list|,
operator|(
name|long
operator|)
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ThreadedGroup
operator|&&
name|dmcount
condition|)
name|sprintf
argument_list|(
name|art_buf
operator|+
name|strlen
argument_list|(
name|art_buf
argument_list|)
operator|-
literal|1
argument_list|,
literal|" + %ld Marked to return)"
argument_list|,
operator|(
name|long
operator|)
name|dmcount
argument_list|)
expr_stmt|;
name|linenum
operator|+=
name|tree_puts
argument_list|(
name|art_buf
argument_list|,
name|linenum
operator|+
name|topline
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|start_header
argument_list|(
name|art
argument_list|)
expr_stmt|;
name|forcelast
operator|=
name|FALSE
expr_stmt|;
comment|/* we will have our day in court */
name|restart
operator|=
name|Nullch
expr_stmt|;
name|artline
operator|=
literal|0
expr_stmt|;
comment|/* start counting lines */
name|artpos
operator|=
literal|0
expr_stmt|;
name|vwtary
argument_list|(
name|artline
argument_list|,
name|artpos
argument_list|)
expr_stmt|;
comment|/* remember pos in file */
block|}
for|for
control|(
init|;
comment|/* linenum already set */
name|in_header
operator|||
operator|(
ifdef|#
directive|ifdef
name|INNERSEARCH
name|innersearch
condition|?
name|innermore
argument_list|()
else|:
endif|#
directive|endif
name|linenum
operator|<
operator|(
name|firstpage
condition|?
name|initlines
else|:
operator|(
name|special
condition|?
name|slines
else|:
name|LINES
operator|)
operator|)
operator|)
condition|;
name|linenum
operator|++
control|)
block|{
comment|/* for each line on page */
if|if
condition|(
name|int_count
condition|)
block|{
comment|/* exit via interrupt? */
name|putchar
argument_list|(
literal|'\n'
argument_list|)
name|FLUSH
expr_stmt|;
comment|/* get to left margin */
name|int_count
operator|=
literal|0
expr_stmt|;
comment|/* reset interrupt count */
name|mode
operator|=
name|oldmode
expr_stmt|;
name|special
operator|=
name|FALSE
expr_stmt|;
return|return
name|DA_NORM
return|;
comment|/* skip out of loops */
block|}
if|if
condition|(
name|restart
condition|)
block|{
comment|/* did not finish last line? */
name|bufptr
operator|=
name|restart
expr_stmt|;
comment|/* then start again here */
name|restart
operator|=
name|Nullch
expr_stmt|;
comment|/* and reset the flag */
block|}
elseif|else
if|if
condition|(
name|in_header
operator|&&
name|headbuf
index|[
name|artpos
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|bufptr
operator|=
name|index
argument_list|(
name|headbuf
operator|+
name|artpos
argument_list|,
literal|'\n'
argument_list|)
operator|+
literal|1
expr_stmt|;
name|bcopy
argument_list|(
name|headbuf
operator|+
name|artpos
argument_list|,
name|art_buf
argument_list|,
name|bufptr
operator|-
name|headbuf
operator|-
name|artpos
argument_list|)
expr_stmt|;
name|art_buf
index|[
name|bufptr
operator|-
name|headbuf
operator|-
name|artpos
index|]
operator|=
literal|'\0'
expr_stmt|;
name|bufptr
operator|=
name|art_buf
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|fgets
argument_list|(
name|art_buf
argument_list|,
name|LBUFLEN
argument_list|,
name|artfp
argument_list|)
operator|==
name|Nullch
condition|)
block|{
comment|/* if all done */
name|mode
operator|=
name|oldmode
expr_stmt|;
name|special
operator|=
name|FALSE
expr_stmt|;
return|return
name|DA_NORM
return|;
comment|/* skip out of loops */
block|}
name|bufptr
operator|=
name|art_buf
expr_stmt|;
comment|/* so start at beginning */
name|art_buf
index|[
name|LBUFLEN
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* make sure string ends */
block|}
name|blinebeg
operator|=
name|bufptr
expr_stmt|;
comment|/* remember where we began */
name|alinebeg
operator|=
name|artpos
expr_stmt|;
comment|/* both in buffer and file */
if|if
condition|(
name|in_header
operator|&&
name|bufptr
operator|==
name|art_buf
condition|)
block|{
name|hide_this_line
operator|=
name|parseline
argument_list|(
name|art_buf
argument_list|,
name|do_hiding
argument_list|,
name|hide_this_line
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in_header
condition|)
block|{
name|linenum
operator|+=
name|finish_tree
argument_list|(
name|linenum
operator|+
name|topline
argument_list|)
expr_stmt|;
name|end_header
argument_list|()
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|notesfiles
operator|&&
name|do_hiding
operator|&&
name|bufptr
operator|==
name|art_buf
operator|&&
operator|*
name|art_buf
operator|==
literal|'#'
operator|&&
name|isupper
argument_list|(
name|art_buf
index|[
literal|1
index|]
argument_list|)
operator|&&
name|art_buf
index|[
literal|2
index|]
operator|==
literal|':'
condition|)
block|{
name|fgets
argument_list|(
name|art_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|art_buf
argument_list|)
argument_list|,
name|artfp
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
argument_list|(
name|art_buf
argument_list|,
literal|'!'
argument_list|)
operator|!=
name|Nullch
condition|)
name|fgets
argument_list|(
name|art_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|art_buf
argument_list|)
argument_list|,
name|artfp
argument_list|)
expr_stmt|;
name|htype
index|[
name|PAST_HEADER
index|]
operator|.
name|ht_minpos
operator|=
name|ftell
argument_list|(
name|artfp
argument_list|)
expr_stmt|;
comment|/* exclude notesfiles droppings */
name|hide_this_line
operator|=
name|TRUE
expr_stmt|;
comment|/* and do not print either */
name|notesfiles
operator|=
name|FALSE
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CUSTOMLINES
if|if
condition|(
name|hideline
operator|&&
name|bufptr
operator|==
name|art_buf
operator|&&
name|execute
argument_list|(
operator|&
name|hide_compex
argument_list|,
name|art_buf
argument_list|)
condition|)
name|hide_this_line
operator|=
name|TRUE
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|in_header
operator|&&
name|htype
index|[
name|in_header
index|]
operator|.
name|ht_flags
operator|&
name|HT_MAGIC
condition|)
block|{
if|if
condition|(
name|in_header
operator|==
name|NGS_LINE
condition|)
block|{
if|if
condition|(
operator|(
name|s
operator|=
name|index
argument_list|(
name|art_buf
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|!=
name|Nullch
condition|)
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
name|hide_this_line
operator|=
operator|(
name|index
argument_list|(
name|art_buf
argument_list|,
literal|','
argument_list|)
operator|==
name|Nullch
operator|)
operator|&&
name|strEQ
argument_list|(
name|art_buf
operator|+
literal|12
argument_list|,
name|ngname
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|Nullch
condition|)
operator|*
name|s
operator|=
literal|'\n'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|in_header
operator|==
name|EXPIR_LINE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|htype
index|[
name|EXPIR_LINE
index|]
operator|.
name|ht_flags
operator|&
name|HT_HIDE
operator|)
condition|)
name|hide_this_line
operator|=
operator|(
name|strlen
argument_list|(
name|art_buf
argument_list|)
operator|<
literal|10
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|in_header
operator|==
name|FROM_LINE
condition|)
block|{
if|if
condition|(
name|do_hiding
operator|&&
operator|(
name|s
operator|=
name|extract_name
argument_list|(
name|art_buf
operator|+
literal|6
argument_list|)
operator|)
operator|!=
name|Nullch
condition|)
name|strcpy
argument_list|(
name|art_buf
operator|+
literal|6
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|in_header
operator|==
name|DATE_LINE
condition|)
block|{
if|if
condition|(
name|do_hiding
operator|&&
name|curr_artp
operator|->
name|date
operator|!=
operator|-
literal|1
condition|)
name|strftime
argument_list|(
name|art_buf
operator|+
literal|6
argument_list|,
sizeof|sizeof
argument_list|(
name|art_buf
argument_list|)
operator|-
literal|6
argument_list|,
name|getval
argument_list|(
literal|"LOCALTIMEFMT"
argument_list|,
name|LOCALTIMEFMT
argument_list|)
argument_list|,
name|localtime
argument_list|(
operator|&
name|curr_artp
operator|->
name|date
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|METAMAIL
elseif|else
if|if
condition|(
name|in_header
operator|==
name|CONTENT_LINE
condition|)
block|{
name|mime_article
operator|=
name|nontext
argument_list|(
name|art_buf
operator|+
literal|14
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
name|in_header
operator|==
name|SUBJ_LINE
operator|&&
name|htype
index|[
name|SUBJ_LINE
index|]
operator|.
name|ht_flags
operator|&
name|HT_MAGIC
condition|)
block|{
comment|/* is this the subject? */
name|int
name|length
decl_stmt|;
name|length
operator|=
name|strlen
argument_list|(
name|art_buf
argument_list|)
operator|-
literal|1
expr_stmt|;
name|artline
operator|++
expr_stmt|;
name|art_buf
index|[
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* wipe out newline */
ifdef|#
directive|ifdef
name|NOFIREWORKS
name|no_ulfire
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|notesfiles
operator|=
operator|(
name|instr
argument_list|(
operator|&
name|art_buf
index|[
name|length
operator|-
literal|10
index|]
argument_list|,
literal|" - (nf"
argument_list|,
name|TRUE
argument_list|)
operator|!=
name|Nullch
operator|)
expr_stmt|;
comment|/* tree_puts(, ,1) underlines subject */
name|linenum
operator|+=
name|tree_puts
argument_list|(
name|art_buf
argument_list|,
name|linenum
operator|+
name|topline
argument_list|,
literal|1
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hide_this_line
operator|&&
name|do_hiding
condition|)
block|{
comment|/* do not print line? */
name|linenum
operator|--
expr_stmt|;
comment|/* compensate for linenum++ */
if|if
condition|(
operator|!
name|in_header
condition|)
name|hide_this_line
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|in_header
condition|)
block|{
name|artline
operator|++
expr_stmt|;
name|linenum
operator|+=
name|tree_puts
argument_list|(
name|art_buf
argument_list|,
name|linenum
operator|+
name|topline
argument_list|,
literal|0
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* just a normal line */
ifdef|#
directive|ifdef
name|METAMAIL
if|if
condition|(
name|mime_article
operator|&&
operator|!
name|tried_display_mime
condition|)
block|{
if|if
condition|(
name|display_mime
argument_list|()
operator|==
literal|0
condition|)
return|return
name|DA_NORM
return|;
else|else
name|tried_display_mime
operator|=
name|TRUE
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|highlight
operator|==
name|artline
condition|)
block|{
comment|/* this line to be highlit? */
if|if
condition|(
name|marking
operator|==
name|STANDOUT
condition|)
block|{
ifdef|#
directive|ifdef
name|NOFIREWORKS
if|if
condition|(
name|erase_screen
condition|)
name|no_sofire
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|standout
argument_list|()
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|NOFIREWORKS
if|if
condition|(
name|erase_screen
condition|)
name|no_ulfire
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|underline
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|bufptr
operator|==
literal|'\n'
condition|)
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|INNERSEARCH
name|outputok
operator|=
operator|!
name|hide_everything
expr_stmt|;
comment|/* get it into register, hopefully */
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CLEAREOL
ifdef|#
directive|ifdef
name|INNERSEARCH
if|if
condition|(
name|outputok
condition|)
endif|#
directive|endif
name|maybe_eol
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* CLEAREOL */
ifdef|#
directive|ifdef
name|CUSTOMLINES
if|if
condition|(
name|pagestop
operator|&&
name|bufptr
operator|==
name|art_buf
operator|&&
name|execute
argument_list|(
operator|&
name|page_compex
argument_list|,
name|art_buf
argument_list|)
condition|)
name|linenum
operator|=
literal|32700
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|outpos
operator|=
literal|0
init|;
name|outpos
operator|<
name|COLS
condition|;
control|)
block|{
comment|/* while line has room */
if|if
condition|(
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|bufptr
operator|>=
literal|' '
condition|)
block|{
comment|/* normal char? */
ifdef|#
directive|ifdef
name|ULSMARTS
if|if
condition|(
operator|*
name|bufptr
operator|==
literal|'_'
condition|)
block|{
if|if
condition|(
name|bufptr
index|[
literal|1
index|]
operator|==
literal|'\b'
condition|)
block|{
if|if
condition|(
operator|!
name|under_lining
operator|&&
name|highlight
operator|!=
name|artline
ifdef|#
directive|ifdef
name|INNERSEARCH
operator|&&
name|outputok
endif|#
directive|endif
condition|)
block|{
name|under_lining
operator|++
expr_stmt|;
if|if
condition|(
name|UG
condition|)
block|{
if|if
condition|(
name|bufptr
operator|!=
name|buf
operator|&&
name|bufptr
index|[
operator|-
literal|1
index|]
operator|==
literal|' '
condition|)
block|{
name|outpos
operator|--
expr_stmt|;
name|backspace
argument_list|()
expr_stmt|;
block|}
block|}
name|underline
argument_list|()
expr_stmt|;
block|}
name|bufptr
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|under_lining
condition|)
block|{
name|under_lining
operator|=
literal|0
expr_stmt|;
name|un_underline
argument_list|()
expr_stmt|;
if|if
condition|(
name|UG
condition|)
block|{
if|if
condition|(
operator|*
name|bufptr
operator|==
literal|' '
condition|)
goto|goto
name|skip_put
goto|;
name|outpos
operator|++
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INNERSEARCH
if|if
condition|(
name|outputok
condition|)
endif|#
directive|endif
block|{
ifdef|#
directive|ifdef
name|ROTATION
if|if
condition|(
name|rotate
operator|&&
operator|!
name|in_header
operator|&&
name|isalpha
argument_list|(
operator|*
name|bufptr
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|bufptr
operator|&
literal|31
operator|)
operator|<=
literal|13
condition|)
name|putchar
argument_list|(
operator|*
name|bufptr
operator|+
literal|13
argument_list|)
expr_stmt|;
else|else
name|putchar
argument_list|(
operator|*
name|bufptr
operator|-
literal|13
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|putchar
argument_list|(
operator|*
name|bufptr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|UC
operator|&&
operator|(
operator|(
name|highlight
operator|==
name|artline
operator|&&
name|marking
operator|==
literal|1
operator|)
ifdef|#
directive|ifdef
name|ULSMARTS
operator|||
name|under_lining
endif|#
directive|endif
operator|)
condition|)
block|{
name|backspace
argument_list|()
expr_stmt|;
name|underchar
argument_list|()
expr_stmt|;
block|}
name|skip_put
label|:
name|bufptr
operator|++
expr_stmt|;
name|outpos
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|bufptr
operator|==
literal|'\n'
operator|||
operator|!
operator|*
name|bufptr
condition|)
block|{
comment|/* newline? */
ifdef|#
directive|ifdef
name|ULSMARTS
if|if
condition|(
name|under_lining
condition|)
block|{
name|under_lining
operator|=
literal|0
expr_stmt|;
name|un_underline
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|DEB_INNERSRCH
operator|&&
name|outpos
operator|<
name|COLS
operator|-
literal|6
condition|)
block|{
name|standout
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"%4d"
argument_list|,
name|artline
argument_list|)
expr_stmt|;
name|un_standout
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INNERSEARCH
if|if
condition|(
name|outputok
condition|)
endif|#
directive|endif
name|putchar
argument_list|(
literal|'\n'
argument_list|)
name|FLUSH
expr_stmt|;
name|restart
operator|=
literal|0
expr_stmt|;
name|outpos
operator|=
literal|1000
expr_stmt|;
comment|/* signal normal \n */
block|}
elseif|else
if|if
condition|(
operator|*
name|bufptr
operator|==
literal|'\t'
condition|)
block|{
comment|/* tab? */
name|int
name|incpos
init|=
literal|8
operator|-
name|outpos
operator|%
literal|8
decl_stmt|;
ifdef|#
directive|ifdef
name|INNERSEARCH
if|if
condition|(
name|outputok
condition|)
endif|#
directive|endif
if|if
condition|(
name|GT
condition|)
name|putchar
argument_list|(
operator|*
name|bufptr
argument_list|)
expr_stmt|;
else|else
while|while
condition|(
name|incpos
operator|--
condition|)
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|bufptr
operator|++
expr_stmt|;
name|outpos
operator|+=
literal|8
operator|-
name|outpos
operator|%
literal|8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|bufptr
operator|==
literal|'\f'
condition|)
block|{
comment|/* form feed? */
ifdef|#
directive|ifdef
name|INNERSEARCH
if|if
condition|(
name|outputok
condition|)
endif|#
directive|endif
name|fputs
argument_list|(
literal|"^L"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|bufptr
operator|==
name|blinebeg
operator|&&
name|highlight
operator|!=
name|artline
condition|)
name|linenum
operator|=
literal|32700
expr_stmt|;
comment|/* how is that for a magic number? */
name|bufptr
operator|++
expr_stmt|;
name|outpos
operator|+=
literal|2
expr_stmt|;
block|}
else|else
block|{
comment|/* other control char */
ifdef|#
directive|ifdef
name|INNERSEARCH
if|if
condition|(
name|outputok
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
name|dont_filter_control
condition|)
name|putchar
argument_list|(
operator|*
name|bufptr
argument_list|)
expr_stmt|;
else|else
block|{
name|putchar
argument_list|(
literal|'^'
argument_list|)
expr_stmt|;
if|if
condition|(
name|highlight
operator|==
name|artline
operator|&&
operator|*
name|UC
operator|&&
name|marking
operator|==
literal|1
condition|)
block|{
name|backspace
argument_list|()
expr_stmt|;
name|underchar
argument_list|()
expr_stmt|;
name|putchar
argument_list|(
operator|*
name|bufptr
operator|+
literal|64
argument_list|)
expr_stmt|;
name|backspace
argument_list|()
expr_stmt|;
name|underchar
argument_list|()
expr_stmt|;
block|}
else|else
name|putchar
argument_list|(
operator|*
name|bufptr
operator|+
literal|64
argument_list|)
expr_stmt|;
block|}
block|}
name|bufptr
operator|++
expr_stmt|;
name|outpos
operator|+=
literal|2
expr_stmt|;
block|}
block|}
comment|/* end of column loop */
if|if
condition|(
name|outpos
operator|<
literal|1000
condition|)
block|{
comment|/* did line overflow? */
name|restart
operator|=
name|bufptr
expr_stmt|;
comment|/* restart here next time */
if|if
condition|(
operator|!
name|AM
operator|||
name|XN
condition|)
block|{
comment|/* no automatic margins on tty? */
ifdef|#
directive|ifdef
name|INNERSEARCH
comment|/* then move it down ourselves */
if|if
condition|(
name|outputok
condition|)
endif|#
directive|endif
name|putchar
argument_list|(
literal|'\n'
argument_list|)
name|FLUSH
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|bufptr
operator|==
literal|'\n'
condition|)
comment|/* skip the newline */
name|restart
operator|=
literal|0
expr_stmt|;
block|}
comment|/* handle normal end of output line formalities */
if|if
condition|(
name|highlight
operator|==
name|artline
condition|)
block|{
comment|/* were we highlighting line? */
if|if
condition|(
name|marking
operator|==
name|STANDOUT
condition|)
name|un_standout
argument_list|()
expr_stmt|;
else|else
name|un_underline
argument_list|()
expr_stmt|;
name|highlight
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* no more we are */
block|}
name|artline
operator|++
expr_stmt|;
comment|/* count the line just printed */
if|if
condition|(
name|artline
operator|-
name|LINES
operator|+
literal|1
operator|>
name|topline
condition|)
comment|/* did we just scroll top line off? */
name|topline
operator|=
name|artline
operator|-
name|LINES
operator|+
literal|1
expr_stmt|;
comment|/* then recompute top line # */
block|}
comment|/* determine actual position in file */
if|if
condition|(
name|restart
condition|)
comment|/* stranded somewhere in the buffer? */
name|artpos
operator|+=
name|restart
operator|-
name|blinebeg
expr_stmt|;
comment|/* just calculate position */
elseif|else
if|if
condition|(
name|in_header
condition|)
name|artpos
operator|=
name|index
argument_list|(
name|headbuf
operator|+
name|artpos
argument_list|,
literal|'\n'
argument_list|)
operator|-
name|headbuf
operator|+
literal|1
expr_stmt|;
else|else
comment|/* no, ftell will do */
name|artpos
operator|=
name|ftell
argument_list|(
name|artfp
argument_list|)
expr_stmt|;
name|vwtary
argument_list|(
name|artline
argument_list|,
name|artpos
argument_list|)
expr_stmt|;
comment|/* remember pos in file */
block|}
comment|/* end of line loop */
ifdef|#
directive|ifdef
name|INNERSEARCH
name|innersearch
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|hide_everything
condition|)
block|{
name|hide_everything
operator|=
name|FALSE
expr_stmt|;
operator|*
name|buf
operator|=
name|Ctl
argument_list|(
literal|'l'
argument_list|)
expr_stmt|;
goto|goto
name|fake_command
goto|;
block|}
endif|#
directive|endif
if|if
condition|(
name|linenum
operator|>=
literal|32700
condition|)
comment|/* did last line have formfeed? */
name|vwtary
argument_list|(
name|artline
operator|-
literal|1
argument_list|,
operator|-
name|vrdary
argument_list|(
name|artline
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* remember by negating pos in file */
name|special
operator|=
name|FALSE
expr_stmt|;
comment|/* end of page, so reset page length */
name|firstpage
operator|=
name|FALSE
expr_stmt|;
comment|/* and say it is not 1st time thru */
comment|/* extra loop bombout */
if|if
condition|(
name|artpos
operator|==
name|artsize
condition|)
block|{
comment|/* did we just now reach EOF? */
name|mode
operator|=
name|oldmode
expr_stmt|;
return|return
name|DA_NORM
return|;
comment|/* avoid --MORE--(100%) */
block|}
comment|/* not done with this article, so pretend we are a pager */
name|reask_pager
label|:
name|unflush_output
argument_list|()
expr_stmt|;
comment|/* disable any ^O in effect */
name|standout
argument_list|()
expr_stmt|;
comment|/* enter standout mode */
name|printf
argument_list|(
literal|"--MORE--(%ld%%)"
argument_list|,
call|(
name|long
call|)
argument_list|(
name|artpos
operator|*
literal|100
operator|/
name|artsize
argument_list|)
argument_list|)
expr_stmt|;
name|un_standout
argument_list|()
expr_stmt|;
comment|/* leave standout mode */
ifdef|#
directive|ifdef
name|CLEAREOL
name|maybe_eol
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
comment|/* reinp_pager:     			/* unused, commented for lint */
name|eat_typeahead
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|DEB_CHECKPOINTING
condition|)
block|{
name|printf
argument_list|(
literal|"(%d %d %d)"
argument_list|,
name|checkcount
argument_list|,
name|linenum
argument_list|,
name|artline
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|checkcount
operator|>=
name|docheckwhen
operator|&&
name|linenum
operator|==
name|LINES
operator|&&
operator|(
name|artline
operator|>
literal|40
operator|||
name|checkcount
operator|>=
name|docheckwhen
operator|+
literal|10
operator|)
condition|)
block|{
comment|/* while he is reading a whole page */
comment|/* in an article he is interested in */
name|checkcount
operator|=
literal|0
expr_stmt|;
name|checkpoint_rc
argument_list|()
expr_stmt|;
comment|/* update .newsrc */
block|}
name|cache_until_key
argument_list|()
expr_stmt|;
name|mode
operator|=
literal|'p'
expr_stmt|;
name|getcmd
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
condition|)
block|{
if|if
condition|(
name|LINES
operator|<
literal|100
operator|&&
operator|!
name|int_count
condition|)
operator|*
name|buf
operator|=
literal|'\f'
expr_stmt|;
comment|/* on CONT fake up refresh */
else|else
block|{
operator|*
name|buf
operator|=
literal|'q'
expr_stmt|;
comment|/* on INTR or paper just quit */
block|}
block|}
name|carriage_return
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|CLEAREOL
name|erase_eol
argument_list|()
expr_stmt|;
comment|/* and erase the prompt */
else|#
directive|else
if|if
condition|(
name|erase_screen
operator|&&
name|can_home_clear
condition|)
name|clear_rest
argument_list|()
expr_stmt|;
else|else
name|erase_eol
argument_list|()
expr_stmt|;
comment|/* and erase the prompt */
endif|#
directive|endif
comment|/* CLEAREOL */
name|carriage_return
argument_list|()
expr_stmt|;
comment|/* Resets kernel's tab column counter to 0 */
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|fake_command
label|:
comment|/* used by innersearch */
name|output_chase_phrase
operator|=
name|TRUE
expr_stmt|;
comment|/* parse and process pager command */
switch|switch
condition|(
name|page_switch
argument_list|()
condition|)
block|{
case|case
name|PS_ASK
case|:
comment|/* reprompt "--MORE--..." */
goto|goto
name|reask_pager
goto|;
case|case
name|PS_RAISE
case|:
comment|/* reparse on article level */
name|mode
operator|=
name|oldmode
expr_stmt|;
return|return
name|DA_RAISE
return|;
case|case
name|PS_TOEND
case|:
comment|/* fast pager loop exit */
name|mode
operator|=
name|oldmode
expr_stmt|;
return|return
name|DA_TOEND
return|;
case|case
name|PS_NORM
case|:
comment|/* display more article */
break|break;
block|}
block|}
comment|/* end of page loop */
block|}
end_function

begin_comment
comment|/* process pager commands */
end_comment

begin_function
name|int
name|page_switch
parameter_list|()
block|{
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
switch|switch
condition|(
operator|*
name|buf
condition|)
block|{
case|case
literal|'d'
case|:
case|case
name|Ctl
argument_list|(
literal|'d'
argument_list|)
case|:
comment|/* half page */
name|special
operator|=
name|TRUE
expr_stmt|;
name|slines
operator|=
name|LINES
operator|/
literal|2
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|marking
operator|&&
operator|*
name|blinebeg
operator|!=
literal|'\f'
ifdef|#
directive|ifdef
name|CUSTOMLINES
operator|&&
operator|(
operator|!
name|pagestop
operator|||
name|blinebeg
operator|!=
name|art_buf
operator|||
operator|!
name|execute
argument_list|(
operator|&
name|page_compex
argument_list|,
name|blinebeg
argument_list|)
operator|)
endif|#
directive|endif
condition|)
block|{
name|up_line
argument_list|()
expr_stmt|;
name|highlight
operator|=
operator|--
name|artline
expr_stmt|;
name|restart
operator|=
name|blinebeg
expr_stmt|;
name|artpos
operator|=
name|alinebeg
expr_stmt|;
block|}
return|return
name|PS_NORM
return|;
case|case
literal|'!'
case|:
comment|/* shell escape */
name|escapade
argument_list|()
expr_stmt|;
return|return
name|PS_ASK
return|;
ifdef|#
directive|ifdef
name|INNERSEARCH
case|case
name|Ctl
argument_list|(
literal|'i'
argument_list|)
case|:
name|gline
operator|=
literal|3
expr_stmt|;
name|sprintf
argument_list|(
name|cmd_buf
argument_list|,
literal|"^[^%c]"
argument_list|,
operator|*
name|blinebeg
argument_list|)
expr_stmt|;
name|compile
argument_list|(
operator|&
name|gcompex
argument_list|,
name|cmd_buf
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
goto|goto
name|caseG
goto|;
case|case
name|Ctl
argument_list|(
literal|'g'
argument_list|)
case|:
name|gline
operator|=
literal|3
expr_stmt|;
name|compile
argument_list|(
operator|&
name|gcompex
argument_list|,
literal|"^Subject:"
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
goto|goto
name|caseG
goto|;
case|case
literal|'g'
case|:
comment|/* in-article search */
if|if
condition|(
operator|!
name|finish_command
argument_list|(
name|FALSE
argument_list|)
condition|)
comment|/* get rest of command */
return|return
name|PS_ASK
return|;
name|s
operator|=
name|buf
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|isspace
argument_list|(
operator|*
name|s
argument_list|)
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|compile
argument_list|(
operator|&
name|gcompex
argument_list|,
name|s
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
operator|)
operator|!=
name|Nullch
condition|)
block|{
comment|/* compile regular expression */
name|printf
argument_list|(
literal|"\n%s\n"
argument_list|,
argument|s
argument_list|)
name|FLUSH
expr_stmt|;
return|return
name|PS_ASK
return|;
block|}
name|carriage_return
argument_list|()
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
comment|/* erase the prompt */
name|carriage_return
argument_list|()
expr_stmt|;
comment|/* Resets kernel's tab column counter to 0 */
comment|/* FALL THROUGH */
name|caseG
label|:
case|case
literal|'G'
case|:
block|{
comment|/* ART_LINE lines_to_skip = 0; */
name|ART_POS
name|start_where
decl_stmt|;
if|if
condition|(
name|gline
operator|<
literal|0
operator|||
name|gline
operator|>
name|LINES
operator|-
literal|2
condition|)
name|gline
operator|=
name|LINES
operator|-
literal|2
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|DEB_INNERSRCH
condition|)
name|printf
argument_list|(
literal|"Start here? %d>=? %d\n"
argument_list|,
argument|topline + gline +
literal|1
argument_list|,
argument|artline
argument_list|)
name|FLUSH
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|*
name|buf
operator|==
name|Ctl
argument_list|(
literal|'i'
argument_list|)
operator|||
name|topline
operator|+
name|gline
operator|+
literal|1
operator|>=
name|artline
condition|)
name|start_where
operator|=
name|artpos
expr_stmt|;
comment|/* in case we had a line wrap */
else|else
block|{
name|start_where
operator|=
name|vrdary
argument_list|(
name|topline
operator|+
name|gline
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|start_where
operator|<
literal|0
condition|)
name|start_where
operator|=
operator|-
name|start_where
expr_stmt|;
block|}
if|if
condition|(
name|start_where
operator|<
name|htype
index|[
name|PAST_HEADER
index|]
operator|.
name|ht_minpos
condition|)
name|start_where
operator|=
name|htype
index|[
name|PAST_HEADER
index|]
operator|.
name|ht_minpos
expr_stmt|;
name|fseek
argument_list|(
name|artfp
argument_list|,
operator|(
name|long
operator|)
name|start_where
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|innersearch
operator|=
literal|0
expr_stmt|;
comment|/* assume not found */
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|artfp
argument_list|)
operator|!=
name|Nullch
condition|)
block|{
comment|/* lines_to_skip++; 		NOT USED NOW */
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|DEB_INNERSRCH
condition|)
name|printf
argument_list|(
literal|"Test %s"
argument_list|,
argument|buf
argument_list|)
name|FLUSH
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|execute
argument_list|(
operator|&
name|gcompex
argument_list|,
name|buf
argument_list|)
operator|!=
name|Nullch
condition|)
block|{
name|innersearch
operator|=
name|ftell
argument_list|(
name|artfp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|innersearch
condition|)
block|{
name|fseek
argument_list|(
name|artfp
argument_list|,
name|artpos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"(Not found)"
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
return|return
name|PS_ASK
return|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|DEB_INNERSRCH
condition|)
name|printf
argument_list|(
literal|"On page? %ld<=? %ld\n"
argument_list|,
argument|(long)innersearch
argument_list|,
argument|(long)artpos
argument_list|)
name|FLUSH
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|innersearch
operator|<=
name|artpos
condition|)
block|{
comment|/* already on page? */
if|if
condition|(
name|innersearch
operator|<
name|artpos
condition|)
block|{
name|artline
operator|=
name|topline
operator|+
literal|1
expr_stmt|;
while|while
condition|(
name|vrdary
argument_list|(
name|artline
argument_list|)
operator|<
name|innersearch
condition|)
name|artline
operator|++
expr_stmt|;
block|}
name|highlight
operator|=
name|artline
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|DEB_INNERSRCH
condition|)
name|printf
argument_list|(
literal|"@ %d\n"
argument_list|,
argument|highlight
argument_list|)
name|FLUSH
expr_stmt|;
endif|#
directive|endif
name|topline
operator|=
name|highlight
operator|-
name|gline
expr_stmt|;
if|if
condition|(
name|topline
operator|<
operator|-
literal|1
condition|)
name|topline
operator|=
operator|-
literal|1
expr_stmt|;
operator|*
name|buf
operator|=
literal|'\f'
expr_stmt|;
comment|/* fake up a refresh */
name|innersearch
operator|=
literal|0
expr_stmt|;
return|return
name|page_switch
argument_list|()
return|;
block|}
else|else
block|{
comment|/* who knows how many lines it is? */
name|do_fseek
operator|=
name|TRUE
expr_stmt|;
name|hide_everything
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
name|PS_NORM
return|;
block|}
else|#
directive|else
case|case
literal|'g'
case|:
case|case
literal|'G'
case|:
case|case
name|Ctl
argument_list|(
literal|'g'
argument_list|)
case|:
name|notincl
argument_list|(
literal|"g"
argument_list|)
expr_stmt|;
return|return
name|PS_ASK
return|;
endif|#
directive|endif
case|case
literal|'\n'
case|:
comment|/* one line */
name|special
operator|=
name|TRUE
expr_stmt|;
name|slines
operator|=
literal|2
expr_stmt|;
return|return
name|PS_NORM
return|;
ifdef|#
directive|ifdef
name|ROTATION
case|case
literal|'X'
case|:
name|rotate
operator|=
operator|!
name|rotate
expr_stmt|;
comment|/* FALL THROUGH */
endif|#
directive|endif
case|case
literal|'l'
case|:
case|case
literal|'\f'
case|:
comment|/* refresh screen */
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|DEB_INNERSRCH
condition|)
block|{
name|printf
argument_list|(
literal|"Topline = %d"
argument_list|,
argument|topline
argument_list|)
name|FLUSH
expr_stmt|;
name|gets
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|clear
argument_list|()
expr_stmt|;
name|carriage_return
argument_list|()
expr_stmt|;
comment|/* Resets kernel's tab column counter to 0 */
name|do_fseek
operator|=
name|TRUE
expr_stmt|;
name|artline
operator|=
name|topline
expr_stmt|;
if|if
condition|(
name|artline
operator|<
literal|0
condition|)
name|artline
operator|=
literal|0
expr_stmt|;
name|firstpage
operator|=
operator|(
name|topline
operator|<
literal|0
operator|)
expr_stmt|;
return|return
name|PS_NORM
return|;
case|case
literal|'b'
case|:
case|case
literal|'\b'
case|:
case|case
name|Ctl
argument_list|(
literal|'b'
argument_list|)
case|:
block|{
comment|/* back up a page */
name|ART_LINE
name|target
decl_stmt|;
ifndef|#
directive|ifndef
name|CLEAREOL
name|clear
argument_list|()
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|can_home_clear
condition|)
comment|/* if we can home do it */
name|home_cursor
argument_list|()
expr_stmt|;
else|else
name|clear
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* CLEAREOL */
name|carriage_return
argument_list|()
expr_stmt|;
comment|/* Resets kernel's tab column counter to 0 */
name|do_fseek
operator|=
name|TRUE
expr_stmt|;
comment|/* reposition article file */
name|target
operator|=
name|topline
operator|-
operator|(
name|LINES
operator|-
literal|2
operator|)
expr_stmt|;
name|artline
operator|=
name|topline
expr_stmt|;
if|if
condition|(
name|artline
operator|>=
literal|0
condition|)
do|do
block|{
name|artline
operator|--
expr_stmt|;
block|}
do|while
condition|(
name|artline
operator|>=
literal|0
operator|&&
name|artline
operator|>
name|target
operator|&&
name|vrdary
argument_list|(
name|artline
operator|-
literal|1
argument_list|)
operator|>=
literal|0
condition|)
do|;
name|topline
operator|=
name|artline
expr_stmt|;
comment|/* remember top line of screen */
comment|/*  (line # within article file) */
if|if
condition|(
name|artline
operator|<
literal|0
condition|)
name|artline
operator|=
literal|0
expr_stmt|;
name|firstpage
operator|=
operator|(
name|topline
operator|<
literal|0
operator|)
expr_stmt|;
return|return
name|PS_NORM
return|;
block|}
case|case
literal|'h'
case|:
block|{
comment|/* help */
name|int
name|cmd
decl_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|=
name|help_page
argument_list|()
operator|)
operator|>
literal|0
condition|)
name|pushchar
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
return|return
name|PS_ASK
return|;
block|}
case|case
literal|'t'
case|:
comment|/* output thread data */
name|page_line
operator|=
literal|1
expr_stmt|;
name|entire_tree
argument_list|(
name|curr_artp
argument_list|)
expr_stmt|;
return|return
name|PS_ASK
return|;
case|case
literal|'_'
case|:
if|if
condition|(
operator|!
name|finish_dblchar
argument_list|()
condition|)
return|return
name|PS_ASK
return|;
switch|switch
condition|(
name|buf
index|[
literal|1
index|]
operator|&
literal|0177
condition|)
block|{
default|default:
goto|goto
name|leave_pager
goto|;
block|}
break|break;
case|case
literal|'\177'
case|:
case|case
literal|'\0'
case|:
comment|/* treat del,break as 'n' */
operator|*
name|buf
operator|=
literal|'n'
expr_stmt|;
comment|/* FALL THROUGH */
case|case
literal|'k'
case|:
case|case
literal|'K'
case|:
case|case
literal|'T'
case|:
case|case
literal|'J'
case|:
case|case
literal|'n'
case|:
case|case
literal|'N'
case|:
case|case
name|Ctl
argument_list|(
literal|'n'
argument_list|)
case|:
case|case
literal|'s'
case|:
case|case
literal|'S'
case|:
case|case
literal|'e'
case|:
case|case
literal|'u'
case|:
case|case
literal|'w'
case|:
case|case
literal|'W'
case|:
case|case
literal|'|'
case|:
name|mark_as_read
argument_list|()
expr_stmt|;
comment|/* mark article as read */
comment|/* FALL THROUGH */
case|case
literal|'U'
case|:
case|case
literal|','
case|:
case|case
literal|'<'
case|:
case|case
literal|'>'
case|:
case|case
literal|'['
case|:
case|case
literal|']'
case|:
case|case
literal|'{'
case|:
case|case
literal|'}'
case|:
case|case
literal|'('
case|:
case|case
literal|')'
case|:
case|case
literal|'+'
case|:
case|case
literal|':'
case|:
case|case
literal|'#'
case|:
case|case
literal|'$'
case|:
case|case
literal|'&'
case|:
case|case
literal|'-'
case|:
case|case
literal|'.'
case|:
case|case
literal|'/'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
case|case
literal|'='
case|:
case|case
literal|'?'
case|:
case|case
literal|'c'
case|:
case|case
literal|'C'
case|:
ifdef|#
directive|ifdef
name|DEBUG
case|case
literal|'D'
case|:
endif|#
directive|endif
case|case
literal|'E'
case|:
case|case
literal|'f'
case|:
case|case
literal|'F'
case|:
case|case
name|Ctl
argument_list|(
literal|'f'
argument_list|)
case|:
case|case
literal|'j'
case|:
case|case
name|Ctl
argument_list|(
literal|'k'
argument_list|)
case|:
case|case
literal|'m'
case|:
case|case
literal|'M'
case|:
case|case
literal|'p'
case|:
case|case
literal|'P'
case|:
case|case
name|Ctl
argument_list|(
literal|'p'
argument_list|)
case|:
case|case
literal|'Q'
case|:
case|case
literal|'r'
case|:
case|case
literal|'R'
case|:
case|case
name|Ctl
argument_list|(
literal|'r'
argument_list|)
case|:
case|case
literal|'v'
case|:
case|case
literal|'Y'
case|:
ifndef|#
directive|ifndef
name|ROTATION
case|case
literal|'x'
case|:
case|case
literal|'X'
case|:
endif|#
directive|endif
case|case
name|Ctl
argument_list|(
literal|'x'
argument_list|)
case|:
case|case
literal|'z'
case|:
case|case
literal|'Z'
case|:
case|case
literal|'^'
case|:
name|leave_pager
label|:
ifdef|#
directive|ifdef
name|ROTATION
name|rotate
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
name|reread
operator|=
name|FALSE
expr_stmt|;
name|do_hiding
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|index
argument_list|(
literal|"nNpP\016\020"
argument_list|,
operator|*
name|buf
argument_list|)
operator|==
name|Nullch
operator|&&
name|index
argument_list|(
literal|"wWsSe:!&|/?123456789."
argument_list|,
operator|*
name|buf
argument_list|)
operator|!=
name|Nullch
condition|)
block|{
name|setdfltcmd
argument_list|()
expr_stmt|;
name|standout
argument_list|()
expr_stmt|;
comment|/* enter standout mode */
name|printf
argument_list|(
name|prompt
argument_list|,
name|mailcall
argument_list|,
name|dfltcmd
argument_list|)
expr_stmt|;
comment|/* print prompt, whatever it is */
name|un_standout
argument_list|()
expr_stmt|;
comment|/* leave standout mode */
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
return|return
name|PS_RAISE
return|;
comment|/* and pretend we were at end */
ifdef|#
directive|ifdef
name|ROTATION
case|case
literal|'x'
case|:
name|rotate
operator|=
name|TRUE
expr_stmt|;
comment|/* FALL THROUGH */
endif|#
directive|endif
case|case
literal|'y'
case|:
case|case
name|Ctl
argument_list|(
literal|'v'
argument_list|)
case|:
comment|/* Leaving it undocumented in case */
comment|/* I want to steal the key--LAW */
case|case
literal|' '
case|:
comment|/* continue current article */
if|if
condition|(
name|erase_screen
condition|)
block|{
comment|/* -e? */
ifndef|#
directive|ifndef
name|CLEAREOL
name|clear
argument_list|()
expr_stmt|;
comment|/* clear screen */
else|#
directive|else
if|if
condition|(
name|can_home_clear
condition|)
comment|/* if we can home do it */
name|home_cursor
argument_list|()
expr_stmt|;
else|else
name|clear
argument_list|()
expr_stmt|;
comment|/* else clear screen */
endif|#
directive|endif
comment|/* CLEAREOL */
name|carriage_return
argument_list|()
expr_stmt|;
comment|/* Resets kernel's tab column counter to 0 */
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|blinebeg
operator|!=
literal|'\f'
ifdef|#
directive|ifdef
name|CUSTOMLINES
operator|&&
operator|(
operator|!
name|pagestop
operator|||
name|blinebeg
operator|!=
name|art_buf
operator|||
operator|!
name|execute
argument_list|(
operator|&
name|page_compex
argument_list|,
name|blinebeg
argument_list|)
operator|)
endif|#
directive|endif
condition|)
block|{
name|restart
operator|=
name|blinebeg
expr_stmt|;
name|artline
operator|--
expr_stmt|;
comment|/* restart this line */
name|artpos
operator|=
name|alinebeg
expr_stmt|;
if|if
condition|(
name|marking
condition|)
comment|/* and mark repeated line */
name|highlight
operator|=
name|artline
expr_stmt|;
block|}
name|topline
operator|=
name|artline
expr_stmt|;
comment|/* and remember top line of screen */
comment|/*  (line # within article file) */
block|}
elseif|else
if|if
condition|(
name|marking
operator|&&
operator|*
name|blinebeg
operator|!=
literal|'\f'
ifdef|#
directive|ifdef
name|CUSTOMLINES
operator|&&
operator|(
operator|!
name|pagestop
operator|||
name|blinebeg
operator|!=
name|art_buf
operator|||
operator|!
name|execute
argument_list|(
operator|&
name|page_compex
argument_list|,
name|blinebeg
argument_list|)
operator|)
endif|#
directive|endif
condition|)
block|{
comment|/* are we marking repeats? */
name|up_line
argument_list|()
expr_stmt|;
comment|/* go up one line */
name|highlight
operator|=
operator|--
name|artline
expr_stmt|;
comment|/* and get ready to highlight */
name|restart
operator|=
name|blinebeg
expr_stmt|;
comment|/*   the old line */
name|artpos
operator|=
name|alinebeg
expr_stmt|;
block|}
return|return
name|PS_NORM
return|;
case|case
literal|'q'
case|:
comment|/* quit this article? */
name|do_hiding
operator|=
name|TRUE
expr_stmt|;
return|return
name|PS_TOEND
return|;
default|default:
name|fputs
argument_list|(
argument|hforhelp
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
name|settle_down
argument_list|()
expr_stmt|;
return|return
name|PS_ASK
return|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INNERSEARCH
end_ifdef

begin_function
name|bool
name|innermore
parameter_list|()
block|{
if|if
condition|(
name|artpos
operator|<
name|innersearch
condition|)
block|{
comment|/* not even on page yet? */
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|DEB_INNERSRCH
condition|)
name|printf
argument_list|(
literal|"Not on page %ld< %ld\n"
argument_list|,
argument|(long)artpos
argument_list|,
argument|(long)innersearch
argument_list|)
name|FLUSH
expr_stmt|;
endif|#
directive|endif
return|return
name|TRUE
return|;
block|}
if|if
condition|(
name|artpos
operator|==
name|innersearch
condition|)
block|{
comment|/* just got onto page? */
name|isrchline
operator|=
name|artline
expr_stmt|;
comment|/* remember first line after */
name|highlight
operator|=
name|artline
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|DEB_INNERSRCH
condition|)
name|printf
argument_list|(
literal|"There it is %ld = %ld, %d @ %d\n"
argument_list|,
argument|(long)artpos
argument_list|,
argument|(long)innersearch
argument_list|,
argument|hide_everything
argument_list|,
argument|highlight
argument_list|)
name|FLUSH
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|hide_everything
condition|)
block|{
comment|/* forced refresh? */
name|topline
operator|=
name|highlight
operator|-
name|gline
expr_stmt|;
if|if
condition|(
name|topline
operator|<
operator|-
literal|1
condition|)
name|topline
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|FALSE
return|;
comment|/* let refresh do it all */
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|DEB_INNERSRCH
condition|)
name|printf
argument_list|(
literal|"Not far enough? %d<? %d + %d\n"
argument_list|,
argument|artline
argument_list|,
argument|isrchline
argument_list|,
argument|gline
argument_list|)
name|FLUSH
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|artline
operator|<
name|isrchline
operator|+
name|gline
condition|)
block|{
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|METAMAIL
end_ifdef

begin_function
name|int
name|nontext
parameter_list|(
name|content_type
parameter_list|)
name|char
modifier|*
name|content_type
decl_stmt|;
block|{
name|char
modifier|*
name|t
decl_stmt|;
if|if
condition|(
name|content_type
index|[
literal|0
index|]
operator|==
literal|'\n'
condition|)
return|return
literal|0
return|;
while|while
condition|(
name|content_type
operator|&&
name|isspace
argument_list|(
operator|*
name|content_type
argument_list|)
condition|)
name|content_type
operator|++
expr_stmt|;
name|t
operator|=
name|index
argument_list|(
name|content_type
argument_list|,
literal|';'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|t
condition|)
name|t
operator|=
name|index
argument_list|(
name|content_type
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
condition|)
operator|*
name|t
operator|--
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
name|t
operator|&&
operator|*
name|t
operator|&&
name|t
operator|>
name|content_type
operator|&&
name|isspace
argument_list|(
operator|*
name|t
argument_list|)
condition|)
operator|*
name|t
operator|--
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|notplain
argument_list|(
name|content_type
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|notplain
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|char
modifier|*
name|t
decl_stmt|;
if|if
condition|(
operator|!
name|s
condition|)
return|return
literal|1
return|;
while|while
condition|(
operator|*
name|s
operator|&&
name|isspace
argument_list|(
operator|*
name|s
argument_list|)
condition|)
name|s
operator|++
expr_stmt|;
for|for
control|(
name|t
operator|=
name|s
init|;
operator|*
name|t
condition|;
operator|++
name|t
control|)
block|{
if|if
condition|(
name|isupper
argument_list|(
operator|*
name|t
argument_list|)
condition|)
operator|*
name|t
operator|=
name|tolower
argument_list|(
operator|*
name|t
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|t
operator|>
name|s
operator|&&
name|isspace
argument_list|(
operator|*
operator|--
name|t
argument_list|)
condition|)
empty_stmt|;
if|if
condition|(
operator|(
operator|(
name|t
operator|-
name|s
operator|)
operator|==
literal|3
operator|)
operator|&&
operator|!
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"text"
argument_list|,
literal|4
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"text/plain"
argument_list|,
literal|10
argument_list|)
condition|)
return|return
literal|1
return|;
name|t
operator|=
name|index
argument_list|(
name|s
argument_list|,
literal|';'
argument_list|)
expr_stmt|;
while|while
condition|(
name|t
condition|)
block|{
name|t
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|t
operator|&&
name|isspace
argument_list|(
operator|*
name|t
argument_list|)
condition|)
name|t
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t
argument_list|,
literal|"charset"
argument_list|,
literal|7
argument_list|)
condition|)
block|{
name|s
operator|=
name|index
argument_list|(
name|t
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
name|s
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|s
operator|&&
name|isspace
argument_list|(
operator|*
name|s
argument_list|)
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"us-ascii"
argument_list|,
literal|8
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|t
operator|=
name|index
argument_list|(
name|t
argument_list|,
literal|';'
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
comment|/* no charset, was text/plain */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Id: rt-page.c,v 3.0 1992/12/14 00:14:12 davison Trn $ */
end_comment

begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"cache.h"
end_include

begin_include
include|#
directive|include
file|"term.h"
end_include

begin_include
include|#
directive|include
file|"ngdata.h"
end_include

begin_include
include|#
directive|include
file|"trn.h"
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"rthread.h"
end_include

begin_include
include|#
directive|include
file|"rt-select.h"
end_include

begin_include
include|#
directive|include
file|"rt-util.h"
end_include

begin_include
include|#
directive|include
file|"INTERN.h"
end_include

begin_include
include|#
directive|include
file|"rt-page.h"
end_include

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|display_mode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|sel_disp_char
index|[]
decl_stmt|;
end_decl_stmt

begin_function
name|bool
name|set_sel_mode
parameter_list|(
name|ch
parameter_list|)
name|char_int
name|ch
decl_stmt|;
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'a'
case|:
name|set_selector
argument_list|(
name|SM_ARTICLE
argument_list|,
name|sel_artsort
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|set_selector
argument_list|(
name|SM_SUBJECT
argument_list|,
name|sel_threadsort
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
if|if
condition|(
name|in_ng
operator|&&
operator|!
name|ThreadedGroup
condition|)
block|{
name|bool
name|always_save
init|=
name|thread_always
decl_stmt|;
name|ThreadedGroup
operator|=
name|TRUE
expr_stmt|;
name|thread_always
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|sel_rereading
condition|)
name|firstart
operator|=
name|absfirst
expr_stmt|;
name|printf
argument_list|(
literal|"\nThreading the group. "
argument_list|)
operator|,
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|thread_open
argument_list|()
expr_stmt|;
name|thread_always
operator|=
name|always_save
expr_stmt|;
if|if
condition|(
name|last_cached
operator|<
name|lastart
condition|)
name|ThreadedGroup
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/* FALL THROUGH */
case|case
literal|'T'
case|:
name|set_selector
argument_list|(
name|SM_THREAD
argument_list|,
name|sel_threadsort
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|bool
name|set_sel_sort
parameter_list|(
name|ch
parameter_list|)
name|char_int
name|ch
decl_stmt|;
block|{
if|if
condition|(
name|isupper
argument_list|(
name|ch
argument_list|)
condition|)
block|{
name|sel_direction
operator|=
operator|-
literal|1
expr_stmt|;
name|ch
operator|=
name|tolower
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
else|else
name|sel_direction
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'d'
case|:
name|sel_sort
operator|=
name|SS_DATE
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|sel_sort
operator|=
name|SS_SUBJECT
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|sel_sort
operator|=
name|SS_AUTHOR
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|sel_sort
operator|=
name|SS_COUNT
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|sel_sort
operator|=
name|SS_GROUPS
expr_stmt|;
break|break;
default|default:
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
name|set_selector
argument_list|(
name|sel_mode
argument_list|,
name|sel_sort
argument_list|)
expr_stmt|;
else|else
name|set_selector
argument_list|(
name|sel_threadmode
argument_list|,
name|sel_sort
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|void
name|set_selector
parameter_list|(
name|smode
parameter_list|,
name|ssort
parameter_list|)
name|int
name|smode
decl_stmt|;
name|int
name|ssort
decl_stmt|;
block|{
name|sel_mode
operator|=
name|smode
expr_stmt|;
name|sel_sort
operator|=
name|ssort
expr_stmt|;
if|if
condition|(
operator|!
name|ThreadedGroup
operator|&&
name|sel_mode
operator|==
name|SM_THREAD
condition|)
name|sel_mode
operator|=
name|SM_SUBJECT
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
if|if
condition|(
name|sel_sort
operator|==
name|SS_COUNT
condition|)
name|sel_sort
operator|=
name|SS_DATE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel_sort
operator|==
name|SS_AUTHOR
operator|||
name|sel_sort
operator|==
name|SS_GROUPS
condition|)
name|sel_sort
operator|=
name|SS_DATE
expr_stmt|;
switch|switch
condition|(
name|sel_mode
condition|)
block|{
case|case
name|SM_THREAD
case|:
name|sel_mode_string
operator|=
literal|"threads"
expr_stmt|;
name|sel_threadmode
operator|=
name|smode
expr_stmt|;
name|sel_threadsort
operator|=
name|ssort
expr_stmt|;
break|break;
case|case
name|SM_SUBJECT
case|:
name|sel_mode_string
operator|=
literal|"subjects"
expr_stmt|;
name|sel_threadmode
operator|=
name|smode
expr_stmt|;
name|sel_threadsort
operator|=
name|ssort
expr_stmt|;
break|break;
case|case
name|SM_ARTICLE
case|:
name|sel_mode_string
operator|=
literal|"articles"
expr_stmt|;
name|sel_artsort
operator|=
name|ssort
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|sel_sort
condition|)
block|{
case|case
name|SS_DATE
case|:
name|sel_sort_string
operator|=
literal|"date"
expr_stmt|;
break|break;
case|case
name|SS_SUBJECT
case|:
name|sel_sort_string
operator|=
literal|"subject"
expr_stmt|;
break|break;
case|case
name|SS_AUTHOR
case|:
name|sel_sort_string
operator|=
literal|"author"
expr_stmt|;
break|break;
case|case
name|SS_COUNT
case|:
name|sel_sort_string
operator|=
literal|"count"
expr_stmt|;
break|break;
case|case
name|SS_GROUPS
case|:
name|sel_sort_string
operator|=
literal|"SubjDate"
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|init_pages
parameter_list|()
block|{
name|try_again
label|:
name|sel_prior_arts
operator|=
name|sel_total_arts
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
name|ARTICLE
modifier|*
name|ap
decl_stmt|,
modifier|*
modifier|*
name|app
decl_stmt|,
modifier|*
modifier|*
name|limit
decl_stmt|;
name|sort_articles
argument_list|()
expr_stmt|;
while|while
condition|(
name|sel_page_sp
operator|&&
name|sel_page_sp
operator|->
name|misc
operator|==
literal|0
condition|)
name|sel_page_sp
operator|=
name|sel_page_sp
operator|->
name|next
expr_stmt|;
comment|/* The artptr_list contains only unread or read articles, never both */
name|limit
operator|=
name|artptr_list
operator|+
name|article_count
expr_stmt|;
for|for
control|(
name|app
operator|=
name|artptr_list
init|;
name|app
operator|<
name|limit
condition|;
name|app
operator|++
control|)
block|{
name|ap
operator|=
operator|*
name|app
expr_stmt|;
if|if
condition|(
name|sel_rereading
operator|&&
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|sel_mask
operator|)
condition|)
name|ap
operator|->
name|flags
operator||=
name|AF_DEL
expr_stmt|;
if|if
condition|(
name|sel_page_app
operator|==
name|app
operator|||
operator|(
operator|!
name|sel_page_app
operator|&&
name|ap
operator|->
name|subj
operator|==
name|sel_page_sp
operator|)
condition|)
block|{
name|sel_page_app
operator|=
name|app
expr_stmt|;
name|sel_prior_arts
operator|=
name|sel_total_arts
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|sel_exclusive
operator|||
operator|(
name|ap
operator|->
name|flags
operator|&
name|sel_mask
operator|)
condition|)
block|{
name|sel_total_arts
operator|++
expr_stmt|;
name|ap
operator|->
name|flags
operator||=
name|AF_INCLUDED
expr_stmt|;
block|}
else|else
name|ap
operator|->
name|flags
operator|&=
operator|~
name|AF_INCLUDED
expr_stmt|;
block|}
if|if
condition|(
name|sel_exclusive
operator|&&
operator|!
name|sel_total_arts
condition|)
block|{
name|sel_exclusive
operator|=
name|FALSE
expr_stmt|;
goto|goto
name|try_again
goto|;
block|}
if|if
condition|(
operator|!
name|sel_page_app
condition|)
operator|(
name|void
operator|)
name|first_page
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|SUBJECT
modifier|*
name|sp
decl_stmt|,
modifier|*
name|group_sp
decl_stmt|;
name|int
name|group_arts
decl_stmt|;
name|sort_subjects
argument_list|()
expr_stmt|;
for|for
control|(
name|sp
operator|=
name|first_subject
init|;
name|sp
condition|;
name|sp
operator|=
name|sp
operator|->
name|next
control|)
block|{
if|if
condition|(
name|sel_rereading
operator|&&
operator|!
operator|(
name|sp
operator|->
name|flags
operator|&
name|sel_mask
operator|)
condition|)
name|sp
operator|->
name|flags
operator||=
name|SF_DEL
expr_stmt|;
name|group_sp
operator|=
name|sp
expr_stmt|;
name|group_arts
operator|=
name|sp
operator|->
name|misc
expr_stmt|;
if|if
condition|(
operator|!
name|sel_exclusive
operator|||
operator|(
name|sp
operator|->
name|flags
operator|&
name|sel_mask
operator|)
condition|)
name|sp
operator|->
name|flags
operator||=
name|SF_INCLUDED
expr_stmt|;
else|else
name|sp
operator|->
name|flags
operator|&=
operator|~
name|SF_INCLUDED
expr_stmt|;
if|if
condition|(
name|sel_page_sp
operator|==
name|group_sp
condition|)
name|sel_prior_arts
operator|=
name|sel_total_arts
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_THREAD
condition|)
block|{
while|while
condition|(
name|sp
operator|->
name|next
operator|&&
name|sp
operator|->
name|next
operator|->
name|thread
operator|==
name|sp
operator|->
name|thread
condition|)
block|{
name|sp
operator|=
name|sp
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|sel_page_sp
condition|)
block|{
name|sel_prior_arts
operator|=
name|sel_total_arts
expr_stmt|;
name|sel_page_sp
operator|=
name|group_sp
expr_stmt|;
block|}
name|sp
operator|->
name|flags
operator|&=
operator|~
name|SF_INCLUDED
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|flags
operator|&
name|sel_mask
condition|)
name|group_sp
operator|->
name|flags
operator||=
name|SF_INCLUDED
expr_stmt|;
elseif|else
if|if
condition|(
name|sel_rereading
condition|)
name|sp
operator|->
name|flags
operator||=
name|SF_DEL
expr_stmt|;
name|group_arts
operator|+=
name|sp
operator|->
name|misc
expr_stmt|;
block|}
block|}
if|if
condition|(
name|group_sp
operator|->
name|flags
operator|&
name|SF_INCLUDED
condition|)
name|sel_total_arts
operator|+=
name|group_arts
expr_stmt|;
block|}
if|if
condition|(
name|sel_exclusive
operator|&&
operator|!
name|sel_total_arts
condition|)
block|{
name|sel_exclusive
operator|=
name|FALSE
expr_stmt|;
goto|goto
name|try_again
goto|;
block|}
if|if
condition|(
operator|!
name|sel_page_sp
condition|)
operator|(
name|void
operator|)
name|first_page
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|bool
name|first_page
parameter_list|()
block|{
name|sel_prior_arts
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
name|ARTICLE
modifier|*
modifier|*
name|app
decl_stmt|,
modifier|*
modifier|*
name|limit
decl_stmt|;
name|limit
operator|=
name|artptr_list
operator|+
name|article_count
expr_stmt|;
for|for
control|(
name|app
operator|=
name|artptr_list
init|;
name|app
operator|<
name|limit
condition|;
name|app
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|*
name|app
operator|)
operator|->
name|flags
operator|&
name|AF_INCLUDED
condition|)
block|{
if|if
condition|(
name|sel_page_app
operator|!=
name|app
condition|)
block|{
name|sel_page_app
operator|=
name|app
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
block|}
block|}
block|}
else|else
block|{
name|SUBJECT
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|first_subject
init|;
name|sp
condition|;
name|sp
operator|=
name|sp
operator|->
name|next
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|flags
operator|&
name|SF_INCLUDED
condition|)
block|{
if|if
condition|(
name|sel_page_sp
operator|!=
name|sp
condition|)
block|{
name|sel_page_sp
operator|=
name|sp
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
block|}
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|bool
name|last_page
parameter_list|()
block|{
name|sel_prior_arts
operator|=
name|sel_total_arts
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
name|ARTICLE
modifier|*
modifier|*
name|app
init|=
name|sel_page_app
decl_stmt|;
name|sel_page_app
operator|=
name|artptr_list
operator|+
name|article_count
expr_stmt|;
if|if
condition|(
operator|!
name|prev_page
argument_list|()
condition|)
name|sel_page_app
operator|=
name|app
expr_stmt|;
elseif|else
if|if
condition|(
name|app
operator|!=
name|sel_page_app
condition|)
return|return
name|TRUE
return|;
block|}
else|else
block|{
name|SUBJECT
modifier|*
name|sp
init|=
name|sel_page_sp
decl_stmt|;
name|sel_page_sp
operator|=
name|Nullsubj
expr_stmt|;
if|if
condition|(
operator|!
name|prev_page
argument_list|()
condition|)
name|sel_page_sp
operator|=
name|sp
expr_stmt|;
elseif|else
if|if
condition|(
name|sp
operator|!=
name|sel_page_sp
condition|)
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|bool
name|next_page
parameter_list|()
block|{
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
if|if
condition|(
name|sel_next_app
operator|<
name|artptr_list
operator|+
name|article_count
condition|)
block|{
name|sel_page_app
operator|=
name|sel_next_app
expr_stmt|;
name|sel_prior_arts
operator|+=
name|sel_page_arts
expr_stmt|;
return|return
name|TRUE
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|sel_next_sp
condition|)
block|{
name|sel_page_sp
operator|=
name|sel_next_sp
expr_stmt|;
name|sel_prior_arts
operator|+=
name|sel_page_arts
expr_stmt|;
return|return
name|TRUE
return|;
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|bool
name|prev_page
parameter_list|()
block|{
name|int
name|item_cnt
init|=
literal|0
decl_stmt|;
comment|/* Scan the items in reverse to go back a page */
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
name|ARTICLE
modifier|*
name|ap
decl_stmt|,
modifier|*
modifier|*
name|app
decl_stmt|,
modifier|*
modifier|*
name|page_app
init|=
name|sel_page_app
decl_stmt|;
for|for
control|(
name|app
operator|=
name|sel_page_app
init|;
operator|--
name|app
operator|>=
name|artptr_list
condition|;
control|)
block|{
name|ap
operator|=
operator|*
name|app
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|flags
operator|&
name|AF_INCLUDED
condition|)
block|{
name|page_app
operator|=
name|app
expr_stmt|;
name|sel_prior_arts
operator|--
expr_stmt|;
if|if
condition|(
operator|++
name|item_cnt
operator|>=
name|sel_max_cnt
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|sel_page_app
operator|!=
name|page_app
condition|)
block|{
name|sel_page_app
operator|=
name|page_app
expr_stmt|;
return|return
name|TRUE
return|;
block|}
block|}
else|else
block|{
name|SUBJECT
modifier|*
name|sp
decl_stmt|,
modifier|*
name|page_sp
init|=
name|sel_page_sp
decl_stmt|;
name|int
name|line_cnt
decl_stmt|,
name|item_arts
decl_stmt|,
name|line
decl_stmt|;
name|line
operator|=
literal|2
expr_stmt|;
for|for
control|(
name|sp
operator|=
operator|(
operator|!
name|page_sp
condition|?
name|last_subject
else|:
name|page_sp
operator|->
name|prev
operator|)
init|;
name|sp
condition|;
name|sp
operator|=
name|sp
operator|->
name|prev
control|)
block|{
name|item_arts
operator|=
name|sp
operator|->
name|misc
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_THREAD
condition|)
block|{
while|while
condition|(
name|sp
operator|->
name|prev
operator|&&
name|sp
operator|->
name|prev
operator|->
name|thread
operator|==
name|sp
operator|->
name|thread
condition|)
block|{
name|sp
operator|=
name|sp
operator|->
name|prev
expr_stmt|;
name|item_arts
operator|+=
name|sp
operator|->
name|misc
expr_stmt|;
block|}
name|line_cnt
operator|=
name|count_thread_lines
argument_list|(
name|sp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|line_cnt
operator|=
name|count_subject_lines
argument_list|(
name|sp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sp
operator|->
name|flags
operator|&
name|SF_INCLUDED
operator|)
operator|||
operator|!
name|line_cnt
condition|)
continue|continue;
if|if
condition|(
name|line_cnt
operator|>
name|LINES
operator|-
literal|5
condition|)
name|line_cnt
operator|=
name|LINES
operator|-
literal|5
expr_stmt|;
name|line
operator|+=
name|line_cnt
expr_stmt|;
if|if
condition|(
name|line
operator|>
name|LINES
operator|-
literal|3
condition|)
block|{
name|sp
operator|=
name|page_sp
expr_stmt|;
break|break;
block|}
name|sel_prior_arts
operator|-=
name|item_arts
expr_stmt|;
name|page_sp
operator|=
name|sp
expr_stmt|;
if|if
condition|(
operator|++
name|item_cnt
operator|>=
name|sel_max_cnt
condition|)
break|break;
block|}
if|if
condition|(
name|sel_page_sp
operator|!=
name|page_sp
condition|)
block|{
name|sel_page_sp
operator|=
operator|(
name|page_sp
condition|?
name|page_sp
else|:
name|first_subject
operator|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|void
name|display_page
parameter_list|()
block|{
name|int
name|sel
decl_stmt|;
name|sel_chars
operator|=
name|getval
argument_list|(
literal|"SELECTCHARS"
argument_list|,
name|SELECTCHARS
argument_list|)
expr_stmt|;
name|sel_max_cnt
operator|=
name|strlen
argument_list|(
name|sel_chars
argument_list|)
expr_stmt|;
if|if
condition|(
name|sel_max_cnt
operator|>
name|MAX_SEL
condition|)
name|sel_max_cnt
operator|=
name|MAX_SEL
expr_stmt|;
if|if
condition|(
name|sel_max_cnt
operator|>
name|LINES
operator|-
literal|5
condition|)
name|sel_max_cnt
operator|=
name|LINES
operator|-
literal|5
expr_stmt|;
ifndef|#
directive|ifndef
name|CLEAREOL
name|clear
argument_list|()
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|can_home_clear
condition|)
block|{
name|home_cursor
argument_list|()
expr_stmt|;
name|maybe_eol
argument_list|()
expr_stmt|;
block|}
else|else
name|clear
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|carriage_return
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|NOFIREWORKS
name|no_sofire
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|standout
argument_list|()
expr_stmt|;
name|fputs
argument_list|(
name|ngname
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|un_standout
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"          %ld %sarticle%s"
argument_list|,
operator|(
name|long
operator|)
name|sel_total_arts
argument_list|,
name|sel_rereading
condition|?
literal|"read "
else|:
name|nullstr
argument_list|,
name|article_count
operator|==
literal|1
condition|?
name|nullstr
else|:
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sel_exclusive
condition|)
name|printf
argument_list|(
literal|" out of %ld"
argument_list|,
operator|(
name|long
operator|)
name|article_count
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|moderated
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CLEAREOL
name|maybe_eol
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|putchar
argument_list|(
literal|'\n'
argument_list|)
name|FLUSH
expr_stmt|;
name|try_again
label|:
name|sel_line
operator|=
literal|2
expr_stmt|;
name|sel_page_arts
operator|=
literal|0
expr_stmt|;
name|sel_item_cnt
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|sel_total_arts
condition|)
empty_stmt|;
elseif|else
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
name|ARTICLE
modifier|*
name|ap
decl_stmt|,
modifier|*
modifier|*
name|app
decl_stmt|,
modifier|*
modifier|*
name|limit
decl_stmt|;
name|limit
operator|=
name|artptr_list
operator|+
name|article_count
expr_stmt|;
name|app
operator|=
name|sel_page_app
expr_stmt|;
do|do
block|{
name|ap
operator|=
operator|*
name|app
expr_stmt|;
if|if
condition|(
name|ap
operator|==
name|sel_last_ap
condition|)
name|sel_item_index
operator|=
name|sel_item_cnt
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_INCLUDED
operator|)
condition|)
continue|continue;
name|sel
operator|=
operator|!
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|sel_mask
operator|)
operator|+
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_DEL
operator|)
expr_stmt|;
name|sel_items
index|[
name|sel_item_cnt
index|]
operator|.
name|ptr
operator|=
operator|(
name|void
operator|*
operator|)
name|ap
expr_stmt|;
name|sel_items
index|[
name|sel_item_cnt
index|]
operator|.
name|line
operator|=
name|sel_line
expr_stmt|;
name|sel_items
index|[
name|sel_item_cnt
index|]
operator|.
name|sel
operator|=
name|sel
expr_stmt|;
name|sel_page_arts
operator|++
expr_stmt|;
comment|/* Output the article, with optional author */
name|display_article
argument_list|(
name|ap
argument_list|,
name|sel_chars
index|[
name|sel_item_cnt
index|]
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|sel_item_cnt
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|app
operator|<
name|limit
operator|&&
name|sel_item_cnt
operator|<
name|sel_max_cnt
condition|)
do|;
if|if
condition|(
operator|!
name|sel_page_arts
condition|)
block|{
if|if
condition|(
name|last_page
argument_list|()
condition|)
goto|goto
name|try_again
goto|;
block|}
name|sel_next_app
operator|=
name|app
expr_stmt|;
block|}
else|else
block|{
name|SUBJECT
modifier|*
name|sp
decl_stmt|;
name|int
name|line_cnt
decl_stmt|;
name|bool
name|etc
decl_stmt|;
name|char
name|ch
decl_stmt|;
name|sp
operator|=
name|sel_page_sp
expr_stmt|;
do|do
block|{
if|if
condition|(
name|sp
operator|==
name|sel_last_sp
condition|)
name|sel_item_index
operator|=
name|sel_item_cnt
expr_stmt|;
name|etc
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|flags
operator|&
name|SF_INCLUDED
condition|)
block|{
comment|/* Compute how many lines we need to display this group */
if|if
condition|(
name|sel_mode
operator|==
name|SM_THREAD
condition|)
name|line_cnt
operator|=
name|count_thread_lines
argument_list|(
name|sp
argument_list|,
operator|&
name|sel
argument_list|)
expr_stmt|;
else|else
name|line_cnt
operator|=
name|count_subject_lines
argument_list|(
name|sp
argument_list|,
operator|&
name|sel
argument_list|)
expr_stmt|;
if|if
condition|(
name|line_cnt
condition|)
block|{
comment|/* If this item is too long to fit on the screen all by 		    ** itself, trim it to fit and set the "etc" flag. 		    */
if|if
condition|(
name|line_cnt
operator|>
name|LINES
operator|-
literal|5
condition|)
block|{
name|line_cnt
operator|=
name|LINES
operator|-
literal|5
expr_stmt|;
name|etc
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* If it doesn't fit, save it for the next page */
if|if
condition|(
name|sel_line
operator|+
name|line_cnt
operator|>
name|LINES
operator|-
literal|3
condition|)
break|break;
name|sel_items
index|[
name|sel_item_cnt
index|]
operator|.
name|ptr
operator|=
operator|(
name|void
operator|*
operator|)
name|sp
expr_stmt|;
name|sel_items
index|[
name|sel_item_cnt
index|]
operator|.
name|line
operator|=
name|sel_line
expr_stmt|;
name|sel_items
index|[
name|sel_item_cnt
index|]
operator|.
name|sel
operator|=
name|sel
expr_stmt|;
name|sel_page_arts
operator|+=
name|sp
operator|->
name|misc
expr_stmt|;
name|ch
operator|=
name|sel_chars
index|[
name|sel_item_cnt
index|]
expr_stmt|;
name|sel
operator|=
name|sel_items
index|[
name|sel_item_cnt
index|]
operator|.
name|sel
expr_stmt|;
name|sel_item_cnt
operator|++
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|misc
condition|)
block|{
name|display_subject
argument_list|(
name|sp
argument_list|,
name|ch
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|ch
operator|=
literal|' '
expr_stmt|;
block|}
block|}
block|}
else|else
name|line_cnt
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_THREAD
condition|)
block|{
while|while
condition|(
name|sp
operator|->
name|next
operator|&&
name|sp
operator|->
name|next
operator|->
name|thread
operator|==
name|sp
operator|->
name|thread
condition|)
block|{
name|sp
operator|=
name|sp
operator|->
name|next
expr_stmt|;
if|if
condition|(
operator|!
name|line_cnt
operator|||
operator|!
name|sp
operator|->
name|misc
condition|)
continue|continue;
if|if
condition|(
name|sel_line
operator|<
name|LINES
operator|-
literal|3
condition|)
name|display_subject
argument_list|(
name|sp
argument_list|,
name|ch
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|ch
operator|=
literal|' '
expr_stmt|;
name|sel_page_arts
operator|+=
name|sp
operator|->
name|misc
expr_stmt|;
block|}
block|}
if|if
condition|(
name|etc
condition|)
name|fputs
argument_list|(
literal|"      ...etc."
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|sp
operator|=
name|sp
operator|->
name|next
operator|)
operator|!=
name|Nullsubj
operator|&&
operator|!
name|etc
operator|&&
name|sel_item_cnt
operator|<
name|sel_max_cnt
condition|)
do|;
if|if
condition|(
operator|!
name|sel_page_arts
condition|)
block|{
if|if
condition|(
name|last_page
argument_list|()
condition|)
goto|goto
name|try_again
goto|;
block|}
name|sel_next_sp
operator|=
name|sp
expr_stmt|;
block|}
name|sel_last_line
operator|=
name|sel_line
operator|+
literal|1
expr_stmt|;
name|sel_last_ap
operator|=
name|Nullart
expr_stmt|;
name|sel_last_sp
operator|=
name|Nullsubj
expr_stmt|;
name|sel_at_end
operator|=
operator|(
name|sel_prior_arts
operator|+
name|sel_page_arts
operator|==
name|sel_total_arts
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CLEAREOL
name|maybe_eol
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|putchar
argument_list|(
literal|'\n'
argument_list|)
name|FLUSH
expr_stmt|;
block|}
end_function

begin_function
name|void
name|update_page
parameter_list|()
block|{
name|int
name|sel
decl_stmt|;
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|sel_item_cnt
condition|;
name|j
operator|++
control|)
block|{
name|sel
operator|=
name|sel_items
index|[
name|j
index|]
operator|.
name|sel
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
name|ARTICLE
modifier|*
name|ap
init|=
operator|(
name|ARTICLE
operator|*
operator|)
name|sel_items
index|[
name|j
index|]
operator|.
name|ptr
decl_stmt|;
if|if
condition|(
name|sel
operator|==
operator|!
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|sel_mask
operator|)
operator|+
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_DEL
operator|)
condition|)
continue|continue;
block|}
else|else
block|{
name|SUBJECT
modifier|*
name|sp
init|=
operator|(
name|SUBJECT
operator|*
operator|)
name|sel_items
index|[
name|j
index|]
operator|.
name|ptr
decl_stmt|;
name|int
name|real_sel
decl_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_THREAD
condition|)
operator|(
name|void
operator|)
name|count_thread_lines
argument_list|(
name|sp
argument_list|,
operator|&
name|real_sel
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|count_subject_lines
argument_list|(
name|sp
argument_list|,
operator|&
name|real_sel
argument_list|)
expr_stmt|;
if|if
condition|(
name|sel
operator|==
name|real_sel
condition|)
continue|continue;
block|}
name|goto_line
argument_list|(
name|sel_line
argument_list|,
name|sel_items
index|[
name|j
index|]
operator|.
name|line
argument_list|)
expr_stmt|;
name|sel_line
operator|=
name|sel_items
index|[
name|j
index|]
operator|.
name|line
expr_stmt|;
name|sel_item_index
operator|=
name|j
expr_stmt|;
name|output_sel
argument_list|(
operator|!
name|sel
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|++
name|sel_item_index
operator|==
name|sel_item_cnt
condition|)
name|sel_item_index
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|output_sel
parameter_list|(
name|sel
parameter_list|)
name|int
name|sel
decl_stmt|;
block|{
name|putchar
argument_list|(
name|sel_chars
index|[
name|sel_item_index
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
name|sel_disp_char
index|[
name|sel
index|]
argument_list|)
expr_stmt|;
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|sel
operator|=
name|sel
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Counts the number of lines needed to output a subject, including ** optional authors. */
end_comment

begin_function
specifier|static
name|int
name|count_subject_lines
parameter_list|(
name|subj
parameter_list|,
name|selptr
parameter_list|)
name|SUBJECT
modifier|*
name|subj
decl_stmt|;
name|int
modifier|*
name|selptr
decl_stmt|;
block|{
specifier|register
name|ARTICLE
modifier|*
name|ap
decl_stmt|;
specifier|register
name|int
name|sel
decl_stmt|;
if|if
condition|(
name|subj
operator|->
name|flags
operator|&
name|SF_DEL
condition|)
name|sel
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|subj
operator|->
name|flags
operator|&
name|sel_mask
condition|)
block|{
name|sel
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|ap
operator|=
name|subj
operator|->
name|articles
init|;
name|ap
condition|;
name|ap
operator|=
name|ap
operator|->
name|subj_next
control|)
block|{
if|if
condition|(
operator|(
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_READ
operator|)
operator|^
name|sel_rereading
operator|)
operator|&&
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|sel_mask
operator|)
condition|)
block|{
name|sel
operator|=
literal|3
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
name|sel
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|selptr
condition|)
operator|*
name|selptr
operator|=
name|sel
expr_stmt|;
if|if
condition|(
operator|*
name|display_mode
operator|==
literal|'l'
condition|)
return|return
name|subj
operator|->
name|misc
return|;
if|if
condition|(
operator|*
name|display_mode
operator|==
literal|'m'
condition|)
return|return
operator|(
name|subj
operator|->
name|misc
operator|<=
literal|4
condition|?
name|subj
operator|->
name|misc
else|:
operator|(
name|subj
operator|->
name|misc
operator|-
literal|4
operator|)
operator|/
literal|3
operator|+
literal|4
operator|)
return|;
return|return
operator|(
name|subj
operator|->
name|misc
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Counts the number of lines needed to output a thread, including ** optional authors. */
end_comment

begin_function
specifier|static
name|int
name|count_thread_lines
parameter_list|(
name|subj
parameter_list|,
name|selptr
parameter_list|)
name|SUBJECT
modifier|*
name|subj
decl_stmt|;
name|int
modifier|*
name|selptr
decl_stmt|;
block|{
specifier|register
name|int
name|total
init|=
literal|0
decl_stmt|;
specifier|register
name|ARTICLE
modifier|*
name|thread
init|=
name|subj
operator|->
name|thread
decl_stmt|;
name|int
name|sel
init|=
operator|-
literal|1
decl_stmt|,
name|subj_sel
decl_stmt|;
do|do
block|{
if|if
condition|(
name|subj
operator|->
name|misc
condition|)
block|{
name|total
operator|+=
name|count_subject_lines
argument_list|(
name|subj
argument_list|,
operator|&
name|subj_sel
argument_list|)
expr_stmt|;
if|if
condition|(
name|sel
operator|<
literal|0
condition|)
name|sel
operator|=
name|subj_sel
expr_stmt|;
elseif|else
if|if
condition|(
name|sel
operator|!=
name|subj_sel
condition|)
name|sel
operator|=
literal|3
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|(
name|subj
operator|=
name|subj
operator|->
name|next
operator|)
operator|!=
name|Nullsubj
operator|&&
name|subj
operator|->
name|thread
operator|==
name|thread
condition|)
do|;
if|if
condition|(
name|selptr
condition|)
operator|*
name|selptr
operator|=
operator|(
name|sel
operator|<
literal|0
condition|?
literal|0
else|:
name|sel
operator|)
expr_stmt|;
return|return
name|total
return|;
block|}
end_function

begin_comment
comment|/* Display an article, perhaps with its author. */
end_comment

begin_function
specifier|static
name|void
name|display_article
parameter_list|(
name|ap
parameter_list|,
name|ch
parameter_list|,
name|sel
parameter_list|)
specifier|register
name|ARTICLE
modifier|*
name|ap
decl_stmt|;
name|char_int
name|ch
decl_stmt|;
name|int
name|sel
decl_stmt|;
block|{
name|int
name|subj_width
init|=
name|COLS
operator|-
literal|5
decl_stmt|;
name|int
name|from_width
init|=
name|COLS
operator|/
literal|5
decl_stmt|;
ifdef|#
directive|ifdef
name|CLEAREOL
name|maybe_eol
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|subj_width
operator|<
literal|32
condition|)
name|subj_width
operator|=
literal|32
expr_stmt|;
name|putchar
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
name|sel_disp_char
index|[
name|sel
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|display_mode
operator|==
literal|'s'
operator|||
name|from_width
operator|<
literal|8
condition|)
name|printf
argument_list|(
literal|"  %s\n"
argument_list|,
argument|compress_subj(ap->subj->articles,subj_width)
argument_list|)
name|FLUSH
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"%s  %s\n"
argument_list|,
argument|compress_from(ap, from_width)
argument_list|,
argument|compress_subj(ap, subj_width - from_width)
argument_list|)
name|FLUSH
expr_stmt|;
block|}
name|sel_line
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Display the given subject group, with optional authors. */
end_comment

begin_function
specifier|static
name|void
name|display_subject
parameter_list|(
name|subj
parameter_list|,
name|ch
parameter_list|,
name|sel
parameter_list|)
name|SUBJECT
modifier|*
name|subj
decl_stmt|;
name|char_int
name|ch
decl_stmt|;
name|int
name|sel
decl_stmt|;
block|{
specifier|register
name|ARTICLE
modifier|*
name|ap
decl_stmt|;
specifier|register
name|int
name|j
decl_stmt|,
name|i
decl_stmt|;
name|int
name|subj_width
init|=
name|COLS
operator|-
literal|8
decl_stmt|;
name|int
name|from_width
init|=
name|COLS
operator|/
literal|5
decl_stmt|;
ifdef|#
directive|ifdef
name|CLEAREOL
name|maybe_eol
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|subj_width
operator|<
literal|32
condition|)
name|subj_width
operator|=
literal|32
expr_stmt|;
name|j
operator|=
name|subj
operator|->
name|misc
expr_stmt|;
name|putchar
argument_list|(
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|!=
literal|' '
condition|)
name|putchar
argument_list|(
name|sel_disp_char
index|[
name|sel
index|]
argument_list|)
expr_stmt|;
else|else
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|display_mode
operator|==
literal|'s'
operator|||
name|from_width
operator|<
literal|8
condition|)
name|printf
argument_list|(
literal|"%3d  %s\n"
argument_list|,
argument|j
argument_list|,
argument|compress_subj(subj->articles,subj_width)
argument_list|)
name|FLUSH
expr_stmt|;
else|else
block|{
comment|/* Find the first unread article so we get the author right */
for|for
control|(
name|ap
operator|=
name|subj
operator|->
name|articles
init|;
name|ap
condition|;
name|ap
operator|=
name|ap
operator|->
name|subj_next
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_READ
operator|)
operator|^
name|sel_rereading
condition|)
break|break;
block|}
name|printf
argument_list|(
literal|"%s%3d  %s\n"
argument_list|,
argument|compress_from(ap, from_width)
argument_list|,
argument|j
argument_list|,
argument|compress_subj(ap, subj_width - from_width)
argument_list|)
name|FLUSH
expr_stmt|;
name|i
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|--
name|j
operator|&&
name|ap
condition|)
block|{
for|for
control|(
name|ap
operator|=
name|ap
operator|->
name|subj_next
init|;
name|ap
operator|&&
name|j
condition|;
name|ap
operator|=
name|ap
operator|->
name|subj_next
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_READ
operator|)
operator|^
name|sel_rereading
operator|)
condition|)
continue|continue;
name|j
operator|--
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
name|i
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|display_mode
operator|==
literal|'m'
condition|)
block|{
if|if
condition|(
operator|!
name|j
condition|)
block|{
if|if
condition|(
name|i
condition|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|i
operator|==
literal|3
operator|||
operator|!
name|i
condition|)
block|{
if|if
condition|(
name|i
condition|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|sel_line
operator|>=
name|LINES
operator|-
literal|3
condition|)
return|return;
ifdef|#
directive|ifdef
name|CLEAREOL
name|maybe_eol
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|i
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|i
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"  %s      "
argument_list|,
argument|compress_from(ap, from_width)
argument_list|)
name|FLUSH
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
operator|++
name|sel_line
operator|>=
name|LINES
operator|-
literal|3
condition|)
return|return;
ifdef|#
directive|ifdef
name|CLEAREOL
name|maybe_eol
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"  %s\n"
argument_list|,
argument|compress_from(ap, from_width)
argument_list|)
name|FLUSH
expr_stmt|;
block|}
block|}
block|}
name|sel_line
operator|++
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sysexits.h>
end_include

begin_comment
comment|/* string extraction/restoration routines */
end_comment

begin_comment
comment|/*   STR_FILE must be defined as a quoted string on the cc command line,   for example:    	-DSTR_FILE=\\\"/usr/local/lib/kermit5.sr\\\"    This is the file where the strings go, and where C-Kermit looks for them   at runtime. */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|STR_FILE
end_ifdef

begin_decl_stmt
name|char
modifier|*
name|StringFile
init|=
name|STR_FILE
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|char
modifier|*
name|StringFile
init|=
literal|"/usr/local/lib/kermit5.sr"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* STR_FILE */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|STR_CTIMED
end_ifdef

begin_decl_stmt
name|char
modifier|*
name|Ctimed
init|=
name|STR_CTIMED
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|char
modifier|*
name|Ctimed
init|=
literal|"/usr/lib/ctimed"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|strfile
init|=
operator|-
literal|1
decl_stmt|,
name|ourpid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BUFLEN
value|256
end_define

begin_macro
name|errprep
argument_list|(
argument|offset
argument_list|,
argument|buf
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|short
name|offset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|pid
init|=
name|getpid
argument_list|()
decl_stmt|;
if|if
condition|(
name|pid
operator|!=
name|ourpid
condition|)
block|{
name|ourpid
operator|=
name|pid
expr_stmt|;
if|if
condition|(
name|strfile
operator|>=
literal|0
condition|)
block|{
name|close
argument_list|(
name|strfile
argument_list|)
expr_stmt|;
name|strfile
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|strfile
operator|<
literal|0
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|getenv
argument_list|()
decl_stmt|;
if|if
condition|(
name|p
operator|=
name|getenv
argument_list|(
literal|"KSTR"
argument_list|)
condition|)
if|if
condition|(
name|strlen
argument_list|(
name|p
argument_list|)
condition|)
name|StringFile
operator|=
name|p
expr_stmt|;
name|strfile
operator|=
name|open
argument_list|(
name|StringFile
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|strfile
operator|<
literal|0
condition|)
block|{
name|oops
label|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot find %s\r\n"
argument_list|,
name|StringFile
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_OSFILE
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|lseek
argument_list|(
name|strfile
argument_list|,
operator|(
name|long
operator|)
name|offset
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
operator|||
name|read
argument_list|(
name|strfile
argument_list|,
name|buf
argument_list|,
name|BUFLEN
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|oops
goto|;
block|}
end_block

begin_comment
comment|/* extracted string front end for printf() */
end_comment

begin_comment
comment|/*VARARGS1*/
end_comment

begin_macro
name|strprerror
argument_list|(
argument|fmt
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|,
argument|d
argument_list|,
argument|e
argument_list|,
argument|f
argument_list|,
argument|g
argument_list|,
argument|h
argument_list|,
argument|i
argument_list|,
argument|j
argument_list|,
argument|k
argument_list|,
argument|l
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fmt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
name|BUFLEN
index|]
decl_stmt|;
name|errprep
argument_list|(
name|fmt
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|buf
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|,
name|f
argument_list|,
name|g
argument_list|,
name|h
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|k
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* extracted string front end for sprintf() */
end_comment

begin_comment
comment|/*VARARGS1*/
end_comment

begin_macro
name|strsrerror
argument_list|(
argument|fmt
argument_list|,
argument|obuf
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|,
argument|d
argument_list|,
argument|e
argument_list|,
argument|f
argument_list|,
argument|g
argument_list|,
argument|h
argument_list|,
argument|i
argument_list|,
argument|j
argument_list|,
argument|k
argument_list|,
argument|l
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fmt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|obuf
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
name|BUFLEN
index|]
decl_stmt|;
name|errprep
argument_list|(
name|fmt
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|obuf
argument_list|,
name|buf
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|,
name|f
argument_list|,
name|g
argument_list|,
name|h
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|k
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* extracted string front end for fprintf() */
end_comment

begin_comment
comment|/*VARARGS1*/
end_comment

begin_macro
name|strfrerror
argument_list|(
argument|fmt
argument_list|,
argument|fd
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|,
argument|d
argument_list|,
argument|e
argument_list|,
argument|f
argument_list|,
argument|g
argument_list|,
argument|h
argument_list|,
argument|i
argument_list|,
argument|j
argument_list|,
argument|k
argument_list|,
argument|l
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fmt
decl_stmt|,
name|fd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
name|BUFLEN
index|]
decl_stmt|;
name|errprep
argument_list|(
name|fmt
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|,
name|f
argument_list|,
name|g
argument_list|,
name|h
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|k
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* extracted string front end for perror() */
end_comment

begin_macro
name|strperror
argument_list|(
argument|fmt
argument_list|)
end_macro

begin_decl_stmt
name|int
name|fmt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
name|BUFLEN
index|]
decl_stmt|;
specifier|register
name|int
name|saverr
init|=
name|errno
decl_stmt|;
name|errprep
argument_list|(
name|fmt
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|saverr
expr_stmt|;
name|perror
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|perror
argument_list|(
argument|str
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"%s: errno %d\n"
argument_list|,
name|str
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
end_block

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_define
define|#
directive|define
name|SEND_FD
value|W[1]
end_define

begin_define
define|#
directive|define
name|RECV_FD
value|R[0]
end_define

begin_define
define|#
directive|define
name|CTIME
value|1
end_define

begin_define
define|#
directive|define
name|ASCTIME
value|2
end_define

begin_define
define|#
directive|define
name|TZSET
value|3
end_define

begin_define
define|#
directive|define
name|LOCALTIME
value|4
end_define

begin_define
define|#
directive|define
name|GMTIME
value|5
end_define

begin_define
define|#
directive|define
name|OFFTIME
value|6
end_define

begin_decl_stmt
specifier|static
name|int
name|R
index|[
literal|2
index|]
decl_stmt|,
name|W
index|[
literal|2
index|]
decl_stmt|,
name|inited
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|result
index|[
literal|26
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tm
name|tmtmp
decl_stmt|;
end_decl_stmt

begin_function
name|char
modifier|*
name|ctime
parameter_list|(
name|t
parameter_list|)
name|time_t
modifier|*
name|t
decl_stmt|;
block|{
name|u_char
name|fnc
init|=
name|CTIME
decl_stmt|;
name|sewer
argument_list|()
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
name|fnc
argument_list|,
sizeof|sizeof
name|fnc
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
name|t
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|getb
argument_list|(
name|RECV_FD
argument_list|,
name|result
argument_list|,
literal|26
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|asctime
parameter_list|(
name|tp
parameter_list|)
name|struct
name|tm
modifier|*
name|tp
decl_stmt|;
block|{
name|u_char
name|fnc
init|=
name|ASCTIME
decl_stmt|;
name|sewer
argument_list|()
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
operator|&
name|fnc
argument_list|,
sizeof|sizeof
name|fnc
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
name|tp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tp
argument_list|)
argument_list|)
expr_stmt|;
name|getb
argument_list|(
name|RECV_FD
argument_list|,
name|result
argument_list|,
literal|26
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|tzset
parameter_list|()
block|{
name|u_char
name|fnc
init|=
name|TZSET
decl_stmt|;
name|sewer
argument_list|()
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
operator|&
name|fnc
argument_list|,
sizeof|sizeof
name|fnc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|tm
modifier|*
name|localtime
parameter_list|(
name|tp
parameter_list|)
name|time_t
modifier|*
name|tp
decl_stmt|;
block|{
name|u_char
name|fnc
init|=
name|LOCALTIME
decl_stmt|;
name|sewer
argument_list|()
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
operator|&
name|fnc
argument_list|,
sizeof|sizeof
name|fnc
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
name|tp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tp
argument_list|)
argument_list|)
expr_stmt|;
name|getb
argument_list|(
name|RECV_FD
argument_list|,
operator|&
name|tmtmp
argument_list|,
sizeof|sizeof
name|tmtmp
argument_list|)
expr_stmt|;
name|getb
argument_list|(
name|RECV_FD
argument_list|,
name|result
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|tmtmp
operator|.
name|tm_zone
operator|=
name|result
expr_stmt|;
return|return
operator|(
operator|&
name|tmtmp
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|tm
modifier|*
name|gmtime
parameter_list|(
name|tp
parameter_list|)
name|time_t
modifier|*
name|tp
decl_stmt|;
block|{
name|u_char
name|fnc
init|=
name|GMTIME
decl_stmt|;
name|sewer
argument_list|()
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
operator|&
name|fnc
argument_list|,
sizeof|sizeof
name|fnc
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
name|tp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tp
argument_list|)
argument_list|)
expr_stmt|;
name|getb
argument_list|(
name|RECV_FD
argument_list|,
operator|&
name|tmtmp
argument_list|,
sizeof|sizeof
name|tmtmp
argument_list|)
expr_stmt|;
name|getb
argument_list|(
name|RECV_FD
argument_list|,
name|result
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|tmtmp
operator|.
name|tm_zone
operator|=
name|result
expr_stmt|;
return|return
operator|(
operator|&
name|tmtmp
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|tm
modifier|*
name|offtime
parameter_list|(
name|clock
parameter_list|,
name|offset
parameter_list|)
name|time_t
modifier|*
name|clock
decl_stmt|;
name|long
name|offset
decl_stmt|;
block|{
name|u_char
name|fnc
init|=
name|OFFTIME
decl_stmt|;
name|sewer
argument_list|()
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
operator|&
name|fnc
argument_list|,
sizeof|sizeof
name|fnc
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
name|clock
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|clock
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|SEND_FD
argument_list|,
operator|&
name|offset
argument_list|,
sizeof|sizeof
name|offset
argument_list|)
expr_stmt|;
name|getb
argument_list|(
name|RECV_FD
argument_list|,
operator|&
name|tmtmp
argument_list|,
sizeof|sizeof
name|tmtmp
argument_list|)
expr_stmt|;
name|tmtmp
operator|.
name|tm_zone
operator|=
literal|""
expr_stmt|;
return|return
operator|(
operator|&
name|tmtmp
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|getb
argument_list|(
name|f
argument_list|,
name|p
argument_list|,
name|n
argument_list|)
specifier|register
name|int
name|f
operator|,
name|n
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
while|while
condition|(
name|n
condition|)
block|{
name|i
operator|=
name|read
argument_list|(
name|f
argument_list|,
name|p
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
return|return;
name|p
operator|+=
name|i
expr_stmt|;
name|n
operator|-=
name|i
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|sewer
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|pid
decl_stmt|,
name|ourpid
init|=
name|getpid
argument_list|()
decl_stmt|;
if|if
condition|(
name|inited
operator|==
name|ourpid
condition|)
return|return;
if|if
condition|(
name|inited
condition|)
block|{
name|close
argument_list|(
name|SEND_FD
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|RECV_FD
argument_list|)
expr_stmt|;
block|}
name|pipe
argument_list|(
name|W
argument_list|)
expr_stmt|;
name|pipe
argument_list|(
name|R
argument_list|)
expr_stmt|;
name|pid
operator|=
name|vfork
argument_list|()
expr_stmt|;
if|if
condition|(
name|pid
operator|==
literal|0
condition|)
block|{
comment|/* child */
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* cancel alarms */
name|dup2
argument_list|(
name|W
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* parent write side to our stdin */
name|dup2
argument_list|(
name|R
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* parent read side to our stdout */
name|close
argument_list|(
name|SEND_FD
argument_list|)
expr_stmt|;
comment|/* copies made, close the... */
name|close
argument_list|(
name|RECV_FD
argument_list|)
expr_stmt|;
comment|/* originals now */
name|execl
argument_list|(
name|Ctimed
argument_list|,
literal|"ctimed"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
name|EX_OSFILE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pid
operator|==
operator|-
literal|1
condition|)
name|abort
argument_list|()
expr_stmt|;
comment|/* nothing else really to do */
name|close
argument_list|(
name|W
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* close read side of SEND channel */
name|close
argument_list|(
name|R
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* close write side of RECV channel */
name|inited
operator|=
name|ourpid
expr_stmt|;
comment|/* don't do this again in this proc */
block|}
end_block

begin_macro
name|XXctime
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|SEND_FD
condition|)
name|close
argument_list|(
name|SEND_FD
argument_list|)
expr_stmt|;
if|if
condition|(
name|RECV_FD
condition|)
name|close
argument_list|(
name|RECV_FD
argument_list|)
expr_stmt|;
name|SEND_FD
operator|=
name|RECV_FD
operator|=
literal|0
expr_stmt|;
name|inited
operator|=
literal|0
expr_stmt|;
block|}
end_block

end_unit


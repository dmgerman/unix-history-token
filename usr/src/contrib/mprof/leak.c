begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	leak.c 2.1 7/8/88 14:15:57	*/
end_comment

begin_comment
comment|/*	Copyright (c) 1987, Benjamin G. Zorn */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"mprof.h"
end_include

begin_decl_stmt
name|int
name|mprof_smemC
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|mpcell
name|lt_hmem
index|[
name|MP_HASH_SIZE
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
name|mpsstk
name|mp_new_sstk
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|lt_hash
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|lt_puthash
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|mpsstk
name|lt_lookup
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|mp_print_leak
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|bool
name|keeping_leaks
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bool
name|keeping_leaks
init|=
name|TRUE
decl_stmt|;
end_decl_stmt

begin_function
name|mpsstk
name|mp_new_sstk
parameter_list|(
name|nbytes
parameter_list|,
name|scallstack
parameter_list|)
name|int
name|nbytes
decl_stmt|;
name|unsigned
name|scallstack
index|[
name|SHORT_CALLSTACK_SIZE
index|]
decl_stmt|;
block|{
name|mpsstk
name|newsstk
init|=
operator|(
name|mpsstk
operator|)
name|malloc
argument_list|(
name|MPSSTK_SIZE
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mprof_smemC
operator|++
expr_stmt|;
name|sstk_allocs
argument_list|(
name|newsstk
argument_list|)
operator|=
literal|1
expr_stmt|;
name|sstk_bytes_alloced
argument_list|(
name|newsstk
argument_list|)
operator|=
name|nbytes
expr_stmt|;
name|sstk_frees
argument_list|(
name|newsstk
argument_list|)
operator|=
literal|0
expr_stmt|;
name|sstk_bytes_freed
argument_list|(
name|newsstk
argument_list|)
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SHORT_CALLSTACK_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|sstk_addrs
argument_list|(
name|newsstk
argument_list|)
index|[
name|i
index|]
operator|=
name|scallstack
index|[
name|i
index|]
expr_stmt|;
block|}
return|return
operator|(
name|newsstk
operator|)
return|;
block|}
end_function

begin_function
name|int
name|lt_hash
parameter_list|(
name|addrs
parameter_list|)
name|unsigned
name|addrs
index|[
name|SHORT_CALLSTACK_SIZE
index|]
decl_stmt|;
block|{
name|unsigned
name|tmp
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|int
name|hash
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SHORT_CALLSTACK_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|tmp
operator|^
name|addrs
index|[
name|i
index|]
expr_stmt|;
block|}
name|hash
operator|=
operator|(
name|tmp
operator|>>
literal|24
operator||
operator|(
name|tmp
operator|&
literal|0xff00
operator|)
operator|)
operator|^
operator|(
operator|(
operator|(
name|tmp
operator|&
literal|0xff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|tmp
operator|&
literal|0xff0000
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
return|return
operator|(
name|hash
operator|%
name|MP_HASH_SIZE
operator|)
return|;
block|}
end_function

begin_function
name|void
name|lt_puthash
parameter_list|(
name|s
parameter_list|)
name|mpsstk
name|s
decl_stmt|;
block|{
name|int
name|hash
init|=
name|lt_hash
argument_list|(
name|sstk_addrs
argument_list|(
name|s
argument_list|)
argument_list|)
decl_stmt|;
name|lt_hmem
index|[
name|hash
index|]
operator|=
name|mp_cons
argument_list|(
operator|(
name|int
operator|)
name|s
argument_list|,
name|lt_hmem
index|[
name|hash
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|mpsstk
name|lt_lookup
parameter_list|(
name|addrs
parameter_list|)
name|unsigned
name|addrs
index|[
name|SHORT_CALLSTACK_SIZE
index|]
decl_stmt|;
block|{
name|int
name|hash
init|=
name|lt_hash
argument_list|(
name|addrs
argument_list|)
decl_stmt|;
name|mpcell
name|c
init|=
name|lt_hmem
index|[
name|hash
index|]
decl_stmt|;
name|mpsstk
name|s
decl_stmt|;
name|int
name|i
decl_stmt|;
name|unsigned
modifier|*
name|haddrs
decl_stmt|;
while|while
condition|(
operator|!
name|mp_null
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|s
operator|=
operator|(
name|mpsstk
operator|)
name|mp_car
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|haddrs
operator|=
name|sstk_addrs
argument_list|(
name|s
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SHORT_CALLSTACK_SIZE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|addrs
index|[
name|i
index|]
operator|!=
name|haddrs
index|[
name|i
index|]
condition|)
block|{
break|break;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
name|SHORT_CALLSTACK_SIZE
operator|-
literal|1
condition|)
block|{
return|return
name|s
return|;
block|}
block|}
name|c
operator|=
operator|(
name|mpcell
operator|)
name|mp_cdr
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|mpsstk
operator|)
name|MP_NIL
return|;
block|}
end_function

begin_function
name|mpsstk
name|mp_add_leak_table
parameter_list|(
name|sstk
parameter_list|,
name|nbytes
parameter_list|)
name|unsigned
name|sstk
index|[
name|SHORT_CALLSTACK_SIZE
index|]
decl_stmt|;
name|int
name|nbytes
decl_stmt|;
block|{
name|mpsstk
name|s
decl_stmt|;
if|if
condition|(
operator|!
name|keeping_leaks
condition|)
return|return
name|NULL
return|;
name|s
operator|=
name|lt_lookup
argument_list|(
name|sstk
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
operator|(
name|mpsstk
operator|)
name|MP_NIL
condition|)
block|{
name|sstk_allocs
argument_list|(
name|s
argument_list|)
operator|++
expr_stmt|;
name|sstk_bytes_alloced
argument_list|(
name|s
argument_list|)
operator|+=
name|nbytes
expr_stmt|;
block|}
else|else
block|{
name|s
operator|=
name|mp_new_sstk
argument_list|(
name|nbytes
argument_list|,
name|sstk
argument_list|)
expr_stmt|;
name|lt_puthash
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
return|return
name|s
return|;
block|}
end_function

begin_function
name|void
name|mp_remove_leak_table
parameter_list|(
name|leakdata
parameter_list|,
name|nbytes
parameter_list|)
name|mpsstk
name|leakdata
decl_stmt|;
name|int
name|nbytes
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|keeping_leaks
condition|)
return|return;
if|if
condition|(
name|leakdata
operator|!=
operator|(
name|mpsstk
operator|)
name|MP_NIL
condition|)
block|{
name|sstk_frees
argument_list|(
name|leakdata
argument_list|)
operator|++
expr_stmt|;
name|sstk_bytes_freed
argument_list|(
name|leakdata
argument_list|)
operator|+=
name|nbytes
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"mp_remove_leak_table -- free of unallocated object\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|mp_print_leak_table
parameter_list|(
name|file
parameter_list|)
name|int
name|file
decl_stmt|;
block|{
name|mpsstk
name|s
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mpcell
name|chain
decl_stmt|;
name|int
name|abytes
init|=
literal|0
decl_stmt|,
name|fbytes
init|=
literal|0
decl_stmt|;
name|char
name|outbuf
index|[
literal|256
index|]
decl_stmt|;
comment|/*  sprintf(outbuf, "%10s %10s %10s %10s     %-10s\n", 	    "allocs", "bytes", "frees", "bytes", "path");     write(file, outbuf, strlen(outbuf)); */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MP_HASH_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|chain
operator|=
name|lt_hmem
index|[
name|i
index|]
expr_stmt|;
while|while
condition|(
operator|!
name|mp_null
argument_list|(
name|chain
argument_list|)
condition|)
block|{
name|s
operator|=
operator|(
name|mpsstk
operator|)
name|mp_car
argument_list|(
name|chain
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|sstk_allocs
argument_list|(
name|s
argument_list|)
operator|!=
name|sstk_frees
argument_list|(
name|s
argument_list|)
operator|)
operator|||
operator|(
name|sstk_bytes_alloced
argument_list|(
name|s
argument_list|)
operator|!=
name|sstk_bytes_freed
argument_list|(
name|s
argument_list|)
operator|)
operator|)
condition|)
block|{
name|mp_print_leak
argument_list|(
name|file
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
name|abytes
operator|+=
name|sstk_bytes_alloced
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|fbytes
operator|+=
name|sstk_bytes_freed
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|chain
operator|=
operator|(
name|mpcell
operator|)
name|mp_cdr
argument_list|(
name|chain
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*     printf(" a: %d f: %d\n", abytes, fbytes); */
name|write
argument_list|(
name|file
argument_list|,
literal|"-2 -1 -1 -1\n"
argument_list|,
literal|12
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mp_print_leak
parameter_list|(
name|file
parameter_list|,
name|s
parameter_list|)
name|int
name|file
decl_stmt|;
name|mpsstk
name|s
decl_stmt|;
block|{
name|char
name|outbuf
index|[
literal|256
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sprintf
argument_list|(
name|outbuf
argument_list|,
literal|"%d %d %d %d\n"
argument_list|,
name|sstk_allocs
argument_list|(
name|s
argument_list|)
argument_list|,
name|sstk_bytes_alloced
argument_list|(
name|s
argument_list|)
argument_list|,
name|sstk_frees
argument_list|(
name|s
argument_list|)
argument_list|,
name|sstk_bytes_freed
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|file
argument_list|,
name|outbuf
argument_list|,
name|strlen
argument_list|(
name|outbuf
argument_list|)
argument_list|)
expr_stmt|;
comment|/*     */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SHORT_CALLSTACK_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|outbuf
argument_list|,
literal|"%d\n"
argument_list|,
name|sstk_addrs
argument_list|(
name|s
argument_list|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|file
argument_list|,
name|outbuf
argument_list|,
name|strlen
argument_list|(
name|outbuf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	*/
block|}
block|}
end_function

begin_function
name|void
name|mpleak_init
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MP_HASH_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|lt_hmem
index|[
name|i
index|]
operator|=
operator|(
name|mpcell
operator|)
name|MP_NIL
expr_stmt|;
block|}
name|mprof_smemC
operator|=
literal|0
expr_stmt|;
block|}
end_function

end_unit


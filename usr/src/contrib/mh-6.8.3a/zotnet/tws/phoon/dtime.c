begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* dtime.c - routines to do ``ARPA-style'' time structures  ver  date   who remarks --- ------- --- ------------------------------------------------------------- 01B 15nov86 JP  Thouroughly hacked by Jef Poskanzer. 01A ??????? MTR Original version from the MH 6.5 distribution, courtesy 	          of Marshall Rose.  */
end_comment

begin_include
include|#
directive|include
file|"tws.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SYS5
end_ifdef

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_else
else|#
directive|else
else|SYS5
end_else

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<sys/timeb.h>
end_include

begin_endif
endif|#
directive|endif
endif|SYS5
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SYS5
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|daylight
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|long
name|timezone
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|tzname
index|[]
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|SYS5
end_endif

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|abs
parameter_list|(
name|a
parameter_list|)
value|( a>= 0 ? a : -a )
end_define

begin_decl_stmt
name|char
modifier|*
name|tw_moty
index|[]
init|=
block|{
literal|"Jan"
block|,
literal|"Feb"
block|,
literal|"Mar"
block|,
literal|"Apr"
block|,
literal|"May"
block|,
literal|"Jun"
block|,
literal|"Jul"
block|,
literal|"Aug"
block|,
literal|"Sep"
block|,
literal|"Oct"
block|,
literal|"Nov"
block|,
literal|"Dec"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tw_dotw
index|[]
init|=
block|{
literal|"Sun"
block|,
literal|"Mon"
block|,
literal|"Tue"
block|,
literal|"Wed"
block|,
literal|"Thu"
block|,
literal|"Fri"
block|,
literal|"Sat"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tw_ldotw
index|[]
init|=
block|{
literal|"Sunday"
block|,
literal|"Monday"
block|,
literal|"Tuesday"
block|,
literal|"Wednesday"
block|,
literal|"Thursday"
block|,
literal|"Friday"
block|,
literal|"Saturday"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_struct
specifier|static
struct|struct
name|zone
block|{
name|char
modifier|*
name|std
decl_stmt|;
name|char
modifier|*
name|dst
decl_stmt|;
name|int
name|shift
decl_stmt|;
block|}
name|zones
index|[]
init|=
block|{
literal|"GMT"
block|,
literal|"BST"
block|,
literal|0
block|,
literal|"EST"
block|,
literal|"EDT"
block|,
operator|-
literal|5
block|,
literal|"CST"
block|,
literal|"CDT"
block|,
operator|-
literal|6
block|,
literal|"MST"
block|,
name|NULL
block|,
operator|-
literal|7
block|,
literal|"PST"
block|,
literal|"PDT"
block|,
operator|-
literal|8
block|,
literal|"A"
block|,
name|NULL
block|,
operator|-
literal|1
block|,
literal|"B"
block|,
name|NULL
block|,
operator|-
literal|2
block|,
literal|"C"
block|,
name|NULL
block|,
operator|-
literal|3
block|,
literal|"D"
block|,
name|NULL
block|,
operator|-
literal|4
block|,
literal|"E"
block|,
name|NULL
block|,
operator|-
literal|5
block|,
literal|"F"
block|,
name|NULL
block|,
operator|-
literal|6
block|,
literal|"G"
block|,
name|NULL
block|,
operator|-
literal|7
block|,
literal|"H"
block|,
name|NULL
block|,
operator|-
literal|8
block|,
literal|"I"
block|,
name|NULL
block|,
operator|-
literal|9
block|,
literal|"K"
block|,
name|NULL
block|,
operator|-
literal|10
block|,
literal|"L"
block|,
name|NULL
block|,
operator|-
literal|11
block|,
literal|"M"
block|,
name|NULL
block|,
operator|-
literal|12
block|,
literal|"N"
block|,
name|NULL
block|,
literal|1
block|,
ifndef|#
directive|ifndef
name|HUJI
literal|"O"
block|,
name|NULL
block|,
literal|2
block|,
else|#
directive|else
else|HUJI
literal|"JST"
block|,
literal|"JDT"
block|,
literal|2
block|,
endif|#
directive|endif
endif|HUJI
literal|"P"
block|,
name|NULL
block|,
literal|3
block|,
literal|"Q"
block|,
name|NULL
block|,
literal|4
block|,
literal|"R"
block|,
name|NULL
block|,
literal|5
block|,
literal|"S"
block|,
name|NULL
block|,
literal|6
block|,
literal|"T"
block|,
name|NULL
block|,
literal|7
block|,
literal|"U"
block|,
name|NULL
block|,
literal|8
block|,
literal|"V"
block|,
name|NULL
block|,
literal|9
block|,
literal|"W"
block|,
name|NULL
block|,
literal|10
block|,
literal|"X"
block|,
name|NULL
block|,
literal|11
block|,
literal|"Y"
block|,
name|NULL
block|,
literal|12
block|,
name|NULL
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|CENTURY
value|19
end_define

begin_function_decl
name|long
name|time
parameter_list|( )
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|tm
modifier|*
name|localtime
parameter_list|( )
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|char
modifier|*
name|dtimenow
parameter_list|( )
block|{
name|long
name|clock
decl_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|clock
argument_list|)
expr_stmt|;
return|return
operator|(
name|dtime
argument_list|(
operator|&
name|clock
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|dctime
parameter_list|(
name|tw
parameter_list|)
name|struct
name|tws
modifier|*
name|tw
decl_stmt|;
block|{
specifier|static
name|char
name|buffer
index|[
literal|25
index|]
decl_stmt|;
if|if
condition|(
name|tw
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%.3s %.3s %02d %02d:%02d:%02d %.4d\n"
argument_list|,
name|tw_dotw
index|[
name|tw
operator|->
name|tw_wday
index|]
argument_list|,
name|tw_moty
index|[
name|tw
operator|->
name|tw_mon
index|]
argument_list|,
name|tw
operator|->
name|tw_mday
argument_list|,
name|tw
operator|->
name|tw_hour
argument_list|,
name|tw
operator|->
name|tw_min
argument_list|,
name|tw
operator|->
name|tw_sec
argument_list|,
name|tw
operator|->
name|tw_year
operator|>=
literal|100
condition|?
name|tw
operator|->
name|tw_year
else|:
literal|1900
operator|+
name|tw
operator|->
name|tw_year
argument_list|)
expr_stmt|;
return|return
operator|(
name|buffer
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|struct
name|tws
modifier|*
name|dtwstime
parameter_list|( )
block|{
name|long
name|clock
decl_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|clock
argument_list|)
expr_stmt|;
return|return
operator|(
name|dlocaltime
argument_list|(
operator|&
name|clock
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|tws
modifier|*
name|dlocaltime
parameter_list|(
name|clock
parameter_list|)
name|long
modifier|*
name|clock
decl_stmt|;
block|{
specifier|register
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
ifndef|#
directive|ifndef
name|SYS5
name|struct
name|timeb
name|tb
decl_stmt|;
endif|#
directive|endif
endif|not SYS5
specifier|static
name|struct
name|tws
name|tw
decl_stmt|;
if|if
condition|(
name|clock
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|tw
operator|.
name|tw_flags
operator|=
name|TW_NULL
expr_stmt|;
name|tm
operator|=
name|localtime
argument_list|(
name|clock
argument_list|)
expr_stmt|;
name|tw
operator|.
name|tw_sec
operator|=
name|tm
operator|->
name|tm_sec
expr_stmt|;
name|tw
operator|.
name|tw_min
operator|=
name|tm
operator|->
name|tm_min
expr_stmt|;
name|tw
operator|.
name|tw_hour
operator|=
name|tm
operator|->
name|tm_hour
expr_stmt|;
name|tw
operator|.
name|tw_mday
operator|=
name|tm
operator|->
name|tm_mday
expr_stmt|;
name|tw
operator|.
name|tw_mon
operator|=
name|tm
operator|->
name|tm_mon
expr_stmt|;
name|tw
operator|.
name|tw_year
operator|=
name|tm
operator|->
name|tm_year
expr_stmt|;
name|tw
operator|.
name|tw_wday
operator|=
name|tm
operator|->
name|tm_wday
expr_stmt|;
name|tw
operator|.
name|tw_yday
operator|=
name|tm
operator|->
name|tm_yday
expr_stmt|;
if|if
condition|(
name|tm
operator|->
name|tm_isdst
condition|)
name|tw
operator|.
name|tw_flags
operator||=
name|TW_DST
expr_stmt|;
ifndef|#
directive|ifndef
name|SYS5
name|ftime
argument_list|(
operator|&
name|tb
argument_list|)
expr_stmt|;
name|tw
operator|.
name|tw_zone
operator|=
operator|-
name|tb
operator|.
name|timezone
expr_stmt|;
else|#
directive|else
else|SYS5
name|tzset
argument_list|( )
expr_stmt|;
name|tw
operator|.
name|tw_zone
operator|=
operator|-
operator|(
name|timezone
operator|/
literal|60
operator|)
expr_stmt|;
endif|#
directive|endif
endif|SYS5
name|tw
operator|.
name|tw_flags
operator|&=
operator|~
name|TW_SDAY
expr_stmt|;
name|tw
operator|.
name|tw_flags
operator||=
name|TW_SEXP
expr_stmt|;
name|tw
operator|.
name|tw_clock
operator|=
operator|*
name|clock
expr_stmt|;
return|return
operator|(
operator|&
name|tw
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|tws
modifier|*
name|dgmtime
parameter_list|(
name|clock
parameter_list|)
name|long
modifier|*
name|clock
decl_stmt|;
block|{
specifier|register
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
specifier|static
name|struct
name|tws
name|tw
decl_stmt|;
if|if
condition|(
name|clock
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|tw
operator|.
name|tw_flags
operator|=
name|TW_NULL
expr_stmt|;
name|tm
operator|=
name|gmtime
argument_list|(
name|clock
argument_list|)
expr_stmt|;
name|tw
operator|.
name|tw_sec
operator|=
name|tm
operator|->
name|tm_sec
expr_stmt|;
name|tw
operator|.
name|tw_min
operator|=
name|tm
operator|->
name|tm_min
expr_stmt|;
name|tw
operator|.
name|tw_hour
operator|=
name|tm
operator|->
name|tm_hour
expr_stmt|;
name|tw
operator|.
name|tw_mday
operator|=
name|tm
operator|->
name|tm_mday
expr_stmt|;
name|tw
operator|.
name|tw_mon
operator|=
name|tm
operator|->
name|tm_mon
expr_stmt|;
name|tw
operator|.
name|tw_year
operator|=
name|tm
operator|->
name|tm_year
expr_stmt|;
name|tw
operator|.
name|tw_wday
operator|=
name|tm
operator|->
name|tm_wday
expr_stmt|;
name|tw
operator|.
name|tw_yday
operator|=
name|tm
operator|->
name|tm_yday
expr_stmt|;
if|if
condition|(
name|tm
operator|->
name|tm_isdst
condition|)
name|tw
operator|.
name|tw_flags
operator||=
name|TW_DST
expr_stmt|;
name|tw
operator|.
name|tw_zone
operator|=
literal|0
expr_stmt|;
name|tw
operator|.
name|tw_flags
operator|&=
operator|~
name|TW_SDAY
expr_stmt|;
name|tw
operator|.
name|tw_flags
operator||=
name|TW_SEXP
expr_stmt|;
name|tw
operator|.
name|tw_clock
operator|=
operator|*
name|clock
expr_stmt|;
return|return
operator|(
operator|&
name|tw
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|char
modifier|*
name|dasctime
parameter_list|(
name|tw
parameter_list|,
name|flags
parameter_list|)
name|struct
name|tws
modifier|*
name|tw
decl_stmt|;
name|int
name|flags
decl_stmt|;
block|{
specifier|static
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|,
name|result
index|[
literal|80
index|]
decl_stmt|;
if|if
condition|(
name|tw
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%02d %s %02d %02d:%02d:%02d %s"
argument_list|,
name|tw
operator|->
name|tw_mday
argument_list|,
name|tw_moty
index|[
name|tw
operator|->
name|tw_mon
index|]
argument_list|,
name|tw
operator|->
name|tw_year
argument_list|,
name|tw
operator|->
name|tw_hour
argument_list|,
name|tw
operator|->
name|tw_min
argument_list|,
name|tw
operator|->
name|tw_sec
argument_list|,
name|dtimezone
argument_list|(
name|tw
operator|->
name|tw_zone
argument_list|,
name|tw
operator|->
name|tw_flags
operator||
name|flags
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tw
operator|->
name|tw_flags
operator|&
name|TW_SDAY
operator|)
operator|==
name|TW_SEXP
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|result
argument_list|,
literal|"%s, %s"
argument_list|,
name|tw_dotw
index|[
name|tw
operator|->
name|tw_wday
index|]
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|tw
operator|->
name|tw_flags
operator|&
name|TW_SDAY
operator|)
operator|==
name|TW_SNIL
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|result
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|result
argument_list|,
literal|"%s (%s)"
argument_list|,
name|buffer
argument_list|,
name|tw_dotw
index|[
name|tw
operator|->
name|tw_wday
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|char
modifier|*
name|dtimezone
parameter_list|(
name|offset
parameter_list|,
name|flags
parameter_list|)
name|int
name|offset
decl_stmt|,
name|flags
decl_stmt|;
block|{
specifier|register
name|int
name|hours
decl_stmt|,
name|mins
decl_stmt|;
specifier|register
name|struct
name|zone
modifier|*
name|z
decl_stmt|;
specifier|static
name|char
name|buffer
index|[
literal|10
index|]
decl_stmt|;
if|if
condition|(
name|offset
operator|<
literal|0
condition|)
block|{
name|mins
operator|=
operator|-
operator|(
operator|(
operator|-
name|offset
operator|)
operator|%
literal|60
operator|)
expr_stmt|;
name|hours
operator|=
operator|-
operator|(
operator|(
operator|-
name|offset
operator|)
operator|/
literal|60
operator|)
expr_stmt|;
block|}
else|else
block|{
name|mins
operator|=
name|offset
operator|%
literal|60
expr_stmt|;
name|hours
operator|=
name|offset
operator|/
literal|60
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|TW_ZONE
operator|)
operator|&&
name|mins
operator|==
literal|0
condition|)
for|for
control|(
name|z
operator|=
name|zones
init|;
name|z
operator|->
name|std
condition|;
name|z
operator|++
control|)
if|if
condition|(
name|z
operator|->
name|shift
operator|==
name|hours
condition|)
return|return
operator|(
name|z
operator|->
name|dst
operator|&&
operator|(
name|flags
operator|&
name|TW_DST
operator|)
condition|?
name|z
operator|->
name|dst
else|:
name|z
operator|->
name|std
operator|)
return|;
ifdef|#
directive|ifdef
name|DSTXXX
if|if
condition|(
name|flags
operator|&
name|TW_DST
condition|)
name|hours
operator|+=
literal|1
expr_stmt|;
endif|#
directive|endif
endif|DSTXXX
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s%02d%02d"
argument_list|,
name|offset
operator|<
literal|0
condition|?
literal|"-"
else|:
literal|"+"
argument_list|,
name|abs
argument_list|(
name|hours
argument_list|)
argument_list|,
name|abs
argument_list|(
name|mins
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|buffer
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|void
name|twscopy
parameter_list|(
name|tb
parameter_list|,
name|tw
parameter_list|)
name|struct
name|tws
modifier|*
name|tb
decl_stmt|,
decl|*
name|tw
decl_stmt|;
end_function

begin_block
block|{
ifdef|#
directive|ifdef
name|notdef
name|tb
operator|->
name|tw_sec
operator|=
name|tw
operator|->
name|tw_sec
expr_stmt|;
name|tb
operator|->
name|tw_min
operator|=
name|tw
operator|->
name|tw_min
expr_stmt|;
name|tb
operator|->
name|tw_hour
operator|=
name|tw
operator|->
name|tw_hour
expr_stmt|;
name|tb
operator|->
name|tw_mday
operator|=
name|tw
operator|->
name|tw_mday
expr_stmt|;
name|tb
operator|->
name|tw_mon
operator|=
name|tw
operator|->
name|tw_mon
expr_stmt|;
name|tb
operator|->
name|tw_year
operator|=
name|tw
operator|->
name|tw_year
expr_stmt|;
name|tb
operator|->
name|tw_wday
operator|=
name|tw
operator|->
name|tw_wday
expr_stmt|;
name|tb
operator|->
name|tw_yday
operator|=
name|tw
operator|->
name|tw_yday
expr_stmt|;
name|tb
operator|->
name|tw_zone
operator|=
name|tw
operator|->
name|tw_zone
expr_stmt|;
name|tb
operator|->
name|tw_clock
operator|=
name|tw
operator|->
name|tw_clock
expr_stmt|;
name|tb
operator|->
name|tw_flags
operator|=
name|tw
operator|->
name|tw_flags
expr_stmt|;
else|#
directive|else
else|not notdef
operator|*
name|tb
operator|=
operator|*
name|tw
expr_stmt|;
endif|#
directive|endif
endif|not notdef
block|}
end_block

begin_function
name|int
name|twsort
parameter_list|(
name|tw1
parameter_list|,
name|tw2
parameter_list|)
name|struct
name|tws
modifier|*
name|tw1
decl_stmt|,
decl|*
name|tw2
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|long
name|c1
decl_stmt|,
name|c2
decl_stmt|;
operator|(
name|void
operator|)
name|twclock
argument_list|(
name|tw1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|twclock
argument_list|(
name|tw2
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|c1
operator|=
name|tw1
operator|->
name|tw_clock
operator|)
operator|>
operator|(
name|c2
operator|=
name|tw2
operator|->
name|tw_clock
operator|)
condition|?
literal|1
else|:
name|c1
operator|==
name|c2
condition|?
literal|0
else|:
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* Julian day number of the Unix clock's origin, 01 Jan 1970. */
end_comment

begin_define
define|#
directive|define
name|JD1970
value|2440587L
end_define

begin_function
name|long
name|twjuliandate
parameter_list|(
name|tw
parameter_list|)
name|struct
name|tws
modifier|*
name|tw
decl_stmt|;
block|{
specifier|register
name|int
name|mday
decl_stmt|,
name|mon
decl_stmt|,
name|year
decl_stmt|;
specifier|register
name|long
name|a
decl_stmt|,
name|b
decl_stmt|;
name|double
name|jd
decl_stmt|;
if|if
condition|(
operator|(
name|mday
operator|=
name|tw
operator|->
name|tw_mday
operator|)
operator|<
literal|1
operator|||
name|mday
operator|>
literal|31
operator|||
operator|(
name|mon
operator|=
name|tw
operator|->
name|tw_mon
operator|+
literal|1
operator|)
operator|<
literal|1
operator|||
name|mon
operator|>
literal|12
operator|||
operator|(
name|year
operator|=
name|tw
operator|->
name|tw_year
operator|)
operator|<
literal|1
operator|||
name|year
operator|>
literal|10000
condition|)
return|return
operator|(
operator|-
literal|1L
operator|)
return|;
if|if
condition|(
name|year
operator|<
literal|100
condition|)
name|year
operator|+=
name|CENTURY
operator|*
literal|100
expr_stmt|;
if|if
condition|(
name|mon
operator|==
literal|1
operator|||
name|mon
operator|==
literal|2
condition|)
block|{
operator|--
name|year
expr_stmt|;
name|mon
operator|+=
literal|12
expr_stmt|;
block|}
if|if
condition|(
name|year
operator|<
literal|1583
condition|)
return|return
operator|(
operator|-
literal|1L
operator|)
return|;
name|a
operator|=
name|year
operator|/
literal|100
expr_stmt|;
name|b
operator|=
literal|2
operator|-
name|a
operator|+
name|a
operator|/
literal|4
expr_stmt|;
name|b
operator|+=
call|(
name|long
call|)
argument_list|(
operator|(
name|double
operator|)
name|year
operator|*
literal|365.25
argument_list|)
expr_stmt|;
name|b
operator|+=
call|(
name|long
call|)
argument_list|(
literal|30.6001
operator|*
operator|(
operator|(
name|double
operator|)
name|mon
operator|+
literal|1.0
operator|)
argument_list|)
expr_stmt|;
name|jd
operator|=
name|mday
operator|+
name|b
operator|+
literal|1720994.5
expr_stmt|;
return|return
operator|(
operator|(
name|long
operator|)
name|jd
operator|)
return|;
block|}
end_function

begin_function
name|long
name|twsubdayclock
parameter_list|(
name|tw
parameter_list|)
name|struct
name|tws
modifier|*
name|tw
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|sec
decl_stmt|,
name|min
decl_stmt|,
name|hour
decl_stmt|;
specifier|register
name|long
name|result
decl_stmt|;
if|if
condition|(
operator|(
name|sec
operator|=
name|tw
operator|->
name|tw_sec
operator|)
operator|<
literal|0
operator|||
name|sec
operator|>
literal|59
operator|||
operator|(
name|min
operator|=
name|tw
operator|->
name|tw_min
operator|)
operator|<
literal|0
operator|||
name|min
operator|>
literal|59
operator|||
operator|(
name|hour
operator|=
name|tw
operator|->
name|tw_hour
operator|)
operator|<
literal|0
operator|||
name|hour
operator|>
literal|23
condition|)
return|return
operator|(
operator|-
literal|1L
operator|)
return|;
name|result
operator|=
operator|(
name|hour
operator|*
literal|60
operator|+
name|min
operator|)
operator|*
literal|60
operator|+
name|sec
expr_stmt|;
name|result
operator|-=
literal|60
operator|*
name|tw
operator|->
name|tw_zone
expr_stmt|;
if|if
condition|(
name|tw
operator|->
name|tw_flags
operator|&
name|TW_DST
condition|)
name|result
operator|-=
literal|60
operator|*
literal|60
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|long
name|twclock
parameter_list|(
name|tw
parameter_list|)
name|struct
name|tws
modifier|*
name|tw
decl_stmt|;
block|{
specifier|register
name|long
name|jd
decl_stmt|,
name|sdc
decl_stmt|,
name|result
decl_stmt|;
if|if
condition|(
name|tw
operator|->
name|tw_clock
operator|!=
literal|0L
condition|)
return|return
operator|(
name|tw
operator|->
name|tw_clock
operator|)
return|;
if|if
condition|(
operator|(
name|jd
operator|=
name|twjuliandate
argument_list|(
name|tw
argument_list|)
operator|)
operator|==
operator|-
literal|1L
condition|)
return|return
operator|(
name|tw
operator|->
name|tw_clock
operator|=
operator|-
literal|1L
operator|)
return|;
if|if
condition|(
operator|(
name|sdc
operator|=
name|twsubdayclock
argument_list|(
name|tw
argument_list|)
operator|)
operator|==
operator|-
literal|1L
condition|)
return|return
operator|(
name|tw
operator|->
name|tw_clock
operator|=
operator|-
literal|1L
operator|)
return|;
name|result
operator|=
operator|(
name|jd
operator|-
name|JD1970
operator|)
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60
operator|+
name|sdc
expr_stmt|;
return|return
operator|(
name|tw
operator|->
name|tw_clock
operator|=
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/*** twsubtract - subtract tw2 from tw1, returning result in seconds  The point of this routine is that using twclock( tw1 ) - twclock( tw2 ) would limit you to dates after the Unix Epoch ( 01 January 1970 ).  This routine avoids that limit.  However, because the result is represented by 32 bits, it is still limited to a span of two billion seconds, which is about 66 years.  */
end_comment

begin_function
name|long
name|twsubtract
parameter_list|(
name|tw1
parameter_list|,
name|tw2
parameter_list|)
name|struct
name|tws
modifier|*
name|tw1
decl_stmt|,
decl|*
name|tw2
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|long
name|jd1
decl_stmt|,
name|jd2
decl_stmt|,
name|sdc1
decl_stmt|,
name|sdc2
decl_stmt|,
name|result
decl_stmt|;
if|if
condition|(
operator|(
name|jd1
operator|=
name|twjuliandate
argument_list|(
name|tw1
argument_list|)
operator|)
operator|==
operator|-
literal|1L
condition|)
return|return
operator|(
literal|0L
operator|)
return|;
if|if
condition|(
operator|(
name|sdc1
operator|=
name|twsubdayclock
argument_list|(
name|tw1
argument_list|)
operator|)
operator|==
operator|-
literal|1L
condition|)
return|return
operator|(
literal|0L
operator|)
return|;
if|if
condition|(
operator|(
name|jd2
operator|=
name|twjuliandate
argument_list|(
name|tw2
argument_list|)
operator|)
operator|==
operator|-
literal|1L
condition|)
return|return
operator|(
literal|0L
operator|)
return|;
if|if
condition|(
operator|(
name|sdc2
operator|=
name|twsubdayclock
argument_list|(
name|tw2
argument_list|)
operator|)
operator|==
operator|-
literal|1L
condition|)
return|return
operator|(
literal|0L
operator|)
return|;
name|result
operator|=
operator|(
name|jd1
operator|-
name|jd2
operator|)
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60
operator|+
operator|(
name|sdc1
operator|-
name|sdc2
operator|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/*  *    Simple calculation of day of the week.  Algorithm used is Zeller's  *    congruence.  Currently, we assume if tw -> tw_year< 100  *    then the century is CENTURY.  */
end_comment

begin_macro
name|set_dotw
argument_list|(
argument|tw
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|tws
modifier|*
name|tw
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|month
decl_stmt|,
name|day
decl_stmt|,
name|year
decl_stmt|,
name|century
decl_stmt|;
name|month
operator|=
name|tw
operator|->
name|tw_mon
operator|-
literal|1
expr_stmt|;
name|day
operator|=
name|tw
operator|->
name|tw_mday
expr_stmt|;
name|year
operator|=
name|tw
operator|->
name|tw_year
operator|%
literal|100
expr_stmt|;
name|century
operator|=
name|tw
operator|->
name|tw_year
operator|>=
literal|100
condition|?
name|tw
operator|->
name|tw_year
operator|/
literal|100
else|:
name|CENTURY
expr_stmt|;
if|if
condition|(
name|month
operator|<=
literal|0
condition|)
block|{
name|month
operator|+=
literal|12
expr_stmt|;
if|if
condition|(
operator|--
name|year
operator|<
literal|0
condition|)
block|{
name|year
operator|+=
literal|100
expr_stmt|;
name|century
operator|--
expr_stmt|;
block|}
block|}
name|tw
operator|->
name|tw_wday
operator|=
operator|(
operator|(
literal|26
operator|*
name|month
operator|-
literal|2
operator|)
operator|/
literal|10
operator|+
name|day
operator|+
name|year
operator|+
name|year
operator|/
literal|4
operator|-
literal|3
operator|*
name|century
operator|/
literal|4
operator|+
literal|1
operator|)
operator|%
literal|7
expr_stmt|;
name|tw
operator|->
name|tw_flags
operator|&=
operator|~
name|TW_SDAY
expr_stmt|;
name|tw
operator|->
name|tw_flags
operator||=
name|TW_SIMP
expr_stmt|;
block|}
end_block

end_unit


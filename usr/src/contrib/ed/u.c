begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1992 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Rodney Ruddock of the University of Guelph.  *  * %sccs.include.redist.c%  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)u.c	5.1 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|"ed.h"
end_include

begin_comment
comment|/*  * This restores the buffer to the state it was in just before the  * last buffer modifying command - the global commands (with command  * list) are looked at as one buffer modifying command. Note: this  * just manipulates the undo stack (u_stk); x-ref u_add_stk(),  * u_clr_stk(), d_add(), and d_do().  */
end_comment

begin_function
name|void
name|u
parameter_list|(
name|inputt
parameter_list|,
name|errnum
parameter_list|)
name|FILE
modifier|*
name|inputt
decl_stmt|;
name|int
modifier|*
name|errnum
decl_stmt|;
block|{
if|if
condition|(
name|rol
argument_list|(
name|inputt
argument_list|,
name|errnum
argument_list|)
condition|)
return|return;
if|if
condition|(
name|u_stk
operator|==
name|NULL
condition|)
block|{
operator|*
name|errnum
operator|=
literal|1
expr_stmt|;
return|return;
block|}
name|undo
argument_list|()
expr_stmt|;
operator|*
name|errnum
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/* end-u */
end_comment

begin_comment
comment|/* This function does the "real work" of the undo. */
end_comment

begin_function
name|void
name|undo
parameter_list|()
block|{
name|LINE
modifier|*
name|l_current
decl_stmt|,
modifier|*
name|l_bottom
decl_stmt|,
modifier|*
name|l_top
decl_stmt|;
name|struct
name|u_layer
modifier|*
name|l_old_u_stk
decl_stmt|,
modifier|*
name|l_temp
decl_stmt|;
comment|/* this is done because undo can be undone */
name|l_current
operator|=
name|u_current
expr_stmt|;
name|l_top
operator|=
name|u_top
expr_stmt|;
name|l_bottom
operator|=
name|u_bottom
expr_stmt|;
name|u_current
operator|=
name|current
expr_stmt|;
name|u_top
operator|=
name|top
expr_stmt|;
name|u_bottom
operator|=
name|bottom
expr_stmt|;
name|l_old_u_stk
operator|=
name|u_stk
expr_stmt|;
name|u_stk
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|l_old_u_stk
operator|!=
name|NULL
condition|)
block|{
name|u_add_stk
argument_list|(
name|l_old_u_stk
operator|->
name|cell
argument_list|)
expr_stmt|;
operator|(
operator|*
operator|(
name|l_old_u_stk
operator|->
name|cell
operator|)
operator|)
operator|=
operator|(
name|l_old_u_stk
operator|->
name|val
operator|)
expr_stmt|;
name|l_temp
operator|=
name|l_old_u_stk
expr_stmt|;
name|l_old_u_stk
operator|=
name|l_old_u_stk
operator|->
name|below
expr_stmt|;
name|free
argument_list|(
name|l_temp
argument_list|)
expr_stmt|;
block|}
comment|/* end-while */
name|current
operator|=
name|l_current
expr_stmt|;
name|top
operator|=
name|l_top
expr_stmt|;
name|bottom
operator|=
name|l_bottom
expr_stmt|;
block|}
end_function

begin_comment
comment|/* end-undo */
end_comment

begin_comment
comment|/* this function should be called before u_add_stk is in each command  * function, _except_ when the global flag is high (>0) -- otherwise,  * we couldn't undo all of the global commands, only the last iteration  * of the last command -- and the u command.  * This is where we begin to dispose of ed's undo knowledge of a line.  * The call to d_do() gets rid of the rest.  */
end_comment

begin_function
name|void
name|u_clr_stk
parameter_list|()
block|{
specifier|register
name|struct
name|u_layer
modifier|*
name|l_temp
decl_stmt|;
name|u_current
operator|=
name|current
expr_stmt|;
name|u_top
operator|=
name|top
expr_stmt|;
name|u_bottom
operator|=
name|bottom
expr_stmt|;
if|if
condition|(
operator|(
name|u_stk
operator|)
operator|&&
operator|(
name|d_stk
operator|)
condition|)
comment|/* only if there is something to delete in the buffer */
name|d_do
argument_list|()
expr_stmt|;
while|while
condition|(
name|u_stk
operator|!=
name|NULL
condition|)
block|{
name|l_temp
operator|=
name|u_stk
expr_stmt|;
name|u_stk
operator|=
name|u_stk
operator|->
name|below
expr_stmt|;
name|free
argument_list|(
name|l_temp
argument_list|)
expr_stmt|;
block|}
name|u_stk
operator|=
name|NULL
expr_stmt|;
comment|/* just to sure */
block|}
end_function

begin_comment
comment|/* end-u_clr_stk */
end_comment

begin_comment
comment|/*  * Place the addresses of and the pointer values of the LINE structures  * that are being changed on the undo stack.  * This is a quick, simple, and effective way to preserve what could be  * be brought back on request without keeping a copy of every bleep'n  * thing.  */
end_comment

begin_function
name|void
name|u_add_stk
parameter_list|(
name|in
parameter_list|)
name|LINE
modifier|*
modifier|*
name|in
decl_stmt|;
block|{
specifier|register
name|struct
name|u_layer
modifier|*
name|l_now
decl_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
return|return;
name|l_now
operator|=
operator|(
expr|struct
name|u_layer
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|u_layer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|l_now
operator|==
name|NULL
condition|)
block|{
name|strcpy
argument_list|(
name|help_msg
argument_list|,
literal|"undo: out of memory error"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|u_stk
operator|==
name|NULL
condition|)
operator|(
name|l_now
operator|->
name|below
operator|)
operator|=
name|NULL
expr_stmt|;
else|else
operator|(
name|l_now
operator|->
name|below
operator|)
operator|=
name|u_stk
expr_stmt|;
name|u_stk
operator|=
name|l_now
expr_stmt|;
operator|(
name|u_stk
operator|->
name|cell
operator|)
operator|=
name|in
expr_stmt|;
operator|(
name|u_stk
operator|->
name|val
operator|)
operator|=
operator|(
operator|*
operator|(
name|u_stk
operator|->
name|cell
operator|)
operator|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* end-u_add_stk */
end_comment

end_unit


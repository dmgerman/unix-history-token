begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * strftime.c  *  * Public-domain relatively quick-and-dirty implementation of  * ANSI library routine for System V Unix systems.  *  * It's written in old-style C for maximal portability.  * However, since I'm used to prototypes, I've included them too.  *  * If you want stuff in the System V ascftime routine, add the SYSV_EXT define.  * For extensions from SunOS, add SUNOS_EXT.  * For stuff needed to implement the P1003.2 date command, add POSIX2_DATE.  * For complete POSIX semantics, add POSIX_SEMANTICS.  *  * The code for %c, %x, and %X is my best guess as to what's "appropriate".  * This version ignores LOCALE information.  * It also doesn't worry about multi-byte characters.  * So there.  *  * This file is also shipped with GAWK (GNU Awk), gawk specific bits of  * code are included if GAWK is defined.  *  * Arnold Robbins  * January, February, March, 1991  * Updated March, April 1992  * Updated April, 1993  *  * Fixes from ado@elsie.nci.nih.gov  * February 1991, May 1992  * Fixes from Tor Lillqvist tor@tik.vtt.fi  * May, 1993  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|GAWK
end_ifndef

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defaults: season to taste */
end_comment

begin_define
define|#
directive|define
name|SYSV_EXT
value|1
end_define

begin_comment
comment|/* stuff in System V ascftime routine */
end_comment

begin_define
define|#
directive|define
name|SUNOS_EXT
value|1
end_define

begin_comment
comment|/* stuff in SunOS strftime routine */
end_comment

begin_define
define|#
directive|define
name|POSIX2_DATE
value|1
end_define

begin_comment
comment|/* stuff in Posix 1003.2 date command */
end_comment

begin_define
define|#
directive|define
name|VMS_EXT
value|1
end_define

begin_comment
comment|/* include %v for VMS date format */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|GAWK
end_ifndef

begin_define
define|#
directive|define
name|POSIX_SEMANTICS
value|1
end_define

begin_comment
comment|/* call tzset() if TZ changes */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|POSIX2_DATE
argument_list|)
end_if

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|SYSV_EXT
argument_list|)
end_if

begin_define
define|#
directive|define
name|SYSV_EXT
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|SUNOS_EXT
argument_list|)
end_if

begin_define
define|#
directive|define
name|SUNOS_EXT
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|POSIX2_DATE
argument_list|)
end_if

begin_define
define|#
directive|define
name|adddecl
parameter_list|(
name|stuff
parameter_list|)
value|stuff
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|adddecl
parameter_list|(
name|stuff
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|strchr
end_undef

begin_comment
comment|/* avoid AIX weirdness */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__STDC__
end_ifndef

begin_define
define|#
directive|define
name|const
end_define

begin_comment
comment|/**/
end_comment

begin_function_decl
specifier|extern
name|void
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
modifier|*
name|realloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|tzset
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|strchr
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|weeknumber
parameter_list|()
function_decl|;
end_function_decl

begin_macro
name|adddecl
argument_list|(
argument|static int iso8601wknum();
argument_list|)
end_macro

begin_else
else|#
directive|else
end_else

begin_function_decl
specifier|extern
name|void
modifier|*
name|malloc
parameter_list|(
name|unsigned
name|count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
modifier|*
name|realloc
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|,
name|unsigned
name|count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|tzset
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|strchr
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|int
name|ch
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|getenv
parameter_list|(
specifier|const
name|char
modifier|*
name|v
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|weeknumber
parameter_list|(
specifier|const
name|struct
name|tm
modifier|*
name|timeptr
parameter_list|,
name|int
name|firstweekday
parameter_list|)
function_decl|;
end_function_decl

begin_macro
name|adddecl
argument_list|(
argument|static int iso8601wknum(const struct tm *timeptr);
argument_list|)
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_define
define|#
directive|define
name|inline
value|__inline__
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|inline
end_define

begin_comment
comment|/**/
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|range
parameter_list|(
name|low
parameter_list|,
name|item
parameter_list|,
name|hi
parameter_list|)
value|max(low, min(item, hi))
end_define

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|MSDOS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|TZNAME_MISSING
argument_list|)
end_if

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|tzname
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|daylight
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* min --- return minimum of two numbers */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__STDC__
end_ifndef

begin_decl_stmt
specifier|static
specifier|inline
name|int
name|min
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_function
specifier|static
specifier|inline
name|int
name|min
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|b
parameter_list|)
endif|#
directive|endif
block|{
return|return
operator|(
name|a
operator|<
name|b
condition|?
name|a
else|:
name|b
operator|)
return|;
block|}
end_function

begin_comment
comment|/* max --- return maximum of two numbers */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__STDC__
end_ifndef

begin_decl_stmt
specifier|static
specifier|inline
name|int
name|max
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_function
specifier|static
specifier|inline
name|int
name|max
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|b
parameter_list|)
endif|#
directive|endif
block|{
return|return
operator|(
name|a
operator|>
name|b
condition|?
name|a
else|:
name|b
operator|)
return|;
block|}
end_function

begin_comment
comment|/* strftime --- produce formatted time */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__STDC__
end_ifndef

begin_decl_stmt
name|size_t
name|strftime
argument_list|(
name|s
argument_list|,
name|maxsize
argument_list|,
name|format
argument_list|,
name|timeptr
argument_list|)
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|maxsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|format
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|struct
name|tm
modifier|*
name|timeptr
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_function
name|size_t
name|strftime
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|size_t
name|maxsize
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
specifier|const
name|struct
name|tm
modifier|*
name|timeptr
parameter_list|)
endif|#
directive|endif
block|{
name|char
modifier|*
name|endp
init|=
name|s
operator|+
name|maxsize
decl_stmt|;
name|char
modifier|*
name|start
init|=
name|s
decl_stmt|;
name|char
name|tbuf
index|[
literal|100
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|static
name|short
name|first
init|=
literal|1
decl_stmt|;
ifdef|#
directive|ifdef
name|POSIX_SEMANTICS
specifier|static
name|char
modifier|*
name|savetz
init|=
name|NULL
decl_stmt|;
specifier|static
name|int
name|savetzlen
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|tz
decl_stmt|;
endif|#
directive|endif
comment|/* POSIX_SEMANTICS */
comment|/* various tables, useful in North America */
specifier|static
name|char
modifier|*
name|days_a
index|[]
init|=
block|{
literal|"Sun"
block|,
literal|"Mon"
block|,
literal|"Tue"
block|,
literal|"Wed"
block|,
literal|"Thu"
block|,
literal|"Fri"
block|,
literal|"Sat"
block|, 	}
decl_stmt|;
specifier|static
name|char
modifier|*
name|days_l
index|[]
init|=
block|{
literal|"Sunday"
block|,
literal|"Monday"
block|,
literal|"Tuesday"
block|,
literal|"Wednesday"
block|,
literal|"Thursday"
block|,
literal|"Friday"
block|,
literal|"Saturday"
block|, 	}
decl_stmt|;
specifier|static
name|char
modifier|*
name|months_a
index|[]
init|=
block|{
literal|"Jan"
block|,
literal|"Feb"
block|,
literal|"Mar"
block|,
literal|"Apr"
block|,
literal|"May"
block|,
literal|"Jun"
block|,
literal|"Jul"
block|,
literal|"Aug"
block|,
literal|"Sep"
block|,
literal|"Oct"
block|,
literal|"Nov"
block|,
literal|"Dec"
block|, 	}
decl_stmt|;
specifier|static
name|char
modifier|*
name|months_l
index|[]
init|=
block|{
literal|"January"
block|,
literal|"February"
block|,
literal|"March"
block|,
literal|"April"
block|,
literal|"May"
block|,
literal|"June"
block|,
literal|"July"
block|,
literal|"August"
block|,
literal|"September"
block|,
literal|"October"
block|,
literal|"November"
block|,
literal|"December"
block|, 	}
decl_stmt|;
specifier|static
name|char
modifier|*
name|ampm
index|[]
init|=
block|{
literal|"AM"
block|,
literal|"PM"
block|, }
decl_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
operator|||
name|format
operator|==
name|NULL
operator|||
name|timeptr
operator|==
name|NULL
operator|||
name|maxsize
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|strchr
argument_list|(
name|format
argument_list|,
literal|'%'
argument_list|)
operator|==
name|NULL
operator|&&
name|strlen
argument_list|(
name|format
argument_list|)
operator|+
literal|1
operator|>=
name|maxsize
condition|)
return|return
literal|0
return|;
ifndef|#
directive|ifndef
name|POSIX_SEMANTICS
if|if
condition|(
name|first
condition|)
block|{
name|tzset
argument_list|()
expr_stmt|;
name|first
operator|=
literal|0
expr_stmt|;
block|}
else|#
directive|else
comment|/* POSIX_SEMANTICS */
name|tz
operator|=
name|getenv
argument_list|(
literal|"TZ"
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
condition|)
block|{
if|if
condition|(
name|tz
operator|!=
name|NULL
condition|)
block|{
name|int
name|tzlen
init|=
name|strlen
argument_list|(
name|tz
argument_list|)
decl_stmt|;
name|savetz
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|tzlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|savetz
operator|!=
name|NULL
condition|)
block|{
name|savetzlen
operator|=
name|tzlen
operator|+
literal|1
expr_stmt|;
name|strcpy
argument_list|(
name|savetz
argument_list|,
name|tz
argument_list|)
expr_stmt|;
block|}
block|}
name|tzset
argument_list|()
expr_stmt|;
name|first
operator|=
literal|0
expr_stmt|;
block|}
comment|/* if we have a saved TZ, and it is different, recapture and reset */
if|if
condition|(
name|tz
operator|&&
name|savetz
operator|&&
operator|(
name|tz
index|[
literal|0
index|]
operator|!=
name|savetz
index|[
literal|0
index|]
operator|||
name|strcmp
argument_list|(
name|tz
argument_list|,
name|savetz
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|i
operator|=
name|strlen
argument_list|(
name|tz
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|savetzlen
condition|)
block|{
name|savetz
operator|=
operator|(
name|char
operator|*
operator|)
name|realloc
argument_list|(
name|savetz
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|savetz
condition|)
block|{
name|savetzlen
operator|=
name|i
expr_stmt|;
name|strcpy
argument_list|(
name|savetz
argument_list|,
name|tz
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|strcpy
argument_list|(
name|savetz
argument_list|,
name|tz
argument_list|)
expr_stmt|;
name|tzset
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* POSIX_SEMANTICS */
for|for
control|(
init|;
operator|*
name|format
operator|&&
name|s
operator|<
name|endp
operator|-
literal|1
condition|;
name|format
operator|++
control|)
block|{
name|tbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|format
operator|!=
literal|'%'
condition|)
block|{
operator|*
name|s
operator|++
operator|=
operator|*
name|format
expr_stmt|;
continue|continue;
block|}
name|again
label|:
switch|switch
condition|(
operator|*
operator|++
name|format
condition|)
block|{
case|case
literal|'\0'
case|:
operator|*
name|s
operator|++
operator|=
literal|'%'
expr_stmt|;
goto|goto
name|out
goto|;
case|case
literal|'%'
case|:
operator|*
name|s
operator|++
operator|=
literal|'%'
expr_stmt|;
continue|continue;
case|case
literal|'a'
case|:
comment|/* abbreviated weekday name */
if|if
condition|(
name|timeptr
operator|->
name|tm_wday
operator|<
literal|0
operator|||
name|timeptr
operator|->
name|tm_wday
operator|>
literal|6
condition|)
name|strcpy
argument_list|(
name|tbuf
argument_list|,
literal|"?"
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|days_a
index|[
name|timeptr
operator|->
name|tm_wday
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
comment|/* full weekday name */
if|if
condition|(
name|timeptr
operator|->
name|tm_wday
operator|<
literal|0
operator|||
name|timeptr
operator|->
name|tm_wday
operator|>
literal|6
condition|)
name|strcpy
argument_list|(
name|tbuf
argument_list|,
literal|"?"
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|days_l
index|[
name|timeptr
operator|->
name|tm_wday
index|]
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|SYSV_EXT
case|case
literal|'h'
case|:
comment|/* abbreviated month name */
endif|#
directive|endif
case|case
literal|'b'
case|:
comment|/* abbreviated month name */
if|if
condition|(
name|timeptr
operator|->
name|tm_mon
operator|<
literal|0
operator|||
name|timeptr
operator|->
name|tm_mon
operator|>
literal|11
condition|)
name|strcpy
argument_list|(
name|tbuf
argument_list|,
literal|"?"
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|months_a
index|[
name|timeptr
operator|->
name|tm_mon
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* full month name */
if|if
condition|(
name|timeptr
operator|->
name|tm_mon
operator|<
literal|0
operator|||
name|timeptr
operator|->
name|tm_mon
operator|>
literal|11
condition|)
name|strcpy
argument_list|(
name|tbuf
argument_list|,
literal|"?"
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|months_l
index|[
name|timeptr
operator|->
name|tm_mon
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
comment|/* appropriate date and time representation */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%s %s %2d %02d:%02d:%02d %d"
argument_list|,
name|days_a
index|[
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_wday
argument_list|,
literal|6
argument_list|)
index|]
argument_list|,
name|months_a
index|[
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_mon
argument_list|,
literal|11
argument_list|)
index|]
argument_list|,
name|range
argument_list|(
literal|1
argument_list|,
name|timeptr
operator|->
name|tm_mday
argument_list|,
literal|31
argument_list|)
argument_list|,
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_hour
argument_list|,
literal|23
argument_list|)
argument_list|,
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_min
argument_list|,
literal|59
argument_list|)
argument_list|,
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_sec
argument_list|,
literal|61
argument_list|)
argument_list|,
name|timeptr
operator|->
name|tm_year
operator|+
literal|1900
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
comment|/* day of the month, 01 - 31 */
name|i
operator|=
name|range
argument_list|(
literal|1
argument_list|,
name|timeptr
operator|->
name|tm_mday
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%02d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
comment|/* hour, 24-hour clock, 00 - 23 */
name|i
operator|=
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_hour
argument_list|,
literal|23
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%02d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
comment|/* hour, 12-hour clock, 01 - 12 */
name|i
operator|=
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_hour
argument_list|,
literal|23
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|i
operator|=
literal|12
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|>
literal|12
condition|)
name|i
operator|-=
literal|12
expr_stmt|;
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%02d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'j'
case|:
comment|/* day of the year, 001 - 366 */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%03d"
argument_list|,
name|timeptr
operator|->
name|tm_yday
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* month, 01 - 12 */
name|i
operator|=
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_mon
argument_list|,
literal|11
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%02d"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
comment|/* minute, 00 - 59 */
name|i
operator|=
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_min
argument_list|,
literal|59
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%02d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* am or pm based on 12-hour clock */
name|i
operator|=
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_hour
argument_list|,
literal|23
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|12
condition|)
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|ampm
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|ampm
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* second, 00 - 61 */
name|i
operator|=
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_sec
argument_list|,
literal|61
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%02d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'U'
case|:
comment|/* week of year, Sunday is first day of week */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%d"
argument_list|,
name|weeknumber
argument_list|(
name|timeptr
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
comment|/* weekday, Sunday == 0, 0 - 6 */
name|i
operator|=
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_wday
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
comment|/* week of year, Monday is first day of week */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%d"
argument_list|,
name|weeknumber
argument_list|(
name|timeptr
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
comment|/* appropriate date representation */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%s %s %2d %d"
argument_list|,
name|days_a
index|[
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_wday
argument_list|,
literal|6
argument_list|)
index|]
argument_list|,
name|months_a
index|[
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_mon
argument_list|,
literal|11
argument_list|)
index|]
argument_list|,
name|range
argument_list|(
literal|1
argument_list|,
name|timeptr
operator|->
name|tm_mday
argument_list|,
literal|31
argument_list|)
argument_list|,
name|timeptr
operator|->
name|tm_year
operator|+
literal|1900
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
comment|/* appropriate time representation */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%02d:%02d:%02d"
argument_list|,
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_hour
argument_list|,
literal|23
argument_list|)
argument_list|,
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_min
argument_list|,
literal|59
argument_list|)
argument_list|,
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_sec
argument_list|,
literal|61
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'y'
case|:
comment|/* year without a century, 00 - 99 */
name|i
operator|=
name|timeptr
operator|->
name|tm_year
operator|%
literal|100
expr_stmt|;
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'Y'
case|:
comment|/* year with century */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%d"
argument_list|,
literal|1900
operator|+
name|timeptr
operator|->
name|tm_year
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'Z'
case|:
comment|/* time zone name or abbrevation */
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
ifndef|#
directive|ifndef
name|TZNAME_MISSING
name|daylight
operator|&&
endif|#
directive|endif
name|timeptr
operator|->
name|tm_isdst
condition|)
name|i
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|TZNAME_MISSING
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|timeptr
operator|->
name|tm_zone
argument_list|)
expr_stmt|;
else|#
directive|else
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|tzname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
ifdef|#
directive|ifdef
name|SYSV_EXT
case|case
literal|'n'
case|:
comment|/* same as \n */
name|tbuf
index|[
literal|0
index|]
operator|=
literal|'\n'
expr_stmt|;
name|tbuf
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
comment|/* same as \t */
name|tbuf
index|[
literal|0
index|]
operator|=
literal|'\t'
expr_stmt|;
name|tbuf
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* date as %m/%d/%y */
name|strftime
argument_list|(
name|tbuf
argument_list|,
sizeof|sizeof
name|tbuf
argument_list|,
literal|"%m/%d/%y"
argument_list|,
name|timeptr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
comment|/* day of month, blank padded */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%2d"
argument_list|,
name|range
argument_list|(
literal|1
argument_list|,
name|timeptr
operator|->
name|tm_mday
argument_list|,
literal|31
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
comment|/* time as %I:%M:%S %p */
name|strftime
argument_list|(
name|tbuf
argument_list|,
sizeof|sizeof
name|tbuf
argument_list|,
literal|"%I:%M:%S %p"
argument_list|,
name|timeptr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
comment|/* time as %H:%M */
name|strftime
argument_list|(
name|tbuf
argument_list|,
sizeof|sizeof
name|tbuf
argument_list|,
literal|"%H:%M"
argument_list|,
name|timeptr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
comment|/* time as %H:%M:%S */
name|strftime
argument_list|(
name|tbuf
argument_list|,
sizeof|sizeof
name|tbuf
argument_list|,
literal|"%H:%M:%S"
argument_list|,
name|timeptr
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SUNOS_EXT
case|case
literal|'k'
case|:
comment|/* hour, 24-hour clock, blank pad */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%2d"
argument_list|,
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_hour
argument_list|,
literal|23
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
comment|/* hour, 12-hour clock, 1 - 12, blank pad */
name|i
operator|=
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_hour
argument_list|,
literal|23
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|i
operator|=
literal|12
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|>
literal|12
condition|)
name|i
operator|-=
literal|12
expr_stmt|;
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%2d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|VMS_EXT
case|case
literal|'v'
case|:
comment|/* date as dd-bbb-YYYY */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%2d-%3.3s-%4d"
argument_list|,
name|range
argument_list|(
literal|1
argument_list|,
name|timeptr
operator|->
name|tm_mday
argument_list|,
literal|31
argument_list|)
argument_list|,
name|months_a
index|[
name|range
argument_list|(
literal|0
argument_list|,
name|timeptr
operator|->
name|tm_mon
argument_list|,
literal|11
argument_list|)
index|]
argument_list|,
name|timeptr
operator|->
name|tm_year
operator|+
literal|1900
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|islower
argument_list|(
name|tbuf
index|[
name|i
index|]
argument_list|)
condition|)
name|tbuf
index|[
name|i
index|]
operator|=
name|toupper
argument_list|(
name|tbuf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|POSIX2_DATE
case|case
literal|'C'
case|:
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%02d"
argument_list|,
operator|(
name|timeptr
operator|->
name|tm_year
operator|+
literal|1900
operator|)
operator|/
literal|100
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
case|case
literal|'O'
case|:
comment|/* POSIX locale extensions, ignored for now */
goto|goto
name|again
goto|;
case|case
literal|'V'
case|:
comment|/* week of year according ISO 8601 */
if|#
directive|if
name|defined
argument_list|(
name|GAWK
argument_list|)
operator|&&
name|defined
argument_list|(
name|VMS_EXT
argument_list|)
block|{
specifier|extern
name|int
name|do_lint
decl_stmt|;
specifier|extern
name|void
name|warning
parameter_list|()
function_decl|;
specifier|static
name|int
name|warned
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|warned
operator|&&
name|do_lint
condition|)
block|{
name|warned
operator|=
literal|1
expr_stmt|;
name|warning
argument_list|(
literal|"conversion %%V added in P1003.2/11.3; for VMS style date, use %%v"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%d"
argument_list|,
name|iso8601wknum
argument_list|(
name|timeptr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
comment|/* ISO 8601: Weekday as a decimal number [1 (Monday) - 7] */
name|sprintf
argument_list|(
name|tbuf
argument_list|,
literal|"%d"
argument_list|,
name|timeptr
operator|->
name|tm_wday
operator|==
literal|0
condition|?
literal|7
else|:
name|timeptr
operator|->
name|tm_wday
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* POSIX2_DATE */
default|default:
name|tbuf
index|[
literal|0
index|]
operator|=
literal|'%'
expr_stmt|;
name|tbuf
index|[
literal|1
index|]
operator|=
operator|*
name|format
expr_stmt|;
name|tbuf
index|[
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|i
operator|=
name|strlen
argument_list|(
name|tbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
if|if
condition|(
name|s
operator|+
name|i
operator|<
name|endp
operator|-
literal|1
condition|)
block|{
name|strcpy
argument_list|(
name|s
argument_list|,
name|tbuf
argument_list|)
expr_stmt|;
name|s
operator|+=
name|i
expr_stmt|;
block|}
else|else
return|return
literal|0
return|;
block|}
name|out
label|:
if|if
condition|(
name|s
operator|<
name|endp
operator|&&
operator|*
name|format
operator|==
literal|'\0'
condition|)
block|{
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|s
operator|-
name|start
operator|)
return|;
block|}
else|else
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|POSIX2_DATE
end_ifdef

begin_comment
comment|/* iso8601wknum --- compute week number according to ISO 8601 */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__STDC__
end_ifndef

begin_decl_stmt
specifier|static
name|int
name|iso8601wknum
argument_list|(
name|timeptr
argument_list|)
decl|const struct
name|tm
modifier|*
name|timeptr
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_function
specifier|static
name|int
name|iso8601wknum
parameter_list|(
specifier|const
name|struct
name|tm
modifier|*
name|timeptr
parameter_list|)
endif|#
directive|endif
block|{
comment|/* 	 * From 1003.2 D11.3: 	 *	If the week (Monday to Sunday) containing January 1 	 *	has four or more days in the new year, then it is week 1; 	 *	otherwise it is week 53 of the previous year, and the 	 *	next week is week 1. 	 * 	 * ADR: This means if Jan 1 was Monday through Thursday, 	 *	it was week 1, otherwise week 53. 	 */
name|int
name|simple_wknum
decl_stmt|,
name|jan1day
decl_stmt|,
name|diff
decl_stmt|,
name|ret
decl_stmt|;
comment|/* get week number, Monday as first day of the week */
name|simple_wknum
operator|=
name|weeknumber
argument_list|(
name|timeptr
argument_list|,
literal|1
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* 	 * With thanks and tip of the hatlo to tml@tik.vtt.fi 	 * 	 * What day of the week does January 1 fall on? 	 * We know that 	 *	(timeptr->tm_yday - jan1.tm_yday) MOD 7 == 	 *		(timeptr->tm_wday - jan1.tm_wday) MOD 7 	 * and that 	 * 	jan1.tm_yday == 0 	 * and that 	 * 	timeptr->tm_wday MOD 7 == timeptr->tm_wday 	 * from which it follows that. . .  	 */
name|jan1day
operator|=
name|timeptr
operator|->
name|tm_wday
operator|-
operator|(
name|timeptr
operator|->
name|tm_yday
operator|%
literal|7
operator|)
expr_stmt|;
if|if
condition|(
name|jan1day
operator|<
literal|0
condition|)
name|jan1day
operator|+=
literal|7
expr_stmt|;
comment|/* 	 * If Jan 1 was a Monday through Thursday, it was in 	 * week 1.  Otherwise it was last year's week 53, which is 	 * this year's week 0. 	 */
if|if
condition|(
name|jan1day
operator|>=
literal|1
operator|&&
name|jan1day
operator|<=
literal|4
condition|)
name|diff
operator|=
literal|0
expr_stmt|;
else|else
name|diff
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|simple_wknum
operator|-
name|diff
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
comment|/* we're in the first week of the year */
name|ret
operator|=
literal|53
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* weeknumber --- figure how many weeks into the year */
end_comment

begin_comment
comment|/* With thanks and tip of the hatlo to ado@elsie.nci.nih.gov */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__STDC__
end_ifndef

begin_decl_stmt
specifier|static
name|int
name|weeknumber
argument_list|(
name|timeptr
argument_list|,
name|firstweekday
argument_list|)
decl|const struct
name|tm
modifier|*
name|timeptr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|firstweekday
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_function
specifier|static
name|int
name|weeknumber
parameter_list|(
specifier|const
name|struct
name|tm
modifier|*
name|timeptr
parameter_list|,
name|int
name|firstweekday
parameter_list|)
endif|#
directive|endif
block|{
if|if
condition|(
name|firstweekday
operator|==
literal|0
condition|)
return|return
operator|(
name|timeptr
operator|->
name|tm_yday
operator|+
literal|7
operator|-
name|timeptr
operator|->
name|tm_wday
operator|)
operator|/
literal|7
return|;
else|else
return|return
operator|(
name|timeptr
operator|->
name|tm_yday
operator|+
literal|7
operator|-
operator|(
name|timeptr
operator|->
name|tm_wday
condition|?
operator|(
name|timeptr
operator|->
name|tm_wday
operator|-
literal|1
operator|)
else|:
literal|6
operator|)
operator|)
operator|/
literal|7
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* ADR --- I'm loathe to mess with ado's code ... */
end_comment

begin_comment
unit|Date:         Wed, 24 Apr 91 20:54:08 MDT From: Michal Jaegermann<audfax!emory!vm.ucs.UAlberta.CA!NTOMCZAK> To: arnold@audiofax.com  Hi Arnold, in a process of fixing of strftime() in libraries on Atari ST I grabbed some pieces of code from your own strftime.  When doing that it came to mind that your weeknumber() function compiles a little bit nicer in the following form:
comment|/*  * firstweekday is 0 if starting in Sunday, non-zero if in Monday  */
end_comment

begin_endif
unit|{     return (timeptr->tm_yday - timeptr->tm_wday + 	    (firstweekday ? (timeptr->tm_wday ? 8 : 1) : 7)) / 7; } How nicer it depends on a compiler, of course, but always a tiny bit.     Cheers,    Michal    ntomczak@vm.ucs.ualberta.ca
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TEST_STRFTIME
end_ifdef

begin_comment
comment|/*  * NAME:  *	tst  *  * SYNOPSIS:  *	tst  *  * DESCRIPTION:  *	"tst" is a test driver for the function "strftime".  *  * OPTIONS:  *	None.  *  * AUTHOR:  *	Karl Vogel  *	Control Data Systems, Inc.  *	vogelke@c-17igp.wpafb.af.mil  *  * BUGS:  *	None noticed yet.  *  * COMPILE:  *	cc -o tst -DTEST_STRFTIME strftime.c  */
end_comment

begin_comment
comment|/* ADR: I reformatted this to my liking, and deleted some unneeded code. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|NULL
end_ifndef

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_define
define|#
directive|define
name|MAXTIME
value|132
end_define

begin_comment
comment|/*  * Array of time formats.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|array
index|[]
init|=
block|{
literal|"(%%A)      full weekday name, var length (Sunday..Saturday)  %A"
block|,
literal|"(%%B)       full month name, var length (January..December)  %B"
block|,
literal|"(%%C)                                               Century  %C"
block|,
literal|"(%%D)                                       date (%%m/%%d/%%y)  %D"
block|,
literal|"(%%E)                           Locale extensions (ignored)  %E"
block|,
literal|"(%%H)                          hour (24-hour clock, 00..23)  %H"
block|,
literal|"(%%I)                          hour (12-hour clock, 01..12)  %I"
block|,
literal|"(%%M)                                       minute (00..59)  %M"
block|,
literal|"(%%O)                           Locale extensions (ignored)  %O"
block|,
literal|"(%%R)                                 time, 24-hour (%%H:%%M)  %R"
block|,
literal|"(%%S)                                       second (00..61)  %S"
block|,
literal|"(%%T)                              time, 24-hour (%%H:%%M:%%S)  %T"
block|,
literal|"(%%U)    week of year, Sunday as first day of week (00..53)  %U"
block|,
literal|"(%%V)                    week of year according to ISO 8601  %V"
block|,
literal|"(%%W)    week of year, Monday as first day of week (00..53)  %W"
block|,
literal|"(%%X)     appropriate locale time representation (%H:%M:%S)  %X"
block|,
literal|"(%%Y)                           year with century (1970...)  %Y"
block|,
literal|"(%%Z) timezone (EDT), or blank if timezone not determinable  %Z"
block|,
literal|"(%%a)          locale's abbreviated weekday name (Sun..Sat)  %a"
block|,
literal|"(%%b)            locale's abbreviated month name (Jan..Dec)  %b"
block|,
literal|"(%%c)           full date (Sat Nov  4 12:02:33 1989)%n%t%t%t  %c"
block|,
literal|"(%%d)                             day of the month (01..31)  %d"
block|,
literal|"(%%e)               day of the month, blank-padded ( 1..31)  %e"
block|,
literal|"(%%h)                                should be same as (%%b)  %h"
block|,
literal|"(%%j)                            day of the year (001..366)  %j"
block|,
literal|"(%%k)               hour, 24-hour clock, blank pad ( 0..23)  %k"
block|,
literal|"(%%l)               hour, 12-hour clock, blank pad ( 0..12)  %l"
block|,
literal|"(%%m)                                        month (01..12)  %m"
block|,
literal|"(%%p)              locale's AM or PM based on 12-hour clock  %p"
block|,
literal|"(%%r)                   time, 12-hour (same as %%I:%%M:%%S %%p)  %r"
block|,
literal|"(%%u) ISO 8601: Weekday as decimal number [1 (Monday) - 7]   %u"
block|,
literal|"(%%v)                                VAX date (dd-bbb-YYYY)  %v"
block|,
literal|"(%%w)                       day of week (0..6, Sunday == 0)  %w"
block|,
literal|"(%%x)                appropriate locale date representation  %x"
block|,
literal|"(%%y)                      last two digits of year (00..99)  %y"
block|,
operator|(
name|char
operator|*
operator|)
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Main routine. */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|long
name|time
parameter_list|()
function_decl|;
name|char
modifier|*
name|next
decl_stmt|;
name|char
name|string
index|[
name|MAXTIME
index|]
decl_stmt|;
name|int
name|k
decl_stmt|;
name|int
name|length
decl_stmt|;
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
name|long
name|clock
decl_stmt|;
comment|/* Call the function. */
name|clock
operator|=
name|time
argument_list|(
operator|(
name|long
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|tm
operator|=
name|localtime
argument_list|(
operator|&
name|clock
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|next
operator|=
name|array
index|[
name|k
index|]
condition|;
name|k
operator|++
control|)
block|{
name|length
operator|=
name|strftime
argument_list|(
name|string
argument_list|,
name|MAXTIME
argument_list|,
name|next
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|string
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TEST_STRFTIME */
end_comment

end_unit


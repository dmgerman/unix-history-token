begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: filingd.c,v 1.6 87/05/14 11:33:26 ed Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_comment
comment|/*  * Copyright (c) 1986, 1987 Xerox Corporation.  */
end_comment

begin_comment
comment|/* $Log:	filingd.c,v $  * Revision 1.6  87/05/14  11:33:26  ed  * Open: don't set cur_dir_handle unless directory is opened.  *   * Revision 1.5  87/05/05  14:46:31  ed  * Don't close connection in continuance_expiration if BDT in progress.  *   * Revision 1.4  87/04/16  15:30:29  ed  * Fixed lingering Subset bugs.  *   * Revision 1.3  87/03/31  14:22:53  ed  * Initialize got_matches in get_filter.  *   * Revision 1.2  87/03/31  09:05:15  ed  * New procedures: Create, ChangeAttributes(name only), Copy, Move,  * 		Replace, Serialize, Deserialize.  * Added conditional disabling of root logins.  * Support for GetAttributes (allAttributeTypes).  * Support for filter of type all.  *   * Revision 1.1  87/01/14  11:25:59  ed  * Initial revision  *   */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netns/ns.h>
end_include

begin_include
include|#
directive|include
file|<netns/sp.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FILING4
end_ifdef

begin_include
include|#
directive|include
file|"filingV4.h"
end_include

begin_include
include|#
directive|include
file|"clearinghouseV2.h"
end_include

begin_include
include|#
directive|include
file|"authenticationV2.h"
end_include

begin_endif
endif|#
directive|endif
endif|FILING4
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FILING5
end_ifdef

begin_include
include|#
directive|include
file|"filingV5.h"
end_include

begin_include
include|#
directive|include
file|"clearinghouseV2.h"
end_include

begin_include
include|#
directive|include
file|"authenticationV2.h"
end_include

begin_endif
endif|#
directive|endif
endif|FILING5
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FILING6
end_ifdef

begin_include
include|#
directive|include
file|"filingV6.h"
end_include

begin_include
include|#
directive|include
file|"clearinghouseV3.h"
end_include

begin_include
include|#
directive|include
file|"authenticationV3.h"
end_include

begin_endif
endif|#
directive|endif
endif|FILING6
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FILINGSUBSET1
end_ifdef

begin_include
include|#
directive|include
file|"filingsubsetV1.h"
end_include

begin_include
include|#
directive|include
file|"clearinghouseV3.h"
end_include

begin_include
include|#
directive|include
file|"authenticationV3.h"
end_include

begin_endif
endif|#
directive|endif
endif|FILINGSUBSET1
end_endif

begin_include
include|#
directive|include
file|<xnscourier/filing_server.h>
end_include

begin_include
include|#
directive|include
file|<xnscourier/CH.h>
end_include

begin_include
include|#
directive|include
file|<xnscourier/filetypes.h>
end_include

begin_define
define|#
directive|define
name|SERVICE_ROOT
value|"/"
end_define

begin_comment
comment|/* root directory for service */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_decl_stmt
name|FILE
modifier|*
name|msgs
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|DEBUG
end_endif

begin_decl_stmt
name|session_handle
name|SessionHandle
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
name|RootHandle
init|=
block|{
name|FILE_OPEN
block|,
name|SERVICE_ROOT
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|TRUE
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|CourierConnection
modifier|*
name|_serverConnection
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current connection */
end_comment

begin_comment
comment|/* 	 * The continuance value is slightly lower than the 90 second 	 * value in lookahead.c. This should insure that the client will 	 * send a Continue before this service stops looking for the next 	 * procedure call. 	 */
end_comment

begin_decl_stmt
name|Cardinal
name|continuance
init|=
literal|80
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* continuance value in seconds */
end_comment

begin_decl_stmt
name|Boolean
name|BDTabort_expected
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* should BDT attn be sent */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
end_ifdef

begin_decl_stmt
name|file_handle
modifier|*
name|cur_dir_handle
init|=
operator|&
name|RootHandle
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
end_endif

begin_escape
end_escape

begin_decl_stmt
name|FILING_LogonResults
name|FILING_Logon
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|service_name
argument_list|,
name|user_credentials
argument_list|,
name|user_verifier
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|CLEARINGHOUSE_ObjectName
name|service_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Credentials
name|user_credentials
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Verifier
name|user_verifier
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|FILING_LogonResults
name|result
decl_stmt|;
name|AUTHENTICATION_ThreePartName
name|chs_name
decl_stmt|;
name|session_handle
modifier|*
name|session_ptr
decl_stmt|;
name|Unspecified
modifier|*
name|bp
decl_stmt|,
name|buffer
index|[
name|SPPMAXDATA
index|]
decl_stmt|;
name|char
name|user
index|[
literal|40
index|]
decl_stmt|;
name|char
name|pass
index|[
literal|40
index|]
decl_stmt|;
name|Cardinal
name|credentials_type
decl_stmt|;
name|Cardinal
name|len
decl_stmt|;
name|char
modifier|*
name|lowercase
parameter_list|()
function_decl|;
if|#
directive|if
name|FILING4
operator||
name|FILING5
name|char
modifier|*
name|rindex
parameter_list|()
function_decl|;
name|char
modifier|*
name|ptr
decl_stmt|;
endif|#
directive|endif
endif|FILING4 | FILING5
name|BDTabort_expected
operator|=
name|FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Logon\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|#
directive|if
name|FILING4
operator||
name|FILING5
if|if
condition|(
name|user_credentials
operator|.
name|type
operator|!=
name|AUTHENTICATION_simpleCredentials
condition|)
block|{
name|ReturnAuthenticationError
argument_list|(
name|AUTHENTICATION_inappropriateCredentials
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
else|else
block|{
name|CLEARINGHOUSE_externalize_Item
argument_list|(
operator|&
name|user_credentials
operator|.
name|value
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|bp
operator|=
name|buffer
expr_stmt|;
name|bp
operator|+=
name|internalize_Cardinal
argument_list|(
operator|&
name|len
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|AUTHENTICATION_internalize_SimpleCredentials
argument_list|(
operator|&
name|chs_name
argument_list|,
name|bp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"chs_name= %s:%s:%s\n"
argument_list|,
name|chs_name
operator|.
name|object
argument_list|,
name|chs_name
operator|.
name|domain
argument_list|,
name|chs_name
operator|.
name|organization
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
block|}
ifdef|#
directive|ifdef
name|ROOTNOTALLOWED
comment|/* 	 * We don't allow root access from the file server 	 */
if|if
condition|(
name|strcmp
argument_list|(
name|lowercase
argument_list|(
name|chs_name
operator|.
name|object
argument_list|)
argument_list|,
literal|"root"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ReturnAuthenticationError
argument_list|(
name|AUTHENTICATION_credentialsInvalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|ROOTNOTALLOWED
comment|/* 	 * Assumption (for Filing4/Filing5 implementation): 	 * may receive fully specified Clearinghouse name, so we should try 	 * to strip off last name (look for last space) assuming there is a 	 * similary named account on this service. If the user credentials 	 * pass network authentiction, then we will not check passwords on 	 * this service (in fact, we can't since the verifier is hashed). 	 * It is assumed that the name will be found in /etc/passwd and  	 * everything will work regardless of password checking. 	 */
if|if
condition|(
operator|(
name|ptr
operator|=
name|rindex
argument_list|(
name|chs_name
operator|.
name|object
argument_list|,
literal|' '
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|user
argument_list|,
name|chs_name
operator|.
name|object
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ptr
operator|++
expr_stmt|;
name|strcpy
argument_list|(
name|user
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|Auth_CredCheck
argument_list|(
name|user_credentials
argument_list|,
name|user_verifier
argument_list|)
condition|)
block|{
name|ReturnAuthenticationError
argument_list|(
name|AUTHENTICATION_credentialsInvalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
else|#
directive|else
else|FILING4 | FILING5
comment|/* 	 * assumption (for FILING6 and FILINGSUBSET1): 	 * no primary credentials are ok 	 * simple primary credentials will be validated with Authentication 	 * strong credentials will be ignored 	 * 	 * secondary credentials must contain userName and userPassword 	 * which are assumed to be Unix name and password 	 */
if|if
condition|(
name|user_credentials
operator|.
name|primary
operator|.
name|type
operator|==
name|AUTHENTICATION_simpleCredentials
condition|)
block|{
if|if
condition|(
operator|!
name|Auth_CredCheck
argument_list|(
name|user_credentials
operator|.
name|primary
argument_list|,
name|user_verifier
argument_list|)
condition|)
block|{
name|ReturnAuthenticationError
argument_list|(
name|FILING_primaryCredentialsInvalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
block|}
if|if
condition|(
name|get_name_and_pwd
argument_list|(
operator|&
name|user_credentials
operator|.
name|secondary
argument_list|,
name|user
argument_list|,
name|pass
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|ReturnAuthenticationError
argument_list|(
name|FILING_secondaryCredentialsRequired
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|ROOTNOTALLOWED
comment|/* 	 * We don't allow root access from the file server 	 */
if|if
condition|(
name|strcmp
argument_list|(
name|lowercase
argument_list|(
name|user
argument_list|)
argument_list|,
literal|"root"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ReturnAuthenticationError
argument_list|(
name|AUTHENTICATION_credentialsInvalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|ROOTNOTALLOWED
endif|#
directive|endif
endif|FILING4 | FILING5
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"user= %s\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|verifyandposition_user
argument_list|(
name|user
argument_list|,
name|pass
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|session_ptr
operator|=
operator|&
name|SessionHandle
expr_stmt|;
name|SessionHandle
operator|.
name|state
operator|=
name|SESSION_OPEN
expr_stmt|;
name|SessionHandle
operator|.
name|verifier
operator|=
name|user_verifier
operator|.
name|sequence
index|[
literal|0
index|]
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
comment|/*	fprintf(msgs,"handle= %x, ver= %x\n",session_ptr,session_ptr->verifier); */
endif|#
directive|endif
endif|DEBUG
name|copyhandle
argument_list|(
name|result
operator|.
name|session
operator|.
name|token
argument_list|,
operator|&
name|session_ptr
argument_list|)
expr_stmt|;
name|result
operator|.
name|session
operator|.
name|verifier
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|AUTHENTICATION_SimpleVerifier
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|Cardinal
argument_list|)
expr_stmt|;
name|result
operator|.
name|session
operator|.
name|verifier
operator|.
name|sequence
operator|=
name|Allocate
argument_list|(
sizeof|sizeof
argument_list|(
name|AUTHENTICATION_SimpleVerifier
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|.
name|session
operator|.
name|verifier
operator|.
name|sequence
index|[
literal|0
index|]
operator|=
name|user_verifier
operator|.
name|sequence
index|[
literal|0
index|]
expr_stmt|;
name|set_continuance_timer
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"out of logon\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
return|return
operator|(
name|result
operator|)
return|;
block|}
end_block

begin_macro
name|copyhandle
argument_list|(
argument|dest
argument_list|,
argument|src
argument_list|)
end_macro

begin_decl_stmt
name|Unspecified
modifier|*
name|dest
decl_stmt|,
modifier|*
name|src
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|dest
operator|==
operator|(
name|Unspecified
operator|*
operator|)
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Oops, dest is null in copyhandle\n"
argument_list|)
expr_stmt|;
else|#
directive|else
else|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Oops, dest is null in copyhandle\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|dest
index|[
literal|0
index|]
operator|=
name|src
index|[
literal|0
index|]
expr_stmt|;
name|dest
index|[
literal|1
index|]
operator|=
name|src
index|[
literal|1
index|]
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_Logoff
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|session_handle
modifier|*
name|session_ptr
decl_stmt|;
name|BDTabort_expected
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|session_ptr
argument_list|,
name|session
operator|.
name|token
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SOMEDAY
if|if
condition|(
name|session_ptr
operator|->
name|state
operator|==
name|SESSION_IN_USE
condition|)
block|{
name|ReturnServiceError
argument_list|(
name|FILING_sessionInUse
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|SOMEDAY
name|session_ptr
operator|->
name|state
operator|=
name|SESSION_CLOSED
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|FILING_OpenResults
name|FILING_Open
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|attributes
argument_list|,
name|directory
argument_list|,
name|controls
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_AttributeSequence
name|attributes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Handle
name|directory
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ControlSequence
name|controls
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|FILING_OpenResults
name|results
decl_stmt|;
name|file_handle
modifier|*
name|handle
decl_stmt|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|file_handle
modifier|*
name|dir_handle
decl_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
name|BDTabort_expected
operator|=
name|FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Open\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|msgs
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifndef|#
directive|ifndef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|is_nullControls
argument_list|(
name|controls
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|ReturnControlTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|is_nullHandle
argument_list|(
name|directory
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|(
name|handle
operator|=
operator|(
name|file_handle
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|file_handle
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ReturnUndefinedError
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Open-- file handle= %x\n"
argument_list|,
name|handle
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|msgs
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|handle
operator|->
name|pathname
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|MAX_FILE_NAME_LENGTH
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ReturnUndefinedError
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|copyhandle
argument_list|(
operator|&
name|dir_handle
argument_list|,
name|directory
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir_handle
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|dir_handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|dir_handle
operator|->
name|isdirectory
operator|!=
name|TRUE
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_directoryRequired
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|dir_handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|dir_handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|SERVICE_ROOT
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|SERVICE_ROOT
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
name|verify_open_attributes
argument_list|(
name|attributes
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|stat_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|handle
operator|->
name|state
operator|=
name|FILE_OPEN
expr_stmt|;
name|handle
operator|->
name|file_desc
operator|=
name|NULL
expr_stmt|;
name|handle
operator|->
name|createdon
operator|=
name|handle
operator|->
name|modifiedon
operator|=
literal|0
expr_stmt|;
name|copyhandle
argument_list|(
name|results
operator|.
name|file
argument_list|,
operator|&
name|handle
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|handle
operator|->
name|isdirectory
operator|==
name|TRUE
condition|)
name|cur_dir_handle
operator|=
name|handle
expr_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return
operator|(
name|results
operator|)
return|;
block|}
end_block

begin_macro
name|verify_session
argument_list|(
argument|session
argument_list|)
end_macro

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|session_handle
modifier|*
name|session_ptr
decl_stmt|;
name|copyhandle
argument_list|(
operator|&
name|session_ptr
argument_list|,
name|session
operator|.
name|token
argument_list|)
expr_stmt|;
if|if
condition|(
name|session_ptr
operator|==
literal|0
operator|||
operator|(
name|session_ptr
operator|->
name|state
operator|!=
name|SESSION_OPEN
operator|)
condition|)
block|{
name|ReturnSessionError
argument_list|(
name|FILING_tokenInvalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|session_ptr
operator|->
name|verifier
operator|!=
operator|*
operator|(
name|session
operator|.
name|verifier
operator|.
name|sequence
operator|)
condition|)
block|{
name|ReturnAuthenticationError
argument_list|(
name|AUTHENTICATION_verifierInvalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|is_nullControls
argument_list|(
argument|controls
argument_list|)
end_macro

begin_decl_stmt
name|FILING_ControlSequence
name|controls
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|controls
operator|.
name|length
operator|!=
literal|0
operator|&&
name|controls
operator|.
name|sequence
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|is_nullHandle
argument_list|(
argument|handle
argument_list|)
end_macro

begin_decl_stmt
name|FILING_Handle
name|handle
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|handle
index|[
literal|0
index|]
operator|!=
literal|0
operator|&&
name|handle
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|verify_open_attributes
argument_list|(
argument|attr
argument_list|,
argument|handle
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeSequence
name|attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
modifier|*
name|handle
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|FILING_AttributeType
name|t
decl_stmt|;
name|int
name|got_parentID
decl_stmt|,
name|got_pathname
decl_stmt|,
name|got_type
decl_stmt|,
name|got_version
decl_stmt|;
name|char
modifier|*
name|pathname
decl_stmt|;
name|Unspecified
modifier|*
name|parentid
decl_stmt|;
name|FILING_Version
name|version
decl_stmt|;
name|char
modifier|*
name|AttrToString
parameter_list|()
function_decl|;
name|Unspecified
modifier|*
name|AttrToFileID
parameter_list|()
function_decl|;
name|LongCardinal
name|AttrToLongCardinal
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|int
name|got_name
decl_stmt|,
name|got_fileID
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|Unspecified
modifier|*
name|fileid
decl_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"verify_open_attribute %d attributes	"
argument_list|,
name|attr
operator|.
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|got_parentID
operator|=
name|got_pathname
operator|=
name|got_type
operator|=
name|got_version
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|got_name
operator|=
name|got_fileID
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|attr
operator|.
name|length
operator|==
literal|0
condition|)
block|{
return|return;
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
name|attr
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|FILING_parentID
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"parentID  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_parentID
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_parentID
operator|++
expr_stmt|;
name|parentid
operator|=
name|AttrToFileID
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_nullID
argument_list|(
name|parentid
argument_list|)
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_pathname
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"pathname  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_pathname
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_pathname
operator|++
expr_stmt|;
name|pathname
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_pathname
argument_list|(
name|pathname
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_type
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"type  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_type
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_type
operator|++
expr_stmt|;
name|handle
operator|->
name|type
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|EXTENSIONS
if|if
condition|(
operator|(
name|handle
operator|->
name|type
operator|!=
name|FILING_tText
operator|)
operator|&&
operator|(
name|handle
operator|->
name|type
operator|!=
name|FILING_tUnspecified
operator|)
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|EXTENSIONS
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_version
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"version  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_version
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_version
operator|++
expr_stmt|;
name|version
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
name|FILING_highestVersion
operator|&&
name|version
operator|!=
name|FILING_lowestVersion
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|t
operator|==
name|FILING_name
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"name  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_name
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_name
operator|++
expr_stmt|;
name|name
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_fileID
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"fileID  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_fileID
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_fileID
operator|++
expr_stmt|;
name|fileid
operator|=
name|AttrToFileID
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_nullID
argument_list|(
name|fileid
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|cur_dir_handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_name_from_fileID
argument_list|(
name|handle
argument_list|,
name|fileid
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
if|if
condition|(
name|t
operator|==
name|FILING_fileID
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|t
operator|==
name|FILING_name
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|(
name|t
operator|<
literal|0
operator|)
operator|||
operator|(
name|t
operator|>
name|FILING_subtreeSizeLimit
operator|)
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_pathname
operator|&&
operator|!
name|got_name
condition|)
block|{
if|if
condition|(
operator|!
name|got_fileID
condition|)
block|{
name|handle
operator|->
name|pathname
operator|=
name|SERVICE_ROOT
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|got_pathname
condition|)
block|{
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|pathname
operator|==
literal|'/'
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
argument_list|)
expr_stmt|;
name|Deallocate
argument_list|(
operator|&
name|pathname
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_pathname
condition|)
block|{
name|handle
operator|->
name|pathname
operator|=
name|SERVICE_ROOT
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|pathname
operator|==
literal|'/'
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
argument_list|)
expr_stmt|;
name|Deallocate
argument_list|(
operator|&
name|pathname
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_type
condition|)
name|handle
operator|->
name|type
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|is_nullID
argument_list|(
argument|fileid
argument_list|)
end_macro

begin_decl_stmt
name|Unspecified
modifier|*
name|fileid
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fileid
index|[
name|i
index|]
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_Close
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|file_handle
modifier|*
name|handle
decl_stmt|;
name|BDTabort_expected
operator|=
name|FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Close\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|is_nullHandle
argument_list|(
name|file
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_nullDisallowed
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|handle
argument_list|,
name|file
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"closing %x\n"
argument_list|,
name|handle
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
comment|/* do it now */
if|if
condition|(
name|handle
operator|->
name|createdon
operator|!=
literal|0
condition|)
comment|/* set date if needed */
name|set_create_time
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|handle
operator|->
name|state
operator|=
name|FILE_CLOSED
expr_stmt|;
name|handle
operator|->
name|pathname
operator|=
operator|(
name|char
operator|*
operator|)
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|handle
operator|==
name|cur_dir_handle
condition|)
name|cur_dir_handle
operator|=
operator|&
name|RootHandle
expr_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
name|free
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|FILING_CreateResults
name|FILING_Create
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|directory
argument_list|,
name|attributes
argument_list|,
name|controls
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|directory
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeSequence
name|attributes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ControlSequence
name|controls
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|EXTENSIONS
name|FILING_CreateResults
name|results
decl_stmt|;
name|file_handle
modifier|*
name|handle
decl_stmt|,
modifier|*
name|dir_handle
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Create  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|BDTabort_expected
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifndef|#
directive|ifndef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|is_nullControls
argument_list|(
name|controls
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|ReturnControlTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|(
name|handle
operator|=
operator|(
name|file_handle
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|file_handle
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ReturnUndefinedError
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|handle
operator|->
name|pathname
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|MAX_FILE_NAME_LENGTH
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ReturnUndefinedError
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"create handle= %x\n"
argument_list|,
name|handle
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|copyhandle
argument_list|(
operator|&
name|dir_handle
argument_list|,
name|directory
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir_handle
operator|==
literal|0
condition|)
block|{
name|dir_handle
operator|=
operator|&
name|RootHandle
expr_stmt|;
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|SERVICE_ROOT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dir_handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|dir_handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|dir_handle
operator|->
name|isdirectory
operator|!=
name|TRUE
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_directoryRequired
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|dir_handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|SERVICE_ROOT
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
name|verify_create_attributes
argument_list|(
name|attributes
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"creating '%s'\n"
argument_list|,
name|handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|handle
operator|->
name|isdirectory
operator|==
name|TRUE
condition|)
block|{
if|if
condition|(
name|create_directory
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
block|}
else|else
block|{
if|if
condition|(
name|create_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|handle
operator|->
name|state
operator|=
name|FILE_OPEN
expr_stmt|;
name|handle
operator|->
name|file_desc
operator|=
name|NULL
expr_stmt|;
name|copyhandle
argument_list|(
name|results
operator|.
name|file
argument_list|,
operator|&
name|handle
argument_list|)
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return
operator|(
name|results
operator|)
return|;
else|#
directive|else
else|EXTENSIONS
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|EXTENSIONS
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|EXTENSIONS
end_ifdef

begin_macro
name|verify_create_attributes
argument_list|(
argument|attr
argument_list|,
argument|handle
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeSequence
name|attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
modifier|*
name|handle
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|FILING_AttributeType
name|t
decl_stmt|;
name|int
name|got_accesslist
decl_stmt|,
name|got_childrenuniquelynamed
decl_stmt|,
name|got_createdon
decl_stmt|,
name|got_datasize
decl_stmt|;
name|int
name|got_defaultaccesslist
decl_stmt|,
name|got_isdirectory
decl_stmt|,
name|got_istemporary
decl_stmt|,
name|got_ordering
decl_stmt|;
name|int
name|got_pathname
decl_stmt|,
name|got_subtreesizelimit
decl_stmt|,
name|got_type
decl_stmt|,
name|got_version
decl_stmt|;
name|char
modifier|*
name|pathname
decl_stmt|;
name|FILING_Version
name|version
decl_stmt|;
name|Boolean
name|childrenuniquelynamed
decl_stmt|,
name|istemporary
decl_stmt|;
name|Cardinal
name|ordering
decl_stmt|;
name|Cardinal
name|subtreesizelimit
decl_stmt|;
name|char
modifier|*
name|AttrToString
parameter_list|()
function_decl|;
name|Unspecified
modifier|*
name|AttrToFileID
parameter_list|()
function_decl|;
name|LongCardinal
name|AttrToLongCardinal
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|int
name|got_name
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d create attributes	"
argument_list|,
name|attr
operator|.
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|attr
operator|.
name|length
operator|<=
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|=
name|got_childrenuniquelynamed
operator|=
name|got_createdon
operator|=
literal|0
expr_stmt|;
name|got_datasize
operator|=
name|got_defaultaccesslist
operator|=
name|got_isdirectory
operator|=
literal|0
expr_stmt|;
name|got_istemporary
operator|=
name|got_ordering
operator|=
name|got_pathname
operator|=
literal|0
expr_stmt|;
name|got_subtreesizelimit
operator|=
name|got_type
operator|=
name|got_version
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|got_name
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
name|attr
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d "
argument_list|,
name|t
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|t
operator|==
name|FILING_createdOn
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"createdOn  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_createdon
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_createdon
operator|++
expr_stmt|;
name|handle
operator|->
name|createdon
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_dataSize
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"dataSize  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_datasize
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_datasize
operator|++
expr_stmt|;
name|handle
operator|->
name|datasize
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_isDirectory
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"isDirectory  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_isdirectory
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_isdirectory
operator|++
expr_stmt|;
name|handle
operator|->
name|isdirectory
operator|=
name|AttrToBoolean
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_pathname
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"pathname  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_pathname
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_pathname
operator|++
expr_stmt|;
name|pathname
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_pathname
argument_list|(
name|pathname
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_type
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"type  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_type
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_type
operator|++
expr_stmt|;
name|handle
operator|->
name|type
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_version
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"version  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_version
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_version
operator|++
expr_stmt|;
name|version
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
name|FILING_highestVersion
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|t
operator|==
name|FILING_name
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"name  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_name
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_name
operator|++
expr_stmt|;
name|name
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
ifdef|#
directive|ifdef
name|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_accessList
condition|)
block|{
if|if
condition|(
name|got_accesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
endif|#
directive|endif
endif|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_childrenUniquelyNamed
condition|)
block|{
if|if
condition|(
name|got_childrenuniquelynamed
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_childrenuniquelynamed
operator|++
expr_stmt|;
name|childrenuniquelynamed
operator|=
name|AttrToBoolean
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|childrenuniquelynamed
operator|!=
name|TRUE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
ifdef|#
directive|ifdef
name|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_defaultAccessList
condition|)
block|{
if|if
condition|(
name|got_defaultaccesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_defaultaccesslist
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
endif|#
directive|endif
endif|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_isTemporary
condition|)
block|{
if|if
condition|(
name|got_istemporary
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_istemporary
operator|++
expr_stmt|;
name|istemporary
operator|=
name|AttrToBoolean
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|istemporary
operator|!=
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_ordering
condition|)
block|{
if|if
condition|(
name|got_ordering
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_ordering
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_subtreeSizeLimit
condition|)
block|{
if|if
condition|(
name|got_subtreesizelimit
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_subtreesizelimit
operator|++
expr_stmt|;
name|subtreesizelimit
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|subtreesizelimit
operator|!=
name|FILING_nullSubtreeSizeLimit
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
operator|(
name|t
operator|==
name|FILING_fileID
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_modifiedBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_modifiedOn
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_numberOfChildren
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_parentID
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_readBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_readOn
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_storedSize
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_subtreeSize
operator|)
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t
operator|<
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|handle
operator|->
name|type
operator|!=
name|TYPE_VP
condition|)
block|{
if|if
condition|(
operator|(
name|t
operator|==
name|FILING_checksum
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_createdBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_position
operator|)
condition|)
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
else|else
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_pathname
operator|&&
operator|!
name|got_name
condition|)
block|{
name|handle
operator|->
name|pathname
operator|=
name|SERVICE_ROOT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|got_pathname
condition|)
block|{
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|pathname
operator|==
literal|'/'
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
argument_list|)
expr_stmt|;
name|Deallocate
argument_list|(
operator|&
name|pathname
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_pathname
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_missing
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
else|else
block|{
if|if
condition|(
operator|*
name|pathname
operator|==
literal|'/'
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
argument_list|)
expr_stmt|;
name|Deallocate
argument_list|(
operator|&
name|pathname
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_type
condition|)
name|handle
operator|->
name|type
operator|=
name|FILING_tUnspecified
expr_stmt|;
if|if
condition|(
operator|!
name|got_createdon
condition|)
name|handle
operator|->
name|createdon
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|got_isdirectory
condition|)
block|{
if|if
condition|(
name|handle
operator|->
name|type
operator|==
name|FILING_tDirectory
condition|)
name|handle
operator|->
name|isdirectory
operator|=
name|TRUE
expr_stmt|;
else|else
name|handle
operator|->
name|isdirectory
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|(
name|handle
operator|->
name|isdirectory
operator|==
name|TRUE
operator|)
operator|&&
operator|(
name|handle
operator|->
name|type
operator|!=
name|FILING_tDirectory
operator|)
operator|)
operator|||
operator|(
operator|(
name|handle
operator|->
name|isdirectory
operator|==
name|FALSE
operator|)
operator|&&
operator|(
name|handle
operator|->
name|type
operator|==
name|FILING_tDirectory
operator|)
operator|)
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unreasonable
argument_list|,
name|FILING_isDirectory
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|EXTENSIONS
end_endif

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_Delete
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|file_handle
modifier|*
name|handle
decl_stmt|;
name|BDTabort_expected
operator|=
name|FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Delete\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|is_nullHandle
argument_list|(
name|file
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_nullDisallowed
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|handle
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
comment|/* do it now */
if|if
condition|(
name|delete_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|handle
operator|->
name|state
operator|=
name|FILE_CLOSED
expr_stmt|;
name|handle
operator|->
name|pathname
operator|=
operator|(
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|free
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|FILING_GetControlsResults
name|FILING_GetControls
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|types
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ControlTypeSequence
name|types
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_ChangeControls
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|controls
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ControlSequence
name|controls
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|7
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|FILING_GetAttributesResults
name|FILING_GetAttributes
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|types
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeTypeSequence
name|types
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|EXTENSIONS
name|file_handle
modifier|*
name|handle
decl_stmt|;
name|FILING_GetAttributesResults
name|results
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Getattributes\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|BDTabort_expected
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|is_nullHandle
argument_list|(
name|file
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_nullDisallowed
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|handle
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
comment|/* do it now */
if|if
condition|(
name|get_types
argument_list|(
name|types
argument_list|,
operator|&
name|results
operator|.
name|attributes
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|make_attribute_sequence
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
operator|&
name|results
operator|.
name|attributes
argument_list|)
expr_stmt|;
return|return
operator|(
name|results
operator|)
return|;
else|#
directive|else
else|EXTENSIONS
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|EXTENSIONS
block|}
end_block

begin_macro
name|get_types
argument_list|(
argument|types
argument_list|,
argument|attrseq
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeTypeSequence
name|types
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeSequence
modifier|*
name|attrseq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|LongCardinal
name|t
decl_stmt|;
if|if
condition|(
name|types
operator|.
name|length
operator|<=
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|EXTENSIONS
if|if
condition|(
operator|*
operator|(
name|types
operator|.
name|sequence
operator|)
operator|==
literal|037777777777
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"get_types: asking for all\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|attrseq
operator|->
name|length
operator|=
operator|-
literal|1
expr_stmt|;
name|attrseq
operator|->
name|sequence
operator|=
operator|(
name|FILING_Attribute
operator|*
operator|)
name|Allocate
argument_list|(
operator|(
name|SUPPORTEDATTRIBUTES
operator|+
name|OPTIONALATTRIBUTES
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|FILING_Attribute
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|Unspecified
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
endif|EXTENSIONS
name|attrseq
operator|->
name|length
operator|=
name|types
operator|.
name|length
expr_stmt|;
name|attrseq
operator|->
name|sequence
operator|=
operator|(
name|FILING_Attribute
operator|*
operator|)
name|Allocate
argument_list|(
name|types
operator|.
name|length
operator|*
sizeof|sizeof
argument_list|(
name|FILING_Attribute
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|Unspecified
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"get_types: asking for "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|types
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
name|types
operator|.
name|sequence
index|[
name|i
index|]
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d  "
argument_list|,
name|t
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|t
operator|<
literal|0
operator|)
operator|||
operator|(
name|t
operator|>
name|FILING_subtreeSizeLimit
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|t
operator|!=
literal|4938
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
block|}
if|if
condition|(
operator|(
name|t
operator|!=
name|FILING_createdOn
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_modifiedOn
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_isDirectory
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_isTemporary
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_name
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_pathname
operator|)
operator|&&
ifndef|#
directive|ifndef
name|FILETOOLCOMPATIBILITY
operator|(
name|t
operator|!=
name|FILING_dataSize
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_type
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_version
operator|)
condition|)
block|{
else|#
directive|else
else|FILETOOLCOMPATIBILITY
operator|(
name|t
operator|!=
name|FILING_dataSize
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_type
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_createdBy
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_readOn
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_version
operator|)
operator|&&
operator|(
name|t
operator|!=
name|FILING_fileID
operator|)
operator|&&
operator|(
name|t
operator|!=
literal|4938
operator|)
block|)
block|{
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|attrseq
operator|->
name|sequence
index|[
name|i
index|]
operator|.
name|type
operator|=
name|t
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|EXTENSIONS
block|}
endif|#
directive|endif
endif|EXTENSIONS
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|EXTENSIONS
end_ifdef

begin_macro
name|make_supported_attributes
argument_list|(
argument|attrseq
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeSequence
modifier|*
name|attrseq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|attrseq
operator|->
name|length
operator|=
name|SUPPORTEDATTRIBUTES
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|FILING_createdOn
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|FILING_isDirectory
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|2
index|]
operator|.
name|type
operator|=
name|FILING_modifiedOn
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|3
index|]
operator|.
name|type
operator|=
name|FILING_name
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|4
index|]
operator|.
name|type
operator|=
name|FILING_dataSize
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|5
index|]
operator|.
name|type
operator|=
name|FILING_type
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|6
index|]
operator|.
name|type
operator|=
name|FILING_version
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|7
index|]
operator|.
name|type
operator|=
name|FILING_pathname
expr_stmt|;
block|}
end_block

begin_macro
name|make_required_attributes
argument_list|(
argument|attrseq
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeSequence
modifier|*
name|attrseq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|attrseq
operator|->
name|length
operator|=
name|REQUIREDATTRIBUTES
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|FILING_createdOn
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|FILING_modifiedOn
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|2
index|]
operator|.
name|type
operator|=
name|FILING_name
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|3
index|]
operator|.
name|type
operator|=
name|FILING_dataSize
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|4
index|]
operator|.
name|type
operator|=
name|FILING_version
expr_stmt|;
name|attrseq
operator|->
name|sequence
index|[
literal|5
index|]
operator|.
name|type
operator|=
name|FILING_pathname
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|EXTENSIONS
end_endif

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_ChangeAttributes
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|attributes
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeSequence
name|attributes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|EXTENSIONS
name|file_handle
modifier|*
name|handle
decl_stmt|;
name|char
name|oldname
index|[
name|MAX_FILE_NAME_LENGTH
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"ChangeAttributes\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|is_nullHandle
argument_list|(
name|file
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_nullDisallowed
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|handle
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
comment|/* do it now */
name|strcpy
argument_list|(
name|oldname
argument_list|,
name|handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
if|if
condition|(
name|verify_change_attributes
argument_list|(
name|attributes
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|oldname
argument_list|,
name|handle
operator|->
name|pathname
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|rename_file
argument_list|(
name|oldname
argument_list|,
name|handle
argument_list|)
expr_stmt|;
block|}
name|set_create_time
argument_list|(
name|handle
argument_list|)
expr_stmt|;
return|return;
else|#
directive|else
else|EXTENSIONS
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|9
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|EXTENSIONS
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|EXTENSIONS
end_ifdef

begin_macro
name|verify_change_attributes
argument_list|(
argument|attr
argument_list|,
argument|handle
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeSequence
name|attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
modifier|*
name|handle
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|FILING_AttributeType
name|t
decl_stmt|;
name|int
name|got_accesslist
decl_stmt|,
name|got_childrenuniquelynamed
decl_stmt|,
name|got_createdon
decl_stmt|,
name|got_datasize
decl_stmt|;
name|int
name|got_defaultaccesslist
decl_stmt|,
name|got_ordering
decl_stmt|;
name|int
name|got_subtreesizelimit
decl_stmt|,
name|got_type
decl_stmt|,
name|got_version
decl_stmt|;
name|FILING_Version
name|version
decl_stmt|;
name|Boolean
name|childrenuniquelynamed
decl_stmt|;
name|Cardinal
name|ordering
decl_stmt|;
name|Cardinal
name|subtreesizelimit
decl_stmt|;
name|char
modifier|*
name|AttrToString
parameter_list|()
function_decl|;
name|LongCardinal
name|AttrToLongCardinal
parameter_list|()
function_decl|;
name|int
name|got_name
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d change attributes	"
argument_list|,
name|attr
operator|.
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|attr
operator|.
name|length
operator|<
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|=
name|got_childrenuniquelynamed
operator|=
name|got_createdon
operator|=
literal|0
expr_stmt|;
name|got_datasize
operator|=
name|got_defaultaccesslist
operator|=
literal|0
expr_stmt|;
name|got_ordering
operator|=
name|got_subtreesizelimit
operator|=
name|got_type
operator|=
name|got_version
operator|=
literal|0
expr_stmt|;
name|got_name
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
name|attr
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d "
argument_list|,
name|t
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|t
operator|==
name|FILING_createdOn
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"createdOn  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_createdon
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_createdon
operator|++
expr_stmt|;
name|handle
operator|->
name|createdon
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_dataSize
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"dataSize  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_datasize
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_datasize
operator|++
expr_stmt|;
name|handle
operator|->
name|datasize
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_type
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"type  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_type
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_type
operator|++
expr_stmt|;
name|handle
operator|->
name|type
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_version
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"version  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_version
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_version
operator|++
expr_stmt|;
name|version
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
name|FILING_highestVersion
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_name
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"name  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_name
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_name
operator|++
expr_stmt|;
name|name
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_accessList
condition|)
block|{
if|if
condition|(
name|got_accesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
endif|#
directive|endif
endif|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_childrenUniquelyNamed
condition|)
block|{
if|if
condition|(
name|got_childrenuniquelynamed
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_childrenuniquelynamed
operator|++
expr_stmt|;
name|childrenuniquelynamed
operator|=
name|AttrToBoolean
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|childrenuniquelynamed
operator|!=
name|TRUE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
ifdef|#
directive|ifdef
name|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_defaultAccessList
condition|)
block|{
if|if
condition|(
name|got_defaultaccesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_defaultaccesslist
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
endif|#
directive|endif
endif|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_ordering
condition|)
block|{
if|if
condition|(
name|got_ordering
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_ordering
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_subtreeSizeLimit
condition|)
block|{
if|if
condition|(
name|got_subtreesizelimit
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_subtreesizelimit
operator|++
expr_stmt|;
name|subtreesizelimit
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|subtreesizelimit
operator|!=
name|FILING_nullSubtreeSizeLimit
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
operator|(
name|t
operator|==
name|FILING_fileID
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_isDirectory
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_isTemporary
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_modifiedBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_modifiedOn
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_numberOfChildren
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_parentID
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_pathname
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_readBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_readOn
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_storedSize
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_subtreeSize
operator|)
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t
operator|<
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|t
operator|==
name|FILING_checksum
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_createdBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_position
operator|)
condition|)
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
else|else
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_name
condition|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|rindex
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|rindex
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|ptr
operator|=
name|handle
operator|->
name|pathname
expr_stmt|;
block|}
else|else
block|{
name|ptr
operator|++
expr_stmt|;
operator|*
name|ptr
operator|=
literal|'\0'
expr_stmt|;
block|}
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|EXTENSIONS
end_endif

begin_escape
end_escape

begin_decl_stmt
name|FILING_CopyResults
name|FILING_Copy
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|destdir
argument_list|,
name|attributes
argument_list|,
name|controls
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Handle
name|destdir
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeSequence
name|attributes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ControlSequence
name|controls
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|EXTENSIONS
name|FILING_CopyResults
name|results
decl_stmt|;
name|file_handle
modifier|*
name|handle
decl_stmt|;
name|file_handle
modifier|*
name|dir_handle
decl_stmt|;
name|file_handle
modifier|*
name|new_handle
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Copy\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|BDTabort_expected
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|handle
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|new_handle
operator|=
operator|(
name|file_handle
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|file_handle
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ReturnUndefinedError
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|new_handle
operator|->
name|pathname
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|MAX_FILE_NAME_LENGTH
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ReturnUndefinedError
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"copy handle= %x\n"
argument_list|,
name|new_handle
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|copyhandle
argument_list|(
operator|&
name|dir_handle
argument_list|,
name|destdir
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir_handle
operator|==
literal|0
condition|)
block|{
name|dir_handle
operator|=
operator|&
name|RootHandle
expr_stmt|;
name|strcpy
argument_list|(
name|new_handle
operator|->
name|pathname
argument_list|,
name|SERVICE_ROOT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dir_handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|dir_handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|dir_handle
operator|->
name|isdirectory
operator|!=
name|TRUE
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_directoryRequired
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|strcpy
argument_list|(
name|new_handle
operator|->
name|pathname
argument_list|,
name|dir_handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|new_handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|new_handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verify_copy_attributes
argument_list|(
name|attributes
argument_list|,
name|new_handle
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"copying %s to %s\n"
argument_list|,
name|handle
operator|->
name|pathname
argument_list|,
name|new_handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|msgs
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|copy_file
argument_list|(
name|handle
argument_list|,
name|new_handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|new_handle
operator|->
name|state
operator|=
name|FILE_OPEN
expr_stmt|;
name|new_handle
operator|->
name|file_desc
operator|=
name|NULL
expr_stmt|;
name|copyhandle
argument_list|(
name|results
operator|.
name|newFile
argument_list|,
operator|&
name|new_handle
argument_list|)
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return
operator|(
name|results
operator|)
return|;
else|#
directive|else
else|EXTENSIONS
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|10
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|EXTENSIONS
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|EXTENSIONS
end_ifdef

begin_macro
name|verify_copy_attributes
argument_list|(
argument|attr
argument_list|,
argument|tohandle
argument_list|,
argument|fromhandle
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeSequence
name|attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
modifier|*
name|tohandle
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
modifier|*
name|fromhandle
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|FILING_AttributeType
name|t
decl_stmt|;
name|int
name|got_accesslist
decl_stmt|,
name|got_defaultaccesslist
decl_stmt|,
name|got_istemporary
decl_stmt|;
name|int
name|got_name
decl_stmt|,
name|got_pathname
decl_stmt|,
name|got_subtreesizelimit
decl_stmt|,
name|got_version
decl_stmt|;
name|char
modifier|*
name|pathname
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|FILING_Version
name|version
decl_stmt|;
name|Boolean
name|istemporary
decl_stmt|;
name|Cardinal
name|subtreesizelimit
decl_stmt|;
name|char
modifier|*
name|AttrToString
parameter_list|()
function_decl|;
name|LongCardinal
name|AttrToLongCardinal
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d copy attributes	"
argument_list|,
name|attr
operator|.
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|attr
operator|.
name|length
operator|<
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|=
name|got_defaultaccesslist
operator|=
name|got_istemporary
operator|=
literal|0
expr_stmt|;
name|got_name
operator|=
name|got_pathname
operator|=
name|got_subtreesizelimit
operator|=
name|got_version
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
name|attr
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d "
argument_list|,
name|t
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|t
operator|==
name|FILING_pathname
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"pathname  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_pathname
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_pathname
operator|++
expr_stmt|;
name|pathname
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_pathname
argument_list|(
name|pathname
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_version
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"version  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_version
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_version
operator|++
expr_stmt|;
name|version
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
name|FILING_highestVersion
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_name
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"name  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_name
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_name
operator|++
expr_stmt|;
name|name
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_accessList
condition|)
block|{
if|if
condition|(
name|got_accesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_defaultAccessList
condition|)
block|{
if|if
condition|(
name|got_defaultaccesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_defaultaccesslist
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
endif|#
directive|endif
endif|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_isTemporary
condition|)
block|{
if|if
condition|(
name|got_istemporary
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_istemporary
operator|++
expr_stmt|;
name|istemporary
operator|=
name|AttrToBoolean
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|istemporary
operator|!=
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_subtreeSizeLimit
condition|)
block|{
if|if
condition|(
name|got_subtreesizelimit
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_subtreesizelimit
operator|++
expr_stmt|;
name|subtreesizelimit
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|subtreesizelimit
operator|!=
name|FILING_nullSubtreeSizeLimit
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_position
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|t
operator|<
literal|0
operator|)
operator|||
operator|(
name|t
operator|>
name|FILING_subtreeSizeLimit
operator|)
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_pathname
operator|&&
operator|!
name|got_name
condition|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|rindex
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|rindex
argument_list|(
name|fromhandle
operator|->
name|pathname
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|ptr
operator|=
name|fromhandle
operator|->
name|pathname
expr_stmt|;
else|else
name|ptr
operator|++
expr_stmt|;
name|strcat
argument_list|(
name|tohandle
operator|->
name|pathname
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|got_pathname
condition|)
block|{
name|strcat
argument_list|(
name|tohandle
operator|->
name|pathname
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|pathname
operator|==
literal|'/'
condition|)
name|strcat
argument_list|(
name|tohandle
operator|->
name|pathname
argument_list|,
name|pathname
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|tohandle
operator|->
name|pathname
argument_list|,
name|pathname
argument_list|)
expr_stmt|;
name|Deallocate
argument_list|(
operator|&
name|pathname
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_pathname
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_missing
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
else|else
block|{
if|if
condition|(
operator|*
name|pathname
operator|==
literal|'/'
condition|)
name|strcat
argument_list|(
name|tohandle
operator|->
name|pathname
argument_list|,
name|pathname
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|tohandle
operator|->
name|pathname
argument_list|,
name|pathname
argument_list|)
expr_stmt|;
name|Deallocate
argument_list|(
operator|&
name|pathname
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|EXTENSIONS
end_endif

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_Move
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|destdir
argument_list|,
name|attributes
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Handle
name|destdir
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeSequence
name|attributes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|EXTENSIONS
name|file_handle
modifier|*
name|handle
decl_stmt|;
name|file_handle
modifier|*
name|dir_handle
decl_stmt|;
name|char
name|oldname
index|[
name|MAX_FILE_NAME_LENGTH
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Move\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|BDTabort_expected
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|handle
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|strcpy
argument_list|(
name|oldname
argument_list|,
name|handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
name|copyhandle
argument_list|(
operator|&
name|dir_handle
argument_list|,
name|destdir
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir_handle
operator|==
literal|0
condition|)
block|{
name|dir_handle
operator|=
operator|&
name|RootHandle
expr_stmt|;
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|SERVICE_ROOT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dir_handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|dir_handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|dir_handle
operator|->
name|isdirectory
operator|!=
name|TRUE
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_directoryRequired
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|dir_handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verify_move_attributes
argument_list|(
name|attributes
argument_list|,
name|handle
argument_list|,
name|oldname
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"moving %s to %s\n"
argument_list|,
name|oldname
argument_list|,
name|handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|rename_file
argument_list|(
name|oldname
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return;
else|#
directive|else
else|EXTENSIONS
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|11
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|EXTENSIONS
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|EXTENSIONS
end_ifdef

begin_macro
name|verify_move_attributes
argument_list|(
argument|attr
argument_list|,
argument|tohandle
argument_list|,
argument|fromname
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeSequence
name|attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
modifier|*
name|tohandle
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fromname
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|FILING_AttributeType
name|t
decl_stmt|;
name|int
name|got_accesslist
decl_stmt|,
name|got_defaultaccesslist
decl_stmt|,
name|got_istemporary
decl_stmt|;
name|int
name|got_name
decl_stmt|,
name|got_subtreesizelimit
decl_stmt|,
name|got_version
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|FILING_Version
name|version
decl_stmt|;
name|Boolean
name|istemporary
decl_stmt|;
name|Cardinal
name|subtreesizelimit
decl_stmt|;
name|char
modifier|*
name|AttrToString
parameter_list|()
function_decl|;
name|LongCardinal
name|AttrToLongCardinal
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d move attributes	"
argument_list|,
name|attr
operator|.
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|attr
operator|.
name|length
operator|<
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|=
name|got_defaultaccesslist
operator|=
name|got_istemporary
operator|=
literal|0
expr_stmt|;
name|got_name
operator|=
name|got_subtreesizelimit
operator|=
name|got_version
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
name|attr
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d "
argument_list|,
name|t
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|t
operator|==
name|FILING_version
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"version  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_version
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_version
operator|++
expr_stmt|;
name|version
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
name|FILING_highestVersion
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_name
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"name  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_name
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_name
operator|++
expr_stmt|;
name|name
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_accessList
condition|)
block|{
if|if
condition|(
name|got_accesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_defaultAccessList
condition|)
block|{
if|if
condition|(
name|got_defaultaccesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_defaultaccesslist
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
endif|#
directive|endif
endif|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_isTemporary
condition|)
block|{
if|if
condition|(
name|got_istemporary
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_istemporary
operator|++
expr_stmt|;
name|istemporary
operator|=
name|AttrToBoolean
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|istemporary
operator|!=
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_subtreeSizeLimit
condition|)
block|{
if|if
condition|(
name|got_subtreesizelimit
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_subtreesizelimit
operator|++
expr_stmt|;
name|subtreesizelimit
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|subtreesizelimit
operator|!=
name|FILING_nullSubtreeSizeLimit
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_position
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|t
operator|<
literal|0
operator|)
operator|||
operator|(
name|t
operator|>
name|FILING_subtreeSizeLimit
operator|)
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|!
name|got_name
condition|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|rindex
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|rindex
argument_list|(
name|fromname
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|ptr
operator|=
name|fromname
expr_stmt|;
else|else
name|ptr
operator|++
expr_stmt|;
name|strcat
argument_list|(
name|tohandle
operator|->
name|pathname
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strcat
argument_list|(
name|tohandle
operator|->
name|pathname
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|EXTENSIONS
end_endif

begin_escape
end_escape

begin_decl_stmt
name|FILING_StoreResults
name|FILING_Store
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|directory
argument_list|,
name|attributes
argument_list|,
name|controls
argument_list|,
name|content
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|directory
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeSequence
name|attributes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ControlSequence
name|controls
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BulkData1_Descriptor
name|content
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|FILING_StoreResults
name|results
decl_stmt|;
name|file_handle
modifier|*
name|handle
decl_stmt|,
modifier|*
name|dir_handle
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Store  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|BDTabort_expected
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifndef|#
directive|ifndef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|is_nullControls
argument_list|(
name|controls
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|ReturnControlTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|is_nullHandle
argument_list|(
name|directory
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
name|content
operator|.
name|designator
operator|==
name|BulkData1_null
condition|)
block|{
return|return;
block|}
elseif|else
if|if
condition|(
name|content
operator|.
name|designator
operator|!=
name|BulkData1_immediate
condition|)
block|{
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|handle
operator|=
operator|(
name|file_handle
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|file_handle
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ReturnUndefinedError
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|handle
operator|->
name|pathname
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|MAX_FILE_NAME_LENGTH
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ReturnUndefinedError
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"store handle= %x\n"
argument_list|,
name|handle
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|copyhandle
argument_list|(
operator|&
name|dir_handle
argument_list|,
name|directory
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir_handle
operator|==
literal|0
condition|)
block|{
name|dir_handle
operator|=
operator|&
name|RootHandle
expr_stmt|;
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|SERVICE_ROOT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dir_handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|dir_handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|dir_handle
operator|->
name|isdirectory
operator|!=
name|TRUE
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_directoryRequired
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|dir_handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|SERVICE_ROOT
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
name|verify_store_attributes
argument_list|(
name|attributes
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"creating '%s'\n"
argument_list|,
name|handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|handle
operator|->
name|isdirectory
operator|==
name|TRUE
condition|)
block|{
if|if
condition|(
name|dir_storeproc
argument_list|(
name|ServerConnection
argument_list|,
name|handle
argument_list|,
name|content
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
block|}
else|else
block|{
if|if
condition|(
name|create_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|EXTENSIONS
if|if
condition|(
operator|(
name|handle
operator|->
name|type
operator|>
name|LAST_FILING_TYPE
operator|)
operator|&&
operator|(
name|handle
operator|->
name|type
operator|!=
name|TYPE_Interpress
operator|)
operator|&&
operator|(
name|handle
operator|->
name|type
operator|!=
name|TYPE_VPCanvas
operator|)
condition|)
block|{
name|SaveExtendedAttributes
argument_list|(
name|handle
operator|->
name|file_desc
argument_list|,
name|attributes
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|EXTENSIONS
if|if
condition|(
name|storeproc
argument_list|(
name|ServerConnection
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|delete_partial_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
block|}
name|handle
operator|->
name|state
operator|=
name|FILE_OPEN
expr_stmt|;
name|handle
operator|->
name|file_desc
operator|=
name|NULL
expr_stmt|;
name|copyhandle
argument_list|(
name|results
operator|.
name|file
argument_list|,
operator|&
name|handle
argument_list|)
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return
operator|(
name|results
operator|)
return|;
block|}
end_block

begin_macro
name|verify_store_attributes
argument_list|(
argument|attr
argument_list|,
argument|handle
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeSequence
name|attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
modifier|*
name|handle
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|FILING_AttributeType
name|t
decl_stmt|;
name|int
name|got_accesslist
decl_stmt|,
name|got_childrenuniquelynamed
decl_stmt|,
name|got_createdon
decl_stmt|,
name|got_datasize
decl_stmt|;
name|int
name|got_defaultaccesslist
decl_stmt|,
name|got_isdirectory
decl_stmt|,
name|got_istemporary
decl_stmt|,
name|got_ordering
decl_stmt|;
name|int
name|got_parentID
decl_stmt|,
name|got_pathname
decl_stmt|,
name|got_subtreesizelimit
decl_stmt|,
name|got_type
decl_stmt|,
name|got_version
decl_stmt|;
name|char
modifier|*
name|pathname
decl_stmt|;
name|FILING_Version
name|version
decl_stmt|;
name|Boolean
name|childrenuniquelynamed
decl_stmt|,
name|istemporary
decl_stmt|;
name|Cardinal
name|ordering
decl_stmt|;
name|Cardinal
name|subtreesizelimit
decl_stmt|;
name|char
modifier|*
name|AttrToString
parameter_list|()
function_decl|;
name|Unspecified
modifier|*
name|AttrToFileID
parameter_list|()
function_decl|;
name|LongCardinal
name|AttrToLongCardinal
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|int
name|got_name
decl_stmt|,
name|got_4938
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d store attributes	"
argument_list|,
name|attr
operator|.
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|attr
operator|.
name|length
operator|<=
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|=
name|got_childrenuniquelynamed
operator|=
name|got_createdon
operator|=
literal|0
expr_stmt|;
name|got_datasize
operator|=
name|got_defaultaccesslist
operator|=
name|got_isdirectory
operator|=
literal|0
expr_stmt|;
name|got_istemporary
operator|=
name|got_ordering
operator|=
name|got_parentID
operator|=
name|got_pathname
operator|=
literal|0
expr_stmt|;
name|got_subtreesizelimit
operator|=
name|got_type
operator|=
name|got_version
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|got_name
operator|=
name|got_4938
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
name|attr
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d "
argument_list|,
name|t
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|t
operator|==
name|FILING_createdOn
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"createdOn  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_createdon
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_createdon
operator|++
expr_stmt|;
name|handle
operator|->
name|createdon
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_dataSize
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"dataSize  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_datasize
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_datasize
operator|++
expr_stmt|;
name|handle
operator|->
name|datasize
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_isDirectory
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"isDirectory  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_isdirectory
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_isdirectory
operator|++
expr_stmt|;
name|handle
operator|->
name|isdirectory
operator|=
name|AttrToBoolean
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_pathname
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"pathname  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_pathname
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_pathname
operator|++
expr_stmt|;
name|pathname
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_pathname
argument_list|(
name|pathname
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_type
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"type  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_type
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_type
operator|++
expr_stmt|;
name|handle
operator|->
name|type
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|EXTENSIONS
if|if
condition|(
operator|(
name|handle
operator|->
name|type
operator|!=
name|FILING_tText
operator|)
operator|&&
operator|(
name|handle
operator|->
name|type
operator|!=
name|FILING_tUnspecified
operator|)
operator|&&
operator|(
name|handle
operator|->
name|type
operator|!=
name|FILING_tDirectory
operator|)
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|EXTENSIONS
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_version
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"version  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_version
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_version
operator|++
expr_stmt|;
name|version
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
name|FILING_highestVersion
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|t
operator|==
name|FILING_name
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"name  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_name
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_name
operator|++
expr_stmt|;
name|name
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
literal|4938
condition|)
block|{
if|if
condition|(
name|got_4938
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_4938
operator|++
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
ifdef|#
directive|ifdef
name|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_accessList
condition|)
block|{
if|if
condition|(
name|got_accesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
endif|#
directive|endif
endif|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_childrenUniquelyNamed
condition|)
block|{
if|if
condition|(
name|got_childrenuniquelynamed
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_childrenuniquelynamed
operator|++
expr_stmt|;
name|childrenuniquelynamed
operator|=
name|AttrToBoolean
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|childrenuniquelynamed
operator|!=
name|TRUE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
ifdef|#
directive|ifdef
name|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_defaultAccessList
condition|)
block|{
if|if
condition|(
name|got_defaultaccesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_defaultaccesslist
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
endif|#
directive|endif
endif|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_isTemporary
condition|)
block|{
if|if
condition|(
name|got_istemporary
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_istemporary
operator|++
expr_stmt|;
name|istemporary
operator|=
name|AttrToBoolean
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|istemporary
operator|!=
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_ordering
condition|)
block|{
if|if
condition|(
name|got_ordering
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_ordering
operator|++
expr_stmt|;
if|if
condition|(
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_subtreeSizeLimit
condition|)
block|{
if|if
condition|(
name|got_subtreesizelimit
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_subtreesizelimit
operator|++
expr_stmt|;
name|subtreesizelimit
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|subtreesizelimit
operator|!=
name|FILING_nullSubtreeSizeLimit
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
operator|(
name|t
operator|==
name|FILING_fileID
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_modifiedBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_modifiedOn
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_name
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_numberOfChildren
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_parentID
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_readBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_readOn
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_storedSize
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_subtreeSize
operator|)
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|EXTENSIONS
if|if
condition|(
operator|(
name|t
operator|<
literal|0
operator|)
operator|||
operator|(
name|t
operator|>
name|FILING_subtreeSizeLimit
operator|)
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|t
operator|==
name|FILING_checksum
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_createdBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_position
operator|)
condition|)
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
else|else
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
else|#
directive|else
else|EXTENSIONS
if|if
condition|(
name|t
operator|<
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|handle
operator|->
name|type
operator|!=
name|TYPE_VP
condition|)
block|{
if|if
condition|(
operator|(
name|t
operator|==
name|FILING_checksum
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_createdBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_position
operator|)
condition|)
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
else|else
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|EXTENSIONS
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_pathname
operator|&&
operator|!
name|got_name
condition|)
block|{
name|handle
operator|->
name|pathname
operator|=
name|SERVICE_ROOT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|got_pathname
condition|)
block|{
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|pathname
operator|==
literal|'/'
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
argument_list|)
expr_stmt|;
name|Deallocate
argument_list|(
operator|&
name|pathname
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_pathname
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_missing
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
else|else
block|{
if|if
condition|(
operator|*
name|pathname
operator|==
literal|'/'
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
argument_list|)
expr_stmt|;
name|Deallocate
argument_list|(
operator|&
name|pathname
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|!
name|got_type
condition|)
name|handle
operator|->
name|type
operator|=
name|FILING_tUnspecified
expr_stmt|;
if|if
condition|(
operator|!
name|got_createdon
condition|)
name|handle
operator|->
name|createdon
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|got_isdirectory
condition|)
block|{
if|if
condition|(
name|handle
operator|->
name|type
operator|==
name|FILING_tDirectory
condition|)
name|handle
operator|->
name|isdirectory
operator|=
name|TRUE
expr_stmt|;
else|else
name|handle
operator|->
name|isdirectory
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|(
name|handle
operator|->
name|isdirectory
operator|==
name|TRUE
operator|)
operator|&&
operator|(
name|handle
operator|->
name|type
operator|!=
name|FILING_tDirectory
operator|)
operator|)
operator|||
operator|(
operator|(
name|handle
operator|->
name|isdirectory
operator|==
name|FALSE
operator|)
operator|&&
operator|(
name|handle
operator|->
name|type
operator|==
name|FILING_tDirectory
operator|)
operator|)
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unreasonable
argument_list|,
name|FILING_isDirectory
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_Retrieve
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|content
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BulkData1_Descriptor
name|content
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|file_handle
modifier|*
name|handle
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Retrieve\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|BDTabort_expected
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|is_nullHandle
argument_list|(
name|file
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_nullDisallowed
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|handle
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|content
operator|.
name|designator
operator|==
name|BulkData1_null
condition|)
block|{
return|return;
block|}
elseif|else
if|if
condition|(
name|content
operator|.
name|designator
operator|!=
name|BulkData1_immediate
condition|)
block|{
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|open_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"retrieving '%s'\n"
argument_list|,
name|handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|retrieveproc
argument_list|(
name|ServerConnection
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|handle
operator|->
name|file_desc
operator|=
name|NULL
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_Replace
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|attributes
argument_list|,
name|content
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeSequence
name|attributes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BulkData1_Descriptor
name|content
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|EXTENSIONS
name|file_handle
modifier|*
name|handle
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Replace\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|BDTabort_expected
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|is_nullHandle
argument_list|(
name|file
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_nullDisallowed
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|handle
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|content
operator|.
name|designator
operator|==
name|BulkData1_null
condition|)
block|{
return|return;
block|}
elseif|else
if|if
condition|(
name|content
operator|.
name|designator
operator|!=
name|BulkData1_immediate
condition|)
block|{
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|verify_replace_attributes
argument_list|(
name|attributes
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"replacing '%s'\n"
argument_list|,
name|handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|make_backup
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|open_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|storeproc
argument_list|(
name|ServerConnection
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|recall_backup
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|unlink_backup
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|handle
operator|->
name|file_desc
operator|=
name|NULL
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return;
else|#
directive|else
else|EXTENSIONS
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|14
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|EXTENSIONS
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|EXTENSIONS
end_ifdef

begin_macro
name|verify_replace_attributes
argument_list|(
argument|attr
argument_list|,
argument|handle
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeSequence
name|attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
modifier|*
name|handle
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|FILING_AttributeType
name|t
decl_stmt|;
name|LongCardinal
name|datasize
decl_stmt|;
name|int
name|got_createdon
decl_stmt|,
name|got_datasize
decl_stmt|;
name|LongCardinal
name|AttrToLongCardinal
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d replace attributes	"
argument_list|,
name|attr
operator|.
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|attr
operator|.
name|length
operator|<
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_createdon
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
name|attr
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d "
argument_list|,
name|t
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|t
operator|==
name|FILING_createdOn
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"createdOn  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_createdon
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_createdon
operator|++
expr_stmt|;
name|handle
operator|->
name|createdon
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_dataSize
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"dataSize  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_datasize
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_datasize
operator|++
expr_stmt|;
name|datasize
operator|=
name|AttrToLongCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|<
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|t
operator|==
name|FILING_checksum
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_createdBy
operator|)
operator|||
operator|(
name|t
operator|==
name|FILING_position
operator|)
condition|)
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
else|else
name|ReturnAttributeTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|EXTENSIONS
end_endif

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_Serialize
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|serializedFile
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BulkData1_Descriptor
name|serializedFile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|EXTENSIONS
name|file_handle
modifier|*
name|handle
decl_stmt|;
name|LongCardinal
name|type
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Serialize\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|BDTabort_expected
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|is_nullHandle
argument_list|(
name|file
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_nullDisallowed
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|handle
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|serializedFile
operator|.
name|designator
operator|==
name|BulkData1_null
condition|)
block|{
return|return;
block|}
elseif|else
if|if
condition|(
name|serializedFile
operator|.
name|designator
operator|!=
name|BulkData1_immediate
condition|)
block|{
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
comment|/* 	 * for now, can only serialize files which are already in 'serialized' 	 * form. This can be assumed if the file is of a Viewpoint file type 	 * and the stored isDirectory attribute is TRUE. 	 * NOTE: like all other cases, this is no guarantee... 	*/
name|type
operator|=
name|get_type
argument_list|(
name|handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|type
operator|<
name|LAST_FILING_TYPE
operator|)
operator|||
operator|(
name|type
operator|==
name|TYPE_Interpress
operator|)
operator|||
operator|(
name|type
operator|==
name|TYPE_VPCanvas
operator|)
condition|)
block|{
name|ReturnAccessError
argument_list|(
name|FILING_fileChanged
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|open_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|GetDirectoryAttribute
argument_list|(
name|handle
operator|->
name|file_desc
argument_list|)
operator|!=
name|TRUE
condition|)
block|{
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|ReturnAccessError
argument_list|(
name|FILING_fileChanged
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"serializing '%s'\n"
argument_list|,
name|handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|retrieveproc
argument_list|(
name|ServerConnection
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|handle
operator|->
name|file_desc
operator|=
name|NULL
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
else|#
directive|else
else|EXTENSIONS
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|15
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|EXTENSIONS
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|FILING_DeserializeResults
name|FILING_Deserialize
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|directory
argument_list|,
name|attributes
argument_list|,
name|controls
argument_list|,
name|serializedFile
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|directory
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeSequence
name|attributes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ControlSequence
name|controls
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BulkData1_Descriptor
name|serializedFile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|EXTENSIONS
name|FILING_DeserializeResults
name|results
decl_stmt|;
name|file_handle
modifier|*
name|handle
decl_stmt|,
modifier|*
name|dir_handle
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Deserialize  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|BDTabort_expected
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifndef|#
directive|ifndef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|is_nullControls
argument_list|(
name|controls
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|ReturnControlTypeError
argument_list|(
name|FILING_disallowed
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|is_nullHandle
argument_list|(
name|directory
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
name|serializedFile
operator|.
name|designator
operator|==
name|BulkData1_null
condition|)
block|{
return|return;
block|}
elseif|else
if|if
condition|(
name|serializedFile
operator|.
name|designator
operator|!=
name|BulkData1_immediate
condition|)
block|{
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|handle
operator|=
operator|(
name|file_handle
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|file_handle
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ReturnUndefinedError
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|(
name|handle
operator|->
name|pathname
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|MAX_FILE_NAME_LENGTH
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ReturnUndefinedError
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"deserialize handle= %x\n"
argument_list|,
name|handle
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|copyhandle
argument_list|(
operator|&
name|dir_handle
argument_list|,
name|directory
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir_handle
operator|==
literal|0
condition|)
block|{
name|dir_handle
operator|=
operator|&
name|RootHandle
expr_stmt|;
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|SERVICE_ROOT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dir_handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|dir_handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|dir_handle
operator|->
name|isdirectory
operator|!=
name|TRUE
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_directoryRequired
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|dir_handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
name|strcpy
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|SERVICE_ROOT
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
name|verify_deserialize_attributes
argument_list|(
name|attributes
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"creating '%s'\n"
argument_list|,
name|handle
operator|->
name|pathname
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|create_file
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|storeproc
argument_list|(
name|ServerConnection
argument_list|,
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|delete_partial_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|close_file
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|handle
operator|->
name|state
operator|=
name|FILE_OPEN
expr_stmt|;
name|handle
operator|->
name|file_desc
operator|=
name|NULL
expr_stmt|;
name|copyhandle
argument_list|(
name|results
operator|.
name|file
argument_list|,
operator|&
name|handle
argument_list|)
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return
operator|(
name|results
operator|)
return|;
else|#
directive|else
else|EXTENSIONS
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|16
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|EXTENSIONS
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|EXTENSIONS
end_ifdef

begin_macro
name|verify_deserialize_attributes
argument_list|(
argument|attr
argument_list|,
argument|handle
argument_list|)
end_macro

begin_decl_stmt
name|FILING_AttributeSequence
name|attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
modifier|*
name|handle
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|FILING_AttributeType
name|t
decl_stmt|;
name|int
name|got_accesslist
decl_stmt|,
name|got_defaultaccesslist
decl_stmt|,
name|got_istemporary
decl_stmt|;
name|int
name|got_name
decl_stmt|,
name|got_pathname
decl_stmt|,
name|got_subtreesizelimit
decl_stmt|,
name|got_version
decl_stmt|;
name|FILING_Version
name|version
decl_stmt|;
name|Boolean
name|istemporary
decl_stmt|;
name|char
modifier|*
name|pathname
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|AttrToString
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"%d deserialize attributes     "
argument_list|,
name|attr
operator|.
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|attr
operator|.
name|length
operator|<=
literal|0
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|=
name|got_defaultaccesslist
operator|=
name|got_istemporary
operator|=
literal|0
expr_stmt|;
name|got_name
operator|=
name|got_pathname
operator|=
name|got_subtreesizelimit
operator|=
name|got_version
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
name|attr
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|FILING_accessList
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"accessList  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_accesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_accesslist
operator|++
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_defaultAccessList
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"defaultAccessList  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_defaultaccesslist
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_defaultaccesslist
operator|++
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
endif|SOMEDAY
if|if
condition|(
name|t
operator|==
name|FILING_isTemporary
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"isTemporary  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_istemporary
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_istemporary
operator|++
expr_stmt|;
name|istemporary
operator|=
name|AttrToBoolean
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|istemporary
operator|!=
name|FALSE
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/*  NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_name
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"name  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_name
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_name
operator|++
expr_stmt|;
name|name
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_pathname
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"pathname  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_pathname
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_pathname
operator|++
expr_stmt|;
name|pathname
operator|=
name|AttrToString
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_pathname
argument_list|(
name|pathname
argument_list|)
operator|!=
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_subtreeSizeLimit
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"subtreeSizeLimit  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_subtreesizelimit
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_subtreesizelimit
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_version
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"version  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_version
condition|)
block|{
name|ReturnAttributeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_version
operator|++
expr_stmt|;
name|version
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|attr
operator|.
name|sequence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
name|FILING_highestVersion
condition|)
block|{
name|ReturnAttributeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|!
name|got_pathname
operator|&&
operator|!
name|got_name
condition|)
block|{
name|handle
operator|->
name|pathname
operator|=
name|SERVICE_ROOT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|got_pathname
condition|)
block|{
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|Deallocate
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|pathname
operator|==
literal|'/'
condition|)
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|handle
operator|->
name|pathname
argument_list|,
name|pathname
argument_list|)
expr_stmt|;
name|Deallocate
argument_list|(
operator|&
name|pathname
argument_list|)
expr_stmt|;
block|}
name|handle
operator|->
name|type
operator|=
name|FILING_tSerialized
expr_stmt|;
name|handle
operator|->
name|createdon
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|EXTENSIONS
end_endif

begin_escape
end_escape

begin_decl_stmt
name|FILING_FindResults
name|FILING_Find
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|directory
argument_list|,
name|types
argument_list|,
name|scope
argument_list|,
name|controls
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|directory
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeTypeSequence
name|types
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ScopeSequence
name|scope
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ControlSequence
name|controls
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|17
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_List
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|directory
argument_list|,
name|types
argument_list|,
name|scope
argument_list|,
name|listing
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|directory
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_AttributeTypeSequence
name|types
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ScopeSequence
name|scope
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BulkData1_Descriptor
name|listing
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|match_name
decl_stmt|;
name|Cardinal
name|count
decl_stmt|;
name|file_handle
modifier|*
name|dir_handle
decl_stmt|;
name|BDTabort_expected
operator|=
name|TRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"List\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
ifndef|#
directive|ifndef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|is_nullHandle
argument_list|(
name|directory
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
name|listing
operator|.
name|designator
operator|==
name|BulkData1_null
condition|)
return|return;
elseif|else
if|if
condition|(
name|listing
operator|.
name|designator
operator|!=
name|BulkData1_immediate
condition|)
block|{
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|copyhandle
argument_list|(
operator|&
name|dir_handle
argument_list|,
name|directory
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
name|dir_handle
operator|==
literal|0
condition|)
block|{
name|dir_handle
operator|=
operator|&
name|RootHandle
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dir_handle
operator|->
name|state
operator|!=
name|FILE_OPEN
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_invalid
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|dir_handle
operator|->
name|isdirectory
operator|!=
name|TRUE
condition|)
block|{
name|ReturnHandleError
argument_list|(
name|FILING_directoryRequired
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|access_file
argument_list|(
name|dir_handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
name|dir_handle
operator|=
operator|&
name|RootHandle
expr_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
name|get_scopes
argument_list|(
name|scope
argument_list|,
operator|&
name|count
argument_list|,
operator|&
name|match_name
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
if|if
condition|(
name|list_directory
argument_list|(
name|ServerConnection
argument_list|,
name|dir_handle
argument_list|,
name|types
argument_list|,
name|match_name
argument_list|,
name|count
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return;
block|}
end_block

begin_macro
name|get_scopes
argument_list|(
argument|scope
argument_list|,
argument|count
argument_list|,
argument|matches_name
argument_list|)
end_macro

begin_decl_stmt
name|FILING_ScopeSequence
name|scope
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Cardinal
modifier|*
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|matches_name
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|got_count
decl_stmt|,
name|got_filter
decl_stmt|,
name|got_matches
decl_stmt|;
name|int
name|i
decl_stmt|,
name|scopetype
decl_stmt|;
name|FILING_ScopeType
name|t
decl_stmt|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|int
name|got_equal
decl_stmt|;
specifier|static
name|char
modifier|*
name|wildcard_all
init|=
literal|"*"
decl_stmt|;
operator|*
name|matches_name
operator|=
name|wildcard_all
expr_stmt|;
operator|*
name|count
operator|=
name|FILING_unlimitedCount
expr_stmt|;
if|if
condition|(
name|scope
operator|.
name|length
operator|<
literal|0
condition|)
block|{
name|ReturnScopeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
elseif|else
if|if
condition|(
name|scope
operator|.
name|length
operator|==
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
if|if
condition|(
name|scope
operator|.
name|length
operator|<=
literal|0
condition|)
block|{
name|ReturnScopeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"get_scope %d scopes   "
argument_list|,
name|scope
operator|.
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|got_count
operator|=
name|got_filter
operator|=
name|got_matches
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scope
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|t
operator|=
name|scope
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|designator
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|FILING_filter
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"filter  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_filter
condition|)
block|{
name|ReturnScopeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_filter
operator|++
expr_stmt|;
if|if
condition|(
name|get_filter
argument_list|(
name|scope
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|FILING_filter_case
argument_list|,
name|matches_name
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
continue|continue;
block|}
if|if
condition|(
name|t
operator|==
name|FILING_count
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"count  "
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|got_count
condition|)
block|{
name|ReturnScopeTypeError
argument_list|(
name|FILING_duplicated
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_count
operator|++
expr_stmt|;
operator|*
name|count
operator|=
name|AttrToCardinal
argument_list|(
operator|&
name|scope
operator|.
name|sequence
index|[
name|i
index|]
operator|.
name|FILING_count_case
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"count = %d  "
argument_list|,
operator|*
name|count
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
continue|continue;
block|}
name|scopetype
operator|=
operator|(
name|Cardinal
operator|)
name|t
expr_stmt|;
if|if
condition|(
operator|(
name|scopetype
operator|<
literal|0
operator|)
operator|||
operator|(
name|scopetype
operator|>
operator|(
name|Cardinal
operator|)
name|FILING_depth
operator|)
condition|)
block|{
name|ReturnScopeTypeError
argument_list|(
name|FILING_illegal
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|ReturnScopeTypeError
argument_list|(
name|FILING_unimplemented
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
if|if
condition|(
operator|!
name|got_count
condition|)
block|{
operator|*
name|count
operator|=
name|FILING_unlimitedCount
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
block|}
end_block

begin_macro
name|get_filter
argument_list|(
argument|filter
argument_list|,
argument|matches_name
argument_list|)
end_macro

begin_decl_stmt
name|FILING_Filter
name|filter
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|matches_name
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|got_matches
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
name|int
name|got_equal
init|=
literal|0
decl_stmt|;
name|int
name|got_all
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
if|if
condition|(
name|filter
operator|.
name|designator
operator|==
name|FILING_matches
condition|)
block|{
if|if
condition|(
name|got_matches
condition|)
block|{
name|ReturnScopeValueError
argument_list|(
name|FILING_duplicated
argument_list|,
operator|(
name|Cardinal
operator|)
name|FILING_filter
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_matches
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"matches on %d attribute\n"
argument_list|,
name|filter
operator|.
name|FILING_matches_case
operator|.
name|attribute
operator|.
name|type
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
if|if
condition|(
operator|(
name|filter
operator|.
name|FILING_matches_case
operator|.
name|attribute
operator|.
name|type
operator|!=
name|FILING_pathname
operator|)
operator|&&
operator|(
name|filter
operator|.
name|FILING_matches_case
operator|.
name|attribute
operator|.
name|type
operator|!=
name|FILING_name
operator|)
condition|)
block|{
name|ReturnScopeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
operator|(
name|Cardinal
operator|)
name|FILING_filter
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
else|#
directive|else
else|FILETOOLCOMPATIBILITY
if|if
condition|(
name|filter
operator|.
name|FILING_matches_case
operator|.
name|attribute
operator|.
name|type
operator|!=
name|FILING_pathname
condition|)
block|{
name|ReturnScopeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
operator|(
name|Cardinal
operator|)
name|FILING_filter
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
operator|*
name|matches_name
operator|=
name|AttrToString
argument_list|(
operator|&
name|filter
operator|.
name|FILING_matches_case
operator|.
name|attribute
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"matches name= '%s'\n"
argument_list|,
operator|*
name|matches_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
ifdef|#
directive|ifdef
name|FILETOOLCOMPATIBILITY
block|}
elseif|else
if|if
condition|(
name|filter
operator|.
name|designator
operator|==
name|FILING_equal
condition|)
block|{
if|if
condition|(
name|got_equal
condition|)
block|{
name|ReturnScopeValueError
argument_list|(
name|FILING_duplicated
argument_list|,
operator|(
name|Cardinal
operator|)
name|FILING_filter
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_equal
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"equal on %d attribute\n"
argument_list|,
name|filter
operator|.
name|FILING_matches_case
operator|.
name|attribute
operator|.
name|type
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|filter
operator|.
name|FILING_matches_case
operator|.
name|attribute
operator|.
name|type
operator|!=
name|FILING_pathname
operator|)
operator|&&
operator|(
name|filter
operator|.
name|FILING_matches_case
operator|.
name|attribute
operator|.
name|type
operator|!=
name|FILING_name
operator|)
condition|)
block|{
name|ReturnScopeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
operator|(
name|Cardinal
operator|)
name|FILING_filter
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
operator|*
name|matches_name
operator|=
name|AttrToString
argument_list|(
operator|&
name|filter
operator|.
name|FILING_matches_case
operator|.
name|attribute
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"matches name= '%s'\n"
argument_list|,
operator|*
name|matches_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
block|}
elseif|else
if|if
condition|(
name|filter
operator|.
name|designator
operator|==
name|FILING_all
condition|)
block|{
if|if
condition|(
name|got_all
condition|)
block|{
name|ReturnScopeValueError
argument_list|(
name|FILING_duplicated
argument_list|,
operator|(
name|Cardinal
operator|)
name|FILING_filter
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|got_all
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"all"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
endif|#
directive|endif
endif|FILETOOLCOMPATIBILITY
block|}
else|else
block|{
name|ReturnScopeValueError
argument_list|(
name|FILING_unimplemented
argument_list|,
operator|(
name|Cardinal
operator|)
name|FILING_filter
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|FILING_ContinueResults
name|FILING_Continue
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|FILING_ContinueResults
name|results
decl_stmt|;
name|BDTabort_expected
operator|=
name|FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|msgs
operator|==
literal|0
condition|)
block|{
name|char
name|logfile
index|[
literal|50
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|logfile
argument_list|,
literal|"/tmp/filing%ld.msgs"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|msgs
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"Continue\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|verify_session
argument_list|(
name|session
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
name|results
operator|.
name|continuance
operator|=
name|continuance
expr_stmt|;
name|reset_continuance_timer
argument_list|()
expr_stmt|;
return|return
operator|(
name|results
operator|)
return|;
block|}
end_block

begin_macro
name|continuance_expiration
argument_list|()
end_macro

begin_block
block|{
comment|/* 	 * if BDT in progress, don't close connection 	 */
if|if
condition|(
operator|!
name|BDTabort_expected
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"continuance_expiration, closing connection\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|msgs
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|CourierClose
argument_list|(
name|_serverConnection
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reset_continuance_timer
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_UnifyAccessLists
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|directory
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|directory
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|20
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_RetrieveBytes
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|range
argument_list|,
name|sink
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ByteRange
name|range
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BulkData1_Descriptor
name|sink
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|22
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
name|void
name|FILING_ReplaceBytes
argument_list|(
name|ServerConnection
argument_list|,
name|BDTProc
argument_list|,
name|file
argument_list|,
name|range
argument_list|,
name|source
argument_list|,
name|session
argument_list|)
name|CourierConnection
modifier|*
name|ServerConnection
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|BDTProc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|FILING_Handle
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_ByteRange
name|range
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BulkData1_Descriptor
name|source
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_Session
name|session
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|NoSuchProcedureValue
argument_list|(
literal|"Filing"
argument_list|,
literal|23
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|dir_storeproc
argument_list|(
argument|conn
argument_list|,
argument|handle
argument_list|,
argument|content
argument_list|)
end_macro

begin_decl_stmt
name|CourierConnection
modifier|*
name|conn
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|file_handle
modifier|*
name|handle
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BulkData1_Descriptor
name|content
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|count
decl_stmt|;
name|char
name|buffer
index|[
literal|10
index|]
decl_stmt|;
if|if
condition|(
name|content
operator|.
name|designator
operator|==
name|BulkData1_immediate
condition|)
block|{
if|if
condition|(
operator|(
name|count
operator|=
name|BDTread
argument_list|(
name|conn
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|BDTabort
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|ReturnAttributeTypeError
argument_list|(
name|FILING_unreasonable
argument_list|,
name|FILING_isDirectory
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
block|}
if|if
condition|(
name|create_directory
argument_list|(
name|handle
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* NOT REACHED */
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_decl_stmt
specifier|static
name|Unspecified
name|list_buffer
index|[
name|SPPMAXDATA
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Unspecified
modifier|*
name|list_end
init|=
name|list_buffer
operator|+
name|SPPMAXDATA
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Unspecified
modifier|*
name|list_ptr
init|=
name|list_buffer
decl_stmt|;
end_decl_stmt

begin_macro
name|put_next_attribute_sequence
argument_list|(
argument|conn
argument_list|,
argument|stream_of_attrseq
argument_list|)
end_macro

begin_decl_stmt
name|CourierConnection
modifier|*
name|conn
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILING_StreamOfAttributeSequence
modifier|*
name|stream_of_attrseq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|ocount
decl_stmt|;
name|stream_of_attrseq
operator|->
name|designator
operator|=
name|nextSegment
expr_stmt|;
if|if
condition|(
operator|(
name|list_ptr
operator|+
name|FILING_sizeof_StreamOfAttributeSequence
argument_list|(
name|stream_of_attrseq
argument_list|)
operator|)
operator|>
name|list_end
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"put_next writing %d bulk data\n"
argument_list|,
name|list_ptr
operator|-
name|list_buffer
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|ocount
operator|=
name|BDTwrite
argument_list|(
name|conn
argument_list|,
name|list_buffer
argument_list|,
operator|(
name|list_ptr
operator|-
name|list_buffer
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|Cardinal
argument_list|)
argument_list|)
operator|)
operator|<=
literal|0
condition|)
block|{
name|list_ptr
operator|=
name|list_buffer
expr_stmt|;
name|BDTabort
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|list_ptr
operator|=
name|list_buffer
expr_stmt|;
block|}
name|list_ptr
operator|+=
name|FILING_externalize_StreamOfAttributeSequence
argument_list|(
name|stream_of_attrseq
argument_list|,
name|list_ptr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"put_next_attr_seq (out) buf= %x, ptr= %x\n"
argument_list|,
name|list_buffer
argument_list|,
name|list_ptr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|put_last_attribute_sequence
argument_list|(
argument|conn
argument_list|)
end_macro

begin_decl_stmt
name|CourierConnection
modifier|*
name|conn
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|ocount
decl_stmt|;
name|Cardinal
name|zero
init|=
literal|0
decl_stmt|,
name|lastseg
init|=
operator|(
name|Cardinal
operator|)
name|lastSegment
decl_stmt|;
if|if
condition|(
operator|(
name|list_ptr
operator|+
operator|(
name|sizeof_Cardinal
argument_list|(
literal|0
argument_list|)
operator|*
literal|3
operator|)
operator|)
operator|>
name|list_end
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"put_last writing %d bulk data\n"
argument_list|,
name|list_ptr
operator|-
name|list_buffer
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|ocount
operator|=
name|BDTwrite
argument_list|(
name|conn
argument_list|,
name|list_buffer
argument_list|,
operator|(
name|list_ptr
operator|-
name|list_buffer
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|Cardinal
argument_list|)
argument_list|)
operator|)
operator|<=
literal|0
condition|)
block|{
name|list_ptr
operator|=
name|list_buffer
expr_stmt|;
name|BDTabort
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|list_ptr
operator|=
name|list_buffer
expr_stmt|;
block|}
name|list_ptr
operator|+=
name|externalize_Cardinal
argument_list|(
operator|&
name|lastseg
argument_list|,
name|list_ptr
argument_list|)
expr_stmt|;
name|list_ptr
operator|+=
name|externalize_Cardinal
argument_list|(
operator|&
name|zero
argument_list|,
name|list_ptr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|msgs
argument_list|,
literal|"put_last writing %d bulk data\n"
argument_list|,
name|list_ptr
operator|-
name|list_buffer
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|ocount
operator|=
name|BDTwrite
argument_list|(
name|conn
argument_list|,
name|list_buffer
argument_list|,
operator|(
name|list_ptr
operator|-
name|list_buffer
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|Cardinal
argument_list|)
argument_list|)
operator|)
operator|<=
literal|0
condition|)
block|{
name|list_ptr
operator|=
name|list_buffer
expr_stmt|;
name|BDTabort
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|ReturnTransferError
argument_list|(
name|FILING_aborted
argument_list|)
expr_stmt|;
comment|/* NOT REACHED */
block|}
name|list_ptr
operator|=
name|list_buffer
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

end_unit


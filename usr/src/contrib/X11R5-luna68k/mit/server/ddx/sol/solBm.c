begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  solBm.c --   *  *	remade by A.Fujita, DEC-16-1992  */
end_comment

begin_include
include|#
directive|include
file|"sol.h"
end_include

begin_include
include|#
directive|include
file|"solFb.h"
end_include

begin_macro
name|solBmCreate
argument_list|(
argument|sol_fb_info
argument_list|)
end_macro

begin_decl_stmt
name|SolFbInfoPtr
name|sol_fb_info
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|fb_rfc
name|rfc
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"solBmCreate\t[solBm.c]\tStart\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|sol_fb_info
operator|->
name|fbfd
operator|=
name|open
argument_list|(
literal|"/dev/fb"
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|Error
argument_list|(
literal|"Can't open /dev/fb"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|sol_fb_info
operator|->
name|fbmapsize
operator|=
operator|(
name|FB_WIDTH
operator|/
literal|8
operator|)
operator|*
name|FB_HEIGHT
expr_stmt|;
name|sol_fb_info
operator|->
name|fbmap
operator|=
operator|(
name|char
operator|*
operator|)
name|mmap
argument_list|(
operator|(
name|caddr_t
operator|)
literal|0
argument_list|,
operator|(
name|size_t
operator|)
name|sol_fb_info
operator|->
name|fbmapsize
argument_list|,
operator|(
name|PROT_READ
operator||
name|PROT_WRITE
operator|)
argument_list|,
name|MAP_SHARED
argument_list|,
name|sol_fb_info
operator|->
name|fbfd
argument_list|,
operator|(
name|off_t
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sol_fb_info
operator|->
name|fbmap
operator|==
operator|(
name|char
operator|*
operator|)
operator|-
literal|1
condition|)
block|{
name|Error
argument_list|(
literal|"Can't mmap /dev/fb"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|sol_fb_info
operator|->
name|plane
operator|=
name|sol_fb_info
operator|->
name|fbmap
operator|+
literal|8
expr_stmt|;
name|rfc
operator|.
name|rfc_hcnt
operator|=
operator|-
literal|249
expr_stmt|;
name|rfc
operator|.
name|rfc_vcnt
operator|=
operator|-
literal|2075
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|sol_fb_info
operator|->
name|fbfd
argument_list|,
name|FBIOSETRFCT
argument_list|,
operator|&
name|rfc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"solBmCreate\t[solBm.c]\tEnd\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|TRUE
return|;
block|}
end_block

begin_function
specifier|static
name|Bool
name|solBmSaveScreen
parameter_list|(
name|pScreen
parameter_list|,
name|on
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
name|Bool
name|on
decl_stmt|;
block|{
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|Bool
name|solBmInit
parameter_list|(
name|index
parameter_list|,
name|pScreen
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|index
decl_stmt|;
name|ScreenPtr
name|pScreen
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|SolFbInfoPtr
name|pFbInfo
decl_stmt|;
specifier|extern
name|miPointerScreenFuncRec
name|solPointerScreenFuncs
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"solBmInit\t[solBm.c]\tStart\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pFbInfo
operator|=
operator|(
name|SolFbInfoPtr
operator|)
name|pScreen
operator|->
name|devPrivates
index|[
name|solScreenIndex
index|]
operator|.
name|ptr
expr_stmt|;
if|if
condition|(
operator|!
name|monitorResolution
condition|)
block|{
name|monitorResolution
operator|=
name|MONO_TV_RESOLUTION
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|mfbScreenInit
argument_list|(
name|pScreen
argument_list|,
operator|(
name|pointer
operator|)
name|pFbInfo
operator|->
name|plane
argument_list|,
name|pFbInfo
operator|->
name|scr_width
argument_list|,
name|pFbInfo
operator|->
name|scr_height
argument_list|,
name|monitorResolution
argument_list|,
name|monitorResolution
argument_list|,
name|pFbInfo
operator|->
name|fb_width
argument_list|)
condition|)
block|{
name|ErrorF
argument_list|(
literal|"mfbScreenInit error.\n"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|pScreen
operator|->
name|whitePixel
operator|=
literal|0
expr_stmt|;
name|pScreen
operator|->
name|blackPixel
operator|=
literal|1
expr_stmt|;
name|miDCInitialize
argument_list|(
name|pScreen
argument_list|,
operator|&
name|solPointerScreenFuncs
argument_list|)
expr_stmt|;
name|mfbCreateDefColormap
argument_list|(
name|pScreen
argument_list|)
expr_stmt|;
name|pScreen
operator|->
name|SaveScreen
operator|=
name|solBmSaveScreen
expr_stmt|;
name|solBmSaveScreen
argument_list|(
name|pScreen
argument_list|,
name|SCREEN_SAVER_FORCER
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"solBmInit\t[solBm.c]\tEnd\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|void
name|solBmGiveUp
parameter_list|(
name|sol_fb_info
parameter_list|)
name|SolFbInfoPtr
name|sol_fb_info
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"solBmGiveUp\t[solBm.c]\tStart\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|sol_fb_info
operator|->
name|fbfd
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"solBmGiveUp\t[solBm.c]\tEnd\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

end_unit


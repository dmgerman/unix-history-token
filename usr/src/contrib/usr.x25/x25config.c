begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1990 The Regents of the University of California.  * All rights reserved.  *  * %sccs.include.redist.c%  *  *	@(#)x25config.c	5.2 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * Configure X.25 interface  *  * Copyright (c) 1986 University of British Columbia  *  * Frank Pronk  * February 1986  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netccitt/x25.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_define
define|#
directive|define
name|IFFBITS
define|\
value|"\020\1UP\2BROADCAST\3DEBUG\4ROUTE\5POINTOPOINT\6NOTRAILERS\7RUNNING\10NOARP"
end_define

begin_decl_stmt
name|int
name|setifflags
argument_list|()
decl_stmt|,
name|setdefault
argument_list|()
decl_stmt|,
name|setnet
argument_list|()
decl_stmt|,
name|setntn
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|setlproto
argument_list|()
decl_stmt|,
name|sethdlc
argument_list|()
decl_stmt|,
name|setlwsize
argument_list|()
decl_stmt|,
name|setltrace
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|setyear
argument_list|()
decl_stmt|,
name|setpwsize
argument_list|()
decl_stmt|,
name|setpacketsize
argument_list|()
decl_stmt|,
name|setmaxlcn
argument_list|()
decl_stmt|,
name|setptrace
argument_list|()
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|cmd
block|{
name|char
modifier|*
name|c_name
decl_stmt|;
name|int
name|c_arg
decl_stmt|;
name|int
function_decl|(
modifier|*
name|c_func
function_decl|)
parameter_list|()
function_decl|;
block|}
name|cmds
index|[]
init|=
block|{
literal|"up"
block|,
name|IFF_UP
block|,
name|setifflags
block|,
literal|"-up"
block|,
operator|-
name|IFF_UP
block|,
name|setifflags
block|,
literal|"down"
block|,
operator|-
name|IFF_UP
block|,
name|setifflags
block|,
literal|"debug"
block|,
name|IFF_DEBUG
block|,
name|setifflags
block|,
literal|"-debug"
block|,
operator|-
name|IFF_DEBUG
block|,
name|setifflags
block|,
literal|"default"
block|,
literal|0
block|,
name|setdefault
block|,
literal|"hdlc"
block|,
name|CCITTPROTO_HDLC
block|,
name|setlproto
block|,
literal|"ieee802llc"
block|,
name|IEEEPROTO_802LLC
block|,
name|setlproto
block|,
literal|"lap"
block|,
name|HDLCPROTO_LAP
block|,
name|sethdlc
block|,
literal|"lapb"
block|,
name|HDLCPROTO_LAPB
block|,
name|sethdlc
block|,
literal|"lapd"
block|,
name|HDLCPROTO_LAPD
block|,
name|sethdlc
block|,
literal|"unset"
block|,
name|HDLCPROTO_UNSET
block|,
name|sethdlc
block|,
literal|"-ltrace"
block|,
literal|0
block|,
name|setltrace
block|,
literal|"ltrace"
block|,
literal|1
block|,
name|setltrace
block|,
literal|"1976"
block|,
name|X25_1976
block|,
name|setyear
block|,
literal|"1980"
block|,
name|X25_1980
block|,
name|setyear
block|,
literal|"1984"
block|,
name|X25_1984
block|,
name|setyear
block|,
literal|"-ptrace"
block|,
literal|0
block|,
name|setptrace
block|,
literal|"ptrace"
block|,
literal|1
block|,
name|setptrace
block|,
literal|"-net"
block|,
literal|0
block|,
name|setnet
block|,
literal|"-ntn"
block|,
literal|0
block|,
name|setntn
block|,
literal|"-lwsize"
block|,
literal|0
block|,
name|setlwsize
block|,
literal|"-pwsize"
block|,
literal|0
block|,
name|setpwsize
block|,
literal|"-psize"
block|,
literal|0
block|,
name|setpacketsize
block|,
literal|"-maxlcn"
block|,
literal|0
block|,
name|setmaxlcn
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|ifreq
name|ifr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ifreq_x25
name|ifrx25
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|x25conf
value|ifrx25.ifr_xc
end_define

begin_decl_stmt
name|char
modifier|*
name|myname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|ifname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* interface name */
end_comment

begin_decl_stmt
name|short
name|ifflags
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* local copy of interface flags */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
specifier|register
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|int
name|argc
decl_stmt|;
block|{
specifier|register
name|int
name|s
decl_stmt|;
name|myname
operator|=
operator|*
name|argv
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|abort
argument_list|(
literal|"usage: x25ifconfig interface [default] [-net net] [-ntn ntn] [-maxlcn maxlcn] [up] [down] [zillions of other options]"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|socket
argument_list|(
name|AF_CCITT
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|syserr
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
name|argv
index|[
name|argc
index|]
operator|=
literal|0
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|ifname
operator|=
operator|*
name|argv
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
name|syserr
argument_list|(
literal|"ioctl (SIOCGIFFLAGS)"
argument_list|)
expr_stmt|;
name|ifflags
operator|=
name|ifr
operator|.
name|ifr_flags
expr_stmt|;
name|strcpy
argument_list|(
name|ifrx25
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFCONF_X25
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ifrx25
argument_list|)
operator|<
literal|0
condition|)
block|{
name|x25conf
operator|.
name|xc_addr
operator|.
name|x25_len
operator|=
sizeof|sizeof
argument_list|(
name|x25conf
argument_list|)
expr_stmt|;
name|x25conf
operator|.
name|xc_addr
operator|.
name|x25_family
operator|=
name|AF_CCITT
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
name|status
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|argv
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|argv
condition|)
block|{
specifier|register
name|struct
name|cmd
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|argneeded
decl_stmt|;
name|argneeded
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|cmds
init|;
condition|;
name|cp
operator|++
control|)
block|{
if|if
condition|(
name|cp
operator|->
name|c_name
operator|==
literal|0
condition|)
name|abort
argument_list|(
literal|"invalid argument: %s"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|->
name|c_func
operator|==
name|setnet
condition|)
name|argneeded
operator|++
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cp
operator|->
name|c_name
argument_list|,
operator|*
name|argv
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argneeded
condition|)
block|{
if|if
condition|(
name|argv
index|[
literal|1
index|]
condition|)
block|{
name|argv
operator|++
expr_stmt|;
call|(
modifier|*
name|cp
operator|->
name|c_func
call|)
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
else|else
name|abort
argument_list|(
literal|"argument expect after %s"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
else|else
call|(
modifier|*
name|cp
operator|->
name|c_func
call|)
argument_list|(
name|cp
operator|->
name|c_arg
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|argv
operator|++
expr_stmt|;
block|}
name|ifr
operator|.
name|ifr_flags
operator|=
name|ifflags
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
name|syserr
argument_list|(
literal|"ioctl (SIOCSIFFLAGS)"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifrx25
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCSIFCONF_X25
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ifrx25
argument_list|)
operator|<
literal|0
condition|)
name|syserr
argument_list|(
literal|"ioctl (SIOCSIFCONF_X25)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* VARARGS */
end_comment

begin_macro
name|abort
argument_list|(
argument|fmt
argument_list|,
argument|a1
argument_list|,
argument|a2
argument_list|,
argument|a3
argument_list|,
argument|a4
argument_list|,
argument|a5
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|fmt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s: %s\n"
argument_list|,
name|myname
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|buf
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* VARARGS */
end_comment

begin_macro
name|syserr
argument_list|(
argument|fmt
argument_list|,
argument|a1
argument_list|,
argument|a2
argument_list|,
argument|a3
argument_list|,
argument|a4
argument_list|,
argument|a5
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|fmt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
specifier|extern
name|int
name|errno
decl_stmt|;
specifier|extern
name|char
modifier|*
name|sys_errlist
index|[]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s: %s: %s\n"
argument_list|,
name|myname
argument_list|,
name|fmt
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|buf
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|status
argument_list|()
end_macro

begin_block
block|{
name|char
modifier|*
name|addr
init|=
name|x25conf
operator|.
name|xc_addr
operator|.
name|x25_addr
decl_stmt|;
name|printf
argument_list|(
literal|"%s: "
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|printb
argument_list|(
literal|"interface flags"
argument_list|,
name|ifflags
argument_list|,
name|IFFBITS
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"link level:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\twindow size: %d\n"
argument_list|,
name|x25conf
operator|.
name|xc_lwsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|x25conf
operator|.
name|xc_ltrace
condition|)
name|printf
argument_list|(
literal|"\ttracing: on\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\npacket level:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\taddress: %04d %s\n"
argument_list|,
name|x25conf
operator|.
name|xc_addr
operator|.
name|x25_net
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\twindow size: %d\n"
argument_list|,
name|x25conf
operator|.
name|xc_pwsize
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tpacket size: %d\n"
argument_list|,
literal|1
operator|<<
name|x25conf
operator|.
name|xc_psize
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax lcn: %d\n"
argument_list|,
name|x25conf
operator|.
name|xc_maxlcn
argument_list|)
expr_stmt|;
if|if
condition|(
name|x25conf
operator|.
name|xc_ptrace
condition|)
name|printf
argument_list|(
literal|"\ttracing: on\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|setifflags
argument_list|(
argument|value
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|value
operator|<
literal|0
condition|)
block|{
name|value
operator|=
operator|-
name|value
expr_stmt|;
name|ifflags
operator|&=
operator|~
name|value
expr_stmt|;
block|}
else|else
name|ifflags
operator||=
name|value
expr_stmt|;
block|}
end_block

begin_comment
comment|/* VARARGS */
end_comment

begin_macro
name|setdefault
argument_list|(
argument|arg
argument_list|)
end_macro

begin_block
block|{
name|x25conf
operator|.
name|xc_addr
operator|.
name|x25_family
operator|=
name|AF_CCITT
expr_stmt|;
name|x25conf
operator|.
name|xc_lproto
operator|=
name|CCITTPROTO_HDLC
expr_stmt|;
name|x25conf
operator|.
name|xc_lptype
operator|=
name|HDLCPROTO_LAPB
expr_stmt|;
name|x25conf
operator|.
name|xc_lwsize
operator|=
literal|7
expr_stmt|;
name|x25conf
operator|.
name|xc_pwsize
operator|=
literal|2
expr_stmt|;
name|x25conf
operator|.
name|xc_psize
operator|=
name|X25_PS128
expr_stmt|;
name|x25conf
operator|.
name|xc_type
operator|=
name|X25_1976
expr_stmt|;
block|}
end_block

begin_macro
name|setnet
argument_list|(
argument|arg
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|net
decl_stmt|;
specifier|register
name|struct
name|netent
modifier|*
name|np
decl_stmt|;
if|if
condition|(
operator|*
name|arg
operator|<
literal|'0'
operator|||
operator|*
name|arg
operator|>
literal|'9'
condition|)
block|{
comment|/* lookup name in /etc/networks */
if|if
condition|(
operator|(
name|np
operator|=
name|getnetbyname
argument_list|(
name|arg
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|abort
argument_list|(
literal|"unknown network (%s)"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|net
operator|=
name|np
operator|->
name|n_net
expr_stmt|;
block|}
else|else
name|net
operator|=
name|atoi
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|x25conf
operator|.
name|xc_addr
operator|.
name|x25_net
operator|=
name|net
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|setntn
argument_list|(
name|arg
argument_list|)
specifier|register
name|char
operator|*
name|arg
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|l
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|hostent
modifier|*
name|getx25hostbyname
parameter_list|()
function_decl|;
if|if
condition|(
operator|*
name|arg
operator|<
literal|'0'
operator|||
operator|*
name|arg
operator|>
literal|'9'
condition|)
block|{
comment|/* lookup in /etc/x25hosts */
if|if
condition|(
operator|(
name|hp
operator|=
name|getx25hostbyname
argument_list|(
name|arg
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|abort
argument_list|(
literal|"can't find '%s' in /etc/x25hosts"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|arg
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_x25
operator|*
operator|)
name|hp
operator|->
name|h_addr
operator|)
operator|->
name|x25_addr
expr_stmt|;
name|l
operator|=
name|strlen
argument_list|(
name|arg
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
else|else
for|for
control|(
name|l
operator|=
literal|1
operator|,
name|p
operator|=
name|arg
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
name|l
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|<
literal|'0'
operator|||
operator|*
name|p
operator|>
literal|'9'
condition|)
name|abort
argument_list|(
literal|"invalid character in ntn address"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|l
operator|>
sizeof|sizeof
argument_list|(
name|x25conf
operator|.
name|xc_addr
operator|.
name|x25_addr
argument_list|)
condition|)
name|abort
argument_list|(
literal|"invalid ntn address"
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arg
argument_list|,
name|x25conf
operator|.
name|xc_addr
operator|.
name|x25_addr
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|to_bcd
argument_list|(
name|src
argument_list|,
name|dest
argument_list|)
specifier|register
name|char
operator|*
name|src
operator|,
operator|*
name|dest
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|*
name|src
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|i
operator|&
literal|0x01
condition|)
operator|*
name|dest
operator|++
operator||=
operator|*
name|src
operator|++
operator|&
literal|0x0F
expr_stmt|;
else|else
operator|*
name|dest
operator|=
operator|*
name|src
operator|++
operator|<<
literal|4
expr_stmt|;
block|}
end_block

begin_macro
name|from_bcd
argument_list|(
argument|src
argument_list|,
argument|dest
argument_list|,
argument|len
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|src
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
operator|/
literal|2
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|dest
operator|++
operator|=
operator|(
operator|(
operator|*
name|src
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
operator|)
operator|+
literal|'0'
expr_stmt|;
operator|*
name|dest
operator|++
operator|=
operator|(
operator|*
name|src
operator|++
operator|&
literal|0xf
operator|)
operator|+
literal|'0'
expr_stmt|;
block|}
operator|*
name|dest
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|setlproto
argument_list|(
argument|arg
argument_list|)
end_macro

begin_block
block|{
name|x25conf
operator|.
name|xc_lproto
operator|=
name|arg
expr_stmt|;
block|}
end_block

begin_macro
name|sethdlc
argument_list|(
argument|arg
argument_list|)
end_macro

begin_block
block|{
name|x25conf
operator|.
name|xc_lptype
operator|=
name|arg
expr_stmt|;
block|}
end_block

begin_macro
name|setlwsize
argument_list|(
argument|arg
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|ws
decl_stmt|;
if|if
condition|(
operator|(
name|ws
operator|=
name|atoi
argument_list|(
name|arg
argument_list|)
operator|)
operator|<=
literal|0
operator|||
name|ws
operator|>
literal|31
condition|)
name|abort
argument_list|(
literal|"invalid link level window size"
argument_list|)
expr_stmt|;
name|x25conf
operator|.
name|xc_lwsize
operator|=
name|ws
expr_stmt|;
block|}
end_block

begin_macro
name|setltrace
argument_list|(
argument|arg
argument_list|)
end_macro

begin_block
block|{
name|x25conf
operator|.
name|xc_ltrace
operator|=
name|arg
expr_stmt|;
block|}
end_block

begin_macro
name|setyear
argument_list|(
argument|arg
argument_list|)
end_macro

begin_block
block|{
name|x25conf
operator|.
name|xc_type
operator|=
name|arg
expr_stmt|;
switch|switch
condition|(
name|arg
condition|)
block|{
case|case
name|X25_1976
case|:
return|return;
case|case
name|X25_1980
case|:
case|case
name|X25_1984
case|:
name|x25conf
operator|.
name|xc_pwsize
operator|=
literal|7
expr_stmt|;
name|x25conf
operator|.
name|xc_psize
operator|=
literal|12
expr_stmt|;
comment|/* 4096 bytes */
block|}
block|}
end_block

begin_macro
name|setpwsize
argument_list|(
argument|arg
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|ws
decl_stmt|;
if|if
condition|(
operator|(
name|ws
operator|=
name|atoi
argument_list|(
name|arg
argument_list|)
operator|)
operator|<=
literal|0
operator|||
name|ws
operator|>
literal|7
condition|)
name|abort
argument_list|(
literal|"invalid packet level window size"
argument_list|)
expr_stmt|;
name|x25conf
operator|.
name|xc_pwsize
operator|=
name|ws
expr_stmt|;
block|}
end_block

begin_macro
name|setpacketsize
argument_list|(
argument|arg
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|psize
decl_stmt|,
name|logpsize
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|psize
operator|=
name|atoi
argument_list|(
name|arg
argument_list|)
operator|)
operator|<
literal|64
operator|||
name|psize
operator|>
literal|4096
condition|)
name|abort
argument_list|(
literal|"invalid packet size"
argument_list|)
expr_stmt|;
while|while
condition|(
name|psize
operator|>
literal|1
condition|)
block|{
name|psize
operator|>>=
literal|1
expr_stmt|;
name|logpsize
operator|++
expr_stmt|;
block|}
name|x25conf
operator|.
name|xc_psize
operator|=
name|logpsize
expr_stmt|;
block|}
end_block

begin_macro
name|setmaxlcn
argument_list|(
argument|arg
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|lcn
decl_stmt|;
if|if
condition|(
operator|(
name|lcn
operator|=
name|atoi
argument_list|(
name|arg
argument_list|)
operator|)
operator|<=
literal|0
condition|)
name|abort
argument_list|(
literal|"invalid maximum lcn"
argument_list|)
expr_stmt|;
name|x25conf
operator|.
name|xc_maxlcn
operator|=
name|lcn
expr_stmt|;
block|}
end_block

begin_macro
name|setptrace
argument_list|(
argument|arg
argument_list|)
end_macro

begin_block
block|{
name|x25conf
operator|.
name|xc_ptrace
operator|=
name|arg
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Print a value a la the %b format of the kernel's printf  */
end_comment

begin_macro
name|printb
argument_list|(
argument|s
argument_list|,
argument|v
argument_list|,
argument|bits
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|char
modifier|*
name|bits
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|unsigned
name|short
name|v
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|any
init|=
literal|0
decl_stmt|;
specifier|register
name|char
name|c
decl_stmt|;
if|if
condition|(
name|bits
operator|&&
operator|*
name|bits
operator|==
literal|8
condition|)
name|printf
argument_list|(
literal|"%s=%o"
argument_list|,
name|s
argument_list|,
name|v
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s=%x"
argument_list|,
name|s
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|bits
operator|++
expr_stmt|;
if|if
condition|(
name|bits
condition|)
block|{
name|putchar
argument_list|(
literal|'<'
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|=
operator|*
name|bits
operator|++
condition|)
block|{
if|if
condition|(
name|v
operator|&
operator|(
literal|1
operator|<<
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|any
condition|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|any
operator|=
literal|1
expr_stmt|;
for|for
control|(
init|;
operator|(
name|c
operator|=
operator|*
name|bits
operator|)
operator|>
literal|32
condition|;
name|bits
operator|++
control|)
name|putchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
else|else
for|for
control|(
init|;
operator|*
name|bits
operator|>
literal|32
condition|;
name|bits
operator|++
control|)
empty_stmt|;
block|}
name|putchar
argument_list|(
literal|'>'
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit


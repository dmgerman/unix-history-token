begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ufn_aei.c - user-friendly aei lookup */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/dsap/common/RCS/ufn_aet.c,v 7.3 91/02/22 09:20:41 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/dsap/common/RCS/ufn_aet.c,v 7.3 91/02/22 09:20:41 mrose Interim $  *  *  * $Log:	ufn_aet.c,v $  * Revision 7.3  91/02/22  09:20:41  mrose  * Interim 6.8  *   * Revision 7.2  90/10/17  11:43:06  mrose  * sync  *   * Revision 7.1  90/07/09  14:35:17  mrose  * sync  *   * Revision 7.0  90/06/20  08:40:43  mrose  * *** empty log message ***  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|"quipu/ufn.h"
end_include

begin_include
include|#
directive|include
file|"quipu/list.h"
end_include

begin_include
include|#
directive|include
file|"quipu/ds_search.h"
end_include

begin_include
include|#
directive|include
file|"quipu/connection.h"
end_include

begin_comment
comment|/* ds_search uses di_block - include this for lint !!! */
end_comment

begin_include
include|#
directive|include
file|"quipu/dua.h"
end_include

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|log_dsap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|addr_log
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|Filter
name|ocfilter
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|Filter
name|joinfilter
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|char
name|PY_pepy
index|[]
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|PY_advise
parameter_list|()
function_decl|;
end_function_decl

begin_function
specifier|static
name|Filter
name|aet_filter
parameter_list|(
name|context
parameter_list|)
name|char
modifier|*
name|context
decl_stmt|;
block|{
name|Filter
name|a
decl_stmt|,
name|b
decl_stmt|;
if|if
condition|(
operator|(
name|a
operator|=
name|ocfilter
argument_list|(
literal|"ApplicationEntity"
argument_list|)
operator|)
operator|==
name|NULLFILTER
condition|)
return|return
name|NULLFILTER
return|;
name|b
operator|=
name|filter_alloc
argument_list|()
expr_stmt|;
name|b
operator|->
name|flt_next
operator|=
name|a
expr_stmt|;
name|b
operator|->
name|flt_type
operator|=
name|FILTER_ITEM
expr_stmt|;
name|b
operator|->
name|FUITEM
operator|.
name|fi_type
operator|=
name|FILTERITEM_EQUALITY
expr_stmt|;
if|if
condition|(
operator|(
name|b
operator|->
name|FUITEM
operator|.
name|UNAVA
operator|.
name|ava_type
operator|=
name|AttrT_new
argument_list|(
name|APPLCTX_OID
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|LLOG
argument_list|(
argument|log_dsap
argument_list|,
argument|LLOG_EXCEPTIONS
argument_list|,
argument|(
literal|"supported application context attribute unknown"
argument|)
argument_list|)
return|return
name|NULLFILTER
return|;
block|}
name|b
operator|->
name|FUITEM
operator|.
name|UNAVA
operator|.
name|ava_value
operator|=
name|str2AttrV
argument_list|(
name|context
argument_list|,
name|b
operator|->
name|FUITEM
operator|.
name|UNAVA
operator|.
name|ava_type
operator|->
name|oa_syntax
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|FUITEM
operator|.
name|UNAVA
operator|.
name|ava_value
operator|==
name|NULLAttrV
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"'%s' unknown OID"
operator|,
name|context
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULLFILTER
return|;
block|}
return|return
name|joinfilter
argument_list|(
name|b
argument_list|,
name|FILTER_AND
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|aet_search
argument_list|(
argument|base
argument_list|,
argument|subtree
argument_list|,
argument|filt
argument_list|,
argument|res
argument_list|)
name|DN
name|base
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
name|subtree
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Filter
name|filt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DNS
modifier|*
name|res
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|ds_search_arg
name|search_arg
decl_stmt|;
specifier|static
name|struct
name|ds_search_result
name|result
decl_stmt|;
name|struct
name|DSError
name|err
decl_stmt|;
specifier|static
name|CommonArgs
name|ca
init|=
name|default_common_args
decl_stmt|;
name|EntryInfo
modifier|*
name|ptr
decl_stmt|;
name|DNS
name|newdns
decl_stmt|,
name|r
init|=
name|NULLDNS
decl_stmt|;
name|search_arg
operator|.
name|sra_baseobject
operator|=
name|base
expr_stmt|;
name|search_arg
operator|.
name|sra_filter
operator|=
name|filt
expr_stmt|;
if|if
condition|(
name|subtree
condition|)
name|search_arg
operator|.
name|sra_subset
operator|=
name|SRA_WHOLESUBTREE
expr_stmt|;
else|else
name|search_arg
operator|.
name|sra_subset
operator|=
name|SRA_ONELEVEL
expr_stmt|;
name|search_arg
operator|.
name|sra_searchaliases
operator|=
name|TRUE
expr_stmt|;
name|search_arg
operator|.
name|sra_common
operator|=
name|ca
expr_stmt|;
comment|/* struct copy */
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_infotypes
operator|=
name|TRUE
expr_stmt|;
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_allattributes
operator|=
name|TRUE
expr_stmt|;
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_select
operator|=
name|NULLATTR
expr_stmt|;
if|if
condition|(
name|ds_search
argument_list|(
operator|&
name|search_arg
argument_list|,
operator|&
name|err
argument_list|,
operator|&
name|result
argument_list|)
operator|!=
name|DS_OK
condition|)
block|{
name|log_ds_error
argument_list|(
operator|&
name|err
argument_list|)
expr_stmt|;
name|ds_error_free
argument_list|(
operator|&
name|err
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|correlate_search_results
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
name|dn_free
argument_list|(
name|result
operator|.
name|CSR_object
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|result
operator|.
name|CSR_limitproblem
operator|!=
name|LSR_NOLIMITPROBLEM
operator|)
operator|||
operator|(
name|result
operator|.
name|CSR_cr
operator|!=
name|NULLCONTINUATIONREF
operator|)
condition|)
block|{
name|crefs_free
argument_list|(
name|result
operator|.
name|CSR_cr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
operator|.
name|CSR_entries
condition|)
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|ptr
operator|=
name|result
operator|.
name|CSR_entries
init|;
name|ptr
operator|!=
name|NULLENTRYINFO
condition|;
name|ptr
operator|=
name|ptr
operator|->
name|ent_next
control|)
block|{
name|cache_entry
argument_list|(
name|ptr
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|newdns
operator|=
name|dn_seq_alloc
argument_list|()
expr_stmt|;
name|newdns
operator|->
name|dns_next
operator|=
name|r
expr_stmt|;
name|newdns
operator|->
name|dns_dn
operator|=
name|dn_cpy
argument_list|(
name|ptr
operator|->
name|ent_dn
argument_list|)
expr_stmt|;
name|r
operator|=
name|newdns
expr_stmt|;
block|}
name|entryinfo_free
argument_list|(
name|result
operator|.
name|CSR_entries
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|res
operator|=
name|r
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_block

begin_macro
name|aet_match
argument_list|(
argument|c
argument_list|,
argument|v
argument_list|,
argument|interact
argument_list|,
argument|result
argument_list|,
argument|el
argument_list|,
argument|context
argument_list|)
end_macro

begin_decl_stmt
name|int
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DNS
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|envlist
name|el
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|context
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|DNS
name|ufnr
init|=
name|NULLDNS
decl_stmt|;
name|DNS
name|newap
init|=
name|NULLDNS
decl_stmt|;
name|DNS
name|apps
init|=
name|NULLDNS
decl_stmt|;
name|DNS
name|dns
decl_stmt|,
name|DNS_append
argument_list|()
decl_stmt|;
name|Filter
name|filt
decl_stmt|;
name|int
name|ok
init|=
name|TRUE
decl_stmt|;
if|if
condition|(
operator|!
name|ufn_match
argument_list|(
name|c
argument_list|,
name|v
argument_list|,
name|interact
argument_list|,
operator|&
name|ufnr
argument_list|,
name|el
argument_list|)
condition|)
block|{
if|if
condition|(
name|PY_pepy
index|[
literal|0
index|]
condition|)
block|{
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"ufn_match failed: %s"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|PY_pepy
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|SLOG
argument_list|(
name|addr_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
operator|(
literal|"%s"
operator|,
name|PY_pepy
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|result
operator|=
name|NULLDNS
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|filt
operator|=
name|aet_filter
argument_list|(
name|context
argument_list|)
expr_stmt|;
for|for
control|(
name|dns
operator|=
name|ufnr
init|;
name|dns
operator|!=
name|NULLDNS
condition|;
name|dns
operator|=
name|dns
operator|->
name|dns_next
control|)
block|{
name|newap
operator|=
name|NULLDNS
expr_stmt|;
if|if
condition|(
name|aet_search
argument_list|(
name|dns
operator|->
name|dns_dn
argument_list|,
name|FALSE
argument_list|,
name|filt
argument_list|,
operator|&
name|newap
argument_list|)
condition|)
name|apps
operator|=
name|DNS_append
argument_list|(
name|apps
argument_list|,
name|newap
argument_list|)
expr_stmt|;
else|else
name|ok
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|apps
operator|==
name|NULLDNS
operator|)
operator|&&
name|ok
condition|)
block|{
comment|/* go deeper */
for|for
control|(
name|dns
operator|=
name|ufnr
init|;
name|dns
operator|!=
name|NULLDNS
condition|;
name|dns
operator|=
name|dns
operator|->
name|dns_next
control|)
block|{
if|if
condition|(
name|dns
operator|->
name|dns_dn
operator|->
name|dn_parent
operator|==
name|NULLDN
condition|)
comment|/* too high for subtree search */
continue|continue;
name|newap
operator|=
name|NULLDNS
expr_stmt|;
if|if
condition|(
name|aet_search
argument_list|(
name|dns
operator|->
name|dns_dn
argument_list|,
name|TRUE
argument_list|,
name|filt
argument_list|,
operator|&
name|newap
argument_list|)
condition|)
name|apps
operator|=
name|DNS_append
argument_list|(
name|apps
argument_list|,
name|newap
argument_list|)
expr_stmt|;
else|else
name|ok
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|ok
operator|&&
operator|!
name|apps
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"search for applicationEntity supporting \"%s\" failed"
argument_list|,
name|context
argument_list|)
expr_stmt|;
name|SLOG
argument_list|(
name|addr_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
operator|(
literal|"%s"
operator|,
name|PY_pepy
operator|)
argument_list|)
expr_stmt|;
block|}
name|filter_free
argument_list|(
name|filt
argument_list|)
expr_stmt|;
name|dn_seq_free
argument_list|(
name|ufnr
argument_list|)
expr_stmt|;
operator|*
name|result
operator|=
name|apps
expr_stmt|;
return|return
name|ok
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* xwho.c - who for X windows */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/others/quipu/image/RCS/xwho.c,v 7.1 91/02/22 09:33:30 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/others/quipu/image/RCS/xwho.c,v 7.1 91/02/22 09:33:30 mrose Interim $  *  *  * $Log:	xwho.c,v $  * Revision 7.1  91/02/22  09:33:30  mrose  * Interim 6.8  *   * Revision 7.0  89/11/23  22:00:06  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"imagesbr.h"
end_include

begin_include
include|#
directive|include
file|<X11/Xlib.h>
end_include

begin_include
include|#
directive|include
file|<X11/Xutil.h>
end_include

begin_include
include|#
directive|include
file|"rwhod.h"
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|"usr.dirent.h"
end_include

begin_define
define|#
directive|define
name|NHOSTS
value|100
end_define

begin_comment
comment|/*
comment|DATA */
end_comment

begin_decl_stmt
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|errsw
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sleepsw
init|=
literal|60
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|host_list
index|[
name|NHOSTS
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Hosts to (not) list */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|host_end
init|=
name|host_list
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|dont_list
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|myname
init|=
literal|"xwho"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|display
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|geometry
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_typedef
typedef|typedef
struct|struct
name|_frame
block|{
name|short
name|x
decl_stmt|,
name|y
decl_stmt|;
name|unsigned
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|unsigned
name|int
name|bdrwidth
decl_stmt|;
name|unsigned
name|long
name|border
decl_stmt|;
name|unsigned
name|long
name|background
decl_stmt|;
block|}
name|OpaqueFrame
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|Display
modifier|*
name|DISP
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|SCRN
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|mapped
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Window
name|mywindow
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|OpaqueFrame
name|myframe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|fontname
init|=
literal|"6x10"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|XFontStruct
modifier|*
name|myfont
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|bwidth
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|XSizeHints
name|hints
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|XSetWindowAttributes
name|xswattrs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|long
name|xswattrs_mask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|long
name|backpix
decl_stmt|,
name|bdrpix
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|GC
name|forepix
decl_stmt|,
name|highpix
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|face
block|{
name|char
name|f_name
index|[
literal|8
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|f_active
decl_stmt|;
name|int
name|f_update
decl_stmt|;
name|Window
name|f_window
decl_stmt|;
name|OpaqueFrame
name|f_frame
decl_stmt|;
name|struct
name|type_IMAGE_Image
modifier|*
name|f_imap
decl_stmt|;
name|struct
name|face
modifier|*
name|f_next
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|host
block|{
name|char
name|h_name
index|[
literal|32
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|h_up
decl_stmt|;
name|int
name|h_update
decl_stmt|;
name|char
name|h_string
index|[
literal|32
operator|+
literal|2
index|]
decl_stmt|;
name|Window
name|h_window
decl_stmt|;
name|GC
name|h_gc
decl_stmt|;
name|int
name|h_ascent
decl_stmt|;
name|OpaqueFrame
name|h_frame
decl_stmt|;
name|struct
name|face
modifier|*
name|h_faces
decl_stmt|;
name|struct
name|host
modifier|*
name|h_next
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|int
name|largest_h
decl_stmt|,
name|largest_w
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|host
modifier|*
name|hosts
decl_stmt|;
end_decl_stmt

begin_function_decl
name|long
name|time
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|MAIN */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|envp
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|,
decl|*
modifier|*
name|envp
decl_stmt|;
end_function

begin_block
block|{
name|int
name|nfds
decl_stmt|;
name|fd_set
name|rfds
decl_stmt|;
name|arginit
argument_list|(
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|errsw
condition|)
name|errsw
operator|=
name|NOTOK
expr_stmt|;
name|update_X
argument_list|()
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|rfds
argument_list|)
expr_stmt|;
name|nfds
operator|=
name|ConnectionNumber
argument_list|(
name|DISP
argument_list|)
operator|+
literal|1
expr_stmt|;
name|FD_SET
argument_list|(
name|ConnectionNumber
argument_list|(
name|DISP
argument_list|)
argument_list|,
operator|&
name|rfds
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|fd_set
name|ifds
decl_stmt|;
name|ifds
operator|=
name|rfds
expr_stmt|;
operator|(
name|void
operator|)
name|xselect
argument_list|(
name|nfds
argument_list|,
operator|&
name|ifds
argument_list|,
name|NULLFD
argument_list|,
name|NULLFD
argument_list|,
name|sleepsw
argument_list|)
expr_stmt|;
name|update_X
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|ARGINIT */
end_comment

begin_macro
name|arginit
argument_list|(
argument|vec
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|vec
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|n
decl_stmt|,
name|nhosts
decl_stmt|;
specifier|register
name|char
modifier|*
name|ap
decl_stmt|,
modifier|*
name|cp
decl_stmt|,
modifier|*
name|lp
decl_stmt|;
specifier|register
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
if|if
condition|(
name|myname
operator|=
name|rindex
argument_list|(
operator|*
name|vec
argument_list|,
literal|'/'
argument_list|)
condition|)
name|myname
operator|++
expr_stmt|;
if|if
condition|(
name|myname
operator|==
name|NULL
operator|||
operator|*
name|myname
operator|==
name|NULL
condition|)
name|myname
operator|=
operator|*
name|vec
expr_stmt|;
name|isodetailor
argument_list|(
name|myname
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|lp
operator|=
name|NULL
expr_stmt|;
name|nhosts
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|vec
operator|++
init|;
name|ap
operator|=
operator|*
name|vec
condition|;
name|vec
operator|++
control|)
if|if
condition|(
operator|*
name|ap
operator|==
literal|'-'
condition|)
switch|switch
condition|(
operator|*
operator|++
name|ap
condition|)
block|{
case|case
literal|'d'
case|:
name|debug
operator|++
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|errsw
operator|++
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
if|if
condition|(
operator|(
name|lp
operator|=
operator|*
operator|++
name|vec
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"usage: %s -h local_dit"
argument_list|,
name|myname
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|recording
operator|++
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
if|if
condition|(
operator|(
name|ap
operator|=
operator|*
operator|++
name|vec
operator|)
operator|==
name|NULL
operator|||
name|sscanf
argument_list|(
name|ap
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|sleepsw
argument_list|)
operator|!=
literal|1
operator|||
name|sleepsw
operator|<
literal|1
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"usage: %s -s seconds"
argument_list|,
name|myname
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|dont_list
operator|++
expr_stmt|;
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown switch -%s"
argument_list|,
name|ap
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|ap
operator|==
literal|'='
condition|)
name|geometry
operator|=
name|ap
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|cp
operator|=
name|rindex
argument_list|(
name|ap
argument_list|,
literal|':'
argument_list|)
operator|)
operator|&&
name|sscanf
argument_list|(
operator|++
name|cp
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|n
argument_list|)
operator|==
literal|1
condition|)
name|display
operator|=
name|ap
expr_stmt|;
else|else
block|{
if|if
condition|(
name|nhosts
operator|++
operator|>=
name|NHOSTS
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"too many hosts"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hp
operator|=
name|gethostbyname
argument_list|(
name|ap
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: unknown host"
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ap
operator|=
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|strlen
argument_list|(
name|hp
operator|->
name|h_name
argument_list|)
operator|+
literal|1
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
operator|*
name|host_end
operator|++
operator|=
name|ap
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
block|}
name|init_aka
argument_list|(
name|myname
argument_list|,
literal|1
argument_list|,
name|lp
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|ll_dbinit
argument_list|(
name|pgm_log
argument_list|,
name|myname
argument_list|)
expr_stmt|;
else|else
name|ll_hdinit
argument_list|(
name|pgm_log
argument_list|,
name|myname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ll_open
argument_list|(
name|pgm_log
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|DISP
operator|=
name|XOpenDisplay
argument_list|(
name|display
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to open display \"%s\""
argument_list|,
name|XDisplayName
argument_list|(
name|display
argument_list|)
argument_list|)
expr_stmt|;
name|SCRN
operator|=
name|DefaultScreen
argument_list|(
name|DISP
argument_list|)
expr_stmt|;
name|forepix
operator|=
name|XCreateGC
argument_list|(
name|DISP
argument_list|,
name|RootWindow
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
argument_list|,
literal|0L
argument_list|,
operator|(
name|XGCValues
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|highpix
operator|=
name|XCreateGC
argument_list|(
name|DISP
argument_list|,
name|RootWindow
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
argument_list|,
literal|0L
argument_list|,
operator|(
name|XGCValues
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|XCopyGC
argument_list|(
name|DISP
argument_list|,
name|DefaultGC
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
argument_list|,
operator|(
literal|1L
operator|<<
operator|(
name|GCLastBit
operator|+
literal|1
operator|)
operator|)
operator|-
literal|1
argument_list|,
name|forepix
argument_list|)
expr_stmt|;
name|XCopyGC
argument_list|(
name|DISP
argument_list|,
name|DefaultGC
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
argument_list|,
operator|(
literal|1L
operator|<<
operator|(
name|GCLastBit
operator|+
literal|1
operator|)
operator|)
operator|-
literal|1
argument_list|,
name|highpix
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|XGetDefault
argument_list|(
name|DISP
argument_list|,
name|myname
argument_list|,
literal|"ReverseVideo"
argument_list|)
operator|)
operator|&&
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|XSetForeground
argument_list|(
name|DISP
argument_list|,
name|forepix
argument_list|,
name|WhitePixel
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
argument_list|)
expr_stmt|;
name|XSetForeground
argument_list|(
name|DISP
argument_list|,
name|highpix
argument_list|,
name|WhitePixel
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
argument_list|)
expr_stmt|;
name|backpix
operator|=
name|BlackPixel
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
expr_stmt|;
name|bdrpix
operator|=
name|WhitePixel
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
expr_stmt|;
name|XSetFunction
argument_list|(
name|DISP
argument_list|,
name|forepix
argument_list|,
name|GXcopyInverted
argument_list|)
expr_stmt|;
name|XSetFunction
argument_list|(
name|DISP
argument_list|,
name|highpix
argument_list|,
name|GXand
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|XSetForeground
argument_list|(
name|DISP
argument_list|,
name|forepix
argument_list|,
name|BlackPixel
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
argument_list|)
expr_stmt|;
name|XSetForeground
argument_list|(
name|DISP
argument_list|,
name|highpix
argument_list|,
name|BlackPixel
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
argument_list|)
expr_stmt|;
name|backpix
operator|=
name|WhitePixel
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
expr_stmt|;
name|bdrpix
operator|=
name|BlackPixel
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
expr_stmt|;
name|XSetFunction
argument_list|(
name|DISP
argument_list|,
name|forepix
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
name|XSetFunction
argument_list|(
name|DISP
argument_list|,
name|highpix
argument_list|,
name|GXor
argument_list|)
expr_stmt|;
block|}
name|XSetBackground
argument_list|(
name|DISP
argument_list|,
name|forepix
argument_list|,
name|backpix
argument_list|)
expr_stmt|;
name|XSetBackground
argument_list|(
name|DISP
argument_list|,
name|highpix
argument_list|,
name|backpix
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|=
name|XGetDefault
argument_list|(
name|DISP
argument_list|,
name|myname
argument_list|,
literal|"BorderWidth"
argument_list|)
condition|)
name|bwidth
operator|=
name|atoi
argument_list|(
name|cp
argument_list|)
expr_stmt|;
else|else
name|bwidth
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|cp
operator|=
name|XGetDefault
argument_list|(
name|DISP
argument_list|,
name|myname
argument_list|,
literal|"BodyFont"
argument_list|)
condition|)
name|fontname
operator|=
name|cp
expr_stmt|;
name|myfont
operator|=
name|XLoadQueryFont
argument_list|(
name|DISP
argument_list|,
name|fontname
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|XWINDOWS */
end_comment

begin_expr_stmt
specifier|static
name|update_X
argument_list|()
block|{
specifier|register
expr|struct
name|host
operator|*
name|hp
block|;
specifier|register
expr|struct
name|face
operator|*
name|fp
block|;
name|XGCValues
name|gcvalues
block|;
name|service_X
argument_list|()
block|;
if|if
condition|(
name|mywindow
operator|&&
operator|!
name|mapped
condition|)
return|return;
name|read_X
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|layout_X
argument_list|()
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|mywindow
operator|==
name|NULL
condition|)
name|init_X
argument_list|()
expr_stmt|;
end_if

begin_for
for|for
control|(
name|hp
operator|=
name|hosts
init|;
name|hp
condition|;
name|hp
operator|=
name|hp
operator|->
name|h_next
control|)
block|{
if|if
condition|(
name|hp
operator|->
name|h_update
operator|&&
name|display_this_host
argument_list|(
name|hp
operator|->
name|h_name
argument_list|)
condition|)
block|{
if|if
condition|(
name|hp
operator|->
name|h_window
condition|)
block|{
name|XFreeGC
argument_list|(
name|DISP
argument_list|,
name|hp
operator|->
name|h_gc
argument_list|)
expr_stmt|;
name|XDestroyWindow
argument_list|(
name|DISP
argument_list|,
name|hp
operator|->
name|h_window
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %dx%d+%d+%d/%d\n"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|width
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|height
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|x
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|y
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|bdrwidth
argument_list|)
expr_stmt|;
name|hp
operator|->
name|h_window
operator|=
name|XCreateSimpleWindow
argument_list|(
name|DISP
argument_list|,
name|mywindow
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|x
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|y
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|width
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|height
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|bdrwidth
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|border
argument_list|,
name|hp
operator|->
name|h_frame
operator|.
name|background
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|DISP
argument_list|,
name|hp
operator|->
name|h_window
argument_list|,
name|ExposureMask
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|DISP
argument_list|,
name|hp
operator|->
name|h_window
argument_list|)
expr_stmt|;
name|gcvalues
operator|.
name|foreground
operator|=
name|bdrpix
expr_stmt|;
name|gcvalues
operator|.
name|background
operator|=
name|backpix
expr_stmt|;
name|gcvalues
operator|.
name|font
operator|=
name|myfont
operator|->
name|fid
expr_stmt|;
name|hp
operator|->
name|h_gc
operator|=
name|XCreateGC
argument_list|(
name|DISP
argument_list|,
name|hp
operator|->
name|h_window
argument_list|,
name|GCForeground
operator||
name|GCBackground
operator||
name|GCFont
argument_list|,
operator|&
name|gcvalues
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|fp
operator|=
name|hp
operator|->
name|h_faces
init|;
name|fp
condition|;
name|fp
operator|=
name|fp
operator|->
name|f_next
control|)
if|if
condition|(
name|fp
operator|->
name|f_update
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|f_window
condition|)
name|XDestroyWindow
argument_list|(
name|DISP
argument_list|,
name|fp
operator|->
name|f_window
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %dx%d+%d+%d/%d\n"
argument_list|,
name|fp
operator|->
name|f_name
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|width
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|height
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|x
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|y
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|bdrwidth
argument_list|)
expr_stmt|;
name|fp
operator|->
name|f_window
operator|=
name|XCreateSimpleWindow
argument_list|(
name|DISP
argument_list|,
name|mywindow
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|x
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|y
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|width
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|height
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|bdrwidth
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|border
argument_list|,
name|fp
operator|->
name|f_frame
operator|.
name|background
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|DISP
argument_list|,
name|fp
operator|->
name|f_window
argument_list|,
name|ExposureMask
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|DISP
argument_list|,
name|fp
operator|->
name|f_window
argument_list|)
expr_stmt|;
block|}
block|}
end_for

begin_expr_stmt
name|service_X
argument_list|()
expr_stmt|;
end_expr_stmt

begin_comment
unit|}
comment|/*
comment|*/
end_comment

begin_function
unit|static
name|int
name|service_X
parameter_list|()
block|{
name|int
name|wh
decl_stmt|,
name|ww
decl_stmt|;
specifier|register
name|Window
name|w
decl_stmt|;
specifier|register
name|struct
name|face
modifier|*
name|fp
decl_stmt|;
specifier|register
name|struct
name|host
modifier|*
name|hp
decl_stmt|;
name|XEvent
name|xevent
decl_stmt|;
specifier|register
name|XEvent
modifier|*
name|xe
init|=
operator|&
name|xevent
decl_stmt|;
while|while
condition|(
name|XPending
argument_list|(
name|DISP
argument_list|)
condition|)
block|{
name|XNextEvent
argument_list|(
name|DISP
argument_list|,
name|xe
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|xe
operator|->
name|type
condition|)
block|{
case|case
name|Expose
case|:
if|if
condition|(
operator|(
name|w
operator|=
operator|(
operator|(
name|XExposeEvent
operator|*
operator|)
name|xe
operator|)
operator|->
name|window
operator|)
operator|==
name|mywindow
condition|)
block|{
name|display_top
argument_list|()
expr_stmt|;
break|break;
block|}
for|for
control|(
name|hp
operator|=
name|hosts
init|;
name|hp
condition|;
name|hp
operator|=
name|hp
operator|->
name|h_next
control|)
block|{
if|if
condition|(
operator|!
name|display_this_host
argument_list|(
name|hp
operator|->
name|h_name
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|hp
operator|->
name|h_window
operator|==
name|w
condition|)
block|{
name|display_host
argument_list|(
name|hp
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|fp
operator|=
name|hp
operator|->
name|h_faces
init|;
name|fp
condition|;
name|fp
operator|=
name|fp
operator|->
name|f_next
control|)
if|if
condition|(
name|fp
operator|->
name|f_window
operator|==
name|w
condition|)
break|break;
if|if
condition|(
name|fp
condition|)
block|{
name|display_face
argument_list|(
name|fp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
name|MapNotify
case|:
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"MapNotify\n"
argument_list|)
expr_stmt|;
name|mapped
operator|=
literal|1
expr_stmt|;
name|display_top
argument_list|()
expr_stmt|;
break|break;
case|case
name|ConfigureNotify
case|:
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ConfigureNotify %dx%d\n"
argument_list|,
operator|(
operator|(
name|XConfigureEvent
operator|*
operator|)
name|xe
operator|)
operator|->
name|height
argument_list|,
operator|(
operator|(
name|XConfigureEvent
operator|*
operator|)
name|xe
operator|)
operator|->
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|XConfigureEvent
operator|*
operator|)
name|xe
operator|)
operator|->
name|window
operator|==
name|mywindow
operator|&&
operator|(
name|wh
operator|=
operator|(
operator|(
name|XConfigureEvent
operator|*
operator|)
name|xe
operator|)
operator|->
name|height
operator|)
operator|>
literal|0
operator|&&
operator|(
name|ww
operator|=
operator|(
operator|(
name|XConfigureEvent
operator|*
operator|)
name|xe
operator|)
operator|->
name|width
operator|)
operator|>
literal|0
condition|)
name|myframe
operator|.
name|height
operator|=
name|wh
operator|,
name|myframe
operator|.
name|width
operator|=
name|ww
expr_stmt|;
break|break;
case|case
name|UnmapNotify
case|:
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"UnmapNotify\n"
argument_list|)
expr_stmt|;
name|mapped
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ReparentNotify
case|:
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ReparentNotify\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Event %d\n"
argument_list|,
name|xe
operator|->
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|init_X
argument_list|()
block|{
name|char
name|def
index|[
name|BUFSIZ
index|]
block|;
name|myframe
operator|.
name|bdrwidth
operator|=
name|bwidth
block|;
name|myframe
operator|.
name|height
operator|=
name|largest_h
operator|+
literal|100
block|;
if|if
condition|(
name|myframe
operator|.
name|height
operator|+
name|bwidth
operator|*
literal|2
operator|>
name|DisplayHeight
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
condition|)
name|myframe
operator|.
name|height
operator|=
name|DisplayHeight
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
operator|-
name|bwidth
operator|*
literal|2
expr_stmt|;
name|myframe
operator|.
name|width
operator|=
name|largest_w
operator|+
literal|100
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|myframe
operator|.
name|width
operator|+
name|bwidth
operator|*
literal|2
operator|>
name|DisplayWidth
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
condition|)
name|myframe
operator|.
name|width
operator|=
name|DisplayWidth
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
operator|-
name|bwidth
operator|*
literal|2
expr_stmt|;
end_if

begin_expr_stmt
name|myframe
operator|.
name|x
operator|=
name|DisplayWidth
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
operator|-
operator|(
name|myframe
operator|.
name|width
operator|+
name|bwidth
operator|*
literal|2
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|myframe
operator|.
name|y
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_expr_stmt
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|def
argument_list|,
literal|"=%dx%d+%d+%d"
argument_list|,
name|myframe
operator|.
name|width
argument_list|,
name|myframe
operator|.
name|height
argument_list|,
name|myframe
operator|.
name|x
argument_list|,
name|myframe
operator|.
name|y
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"def: %s, myframe: =%dx%d+%d+%d/%d\n"
argument_list|,
name|def
argument_list|,
name|myframe
operator|.
name|width
argument_list|,
name|myframe
operator|.
name|height
argument_list|,
name|myframe
operator|.
name|x
argument_list|,
name|myframe
operator|.
name|y
argument_list|,
name|myframe
operator|.
name|bdrwidth
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|hints
operator|.
name|width
operator|=
name|largest_w
operator|+
literal|100
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|hints
operator|.
name|height
operator|=
name|largest_h
operator|+
literal|100
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|hints
operator|.
name|x
operator|=
name|hints
operator|.
name|y
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|hints
operator|.
name|flags
operator|=
name|PSize
operator||
name|PPosition
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|xswattrs
operator|.
name|border_pixel
operator|=
name|bdrpix
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|xswattrs
operator|.
name|background_pixel
operator|=
name|backpix
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|xswattrs_mask
operator|=
name|CWBackPixel
operator||
name|CWBorderPixel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|mywindow
operator|=
name|XCreateWindow
argument_list|(
name|DISP
argument_list|,
name|RootWindow
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
argument_list|,
name|myframe
operator|.
name|x
argument_list|,
name|myframe
operator|.
name|y
argument_list|,
name|myframe
operator|.
name|width
argument_list|,
name|myframe
operator|.
name|height
argument_list|,
name|myframe
operator|.
name|bdrwidth
argument_list|,
literal|0
argument_list|,
name|InputOutput
argument_list|,
operator|(
name|Visual
operator|*
operator|)
name|CopyFromParent
argument_list|,
name|xswattrs_mask
argument_list|,
operator|&
name|xswattrs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|XSetStandardProperties
argument_list|(
name|DISP
argument_list|,
name|mywindow
argument_list|,
name|myname
argument_list|,
literal|"X Who"
argument_list|,
name|None
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|hints
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|XSelectInput
argument_list|(
name|DISP
argument_list|,
name|mywindow
argument_list|,
name|ExposureMask
operator||
name|StructureNotifyMask
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|XMapWindow
argument_list|(
name|DISP
argument_list|,
name|mywindow
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|mapped
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_comment
unit|}
comment|/*
comment|*/
end_comment

begin_macro
unit|static
name|layout_X
argument_list|()
end_macro

begin_block
block|{
name|int
name|h
decl_stmt|;
specifier|register
name|struct
name|face
modifier|*
name|fp
decl_stmt|;
specifier|register
name|struct
name|host
modifier|*
name|hp
decl_stmt|;
name|XCharStruct
name|mychar
decl_stmt|;
name|h
operator|=
name|largest_w
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|hp
operator|=
name|hosts
init|;
name|hp
condition|;
name|hp
operator|=
name|hp
operator|->
name|h_next
control|)
block|{
name|int
name|hh
decl_stmt|,
name|hw
decl_stmt|;
name|hh
operator|=
name|hw
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|hp
operator|->
name|h_window
operator|==
name|NULL
operator|||
name|hp
operator|->
name|h_frame
operator|.
name|y
operator|!=
name|h
condition|)
block|{
name|int
name|direction_return
decl_stmt|,
name|font_ascent_return
decl_stmt|,
name|font_descent_return
decl_stmt|;
name|hp
operator|->
name|h_frame
operator|.
name|bdrwidth
operator|=
literal|2
expr_stmt|;
name|XTextExtents
argument_list|(
name|myfont
argument_list|,
name|hp
operator|->
name|h_string
argument_list|,
name|strlen
argument_list|(
name|hp
operator|->
name|h_string
argument_list|)
argument_list|,
operator|&
name|direction_return
argument_list|,
operator|&
name|font_ascent_return
argument_list|,
operator|&
name|font_descent_return
argument_list|,
operator|&
name|mychar
argument_list|)
expr_stmt|;
name|hp
operator|->
name|h_ascent
operator|=
name|mychar
operator|.
name|ascent
expr_stmt|;
name|hp
operator|->
name|h_frame
operator|.
name|height
operator|=
name|mychar
operator|.
name|ascent
operator|+
name|mychar
operator|.
name|descent
expr_stmt|;
name|hp
operator|->
name|h_frame
operator|.
name|border
operator|=
name|backpix
expr_stmt|;
name|hp
operator|->
name|h_frame
operator|.
name|background
operator|=
name|backpix
expr_stmt|;
name|hp
operator|->
name|h_frame
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|hp
operator|->
name|h_frame
operator|.
name|y
operator|=
name|h
expr_stmt|;
name|hp
operator|->
name|h_update
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|hp
operator|->
name|h_update
operator|=
literal|0
expr_stmt|;
name|h
operator|+=
name|hp
operator|->
name|h_frame
operator|.
name|height
operator|+
literal|2
operator|*
name|hp
operator|->
name|h_frame
operator|.
name|bdrwidth
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|hp
operator|->
name|h_faces
init|;
name|fp
condition|;
name|fp
operator|=
name|fp
operator|->
name|f_next
control|)
if|if
condition|(
name|fp
operator|->
name|f_imap
operator|&&
name|fp
operator|->
name|f_imap
operator|->
name|height
operator|>
name|hh
condition|)
name|hh
operator|=
name|fp
operator|->
name|f_imap
operator|->
name|height
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|hp
operator|->
name|h_faces
init|;
name|fp
condition|;
name|fp
operator|=
name|fp
operator|->
name|f_next
control|)
if|if
condition|(
name|fp
operator|->
name|f_imap
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|f_window
operator|==
name|NULL
operator|||
name|fp
operator|->
name|f_frame
operator|.
name|height
operator|!=
name|hh
operator|||
name|fp
operator|->
name|f_frame
operator|.
name|width
operator|!=
name|fp
operator|->
name|f_imap
operator|->
name|width
operator|||
name|fp
operator|->
name|f_frame
operator|.
name|x
operator|!=
name|hw
operator|||
name|fp
operator|->
name|f_frame
operator|.
name|y
operator|!=
name|h
condition|)
block|{
name|fp
operator|->
name|f_frame
operator|.
name|bdrwidth
operator|=
name|bwidth
expr_stmt|;
name|fp
operator|->
name|f_frame
operator|.
name|height
operator|=
name|hh
expr_stmt|;
name|fp
operator|->
name|f_frame
operator|.
name|width
operator|=
name|fp
operator|->
name|f_imap
operator|->
name|width
expr_stmt|;
name|fp
operator|->
name|f_frame
operator|.
name|border
operator|=
name|backpix
expr_stmt|;
name|fp
operator|->
name|f_frame
operator|.
name|background
operator|=
name|backpix
expr_stmt|;
name|fp
operator|->
name|f_frame
operator|.
name|x
operator|=
name|hw
expr_stmt|;
name|fp
operator|->
name|f_frame
operator|.
name|y
operator|=
name|h
expr_stmt|;
name|fp
operator|->
name|f_update
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|fp
operator|->
name|f_update
operator|=
literal|0
expr_stmt|;
name|hw
operator|+=
name|fp
operator|->
name|f_imap
operator|->
name|width
operator|+
name|bwidth
operator|*
literal|2
expr_stmt|;
block|}
else|else
name|fp
operator|->
name|f_update
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|hw
operator|>
name|largest_w
condition|)
name|largest_w
operator|=
name|hw
expr_stmt|;
if|if
condition|(
name|hp
operator|->
name|h_frame
operator|.
name|width
operator|>
name|largest_w
condition|)
name|largest_w
operator|=
name|hp
operator|->
name|h_frame
operator|.
name|width
expr_stmt|;
if|if
condition|(
name|hw
operator|>
literal|0
condition|)
name|h
operator|+=
name|hh
operator|+
literal|2
expr_stmt|;
else|else
block|{
name|h
operator|-=
name|hp
operator|->
name|h_frame
operator|.
name|height
operator|+
literal|2
operator|*
name|hp
operator|->
name|h_frame
operator|.
name|bdrwidth
expr_stmt|;
name|hp
operator|->
name|h_update
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|hp
operator|->
name|h_window
condition|)
block|{
name|XFreeGC
argument_list|(
name|DISP
argument_list|,
name|hp
operator|->
name|h_gc
argument_list|)
expr_stmt|;
name|XDestroyWindow
argument_list|(
name|DISP
argument_list|,
name|hp
operator|->
name|h_window
argument_list|)
expr_stmt|;
name|hp
operator|->
name|h_window
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
name|largest_h
operator|=
name|h
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|display_top
argument_list|()
block|{
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"top window\n"
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_expr_stmt
specifier|static
name|display_host
argument_list|(
name|hp
argument_list|)
specifier|register
expr|struct
name|host
operator|*
name|hp
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s:\n"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
name|XDrawImageString
argument_list|(
name|DISP
argument_list|,
name|hp
operator|->
name|h_window
argument_list|,
name|hp
operator|->
name|h_gc
argument_list|,
literal|0
argument_list|,
name|hp
operator|->
name|h_ascent
argument_list|,
name|hp
operator|->
name|h_string
argument_list|,
name|strlen
argument_list|(
name|hp
operator|->
name|h_string
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|display_face
argument_list|(
name|fp
argument_list|)
specifier|register
expr|struct
name|face
operator|*
name|fp
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|sx
decl_stmt|,
name|sy
decl_stmt|,
name|dx
decl_stmt|,
name|dy
decl_stmt|;
name|unsigned
name|int
name|h
decl_stmt|,
name|w
decl_stmt|;
specifier|register
name|struct
name|type_IMAGE_Image
modifier|*
name|im
init|=
name|fp
operator|->
name|f_imap
decl_stmt|;
specifier|register
name|OpaqueFrame
modifier|*
name|xm
init|=
operator|&
name|fp
operator|->
name|f_frame
decl_stmt|;
name|XImage
modifier|*
name|image
decl_stmt|;
name|sx
operator|=
name|max
argument_list|(
name|im
operator|->
name|width
operator|-
operator|(
name|int
operator|)
name|xm
operator|->
name|width
argument_list|,
literal|0
argument_list|)
operator|/
literal|2
expr_stmt|;
name|sy
operator|=
name|max
argument_list|(
name|im
operator|->
name|height
operator|-
operator|(
name|int
operator|)
name|xm
operator|->
name|height
argument_list|,
literal|0
argument_list|)
operator|/
literal|2
expr_stmt|;
name|dx
operator|=
name|max
argument_list|(
operator|(
name|int
operator|)
name|xm
operator|->
name|width
operator|-
name|im
operator|->
name|width
argument_list|,
literal|0
argument_list|)
operator|/
literal|2
expr_stmt|;
name|dy
operator|=
name|max
argument_list|(
operator|(
name|int
operator|)
name|xm
operator|->
name|height
operator|-
name|im
operator|->
name|height
argument_list|,
literal|0
argument_list|)
operator|/
literal|2
expr_stmt|;
name|w
operator|=
name|min
argument_list|(
name|xm
operator|->
name|width
argument_list|,
name|im
operator|->
name|width
argument_list|)
expr_stmt|;
name|h
operator|=
name|min
argument_list|(
name|xm
operator|->
name|height
argument_list|,
name|im
operator|->
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"im: %dx%d frame:%dx%d\n"
argument_list|,
name|im
operator|->
name|width
argument_list|,
name|im
operator|->
name|height
argument_list|,
name|xm
operator|->
name|width
argument_list|,
name|xm
operator|->
name|height
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"sx=%d sy=%d dx=%d dy=%d w=%d h=%d\n"
argument_list|,
name|sx
argument_list|,
name|sy
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
block|}
name|image
operator|=
name|XCreateImage
argument_list|(
name|DISP
argument_list|,
name|DefaultVisual
argument_list|(
name|DISP
argument_list|,
name|SCRN
argument_list|)
argument_list|,
literal|1
argument_list|,
name|XYBitmap
argument_list|,
literal|0
argument_list|,
name|im
operator|->
name|data
operator|->
name|qb_forw
operator|->
name|qb_data
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|im
operator|->
name|width
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|im
operator|->
name|height
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|image
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"XCreateImage failed"
argument_list|)
expr_stmt|;
name|image
operator|->
name|byte_order
operator|=
name|image
operator|->
name|bitmap_bit_order
operator|=
name|LSBFirst
expr_stmt|;
name|XClearWindow
argument_list|(
name|DISP
argument_list|,
name|fp
operator|->
name|f_window
argument_list|)
expr_stmt|;
name|XPutImage
argument_list|(
name|DISP
argument_list|,
name|fp
operator|->
name|f_window
argument_list|,
name|forepix
argument_list|,
name|image
argument_list|,
name|sx
argument_list|,
name|sy
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|XDestroyImage
argument_list|(
name|image
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|facecmp
parameter_list|(
name|f1
parameter_list|,
name|f2
parameter_list|)
name|struct
name|face
modifier|*
modifier|*
name|f1
decl_stmt|,
decl|*
modifier|*
name|f2
decl_stmt|;
end_function

begin_block
block|{
return|return
name|strcmp
argument_list|(
operator|(
operator|*
name|f1
operator|)
operator|->
name|f_name
argument_list|,
operator|(
operator|*
name|f2
operator|)
operator|->
name|f_name
argument_list|)
return|;
block|}
end_block

begin_function
specifier|static
name|int
name|hostcmp
parameter_list|(
name|h1
parameter_list|,
name|h2
parameter_list|)
name|struct
name|host
modifier|*
modifier|*
name|h1
decl_stmt|,
decl|*
modifier|*
name|h2
decl_stmt|;
end_function

begin_block
block|{
return|return
name|strcmp
argument_list|(
operator|(
operator|*
name|h1
operator|)
operator|->
name|h_name
argument_list|,
operator|(
operator|*
name|h2
operator|)
operator|->
name|h_name
argument_list|)
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|read_X
argument_list|()
block|{
name|int
name|fd
block|,
name|n
block|;
name|long
name|now
block|;
specifier|register
expr|struct
name|dirent
operator|*
name|dp
block|;
specifier|register
expr|struct
name|face
operator|*
name|fp
block|,
operator|*
operator|*
name|fpp
block|;
specifier|register
expr|struct
name|host
operator|*
name|hp
block|,
operator|*
operator|*
name|hpp
block|;     struct
name|whod
name|wds
block|;
specifier|register
expr|struct
name|whod
operator|*
name|wd
operator|=
operator|&
name|wds
block|;
specifier|register
expr|struct
name|whoent
operator|*
name|we
block|;
specifier|static
name|DIR
operator|*
name|dd
operator|=
name|NULL
block|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|now
argument_list|)
block|;
for|for
control|(
name|hp
operator|=
name|hosts
init|;
name|hp
condition|;
name|hp
operator|=
name|hp
operator|->
name|h_next
control|)
block|{
name|hp
operator|->
name|h_up
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|hp
operator|->
name|h_faces
init|;
name|fp
condition|;
name|fp
operator|=
name|fp
operator|->
name|f_next
control|)
name|fp
operator|->
name|f_active
operator|=
literal|0
expr_stmt|;
block|}
end_expr_stmt

begin_if
if|if
condition|(
name|dd
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|chdir
argument_list|(
literal|"/usr/spool/rwho"
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
literal|"/usr/spool/rwho"
argument_list|,
literal|"unable to change directory to"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dd
operator|=
name|opendir
argument_list|(
literal|"."
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
literal|"/usr/spool/rwho"
argument_list|,
literal|"unable to read"
argument_list|)
expr_stmt|;
block|}
else|else
name|rewinddir
argument_list|(
name|dd
argument_list|)
expr_stmt|;
end_if

begin_while
while|while
condition|(
name|dp
operator|=
name|readdir
argument_list|(
name|dd
argument_list|)
condition|)
block|{
if|if
condition|(
name|dp
operator|->
name|d_ino
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|dp
operator|->
name|d_name
argument_list|,
literal|"whod."
argument_list|,
literal|5
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|dp
operator|->
name|d_name
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
continue|continue;
name|n
operator|=
name|read
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|wd
argument_list|,
sizeof|sizeof
expr|*
name|wd
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|-=
sizeof|sizeof
expr|*
name|wd
operator|-
sizeof|sizeof
name|wd
operator|->
name|wd_we
operator|)
operator|<
literal|0
condition|)
continue|continue;
if|if
condition|(
name|now
operator|-
name|wd
operator|->
name|wd_recvtime
operator|>
literal|5
operator|*
literal|60
operator|||
name|n
operator|<
sizeof|sizeof
expr|*
name|we
condition|)
continue|continue;
for|for
control|(
name|hp
operator|=
name|hosts
init|;
name|hp
condition|;
name|hp
operator|=
name|hp
operator|->
name|h_next
control|)
if|if
condition|(
name|strncmp
argument_list|(
name|hp
operator|->
name|h_name
argument_list|,
name|wd
operator|->
name|wd_hostname
argument_list|,
sizeof|sizeof
name|wd
operator|->
name|wd_hostname
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|hp
operator|=
operator|(
expr|struct
name|host
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|hp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|hp
operator|->
name|h_next
operator|=
name|hosts
expr_stmt|;
name|hosts
operator|=
name|hp
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|hp
operator|->
name|h_name
argument_list|,
name|wd
operator|->
name|wd_hostname
argument_list|,
sizeof|sizeof
name|wd
operator|->
name|wd_hostname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|hp
operator|->
name|h_string
argument_list|,
literal|"%s:"
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
name|hp
operator|->
name|h_frame
operator|.
name|width
operator|=
name|XTextWidth
argument_list|(
name|myfont
argument_list|,
name|hp
operator|->
name|h_string
argument_list|,
name|strlen
argument_list|(
name|hp
operator|->
name|h_string
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|hp
operator|->
name|h_up
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|we
operator|=
name|wd
operator|->
name|wd_we
operator|,
name|n
operator|=
name|n
operator|/
sizeof|sizeof
expr|*
name|we
init|;
name|n
operator|>
literal|0
condition|;
name|we
operator|++
operator|,
name|n
operator|--
control|)
block|{
if|if
condition|(
name|we
operator|->
name|we_idle
operator|>
literal|60
operator|*
literal|60
condition|)
continue|continue;
for|for
control|(
name|fp
operator|=
name|hp
operator|->
name|h_faces
init|;
name|fp
condition|;
name|fp
operator|=
name|fp
operator|->
name|f_next
control|)
if|if
condition|(
name|strncmp
argument_list|(
name|fp
operator|->
name|f_name
argument_list|,
name|we
operator|->
name|we_utmp
operator|.
name|out_name
argument_list|,
sizeof|sizeof
name|we
operator|->
name|we_utmp
operator|.
name|out_name
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|fp
operator|=
operator|(
expr|struct
name|face
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|fp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|fp
operator|->
name|f_next
operator|=
name|hp
operator|->
name|h_faces
expr_stmt|;
name|hp
operator|->
name|h_faces
operator|=
name|fp
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|fp
operator|->
name|f_name
argument_list|,
name|we
operator|->
name|we_utmp
operator|.
name|out_name
argument_list|,
sizeof|sizeof
name|we
operator|->
name|we_utmp
operator|.
name|out_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|display_this_host
argument_list|(
name|hp
operator|->
name|h_name
argument_list|)
operator|&&
operator|(
name|fp
operator|->
name|f_imap
operator|=
name|fetch_image
argument_list|(
name|fp
operator|->
name|f_name
argument_list|,
name|NULLCP
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|recording
condition|)
name|LLOG
argument_list|(
name|pgm_log
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"no image for \"%s\" \"%s\""
operator|,
name|hp
operator|->
name|h_name
operator|,
name|fp
operator|->
name|f_name
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|fp
operator|->
name|f_active
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_while

begin_for
for|for
control|(
name|hpp
operator|=
operator|&
name|hosts
init|;
name|hp
operator|=
operator|*
name|hpp
condition|;
control|)
block|{
for|for
control|(
name|fpp
operator|=
operator|&
name|hp
operator|->
name|h_faces
init|;
name|fp
operator|=
operator|*
name|fpp
condition|;
control|)
block|{
if|if
condition|(
operator|!
name|hp
operator|->
name|h_up
operator|||
operator|!
name|fp
operator|->
name|f_active
condition|)
block|{
operator|*
name|fpp
operator|=
name|fp
operator|->
name|f_next
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|f_window
condition|)
name|XDestroyWindow
argument_list|(
name|DISP
argument_list|,
name|fp
operator|->
name|f_window
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fp
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|fpp
operator|=
operator|&
name|fp
operator|->
name|f_next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|hp
operator|->
name|h_up
operator|||
name|hp
operator|->
name|h_faces
operator|==
name|NULL
condition|)
block|{
operator|*
name|hpp
operator|=
name|hp
operator|->
name|h_next
expr_stmt|;
if|if
condition|(
name|hp
operator|->
name|h_window
condition|)
block|{
name|XFreeGC
argument_list|(
name|DISP
argument_list|,
name|hp
operator|->
name|h_gc
argument_list|)
expr_stmt|;
name|XDestroyWindow
argument_list|(
name|DISP
argument_list|,
name|hp
operator|->
name|h_window
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|hp
argument_list|)
expr_stmt|;
block|}
else|else
name|hpp
operator|=
operator|&
name|hp
operator|->
name|h_next
expr_stmt|;
block|}
end_for

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|struct
name|host
modifier|*
modifier|*
name|hq
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|hp
operator|=
name|hosts
init|;
name|hp
condition|;
name|hp
operator|=
name|hp
operator|->
name|h_next
control|)
block|{
specifier|register
name|int
name|j
decl_stmt|;
specifier|register
name|struct
name|face
modifier|*
modifier|*
name|fq
decl_stmt|;
name|i
operator|++
operator|,
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|hp
operator|->
name|h_faces
init|;
name|fp
condition|;
name|fp
operator|=
name|fp
operator|->
name|f_next
control|)
name|j
operator|++
expr_stmt|;
if|if
condition|(
name|j
operator|>
literal|1
condition|)
block|{
specifier|register
name|struct
name|face
modifier|*
modifier|*
name|faces
decl_stmt|;
if|if
condition|(
operator|(
name|faces
operator|=
operator|(
expr|struct
name|face
operator|*
operator|*
operator|)
name|calloc
argument_list|(
operator|(
name|unsigned
operator|)
name|j
argument_list|,
sizeof|sizeof
expr|*
name|faces
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
name|fp
operator|=
name|hp
operator|->
name|h_faces
operator|,
name|fq
operator|=
name|faces
init|;
operator|*
name|fq
operator|=
name|fp
condition|;
name|fp
operator|=
name|fp
operator|->
name|f_next
operator|,
name|fq
operator|++
control|)
continue|continue;
name|qsort
argument_list|(
operator|(
name|char
operator|*
operator|)
name|faces
argument_list|,
name|j
argument_list|,
sizeof|sizeof
expr|*
name|faces
argument_list|,
name|facecmp
argument_list|)
expr_stmt|;
for|for
control|(
name|fq
operator|=
name|faces
operator|,
name|fpp
operator|=
operator|&
name|hp
operator|->
name|h_faces
init|;
operator|*
name|fpp
operator|=
operator|*
name|fq
condition|;
name|fq
operator|++
operator|,
name|fpp
operator|=
operator|&
operator|(
operator|*
name|fpp
operator|)
operator|->
name|f_next
control|)
continue|continue;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|faces
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|i
operator|>
literal|1
condition|)
block|{
specifier|register
name|struct
name|host
modifier|*
modifier|*
name|hostz
decl_stmt|;
if|if
condition|(
operator|(
name|hostz
operator|=
operator|(
expr|struct
name|host
operator|*
operator|*
operator|)
name|calloc
argument_list|(
operator|(
name|unsigned
operator|)
name|i
argument_list|,
sizeof|sizeof
expr|*
name|hostz
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|hp
operator|=
name|hosts
operator|,
name|hq
operator|=
name|hostz
init|;
operator|*
name|hq
operator|=
name|hp
condition|;
name|hp
operator|=
name|hp
operator|->
name|h_next
operator|,
name|hq
operator|++
control|)
continue|continue;
name|qsort
argument_list|(
operator|(
name|char
operator|*
operator|)
name|hostz
argument_list|,
name|i
argument_list|,
sizeof|sizeof
expr|*
name|hostz
argument_list|,
name|hostcmp
argument_list|)
expr_stmt|;
for|for
control|(
name|hq
operator|=
name|hostz
operator|,
name|hpp
operator|=
operator|&
name|hosts
init|;
operator|*
name|hpp
operator|=
operator|*
name|hq
condition|;
name|hq
operator|++
operator|,
name|hpp
operator|=
operator|&
operator|(
operator|*
name|hpp
operator|)
operator|->
name|h_next
control|)
continue|continue;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|hostz
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_label
name|out
label|:
end_label

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
unit|}
comment|/*
comment|*/
end_comment

begin_function
unit|static
name|int
name|display_this_host
parameter_list|(
name|n
parameter_list|)
specifier|register
name|char
modifier|*
name|n
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
modifier|*
name|ap
decl_stmt|;
if|if
condition|(
name|host_list
operator|==
name|host_end
condition|)
return|return
literal|1
return|;
for|for
control|(
name|ap
operator|=
name|host_list
init|;
name|ap
operator|<
name|host_end
condition|;
name|ap
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|ap
argument_list|,
name|n
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
operator|!
name|dont_list
operator|)
return|;
return|return
name|dont_list
return|;
block|}
end_function

end_unit


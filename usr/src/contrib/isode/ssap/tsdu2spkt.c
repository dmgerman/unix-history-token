begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* tsdu2spkt.c - read/write a SPDU to a TSDU */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/ssap/RCS/tsdu2spkt.c,v 7.1 91/02/22 09:46:14 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/ssap/RCS/tsdu2spkt.c,v 7.1 91/02/22 09:46:14 mrose Interim $  *  *  * $Log:	tsdu2spkt.c,v $  * Revision 7.1  91/02/22  09:46:14  mrose  * Interim 6.8  *   * Revision 7.0  89/11/23  22:25:55  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"spkt.h"
end_include

begin_include
include|#
directive|include
file|"tailor.h"
end_include

begin_comment
comment|/*
comment|*/
end_comment

begin_struct
struct|struct
name|local_buf
block|{
name|char
modifier|*
name|top
decl_stmt|;
comment|/* Top of buffer */
name|char
modifier|*
name|ptr
decl_stmt|;
comment|/* Pointer to working buffer */
name|int
name|pgi
decl_stmt|;
comment|/* Offset of last PGI li */
name|int
name|left
decl_stmt|;
comment|/* Number of bytes left */
name|int
name|li
decl_stmt|;
comment|/* Running spdu length */
name|int
name|allocli
decl_stmt|;
comment|/* Allocated li */
name|int
name|len
decl_stmt|;
comment|/* Current buffer size */
block|}
struct|;
end_struct

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|PMASK_NODATA
value|0x000000
end_define

begin_define
define|#
directive|define
name|PMASK_CN_ID
value|0x000001
end_define

begin_comment
comment|/*   1: Connection ID */
end_comment

begin_define
define|#
directive|define
name|PMASK_CN_ITEMS
value|0x000002
end_define

begin_comment
comment|/*   5: Connect/Accept Item */
end_comment

begin_define
define|#
directive|define
name|PMASK_SYNC
value|0x000004
end_define

begin_comment
comment|/*  15: Sync Type Item */
end_comment

begin_define
define|#
directive|define
name|PMASK_TOKEN
value|0x000008
end_define

begin_comment
comment|/*  16: Token Item */
end_comment

begin_define
define|#
directive|define
name|PMASK_TDISC
value|0x000010
end_define

begin_comment
comment|/*  17: Transport Disc */
end_comment

begin_define
define|#
directive|define
name|PMASK_USER_REQ
value|0x000020
end_define

begin_comment
comment|/*  20: Session User Req */
end_comment

begin_define
define|#
directive|define
name|PMASK_VERSION
value|0x000040
end_define

begin_comment
comment|/*  22: Version Number */
end_comment

begin_define
define|#
directive|define
name|PMASK_PREPARE
value|0x000080
end_define

begin_comment
comment|/*  24: Prepare type */
end_comment

begin_define
define|#
directive|define
name|PMASK_ENCLOSE
value|0x000100
end_define

begin_comment
comment|/*  25: Enclosure Item */
end_comment

begin_define
define|#
directive|define
name|PMASK_TOKEN_SET
value|0x000200
end_define

begin_comment
comment|/*  26: Token Setting Item */
end_comment

begin_define
define|#
directive|define
name|PMASK_RESYNC
value|0x000400
end_define

begin_comment
comment|/*  27: Resync type */
end_comment

begin_define
define|#
directive|define
name|PMASK_LINK
value|0x000800
end_define

begin_comment
comment|/*  33: Linking information */
end_comment

begin_define
define|#
directive|define
name|PMASK_ACT_ID
value|0x001000
end_define

begin_comment
comment|/*  41: Activity ID */
end_comment

begin_define
define|#
directive|define
name|PMASK_SERIAL
value|0x002000
end_define

begin_comment
comment|/*  42: Serial Number */
end_comment

begin_define
define|#
directive|define
name|PMASK_MIA_DATA
value|0x004000
end_define

begin_comment
comment|/*  46: MIA User Data */
end_comment

begin_define
define|#
directive|define
name|PMASK_REFLECT
value|0x008000
end_define

begin_comment
comment|/*  49: Reflect parameter */
end_comment

begin_define
define|#
directive|define
name|PMASK_REASON
value|0x010000
end_define

begin_comment
comment|/*  50: Refusal Reason */
end_comment

begin_define
define|#
directive|define
name|PMASK_SSAP_CALLING
value|0x020000
end_define

begin_comment
comment|/*  51: Calling SSAP ID */
end_comment

begin_define
define|#
directive|define
name|PMASK_SSAP_CALLED
value|0x040000
end_define

begin_comment
comment|/*  52: Called SSAP ID */
end_comment

begin_define
define|#
directive|define
name|PMASK_UDATA
value|0x080000
end_define

begin_comment
comment|/* 193: User data */
end_comment

begin_define
define|#
directive|define
name|PMASK_XDATA
value|0x100000
end_define

begin_comment
comment|/* 194: Extended user data */
end_comment

begin_define
define|#
directive|define
name|PMASK_VARLEN
value|0x800000
end_define

begin_comment
comment|/* PI is Variable Len */
end_comment

begin_define
define|#
directive|define
name|PMASK_NOTSUPPORTED
value|-1
end_define

begin_comment
comment|/* Type not supported */
end_comment

begin_decl_stmt
specifier|static
name|int
name|si_table
index|[]
init|=
block|{
name|PMASK_REFLECT
block|,
comment|/* 0x00: SPDU_ER */
name|PMASK_ENCLOSE
comment|/* 0x01: SPDU_GT& SPDU_DT */
operator||
name|PMASK_TOKEN
block|,
name|PMASK_TOKEN
comment|/* 0x02: SPDU_PT */
operator||
name|PMASK_ENCLOSE
operator||
name|PMASK_UDATA
block|,
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x03 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x04 */
name|PMASK_NODATA
block|,
comment|/* 0x05: SPDU_EX */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x06 */
name|PMASK_PREPARE
block|,
comment|/* 0x07: SPDU_PR */
name|PMASK_ENCLOSE
comment|/* 0x08: SPDU_NF */
operator||
name|PMASK_UDATA
block|,
name|PMASK_TDISC
comment|/* 0x09: SPDU_FN */
operator||
name|PMASK_ENCLOSE
operator||
name|PMASK_UDATA
block|,
name|PMASK_ENCLOSE
comment|/* 0x0a: SPDU_DN */
operator||
name|PMASK_UDATA
block|,
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x0b */
name|PMASK_CN_ID
comment|/* 0x0c: SPDU_RF */
operator||
name|PMASK_TDISC
operator||
name|PMASK_USER_REQ
operator||
name|PMASK_VERSION
operator||
name|PMASK_ENCLOSE
operator||
name|PMASK_REASON
block|,
name|PMASK_CN_ID
comment|/* 0x0d: SPDU_CN */
operator||
name|PMASK_CN_ITEMS
operator||
name|PMASK_USER_REQ
operator||
name|PMASK_VERSION
operator||
name|PMASK_SSAP_CALLING
operator||
name|PMASK_SSAP_CALLED
operator||
name|PMASK_UDATA
operator||
name|PMASK_XDATA
block|,
name|PMASK_CN_ID
comment|/* 0x0e: SPDU_AC */
operator||
name|PMASK_CN_ITEMS
operator||
name|PMASK_USER_REQ
operator||
name|PMASK_VERSION
operator||
name|PMASK_SSAP_CALLING
operator||
name|PMASK_TOKEN
operator||
name|PMASK_ENCLOSE
operator||
name|PMASK_SSAP_CALLED
operator||
name|PMASK_UDATA
block|,
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x0f */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x10 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x11 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x12 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x13 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x14 */
name|PMASK_NODATA
block|,
comment|/* 0x15: SPDU_GTC */
name|PMASK_NODATA
block|,
comment|/* 0x16: SPDU_GTA */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x17 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x18 */
name|PMASK_TDISC
comment|/* 0x19: SPDU_AB& SPDU_AI */
operator||
name|PMASK_REFLECT
operator||
name|PMASK_REASON
operator||
name|PMASK_ENCLOSE
operator||
name|PMASK_UDATA
block|,
name|PMASK_NODATA
block|,
comment|/* 0x1a: SPDU_AA& SPDU_AIA */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x1b */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x1c */
name|PMASK_LINK
comment|/* 0x1d: SPDU_AR */
operator||
name|PMASK_ACT_ID
operator||
name|PMASK_ENCLOSE
operator||
name|PMASK_SERIAL
operator||
name|PMASK_UDATA
block|,
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x1e */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x1f */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x20 */
name|PMASK_ENCLOSE
block|,
comment|/* 0x21: SPDU_TD */
name|PMASK_TOKEN_SET
comment|/* 0x22: SPDU_RA */
operator||
name|PMASK_ENCLOSE
operator||
name|PMASK_SERIAL
operator||
name|PMASK_UDATA
block|,
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x23 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x24 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x25 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x26 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x27 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x28 */
name|PMASK_SYNC
comment|/* 0x29: SPDU_MAP& SPDU_AE */
operator||
name|PMASK_ENCLOSE
operator||
name|PMASK_SERIAL
operator||
name|PMASK_UDATA
block|,
name|PMASK_ENCLOSE
comment|/* 0x2a: SPDU_MAA& SPDU_AEA */
operator||
name|PMASK_SERIAL
operator||
name|PMASK_UDATA
block|,
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x2b */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x2c */
name|PMASK_ENCLOSE
comment|/* 0x2d: SPDU_AS */
operator||
name|PMASK_ACT_ID
operator||
name|PMASK_UDATA
block|,
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x2e */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x2f */
name|PMASK_ENCLOSE
comment|/* 0x30: SPDU_ED */
operator||
name|PMASK_REASON
operator||
name|PMASK_UDATA
block|,
name|PMASK_SYNC
comment|/* 0x31: SPDU_MIP */
operator||
name|PMASK_ENCLOSE
operator||
name|PMASK_SERIAL
operator||
name|PMASK_UDATA
block|,
name|PMASK_ENCLOSE
comment|/* 0x32: SPDU_MIA */
operator||
name|PMASK_SERIAL
operator||
name|PMASK_MIA_DATA
block|,
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x33 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x34 */
name|PMASK_TOKEN_SET
comment|/* 0x35: SPDU_RS */
operator||
name|PMASK_ENCLOSE
operator||
name|PMASK_RESYNC
operator||
name|PMASK_SERIAL
operator||
name|PMASK_UDATA
block|,
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x36 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x37 */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x38 */
name|PMASK_REASON
block|,
comment|/* 0x39: SPDU_AD */
name|PMASK_NODATA
block|,
comment|/* 0x3a: SPDU_ADA */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x3b */
name|PMASK_NOTSUPPORTED
block|,
comment|/* 0x3c */
name|PMASK_ENCLOSE
comment|/* 0x3d: SPDU_CD */
operator||
name|PMASK_UDATA
block|,
name|PMASK_ENCLOSE
comment|/* 0x3e: SPDU_CDA */
operator||
name|PMASK_UDATA
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SI_TABLE_LEN
value|((sizeof si_table) / (sizeof si_table[0]))
end_define

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|PGI_CN_ID
value|1
end_define

begin_define
define|#
directive|define
name|PI_CALLED_SS
value|9
end_define

begin_define
define|#
directive|define
name|PI_CALLING_SS
value|10
end_define

begin_define
define|#
directive|define
name|PI_COMMON_REF
value|11
end_define

begin_define
define|#
directive|define
name|PI_ADD_INFO
value|12
end_define

begin_define
define|#
directive|define
name|PGI_CN_ITEMS
value|5
end_define

begin_define
define|#
directive|define
name|PI_PROTOCOL_OPT
value|19
end_define

begin_define
define|#
directive|define
name|PI_TSDU_MAXSIZ
value|21
end_define

begin_define
define|#
directive|define
name|PI_VERSION
value|22
end_define

begin_define
define|#
directive|define
name|PI_ISN
value|23
end_define

begin_define
define|#
directive|define
name|PI_TOKEN_SET
value|26
end_define

begin_define
define|#
directive|define
name|PI_ISN2
value|55
end_define

begin_define
define|#
directive|define
name|PI_SYNC
value|15
end_define

begin_define
define|#
directive|define
name|PI_TOKEN
value|16
end_define

begin_define
define|#
directive|define
name|PI_TDISC
value|17
end_define

begin_define
define|#
directive|define
name|PI_USER_REQ
value|20
end_define

begin_define
define|#
directive|define
name|PI_PREPARE
value|24
end_define

begin_define
define|#
directive|define
name|PI_ENCLOSE
value|25
end_define

begin_define
define|#
directive|define
name|PI_RESYNC
value|27
end_define

begin_define
define|#
directive|define
name|PGI_AR_LINK
value|33
end_define

begin_define
define|#
directive|define
name|PI_AR_CALLED
value|9
end_define

begin_define
define|#
directive|define
name|PI_AR_CALLING
value|10
end_define

begin_define
define|#
directive|define
name|PI_AR_COMMON
value|11
end_define

begin_define
define|#
directive|define
name|PI_AR_ADDT
value|12
end_define

begin_define
define|#
directive|define
name|PI_AR_OLD
value|41
end_define

begin_define
define|#
directive|define
name|PI_AR_SERIAL
value|42
end_define

begin_define
define|#
directive|define
name|PI_ACT_ID
value|41
end_define

begin_define
define|#
directive|define
name|PI_SERIAL
value|42
end_define

begin_define
define|#
directive|define
name|PI_MIA_DATA
value|46
end_define

begin_define
define|#
directive|define
name|PI_REFLECT
value|49
end_define

begin_define
define|#
directive|define
name|PI_REASON
value|50
end_define

begin_define
define|#
directive|define
name|PI_SSAP_CALLING
value|51
end_define

begin_define
define|#
directive|define
name|PI_SSAP_CALLED
value|52
end_define

begin_define
define|#
directive|define
name|PI_UDATA
value|193
end_define

begin_define
define|#
directive|define
name|PI_XDATA
value|194
end_define

begin_decl_stmt
specifier|static
name|int
name|pi_table
index|[]
init|=
block|{
literal|0
block|,
comment|/* 0x00 */
name|PMASK_VARLEN
operator||
name|PMASK_CN_ID
block|,
comment|/* 0x01: Connection ID */
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* 0x02-04 */
name|PMASK_VARLEN
operator||
name|PMASK_CN_ITEMS
block|,
comment|/* 0x05: Connect/Accept Item */
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* 0x06-08 */
name|PMASK_VARLEN
operator||
name|PMASK_CN_ID
operator||
name|PMASK_LINK
block|,
comment|/* 0x09: Called Session SS */
name|PMASK_VARLEN
operator||
name|PMASK_CN_ID
operator||
name|PMASK_LINK
block|,
comment|/* 0x0a: Calling Session SS */
name|PMASK_VARLEN
operator||
name|PMASK_CN_ID
operator||
name|PMASK_LINK
block|,
comment|/* 0x0b: Common Reference */
name|PMASK_VARLEN
operator||
name|PMASK_CN_ID
operator||
name|PMASK_LINK
block|,
comment|/* 0x0c: Additional Info */
literal|0
block|,
literal|0
block|,
comment|/* 0x0d-0e */
name|PMASK_SYNC
block|,
comment|/* 0x0f: Sync Type Item */
name|PMASK_TOKEN
block|,
comment|/* 0x10: Token Item */
name|PMASK_TDISC
block|,
comment|/* 0x11: Transport Disc */
literal|0
block|,
comment|/* 0x12 */
name|PMASK_CN_ITEMS
block|,
comment|/* 0x13: Protocol Option */
name|PMASK_USER_REQ
block|,
comment|/* 0x14: Session User Req */
name|PMASK_VARLEN
operator||
name|PMASK_CN_ITEMS
block|,
comment|/* 0x15: TSDU Max Size */
name|PMASK_VERSION
block|,
comment|/* 0x16: Version Number */
name|PMASK_VARLEN
operator||
name|PMASK_CN_ITEMS
block|,
comment|/* 0x17: Initial Serial Num */
name|PMASK_PREPARE
block|,
comment|/* 0x18: Prepare Type */
name|PMASK_ENCLOSE
block|,
comment|/* 0x19: Enclosure Item */
name|PMASK_CN_ITEMS
operator||
name|PMASK_TOKEN_SET
block|,
comment|/* 0x1a: Token setting item */
name|PMASK_RESYNC
block|,
comment|/* 0x1b: Resync type */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* 0x1c-20 */
name|PMASK_VARLEN
operator||
name|PMASK_LINK
block|,
comment|/* 0x21: Activity Link */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* 0x22-28 */
name|PMASK_VARLEN
operator||
name|PMASK_ACT_ID
block|,
comment|/* 0x29: Activity ID */
name|PMASK_VARLEN
operator||
name|PMASK_SERIAL
block|,
comment|/* 0x2a: Serial Number */
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* 0x2b-2d */
name|PMASK_VARLEN
operator||
name|PMASK_MIA_DATA
block|,
comment|/* 0x2e: MIA User Data */
literal|0
block|,
literal|0
block|,
comment|/* 0x2f-30 */
name|PMASK_VARLEN
operator||
name|PMASK_REFLECT
block|,
comment|/* 0x31: Reflect parameter */
name|PMASK_VARLEN
operator||
name|PMASK_REASON
block|,
comment|/* 0x32: Refusal Reason */
name|PMASK_VARLEN
operator||
name|PMASK_SSAP_CALLING
block|,
comment|/* 0x33: Calling SSAP ID */
name|PMASK_VARLEN
operator||
name|PMASK_SSAP_CALLED
block|,
comment|/* 0x34: Called SSAP ID */
literal|0
block|,
literal|0
block|,
comment|/* 0x35-36 */
name|PMASK_VARLEN
operator||
name|PMASK_CN_ITEMS
comment|/* 0x17: 2nd initial s/n */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PI_TABLE_LEN
value|((sizeof pi_table) / (sizeof pi_table[0]))
end_define

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
specifier|static
name|int
name|pi_length
index|[
name|PI_TABLE_LEN
index|]
init|=
block|{
literal|0
block|,
comment|/* 0x00 */
name|SREF_USER_SIZE
comment|/* 0x01: Connection ID */
operator|+
name|SREF_COMM_SIZE
operator|+
name|SREF_ADDT_SIZE
operator|+
literal|6
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* 0x02-04 */
literal|1
operator|+
literal|4
operator|+
literal|1
operator|+
literal|6
operator|+
literal|1
operator|+
literal|10
block|,
comment|/* 0x05: Connect/Accept Item */
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* 0x06-08 */
name|SREF_USER_SIZE
block|,
comment|/* 0x09: Called Session SS */
name|SREF_USER_SIZE
block|,
comment|/* 0x0a: Calling Session SS */
name|SREF_COMM_SIZE
block|,
comment|/* 0x0b: Common Reference */
name|SREF_ADDT_SIZE
block|,
comment|/* 0x0c: Additional Info */
literal|0
block|,
literal|0
block|,
comment|/* 0x0d-0e */
literal|1
block|,
comment|/* 0x0f: Sync Type Item */
literal|1
block|,
comment|/* 0x10: Token Item */
literal|1
block|,
comment|/* 0x11: Transport Disc */
literal|0
block|,
comment|/* 0x12 */
literal|1
block|,
comment|/* 0x13: Protocol Option */
literal|2
block|,
comment|/* 0x14: Session User Req */
literal|4
block|,
comment|/* 0x15: TSDU Max Size */
literal|1
block|,
comment|/* 0x16: Version Number */
name|SIZE_CN_ISN
block|,
comment|/* 0x17: Initial Serial Num */
literal|1
block|,
comment|/* 0x18: Prepare Type */
literal|1
block|,
comment|/* 0x19: Enclosure Item */
literal|1
block|,
comment|/* 0x1a: Token setting item */
literal|1
block|,
comment|/* 0x1b: Resync type */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* 0x1c-20 */
literal|2
operator|*
name|SREF_USER_SIZE
comment|/* 0x21: Activity Link */
operator|+
name|SREF_COMM_SIZE
operator|+
name|SREF_ADDT_SIZE
operator|+
name|SID_DATA_SIZE
operator|+
name|SIZE_CN_ISN
operator|+
literal|6
operator|*
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* 0x22-28 */
name|SID_DATA_SIZE
block|,
comment|/* 0x29: Activity ID */
name|SIZE_CN_ISN
block|,
comment|/* 0x2a: Serial Number */
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* 0x2b-2d */
name|SEGMENT_MAX
comment|/* MIA_SIZE */
block|,
comment|/* 0x2e: MIA User Data */
literal|0
block|,
literal|0
block|,
comment|/* 0x2f-30 */
name|SEGMENT_MAX
block|,
comment|/* 0x31: Reflect parameter */
name|RF_SIZE
block|,
comment|/* 0x32: Refusal Reason */
name|SSSIZE
block|,
comment|/* 0x33: Calling SSAP ID */
name|SSSIZE
block|,
comment|/* 0x34: Called SSAP ID */
literal|0
block|,
literal|0
block|,
comment|/* 0x35-36 */
name|SIZE_CN_ISN
block|,
comment|/* 0x37: 2nd initial s/n */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_define
define|#
directive|define
name|If_Set
parameter_list|(
name|flag
parameter_list|)
value|if (s -> s_mask& (flag))
end_define

begin_define
define|#
directive|define
name|If_Reset
parameter_list|(
name|flag
parameter_list|)
value|if (!(s -> s_mask& (flag)))
end_define

begin_define
define|#
directive|define
name|Set
parameter_list|(
name|flag
parameter_list|)
value|s -> s_mask |= (flag)
end_define

begin_define
define|#
directive|define
name|Reset
parameter_list|(
name|flag
parameter_list|)
value|s -> s_mask&= ~(flag)
end_define

begin_define
define|#
directive|define
name|Put_Item
parameter_list|(
name|code
parameter_list|,
name|value
parameter_list|)
define|\
value|put2spdu((code), pi_length[(code)], (value),&c)
end_define

begin_define
define|#
directive|define
name|Put_Ref
parameter_list|(
name|r
parameter_list|,
name|code
parameter_list|)
define|\
value|{ \     start_pgi (PGI_CN_ID,&c); \     if (r.sr_ulen) \ 	put2spdu (code, (int) r.sr_ulen, r.sr_udata,&c); \     if (r.sr_clen) \ 	put2spdu (PI_COMMON_REF, (int) r.sr_clen, r.sr_cdata,&c); \     if (r.sr_alen) \ 	put2spdu (PI_ADD_INFO, (int) r.sr_alen, r.sr_adata,&c); \     end_pgi (&c); \ }
end_define

begin_define
define|#
directive|define
name|Put_SSN
parameter_list|(
name|code
parameter_list|,
name|ssn
parameter_list|)
define|\
value|{ \     if ((ssn)> SERIAL_MAX + 1) { \ 	if (c.len) \ 	    free (c.top); \ 	s -> s_errno = SC_PROTOCOL; \ 	return NOTOK; \     } \     (void) sprintf (isn, "%lu", (ssn)); \     put2spdu ((code), strlen (isn), isn,&c); \ }
end_define

begin_comment
comment|/* this used to check  	if (s -> s_ulen> (csize)) { 	    if (c.len) 		free (c.top); 	    s -> s_errno = SC_PROTOCOL; 	    return NOTOK; 	}     but with version 2 session, there's really no point... */
end_comment

begin_define
define|#
directive|define
name|Put_UData
parameter_list|(
name|csize
parameter_list|)
define|\
value|{ \     if (s -> s_udata) { \ 	put2spdu (PI_UDATA, s -> s_ulen, s -> s_udata,&c); \     } \ }
end_define

begin_define
define|#
directive|define
name|Put_XData
parameter_list|(
name|csize
parameter_list|)
define|\
value|{ \     if (s -> s_udata) { \ 	put2spdu (s -> s_ulen> csize ? PI_XDATA : PI_UDATA, s -> s_ulen, \ 		  s -> s_udata,&c); \     } \ }
end_define

begin_define
define|#
directive|define
name|Put_MData
parameter_list|(
name|csize
parameter_list|)
define|\
value|{ \     if (s -> s_udata) { \ 	put2spdu (PI_MIA_DATA, s -> s_ulen, s -> s_udata,&c); \     } \ }
end_define

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|start_spdu
argument_list|(
argument|s
argument_list|,
argument|c
argument_list|,
argument|basesize
argument_list|)
expr|struct
name|ssapkt
operator|*
name|s
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|local_buf
modifier|*
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|basesize
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|s
operator|->
name|s_udata
condition|)
switch|switch
condition|(
name|s
operator|->
name|s_code
condition|)
block|{
case|case
name|SPDU_DT
case|:
comment|/* caller responsible for this... */
case|case
name|SPDU_EX
case|:
case|case
name|SPDU_TD
case|:
break|break;
default|default:
if|if
condition|(
name|s
operator|->
name|s_ulen
condition|)
name|basesize
operator|+=
name|s
operator|->
name|s_ulen
operator|+
operator|(
name|s
operator|->
name|s_ulen
operator|>
literal|254
condition|?
literal|4
else|:
literal|2
operator|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|s
operator|->
name|s_code
condition|)
block|{
case|case
name|SPDU_CN
case|:
case|case
name|SPDU_AC
case|:
name|If_Set
argument_list|(
argument|SMASK_CN_REF
argument_list|)
block|{
name|basesize
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_ulen
condition|)
name|basesize
operator|+=
literal|2
operator|+
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_ulen
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_clen
condition|)
name|basesize
operator|+=
literal|2
operator|+
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_clen
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_alen
condition|)
name|basesize
operator|+=
literal|2
operator|+
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_alen
expr_stmt|;
block|}
name|If_Set
argument_list|(
argument|SMASK_CN_CALLING
argument_list|)
name|basesize
operator|+=
name|s
operator|->
name|s_callinglen
operator|+
literal|2
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_CALLED
argument_list|)
name|basesize
operator|+=
name|s
operator|->
name|s_calledlen
operator|+
literal|2
expr_stmt|;
break|break;
case|case
name|SPDU_RF
case|:
name|If_Set
argument_list|(
argument|SMASK_RF_REF
argument_list|)
block|{
name|basesize
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_ulen
condition|)
name|basesize
operator|+=
literal|2
operator|+
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_ulen
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_clen
condition|)
name|basesize
operator|+=
literal|2
operator|+
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_clen
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_alen
condition|)
name|basesize
operator|+=
literal|2
operator|+
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_alen
expr_stmt|;
block|}
break|break;
case|case
name|SPDU_AR
case|:
name|basesize
operator|+=
literal|2
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_AR_REF
argument_list|)
block|{
if|if
condition|(
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_ulen
condition|)
name|basesize
operator|+=
literal|2
operator|+
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_ulen
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_clen
condition|)
name|basesize
operator|+=
literal|2
operator|+
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_clen
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_alen
condition|)
name|basesize
operator|+=
literal|2
operator|+
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_alen
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_vlen
condition|)
name|basesize
operator|+=
literal|2
operator|+
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_vlen
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|basesize
operator|<
literal|254
condition|)
name|basesize
operator|=
literal|254
expr_stmt|;
name|c
operator|->
name|li
operator|=
name|c
operator|->
name|pgi
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|len
operator|=
name|basesize
operator|+
operator|(
operator|(
name|basesize
operator|>
literal|254
operator|)
condition|?
literal|4
else|:
literal|2
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|->
name|top
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|c
operator|->
name|len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|c
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|s_errno
operator|=
name|SC_CONGEST
expr_stmt|;
block|}
else|else
name|s
operator|->
name|s_errno
operator|=
name|SC_ACCEPT
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|->
name|allocli
operator|=
name|c
operator|->
name|left
operator|=
name|basesize
operator|)
operator|>
literal|254
condition|)
name|c
operator|->
name|ptr
operator|=
name|c
operator|->
name|top
operator|+
literal|4
expr_stmt|;
else|else
name|c
operator|->
name|ptr
operator|=
name|c
operator|->
name|top
operator|+
literal|2
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|end_spdu
parameter_list|(
name|code
parameter_list|,
name|c
parameter_list|)
name|unsigned
name|char
name|code
decl_stmt|;
name|struct
name|local_buf
modifier|*
name|c
decl_stmt|;
block|{
if|if
condition|(
name|c
operator|->
name|len
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|allocli
operator|>
literal|254
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|li
operator|<
literal|255
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|c
operator|->
name|top
operator|+
literal|2
operator|)
argument_list|,
name|c
operator|->
name|top
argument_list|,
operator|(
name|c
operator|->
name|len
operator|-
name|c
operator|->
name|left
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|c
operator|->
name|top
operator|+
literal|1
operator|)
operator|=
name|c
operator|->
name|li
expr_stmt|;
name|c
operator|->
name|len
operator|=
name|c
operator|->
name|li
operator|+
literal|2
expr_stmt|;
block|}
else|else
block|{
operator|*
operator|(
name|c
operator|->
name|top
operator|+
literal|1
operator|)
operator|=
literal|255
expr_stmt|;
operator|*
operator|(
name|c
operator|->
name|top
operator|+
literal|2
operator|)
operator|=
operator|(
name|c
operator|->
name|li
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
operator|*
operator|(
name|c
operator|->
name|top
operator|+
literal|3
operator|)
operator|=
name|c
operator|->
name|li
operator|&
literal|0xff
expr_stmt|;
name|c
operator|->
name|len
operator|=
name|c
operator|->
name|li
operator|+
literal|4
expr_stmt|;
block|}
block|}
else|else
block|{
operator|*
operator|(
name|c
operator|->
name|top
operator|+
literal|1
operator|)
operator|=
name|c
operator|->
name|li
expr_stmt|;
name|c
operator|->
name|len
operator|=
name|c
operator|->
name|ptr
operator|-
name|c
operator|->
name|top
expr_stmt|;
block|}
operator|*
name|c
operator|->
name|top
operator|=
name|code
expr_stmt|;
return|return
name|OK
return|;
block|}
return|return
name|NOTOK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|start_pgi
argument_list|(
argument|code
argument_list|,
argument|c
argument_list|)
name|unsigned
name|char
name|code
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|local_buf
modifier|*
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|put2spdu
argument_list|(
operator|(
name|int
operator|)
name|code
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|len
condition|)
name|c
operator|->
name|pgi
operator|=
operator|(
name|c
operator|->
name|ptr
operator|-
name|c
operator|->
name|top
operator|-
literal|1
operator|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|end_pgi
argument_list|(
argument|c
argument_list|)
expr|struct
name|local_buf
operator|*
name|c
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|c
operator|->
name|len
condition|)
operator|*
operator|(
name|c
operator|->
name|top
operator|+
name|c
operator|->
name|pgi
operator|)
operator|=
operator|(
name|c
operator|->
name|len
operator|-
name|c
operator|->
name|left
operator|)
operator|-
operator|(
name|c
operator|->
name|pgi
operator|+
literal|1
operator|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|put2spdu
argument_list|(
argument|code
argument_list|,
argument|li
argument_list|,
argument|value
argument_list|,
argument|c
argument_list|)
name|int
name|code
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|li
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|value
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|local_buf
modifier|*
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|cl
init|=
name|li
decl_stmt|;
name|char
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|len
condition|)
block|{
name|cl
operator|+=
operator|(
name|li
operator|<
literal|255
operator|)
condition|?
literal|2
else|:
literal|4
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|left
operator|>=
name|cl
condition|)
name|c
operator|->
name|left
operator|-=
name|cl
expr_stmt|;
else|else
block|{
comment|/* XXX:	this clause of Dwight's is all WRONG, WRONG, WRONG.  I think we 	should make start_spdu() smarter, if necessary and change this to  	c -> len = 0; 	return; */
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|allocli
operator|<
literal|255
condition|)
name|cl
operator|+=
literal|2
expr_stmt|;
name|cp
operator|=
name|realloc
argument_list|(
name|c
operator|->
name|top
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|c
operator|->
name|len
operator|+=
name|cl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
block|{
name|c
operator|->
name|len
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|ptr
operator|=
operator|(
name|c
operator|->
name|top
operator|=
name|cp
operator|)
operator|+
operator|(
name|c
operator|->
name|len
operator|-
name|c
operator|->
name|left
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|allocli
operator|<
literal|255
condition|)
block|{
name|c
operator|->
name|allocli
operator|+=
name|cl
expr_stmt|;
name|cl
operator|=
name|c
operator|->
name|len
operator|-
name|c
operator|->
name|left
operator|+
literal|2
expr_stmt|;
for|for
control|(
name|p1
operator|=
name|c
operator|->
name|ptr
operator|,
name|p2
operator|=
name|p1
operator|+
literal|2
init|;
name|cl
condition|;
name|cl
operator|--
control|)
operator|*
name|p2
operator|--
operator|=
operator|*
name|p1
operator|--
expr_stmt|;
name|c
operator|->
name|pgi
operator|+=
literal|2
expr_stmt|;
name|c
operator|->
name|left
operator|-=
literal|2
expr_stmt|;
block|}
block|}
operator|*
name|c
operator|->
name|ptr
operator|++
operator|=
name|code
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|li
operator|<
literal|255
condition|)
block|{
operator|*
name|c
operator|->
name|ptr
operator|++
operator|=
name|li
expr_stmt|;
name|c
operator|->
name|li
operator|+=
literal|2
operator|+
name|li
expr_stmt|;
block|}
else|else
block|{
operator|*
name|c
operator|->
name|ptr
operator|++
operator|=
literal|255
expr_stmt|;
operator|*
name|c
operator|->
name|ptr
operator|++
operator|=
operator|(
name|li
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
operator|*
name|c
operator|->
name|ptr
operator|++
operator|=
name|li
operator|&
literal|0xff
expr_stmt|;
name|c
operator|->
name|li
operator|+=
literal|4
operator|+
name|li
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|value
argument_list|,
name|c
operator|->
name|ptr
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|c
operator|->
name|ptr
operator|+=
name|li
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|spkt2tsdu
parameter_list|(
name|s
parameter_list|,
name|base
parameter_list|,
name|len
parameter_list|)
specifier|register
name|struct
name|ssapkt
modifier|*
name|s
decl_stmt|;
name|char
modifier|*
modifier|*
name|base
decl_stmt|;
name|int
modifier|*
name|len
decl_stmt|;
block|{
name|struct
name|local_buf
name|c
decl_stmt|;
name|char
name|isn
index|[
name|SIZE_CN_ISN
operator|+
literal|1
index|]
decl_stmt|;
name|c
operator|.
name|len
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|s
operator|->
name|s_code
condition|)
block|{
case|case
name|SPDU_CN
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|CN_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_REF
argument_list|)
name|Put_Ref
argument_list|(
name|s
operator|->
name|s_cn_reference
argument_list|,
name|PI_CALLING_SS
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_OPT | SMASK_CN_TSDU | SMASK_CN_VRSN | SMASK_CN_ISN 		    | SMASK_CN_SET
argument_list|)
block|{
name|start_pgi
argument_list|(
name|PGI_CN_ITEMS
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_OPT
argument_list|)
name|Put_Item
argument_list|(
name|PI_PROTOCOL_OPT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_options
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_TSDU
argument_list|)
block|{
name|u_long
name|tsdu_maxsize
init|=
operator|(
name|s
operator|->
name|s_tsdu_init
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
operator||
name|s
operator|->
name|s_tsdu_resp
operator|&
literal|0xffff
decl_stmt|;
name|tsdu_maxsize
operator|=
name|htonl
argument_list|(
name|tsdu_maxsize
argument_list|)
expr_stmt|;
name|Put_Item
argument_list|(
name|PI_TSDU_MAXSIZ
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|tsdu_maxsize
argument_list|)
expr_stmt|;
block|}
name|If_Set
argument_list|(
argument|SMASK_CN_VRSN
argument_list|)
name|Put_Item
argument_list|(
name|PI_VERSION
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_cn_version
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_ISN
argument_list|)
name|Put_SSN
argument_list|(
name|PI_ISN
argument_list|,
name|s
operator|->
name|s_isn
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_SET
argument_list|)
name|Put_Item
argument_list|(
name|PI_TOKEN_SET
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_settings
argument_list|)
expr_stmt|;
name|end_pgi
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
block|}
name|If_Set
argument_list|(
argument|SMASK_CN_REQ
argument_list|)
block|{
name|u_short
name|requirements
init|=
name|htons
argument_list|(
name|s
operator|->
name|s_cn_require
argument_list|)
decl_stmt|;
name|Put_Item
argument_list|(
name|PI_USER_REQ
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|requirements
argument_list|)
expr_stmt|;
block|}
name|If_Set
argument_list|(
argument|SMASK_CN_CALLING
argument_list|)
name|put2spdu
argument_list|(
name|PI_SSAP_CALLING
argument_list|,
name|s
operator|->
name|s_callinglen
argument_list|,
name|s
operator|->
name|s_calling
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_CALLED
argument_list|)
name|put2spdu
argument_list|(
name|PI_SSAP_CALLED
argument_list|,
name|s
operator|->
name|s_calledlen
argument_list|,
name|s
operator|->
name|s_called
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|Put_XData
argument_list|(
name|CN_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AC
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|AC_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_REF
argument_list|)
name|Put_Ref
argument_list|(
name|s
operator|->
name|s_cn_reference
argument_list|,
name|PI_CALLED_SS
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_OPT | SMASK_CN_TSDU | SMASK_CN_VRSN | SMASK_CN_ISN 		    | SMASK_CN_SET
argument_list|)
block|{
name|start_pgi
argument_list|(
name|PGI_CN_ITEMS
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_OPT
argument_list|)
name|Put_Item
argument_list|(
name|PI_PROTOCOL_OPT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_options
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_TSDU
argument_list|)
block|{
name|u_long
name|tsdu_maxsize
init|=
operator|(
name|s
operator|->
name|s_tsdu_init
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
operator||
name|s
operator|->
name|s_tsdu_resp
operator|&
literal|0xffff
decl_stmt|;
name|tsdu_maxsize
operator|=
name|htonl
argument_list|(
name|tsdu_maxsize
argument_list|)
expr_stmt|;
name|Put_Item
argument_list|(
name|PI_TSDU_MAXSIZ
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|tsdu_maxsize
argument_list|)
expr_stmt|;
block|}
name|If_Set
argument_list|(
argument|SMASK_CN_VRSN
argument_list|)
name|Put_Item
argument_list|(
name|PI_VERSION
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_cn_version
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_ISN
argument_list|)
name|Put_SSN
argument_list|(
name|PI_ISN
argument_list|,
name|s
operator|->
name|s_isn
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_SET
argument_list|)
name|Put_Item
argument_list|(
name|PI_TOKEN_SET
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_settings
argument_list|)
expr_stmt|;
name|end_pgi
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
block|}
name|If_Set
argument_list|(
argument|SMASK_AC_TOKEN
argument_list|)
name|Put_Item
argument_list|(
name|PI_TOKEN
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_ac_token
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_REQ
argument_list|)
block|{
name|u_short
name|requirements
init|=
name|htons
argument_list|(
name|s
operator|->
name|s_cn_require
argument_list|)
decl_stmt|;
name|Put_Item
argument_list|(
name|PI_USER_REQ
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|requirements
argument_list|)
expr_stmt|;
block|}
name|If_Set
argument_list|(
argument|SMASK_CN_CALLING
argument_list|)
name|put2spdu
argument_list|(
name|PI_SSAP_CALLING
argument_list|,
name|s
operator|->
name|s_callinglen
argument_list|,
name|s
operator|->
name|s_calling
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_CN_CALLED
argument_list|)
name|put2spdu
argument_list|(
name|PI_SSAP_CALLED
argument_list|,
name|s
operator|->
name|s_calledlen
argument_list|,
name|s
operator|->
name|s_called
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|AC_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RF
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|RF_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_RF_REF
argument_list|)
name|Put_Ref
argument_list|(
name|s
operator|->
name|s_rf_reference
argument_list|,
name|PI_CALLED_SS
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_RF_DISC
argument_list|)
name|Put_Item
argument_list|(
name|PI_TDISC
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_rf_disconnect
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_RF_REQ
argument_list|)
block|{
name|u_short
name|requirements
init|=
name|htons
argument_list|(
name|s
operator|->
name|s_rf_require
argument_list|)
decl_stmt|;
name|Put_Item
argument_list|(
name|PI_USER_REQ
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|requirements
argument_list|)
expr_stmt|;
block|}
name|If_Set
argument_list|(
argument|SMASK_RF_VRSN
argument_list|)
name|Put_Item
argument_list|(
name|PI_VERSION
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_rf_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_rlen
operator|>
name|RF_SIZE
condition|)
block|{
if|if
condition|(
name|c
operator|.
name|len
condition|)
name|free
argument_list|(
name|c
operator|.
name|top
argument_list|)
expr_stmt|;
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_rlen
operator|>
literal|0
condition|)
name|put2spdu
argument_list|(
name|PI_REASON
argument_list|,
name|s
operator|->
name|s_rlen
argument_list|,
name|s
operator|->
name|s_rdata
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_FN
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|FN_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_FN_DISC
argument_list|)
name|Put_Item
argument_list|(
name|PI_TDISC
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_fn_disconnect
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|FN_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_DN
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|DN_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|DN_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_NF
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|NF_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|NF_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AB
case|:
ifdef|#
directive|ifdef
name|notdef
case|case
name|SPDU_AI
case|:
comment|/* aka SPDU_AB */
endif|#
directive|endif
name|If_Set
argument_list|(
argument|SMASK_SPDU_AB
argument_list|)
block|{
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|AB_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_AB_DISC
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|Put_Item
argument_list|(
name|PI_TDISC
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_ab_disconnect
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_AB_REFL
argument_list|)
name|put2spdu
argument_list|(
name|PI_REFLECT
argument_list|,
name|AB_REFL_SIZE
argument_list|,
operator|(
name|char
operator|*
operator|)
name|s
operator|->
name|s_reflect
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|AB_SIZE
argument_list|)
expr_stmt|;
break|break;
block|}
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|AI_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_AI_REASON
argument_list|)
name|put2spdu
argument_list|(
name|PI_REASON
argument_list|,
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_ai_reason
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AA
case|:
ifdef|#
directive|ifdef
name|notdef
case|case
name|SPDU_AIA
case|:
comment|/* aka SPDU_AA */
endif|#
directive|endif
name|If_Set
argument_list|(
argument|SMASK_SPDU_AA
argument_list|)
block|{
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|AA_BASE_SIZE
argument_list|)
expr_stmt|;
break|break;
block|}
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|AIA_BASE_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_GT
case|:
ifdef|#
directive|ifdef
name|notdef
case|case
name|SPDU_DT
case|:
comment|/* aka SPDU_GT */
endif|#
directive|endif
name|If_Set
argument_list|(
argument|SMASK_SPDU_GT
argument_list|)
block|{
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|GT_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_GT_TOKEN
argument_list|)
name|Put_Item
argument_list|(
name|PI_TOKEN
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_gt_token
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* else fall */
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|DT_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
comment|/* NB: caller responsible for mapping s -> s_udata to user info */
break|break;
case|case
name|SPDU_TD
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|TD_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
comment|/* NB: caller responsible for mapping s -> s_udata to user info */
break|break;
case|case
name|SPDU_EX
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|EX_BASE_SIZE
argument_list|)
expr_stmt|;
comment|/* NB: caller responsible for mapping s -> s_udata to user info */
break|break;
case|case
name|SPDU_CD
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|CD_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|CD_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_CDA
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|CDA_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|CDA_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_PT
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|PT_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_PT_TOKEN
argument_list|)
name|Put_Item
argument_list|(
name|PI_TOKEN
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_pt_token
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|PT_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_GTC
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|GTC_BASE_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_GTA
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|GTA_BASE_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_MIP
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|MIP_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_MIP_SYNC
argument_list|)
name|Put_Item
argument_list|(
name|PI_SYNC
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_mip_sync
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_MIP_SERIAL
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|Put_SSN
argument_list|(
name|PI_SERIAL
argument_list|,
name|s
operator|->
name|s_mip_serial
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|MIP_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_MAP
case|:
ifdef|#
directive|ifdef
name|notdef
case|case
name|SPDU_AE
case|:
comment|/* aka SPDU_MAP */
endif|#
directive|endif
name|If_Set
argument_list|(
argument|SMASK_MAP_SYNC
argument_list|)
block|{
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|MAP_BASE_SIZE
argument_list|)
expr_stmt|;
name|Put_Item
argument_list|(
name|PI_SYNC
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_map_sync
argument_list|)
expr_stmt|;
block|}
else|else
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|AE_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_MAP_SERIAL
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|Put_SSN
argument_list|(
name|PI_SERIAL
argument_list|,
name|s
operator|->
name|s_map_serial
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|MAP_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_MIA
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|MIA_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_MIA_SERIAL
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|Put_SSN
argument_list|(
name|PI_SERIAL
argument_list|,
name|s
operator|->
name|s_mia_serial
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_MData
argument_list|(
name|MIA_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_MAA
case|:
ifdef|#
directive|ifdef
name|notdef
case|case
name|SPDU_AEA
case|:
comment|/* aka SPDU_MAA */
endif|#
directive|endif
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|MAA_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_MAA_SERIAL
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|Put_SSN
argument_list|(
name|PI_SERIAL
argument_list|,
name|s
operator|->
name|s_maa_serial
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|MAA_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RS
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|RS_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_RS_SET
argument_list|)
name|Put_Item
argument_list|(
name|PI_TOKEN_SET
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_rs_settings
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_RS_TYPE
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|Put_Item
argument_list|(
name|PI_RESYNC
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_rs_type
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_RS_SSN
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|Put_SSN
argument_list|(
name|PI_SERIAL
argument_list|,
name|s
operator|->
name|s_rs_serial
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|RS_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RA
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|RA_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_RA_SET
argument_list|)
name|Put_Item
argument_list|(
name|PI_TOKEN_SET
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_ra_settings
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_RA_SSN
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|Put_SSN
argument_list|(
name|PI_SERIAL
argument_list|,
name|s
operator|->
name|s_ra_serial
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|RA_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_PR
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|PR_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_PR_TYPE
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|Put_Item
argument_list|(
name|PI_PREPARE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_pr_type
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_ER
case|:
comment|/* we don't do these! */
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_ED
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|ED_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_ED_REASON
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|put2spdu
argument_list|(
name|PI_REASON
argument_list|,
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_ed_reason
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|ED_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AS
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|AS_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_AS_ID
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|put2spdu
argument_list|(
name|PI_ACT_ID
argument_list|,
operator|(
name|int
operator|)
name|s
operator|->
name|s_as_id
operator|.
name|sd_len
argument_list|,
name|s
operator|->
name|s_as_id
operator|.
name|sd_data
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|AS_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AR
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|AR_BASE_SIZE
argument_list|)
expr_stmt|;
name|start_pgi
argument_list|(
name|PGI_AR_LINK
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_AR_REF
argument_list|)
block|{
if|if
condition|(
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_called_len
condition|)
name|put2spdu
argument_list|(
name|PI_AR_CALLED
argument_list|,
operator|(
name|int
operator|)
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_called_len
argument_list|,
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_called
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_calling_len
condition|)
name|put2spdu
argument_list|(
name|PI_AR_CALLING
argument_list|,
operator|(
name|int
operator|)
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_calling_len
argument_list|,
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_calling
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_clen
condition|)
name|put2spdu
argument_list|(
name|PI_AR_COMMON
argument_list|,
operator|(
name|int
operator|)
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_clen
argument_list|,
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_cdata
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_alen
condition|)
name|put2spdu
argument_list|(
name|PI_AR_ADDT
argument_list|,
operator|(
name|int
operator|)
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_alen
argument_list|,
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_adata
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
block|}
name|If_Reset
argument_list|(
argument|SMASK_AR_OID
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|put2spdu
argument_list|(
name|PI_ACT_ID
argument_list|,
operator|(
name|int
operator|)
name|s
operator|->
name|s_ar_oid
operator|.
name|sd_len
argument_list|,
name|s
operator|->
name|s_ar_oid
operator|.
name|sd_data
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_AR_SSN
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|Put_SSN
argument_list|(
name|PI_SERIAL
argument_list|,
name|s
operator|->
name|s_ar_serial
argument_list|)
expr_stmt|;
name|end_pgi
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_AR_ID
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|put2spdu
argument_list|(
name|PI_ACT_ID
argument_list|,
operator|(
name|int
operator|)
name|s
operator|->
name|s_ar_id
operator|.
name|sd_len
argument_list|,
name|s
operator|->
name|s_ar_id
operator|.
name|sd_data
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_ENCLOSE
argument_list|)
name|Put_Item
argument_list|(
name|PI_ENCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_enclose
argument_list|)
expr_stmt|;
name|Put_UData
argument_list|(
name|AR_SIZE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AD
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|AD_BASE_SIZE
argument_list|)
expr_stmt|;
name|If_Set
argument_list|(
argument|SMASK_AD_REASON
argument_list|)
name|put2spdu
argument_list|(
name|PI_REASON
argument_list|,
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|s
operator|->
name|s_ad_reason
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_ADA
case|:
name|start_spdu
argument_list|(
name|s
argument_list|,
operator|&
name|c
argument_list|,
name|ADA_BASE_SIZE
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|end_spdu
argument_list|(
name|s
operator|->
name|s_code
argument_list|,
operator|&
name|c
argument_list|)
operator|==
name|NOTOK
operator|)
operator|||
operator|(
name|s
operator|->
name|s_errno
operator|!=
name|SC_ACCEPT
operator|)
condition|)
block|{
if|if
condition|(
name|s
operator|->
name|s_errno
operator|==
name|SC_ACCEPT
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_CONGEST
expr_stmt|;
if|if
condition|(
name|c
operator|.
name|len
condition|)
block|{
name|free
argument_list|(
name|c
operator|.
name|top
argument_list|)
expr_stmt|;
name|c
operator|.
name|len
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|base
operator|=
name|NULL
expr_stmt|;
operator|*
name|len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
operator|*
name|base
operator|=
name|c
operator|.
name|top
expr_stmt|;
operator|*
name|len
operator|=
name|c
operator|.
name|len
expr_stmt|;
name|s
operator|->
name|s_li
operator|=
name|c
operator|.
name|li
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|ssap_log
operator|->
name|ll_events
operator|&
name|LLOG_PDUS
condition|)
name|spkt2text
argument_list|(
name|ssap_log
argument_list|,
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|c
operator|.
name|len
condition|?
name|OK
else|:
name|NOTOK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|u_long
name|str2ssn
parameter_list|(
name|s
parameter_list|,
name|n
parameter_list|)
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|u_long
name|u
decl_stmt|;
for|for
control|(
name|u
operator|=
literal|0L
init|;
name|n
operator|>
literal|0
condition|;
name|n
operator|--
control|)
name|u
operator|=
name|u
operator|*
literal|10
operator|+
operator|*
name|s
operator|++
operator|-
literal|'0'
expr_stmt|;
return|return
name|u
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* this is used to pull PCI, not user data... */
end_comment

begin_define
define|#
directive|define
name|advance
parameter_list|(
name|n
parameter_list|)
define|\
value|if (base>= xbase) { \ 	if ((base = pullqb (qb, (n))) == NULL) { \ 	    s -> s_errno = SC_PROTOCOL; \ 	    break; \ 	} \ 	xbase = base + (n); \ 	nread += (n); \     } \     else
end_define

begin_function
specifier|static
name|char
modifier|*
name|pullqb
parameter_list|(
name|qb
parameter_list|,
name|n
parameter_list|)
name|struct
name|qbuf
modifier|*
name|qb
decl_stmt|;
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|once
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|struct
name|qbuf
modifier|*
name|qp
decl_stmt|;
specifier|static
name|char
modifier|*
name|buffer
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|n
operator|>
name|SEGMENT_MAX
condition|)
return|return
name|NULLCP
return|;
for|for
control|(
name|once
operator|=
literal|1
operator|,
name|cp
operator|=
name|buffer
operator|,
name|qp
operator|=
name|NULL
init|;
name|n
operator|>
literal|0
condition|;
name|once
operator|=
literal|0
operator|,
name|cp
operator|+=
name|i
operator|,
name|n
operator|-=
name|i
control|)
block|{
if|if
condition|(
name|qp
operator|==
name|NULL
operator|&&
operator|(
name|qp
operator|=
name|qb
operator|->
name|qb_forw
operator|)
operator|==
name|qb
condition|)
return|return
name|NULLCP
return|;
name|i
operator|=
name|min
argument_list|(
name|qp
operator|->
name|qb_len
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|once
operator|&&
name|i
operator|==
name|n
condition|)
block|{
comment|/* special case */
name|cp
operator|=
name|qp
operator|->
name|qb_data
expr_stmt|;
name|qp
operator|->
name|qb_data
operator|+=
name|i
operator|,
name|qp
operator|->
name|qb_len
operator|-=
name|i
expr_stmt|;
return|return
name|cp
return|;
block|}
if|if
condition|(
name|buffer
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|buffer
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|SEGMENT_MAX
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULLCP
return|;
name|cp
operator|=
name|buffer
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|qp
operator|->
name|qb_data
argument_list|,
name|cp
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|qp
operator|->
name|qb_data
operator|+=
name|i
operator|,
name|qp
operator|->
name|qb_len
operator|-=
name|i
expr_stmt|;
if|if
condition|(
name|qp
operator|->
name|qb_len
operator|<=
literal|0
condition|)
block|{
name|remque
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|qp
argument_list|)
expr_stmt|;
name|qp
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return
name|buffer
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|struct
name|ssapkt
modifier|*
name|tsdu2spkt
parameter_list|(
name|qb
parameter_list|,
name|len
parameter_list|,
name|cc
parameter_list|)
name|struct
name|qbuf
modifier|*
name|qb
decl_stmt|;
name|int
name|len
decl_stmt|,
decl|*
name|cc
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|int
name|li
decl_stmt|;
name|int
name|cat0
decl_stmt|,
name|nread
decl_stmt|,
name|pktlen
decl_stmt|,
name|pgilen
decl_stmt|,
name|pmask
decl_stmt|,
name|xlen
decl_stmt|;
specifier|register
name|char
modifier|*
name|base
decl_stmt|;
name|char
modifier|*
name|xbase
decl_stmt|;
name|unsigned
name|char
name|code
decl_stmt|,
name|si
decl_stmt|;
specifier|register
name|struct
name|ssapkt
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|cc
condition|)
block|{
name|cat0
operator|=
operator|*
name|cc
expr_stmt|;
operator|*
name|cc
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|cat0
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|base
operator|=
name|pullqb
argument_list|(
name|qb
argument_list|,
name|nread
operator|=
literal|2
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|s
operator|=
name|newspkt
argument_list|(
call|(
name|int
call|)
argument_list|(
name|si
operator|=
operator|*
name|base
operator|++
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULLSPKT
return|;
if|if
condition|(
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
name|base
operator|)
operator|==
literal|255
condition|)
block|{
if|if
condition|(
operator|(
name|base
operator|=
name|pullqb
argument_list|(
name|qb
argument_list|,
literal|2
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
return|return
name|s
return|;
block|}
name|nread
operator|+=
literal|2
expr_stmt|;
name|s
operator|->
name|s_li
operator|=
operator|(
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
name|base
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|(
name|base
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
block|}
else|else
name|s
operator|->
name|s_li
operator|=
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
name|base
operator|)
expr_stmt|;
name|pgilen
operator|=
name|pktlen
operator|=
name|s
operator|->
name|s_li
expr_stmt|;
if|if
condition|(
name|cat0
condition|)
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_GT
case|:
name|Set
argument_list|(
name|SMASK_SPDU_GT
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AB
case|:
name|Set
argument_list|(
name|SMASK_SPDU_AB
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AA
case|:
name|Set
argument_list|(
name|SMASK_SPDU_AA
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
operator|(
name|si
operator|>=
name|SI_TABLE_LEN
operator|)
operator|||
operator|(
operator|(
name|pmask
operator|=
name|si_table
index|[
name|si
index|]
operator|)
operator|==
name|PMASK_NOTSUPPORTED
operator|)
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
return|return
name|s
return|;
block|}
if|if
condition|(
name|len
operator|<
name|pktlen
operator|+
name|nread
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
return|return
name|s
return|;
block|}
name|s
operator|->
name|s_errno
operator|=
name|SC_ACCEPT
expr_stmt|;
name|xbase
operator|=
name|base
expr_stmt|;
while|while
condition|(
name|pktlen
operator|&&
operator|(
name|s
operator|->
name|s_errno
operator|==
name|SC_ACCEPT
operator|)
condition|)
block|{
name|advance
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|code
operator|=
operator|*
name|base
operator|++
expr_stmt|;
if|if
condition|(
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
name|base
operator|)
operator|==
literal|255
condition|)
block|{
name|base
operator|++
expr_stmt|;
name|advance
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|li
operator|=
operator|(
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
name|base
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|(
name|base
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
name|xlen
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|li
operator|=
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
name|base
operator|)
expr_stmt|;
name|xlen
operator|=
literal|1
expr_stmt|;
block|}
name|base
operator|+=
name|xlen
expr_stmt|;
if|if
condition|(
name|xlen
operator|>
literal|1
condition|)
name|xlen
operator|+=
literal|2
expr_stmt|;
else|else
name|xlen
operator|++
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|PI_UDATA
case|:
if|if
condition|(
operator|!
operator|(
name|pmask
operator|&
name|PMASK_UDATA
operator|)
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|PI_XDATA
case|:
if|if
condition|(
operator|!
operator|(
name|pmask
operator|&
name|PMASK_XDATA
operator|)
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|code
operator|>=
name|PI_TABLE_LEN
operator|||
operator|!
operator|(
name|pmask
operator|&
name|pi_table
index|[
name|code
index|]
operator|)
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|s
operator|->
name|s_errno
operator|!=
name|SC_ACCEPT
condition|)
break|break;
if|if
condition|(
operator|!
name|pgilen
condition|)
name|pgilen
operator|=
name|pktlen
expr_stmt|;
name|pktlen
operator|-=
operator|(
name|xlen
operator|+
name|li
operator|)
expr_stmt|;
if|if
condition|(
name|li
operator|>
operator|(
name|pgilen
operator|-=
name|xlen
operator|)
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|pgilen
operator|-=
name|li
expr_stmt|;
if|if
condition|(
name|li
condition|)
name|advance
argument_list|(
name|li
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
name|PI_TABLE_LEN
condition|)
block|{
if|if
condition|(
name|li
condition|)
block|{
if|if
condition|(
name|pi_table
index|[
name|code
index|]
operator|&
name|PMASK_VARLEN
condition|)
block|{
if|if
condition|(
name|li
operator|>
name|pi_length
index|[
name|code
index|]
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|li
operator|!=
name|pi_length
index|[
name|code
index|]
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
block|}
block|}
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|PGI_AR_LINK
case|:
name|Set
argument_list|(
name|SMASK_AR_OID
argument_list|)
expr_stmt|;
comment|/* HACK! */
goto|goto
name|do_pgi
goto|;
case|case
name|PGI_CN_ID
case|:
name|Set
argument_list|(
name|SMASK_CN_REF
argument_list|)
expr_stmt|;
comment|/* fall */
case|case
name|PGI_CN_ITEMS
case|:
name|do_pgi
label|:
empty_stmt|;
name|pktlen
operator|+=
name|li
expr_stmt|;
name|pgilen
operator|=
name|li
expr_stmt|;
name|li
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|PI_CALLED_SS
case|:
case|case
name|PI_CALLING_SS
case|:
ifdef|#
directive|ifdef
name|notdef
case|case
name|PI_AR_CALLED
case|:
case|case
name|PI_AR_CALLING
case|:
endif|#
directive|endif
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_CN
case|:
case|case
name|SPDU_AC
case|:
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_ulen
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_udata
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_CN_REF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RF
case|:
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_ulen
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_udata
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_RF_REF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AR
case|:
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|PI_AR_CALLED
case|:
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_called_len
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_called
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_AR_REF
argument_list|)
expr_stmt|;
break|break;
case|case
name|PI_AR_CALLING
case|:
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_calling_len
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_calling
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_AR_REF
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|PI_COMMON_REF
case|:
ifdef|#
directive|ifdef
name|notdef
case|case
name|PI_AR_COMMON
case|:
endif|#
directive|endif
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_CN
case|:
case|case
name|SPDU_AC
case|:
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_clen
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_cdata
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_CN_REF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RF
case|:
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_clen
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_cdata
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_RF_REF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AR
case|:
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_clen
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_cdata
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_AR_REF
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|PI_ADD_INFO
case|:
ifdef|#
directive|ifdef
name|notdef
case|case
name|PI_AR_ADDT
case|:
endif|#
directive|endif
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_CN
case|:
case|case
name|SPDU_AC
case|:
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_alen
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_cn_reference
operator|.
name|sr_adata
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_CN_REF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RF
case|:
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_alen
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_rf_reference
operator|.
name|sr_adata
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_RF_REF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AR
case|:
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_alen
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_ar_reference
operator|.
name|sr_adata
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_AR_REF
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|PI_PROTOCOL_OPT
case|:
if|if
condition|(
operator|(
name|s
operator|->
name|s_options
operator|=
operator|*
name|base
operator|++
operator|)
operator|&
operator|~
name|CR_OPT_MASK
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
else|else
name|Set
argument_list|(
name|SMASK_CN_OPT
argument_list|)
expr_stmt|;
break|break;
case|case
name|PI_TSDU_MAXSIZ
case|:
block|{
name|u_long
name|tsdu_maxsize
decl_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|tsdu_maxsize
argument_list|,
name|pi_length
index|[
name|PI_TSDU_MAXSIZ
index|]
argument_list|)
expr_stmt|;
name|tsdu_maxsize
operator|=
name|ntohl
argument_list|(
name|tsdu_maxsize
argument_list|)
expr_stmt|;
name|s
operator|->
name|s_tsdu_init
operator|=
operator|(
name|tsdu_maxsize
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
expr_stmt|;
name|s
operator|->
name|s_tsdu_resp
operator|=
name|tsdu_maxsize
operator|&
literal|0xffff
expr_stmt|;
name|Set
argument_list|(
name|SMASK_CN_TSDU
argument_list|)
expr_stmt|;
block|}
name|base
operator|+=
name|pi_length
index|[
name|PI_TSDU_MAXSIZ
index|]
expr_stmt|;
break|break;
case|case
name|PI_VERSION
case|:
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_CN
case|:
case|case
name|SPDU_AC
case|:
name|s
operator|->
name|s_cn_version
operator|=
operator|*
name|base
operator|++
expr_stmt|;
name|Set
argument_list|(
name|SMASK_CN_VRSN
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RF
case|:
name|s
operator|->
name|s_rf_version
operator|=
operator|*
name|base
operator|++
expr_stmt|;
name|Set
argument_list|(
name|SMASK_RF_VRSN
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|PI_SYNC
case|:
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_MIP
case|:
if|if
condition|(
operator|(
name|s
operator|->
name|s_mip_sync
operator|=
operator|*
name|base
operator|++
operator|)
operator|&
operator|~
name|MIP_SYNC_MASK
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
else|else
name|Set
argument_list|(
name|SMASK_MIP_SYNC
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_MAP
case|:
if|if
condition|(
operator|(
name|s
operator|->
name|s_map_sync
operator|=
operator|*
name|base
operator|++
operator|)
operator|&
operator|~
name|MAP_SYNC_MASK
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
else|else
name|Set
argument_list|(
name|SMASK_MAP_SYNC
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|PI_TOKEN_SET
case|:
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_CN
case|:
case|case
name|SPDU_AC
case|:
name|s
operator|->
name|s_settings
operator|=
operator|*
name|base
operator|++
expr_stmt|;
name|Set
argument_list|(
name|SMASK_CN_SET
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RS
case|:
name|s
operator|->
name|s_rs_settings
operator|=
operator|*
name|base
operator|++
expr_stmt|;
name|Set
argument_list|(
name|SMASK_RS_SET
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RA
case|:
name|s
operator|->
name|s_ra_settings
operator|=
operator|*
name|base
operator|++
expr_stmt|;
name|Set
argument_list|(
name|SMASK_RA_SET
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|PI_TOKEN
case|:
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_AC
case|:
name|s
operator|->
name|s_ac_token
operator|=
operator|*
name|base
operator|++
expr_stmt|;
name|Set
argument_list|(
name|SMASK_AC_TOKEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_GT
case|:
name|If_Reset
argument_list|(
argument|SMASK_SPDU_GT
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|s
operator|->
name|s_gt_token
operator|=
operator|*
name|base
operator|++
expr_stmt|;
name|Set
argument_list|(
name|SMASK_GT_TOKEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_PT
case|:
name|s
operator|->
name|s_pt_token
operator|=
operator|*
name|base
operator|++
expr_stmt|;
name|Set
argument_list|(
name|SMASK_PT_TOKEN
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|PI_TDISC
case|:
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_RF
case|:
if|if
condition|(
operator|(
name|s
operator|->
name|s_rf_disconnect
operator|=
operator|*
name|base
operator|++
operator|)
operator|&
operator|~
name|RF_DISC_MASK
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
else|else
name|Set
argument_list|(
name|SMASK_RF_DISC
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_FN
case|:
if|if
condition|(
operator|(
name|s
operator|->
name|s_fn_disconnect
operator|=
operator|*
name|base
operator|++
operator|)
operator|&
operator|~
name|FN_DISC_MASK
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
else|else
name|Set
argument_list|(
name|SMASK_FN_DISC
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AB
case|:
name|If_Reset
argument_list|(
argument|SMASK_SPDU_AB
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|s
operator|->
name|s_ab_disconnect
operator|=
operator|*
name|base
operator|++
operator|)
operator|&
operator|~
name|AB_DISC_MASK
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
else|else
name|Set
argument_list|(
name|SMASK_AB_DISC
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|PI_USER_REQ
case|:
block|{
name|u_short
name|requirements
decl_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|requirements
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|requirements
operator|=
name|ntohs
argument_list|(
name|requirements
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|!=
name|SPDU_RF
condition|)
block|{
name|s
operator|->
name|s_cn_require
operator|=
name|requirements
expr_stmt|;
name|Set
argument_list|(
name|SMASK_CN_REQ
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|s
operator|->
name|s_rf_require
operator|=
name|requirements
expr_stmt|;
name|Set
argument_list|(
name|SMASK_RF_REQ
argument_list|)
expr_stmt|;
block|}
block|}
name|base
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|PI_ISN
case|:
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_CN
case|:
case|case
name|SPDU_AC
case|:
name|s
operator|->
name|s_isn
operator|=
name|str2ssn
argument_list|(
name|base
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_CN_ISN
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
case|case
name|PI_ISN2
case|:
comment|/* not supported yet */
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|PI_ENCLOSE
case|:
if|if
condition|(
operator|(
name|si
operator|==
name|SPDU_DT
operator|&&
operator|(
name|s
operator|->
name|s_mask
operator|&
name|SMASK_SPDU_GT
operator|)
operator|)
operator|||
operator|(
name|si
operator|==
name|SPDU_AI
operator|&&
operator|!
operator|(
name|s
operator|->
name|s_mask
operator|&
name|SMASK_SPDU_AB
operator|)
operator|)
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|s
operator|->
name|s_enclose
operator|=
operator|*
name|base
operator|++
operator|)
operator|&
operator|~
name|ENCL_MASK
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
else|else
name|Set
argument_list|(
name|SMASK_ENCLOSE
argument_list|)
expr_stmt|;
break|break;
case|case
name|PI_RESYNC
case|:
name|s
operator|->
name|s_rs_type
operator|=
operator|*
name|base
operator|++
expr_stmt|;
if|if
condition|(
name|SYNC_OK
argument_list|(
name|s
operator|->
name|s_rs_type
argument_list|)
condition|)
name|Set
argument_list|(
name|SMASK_RS_TYPE
argument_list|)
expr_stmt|;
else|else
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|PI_ACT_ID
case|:
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_AS
case|:
name|s
operator|->
name|s_as_id
operator|.
name|sd_len
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_as_id
operator|.
name|sd_data
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_AS_ID
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AR
case|:
if|if
condition|(
operator|(
name|s
operator|->
name|s_mask
operator|&
name|SMASK_AR_OID
operator|)
operator|&&
name|s
operator|->
name|s_ar_oid
operator|.
name|sd_len
operator|==
literal|0
condition|)
block|{
name|s
operator|->
name|s_ar_oid
operator|.
name|sd_len
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_ar_oid
operator|.
name|sd_data
argument_list|,
name|li
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|s
operator|->
name|s_ar_id
operator|.
name|sd_len
operator|=
name|li
expr_stmt|;
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_ar_id
operator|.
name|sd_data
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_AR_ID
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|PI_SERIAL
case|:
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_MIP
case|:
name|s
operator|->
name|s_mip_serial
operator|=
name|str2ssn
argument_list|(
name|base
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_MIP_SERIAL
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_MAP
case|:
name|s
operator|->
name|s_map_serial
operator|=
name|str2ssn
argument_list|(
name|base
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_MAP_SERIAL
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_MIA
case|:
name|s
operator|->
name|s_mia_serial
operator|=
name|str2ssn
argument_list|(
name|base
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_MIA_SERIAL
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_MAA
case|:
name|s
operator|->
name|s_maa_serial
operator|=
name|str2ssn
argument_list|(
name|base
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_MAA_SERIAL
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RS
case|:
name|s
operator|->
name|s_rs_serial
operator|=
name|str2ssn
argument_list|(
name|base
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_RS_SSN
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_RA
case|:
name|s
operator|->
name|s_ra_serial
operator|=
name|str2ssn
argument_list|(
name|base
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_RA_SSN
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_AR
case|:
name|s
operator|->
name|s_ar_serial
operator|=
name|str2ssn
argument_list|(
name|base
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_AR_SSN
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|PI_MIA_DATA
case|:
case|case
name|PI_UDATA
case|:
case|case
name|PI_XDATA
case|:
name|Set
argument_list|(
name|SMASK_UDATA_PGI
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|li
condition|)
break|break;
if|if
condition|(
name|si
operator|==
name|SPDU_AB
operator|&&
operator|!
operator|(
name|s
operator|->
name|s_mask
operator|&
name|SMASK_SPDU_AB
operator|)
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|li
operator|>
operator|(
name|code
operator|!=
name|PI_XDATA
condition|?
name|SEGMENT_MAX
else|:
name|CONNECT_MAX
operator|)
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|s
operator|->
name|s_udata
operator|=
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|s
operator|->
name|s_ulen
operator|=
name|li
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_udata
operator|==
name|NULL
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_CONGEST
expr_stmt|;
break|break;
block|}
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_udata
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|PI_REASON
case|:
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_RF
case|:
name|s
operator|->
name|s_rdata
operator|=
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|s
operator|->
name|s_rlen
operator|=
name|li
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_rdata
operator|==
name|NULL
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_CONGEST
expr_stmt|;
break|break;
block|}
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_rdata
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|SPDU_ED
case|:
name|s
operator|->
name|s_ed_reason
operator|=
operator|*
name|base
operator|++
expr_stmt|;
if|if
condition|(
name|li
operator|==
literal|1
operator|&&
name|SP_OK
argument_list|(
name|s
operator|->
name|s_ed_reason
argument_list|)
condition|)
name|Set
argument_list|(
name|SMASK_ED_REASON
argument_list|)
expr_stmt|;
else|else
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_AI
case|:
name|If_Set
argument_list|(
argument|SMASK_SPDU_AB
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|s
operator|->
name|s_ai_reason
operator|=
operator|*
name|base
operator|++
expr_stmt|;
if|if
condition|(
name|li
operator|==
literal|1
operator|&&
name|SP_OK
argument_list|(
name|s
operator|->
name|s_ai_reason
argument_list|)
condition|)
name|Set
argument_list|(
name|SMASK_AI_REASON
argument_list|)
expr_stmt|;
else|else
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_AD
case|:
name|s
operator|->
name|s_ad_reason
operator|=
operator|*
name|base
operator|++
expr_stmt|;
if|if
condition|(
name|li
operator|==
literal|1
operator|&&
name|SP_OK
argument_list|(
name|s
operator|->
name|s_ad_reason
argument_list|)
condition|)
name|Set
argument_list|(
name|SMASK_AD_REASON
argument_list|)
expr_stmt|;
else|else
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|PI_REFLECT
case|:
switch|switch
condition|(
name|si
condition|)
block|{
case|case
name|SPDU_AB
case|:
name|If_Reset
argument_list|(
argument|SMASK_SPDU_AB
argument_list|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|li
operator|>
name|AB_REFL_SIZE
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|bcopy
argument_list|(
name|base
argument_list|,
operator|(
name|char
operator|*
operator|)
name|s
operator|->
name|s_reflect
argument_list|,
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_AB_REFL
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPDU_ER
case|:
name|s
operator|->
name|s_udata
operator|=
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|s
operator|->
name|s_ulen
operator|=
name|li
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|s_udata
operator|==
name|NULL
condition|)
block|{
name|s
operator|->
name|s_errno
operator|=
name|SC_CONGEST
expr_stmt|;
break|break;
block|}
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_udata
argument_list|,
name|li
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|PI_SSAP_CALLING
case|:
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_calling
argument_list|,
name|s
operator|->
name|s_callinglen
operator|=
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_CN_CALLING
argument_list|)
expr_stmt|;
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|PI_SSAP_CALLED
case|:
name|bcopy
argument_list|(
name|base
argument_list|,
name|s
operator|->
name|s_called
argument_list|,
name|s
operator|->
name|s_calledlen
operator|=
name|li
argument_list|)
expr_stmt|;
name|Set
argument_list|(
name|SMASK_CN_CALLED
argument_list|)
expr_stmt|;
name|base
operator|+=
name|li
expr_stmt|;
break|break;
case|case
name|PI_PREPARE
case|:
if|if
condition|(
operator|(
name|s
operator|->
name|s_pr_type
operator|=
operator|*
name|base
operator|++
operator|)
operator|>
name|PR_MAX
condition|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
else|else
name|Set
argument_list|(
name|SMASK_PR_TYPE
argument_list|)
expr_stmt|;
break|break;
default|default:
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
block|}
comment|/* NB: caller responsible for mapping user info to s -> s_qbuf */
if|if
condition|(
name|cc
condition|)
operator|*
name|cc
operator|=
name|nread
expr_stmt|;
block|{
comment|/* "dangling" qbuf */
specifier|register
name|struct
name|qbuf
modifier|*
name|qp
decl_stmt|;
if|if
condition|(
operator|(
name|qp
operator|=
name|qb
operator|->
name|qb_forw
operator|)
operator|!=
name|qb
operator|&&
name|qp
operator|->
name|qb_len
operator|<=
literal|0
condition|)
block|{
name|remque
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|qp
argument_list|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|s
operator|->
name|s_code
condition|)
block|{
case|case
name|SPDU_AB
case|:
name|If_Set
argument_list|(
argument|SMASK_SPDU_AB
argument_list|)
block|{
name|If_Reset
argument_list|(
argument|SMASK_AB_DISC
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
block|}
break|break;
case|case
name|SPDU_MIP
case|:
name|If_Reset
argument_list|(
argument|SMASK_MIP_SERIAL
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_MAP
case|:
name|If_Reset
argument_list|(
argument|SMASK_MAP_SERIAL
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_MIA
case|:
name|If_Reset
argument_list|(
argument|SMASK_MIA_SERIAL
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_MAA
case|:
name|If_Reset
argument_list|(
argument|SMASK_MAA_SERIAL
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_RS
case|:
name|If_Reset
argument_list|(
argument|SMASK_RS_TYPE
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_RS_SSN
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_RA
case|:
name|If_Reset
argument_list|(
argument|SMASK_RA_SSN
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_PR
case|:
name|If_Reset
argument_list|(
argument|SMASK_PR_TYPE
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_ED
case|:
name|If_Reset
argument_list|(
argument|SMASK_ED_REASON
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_AS
case|:
name|If_Reset
argument_list|(
argument|SMASK_AS_ID
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
case|case
name|SPDU_AR
case|:
name|If_Reset
argument_list|(
argument|SMASK_AR_OID
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_AR_SSN
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
name|If_Reset
argument_list|(
argument|SMASK_AR_ID
argument_list|)
name|s
operator|->
name|s_errno
operator|=
name|SC_PROTOCOL
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|ssap_log
operator|->
name|ll_events
operator|&
name|LLOG_PDUS
condition|)
name|spkt2text
argument_list|(
name|ssap_log
argument_list|,
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|s
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|struct
name|ssapkt
modifier|*
name|newspkt
parameter_list|(
name|code
parameter_list|)
name|int
name|code
decl_stmt|;
block|{
specifier|register
name|struct
name|ssapkt
modifier|*
name|s
decl_stmt|;
name|s
operator|=
operator|(
expr|struct
name|ssapkt
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|s
operator|->
name|s_code
operator|=
name|code
expr_stmt|;
name|s
operator|->
name|s_qbuf
operator|.
name|qb_forw
operator|=
name|s
operator|->
name|s_qbuf
operator|.
name|qb_back
operator|=
operator|&
name|s
operator|->
name|s_qbuf
expr_stmt|;
return|return
name|s
return|;
block|}
end_function

begin_function
name|int
name|freespkt
parameter_list|(
name|s
parameter_list|)
specifier|register
name|struct
name|ssapkt
modifier|*
name|s
decl_stmt|;
block|{
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return;
switch|switch
condition|(
name|s
operator|->
name|s_code
condition|)
block|{
case|case
name|SPDU_RF
case|:
if|if
condition|(
name|s
operator|->
name|s_rdata
condition|)
name|free
argument_list|(
name|s
operator|->
name|s_rdata
argument_list|)
expr_stmt|;
comment|/* and fall... */
default|default:
if|if
condition|(
name|s
operator|->
name|s_udata
condition|)
name|free
argument_list|(
name|s
operator|->
name|s_udata
argument_list|)
expr_stmt|;
name|QBFREE
argument_list|(
operator|&
name|s
operator|->
name|s_qbuf
argument_list|)
expr_stmt|;
break|break;
block|}
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|s
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


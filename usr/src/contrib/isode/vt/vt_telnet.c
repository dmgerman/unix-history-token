begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* vt_telnet.c - VT telnet profile */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/vt/RCS/vt_telnet.c,v 7.1 91/02/22 09:48:26 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/vt/RCS/vt_telnet.c,v 7.1 91/02/22 09:48:26 mrose Interim $  *  *  * $Log:	vt_telnet.c,v $  * Revision 7.1  91/02/22  09:48:26  mrose  * Interim 6.8  *   * Revision 7.0  89/11/23  22:31:53  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|"vtpm.h"
end_include

begin_include
include|#
directive|include
file|"sector1.h"
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_define
define|#
directive|define
name|VT_BREAK
end_define

begin_undef
undef|#
directive|undef
name|PEPYPARM
end_undef

begin_define
define|#
directive|define
name|PEPYPARM
value|int *
end_define

begin_decl_stmt
specifier|extern
name|struct
name|sgttyb
name|ottyb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|cur_emode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|my_displayobj
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|my_signal_obj
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|my_echo_obj
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|kb_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|di_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|ni_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|na_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|sync_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|ga_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|nego_state
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|my_right
decl_stmt|;
end_decl_stmt

begin_extern
extern|extern transparent;
end_extern

begin_extern
extern|extern do_break;
end_extern

begin_extern
extern|extern telnet_profile;
end_extern

begin_decl_stmt
specifier|extern
name|int
name|connected
decl_stmt|;
end_decl_stmt

begin_macro
name|vt_newline
argument_list|()
end_macro

begin_comment
comment|/*Produce Newline update*/
end_comment

begin_block
block|{
name|TEXT_UPDATE
name|ud
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ud
argument_list|,
sizeof|sizeof
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|echo_sw
operator|=
name|cur_emode
expr_stmt|;
name|ud
operator|.
name|type_sw
operator|=
name|DISPLAY_OBJ
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_name
operator|=
name|my_displayobj
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_type
operator|=
name|DO_NEXT_X
expr_stmt|;
comment|/*Next X-Array*/
name|send_queue
argument_list|(
name|ud
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|vt_char_erase
argument_list|()
end_macro

begin_comment
comment|/*Pointer Relative (x=x-1)& erase current*/
end_comment

begin_block
block|{
name|TEXT_UPDATE
name|ud
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ud
argument_list|,
sizeof|sizeof
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|echo_sw
operator|=
name|cur_emode
expr_stmt|;
name|ud
operator|.
name|type_sw
operator|=
name|DISPLAY_OBJ
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_name
operator|=
name|my_displayobj
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_type
operator|=
name|DO_PTR_REL
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|ptr_rel
operator|.
name|x_true
operator|=
literal|1
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|ptr_rel
operator|.
name|y_true
operator|=
literal|0
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|ptr_rel
operator|.
name|z_true
operator|=
literal|0
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|ptr_rel
operator|.
name|x_value
operator|=
operator|-
literal|1
expr_stmt|;
name|send_queue
argument_list|(
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_type
operator|=
name|DO_ERASE
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|erase
operator|.
name|start_erase
operator|.
name|ptr_type
operator|=
literal|0
expr_stmt|;
comment|/*Current*/
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|erase
operator|.
name|end_erase
operator|.
name|ptr_type
operator|=
literal|0
expr_stmt|;
comment|/*Current*/
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|erase
operator|.
name|erase_attr
operator|=
literal|0
expr_stmt|;
name|send_queue
argument_list|(
name|ud
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|vt_line_erase
argument_list|()
end_macro

begin_comment
comment|/*Erase full x-array& pointer to x = 1*/
end_comment

begin_block
block|{
name|TEXT_UPDATE
name|ud
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ud
argument_list|,
sizeof|sizeof
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|echo_sw
operator|=
name|cur_emode
expr_stmt|;
name|ud
operator|.
name|type_sw
operator|=
name|DISPLAY_OBJ
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_name
operator|=
name|my_displayobj
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_type
operator|=
name|DO_ERASE
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|erase
operator|.
name|start_erase
operator|.
name|ptr_type
operator|=
literal|3
expr_stmt|;
comment|/*Start X*/
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|erase
operator|.
name|end_erase
operator|.
name|ptr_type
operator|=
literal|6
expr_stmt|;
comment|/*End X*/
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|erase
operator|.
name|erase_attr
operator|=
literal|0
expr_stmt|;
name|send_queue
argument_list|(
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_type
operator|=
name|DO_PTR_ABS
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|ptr_abs
operator|.
name|ptr_type
operator|=
literal|3
expr_stmt|;
comment|/*Start X*/
name|send_queue
argument_list|(
name|ud
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|vt_interrupt
argument_list|()
end_macro

begin_comment
comment|/*Toggle Bit 1 of DI/KB control object*/
end_comment

begin_block
block|{
name|TEXT_UPDATE
name|ud
decl_stmt|;
name|char
name|int_mask
decl_stmt|;
name|char
name|image
decl_stmt|;
name|int_mask
operator|=
name|IP_OBJ
expr_stmt|;
if|if
condition|(
name|my_right
operator|==
name|INITIATOR
condition|)
block|{
name|kb_image
operator|^=
name|IP_OBJ
expr_stmt|;
name|image
operator|=
name|kb_image
expr_stmt|;
block|}
else|else
block|{
name|di_image
operator|^=
name|IP_OBJ
expr_stmt|;
comment|/*Toggle the Interrupt Process bit*/
name|image
operator|=
name|di_image
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ud
argument_list|,
sizeof|sizeof
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|echo_sw
operator|=
name|cur_emode
expr_stmt|;
name|ud
operator|.
name|type_sw
operator|=
name|CTRL_OBJ
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_name
operator|=
name|my_signal_obj
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_type
operator|=
literal|1
expr_stmt|;
comment|/*Boolean Update*/
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|=
operator|&
name|image
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|val_count
operator|=
name|KB_SIZE
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask
operator|=
operator|&
name|int_mask
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask_count
operator|=
name|KB_SIZE
expr_stmt|;
name|send_queue
argument_list|(
name|ud
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|vt_set_nego
argument_list|(
argument|image
argument_list|,
argument|mask
argument_list|)
end_macro

begin_comment
comment|/*Update NA/NI control object as in image*/
end_comment

begin_decl_stmt
name|char
name|image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|mask
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|TEXT_UPDATE
name|ud
decl_stmt|;
name|char
name|e_image
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ud
argument_list|,
sizeof|sizeof
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|echo_sw
operator|=
name|cur_emode
expr_stmt|;
name|ud
operator|.
name|type_sw
operator|=
name|CTRL_OBJ
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_name
operator|=
name|my_echo_obj
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_type
operator|=
literal|1
expr_stmt|;
comment|/*Boolean*/
name|e_image
operator|=
name|image
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|=
operator|&
name|e_image
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|val_count
operator|=
name|NA_SIZE
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask
operator|=
operator|&
name|mask
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask_count
operator|=
name|NA_SIZE
expr_stmt|;
name|send_queue
argument_list|(
name|ud
argument_list|)
expr_stmt|;
name|vtsend
argument_list|()
expr_stmt|;
comment|/*Since we're bypassing normal keyboard entry*/
block|}
end_block

begin_escape
end_escape

begin_macro
name|vt_echo
argument_list|(
argument|echo
argument_list|)
end_macro

begin_decl_stmt
name|int
name|echo
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|telnet_profile
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"not using TELNET profile"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|ni_image
operator|&
name|ECHO_OBJ
operator|)
operator|!=
operator|(
name|nego_state
operator|&
name|ECHO_OBJ
operator|)
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"negotiation in progress, try again later..."
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|echo
operator|!=
operator|(
operator|(
name|nego_state
operator|&
name|ECHO_OBJ
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|echo
condition|)
name|ni_image
operator||=
name|ECHO_OBJ
expr_stmt|;
else|else
name|ni_image
operator|&=
operator|~
name|ECHO_OBJ
expr_stmt|;
name|vt_set_nego
argument_list|(
name|ni_image
argument_list|,
name|ECHO_OBJ
argument_list|)
expr_stmt|;
comment|/*Set proper UNIX echo state when reponse 				  is received. */
block|}
else|else
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"already using %s echoing"
argument_list|,
name|echo
condition|?
literal|"remote"
else|:
literal|"local"
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|vt_rem_echo
argument_list|(
argument|img_addr
argument_list|)
end_macro

begin_comment
comment|/*Request Remote Echo Mode.  Parameter is pointer 			  to image byte. */
end_comment

begin_decl_stmt
name|char
modifier|*
name|img_addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
operator|*
name|img_addr
operator||=
name|ECHO_OBJ
expr_stmt|;
name|vt_set_nego
argument_list|(
operator|*
name|img_addr
argument_list|,
name|ECHO_OBJ
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|vt_sup_ga
argument_list|(
argument|img_addr
argument_list|)
end_macro

begin_comment
comment|/*Request Suppress Go Ahead*/
end_comment

begin_decl_stmt
name|char
modifier|*
name|img_addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
operator|*
name|img_addr
operator||=
name|SUP_GA
expr_stmt|;
name|vt_set_nego
argument_list|(
operator|*
name|img_addr
argument_list|,
name|SUP_GA
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* ARGSUSED */
end_comment

begin_macro
name|vt_break
argument_list|(
argument|vec
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|vec
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|VT_BREAK
if|if
condition|(
operator|!
name|do_break
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"VT-BREAK Functional Unit Not Chosen"
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
operator|(
name|void
operator|)
name|tmode
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|vt_clr_obj
argument_list|()
expr_stmt|;
comment|/*Initialize all control objects*/
name|vbrkreq
argument_list|()
expr_stmt|;
else|#
directive|else
name|TEXT_UPDATE
name|ud
decl_stmt|;
name|mask
operator|=
name|BRK_OBJ
expr_stmt|;
name|kb_image
operator|^=
name|BRK_OBJ
expr_stmt|;
comment|/*Can Only be called by User side*/
name|image
operator|=
name|kb_image
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ud
argument_list|,
sizeof|sizeof
expr|*
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|echo_sw
operator|=
name|cur_emode
expr_stmt|;
name|ud
operator|.
name|type_sw
operator|=
name|CTRL_OBJ
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_name
operator|=
name|my_signal_obj
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_type
operator|=
literal|1
expr_stmt|;
comment|/*Boolean Update*/
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|=
operator|&
name|image
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|val_count
operator|=
name|KB_SIZE
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask
operator|=
operator|&
name|mask
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask_count
operator|=
name|KB_SIZE
expr_stmt|;
name|send_queue
argument_list|(
name|ud
argument_list|)
expr_stmt|;
name|vtsend
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
name|OK
return|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* ARGSUSED */
end_comment

begin_macro
name|vt_ayt
argument_list|(
argument|vec
argument_list|)
end_macro

begin_comment
comment|/*Send Are You There*/
end_comment

begin_decl_stmt
name|char
modifier|*
modifier|*
name|vec
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|TEXT_UPDATE
name|ud
decl_stmt|;
name|char
name|mask
decl_stmt|;
name|char
name|image
decl_stmt|;
if|if
condition|(
operator|!
name|telnet_profile
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"not using TELNET profile"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|mask
operator|=
name|AYT_OBJ
expr_stmt|;
name|kb_image
operator|^=
name|AYT_OBJ
expr_stmt|;
comment|/*Can only be called by User side*/
name|image
operator|=
name|kb_image
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ud
argument_list|,
sizeof|sizeof
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|echo_sw
operator|=
name|cur_emode
expr_stmt|;
name|ud
operator|.
name|type_sw
operator|=
name|CTRL_OBJ
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_name
operator|=
name|my_signal_obj
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_type
operator|=
literal|1
expr_stmt|;
comment|/*Boolean Update*/
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|=
operator|&
name|image
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|val_count
operator|=
name|KB_SIZE
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask
operator|=
operator|&
name|mask
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask_count
operator|=
name|KB_SIZE
expr_stmt|;
name|send_queue
argument_list|(
name|ud
argument_list|)
expr_stmt|;
name|vtsend
argument_list|()
expr_stmt|;
return|return
name|OK
return|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|switch_rep
argument_list|(
argument|rep_num
argument_list|)
end_macro

begin_comment
comment|/*Change to specified repertoire. 	             Switching is done by sending 		     a Write Attribute NDQ. 		   */
end_comment

begin_decl_stmt
name|int
name|rep_num
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|TEXT_UPDATE
name|ud
decl_stmt|;
if|if
condition|(
name|rep_num
operator|==
literal|1
condition|)
name|transparent
operator|=
literal|0
expr_stmt|;
else|else
name|transparent
operator|=
literal|1
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ud
argument_list|,
sizeof|sizeof
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|echo_sw
operator|=
name|cur_emode
expr_stmt|;
name|ud
operator|.
name|type_sw
operator|=
name|DISPLAY_OBJ
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_name
operator|=
name|my_displayobj
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_type
operator|=
name|DO_ATTR
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|wrt_attrib
operator|.
name|attr_id
operator|=
literal|0
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|wrt_attrib
operator|.
name|attr_val
operator|=
name|rep_num
expr_stmt|;
comment|/*Rep Number*/
name|ud
operator|.
name|updates
operator|.
name|do_list
operator|.
name|do_cmd
operator|.
name|wrt_attrib
operator|.
name|attr_ext
operator|=
literal|2
expr_stmt|;
comment|/*Modal Extent*/
name|send_queue
argument_list|(
name|ud
argument_list|)
expr_stmt|;
name|vtsend
argument_list|()
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|vt_repertoire
argument_list|(
argument|repertoire
argument_list|)
end_macro

begin_decl_stmt
name|int
name|repertoire
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|telnet_profile
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"not using TELNET profile"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|repertoire
operator|!=
name|transparent
condition|)
block|{
if|if
condition|(
name|repertoire
condition|)
name|ni_image
operator||=
operator|(
name|DISP_BIN
operator||
name|KBD_BIN
operator|)
expr_stmt|;
else|else
name|ni_image
operator|&=
operator|~
operator|(
name|DISP_BIN
operator||
name|KBD_BIN
operator|)
expr_stmt|;
name|vt_set_nego
argument_list|(
name|ni_image
argument_list|,
name|DISP_BIN
operator||
name|KBD_BIN
argument_list|)
expr_stmt|;
block|}
else|else
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"already using %s repertoire"
argument_list|,
name|transparent
condition|?
literal|"BINARY"
else|:
literal|"ASCII"
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|vt_clr_obj
argument_list|()
end_macro

begin_comment
comment|/*Set TELNET Profile Control Objects to 0*/
end_comment

begin_block
block|{
name|kb_image
operator|=
name|di_image
operator|=
literal|0
expr_stmt|;
name|nego_state
operator|=
name|ni_image
operator|=
name|na_image
operator|=
literal|0
expr_stmt|;
name|sync_image
operator|=
name|ga_image
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|vt_sync
argument_list|(
argument|vec
argument_list|)
end_macro

begin_comment
comment|/*Send TELNET SYNC signal (test for UDQ& typed data)*/
end_comment

begin_decl_stmt
name|char
modifier|*
modifier|*
name|vec
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|PE
name|udqp
decl_stmt|;
name|TEXT_UPDATE
name|ud
decl_stmt|;
name|char
name|mask
decl_stmt|,
name|image
decl_stmt|;
name|mask
operator|=
name|SYNC
expr_stmt|;
name|sync_image
operator|^=
name|SYNC
expr_stmt|;
name|image
operator|=
name|sync_image
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ud
argument_list|,
sizeof|sizeof
name|ud
argument_list|)
expr_stmt|;
name|ud
operator|.
name|echo_sw
operator|=
name|cur_emode
expr_stmt|;
name|ud
operator|.
name|type_sw
operator|=
name|CTRL_OBJ
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_name
operator|=
literal|"SY"
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_type
operator|=
literal|1
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|=
operator|&
name|image
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|val_count
operator|=
name|SYNC_SIZE
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask
operator|=
operator|&
name|mask
expr_stmt|;
name|ud
operator|.
name|updates
operator|.
name|co_list
operator|.
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask_count
operator|=
name|SYNC_SIZE
expr_stmt|;
if|if
condition|(
name|build_UDQPDU_UDQpdu
argument_list|(
operator|&
name|udqp
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULLCP
argument_list|,
operator|(
name|PEPYPARM
operator|)
operator|&
name|ud
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"UDQ build failure"
argument_list|)
expr_stmt|;
name|udqp
operator|->
name|pe_context
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|do_event
argument_list|(
name|VDATreq_u
argument_list|,
name|udqp
argument_list|)
expr_stmt|;
name|pe_free
argument_list|(
name|udqp
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_block

end_unit


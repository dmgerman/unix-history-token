begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* map.c - VT telnet profile mappings */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/vt/RCS/map.c,v 7.2 91/02/22 09:47:58 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/vt/RCS/map.c,v 7.2 91/02/22 09:47:58 mrose Interim $  *  *  * $Log:	map.c,v $  * Revision 7.2  91/02/22  09:47:58  mrose  * Interim 6.8  *   * Revision 7.1  90/07/09  14:51:50  mrose  * sync  *   * Revision 7.0  89/11/23  22:31:31  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_define
define|#
directive|define
name|DO_LOCAL_ECHO
end_define

begin_undef
undef|#
directive|undef
name|PEPYPARM
end_undef

begin_define
define|#
directive|define
name|PEPYPARM
value|int *
end_define

begin_include
include|#
directive|include
file|"vtpm.h"
end_include

begin_include
include|#
directive|include
file|"sector1.h"
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_include
include|#
directive|include
file|<sys/termios.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|char
name|erase_char
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|erase_line
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_decl_stmt
specifier|extern
name|struct
name|termios
name|oterm
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|extern
name|struct
name|sgttyb
name|ottyb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|tchars
name|otc
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|char
name|intr_char
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|ni_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|na_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|nego_state
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|kb_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|di_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|sync_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|ga_image
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|my_right
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|cur_emode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|myhostname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|transparent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|showoptions
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|debug
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|telnet_profile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|TEXT_UPDATE
modifier|*
name|ndq_queue
decl_stmt|,
modifier|*
name|deq
argument_list|()
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*Incoming (From Net) NDQ's*/
end_comment

begin_macro
name|map
argument_list|(
argument|ndq
argument_list|)
end_macro

begin_comment
comment|/*Parse the given NDQ (could contain several updates). 		  Pass individual updates to appropriate processing 		  routine. 		*/
end_comment

begin_decl_stmt
name|PE
name|ndq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|TEXT_UPDATE
modifier|*
name|ud
decl_stmt|;
if|if
condition|(
name|unbuild_NDQPDU_NDQpdu
argument_list|(
name|ndq
argument_list|,
literal|1
argument_list|,
name|NULLIP
argument_list|,
name|NULLVP
argument_list|,
operator|(
name|PEPYPARM
operator|)
literal|0
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"NDQ parse failure (%s)"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|ud
operator|=
name|deq
argument_list|(
operator|&
name|ndq_queue
argument_list|)
condition|)
block|{
if|if
condition|(
name|ud
operator|->
name|type_sw
operator|==
name|DISPLAY_OBJ
condition|)
block|{
name|display_ud
argument_list|(
operator|&
name|ud
operator|->
name|updates
operator|.
name|do_list
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ud
operator|->
name|updates
operator|.
name|do_list
operator|.
name|do_name
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ud
operator|->
name|type_sw
operator|==
name|CTRL_OBJ
condition|)
block|{
name|control_ud
argument_list|(
operator|&
name|ud
operator|->
name|updates
operator|.
name|co_list
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ud
operator|->
name|updates
operator|.
name|co_list
operator|.
name|co_name
argument_list|)
expr_stmt|;
block|}
else|else
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"Invalid Update"
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ud
argument_list|)
expr_stmt|;
block|}
name|pe_free
argument_list|(
name|ndq
argument_list|)
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_macro
name|display_ud
argument_list|(
argument|doptr
argument_list|)
end_macro

begin_comment
comment|/*Handle Display Updates*/
end_comment

begin_decl_stmt
name|DO_UPDATE
modifier|*
name|doptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|pt
decl_stmt|;
ifdef|#
directive|ifdef
name|BSD44
name|struct
name|termios
name|term
decl_stmt|;
else|#
directive|else
name|struct
name|sgttyb
name|ttyb
decl_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|doptr
operator|->
name|do_type
condition|)
block|{
case|case
name|DO_NEXT_X
case|:
if|if
condition|(
name|putch
argument_list|(
literal|'\r'
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"DROPPED CHAR"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|my_right
operator|==
name|INITIATOR
condition|)
block|{
if|if
condition|(
name|putch
argument_list|(
literal|'\n'
argument_list|)
operator|==
name|NOTOK
condition|)
comment|/*Current Telnet only gives 									   CR to PTY*/
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"DROPPED CHAR"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
break|break;
case|case
name|DO_NEXT_Y
case|:
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Next Y Array"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DO_PTR_REL
case|:
comment|/*Ignore for TELNET since next update must 						  be erase. */
break|break;
case|case
name|DO_PTR_ABS
case|:
comment|/*Ignore for TELNET since must have been 						  preceeded by erase line. */
break|break;
case|case
name|DO_TEXT
case|:
for|for
control|(
name|pt
operator|=
name|doptr
operator|->
name|do_cmd
operator|.
name|text_ud
operator|.
name|text_ptr
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|doptr
operator|->
name|do_cmd
operator|.
name|text_ud
operator|.
name|text_count
condition|;
operator|++
name|pt
operator|,
operator|++
name|i
control|)
block|{
if|if
condition|(
name|putch
argument_list|(
operator|*
name|pt
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"DROPPED CHAR"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|free
argument_list|(
name|doptr
operator|->
name|do_cmd
operator|.
name|text_ud
operator|.
name|text_ptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|DO_RPT_TEXT
case|:
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Repeat Text"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DO_ATTR
case|:
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Write Attribute"
argument_list|)
expr_stmt|;
name|attrib_hdlr
argument_list|(
name|doptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|DO_ERASE
case|:
if|if
condition|(
operator|(
name|doptr
operator|->
name|do_cmd
operator|.
name|erase
operator|.
name|start_erase
operator|.
name|ptr_type
operator|==
literal|0
operator|)
operator|&&
operator|(
name|doptr
operator|->
name|do_cmd
operator|.
name|erase
operator|.
name|end_erase
operator|.
name|ptr_type
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|my_right
operator|==
name|ACCEPTOR
condition|)
block|{
ifdef|#
directive|ifdef
name|BSD44
if|if
condition|(
name|tcgetattr
argument_list|(
name|pty
argument_list|,
operator|&
name|term
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|putch
argument_list|(
name|erase_char
operator|=
name|term
operator|.
name|c_cc
index|[
name|VERASE
index|]
argument_list|)
expr_stmt|;
comment|/* XXX what if _POSIX_VDISABLE */
else|#
directive|else
if|if
condition|(
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCGETP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ttyb
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ioctl failed"
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|putch
argument_list|(
name|ttyb
operator|.
name|sg_erase
argument_list|)
expr_stmt|;
name|erase_char
operator|=
name|ttyb
operator|.
name|sg_erase
expr_stmt|;
endif|#
directive|endif
block|}
else|else
operator|(
name|void
operator|)
name|putch
argument_list|(
name|erase_char
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|doptr
operator|->
name|do_cmd
operator|.
name|erase
operator|.
name|start_erase
operator|.
name|ptr_type
operator|==
literal|3
operator|)
operator|&&
operator|(
name|doptr
operator|->
name|do_cmd
operator|.
name|erase
operator|.
name|end_erase
operator|.
name|ptr_type
operator|==
literal|6
operator|)
condition|)
block|{
if|if
condition|(
name|my_right
operator|==
name|ACCEPTOR
condition|)
block|{
ifdef|#
directive|ifdef
name|BSD44
if|if
condition|(
name|tcgetattr
argument_list|(
name|pty
argument_list|,
operator|&
name|term
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|putch
argument_list|(
name|erase_line
operator|=
name|term
operator|.
name|c_cc
index|[
name|VKILL
index|]
argument_list|)
expr_stmt|;
comment|/* XXX what if _POSIX_VDISABLE */
else|#
directive|else
if|if
condition|(
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCGETP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ttyb
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ioctl failed"
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|putch
argument_list|(
name|ttyb
operator|.
name|sg_kill
argument_list|)
expr_stmt|;
name|erase_line
operator|=
name|ttyb
operator|.
name|sg_kill
expr_stmt|;
endif|#
directive|endif
block|}
else|else
operator|(
name|void
operator|)
name|putch
argument_list|(
name|erase_line
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|DO_PREV_X
case|:
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Previous X-Array\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DO_PREV_Y
case|:
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Previous Y-Array\n"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*End Switch*/
block|}
end_block

begin_escape
end_escape

begin_macro
name|control_ud
argument_list|(
argument|coptr
argument_list|)
end_macro

begin_comment
comment|/*Handle Control Object Updates*/
end_comment

begin_decl_stmt
name|CO_UPDATE
modifier|*
name|coptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|active
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|BSD44
name|struct
name|termios
name|term
decl_stmt|;
else|#
directive|else
name|struct
name|sgttyb
name|sb
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|telnet_profile
condition|)
block|{
if|if
condition|(
operator|(
name|my_right
operator|==
name|INITIATOR
operator|)
operator|&&
operator|(
operator|!
name|strcmp
argument_list|(
name|coptr
operator|->
name|co_name
argument_list|,
literal|"E"
argument_list|)
operator|)
condition|)
comment|/*The Echo Control Object in Default Profile is WACA*/
name|def_echo
argument_list|(
name|coptr
argument_list|)
expr_stmt|;
else|else
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"Received Invalid CO Update under Default Profile\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|coptr
operator|->
name|co_type
operator|!=
literal|1
condition|)
comment|/*Only Booleans allowed in TELNET*/
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"Invalid CO Type\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask_count
operator|==
literal|0
condition|)
name|active
operator|=
literal|0xff
expr_stmt|;
else|else
name|active
operator|=
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask
expr_stmt|;
if|if
condition|(
name|my_right
operator|==
name|INITIATOR
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|coptr
operator|->
name|co_name
argument_list|,
literal|"DI"
argument_list|)
condition|)
block|{
if|if
condition|(
name|active
operator|&
name|AYT_OBJ
condition|)
comment|/*If This CO contains potential update to Are You There bit*/
block|{
if|if
condition|(
operator|(
name|di_image
operator|&
name|AYT_OBJ
operator|)
operator|!=
operator|(
name|AYT_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
condition|)
comment|/*If this bit was toggled*/
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled AYT in DI\n"
argument_list|)
expr_stmt|;
name|di_image
operator|^=
name|AYT_OBJ
expr_stmt|;
comment|/*Save the new value*/
block|}
block|}
if|if
condition|(
name|active
operator|&
name|AO_OBJ
condition|)
comment|/*If potential update to Abort Output bit*/
block|{
if|if
condition|(
operator|(
name|di_image
operator|&
name|AO_OBJ
operator|)
operator|!=
operator|(
name|AO_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
condition|)
comment|/*Toggled AO bit*/
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled AO in DI\n"
argument_list|)
expr_stmt|;
name|di_image
operator|^=
name|AO_OBJ
expr_stmt|;
comment|/*Record it*/
block|}
block|}
if|if
condition|(
name|active
operator|&
name|IP_OBJ
condition|)
comment|/*If potential update to Interrupt Process bit*/
block|{
if|if
condition|(
operator|(
name|di_image
operator|&
name|IP_OBJ
operator|)
operator|!=
operator|(
name|IP_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
condition|)
comment|/*Toggled AO bit*/
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled IP in DI/n"
argument_list|)
expr_stmt|;
name|di_image
operator|^=
name|IP_OBJ
expr_stmt|;
block|}
block|}
if|if
condition|(
name|active
operator|&
name|DM_OBJ
condition|)
block|{
if|if
condition|(
operator|(
name|di_image
operator|&
name|DM_OBJ
operator|)
operator|!=
operator|(
name|DM_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
condition|)
comment|/*Toggled DM Bit*/
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled DM in DI\n"
argument_list|)
expr_stmt|;
name|di_image
operator|^=
name|DM_OBJ
expr_stmt|;
block|}
block|}
if|if
condition|(
name|active
operator|&
name|BRK_OBJ
condition|)
block|{
if|if
condition|(
operator|(
name|di_image
operator|&
name|BRK_OBJ
operator|)
operator|!=
operator|(
name|BRK_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
condition|)
comment|/*Toggled Break Bit*/
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled BRK in DI\n"
argument_list|)
expr_stmt|;
name|di_image
operator|^=
name|BRK_OBJ
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|coptr
operator|->
name|co_name
argument_list|,
literal|"NA"
argument_list|)
condition|)
block|{
if|if
condition|(
name|active
operator|&
name|ECHO_OBJ
condition|)
comment|/*Update to Echo Control Object*/
block|{
if|if
condition|(
name|ECHO_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
condition|)
comment|/*Request from Server for Remote Echo*/
block|{
name|na_image
operator||=
name|ECHO_OBJ
expr_stmt|;
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Remote Echo Update Received\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ECHO_OBJ
operator|&
name|nego_state
condition|)
comment|/*If now in Remote Echo*/
block|{
if|if
condition|(
name|ni_image
operator|&
name|ECHO_OBJ
condition|)
comment|/*No request outstatnding*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Server Request ignored--Now in Remote echo\r\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Request for Local Echo Denied by Server\r\n"
argument_list|)
expr_stmt|;
name|ni_image
operator||=
name|ECHO_OBJ
expr_stmt|;
block|}
block|}
else|else
comment|/*Else Not in Remote Echo*/
block|{
if|if
condition|(
name|ni_image
operator|&
name|ECHO_OBJ
condition|)
comment|/*I Requested Remote Echo*/
comment|/*This must be confirmation*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Server agreed to do Remote Echo\r\n"
argument_list|)
expr_stmt|;
block|}
else|else
comment|/*Request to do Remote Echo*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Server Requested Remote Echo\r\n"
argument_list|)
expr_stmt|;
name|ni_image
operator||=
name|ECHO_OBJ
expr_stmt|;
name|vt_set_nego
argument_list|(
name|ni_image
argument_list|,
name|ECHO_OBJ
argument_list|)
expr_stmt|;
comment|/*Respond "WILL"*/
block|}
operator|(
name|void
operator|)
name|tmode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|nego_state
operator||=
name|ECHO_OBJ
expr_stmt|;
name|cur_emode
operator|=
name|ECHO_NOW
expr_stmt|;
comment|/*Want Server to Echo*/
block|}
block|}
else|else
comment|/*Request from server for Local Echo*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"NA--Local Echo\r\n"
argument_list|)
expr_stmt|;
name|cur_emode
operator|=
name|NOT_ECHO_NOW
expr_stmt|;
name|na_image
operator|&=
operator|~
name|ECHO_OBJ
expr_stmt|;
if|if
condition|(
name|nego_state
operator|&
name|ECHO_OBJ
condition|)
comment|/*If now in Remote Echo*/
block|{
if|if
condition|(
name|ni_image
operator|&
name|ECHO_OBJ
condition|)
comment|/*If no request pending*/
comment|/*Must be request from sender*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Server requested Local Echo -- O.K.\r\n"
argument_list|)
expr_stmt|;
name|ni_image
operator|&=
operator|~
name|ECHO_OBJ
expr_stmt|;
name|vt_set_nego
argument_list|(
name|ni_image
argument_list|,
name|ECHO_OBJ
argument_list|)
expr_stmt|;
comment|/*Respond "WILL"*/
block|}
else|else
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"User request for Local Echo Accepted\r\n"
argument_list|)
expr_stmt|;
block|}
name|nego_state
operator|&=
operator|~
name|ECHO_OBJ
expr_stmt|;
comment|/*			    sb = ottyb; 		/*			    sb.sg_flags |= ECHO|CRMOD|CBREAK; 		/*			    ioctl(fileno(stdin),TIOCSETP,(char*)&sb); 		*/
operator|(
name|void
operator|)
name|tmode
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
comment|/*Else now in Local Echo*/
block|{
if|if
condition|(
name|ni_image
operator|&
name|ECHO_OBJ
condition|)
comment|/*If requeset pending*/
comment|/*Must be negative response*/
block|{
name|ni_image
operator|&=
operator|~
name|ECHO_OBJ
expr_stmt|;
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Request for Remote Echo Denied by Server\r\n"
argument_list|)
expr_stmt|;
block|}
else|else
comment|/*Else no request pending*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Server Request Ignored--Now in Local Echo\r\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|active
operator|&
name|SUP_GA
condition|)
comment|/*Update to Suppress Go Ahead Control Object*/
block|{
if|if
condition|(
name|SUP_GA
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
condition|)
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Suppress Go Ahead\r\n"
argument_list|)
expr_stmt|;
name|na_image
operator||=
name|SUP_GA
expr_stmt|;
if|if
condition|(
operator|(
name|ni_image
operator|&
name|SUP_GA
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|SUP_GA
operator|)
condition|)
comment|/*If no outstanding request from User*/
block|{
if|if
condition|(
operator|!
operator|(
name|nego_state
operator|&
name|SUP_GA
operator|)
condition|)
comment|/*If not currently in Suppress Go Ahead*/
block|{
name|ni_image
operator||=
name|SUP_GA
expr_stmt|;
name|vt_set_nego
argument_list|(
name|ni_image
argument_list|,
name|SUP_GA
argument_list|)
expr_stmt|;
comment|/*Reply "Will"*/
block|}
block|}
name|nego_state
operator||=
name|SUP_GA
expr_stmt|;
comment|/*Either here now or entering*/
block|}
else|else
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Go Ahead\r\n"
argument_list|)
expr_stmt|;
name|na_image
operator|&=
operator|~
name|SUP_GA
expr_stmt|;
if|if
condition|(
operator|(
name|ni_image
operator|&
name|SUP_GA
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|SUP_GA
operator|)
condition|)
comment|/*Must be request from Server*/
block|{
name|ni_image
operator||=
name|SUP_GA
expr_stmt|;
name|vt_set_nego
argument_list|(
name|ni_image
argument_list|,
name|SUP_GA
argument_list|)
expr_stmt|;
comment|/*Reply "Won't"*/
block|}
else|else
comment|/*Else response to my request to Suppress*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Server refuses to Suppress Go Ahead\r\n"
argument_list|)
expr_stmt|;
name|ni_image
operator|&=
operator|~
name|SUP_GA
expr_stmt|;
comment|/*Give Up*/
comment|/*May want to terminate Association here*/
block|}
block|}
block|}
if|if
condition|(
name|active
operator|&
name|DISP_BIN
condition|)
comment|/*Update to WACA Binary Repertoire*/
block|{
if|if
condition|(
name|DISP_BIN
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
condition|)
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"WACA requested Binary Repertoire on DI\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ni_image
operator|&
name|DISP_BIN
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|DISP_BIN
operator|)
condition|)
comment|/*No request outstanding from Initiator*/
block|{
if|if
condition|(
operator|!
operator|(
name|nego_state
operator|&
name|DISP_BIN
operator|)
condition|)
comment|/*If not now binary*/
block|{
name|ni_image
operator||=
name|DISP_BIN
expr_stmt|;
name|vt_set_nego
argument_list|(
name|ni_image
argument_list|,
name|DISP_BIN
argument_list|)
expr_stmt|;
comment|/*Send "Will"*/
block|}
block|}
name|nego_state
operator||=
name|DISP_BIN
expr_stmt|;
name|ni_image
operator||=
name|DISP_BIN
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"WACA requested ASCII Repertoire on DI\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ni_image
operator|&
name|DISP_BIN
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|DISP_BIN
operator|)
condition|)
block|{
if|if
condition|(
name|nego_state
operator|&
name|DISP_BIN
condition|)
comment|/*If not now ASCII*/
block|{
name|ni_image
operator|&=
operator|~
name|DISP_BIN
expr_stmt|;
name|vt_set_nego
argument_list|(
name|ni_image
argument_list|,
name|DISP_BIN
argument_list|)
expr_stmt|;
block|}
block|}
name|nego_state
operator|&=
operator|~
name|DISP_BIN
expr_stmt|;
name|ni_image
operator|&=
operator|~
name|DISP_BIN
expr_stmt|;
block|}
block|}
if|if
condition|(
name|active
operator|&
name|KBD_BIN
condition|)
comment|/*Update to WACI Binary Repertoire*/
block|{
if|if
condition|(
name|KBD_BIN
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
condition|)
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"WACA requested Binary Repertoire on KB\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ni_image
operator|&
name|KBD_BIN
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|KBD_BIN
operator|)
condition|)
comment|/*If no initiator request outstanding*/
block|{
if|if
condition|(
operator|!
operator|(
name|nego_state
operator|&
name|KBD_BIN
operator|)
condition|)
comment|/*If not now binary*/
block|{
name|ni_image
operator||=
name|KBD_BIN
expr_stmt|;
name|vt_set_nego
argument_list|(
name|ni_image
argument_list|,
name|KBD_BIN
argument_list|)
expr_stmt|;
comment|/*Reply "Will"*/
name|switch_rep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/*Send Attribute update to use Binary Repertoire*/
block|}
block|}
else|else
comment|/*Else a response to Initiator Request*/
block|{
if|if
condition|(
name|ni_image
operator|&
name|KBD_BIN
condition|)
comment|/*Positive response*/
name|switch_rep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|ni_image
operator||=
name|KBD_BIN
expr_stmt|;
name|nego_state
operator||=
name|KBD_BIN
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Acceptor requested ASCII Repertoire on KB\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ni_image
operator|&
name|KBD_BIN
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|KBD_BIN
operator|)
condition|)
comment|/*Request from Acceptor*/
block|{
if|if
condition|(
name|nego_state
operator|&
name|KBD_BIN
condition|)
comment|/*If not now ASCII*/
block|{
name|ni_image
operator|&=
operator|~
name|KBD_BIN
expr_stmt|;
name|vt_set_nego
argument_list|(
name|ni_image
argument_list|,
name|KBD_BIN
argument_list|)
expr_stmt|;
comment|/*Reply "Will"*/
name|switch_rep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/*Send Attr to ASCII*/
block|}
block|}
else|else
comment|/*Else response to Initiator Request*/
block|{
if|if
condition|(
operator|!
operator|(
name|ni_image
operator|&
name|KBD_BIN
operator|)
condition|)
comment|/*Positive response*/
name|switch_rep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ni_image
operator|&=
operator|~
name|KBD_BIN
expr_stmt|;
name|nego_state
operator|&=
operator|~
name|KBD_BIN
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
comment|/*Else Server (Display) side*/
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|coptr
operator|->
name|co_name
argument_list|,
literal|"KB"
argument_list|)
condition|)
comment|/*Server receives updates to the Keyboard*/
block|{
if|if
condition|(
name|active
operator|&
name|AYT_OBJ
condition|)
comment|/*If This CO contains potential update to Are You There bit*/
block|{
if|if
condition|(
operator|(
name|kb_image
operator|&
name|AYT_OBJ
operator|)
operator|!=
operator|(
name|AYT_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
condition|)
comment|/*If this bit was toggled*/
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled AYT in KB"
argument_list|)
expr_stmt|;
name|kb_image
operator|^=
name|AYT_OBJ
expr_stmt|;
comment|/*Save the new value*/
if|if
condition|(
name|vt_text
argument_list|(
literal|"[associated with terminal service on "
argument_list|,
name|strlen
argument_list|(
literal|"[associated with terminal service on "
argument_list|)
argument_list|)
operator|!=
name|OK
condition|)
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"vt_text failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vt_text
argument_list|(
name|myhostname
argument_list|,
name|strlen
argument_list|(
name|myhostname
argument_list|)
argument_list|)
operator|!=
name|OK
condition|)
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"vt_text failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vt_text
argument_list|(
literal|"]\r\n"
argument_list|,
literal|3
argument_list|)
operator|!=
name|OK
condition|)
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"vt_text failed"
argument_list|)
expr_stmt|;
name|vtsend
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|active
operator|&
name|AO_OBJ
condition|)
comment|/*If potential update to Abort Output bit*/
block|{
if|if
condition|(
operator|(
name|kb_image
operator|&
name|AO_OBJ
operator|)
operator|!=
operator|(
name|AO_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
condition|)
comment|/*Toggled AO bit*/
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled AO in KB"
argument_list|)
expr_stmt|;
name|kb_image
operator|^=
name|AO_OBJ
expr_stmt|;
comment|/*Record it*/
block|}
block|}
if|if
condition|(
name|active
operator|&
name|IP_OBJ
condition|)
comment|/*If potential update to Interrupt Process bit*/
block|{
if|if
condition|(
operator|(
name|kb_image
operator|&
name|IP_OBJ
operator|)
operator|!=
operator|(
name|IP_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
condition|)
comment|/*Toggled IP bit*/
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled IP in KB"
argument_list|)
expr_stmt|;
name|kb_image
operator|^=
name|IP_OBJ
expr_stmt|;
name|kill_proc
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|active
operator|&
name|DM_OBJ
condition|)
block|{
if|if
condition|(
operator|(
name|kb_image
operator|&
name|DM_OBJ
operator|)
operator|!=
operator|(
name|DM_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
condition|)
block|{
comment|/*Toggled DM BIt*/
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled DM in KB"
argument_list|)
expr_stmt|;
name|kb_image
operator|^=
name|DM_OBJ
expr_stmt|;
block|}
block|}
if|if
condition|(
name|active
operator|&
name|BRK_OBJ
condition|)
comment|/*If potential update to Break Bit*/
block|{
if|if
condition|(
operator|(
name|kb_image
operator|&
name|BRK_OBJ
operator|)
operator|!=
operator|(
name|BRK_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
condition|)
comment|/*Toggled BREAK bit*/
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled BREAK in KB"
argument_list|)
expr_stmt|;
name|kb_image
operator|^=
name|BRK_OBJ
expr_stmt|;
name|kill_proc
argument_list|()
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|coptr
operator|->
name|co_name
argument_list|,
literal|"NI"
argument_list|)
condition|)
block|{
if|if
condition|(
name|active
operator|&
name|ECHO_OBJ
condition|)
comment|/*Update to Echo Control Object*/
block|{
if|if
condition|(
name|ECHO_OBJ
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
condition|)
comment|/*Request from User for Remote Echo*/
block|{
name|ni_image
operator||=
name|ECHO_OBJ
expr_stmt|;
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Remote Echo Update Received\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ECHO_OBJ
operator|&
name|nego_state
condition|)
comment|/*If now in Remote Echo*/
block|{
if|if
condition|(
name|na_image
operator|&
name|ECHO_OBJ
condition|)
comment|/*No request outstatnding*/
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"User Request ignored--Now in Remote echo"
argument_list|)
expr_stmt|;
else|else
comment|/*Must be user's response to a request*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Request for Local Echo Denied by User\n"
argument_list|)
expr_stmt|;
name|na_image
operator||=
name|ECHO_OBJ
expr_stmt|;
block|}
block|}
else|else
comment|/*Else Not in Remote Echo*/
block|{
if|if
condition|(
name|na_image
operator|&
name|ECHO_OBJ
condition|)
comment|/*I Requested Remote Echo*/
comment|/*This must be confirmation*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"User agreed to do Remote Echo\n"
argument_list|)
expr_stmt|;
block|}
else|else
comment|/*Request to do Remote Echo*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"User Requested Remote Echo--O.K.\n"
argument_list|)
expr_stmt|;
name|na_image
operator||=
name|ECHO_OBJ
expr_stmt|;
name|vt_set_nego
argument_list|(
name|na_image
argument_list|,
name|ECHO_OBJ
argument_list|)
expr_stmt|;
comment|/*Respond "WILL"*/
block|}
ifdef|#
directive|ifdef
name|BSD44
name|realptyecho
argument_list|(
literal|1
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCGETP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ioctl failed"
argument_list|)
expr_stmt|;
block|}
name|sb
operator|.
name|sg_flags
operator||=
name|ECHO
expr_stmt|;
comment|/*Turn on Echo*/
if|if
condition|(
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCSETP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ioctl failed"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|nego_state
operator||=
name|ECHO_OBJ
expr_stmt|;
name|cur_emode
operator|=
name|NOT_ECHO_NOW
expr_stmt|;
comment|/*Don't Want user to Echo*/
block|}
block|}
else|else
comment|/*Request from user for Local Echo*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"NI--Local Echo\n"
argument_list|)
expr_stmt|;
name|cur_emode
operator|=
name|NOT_ECHO_NOW
expr_stmt|;
name|ni_image
operator|&=
operator|~
name|ECHO_OBJ
expr_stmt|;
if|if
condition|(
name|nego_state
operator|&
name|ECHO_OBJ
condition|)
comment|/*If now in Remote Echo*/
block|{
if|if
condition|(
name|na_image
operator|&
name|ECHO_OBJ
condition|)
comment|/*If no request pending*/
comment|/*Must be request from user*/
block|{
ifdef|#
directive|ifdef
name|DO_LOCAL_ECHO
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"User requested Local Echo -- O.K.\n"
argument_list|)
expr_stmt|;
name|na_image
operator|&=
operator|~
name|ECHO_OBJ
expr_stmt|;
name|nego_state
operator|&=
operator|~
name|ECHO_OBJ
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD44
name|ptyecho
argument_list|(
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
name|setmode
argument_list|(
literal|0
argument_list|,
name|ECHO
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|#
directive|else
name|na_image
operator||=
name|ECHO_OBJ
expr_stmt|;
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"User requested Local Echo -- Denied\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vt_set_nego
argument_list|(
name|na_image
argument_list|,
name|ECHO_OBJ
argument_list|)
expr_stmt|;
comment|/*Respond "WILL"*/
block|}
else|else
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Server request for Local Echo Accepted\n"
argument_list|)
expr_stmt|;
name|nego_state
operator|&=
operator|~
name|ECHO_OBJ
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD44
name|ptyecho
argument_list|(
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
name|setmode
argument_list|(
literal|0
argument_list|,
name|ECHO
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
else|else
comment|/*Else now in Local Echo*/
block|{
if|if
condition|(
name|na_image
operator|&
name|ECHO_OBJ
condition|)
comment|/*If requeset pending*/
comment|/*Must be negative response*/
block|{
name|na_image
operator|&=
operator|~
name|ECHO_OBJ
expr_stmt|;
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Request for Remote Echo Denied by User\n"
argument_list|)
expr_stmt|;
block|}
else|else
comment|/*Else no request pending*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"User Request Ignored--Now in Local Echo\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|active
operator|&
name|SUP_GA
condition|)
comment|/*Update to Suppress Go Ahead Control Object*/
block|{
if|if
condition|(
name|SUP_GA
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
condition|)
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Suppress Go Ahead\n"
argument_list|)
expr_stmt|;
name|ni_image
operator||=
name|SUP_GA
expr_stmt|;
if|if
condition|(
operator|(
name|na_image
operator|&
name|SUP_GA
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|SUP_GA
operator|)
condition|)
comment|/*If no request from Acceptor outstanding*/
block|{
if|if
condition|(
operator|!
operator|(
name|nego_state
operator|&
name|SUP_GA
operator|)
condition|)
comment|/*If not currently in Supress Go Ahead*/
block|{
name|na_image
operator||=
name|SUP_GA
expr_stmt|;
name|vt_set_nego
argument_list|(
name|na_image
argument_list|,
name|SUP_GA
argument_list|)
expr_stmt|;
comment|/*Reply "Will"*/
block|}
block|}
name|nego_state
operator||=
name|SUP_GA
expr_stmt|;
comment|/*Entering or already there*/
block|}
else|else
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Don't Suppress Go Ahead\n"
argument_list|)
expr_stmt|;
name|ni_image
operator|&=
operator|~
name|SUP_GA
expr_stmt|;
if|if
condition|(
operator|(
name|na_image
operator|&
name|SUP_GA
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|SUP_GA
operator|)
condition|)
comment|/*Must be request from Initiator*/
block|{
name|na_image
operator||=
name|SUP_GA
expr_stmt|;
name|vt_set_nego
argument_list|(
name|na_image
argument_list|,
name|SUP_GA
argument_list|)
expr_stmt|;
comment|/*Reply "Won't"*/
block|}
else|else
comment|/*Else reply to my request*/
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"User refuses to Suppress Go Ahead\n"
argument_list|)
expr_stmt|;
name|na_image
operator|&=
operator|~
name|SUP_GA
expr_stmt|;
comment|/*Give up*/
block|}
block|}
block|}
if|if
condition|(
name|active
operator|&
name|DISP_BIN
condition|)
comment|/*Update to WACI Binary Repertoire*/
block|{
if|if
condition|(
name|DISP_BIN
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
condition|)
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Initiator requested Binary Repertoire on DI\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|na_image
operator|&
name|DISP_BIN
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|DISP_BIN
operator|)
condition|)
comment|/*No request outstanding from Acceptor*/
block|{
if|if
condition|(
operator|!
operator|(
name|nego_state
operator|&
name|DISP_BIN
operator|)
condition|)
comment|/*If not now binary*/
block|{
name|na_image
operator||=
name|DISP_BIN
expr_stmt|;
name|vt_set_nego
argument_list|(
name|na_image
argument_list|,
name|DISP_BIN
argument_list|)
expr_stmt|;
comment|/*Send "Will"*/
name|switch_rep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
else|else
comment|/*Else a response to Acceptor request*/
block|{
if|if
condition|(
name|na_image
operator|&
name|KBD_BIN
condition|)
comment|/*Positive Response*/
name|switch_rep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|nego_state
operator||=
name|DISP_BIN
expr_stmt|;
name|na_image
operator||=
name|DISP_BIN
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Initiator requested ASCII Repertoire on DI\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|na_image
operator|&
name|DISP_BIN
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|DISP_BIN
operator|)
condition|)
block|{
if|if
condition|(
name|nego_state
operator|&
name|DISP_BIN
condition|)
comment|/*If not now ASCII*/
block|{
name|na_image
operator|&=
operator|~
name|DISP_BIN
expr_stmt|;
name|vt_set_nego
argument_list|(
name|na_image
argument_list|,
name|DISP_BIN
argument_list|)
expr_stmt|;
name|switch_rep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|na_image
operator|&
name|KBD_BIN
operator|)
condition|)
comment|/*Positive Response*/
name|switch_rep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|nego_state
operator|&=
operator|~
name|DISP_BIN
expr_stmt|;
name|na_image
operator|&=
operator|~
name|DISP_BIN
expr_stmt|;
block|}
block|}
if|if
condition|(
name|active
operator|&
name|KBD_BIN
condition|)
comment|/*Update to WACI Binary Repertoire*/
block|{
if|if
condition|(
name|KBD_BIN
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
condition|)
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Initiator requested Binary Repertoire on KB\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|na_image
operator|&
name|KBD_BIN
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|KBD_BIN
operator|)
condition|)
comment|/*If no Acceptor request outstanding*/
block|{
if|if
condition|(
operator|!
operator|(
name|nego_state
operator|&
name|KBD_BIN
operator|)
condition|)
comment|/*If not now binary*/
block|{
name|na_image
operator||=
name|KBD_BIN
expr_stmt|;
name|vt_set_nego
argument_list|(
name|na_image
argument_list|,
name|KBD_BIN
argument_list|)
expr_stmt|;
comment|/*Reply "Will"*/
block|}
block|}
name|na_image
operator||=
name|KBD_BIN
expr_stmt|;
name|nego_state
operator||=
name|KBD_BIN
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|showoptions
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Initiator requested ASCII Repertoire on KB\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|na_image
operator|&
name|KBD_BIN
operator|)
operator|==
operator|(
name|nego_state
operator|&
name|KBD_BIN
operator|)
condition|)
comment|/*Request from Initator*/
block|{
if|if
condition|(
name|nego_state
operator|&
name|KBD_BIN
condition|)
comment|/*If not now ASCII*/
block|{
name|na_image
operator|&=
operator|~
name|KBD_BIN
expr_stmt|;
name|vt_set_nego
argument_list|(
name|na_image
argument_list|,
name|KBD_BIN
argument_list|)
expr_stmt|;
comment|/*Reply "Will"*/
block|}
block|}
name|na_image
operator|&=
operator|~
name|KBD_BIN
expr_stmt|;
name|nego_state
operator|&=
operator|~
name|KBD_BIN
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|coptr
operator|->
name|co_name
argument_list|,
literal|"SY"
argument_list|)
condition|)
comment|/*SYNCHRONIZE CO can be written 							by Initiator or Acceptor*/
block|{
if|if
condition|(
name|active
operator|&
name|SYNC
condition|)
comment|/*Potential Update to Synch*/
block|{
if|if
condition|(
operator|(
name|SYNC
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
operator|!=
operator|(
name|SYNC
operator|&
name|sync_image
operator|)
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled SYNC"
argument_list|)
expr_stmt|;
name|sync_image
operator|^=
name|SYNC
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|coptr
operator|->
name|co_name
argument_list|,
literal|"GA"
argument_list|)
condition|)
block|{
if|if
condition|(
name|active
operator|&
name|GO_AHEAD
condition|)
comment|/*Potential Update to Go Ahead*/
block|{
if|if
condition|(
operator|(
name|GO_AHEAD
operator|&
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|)
operator|!=
operator|(
name|GO_AHEAD
operator|&
name|ga_image
operator|)
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"Toggled Go Ahead"
argument_list|)
expr_stmt|;
name|ga_image
operator|^=
name|GO_AHEAD
expr_stmt|;
block|}
block|}
block|}
block|}
end_block

begin_escape
end_escape

begin_macro
name|attrib_hdlr
argument_list|(
argument|doptr
argument_list|)
end_macro

begin_comment
comment|/*Handle Write Attribute Display Object Update*/
end_comment

begin_decl_stmt
name|DO_UPDATE
modifier|*
name|doptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|doptr
operator|->
name|do_cmd
operator|.
name|wrt_attrib
operator|.
name|attr_id
operator|==
literal|0
condition|)
comment|/*If switching repertoires*/
block|{
if|if
condition|(
name|doptr
operator|->
name|do_cmd
operator|.
name|wrt_attrib
operator|.
name|attr_ext
operator|==
literal|2
condition|)
comment|/*If Modal extent*/
block|{
if|if
condition|(
name|doptr
operator|->
name|do_cmd
operator|.
name|wrt_attrib
operator|.
name|attr_val
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|showoptions
condition|)
if|if
condition|(
name|my_right
operator|==
name|INITIATOR
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Switching to ASCII Repertoire\r\n"
argument_list|)
expr_stmt|;
name|transparent
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|doptr
operator|->
name|do_cmd
operator|.
name|wrt_attrib
operator|.
name|attr_val
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|showoptions
condition|)
if|if
condition|(
name|my_right
operator|==
name|INITIATOR
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Switching to Transparent profile.\r\n"
argument_list|)
expr_stmt|;
name|transparent
operator|=
literal|1
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Attribute for unavailable repertoire\n"
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Attribute update with invalid extent (%d)\n"
argument_list|,
name|doptr
operator|->
name|do_cmd
operator|.
name|wrt_attrib
operator|.
name|attr_ext
argument_list|)
expr_stmt|;
block|}
else|else
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"Attribute Update with invalid I.D. (%d)\n"
argument_list|,
name|doptr
operator|->
name|do_cmd
operator|.
name|wrt_attrib
operator|.
name|attr_id
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|TTY */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_decl_stmt
specifier|extern
name|struct
name|termios
name|oterm
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|tmode
parameter_list|(
name|f
parameter_list|)
name|int
name|f
decl_stmt|;
block|{
specifier|static
name|int
name|prevmode
init|=
literal|0
decl_stmt|;
name|struct
name|termios
name|term
decl_stmt|;
name|int
name|onoff
decl_stmt|,
name|old
decl_stmt|;
if|if
condition|(
name|prevmode
operator|==
name|f
condition|)
return|return
operator|(
name|f
operator|)
return|;
name|old
operator|=
name|prevmode
expr_stmt|;
name|prevmode
operator|=
name|f
expr_stmt|;
name|term
operator|=
name|oterm
expr_stmt|;
switch|switch
condition|(
name|f
condition|)
block|{
case|case
literal|0
case|:
name|onoff
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|1
case|:
case|case
literal|2
case|:
name|onoff
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|f
operator|==
literal|1
condition|)
block|{
name|term
operator|.
name|c_lflag
operator|&=
operator|~
name|ECHO
expr_stmt|;
name|term
operator|.
name|c_oflag
operator|&=
operator|~
name|OPOST
expr_stmt|;
block|}
else|else
block|{
name|term
operator|.
name|c_lflag
operator||=
name|ECHO
expr_stmt|;
name|term
operator|.
name|c_oflag
operator||=
name|OPOST
expr_stmt|;
block|}
name|term
operator|.
name|c_lflag
operator|&=
operator|~
operator|(
name|IEXTEN
operator||
name|ISIG
operator||
name|ICANON
operator|)
expr_stmt|;
break|break;
default|default:
return|return
name|old
return|;
block|}
if|if
condition|(
name|tcsetattr
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|TCSAFLUSH
argument_list|,
operator|&
name|term
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"tcsetattr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|FIONBIO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|old
operator|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|extern
name|struct
name|tchars
name|otc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ltchars
name|oltc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|sgttyb
name|ottyb
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* struct	tchars notc =	{ -1, 3, -1, -1, -1, -1 };*/
end_comment

begin_decl_stmt
name|struct
name|tchars
name|notc
init|=
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ltchars
name|noltc
init|=
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|tmode
parameter_list|(
name|f
parameter_list|)
specifier|register
name|int
name|f
decl_stmt|;
block|{
specifier|static
name|int
name|prevmode
init|=
literal|0
decl_stmt|;
name|struct
name|tchars
modifier|*
name|tc
decl_stmt|;
name|struct
name|ltchars
modifier|*
name|ltc
decl_stmt|;
name|struct
name|sgttyb
name|sb
decl_stmt|;
name|int
name|onoff
decl_stmt|,
name|old
decl_stmt|;
if|if
condition|(
name|prevmode
operator|==
name|f
condition|)
return|return
operator|(
name|f
operator|)
return|;
name|old
operator|=
name|prevmode
expr_stmt|;
name|prevmode
operator|=
name|f
expr_stmt|;
name|sb
operator|=
name|ottyb
expr_stmt|;
switch|switch
condition|(
name|f
condition|)
block|{
case|case
literal|0
case|:
name|onoff
operator|=
literal|0
expr_stmt|;
name|tc
operator|=
operator|&
name|otc
expr_stmt|;
name|ltc
operator|=
operator|&
name|oltc
expr_stmt|;
break|break;
case|case
literal|1
case|:
case|case
literal|2
case|:
if|if
condition|(
name|f
operator|==
literal|1
condition|)
block|{
name|sb
operator|.
name|sg_flags
operator||=
name|CBREAK
expr_stmt|;
name|sb
operator|.
name|sg_flags
operator|&=
operator|~
operator|(
name|ECHO
operator||
name|CRMOD
operator|)
expr_stmt|;
name|sb
operator|.
name|sg_erase
operator|=
name|sb
operator|.
name|sg_kill
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sb
operator|.
name|sg_flags
operator|&=
name|CBREAK
expr_stmt|;
name|sb
operator|.
name|sg_flags
operator||=
name|ECHO
operator||
name|CRMOD
expr_stmt|;
block|}
name|tc
operator|=
operator|&
name|notc
expr_stmt|;
name|notc
operator|.
name|t_stopc
operator|=
name|otc
operator|.
name|t_stopc
expr_stmt|;
name|notc
operator|.
name|t_startc
operator|=
name|otc
operator|.
name|t_startc
expr_stmt|;
name|ltc
operator|=
operator|&
name|noltc
expr_stmt|;
name|onoff
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
return|return
name|old
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|TIOCSLTC
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ltc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ioctl failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|TIOCSETC
argument_list|,
operator|(
name|char
operator|*
operator|)
name|tc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ioctl failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|TIOCSETP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sb
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ioctl failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|FIONBIO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ioctl failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|,
name|FIONBIO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ioctl failed"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|old
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_macro
name|kill_proc
argument_list|()
end_macro

begin_comment
comment|/*Terminate current UNIX process using UNIX interrupt char*/
end_comment

begin_block
block|{
ifdef|#
directive|ifdef
name|BSD44
name|struct
name|termios
name|term
decl_stmt|;
if|if
condition|(
name|tcgetattr
argument_list|(
name|pty
argument_list|,
operator|&
name|term
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"tcgetattr"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|term
operator|.
name|c_cc
index|[
name|VINTR
index|]
operator|!=
name|_POSIX_VDISABLE
condition|)
operator|(
name|void
operator|)
name|putch
argument_list|(
name|term
operator|.
name|c_cc
index|[
name|VINTR
index|]
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCGETC
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|otc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ioctl failed"
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|putch
argument_list|(
name|otc
operator|.
name|t_intrc
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_block

begin_macro
name|def_echo
argument_list|(
argument|coptr
argument_list|)
end_macro

begin_comment
comment|/*Handle Default Profile Echo Ctrl Object*/
end_comment

begin_decl_stmt
name|CO_UPDATE
modifier|*
name|coptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|active
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask_count
operator|==
literal|0
condition|)
name|active
operator|=
literal|0xff
expr_stmt|;
else|else
name|active
operator|=
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|mask
expr_stmt|;
if|if
condition|(
name|active
operator|&
name|ECHO_OBJ
condition|)
block|{
if|if
condition|(
operator|*
name|coptr
operator|->
name|co_cmd
operator|.
name|bool_update
operator|.
name|value
operator|&
name|ECHO_OBJ
condition|)
comment|/*True means do local echo*/
operator|(
name|void
operator|)
name|tmode
argument_list|(
literal|2
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|tmode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|BSD44
end_ifdef

begin_expr_stmt
specifier|static
name|realptyecho
argument_list|(
argument|on
argument_list|)
block|{ 	struct
name|termios
name|term
block|;
if|if
condition|(
name|tcgetattr
argument_list|(
name|pty
argument_list|,
operator|&
name|term
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"tcgetattr"
argument_list|)
expr_stmt|;
return|return;
block|}
end_expr_stmt

begin_if
if|if
condition|(
name|on
condition|)
name|term
operator|.
name|c_lflag
operator||=
name|ECHO
expr_stmt|;
else|else
name|term
operator|.
name|c_lflag
operator|&=
name|ECHO
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|tcsetattr
argument_list|(
name|pty
argument_list|,
name|TCSAFLUSH
argument_list|,
operator|&
name|term
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"tcsetattr"
argument_list|)
expr_stmt|;
return|return;
block|}
end_if

begin_endif
unit|}
endif|#
directive|endif
end_endif

end_unit


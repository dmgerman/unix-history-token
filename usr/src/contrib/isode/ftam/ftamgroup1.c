begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ftamgroup1.c - FPM: initiate a grouped transaction */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/ftam/RCS/ftamgroup1.c,v 7.1 91/02/22 09:22:54 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/ftam/RCS/ftamgroup1.c,v 7.1 91/02/22 09:22:54 mrose Interim $  *  *  * $Log:	ftamgroup1.c,v $  * Revision 7.1  91/02/22  09:22:54  mrose  * Interim 6.8  *   * Revision 7.0  89/11/23  21:53:37  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|"fpkt.h"
end_include

begin_comment
comment|/*
comment|F-{MANAGE,BULK-{BEGIN,END}}.REQUEST (group) */
end_comment

begin_function
name|int
name|FManageRequest
parameter_list|(
name|sd
parameter_list|,
name|ftg
parameter_list|,
name|fti
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|FTAMgroup
modifier|*
name|ftg
decl_stmt|;
name|struct
name|FTAMindication
modifier|*
name|fti
decl_stmt|;
block|{
return|return
name|FGroupRequest
argument_list|(
name|sd
argument_list|,
name|ftg
argument_list|,
name|FTI_MANAGEMENT
argument_list|,
name|FSB_MANAGEMENT
argument_list|,
name|fti
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|FBulkBeginRequest
parameter_list|(
name|sd
parameter_list|,
name|ftg
parameter_list|,
name|fti
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|FTAMgroup
modifier|*
name|ftg
decl_stmt|;
name|struct
name|FTAMindication
modifier|*
name|fti
decl_stmt|;
block|{
return|return
name|FGroupRequest
argument_list|(
name|sd
argument_list|,
name|ftg
argument_list|,
name|FTI_BULKBEGIN
argument_list|,
name|FSB_BULKBEGIN
argument_list|,
name|fti
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|FBulkEndRequest
parameter_list|(
name|sd
parameter_list|,
name|ftg
parameter_list|,
name|fti
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|FTAMgroup
modifier|*
name|ftg
decl_stmt|;
name|struct
name|FTAMindication
modifier|*
name|fti
decl_stmt|;
block|{
return|return
name|FGroupRequest
argument_list|(
name|sd
argument_list|,
name|ftg
argument_list|,
name|FTI_BULKEND
argument_list|,
name|FSB_BULKEND
argument_list|,
name|fti
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|F-GROUP.REQUEST (group) */
end_comment

begin_function
specifier|static
name|int
name|FGroupRequest
parameter_list|(
name|sd
parameter_list|,
name|ftg
parameter_list|,
name|type
parameter_list|,
name|state
parameter_list|,
name|fti
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|FTAMgroup
modifier|*
name|ftg
decl_stmt|;
name|int
name|type
decl_stmt|,
name|state
decl_stmt|;
name|struct
name|FTAMindication
modifier|*
name|fti
decl_stmt|;
block|{
name|SBV
name|smask
decl_stmt|;
name|int
name|result
decl_stmt|;
specifier|register
name|struct
name|ftamblk
modifier|*
name|fsb
decl_stmt|;
name|missingP
argument_list|(
name|ftg
argument_list|)
expr_stmt|;
name|missingP
argument_list|(
name|fti
argument_list|)
expr_stmt|;
name|smask
operator|=
name|sigioblock
argument_list|()
expr_stmt|;
name|ftamPsig
argument_list|(
name|fsb
argument_list|,
name|sd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|result
operator|=
name|figrpchk
argument_list|(
name|fsb
argument_list|,
name|ftg
argument_list|,
name|type
argument_list|,
name|fti
argument_list|)
operator|)
operator|!=
name|NOTOK
condition|)
name|result
operator|=
name|FGroupRequestAux
argument_list|(
name|fsb
argument_list|,
name|ftg
argument_list|,
name|state
argument_list|,
name|fti
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sigiomask
argument_list|(
name|smask
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|FGroupRequestAux
parameter_list|(
name|fsb
parameter_list|,
name|ftg
parameter_list|,
name|state
parameter_list|,
name|fti
parameter_list|)
specifier|register
name|struct
name|ftamblk
modifier|*
name|fsb
decl_stmt|;
specifier|register
name|struct
name|FTAMgroup
modifier|*
name|ftg
decl_stmt|;
name|int
name|state
decl_stmt|;
name|struct
name|FTAMindication
modifier|*
name|fti
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|did_loop
decl_stmt|,
name|npdu
decl_stmt|,
name|result
decl_stmt|;
name|char
modifier|*
modifier|*
name|txp
decl_stmt|,
modifier|*
name|texts
index|[
name|NPDATA
index|]
decl_stmt|;
name|PE
name|pe
decl_stmt|,
modifier|*
name|pep
decl_stmt|,
name|info
index|[
name|NPDATA
index|]
decl_stmt|;
name|struct
name|PSAPindication
name|pis
decl_stmt|;
name|struct
name|PSAPindication
modifier|*
name|pi
init|=
operator|&
name|pis
decl_stmt|;
name|struct
name|PSAPabort
modifier|*
name|pa
init|=
operator|&
name|pi
operator|->
name|pi_abort
decl_stmt|;
name|struct
name|type_FTAM_PDU
modifier|*
modifier|*
name|pdup
decl_stmt|,
modifier|*
name|pdus
index|[
name|NPDATA
index|]
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|texts
argument_list|,
sizeof|sizeof
name|texts
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|info
argument_list|,
sizeof|sizeof
name|info
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pdus
argument_list|,
sizeof|sizeof
name|pdus
argument_list|)
expr_stmt|;
name|did_loop
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|result
operator|=
name|figrp2pdus
argument_list|(
name|fsb
argument_list|,
name|ftg
argument_list|,
name|pdus
argument_list|,
name|texts
argument_list|,
operator|&
name|npdu
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|pdup
operator|=
name|pdus
operator|,
name|pep
operator|=
name|info
operator|,
name|txp
operator|=
name|texts
operator|,
name|i
operator|=
name|npdu
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|pdup
operator|++
operator|,
name|pep
operator|++
operator|,
name|txp
operator|++
operator|,
name|i
operator|--
control|)
block|{
name|pe
operator|=
name|NULLPE
expr_stmt|;
if|if
condition|(
name|encode_FTAM_PDU
argument_list|(
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
operator|*
name|pdup
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|result
operator|=
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|"error encoding PDU: %s"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|(
operator|*
name|pep
operator|=
name|pe
operator|)
operator|->
name|pe_context
operator|=
name|fsb
operator|->
name|fsb_id
expr_stmt|;
name|fsbtrace
argument_list|(
name|fsb
argument_list|,
operator|(
name|fsb
operator|->
name|fsb_fd
operator|,
literal|"P-DATA.REQUEST"
operator|,
operator|*
name|txp
operator|,
name|pe
operator|,
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
name|did_loop
operator|=
literal|1
expr_stmt|;
name|result
operator|=
name|PDataRequest
argument_list|(
name|fsb
operator|->
name|fsb_fd
argument_list|,
name|info
argument_list|,
name|npdu
argument_list|,
name|pi
argument_list|)
expr_stmt|;
name|out
label|:
empty_stmt|;
for|for
control|(
name|pdup
operator|=
name|pdus
operator|,
name|pep
operator|=
name|info
operator|,
name|i
operator|=
name|NPDATA
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|pdup
operator|++
operator|,
name|pep
operator|++
operator|,
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|*
name|pep
condition|)
name|pe_free
argument_list|(
operator|*
name|pep
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pdup
condition|)
name|free_FTAM_PDU
argument_list|(
operator|*
name|pdup
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|did_loop
condition|)
operator|(
name|void
operator|)
name|ps2ftamlose
argument_list|(
name|fsb
argument_list|,
name|fti
argument_list|,
literal|"PDataRequest"
argument_list|,
name|pa
argument_list|)
expr_stmt|;
if|if
condition|(
name|fti
operator|->
name|fti_abort
operator|.
name|fta_action
operator|==
name|FACTION_PERM
condition|)
name|freefsblk
argument_list|(
name|fsb
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|fsb
operator|->
name|fsb_state
operator|=
name|state
expr_stmt|;
name|fsb
operator|->
name|fsb_group
operator|=
name|ftg
operator|->
name|ftg_flags
expr_stmt|;
return|return
name|FWaitRequestAux
argument_list|(
name|fsb
argument_list|,
name|NOTOK
argument_list|,
name|fti
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|figrpchk
parameter_list|(
name|fsb
parameter_list|,
name|ftg
parameter_list|,
name|type
parameter_list|,
name|fti
parameter_list|)
specifier|register
name|struct
name|ftamblk
modifier|*
name|fsb
decl_stmt|;
specifier|register
name|struct
name|FTAMgroup
modifier|*
name|ftg
decl_stmt|;
name|int
name|type
decl_stmt|;
name|struct
name|FTAMindication
modifier|*
name|fti
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|request
decl_stmt|;
specifier|register
name|struct
name|FTAMpasswords
modifier|*
name|fp
decl_stmt|;
specifier|register
name|struct
name|FTAMconcurrency
modifier|*
name|fc
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_flags
operator|&
name|FSB_INIT
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"not initiator"
argument_list|)
return|;
switch|switch
condition|(
name|fsb
operator|->
name|fsb_state
condition|)
block|{
case|case
name|FSB_INITIALIZED
case|:
if|if
condition|(
name|type
operator|==
name|FTI_BULKEND
condition|)
goto|goto
name|wrong_state
goto|;
break|break;
case|case
name|FSB_DATAIDLE
case|:
if|if
condition|(
name|type
operator|!=
name|FTI_BULKEND
condition|)
goto|goto
name|wrong_state
goto|;
break|break;
default|default:
name|wrong_state
label|:
empty_stmt|;
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"wrong state"
argument_list|)
return|;
block|}
switch|switch
condition|(
name|fsb
operator|->
name|fsb_class
condition|)
block|{
case|case
name|FCLASS_TRANSFER
case|:
if|if
condition|(
name|type
operator|!=
name|FTI_MANAGEMENT
condition|)
break|break;
goto|goto
name|bad_class
goto|;
case|case
name|FCLASS_MANAGE
case|:
if|if
condition|(
name|type
operator|==
name|FTI_MANAGEMENT
condition|)
break|break;
goto|goto
name|bad_class
goto|;
case|case
name|FCLASS_TM
case|:
case|case
name|FCLASS_ACCESS
case|:
break|break;
default|default:
name|bad_class
label|:
empty_stmt|;
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"file management not permitted"
argument_list|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_BEGIN
operator|)
operator|||
operator|!
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_END
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"must be grouped"
argument_list|)
return|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|FTI_MANAGEMENT
case|:
case|case
name|FTI_BULKBEGIN
case|:
if|if
condition|(
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
operator|(
name|FTG_SELECT
operator||
name|FTG_CREATE
operator|)
operator|)
operator|==
literal|0
operator|||
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
operator|(
name|FTG_SELECT
operator||
name|FTG_CREATE
operator|)
operator|)
operator|==
operator|(
name|FTG_SELECT
operator||
name|FTG_CREATE
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"missing/duplicate select/create request"
argument_list|)
return|;
if|if
condition|(
name|type
operator|==
name|FTI_MANAGEMENT
condition|)
block|{
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
operator|(
name|FTG_OPEN
operator||
name|FTG_CLOSE
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"file transfer not permitted"
argument_list|)
return|;
goto|goto
name|finish_end
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_OPEN
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"missing open request"
argument_list|)
return|;
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
operator|(
name|FTG_CLOSE
operator||
name|FTG_DESELECT
operator||
name|FTG_DELETE
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"file management/close not permitted"
argument_list|)
return|;
break|break;
case|case
name|FTI_BULKEND
case|:
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
operator|(
name|FTG_SELECT
operator||
name|FTG_CREATE
operator||
name|FTG_OPEN
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"file management/open not permitted"
argument_list|)
return|;
if|if
condition|(
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_CLOSE
operator|)
operator|==
literal|0
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"missing close request"
argument_list|)
return|;
name|finish_end
label|:
empty_stmt|;
if|if
condition|(
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
operator|(
name|FTG_DESELECT
operator||
name|FTG_DELETE
operator|)
operator|)
operator|==
literal|0
operator|||
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
operator|(
name|FTG_DESELECT
operator||
name|FTG_DELETE
operator|)
operator|)
operator|==
operator|(
name|FTG_DESELECT
operator||
name|FTG_DELETE
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"missing/duplicate deselect/delete request"
argument_list|)
return|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNIT_GROUPING
operator|)
operator|&&
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
operator|(
name|FTG_BEGIN
operator||
name|FTG_END
operator|)
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"grouping not permitted"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNIT_LIMITED
operator|)
operator|&&
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
operator|(
name|FTG_CREATE
operator||
name|FTG_RDATTR
operator||
name|FTG_DELETE
operator|)
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"limited file management not permitted"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNIT_ENHANCED
operator|)
operator|&&
operator|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_CHATTR
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"enhanced file management not permitted"
argument_list|)
return|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_SELECT
condition|)
block|{
specifier|register
name|struct
name|FTAMselect
modifier|*
name|ftse
init|=
operator|&
name|ftg
operator|->
name|ftg_select
decl_stmt|;
if|if
condition|(
name|ftse
operator|->
name|ftse_attrs
operator|.
name|fa_present
operator|!=
name|FA_FILENAME
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"only filename should be present"
argument_list|)
return|;
if|if
condition|(
name|ftse
operator|->
name|ftse_access
operator|&
operator|~
name|FA_REQ_MASK
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"FADU-Identity groups not permitted"
argument_list|)
return|;
name|request
operator|=
name|ftse
operator|->
name|ftse_access
expr_stmt|;
name|fp
operator|=
operator|&
name|ftse
operator|->
name|ftse_pwds
expr_stmt|;
name|fc
operator|=
operator|&
name|ftse
operator|->
name|ftse_conctl
expr_stmt|;
goto|goto
name|finish_create
goto|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_CREATE
condition|)
block|{
specifier|register
name|struct
name|FTAMcreate
modifier|*
name|ftce
init|=
operator|&
name|ftg
operator|->
name|ftg_create
decl_stmt|;
switch|switch
condition|(
name|ftce
operator|->
name|ftce_override
condition|)
block|{
case|case
name|FOVER_FAIL
case|:
case|case
name|FOVER_SELECT
case|:
case|case
name|FOVER_WRITE
case|:
case|case
name|FOVER_DELETE
case|:
break|break;
default|default:
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"bad value for creation mode"
argument_list|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|ftce
operator|->
name|ftce_attrs
operator|.
name|fa_present
operator|&
name|FA_FILENAME
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"filename not present"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|ftce
operator|->
name|ftce_attrs
operator|.
name|fa_present
operator|&
name|FA_ACTIONS
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"permitted-actions not present"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|ftce
operator|->
name|ftce_attrs
operator|.
name|fa_present
operator|&
name|FA_CONTENTS
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"contents-type not present"
argument_list|)
return|;
if|if
condition|(
name|ftce
operator|->
name|ftce_attrs
operator|.
name|fa_present
operator|&
operator|~
name|FA_CRE_ATTRS
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"illegal attributes present"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_STORAGE
operator|)
operator|&&
operator|(
name|ftce
operator|->
name|ftce_attrs
operator|.
name|fa_present
operator|&
name|FA_STORAGE
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"storage attributes not permitted"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_SECURITY
operator|)
operator|&&
operator|(
name|ftce
operator|->
name|ftce_attrs
operator|.
name|fa_present
operator|&
name|FA_SECURITY
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"security attributes not permitted"
argument_list|)
return|;
if|if
condition|(
name|ftce
operator|->
name|ftce_access
operator|&
operator|~
name|FA_REQ_MASK
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"FADU-Identity groups not permitted"
argument_list|)
return|;
name|request
operator|=
name|ftce
operator|->
name|ftce_access
expr_stmt|;
name|fp
operator|=
operator|&
name|ftce
operator|->
name|ftce_pwds
expr_stmt|;
name|fc
operator|=
operator|&
name|ftce
operator|->
name|ftce_conctl
expr_stmt|;
name|finish_create
label|:
empty_stmt|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_SECURITY
operator|)
operator|&&
name|passes_present
argument_list|(
name|fp
argument_list|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"access passwords not permitted"
argument_list|)
return|;
if|if
condition|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_STORAGE
condition|)
block|{
if|if
condition|(
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_READ
operator|)
operator|&&
name|fc
operator|->
name|fc_readlock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_INSERT
operator|)
operator|&&
name|fc
operator|->
name|fc_insertlock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_REPLACE
operator|)
operator|&&
name|fc
operator|->
name|fc_replacelock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_ERASE
operator|)
operator|&&
name|fc
operator|->
name|fc_eraselock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_EXTEND
operator|)
operator|&&
name|fc
operator|->
name|fc_extendlock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_READATTR
operator|)
operator|&&
name|fc
operator|->
name|fc_readattrlock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_CHNGATTR
operator|)
operator|&&
name|fc
operator|->
name|fc_chngattrlock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_DELETE
operator|)
operator|&&
name|fc
operator|->
name|fc_deletelock
operator|<
name|FLOCK_PRESENT
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"bad settings for select/create concurrency control"
argument_list|)
return|;
block|}
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_CLOSE
condition|)
block|{
specifier|register
name|struct
name|FTAMclose
modifier|*
name|ftcl
init|=
operator|&
name|ftg
operator|->
name|ftg_close
decl_stmt|;
switch|switch
condition|(
name|ftcl
operator|->
name|ftcl_action
condition|)
block|{
case|case
name|FACTION_SUCCESS
case|:
case|case
name|FACTION_TRANS
case|:
case|case
name|FACTION_PERM
case|:
break|break;
default|default:
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"bad value for close action parameter"
argument_list|)
return|;
block|}
if|if
condition|(
name|ftcl
operator|->
name|ftcl_ndiag
operator|>
name|NFDIAG
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"too many close diagnostics"
argument_list|)
return|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_RDATTR
condition|)
block|{
specifier|register
name|struct
name|FTAMreadattr
modifier|*
name|ftra
init|=
operator|&
name|ftg
operator|->
name|ftg_readattr
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_STORAGE
operator|)
operator|&&
operator|(
name|ftra
operator|->
name|ftra_attrnames
operator|&
name|FA_STORAGE
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"storage attributes not permitted"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_SECURITY
operator|)
operator|&&
operator|(
name|ftra
operator|->
name|ftra_attrnames
operator|&
name|FA_SECURITY
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"security attributes not permitted"
argument_list|)
return|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_CHATTR
condition|)
block|{
specifier|register
name|struct
name|FTAMchngattr
modifier|*
name|ftca
init|=
operator|&
name|ftg
operator|->
name|ftg_chngattr
decl_stmt|;
if|if
condition|(
name|ftca
operator|->
name|ftca_attrs
operator|.
name|fa_present
operator|&
name|ftca
operator|->
name|ftca_attrs
operator|.
name|fa_novalue
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"attributes can not be changed to no-value-available"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_STORAGE
operator|)
operator|&&
operator|(
name|ftca
operator|->
name|ftca_attrs
operator|.
name|fa_present
operator|&
name|FA_STORAGE
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"storage attributes not permitted"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_SECURITY
operator|)
operator|&&
operator|(
name|ftca
operator|->
name|ftca_attrs
operator|.
name|fa_present
operator|&
name|FA_SECURITY
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"security attributes not permitted"
argument_list|)
return|;
if|if
condition|(
name|ftca
operator|->
name|ftca_attrs
operator|.
name|fa_present
operator|&
name|FA_CONTROL
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"encoding of access-control not supported (yet)"
argument_list|)
return|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_DESELECT
condition|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_DELETE
condition|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_OPEN
condition|)
block|{
specifier|register
name|struct
name|FTAMopen
modifier|*
name|ftop
init|=
operator|&
name|ftg
operator|->
name|ftg_open
decl_stmt|;
if|if
condition|(
operator|(
name|request
operator|=
name|ftop
operator|->
name|ftop_mode
operator|)
operator|&
operator|~
name|FA_MODE_MASK
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"bad open mode"
argument_list|)
return|;
ifdef|#
directive|ifdef
name|notdef
if|if
condition|(
name|ftop
operator|->
name|ftop_contents
operator|==
name|NULLOID
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"missing contents type in open"
argument_list|)
return|;
endif|#
directive|endif
if|if
condition|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_STORAGE
condition|)
block|{
name|fc
operator|=
operator|&
name|ftop
operator|->
name|ftop_conctl
expr_stmt|;
if|if
condition|(
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_READ
operator|)
operator|&&
name|fc
operator|->
name|fc_readlock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_INSERT
operator|)
operator|&&
name|fc
operator|->
name|fc_insertlock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_REPLACE
operator|)
operator|&&
name|fc
operator|->
name|fc_replacelock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_ERASE
operator|)
operator|&&
name|fc
operator|->
name|fc_eraselock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
operator|(
operator|!
operator|(
name|request
operator|&
name|FA_PERM_EXTEND
operator|)
operator|&&
name|fc
operator|->
name|fc_extendlock
operator|<
name|FLOCK_PRESENT
operator|)
operator|||
name|fc
operator|->
name|fc_readattrlock
operator|!=
name|FLOCK_NOTREQD
operator|||
name|fc
operator|->
name|fc_chngattrlock
operator|!=
name|FLOCK_NOTREQD
operator|||
name|fc
operator|->
name|fc_deletelock
operator|!=
name|FLOCK_NOTREQD
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"bad settings for open concurrency control"
argument_list|)
return|;
block|}
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
name|ftg
operator|->
name|ftg_threshold
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"threshold mismatch; expecting %d, found %d"
argument_list|,
name|ftg
operator|->
name|ftg_threshold
argument_list|,
name|i
argument_list|)
return|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|figrp2pdus
parameter_list|(
name|fsb
parameter_list|,
name|ftg
parameter_list|,
name|pdus
parameter_list|,
name|texts
parameter_list|,
name|npdu
parameter_list|,
name|fti
parameter_list|)
specifier|register
name|struct
name|ftamblk
modifier|*
name|fsb
decl_stmt|;
specifier|register
name|struct
name|FTAMgroup
modifier|*
name|ftg
decl_stmt|;
name|struct
name|type_FTAM_PDU
modifier|*
name|pdus
index|[]
decl_stmt|;
name|char
modifier|*
name|texts
index|[]
decl_stmt|;
name|int
modifier|*
name|npdu
decl_stmt|;
name|struct
name|FTAMindication
modifier|*
name|fti
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
specifier|register
name|struct
name|type_FTAM_PDU
modifier|*
name|pdu
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|new_pdu
parameter_list|(
name|t
parameter_list|,
name|o
parameter_list|,
name|u
parameter_list|,
name|x
parameter_list|)
define|\
value|register struct t *req; \  \ 	if ((pdu = (struct type_FTAM_PDU *) calloc (1, sizeof *pdu)) == NULL) \ 	    goto no_mem; \ 	pdus[i] = pdu; \ 	pdu  -> offset = o; \ 	texts[i++] = x; \ 	if ((req = (struct t *) calloc (1, sizeof *req)) == NULL) \ 	    goto no_mem; \ 	pdu -> un.u = req;
define|#
directive|define
name|new_action
parameter_list|(
name|a
parameter_list|)
define|\
value|if (a != int_FTAM_Action__Result_success) { \ 	if ((req -> action__result = \ 	     		(struct type_FTAM_Action__Result *) \ 	     			calloc (1, sizeof *req -> action__result)) \ 	        == NULL) \ 	    goto no_mem; \ 	req -> action__result -> parm = a; \     }
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_BEGIN
condition|)
block|{
name|new_pdu
argument_list|(
name|type_FTAM_F__BEGIN__GROUP__request
argument_list|,
name|type_FTAM_PDU_f__begin__group__request
argument_list|,
name|f__begin__group__request
argument_list|,
literal|"F-BEGIN-GROUP-request"
argument_list|)
expr_stmt|;
name|req
operator|->
name|parm
operator|=
name|ftg
operator|->
name|ftg_threshold
expr_stmt|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_SELECT
condition|)
block|{
specifier|register
name|struct
name|FTAMselect
modifier|*
name|ftse
init|=
operator|&
name|ftg
operator|->
name|ftg_select
decl_stmt|;
name|new_pdu
argument_list|(
name|type_FTAM_F__SELECT__request
argument_list|,
name|type_FTAM_PDU_f__select__request
argument_list|,
name|f__select__request
argument_list|,
literal|"F-SELECT-request"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|req
operator|->
name|attributes
operator|=
name|attr2fpm
argument_list|(
name|fsb
argument_list|,
operator|&
name|ftse
operator|->
name|ftse_attrs
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
operator|(
name|req
operator|->
name|requested__access
operator|=
name|bits2fpm
argument_list|(
name|fsb
argument_list|,
name|frequested_pairs
argument_list|,
name|ftse
operator|->
name|ftse_access
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|passes_present
argument_list|(
operator|&
name|ftse
operator|->
name|ftse_pwds
argument_list|)
operator|&&
operator|(
name|req
operator|->
name|access__passwords
operator|=
name|pass2fpm
argument_list|(
name|fsb
argument_list|,
operator|&
name|ftse
operator|->
name|ftse_pwds
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|conctl_present
argument_list|(
operator|&
name|ftse
operator|->
name|ftse_conctl
argument_list|)
operator|&&
operator|(
name|req
operator|->
name|concurrency__control
operator|=
name|conctl2fpm
argument_list|(
name|fsb
argument_list|,
operator|&
name|ftse
operator|->
name|ftse_conctl
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|ftse
operator|->
name|ftse_sharedASE
operator|&&
operator|(
name|req
operator|->
name|shared__ASE__information
operator|=
name|shared2fpm
argument_list|(
name|fsb
argument_list|,
name|ftse
operator|->
name|ftse_sharedASE
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|ftse
operator|->
name|ftse_account
operator|&&
operator|(
name|req
operator|->
name|account
operator|=
name|str2qb
argument_list|(
name|ftse
operator|->
name|ftse_account
argument_list|,
name|strlen
argument_list|(
name|ftse
operator|->
name|ftse_account
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_CREATE
condition|)
block|{
specifier|register
name|struct
name|FTAMcreate
modifier|*
name|ftce
init|=
operator|&
name|ftg
operator|->
name|ftg_create
decl_stmt|;
name|new_pdu
argument_list|(
name|type_FTAM_F__CREATE__request
argument_list|,
name|type_FTAM_PDU_f__create__request
argument_list|,
name|f__create__request
argument_list|,
literal|"F-CREATE-request"
argument_list|)
expr_stmt|;
name|req
operator|->
name|override
operator|=
name|ftce
operator|->
name|ftce_override
expr_stmt|;
if|if
condition|(
operator|(
name|req
operator|->
name|initial__attributes
operator|=
name|attr2fpm
argument_list|(
name|fsb
argument_list|,
operator|&
name|ftce
operator|->
name|ftce_attrs
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|ftce
operator|->
name|ftce_create
condition|)
block|{
specifier|register
name|struct
name|type_FTAM_Password
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
operator|(
expr|struct
name|type_FTAM_Password
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|p
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|req
operator|->
name|create__password
operator|=
name|p
expr_stmt|;
name|p
operator|->
name|offset
operator|=
name|type_FTAM_Password_binary
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|un
operator|.
name|binary
operator|=
name|str2qb
argument_list|(
name|ftce
operator|->
name|ftce_create
argument_list|,
name|ftce
operator|->
name|ftce_crelen
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
block|}
if|if
condition|(
operator|(
name|req
operator|->
name|requested__access
operator|=
name|bits2fpm
argument_list|(
name|fsb
argument_list|,
name|frequested_pairs
argument_list|,
name|ftce
operator|->
name|ftce_access
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|passes_present
argument_list|(
operator|&
name|ftce
operator|->
name|ftce_pwds
argument_list|)
operator|&&
operator|(
name|req
operator|->
name|access__passwords
operator|=
name|pass2fpm
argument_list|(
name|fsb
argument_list|,
operator|&
name|ftce
operator|->
name|ftce_pwds
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|conctl_present
argument_list|(
operator|&
name|ftce
operator|->
name|ftce_conctl
argument_list|)
operator|&&
operator|(
name|req
operator|->
name|concurrency__control
operator|=
name|conctl2fpm
argument_list|(
name|fsb
argument_list|,
operator|&
name|ftce
operator|->
name|ftce_conctl
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|ftce
operator|->
name|ftce_sharedASE
operator|&&
operator|(
name|req
operator|->
name|shared__ASE__information
operator|=
name|shared2fpm
argument_list|(
name|fsb
argument_list|,
name|ftce
operator|->
name|ftce_sharedASE
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|ftce
operator|->
name|ftce_account
operator|&&
operator|(
name|req
operator|->
name|account
operator|=
name|str2qb
argument_list|(
name|ftce
operator|->
name|ftce_account
argument_list|,
name|strlen
argument_list|(
name|ftce
operator|->
name|ftce_account
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_CLOSE
condition|)
block|{
specifier|register
name|struct
name|FTAMclose
modifier|*
name|ftcl
init|=
operator|&
name|ftg
operator|->
name|ftg_close
decl_stmt|;
name|new_pdu
argument_list|(
name|type_FTAM_F__CLOSE__request
argument_list|,
name|type_FTAM_PDU_f__close__request
argument_list|,
name|f__close__request
argument_list|,
literal|"F-CLOSE-request"
argument_list|)
expr_stmt|;
name|new_action
argument_list|(
name|ftcl
operator|->
name|ftcl_action
argument_list|)
expr_stmt|;
if|if
condition|(
name|ftcl
operator|->
name|ftcl_sharedASE
operator|&&
operator|(
name|req
operator|->
name|shared__ASE__information
operator|=
name|shared2fpm
argument_list|(
name|fsb
argument_list|,
name|ftcl
operator|->
name|ftcl_sharedASE
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|ftcl
operator|->
name|ftcl_ndiag
operator|>
literal|0
operator|&&
operator|(
name|req
operator|->
name|diagnostic
operator|=
name|diag2fpm
argument_list|(
name|fsb
argument_list|,
literal|0
argument_list|,
name|ftcl
operator|->
name|ftcl_diags
argument_list|,
name|ftcl
operator|->
name|ftcl_ndiag
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_RDATTR
condition|)
block|{
specifier|register
name|struct
name|FTAMreadattr
modifier|*
name|ftra
init|=
operator|&
name|ftg
operator|->
name|ftg_readattr
decl_stmt|;
if|if
condition|(
operator|(
name|pdu
operator|=
operator|(
expr|struct
name|type_FTAM_PDU
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|pdu
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|pdus
index|[
name|i
index|]
operator|=
name|pdu
expr_stmt|;
name|pdu
operator|->
name|offset
operator|=
name|type_FTAM_PDU_f__read__attrib__request
expr_stmt|;
name|texts
index|[
name|i
operator|++
index|]
operator|=
literal|"F-READ-ATTRIB-request"
expr_stmt|;
if|if
condition|(
operator|(
name|pdu
operator|->
name|un
operator|.
name|f__read__attrib__request
operator|=
name|bits2fpm
argument_list|(
name|fsb
argument_list|,
name|fname_pairs
argument_list|,
name|ftra
operator|->
name|ftra_attrnames
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_CHATTR
condition|)
block|{
specifier|register
name|struct
name|FTAMchngattr
modifier|*
name|ftca
init|=
operator|&
name|ftg
operator|->
name|ftg_chngattr
decl_stmt|;
if|if
condition|(
operator|(
name|pdu
operator|=
operator|(
expr|struct
name|type_FTAM_PDU
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|pdu
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|pdus
index|[
name|i
index|]
operator|=
name|pdu
expr_stmt|;
name|pdu
operator|->
name|offset
operator|=
name|type_FTAM_PDU_f__change__attrib__request
expr_stmt|;
name|texts
index|[
name|i
operator|++
index|]
operator|=
literal|"F-CHANGE-ATTRIB-request"
expr_stmt|;
if|if
condition|(
operator|(
name|pdu
operator|->
name|un
operator|.
name|f__change__attrib__request
operator|=
name|attr2fpm
argument_list|(
name|fsb
argument_list|,
operator|&
name|ftca
operator|->
name|ftca_attrs
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_DESELECT
condition|)
block|{
specifier|register
name|struct
name|FTAMdeselect
modifier|*
name|ftde
init|=
operator|&
name|ftg
operator|->
name|ftg_deselect
decl_stmt|;
if|if
condition|(
operator|(
name|pdu
operator|=
operator|(
expr|struct
name|type_FTAM_PDU
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|pdu
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|pdus
index|[
name|i
index|]
operator|=
name|pdu
expr_stmt|;
name|pdu
operator|->
name|offset
operator|=
name|type_FTAM_PDU_f__deselect__request
expr_stmt|;
name|texts
index|[
name|i
operator|++
index|]
operator|=
literal|"F-DESELECT-request"
expr_stmt|;
if|if
condition|(
name|ftde
operator|->
name|ftde_sharedASE
operator|&&
operator|(
name|pdu
operator|->
name|un
operator|.
name|f__deselect__request
operator|=
name|shared2fpm
argument_list|(
name|fsb
argument_list|,
name|ftde
operator|->
name|ftde_sharedASE
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_DELETE
condition|)
block|{
specifier|register
name|struct
name|FTAMdelete
modifier|*
name|ftxe
init|=
operator|&
name|ftg
operator|->
name|ftg_delete
decl_stmt|;
if|if
condition|(
operator|(
name|pdu
operator|=
operator|(
expr|struct
name|type_FTAM_PDU
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|pdu
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|pdus
index|[
name|i
index|]
operator|=
name|pdu
expr_stmt|;
name|pdu
operator|->
name|offset
operator|=
name|type_FTAM_PDU_f__delete__request
expr_stmt|;
name|texts
index|[
name|i
operator|++
index|]
operator|=
literal|"F-DELETE-request"
expr_stmt|;
if|if
condition|(
name|ftxe
operator|->
name|ftxe_sharedASE
operator|&&
operator|(
name|pdu
operator|->
name|un
operator|.
name|f__deselect__request
operator|=
name|shared2fpm
argument_list|(
name|fsb
argument_list|,
name|ftxe
operator|->
name|ftxe_sharedASE
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_OPEN
condition|)
block|{
specifier|register
name|struct
name|FTAMopen
modifier|*
name|ftop
init|=
operator|&
name|ftg
operator|->
name|ftg_open
decl_stmt|;
name|new_pdu
argument_list|(
name|type_FTAM_F__OPEN__request
argument_list|,
name|type_FTAM_PDU_f__open__request
argument_list|,
name|f__open__request
argument_list|,
literal|"F-OPEN-request"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ftop
operator|->
name|ftop_mode
operator|!=
name|FA_PERM_READ
operator|&&
operator|(
name|req
operator|->
name|processing__mode
operator|=
name|bits2fpm
argument_list|(
name|fsb
argument_list|,
name|fmode_pairs
argument_list|,
name|ftop
operator|->
name|ftop_mode
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
operator|(
name|req
operator|->
name|contents__type
operator|=
operator|(
expr|struct
name|choice_FTAM_0
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|req
operator|->
name|contents__type
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
if|if
condition|(
name|ftop
operator|->
name|ftop_contents
condition|)
block|{
specifier|register
name|struct
name|type_FTAM_Contents__Type__Attribute
modifier|*
name|proposed
decl_stmt|;
name|req
operator|->
name|contents__type
operator|->
name|offset
operator|=
name|choice_FTAM_0_proposed
expr_stmt|;
if|if
condition|(
operator|(
name|proposed
operator|=
operator|(
expr|struct
name|type_FTAM_Contents__Type__Attribute
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|proposed
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|req
operator|->
name|contents__type
operator|->
name|un
operator|.
name|proposed
operator|=
name|proposed
expr_stmt|;
if|if
condition|(
operator|(
name|proposed
operator|->
name|document__type__name
operator|=
name|oid_cpy
argument_list|(
name|ftop
operator|->
name|ftop_contents
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
goto|goto
name|no_mem
goto|;
if|if
condition|(
name|proposed
operator|->
name|parameter
operator|=
name|ftop
operator|->
name|ftop_parameter
condition|)
name|proposed
operator|->
name|parameter
operator|->
name|pe_refcnt
operator|++
expr_stmt|;
block|}
else|else
name|req
operator|->
name|contents__type
operator|->
name|offset
operator|=
name|choice_FTAM_0_unknown
expr_stmt|;
if|if
condition|(
name|conctl_present
argument_list|(
operator|&
name|ftop
operator|->
name|ftop_conctl
argument_list|)
operator|&&
operator|(
name|req
operator|->
name|concurrency__control
operator|=
name|conctl2fpm
argument_list|(
name|fsb
argument_list|,
operator|&
name|ftop
operator|->
name|ftop_conctl
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|ftop
operator|->
name|ftop_sharedASE
operator|&&
operator|(
name|req
operator|->
name|shared__ASE__information
operator|=
name|shared2fpm
argument_list|(
name|fsb
argument_list|,
name|ftop
operator|->
name|ftop_sharedASE
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNIT_FADULOCK
condition|)
name|req
operator|->
name|enable__fadu__locking
operator|=
name|ftop
operator|->
name|ftop_locking
condition|?
name|int_FTAM_FADU__Lock_on
else|:
name|int_FTAM_FADU__Lock_off
expr_stmt|;
block|}
if|if
condition|(
name|ftg
operator|->
name|ftg_flags
operator|&
name|FTG_END
condition|)
block|{
if|if
condition|(
operator|(
name|pdu
operator|=
operator|(
expr|struct
name|type_FTAM_PDU
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|pdu
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|pdus
index|[
name|i
index|]
operator|=
name|pdu
expr_stmt|;
name|pdu
operator|->
name|offset
operator|=
name|type_FTAM_PDU_f__end__group__request
expr_stmt|;
name|texts
index|[
name|i
operator|++
index|]
operator|=
literal|"F-END-GROUP-request"
expr_stmt|;
block|}
operator|*
name|npdu
operator|=
name|i
expr_stmt|;
return|return
name|OK
return|;
undef|#
directive|undef
name|new_pdu
undef|#
directive|undef
name|new_action
name|no_mem
label|:
empty_stmt|;
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
return|;
block|}
end_function

end_unit


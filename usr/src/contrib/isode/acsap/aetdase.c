begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* aetdase.c - DASE-based DSE */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/acsap/RCS/aetdase.c,v 7.6 91/02/22 09:14:28 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/acsap/RCS/aetdase.c,v 7.6 91/02/22 09:14:28 mrose Interim $  *  *  * $Log:	aetdase.c,v $  * Revision 7.6  91/02/22  09:14:28  mrose  * Interim 6.8  *   * Revision 7.5  91/01/07  12:39:41  mrose  * update  *   * Revision 7.4  90/12/23  18:39:01  mrose  * update  *   * Revision 7.3  90/12/11  10:52:00  mrose  * lock-and-load  *   * Revision 7.2  90/10/29  18:37:54  mrose  * updates  *   * Revision 7.1  90/07/09  14:30:48  mrose  * sync  *   * Revision 7.0  90/07/07  16:11:32  mrose  * *** empty log message ***  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"DASE-types.h"
end_include

begin_include
include|#
directive|include
file|"psap.h"
end_include

begin_include
include|#
directive|include
file|"tsap.h"
end_include

begin_include
include|#
directive|include
file|"dgram.h"
end_include

begin_include
include|#
directive|include
file|"tailor.h"
end_include

begin_comment
comment|/*
comment|DATA */
end_comment

begin_decl_stmt
specifier|static
name|int
name|stayopen
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|TSAPconnect
name|tcs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|PS
name|ps
init|=
name|NULLPS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|armed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|interrupted
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|jmp_buf
name|intrenv
decl_stmt|;
end_decl_stmt

begin_function_decl
name|SFD
name|intrser
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|element_DASE_1
modifier|*
name|read_el
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|LOOKUP */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|PE
name|name2value_dase
parameter_list|(
name|name
parameter_list|,
name|context
parameter_list|,
name|ontty
parameter_list|,
name|userdn
parameter_list|,
name|passwd
parameter_list|,
name|real_name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|,
decl|*
name|context
decl_stmt|,
modifier|*
name|userdn
decl_stmt|,
modifier|*
name|passwd
decl_stmt|;
end_function

begin_decl_stmt
name|int
name|ontty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|PE
modifier|*
name|real_name
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|done
decl_stmt|,
name|err
decl_stmt|,
name|nfds
decl_stmt|,
name|vecp
decl_stmt|;
name|fd_set
name|ifds
decl_stmt|;
name|char
modifier|*
name|vec
index|[
name|NVEC
operator|+
literal|1
index|]
decl_stmt|;
name|PE
name|pe
init|=
name|NULLPE
decl_stmt|,
name|result
init|=
name|NULLPE
decl_stmt|;
name|SFP
name|istat
decl_stmt|;
specifier|register
name|struct
name|type_DASE_Query__REQ
modifier|*
name|parm
init|=
name|NULL
decl_stmt|;
operator|*
name|real_name
operator|=
name|NULLPE
expr_stmt|;
if|if
condition|(
name|ontty
condition|)
block|{
name|istat
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|intrser
argument_list|)
expr_stmt|;
name|interrupted
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ps
operator|==
name|NULLPS
operator|&&
name|dase_init
argument_list|()
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|ontty
condition|)
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|istat
argument_list|)
expr_stmt|;
return|return
name|NULLPE
return|;
block|}
name|err
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|name
operator|==
literal|'@'
condition|)
block|{
name|vec
index|[
name|vecp
operator|=
literal|0
index|]
operator|=
name|name
expr_stmt|;
name|vecp
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|vecp
operator|=
name|sstr2arg
argument_list|(
name|name
argument_list|,
name|NVEC
argument_list|,
name|vec
argument_list|,
literal|","
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"invalid name"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|parm
operator|=
operator|(
expr|struct
name|type_DASE_Query__REQ
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|parm
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|no_mem
label|:
empty_stmt|;
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"name2value_dase: out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|{
specifier|register
name|char
modifier|*
modifier|*
name|vp
decl_stmt|;
specifier|register
name|struct
name|element_DASE_0
modifier|*
name|dl
decl_stmt|,
modifier|*
modifier|*
name|dp
decl_stmt|;
name|dp
operator|=
operator|&
name|parm
operator|->
name|name
expr_stmt|;
for|for
control|(
name|vp
operator|=
name|vec
init|;
name|vecp
operator|>
literal|0
condition|;
name|vp
operator|++
operator|,
name|vecp
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|dl
operator|=
operator|(
expr|struct
name|element_DASE_0
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|dl
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
operator|*
name|dp
operator|=
name|dl
expr_stmt|;
name|dp
operator|=
operator|&
name|dl
operator|->
name|next
expr_stmt|;
if|if
condition|(
operator|(
name|dl
operator|->
name|IA5String
operator|=
name|str2qb
argument_list|(
operator|*
name|vp
argument_list|,
name|strlen
argument_list|(
operator|*
name|vp
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
block|}
block|}
name|parm
operator|->
name|interactive
operator|=
name|ontty
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|parm
operator|->
name|envlist
operator|=
name|read_el
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|(
name|parm
operator|->
name|context
operator|=
name|str2qb
argument_list|(
name|context
argument_list|,
name|strlen
argument_list|(
name|context
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
if|if
condition|(
name|userdn
operator|&&
operator|(
name|parm
operator|->
name|userdn
operator|=
name|str2qb
argument_list|(
name|userdn
argument_list|,
name|strlen
argument_list|(
name|userdn
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
if|if
condition|(
name|passwd
operator|&&
operator|(
name|parm
operator|->
name|passwd
operator|=
name|str2qb
argument_list|(
name|passwd
argument_list|,
name|strlen
argument_list|(
name|passwd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
empty_stmt|;
if|if
condition|(
name|encode_DASE_Query__REQ
argument_list|(
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULLCP
argument_list|,
name|parm
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|(
name|err
operator|=
name|pe2ps
argument_list|(
name|ps
argument_list|,
name|pe
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to write query [%s]"
argument_list|,
name|ps_error
argument_list|(
name|ps
operator|->
name|ps_errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|PLOGP
argument_list|(
name|addr_log
argument_list|,
name|DASE_Message
argument_list|,
name|pe
argument_list|,
literal|"message"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|ifds
argument_list|)
expr_stmt|;
name|nfds
operator|=
name|tcs
operator|.
name|tc_sd
operator|+
literal|1
expr_stmt|;
name|FD_SET
argument_list|(
name|tcs
operator|.
name|tc_sd
argument_list|,
operator|&
name|ifds
argument_list|)
expr_stmt|;
for|for
control|(
name|done
operator|=
literal|0
init|;
operator|!
name|done
condition|;
control|)
block|{
name|fd_set
name|rfds
decl_stmt|;
name|struct
name|type_DASE_Provider__RSP
modifier|*
name|rsp
init|=
name|NULL
decl_stmt|;
name|PE
name|in
decl_stmt|;
if|if
condition|(
operator|!
name|interrupted
condition|)
block|{
name|rfds
operator|=
name|ifds
expr_stmt|;
comment|/* struct copy */
operator|(
name|void
operator|)
name|xselect
argument_list|(
name|nfds
argument_list|,
operator|&
name|rfds
argument_list|,
name|NULLFD
argument_list|,
name|NULLFD
argument_list|,
name|NOTOK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|interrupted
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"interrupted"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|FD_ISSET
argument_list|(
name|tcs
operator|.
name|tc_sd
argument_list|,
operator|&
name|rfds
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|in
operator|=
name|ps2pe
argument_list|(
name|ps
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to read response [%s]"
argument_list|,
name|ps_error
argument_list|(
name|ps
operator|->
name|ps_errno
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|decode_DASE_Provider__RSP
argument_list|(
name|in
argument_list|,
literal|1
argument_list|,
name|NULLIP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|rsp
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|you_lose
label|:
empty_stmt|;
name|pe_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
condition|)
name|free_DASE_Provider__RSP
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
name|err
operator|++
expr_stmt|;
break|break;
block|}
name|PLOGP
argument_list|(
name|addr_log
argument_list|,
name|DASE_Message
argument_list|,
name|in
argument_list|,
literal|"message"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rsp
operator|->
name|offset
condition|)
block|{
case|case
name|type_DASE_Provider__RSP_callback
case|:
if|if
condition|(
operator|!
name|ontty
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"unexpected callback from nameservice"
argument_list|)
expr_stmt|;
goto|goto
name|you_lose
goto|;
block|}
if|if
condition|(
name|dase_callback
argument_list|(
name|rsp
operator|->
name|un
operator|.
name|callback
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|you_lose
goto|;
break|break;
case|case
name|type_DASE_Provider__RSP_answer
case|:
block|{
specifier|register
name|char
modifier|*
name|pp
decl_stmt|,
modifier|*
name|ep
decl_stmt|;
specifier|register
name|struct
name|qbuf
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
specifier|register
name|struct
name|type_DASE_Query__RSP
modifier|*
name|ans
init|=
name|rsp
operator|->
name|un
operator|.
name|answer
decl_stmt|;
if|if
condition|(
operator|(
name|q
operator|=
name|ans
operator|->
name|friendly
operator|)
operator|&&
name|ontty
condition|)
block|{
name|printf
argument_list|(
literal|"[ using "
argument_list|)
expr_stmt|;
name|print_qb
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" ]\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
operator|*
name|real_name
operator|=
name|ans
operator|->
name|name
operator|,
name|ans
operator|->
name|name
operator|=
name|NULLPE
expr_stmt|;
name|result
operator|=
name|ans
operator|->
name|value
operator|,
name|ans
operator|->
name|value
operator|=
name|NULLPE
expr_stmt|;
name|ep
operator|=
operator|(
name|pp
operator|=
name|PY_pepy
operator|)
operator|+
name|BUFSIZ
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|q
operator|=
name|ans
operator|->
name|diagnostic
condition|)
for|for
control|(
name|p
operator|=
name|q
operator|->
name|qb_forw
init|;
name|p
operator|!=
name|q
operator|&&
name|pp
operator|<
name|ep
condition|;
name|pp
operator|+=
name|p
operator|->
name|qb_len
operator|,
name|p
operator|=
name|p
operator|->
name|qb_forw
control|)
name|bcopy
argument_list|(
name|p
operator|->
name|qb_data
argument_list|,
name|pp
argument_list|,
name|p
operator|->
name|qb_len
argument_list|)
expr_stmt|;
operator|*
name|pp
operator|=
name|NULL
expr_stmt|;
name|done
operator|=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"unexpected response from nameservice: %d"
argument_list|,
name|rsp
operator|->
name|offset
argument_list|)
expr_stmt|;
goto|goto
name|you_lose
goto|;
block|}
name|pe_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|free_DASE_Provider__RSP
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
block|}
name|out
label|:
empty_stmt|;
if|if
condition|(
name|result
operator|==
name|NULLPE
condition|)
name|SLOG
argument_list|(
name|addr_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
operator|(
literal|"%s"
operator|,
name|PY_pepy
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|parm
condition|)
name|free_DASE_Query__REQ
argument_list|(
name|parm
argument_list|)
expr_stmt|;
if|if
condition|(
name|pe
condition|)
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|&&
operator|(
name|err
operator|||
operator|!
name|stayopen
operator|)
condition|)
block|{
name|struct
name|TSAPdisconnect
name|tds
decl_stmt|;
operator|(
name|void
operator|)
name|TDiscRequest
argument_list|(
name|tcs
operator|.
name|tc_sd
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
operator|&
name|tds
argument_list|)
expr_stmt|;
name|ps_free
argument_list|(
name|ps
argument_list|)
expr_stmt|;
name|ps
operator|=
name|NULLPS
expr_stmt|;
block|}
if|if
condition|(
name|ontty
condition|)
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|istat
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|dase_init
parameter_list|()
block|{
name|int
name|i
decl_stmt|,
name|nfds
decl_stmt|;
name|fd_set
name|ifds
decl_stmt|;
specifier|register
name|struct
name|TSAPaddr
modifier|*
name|tz
decl_stmt|;
specifier|register
name|struct
name|TSAPconnect
modifier|*
name|tc
init|=
operator|&
name|tcs
decl_stmt|;
name|struct
name|TSAPdisconnect
name|tds
decl_stmt|;
specifier|register
name|struct
name|TSAPdisconnect
modifier|*
name|td
init|=
operator|&
name|tds
decl_stmt|;
if|if
condition|(
operator|(
name|tz
operator|=
name|str2taddr
argument_list|(
name|ns_address
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to parse nameservice address \"%s\""
argument_list|,
name|ns_address
argument_list|)
expr_stmt|;
name|out
label|:
empty_stmt|;
name|SLOG
argument_list|(
name|addr_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
operator|(
literal|"%s"
operator|,
name|PY_pepy
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
operator|(
name|i
operator|=
name|TAsynConnRequest
argument_list|(
name|NULLTA
argument_list|,
name|tz
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|NULLQOS
argument_list|,
name|tc
argument_list|,
name|td
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|you_lose
label|:
empty_stmt|;
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
name|td
operator|->
name|td_cc
operator|>
literal|0
condition|?
literal|"unable to connect to nameservice: [%s] %*.*s"
else|:
literal|"unable to connect to nameservice: [%s]"
argument_list|,
name|TErrString
argument_list|(
name|td
operator|->
name|td_reason
argument_list|)
argument_list|,
name|td
operator|->
name|td_cc
argument_list|,
name|td
operator|->
name|td_cc
argument_list|,
name|td
operator|->
name|td_data
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|FD_ZERO
argument_list|(
operator|&
name|ifds
argument_list|)
expr_stmt|;
name|nfds
operator|=
name|tc
operator|->
name|tc_sd
operator|+
literal|1
expr_stmt|;
name|FD_SET
argument_list|(
name|tc
operator|->
name|tc_sd
argument_list|,
operator|&
name|ifds
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|==
name|CONNECTING_1
operator|||
name|i
operator|==
name|CONNECTING_2
condition|)
block|{
name|fd_set
name|mask
decl_stmt|,
modifier|*
name|rmask
decl_stmt|,
modifier|*
name|wmask
decl_stmt|;
if|if
condition|(
operator|!
name|interrupted
condition|)
block|{
name|mask
operator|=
name|ifds
expr_stmt|;
comment|/* struct copy */
if|if
condition|(
name|i
operator|==
name|CONNECTING_2
condition|)
name|rmask
operator|=
operator|&
name|mask
operator|,
name|wmask
operator|=
name|NULLFD
expr_stmt|;
else|else
name|rmask
operator|=
name|NULLFD
operator|,
name|wmask
operator|=
operator|&
name|mask
expr_stmt|;
operator|(
name|void
operator|)
name|xselect
argument_list|(
name|nfds
argument_list|,
name|rmask
argument_list|,
name|wmask
argument_list|,
name|NULLFD
argument_list|,
name|NOTOK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|interrupted
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"interrupted"
argument_list|)
expr_stmt|;
goto|goto
name|oops
goto|;
block|}
if|if
condition|(
operator|(
name|rmask
operator|&&
operator|!
name|FD_ISSET
argument_list|(
name|tc
operator|->
name|tc_sd
argument_list|,
name|rmask
argument_list|)
operator|)
operator|||
operator|(
name|wmask
operator|&&
operator|!
name|FD_ISSET
argument_list|(
name|tc
operator|->
name|tc_sd
argument_list|,
name|wmask
argument_list|)
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|i
operator|=
name|TAsynRetryRequest
argument_list|(
name|tc
operator|->
name|tc_sd
argument_list|,
name|tc
argument_list|,
name|td
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
goto|goto
name|you_lose
goto|;
block|}
if|if
condition|(
operator|(
name|ps
operator|=
name|ps_alloc
argument_list|(
name|dg_open
argument_list|)
operator|)
operator|==
name|NULLPS
operator|||
name|dg_setup
argument_list|(
name|ps
argument_list|,
name|tc
operator|->
name|tc_sd
argument_list|,
name|MAXDGRAM
argument_list|,
name|ts_read
argument_list|,
name|ts_write
argument_list|,
name|NULLIFP
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|ps
operator|==
name|NULLPS
condition|)
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"ps_alloc: out of memory"
argument_list|)
expr_stmt|;
else|else
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"dg_setup: %s"
argument_list|,
name|ps_error
argument_list|(
name|ps
operator|->
name|ps_errno
argument_list|)
argument_list|)
expr_stmt|;
name|ps_free
argument_list|(
name|ps
argument_list|)
expr_stmt|;
name|ps
operator|=
name|NULL
expr_stmt|;
block|}
name|oops
label|:
empty_stmt|;
operator|(
name|void
operator|)
name|TDiscRequest
argument_list|(
name|tcs
operator|.
name|tc_sd
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|td
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|dase_callback
parameter_list|(
name|arg
parameter_list|)
specifier|register
name|struct
name|type_DASE_Callback__REQ
modifier|*
name|arg
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|result
decl_stmt|;
specifier|register
name|struct
name|element_DASE_3
modifier|*
name|choice
decl_stmt|;
name|struct
name|type_DASE_Callback__RSP
modifier|*
name|rsp
init|=
name|NULL
decl_stmt|;
specifier|register
name|struct
name|type_DASE_Callback__RSP
modifier|*
modifier|*
name|rp
init|=
operator|&
name|rsp
decl_stmt|;
name|PE
name|pe
init|=
name|NULLPE
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|choice
operator|=
name|arg
operator|->
name|choices
init|;
name|choice
condition|;
name|choice
operator|=
name|choice
operator|->
name|next
control|)
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|"%d imprecise matches for '"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|print_qb
argument_list|(
name|arg
operator|->
name|string
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"', select fron them [y/n] ? "
argument_list|)
expr_stmt|;
if|if
condition|(
name|yesno
argument_list|()
operator|!=
name|OK
condition|)
goto|goto
name|send_rsp
goto|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Please select from the following %d match%s for '"
argument_list|,
name|i
argument_list|,
name|i
operator|!=
literal|1
condition|?
literal|"es"
else|:
literal|""
argument_list|)
expr_stmt|;
name|print_qb
argument_list|(
name|arg
operator|->
name|string
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"':\n"
argument_list|)
expr_stmt|;
block|}
name|j
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|choice
operator|=
name|arg
operator|->
name|choices
init|;
name|choice
condition|;
name|choice
operator|=
name|choice
operator|->
name|next
control|)
block|{
specifier|register
name|struct
name|type_DASE_Callback__RSP
modifier|*
name|yes
decl_stmt|;
name|printf
argument_list|(
literal|"  "
argument_list|)
expr_stmt|;
name|print_qb
argument_list|(
name|choice
operator|->
name|Pair
operator|->
name|friendly
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" [y/n] ? "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|yesno
argument_list|()
condition|)
block|{
case|case
name|DONE
case|:
goto|goto
name|send_rsp
goto|;
case|case
name|NOTOK
case|:
default|default:
break|break;
case|case
name|OK
case|:
if|if
condition|(
operator|(
name|yes
operator|=
operator|(
expr|struct
name|type_DASE_Callback__RSP
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|yes
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"dase_callback: out of memory"
argument_list|)
expr_stmt|;
name|result
operator|=
name|NOTOK
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|rp
operator|=
name|yes
operator|,
name|rp
operator|=
operator|&
name|yes
operator|->
name|next
expr_stmt|;
name|yes
operator|->
name|IA5String
operator|=
name|choice
operator|->
name|Pair
operator|->
name|complete
expr_stmt|;
name|choice
operator|->
name|Pair
operator|->
name|complete
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|j
operator|++
operator|%
literal|10
operator|)
operator|==
literal|0
operator|&&
name|choice
operator|->
name|next
condition|)
block|{
name|printf
argument_list|(
literal|"Continue (%d more) [y/n] ? "
argument_list|,
name|i
operator|-
name|j
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|yesno
argument_list|()
operator|!=
name|OK
condition|)
break|break;
block|}
block|}
name|send_rsp
label|:
empty_stmt|;
if|if
condition|(
operator|(
name|result
operator|=
name|encode_DASE_Callback__RSP
argument_list|(
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULLCP
argument_list|,
name|rsp
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|(
name|result
operator|=
name|pe2ps
argument_list|(
name|ps
argument_list|,
name|pe
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to write callback [%s]"
argument_list|,
name|ps_error
argument_list|(
name|ps
operator|->
name|ps_errno
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|PLOGP
argument_list|(
name|addr_log
argument_list|,
name|DASE_Message
argument_list|,
name|pe
argument_list|,
literal|"message"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|OK
expr_stmt|;
block|}
name|out
label|:
empty_stmt|;
if|if
condition|(
name|rsp
condition|)
name|free_DASE_Callback__RSP
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|pe
condition|)
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|yesno
parameter_list|()
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|result
decl_stmt|;
if|if
condition|(
name|interrupted
condition|)
block|{
name|interrupted
operator|=
literal|0
expr_stmt|;
return|return
name|DONE
return|;
block|}
switch|switch
condition|(
name|setjmp
argument_list|(
name|intrenv
argument_list|)
condition|)
block|{
case|case
name|OK
case|:
name|armed
operator|++
expr_stmt|;
break|break;
case|case
name|NOTOK
case|:
default|default:
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|armed
operator|=
literal|0
expr_stmt|;
return|return
name|DONE
return|;
block|}
name|again
label|:
empty_stmt|;
name|x
operator|=
name|y
operator|=
name|getc
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
while|while
condition|(
name|y
operator|!=
literal|'\n'
operator|&&
name|y
operator|!=
name|EOF
condition|)
name|y
operator|=
name|getc
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|x
condition|)
block|{
case|case
literal|'y'
case|:
case|case
literal|'\n'
case|:
name|result
operator|=
name|OK
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|result
operator|=
name|NOTOK
expr_stmt|;
break|break;
case|case
name|EOF
case|:
name|result
operator|=
name|DONE
expr_stmt|;
name|clearerr
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Please type 'y' or 'n': "
argument_list|)
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|armed
operator|=
literal|0
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|print_qb
argument_list|(
argument|q
argument_list|)
expr|struct
name|qbuf
operator|*
name|q
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|qbuf
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
name|q
operator|->
name|qb_forw
init|;
name|p
operator|!=
name|q
condition|;
name|p
operator|=
name|p
operator|->
name|qb_forw
control|)
name|printf
argument_list|(
literal|"%*.*s"
argument_list|,
name|p
operator|->
name|qb_len
argument_list|,
name|p
operator|->
name|qb_len
argument_list|,
name|p
operator|->
name|qb_data
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|struct
name|element_DASE_1
modifier|*
name|read_el
parameter_list|()
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|bp
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|ufnrc
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|struct
name|element_DASE_1
modifier|*
name|top
decl_stmt|;
specifier|register
name|struct
name|element_DASE_1
modifier|*
modifier|*
name|etail
decl_stmt|;
specifier|register
name|struct
name|element_DASE_2
modifier|*
modifier|*
name|dtail
decl_stmt|;
if|if
condition|(
name|bp
operator|=
name|getenv
argument_list|(
literal|"UFNRC"
argument_list|)
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ufnrc
argument_list|,
name|bp
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
name|bp
operator|=
name|getenv
argument_list|(
literal|"HOME"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|bp
operator|=
literal|"."
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|ufnrc
argument_list|,
literal|"%s/.ufnrc"
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|ufnrc
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ufnrc
argument_list|,
name|isodefile
argument_list|(
literal|"ufnrc"
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|ufnrc
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|PY_advise
argument_list|(
name|ufnrc
argument_list|,
literal|"unable to read"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|top
operator|=
name|NULL
operator|,
name|etail
operator|=
operator|&
name|top
operator|,
name|dtail
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|fgets
argument_list|(
name|bp
operator|=
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|fp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
specifier|register
name|struct
name|element_DASE_2
modifier|*
name|dl
decl_stmt|;
if|if
condition|(
operator|*
name|buffer
operator|==
literal|'#'
condition|)
continue|continue;
if|if
condition|(
name|bp
operator|=
name|index
argument_list|(
name|buffer
argument_list|,
literal|'\n'
argument_list|)
condition|)
operator|*
name|bp
operator|=
name|NULL
expr_stmt|;
name|bp
operator|=
name|buffer
expr_stmt|;
if|if
condition|(
operator|*
name|bp
operator|==
name|NULL
condition|)
block|{
name|dtail
operator|=
name|NULL
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|isspace
argument_list|(
operator|*
name|bp
argument_list|)
condition|)
block|{
specifier|register
name|char
modifier|*
name|dp
decl_stmt|;
specifier|register
name|struct
name|element_DASE_1
modifier|*
name|el
decl_stmt|;
specifier|register
name|struct
name|type_DASE_Environment
modifier|*
name|fl
decl_stmt|;
if|if
condition|(
operator|(
name|el
operator|=
operator|(
expr|struct
name|element_DASE_1
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|el
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|no_mem
label|:
empty_stmt|;
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"real_el: out of memory"
argument_list|)
expr_stmt|;
name|out
label|:
empty_stmt|;
for|for
control|(
init|;
name|top
condition|;
name|top
operator|=
name|el
control|)
block|{
name|el
operator|=
name|top
operator|->
name|next
expr_stmt|;
name|free_DASE_Environment
argument_list|(
name|top
operator|->
name|Environment
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|top
argument_list|)
expr_stmt|;
block|}
name|SLOG
argument_list|(
name|addr_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
operator|(
literal|"%s"
operator|,
name|PY_pepy
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|etail
operator|=
name|el
expr_stmt|;
name|etail
operator|=
operator|&
name|el
operator|->
name|next
expr_stmt|;
if|if
condition|(
operator|(
name|fl
operator|=
operator|(
expr|struct
name|type_DASE_Environment
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|fl
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|el
operator|->
name|Environment
operator|=
name|fl
expr_stmt|;
name|dtail
operator|=
operator|&
name|fl
operator|->
name|path
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|index
argument_list|(
name|bp
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: missing ':' at line %d"
argument_list|,
name|ufnrc
argument_list|,
name|i
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|cp
operator|++
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|dp
operator|=
name|index
argument_list|(
name|bp
argument_list|,
literal|','
argument_list|)
condition|)
block|{
operator|*
name|dp
operator|++
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|dp
argument_list|)
condition|)
name|dp
operator|++
expr_stmt|;
name|fl
operator|->
name|upper
operator|=
operator|*
name|dp
operator|==
literal|'+'
condition|?
literal|32767
else|:
name|atoi
argument_list|(
name|dp
argument_list|)
expr_stmt|;
block|}
else|else
name|fl
operator|->
name|upper
operator|=
literal|0
expr_stmt|;
name|fl
operator|->
name|lower
operator|=
name|atoi
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|fl
operator|->
name|upper
operator|==
literal|0
condition|)
name|fl
operator|->
name|upper
operator|=
name|fl
operator|->
name|lower
expr_stmt|;
name|bp
operator|=
name|cp
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|dtail
condition|)
block|{
name|PY_advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: unexpected blank at start of line %d"
argument_list|,
name|ufnrc
argument_list|,
name|i
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|dl
operator|=
operator|(
expr|struct
name|element_DASE_2
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|dl
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
operator|*
name|dtail
operator|=
name|dl
expr_stmt|;
name|dtail
operator|=
operator|&
name|dl
operator|->
name|next
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|bp
argument_list|)
condition|)
name|bp
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|dl
operator|->
name|IA5String
operator|=
name|str2qb
argument_list|(
name|bp
argument_list|,
name|strlen
argument_list|(
name|bp
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|top
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|SFD
name|intrser
parameter_list|(
name|sig
parameter_list|)
name|int
name|sig
decl_stmt|;
block|{
ifndef|#
directive|ifndef
name|BSDSIGS
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|intrser
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|armed
condition|)
name|longjmp
argument_list|(
name|intrenv
argument_list|,
name|NOTOK
argument_list|)
expr_stmt|;
name|interrupted
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|set_lookup_dase
argument_list|(
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|char
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|!
operator|(
name|stayopen
operator|=
name|flag
operator|)
operator|&&
name|ps
condition|)
block|{
name|struct
name|TSAPdisconnect
name|tds
decl_stmt|;
operator|(
name|void
operator|)
name|TDiscRequest
argument_list|(
name|tcs
operator|.
name|tc_sd
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
operator|&
name|tds
argument_list|)
expr_stmt|;
name|ps_free
argument_list|(
name|ps
argument_list|)
expr_stmt|;
name|ps
operator|=
name|NULLPS
expr_stmt|;
block|}
name|acsap_lookup
operator|=
name|name2value_dase
expr_stmt|;
block|}
end_block

end_unit


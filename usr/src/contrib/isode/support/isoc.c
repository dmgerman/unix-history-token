begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* isoc.c - "minimal" ISODE client for testing */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/support/RCS/isoc.c,v 7.5 91/02/22 09:46:29 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/support/RCS/isoc.c,v 7.5 91/02/22 09:46:29 mrose Interim $  *  *  * $Log:	isoc.c,v $  * Revision 7.5  91/02/22  09:46:29  mrose  * Interim 6.8  *   * Revision 7.4  90/12/11  10:52:20  mrose  * lock-and-load  *   * Revision 7.3  90/11/11  10:53:16  mrose  * update  *   * Revision 7.2  90/10/16  12:56:05  mrose  * stuff  *   * Revision 7.1  89/12/07  21:19:51  mrose  * stuff  *   * Revision 7.0  89/11/23  22:27:15  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<varargs.h>
end_include

begin_include
include|#
directive|include
file|"rosap.h"
end_include

begin_include
include|#
directive|include
file|"rtsap.h"
end_include

begin_include
include|#
directive|include
file|"acsap.h"
end_include

begin_include
include|#
directive|include
file|"psap2.h"
end_include

begin_include
include|#
directive|include
file|"ssap.h"
end_include

begin_include
include|#
directive|include
file|"tsap.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TCP
end_ifdef

begin_include
include|#
directive|include
file|"internet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|BSD42
end_ifdef

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SVR3
end_ifdef

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"isoservent.h"
end_include

begin_include
include|#
directive|include
file|"tailor.h"
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_undef
undef|#
directive|undef
name|TIMER
end_undef

begin_undef
undef|#
directive|undef
name|TMS
end_undef

begin_ifdef
ifdef|#
directive|ifdef
name|BSD42
end_ifdef

begin_define
define|#
directive|define
name|TIMER
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SYS5
end_ifdef

begin_define
define|#
directive|define
name|TIMER
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|HPUX
end_ifndef

begin_include
include|#
directive|include
file|<sys/times.h>
end_include

begin_define
define|#
directive|define
name|TMS
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|TCP
argument_list|)
operator|&&
operator|(
name|defined
argument_list|(
name|FIONBIO
argument_list|)
operator|||
name|defined
argument_list|(
name|O_NDELAY
argument_list|)
operator|)
end_if

begin_define
define|#
directive|define
name|ASYNC
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*
comment|DATA */
end_comment

begin_define
define|#
directive|define
name|ISN
parameter_list|(
name|req
parameter_list|)
define|\
value|(req& (SR_MINORSYNC | SR_MAJORSYNC | SR_RESYNC | SR_ACTIVITY)) \ 	? (long) ((getpid () % (SERIAL_MAX - SERIAL_MIN + 1)) + SERIAL_MIN) \ 	: SERIAL_NONE
end_define

begin_enum
specifier|static
enum|enum
block|{
name|echo
block|,
name|sink
block|,
name|XXX
block|}
name|mode
init|=
name|XXX
enum|;
end_enum

begin_decl_stmt
specifier|static
name|int
name|testing_queued_writes
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|isacs
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|isrts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|status
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|myname
init|=
literal|"isoc"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|adios
argument_list|()
decl_stmt|,
name|advise
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ts_adios
argument_list|()
decl_stmt|,
name|ts_advise
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ss_adios
argument_list|()
decl_stmt|,
name|ss_advise
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ps_adios
argument_list|()
decl_stmt|,
name|ps_advise
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|acs_adios
argument_list|()
decl_stmt|,
name|acs_advise
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|rts_adios
argument_list|()
decl_stmt|,
name|rts_advise
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ros_adios
argument_list|()
decl_stmt|,
name|ros_advise
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|MAIN */
end_comment

begin_define
define|#
directive|define
name|chkacs
parameter_list|()
value|if (isacs) \ 			    adios (NULLCP, "no association control for %s", \ 					argv[2])
end_define

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|envp
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|,
decl|*
modifier|*
name|envp
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|struct
name|isoservent
modifier|*
name|is
decl_stmt|;
if|if
condition|(
name|myname
operator|=
name|rindex
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|'/'
argument_list|)
condition|)
name|myname
operator|++
expr_stmt|;
if|if
condition|(
name|myname
operator|==
name|NULL
operator|||
operator|*
name|myname
operator|==
name|NULL
condition|)
name|myname
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|isodetailor
argument_list|(
name|myname
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|4
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"usage: %s host provider entity"
argument_list|,
name|myname
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TCP
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"raw"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|raw_main
argument_list|(
name|argv
index|[
literal|3
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|index
argument_list|(
name|argv
index|[
literal|3
index|]
argument_list|,
literal|'/'
argument_list|)
condition|)
block|{
name|mode
operator|=
name|strcmp
argument_list|(
name|isacs
operator|=
name|argv
index|[
literal|3
index|]
argument_list|,
literal|"isode/sink"
argument_list|)
condition|?
name|echo
else|:
name|sink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|is
operator|=
name|getisoserventbyname
argument_list|(
name|argv
index|[
literal|3
index|]
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s/%s: unknown provider/entity pair"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|mode
operator|=
name|strcmp
argument_list|(
name|is
operator|->
name|is_entity
argument_list|,
literal|"sink"
argument_list|)
condition|?
name|echo
else|:
name|sink
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"tsap"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|chkacs
argument_list|()
expr_stmt|;
name|ts_main
argument_list|(
name|is
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"ssap"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|chkacs
argument_list|()
expr_stmt|;
name|ss_main
argument_list|(
name|is
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"psap"
argument_list|)
operator|==
literal|0
condition|)
name|ps_main
argument_list|(
name|is
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"rtsap"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|isrts
operator|=
literal|1
expr_stmt|;
name|rts_main
argument_list|(
name|is
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"rosap"
argument_list|)
operator|==
literal|0
condition|)
name|ros_main
argument_list|(
name|is
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
else|else
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown provider: \"%s\""
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|status
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_block

begin_comment
comment|/*
comment|RAW */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|TCP
end_ifdef

begin_function
specifier|static
name|int
name|raw_main
parameter_list|(
name|service
parameter_list|,
name|addr
parameter_list|)
name|char
modifier|*
name|service
decl_stmt|,
decl|*
name|addr
decl_stmt|;
end_function

begin_block
block|{
name|int
name|sd
decl_stmt|,
name|cc
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|;
specifier|register
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
specifier|register
name|struct
name|servent
modifier|*
name|sp
decl_stmt|;
name|struct
name|sockaddr_in
name|in_socket
decl_stmt|;
specifier|register
name|struct
name|sockaddr_in
modifier|*
name|isock
init|=
operator|&
name|in_socket
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|service
argument_list|,
literal|"sink"
argument_list|)
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"only sink on raw tcp is supported"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sp
operator|=
name|getservbyname
argument_list|(
name|service
argument_list|,
literal|"tcp"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s/%s: unknown service"
argument_list|,
literal|"tcp"
argument_list|,
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hp
operator|=
name|gethostbystring
argument_list|(
name|addr
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: unknown host"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|isock
argument_list|,
sizeof|sizeof
expr|*
name|isock
argument_list|)
expr_stmt|;
name|isock
operator|->
name|sin_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|isock
operator|->
name|sin_port
operator|=
name|sp
operator|->
name|s_port
expr_stmt|;
name|inaddr_copy
argument_list|(
name|hp
argument_list|,
name|isock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|=
name|start_tcp_client
argument_list|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
literal|"socket"
argument_list|,
literal|"unable to start"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s... "
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|join_tcp_server
argument_list|(
name|sd
argument_list|,
name|isock
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
literal|"socket"
argument_list|,
literal|"unable to connect"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connected\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|==
name|NOTOK
operator|||
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFREG
operator|||
operator|(
name|cc
operator|=
name|st
operator|.
name|st_size
operator|)
operator|==
literal|0
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"standard input not a regular file"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|cc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|cp
operator|,
name|j
operator|=
name|cc
init|;
name|j
operator|>
literal|0
condition|;
name|dp
operator|+=
name|i
operator|,
name|j
operator|-=
name|i
control|)
switch|switch
condition|(
name|i
operator|=
name|read
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|dp
argument_list|,
name|j
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|adios
argument_list|(
literal|"on stdin"
argument_list|,
literal|"read failed"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"premature end-of-file"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|write_tcp_socket
argument_list|(
name|sd
argument_list|,
name|cp
argument_list|,
name|cc
argument_list|)
operator|!=
name|cc
condition|)
name|adios
argument_list|(
literal|"writing"
argument_list|,
literal|"error"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close_tcp_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
name|cc
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*
comment|TSAP */
end_comment

begin_function
specifier|static
name|int
name|ts_main
parameter_list|(
name|is
parameter_list|,
name|addr
parameter_list|)
name|struct
name|isoservent
modifier|*
name|is
decl_stmt|;
name|char
modifier|*
name|addr
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|,
name|cc
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|expedited
decl_stmt|,
name|expd
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|TSAPaddr
modifier|*
name|ta
decl_stmt|;
name|struct
name|TSAPconnect
name|tcs
decl_stmt|;
specifier|register
name|struct
name|TSAPconnect
modifier|*
name|tc
init|=
operator|&
name|tcs
decl_stmt|;
name|struct
name|TSAPdisconnect
name|tds
decl_stmt|;
specifier|register
name|struct
name|TSAPdisconnect
modifier|*
name|td
init|=
operator|&
name|tds
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
operator|(
name|ta
operator|=
name|is2taddr
argument_list|(
name|addr
argument_list|,
name|NULLCP
argument_list|,
name|is
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"address translation failed"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s... "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|ASYNC
if|if
condition|(
name|TConnRequest
argument_list|(
name|NULLTA
argument_list|,
name|ta
argument_list|,
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|NULLQOS
argument_list|,
name|tc
argument_list|,
name|td
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ts_adios
argument_list|(
name|td
argument_list|,
literal|"T-CONNECT.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|sd
operator|=
name|tc
operator|->
name|tc_sd
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|(
name|i
operator|=
name|TAsynConnRequest
argument_list|(
name|NULLTA
argument_list|,
name|ta
argument_list|,
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|NULLQOS
argument_list|,
name|tc
argument_list|,
name|td
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ts_adios
argument_list|(
name|td
argument_list|,
literal|"T-(ASYN-)CONNECT.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|sd
operator|=
name|tc
operator|->
name|tc_sd
operator|,
name|cc
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|==
name|CONNECTING_1
operator|||
name|i
operator|==
name|CONNECTING_2
condition|)
block|{
name|int
name|nfds
decl_stmt|;
name|fd_set
name|mask
decl_stmt|,
modifier|*
name|rmask
decl_stmt|,
modifier|*
name|wmask
decl_stmt|;
name|nfds
operator|=
literal|0
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|TSelectMask
argument_list|(
name|sd
argument_list|,
operator|&
name|mask
argument_list|,
operator|&
name|nfds
argument_list|,
name|td
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ts_adios
argument_list|(
name|td
argument_list|,
literal|"T-(ASYN-)CONNECT.REQUEST(TSelectMask)"
argument_list|)
expr_stmt|;
block|}
name|rmask
operator|=
operator|(
name|i
operator|==
name|CONNECTING_2
operator|)
condition|?
operator|&
name|mask
else|:
name|NULLFD
expr_stmt|;
name|wmask
operator|=
operator|(
name|i
operator|==
name|CONNECTING_2
operator|)
condition|?
name|NULLFD
else|:
operator|&
name|mask
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"."
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|xselect
argument_list|(
name|nfds
argument_list|,
name|rmask
argument_list|,
name|wmask
argument_list|,
name|NULLFD
argument_list|,
literal|1
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
literal|"failed"
argument_list|,
literal|"select"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rmask
operator|&&
name|FD_ISSET
argument_list|(
name|sd
argument_list|,
name|rmask
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|wmask
operator|&&
name|FD_ISSET
argument_list|(
name|sd
argument_list|,
name|wmask
argument_list|)
operator|==
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|i
operator|=
name|TAsynRetryRequest
argument_list|(
name|sd
argument_list|,
name|tc
argument_list|,
name|td
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ts_adios
argument_list|(
name|td
argument_list|,
literal|"T-ASYN-RETRY.REQUEST"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connected\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|getenv
argument_list|(
literal|"TEST_QUEUED_WRITES"
argument_list|)
condition|)
block|{
if|if
condition|(
name|TSetQueuesOK
argument_list|(
name|tc
operator|->
name|tc_sd
argument_list|,
literal|1
argument_list|,
name|td
argument_list|)
operator|==
name|NOTOK
condition|)
name|ts_adios
argument_list|(
name|td
argument_list|,
literal|"T-SET-QUEUES-OK"
argument_list|)
expr_stmt|;
name|tsap_log
operator|->
name|ll_events
operator||=
name|LLOG_EXCEPTIONS
expr_stmt|;
name|tsap_log
operator|->
name|ll_file
operator|=
literal|"-"
expr_stmt|;
operator|(
name|void
operator|)
name|ll_close
argument_list|(
name|tsap_log
argument_list|)
expr_stmt|;
name|testing_queued_writes
operator|=
literal|1
expr_stmt|;
block|}
name|expd
operator|=
name|tc
operator|->
name|tc_expedited
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"responding TSAP address: %s"
argument_list|,
name|taddr2str
argument_list|(
operator|&
name|tc
operator|->
name|tc_responding
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tc
operator|->
name|tc_cc
operator|>
literal|0
condition|)
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"greetings: %d octets"
argument_list|,
name|tc
operator|->
name|tc_cc
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|!=
name|NOTOK
operator|&&
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|==
name|S_IFREG
operator|&&
operator|(
name|cc
operator|=
name|st
operator|.
name|st_size
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|cc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|cp
operator|,
name|j
operator|=
name|cc
init|;
name|j
operator|>
literal|0
condition|;
name|dp
operator|+=
name|i
operator|,
name|j
operator|-=
name|i
control|)
switch|switch
condition|(
name|i
operator|=
name|read
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|dp
argument_list|,
name|j
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|adios
argument_list|(
literal|"on stdin"
argument_list|,
literal|"read failed"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"premature end-of-file"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|10
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ts_datarequest
argument_list|(
name|sd
argument_list|,
name|cp
argument_list|,
name|cc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
name|cc
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|free
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
else|else
for|for
control|(
name|expedited
operator|=
literal|0
init|;
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|stdin
argument_list|)
condition|;
name|expedited
operator|=
operator|!
name|expedited
control|)
block|{
if|if
condition|(
operator|(
name|cc
operator|=
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|+
literal|1
operator|)
operator|>
name|TX_SIZE
operator|&&
name|expedited
condition|)
name|expedited
operator|=
literal|0
expr_stmt|;
name|ts_datarequest
argument_list|(
name|sd
argument_list|,
name|buffer
argument_list|,
name|cc
argument_list|,
name|expd
condition|?
name|expedited
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|TDiscRequest
argument_list|(
name|sd
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|td
argument_list|)
operator|==
name|NOTOK
condition|)
name|ts_adios
argument_list|(
name|td
argument_list|,
literal|"T-DISCONNECT.REQUEST"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|ts_datarequest
parameter_list|(
name|sd
parameter_list|,
name|data
parameter_list|,
name|cc
parameter_list|,
name|expedited
parameter_list|)
name|int
name|sd
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|cc
decl_stmt|,
name|expedited
decl_stmt|;
block|{
name|struct
name|TSAPdata
name|txs
decl_stmt|;
specifier|register
name|struct
name|TSAPdata
modifier|*
name|tx
init|=
operator|&
name|txs
decl_stmt|;
name|struct
name|TSAPdisconnect
name|tds
decl_stmt|;
specifier|register
name|struct
name|TSAPdisconnect
modifier|*
name|td
init|=
operator|&
name|tds
decl_stmt|;
if|if
condition|(
operator|(
name|expedited
condition|?
name|TExpdRequest
argument_list|(
name|sd
argument_list|,
name|data
argument_list|,
name|cc
argument_list|,
name|td
argument_list|)
else|:
name|TDataRequest
argument_list|(
name|sd
argument_list|,
name|data
argument_list|,
name|cc
argument_list|,
name|td
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
if|if
condition|(
name|expedited
condition|)
name|ts_adios
argument_list|(
name|td
argument_list|,
literal|"T-EXPEDITED-DATA.REQUEST"
argument_list|)
expr_stmt|;
else|else
name|ts_adios
argument_list|(
name|td
argument_list|,
literal|"T-DATA.REQUEST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|echo
condition|)
block|{
if|if
condition|(
name|testing_queued_writes
condition|)
block|{
name|int
name|vecp
decl_stmt|;
name|char
modifier|*
name|vec
index|[
literal|4
index|]
decl_stmt|;
name|fd_set
name|rfds
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|rfds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|sd
argument_list|,
operator|&
name|rfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|TNetAccept
argument_list|(
operator|&
name|vecp
argument_list|,
name|vec
argument_list|,
name|sd
operator|+
literal|1
argument_list|,
operator|&
name|rfds
argument_list|,
name|NULLFD
argument_list|,
name|NULLFD
argument_list|,
name|NOTOK
argument_list|,
name|td
argument_list|)
operator|==
name|NOTOK
condition|)
name|ts_adios
argument_list|(
name|td
argument_list|,
literal|"T-NET-ACCEPT"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|TReadRequest
argument_list|(
name|sd
argument_list|,
name|tx
argument_list|,
name|NOTOK
argument_list|,
name|td
argument_list|)
operator|==
name|NOTOK
condition|)
name|ts_adios
argument_list|(
name|td
argument_list|,
literal|"T-READ.REQUEST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|!=
name|tx
operator|->
name|tx_cc
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"length mismatch, orig=%d echo=%d"
argument_list|,
name|cc
argument_list|,
name|tx
operator|->
name|tx_cc
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|qcmp
argument_list|(
name|data
argument_list|,
operator|&
name|tx
operator|->
name|tx_qbuf
argument_list|,
name|cc
argument_list|)
condition|)
name|status
operator|++
expr_stmt|;
name|TXFREE
argument_list|(
argument|tx
argument_list|)
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|void
name|ts_adios
parameter_list|(
name|td
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|TSAPdisconnect
modifier|*
name|td
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|ts_advise
argument_list|(
name|td
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ts_advise
parameter_list|(
name|td
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|TSAPdisconnect
modifier|*
name|td
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|char
name|data
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|td
operator|->
name|td_cc
operator|>
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|data
argument_list|,
literal|"[%s] %*.*s"
argument_list|,
name|TErrString
argument_list|(
name|td
operator|->
name|td_reason
argument_list|)
argument_list|,
name|td
operator|->
name|td_cc
argument_list|,
name|td
operator|->
name|td_cc
argument_list|,
name|td
operator|->
name|td_data
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|data
argument_list|,
literal|"[%s]"
argument_list|,
name|TErrString
argument_list|(
name|td
operator|->
name|td_reason
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: %s"
argument_list|,
name|event
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|SSAP */
end_comment

begin_decl_stmt
specifier|static
name|int
name|requirements
init|=
name|SR_HALFDUPLEX
operator||
name|SR_DUPLEX
operator||
name|SR_EXPEDITED
operator||
name|SR_MINORSYNC
operator||
name|SR_MAJORSYNC
operator||
name|SR_RESYNC
operator||
name|SR_ACTIVITY
operator||
name|SR_NEGOTIATED
operator||
name|SR_CAPABILITY
operator||
name|SR_EXCEPTIONS
operator||
name|SR_TYPEDATA
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|owned
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|avail
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|ssn
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nmodes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|datamodes
index|[
literal|4
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|userdata
index|[
literal|1024
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|ss_main
parameter_list|(
name|is
parameter_list|,
name|addr
parameter_list|)
name|struct
name|isoservent
modifier|*
name|is
decl_stmt|;
name|char
modifier|*
name|addr
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|,
name|cc
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|l
decl_stmt|,
name|tokens
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|SSAPactid
name|ids
decl_stmt|;
specifier|register
name|struct
name|SSAPactid
modifier|*
name|id
init|=
operator|&
name|ids
decl_stmt|;
specifier|register
name|struct
name|SSAPaddr
modifier|*
name|sz
decl_stmt|;
name|struct
name|SSAPref
name|sfs
decl_stmt|;
specifier|register
name|struct
name|SSAPref
modifier|*
name|sf
decl_stmt|;
name|struct
name|SSAPconnect
name|scs
decl_stmt|;
specifier|register
name|struct
name|SSAPconnect
modifier|*
name|sc
init|=
operator|&
name|scs
decl_stmt|;
name|struct
name|SSAPrelease
name|srs
decl_stmt|;
specifier|register
name|struct
name|SSAPrelease
modifier|*
name|sr
init|=
operator|&
name|srs
decl_stmt|;
name|struct
name|SSAPindication
name|sis
decl_stmt|;
specifier|register
name|struct
name|SSAPindication
modifier|*
name|si
init|=
operator|&
name|sis
decl_stmt|;
specifier|register
name|struct
name|SSAPabort
modifier|*
name|sa
init|=
operator|&
name|si
operator|->
name|si_abort
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|bzero
argument_list|(
name|userdata
argument_list|,
sizeof|sizeof
name|userdata
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sz
operator|=
name|is2saddr
argument_list|(
name|addr
argument_list|,
name|NULLCP
argument_list|,
name|is
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"address translation failed"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sf
operator|=
name|addr2ref
argument_list|(
name|SLocalHostName
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sf
operator|=
operator|&
name|sfs
expr_stmt|;
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sf
argument_list|,
sizeof|sizeof
expr|*
name|sf
argument_list|)
expr_stmt|;
block|}
name|tokens
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \     if (requirements& requires) \ 	tokens |= ST_CALL_VALUE<< shift; \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s... "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|ASYNC
if|if
condition|(
name|SConnRequest
argument_list|(
name|sf
argument_list|,
name|NULLSA
argument_list|,
name|sz
argument_list|,
name|requirements
argument_list|,
name|tokens
argument_list|,
name|ISN
argument_list|(
name|requirements
argument_list|)
argument_list|,
name|userdata
argument_list|,
sizeof|sizeof
name|userdata
comment|/*SS_SIZE*/
argument_list|,
name|NULLQOS
argument_list|,
name|sc
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-CONNECT.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|sd
operator|=
name|sc
operator|->
name|sc_sd
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|(
name|i
operator|=
name|SAsynConnRequest
argument_list|(
name|sf
argument_list|,
name|NULLSA
argument_list|,
name|sz
argument_list|,
name|requirements
argument_list|,
name|tokens
argument_list|,
name|ISN
argument_list|(
name|requirements
argument_list|)
argument_list|,
name|userdata
argument_list|,
sizeof|sizeof
name|userdata
comment|/*SS_SIZE*/
argument_list|,
name|NULLQOS
argument_list|,
name|sc
argument_list|,
name|si
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-(ASYN-)CONNECT.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|sd
operator|=
name|sc
operator|->
name|sc_sd
operator|,
name|cc
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|==
name|CONNECTING_1
operator|||
name|i
operator|==
name|CONNECTING_2
condition|)
block|{
name|int
name|nfds
decl_stmt|;
name|fd_set
name|mask
decl_stmt|,
modifier|*
name|rmask
decl_stmt|,
modifier|*
name|wmask
decl_stmt|;
name|nfds
operator|=
literal|0
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|SSelectMask
argument_list|(
name|sd
argument_list|,
operator|&
name|mask
argument_list|,
operator|&
name|nfds
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-(ASYN-)CONNECT.REQUEST(SSelectMask)"
argument_list|)
expr_stmt|;
block|}
name|rmask
operator|=
operator|(
name|i
operator|==
name|CONNECTING_2
operator|)
condition|?
operator|&
name|mask
else|:
name|NULLFD
expr_stmt|;
name|wmask
operator|=
operator|(
name|i
operator|==
name|CONNECTING_2
operator|)
condition|?
name|NULLFD
else|:
operator|&
name|mask
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"."
argument_list|)
expr_stmt|;
if|if
condition|(
name|xselect
argument_list|(
name|nfds
argument_list|,
name|rmask
argument_list|,
name|wmask
argument_list|,
name|NULLFD
argument_list|,
literal|1
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
literal|"failed"
argument_list|,
literal|"select"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rmask
operator|&&
name|FD_ISSET
argument_list|(
name|sd
argument_list|,
name|rmask
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|wmask
operator|&&
name|FD_ISSET
argument_list|(
name|sd
argument_list|,
name|wmask
argument_list|)
operator|==
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|i
operator|=
name|SAsynRetryRequest
argument_list|(
name|sd
argument_list|,
name|sc
argument_list|,
name|si
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-ASYN-RETRY.REQUEST"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|sc
operator|->
name|sc_result
operator|!=
name|SC_ACCEPT
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_cc
operator|>
literal|0
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"connection rejected: [%s] %*.*s"
argument_list|,
name|SErrString
argument_list|(
name|sc
operator|->
name|sc_result
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_cc
argument_list|,
name|sc
operator|->
name|sc_cc
argument_list|,
name|sc
operator|->
name|sc_data
argument_list|)
expr_stmt|;
else|else
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"connection rejected: [%s]"
argument_list|,
name|SErrString
argument_list|(
name|sc
operator|->
name|sc_result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connected\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"responding SSAP address: %s"
argument_list|,
name|saddr2str
argument_list|(
operator|&
name|sc
operator|->
name|sc_responding
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_cc
operator|>
literal|0
condition|)
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"greetings: %d octets"
argument_list|,
name|sc
operator|->
name|sc_cc
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|requirements
operator|=
name|sc
operator|->
name|sc_requirements
expr_stmt|;
name|nmodes
operator|=
literal|0
expr_stmt|;
name|datamodes
index|[
name|nmodes
operator|++
index|]
operator|=
name|SX_NORMAL
expr_stmt|;
if|if
condition|(
name|requirements
operator|&
name|SR_EXPEDITED
condition|)
name|datamodes
index|[
name|nmodes
operator|++
index|]
operator|=
name|SX_EXPEDITED
expr_stmt|;
if|if
condition|(
operator|(
name|requirements
operator|&
name|SR_CAPABILITY
operator|)
operator|&&
operator|(
name|requirements
operator|&
name|SR_ACTIVITY
operator|)
condition|)
name|datamodes
index|[
name|nmodes
operator|++
index|]
operator|=
name|SX_CAPDIND
expr_stmt|;
if|if
condition|(
name|requirements
operator|&
name|SR_TYPEDATA
condition|)
name|datamodes
index|[
name|nmodes
operator|++
index|]
operator|=
name|SX_TYPED
expr_stmt|;
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \     if (requirements& requires) \ 	switch (sc -> sc_settings& (ST_MASK<< shift)) { \ 	    case ST_CALL_VALUE: \ 		adios (NULLCP, "%s token: choice", type); \  \ 	    case ST_INIT_VALUE: \ 		owned |= bit, avail |= bit; \ 		break; \  \ 	    case ST_RESP_VALUE: \ 		avail |= bit; \ 		break; \  \ 	    default: \ 		adios (NULLCP, "%s token: reserved", type); \ 	} \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
if|if
condition|(
name|requirements
operator|&
name|SR_ACTIVITY
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|id
operator|->
name|sd_data
argument_list|,
name|mode
operator|==
name|echo
condition|?
literal|"echo"
else|:
literal|"sink"
argument_list|)
expr_stmt|;
name|id
operator|->
name|sd_len
operator|=
name|strlen
argument_list|(
name|id
operator|->
name|sd_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|SActStartRequest
argument_list|(
name|sd
argument_list|,
name|id
argument_list|,
name|userdata
argument_list|,
name|SV_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-ACTIVITY-START.REQUEST"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|!=
name|NOTOK
operator|&&
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|==
name|S_IFREG
operator|&&
operator|(
name|cc
operator|=
name|st
operator|.
name|st_size
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|cc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|cp
operator|,
name|j
operator|=
name|cc
init|;
name|j
operator|>
literal|0
condition|;
name|dp
operator|+=
name|i
operator|,
name|j
operator|-=
name|i
control|)
switch|switch
condition|(
name|i
operator|=
name|read
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|dp
argument_list|,
name|j
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|adios
argument_list|(
literal|"on stdin"
argument_list|,
literal|"read failed"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"premature end-of-file"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|10
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ss_datarequest
argument_list|(
name|sd
argument_list|,
name|cp
argument_list|,
name|cc
argument_list|,
name|SX_NORMAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
name|cc
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|free
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|j
operator|=
name|l
operator|=
literal|0
init|;
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|stdin
argument_list|)
condition|;
control|)
block|{
name|k
operator|=
name|j
operator|>=
name|nmodes
condition|?
name|SX_EXPEDITED
else|:
name|datamodes
index|[
name|j
operator|++
operator|%
name|nmodes
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|cc
operator|=
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|+
literal|1
operator|)
operator|>
name|SX_EXSIZE
operator|&&
name|k
operator|==
name|SX_EXPEDITED
condition|)
block|{
if|if
condition|(
operator|(
name|k
operator|=
name|datamodes
index|[
name|j
operator|++
operator|%
name|nmodes
index|]
operator|)
operator|==
name|SX_EXPEDITED
condition|)
name|k
operator|=
name|datamodes
index|[
name|j
operator|++
operator|%
name|nmodes
index|]
expr_stmt|;
block|}
switch|switch
condition|(
name|k
condition|)
block|{
case|case
name|SX_CAPDIND
case|:
if|if
condition|(
operator|!
operator|(
name|requirements
operator|&
name|SR_RESYNC
operator|)
operator|||
name|l
operator|++
operator|&
literal|0x01
condition|)
block|{
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
name|ST_ACT_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|&
literal|0x03
condition|)
block|{
if|if
condition|(
name|SActIntrRequest
argument_list|(
name|sd
argument_list|,
name|SP_SEQUENCE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-ACTIVITY-INTERRUPT.REQUEST"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SActDiscRequest
argument_list|(
name|sd
argument_list|,
name|SP_SEQUENCE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-ACTIVITY-DISCARD.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|push_data
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|requirements
operator|&
name|SR_RESYNC
operator|)
condition|)
break|break;
name|tokens
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \ 		    if (requirements& requires) \ 			tokens |= ST_CALL_VALUE<< shift; \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
if|if
condition|(
name|SReSyncRequest
argument_list|(
name|sd
argument_list|,
name|SYNC_SET
argument_list|,
name|ssn
operator|-
literal|1
argument_list|,
name|tokens
argument_list|,
name|userdata
argument_list|,
name|SN_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-RESYNCHRONIZE.REQUEST"
argument_list|)
expr_stmt|;
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|SX_EXPEDITED
case|:
if|if
condition|(
name|j
operator|>=
name|nmodes
condition|)
name|j
operator|=
name|j
operator|%
name|nmodes
expr_stmt|;
comment|/* fall... */
if|if
condition|(
operator|!
operator|(
name|requirements
operator|&
name|SR_EXPEDITED
operator|)
condition|)
name|k
operator|=
name|SX_NORMAL
expr_stmt|;
comment|/* fall... */
default|default:
name|push_data
label|:
empty_stmt|;
name|ss_datarequest
argument_list|(
name|sd
argument_list|,
name|buffer
argument_list|,
name|cc
argument_list|,
name|k
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|SX_CAPDIND
operator|&&
name|SActResumeRequest
argument_list|(
name|sd
argument_list|,
name|id
argument_list|,
name|id
argument_list|,
call|(
name|long
call|)
argument_list|(
name|getpid
argument_list|()
operator|%
operator|(
name|SERIAL_MAX
operator|-
name|SERIAL_MIN
operator|+
literal|1
operator|)
argument_list|)
operator|+
name|SERIAL_MIN
argument_list|,
name|sf
argument_list|,
name|userdata
argument_list|,
name|SV_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-ACTIVITY-RESUME.REQUEST"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|requirements
operator|&
name|SR_EXCEPTIONS
condition|)
block|{
if|if
condition|(
name|owned
operator|&
name|ST_DAT_TOKEN
condition|)
if|if
condition|(
name|SGTokenRequest
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-TOKEN-GIVE.REQUEST"
argument_list|)
expr_stmt|;
else|else
name|owned
operator|&=
operator|~
name|ST_DAT_TOKEN
expr_stmt|;
if|if
condition|(
name|SUReportRequest
argument_list|(
name|sd
argument_list|,
name|SP_NOREASON
argument_list|,
name|userdata
argument_list|,
name|SP_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-U-EXCEPTION-REPORT.REQUEST"
argument_list|)
expr_stmt|;
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|requirements
operator|&
name|SR_MAJORSYNC
operator|)
operator|&&
operator|!
operator|(
name|requirements
operator|&
name|SR_ACTIVITY
operator|)
condition|)
block|{
if|if
condition|(
name|SMajSyncRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|userdata
argument_list|,
name|SN_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|sa
operator|->
name|sa_reason
condition|)
block|{
case|case
name|SC_OPERATION
case|:
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
operator||
name|ST_MIN_TOKEN
operator||
name|ST_MAJ_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|SMajSyncRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|userdata
argument_list|,
name|SN_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-MAJOR-SYNC.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|requirements
operator|&
name|SR_ACTIVITY
condition|)
block|{
if|if
condition|(
name|SActEndRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|userdata
argument_list|,
name|SV_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|sa
operator|->
name|sa_reason
condition|)
block|{
case|case
name|SC_OPERATION
case|:
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
name|avail
argument_list|)
expr_stmt|;
if|if
condition|(
name|SActEndRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|userdata
argument_list|,
name|SV_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-ACTIVITY-END.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|SGControlRequest
argument_list|(
name|sd
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|sa
operator|->
name|sa_reason
condition|)
block|{
case|case
name|SC_OPERATION
case|:
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
name|avail
argument_list|)
expr_stmt|;
if|if
condition|(
name|SGControlRequest
argument_list|(
name|sd
argument_list|,
name|si
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-CONTROL-GIVE.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|owned
operator|=
literal|0
expr_stmt|;
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SRelRequest
argument_list|(
name|sd
argument_list|,
name|userdata
argument_list|,
name|SF_SIZE
argument_list|,
name|NOTOK
argument_list|,
name|sr
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|sa
operator|->
name|sa_reason
condition|)
block|{
case|case
name|SC_OPERATION
case|:
case|case
name|SC_WAITING
case|:
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
name|avail
argument_list|)
expr_stmt|;
if|if
condition|(
name|SRelRequest
argument_list|(
name|sd
argument_list|,
name|userdata
argument_list|,
name|SF_SIZE
argument_list|,
name|NOTOK
argument_list|,
name|sr
argument_list|,
name|si
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-RELEASE.REQUEST"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|sr
operator|->
name|sr_affirmative
condition|)
block|{
operator|(
name|void
operator|)
name|SUAbortRequest
argument_list|(
name|sd
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|si
argument_list|)
expr_stmt|;
if|if
condition|(
name|sr
operator|->
name|sr_cc
operator|>
literal|0
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"release rejected by peer: %*.*s"
argument_list|,
name|sr
operator|->
name|sr_cc
argument_list|,
name|sr
operator|->
name|sr_cc
argument_list|,
name|sr
operator|->
name|sr_data
argument_list|)
expr_stmt|;
else|else
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"release rejected by peer"
argument_list|)
expr_stmt|;
block|}
name|SRFREE
argument_list|(
name|sr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|ss_datarequest
parameter_list|(
name|sd
parameter_list|,
name|data
parameter_list|,
name|cc
parameter_list|,
name|dm
parameter_list|,
name|sync
parameter_list|)
name|int
name|sd
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|cc
decl_stmt|,
name|dm
decl_stmt|,
name|sync
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|SSAPdata
name|sxs
decl_stmt|;
specifier|register
name|struct
name|SSAPdata
modifier|*
name|sx
init|=
operator|&
name|sxs
decl_stmt|;
name|struct
name|SSAPindication
name|sis
decl_stmt|;
specifier|register
name|struct
name|SSAPindication
modifier|*
name|si
init|=
operator|&
name|sis
decl_stmt|;
specifier|register
name|struct
name|SSAPabort
modifier|*
name|sa
init|=
operator|&
name|si
operator|->
name|si_abort
decl_stmt|;
switch|switch
condition|(
name|dm
condition|)
block|{
default|default:
if|if
condition|(
name|SDataRequest
argument_list|(
name|sd
argument_list|,
name|data
argument_list|,
name|cc
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|sa
operator|->
name|sa_reason
condition|)
block|{
case|case
name|SC_OPERATION
case|:
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|SDataRequest
argument_list|(
name|sd
argument_list|,
name|data
argument_list|,
name|cc
argument_list|,
name|si
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-DATA.REQUEST"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SX_EXPEDITED
case|:
if|if
condition|(
name|SExpdRequest
argument_list|(
name|sd
argument_list|,
name|data
argument_list|,
name|cc
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-EXPEDITED-DATA.REQUEST"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SX_CAPDIND
case|:
if|if
condition|(
name|SCapdRequest
argument_list|(
name|sd
argument_list|,
name|data
argument_list|,
name|cc
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|sa
operator|->
name|sa_reason
condition|)
block|{
case|case
name|SC_OPERATION
case|:
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
name|avail
operator|&
operator|~
name|ST_RLS_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|SCapdRequest
argument_list|(
name|sd
argument_list|,
name|data
argument_list|,
name|cc
argument_list|,
name|si
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-CAPABILITY-DATA.REQUEST"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SX_TYPED
case|:
if|if
condition|(
name|STypedRequest
argument_list|(
name|sd
argument_list|,
name|data
argument_list|,
name|cc
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-TYPED-DATA.REQUEST"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|mode
operator|==
name|echo
operator|||
name|dm
operator|==
name|SX_CAPDIND
condition|)
for|for
control|(
init|;
condition|;
control|)
block|{
switch|switch
condition|(
name|result
operator|=
name|SReadRequest
argument_list|(
name|sd
argument_list|,
name|sx
argument_list|,
name|NOTOK
argument_list|,
name|si
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-READ.REQUEST"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
if|if
condition|(
operator|(
name|dm
operator|!=
name|SX_CAPDIND
condition|?
name|dm
else|:
name|SX_CAPDCNF
operator|)
operator|!=
name|sx
operator|->
name|sx_type
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"data indication type mismatch, orig=%d echo=%d"
argument_list|,
name|dm
argument_list|,
name|sx
operator|->
name|sx_type
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cc
operator|!=
name|sx
operator|->
name|sx_cc
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"length mismatch, orig=%d echo=%d"
argument_list|,
name|cc
argument_list|,
name|sx
operator|->
name|sx_cc
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|qcmp
argument_list|(
name|data
argument_list|,
operator|&
name|sx
operator|->
name|sx_qbuf
argument_list|,
name|cc
argument_list|)
condition|)
name|status
operator|++
expr_stmt|;
name|SXFREE
argument_list|(
argument|sx
argument_list|)
break|break;
case|case
name|DONE
case|:
name|ss_event
argument_list|(
name|sd
argument_list|,
name|si
argument_list|)
expr_stmt|;
continue|continue;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown return from SReadRequest=%d"
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|sync
operator|&&
operator|(
name|requirements
operator|&
name|SR_MINORSYNC
operator|)
operator|&&
operator|!
operator|(
name|requirements
operator|&
name|SR_ACTIVITY
operator|)
condition|)
block|{
if|if
condition|(
name|SMinSyncRequest
argument_list|(
name|sd
argument_list|,
name|SYNC_CONFIRM
argument_list|,
operator|&
name|ssn
argument_list|,
name|userdata
argument_list|,
name|SN_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|sa
operator|->
name|sa_reason
condition|)
block|{
case|case
name|SC_OPERATION
case|:
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
operator||
name|ST_MIN_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|SMinSyncRequest
argument_list|(
name|sd
argument_list|,
name|SYNC_CONFIRM
argument_list|,
operator|&
name|ssn
argument_list|,
name|userdata
argument_list|,
name|SN_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-MINOR-SYNC.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sync
operator|&&
operator|(
name|requirements
operator|&
name|SR_ACTIVITY
operator|)
operator|&&
operator|(
name|requirements
operator|&
name|SR_MAJORSYNC
operator|)
operator|&&
name|dm
operator|==
name|SX_NORMAL
condition|)
block|{
if|if
condition|(
name|SMajSyncRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|userdata
argument_list|,
name|SN_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|sa
operator|->
name|sa_reason
condition|)
block|{
case|case
name|SC_OPERATION
case|:
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
operator||
name|ST_MIN_TOKEN
operator||
name|ST_MAJ_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|SMajSyncRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|userdata
argument_list|,
name|SN_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-MAJOR-SYNC.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|ss_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|ss_waitfor
parameter_list|(
name|sd
parameter_list|,
name|want
parameter_list|)
name|int
name|sd
decl_stmt|,
name|want
decl_stmt|;
block|{
name|int
name|result
decl_stmt|,
name|tokens
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|SSAPdata
name|sxs
decl_stmt|;
specifier|register
name|struct
name|SSAPdata
modifier|*
name|sx
init|=
operator|&
name|sxs
decl_stmt|;
name|struct
name|SSAPindication
name|sis
decl_stmt|;
specifier|register
name|struct
name|SSAPindication
modifier|*
name|si
init|=
operator|&
name|sis
decl_stmt|;
specifier|register
name|struct
name|SSAPabort
modifier|*
name|sa
init|=
operator|&
name|si
operator|->
name|si_abort
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|want
operator|==
operator|-
literal|1
condition|)
block|{
name|want
operator|=
name|avail
expr_stmt|;
goto|goto
name|read_it
goto|;
block|}
name|tokens
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \ 	if ((want& bit)&& !(owned& bit)) \ 	    tokens |= bit; \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
if|if
condition|(
name|tokens
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|SPTokenRequest
argument_list|(
name|sd
argument_list|,
name|tokens
argument_list|,
name|userdata
argument_list|,
name|ST_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-TOKEN-PLEASE.REQUEST"
argument_list|)
expr_stmt|;
name|read_it
label|:
empty_stmt|;
switch|switch
condition|(
name|result
operator|=
name|SReadRequest
argument_list|(
name|sd
argument_list|,
name|sx
argument_list|,
name|NOTOK
argument_list|,
name|si
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-READ.REQUEST"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
literal|"protocol screw-up"
argument_list|)
expr_stmt|;
if|if
condition|(
name|SUAbortRequest
argument_list|(
name|sd
argument_list|,
name|buffer
argument_list|,
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|+
literal|1
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-U-ABORT.REQUEST"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s, data indication type=0x%x"
argument_list|,
name|buffer
argument_list|,
name|sx
operator|->
name|sx_type
argument_list|)
expr_stmt|;
case|case
name|DONE
case|:
name|ss_event
argument_list|(
name|sd
argument_list|,
name|si
argument_list|)
expr_stmt|;
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown return from SReadRequest=%d"
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|ss_event
argument_list|(
argument|sd
argument_list|,
argument|si
argument_list|)
name|int
name|sd
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|SSAPindication
modifier|*
name|si
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|SSAPabort
modifier|*
name|sa
init|=
operator|&
name|si
operator|->
name|si_abort
decl_stmt|;
specifier|register
name|struct
name|SSAPactivity
modifier|*
name|sv
init|=
operator|&
name|si
operator|->
name|si_activity
decl_stmt|;
specifier|register
name|struct
name|SSAPfinish
modifier|*
name|sf
init|=
operator|&
name|si
operator|->
name|si_finish
decl_stmt|;
specifier|register
name|struct
name|SSAPreport
modifier|*
name|sp
init|=
operator|&
name|si
operator|->
name|si_report
decl_stmt|;
specifier|register
name|struct
name|SSAPsync
modifier|*
name|sn
init|=
operator|&
name|si
operator|->
name|si_sync
decl_stmt|;
specifier|register
name|struct
name|SSAPtoken
modifier|*
name|st
init|=
operator|&
name|si
operator|->
name|si_token
decl_stmt|;
switch|switch
condition|(
name|si
operator|->
name|si_type
condition|)
block|{
case|case
name|SI_TOKEN
case|:
switch|switch
condition|(
name|st
operator|->
name|st_type
condition|)
block|{
case|case
name|ST_GIVE
case|:
case|case
name|ST_CONTROL
case|:
name|owned
operator|=
name|st
operator|->
name|st_owned
expr_stmt|;
break|break;
case|case
name|ST_PLEASE
case|:
if|if
condition|(
name|SGTokenRequest
argument_list|(
name|sd
argument_list|,
operator|(
name|int
operator|)
name|st
operator|->
name|st_tokens
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-TOKEN-GIVE.REQUEST"
argument_list|)
expr_stmt|;
else|else
name|owned
operator|&=
operator|~
name|st
operator|->
name|st_tokens
expr_stmt|;
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown token indication type=0x%x, %d bytes"
argument_list|,
name|st
operator|->
name|st_type
argument_list|,
name|st
operator|->
name|st_cc
argument_list|)
expr_stmt|;
block|}
name|STFREE
argument_list|(
name|st
argument_list|)
expr_stmt|;
break|break;
case|case
name|SI_SYNC
case|:
switch|switch
condition|(
name|sn
operator|->
name|sn_type
condition|)
block|{
case|case
name|SN_MAJORIND
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"majorsync indication %d, %d bytes"
argument_list|,
name|sn
operator|->
name|sn_ssn
argument_list|,
name|sn
operator|->
name|sn_cc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SN_MAJORCNF
case|:
break|break;
case|case
name|SN_MINORIND
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"minorsync indication %d%s, %d bytes"
argument_list|,
name|sn
operator|->
name|sn_ssn
argument_list|,
name|sn
operator|->
name|sn_options
operator|==
name|SYNC_CONFIRM
condition|?
literal|" (wants confirmation)"
else|:
name|NULLCP
argument_list|,
name|sn
operator|->
name|sn_cc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SN_MINORCNF
case|:
break|break;
case|case
name|SN_RESETIND
case|:
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \ 		    if (requirements& requires) \ 			switch (sn -> sn_settings& (ST_MASK<< shift)) { \ 			    case ST_CALL_VALUE<< shift: \ 				sn -> sn_settings&= ~(ST_MASK<< shift); \ 				sn -> sn_settings |= ST_RESP_VALUE<< shift; \ 			    case ST_RESP_VALUE<< shift: \ 				owned&= ~bit; \ 				break; \  \ 			    case ST_INIT_VALUE<< shift: \ 				owned |= bit; \ 				break; \  \ 			    default: \ 				adios (NULLCP, "%s token: reserved", type); \ 				break; \ 			} \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
if|if
condition|(
name|SReSyncResponse
argument_list|(
name|sd
argument_list|,
name|sn
operator|->
name|sn_ssn
argument_list|,
name|sn
operator|->
name|sn_settings
argument_list|,
name|userdata
argument_list|,
name|SN_SIZE
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-RESYNCHRONIZE.RESPONSE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SN_RESETCNF
case|:
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown sync indication=0x%x, ssn=%d, %d bytes"
argument_list|,
name|sn
operator|->
name|sn_type
argument_list|,
name|sn
operator|->
name|sn_ssn
argument_list|,
name|sn
operator|->
name|sn_cc
argument_list|)
expr_stmt|;
block|}
name|SNFREE
argument_list|(
name|sn
argument_list|)
expr_stmt|;
break|break;
case|case
name|SI_ACTIVITY
case|:
switch|switch
condition|(
name|sv
operator|->
name|sv_type
condition|)
block|{
case|case
name|SV_START
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"activity start indication: %*.*s, %d bytes"
argument_list|,
name|sv
operator|->
name|sv_id
operator|.
name|sd_len
argument_list|,
name|sv
operator|->
name|sv_id
operator|.
name|sd_len
argument_list|,
name|sv
operator|->
name|sv_id
operator|.
name|sd_data
argument_list|,
name|sv
operator|->
name|sv_cc
argument_list|)
expr_stmt|;
case|case
name|SV_RESUME
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"activity resume indication: id=%*.*s oid=%*.*s connect=%s ssn=%d, %d bytes"
argument_list|,
name|sv
operator|->
name|sv_id
operator|.
name|sd_len
argument_list|,
name|sv
operator|->
name|sv_id
operator|.
name|sd_len
argument_list|,
name|sv
operator|->
name|sv_id
operator|.
name|sd_data
argument_list|,
name|sv
operator|->
name|sv_oid
operator|.
name|sd_len
argument_list|,
name|sv
operator|->
name|sv_oid
operator|.
name|sd_len
argument_list|,
name|sv
operator|->
name|sv_oid
operator|.
name|sd_data
argument_list|,
name|sprintref
argument_list|(
operator|&
name|sv
operator|->
name|sv_connect
argument_list|)
argument_list|,
name|sv
operator|->
name|sv_ssn
argument_list|,
name|sv
operator|->
name|sv_cc
argument_list|)
expr_stmt|;
case|case
name|SV_INTRIND
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"activity interrupt indication %d, %d bytes"
argument_list|,
name|sv
operator|->
name|sv_reason
argument_list|,
name|sv
operator|->
name|sv_cc
argument_list|)
expr_stmt|;
case|case
name|SV_INTRCNF
case|:
break|break;
case|case
name|SV_DISCIND
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"activity discard indication %d, %d bytes"
argument_list|,
name|sv
operator|->
name|sv_reason
argument_list|,
name|sv
operator|->
name|sv_cc
argument_list|)
expr_stmt|;
case|case
name|SV_DISCCNF
case|:
break|break;
case|case
name|SV_ENDIND
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"activity end indication %d, %d bytes"
argument_list|,
name|sv
operator|->
name|sv_ssn
argument_list|,
name|sv
operator|->
name|sv_cc
argument_list|)
expr_stmt|;
case|case
name|SV_ENDCNF
case|:
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown activity indication=0x%x, %d bytes"
argument_list|,
name|sv
operator|->
name|sv_type
argument_list|,
name|sv
operator|->
name|sv_cc
argument_list|)
expr_stmt|;
block|}
name|SVFREE
argument_list|(
name|sv
argument_list|)
expr_stmt|;
break|break;
case|case
name|SI_REPORT
case|:
if|if
condition|(
name|requirements
operator|&
name|SR_DAT_EXISTS
condition|)
block|{
if|if
condition|(
name|SGTokenRequest
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-TOKEN-GIVE.REQUEST (to clear exception)"
argument_list|)
expr_stmt|;
else|else
name|owned
operator|&=
operator|~
name|ST_DAT_TOKEN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SUAbortRequest
argument_list|(
name|sd
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-U-ABORT.REQUEST"
argument_list|)
expr_stmt|;
else|else
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"aborted"
argument_list|)
expr_stmt|;
name|SPFREE
argument_list|(
name|sp
argument_list|)
expr_stmt|;
break|break;
case|case
name|SI_FINISH
case|:
if|if
condition|(
name|SRelResponse
argument_list|(
name|sd
argument_list|,
name|SC_REJECTED
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|si
argument_list|)
operator|==
name|NOTOK
condition|)
name|ss_adios
argument_list|(
name|sa
argument_list|,
literal|"S-RELEASE.RESPONSE"
argument_list|)
expr_stmt|;
name|SFFREE
argument_list|(
name|sf
argument_list|)
expr_stmt|;
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown indication type=0x%x"
argument_list|,
name|si
operator|->
name|si_type
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|void
name|ss_adios
parameter_list|(
name|sa
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|SSAPabort
modifier|*
name|sa
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|ss_advise
argument_list|(
name|sa
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ss_advise
parameter_list|(
name|sa
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|SSAPabort
modifier|*
name|sa
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_cc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s] %*.*s"
argument_list|,
name|SErrString
argument_list|(
name|sa
operator|->
name|sa_reason
argument_list|)
argument_list|,
name|sa
operator|->
name|sa_cc
argument_list|,
name|sa
operator|->
name|sa_cc
argument_list|,
name|sa
operator|->
name|sa_data
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s]"
argument_list|,
name|SErrString
argument_list|(
name|sa
operator|->
name|sa_reason
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: %s%s"
argument_list|,
name|event
argument_list|,
name|buffer
argument_list|,
name|sa
operator|->
name|sa_peer
condition|?
literal|" (peer initiated)"
else|:
literal|""
argument_list|)
expr_stmt|;
name|SAFREE
argument_list|(
name|sa
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|PSAP */
end_comment

begin_decl_stmt
specifier|static
name|int
name|prequirements
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|srequirements
value|requirements
end_define

begin_decl_stmt
specifier|static
name|int
name|nctxs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|datactxs
index|[
name|NPCTX
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|ps_main
parameter_list|(
name|is
parameter_list|,
name|addr
parameter_list|)
name|struct
name|isoservent
modifier|*
name|is
decl_stmt|;
name|char
modifier|*
name|addr
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|,
name|cc
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|l
decl_stmt|,
name|m
decl_stmt|,
name|tokens
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|struct
name|PSAPaddr
modifier|*
name|pz
decl_stmt|;
name|struct
name|SSAPactid
name|ids
decl_stmt|;
specifier|register
name|struct
name|SSAPactid
modifier|*
name|id
init|=
operator|&
name|ids
decl_stmt|;
name|struct
name|SSAPref
name|sfs
decl_stmt|;
specifier|register
name|struct
name|SSAPref
modifier|*
name|sf
decl_stmt|;
name|struct
name|PSAPconnect
name|pcs
decl_stmt|;
specifier|register
name|struct
name|PSAPconnect
modifier|*
name|pc
init|=
operator|&
name|pcs
decl_stmt|;
name|struct
name|PSAPctxlist
name|pls
decl_stmt|;
specifier|register
name|struct
name|PSAPctxlist
modifier|*
name|pl
init|=
operator|&
name|pls
decl_stmt|;
name|struct
name|PSAPrelease
name|prs
decl_stmt|;
specifier|register
name|struct
name|PSAPrelease
modifier|*
name|pr
init|=
operator|&
name|prs
decl_stmt|;
name|struct
name|PSAPindication
name|pis
decl_stmt|;
specifier|register
name|struct
name|PSAPindication
modifier|*
name|pi
init|=
operator|&
name|pis
decl_stmt|;
specifier|register
name|struct
name|PSAPabort
modifier|*
name|pa
init|=
operator|&
name|pi
operator|->
name|pi_abort
decl_stmt|;
name|struct
name|AcSAPconnect
name|accs
decl_stmt|;
specifier|register
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
name|accs
decl_stmt|;
name|struct
name|AcSAPrelease
name|acrs
decl_stmt|;
specifier|register
name|struct
name|AcSAPrelease
modifier|*
name|acr
init|=
operator|&
name|acrs
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
specifier|register
name|PE
name|pe
decl_stmt|;
name|PE
name|udata
index|[
name|NPDATA
index|]
decl_stmt|;
name|AEI
name|aei
decl_stmt|;
name|OID
name|oid
decl_stmt|,
name|ode
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
name|isacs
condition|)
block|{
if|if
condition|(
operator|(
name|aei
operator|=
name|str2aei
argument_list|(
name|addr
argument_list|,
name|isacs
argument_list|)
operator|)
operator|==
name|NULLAEI
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s-%s: unknown application-entity"
argument_list|,
name|addr
argument_list|,
name|isacs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pz
operator|=
name|aei2addr
argument_list|(
name|aei
argument_list|)
operator|)
operator|==
name|NULLPA
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"address translation failed"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|mode
operator|==
name|echo
condition|?
literal|"isode echo pci"
else|:
literal|"isode sink pci"
expr_stmt|;
if|if
condition|(
operator|(
name|ode
operator|=
name|ode2oid
argument_list|(
name|cp
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: unknown object descriptor"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|ode
operator|=
name|oid_cpy
argument_list|(
name|ode
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pz
operator|=
name|is2paddr
argument_list|(
name|addr
argument_list|,
name|NULLCP
argument_list|,
name|is
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"address translation failed"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sf
operator|=
name|addr2ref
argument_list|(
name|PLocalHostName
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sf
operator|=
operator|&
name|sfs
expr_stmt|;
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sf
argument_list|,
sizeof|sizeof
expr|*
name|sf
argument_list|)
expr_stmt|;
block|}
name|tokens
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \     if (srequirements& requires) \ 	tokens |= ST_CALL_VALUE<< shift; \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
for|for
control|(
name|i
operator|=
operator|(
name|pl
operator|->
name|pc_nctx
operator|=
name|NPCTX
operator|-
operator|(
name|isacs
condition|?
literal|1
else|:
literal|0
operator|)
operator|)
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_id
operator|=
name|i
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|oid
operator|=
name|ode2oid
argument_list|(
literal|"iso asn.1 abstract syntax"
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"iso asn.1 abstract syntax: unknown"
argument_list|)
expr_stmt|;
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_asn
operator|=
name|oid_cpy
argument_list|(
name|oid
argument_list|)
expr_stmt|;
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_atn
operator|=
name|NULLOID
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPDATA
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|pe
operator|=
name|int2prim
argument_list|(
name|i
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate hello"
argument_list|)
expr_stmt|;
name|pe
operator|->
name|pe_context
operator|=
operator|(
name|i
operator|%
name|pl
operator|->
name|pc_nctx
operator|)
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
name|udata
index|[
name|i
index|]
operator|=
name|pe
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s... "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|isacs
condition|)
block|{
ifndef|#
directive|ifndef
name|ASYNC
if|if
condition|(
name|AcAssocRequest
argument_list|(
name|ode
argument_list|,
name|NULLAEI
argument_list|,
name|aei
argument_list|,
name|NULLPA
argument_list|,
name|pz
argument_list|,
name|pl
argument_list|,
name|ode
argument_list|,
name|prequirements
argument_list|,
name|srequirements
argument_list|,
name|ISN
argument_list|(
name|srequirements
argument_list|)
argument_list|,
name|tokens
argument_list|,
name|sf
argument_list|,
name|udata
argument_list|,
name|NACDATA
argument_list|,
name|NULLQOS
argument_list|,
name|acc
argument_list|,
name|aci
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|acs_adios
argument_list|(
name|aca
argument_list|,
literal|"A-ASSOCIATE.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|sd
operator|=
name|acc
operator|->
name|acc_sd
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|(
name|i
operator|=
name|AcAsynAssocRequest
argument_list|(
name|ode
argument_list|,
name|NULLAEI
argument_list|,
name|aei
argument_list|,
name|NULLPA
argument_list|,
name|pz
argument_list|,
name|pl
argument_list|,
name|ode
argument_list|,
name|prequirements
argument_list|,
name|srequirements
argument_list|,
name|ISN
argument_list|(
name|srequirements
argument_list|)
argument_list|,
name|tokens
argument_list|,
name|sf
argument_list|,
name|udata
argument_list|,
name|NACDATA
argument_list|,
name|NULLQOS
argument_list|,
name|acc
argument_list|,
name|aci
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|acs_adios
argument_list|(
name|aca
argument_list|,
literal|"A-(ASYN-)ASSOCIATE.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|sd
operator|=
name|acc
operator|->
name|acc_sd
operator|,
name|cc
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|==
name|CONNECTING_1
operator|||
name|i
operator|==
name|CONNECTING_2
condition|)
block|{
name|int
name|nfds
decl_stmt|;
name|fd_set
name|mask
decl_stmt|,
modifier|*
name|rmask
decl_stmt|,
modifier|*
name|wmask
decl_stmt|;
name|nfds
operator|=
literal|0
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|PSelectMask
argument_list|(
name|sd
argument_list|,
operator|&
name|mask
argument_list|,
operator|&
name|nfds
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|acs_adios
argument_list|(
name|aca
argument_list|,
literal|"A-(ASYN-)ASSOCIATE.REQUEST(PSelectMask)"
argument_list|)
expr_stmt|;
block|}
name|rmask
operator|=
operator|(
name|i
operator|==
name|CONNECTING_2
operator|)
condition|?
operator|&
name|mask
else|:
name|NULLFD
expr_stmt|;
name|wmask
operator|=
operator|(
name|i
operator|==
name|CONNECTING_2
operator|)
condition|?
name|NULLFD
else|:
operator|&
name|mask
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"."
argument_list|)
expr_stmt|;
if|if
condition|(
name|xselect
argument_list|(
name|nfds
argument_list|,
name|rmask
argument_list|,
name|wmask
argument_list|,
name|NULLFD
argument_list|,
literal|1
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
literal|"failed"
argument_list|,
literal|"select"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rmask
operator|&&
name|FD_ISSET
argument_list|(
name|sd
argument_list|,
name|rmask
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|wmask
operator|&&
name|FD_ISSET
argument_list|(
name|sd
argument_list|,
name|wmask
argument_list|)
operator|==
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|i
operator|=
name|AcAsynRetryRequest
argument_list|(
name|sd
argument_list|,
name|acc
argument_list|,
name|aci
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|acs_adios
argument_list|(
name|aca
argument_list|,
literal|"A-ASYN-RETRY.REQUEST"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|acc
operator|->
name|acc_result
operator|!=
name|ACS_ACCEPT
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"connection rejected: [%s], %d elements"
argument_list|,
name|AcErrString
argument_list|(
name|acc
operator|->
name|acc_result
argument_list|)
argument_list|,
name|acc
operator|->
name|acc_ninfo
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
ifndef|#
directive|ifndef
name|ASYNC
if|if
condition|(
name|PConnRequest
argument_list|(
name|NULLPA
argument_list|,
name|pz
argument_list|,
name|pl
argument_list|,
name|NULLOID
argument_list|,
name|prequirements
argument_list|,
name|srequirements
argument_list|,
name|srequirements
operator|&
operator|(
name|SR_MINORSYNC
operator||
name|SR_MAJORSYNC
operator||
name|SR_RESYNC
operator||
name|SR_ACTIVITY
operator|)
condition|?
call|(
name|long
call|)
argument_list|(
name|getpid
argument_list|()
operator|%
operator|(
name|SERIAL_MAX
operator|-
name|SERIAL_MIN
operator|+
literal|1
operator|)
argument_list|)
operator|+
name|SERIAL_MIN
else|:
name|SERIAL_NONE
argument_list|,
name|tokens
argument_list|,
name|sf
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|NULLQOS
argument_list|,
name|pc
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-CONNECT.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|sd
operator|=
name|pc
operator|->
name|pc_sd
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|(
name|i
operator|=
name|PAsynConnRequest
argument_list|(
name|NULLPA
argument_list|,
name|pz
argument_list|,
name|pl
argument_list|,
name|NULLOID
argument_list|,
name|prequirements
argument_list|,
name|srequirements
argument_list|,
name|ISN
argument_list|(
name|srequirements
argument_list|)
argument_list|,
name|tokens
argument_list|,
name|sf
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|NULLQOS
argument_list|,
name|pc
argument_list|,
name|pi
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-CONNECT.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|sd
operator|=
name|pc
operator|->
name|pc_sd
operator|,
name|cc
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|==
name|CONNECTING_1
operator|||
name|i
operator|==
name|CONNECTING_2
condition|)
block|{
name|int
name|nfds
decl_stmt|;
name|fd_set
name|mask
decl_stmt|,
modifier|*
name|rmask
decl_stmt|,
modifier|*
name|wmask
decl_stmt|;
name|nfds
operator|=
literal|0
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|PSelectMask
argument_list|(
name|sd
argument_list|,
operator|&
name|mask
argument_list|,
operator|&
name|nfds
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-CONNECT.REQUEST(PSelectMask)"
argument_list|)
expr_stmt|;
block|}
name|rmask
operator|=
operator|(
name|i
operator|==
name|CONNECTING_2
operator|)
condition|?
operator|&
name|mask
else|:
name|NULLFD
expr_stmt|;
name|wmask
operator|=
operator|(
name|i
operator|==
name|CONNECTING_2
operator|)
condition|?
name|NULLFD
else|:
operator|&
name|mask
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"."
argument_list|)
expr_stmt|;
if|if
condition|(
name|xselect
argument_list|(
name|nfds
argument_list|,
name|rmask
argument_list|,
name|wmask
argument_list|,
name|NULLFD
argument_list|,
literal|1
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
literal|"failed"
argument_list|,
literal|"select"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rmask
operator|&&
name|FD_ISSET
argument_list|(
name|sd
argument_list|,
name|rmask
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|wmask
operator|&&
name|FD_ISSET
argument_list|(
name|sd
argument_list|,
name|wmask
argument_list|)
operator|==
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|i
operator|=
name|PAsynRetryRequest
argument_list|(
name|sd
argument_list|,
name|pc
argument_list|,
name|pi
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-ASYN-RETRY.REQUEST"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|pc
operator|->
name|pc_result
operator|!=
name|PC_ACCEPT
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"connection rejected: [%s], %d elements"
argument_list|,
name|PErrString
argument_list|(
name|pc
operator|->
name|pc_result
argument_list|)
argument_list|,
name|pc
operator|->
name|pc_ninfo
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connected\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isacs
condition|)
block|{
name|pc
operator|=
operator|&
name|acc
operator|->
name|acc_connect
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"context: %s"
argument_list|,
name|oid2ode
argument_list|(
name|acc
operator|->
name|acc_context
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"responding AE title: %s, responding PSAP address: %s"
argument_list|,
name|sprintaei
argument_list|(
operator|&
name|acc
operator|->
name|acc_respondtitle
argument_list|)
argument_list|,
name|paddr2str
argument_list|(
operator|&
name|pc
operator|->
name|pc_responding
argument_list|,
name|NULLNA
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"greetings: %d elements"
argument_list|,
name|acc
operator|->
name|acc_ninfo
argument_list|)
expr_stmt|;
name|pl
operator|=
operator|&
name|pc
operator|->
name|pc_ctxlist
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pl
operator|->
name|pc_nctx
condition|;
name|i
operator|++
control|)
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"ctx %d: 0x%x 0x%x %d"
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_id
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_asn
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_atn
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_result
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"default %d"
argument_list|,
name|pc
operator|->
name|pc_defctxresult
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"p/s requirements 0x%x/0x%x"
argument_list|,
name|pc
operator|->
name|pc_prequirements
argument_list|,
name|pc
operator|->
name|pc_srequirements
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|pl
operator|=
operator|&
name|pc
operator|->
name|pc_ctxlist
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|echo
condition|)
block|{
if|if
condition|(
name|acc
operator|->
name|acc_ninfo
operator|!=
name|NACDATA
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"expecting %d hellos, got %d elements"
argument_list|,
name|NACDATA
argument_list|,
name|acc
operator|->
name|acc_ninfo
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NACDATA
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|pe
operator|=
name|acc
operator|->
name|acc_info
index|[
name|i
index|]
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"hello %d: NULL"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|=
name|prim2num
argument_list|(
name|pe
argument_list|)
operator|)
operator|==
name|NOTOK
operator|&&
name|pe
operator|->
name|pe_errno
operator|!=
name|PE_ERR_NONE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"hello %d: %s"
argument_list|,
name|i
argument_list|,
name|pe_error
argument_list|(
name|pe
operator|->
name|pe_errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|!=
name|i
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"hello %d: value %d"
argument_list|,
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|pe
operator|->
name|pe_context
operator|!=
name|udata
index|[
name|i
index|]
operator|->
name|pe_context
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"hello %d: context of %d instead of %d"
argument_list|,
name|i
argument_list|,
name|pe
operator|->
name|pe_context
argument_list|,
name|udata
index|[
name|i
index|]
operator|->
name|pe_context
argument_list|)
expr_stmt|;
block|}
block|}
goto|goto
name|do_release
goto|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|DEBUG
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"responding PSAP address: %s"
argument_list|,
name|paddr2str
argument_list|(
operator|&
name|pc
operator|->
name|pc_responding
argument_list|,
name|NULLNA
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"greetings: %d elements"
argument_list|,
name|pc
operator|->
name|pc_ninfo
argument_list|)
expr_stmt|;
name|pl
operator|=
operator|&
name|pc
operator|->
name|pc_ctxlist
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pl
operator|->
name|pc_nctx
condition|;
name|i
operator|++
control|)
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"ctx %d: 0x%x 0x%x %d"
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_id
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_asn
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_atn
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_result
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"default %d"
argument_list|,
name|pc
operator|->
name|pc_defctxresult
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"p/s requirements 0x%x/0x%x"
argument_list|,
name|pc
operator|->
name|pc_prequirements
argument_list|,
name|pc
operator|->
name|pc_srequirements
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|mode
operator|==
name|echo
condition|)
block|{
if|if
condition|(
name|pc
operator|->
name|pc_ninfo
operator|!=
name|NPDATA
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"expecting %d hellos, got %d elements"
argument_list|,
name|NPDATA
argument_list|,
name|pc
operator|->
name|pc_ninfo
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPDATA
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|pe
operator|=
name|pc
operator|->
name|pc_info
index|[
name|i
index|]
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"hello %d: NULL"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|=
name|prim2num
argument_list|(
name|pe
argument_list|)
operator|)
operator|==
name|NOTOK
operator|&&
name|pe
operator|->
name|pe_errno
operator|!=
name|PE_ERR_NONE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"hello %d: %s"
argument_list|,
name|i
argument_list|,
name|pe_error
argument_list|(
name|pe
operator|->
name|pe_errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|!=
name|i
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"hello %d: value %d"
argument_list|,
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|pe
operator|->
name|pe_context
operator|!=
name|udata
index|[
name|i
index|]
operator|->
name|pe_context
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"hello %d: context of %d instead of %d"
argument_list|,
name|i
argument_list|,
name|pe
operator|->
name|pe_context
argument_list|,
name|udata
index|[
name|i
index|]
operator|->
name|pe_context
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|nctxs
operator|=
literal|0
expr_stmt|;
name|pl
operator|=
operator|&
name|pc
operator|->
name|pc_ctxlist
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pl
operator|->
name|pc_nctx
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_result
operator|==
name|PC_ACCEPT
condition|)
name|datactxs
index|[
name|nctxs
operator|++
index|]
operator|=
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_id
expr_stmt|;
name|srequirements
operator|=
name|pc
operator|->
name|pc_srequirements
expr_stmt|;
name|nmodes
operator|=
literal|0
expr_stmt|;
name|datamodes
index|[
name|nmodes
operator|++
index|]
operator|=
name|SX_NORMAL
expr_stmt|;
if|if
condition|(
name|srequirements
operator|&
name|SR_EXPEDITED
condition|)
name|datamodes
index|[
name|nmodes
operator|++
index|]
operator|=
name|SX_EXPEDITED
expr_stmt|;
if|if
condition|(
operator|(
name|srequirements
operator|&
name|SR_CAPABILITY
operator|)
operator|&&
operator|(
name|srequirements
operator|&
name|SR_ACTIVITY
operator|)
condition|)
name|datamodes
index|[
name|nmodes
operator|++
index|]
operator|=
name|SX_CAPDIND
expr_stmt|;
if|if
condition|(
name|srequirements
operator|&
name|SR_TYPEDATA
condition|)
name|datamodes
index|[
name|nmodes
operator|++
index|]
operator|=
name|SX_TYPED
expr_stmt|;
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \     if (srequirements& requires) \ 	switch (pc -> pc_settings& (ST_MASK<< shift)) { \ 	    case ST_CALL_VALUE: \ 		adios (NULLCP, "%s token: choice", type); \  \ 	    case ST_INIT_VALUE: \ 		owned |= bit, avail |= bit; \ 		break; \  \ 	    case ST_RESP_VALUE: \ 		avail |= bit; \ 		break; \  \ 	    default: \ 		adios (NULLCP, "%s token: reserved", type); \ 	} \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
if|if
condition|(
name|isacs
condition|)
name|ACCFREE
argument_list|(
argument|acc
argument_list|)
else|else
name|PCFREE
argument_list|(
name|pc
argument_list|)
expr_stmt|;
if|if
condition|(
name|srequirements
operator|&
name|SR_ACTIVITY
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|id
operator|->
name|sd_data
argument_list|,
name|mode
operator|==
name|echo
condition|?
literal|"echo"
else|:
literal|"sink"
argument_list|)
expr_stmt|;
name|id
operator|->
name|sd_len
operator|=
name|strlen
argument_list|(
name|id
operator|->
name|sd_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|PActStartRequest
argument_list|(
name|sd
argument_list|,
name|id
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-ACTIVITY-START.REQUEST"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|!=
name|NOTOK
operator|&&
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|==
name|S_IFREG
operator|&&
operator|(
name|cc
operator|=
name|st
operator|.
name|st_size
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|cc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|cp
operator|,
name|j
operator|=
name|cc
init|;
name|j
operator|>
literal|0
condition|;
name|dp
operator|+=
name|i
operator|,
name|j
operator|-=
name|i
control|)
switch|switch
condition|(
name|i
operator|=
name|read
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|dp
argument_list|,
name|j
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|adios
argument_list|(
literal|"on stdin"
argument_list|,
literal|"read failed"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"premature end-of-file"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
if|if
condition|(
operator|(
name|pe
operator|=
name|oct2prim
argument_list|(
name|cp
argument_list|,
name|cc
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate PSDU"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nctxs
condition|)
name|pe
operator|->
name|pe_context
operator|=
name|datactxs
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|10
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ps_datarequest
argument_list|(
name|sd
argument_list|,
name|pe
argument_list|,
name|SX_NORMAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
name|cc
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|j
operator|=
name|l
operator|=
name|m
operator|=
literal|0
init|;
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|stdin
argument_list|)
condition|;
control|)
block|{
name|k
operator|=
name|j
operator|>=
name|nmodes
condition|?
name|SX_EXPEDITED
else|:
name|datamodes
index|[
name|j
operator|++
operator|%
name|nmodes
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|cc
operator|=
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|+
literal|1
operator|)
operator|>
name|SX_EXSIZE
operator|-
literal|7
operator|&&
name|k
operator|==
name|SX_EXPEDITED
condition|)
block|{
if|if
condition|(
operator|(
name|k
operator|=
name|datamodes
index|[
name|j
operator|++
operator|%
name|nmodes
index|]
operator|)
operator|==
name|SX_EXPEDITED
condition|)
name|k
operator|=
name|datamodes
index|[
name|j
operator|++
operator|%
name|nmodes
index|]
expr_stmt|;
block|}
switch|switch
condition|(
name|k
condition|)
block|{
case|case
name|SX_CAPDIND
case|:
if|if
condition|(
operator|!
operator|(
name|requirements
operator|&
name|SR_RESYNC
operator|)
operator|||
name|l
operator|++
operator|&
literal|0x01
condition|)
block|{
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
name|ST_ACT_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|&
literal|0x03
condition|)
block|{
if|if
condition|(
name|PActIntrRequest
argument_list|(
name|sd
argument_list|,
name|SP_SEQUENCE
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-ACTIVITY-INTERRUPT.REQUEST"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|PActDiscRequest
argument_list|(
name|sd
argument_list|,
name|SP_SEQUENCE
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-ACTIVITY-DISCARD.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|push_data
goto|;
block|}
name|tokens
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \ 		    if (requirements& requires) \ 			tokens |= ST_CALL_VALUE<< shift; \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
if|if
condition|(
name|PReSyncRequest
argument_list|(
name|sd
argument_list|,
name|SYNC_SET
argument_list|,
name|ssn
operator|-
literal|1
argument_list|,
name|tokens
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-RESYNCHRONIZE.REQUEST"
argument_list|)
expr_stmt|;
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|SX_EXPEDITED
case|:
if|if
condition|(
name|j
operator|>=
name|nmodes
condition|)
name|j
operator|=
name|j
operator|%
name|nmodes
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|srequirements
operator|&
name|SR_EXPEDITED
operator|)
condition|)
name|k
operator|=
name|SX_NORMAL
expr_stmt|;
comment|/* fall... */
default|default:
name|push_data
label|:
empty_stmt|;
if|if
condition|(
operator|(
name|pe
operator|=
name|oct2prim
argument_list|(
name|buffer
argument_list|,
name|cc
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate PSDU"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nctxs
operator|&&
name|k
operator|!=
name|SX_EXPEDITED
condition|)
name|pe
operator|->
name|pe_context
operator|=
name|datactxs
index|[
name|m
operator|++
operator|%
name|nctxs
index|]
expr_stmt|;
name|ps_datarequest
argument_list|(
name|sd
argument_list|,
name|pe
argument_list|,
name|k
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|SX_CAPDIND
operator|&&
name|PActResumeRequest
argument_list|(
name|sd
argument_list|,
name|id
argument_list|,
name|id
argument_list|,
call|(
name|long
call|)
argument_list|(
name|getpid
argument_list|()
operator|%
operator|(
name|SERIAL_MAX
operator|-
name|SERIAL_MIN
operator|+
literal|1
operator|)
argument_list|)
operator|+
name|SERIAL_MIN
argument_list|,
name|sf
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-ACTIVITY-RESUME.REQUEST"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|requirements
operator|&
name|SR_EXCEPTIONS
condition|)
block|{
if|if
condition|(
name|owned
operator|&
name|ST_DAT_TOKEN
condition|)
if|if
condition|(
name|PGTokenRequest
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-TOKEN-GIVE.REQUEST"
argument_list|)
expr_stmt|;
else|else
name|owned
operator|&=
operator|~
name|ST_DAT_TOKEN
expr_stmt|;
if|if
condition|(
name|PUReportRequest
argument_list|(
name|sd
argument_list|,
name|SP_NOREASON
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-U-EXCEPTION-REPORT.REQUEST"
argument_list|)
expr_stmt|;
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|requirements
operator|&
name|SR_MAJORSYNC
operator|)
operator|&&
operator|!
operator|(
name|requirements
operator|&
name|SR_ACTIVITY
operator|)
condition|)
block|{
if|if
condition|(
name|PMajSyncRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|pa
operator|->
name|pa_reason
condition|)
block|{
case|case
name|PC_OPERATION
case|:
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
operator||
name|ST_MIN_TOKEN
operator||
name|ST_MAJ_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|PMajSyncRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|pi
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-MAJOR-SYNC.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|requirements
operator|&
name|SR_ACTIVITY
condition|)
block|{
if|if
condition|(
name|PActEndRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|pa
operator|->
name|pa_reason
condition|)
block|{
case|case
name|PC_OPERATION
case|:
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
name|avail
argument_list|)
expr_stmt|;
if|if
condition|(
name|PActEndRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|pi
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-ACTIVITY-END.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|PGControlRequest
argument_list|(
name|sd
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|pa
operator|->
name|pa_reason
condition|)
block|{
case|case
name|PC_OPERATION
case|:
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
name|avail
argument_list|)
expr_stmt|;
if|if
condition|(
name|PGControlRequest
argument_list|(
name|sd
argument_list|,
name|pi
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-CONTROL-GIVE.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|owned
operator|=
literal|0
expr_stmt|;
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|do_release
label|:
empty_stmt|;
if|if
condition|(
name|isacs
condition|)
block|{
if|if
condition|(
name|AcRelRequest
argument_list|(
name|sd
argument_list|,
name|ACF_NORMAL
argument_list|,
name|udata
argument_list|,
name|NACDATA
argument_list|,
name|NOTOK
argument_list|,
name|acr
argument_list|,
name|aci
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|aca
operator|->
name|aca_reason
condition|)
block|{
case|case
name|ACS_OPERATION
case|:
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
name|avail
argument_list|)
expr_stmt|;
if|if
condition|(
name|AcRelRequest
argument_list|(
name|sd
argument_list|,
name|ACF_NORMAL
argument_list|,
name|udata
argument_list|,
name|NACDATA
argument_list|,
name|NOTOK
argument_list|,
name|acr
argument_list|,
name|aci
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|acs_adios
argument_list|(
name|aca
argument_list|,
literal|"A-RELEASE.REQUEST"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|acr
operator|->
name|acr_affirmative
condition|)
block|{
operator|(
name|void
operator|)
name|AcUAbortRequest
argument_list|(
name|sd
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|aci
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"release rejected by peer: %d, %d elements"
argument_list|,
name|acr
operator|->
name|acr_reason
argument_list|,
name|acr
operator|->
name|acr_ninfo
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"A-RELEASE.CONFIRMATION: %d, %d elements"
argument_list|,
name|acr
operator|->
name|acr_reason
argument_list|,
name|acr
operator|->
name|acr_ninfo
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ACRFREE
argument_list|(
name|acr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|PRelRequest
argument_list|(
name|sd
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|NOTOK
argument_list|,
name|pr
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|pa
operator|->
name|pa_reason
condition|)
block|{
case|case
name|PC_OPERATION
case|:
case|case
name|PC_WAITING
case|:
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
name|avail
argument_list|)
expr_stmt|;
if|if
condition|(
name|PRelRequest
argument_list|(
name|sd
argument_list|,
name|udata
argument_list|,
name|NPDATA
argument_list|,
name|NOTOK
argument_list|,
name|pr
argument_list|,
name|pi
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-RELEASE.REQUEST"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pr
operator|->
name|pr_affirmative
condition|)
block|{
operator|(
name|void
operator|)
name|PUAbortRequest
argument_list|(
name|sd
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|pi
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"release rejected by peer: %d elements"
argument_list|,
name|pr
operator|->
name|pr_ninfo
argument_list|)
expr_stmt|;
block|}
name|PRFREE
argument_list|(
name|pr
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPDATA
condition|;
name|i
operator|++
control|)
name|pe_free
argument_list|(
name|udata
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|ps_datarequest
parameter_list|(
name|sd
parameter_list|,
name|pe
parameter_list|,
name|dm
parameter_list|,
name|sync
parameter_list|)
name|int
name|sd
decl_stmt|;
name|PE
name|pe
decl_stmt|;
name|int
name|dm
decl_stmt|,
name|sync
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|PSAPdata
name|pxs
decl_stmt|;
specifier|register
name|struct
name|PSAPdata
modifier|*
name|px
init|=
operator|&
name|pxs
decl_stmt|;
name|struct
name|PSAPindication
name|pis
decl_stmt|;
specifier|register
name|struct
name|PSAPindication
modifier|*
name|pi
init|=
operator|&
name|pis
decl_stmt|;
specifier|register
name|struct
name|PSAPabort
modifier|*
name|pa
init|=
operator|&
name|pi
operator|->
name|pi_abort
decl_stmt|;
switch|switch
condition|(
name|dm
condition|)
block|{
default|default:
if|if
condition|(
name|PDataRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|pa
operator|->
name|pa_reason
condition|)
block|{
case|case
name|PC_OPERATION
case|:
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|PDataRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|pi
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-DATA.REQUEST"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SX_EXPEDITED
case|:
if|if
condition|(
name|PExpdRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-EXPEDITED-DATA.REQUEST"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SX_CAPDIND
case|:
if|if
condition|(
name|PCapdRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|pa
operator|->
name|pa_reason
condition|)
block|{
case|case
name|PC_OPERATION
case|:
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
name|avail
operator|&
operator|~
name|ST_RLS_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|PCapdRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|pi
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-CAPABILITY-DATA.REQUEST"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SX_TYPED
case|:
if|if
condition|(
name|PTypedRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-TYPED-DATA.REQUEST"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|mode
operator|==
name|echo
operator|||
name|dm
operator|==
name|SX_CAPDIND
condition|)
for|for
control|(
init|;
condition|;
control|)
block|{
switch|switch
condition|(
name|result
operator|=
name|PReadRequest
argument_list|(
name|sd
argument_list|,
name|px
argument_list|,
name|NOTOK
argument_list|,
name|pi
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-READ.REQUEST"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
if|if
condition|(
operator|(
name|dm
operator|!=
name|SX_CAPDIND
condition|?
name|dm
else|:
name|SX_CAPDCNF
operator|)
operator|!=
name|px
operator|->
name|px_type
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"data indication type mismatch, orig=%d echo=%d"
argument_list|,
name|dm
argument_list|,
name|px
operator|->
name|px_type
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|px
operator|->
name|px_ninfo
operator|!=
literal|1
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"length mismatch, orig=%d echo=%d"
argument_list|,
literal|1
argument_list|,
name|px
operator|->
name|px_ninfo
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pe
operator|->
name|pe_context
operator|!=
operator|(
operator|*
name|px
operator|->
name|px_info
operator|)
operator|->
name|pe_context
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"context mismatch, orig=%d echo=%d"
argument_list|,
name|pe
operator|->
name|pe_context
argument_list|,
operator|(
operator|*
name|px
operator|->
name|px_info
operator|)
operator|->
name|pe_context
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pe_cmp
argument_list|(
name|pe
argument_list|,
operator|*
name|px
operator|->
name|px_info
argument_list|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"data mismatch (1)"
argument_list|)
expr_stmt|;
name|vunknown
argument_list|(
name|pe
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"---------"
argument_list|)
expr_stmt|;
name|vunknown
argument_list|(
operator|*
name|px
operator|->
name|px_info
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"---------"
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
name|PXFREE
argument_list|(
argument|px
argument_list|)
break|break;
case|case
name|DONE
case|:
name|ps_event
argument_list|(
name|sd
argument_list|,
name|pi
argument_list|)
expr_stmt|;
continue|continue;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown return from PReadRequest=%d"
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|sync
operator|&&
operator|(
name|srequirements
operator|&
name|SR_MINORSYNC
operator|)
operator|&&
operator|!
operator|(
name|srequirements
operator|&
name|SR_ACTIVITY
operator|)
condition|)
block|{
if|if
condition|(
name|PMinSyncRequest
argument_list|(
name|sd
argument_list|,
name|SYNC_CONFIRM
argument_list|,
operator|&
name|ssn
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|pa
operator|->
name|pa_reason
condition|)
block|{
case|case
name|PC_OPERATION
case|:
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
operator||
name|ST_MIN_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|PMinSyncRequest
argument_list|(
name|sd
argument_list|,
name|SYNC_CONFIRM
argument_list|,
operator|&
name|ssn
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|pi
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-MINOR-SYNC.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sync
operator|&&
operator|(
name|srequirements
operator|&
name|SR_ACTIVITY
operator|)
operator|&&
operator|(
name|srequirements
operator|&
name|SR_MAJORSYNC
operator|)
operator|&&
name|dm
operator|==
name|SX_NORMAL
condition|)
block|{
if|if
condition|(
name|PMajSyncRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|pa
operator|->
name|pa_reason
condition|)
block|{
case|case
name|PC_OPERATION
case|:
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
operator||
name|ST_MIN_TOKEN
operator||
name|ST_MAJ_TOKEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|PMajSyncRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ssn
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|pi
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-MAJOR-SYNC.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|ps_waitfor
argument_list|(
name|sd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|ps_waitfor
parameter_list|(
name|sd
parameter_list|,
name|want
parameter_list|)
name|int
name|sd
decl_stmt|,
name|want
decl_stmt|;
block|{
name|int
name|result
decl_stmt|,
name|tokens
decl_stmt|;
name|struct
name|PSAPdata
name|pxs
decl_stmt|;
specifier|register
name|struct
name|PSAPdata
modifier|*
name|px
init|=
operator|&
name|pxs
decl_stmt|;
name|struct
name|PSAPindication
name|pis
decl_stmt|;
specifier|register
name|struct
name|PSAPindication
modifier|*
name|pi
init|=
operator|&
name|pis
decl_stmt|;
specifier|register
name|struct
name|PSAPabort
modifier|*
name|pa
init|=
operator|&
name|pi
operator|->
name|pi_abort
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|want
operator|==
operator|-
literal|1
condition|)
block|{
name|want
operator|=
name|avail
expr_stmt|;
goto|goto
name|read_it
goto|;
block|}
name|tokens
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \ 	if ((want& bit)&& !(owned& bit)) \ 	    tokens |= bit; \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
if|if
condition|(
name|tokens
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|PPTokenRequest
argument_list|(
name|sd
argument_list|,
name|tokens
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-TOKEN-PLEASE.REQUEST"
argument_list|)
expr_stmt|;
name|read_it
label|:
empty_stmt|;
switch|switch
condition|(
name|result
operator|=
name|PReadRequest
argument_list|(
name|sd
argument_list|,
name|px
argument_list|,
name|NOTOK
argument_list|,
name|pi
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-READ.REQUEST"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
name|ps_abort
argument_list|(
name|sd
argument_list|,
literal|"protocol screw-up"
argument_list|)
expr_stmt|;
case|case
name|DONE
case|:
name|ps_event
argument_list|(
name|sd
argument_list|,
name|pi
argument_list|)
expr_stmt|;
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown return from PReadRequest=%d"
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|ps_event
argument_list|(
argument|sd
argument_list|,
argument|pi
argument_list|)
name|int
name|sd
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|PSAPindication
modifier|*
name|pi
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|PSAPabort
modifier|*
name|pa
init|=
operator|&
name|pi
operator|->
name|pi_abort
decl_stmt|;
specifier|register
name|struct
name|PSAPactivity
modifier|*
name|pv
init|=
operator|&
name|pi
operator|->
name|pi_activity
decl_stmt|;
specifier|register
name|struct
name|PSAPfinish
modifier|*
name|pf
init|=
operator|&
name|pi
operator|->
name|pi_finish
decl_stmt|;
specifier|register
name|struct
name|PSAPreport
modifier|*
name|pp
init|=
operator|&
name|pi
operator|->
name|pi_report
decl_stmt|;
specifier|register
name|struct
name|PSAPsync
modifier|*
name|pn
init|=
operator|&
name|pi
operator|->
name|pi_sync
decl_stmt|;
specifier|register
name|struct
name|PSAPtoken
modifier|*
name|pt
init|=
operator|&
name|pi
operator|->
name|pi_token
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
specifier|register
name|struct
name|AcSAPfinish
modifier|*
name|acf
init|=
operator|&
name|aci
operator|->
name|aci_finish
decl_stmt|;
switch|switch
condition|(
name|pi
operator|->
name|pi_type
condition|)
block|{
case|case
name|PI_TOKEN
case|:
switch|switch
condition|(
name|pt
operator|->
name|pt_type
condition|)
block|{
case|case
name|ST_GIVE
case|:
case|case
name|ST_CONTROL
case|:
name|owned
operator|=
name|pt
operator|->
name|pt_owned
expr_stmt|;
break|break;
case|case
name|ST_PLEASE
case|:
if|if
condition|(
name|PGTokenRequest
argument_list|(
name|sd
argument_list|,
operator|(
name|int
operator|)
name|pt
operator|->
name|pt_tokens
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-TOKEN-GIVE.REQUEST"
argument_list|)
expr_stmt|;
else|else
name|owned
operator|&=
operator|~
name|pt
operator|->
name|pt_tokens
expr_stmt|;
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown token indication type=0x%x"
argument_list|,
name|pt
operator|->
name|pt_type
argument_list|)
expr_stmt|;
block|}
name|PTFREE
argument_list|(
name|pt
argument_list|)
expr_stmt|;
break|break;
case|case
name|PI_SYNC
case|:
switch|switch
condition|(
name|pn
operator|->
name|pn_type
condition|)
block|{
case|case
name|SN_MAJORIND
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"majorsync indication %d"
argument_list|,
name|pn
operator|->
name|pn_ssn
argument_list|)
expr_stmt|;
break|break;
case|case
name|SN_MAJORCNF
case|:
break|break;
case|case
name|SN_MINORIND
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"minorsync indication %d%s"
argument_list|,
name|pn
operator|->
name|pn_ssn
argument_list|,
name|pn
operator|->
name|pn_options
operator|==
name|SYNC_CONFIRM
condition|?
literal|" (wants confirmation)"
else|:
name|NULLCP
argument_list|)
expr_stmt|;
break|break;
case|case
name|SN_MINORCNF
case|:
break|break;
case|case
name|SN_RESETIND
case|:
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \ 		    if (srequirements& requires) \ 			switch (pn -> pn_settings& (ST_MASK<< shift)) { \ 			    case ST_CALL_VALUE<< shift: \ 				pn -> pn_settings&= ~(ST_MASK<< shift); \ 				pn -> pn_settings |= ST_RESP_VALUE<< shift; \ 			    case ST_RESP_VALUE<< shift: \ 				owned&= ~bit; \ 				break; \  \ 			    case ST_INIT_VALUE<< shift: \ 				owned |= bit; \ 				break; \  \ 			    default: \ 				adios (NULLCP, "%s token: reserved", type); \ 				break; \ 			} \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
if|if
condition|(
name|PReSyncResponse
argument_list|(
name|sd
argument_list|,
name|pn
operator|->
name|pn_ssn
argument_list|,
name|pn
operator|->
name|pn_settings
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-RESYNCHRONIZE.RESPONSE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SN_RESETCNF
case|:
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown sync indication=0x%x, ssn=%d"
argument_list|,
name|pn
operator|->
name|pn_type
argument_list|,
name|pn
operator|->
name|pn_ssn
argument_list|)
expr_stmt|;
block|}
name|PNFREE
argument_list|(
name|pn
argument_list|)
expr_stmt|;
break|break;
case|case
name|PI_ACTIVITY
case|:
switch|switch
condition|(
name|pv
operator|->
name|pv_type
condition|)
block|{
case|case
name|SV_START
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"activity start indication: %*.*s"
argument_list|,
name|pv
operator|->
name|pv_id
operator|.
name|sd_len
argument_list|,
name|pv
operator|->
name|pv_id
operator|.
name|sd_len
argument_list|,
name|pv
operator|->
name|pv_id
operator|.
name|sd_data
argument_list|)
expr_stmt|;
case|case
name|SV_RESUME
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"activity resume indication: id=%*.*s oid=%*.*s connect=%s ssn=%d"
argument_list|,
name|pv
operator|->
name|pv_id
operator|.
name|sd_len
argument_list|,
name|pv
operator|->
name|pv_id
operator|.
name|sd_len
argument_list|,
name|pv
operator|->
name|pv_id
operator|.
name|sd_data
argument_list|,
name|pv
operator|->
name|pv_oid
operator|.
name|sd_len
argument_list|,
name|pv
operator|->
name|pv_oid
operator|.
name|sd_len
argument_list|,
name|pv
operator|->
name|pv_oid
operator|.
name|sd_data
argument_list|,
name|sprintref
argument_list|(
operator|&
name|pv
operator|->
name|pv_connect
argument_list|)
argument_list|,
name|pv
operator|->
name|pv_ssn
argument_list|)
expr_stmt|;
case|case
name|SV_INTRIND
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"activity interrupt indication %d"
argument_list|,
name|pv
operator|->
name|pv_reason
argument_list|)
expr_stmt|;
case|case
name|SV_INTRCNF
case|:
break|break;
case|case
name|SV_DISCIND
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"activity discard indication %d"
argument_list|,
name|pv
operator|->
name|pv_reason
argument_list|)
expr_stmt|;
case|case
name|SV_DISCCNF
case|:
break|break;
case|case
name|SV_ENDIND
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"activity end indication %d"
argument_list|,
name|pv
operator|->
name|pv_ssn
argument_list|)
expr_stmt|;
case|case
name|SV_ENDCNF
case|:
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown activity indication=0x%x"
argument_list|,
name|pv
operator|->
name|pv_type
argument_list|)
expr_stmt|;
block|}
name|PVFREE
argument_list|(
name|pv
argument_list|)
expr_stmt|;
break|break;
case|case
name|PI_REPORT
case|:
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s report %d"
argument_list|,
name|pp
operator|->
name|pp_peer
condition|?
literal|"user"
else|:
literal|"provider"
argument_list|,
name|pp
operator|->
name|pp_reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|srequirements
operator|&
name|SR_DAT_EXISTS
condition|)
block|{
if|if
condition|(
name|PGTokenRequest
argument_list|(
name|sd
argument_list|,
name|ST_DAT_TOKEN
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-TOKEN-GIVE.REQUEST (to clear exception)"
argument_list|)
expr_stmt|;
else|else
name|owned
operator|&=
operator|~
name|ST_DAT_TOKEN
expr_stmt|;
block|}
else|else
name|ps_abort
argument_list|(
name|sd
argument_list|,
literal|"aborted"
argument_list|)
expr_stmt|;
name|PPFREE
argument_list|(
name|pp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PI_FINISH
case|:
if|if
condition|(
name|isacs
condition|)
block|{
if|if
condition|(
name|AcFINISHser
argument_list|(
name|sd
argument_list|,
name|pf
argument_list|,
name|aci
argument_list|)
operator|==
name|NOTOK
condition|)
name|acs_adios
argument_list|(
name|aca
argument_list|,
literal|"AcFINISHser"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"A-RELEASE.INDICATION %d, %d elements"
argument_list|,
name|acf
operator|->
name|acf_reason
argument_list|,
name|acf
operator|->
name|acf_ninfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|AcRelResponse
argument_list|(
name|sd
argument_list|,
name|ACS_USER_NOREASON
argument_list|,
name|ACR_NOTFINISHED
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|aci
argument_list|)
operator|==
name|NOTOK
condition|)
name|acs_adios
argument_list|(
name|aca
argument_list|,
literal|"A-RELEASE.RESPONSE"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ACFFREE
argument_list|(
name|acf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|PRelResponse
argument_list|(
name|sd
argument_list|,
name|PC_REJECTED
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-RELEASE.RESPONSE"
argument_list|)
expr_stmt|;
name|PFFREE
argument_list|(
name|pf
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown indication type=0x%x"
argument_list|,
name|pi
operator|->
name|pi_type
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|ps_abort
argument_list|(
argument|sd
argument_list|,
argument|reason
argument_list|)
name|int
name|sd
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|reason
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|PSAPindication
name|pis
decl_stmt|;
specifier|register
name|struct
name|PSAPindication
modifier|*
name|pi
init|=
operator|&
name|pis
decl_stmt|;
specifier|register
name|struct
name|PSAPabort
modifier|*
name|pa
init|=
operator|&
name|pi
operator|->
name|pi_abort
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
if|if
condition|(
name|isacs
condition|)
block|{
if|if
condition|(
name|AcUAbortRequest
argument_list|(
name|sd
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|aci
argument_list|)
operator|==
name|NOTOK
condition|)
name|acs_adios
argument_list|(
name|aca
argument_list|,
literal|"A-U-ABORT.REQUEST"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|PUAbortRequest
argument_list|(
name|sd
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|pi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ps_adios
argument_list|(
name|pa
argument_list|,
literal|"P-U-ABORT.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|void
name|ps_adios
parameter_list|(
name|pa
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|PSAPabort
modifier|*
name|pa
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|ps_advise
argument_list|(
name|pa
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ps_advise
parameter_list|(
name|pa
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|PSAPabort
modifier|*
name|pa
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|pa
operator|->
name|pa_cc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s] %*.*s"
argument_list|,
name|PErrString
argument_list|(
name|pa
operator|->
name|pa_reason
argument_list|)
argument_list|,
name|pa
operator|->
name|pa_cc
argument_list|,
name|pa
operator|->
name|pa_cc
argument_list|,
name|pa
operator|->
name|pa_data
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s]"
argument_list|,
name|PErrString
argument_list|(
name|pa
operator|->
name|pa_reason
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: %s%s"
argument_list|,
name|event
argument_list|,
name|buffer
argument_list|,
name|pa
operator|->
name|pa_peer
condition|?
literal|" (peer initiated)"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|AcSAP */
end_comment

begin_function
specifier|static
name|void
name|acs_adios
parameter_list|(
name|aca
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|acs_advise
argument_list|(
name|aca
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acs_advise
parameter_list|(
name|aca
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|aca
operator|->
name|aca_cc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s] %*.*s"
argument_list|,
name|AcErrString
argument_list|(
name|aca
operator|->
name|aca_reason
argument_list|)
argument_list|,
name|aca
operator|->
name|aca_cc
argument_list|,
name|aca
operator|->
name|aca_cc
argument_list|,
name|aca
operator|->
name|aca_data
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s]"
argument_list|,
name|AcErrString
argument_list|(
name|aca
operator|->
name|aca_reason
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: %s (source %d)"
argument_list|,
name|event
argument_list|,
name|buffer
argument_list|,
name|aca
operator|->
name|aca_source
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|RtSAP */
end_comment

begin_decl_stmt
specifier|static
name|int
name|turn
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|rts_main
parameter_list|(
name|is
parameter_list|,
name|addr
parameter_list|)
name|struct
name|isoservent
modifier|*
name|is
decl_stmt|;
name|char
modifier|*
name|addr
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|,
name|cc
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|ros
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|struct
name|PSAPaddr
modifier|*
name|pa
decl_stmt|;
name|struct
name|PSAPctxlist
name|pls
decl_stmt|;
specifier|register
name|struct
name|PSAPctxlist
modifier|*
name|pl
init|=
operator|&
name|pls
decl_stmt|;
name|struct
name|AcSAPrelease
name|acrs
decl_stmt|;
specifier|register
name|struct
name|AcSAPrelease
modifier|*
name|acr
init|=
operator|&
name|acrs
decl_stmt|;
name|struct
name|RtSAPaddr
name|rtzs
decl_stmt|;
specifier|register
name|struct
name|RtSAPaddr
modifier|*
name|rtz
init|=
operator|&
name|rtzs
decl_stmt|;
name|struct
name|RtSAPconnect
name|rtcs
decl_stmt|;
specifier|register
name|struct
name|RtSAPconnect
modifier|*
name|rtc
init|=
operator|&
name|rtcs
decl_stmt|;
name|struct
name|RtSAPindication
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPindication
modifier|*
name|rti
init|=
operator|&
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rta
init|=
operator|&
name|rti
operator|->
name|rti_abort
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
name|rtc
operator|->
name|rtc_connect
decl_stmt|;
name|struct
name|PSAPconnect
modifier|*
name|pc
init|=
operator|&
name|acc
operator|->
name|acc_connect
decl_stmt|;
endif|#
directive|endif
specifier|register
name|PE
name|pe
decl_stmt|;
name|AEI
name|aei
decl_stmt|;
name|OID
name|oid
decl_stmt|,
name|ode
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
operator|(
name|pe
operator|=
name|int2prim
argument_list|(
name|i
operator|=
name|getpid
argument_list|()
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate hello"
argument_list|)
expr_stmt|;
name|turn
operator|=
name|mode
operator|==
name|sink
expr_stmt|;
if|if
condition|(
name|isacs
condition|)
block|{
if|if
condition|(
name|ros
operator|=
name|strncmp
argument_list|(
name|isacs
argument_list|,
literal|"isode/ros_"
argument_list|,
name|strlen
argument_list|(
literal|"isode/ros_"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|mode
operator|=
name|strcmp
argument_list|(
name|isacs
argument_list|,
literal|"isode/ros_sink"
argument_list|)
condition|?
name|echo
else|:
name|sink
expr_stmt|;
else|else
name|mode
operator|=
name|strcmp
argument_list|(
name|isacs
argument_list|,
literal|"isode/rtse sink"
argument_list|)
condition|?
name|echo
else|:
name|sink
expr_stmt|;
name|turn
operator|=
name|mode
operator|==
name|sink
expr_stmt|;
if|if
condition|(
operator|(
name|aei
operator|=
name|str2aei
argument_list|(
name|addr
argument_list|,
name|isacs
argument_list|)
operator|)
operator|==
name|NULLAEI
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s-%s: unknown application-entity"
argument_list|,
name|addr
argument_list|,
name|isacs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pa
operator|=
name|aei2addr
argument_list|(
name|aei
argument_list|)
operator|)
operator|==
name|NULLPA
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"address translation failed"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|mode
operator|==
name|echo
condition|?
literal|"isode echo pci"
else|:
literal|"isode sink pci"
expr_stmt|;
if|if
condition|(
operator|(
name|ode
operator|=
name|ode2oid
argument_list|(
name|cp
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: unknown object descriptor"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|ode
operator|=
name|oid_cpy
argument_list|(
name|ode
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
operator|(
name|pl
operator|->
name|pc_nctx
operator|=
name|NPCTX
operator|-
literal|2
operator|)
operator|-
literal|1
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
block|{
name|pl
operator|->
name|pc_ctx
index|[
name|j
index|]
operator|.
name|pc_id
operator|=
name|j
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|oid
operator|=
name|ode2oid
argument_list|(
literal|"iso asn.1 abstract syntax"
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"iso asn.1 abstract syntax: unknown"
argument_list|)
expr_stmt|;
name|pl
operator|->
name|pc_ctx
index|[
name|j
index|]
operator|.
name|pc_asn
operator|=
name|oid_cpy
argument_list|(
name|oid
argument_list|)
expr_stmt|;
name|pl
operator|->
name|pc_ctx
index|[
name|j
index|]
operator|.
name|pc_atn
operator|=
name|NULLOID
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s... "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtOpenRequest
argument_list|(
name|RTS_TWA
argument_list|,
name|turn
condition|?
name|RTS_INITIATOR
else|:
name|RTS_RESPONDER
argument_list|,
name|ode
argument_list|,
name|NULLAEI
argument_list|,
name|aei
argument_list|,
name|NULLPA
argument_list|,
name|pa
argument_list|,
name|pl
argument_list|,
name|ode
argument_list|,
name|pe
argument_list|,
name|NULLQOS
argument_list|,
name|rtc
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-OPEN.REQUEST"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
specifier|register
name|struct
name|SSAPaddr
modifier|*
name|sa
decl_stmt|;
if|if
condition|(
name|ros
operator|=
name|strncmp
argument_list|(
name|is
operator|->
name|is_entity
argument_list|,
literal|"ros_"
argument_list|,
name|strlen
argument_list|(
literal|"ros_"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|strcmp
argument_list|(
name|is
operator|->
name|is_entity
argument_list|,
literal|"ros_sink"
argument_list|)
condition|?
name|echo
else|:
name|sink
expr_stmt|;
name|turn
operator|=
name|mode
operator|==
name|sink
expr_stmt|;
block|}
name|rtz
operator|->
name|rta_port
operator|=
name|is
operator|->
name|is_port
expr_stmt|;
comment|/* yikes! */
if|if
condition|(
operator|(
name|is
operator|=
name|getisoserventbyname
argument_list|(
literal|"rts"
argument_list|,
literal|"ssap"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ssap/rts: unknown entity"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sa
operator|=
name|is2saddr
argument_list|(
name|addr
argument_list|,
name|NULLCP
argument_list|,
name|is
argument_list|)
operator|)
operator|==
name|NULLSA
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"address translation failed"
argument_list|)
expr_stmt|;
name|rtz
operator|->
name|rta_addr
operator|=
operator|*
name|sa
expr_stmt|;
comment|/* struct copy */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s... "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtBeginRequest
argument_list|(
name|rtz
argument_list|,
name|RTS_TWA
argument_list|,
name|turn
condition|?
name|RTS_INITIATOR
else|:
name|RTS_RESPONDER
argument_list|,
name|pe
argument_list|,
name|rtc
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-BEGIN.REQUEST"
argument_list|)
expr_stmt|;
block|}
block|}
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtc
operator|->
name|rtc_result
operator|!=
name|RTS_ACCEPT
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"association rejected: [%s]"
argument_list|,
name|RtErrString
argument_list|(
name|rtc
operator|->
name|rtc_result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connected\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"sent greetings of %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sd
operator|=
name|rtc
operator|->
name|rtc_sd
expr_stmt|;
if|if
condition|(
name|rtc
operator|->
name|rtc_data
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|=
name|prim2num
argument_list|(
name|rtc
operator|->
name|rtc_data
argument_list|)
operator|)
operator|==
name|NOTOK
operator|&&
name|rtc
operator|->
name|rtc_data
operator|->
name|pe_errno
operator|!=
name|PE_ERR_NONE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"error decoding hello: %s (%d)"
argument_list|,
name|pe_error
argument_list|(
name|rtc
operator|->
name|rtc_data
operator|->
name|pe_errno
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"received greetings of %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|isacs
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"context: %s"
argument_list|,
name|oid2ode
argument_list|(
name|acc
operator|->
name|acc_context
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"responding AE title: %s, responding PSAP address: %s"
argument_list|,
name|sprintaei
argument_list|(
operator|&
name|acc
operator|->
name|acc_respondtitle
argument_list|)
argument_list|,
name|paddr2str
argument_list|(
operator|&
name|pc
operator|->
name|pc_responding
argument_list|,
name|NULLNA
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"greetings: %d elements"
argument_list|,
name|acc
operator|->
name|acc_ninfo
argument_list|)
expr_stmt|;
name|pl
operator|=
operator|&
name|pc
operator|->
name|pc_ctxlist
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pl
operator|->
name|pc_nctx
condition|;
name|i
operator|++
control|)
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"ctx %d: 0x%x 0x%x %d"
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_id
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_asn
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_atn
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_result
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"default %d"
argument_list|,
name|pc
operator|->
name|pc_defctxresult
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"p/s requirements 0x%x/0x%x"
argument_list|,
name|pc
operator|->
name|pc_prequirements
argument_list|,
name|pc
operator|->
name|pc_srequirements
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|RTCFREE
argument_list|(
name|rtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ros
condition|)
block|{
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
name|rois
operator|.
name|roi_preject
decl_stmt|;
if|if
condition|(
name|RoSetService
argument_list|(
name|sd
argument_list|,
name|RoRtService
argument_list|,
operator|&
name|rois
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
name|rop
argument_list|,
literal|"set RO/PT fails"
argument_list|)
expr_stmt|;
name|do_ros
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|!=
name|NOTOK
operator|&&
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|==
name|S_IFREG
operator|&&
operator|(
name|cc
operator|=
name|st
operator|.
name|st_size
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|cc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|cp
operator|,
name|j
operator|=
name|cc
init|;
name|j
operator|>
literal|0
condition|;
name|dp
operator|+=
name|i
operator|,
name|j
operator|-=
name|i
control|)
switch|switch
condition|(
name|i
operator|=
name|read
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|dp
argument_list|,
name|j
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|adios
argument_list|(
literal|"on stdin"
argument_list|,
literal|"read failed"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"premature end-of-file"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
if|if
condition|(
operator|(
name|pe
operator|=
name|oct2prim
argument_list|(
name|cp
argument_list|,
name|cc
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate APDU"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|10
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|rts_transferequest
argument_list|(
name|sd
argument_list|,
name|pe
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
name|cc
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
block|}
else|else
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|stdin
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|pe
operator|=
name|oct2prim
argument_list|(
name|buffer
argument_list|,
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate APDU"
argument_list|)
expr_stmt|;
name|rts_transferequest
argument_list|(
name|sd
argument_list|,
name|pe
argument_list|)
expr_stmt|;
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isacs
condition|)
block|{
if|if
condition|(
operator|(
name|pe
operator|=
name|int2prim
argument_list|(
name|i
operator|=
name|getpid
argument_list|()
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate hello"
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtCloseRequest
argument_list|(
name|sd
argument_list|,
name|ACF_NORMAL
argument_list|,
name|pe
argument_list|,
name|acr
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|rta
operator|->
name|rta_reason
condition|)
block|{
case|case
name|RTS_OPERATION
case|:
case|case
name|RTS_WAITING
case|:
name|rts_waitfor
argument_list|(
name|sd
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtCloseRequest
argument_list|(
name|sd
argument_list|,
name|ACF_NORMAL
argument_list|,
name|pe
argument_list|,
name|acr
argument_list|,
name|rti
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-CLOSE.REQUEST"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|acr
operator|->
name|acr_affirmative
condition|)
block|{
operator|(
name|void
operator|)
name|RtUAbortRequest
argument_list|(
name|sd
argument_list|,
name|NULLPE
argument_list|,
name|rti
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"release rejected by peer: %d, %d elements"
argument_list|,
name|acr
operator|->
name|acr_reason
argument_list|,
name|acr
operator|->
name|acr_ninfo
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mode
operator|==
name|echo
condition|)
block|{
if|if
condition|(
name|acr
operator|->
name|acr_ninfo
operator|!=
literal|1
condition|)
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"got %d elements returned on close"
argument_list|,
name|acr
operator|->
name|acr_ninfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|pe_cmp
argument_list|(
name|pe
argument_list|,
name|acr
operator|->
name|acr_info
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"data mismatch (2)"
argument_list|)
expr_stmt|;
name|vunknown
argument_list|(
name|pe
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"---------"
argument_list|)
expr_stmt|;
name|vunknown
argument_list|(
name|acr
operator|->
name|acr_info
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"---------"
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
block|}
name|ACRFREE
argument_list|(
name|acr
argument_list|)
expr_stmt|;
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|RtEndRequest
argument_list|(
name|sd
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|rta
operator|->
name|rta_reason
condition|)
block|{
case|case
name|RTS_OPERATION
case|:
case|case
name|RTS_WAITING
case|:
name|rts_waitfor
argument_list|(
name|sd
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtEndRequest
argument_list|(
name|sd
argument_list|,
name|rti
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-END.REQUEST"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|rts_transferequest
parameter_list|(
name|sd
parameter_list|,
name|pe
parameter_list|)
name|int
name|sd
decl_stmt|;
specifier|register
name|PE
name|pe
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|RtSAPindication
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPindication
modifier|*
name|rti
init|=
operator|&
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rta
init|=
operator|&
name|rti
operator|->
name|rti_abort
decl_stmt|;
specifier|register
name|struct
name|RtSAPtransfer
modifier|*
name|rtt
init|=
operator|&
name|rti
operator|->
name|rti_transfer
decl_stmt|;
if|if
condition|(
name|RtTransferRequest
argument_list|(
name|sd
argument_list|,
name|pe
argument_list|,
name|NOTOK
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|rta
operator|->
name|rta_reason
condition|)
block|{
case|case
name|RTS_OPERATION
case|:
name|rts_waitfor
argument_list|(
name|sd
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtTransferRequest
argument_list|(
name|sd
argument_list|,
name|pe
argument_list|,
name|NOTOK
argument_list|,
name|rti
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
if|if
condition|(
name|RTS_FATAL
argument_list|(
name|rta
operator|->
name|rta_reason
argument_list|)
condition|)
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-TRANSFER.REQUEST"
argument_list|)
expr_stmt|;
name|rts_advise
argument_list|(
name|rta
argument_list|,
literal|"RT-TRANSFER.REQUEST"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mode
operator|==
name|echo
condition|)
for|for
control|(
init|;
condition|;
control|)
switch|switch
condition|(
name|result
operator|=
name|RtWaitRequest
argument_list|(
name|sd
argument_list|,
name|NOTOK
argument_list|,
name|rti
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-WAIT.REQUEST"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
if|if
condition|(
name|pe_cmp
argument_list|(
name|pe
argument_list|,
name|rtt
operator|->
name|rtt_data
argument_list|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"data mismatch (3)"
argument_list|)
expr_stmt|;
name|vunknown
argument_list|(
name|pe
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"---------"
argument_list|)
expr_stmt|;
name|vunknown
argument_list|(
name|rtt
operator|->
name|rtt_data
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"---------"
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
name|RTTFREE
argument_list|(
name|rtt
argument_list|)
expr_stmt|;
return|return;
case|case
name|DONE
case|:
name|rts_event
argument_list|(
name|sd
argument_list|,
name|rti
argument_list|)
expr_stmt|;
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown return from RtWaitRequest=%d"
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|rts_waitfor
parameter_list|(
name|sd
parameter_list|)
name|int
name|sd
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|RtSAPindication
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPindication
modifier|*
name|rti
init|=
operator|&
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rta
init|=
operator|&
name|rti
operator|->
name|rti_abort
decl_stmt|;
specifier|static
name|int
name|priority
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|turn
condition|)
return|return;
if|if
condition|(
name|RtPTurnRequest
argument_list|(
name|sd
argument_list|,
name|priority
operator|++
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-TURN-PLEASE.REQUEST"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|turn
condition|)
switch|switch
condition|(
name|result
operator|=
name|RtWaitRequest
argument_list|(
name|sd
argument_list|,
name|NOTOK
argument_list|,
name|rti
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-WAIT.REQUEST"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"protocol screw-up"
argument_list|)
expr_stmt|;
case|case
name|DONE
case|:
name|rts_event
argument_list|(
name|sd
argument_list|,
name|rti
argument_list|)
expr_stmt|;
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown return from RtWaitRequest=%d"
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|rts_event
parameter_list|(
name|sd
parameter_list|,
name|rti
parameter_list|)
name|int
name|sd
decl_stmt|;
specifier|register
name|struct
name|RtSAPindication
modifier|*
name|rti
decl_stmt|;
block|{
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rta
init|=
operator|&
name|rti
operator|->
name|rti_abort
decl_stmt|;
specifier|register
name|struct
name|RtSAPturn
modifier|*
name|rtu
init|=
operator|&
name|rti
operator|->
name|rti_turn
decl_stmt|;
switch|switch
condition|(
name|rti
operator|->
name|rti_type
condition|)
block|{
case|case
name|RTI_TURN
case|:
if|if
condition|(
name|rtu
operator|->
name|rtu_please
condition|)
block|{
if|if
condition|(
name|RtGTurnRequest
argument_list|(
name|sd
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-TURN-GIVE.REQUEST"
argument_list|)
expr_stmt|;
name|turn
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|turn
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|RTI_CLOSE
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"got RT-END.INDICATION"
argument_list|)
expr_stmt|;
case|case
name|RTI_FINISH
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"got RT-CLOSE.INDICATION"
argument_list|)
expr_stmt|;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown indication type=0x%x"
argument_list|,
name|rti
operator|->
name|rti_type
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|void
name|rts_adios
parameter_list|(
name|rta
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rta
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|rts_advise
argument_list|(
name|rta
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rts_advise
parameter_list|(
name|rta
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rta
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|rta
operator|->
name|rta_cc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s] %*.*s"
argument_list|,
name|RtErrString
argument_list|(
name|rta
operator|->
name|rta_reason
argument_list|)
argument_list|,
name|rta
operator|->
name|rta_cc
argument_list|,
name|rta
operator|->
name|rta_cc
argument_list|,
name|rta
operator|->
name|rta_data
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s]"
argument_list|,
name|RtErrString
argument_list|(
name|rta
operator|->
name|rta_reason
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: %s"
argument_list|,
name|event
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|RoSAP */
end_comment

begin_function
specifier|static
name|int
name|ros_main
parameter_list|(
name|is
parameter_list|,
name|addr
parameter_list|)
name|struct
name|isoservent
modifier|*
name|is
decl_stmt|;
name|char
modifier|*
name|addr
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|struct
name|SSAPref
name|sfs
decl_stmt|;
specifier|register
name|struct
name|SSAPref
modifier|*
name|sf
decl_stmt|;
specifier|register
name|struct
name|PSAPaddr
modifier|*
name|pa
decl_stmt|;
name|struct
name|AcSAPconnect
name|accs
decl_stmt|;
specifier|register
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
name|accs
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
name|struct
name|RoSAPaddr
name|roas
decl_stmt|;
specifier|register
name|struct
name|RoSAPaddr
modifier|*
name|roa
init|=
operator|&
name|roas
decl_stmt|;
name|struct
name|RoSAPconnect
name|rocs
decl_stmt|;
specifier|register
name|struct
name|RoSAPconnect
modifier|*
name|roc
init|=
operator|&
name|rocs
decl_stmt|;
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
name|roi
operator|->
name|roi_preject
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|struct
name|PSAPconnect
modifier|*
name|pc
init|=
operator|&
name|acc
operator|->
name|acc_connect
decl_stmt|;
endif|#
directive|endif
name|struct
name|PSAPctxlist
name|pls
decl_stmt|;
specifier|register
name|struct
name|PSAPctxlist
modifier|*
name|pl
init|=
operator|&
name|pls
decl_stmt|;
name|AEI
name|aei
decl_stmt|;
name|OID
name|oid
decl_stmt|,
name|ode
decl_stmt|;
specifier|register
name|PE
name|pe
decl_stmt|;
if|if
condition|(
name|isacs
condition|)
block|{
if|if
condition|(
operator|(
name|aei
operator|=
name|str2aei
argument_list|(
name|addr
argument_list|,
name|isacs
argument_list|)
operator|)
operator|==
name|NULLAEI
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s-%s: unknown application-entity"
argument_list|,
name|addr
argument_list|,
name|isacs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pa
operator|=
name|aei2addr
argument_list|(
name|aei
argument_list|)
operator|)
operator|==
name|NULLPA
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"address translation failed"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|mode
operator|==
name|echo
condition|?
literal|"isode echo pci"
else|:
literal|"isode sink pci"
expr_stmt|;
if|if
condition|(
operator|(
name|ode
operator|=
name|ode2oid
argument_list|(
name|cp
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: unknown object descriptor"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|ode
operator|=
name|oid_cpy
argument_list|(
name|ode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sf
operator|=
name|addr2ref
argument_list|(
name|PLocalHostName
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sf
operator|=
operator|&
name|sfs
expr_stmt|;
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sf
argument_list|,
sizeof|sizeof
expr|*
name|sf
argument_list|)
expr_stmt|;
block|}
name|pl
operator|->
name|pc_nctx
operator|=
literal|1
expr_stmt|;
name|pl
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_id
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|oid
operator|=
name|ode2oid
argument_list|(
literal|"iso asn.1 abstract syntax"
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"iso asn.1 abstract syntax: unknown"
argument_list|)
expr_stmt|;
name|pl
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_asn
operator|=
name|oid_cpy
argument_list|(
name|oid
argument_list|)
expr_stmt|;
name|pl
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_atn
operator|=
name|NULLOID
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s... "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|AcAssocRequest
argument_list|(
name|ode
argument_list|,
name|NULLAEI
argument_list|,
name|aei
argument_list|,
name|NULLPA
argument_list|,
name|pa
argument_list|,
name|pl
argument_list|,
name|ode
argument_list|,
literal|0
argument_list|,
name|ROS_MYREQUIRE
argument_list|,
name|SERIAL_NONE
argument_list|,
literal|0
argument_list|,
name|sf
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|NULLQOS
argument_list|,
name|acc
argument_list|,
name|aci
argument_list|)
operator|==
name|NOTOK
condition|)
name|acs_adios
argument_list|(
name|aca
argument_list|,
literal|"A-ASSOCIATE.REQUEST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|acc
operator|->
name|acc_result
operator|!=
name|ACS_ACCEPT
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"association rejected: [%s]"
argument_list|,
name|AcErrString
argument_list|(
name|acc
operator|->
name|acc_result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connected\n"
argument_list|)
expr_stmt|;
name|sd
operator|=
name|acc
operator|->
name|acc_sd
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|pa
operator|=
operator|&
name|pc
operator|->
name|pc_responding
expr_stmt|;
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"context: %s"
argument_list|,
name|oid2ode
argument_list|(
name|acc
operator|->
name|acc_context
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"responding AE title: %s, responding PSAP address: %s"
argument_list|,
name|sprintaei
argument_list|(
operator|&
name|acc
operator|->
name|acc_respondtitle
argument_list|)
argument_list|,
name|paddr2str
argument_list|(
operator|&
name|pc
operator|->
name|pc_responding
argument_list|,
name|NULLNA
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"greetings: %d elements"
argument_list|,
name|acc
operator|->
name|acc_ninfo
argument_list|)
expr_stmt|;
name|pl
operator|=
operator|&
name|pc
operator|->
name|pc_ctxlist
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pl
operator|->
name|pc_nctx
condition|;
name|i
operator|++
control|)
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"ctx %d: 0x%x 0x%x %d"
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_id
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_asn
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_atn
argument_list|,
name|pl
operator|->
name|pc_ctx
index|[
name|i
index|]
operator|.
name|pc_result
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"default %d"
argument_list|,
name|pc
operator|->
name|pc_defctxresult
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"p/s requirements 0x%x/0x%x"
argument_list|,
name|pc
operator|->
name|pc_prequirements
argument_list|,
name|pc
operator|->
name|pc_srequirements
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|ACCFREE
argument_list|(
name|acc
argument_list|)
expr_stmt|;
if|if
condition|(
name|RoSetService
argument_list|(
name|sd
argument_list|,
name|RoPService
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
name|rop
argument_list|,
literal|"set RO/PT fails"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|register
name|struct
name|SSAPaddr
modifier|*
name|sa
decl_stmt|;
name|roa
operator|->
name|roa_port
operator|=
name|is
operator|->
name|is_port
expr_stmt|;
comment|/* yikes! */
if|if
condition|(
operator|(
name|is
operator|=
name|getisoserventbyname
argument_list|(
literal|"ros"
argument_list|,
literal|"ssap"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"ssap/ros: unknown entity"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sa
operator|=
name|is2saddr
argument_list|(
name|addr
argument_list|,
name|NULLCP
argument_list|,
name|is
argument_list|)
operator|)
operator|==
name|NULLSA
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"address translation failed"
argument_list|)
expr_stmt|;
name|roa
operator|->
name|roa_addr
operator|=
operator|*
name|sa
expr_stmt|;
comment|/* struct copy */
if|if
condition|(
operator|(
name|pe
operator|=
name|int2prim
argument_list|(
name|i
operator|=
name|getpid
argument_list|()
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate hello"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s... "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
name|RoBeginRequest
argument_list|(
name|roa
argument_list|,
name|pe
argument_list|,
name|roc
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|ros_adios
argument_list|(
name|rop
argument_list|,
literal|"RO-BEGIN.REQUEST"
argument_list|)
expr_stmt|;
block|}
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
if|if
condition|(
name|roc
operator|->
name|roc_result
operator|!=
name|ROS_ACCEPT
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"association rejected: [%s]"
argument_list|,
name|RoErrString
argument_list|(
name|roc
operator|->
name|roc_result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connected\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"sent greetings of %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sd
operator|=
name|roc
operator|->
name|roc_sd
expr_stmt|;
if|if
condition|(
name|roc
operator|->
name|roc_data
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|=
name|prim2num
argument_list|(
name|roc
operator|->
name|roc_data
argument_list|)
operator|)
operator|==
name|NOTOK
operator|&&
name|roc
operator|->
name|roc_data
operator|->
name|pe_errno
operator|!=
name|PE_ERR_NONE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"error decoding hello: %s (%d)"
argument_list|,
name|pe_error
argument_list|(
name|roc
operator|->
name|roc_data
operator|->
name|pe_errno
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"received greetings of %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|ROCFREE
argument_list|(
name|roc
argument_list|)
expr_stmt|;
block|}
name|do_ros
argument_list|(
name|sd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|do_ros
parameter_list|(
name|sd
parameter_list|)
name|int
name|sd
decl_stmt|;
block|{
name|int
name|cc
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
name|roi
operator|->
name|roi_preject
decl_stmt|;
name|struct
name|AcSAPrelease
name|acrs
decl_stmt|;
specifier|register
name|struct
name|AcSAPrelease
modifier|*
name|acr
init|=
operator|&
name|acrs
decl_stmt|;
specifier|register
name|PE
name|pe
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|!=
name|NOTOK
operator|&&
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|==
name|S_IFREG
operator|&&
operator|(
name|cc
operator|=
name|st
operator|.
name|st_size
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|cc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|cp
operator|,
name|j
operator|=
name|cc
init|;
name|j
operator|>
literal|0
condition|;
name|dp
operator|+=
name|i
operator|,
name|j
operator|-=
name|i
control|)
switch|switch
condition|(
name|i
operator|=
name|read
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|dp
argument_list|,
name|j
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|adios
argument_list|(
literal|"on stdin"
argument_list|,
literal|"read failed"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"premature end-of-file"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
if|if
condition|(
operator|(
name|pe
operator|=
name|oct2prim
argument_list|(
name|cp
argument_list|,
name|cc
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate invocation argument"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|10
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ros_invokerequest
argument_list|(
name|sd
argument_list|,
name|pe
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIMER
name|timer
argument_list|(
name|cc
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
block|}
else|else
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|stdin
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|pe
operator|=
name|oct2prim
argument_list|(
name|buffer
argument_list|,
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate invocation argument"
argument_list|)
expr_stmt|;
name|ros_invokerequest
argument_list|(
name|sd
argument_list|,
name|pe
argument_list|)
expr_stmt|;
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isrts
condition|)
block|{
name|struct
name|RtSAPindication
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPindication
modifier|*
name|rti
init|=
operator|&
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rta
init|=
operator|&
name|rti
operator|->
name|rti_abort
decl_stmt|;
if|if
condition|(
name|isacs
condition|)
block|{
if|if
condition|(
name|RtCloseRequest
argument_list|(
name|sd
argument_list|,
name|ACF_NORMAL
argument_list|,
name|NULLPE
argument_list|,
name|acr
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|rta
operator|->
name|rta_reason
condition|)
block|{
case|case
name|RTS_OPERATION
case|:
case|case
name|RTS_WAITING
case|:
name|rts_waitfor
argument_list|(
name|sd
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtCloseRequest
argument_list|(
name|sd
argument_list|,
name|ACF_NORMAL
argument_list|,
name|NULLPE
argument_list|,
name|acr
argument_list|,
name|rti
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-CLOSE.REQUEST"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|acr
operator|->
name|acr_affirmative
condition|)
block|{
operator|(
name|void
operator|)
name|RtUAbortRequest
argument_list|(
name|sd
argument_list|,
name|NULLPE
argument_list|,
name|rti
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"release rejected by peer: %d, %d elements"
argument_list|,
name|acr
operator|->
name|acr_reason
argument_list|,
name|acr
operator|->
name|acr_ninfo
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|RtEndRequest
argument_list|(
name|sd
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
switch|switch
condition|(
name|rta
operator|->
name|rta_reason
condition|)
block|{
case|case
name|RTS_OPERATION
case|:
case|case
name|RTS_WAITING
case|:
name|rts_waitfor
argument_list|(
name|sd
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtEndRequest
argument_list|(
name|sd
argument_list|,
name|rti
argument_list|)
operator|==
name|OK
condition|)
break|break;
comment|/* else fall */
default|default:
name|rts_adios
argument_list|(
name|rta
argument_list|,
literal|"RT-END.REQUEST"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|isacs
condition|)
block|{
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
if|if
condition|(
name|AcRelRequest
argument_list|(
name|sd
argument_list|,
name|ACF_NORMAL
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|NOTOK
argument_list|,
name|acr
argument_list|,
name|aci
argument_list|)
operator|==
name|NOTOK
condition|)
name|acs_adios
argument_list|(
name|aca
argument_list|,
literal|"A-RELEASE.REQUEST"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|acr
operator|->
name|acr_affirmative
condition|)
block|{
operator|(
name|void
operator|)
name|AcUAbortRequest
argument_list|(
name|sd
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
name|aci
argument_list|)
expr_stmt|;
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"release rejected by peer: %d, %d elements"
argument_list|,
name|acr
operator|->
name|acr_reason
argument_list|,
name|acr
operator|->
name|acr_ninfo
argument_list|)
expr_stmt|;
block|}
name|ACRFREE
argument_list|(
name|acr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|RoEndRequest
argument_list|(
name|sd
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
name|rop
argument_list|,
literal|"RO-END.REQUEST"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|ros_invokerequest
parameter_list|(
name|sd
parameter_list|,
name|pe
parameter_list|)
name|int
name|sd
decl_stmt|;
name|PE
name|pe
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
name|roi
operator|->
name|roi_preject
decl_stmt|;
specifier|static
name|int
name|id
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|op
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|result
operator|=
name|RoInvokeRequest
argument_list|(
name|sd
argument_list|,
name|op
operator|++
argument_list|,
name|ROS_SYNC
argument_list|,
name|pe
argument_list|,
operator|++
name|id
argument_list|,
name|NULLIP
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
if|if
condition|(
name|ROS_FATAL
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
condition|)
name|ros_adios
argument_list|(
name|rop
argument_list|,
literal|"RO-INVOKE.REQUEST"
argument_list|)
expr_stmt|;
name|ros_advise
argument_list|(
name|rop
argument_list|,
literal|"RO-INVOKE.REQUEST"
argument_list|)
expr_stmt|;
break|break;
case|case
name|OK
case|:
switch|switch
condition|(
name|roi
operator|->
name|roi_type
condition|)
block|{
case|case
name|ROI_INVOKE
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"got RO-INVOKE.INDICATION"
argument_list|)
expr_stmt|;
case|case
name|ROI_RESULT
case|:
block|{
specifier|register
name|struct
name|RoSAPresult
modifier|*
name|ror
init|=
operator|&
name|roi
operator|->
name|roi_result
decl_stmt|;
if|if
condition|(
name|ror
operator|->
name|ror_id
operator|!=
name|id
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"id mismatch (wanted %d, got %d)"
argument_list|,
name|id
argument_list|,
name|ror
operator|->
name|ror_id
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
if|if
condition|(
name|RoURejectRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|ror
operator|->
name|ror_id
argument_list|,
name|ROS_RRP_UNRECOG
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
name|rop
argument_list|,
literal|"RO-REJECT-U.REQUEST"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
name|echo
operator|&&
name|pe_cmp
argument_list|(
name|pe
argument_list|,
name|ror
operator|->
name|ror_result
argument_list|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"data mismatch (4)"
argument_list|)
expr_stmt|;
name|vunknown
argument_list|(
name|pe
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"---------"
argument_list|)
expr_stmt|;
name|vunknown
argument_list|(
name|ror
operator|->
name|ror_result
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"---------"
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
name|RORFREE
argument_list|(
name|ror
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ROI_ERROR
case|:
block|{
specifier|register
name|struct
name|RoSAPerror
modifier|*
name|roe
init|=
operator|&
name|roi
operator|->
name|roi_error
decl_stmt|;
if|if
condition|(
name|roe
operator|->
name|roe_id
operator|!=
name|id
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"id mismatch (wanted %d, got %d)"
argument_list|,
name|id
argument_list|,
name|roe
operator|->
name|roe_id
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
if|if
condition|(
name|RoURejectRequest
argument_list|(
name|sd
argument_list|,
operator|&
name|roe
operator|->
name|roe_id
argument_list|,
name|ROS_REP_UNRECOG
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_adios
argument_list|(
name|rop
argument_list|,
literal|"RO-REJECT-U.REQUEST"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
name|echo
operator|&&
name|pe_cmp
argument_list|(
name|pe
argument_list|,
name|roe
operator|->
name|roe_param
argument_list|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"data mismatch (5)"
argument_list|)
expr_stmt|;
name|vunknown
argument_list|(
name|pe
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"---------"
argument_list|)
expr_stmt|;
name|vunknown
argument_list|(
name|roe
operator|->
name|roe_param
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"---------"
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
name|ROEFREE
argument_list|(
name|roe
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ROI_UREJECT
case|:
block|{
specifier|register
name|struct
name|RoSAPureject
modifier|*
name|rou
init|=
operator|&
name|roi
operator|->
name|roi_ureject
decl_stmt|;
if|if
condition|(
name|rou
operator|->
name|rou_noid
condition|)
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"RO-REJECT-U.INDICATION: %s"
argument_list|,
name|RoErrString
argument_list|(
name|rou
operator|->
name|rou_reason
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"RO-REJECT-U.INDICATION: %s (id=%d)"
argument_list|,
name|RoErrString
argument_list|(
name|rou
operator|->
name|rou_reason
argument_list|)
argument_list|,
name|rou
operator|->
name|rou_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rou
operator|->
name|rou_noid
operator|&&
name|rou
operator|->
name|rou_id
operator|!=
name|id
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"id mismatch (wanted %d, got %d)"
argument_list|,
name|id
argument_list|,
name|rou
operator|->
name|rou_id
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown indication type=%d"
argument_list|,
name|roi
operator|->
name|roi_type
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isrts
condition|)
name|turn
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|DONE
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"got RO-END.INDICATION"
argument_list|)
expr_stmt|;
default|default:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown return from RoInvokeRequest=%d"
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|void
name|ros_adios
parameter_list|(
name|rop
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|ros_advise
argument_list|(
name|rop
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ros_advise
parameter_list|(
name|rop
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|rop
operator|->
name|rop_cc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s] %*.*s"
argument_list|,
name|RoErrString
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
argument_list|,
name|rop
operator|->
name|rop_cc
argument_list|,
name|rop
operator|->
name|rop_cc
argument_list|,
name|rop
operator|->
name|rop_data
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s]"
argument_list|,
name|RoErrString
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s: %s"
argument_list|,
name|event
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|TIMER */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|TIMER
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|NBBY
end_ifndef

begin_define
define|#
directive|define
name|NBBY
value|8
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|TMS
end_ifndef

begin_expr_stmt
specifier|static
name|timer
argument_list|(
argument|cc
argument_list|)
name|int
name|cc
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|bytes
decl_stmt|;
name|long
name|ms
decl_stmt|;
name|float
name|bs
decl_stmt|;
name|struct
name|timeval
name|stop
decl_stmt|,
name|td
decl_stmt|;
specifier|static
name|struct
name|timeval
name|start
decl_stmt|;
if|if
condition|(
name|cc
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|start
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|stop
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|tvsub
argument_list|(
operator|&
name|td
argument_list|,
operator|&
name|stop
argument_list|,
operator|&
name|start
argument_list|)
expr_stmt|;
name|ms
operator|=
operator|(
name|td
operator|.
name|tv_sec
operator|*
literal|1000
operator|)
operator|+
operator|(
name|td
operator|.
name|tv_usec
operator|/
literal|1000
operator|)
expr_stmt|;
name|bytes
operator|=
name|mode
operator|==
name|echo
condition|?
name|cc
operator|*
literal|2
else|:
name|cc
expr_stmt|;
name|bs
operator|=
operator|(
operator|(
operator|(
name|float
operator|)
name|bytes
operator|*
name|NBBY
operator|*
literal|1000
operator|)
operator|/
call|(
name|float
call|)
argument_list|(
name|ms
condition|?
name|ms
else|:
literal|1
argument_list|)
operator|)
operator|/
name|NBBY
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%d bytes %s in %d.%02d seconds (%.2f Kbytes/s)"
argument_list|,
name|cc
argument_list|,
name|mode
operator|==
name|echo
condition|?
literal|"echoed"
else|:
literal|"sunk"
argument_list|,
name|td
operator|.
name|tv_sec
argument_list|,
name|td
operator|.
name|tv_usec
operator|/
literal|10000
argument_list|,
name|bs
operator|/
literal|1024
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|tvsub
argument_list|(
name|tdiff
argument_list|,
name|t1
argument_list|,
name|t0
argument_list|)
specifier|register
expr|struct
name|timeval
operator|*
name|tdiff
operator|,
operator|*
name|t1
operator|,
operator|*
name|t0
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|tdiff
operator|->
name|tv_sec
operator|=
name|t1
operator|->
name|tv_sec
operator|-
name|t0
operator|->
name|tv_sec
expr_stmt|;
name|tdiff
operator|->
name|tv_usec
operator|=
name|t1
operator|->
name|tv_usec
operator|-
name|t0
operator|->
name|tv_usec
expr_stmt|;
if|if
condition|(
name|tdiff
operator|->
name|tv_usec
operator|<
literal|0
condition|)
name|tdiff
operator|->
name|tv_sec
operator|--
operator|,
name|tdiff
operator|->
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
block|}
end_block

begin_else
else|#
directive|else
end_else

begin_function_decl
name|long
name|times
parameter_list|()
function_decl|;
end_function_decl

begin_expr_stmt
specifier|static
name|timer
argument_list|(
argument|cc
argument_list|)
name|int
name|cc
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|bytes
decl_stmt|;
name|long
name|ms
decl_stmt|;
name|float
name|bs
decl_stmt|;
name|long
name|stop
decl_stmt|,
name|td
decl_stmt|,
name|secs
decl_stmt|,
name|msecs
decl_stmt|;
name|struct
name|tms
name|tm
decl_stmt|;
specifier|static
name|long
name|start
decl_stmt|;
if|if
condition|(
name|cc
operator|==
literal|0
condition|)
block|{
name|start
operator|=
name|times
argument_list|(
operator|&
name|tm
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
name|stop
operator|=
name|times
argument_list|(
operator|&
name|tm
argument_list|)
expr_stmt|;
name|td
operator|=
name|stop
operator|-
name|start
expr_stmt|;
name|secs
operator|=
name|td
operator|/
literal|60
operator|,
name|msecs
operator|=
operator|(
name|td
operator|%
literal|60
operator|)
operator|*
literal|1000
operator|/
literal|60
expr_stmt|;
name|ms
operator|=
operator|(
name|secs
operator|*
literal|1000
operator|)
operator|+
name|msecs
expr_stmt|;
name|bytes
operator|=
name|mode
operator|==
name|echo
condition|?
name|cc
operator|*
literal|2
else|:
name|cc
expr_stmt|;
name|bs
operator|=
operator|(
operator|(
operator|(
name|float
operator|)
name|bytes
operator|*
name|NBBY
operator|*
literal|1000
operator|)
operator|/
call|(
name|float
call|)
argument_list|(
name|ms
condition|?
name|ms
else|:
literal|1
argument_list|)
operator|)
operator|/
name|NBBY
expr_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%d bytes %s in %d.%02d seconds (%.2f KBytes/s)"
argument_list|,
name|cc
argument_list|,
name|mode
operator|==
name|echo
condition|?
literal|"echoed"
else|:
literal|"sunk"
argument_list|,
name|secs
argument_list|,
name|msecs
operator|/
literal|10
argument_list|,
name|bs
operator|/
literal|1024
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*
comment|QBUF */
end_comment

begin_function
specifier|static
name|int
name|qcmp
parameter_list|(
name|b
parameter_list|,
name|qb
parameter_list|,
name|l
parameter_list|)
specifier|register
name|char
modifier|*
name|b
decl_stmt|;
specifier|register
name|struct
name|qbuf
modifier|*
name|qb
decl_stmt|;
specifier|register
name|int
name|l
decl_stmt|;
block|{
specifier|register
name|struct
name|qbuf
modifier|*
name|qp
decl_stmt|;
for|for
control|(
name|qp
operator|=
name|qb
operator|->
name|qb_forw
init|;
name|qp
operator|!=
name|qb
condition|;
name|qp
operator|=
name|qp
operator|->
name|qb_forw
control|)
block|{
if|if
condition|(
operator|(
name|l
operator|-=
name|qp
operator|->
name|qb_len
operator|)
operator|<
literal|0
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"length mismatch(1)"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|bcmp
argument_list|(
name|b
argument_list|,
name|qp
operator|->
name|qb_data
argument_list|,
name|qp
operator|->
name|qb_len
argument_list|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"data mismatch (6)"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|b
operator|+=
name|qp
operator|->
name|qb_len
expr_stmt|;
block|}
if|if
condition|(
name|l
operator|!=
literal|0
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"length mismatch(2)"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|ERRORS */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_function_decl
name|void
name|_advise
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|void
name|adios
parameter_list|(
name|va_alist
parameter_list|)
function|va_dcl
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|_advise
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* VARARGS */
end_comment

begin_function
name|void
name|adios
parameter_list|(
name|what
parameter_list|,
name|fmt
parameter_list|)
name|char
modifier|*
name|what
decl_stmt|,
decl|*
name|fmt
decl_stmt|;
end_function

begin_block
block|{
name|adios
argument_list|(
name|what
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_function
name|void
name|advise
parameter_list|(
name|va_alist
parameter_list|)
function|va_dcl
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|_advise
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|_advise
parameter_list|(
name|ap
parameter_list|)
name|va_list
name|ap
decl_stmt|;
block|{
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|asprintf
argument_list|(
name|buffer
argument_list|,
name|ap
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: "
argument_list|,
name|myname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fputs
argument_list|(
name|buffer
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fputc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* VARARGS */
end_comment

begin_function
name|void
name|advise
parameter_list|(
name|what
parameter_list|,
name|fmt
parameter_list|)
name|char
modifier|*
name|what
decl_stmt|,
decl|*
name|fmt
decl_stmt|;
end_function

begin_block
block|{
name|advise
argument_list|(
name|what
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


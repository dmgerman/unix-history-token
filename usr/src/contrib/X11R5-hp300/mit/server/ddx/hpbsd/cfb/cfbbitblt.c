begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * cfb copy area  */
end_comment

begin_comment
comment|/* Copyright 1989 by the Massachusetts Institute of Technology  Permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.  Author: Keith Packard  */
end_comment

begin_comment
comment|/* $XConsortium: cfbbitblt.c,v 5.43 91/07/19 23:20:45 keith Exp $ */
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xmd.h"
end_include

begin_include
include|#
directive|include
file|"Xproto.h"
end_include

begin_include
include|#
directive|include
file|"gcstruct.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"regionstr.h"
end_include

begin_include
include|#
directive|include
file|"cfb.h"
end_include

begin_include
include|#
directive|include
file|"cfbmskbits.h"
end_include

begin_include
include|#
directive|include
file|"cfb8bit.h"
end_include

begin_include
include|#
directive|include
file|"fastblt.h"
end_include

begin_decl_stmt
name|RegionPtr
name|cfbBitBlt
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|pGC
argument_list|,
name|srcx
argument_list|,
name|srcy
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|dstx
argument_list|,
name|dsty
argument_list|,
name|doBitBlt
argument_list|,
name|bitPlane
argument_list|)
decl|register
name|DrawablePtr
name|pSrcDrawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|DrawablePtr
name|pDstDrawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|GC
modifier|*
name|pGC
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|srcx
decl_stmt|,
name|srcy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dstx
decl_stmt|,
name|dsty
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|doBitBlt
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|unsigned
name|long
name|bitPlane
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|RegionPtr
name|prgnSrcClip
decl_stmt|;
comment|/* may be a new region, or just a copy */
name|Bool
name|freeSrcClip
init|=
name|FALSE
decl_stmt|;
name|RegionPtr
name|prgnExposed
decl_stmt|;
name|RegionRec
name|rgnDst
decl_stmt|;
name|DDXPointPtr
name|pptSrc
decl_stmt|;
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
specifier|register
name|BoxPtr
name|pbox
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|dx
decl_stmt|;
specifier|register
name|int
name|dy
decl_stmt|;
name|xRectangle
name|origSource
decl_stmt|;
name|DDXPointRec
name|origDest
decl_stmt|;
name|int
name|numRects
decl_stmt|;
name|BoxRec
name|fastBox
decl_stmt|;
name|int
name|fastClip
init|=
literal|0
decl_stmt|;
comment|/* for fast clipping with pixmap source */
name|int
name|fastExpose
init|=
literal|0
decl_stmt|;
comment|/* for fast exposures with pixmap source */
name|origSource
operator|.
name|x
operator|=
name|srcx
expr_stmt|;
name|origSource
operator|.
name|y
operator|=
name|srcy
expr_stmt|;
name|origSource
operator|.
name|width
operator|=
name|width
expr_stmt|;
name|origSource
operator|.
name|height
operator|=
name|height
expr_stmt|;
name|origDest
operator|.
name|x
operator|=
name|dstx
expr_stmt|;
name|origDest
operator|.
name|y
operator|=
name|dsty
expr_stmt|;
if|if
condition|(
operator|(
name|pSrcDrawable
operator|!=
name|pDstDrawable
operator|)
operator|&&
name|pSrcDrawable
operator|->
name|pScreen
operator|->
name|SourceValidate
condition|)
block|{
call|(
modifier|*
name|pSrcDrawable
operator|->
name|pScreen
operator|->
name|SourceValidate
call|)
argument_list|(
name|pSrcDrawable
argument_list|,
name|srcx
argument_list|,
name|srcy
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
block|}
name|srcx
operator|+=
name|pSrcDrawable
operator|->
name|x
expr_stmt|;
name|srcy
operator|+=
name|pSrcDrawable
operator|->
name|y
expr_stmt|;
comment|/* clip the source */
if|if
condition|(
name|pSrcDrawable
operator|->
name|type
operator|==
name|DRAWABLE_PIXMAP
condition|)
block|{
if|if
condition|(
operator|(
name|pSrcDrawable
operator|==
name|pDstDrawable
operator|)
operator|&&
operator|(
name|pGC
operator|->
name|clientClipType
operator|==
name|CT_NONE
operator|)
condition|)
block|{
name|prgnSrcClip
operator|=
operator|(
operator|(
name|cfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
expr_stmt|;
block|}
else|else
block|{
name|fastClip
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|pGC
operator|->
name|subWindowMode
operator|==
name|IncludeInferiors
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|WindowPtr
operator|)
name|pSrcDrawable
operator|)
operator|->
name|parent
condition|)
block|{
comment|/* 		 * special case bitblt from root window in 		 * IncludeInferiors mode; just like from a pixmap 		 */
name|fastClip
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSrcDrawable
operator|==
name|pDstDrawable
operator|)
operator|&&
operator|(
name|pGC
operator|->
name|clientClipType
operator|==
name|CT_NONE
operator|)
condition|)
block|{
name|prgnSrcClip
operator|=
operator|(
operator|(
name|cfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
expr_stmt|;
block|}
else|else
block|{
name|prgnSrcClip
operator|=
name|NotClippedByChildren
argument_list|(
operator|(
name|WindowPtr
operator|)
name|pSrcDrawable
argument_list|)
expr_stmt|;
name|freeSrcClip
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
else|else
block|{
name|prgnSrcClip
operator|=
operator|&
operator|(
operator|(
name|WindowPtr
operator|)
name|pSrcDrawable
operator|)
operator|->
name|clipList
expr_stmt|;
block|}
block|}
name|fastBox
operator|.
name|x1
operator|=
name|srcx
expr_stmt|;
name|fastBox
operator|.
name|y1
operator|=
name|srcy
expr_stmt|;
name|fastBox
operator|.
name|x2
operator|=
name|srcx
operator|+
name|width
expr_stmt|;
name|fastBox
operator|.
name|y2
operator|=
name|srcy
operator|+
name|height
expr_stmt|;
comment|/* Don't create a source region if we are doing a fast clip */
if|if
condition|(
name|fastClip
condition|)
block|{
name|fastExpose
operator|=
literal|1
expr_stmt|;
comment|/* 	 * clip the source; if regions extend beyond the source size,  	 * make sure exposure events get sent 	 */
if|if
condition|(
name|fastBox
operator|.
name|x1
operator|<
name|pSrcDrawable
operator|->
name|x
condition|)
block|{
name|fastBox
operator|.
name|x1
operator|=
name|pSrcDrawable
operator|->
name|x
expr_stmt|;
name|fastExpose
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|fastBox
operator|.
name|y1
operator|<
name|pSrcDrawable
operator|->
name|y
condition|)
block|{
name|fastBox
operator|.
name|y1
operator|=
name|pSrcDrawable
operator|->
name|y
expr_stmt|;
name|fastExpose
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|fastBox
operator|.
name|x2
operator|>
name|pSrcDrawable
operator|->
name|x
operator|+
operator|(
name|int
operator|)
name|pSrcDrawable
operator|->
name|width
condition|)
block|{
name|fastBox
operator|.
name|x2
operator|=
name|pSrcDrawable
operator|->
name|x
operator|+
operator|(
name|int
operator|)
name|pSrcDrawable
operator|->
name|width
expr_stmt|;
name|fastExpose
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|fastBox
operator|.
name|y2
operator|>
name|pSrcDrawable
operator|->
name|y
operator|+
operator|(
name|int
operator|)
name|pSrcDrawable
operator|->
name|height
condition|)
block|{
name|fastBox
operator|.
name|y2
operator|=
name|pSrcDrawable
operator|->
name|y
operator|+
operator|(
name|int
operator|)
name|pSrcDrawable
operator|->
name|height
expr_stmt|;
name|fastExpose
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|RegionInit
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|,
operator|&
name|fastBox
argument_list|,
literal|1
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|Intersect
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|,
operator|&
name|rgnDst
argument_list|,
name|prgnSrcClip
argument_list|)
expr_stmt|;
block|}
name|dstx
operator|+=
name|pDstDrawable
operator|->
name|x
expr_stmt|;
name|dsty
operator|+=
name|pDstDrawable
operator|->
name|y
expr_stmt|;
if|if
condition|(
name|pDstDrawable
operator|->
name|type
operator|==
name|DRAWABLE_WINDOW
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|WindowPtr
operator|)
name|pDstDrawable
operator|)
operator|->
name|realized
condition|)
block|{
if|if
condition|(
operator|!
name|fastClip
condition|)
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|RegionUninit
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|)
expr_stmt|;
if|if
condition|(
name|freeSrcClip
condition|)
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|RegionDestroy
call|)
argument_list|(
name|prgnSrcClip
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|dx
operator|=
name|srcx
operator|-
name|dstx
expr_stmt|;
name|dy
operator|=
name|srcy
operator|-
name|dsty
expr_stmt|;
comment|/* Translate and clip the dst to the destination composite clip */
if|if
condition|(
name|fastClip
condition|)
block|{
name|RegionPtr
name|cclip
decl_stmt|;
comment|/* Translate the region directly */
name|fastBox
operator|.
name|x1
operator|-=
name|dx
expr_stmt|;
name|fastBox
operator|.
name|x2
operator|-=
name|dx
expr_stmt|;
name|fastBox
operator|.
name|y1
operator|-=
name|dy
expr_stmt|;
name|fastBox
operator|.
name|y2
operator|-=
name|dy
expr_stmt|;
comment|/* If the destination composite clip is one rectangle we can 	   do the clip directly.  Otherwise we have to create a full 	   blown region and call intersect */
comment|/* XXX because CopyPlane uses this routine for 8-to-1 bit 	 * copies, this next line *must* also correctly fetch the 	 * composite clip from an mfb gc 	 */
name|cclip
operator|=
operator|(
operator|(
name|cfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
expr_stmt|;
if|if
condition|(
name|REGION_NUM_RECTS
argument_list|(
name|cclip
argument_list|)
operator|==
literal|1
condition|)
block|{
name|BoxPtr
name|pBox
init|=
name|REGION_RECTS
argument_list|(
name|cclip
argument_list|)
decl_stmt|;
if|if
condition|(
name|fastBox
operator|.
name|x1
operator|<
name|pBox
operator|->
name|x1
condition|)
name|fastBox
operator|.
name|x1
operator|=
name|pBox
operator|->
name|x1
expr_stmt|;
if|if
condition|(
name|fastBox
operator|.
name|x2
operator|>
name|pBox
operator|->
name|x2
condition|)
name|fastBox
operator|.
name|x2
operator|=
name|pBox
operator|->
name|x2
expr_stmt|;
if|if
condition|(
name|fastBox
operator|.
name|y1
operator|<
name|pBox
operator|->
name|y1
condition|)
name|fastBox
operator|.
name|y1
operator|=
name|pBox
operator|->
name|y1
expr_stmt|;
if|if
condition|(
name|fastBox
operator|.
name|y2
operator|>
name|pBox
operator|->
name|y2
condition|)
name|fastBox
operator|.
name|y2
operator|=
name|pBox
operator|->
name|y2
expr_stmt|;
comment|/* Check to see if the region is empty */
if|if
condition|(
name|fastBox
operator|.
name|x1
operator|>=
name|fastBox
operator|.
name|x2
operator|||
name|fastBox
operator|.
name|y1
operator|>=
name|fastBox
operator|.
name|y2
condition|)
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|RegionInit
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|,
name|NullBox
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|RegionInit
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|,
operator|&
name|fastBox
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* We must turn off fastClip now, since we must create 	       a full blown region.  It is intersected with the 	       composite clip below. */
name|fastClip
operator|=
literal|0
expr_stmt|;
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|RegionInit
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|,
operator|&
name|fastBox
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|TranslateRegion
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|,
operator|-
name|dx
argument_list|,
operator|-
name|dy
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fastClip
condition|)
block|{
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|Intersect
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|,
operator|&
name|rgnDst
argument_list|,
operator|(
operator|(
name|cfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
block|}
comment|/* Do bit blitting */
name|numRects
operator|=
name|REGION_NUM_RECTS
argument_list|(
operator|&
name|rgnDst
argument_list|)
expr_stmt|;
if|if
condition|(
name|numRects
operator|&&
name|width
operator|&&
name|height
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|pptSrc
operator|=
operator|(
name|DDXPointPtr
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|numRects
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
operator|)
condition|)
block|{
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|RegionUninit
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|)
expr_stmt|;
if|if
condition|(
name|freeSrcClip
condition|)
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|RegionDestroy
call|)
argument_list|(
name|prgnSrcClip
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pbox
operator|=
name|REGION_RECTS
argument_list|(
operator|&
name|rgnDst
argument_list|)
expr_stmt|;
name|ppt
operator|=
name|pptSrc
expr_stmt|;
for|for
control|(
name|i
operator|=
name|numRects
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
name|pbox
operator|++
operator|,
name|ppt
operator|++
control|)
block|{
name|ppt
operator|->
name|x
operator|=
name|pbox
operator|->
name|x1
operator|+
name|dx
expr_stmt|;
name|ppt
operator|->
name|y
operator|=
name|pbox
operator|->
name|y1
operator|+
name|dy
expr_stmt|;
block|}
call|(
modifier|*
name|doBitBlt
call|)
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|pGC
operator|->
name|alu
argument_list|,
operator|&
name|rgnDst
argument_list|,
name|pptSrc
argument_list|,
name|pGC
operator|->
name|planemask
argument_list|,
name|bitPlane
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pptSrc
argument_list|)
expr_stmt|;
block|}
name|prgnExposed
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|cfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|fExpose
condition|)
block|{
specifier|extern
name|RegionPtr
name|miHandleExposures
parameter_list|()
function_decl|;
comment|/* Pixmap sources generate a NoExposed (we return NULL to do this) */
if|if
condition|(
operator|!
name|fastExpose
condition|)
name|prgnExposed
operator|=
name|miHandleExposures
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|pGC
argument_list|,
name|origSource
operator|.
name|x
argument_list|,
name|origSource
operator|.
name|y
argument_list|,
operator|(
name|int
operator|)
name|origSource
operator|.
name|width
argument_list|,
operator|(
name|int
operator|)
name|origSource
operator|.
name|height
argument_list|,
name|origDest
operator|.
name|x
argument_list|,
name|origDest
operator|.
name|y
argument_list|,
name|bitPlane
argument_list|)
expr_stmt|;
block|}
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|RegionUninit
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|)
expr_stmt|;
if|if
condition|(
name|freeSrcClip
condition|)
call|(
modifier|*
name|pGC
operator|->
name|pScreen
operator|->
name|RegionDestroy
call|)
argument_list|(
name|prgnSrcClip
argument_list|)
expr_stmt|;
return|return
name|prgnExposed
return|;
block|}
end_block

begin_function_decl
specifier|extern
name|int
name|cfbDoBitbltCopy
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|cfbDoBitbltXor
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|cfbDoBitbltOr
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|cfbDoBitbltGeneral
parameter_list|()
function_decl|;
end_function_decl

begin_macro
name|cfbDoBitblt
argument_list|(
argument|pSrc
argument_list|,
argument|pDst
argument_list|,
argument|alu
argument_list|,
argument|prgnDst
argument_list|,
argument|pptSrc
argument_list|,
argument|planemask
argument_list|)
end_macro

begin_decl_stmt
name|DrawablePtr
name|pSrc
decl_stmt|,
name|pDst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|alu
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|RegionPtr
name|prgnDst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DDXPointPtr
name|pptSrc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|planemask
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
function_decl|(
modifier|*
name|blt
function_decl|)
parameter_list|()
init|=
name|cfbDoBitbltGeneral
function_decl|;
if|if
condition|(
operator|(
name|planemask
operator|&
name|PMSK
operator|)
operator|==
name|PMSK
condition|)
block|{
switch|switch
condition|(
name|alu
condition|)
block|{
case|case
name|GXcopy
case|:
name|blt
operator|=
name|cfbDoBitbltCopy
expr_stmt|;
break|break;
case|case
name|GXxor
case|:
name|blt
operator|=
name|cfbDoBitbltXor
expr_stmt|;
break|break;
case|case
name|GXor
case|:
name|blt
operator|=
name|cfbDoBitbltOr
expr_stmt|;
break|break;
block|}
block|}
return|return
call|(
modifier|*
name|blt
call|)
argument_list|(
name|pSrc
argument_list|,
name|pDst
argument_list|,
name|alu
argument_list|,
name|prgnDst
argument_list|,
name|pptSrc
argument_list|,
name|planemask
argument_list|)
return|;
block|}
end_block

begin_function
name|RegionPtr
name|cfbCopyArea
parameter_list|(
name|pSrcDrawable
parameter_list|,
name|pDstDrawable
parameter_list|,
name|pGC
parameter_list|,
name|srcx
parameter_list|,
name|srcy
parameter_list|,
name|width
parameter_list|,
name|height
parameter_list|,
name|dstx
parameter_list|,
name|dsty
parameter_list|)
specifier|register
name|DrawablePtr
name|pSrcDrawable
decl_stmt|;
specifier|register
name|DrawablePtr
name|pDstDrawable
decl_stmt|;
name|GC
modifier|*
name|pGC
decl_stmt|;
name|int
name|srcx
decl_stmt|,
name|srcy
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|dstx
decl_stmt|,
name|dsty
decl_stmt|;
block|{
name|int
function_decl|(
modifier|*
name|doBitBlt
function_decl|)
parameter_list|()
function_decl|;
name|doBitBlt
operator|=
name|cfbDoBitbltCopy
expr_stmt|;
if|if
condition|(
name|pGC
operator|->
name|alu
operator|!=
name|GXcopy
operator|||
operator|(
name|pGC
operator|->
name|planemask
operator|&
name|PMSK
operator|)
operator|!=
name|PMSK
condition|)
block|{
name|doBitBlt
operator|=
name|cfbDoBitbltGeneral
expr_stmt|;
if|if
condition|(
operator|(
name|pGC
operator|->
name|planemask
operator|&
name|PMSK
operator|)
operator|==
name|PMSK
condition|)
block|{
switch|switch
condition|(
name|pGC
operator|->
name|alu
condition|)
block|{
case|case
name|GXxor
case|:
name|doBitBlt
operator|=
name|cfbDoBitbltXor
expr_stmt|;
break|break;
case|case
name|GXor
case|:
name|doBitBlt
operator|=
name|cfbDoBitbltOr
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
name|cfbBitBlt
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|pGC
argument_list|,
name|srcx
argument_list|,
name|srcy
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|dstx
argument_list|,
name|dsty
argument_list|,
name|doBitBlt
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|PPW
operator|==
literal|4
operator|)
end_if

begin_macro
name|cfbCopyPlane1to8
argument_list|(
argument|pSrcDrawable
argument_list|,
argument|pDstDrawable
argument_list|,
argument|rop
argument_list|,
argument|prgnDst
argument_list|,
argument|pptSrc
argument_list|,
argument|planemask
argument_list|,
argument|bitPlane
argument_list|)
end_macro

begin_decl_stmt
name|DrawablePtr
name|pSrcDrawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DrawablePtr
name|pDstDrawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|planemask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|RegionPtr
name|prgnDst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DDXPointPtr
name|pptSrc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|bitPlane
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|srcx
decl_stmt|,
name|srcy
decl_stmt|,
name|dstx
decl_stmt|,
name|dsty
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|xoffSrc
decl_stmt|,
name|xoffDst
decl_stmt|;
name|unsigned
name|long
modifier|*
name|psrcBase
decl_stmt|,
modifier|*
name|pdstBase
decl_stmt|;
name|int
name|widthSrc
decl_stmt|,
name|widthDst
decl_stmt|;
name|unsigned
name|long
modifier|*
name|psrcLine
decl_stmt|,
modifier|*
name|pdstLine
decl_stmt|;
specifier|register
name|unsigned
name|long
modifier|*
name|psrc
decl_stmt|,
modifier|*
name|pdst
decl_stmt|;
specifier|register
name|unsigned
name|long
name|bits
decl_stmt|,
name|tmp
decl_stmt|;
specifier|register
name|int
name|leftShift
decl_stmt|,
name|rightShift
decl_stmt|;
name|unsigned
name|long
name|startmask
decl_stmt|,
name|endmask
decl_stmt|;
specifier|register
name|int
name|nl
decl_stmt|,
name|nlMiddle
decl_stmt|;
name|int
name|firstoff
decl_stmt|,
name|secondoff
decl_stmt|;
name|unsigned
name|long
name|src
decl_stmt|;
name|int
name|nbox
decl_stmt|;
name|BoxPtr
name|pbox
decl_stmt|;
name|cfbGetLongWidthAndPointer
argument_list|(
argument|pSrcDrawable
argument_list|,
argument|widthSrc
argument_list|,
argument|psrcBase
argument_list|)
name|cfbGetLongWidthAndPointer
argument_list|(
argument|pDstDrawable
argument_list|,
argument|widthDst
argument_list|,
argument|pdstBase
argument_list|)
name|nbox
operator|=
name|REGION_NUM_RECTS
argument_list|(
name|prgnDst
argument_list|)
expr_stmt|;
name|pbox
operator|=
name|REGION_RECTS
argument_list|(
name|prgnDst
argument_list|)
expr_stmt|;
comment|/* XXX ?? */
name|WAIT_READY_TO_RENDER
argument_list|(
name|pSrcDrawable
operator|->
name|pScreen
argument_list|)
expr_stmt|;
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDstDrawable
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
while|while
condition|(
name|nbox
operator|--
condition|)
block|{
name|dstx
operator|=
name|pbox
operator|->
name|x1
expr_stmt|;
name|dsty
operator|=
name|pbox
operator|->
name|y1
expr_stmt|;
name|srcx
operator|=
name|pptSrc
operator|->
name|x
expr_stmt|;
name|srcy
operator|=
name|pptSrc
operator|->
name|y
expr_stmt|;
name|width
operator|=
name|pbox
operator|->
name|x2
operator|-
name|pbox
operator|->
name|x1
expr_stmt|;
name|height
operator|=
name|pbox
operator|->
name|y2
operator|-
name|pbox
operator|->
name|y1
expr_stmt|;
name|pbox
operator|++
expr_stmt|;
name|pptSrc
operator|++
expr_stmt|;
name|psrcLine
operator|=
name|psrcBase
operator|+
name|srcy
operator|*
name|widthSrc
operator|+
operator|(
name|srcx
operator|>>
literal|5
operator|)
expr_stmt|;
name|pdstLine
operator|=
name|pdstBase
operator|+
name|dsty
operator|*
name|widthDst
operator|+
operator|(
name|dstx
operator|>>
literal|2
operator|)
expr_stmt|;
name|xoffSrc
operator|=
name|srcx
operator|&
literal|0x1f
expr_stmt|;
name|xoffDst
operator|=
name|dstx
operator|&
literal|0x3
expr_stmt|;
if|if
condition|(
name|xoffDst
operator|+
name|width
operator|<
literal|4
condition|)
block|{
name|maskpartialbits
argument_list|(
name|dstx
argument_list|,
name|width
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|endmask
operator|=
literal|0
expr_stmt|;
name|nlMiddle
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|dstx
argument_list|,
name|width
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlMiddle
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * compute constants for the first four bits to be 	 * copied.  This avoids troubles with partial first 	 * writes, and difficult shift computation 	 */
if|if
condition|(
name|startmask
condition|)
block|{
name|firstoff
operator|=
name|xoffSrc
operator|-
name|xoffDst
expr_stmt|;
if|if
condition|(
name|firstoff
operator|>
literal|28
condition|)
name|secondoff
operator|=
literal|32
operator|-
name|firstoff
expr_stmt|;
if|if
condition|(
name|xoffDst
condition|)
block|{
name|srcx
operator|+=
operator|(
literal|4
operator|-
name|xoffDst
operator|)
expr_stmt|;
name|dstx
operator|+=
operator|(
literal|4
operator|-
name|xoffDst
operator|)
expr_stmt|;
name|xoffSrc
operator|=
name|srcx
operator|&
literal|0x1f
expr_stmt|;
block|}
block|}
name|leftShift
operator|=
name|xoffSrc
expr_stmt|;
name|rightShift
operator|=
literal|32
operator|-
name|leftShift
expr_stmt|;
if|if
condition|(
name|cfb8StippleRRop
operator|==
name|GXcopy
condition|)
block|{
while|while
condition|(
name|height
operator|--
condition|)
block|{
name|psrc
operator|=
name|psrcLine
expr_stmt|;
name|pdst
operator|=
name|pdstLine
expr_stmt|;
name|psrcLine
operator|+=
name|widthSrc
expr_stmt|;
name|pdstLine
operator|+=
name|widthDst
expr_stmt|;
name|bits
operator|=
operator|*
name|psrc
operator|++
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
if|if
condition|(
name|firstoff
operator|<
literal|0
condition|)
name|tmp
operator|=
name|BitRight
argument_list|(
name|bits
argument_list|,
operator|-
name|firstoff
argument_list|)
expr_stmt|;
else|else
block|{
name|tmp
operator|=
name|BitLeft
argument_list|(
name|bits
argument_list|,
name|firstoff
argument_list|)
expr_stmt|;
comment|/* 			 * need a more cautious test for partialmask 			 * case... 			 */
if|if
condition|(
name|firstoff
operator|>=
literal|28
condition|)
block|{
name|bits
operator|=
operator|*
name|psrc
operator|++
expr_stmt|;
if|if
condition|(
name|firstoff
operator|!=
literal|28
condition|)
name|tmp
operator||=
name|BitRight
argument_list|(
name|bits
argument_list|,
name|secondoff
argument_list|)
expr_stmt|;
block|}
block|}
operator|*
name|pdst
operator|=
operator|*
name|pdst
operator|&
operator|~
name|startmask
operator||
name|GetFourPixels
argument_list|(
name|tmp
argument_list|)
operator|&
name|startmask
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
block|}
name|nl
operator|=
name|nlMiddle
expr_stmt|;
while|while
condition|(
name|nl
operator|>=
literal|8
condition|)
block|{
name|nl
operator|-=
literal|8
expr_stmt|;
name|tmp
operator|=
name|BitLeft
argument_list|(
name|bits
argument_list|,
name|leftShift
argument_list|)
expr_stmt|;
name|bits
operator|=
operator|*
name|psrc
operator|++
expr_stmt|;
if|if
condition|(
name|rightShift
operator|!=
literal|32
condition|)
name|tmp
operator||=
name|BitRight
argument_list|(
name|bits
argument_list|,
name|rightShift
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FAST_CONSTANT_OFFSET_MODE
define|#
directive|define
name|StorePixels
parameter_list|(
name|pdst
parameter_list|,
name|o
parameter_list|,
name|pixels
parameter_list|)
value|(pdst)[o] = (pixels)
define|#
directive|define
name|EndStep
parameter_list|(
name|pdst
parameter_list|,
name|o
parameter_list|)
value|(pdst) += (o)
define|#
directive|define
name|StoreRopPixels
parameter_list|(
name|pdst
parameter_list|,
name|o
parameter_list|,
name|and
parameter_list|,
name|xor
parameter_list|)
value|(pdst)[o] = DoRRop((pdst)[o],and,xor);
else|#
directive|else
define|#
directive|define
name|StorePixels
parameter_list|(
name|pdst
parameter_list|,
name|o
parameter_list|,
name|pixels
parameter_list|)
value|*(pdst)++ = (pixels)
define|#
directive|define
name|EndStep
parameter_list|(
name|pdst
parameter_list|,
name|o
parameter_list|)
define|#
directive|define
name|StoreRopPixels
parameter_list|(
name|pdst
parameter_list|,
name|o
parameter_list|,
name|and
parameter_list|,
name|xor
parameter_list|)
value|*(pdst) = DoRRop(*(pdst),and,xor); (pdst)++;
endif|#
directive|endif
define|#
directive|define
name|Step
parameter_list|(
name|c
parameter_list|)
value|NextFourBits(c);
define|#
directive|define
name|StoreBitsPlain
parameter_list|(
name|o
parameter_list|,
name|c
parameter_list|)
value|StorePixels(pdst,o,GetFourPixels(c))
define|#
directive|define
name|StoreRopBitsPlain
parameter_list|(
name|o
parameter_list|,
name|c
parameter_list|)
value|StoreRopPixels(pdst,o,\ 					cfb8StippleAnd[GetFourBits(c)], \ 					cfb8StippleXor[GetFourBits(c)])
define|#
directive|define
name|StoreBits0
parameter_list|(
name|c
parameter_list|)
value|StoreBitsPlain(0,c)
define|#
directive|define
name|StoreRopBits0
parameter_list|(
name|c
parameter_list|)
value|StoreRopBitsPlain(0,c)
if|#
directive|if
operator|(
name|BITMAP_BIT_ORDER
operator|==
name|MSBFirst
operator|)
define|#
directive|define
name|StoreBits
parameter_list|(
name|o
parameter_list|,
name|c
parameter_list|)
value|StoreBitsPlain(o,c)
define|#
directive|define
name|StoreRopBits
parameter_list|(
name|o
parameter_list|,
name|c
parameter_list|)
value|StoreRopBitsPlain(o,c)
define|#
directive|define
name|FirstStep
parameter_list|(
name|c
parameter_list|)
value|Step(c)
else|#
directive|else
define|#
directive|define
name|StoreBits
parameter_list|(
name|o
parameter_list|,
name|c
parameter_list|)
value|StorePixels(pdst,o,*((unsigned long *)\ 			    (((char *) cfb8Pixels) + (c& 0x3c))))
define|#
directive|define
name|StoreRopBits
parameter_list|(
name|o
parameter_list|,
name|c
parameter_list|)
value|StoreRopPixels(pdst,o, \ 	    *((unsigned long *) (((char *) cfb8StippleAnd) + (c& 0x3c))), \ 	    *((unsigned long *) (((char *) cfb8StippleXor) + (c& 0x3c))))
define|#
directive|define
name|FirstStep
parameter_list|(
name|c
parameter_list|)
value|c = BitLeft (c, 2);
endif|#
directive|endif
name|StoreBits0
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|FirstStep
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreBits
argument_list|(
literal|1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreBits
argument_list|(
literal|2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreBits
argument_list|(
literal|3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreBits
argument_list|(
literal|4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreBits
argument_list|(
literal|5
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreBits
argument_list|(
literal|6
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreBits
argument_list|(
literal|7
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|EndStep
argument_list|(
name|pdst
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nl
operator|||
name|endmask
condition|)
block|{
name|tmp
operator|=
name|BitLeft
argument_list|(
name|bits
argument_list|,
name|leftShift
argument_list|)
expr_stmt|;
comment|/* 		     * better condition needed -- mustn't run 		     * off the end of the source... 		     */
if|if
condition|(
name|rightShift
operator|!=
literal|32
condition|)
block|{
name|bits
operator|=
operator|*
name|psrc
operator|++
expr_stmt|;
name|tmp
operator||=
name|BitRight
argument_list|(
name|bits
argument_list|,
name|rightShift
argument_list|)
expr_stmt|;
block|}
name|EndStep
argument_list|(
name|pdst
argument_list|,
name|nl
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|nl
condition|)
block|{
case|case
literal|7
case|:
name|StoreBitsPlain
argument_list|(
operator|-
literal|7
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
case|case
literal|6
case|:
name|StoreBitsPlain
argument_list|(
operator|-
literal|6
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
case|case
literal|5
case|:
name|StoreBitsPlain
argument_list|(
operator|-
literal|5
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
case|case
literal|4
case|:
name|StoreBitsPlain
argument_list|(
operator|-
literal|4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
case|case
literal|3
case|:
name|StoreBitsPlain
argument_list|(
operator|-
literal|3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
case|case
literal|2
case|:
name|StoreBitsPlain
argument_list|(
operator|-
literal|2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
case|case
literal|1
case|:
name|StoreBitsPlain
argument_list|(
operator|-
literal|1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
operator|*
name|pdst
operator|=
operator|*
name|pdst
operator|&
operator|~
name|endmask
operator||
name|GetFourPixels
argument_list|(
name|tmp
argument_list|)
operator|&
name|endmask
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
while|while
condition|(
name|height
operator|--
condition|)
block|{
name|psrc
operator|=
name|psrcLine
expr_stmt|;
name|pdst
operator|=
name|pdstLine
expr_stmt|;
name|psrcLine
operator|+=
name|widthSrc
expr_stmt|;
name|pdstLine
operator|+=
name|widthDst
expr_stmt|;
name|bits
operator|=
operator|*
name|psrc
operator|++
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
if|if
condition|(
name|firstoff
operator|<
literal|0
condition|)
name|tmp
operator|=
name|BitRight
argument_list|(
name|bits
argument_list|,
operator|-
name|firstoff
argument_list|)
expr_stmt|;
else|else
block|{
name|tmp
operator|=
name|BitLeft
argument_list|(
name|bits
argument_list|,
name|firstoff
argument_list|)
expr_stmt|;
if|if
condition|(
name|firstoff
operator|>=
literal|28
condition|)
block|{
name|bits
operator|=
operator|*
name|psrc
operator|++
expr_stmt|;
if|if
condition|(
name|firstoff
operator|!=
literal|28
condition|)
name|tmp
operator||=
name|BitRight
argument_list|(
name|bits
argument_list|,
name|secondoff
argument_list|)
expr_stmt|;
block|}
block|}
name|src
operator|=
name|GetFourBits
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
operator|*
name|pdst
operator|=
name|MaskRRopPixels
argument_list|(
operator|*
name|pdst
argument_list|,
name|src
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
block|}
name|nl
operator|=
name|nlMiddle
expr_stmt|;
while|while
condition|(
name|nl
operator|>=
literal|8
condition|)
block|{
name|nl
operator|-=
literal|8
expr_stmt|;
name|tmp
operator|=
name|BitLeft
argument_list|(
name|bits
argument_list|,
name|leftShift
argument_list|)
expr_stmt|;
name|bits
operator|=
operator|*
name|psrc
operator|++
expr_stmt|;
if|if
condition|(
name|rightShift
operator|!=
literal|32
condition|)
name|tmp
operator||=
name|BitRight
argument_list|(
name|bits
argument_list|,
name|rightShift
argument_list|)
expr_stmt|;
name|StoreRopBits0
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|FirstStep
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreRopBits
argument_list|(
literal|1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreRopBits
argument_list|(
literal|2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreRopBits
argument_list|(
literal|3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreRopBits
argument_list|(
literal|4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreRopBits
argument_list|(
literal|5
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreRopBits
argument_list|(
literal|6
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Step
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|StoreRopBits
argument_list|(
literal|7
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|EndStep
argument_list|(
name|pdst
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nl
operator|||
name|endmask
condition|)
block|{
name|tmp
operator|=
name|BitLeft
argument_list|(
name|bits
argument_list|,
name|leftShift
argument_list|)
expr_stmt|;
comment|/* 		     * better condition needed -- mustn't run 		     * off the end of the source... 		     */
if|if
condition|(
name|rightShift
operator|!=
literal|32
condition|)
block|{
name|bits
operator|=
operator|*
name|psrc
operator|++
expr_stmt|;
name|tmp
operator||=
name|BitRight
argument_list|(
name|bits
argument_list|,
name|rightShift
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|nl
operator|--
condition|)
block|{
name|src
operator|=
name|GetFourBits
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
operator|*
name|pdst
operator|=
name|RRopPixels
argument_list|(
operator|*
name|pdst
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
name|NextFourBits
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
name|src
operator|=
name|GetFourBits
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
operator|*
name|pdst
operator|=
name|MaskRRopPixels
argument_list|(
operator|*
name|pdst
argument_list|,
name|src
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|RegionPtr
name|cfbCopyPlane
parameter_list|(
name|pSrcDrawable
parameter_list|,
name|pDstDrawable
parameter_list|,
name|pGC
parameter_list|,
name|srcx
parameter_list|,
name|srcy
parameter_list|,
name|width
parameter_list|,
name|height
parameter_list|,
name|dstx
parameter_list|,
name|dsty
parameter_list|,
name|bitPlane
parameter_list|)
name|DrawablePtr
name|pSrcDrawable
decl_stmt|;
name|DrawablePtr
name|pDstDrawable
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|srcx
decl_stmt|,
name|srcy
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|dstx
decl_stmt|,
name|dsty
decl_stmt|;
name|unsigned
name|long
name|bitPlane
decl_stmt|;
block|{
name|RegionPtr
name|ret
decl_stmt|;
specifier|extern
name|RegionPtr
name|miHandleExposures
parameter_list|()
function_decl|;
name|int
function_decl|(
modifier|*
name|doBitBlt
function_decl|)
parameter_list|()
function_decl|;
if|#
directive|if
operator|(
name|PPW
operator|==
literal|4
operator|)
extern|extern cfbCopyPlane8to1(
block|)
function|;
end_function

begin_if
if|if
condition|(
name|pSrcDrawable
operator|->
name|bitsPerPixel
operator|==
literal|1
operator|&&
name|pDstDrawable
operator|->
name|bitsPerPixel
operator|==
literal|8
condition|)
block|{
if|if
condition|(
name|bitPlane
operator|==
literal|1
condition|)
block|{
name|doBitBlt
operator|=
name|cfbCopyPlane1to8
expr_stmt|;
name|cfb8CheckOpaqueStipple
argument_list|(
name|pGC
operator|->
name|alu
argument_list|,
name|pGC
operator|->
name|fgPixel
argument_list|,
name|pGC
operator|->
name|bgPixel
argument_list|,
name|pGC
operator|->
name|planemask
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cfbBitBlt
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|pGC
argument_list|,
name|srcx
argument_list|,
name|srcy
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|dstx
argument_list|,
name|dsty
argument_list|,
name|doBitBlt
argument_list|,
name|bitPlane
argument_list|)
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|miHandleExposures
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|pGC
argument_list|,
name|srcx
argument_list|,
name|srcy
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|dstx
argument_list|,
name|dsty
argument_list|,
name|bitPlane
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pSrcDrawable
operator|->
name|bitsPerPixel
operator|==
literal|8
operator|&&
name|pDstDrawable
operator|->
name|bitsPerPixel
operator|==
literal|1
condition|)
block|{
specifier|extern
name|int
name|InverseAlu
index|[
literal|16
index|]
decl_stmt|;
name|int
name|oldalu
decl_stmt|;
name|oldalu
operator|=
name|pGC
operator|->
name|alu
expr_stmt|;
if|if
condition|(
operator|(
name|pGC
operator|->
name|fgPixel
operator|&
literal|1
operator|)
operator|==
literal|0
operator|&&
operator|(
name|pGC
operator|->
name|bgPixel
operator|&
literal|1
operator|)
operator|==
literal|1
condition|)
name|pGC
operator|->
name|alu
operator|=
name|InverseAlu
index|[
name|pGC
operator|->
name|alu
index|]
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|pGC
operator|->
name|fgPixel
operator|&
literal|1
operator|)
operator|==
operator|(
name|pGC
operator|->
name|bgPixel
operator|&
literal|1
operator|)
condition|)
name|pGC
operator|->
name|alu
operator|=
name|mfbReduceRop
argument_list|(
name|pGC
operator|->
name|alu
argument_list|,
name|pGC
operator|->
name|fgPixel
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cfbBitBlt
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|pGC
argument_list|,
name|srcx
argument_list|,
name|srcy
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|dstx
argument_list|,
name|dsty
argument_list|,
name|cfbCopyPlane8to1
argument_list|,
name|bitPlane
argument_list|)
expr_stmt|;
name|pGC
operator|->
name|alu
operator|=
name|oldalu
expr_stmt|;
block|}
else|else
block|{
name|PixmapPtr
name|pBitmap
decl_stmt|;
name|ScreenPtr
name|pScreen
init|=
name|pSrcDrawable
operator|->
name|pScreen
decl_stmt|;
name|GCPtr
name|pGC1
decl_stmt|;
name|unsigned
name|long
name|fg
decl_stmt|,
name|bg
decl_stmt|;
name|pBitmap
operator|=
call|(
modifier|*
name|pScreen
operator|->
name|CreatePixmap
call|)
argument_list|(
name|pScreen
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pBitmap
condition|)
return|return
name|NULL
return|;
name|pGC1
operator|=
name|GetScratchGC
argument_list|(
literal|1
argument_list|,
name|pScreen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pGC1
condition|)
block|{
call|(
modifier|*
name|pScreen
operator|->
name|DestroyPixmap
call|)
argument_list|(
name|pBitmap
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	 * don't need to set pGC->fgPixel,bgPixel as copyPlane8to1 	 * ignores pixel values, expecting the rop to "do the 	 * right thing", which GXcopy will. 	 */
name|ValidateGC
argument_list|(
operator|(
name|DrawablePtr
operator|)
name|pBitmap
argument_list|,
name|pGC1
argument_list|)
expr_stmt|;
comment|/* no exposures here, scratch GC's don't get graphics expose */
operator|(
name|void
operator|)
name|cfbBitBlt
argument_list|(
name|pSrcDrawable
argument_list|,
operator|(
name|DrawablePtr
operator|)
name|pBitmap
argument_list|,
name|pGC1
argument_list|,
name|srcx
argument_list|,
name|srcy
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|cfbCopyPlane8to1
argument_list|,
name|bitPlane
argument_list|)
expr_stmt|;
name|cfb8CheckOpaqueStipple
argument_list|(
name|pGC
operator|->
name|alu
argument_list|,
name|pGC
operator|->
name|fgPixel
argument_list|,
name|pGC
operator|->
name|bgPixel
argument_list|,
name|pGC
operator|->
name|planemask
argument_list|)
expr_stmt|;
comment|/* no exposures here, copy bits from inside a pixmap */
operator|(
name|void
operator|)
name|cfbBitBlt
argument_list|(
operator|(
name|DrawablePtr
operator|)
name|pBitmap
argument_list|,
name|pDstDrawable
argument_list|,
name|pGC
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|dstx
argument_list|,
name|dsty
argument_list|,
name|cfbCopyPlane1to8
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|FreeScratchGC
argument_list|(
name|pGC1
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pScreen
operator|->
name|DestroyPixmap
call|)
argument_list|(
name|pBitmap
argument_list|)
expr_stmt|;
comment|/* compute resultant exposures */
name|ret
operator|=
name|miHandleExposures
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|pGC
argument_list|,
name|srcx
argument_list|,
name|srcy
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|dstx
argument_list|,
name|dsty
argument_list|,
name|bitPlane
argument_list|)
expr_stmt|;
block|}
end_if

begin_return
return|return
name|ret
return|;
end_return

begin_else
else|#
directive|else
end_else

begin_return
return|return
name|miCopyPlane
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|pGC
argument_list|,
name|srcx
argument_list|,
name|srcy
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|dstx
argument_list|,
name|dsty
argument_list|,
name|bitPlane
argument_list|)
return|;
end_return

begin_endif
endif|#
directive|endif
end_endif

unit|}
end_unit


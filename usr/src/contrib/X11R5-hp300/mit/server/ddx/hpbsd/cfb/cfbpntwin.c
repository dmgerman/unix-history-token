begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*********************************************************** Copyright 1987 by Digital Equipment Corporation, Maynard, Massachusetts, and the Massachusetts Institute of Technology, Cambridge, Massachusetts.                          All Rights Reserved  Permission to use, copy, modify, and distribute this software and its  documentation for any purpose and without fee is hereby granted,  provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in  supporting documentation, and that the names of Digital or MIT not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.    DIGITAL DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL DIGITAL BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  ******************************************************************/
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"regionstr.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"cfb.h"
end_include

begin_include
include|#
directive|include
file|"cfbmskbits.h"
end_include

begin_decl_stmt
specifier|static
name|void
name|cfbPaintArea32
argument_list|()
decl_stmt|,
name|cfbPaintAreaSolid
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|void
name|miPaintWindow
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|void
name|cfbPaintWindow
parameter_list|(
name|pWin
parameter_list|,
name|pRegion
parameter_list|,
name|what
parameter_list|)
name|WindowPtr
name|pWin
decl_stmt|;
name|RegionPtr
name|pRegion
decl_stmt|;
name|int
name|what
decl_stmt|;
block|{
specifier|register
name|cfbPrivWin
modifier|*
name|pPrivWin
decl_stmt|;
name|pPrivWin
operator|=
operator|(
name|cfbPrivWin
operator|*
operator|)
operator|(
name|pWin
operator|->
name|devPrivates
index|[
name|cfbWindowPrivateIndex
index|]
operator|.
name|ptr
operator|)
expr_stmt|;
switch|switch
condition|(
name|what
condition|)
block|{
case|case
name|PW_BACKGROUND
case|:
switch|switch
condition|(
name|pWin
operator|->
name|backgroundState
condition|)
block|{
case|case
name|None
case|:
return|return;
case|case
name|ParentRelative
case|:
do|do
block|{
name|pWin
operator|=
name|pWin
operator|->
name|parent
expr_stmt|;
block|}
do|while
condition|(
name|pWin
operator|->
name|backgroundState
operator|==
name|ParentRelative
condition|)
do|;
call|(
modifier|*
name|pWin
operator|->
name|drawable
operator|.
name|pScreen
operator|->
name|PaintWindowBackground
call|)
argument_list|(
name|pWin
argument_list|,
name|pRegion
argument_list|,
name|what
argument_list|)
expr_stmt|;
return|return;
case|case
name|BackgroundPixmap
case|:
if|if
condition|(
name|pPrivWin
operator|->
name|fastBackground
condition|)
block|{
name|cfbFillBoxTile32
argument_list|(
operator|(
name|DrawablePtr
operator|)
name|pWin
argument_list|,
operator|(
name|int
operator|)
name|REGION_NUM_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|REGION_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|pPrivWin
operator|->
name|pRotatedBackground
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|cfbFillBoxTileOdd
argument_list|(
operator|(
name|DrawablePtr
operator|)
name|pWin
argument_list|,
operator|(
name|int
operator|)
name|REGION_NUM_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|REGION_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|pWin
operator|->
name|background
operator|.
name|pixmap
argument_list|,
operator|(
name|int
operator|)
name|pWin
operator|->
name|drawable
operator|.
name|x
argument_list|,
operator|(
name|int
operator|)
name|pWin
operator|->
name|drawable
operator|.
name|y
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|BackgroundPixel
case|:
name|cfbFillBoxSolid
argument_list|(
operator|(
name|DrawablePtr
operator|)
name|pWin
argument_list|,
operator|(
name|int
operator|)
name|REGION_NUM_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|REGION_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|pWin
operator|->
name|background
operator|.
name|pixel
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|PW_BORDER
case|:
if|if
condition|(
name|pWin
operator|->
name|borderIsPixel
condition|)
block|{
name|cfbFillBoxSolid
argument_list|(
operator|(
name|DrawablePtr
operator|)
name|pWin
argument_list|,
operator|(
name|int
operator|)
name|REGION_NUM_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|REGION_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|pWin
operator|->
name|border
operator|.
name|pixel
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|pPrivWin
operator|->
name|fastBorder
condition|)
block|{
name|cfbFillBoxTile32
argument_list|(
operator|(
name|DrawablePtr
operator|)
name|pWin
argument_list|,
operator|(
name|int
operator|)
name|REGION_NUM_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|REGION_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|pPrivWin
operator|->
name|pRotatedBorder
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|pWin
operator|->
name|border
operator|.
name|pixmap
operator|->
name|drawable
operator|.
name|width
operator|>=
name|PPW
operator|/
literal|2
condition|)
block|{
name|cfbFillBoxTileOdd
argument_list|(
operator|(
name|DrawablePtr
operator|)
name|pWin
argument_list|,
operator|(
name|int
operator|)
name|REGION_NUM_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|REGION_RECTS
argument_list|(
name|pRegion
argument_list|)
argument_list|,
name|pWin
operator|->
name|border
operator|.
name|pixmap
argument_list|,
operator|(
name|int
operator|)
name|pWin
operator|->
name|drawable
operator|.
name|x
argument_list|,
operator|(
name|int
operator|)
name|pWin
operator|->
name|drawable
operator|.
name|y
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
name|miPaintWindow
argument_list|(
name|pWin
argument_list|,
name|pRegion
argument_list|,
name|what
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Use the RROP macros in copy mode  */
end_comment

begin_define
define|#
directive|define
name|RROP
value|GXcopy
end_define

begin_include
include|#
directive|include
file|"cfbrrop.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|RROP_UNROLL
end_ifdef

begin_define
define|#
directive|define
name|Expand
parameter_list|(
name|left
parameter_list|,
name|right
parameter_list|,
name|leftAdjust
parameter_list|)
value|{\     int part = nmiddle& RROP_UNROLL_MASK; \     int widthStep; \     widthStep = widthDst - nmiddle - leftAdjust; \     nmiddle>>= RROP_UNROLL_SHIFT; \     while (h--) { \ 	left \ 	pdst += part; \ 	switch (part) { \ 	    RROP_UNROLL_CASE(pdst) \ 	} \ 	m = nmiddle; \ 	while (m) { \ 	    pdst += RROP_UNROLL; \ 	    RROP_UNROLL_LOOP(pdst) \ 	    m--; \ 	} \ 	right \ 	pdst += widthStep; \     } \ }
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|Expand
parameter_list|(
name|left
parameter_list|,
name|right
parameter_list|,
name|leftAdjust
parameter_list|)
value|{ \     int widthStep; \     widthStep = widthDst - nmiddle - leftAdjust; \     while (h--) { \ 	left \ 	m = nmiddle; \ 	while (m--) {\ 	    RROP_SOLID(pdst); \ 	    pdst++; \ 	} \ 	right \ 	pdst += widthStep; \     } \ }
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|cfbFillBoxSolid
parameter_list|(
name|pDrawable
parameter_list|,
name|nBox
parameter_list|,
name|pBox
parameter_list|,
name|pixel
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|int
name|nBox
decl_stmt|;
name|BoxPtr
name|pBox
decl_stmt|;
name|unsigned
name|long
name|pixel
decl_stmt|;
block|{
name|unsigned
name|long
modifier|*
name|pdstBase
decl_stmt|;
name|int
name|widthDst
decl_stmt|;
specifier|register
name|int
name|h
decl_stmt|;
specifier|register
name|unsigned
name|long
name|rrop_xor
decl_stmt|;
specifier|register
name|unsigned
name|long
modifier|*
name|pdst
decl_stmt|;
specifier|register
name|unsigned
name|long
name|leftMask
decl_stmt|,
name|rightMask
decl_stmt|;
name|int
name|nmiddle
decl_stmt|;
specifier|register
name|int
name|m
decl_stmt|;
name|int
name|w
decl_stmt|;
name|cfbGetLongWidthAndPointer
argument_list|(
name|pDrawable
argument_list|,
name|widthDst
argument_list|,
name|pdstBase
argument_list|)
expr_stmt|;
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
name|rrop_xor
operator|=
name|PFILL
argument_list|(
name|pixel
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|nBox
condition|;
name|nBox
operator|--
operator|,
name|pBox
operator|++
control|)
block|{
name|pdst
operator|=
name|pdstBase
operator|+
name|pBox
operator|->
name|y1
operator|*
name|widthDst
expr_stmt|;
name|h
operator|=
name|pBox
operator|->
name|y2
operator|-
name|pBox
operator|->
name|y1
expr_stmt|;
name|w
operator|=
name|pBox
operator|->
name|x2
operator|-
name|pBox
operator|->
name|x1
expr_stmt|;
if|#
directive|if
name|PPW
operator|==
literal|4
if|if
condition|(
name|w
operator|==
literal|1
condition|)
block|{
specifier|register
name|char
modifier|*
name|pdstb
init|=
operator|(
operator|(
name|char
operator|*
operator|)
name|pdst
operator|)
operator|+
name|pBox
operator|->
name|x1
decl_stmt|;
name|int
name|incr
init|=
name|widthDst
operator|<<
literal|2
decl_stmt|;
while|while
condition|(
name|h
operator|--
condition|)
block|{
operator|*
name|pdstb
operator|=
name|rrop_xor
expr_stmt|;
name|pdstb
operator|+=
name|incr
expr_stmt|;
block|}
block|}
else|else
block|{
endif|#
directive|endif
name|pdst
operator|+=
operator|(
name|pBox
operator|->
name|x1
operator|>>
name|PWSH
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|pBox
operator|->
name|x1
operator|&
name|PIM
operator|)
operator|+
name|w
operator|<=
name|PPW
condition|)
block|{
name|maskpartialbits
argument_list|(
name|pBox
operator|->
name|x1
argument_list|,
name|w
argument_list|,
name|leftMask
argument_list|)
expr_stmt|;
while|while
condition|(
name|h
operator|--
condition|)
block|{
operator|*
name|pdst
operator|=
operator|(
operator|*
name|pdst
operator|&
operator|~
name|leftMask
operator|)
operator||
operator|(
name|rrop_xor
operator|&
name|leftMask
operator|)
expr_stmt|;
name|pdst
operator|+=
name|widthDst
expr_stmt|;
block|}
block|}
else|else
block|{
name|maskbits
argument_list|(
name|pBox
operator|->
name|x1
argument_list|,
name|w
argument_list|,
name|leftMask
argument_list|,
name|rightMask
argument_list|,
name|nmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|leftMask
condition|)
block|{
if|if
condition|(
name|rightMask
condition|)
block|{
name|Expand
argument_list|(
argument|RROP_SOLID_MASK (pdst, leftMask); pdst++;
argument_list|,
argument|RROP_SOLID_MASK (pdst, rightMask);
argument_list|,
literal|1
argument_list|)
block|}
else|else
block|{
name|Expand
argument_list|(
argument|RROP_SOLID_MASK (pdst, leftMask); pdst++;
argument_list|,
argument|;
argument_list|,
literal|1
argument_list|)
block|}
block|}
else|else
block|{
if|if
condition|(
name|rightMask
condition|)
block|{
name|Expand
argument_list|(
argument|;
argument_list|,
argument|RROP_SOLID_MASK (pdst, rightMask);
argument_list|,
literal|0
argument_list|)
block|}
else|else
block|{
name|Expand
argument_list|(
argument|;
argument_list|,
argument|;
argument_list|,
literal|0
argument_list|)
block|}
block|}
block|}
if|#
directive|if
name|PPW
operator|==
literal|4
block|}
endif|#
directive|endif
block|}
block|}
end_function

begin_function
name|void
name|cfbFillBoxTile32
parameter_list|(
name|pDrawable
parameter_list|,
name|nBox
parameter_list|,
name|pBox
parameter_list|,
name|tile
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|int
name|nBox
decl_stmt|;
comment|/* number of boxes to fill */
name|BoxPtr
name|pBox
decl_stmt|;
comment|/* pointer to list of boxes to fill */
name|PixmapPtr
name|tile
decl_stmt|;
comment|/* rotated, expanded tile */
block|{
specifier|register
name|unsigned
name|long
name|rrop_xor
decl_stmt|;
specifier|register
name|unsigned
name|long
modifier|*
name|pdst
decl_stmt|;
specifier|register
name|int
name|m
decl_stmt|;
name|int
modifier|*
name|psrc
decl_stmt|;
name|int
name|tileHeight
decl_stmt|;
name|int
name|widthDst
decl_stmt|;
name|int
name|widthSrc
decl_stmt|;
name|int
name|w
decl_stmt|;
name|int
name|h
decl_stmt|;
specifier|register
name|unsigned
name|long
name|leftMask
decl_stmt|;
specifier|register
name|unsigned
name|long
name|rightMask
decl_stmt|;
name|int
name|nmiddle
decl_stmt|;
name|int
name|y
decl_stmt|;
name|int
name|srcy
decl_stmt|;
name|unsigned
name|long
modifier|*
name|pdstBase
decl_stmt|;
name|psrc
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
operator|(
operator|(
name|hpPrivPixmapPtr
operator|)
name|tile
operator|->
name|devPrivate
operator|.
name|ptr
operator|)
operator|->
name|bits
operator|)
expr_stmt|;
name|widthSrc
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
operator|(
name|hpPrivPixmapPtr
operator|)
name|tile
operator|->
name|devPrivate
operator|.
name|ptr
operator|)
operator|->
name|stride
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|tileHeight
operator|=
name|tile
operator|->
name|drawable
operator|.
name|height
operator|*
name|widthSrc
expr_stmt|;
name|cfbGetLongWidthAndPointer
argument_list|(
name|pDrawable
argument_list|,
name|widthDst
argument_list|,
name|pdstBase
argument_list|)
expr_stmt|;
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
if|if
condition|(
name|tile
operator|->
name|devKind
operator|==
name|PIXMAP_FRAME_BUFFER
condition|)
name|WAIT_READY_TO_RENDER
argument_list|(
name|tile
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
expr_stmt|;
while|while
condition|(
name|nBox
operator|--
condition|)
block|{
name|w
operator|=
name|pBox
operator|->
name|x2
operator|-
name|pBox
operator|->
name|x1
expr_stmt|;
name|h
operator|=
name|pBox
operator|->
name|y2
operator|-
name|pBox
operator|->
name|y1
expr_stmt|;
name|y
operator|=
name|pBox
operator|->
name|y1
expr_stmt|;
name|pdst
operator|=
name|pdstBase
operator|+
operator|(
name|pBox
operator|->
name|y1
operator|*
name|widthDst
operator|)
operator|+
operator|(
name|pBox
operator|->
name|x1
operator|>>
name|PWSH
operator|)
expr_stmt|;
name|srcy
operator|=
operator|(
name|y
operator|*
name|widthSrc
operator|)
operator|%
name|tileHeight
expr_stmt|;
define|#
directive|define
name|StepTile
value|rrop_xor = psrc[srcy]; \ 		    srcy += widthSrc; \ 		    if (srcy == tileHeight) \ 		        srcy = 0;
if|if
condition|(
operator|(
operator|(
name|pBox
operator|->
name|x1
operator|&
name|PIM
operator|)
operator|+
name|w
operator|)
operator|<
name|PPW
condition|)
block|{
name|maskpartialbits
argument_list|(
name|pBox
operator|->
name|x1
argument_list|,
name|w
argument_list|,
name|leftMask
argument_list|)
expr_stmt|;
name|rightMask
operator|=
operator|~
name|leftMask
expr_stmt|;
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|StepTile
modifier|*
name|pdst
init|=
operator|(
operator|*
name|pdst
operator|&
name|rightMask
operator|)
operator||
operator|(
name|rrop_xor
operator|&
name|leftMask
operator|)
decl_stmt|;
name|pdst
operator|+=
name|widthDst
expr_stmt|;
block|}
block|}
else|else
block|{
name|maskbits
argument_list|(
name|pBox
operator|->
name|x1
argument_list|,
name|w
argument_list|,
name|leftMask
argument_list|,
name|rightMask
argument_list|,
name|nmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|leftMask
condition|)
block|{
if|if
condition|(
name|rightMask
condition|)
block|{
name|Expand
argument_list|(
argument|StepTile 			    RROP_SOLID_MASK(pdst, leftMask); pdst++;
argument_list|,
argument|RROP_SOLID_MASK(pdst, rightMask);
argument_list|,
literal|1
argument_list|)
block|}
else|else
block|{
name|Expand
argument_list|(
argument|StepTile 			    RROP_SOLID_MASK(pdst, leftMask); pdst++;
argument_list|,
argument_list|,
literal|1
argument_list|)
block|}
block|}
else|else
block|{
if|if
condition|(
name|rightMask
condition|)
block|{
name|Expand
argument_list|(
argument|StepTile
argument_list|,
argument|RROP_SOLID_MASK(pdst, rightMask);
argument_list|,
literal|0
argument_list|)
block|}
else|else
block|{
name|Expand
argument_list|(
argument|StepTile
argument_list|,
argument_list|,
literal|0
argument_list|)
block|}
block|}
block|}
name|pBox
operator|++
expr_stmt|;
block|}
block|}
end_function

end_unit


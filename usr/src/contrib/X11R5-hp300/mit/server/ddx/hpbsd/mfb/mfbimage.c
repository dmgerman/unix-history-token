begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*********************************************************** Copyright 1987 by Digital Equipment Corporation, Maynard, Massachusetts, and the Massachusetts Institute of Technology, Cambridge, Massachusetts.                          All Rights Reserved  Permission to use, copy, modify, and distribute this software and its  documentation for any purpose and without fee is hereby granted,  provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in  supporting documentation, and that the names of Digital or MIT not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.    DIGITAL DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL DIGITAL BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  ******************************************************************/
end_comment

begin_comment
comment|/* $XConsortium: mfbimage.c,v 5.3 89/09/14 16:26:42 rws Exp $ */
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"gcstruct.h"
end_include

begin_include
include|#
directive|include
file|"mfb.h"
end_include

begin_include
include|#
directive|include
file|"mi.h"
end_include

begin_include
include|#
directive|include
file|"Xmd.h"
end_include

begin_include
include|#
directive|include
file|"maskbits.h"
end_include

begin_include
include|#
directive|include
file|"servermd.h"
end_include

begin_comment
comment|/* Put and Get images on a monochrome frame buffer  *  *   we do this by creating a temporary pixmap and making its  * pointer to bits point to the buffer read in from the client.  * this works because of the padding rules specified at startup  *  * Note that CopyArea must know how to copy a bitmap into the server-format  * temporary pixmap.  *  * For speed, mfbPutImage should allocate the temporary pixmap on the stack.  *  *     even though an XYBitmap and an XYPixmap have the same  * format (for this device), PutImage has different semantics for the  * two.  XYPixmap just does the copy; XYBitmap takes gc.fgPixel for  * a 1 bit, gc.bgPixel for a 0 bit, which we notice is exactly  * like CopyPlane.  *  *   written by drewry, september 1986  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
name|void
name|mfbPutImage
parameter_list|(
name|dst
parameter_list|,
name|pGC
parameter_list|,
name|depth
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|,
name|w
parameter_list|,
name|h
parameter_list|,
name|leftPad
parameter_list|,
name|format
parameter_list|,
name|pImage
parameter_list|)
name|DrawablePtr
name|dst
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|depth
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|int
name|leftPad
decl_stmt|;
name|unsigned
name|int
name|format
decl_stmt|;
name|int
modifier|*
name|pImage
decl_stmt|;
block|{
name|PixmapRec
name|FakePixmap
decl_stmt|;
name|hpPrivPixmap
name|FakePrivPixmap
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
comment|/* 0 may confuse CreatePixmap, and will sometimes be        passed by the mi text code     */
if|if
condition|(
operator|(
name|w
operator|==
literal|0
operator|)
operator|||
operator|(
name|h
operator|==
literal|0
operator|)
condition|)
return|return;
name|FakePixmap
operator|.
name|drawable
operator|.
name|type
operator|=
name|DRAWABLE_PIXMAP
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|class
operator|=
literal|0
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|pScreen
operator|=
name|dst
operator|->
name|pScreen
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|bitsPerPixel
operator|=
literal|1
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|id
operator|=
literal|0
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|serialNumber
operator|=
name|NEXT_SERIAL_NUMBER
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|width
operator|=
name|w
operator|+
name|leftPad
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|height
operator|=
name|h
expr_stmt|;
name|FakePixmap
operator|.
name|devKind
operator|=
name|PIXMAP_HOST_MEMORY
expr_stmt|;
name|FakePixmap
operator|.
name|refcnt
operator|=
literal|1
expr_stmt|;
name|FakePixmap
operator|.
name|devPrivate
operator|.
name|ptr
operator|=
operator|(
name|pointer
operator|)
operator|&
name|FakePrivPixmap
expr_stmt|;
name|FakePrivPixmap
operator|.
name|stride
operator|=
name|PixmapBytePad
argument_list|(
name|FakePixmap
operator|.
name|drawable
operator|.
name|width
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|FakePrivPixmap
operator|.
name|bits
operator|=
operator|(
name|pointer
operator|)
name|pImage
expr_stmt|;
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|fExpose
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|format
operator|!=
name|XYBitmap
condition|)
call|(
modifier|*
name|pGC
operator|->
name|ops
operator|->
name|CopyArea
call|)
argument_list|(
operator|&
name|FakePixmap
argument_list|,
name|dst
argument_list|,
name|pGC
argument_list|,
name|leftPad
argument_list|,
literal|0
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
else|else
call|(
modifier|*
name|pGC
operator|->
name|ops
operator|->
name|CopyPlane
call|)
argument_list|(
operator|&
name|FakePixmap
argument_list|,
name|dst
argument_list|,
name|pGC
argument_list|,
name|leftPad
argument_list|,
literal|0
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|fExpose
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * pdstLine points to space allocated by caller, which he can do since  * he knows dimensions of the pixmap  * we can call mfbDoBitblt because the dispatcher has promised not to send us  * anything that would require going over the edge of the screen.  *  *	XYPixmap and ZPixmap are the same for mfb.  *	For any planemask with bit 0 == 0, just fill the dst with 0.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
name|void
name|mfbGetImage
parameter_list|(
name|pDrawable
parameter_list|,
name|sx
parameter_list|,
name|sy
parameter_list|,
name|w
parameter_list|,
name|h
parameter_list|,
name|format
parameter_list|,
name|planeMask
parameter_list|,
name|pdstLine
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|int
name|sx
decl_stmt|,
name|sy
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|unsigned
name|int
name|format
decl_stmt|;
name|unsigned
name|long
name|planeMask
decl_stmt|;
name|pointer
name|pdstLine
decl_stmt|;
block|{
name|PixmapRec
name|FakePixmap
decl_stmt|;
name|hpPrivPixmap
name|FakePrivPixmap
decl_stmt|;
name|BoxRec
name|box
decl_stmt|;
name|DDXPointRec
name|ptSrc
decl_stmt|;
name|RegionRec
name|rgnDst
decl_stmt|;
if|if
condition|(
name|planeMask
operator|&
literal|0x1
condition|)
block|{
name|FakePixmap
operator|.
name|drawable
operator|.
name|type
operator|=
name|DRAWABLE_PIXMAP
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|class
operator|=
literal|0
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|pScreen
operator|=
name|pDrawable
operator|->
name|pScreen
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|bitsPerPixel
operator|=
literal|1
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|id
operator|=
literal|0
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|serialNumber
operator|=
name|NEXT_SERIAL_NUMBER
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|width
operator|=
name|w
expr_stmt|;
name|FakePixmap
operator|.
name|drawable
operator|.
name|height
operator|=
name|h
expr_stmt|;
name|FakePixmap
operator|.
name|devKind
operator|=
name|PIXMAP_HOST_MEMORY
expr_stmt|;
name|FakePixmap
operator|.
name|refcnt
operator|=
literal|1
expr_stmt|;
name|FakePixmap
operator|.
name|devPrivate
operator|.
name|ptr
operator|=
operator|(
name|pointer
operator|)
operator|&
name|FakePrivPixmap
expr_stmt|;
name|FakePrivPixmap
operator|.
name|stride
operator|=
name|PixmapBytePad
argument_list|(
name|w
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|FakePrivPixmap
operator|.
name|bits
operator|=
name|pdstLine
expr_stmt|;
name|ptSrc
operator|.
name|x
operator|=
name|sx
operator|+
name|pDrawable
operator|->
name|x
expr_stmt|;
name|ptSrc
operator|.
name|y
operator|=
name|sy
operator|+
name|pDrawable
operator|->
name|y
expr_stmt|;
name|box
operator|.
name|x1
operator|=
literal|0
expr_stmt|;
name|box
operator|.
name|y1
operator|=
literal|0
expr_stmt|;
name|box
operator|.
name|x2
operator|=
name|w
expr_stmt|;
name|box
operator|.
name|y2
operator|=
name|h
expr_stmt|;
call|(
modifier|*
name|pDrawable
operator|->
name|pScreen
operator|->
name|RegionInit
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|,
operator|&
name|box
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mfbDoBitblt
argument_list|(
name|pDrawable
argument_list|,
operator|(
name|DrawablePtr
operator|)
operator|&
name|FakePixmap
argument_list|,
name|GXcopy
argument_list|,
operator|&
name|rgnDst
argument_list|,
operator|&
name|ptSrc
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pDrawable
operator|->
name|pScreen
operator|->
name|RegionUninit
call|)
argument_list|(
operator|&
name|rgnDst
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pdstLine
argument_list|,
name|PixmapBytePad
argument_list|(
name|w
argument_list|,
literal|1
argument_list|)
operator|*
name|h
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


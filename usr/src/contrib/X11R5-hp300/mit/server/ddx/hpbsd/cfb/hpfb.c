begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  Copyright (c) 1986, 1987 by Hewlett-Packard Company Copyright (c) 1986, 1987 by the Massachusetts Institute of Technology  Permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  HEWLETT-PACKARD MAKES NO WARRANTY OF ANY KIND WITH REGARD TO THIS SOFWARE, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  PURPOSE.  Hewlett-Packard shall not be liable for errors  contained herein or direct, indirect, special, incidental or  consequential damages in connection with the furnishing,  performance, or use of this material.  This software is not subject to any license of the American Telephone and Telegraph Company or of the Regents of the University of California.  */
end_comment

begin_comment
comment|/*********************************************************** Copyright 1987 by Digital Equipment Corporation, Maynard, Massachusetts, and the Massachusetts Institute of Technology, Cambridge, Massachusetts.                          All Rights Reserved  Permission to use, copy, modify, and distribute this software and its  documentation for any purpose and without fee is hereby granted,  provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in  supporting documentation, and that the names of Digital or MIT not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.    DIGITAL DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL DIGITAL BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  ******************************************************************/
end_comment

begin_comment
comment|/* $XConsortium: hpfb.c,v 1.7 88/09/06 15:18:15 jim Exp $ */
end_comment

begin_comment
comment|/* Author: Todd Newman  (aided and abetted by Mr. Drewry) */
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xprotostr.h"
end_include

begin_include
include|#
directive|include
file|"misc.h"
end_include

begin_include
include|#
directive|include
file|"gcstruct.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"regionstr.h"
end_include

begin_include
include|#
directive|include
file|"servermd.h"
end_include

begin_include
include|#
directive|include
file|"cfb.h"
end_include

begin_comment
comment|/* DoBitblt() does multiple rectangle moves into the rectangles     we have to cope with the direction on a per band basis, rather than a per rectangle basis.  moving bottom to top means we have to invert the order of the bands; moving right to left requires reversing the order of the rectangles in each band.     if src or dst is a window, the points have already been translated. */
end_comment

begin_function
name|void
name|hpfbDoBitblt
parameter_list|(
name|pSrcDrawable
parameter_list|,
name|pDstDrawable
parameter_list|,
name|alu
parameter_list|,
name|prgnDst
parameter_list|,
name|pptSrc
parameter_list|,
name|planemask
parameter_list|)
name|DrawablePtr
name|pSrcDrawable
decl_stmt|;
name|DrawablePtr
name|pDstDrawable
decl_stmt|;
name|int
name|alu
decl_stmt|;
name|RegionPtr
name|prgnDst
decl_stmt|;
name|DDXPointPtr
name|pptSrc
decl_stmt|;
name|unsigned
name|long
name|planemask
decl_stmt|;
block|{
specifier|register
name|BoxPtr
name|pbox
decl_stmt|;
name|int
name|nbox
decl_stmt|;
name|BoxPtr
name|pboxTmp
decl_stmt|,
name|pboxNext
decl_stmt|,
name|pboxBase
decl_stmt|,
name|pboxNewY
decl_stmt|,
name|pboxNewX
decl_stmt|;
comment|/* temporaries for shuffling rectangles */
name|DDXPointPtr
name|pptTmp
decl_stmt|,
name|pptNewY
decl_stmt|,
name|pptNewX
decl_stmt|;
comment|/* shuffling boxes entails shuffling the 					   source points too */
name|int
name|w
decl_stmt|,
name|h
decl_stmt|;
name|void
function_decl|(
modifier|*
name|bitMover
function_decl|)
parameter_list|()
function_decl|;
comment|/* check whether we should use this routine... call cfb code if not. */
if|if
condition|(
operator|(
operator|(
name|pSrcDrawable
operator|->
name|type
operator|==
name|DRAWABLE_PIXMAP
operator|)
operator|&&
operator|(
operator|(
call|(
name|PixmapPtr
call|)
argument_list|(
name|pSrcDrawable
argument_list|)
operator|)
operator|->
name|devKind
operator|!=
name|PIXMAP_FRAME_BUFFER
operator|)
operator|)
operator|&&
operator|(
name|pSrcDrawable
operator|->
name|type
operator|!=
name|DRAWABLE_WINDOW
operator|)
condition|)
block|{
name|cfbDoBitblt
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|alu
argument_list|,
name|prgnDst
argument_list|,
name|pptSrc
argument_list|,
name|planemask
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
operator|(
name|pDstDrawable
operator|->
name|type
operator|==
name|DRAWABLE_PIXMAP
operator|)
operator|&&
operator|(
operator|(
call|(
name|PixmapPtr
call|)
argument_list|(
name|pDstDrawable
argument_list|)
operator|)
operator|->
name|devKind
operator|!=
name|PIXMAP_FRAME_BUFFER
operator|)
operator|)
operator|&&
operator|(
name|pDstDrawable
operator|->
name|type
operator|!=
name|DRAWABLE_WINDOW
operator|)
condition|)
block|{
name|cfbDoBitblt
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|alu
argument_list|,
name|prgnDst
argument_list|,
name|pptSrc
argument_list|,
name|planemask
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pSrcDrawable
operator|->
name|pScreen
operator|!=
name|pDstDrawable
operator|->
name|pScreen
condition|)
block|{
name|cfbDoBitblt
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|alu
argument_list|,
name|prgnDst
argument_list|,
name|pptSrc
argument_list|,
name|planemask
argument_list|)
expr_stmt|;
return|return;
block|}
name|pbox
operator|=
name|REGION_RECTS
argument_list|(
name|prgnDst
argument_list|)
expr_stmt|;
name|nbox
operator|=
name|REGION_NUM_RECTS
argument_list|(
name|prgnDst
argument_list|)
expr_stmt|;
name|pboxNewY
operator|=
literal|0
expr_stmt|;
name|pptNewY
operator|=
literal|0
expr_stmt|;
name|pboxNewX
operator|=
literal|0
expr_stmt|;
name|pptNewX
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pptSrc
operator|->
name|y
operator|<
name|pbox
operator|->
name|y1
condition|)
block|{
comment|/* walk source botttom to top */
if|if
condition|(
name|nbox
operator|>
literal|1
condition|)
block|{
comment|/* keep ordering in each band, reverse order of bands */
name|pboxNewY
operator|=
operator|(
name|BoxPtr
operator|)
name|ALLOCATE_LOCAL
argument_list|(
sizeof|sizeof
argument_list|(
name|BoxRec
argument_list|)
operator|*
name|nbox
argument_list|)
expr_stmt|;
name|pptNewY
operator|=
operator|(
name|DDXPointPtr
operator|)
name|ALLOCATE_LOCAL
argument_list|(
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
operator|*
name|nbox
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pboxNewY
operator|||
operator|!
name|pptNewY
condition|)
block|{
name|DEALLOCATE_LOCAL
argument_list|(
name|pptNewY
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pboxNewY
argument_list|)
expr_stmt|;
return|return;
block|}
name|pboxBase
operator|=
name|pboxNext
operator|=
name|pbox
operator|+
name|nbox
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|pboxBase
operator|>=
name|pbox
condition|)
block|{
while|while
condition|(
operator|(
name|pboxNext
operator|>=
name|pbox
operator|)
operator|&&
operator|(
name|pboxBase
operator|->
name|y1
operator|==
name|pboxNext
operator|->
name|y1
operator|)
condition|)
name|pboxNext
operator|--
expr_stmt|;
name|pboxTmp
operator|=
name|pboxNext
operator|+
literal|1
expr_stmt|;
name|pptTmp
operator|=
name|pptSrc
operator|+
operator|(
name|pboxTmp
operator|-
name|pbox
operator|)
expr_stmt|;
while|while
condition|(
name|pboxTmp
operator|<=
name|pboxBase
condition|)
block|{
operator|*
name|pboxNewY
operator|++
operator|=
operator|*
name|pboxTmp
operator|++
expr_stmt|;
operator|*
name|pptNewY
operator|++
operator|=
operator|*
name|pptTmp
operator|++
expr_stmt|;
block|}
name|pboxBase
operator|=
name|pboxNext
expr_stmt|;
block|}
name|pboxNewY
operator|-=
name|nbox
expr_stmt|;
name|pbox
operator|=
name|pboxNewY
expr_stmt|;
name|pptNewY
operator|-=
name|nbox
expr_stmt|;
name|pptSrc
operator|=
name|pptNewY
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pptSrc
operator|->
name|x
operator|<
name|pbox
operator|->
name|x1
condition|)
block|{
comment|/* walk source right to left */
if|if
condition|(
name|nbox
operator|>
literal|1
condition|)
block|{
comment|/* reverse order of rects in each band */
name|pboxNewX
operator|=
operator|(
name|BoxPtr
operator|)
name|ALLOCATE_LOCAL
argument_list|(
sizeof|sizeof
argument_list|(
name|BoxRec
argument_list|)
operator|*
name|nbox
argument_list|)
expr_stmt|;
name|pptNewX
operator|=
operator|(
name|DDXPointPtr
operator|)
name|ALLOCATE_LOCAL
argument_list|(
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
operator|*
name|nbox
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pboxNewX
operator|||
operator|!
name|pptNewX
condition|)
block|{
name|DEALLOCATE_LOCAL
argument_list|(
name|pptNewX
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pboxNewX
argument_list|)
expr_stmt|;
return|return;
block|}
name|pboxBase
operator|=
name|pboxNext
operator|=
name|pbox
expr_stmt|;
while|while
condition|(
name|pboxBase
operator|<
name|pbox
operator|+
name|nbox
condition|)
block|{
while|while
condition|(
operator|(
name|pboxNext
operator|<
name|pbox
operator|+
name|nbox
operator|)
operator|&&
operator|(
name|pboxNext
operator|->
name|y1
operator|==
name|pboxBase
operator|->
name|y1
operator|)
condition|)
name|pboxNext
operator|++
expr_stmt|;
name|pboxTmp
operator|=
name|pboxNext
expr_stmt|;
name|pptTmp
operator|=
name|pptSrc
operator|+
operator|(
name|pboxTmp
operator|-
name|pbox
operator|)
expr_stmt|;
while|while
condition|(
name|pboxTmp
operator|!=
name|pboxBase
condition|)
block|{
operator|*
name|pboxNewX
operator|++
operator|=
operator|*
operator|--
name|pboxTmp
expr_stmt|;
operator|*
name|pptNewX
operator|++
operator|=
operator|*
operator|--
name|pptTmp
expr_stmt|;
block|}
name|pboxBase
operator|=
name|pboxNext
expr_stmt|;
block|}
name|pboxNewX
operator|-=
name|nbox
expr_stmt|;
name|pbox
operator|=
name|pboxNewX
expr_stmt|;
name|pptNewX
operator|-=
name|nbox
expr_stmt|;
name|pptSrc
operator|=
name|pptNewX
expr_stmt|;
block|}
block|}
name|bitMover
operator|=
operator|(
call|(
name|hpPrivScreenPtr
call|)
argument_list|(
name|pSrcDrawable
operator|->
name|pScreen
operator|->
name|devPrivate
argument_list|)
operator|)
operator|->
name|MoveBits
expr_stmt|;
while|while
condition|(
name|nbox
operator|--
condition|)
block|{
name|w
operator|=
name|pbox
operator|->
name|x2
operator|-
name|pbox
operator|->
name|x1
expr_stmt|;
name|h
operator|=
name|pbox
operator|->
name|y2
operator|-
name|pbox
operator|->
name|y1
expr_stmt|;
call|(
modifier|*
name|bitMover
call|)
argument_list|(
name|pSrcDrawable
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|alu
argument_list|,
name|pptSrc
operator|->
name|x
argument_list|,
name|pptSrc
operator|->
name|y
argument_list|,
name|pbox
operator|->
name|x1
argument_list|,
name|pbox
operator|->
name|y1
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|pbox
operator|++
expr_stmt|;
name|pptSrc
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pptNewY
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptNewY
argument_list|)
expr_stmt|;
if|if
condition|(
name|pboxNewY
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pboxNewY
argument_list|)
expr_stmt|;
if|if
condition|(
name|pptNewX
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptNewX
argument_list|)
expr_stmt|;
if|if
condition|(
name|pboxNewX
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pboxNewX
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


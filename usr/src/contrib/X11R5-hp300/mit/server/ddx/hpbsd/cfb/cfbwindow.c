begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*********************************************************** Copyright 1987 by Digital Equipment Corporation, Maynard, Massachusetts, and the Massachusetts Institute of Technology, Cambridge, Massachusetts.                          All Rights Reserved  Permission to use, copy, modify, and distribute this software and its  documentation for any purpose and without fee is hereby granted,  provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in  supporting documentation, and that the names of Digital or MIT not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.    DIGITAL DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL DIGITAL BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  ******************************************************************/
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"cfb.h"
end_include

begin_include
include|#
directive|include
file|"mistruct.h"
end_include

begin_include
include|#
directive|include
file|"regionstr.h"
end_include

begin_include
include|#
directive|include
file|"cfbmskbits.h"
end_include

begin_decl_stmt
specifier|extern
name|WindowPtr
modifier|*
name|WindowTable
decl_stmt|;
end_decl_stmt

begin_function
name|Bool
name|cfbCreateWindow
parameter_list|(
name|pWin
parameter_list|)
name|WindowPtr
name|pWin
decl_stmt|;
block|{
name|cfbPrivWin
modifier|*
name|pPrivWin
decl_stmt|;
name|pPrivWin
operator|=
operator|(
name|cfbPrivWin
operator|*
operator|)
operator|(
name|pWin
operator|->
name|devPrivates
index|[
name|cfbWindowPrivateIndex
index|]
operator|.
name|ptr
operator|)
expr_stmt|;
name|pPrivWin
operator|->
name|pRotatedBorder
operator|=
name|NullPixmap
expr_stmt|;
name|pPrivWin
operator|->
name|pRotatedBackground
operator|=
name|NullPixmap
expr_stmt|;
name|pPrivWin
operator|->
name|fastBackground
operator|=
name|FALSE
expr_stmt|;
name|pPrivWin
operator|->
name|fastBorder
operator|=
name|FALSE
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|Bool
name|cfbDestroyWindow
parameter_list|(
name|pWin
parameter_list|)
name|WindowPtr
name|pWin
decl_stmt|;
block|{
name|cfbPrivWin
modifier|*
name|pPrivWin
decl_stmt|;
name|pPrivWin
operator|=
operator|(
name|cfbPrivWin
operator|*
operator|)
operator|(
name|pWin
operator|->
name|devPrivates
index|[
name|cfbWindowPrivateIndex
index|]
operator|.
name|ptr
operator|)
expr_stmt|;
if|if
condition|(
name|pPrivWin
operator|->
name|pRotatedBorder
condition|)
name|cfbDestroyPixmap
argument_list|(
name|pPrivWin
operator|->
name|pRotatedBorder
argument_list|)
expr_stmt|;
if|if
condition|(
name|pPrivWin
operator|->
name|pRotatedBackground
condition|)
name|cfbDestroyPixmap
argument_list|(
name|pPrivWin
operator|->
name|pRotatedBackground
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
name|Bool
name|cfbMapWindow
parameter_list|(
name|pWindow
parameter_list|)
name|WindowPtr
name|pWindow
decl_stmt|;
block|{
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/* (x, y) is the upper left corner of the window on the screen     do we really need to pass this?  (is it a;ready in pWin->absCorner?)    we only do the rotation for pixmaps that are 32 bits wide (padded or otherwise.)    cfbChangeWindowAttributes() has already put a copy of the pixmap in pPrivWin->pRotated* */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
name|Bool
name|cfbPositionWindow
parameter_list|(
name|pWin
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|)
name|WindowPtr
name|pWin
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
block|{
name|cfbPrivWin
modifier|*
name|pPrivWin
decl_stmt|;
name|int
name|setxy
init|=
literal|0
decl_stmt|;
name|pPrivWin
operator|=
operator|(
name|cfbPrivWin
operator|*
operator|)
operator|(
name|pWin
operator|->
name|devPrivates
index|[
name|cfbWindowPrivateIndex
index|]
operator|.
name|ptr
operator|)
expr_stmt|;
if|if
condition|(
name|pWin
operator|->
name|backgroundState
operator|==
name|BackgroundPixmap
operator|&&
name|pPrivWin
operator|->
name|fastBackground
condition|)
block|{
name|cfbXRotatePixmap
argument_list|(
name|pPrivWin
operator|->
name|pRotatedBackground
argument_list|,
name|pWin
operator|->
name|drawable
operator|.
name|x
operator|-
name|pPrivWin
operator|->
name|oldRotate
operator|.
name|x
argument_list|)
expr_stmt|;
name|cfbYRotatePixmap
argument_list|(
name|pPrivWin
operator|->
name|pRotatedBackground
argument_list|,
name|pWin
operator|->
name|drawable
operator|.
name|y
operator|-
name|pPrivWin
operator|->
name|oldRotate
operator|.
name|y
argument_list|)
expr_stmt|;
name|setxy
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pWin
operator|->
name|borderIsPixel
operator|&&
name|pPrivWin
operator|->
name|fastBorder
condition|)
block|{
name|cfbXRotatePixmap
argument_list|(
name|pPrivWin
operator|->
name|pRotatedBorder
argument_list|,
name|pWin
operator|->
name|drawable
operator|.
name|x
operator|-
name|pPrivWin
operator|->
name|oldRotate
operator|.
name|x
argument_list|)
expr_stmt|;
name|cfbYRotatePixmap
argument_list|(
name|pPrivWin
operator|->
name|pRotatedBorder
argument_list|,
name|pWin
operator|->
name|drawable
operator|.
name|y
operator|-
name|pPrivWin
operator|->
name|oldRotate
operator|.
name|y
argument_list|)
expr_stmt|;
name|setxy
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|setxy
condition|)
block|{
name|pPrivWin
operator|->
name|oldRotate
operator|.
name|x
operator|=
name|pWin
operator|->
name|drawable
operator|.
name|x
expr_stmt|;
name|pPrivWin
operator|->
name|oldRotate
operator|.
name|y
operator|=
name|pWin
operator|->
name|drawable
operator|.
name|y
expr_stmt|;
block|}
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
name|Bool
name|cfbUnmapWindow
parameter_list|(
name|pWindow
parameter_list|)
name|WindowPtr
name|pWindow
decl_stmt|;
block|{
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/* UNCLEAN!    this code calls the bitblt helper code directly.     cfbCopyWindow copies only the parts of the destination that are visible in the source. */
end_comment

begin_function
name|void
name|cfbCopyWindow
parameter_list|(
name|pWin
parameter_list|,
name|ptOldOrg
parameter_list|,
name|prgnSrc
parameter_list|)
name|WindowPtr
name|pWin
decl_stmt|;
name|DDXPointRec
name|ptOldOrg
decl_stmt|;
name|RegionPtr
name|prgnSrc
decl_stmt|;
block|{
name|DDXPointPtr
name|pptSrc
decl_stmt|;
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
name|RegionPtr
name|prgnDst
decl_stmt|;
specifier|register
name|BoxPtr
name|pbox
decl_stmt|;
specifier|register
name|int
name|dx
decl_stmt|,
name|dy
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|nbox
decl_stmt|;
name|WindowPtr
name|pwinRoot
decl_stmt|;
name|pwinRoot
operator|=
name|WindowTable
index|[
name|pWin
operator|->
name|drawable
operator|.
name|pScreen
operator|->
name|myNum
index|]
expr_stmt|;
name|prgnDst
operator|=
call|(
modifier|*
name|pWin
operator|->
name|drawable
operator|.
name|pScreen
operator|->
name|RegionCreate
call|)
argument_list|(
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dx
operator|=
name|ptOldOrg
operator|.
name|x
operator|-
name|pWin
operator|->
name|drawable
operator|.
name|x
expr_stmt|;
name|dy
operator|=
name|ptOldOrg
operator|.
name|y
operator|-
name|pWin
operator|->
name|drawable
operator|.
name|y
expr_stmt|;
call|(
modifier|*
name|pWin
operator|->
name|drawable
operator|.
name|pScreen
operator|->
name|TranslateRegion
call|)
argument_list|(
name|prgnSrc
argument_list|,
operator|-
name|dx
argument_list|,
operator|-
name|dy
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pWin
operator|->
name|drawable
operator|.
name|pScreen
operator|->
name|Intersect
call|)
argument_list|(
name|prgnDst
argument_list|,
operator|&
name|pWin
operator|->
name|borderClip
argument_list|,
name|prgnSrc
argument_list|)
expr_stmt|;
name|pbox
operator|=
name|REGION_RECTS
argument_list|(
name|prgnDst
argument_list|)
expr_stmt|;
name|nbox
operator|=
name|REGION_NUM_RECTS
argument_list|(
name|prgnDst
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pptSrc
operator|=
operator|(
name|DDXPointPtr
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|nbox
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
operator|)
condition|)
return|return;
name|ppt
operator|=
name|pptSrc
expr_stmt|;
for|for
control|(
name|i
operator|=
name|nbox
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
name|ppt
operator|++
operator|,
name|pbox
operator|++
control|)
block|{
name|ppt
operator|->
name|x
operator|=
name|pbox
operator|->
name|x1
operator|+
name|dx
expr_stmt|;
name|ppt
operator|->
name|y
operator|=
name|pbox
operator|->
name|y1
operator|+
name|dy
expr_stmt|;
block|}
name|hpfbDoBitblt
argument_list|(
operator|(
name|DrawablePtr
operator|)
name|pwinRoot
argument_list|,
operator|(
name|DrawablePtr
operator|)
name|pwinRoot
argument_list|,
name|GXcopy
argument_list|,
name|prgnDst
argument_list|,
name|pptSrc
argument_list|,
operator|~
literal|0L
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pptSrc
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pWin
operator|->
name|drawable
operator|.
name|pScreen
operator|->
name|RegionDestroy
call|)
argument_list|(
name|prgnDst
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* swap in correct PaintWindow* routine.  If we can use a fast output routine (i.e. the pixmap is paddable to 32 bits), also pre-rotate a copy of it in devPrivates[cfbWindowPrivateIndex].ptr. */
end_comment

begin_function
name|Bool
name|cfbChangeWindowAttributes
parameter_list|(
name|pWin
parameter_list|,
name|mask
parameter_list|)
name|WindowPtr
name|pWin
decl_stmt|;
name|unsigned
name|long
name|mask
decl_stmt|;
block|{
specifier|register
name|unsigned
name|long
name|index
decl_stmt|;
specifier|register
name|cfbPrivWin
modifier|*
name|pPrivWin
decl_stmt|;
name|int
name|width
decl_stmt|;
name|pPrivWin
operator|=
operator|(
name|cfbPrivWin
operator|*
operator|)
operator|(
name|pWin
operator|->
name|devPrivates
index|[
name|cfbWindowPrivateIndex
index|]
operator|.
name|ptr
operator|)
expr_stmt|;
while|while
condition|(
name|mask
condition|)
block|{
name|index
operator|=
name|lowbit
argument_list|(
name|mask
argument_list|)
expr_stmt|;
name|mask
operator|&=
operator|~
name|index
expr_stmt|;
switch|switch
condition|(
name|index
condition|)
block|{
case|case
name|CWBackPixmap
case|:
if|if
condition|(
name|pWin
operator|->
name|backgroundState
operator|==
name|None
condition|)
block|{
name|pPrivWin
operator|->
name|fastBackground
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pWin
operator|->
name|backgroundState
operator|==
name|ParentRelative
condition|)
block|{
name|pPrivWin
operator|->
name|fastBackground
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|width
operator|=
operator|(
name|pWin
operator|->
name|background
operator|.
name|pixmap
operator|->
name|drawable
operator|.
name|width
operator|*
name|PSZ
operator|)
operator|)
operator|<=
literal|32
operator|)
operator|&&
operator|!
operator|(
name|width
operator|&
operator|(
name|width
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|cfbCopyRotatePixmap
argument_list|(
name|pWin
operator|->
name|background
operator|.
name|pixmap
argument_list|,
operator|&
name|pPrivWin
operator|->
name|pRotatedBackground
argument_list|,
name|pWin
operator|->
name|drawable
operator|.
name|x
argument_list|,
name|pWin
operator|->
name|drawable
operator|.
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
name|pPrivWin
operator|->
name|pRotatedBackground
condition|)
block|{
name|pPrivWin
operator|->
name|fastBackground
operator|=
name|TRUE
expr_stmt|;
name|pPrivWin
operator|->
name|oldRotate
operator|.
name|x
operator|=
name|pWin
operator|->
name|drawable
operator|.
name|x
expr_stmt|;
name|pPrivWin
operator|->
name|oldRotate
operator|.
name|y
operator|=
name|pWin
operator|->
name|drawable
operator|.
name|y
expr_stmt|;
block|}
else|else
block|{
name|pPrivWin
operator|->
name|fastBackground
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
else|else
block|{
name|pPrivWin
operator|->
name|fastBackground
operator|=
name|FALSE
expr_stmt|;
block|}
break|break;
case|case
name|CWBackPixel
case|:
name|pPrivWin
operator|->
name|fastBackground
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
name|CWBorderPixmap
case|:
if|if
condition|(
operator|(
operator|(
name|width
operator|=
operator|(
name|pWin
operator|->
name|border
operator|.
name|pixmap
operator|->
name|drawable
operator|.
name|width
operator|*
name|PSZ
operator|)
operator|)
operator|<=
literal|32
operator|)
operator|&&
operator|!
operator|(
name|width
operator|&
operator|(
name|width
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|cfbCopyRotatePixmap
argument_list|(
name|pWin
operator|->
name|border
operator|.
name|pixmap
argument_list|,
operator|&
name|pPrivWin
operator|->
name|pRotatedBorder
argument_list|,
name|pWin
operator|->
name|drawable
operator|.
name|x
argument_list|,
name|pWin
operator|->
name|drawable
operator|.
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
name|pPrivWin
operator|->
name|pRotatedBorder
condition|)
block|{
name|pPrivWin
operator|->
name|fastBorder
operator|=
name|TRUE
expr_stmt|;
name|pPrivWin
operator|->
name|oldRotate
operator|.
name|x
operator|=
name|pWin
operator|->
name|drawable
operator|.
name|x
expr_stmt|;
name|pPrivWin
operator|->
name|oldRotate
operator|.
name|y
operator|=
name|pWin
operator|->
name|drawable
operator|.
name|y
expr_stmt|;
block|}
else|else
block|{
name|pPrivWin
operator|->
name|fastBorder
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
else|else
block|{
name|pPrivWin
operator|->
name|fastBorder
operator|=
name|FALSE
expr_stmt|;
block|}
break|break;
case|case
name|CWBorderPixel
case|:
name|pPrivWin
operator|->
name|fastBorder
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

end_unit


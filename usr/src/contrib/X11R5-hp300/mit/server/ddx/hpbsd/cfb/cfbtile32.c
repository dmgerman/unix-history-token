begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Fill 32 bit tiled rectangles.  Used by both PolyFillRect and PaintWindow.  * no depth dependencies.  */
end_comment

begin_comment
comment|/* Copyright 1989 by the Massachusetts Institute of Technology  Permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty. */
end_comment

begin_comment
comment|/* $XConsortium: cfbtile32.c,v 1.5 91/07/14 13:49:46 keith Exp $ */
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xmd.h"
end_include

begin_include
include|#
directive|include
file|"servermd.h"
end_include

begin_include
include|#
directive|include
file|"gcstruct.h"
end_include

begin_include
include|#
directive|include
file|"window.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"cfb.h"
end_include

begin_include
include|#
directive|include
file|"cfbmskbits.h"
end_include

begin_include
include|#
directive|include
file|"cfb8bit.h"
end_include

begin_include
include|#
directive|include
file|"mergerop.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|sparc
end_ifdef

begin_define
define|#
directive|define
name|SHARED_IDCACHE
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|STORE
parameter_list|(
name|p
parameter_list|)
value|(*(p) = MROP_PREBUILT_SOLID(srcpix,*(p)))
end_define

begin_if
if|#
directive|if
operator|(
name|MROP
operator|==
name|Mcopy
operator|)
operator|&&
name|defined
argument_list|(
name|FAST_CONSTANT_OFFSET_MODE
argument_list|)
operator|&&
name|defined
argument_list|(
name|SHARED_IDCACHE
argument_list|)
end_if

begin_define
define|#
directive|define
name|Expand
parameter_list|(
name|left
parameter_list|,
name|right
parameter_list|)
value|{\     int part = nlwMiddle& 7; \     nlwMiddle>>= 3; \     while (h--) { \ 	srcpix = psrc[srcy * tileStride]; \ 	MROP_PREBUILD(srcpix); \ 	++srcy; \ 	if (srcy == tileHeight) \ 	    srcy = 0; \ 	left \ 	p += part; \ 	switch (part) { \ 	case 7: \ 	    STORE(p - 7); \ 	case 6: \ 	    STORE(p - 6); \ 	case 5: \ 	    STORE(p - 5); \ 	case 4: \ 	    STORE(p - 4); \ 	case 3: \ 	    STORE(p - 3); \ 	case 2: \ 	    STORE(p - 2); \ 	case 1: \ 	    STORE(p - 1); \ 	} \ 	nlw = nlwMiddle; \ 	while (nlw) { \ 	    STORE (p + 0); \ 	    STORE (p + 1); \ 	    STORE (p + 2); \ 	    STORE (p + 3); \ 	    STORE (p + 4); \ 	    STORE (p + 5); \ 	    STORE (p + 6); \ 	    STORE (p + 7); \ 	    p += 8; \ 	    nlw--; \ 	} \ 	right \ 	p += nlwExtra; \     } \ }
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|Expand
parameter_list|(
name|left
parameter_list|,
name|right
parameter_list|)
value|{\     while (h--)	{ \ 	srcpix = psrc[srcy * tileStride]; \ 	MROP_PREBUILD(srcpix); \ 	++srcy; \ 	if (srcy == tileHeight) \ 	    srcy = 0; \ 	left \ 	nlw = nlwMiddle; \ 	while (nlw--) \ 	{ \ 	    STORE(p); \ 	    p++; \ 	} \ 	right \ 	p += nlwExtra; \     } \ }
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|MROP_NAME
function|(
name|cfbFillRectTile32
function|)
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nBox
parameter_list|,
name|pBox
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|nBox
decl_stmt|;
comment|/* number of boxes to fill */
name|BoxPtr
name|pBox
decl_stmt|;
comment|/* pointer to list of boxes to fill */
block|{
specifier|register
name|unsigned
name|long
name|srcpix
decl_stmt|;
name|unsigned
name|long
modifier|*
name|psrc
decl_stmt|;
comment|/* pointer to bits in tile, if needed */
name|int
name|tileHeight
decl_stmt|;
comment|/* height of the tile */
name|int
name|nlwDst
decl_stmt|;
comment|/* width in longwords of the dest pixmap */
name|int
name|w
decl_stmt|;
comment|/* width of current box */
specifier|register
name|int
name|h
decl_stmt|;
comment|/* height of current box */
specifier|register
name|unsigned
name|long
name|startmask
decl_stmt|;
specifier|register
name|unsigned
name|long
name|endmask
decl_stmt|;
comment|/* masks for reggedy bits at either end of line */
name|int
name|nlwMiddle
decl_stmt|;
comment|/* number of longwords between sides of boxes */
name|int
name|nlwExtra
decl_stmt|;
comment|/* to get from right of box to left of next span */
specifier|register
name|int
name|nlw
decl_stmt|;
comment|/* loop version of nlwMiddle */
specifier|register
name|unsigned
name|long
modifier|*
name|p
decl_stmt|;
comment|/* pointer to bits we're writing */
name|int
name|y
decl_stmt|;
comment|/* current scan line */
name|int
name|srcy
decl_stmt|;
comment|/* current tile position */
name|unsigned
name|long
modifier|*
name|pbits
decl_stmt|;
comment|/* pointer to start of pixmap */
name|PixmapPtr
name|tile
decl_stmt|;
comment|/* rotated, expanded tile */
name|hpPrivPixmapPtr
name|tilePriv
decl_stmt|;
name|int
name|tileStride
decl_stmt|;
name|MROP_DECLARE_REG
argument_list|()
name|MROP_PREBUILT_DECLARE
argument_list|()
name|tile
operator|=
operator|(
call|(
name|cfbPrivGCPtr
call|)
argument_list|(
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
argument_list|)
operator|)
operator|->
name|pRotatedPixmap
expr_stmt|;
name|tilePriv
operator|=
operator|(
name|hpPrivPixmapPtr
operator|)
name|tile
operator|->
name|devPrivate
operator|.
name|ptr
expr_stmt|;
name|tileHeight
operator|=
name|tile
operator|->
name|drawable
operator|.
name|height
expr_stmt|;
name|tileStride
operator|=
name|tilePriv
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
name|psrc
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
name|tilePriv
operator|->
name|bits
expr_stmt|;
name|MROP_INITIALIZE
argument_list|(
name|pGC
operator|->
name|alu
argument_list|,
name|pGC
operator|->
name|planemask
argument_list|)
expr_stmt|;
name|cfbGetLongWidthAndPointer
argument_list|(
argument|pDrawable
argument_list|,
argument|nlwDst
argument_list|,
argument|pbits
argument_list|)
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
if|if
condition|(
name|tile
operator|->
name|devKind
operator|==
name|PIXMAP_FRAME_BUFFER
condition|)
name|WAIT_READY_TO_RENDER
argument_list|(
name|tile
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
expr_stmt|;
while|while
condition|(
name|nBox
operator|--
condition|)
block|{
name|w
operator|=
name|pBox
operator|->
name|x2
operator|-
name|pBox
operator|->
name|x1
expr_stmt|;
name|h
operator|=
name|pBox
operator|->
name|y2
operator|-
name|pBox
operator|->
name|y1
expr_stmt|;
name|y
operator|=
name|pBox
operator|->
name|y1
expr_stmt|;
name|p
operator|=
name|pbits
operator|+
operator|(
name|y
operator|*
name|nlwDst
operator|)
operator|+
operator|(
name|pBox
operator|->
name|x1
operator|>>
name|PWSH
operator|)
expr_stmt|;
name|srcy
operator|=
name|y
operator|%
name|tileHeight
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|pBox
operator|->
name|x1
operator|&
name|PIM
operator|)
operator|+
name|w
operator|)
operator|<=
name|PPW
condition|)
block|{
name|maskpartialbits
argument_list|(
name|pBox
operator|->
name|x1
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|nlwExtra
operator|=
name|nlwDst
expr_stmt|;
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|srcpix
operator|=
name|psrc
index|[
name|srcy
operator|*
name|tileStride
index|]
expr_stmt|;
name|MROP_PREBUILD
argument_list|(
name|srcpix
argument_list|)
expr_stmt|;
operator|++
name|srcy
expr_stmt|;
if|if
condition|(
name|srcy
operator|==
name|tileHeight
condition|)
name|srcy
operator|=
literal|0
expr_stmt|;
operator|*
name|p
operator|=
name|MROP_PREBUILT_MASK
argument_list|(
name|srcpix
argument_list|,
operator|*
name|p
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|p
operator|+=
name|nlwExtra
expr_stmt|;
block|}
block|}
else|else
block|{
name|maskbits
argument_list|(
name|pBox
operator|->
name|x1
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlwMiddle
argument_list|)
expr_stmt|;
name|nlwExtra
operator|=
name|nlwDst
operator|-
name|nlwMiddle
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|nlwExtra
operator|-=
literal|1
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
block|{
name|Expand
argument_list|(
argument|*p = MROP_PREBUILT_MASK(srcpix, *p, startmask); p++;
argument_list|,
argument|*p = MROP_PREBUILT_MASK(srcpix, *p, endmask);
argument_list|)
block|}
else|else
block|{
name|Expand
argument_list|(
argument|*p = MROP_PREBUILT_MASK(srcpix, *p, startmask); p++;
argument_list|,
argument|;
argument_list|)
block|}
block|}
else|else
block|{
if|if
condition|(
name|endmask
condition|)
block|{
name|Expand
argument_list|(
argument|;
argument_list|,
argument|*p = MROP_PREBUILT_MASK(srcpix, *p, endmask);
argument_list|)
block|}
else|else
block|{
name|Expand
argument_list|(
argument|;
argument_list|,
argument|;
argument_list|)
block|}
block|}
block|}
name|pBox
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|MROP_NAME
function|(
name|cfbTile32FS
function|)
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nInit
parameter_list|,
name|pptInit
parameter_list|,
name|pwidthInit
parameter_list|,
name|fSorted
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|nInit
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|pptInit
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidthInit
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|fSorted
decl_stmt|;
block|{
comment|/* next three parameters are post-clip */
name|int
name|n
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|ppt
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidth
decl_stmt|;
comment|/* pointer to list of n widths */
name|unsigned
name|long
modifier|*
name|pbits
decl_stmt|;
comment|/* pointer to start of bitmap */
name|int
name|nlwDst
decl_stmt|;
comment|/* width in longwords of bitmap */
specifier|register
name|unsigned
name|long
modifier|*
name|p
decl_stmt|;
comment|/* pointer to current longword in bitmap */
specifier|register
name|int
name|w
decl_stmt|;
comment|/* current span width */
specifier|register
name|int
name|nlw
decl_stmt|;
specifier|register
name|int
name|x
decl_stmt|;
specifier|register
name|unsigned
name|long
name|startmask
decl_stmt|;
specifier|register
name|unsigned
name|long
name|endmask
decl_stmt|;
specifier|register
name|unsigned
name|long
name|srcpix
decl_stmt|;
name|int
name|y
decl_stmt|;
name|int
modifier|*
name|pwidthFree
decl_stmt|;
comment|/* copies of the pointers to free */
name|DDXPointPtr
name|pptFree
decl_stmt|;
name|PixmapPtr
name|tile
decl_stmt|;
name|hpPrivPixmapPtr
name|tilePriv
decl_stmt|;
name|int
name|tileStride
decl_stmt|;
name|unsigned
name|long
modifier|*
name|psrc
decl_stmt|;
comment|/* pointer to bits in tile */
name|int
name|tileHeight
decl_stmt|;
comment|/* height of the tile */
name|MROP_DECLARE_REG
argument_list|()
name|MROP_PREBUILT_DECLARE
argument_list|()
name|n
operator|=
name|nInit
operator|*
name|miFindMaxBand
argument_list|(
operator|(
operator|(
name|cfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
name|pwidthFree
operator|=
operator|(
name|int
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pptFree
operator|=
operator|(
name|DDXPointRec
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pptFree
operator|||
operator|!
name|pwidthFree
condition|)
block|{
if|if
condition|(
name|pptFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwidthFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
return|return;
block|}
name|pwidth
operator|=
name|pwidthFree
expr_stmt|;
name|ppt
operator|=
name|pptFree
expr_stmt|;
name|n
operator|=
name|miClipSpans
argument_list|(
operator|(
operator|(
name|cfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|,
name|pptInit
argument_list|,
name|pwidthInit
argument_list|,
name|nInit
argument_list|,
name|ppt
argument_list|,
name|pwidth
argument_list|,
name|fSorted
argument_list|)
expr_stmt|;
name|tile
operator|=
operator|(
call|(
name|cfbPrivGCPtr
call|)
argument_list|(
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
argument_list|)
operator|)
operator|->
name|pRotatedPixmap
expr_stmt|;
name|tilePriv
operator|=
operator|(
name|hpPrivPixmapPtr
operator|)
name|tile
operator|->
name|devPrivate
operator|.
name|ptr
expr_stmt|;
name|tileHeight
operator|=
name|tile
operator|->
name|drawable
operator|.
name|height
expr_stmt|;
name|tileStride
operator|=
name|tilePriv
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
name|psrc
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
name|tilePriv
operator|->
name|bits
expr_stmt|;
name|MROP_INITIALIZE
argument_list|(
name|pGC
operator|->
name|alu
argument_list|,
name|pGC
operator|->
name|planemask
argument_list|)
expr_stmt|;
name|cfbGetLongWidthAndPointer
argument_list|(
argument|pDrawable
argument_list|,
argument|nlwDst
argument_list|,
argument|pbits
argument_list|)
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
if|if
condition|(
name|tile
operator|->
name|devKind
operator|==
name|PIXMAP_FRAME_BUFFER
condition|)
name|WAIT_READY_TO_RENDER
argument_list|(
name|tile
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
expr_stmt|;
if|#
directive|if
name|MROP
operator|==
name|Mcopy
if|if
condition|(
operator|!
operator|(
name|tileHeight
operator|&
operator|(
name|tileHeight
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|tileHeight
operator|--
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|x
operator|=
name|ppt
operator|->
name|x
expr_stmt|;
name|y
operator|=
name|ppt
operator|->
name|y
expr_stmt|;
operator|++
name|ppt
expr_stmt|;
name|w
operator|=
operator|*
name|pwidth
operator|++
expr_stmt|;
name|p
operator|=
name|pbits
operator|+
operator|(
name|y
operator|*
name|nlwDst
operator|)
operator|+
operator|(
name|x
operator|>>
name|PWSH
operator|)
expr_stmt|;
name|srcpix
operator|=
name|psrc
index|[
operator|(
name|y
operator|&
name|tileHeight
operator|)
operator|*
name|tileStride
index|]
expr_stmt|;
name|MROP_PREBUILD
argument_list|(
name|srcpix
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|&
name|PIM
operator|)
operator|+
name|w
operator|<
name|PPW
condition|)
block|{
name|maskpartialbits
argument_list|(
name|x
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
name|MROP_PREBUILT_MASK
argument_list|(
name|srcpix
argument_list|,
operator|*
name|p
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|x
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlw
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
operator|*
name|p
operator|=
name|MROP_PREBUILT_MASK
argument_list|(
name|srcpix
argument_list|,
operator|*
name|p
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
name|STORE
argument_list|(
name|p
argument_list|)
expr_stmt|;
operator|++
name|p
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
operator|*
name|p
operator|=
name|MROP_PREBUILT_MASK
argument_list|(
name|srcpix
argument_list|,
operator|*
name|p
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
endif|#
directive|endif
block|{
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|x
operator|=
name|ppt
operator|->
name|x
expr_stmt|;
name|y
operator|=
name|ppt
operator|->
name|y
expr_stmt|;
operator|++
name|ppt
expr_stmt|;
name|w
operator|=
operator|*
name|pwidth
operator|++
expr_stmt|;
name|p
operator|=
name|pbits
operator|+
operator|(
name|y
operator|*
name|nlwDst
operator|)
operator|+
operator|(
name|x
operator|>>
name|PWSH
operator|)
expr_stmt|;
name|srcpix
operator|=
name|psrc
index|[
operator|(
name|y
operator|%
name|tileHeight
operator|)
operator|*
name|tileStride
index|]
expr_stmt|;
name|MROP_PREBUILD
argument_list|(
name|srcpix
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|&
name|PIM
operator|)
operator|+
name|w
operator|<
name|PPW
condition|)
block|{
name|maskpartialbits
argument_list|(
name|x
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
name|MROP_PREBUILT_MASK
argument_list|(
name|srcpix
argument_list|,
operator|*
name|p
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|x
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlw
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
operator|*
name|p
operator|=
name|MROP_PREBUILT_MASK
argument_list|(
name|srcpix
argument_list|,
operator|*
name|p
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
name|STORE
argument_list|(
name|p
argument_list|)
expr_stmt|;
operator|++
name|p
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
operator|*
name|p
operator|=
name|MROP_PREBUILT_MASK
argument_list|(
name|srcpix
argument_list|,
operator|*
name|p
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


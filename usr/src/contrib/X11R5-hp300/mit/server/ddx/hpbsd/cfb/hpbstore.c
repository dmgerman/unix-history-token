begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* moreBS.c : more backing store stuff 	 */
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xmd.h"
end_include

begin_include
include|#
directive|include
file|"Xproto.h"
end_include

begin_include
include|#
directive|include
file|"gcstruct.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"regionstr.h"
end_include

begin_include
include|#
directive|include
file|"mibstore.h"
end_include

begin_include
include|#
directive|include
file|"cfb.h"
end_include

begin_decl_stmt
specifier|extern
name|void
name|MemToMem
argument_list|()
decl_stmt|,
name|ScreenToScreen
argument_list|()
decl_stmt|,
name|MemToScreen
argument_list|()
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PIXER
parameter_list|(
name|Drawable
parameter_list|)
value|((hpPrivPixmapPtr)((PixmapPtr)Drawable)->devPrivate.ptr)
end_define

begin_comment
comment|/*-  *-----------------------------------------------------------------------  * hpSaveAreas --  *	Function called by miSaveAreas to actually fetch the areas to be  *	saved into the backing pixmap. The region to save is  *	already destination-relative and we're given the offset to the  *	window origin, so we have only to create an array of points of the  *	u.l. corners of the boxes in the region translated to the screen  *	coordinate system and fetch the screen pixmap out of its devPrivate  *	field....  * screen -> pixmap  *-----------------------------------------------------------------------  */
end_comment

begin_function
name|void
name|hpSaveAreas
parameter_list|(
name|pPixmap
parameter_list|,
name|prgnSave
parameter_list|,
name|xorg
parameter_list|,
name|yorg
parameter_list|)
name|PixmapPtr
name|pPixmap
decl_stmt|;
comment|/* Backing pixmap */
name|RegionPtr
name|prgnSave
decl_stmt|;
comment|/* Region to save (pixmap-relative) */
name|int
name|xorg
decl_stmt|,
name|yorg
decl_stmt|;
comment|/* X,Y origin of region */
block|{
name|BoxRec
name|sbox
decl_stmt|;
specifier|register
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
name|GC
name|gc
decl_stmt|;
name|getPrivScreenPtr
argument_list|(
name|pPixmap
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
operator|->
name|CursorOff
argument_list|(
name|pPixmap
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
expr_stmt|;
name|sbox
operator|.
name|x1
operator|=
name|sbox
operator|.
name|y1
operator|=
literal|0
expr_stmt|;
name|sbox
operator|.
name|x2
operator|=
name|sbox
operator|.
name|y2
operator|=
literal|10000
expr_stmt|;
name|gc
operator|.
name|alu
operator|=
name|GXcopy
expr_stmt|;
name|gc
operator|.
name|planemask
operator|=
operator|~
literal|0
expr_stmt|;
if|if
condition|(
name|pPixmap
operator|->
name|devKind
operator|==
name|PIXMAP_FRAME_BUFFER
condition|)
block|{
name|a
operator|=
name|PIXER
argument_list|(
name|pPixmap
argument_list|)
operator|->
name|pChunk
operator|->
name|x
expr_stmt|;
name|b
operator|=
name|PIXER
argument_list|(
name|pPixmap
argument_list|)
operator|->
name|pChunk
operator|->
name|y
expr_stmt|;
name|ScreenToScreen
argument_list|(
operator|&
name|pPixmap
operator|->
name|drawable
argument_list|,
operator|&
name|gc
argument_list|,
name|xorg
argument_list|,
name|yorg
argument_list|,
name|sbox
operator|.
name|x2
argument_list|,
name|sbox
operator|.
name|y2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|sbox
argument_list|,
literal|1
argument_list|,
name|REGION_RECTS
argument_list|(
name|prgnSave
argument_list|)
argument_list|,
name|REGION_NUM_RECTS
argument_list|(
name|prgnSave
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|MemToMem
argument_list|(
name|getPrivScreenPtr
argument_list|(
name|pPixmap
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
operator|->
name|pDrawable
argument_list|,
operator|&
name|pPixmap
operator|->
name|drawable
argument_list|,
operator|&
name|gc
argument_list|,
name|xorg
argument_list|,
name|yorg
argument_list|,
name|sbox
operator|.
name|x2
argument_list|,
name|sbox
operator|.
name|y2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|sbox
argument_list|,
literal|1
argument_list|,
name|REGION_RECTS
argument_list|(
name|prgnSave
argument_list|)
argument_list|,
name|REGION_NUM_RECTS
argument_list|(
name|prgnSave
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*-  *-----------------------------------------------------------------------  * hpRestoreAreas --  *	Function called by miRestoreAreas to actually fetch the areas to be  *	restored from the backing pixmap. The region to restore is  *	already destination-relative and we're given the offset to the  *	window origin, so we have only to create an array of points of the  *	u.l. corners of the boxes in the region translated to the pixmap  *	coordinate system and fetch the screen pixmap out of its devPrivate  *	field....  * pixmap -> screen  *-----------------------------------------------------------------------  */
end_comment

begin_function
name|void
name|hpRestoreAreas
parameter_list|(
name|pPixmap
parameter_list|,
name|prgnRestore
parameter_list|,
name|xorg
parameter_list|,
name|yorg
parameter_list|)
name|PixmapPtr
name|pPixmap
decl_stmt|;
comment|/* Backing pixmap */
name|RegionPtr
name|prgnRestore
decl_stmt|;
comment|/* Region to restore (screen-relative)*/
name|int
name|xorg
decl_stmt|,
name|yorg
decl_stmt|;
comment|/* origin of window */
block|{
name|BoxRec
name|sbox
decl_stmt|;
specifier|register
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
name|GC
name|gc
decl_stmt|;
name|getPrivScreenPtr
argument_list|(
name|pPixmap
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
operator|->
name|CursorOff
argument_list|(
name|pPixmap
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
expr_stmt|;
name|sbox
operator|.
name|x1
operator|=
name|sbox
operator|.
name|y1
operator|=
literal|0
expr_stmt|;
name|sbox
operator|.
name|x2
operator|=
name|pPixmap
operator|->
name|drawable
operator|.
name|width
expr_stmt|;
name|sbox
operator|.
name|y2
operator|=
name|pPixmap
operator|->
name|drawable
operator|.
name|height
expr_stmt|;
name|gc
operator|.
name|alu
operator|=
name|GXcopy
expr_stmt|;
name|gc
operator|.
name|planemask
operator|=
operator|~
literal|0
expr_stmt|;
if|if
condition|(
name|pPixmap
operator|->
name|devKind
operator|==
name|PIXMAP_FRAME_BUFFER
condition|)
block|{
name|a
operator|=
name|PIXER
argument_list|(
name|pPixmap
argument_list|)
operator|->
name|pChunk
operator|->
name|x
expr_stmt|;
name|b
operator|=
name|PIXER
argument_list|(
name|pPixmap
argument_list|)
operator|->
name|pChunk
operator|->
name|y
expr_stmt|;
name|ScreenToScreen
argument_list|(
operator|&
name|pPixmap
operator|->
name|drawable
argument_list|,
operator|&
name|gc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|sbox
operator|.
name|x2
argument_list|,
name|sbox
operator|.
name|y2
argument_list|,
name|xorg
argument_list|,
name|yorg
argument_list|,
operator|&
name|sbox
argument_list|,
literal|1
argument_list|,
name|REGION_RECTS
argument_list|(
name|prgnRestore
argument_list|)
argument_list|,
name|REGION_NUM_RECTS
argument_list|(
name|prgnRestore
argument_list|)
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gc
operator|.
name|pScreen
operator|=
name|pPixmap
operator|->
name|drawable
operator|.
name|pScreen
expr_stmt|;
name|MemToScreen
argument_list|(
operator|&
name|pPixmap
operator|->
name|drawable
argument_list|,
name|getPrivScreenPtr
argument_list|(
name|pPixmap
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
operator|->
name|pDrawable
argument_list|,
operator|&
name|gc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|sbox
operator|.
name|x2
argument_list|,
name|sbox
operator|.
name|y2
argument_list|,
name|xorg
argument_list|,
name|yorg
argument_list|,
name|REGION_NUM_RECTS
argument_list|(
name|prgnRestore
argument_list|)
argument_list|,
name|REGION_RECTS
argument_list|(
name|prgnRestore
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


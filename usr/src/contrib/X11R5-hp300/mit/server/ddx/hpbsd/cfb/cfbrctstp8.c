begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Fill 32 bit stippled rectangles for 8 bit frame buffers  */
end_comment

begin_comment
comment|/* Copyright 1989 by the Massachusetts Institute of Technology  Permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.  Author: Keith Packard, MIT X Consortium  */
end_comment

begin_comment
comment|/* $XConsortium: cfbrctstp8.c,v 1.13 91/04/10 11:41:33 keith Exp $ */
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xmd.h"
end_include

begin_include
include|#
directive|include
file|"servermd.h"
end_include

begin_include
include|#
directive|include
file|"gcstruct.h"
end_include

begin_include
include|#
directive|include
file|"window.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"cfb.h"
end_include

begin_include
include|#
directive|include
file|"cfbmskbits.h"
end_include

begin_include
include|#
directive|include
file|"cfb8bit.h"
end_include

begin_if
if|#
directive|if
operator|(
name|PPW
operator|==
literal|4
operator|)
end_if

begin_function
name|void
name|cfb8FillRectOpaqueStippled32
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nBox
parameter_list|,
name|pBox
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|nBox
decl_stmt|;
comment|/* number of boxes to fill */
specifier|register
name|BoxPtr
name|pBox
decl_stmt|;
comment|/* pointer to list of boxes to fill */
block|{
name|unsigned
name|long
modifier|*
name|src
decl_stmt|;
name|int
name|stippleHeight
decl_stmt|;
name|int
name|nlwDst
decl_stmt|;
comment|/* width in longwords of the dest pixmap */
name|int
name|nlwSrc
decl_stmt|;
comment|/* width in longwords of the src pixmap */
name|int
name|w
decl_stmt|;
comment|/* width of current box */
specifier|register
name|int
name|h
decl_stmt|;
comment|/* height of current box */
name|unsigned
name|long
name|startmask
decl_stmt|;
name|unsigned
name|long
name|endmask
decl_stmt|;
comment|/* masks for reggedy bits at either end of line */
name|int
name|nlwMiddle
decl_stmt|;
comment|/* number of longwords between sides of boxes */
specifier|register
name|int
name|nlw
decl_stmt|;
comment|/* loop version of nlwMiddle */
name|unsigned
name|long
modifier|*
name|dstLine
decl_stmt|;
specifier|register
name|unsigned
name|long
modifier|*
name|dst
decl_stmt|;
comment|/* pointer to bits we're writing */
name|unsigned
name|long
modifier|*
name|dstTmp
decl_stmt|;
name|int
name|y
decl_stmt|;
comment|/* current scan line */
name|unsigned
name|long
modifier|*
name|pbits
decl_stmt|;
comment|/* pointer to start of pixmap */
specifier|register
name|unsigned
name|long
name|bits
decl_stmt|;
comment|/* bits from stipple */
name|int
name|rot
decl_stmt|,
name|lastStop
decl_stmt|,
name|i
decl_stmt|;
specifier|register
name|unsigned
name|long
name|xor
decl_stmt|,
name|and
decl_stmt|;
name|cfbPrivGCPtr
name|devPriv
decl_stmt|;
name|PixmapPtr
name|stipple
decl_stmt|;
name|int
name|wEnd
decl_stmt|;
name|devPriv
operator|=
operator|(
operator|(
name|cfbPrivGCPtr
operator|)
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
expr_stmt|;
name|stipple
operator|=
name|devPriv
operator|->
name|pRotatedPixmap
expr_stmt|;
name|cfb8CheckOpaqueStipple
argument_list|(
name|pGC
operator|->
name|alu
argument_list|,
name|pGC
operator|->
name|fgPixel
argument_list|,
name|pGC
operator|->
name|bgPixel
argument_list|,
name|pGC
operator|->
name|planemask
argument_list|)
expr_stmt|;
name|src
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|(
operator|(
name|hpPrivPixmapPtr
operator|)
name|stipple
operator|->
name|devPrivate
operator|.
name|ptr
operator|)
operator|->
name|bits
expr_stmt|;
name|nlwSrc
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
operator|(
name|hpPrivPixmapPtr
operator|)
name|stipple
operator|->
name|devPrivate
operator|.
name|ptr
operator|)
operator|->
name|stride
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|stippleHeight
operator|=
name|stipple
operator|->
name|drawable
operator|.
name|height
operator|*
name|nlwSrc
expr_stmt|;
name|cfbGetLongWidthAndPointer
argument_list|(
argument|pDrawable
argument_list|,
argument|nlwDst
argument_list|,
argument|pbits
argument_list|)
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
if|if
condition|(
name|stipple
operator|->
name|devKind
operator|==
name|PIXMAP_FRAME_BUFFER
condition|)
name|WAIT_READY_TO_RENDER
argument_list|(
name|stipple
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
expr_stmt|;
while|while
condition|(
name|nBox
operator|--
condition|)
block|{
name|w
operator|=
name|pBox
operator|->
name|x2
operator|-
name|pBox
operator|->
name|x1
expr_stmt|;
name|h
operator|=
name|pBox
operator|->
name|y2
operator|-
name|pBox
operator|->
name|y1
expr_stmt|;
name|y
operator|=
name|pBox
operator|->
name|y1
expr_stmt|;
name|dstLine
operator|=
name|pbits
operator|+
operator|(
name|pBox
operator|->
name|y1
operator|*
name|nlwDst
operator|)
operator|+
operator|(
operator|(
name|pBox
operator|->
name|x1
operator|&
operator|~
literal|3
operator|)
operator|>>
name|PWSH
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|pBox
operator|->
name|x1
operator|&
name|PIM
operator|)
operator|+
name|w
operator|)
operator|<=
name|PPW
condition|)
block|{
name|maskpartialbits
argument_list|(
name|pBox
operator|->
name|x1
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|nlwMiddle
operator|=
literal|0
expr_stmt|;
name|endmask
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|pBox
operator|->
name|x1
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlwMiddle
argument_list|)
expr_stmt|;
block|}
name|rot
operator|=
operator|(
name|pBox
operator|->
name|x1
operator|&
operator|(
literal|31
operator|&
operator|~
literal|3
operator|)
operator|)
expr_stmt|;
name|pBox
operator|++
expr_stmt|;
name|y
operator|=
operator|(
name|y
operator|*
name|nlwSrc
operator|)
operator|%
name|stippleHeight
expr_stmt|;
if|if
condition|(
name|cfb8StippleRRop
operator|==
name|GXcopy
condition|)
block|{
if|if
condition|(
name|w
operator|<
literal|64
condition|)
block|{
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|bits
operator|=
name|src
index|[
name|y
index|]
expr_stmt|;
name|y
operator|+=
name|nlwSrc
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|stippleHeight
condition|)
name|y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rot
condition|)
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
name|rot
argument_list|)
expr_stmt|;
name|dst
operator|=
name|dstLine
expr_stmt|;
name|dstLine
operator|+=
name|nlwDst
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
operator|*
name|dst
operator|=
operator|*
name|dst
operator|&
operator|~
name|startmask
operator||
name|GetFourPixels
argument_list|(
name|bits
argument_list|)
operator|&
name|startmask
expr_stmt|;
name|dst
operator|++
expr_stmt|;
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|nlw
operator|=
name|nlwMiddle
expr_stmt|;
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
operator|*
name|dst
operator|++
operator|=
name|GetFourPixels
argument_list|(
name|bits
argument_list|)
expr_stmt|;
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
operator|*
name|dst
operator|=
operator|*
name|dst
operator|&
operator|~
name|endmask
operator||
name|GetFourPixels
argument_list|(
name|bits
argument_list|)
operator|&
name|endmask
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|wEnd
operator|=
literal|7
operator|-
operator|(
name|nlwMiddle
operator|&
literal|7
operator|)
expr_stmt|;
name|nlwMiddle
operator|=
operator|(
name|nlwMiddle
operator|>>
literal|3
operator|)
operator|+
literal|1
expr_stmt|;
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|bits
operator|=
name|src
index|[
name|y
index|]
expr_stmt|;
name|y
operator|+=
name|nlwSrc
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|stippleHeight
condition|)
name|y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rot
operator|!=
literal|0
condition|)
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
name|rot
argument_list|)
expr_stmt|;
name|dstTmp
operator|=
name|dstLine
expr_stmt|;
name|dstLine
operator|+=
name|nlwDst
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
operator|*
name|dstTmp
operator|=
operator|*
name|dstTmp
operator|&
operator|~
name|startmask
operator||
name|GetFourPixels
argument_list|(
name|bits
argument_list|)
operator|&
name|startmask
expr_stmt|;
name|dstTmp
operator|++
expr_stmt|;
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|w
operator|=
literal|7
operator|-
name|wEnd
expr_stmt|;
while|while
condition|(
name|w
operator|--
condition|)
block|{
name|nlw
operator|=
name|nlwMiddle
expr_stmt|;
name|dst
operator|=
name|dstTmp
expr_stmt|;
name|dstTmp
operator|++
expr_stmt|;
name|xor
operator|=
name|GetFourPixels
argument_list|(
name|bits
argument_list|)
expr_stmt|;
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
operator|*
name|dst
operator|=
name|xor
expr_stmt|;
name|dst
operator|+=
literal|8
expr_stmt|;
block|}
name|NextFourBits
argument_list|(
name|bits
argument_list|)
expr_stmt|;
block|}
name|nlwMiddle
operator|--
expr_stmt|;
name|w
operator|=
name|wEnd
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
block|{
name|dst
operator|=
name|dstTmp
operator|+
operator|(
name|nlwMiddle
operator|<<
literal|3
operator|)
expr_stmt|;
operator|*
name|dst
operator|=
operator|(
operator|*
name|dst
operator|&
operator|~
name|endmask
operator|)
operator||
name|GetFourPixels
argument_list|(
name|bits
argument_list|)
operator|&
name|endmask
expr_stmt|;
block|}
while|while
condition|(
name|w
operator|--
condition|)
block|{
name|nlw
operator|=
name|nlwMiddle
expr_stmt|;
name|dst
operator|=
name|dstTmp
expr_stmt|;
name|dstTmp
operator|++
expr_stmt|;
name|xor
operator|=
name|GetFourPixels
argument_list|(
name|bits
argument_list|)
expr_stmt|;
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
operator|*
name|dst
operator|=
name|xor
expr_stmt|;
name|dst
operator|+=
literal|8
expr_stmt|;
block|}
name|NextFourBits
argument_list|(
name|bits
argument_list|)
expr_stmt|;
block|}
name|nlwMiddle
operator|++
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|bits
operator|=
name|src
index|[
name|y
index|]
expr_stmt|;
name|y
operator|+=
name|nlwSrc
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|stippleHeight
condition|)
name|y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rot
condition|)
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
name|rot
argument_list|)
expr_stmt|;
name|dst
operator|=
name|dstLine
expr_stmt|;
name|dstLine
operator|+=
name|nlwDst
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|xor
operator|=
name|GetFourBits
argument_list|(
name|bits
argument_list|)
expr_stmt|;
operator|*
name|dst
operator|=
name|MaskRRopPixels
argument_list|(
operator|*
name|dst
argument_list|,
name|xor
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|dst
operator|++
expr_stmt|;
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|nlw
operator|=
name|nlwMiddle
expr_stmt|;
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
name|RRopFourBits
argument_list|(
name|dst
argument_list|,
name|GetFourBits
argument_list|(
name|bits
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|++
expr_stmt|;
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
name|xor
operator|=
name|GetFourBits
argument_list|(
name|bits
argument_list|)
expr_stmt|;
operator|*
name|dst
operator|=
name|MaskRRopPixels
argument_list|(
operator|*
name|dst
argument_list|,
name|xor
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_function

begin_macro
name|cfb8FillRectTransparentStippled32
argument_list|(
argument|pDrawable
argument_list|,
argument|pGC
argument_list|,
argument|nBox
argument_list|,
argument|pBox
argument_list|)
end_macro

begin_decl_stmt
name|DrawablePtr
name|pDrawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|GCPtr
name|pGC
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nBox
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of boxes to fill */
end_comment

begin_decl_stmt
name|BoxPtr
name|pBox
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* pointer to list of boxes to fill */
end_comment

begin_block
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|int
name|nlwMiddle
decl_stmt|,
name|nlwDst
decl_stmt|,
name|nlwTmp
decl_stmt|,
name|nlwSrc
decl_stmt|;
name|unsigned
name|long
name|startmask
decl_stmt|,
name|endmask
decl_stmt|;
specifier|register
name|unsigned
name|long
modifier|*
name|dst
decl_stmt|;
name|unsigned
name|long
modifier|*
name|dstLine
decl_stmt|,
modifier|*
name|pbits
decl_stmt|,
modifier|*
name|dstTmp
decl_stmt|;
name|unsigned
name|long
modifier|*
name|src
decl_stmt|;
specifier|register
name|unsigned
name|long
name|xor
decl_stmt|;
specifier|register
name|unsigned
name|long
name|bits
decl_stmt|,
name|mask
decl_stmt|;
name|int
name|rot
decl_stmt|;
name|int
name|wEnd
decl_stmt|;
name|cfbPrivGCPtr
name|devPriv
decl_stmt|;
name|PixmapPtr
name|stipple
decl_stmt|;
name|int
name|stippleHeight
decl_stmt|;
specifier|register
name|int
name|nlw
decl_stmt|;
name|devPriv
operator|=
operator|(
operator|(
name|cfbPrivGCPtr
operator|)
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
expr_stmt|;
name|stipple
operator|=
name|devPriv
operator|->
name|pRotatedPixmap
expr_stmt|;
name|src
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|(
operator|(
name|hpPrivPixmapPtr
operator|)
name|stipple
operator|->
name|devPrivate
operator|.
name|ptr
operator|)
operator|->
name|bits
expr_stmt|;
name|nlwSrc
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
operator|(
name|hpPrivPixmapPtr
operator|)
name|stipple
operator|->
name|devPrivate
operator|.
name|ptr
operator|)
operator|->
name|stride
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|stippleHeight
operator|=
name|stipple
operator|->
name|drawable
operator|.
name|height
operator|*
name|nlwSrc
expr_stmt|;
name|cfb8CheckStipple
argument_list|(
name|pGC
operator|->
name|alu
argument_list|,
name|pGC
operator|->
name|fgPixel
argument_list|,
name|pGC
operator|->
name|planemask
argument_list|)
expr_stmt|;
name|cfbGetLongWidthAndPointer
argument_list|(
argument|pDrawable
argument_list|,
argument|nlwDst
argument_list|,
argument|pbits
argument_list|)
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
if|if
condition|(
name|stipple
operator|->
name|devKind
operator|==
name|PIXMAP_FRAME_BUFFER
condition|)
name|WAIT_READY_TO_RENDER
argument_list|(
name|stipple
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
expr_stmt|;
while|while
condition|(
name|nBox
operator|--
condition|)
block|{
name|x
operator|=
name|pBox
operator|->
name|x1
expr_stmt|;
name|w
operator|=
name|pBox
operator|->
name|x2
operator|-
name|x
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|x
operator|&
name|PIM
operator|)
operator|+
name|w
operator|)
operator|<=
name|PPW
condition|)
block|{
name|maskpartialbits
argument_list|(
name|x
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|endmask
operator|=
literal|0
expr_stmt|;
name|nlwMiddle
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|x
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlwMiddle
argument_list|)
expr_stmt|;
block|}
name|rot
operator|=
operator|(
name|x
operator|&
operator|(
literal|31
operator|&
operator|~
literal|3
operator|)
operator|)
expr_stmt|;
name|y
operator|=
name|pBox
operator|->
name|y1
expr_stmt|;
name|dstLine
operator|=
name|pbits
operator|+
operator|(
name|y
operator|*
name|nlwDst
operator|)
operator|+
operator|(
name|x
operator|>>
name|PWSH
operator|)
expr_stmt|;
name|h
operator|=
name|pBox
operator|->
name|y2
operator|-
name|y
expr_stmt|;
name|pBox
operator|++
expr_stmt|;
name|y
operator|=
operator|(
name|y
operator|*
name|nlwSrc
operator|)
operator|%
name|stippleHeight
expr_stmt|;
if|if
condition|(
name|cfb8StippleRRop
operator|==
name|GXcopy
condition|)
block|{
name|xor
operator|=
name|devPriv
operator|->
name|xor
expr_stmt|;
if|if
condition|(
name|w
operator|<
literal|64
condition|)
block|{
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|bits
operator|=
name|src
index|[
name|y
index|]
expr_stmt|;
name|y
operator|+=
name|nlwSrc
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|stippleHeight
condition|)
name|y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rot
operator|!=
literal|0
condition|)
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
name|rot
argument_list|)
expr_stmt|;
name|dst
operator|=
name|dstLine
expr_stmt|;
name|dstLine
operator|+=
name|nlwDst
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|mask
operator|=
name|cfb8PixelMasks
index|[
name|GetFourBits
argument_list|(
name|bits
argument_list|)
index|]
expr_stmt|;
operator|*
name|dst
operator|=
operator|(
operator|*
name|dst
operator|&
operator|~
operator|(
name|mask
operator|&
name|startmask
operator|)
operator|)
operator||
operator|(
name|xor
operator|&
operator|(
name|mask
operator|&
name|startmask
operator|)
operator|)
expr_stmt|;
name|dst
operator|++
expr_stmt|;
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|nlw
operator|=
name|nlwMiddle
expr_stmt|;
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
name|WriteFourBits
argument_list|(
argument|dst
argument_list|,
argument|xor
argument_list|,
argument|GetFourBits(bits)
argument_list|)
name|dst
operator|++
expr_stmt|;
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
name|mask
operator|=
name|cfb8PixelMasks
index|[
name|GetFourBits
argument_list|(
name|bits
argument_list|)
index|]
expr_stmt|;
operator|*
name|dst
operator|=
operator|(
operator|*
name|dst
operator|&
operator|~
operator|(
name|mask
operator|&
name|endmask
operator|)
operator|)
operator||
operator|(
name|xor
operator|&
operator|(
name|mask
operator|&
name|endmask
operator|)
operator|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|wEnd
operator|=
literal|7
operator|-
operator|(
name|nlwMiddle
operator|&
literal|7
operator|)
expr_stmt|;
name|nlwMiddle
operator|=
operator|(
name|nlwMiddle
operator|>>
literal|3
operator|)
operator|+
literal|1
expr_stmt|;
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|bits
operator|=
name|src
index|[
name|y
index|]
expr_stmt|;
name|y
operator|+=
name|nlwSrc
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|stippleHeight
condition|)
name|y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rot
operator|!=
literal|0
condition|)
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
name|rot
argument_list|)
expr_stmt|;
name|dstTmp
operator|=
name|dstLine
expr_stmt|;
name|dstLine
operator|+=
name|nlwDst
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|mask
operator|=
name|cfb8PixelMasks
index|[
name|GetFourBits
argument_list|(
name|bits
argument_list|)
index|]
expr_stmt|;
operator|*
name|dstTmp
operator|=
operator|(
operator|*
name|dstTmp
operator|&
operator|~
operator|(
name|mask
operator|&
name|startmask
operator|)
operator|)
operator||
operator|(
name|xor
operator|&
operator|(
name|mask
operator|&
name|startmask
operator|)
operator|)
expr_stmt|;
name|dstTmp
operator|++
expr_stmt|;
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|w
operator|=
literal|7
operator|-
name|wEnd
expr_stmt|;
while|while
condition|(
name|w
operator|--
condition|)
block|{
name|nlw
operator|=
name|nlwMiddle
expr_stmt|;
name|dst
operator|=
name|dstTmp
expr_stmt|;
name|dstTmp
operator|++
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__GNUC__
argument_list|)
operator|&&
name|defined
argument_list|(
name|mc68020
argument_list|)
name|mask
operator|=
name|cfb8PixelMasks
index|[
name|GetFourBits
argument_list|(
name|bits
argument_list|)
index|]
expr_stmt|;
name|xor
operator|=
name|xor
operator|&
name|mask
expr_stmt|;
name|mask
operator|=
operator|~
name|mask
expr_stmt|;
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
operator|*
name|dst
operator|=
operator|(
operator|*
name|dst
operator|&
name|mask
operator|)
operator||
name|xor
expr_stmt|;
name|dst
operator|+=
literal|8
expr_stmt|;
block|}
name|xor
operator|=
name|devPriv
operator|->
name|xor
expr_stmt|;
else|#
directive|else
define|#
directive|define
name|SwitchBitsLoop
parameter_list|(
name|body
parameter_list|)
define|\
value|while (nlw--)	\ 	{		\ 	    body	\ 	    dst += 8;	\ 	}
name|SwitchFourBits
argument_list|(
name|dst
argument_list|,
name|xor
argument_list|,
name|GetFourBits
argument_list|(
name|bits
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SwitchBitsLoop
endif|#
directive|endif
name|NextFourBits
argument_list|(
name|bits
argument_list|)
expr_stmt|;
block|}
name|nlwMiddle
operator|--
expr_stmt|;
name|w
operator|=
name|wEnd
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
block|{
name|mask
operator|=
name|cfb8PixelMasks
index|[
name|GetFourBits
argument_list|(
name|bits
argument_list|)
index|]
expr_stmt|;
name|dst
operator|=
name|dstTmp
operator|+
operator|(
name|nlwMiddle
operator|<<
literal|3
operator|)
expr_stmt|;
operator|*
name|dst
operator|=
operator|(
operator|*
name|dst
operator|&
operator|~
operator|(
name|mask
operator|&
name|endmask
operator|)
operator|)
operator||
operator|(
name|xor
operator|&
operator|(
name|mask
operator|&
name|endmask
operator|)
operator|)
expr_stmt|;
block|}
while|while
condition|(
name|w
operator|--
condition|)
block|{
name|nlw
operator|=
name|nlwMiddle
expr_stmt|;
name|dst
operator|=
name|dstTmp
expr_stmt|;
name|dstTmp
operator|++
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__GNUC__
argument_list|)
operator|&&
name|defined
argument_list|(
name|mc68020
argument_list|)
name|mask
operator|=
name|cfb8PixelMasks
index|[
name|GetFourBits
argument_list|(
name|bits
argument_list|)
index|]
expr_stmt|;
name|xor
operator|=
name|xor
operator|&
name|mask
expr_stmt|;
name|mask
operator|=
operator|~
name|mask
expr_stmt|;
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
operator|*
name|dst
operator|=
operator|(
operator|*
name|dst
operator|&
name|mask
operator|)
operator||
name|xor
expr_stmt|;
name|dst
operator|+=
literal|8
expr_stmt|;
block|}
name|xor
operator|=
name|devPriv
operator|->
name|xor
expr_stmt|;
else|#
directive|else
define|#
directive|define
name|SwitchBitsLoop
parameter_list|(
name|body
parameter_list|)
define|\
value|while (nlw--)	\ 	{		\ 	    body	\ 	    dst += 8;	\ 	}
name|SwitchFourBits
argument_list|(
name|dst
argument_list|,
name|xor
argument_list|,
name|GetFourBits
argument_list|(
name|bits
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SwitchBitsLoop
endif|#
directive|endif
name|NextFourBits
argument_list|(
name|bits
argument_list|)
expr_stmt|;
block|}
name|nlwMiddle
operator|++
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|bits
operator|=
name|src
index|[
name|y
index|]
expr_stmt|;
name|y
operator|+=
name|nlwSrc
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|stippleHeight
condition|)
name|y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rot
operator|!=
literal|0
condition|)
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
name|rot
argument_list|)
expr_stmt|;
name|dst
operator|=
name|dstLine
expr_stmt|;
name|dstLine
operator|+=
name|nlwDst
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|xor
operator|=
name|GetFourBits
argument_list|(
name|bits
argument_list|)
expr_stmt|;
operator|*
name|dst
operator|=
name|MaskRRopPixels
argument_list|(
operator|*
name|dst
argument_list|,
name|xor
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|dst
operator|++
expr_stmt|;
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|nlw
operator|=
name|nlwMiddle
expr_stmt|;
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
name|RRopFourBits
argument_list|(
name|dst
argument_list|,
name|GetFourBits
argument_list|(
name|bits
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|++
expr_stmt|;
name|RotBitsLeft
argument_list|(
name|bits
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
name|xor
operator|=
name|GetFourBits
argument_list|(
name|bits
argument_list|)
expr_stmt|;
operator|*
name|dst
operator|=
name|MaskRRopPixels
argument_list|(
operator|*
name|dst
argument_list|,
name|xor
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_block

begin_function
name|void
name|cfb8FillRectStippledUnnatural
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nBox
parameter_list|,
name|pBox
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|nBox
decl_stmt|;
specifier|register
name|BoxPtr
name|pBox
decl_stmt|;
block|{
name|unsigned
name|long
modifier|*
name|pdstBase
decl_stmt|;
comment|/* pointer to start of bitmap */
name|unsigned
name|long
modifier|*
name|pdstLine
decl_stmt|;
comment|/* current destination line */
name|int
name|nlwDst
decl_stmt|;
comment|/* width in longwords of bitmap */
name|PixmapPtr
name|pStipple
decl_stmt|;
comment|/* pointer to stipple we want to fill with */
name|hpPrivPixmapPtr
name|pPrivStipple
decl_stmt|;
name|int
name|nlwMiddle
decl_stmt|;
specifier|register
name|int
name|nlw
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|,
name|xrem
decl_stmt|,
name|xSrc
decl_stmt|,
name|ySrc
decl_stmt|;
name|int
name|stwidth
decl_stmt|,
name|stippleWidth
decl_stmt|;
name|int
name|stippleHeight
decl_stmt|;
specifier|register
name|unsigned
name|long
name|bits
decl_stmt|,
name|inputBits
decl_stmt|;
specifier|register
name|int
name|partBitsLeft
decl_stmt|;
name|int
name|nextPartBits
decl_stmt|;
name|int
name|bitsLeft
decl_stmt|,
name|bitsWhole
decl_stmt|;
specifier|register
name|unsigned
name|long
modifier|*
name|pdst
decl_stmt|;
comment|/* pointer to current word in bitmap */
name|unsigned
name|long
modifier|*
name|srcTemp
decl_stmt|,
modifier|*
name|srcStart
decl_stmt|;
name|unsigned
name|long
modifier|*
name|psrcBase
decl_stmt|;
name|unsigned
name|long
name|startmask
decl_stmt|,
name|endmask
decl_stmt|;
if|if
condition|(
name|pGC
operator|->
name|fillStyle
operator|==
name|FillStippled
condition|)
name|cfb8CheckStipple
argument_list|(
name|pGC
operator|->
name|alu
argument_list|,
name|pGC
operator|->
name|fgPixel
argument_list|,
name|pGC
operator|->
name|planemask
argument_list|)
expr_stmt|;
else|else
name|cfb8CheckOpaqueStipple
argument_list|(
name|pGC
operator|->
name|alu
argument_list|,
name|pGC
operator|->
name|fgPixel
argument_list|,
name|pGC
operator|->
name|bgPixel
argument_list|,
name|pGC
operator|->
name|planemask
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfb8StippleRRop
operator|==
name|GXnoop
condition|)
return|return;
comment|/*      *  OK,  so what's going on here?  We have two Drawables:      *      *  The Stipple:      *		Depth = 1      *		Width = stippleWidth      *		Words per scanline = stwidth      *		Pointer to pixels = pStipple->devPrivate.ptr      */
name|pStipple
operator|=
name|pGC
operator|->
name|stipple
expr_stmt|;
name|pPrivStipple
operator|=
operator|(
name|hpPrivPixmapPtr
operator|)
name|pStipple
operator|->
name|devPrivate
operator|.
name|ptr
expr_stmt|;
name|stwidth
operator|=
name|pPrivStipple
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
name|stippleWidth
operator|=
name|pStipple
operator|->
name|drawable
operator|.
name|width
expr_stmt|;
name|stippleHeight
operator|=
name|pStipple
operator|->
name|drawable
operator|.
name|height
expr_stmt|;
name|psrcBase
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
name|pPrivStipple
operator|->
name|bits
expr_stmt|;
comment|/*      *	The Target:      *		Depth = PSZ      *		Width = determined from *pwidth      *		Words per scanline = nlwDst      *		Pointer to pixels = addrlBase      */
name|xSrc
operator|=
name|pDrawable
operator|->
name|x
expr_stmt|;
name|ySrc
operator|=
name|pDrawable
operator|->
name|y
expr_stmt|;
name|cfbGetLongWidthAndPointer
argument_list|(
argument|pDrawable
argument_list|,
argument|nlwDst
argument_list|,
argument|pdstBase
argument_list|)
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
comment|/* this replaces rotating the stipple. Instead we just adjust the offset      * at which we start grabbing bits from the stipple.      * Ensure that ppt->x - xSrc>= 0 and ppt->y - ySrc>= 0,      * so that iline and xrem always stay within the stipple bounds.      */
name|xSrc
operator|+=
operator|(
name|pGC
operator|->
name|patOrg
operator|.
name|x
operator|%
name|stippleWidth
operator|)
operator|-
name|stippleWidth
expr_stmt|;
name|ySrc
operator|+=
operator|(
name|pGC
operator|->
name|patOrg
operator|.
name|y
operator|%
name|stippleHeight
operator|)
operator|-
name|stippleHeight
expr_stmt|;
name|bitsWhole
operator|=
name|stippleWidth
expr_stmt|;
while|while
condition|(
name|nBox
operator|--
condition|)
block|{
name|x
operator|=
name|pBox
operator|->
name|x1
expr_stmt|;
name|y
operator|=
name|pBox
operator|->
name|y1
expr_stmt|;
name|w
operator|=
name|pBox
operator|->
name|x2
operator|-
name|x
expr_stmt|;
name|h
operator|=
name|pBox
operator|->
name|y2
operator|-
name|y
expr_stmt|;
name|pBox
operator|++
expr_stmt|;
name|pdstLine
operator|=
name|pdstBase
operator|+
name|y
operator|*
name|nlwDst
operator|+
operator|(
name|x
operator|>>
name|PWSH
operator|)
expr_stmt|;
name|y
operator|=
operator|(
name|y
operator|-
name|ySrc
operator|)
operator|%
name|stippleHeight
expr_stmt|;
name|srcStart
operator|=
name|psrcBase
operator|+
name|y
operator|*
name|stwidth
expr_stmt|;
name|xrem
operator|=
operator|(
operator|(
name|x
operator|&
operator|~
literal|3
operator|)
operator|-
name|xSrc
operator|)
operator|%
name|stippleWidth
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|x
operator|&
name|PIM
operator|)
operator|+
name|w
operator|)
operator|<
name|PPW
condition|)
block|{
name|maskpartialbits
argument_list|(
name|x
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|nlwMiddle
operator|=
literal|0
expr_stmt|;
name|endmask
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|x
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlwMiddle
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|h
operator|--
condition|)
block|{
name|srcTemp
operator|=
name|srcStart
operator|+
operator|(
name|xrem
operator|>>
literal|5
operator|)
expr_stmt|;
name|bitsLeft
operator|=
name|stippleWidth
operator|-
operator|(
name|xrem
operator|&
operator|~
literal|0x1f
operator|)
expr_stmt|;
name|NextUnnaturalStippleWord
name|NextSomeBits
argument_list|(
name|inputBits
argument_list|,
operator|(
name|xrem
operator|&
literal|0x1f
operator|)
argument_list|)
decl_stmt|;
name|partBitsLeft
operator|-=
operator|(
name|xrem
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|NextUnnaturalStippleBits
name|nlw
init|=
name|nlwMiddle
decl_stmt|;
name|pdst
operator|=
name|pdstLine
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
operator|*
name|pdst
operator|=
name|MaskRRopPixels
argument_list|(
operator|*
name|pdst
argument_list|,
name|bits
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
name|NextUnnaturalStippleBits
block|}
while|while
condition|(
name|nlw
operator|--
condition|)
block|{
operator|*
name|pdst
operator|=
name|RRopPixels
argument_list|(
operator|*
name|pdst
argument_list|,
name|bits
argument_list|)
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
name|NextUnnaturalStippleBits
block|}
if|if
condition|(
name|endmask
condition|)
operator|*
name|pdst
operator|=
name|MaskRRopPixels
argument_list|(
operator|*
name|pdst
argument_list|,
name|bits
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
name|pdstLine
operator|+=
name|nlwDst
expr_stmt|;
name|y
operator|++
expr_stmt|;
name|srcStart
operator|+=
name|stwidth
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|stippleHeight
condition|)
block|{
name|y
operator|=
literal|0
expr_stmt|;
name|srcStart
operator|=
name|psrcBase
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


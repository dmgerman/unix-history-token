begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	File: xtest1dd.c  *  *	This file contains the device dependent parts of the input  *	synthesis extension.  */
end_comment

begin_comment
comment|/*  Copyright 1986, 1987, 1988 by Hewlett-Packard Corporation Copyright 1986, 1987, 1988 by the Massachusetts Institute of Technology  Permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  Hewlett-Packard and M.I.T. make no representations about the  suitability of this software for any purpose.  It is provided  "as is" without express or implied warranty.  This software is not subject to any license of the American Telephone and Telegraph Company or of the Regents of the University of California.  */
end_comment

begin_comment
comment|/***************************************************************  * include files  ***************************************************************/
end_comment

begin_define
define|#
directive|define
name|NEED_EVENTS
end_define

begin_define
define|#
directive|define
name|NEED_REPLIES
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xproto.h"
end_include

begin_include
include|#
directive|include
file|"inputstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_define
define|#
directive|define
name|XTestSERVER_SIDE
end_define

begin_include
include|#
directive|include
file|"xtestext1.h"
end_include

begin_comment
comment|/*  * the following include files are specific to HP's implementation  * of the extension.  Your implementation may vary.  */
end_comment

begin_include
include|#
directive|include
file|"hildef.h"
end_include

begin_include
include|#
directive|include
file|"hpext.h"
end_include

begin_include
include|#
directive|include
file|"XHPproto.h"
end_include

begin_comment
comment|/*  * The following externs are specific to HP's implementation  * of the extension.  Your implementation may vary.  */
end_comment

begin_decl_stmt
specifier|extern
name|ScreenInfo
name|screenInfo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|InputInfo
name|inputInfo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|HPInputDevice
modifier|*
name|hpPointer
decl_stmt|,
modifier|*
name|hpKeyboard
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|lastEventTime
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************************************************************  *  *	XTestGetPointerPos  *  * Return the position of the mouse.  *  */
end_comment

begin_function
name|void
name|XTestGetPointerPos
parameter_list|(
name|fmousex
parameter_list|,
name|fmousey
parameter_list|)
name|short
modifier|*
name|fmousex
decl_stmt|,
decl|*
name|fmousey
decl_stmt|;
end_function

begin_block
block|{
operator|*
name|fmousex
operator|=
name|hpPointer
operator|->
name|coords
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|fmousey
operator|=
name|hpPointer
operator|->
name|coords
index|[
literal|1
index|]
expr_stmt|;
block|}
end_block

begin_comment
comment|/******************************************************************************  *  *	XTestJumpPointer  *  *	Tell the server to move the mouse.  *  *	This is implementation-dependent.  Your implementation may vary.  */
end_comment

begin_function
name|void
name|XTestJumpPointer
parameter_list|(
name|jx
parameter_list|,
name|jy
parameter_list|,
name|dev_type
parameter_list|)
comment|/*  * the x and y position to move the mouse to  */
name|int
name|jx
decl_stmt|;
name|int
name|jy
decl_stmt|;
comment|/*  * which device is supposed to move (ignored)  */
name|int
name|dev_type
decl_stmt|;
block|{
name|int
name|xdiff
decl_stmt|,
name|screensize
decl_stmt|;
name|ScreenPtr
name|pScreen
init|=
name|hpPointer
operator|->
name|pScreen
decl_stmt|;
name|xEvent
modifier|*
name|format_ev
argument_list|()
decl_stmt|,
modifier|*
name|ev
decl_stmt|;
specifier|extern
name|xHPEvent
name|xE
decl_stmt|;
name|int
name|coords
index|[
name|MAX_AXES
index|]
decl_stmt|;
comment|/* 	 * set the last event time so that the screen saver code will 	 * think that the mouse has been moved 	 */
name|lastEventTime
operator|=
name|GetTimeInMillis
argument_list|()
expr_stmt|;
comment|/* 	 * move the mouse. 	 * The kludge below is an attempt to make it possible to  	 * test stacked screens mode.  Xtm records absolute screen 	 * positions, so we have trouble knowing whether or not the 	 * screen changed.  We make an arbitrary assumption here that 	 * if we moved more than 500 pixels in the x direction that 	 * we must have wrapped from one screen to another.  This is 	 * a fairly safe assumption unless someone set the mouse 	 * acceleration to some unreasonably large number. 	 * 	 * In any case, translate the absolute postions into a relative 	 * move from the current pointer position, and pass that 	 * relative move to process_motion. 	 */
name|xdiff
operator|=
name|jx
operator|-
name|hpPointer
operator|->
name|coords
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|abs
argument_list|(
name|xdiff
argument_list|)
operator|>
literal|500
operator|&&
name|screenInfo
operator|.
name|numScreens
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|xdiff
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|pScreen
operator|->
name|myNum
operator|!=
literal|0
condition|)
name|screensize
operator|=
name|screenInfo
operator|.
name|screens
index|[
name|pScreen
operator|->
name|myNum
operator|-
literal|1
index|]
operator|->
name|width
expr_stmt|;
else|else
name|screensize
operator|=
name|screenInfo
operator|.
name|screens
index|[
name|screenInfo
operator|.
name|numScreens
operator|-
literal|1
index|]
operator|->
name|width
expr_stmt|;
name|xdiff
operator|-=
name|screensize
expr_stmt|;
block|}
else|else
name|xdiff
operator|+=
name|pScreen
operator|->
name|width
expr_stmt|;
block|}
name|coords
index|[
literal|0
index|]
operator|=
name|xdiff
expr_stmt|;
name|coords
index|[
literal|1
index|]
operator|=
name|jy
operator|-
name|hpPointer
operator|->
name|coords
index|[
literal|1
index|]
expr_stmt|;
name|process_motion
argument_list|(
name|inputInfo
operator|.
name|pointer
argument_list|,
name|hpPointer
argument_list|,
name|hpPointer
argument_list|,
name|coords
argument_list|)
expr_stmt|;
name|ev
operator|=
name|format_ev
argument_list|(
name|MotionNotify
argument_list|,
literal|0
argument_list|,
name|lastEventTime
argument_list|,
name|hpPointer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ProcessInputEvents
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  *	XTestGenerateEvent  *  *	Send a key/button input action to the server to be processed.  *  *	This is implementation-dependent.  Your implementation may vary.  */
end_comment

begin_function
name|void
name|XTestGenerateEvent
parameter_list|(
name|dev_type
parameter_list|,
name|keycode
parameter_list|,
name|keystate
parameter_list|,
name|mousex
parameter_list|,
name|mousey
parameter_list|)
comment|/*  * which device supposedly performed the action  */
name|int
name|dev_type
decl_stmt|;
comment|/*  * which key/button moved  */
name|int
name|keycode
decl_stmt|;
comment|/*  * whether the key/button was up or down  */
name|int
name|keystate
decl_stmt|;
comment|/*  * the x and y position of the locator when the action happenned  */
name|int
name|mousex
decl_stmt|;
name|int
name|mousey
decl_stmt|;
block|{
name|HPInputDevice
modifier|*
name|tmp_ptr
decl_stmt|;
name|xEvent
modifier|*
name|format_ev
argument_list|()
decl_stmt|,
modifier|*
name|ev
decl_stmt|;
comment|/* 	 * the server expects to have the x and y position of the locator 	 * when the action happened placed in hpPointer. 	 */
if|if
condition|(
name|dev_type
operator|==
name|MOUSE
condition|)
block|{
name|hpPointer
operator|->
name|coords
index|[
literal|0
index|]
operator|=
name|mousex
expr_stmt|;
name|hpPointer
operator|->
name|coords
index|[
literal|1
index|]
operator|=
name|mousey
expr_stmt|;
name|tmp_ptr
operator|=
name|hpPointer
expr_stmt|;
block|}
else|else
block|{
name|hpPointer
operator|->
name|coords
index|[
literal|0
index|]
operator|=
name|mousex
expr_stmt|;
name|hpPointer
operator|->
name|coords
index|[
literal|1
index|]
operator|=
name|mousey
expr_stmt|;
name|tmp_ptr
operator|=
name|hpKeyboard
expr_stmt|;
block|}
comment|/* 	 * convert the keystate back into server-dependent state values 	 */
if|if
condition|(
name|keycode
operator|<
literal|8
condition|)
block|{
comment|/* 		 * if keycode< 8, this is really a button.  		 */
if|if
condition|(
name|keystate
operator|==
name|XTestKEY_UP
condition|)
block|{
name|keystate
operator|=
name|ButtonRelease
expr_stmt|;
block|}
else|else
block|{
name|keystate
operator|=
name|ButtonPress
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|keystate
operator|==
name|XTestKEY_UP
condition|)
block|{
name|keystate
operator|=
name|KeyRelease
expr_stmt|;
block|}
else|else
block|{
name|keystate
operator|=
name|KeyPress
expr_stmt|;
block|}
block|}
comment|/* 	 * Tell the server to process all of the events in its input queue. 	 * This makes sure that there is room in the server's input queue 	 * for a key/button input event. 	 */
name|ProcessInputEvents
argument_list|()
expr_stmt|;
comment|/* 	 * set the last event time so that the screen saver code will 	 * think that a key has been pressed 	 */
name|lastEventTime
operator|=
name|GetTimeInMillis
argument_list|()
expr_stmt|;
comment|/* 	 * put a key/button input action into the servers input event queue 	 */
name|ev
operator|=
name|format_ev
argument_list|(
name|keystate
argument_list|,
name|keycode
argument_list|,
name|lastEventTime
argument_list|,
name|tmp_ptr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Tell the server to process all of the events in its input queue. 	 * This makes sure that key/button event we just put in the queue 	 * is processed immediately. 	 */
name|ProcessInputEvents
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  *	check_for_motion_steal  *  *	Called from xosMoveMouse.  */
end_comment

begin_expr_stmt
name|check_for_motion_steal
argument_list|(
name|hotX
argument_list|,
name|hotY
argument_list|)
specifier|register
name|int
name|hotX
operator|,
name|hotY
expr_stmt|;
end_expr_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|XTESTEXT1
specifier|extern
name|int
name|on_steal_input
decl_stmt|;
comment|/* defined in xtestext1di.c */
specifier|extern
name|short
name|xtest_mousex
decl_stmt|;
comment|/* defined in xtestext1di.c */
specifier|extern
name|short
name|xtest_mousey
decl_stmt|;
comment|/* defined in xtestext1di.c */
if|if
condition|(
operator|(
name|on_steal_input
operator|)
operator|&&
operator|(
operator|(
name|hotX
operator|!=
name|xtest_mousex
operator|)
operator|||
operator|(
name|hotY
operator|!=
name|xtest_mousey
operator|)
operator|)
condition|)
comment|/* mouse moved    */
block|{
name|XTestStealMotionData
argument_list|(
operator|(
name|hotX
operator|-
name|xtest_mousex
operator|)
argument_list|,
operator|(
name|hotY
operator|-
name|xtest_mousey
operator|)
argument_list|,
name|MOUSE
argument_list|,
name|xtest_mousex
argument_list|,
name|xtest_mousey
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* XTESTEXT1 */
block|}
end_block

end_unit


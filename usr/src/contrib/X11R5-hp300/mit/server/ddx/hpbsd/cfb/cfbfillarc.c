begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************ Copyright 1989 by The Massachusetts Institute of Technology  Permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of MIT not be used in advertising or publicity pertaining to distribution of the software without specific prior written permission. M.I.T. makes no representation about the suitability of this software for any purpose. It is provided "as is" without any express or implied warranty.  ********************************************************/
end_comment

begin_comment
comment|/* $XConsortium: cfbfillarc.c,v 5.12 91/04/10 11:41:49 keith Exp $ */
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xprotostr.h"
end_include

begin_include
include|#
directive|include
file|"miscstruct.h"
end_include

begin_include
include|#
directive|include
file|"gcstruct.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"cfb.h"
end_include

begin_include
include|#
directive|include
file|"cfbmskbits.h"
end_include

begin_include
include|#
directive|include
file|"mifillarc.h"
end_include

begin_include
include|#
directive|include
file|"cfbrrop.h"
end_include

begin_function_decl
specifier|extern
name|void
name|miPolyFillArc
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* gcc 1.35 is stupid */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__GNUC__
argument_list|)
operator|&&
name|defined
argument_list|(
name|mc68020
argument_list|)
end_if

begin_define
define|#
directive|define
name|STUPID
value|volatile
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|STUPID
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|RROP_NAME
function|(
name|cfbFillEllipseSolid
function|)
parameter_list|(
name|pDraw
parameter_list|,
name|pGC
parameter_list|,
name|arc
parameter_list|)
name|DrawablePtr
name|pDraw
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|xArc
modifier|*
name|arc
decl_stmt|;
block|{
name|STUPID
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|e
decl_stmt|;
name|STUPID
name|int
name|yk
decl_stmt|,
name|xk
decl_stmt|,
name|ym
decl_stmt|,
name|xm
decl_stmt|,
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|xorg
decl_stmt|,
name|yorg
decl_stmt|;
name|miFillArcRec
name|info
decl_stmt|;
name|unsigned
name|long
modifier|*
name|addrlt
decl_stmt|,
modifier|*
name|addrlb
decl_stmt|;
specifier|register
name|unsigned
name|long
modifier|*
name|addrl
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
name|int
name|nlwidth
decl_stmt|;
name|RROP_DECLARE
specifier|register
name|int
name|xpos
decl_stmt|;
specifier|register
name|int
name|slw
decl_stmt|;
name|unsigned
name|long
name|startmask
decl_stmt|,
name|endmask
decl_stmt|;
name|int
name|nlmiddle
decl_stmt|;
name|cfbGetLongWidthAndPointer
argument_list|(
argument|pDraw
argument_list|,
argument|nlwidth
argument_list|,
argument|addrlt
argument_list|)
name|RROP_FETCH_GC
argument_list|(
name|pGC
argument_list|)
expr_stmt|;
name|miFillArcSetup
argument_list|(
name|arc
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
name|MIFILLARCSETUP
argument_list|()
expr_stmt|;
name|xorg
operator|+=
name|pDraw
operator|->
name|x
expr_stmt|;
name|yorg
operator|+=
name|pDraw
operator|->
name|y
expr_stmt|;
name|addrlb
operator|=
name|addrlt
expr_stmt|;
name|addrlt
operator|+=
name|nlwidth
operator|*
operator|(
name|yorg
operator|-
name|y
operator|)
expr_stmt|;
name|addrlb
operator|+=
name|nlwidth
operator|*
operator|(
name|yorg
operator|+
name|y
operator|+
name|dy
operator|)
expr_stmt|;
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDraw
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
while|while
condition|(
name|y
condition|)
block|{
name|addrlt
operator|+=
name|nlwidth
expr_stmt|;
name|addrlb
operator|-=
name|nlwidth
expr_stmt|;
name|MIFILLARCSTEP
argument_list|(
name|slw
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|slw
condition|)
continue|continue;
name|xpos
operator|=
name|xorg
operator|-
name|x
expr_stmt|;
name|addrl
operator|=
name|addrlt
operator|+
operator|(
name|xpos
operator|>>
name|PWSH
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|xpos
operator|&
name|PIM
operator|)
operator|+
name|slw
operator|)
operator|<=
name|PPW
condition|)
block|{
name|maskpartialbits
argument_list|(
name|xpos
argument_list|,
name|slw
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|RROP_SOLID_MASK
argument_list|(
name|addrl
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|miFillArcLower
argument_list|(
name|slw
argument_list|)
condition|)
block|{
name|addrl
operator|=
name|addrlb
operator|+
operator|(
name|xpos
operator|>>
name|PWSH
operator|)
expr_stmt|;
name|RROP_SOLID_MASK
argument_list|(
name|addrl
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
name|maskbits
argument_list|(
name|xpos
argument_list|,
name|slw
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|RROP_SOLID_MASK
argument_list|(
name|addrl
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|addrl
operator|++
expr_stmt|;
block|}
name|n
operator|=
name|nlmiddle
expr_stmt|;
name|RROP_SPAN
argument_list|(
argument|addrl
argument_list|,
argument|n
argument_list|)
if|if
condition|(
name|endmask
condition|)
name|RROP_SOLID_MASK
argument_list|(
name|addrl
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|miFillArcLower
argument_list|(
name|slw
argument_list|)
condition|)
continue|continue;
name|addrl
operator|=
name|addrlb
operator|+
operator|(
name|xpos
operator|>>
name|PWSH
operator|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|RROP_SOLID_MASK
argument_list|(
name|addrl
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|addrl
operator|++
expr_stmt|;
block|}
name|n
operator|=
name|nlmiddle
expr_stmt|;
name|RROP_SPAN
argument_list|(
name|addrl
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
name|RROP_SOLID_MASK
argument_list|(
name|addrl
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|FILLSPAN
parameter_list|(
name|xl
parameter_list|,
name|xr
parameter_list|,
name|addr
parameter_list|)
define|\
value|if (xr>= xl) \     { \ 	n = xr - xl + 1; \ 	addrl = addr + (xl>> PWSH); \ 	if (((xl& PIM) + n)<= PPW) \ 	{ \ 	    maskpartialbits(xl, n, startmask); \ 	    RROP_SOLID_MASK(addrl, startmask); \ 	} \ 	else \ 	{ \ 	    maskbits(xl, n, startmask, endmask, n); \ 	    if (startmask) \ 	    { \ 		RROP_SOLID_MASK(addrl, startmask); \ 		addrl++; \ 	    } \ 	    while (n--) \ 	    { \ 		RROP_SOLID(addrl); \ 		++addrl; \ 	    } \ 	    if (endmask) \ 		RROP_SOLID_MASK(addrl, endmask); \ 	} \     }
end_define

begin_define
define|#
directive|define
name|FILLSLICESPANS
parameter_list|(
name|flip
parameter_list|,
name|addr
parameter_list|)
define|\
value|if (!flip) \     { \ 	FILLSPAN(xl, xr, addr); \     } \     else \     { \ 	xc = xorg - x; \ 	FILLSPAN(xc, xr, addr); \ 	xc += slw - 1; \ 	FILLSPAN(xl, xc, addr); \     }
end_define

begin_function
specifier|static
name|void
name|RROP_NAME
function|(
name|cfbFillArcSliceSolid
function|)
parameter_list|(
name|pDraw
parameter_list|,
name|pGC
parameter_list|,
name|arc
parameter_list|)
name|DrawablePtr
name|pDraw
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|xArc
modifier|*
name|arc
decl_stmt|;
block|{
name|int
name|yk
decl_stmt|,
name|xk
decl_stmt|,
name|ym
decl_stmt|,
name|xm
decl_stmt|,
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|xorg
decl_stmt|,
name|yorg
decl_stmt|,
name|slw
decl_stmt|;
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|e
decl_stmt|;
name|miFillArcRec
name|info
decl_stmt|;
name|miArcSliceRec
name|slice
decl_stmt|;
name|int
name|xl
decl_stmt|,
name|xr
decl_stmt|,
name|xc
decl_stmt|;
name|unsigned
name|long
modifier|*
name|addrlt
decl_stmt|,
modifier|*
name|addrlb
decl_stmt|;
specifier|register
name|unsigned
name|long
modifier|*
name|addrl
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
name|int
name|nlwidth
decl_stmt|;
name|RROP_DECLARE
name|unsigned
name|long
name|startmask
decl_stmt|,
name|endmask
decl_stmt|;
name|cfbGetLongWidthAndPointer
argument_list|(
argument|pDraw
argument_list|,
argument|nlwidth
argument_list|,
argument|addrlt
argument_list|)
name|RROP_FETCH_GC
argument_list|(
name|pGC
argument_list|)
expr_stmt|;
name|miFillArcSetup
argument_list|(
name|arc
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
name|miFillArcSliceSetup
argument_list|(
name|arc
argument_list|,
operator|&
name|slice
argument_list|,
name|pGC
argument_list|)
expr_stmt|;
name|MIFILLARCSETUP
argument_list|()
expr_stmt|;
name|xorg
operator|+=
name|pDraw
operator|->
name|x
expr_stmt|;
name|yorg
operator|+=
name|pDraw
operator|->
name|y
expr_stmt|;
name|addrlb
operator|=
name|addrlt
expr_stmt|;
name|addrlt
operator|+=
name|nlwidth
operator|*
operator|(
name|yorg
operator|-
name|y
operator|)
expr_stmt|;
name|addrlb
operator|+=
name|nlwidth
operator|*
operator|(
name|yorg
operator|+
name|y
operator|+
name|dy
operator|)
expr_stmt|;
name|slice
operator|.
name|edge1
operator|.
name|x
operator|+=
name|pDraw
operator|->
name|x
expr_stmt|;
name|slice
operator|.
name|edge2
operator|.
name|x
operator|+=
name|pDraw
operator|->
name|x
expr_stmt|;
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDraw
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
while|while
condition|(
name|y
operator|>
literal|0
condition|)
block|{
name|addrlt
operator|+=
name|nlwidth
expr_stmt|;
name|addrlb
operator|-=
name|nlwidth
expr_stmt|;
name|MIFILLARCSTEP
argument_list|(
name|slw
argument_list|)
expr_stmt|;
name|MIARCSLICESTEP
argument_list|(
name|slice
operator|.
name|edge1
argument_list|)
expr_stmt|;
name|MIARCSLICESTEP
argument_list|(
name|slice
operator|.
name|edge2
argument_list|)
expr_stmt|;
if|if
condition|(
name|miFillSliceUpper
argument_list|(
name|slice
argument_list|)
condition|)
block|{
name|MIARCSLICEUPPER
argument_list|(
name|xl
argument_list|,
name|xr
argument_list|,
name|slice
argument_list|,
name|slw
argument_list|)
expr_stmt|;
name|FILLSLICESPANS
argument_list|(
name|slice
operator|.
name|flip_top
argument_list|,
name|addrlt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|miFillSliceLower
argument_list|(
name|slice
argument_list|)
condition|)
block|{
name|MIARCSLICELOWER
argument_list|(
name|xl
argument_list|,
name|xr
argument_list|,
name|slice
argument_list|,
name|slw
argument_list|)
expr_stmt|;
name|FILLSLICESPANS
argument_list|(
name|slice
operator|.
name|flip_bot
argument_list|,
name|addrlb
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|RROP_NAME
function|(
name|cfbPolyFillArcSolid
function|)
parameter_list|(
name|pDraw
parameter_list|,
name|pGC
parameter_list|,
name|narcs
parameter_list|,
name|parcs
parameter_list|)
name|DrawablePtr
name|pDraw
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|narcs
decl_stmt|;
name|xArc
modifier|*
name|parcs
decl_stmt|;
block|{
specifier|register
name|xArc
modifier|*
name|arc
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|BoxRec
name|box
decl_stmt|;
name|RegionPtr
name|cclip
decl_stmt|;
name|cclip
operator|=
operator|(
operator|(
name|cfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
expr_stmt|;
for|for
control|(
name|arc
operator|=
name|parcs
operator|,
name|i
operator|=
name|narcs
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
name|arc
operator|++
control|)
block|{
if|if
condition|(
name|miFillArcEmpty
argument_list|(
name|arc
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|miCanFillArc
argument_list|(
name|arc
argument_list|)
condition|)
block|{
name|box
operator|.
name|x1
operator|=
name|arc
operator|->
name|x
operator|+
name|pDraw
operator|->
name|x
expr_stmt|;
name|box
operator|.
name|y1
operator|=
name|arc
operator|->
name|y
operator|+
name|pDraw
operator|->
name|y
expr_stmt|;
name|box
operator|.
name|x2
operator|=
name|box
operator|.
name|x1
operator|+
operator|(
name|int
operator|)
name|arc
operator|->
name|width
operator|+
literal|1
expr_stmt|;
name|box
operator|.
name|y2
operator|=
name|box
operator|.
name|y1
operator|+
operator|(
name|int
operator|)
name|arc
operator|->
name|height
operator|+
literal|1
expr_stmt|;
if|if
condition|(
call|(
modifier|*
name|pDraw
operator|->
name|pScreen
operator|->
name|RectIn
call|)
argument_list|(
name|cclip
argument_list|,
operator|&
name|box
argument_list|)
operator|==
name|rgnIN
condition|)
block|{
if|if
condition|(
operator|(
name|arc
operator|->
name|angle2
operator|>=
name|FULLCIRCLE
operator|)
operator|||
operator|(
name|arc
operator|->
name|angle2
operator|<=
operator|-
name|FULLCIRCLE
operator|)
condition|)
name|RROP_NAME
function_decl|(
name|cfbFillEllipseSolid
function_decl|)
parameter_list|(
name|pDraw
parameter_list|,
name|pGC
parameter_list|,
name|arc
parameter_list|)
function_decl|;
else|else
name|RROP_NAME
function_decl|(
name|cfbFillArcSliceSolid
function_decl|)
parameter_list|(
name|pDraw
parameter_list|,
name|pGC
parameter_list|,
name|arc
parameter_list|)
function_decl|;
continue|continue;
block|}
block|}
name|miPolyFillArc
argument_list|(
name|pDraw
argument_list|,
name|pGC
argument_list|,
literal|1
argument_list|,
name|arc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


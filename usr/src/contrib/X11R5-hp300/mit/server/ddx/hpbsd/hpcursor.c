begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $XConsortium: hpcursor.c,v 1.5 88/09/06 15:26:07 jim Exp $ */
end_comment

begin_comment
comment|/*  * hpcursor.c : hp soft cursor routines  * C Durland, C Amacher  */
end_comment

begin_comment
comment|/* Copyright (c) 1986, 1987 by Hewlett-Packard Company Copyright (c) 1986, 1987 by the Massachusetts Institute of Technology  Permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  HEWLETT-PACKARD MAKES NO WARRANTY OF ANY KIND WITH REGARD TO THIS SOFWARE, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  PURPOSE.  Hewlett-Packard shall not be liable for errors  contained herein or direct, indirect, special, incidental or  consequential damages in connection with the furnishing,  performance, or use of this material.  This software is not subject to any license of the American Telephone and Telegraph Company or of the Regents of the University of California. */
end_comment

begin_define
define|#
directive|define
name|NEED_EVENTS
end_define

begin_comment
comment|/* hack hack hack */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xproto.h"
end_include

begin_include
include|#
directive|include
file|"servermd.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"cursorstr.h"
end_include

begin_include
include|#
directive|include
file|"hppriv.h"
end_include

begin_include
include|#
directive|include
file|"resource.h"
end_include

begin_include
include|#
directive|include
file|"inputstr.h"
end_include

begin_include
include|#
directive|include
file|"hpext.h"
end_include

begin_include
include|#
directive|include
file|"hildef.h"
end_include

begin_include
include|#
directive|include
file|"XHPproto.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|lastEventTime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|HPInputDevice
modifier|*
name|hpPointer
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MAXCX
value|64
end_define

begin_comment
comment|/* max cursor rectangle width */
end_comment

begin_define
define|#
directive|define
name|MAXCY
value|64
end_define

begin_comment
comment|/* max cursor rectangle height */
end_comment

begin_decl_stmt
specifier|static
name|Bool
name|hpRealizeCursor
argument_list|()
decl_stmt|,
name|hpUnrealizeCursor
argument_list|()
decl_stmt|,
name|hpDisplayCursor
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|hpPointerNonInterestBox
argument_list|()
decl_stmt|,
name|hpRecolorCursor
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|Bool
name|hpSetCursorPosition
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|void
name|hpCursorLimits
argument_list|()
decl_stmt|,
name|hpConstrainCursor
argument_list|()
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|XTESTEXT1
end_ifdef

begin_comment
comment|/*  * defined in xtestext1di.c  */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|on_steal_input
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * defined in xtestext1di.c  */
end_comment

begin_decl_stmt
specifier|extern
name|short
name|xtest_mousex
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * defined in xtestext1di.c  */
end_comment

begin_decl_stmt
specifier|extern
name|short
name|xtest_mousey
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XTESTEXT1 */
end_comment

begin_comment
comment|/* restore screen from off screen mem */
end_comment

begin_function
specifier|static
name|void
name|hpCursorOff
parameter_list|(
name|pScreen
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
block|{
specifier|register
name|hpPrivScreenPtr
name|cfb
init|=
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
decl_stmt|;
if|if
condition|(
name|cfb
operator|->
name|cstate
operator|==
name|CURSOR_OFF
condition|)
return|return;
name|cfb
operator|->
name|cstate
operator|=
name|CURSOR_OFF
expr_stmt|;
call|(
modifier|*
name|cfb
operator|->
name|MoveBits
call|)
argument_list|(
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|,
name|cfb
operator|->
name|ssaveX
argument_list|,
name|cfb
operator|->
name|ssaveY
argument_list|,
name|cfb
operator|->
name|saved
operator|.
name|x1
argument_list|,
name|cfb
operator|->
name|saved
operator|.
name|y1
argument_list|,
name|cfb
operator|->
name|w
argument_list|,
name|cfb
operator|->
name|h
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* copy area cursor covers to off screen mem, copy cursor to screen */
end_comment

begin_function
specifier|static
name|void
name|hpCursorOn
parameter_list|(
name|pScreen
parameter_list|,
name|dx
parameter_list|,
name|dy
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
specifier|register
name|int
name|dx
decl_stmt|,
name|dy
decl_stmt|;
comment|/* the cursor hot spot */
block|{
specifier|register
name|hpPrivScreenPtr
name|cfb
init|=
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
decl_stmt|;
specifier|register
name|int
name|srcx
init|=
name|cfb
operator|->
name|srcX
decl_stmt|,
name|srcy
init|=
name|cfb
operator|->
name|srcY
decl_stmt|,
name|maskx
init|=
name|cfb
operator|->
name|maskX
decl_stmt|,
name|masky
init|=
name|cfb
operator|->
name|maskY
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
if|if
condition|(
name|cfb
operator|->
name|cstate
operator|==
name|CURSOR_ON
condition|)
return|return;
comment|/* else cursor is offscreen */
name|dx
operator|-=
name|cfb
operator|->
name|hoffX
expr_stmt|;
name|dy
operator|-=
name|cfb
operator|->
name|hoffY
expr_stmt|;
comment|/* hotspot to upper left corner */
comment|/* clip cursor rectangle */
name|w
operator|=
name|min
argument_list|(
name|cfb
operator|->
name|width
argument_list|,
name|pScreen
operator|->
name|width
operator|-
name|dx
argument_list|)
expr_stmt|;
name|h
operator|=
name|min
argument_list|(
name|cfb
operator|->
name|height
argument_list|,
name|pScreen
operator|->
name|height
operator|-
name|dy
argument_list|)
expr_stmt|;
if|if
condition|(
name|dx
operator|<
literal|0
condition|)
block|{
name|srcx
operator|-=
name|dx
expr_stmt|;
name|maskx
operator|-=
name|dx
expr_stmt|;
name|w
operator|+=
name|dx
expr_stmt|;
name|dx
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|dy
operator|<
literal|0
condition|)
block|{
name|srcy
operator|-=
name|dy
expr_stmt|;
name|masky
operator|-=
name|dy
expr_stmt|;
name|h
operator|+=
name|dy
expr_stmt|;
name|dy
operator|=
literal|0
expr_stmt|;
block|}
call|(
modifier|*
name|cfb
operator|->
name|MoveBits
call|)
argument_list|(
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|,
comment|/* save screen area */
name|dx
argument_list|,
name|dy
argument_list|,
name|cfb
operator|->
name|ssaveX
argument_list|,
name|cfb
operator|->
name|ssaveY
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|cfb
operator|->
name|saved
operator|.
name|x1
operator|=
name|dx
expr_stmt|;
name|cfb
operator|->
name|saved
operator|.
name|y1
operator|=
name|dy
expr_stmt|;
name|cfb
operator|->
name|saved
operator|.
name|x2
operator|=
name|dx
operator|+
name|w
expr_stmt|;
name|cfb
operator|->
name|saved
operator|.
name|y2
operator|=
name|dy
operator|+
name|h
expr_stmt|;
name|cfb
operator|->
name|w
operator|=
name|w
expr_stmt|;
name|cfb
operator|->
name|h
operator|=
name|h
expr_stmt|;
comment|/* mask out cursor shape, put cursor in hole */
call|(
modifier|*
name|cfb
operator|->
name|MoveBits
call|)
argument_list|(
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXand
argument_list|,
name|maskx
argument_list|,
name|masky
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
call|(
modifier|*
name|cfb
operator|->
name|MoveBits
call|)
argument_list|(
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXor
argument_list|,
name|srcx
argument_list|,
name|srcy
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|cfb
operator|->
name|cstate
operator|=
name|CURSOR_ON
expr_stmt|;
comment|/* cursor is on screen */
block|}
end_function

begin_comment
comment|/* move screen cursor hotspot to (hotX,hotY) from wherever it is */
end_comment

begin_function
specifier|static
name|void
name|hpMoveMouse
parameter_list|(
name|pScreen
parameter_list|,
name|hotX
parameter_list|,
name|hotY
parameter_list|,
name|forceit
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
specifier|register
name|int
name|hotX
decl_stmt|,
name|hotY
decl_stmt|;
name|int
name|forceit
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|XTESTEXT1
if|if
condition|(
name|on_steal_input
condition|)
block|{
comment|/* 	 * only call if the mouse position has actually moved 	 */
if|if
condition|(
operator|(
name|hotX
operator|!=
name|xtest_mousex
operator|)
operator|||
operator|(
name|hotY
operator|!=
name|xtest_mousey
operator|)
condition|)
block|{
name|XTestStealMotionData
argument_list|(
operator|(
name|hotX
operator|-
name|xtest_mousex
operator|)
argument_list|,
operator|(
name|hotY
operator|-
name|xtest_mousey
operator|)
argument_list|,
name|MOUSE
argument_list|,
name|xtest_mousex
argument_list|,
name|xtest_mousey
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* XTESTEXT1 */
if|if
condition|(
name|forceit
condition|)
name|hpCursorOff
argument_list|(
name|pScreen
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|<=
name|hotX
operator|&&
literal|0
operator|<=
name|hotY
operator|&&
name|hotX
operator|<
name|pScreen
operator|->
name|width
operator|&&
name|hotY
operator|<
name|pScreen
operator|->
name|height
condition|)
name|hpCursorOn
argument_list|(
name|pScreen
argument_list|,
name|hotX
argument_list|,
name|hotY
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
specifier|extern
name|void
name|hpSpriteFindColors
parameter_list|()
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|tcXY
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
comment|/* address of offscreen mem */
define|\
value|(unsigned char *)(cfb->bits +(y)*cfb->stride +(x))
end_define

begin_function
specifier|static
name|Bool
name|hpDisplayCursor
parameter_list|(
name|pScreen
parameter_list|,
name|pCursor
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
name|CursorPtr
name|pCursor
decl_stmt|;
block|{
specifier|register
name|hpPrivScreenPtr
name|cfb
init|=
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|ctr
decl_stmt|,
modifier|*
name|mtr
decl_stmt|,
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|qtr
decl_stmt|,
name|z
decl_stmt|,
name|startbit
decl_stmt|;
specifier|register
name|short
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|int
name|xstart
decl_stmt|,
name|ystart
decl_stmt|;
name|Pixel
name|fgcolor
decl_stmt|,
name|bgcolor
decl_stmt|;
name|w
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|width
expr_stmt|;
name|h
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|height
expr_stmt|;
comment|/* scale cursor if bigger than max */
name|cfb
operator|->
name|width
operator|=
name|min
argument_list|(
name|w
argument_list|,
name|MAXCX
argument_list|)
expr_stmt|;
name|cfb
operator|->
name|height
operator|=
name|min
argument_list|(
name|h
argument_list|,
name|MAXCY
argument_list|)
expr_stmt|;
name|xstart
operator|=
operator|(
name|w
operator|<=
name|MAXCX
operator|)
condition|?
literal|0
else|:
name|pCursor
operator|->
name|bits
operator|->
name|xhot
operator|-
name|MAXCX
operator|+
operator|(
operator|(
name|w
operator|-
name|pCursor
operator|->
name|bits
operator|->
name|xhot
operator|)
operator|*
name|MAXCX
operator|)
operator|/
name|w
expr_stmt|;
name|startbit
operator|=
literal|0x80
operator|>>
operator|(
name|xstart
operator|%
literal|8
operator|)
expr_stmt|;
name|cfb
operator|->
name|hoffX
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|xhot
operator|-
name|xstart
expr_stmt|;
name|xstart
operator|/=
literal|8
expr_stmt|;
name|ystart
operator|=
operator|(
name|h
operator|<=
name|MAXCY
operator|)
condition|?
literal|0
else|:
name|pCursor
operator|->
name|bits
operator|->
name|yhot
operator|-
name|MAXCY
operator|+
operator|(
operator|(
name|h
operator|-
name|pCursor
operator|->
name|bits
operator|->
name|yhot
operator|)
operator|*
name|MAXCY
operator|)
operator|/
name|h
expr_stmt|;
name|cfb
operator|->
name|hoffY
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|yhot
operator|-
name|ystart
expr_stmt|;
comment|/* convert colors to display specific colors */
name|hpSpriteFindColors
argument_list|(
name|pScreen
argument_list|,
name|pCursor
argument_list|,
operator|&
name|fgcolor
argument_list|,
operator|&
name|bgcolor
argument_list|)
expr_stmt|;
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
comment|/* setup hardware */
comment|/* bytes in each row of pixmaps (including padding) */
name|w
operator|=
operator|(
name|w
operator|+
name|BITMAP_SCANLINE_PAD
operator|-
literal|1
operator|)
operator|/
name|BITMAP_SCANLINE_PAD
operator|*
operator|(
name|BITMAP_SCANLINE_PAD
operator|/
literal|8
operator|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|cfb
operator|->
name|height
condition|;
name|y
operator|++
control|)
block|{
name|ptr
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|source
operator|+
name|w
operator|*
operator|(
name|ystart
operator|+
name|y
operator|)
operator|+
name|xstart
expr_stmt|;
name|qtr
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|mask
operator|+
name|w
operator|*
operator|(
name|ystart
operator|+
name|y
operator|)
operator|+
name|xstart
expr_stmt|;
name|ctr
operator|=
name|tcXY
argument_list|(
name|cfb
operator|->
name|srcX
argument_list|,
name|y
operator|+
name|cfb
operator|->
name|srcY
argument_list|)
expr_stmt|;
comment|/* address of offscreen cursor */
name|mtr
operator|=
name|tcXY
argument_list|(
name|cfb
operator|->
name|maskX
argument_list|,
name|y
operator|+
name|cfb
operator|->
name|maskY
argument_list|)
expr_stmt|;
comment|/* address of offscreen cursor mask */
for|for
control|(
name|z
operator|=
name|startbit
operator|,
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|cfb
operator|->
name|width
condition|;
name|x
operator|++
control|)
block|{
comment|/* cursor mask: all planes = xor(or(all planes)) */
operator|*
name|mtr
operator|++
operator|=
operator|(
operator|*
name|qtr
operator|&
name|z
operator|)
condition|?
literal|0
else|:
literal|0xFF
expr_stmt|;
comment|/* squeeze cursor through mask */
operator|*
name|ctr
operator|++
operator|=
operator|(
operator|*
name|qtr
operator|&
name|z
operator|)
condition|?
operator|(
operator|(
operator|*
name|ptr
operator|&
name|z
operator|)
condition|?
name|fgcolor
else|:
name|bgcolor
operator|)
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|z
operator|>>=
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|z
operator|=
literal|0x80
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|qtr
operator|++
expr_stmt|;
block|}
block|}
block|}
name|hpMoveMouse
argument_list|(
name|pScreen
argument_list|,
name|hpPointer
operator|->
name|coords
index|[
literal|0
index|]
argument_list|,
name|hpPointer
operator|->
name|coords
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|hpmDisplayCursor
parameter_list|(
name|pScreen
parameter_list|,
name|pCursor
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
name|CursorPtr
name|pCursor
decl_stmt|;
block|{
specifier|register
name|hpPrivScreenPtr
name|cfb
init|=
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|ctr
decl_stmt|,
modifier|*
name|mtr
decl_stmt|,
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|qtr
decl_stmt|,
name|z
decl_stmt|,
name|z1
decl_stmt|,
name|startbit
decl_stmt|;
specifier|register
name|short
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|int
name|xstart
decl_stmt|,
name|ystart
decl_stmt|;
name|Pixel
name|fgcolor
decl_stmt|,
name|bgcolor
decl_stmt|;
name|w
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|width
expr_stmt|;
name|h
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|height
expr_stmt|;
comment|/* scale cursor if bigger than max */
name|cfb
operator|->
name|width
operator|=
name|min
argument_list|(
name|w
argument_list|,
name|MAXCX
argument_list|)
expr_stmt|;
name|cfb
operator|->
name|height
operator|=
name|min
argument_list|(
name|h
argument_list|,
name|MAXCY
argument_list|)
expr_stmt|;
name|xstart
operator|=
operator|(
name|w
operator|<=
name|MAXCX
operator|)
condition|?
literal|0
else|:
name|pCursor
operator|->
name|bits
operator|->
name|xhot
operator|-
name|MAXCX
operator|+
operator|(
operator|(
name|w
operator|-
name|pCursor
operator|->
name|bits
operator|->
name|xhot
operator|)
operator|*
name|MAXCX
operator|)
operator|/
name|w
expr_stmt|;
name|startbit
operator|=
literal|0x80
operator|>>
operator|(
name|xstart
operator|%
literal|8
operator|)
expr_stmt|;
name|cfb
operator|->
name|hoffX
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|xhot
operator|-
name|xstart
expr_stmt|;
name|xstart
operator|/=
literal|8
expr_stmt|;
name|ystart
operator|=
operator|(
name|h
operator|<=
name|MAXCY
operator|)
condition|?
literal|0
else|:
name|pCursor
operator|->
name|bits
operator|->
name|yhot
operator|-
name|MAXCY
operator|+
operator|(
operator|(
name|h
operator|-
name|pCursor
operator|->
name|bits
operator|->
name|yhot
operator|)
operator|*
name|MAXCY
operator|)
operator|/
name|h
expr_stmt|;
name|cfb
operator|->
name|hoffY
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|yhot
operator|-
name|ystart
expr_stmt|;
comment|/* convert colors to display specific colors */
name|hpSpriteFindColors
argument_list|(
name|pScreen
argument_list|,
name|pCursor
argument_list|,
operator|&
name|fgcolor
argument_list|,
operator|&
name|bgcolor
argument_list|)
expr_stmt|;
name|fgcolor
operator|=
operator|(
name|fgcolor
operator|==
literal|0
operator|)
condition|?
literal|0
else|:
literal|0xFF
expr_stmt|;
name|bgcolor
operator|=
operator|(
name|bgcolor
operator|==
literal|0
operator|)
condition|?
literal|0
else|:
literal|0xFF
expr_stmt|;
comment|/* SET_REGISTERS_FOR_WRITING(pScreen,~0,GXcopy);	  /* setup hardware */
comment|/* bytes in each row of pixmaps (including padding) */
name|w
operator|=
operator|(
name|w
operator|+
name|BITMAP_SCANLINE_PAD
operator|-
literal|1
operator|)
operator|/
name|BITMAP_SCANLINE_PAD
operator|*
operator|(
name|BITMAP_SCANLINE_PAD
operator|/
literal|8
operator|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|cfb
operator|->
name|height
condition|;
name|y
operator|++
control|)
block|{
name|ptr
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|source
operator|+
name|w
operator|*
operator|(
name|ystart
operator|+
name|y
operator|)
operator|+
name|xstart
expr_stmt|;
name|qtr
operator|=
name|pCursor
operator|->
name|bits
operator|->
name|mask
operator|+
name|w
operator|*
operator|(
name|ystart
operator|+
name|y
operator|)
operator|+
name|xstart
expr_stmt|;
name|ctr
operator|=
name|tcXY
argument_list|(
name|cfb
operator|->
name|srcX
operator|/
literal|8
argument_list|,
name|y
operator|+
name|cfb
operator|->
name|srcY
argument_list|)
expr_stmt|;
comment|/* address of offscreen cursor */
name|mtr
operator|=
name|tcXY
argument_list|(
name|cfb
operator|->
name|maskX
operator|/
literal|8
argument_list|,
name|y
operator|+
name|cfb
operator|->
name|maskY
argument_list|)
expr_stmt|;
comment|/* address of offscreen cursor mask */
for|for
control|(
name|z
operator|=
name|startbit
operator|,
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|cfb
operator|->
name|width
condition|;
name|x
operator|+=
literal|8
control|)
block|{
operator|*
name|mtr
operator|=
operator|*
name|ctr
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|z1
operator|=
literal|0x80
init|;
name|z1
operator|>
literal|0
condition|;
name|z1
operator|>>=
literal|1
control|)
block|{
comment|/* cursor mask: all planes = xor(or(all planes)) */
operator|*
name|mtr
operator||=
operator|(
operator|(
operator|*
name|qtr
operator|&
name|z
operator|)
condition|?
literal|0
else|:
literal|0xFF
operator|)
operator|&
name|z1
expr_stmt|;
comment|/* squeeze cursor through mask */
operator|*
name|ctr
operator||=
operator|(
operator|(
operator|*
name|qtr
operator|&
name|z
operator|)
condition|?
operator|(
operator|(
operator|*
name|ptr
operator|&
name|z
operator|)
condition|?
name|fgcolor
else|:
name|bgcolor
operator|)
else|:
literal|0
operator|)
operator|&
name|z1
expr_stmt|;
if|if
condition|(
operator|(
name|z
operator|>>=
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|z
operator|=
literal|0x80
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|qtr
operator|++
expr_stmt|;
block|}
block|}
name|mtr
operator|++
expr_stmt|;
name|ctr
operator|++
expr_stmt|;
block|}
block|}
name|hpMoveMouse
argument_list|(
name|pScreen
argument_list|,
name|hpPointer
operator|->
name|coords
index|[
literal|0
index|]
argument_list|,
name|hpPointer
operator|->
name|coords
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function_decl
specifier|extern
name|Bool
name|hpSpriteInitialize
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|Bool
name|hpInitCursor
parameter_list|(
name|pScreen
parameter_list|,
name|scrn_depth
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
name|int
name|scrn_depth
decl_stmt|;
block|{
specifier|register
name|hpPrivScreenPtr
name|cfb
init|=
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
decl_stmt|;
name|hpChunk
modifier|*
name|chunkie
decl_stmt|;
name|cfb
operator|->
name|MoveMouse
operator|=
name|hpMoveMouse
expr_stmt|;
name|cfb
operator|->
name|CursorOff
operator|=
name|hpCursorOff
expr_stmt|;
name|cfb
operator|->
name|cstate
operator|=
name|CURSOR_OFF
expr_stmt|;
comment|/* allocate 3 max size cursor retangles:  	 * cursor, cursor mask and screen save area 	 */
name|chunkie
operator|=
name|hpBufAlloc
argument_list|(
name|pScreen
argument_list|,
name|MAXCX
argument_list|,
name|MAXCY
argument_list|)
expr_stmt|;
comment|/* save area */
name|cfb
operator|->
name|ssaveX
operator|=
name|chunkie
operator|->
name|x
expr_stmt|;
name|cfb
operator|->
name|ssaveY
operator|=
name|chunkie
operator|->
name|y
expr_stmt|;
name|chunkie
operator|=
name|hpBufAlloc
argument_list|(
name|pScreen
argument_list|,
name|MAXCX
argument_list|,
name|MAXCY
argument_list|)
expr_stmt|;
comment|/* cursor */
name|cfb
operator|->
name|srcX
operator|=
name|chunkie
operator|->
name|x
expr_stmt|;
name|cfb
operator|->
name|srcY
operator|=
name|chunkie
operator|->
name|y
expr_stmt|;
name|chunkie
operator|=
name|hpBufAlloc
argument_list|(
name|pScreen
argument_list|,
name|MAXCX
argument_list|,
name|MAXCY
argument_list|)
expr_stmt|;
comment|/* mask */
name|cfb
operator|->
name|maskX
operator|=
name|chunkie
operator|->
name|x
expr_stmt|;
name|cfb
operator|->
name|maskY
operator|=
name|chunkie
operator|->
name|y
expr_stmt|;
comment|/* create a dummy cursor to avoid trashing screen */
name|cfb
operator|->
name|hoffX
operator|=
literal|0
expr_stmt|;
name|cfb
operator|->
name|hoffY
operator|=
literal|0
expr_stmt|;
name|cfb
operator|->
name|width
operator|=
literal|1
expr_stmt|;
name|cfb
operator|->
name|height
operator|=
literal|1
expr_stmt|;
name|pScreen
operator|->
name|RealizeCursor
operator|=
name|hpRealizeCursor
expr_stmt|;
name|pScreen
operator|->
name|UnrealizeCursor
operator|=
name|hpUnrealizeCursor
expr_stmt|;
if|if
condition|(
name|scrn_depth
operator|==
literal|1
condition|)
name|pScreen
operator|->
name|DisplayCursor
operator|=
name|hpmDisplayCursor
expr_stmt|;
else|else
name|pScreen
operator|->
name|DisplayCursor
operator|=
name|hpDisplayCursor
expr_stmt|;
name|pScreen
operator|->
name|SetCursorPosition
operator|=
name|hpSetCursorPosition
expr_stmt|;
name|pScreen
operator|->
name|CursorLimits
operator|=
name|hpCursorLimits
expr_stmt|;
name|pScreen
operator|->
name|PointerNonInterestBox
operator|=
name|hpPointerNonInterestBox
expr_stmt|;
name|pScreen
operator|->
name|ConstrainCursor
operator|=
name|hpConstrainCursor
expr_stmt|;
name|pScreen
operator|->
name|RecolorCursor
operator|=
name|hpRecolorCursor
expr_stmt|;
return|return
name|hpSpriteInitialize
argument_list|(
name|pScreen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|hpRealizeCursor
parameter_list|(
name|pScreen
parameter_list|,
name|pCursor
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
name|CursorPtr
name|pCursor
decl_stmt|;
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|hpUnrealizeCursor
parameter_list|(
name|pScreen
parameter_list|,
name|pCursor
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
name|CursorPtr
name|pCursor
decl_stmt|;
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* hpRecolorCursor -- Change the color of a cursor 	 * Do this by creating a new cursor that has the new colors 	 */
end_comment

begin_function
specifier|static
name|void
name|hpRecolorCursor
parameter_list|(
name|pScreen
parameter_list|,
name|pCursor
parameter_list|,
name|displayed
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
comment|/* Screen for which the cursor is to be recolored */
name|CursorPtr
name|pCursor
decl_stmt|;
comment|/* Cursor to recolor */
name|Bool
name|displayed
decl_stmt|;
comment|/* True if pCursor being displayed now */
block|{
if|if
condition|(
name|displayed
condition|)
operator|(
name|void
operator|)
name|hpDisplayCursor
argument_list|(
name|pScreen
argument_list|,
name|pCursor
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * hpPointerNonInterestBox --  *	Set up things to ignore uninteresting mouse events. Sorry.  */
end_comment

begin_function
specifier|static
name|void
name|hpPointerNonInterestBox
parameter_list|(
name|pScreen
parameter_list|,
name|pBox
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
name|BoxPtr
name|pBox
decl_stmt|;
comment|/* Box outside of which motions are boring */
block|{ }
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<grfioctl.h>
end_include

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_define
define|#
directive|define
name|NEED_EVENTS
end_define

begin_include
include|#
directive|include
file|"Xproto.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"cursorstr.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"inputstr.h"
end_include

begin_include
include|#
directive|include
file|"regionstr.h"
end_include

begin_include
include|#
directive|include
file|"hppriv.h"
end_include

begin_include
include|#
directive|include
file|"hyperion.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|lastEventTime
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|void
name|hpChangeScreens
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|Bool
name|hpInitCursor
argument_list|()
decl_stmt|,
name|mfbCreateDefColormap
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|hpPrivScreenPtr
name|hp_screens
index|[]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|Bool
name|hyperSaveScreen
parameter_list|(
name|pScreen
parameter_list|,
name|on
parameter_list|)
name|ScreenPtr
name|pScreen
decl_stmt|;
name|Bool
name|on
decl_stmt|;
block|{
name|HYPER
modifier|*
name|gp_hardware
init|=
name|getHyHardware
argument_list|(
name|pScreen
argument_list|)
decl_stmt|;
if|if
condition|(
name|on
operator|!=
name|SCREEN_SAVER_ON
condition|)
block|{
name|lastEventTime
operator|=
name|GetTimeInMillis
argument_list|()
expr_stmt|;
comment|/* Turn on Video */
name|gp_hardware
operator|->
name|nblank
operator|=
name|HY_VIDEO_ON
expr_stmt|;
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
operator|->
name|screenBlanked
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
comment|/* Turn off video */
name|gp_hardware
operator|->
name|nblank
operator|=
name|HY_VIDEO_OFF
expr_stmt|;
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
operator|->
name|screenBlanked
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|Bool
name|hyperScreenInfo
parameter_list|(
name|index
parameter_list|,
name|argv
parameter_list|,
name|argc
parameter_list|)
name|int
name|index
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|int
name|argc
decl_stmt|;
block|{
name|hpPrivScreenPtr
name|thisScreen
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|gcid
decl_stmt|;
name|thisScreen
operator|=
operator|(
name|hpPrivScreenPtr
operator|)
name|xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|hpPrivScreen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|thisScreen
condition|)
return|return
name|FALSE
return|;
name|hp_screens
index|[
name|index
index|]
operator|=
name|thisScreen
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
name|O_WRONLY
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ErrorF
argument_list|(
literal|"%s: couldn't open %s \n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|{
name|struct
name|grfinfo
name|gi
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|GRFIOCGINFO
argument_list|,
operator|&
name|gi
argument_list|)
operator|<
literal|0
operator|||
name|ioctl
argument_list|(
name|fd
argument_list|,
name|GRFIOCON
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|ErrorF
argument_list|(
literal|"%s: couldn't GCON and GCID %s \n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|thisScreen
operator|->
name|fbOffset
operator|=
name|gi
operator|.
name|gd_regsize
expr_stmt|;
name|gcid
operator|=
name|gi
operator|.
name|gd_id
expr_stmt|;
block|}
if|if
condition|(
name|gcid
operator|!=
name|GCID_HYPERION
condition|)
comment|/* Not a Hyperion */
block|{
name|ErrorF
argument_list|(
literal|"%s: device %s not this kind of display.\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|thisScreen
operator|->
name|fd
operator|=
name|fd
expr_stmt|;
name|thisScreen
operator|->
name|gcid
operator|=
name|gcid
expr_stmt|;
comment|/*      * Map the hyperion in to our address space.  We could ask the O.S.      * to map it in where it prefers, but this would limit the amount of      * data we can malloc() at a later time.      * However, we don't know how much address space it will take up until      * we can examine its memWide and memHigh values....      */
block|{
name|u_char
modifier|*
name|Addr
init|=
operator|(
name|u_char
operator|*
operator|)
literal|0
decl_stmt|;
name|char
modifier|*
name|str_addr
init|=
operator|(
name|char
operator|*
operator|)
name|getenv
argument_list|(
literal|"XDISPADDR"
argument_list|)
decl_stmt|;
if|if
condition|(
name|str_addr
condition|)
name|Addr
operator|=
operator|(
name|u_char
operator|*
operator|)
name|atoi
argument_list|(
name|str_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|GRFIOCMAP
argument_list|,
operator|&
name|Addr
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|GRFIOCOFF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"GRFIOCMAP:"
argument_list|)
expr_stmt|;
name|ErrorF
argument_list|(
literal|"%s: Error getting address of %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|thisScreen
operator|->
name|pHardwareScreen
operator|=
operator|(
name|pointer
operator|)
name|Addr
expr_stmt|;
block|}
block|{
name|HYPER
modifier|*
name|hy
init|=
operator|(
name|HYPER
operator|*
operator|)
name|thisScreen
operator|->
name|pHardwareScreen
decl_stmt|;
name|thisScreen
operator|->
name|memHeight
operator|=
operator|(
name|hy
operator|->
name|t_memhigh
operator|<<
literal|8
operator|)
operator||
name|hy
operator|->
name|b_memhigh
expr_stmt|;
name|thisScreen
operator|->
name|memWidth
operator|=
operator|(
name|hy
operator|->
name|t_memwide
operator|<<
literal|8
operator|)
operator||
name|hy
operator|->
name|b_memwide
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|thisScreen->WholeGlyph = hyWholeGlyph;
endif|#
directive|endif
comment|/* store the screen minor number in the devPrivate structure;      * if there are four arguments, the fourth is the screen minor number;      */
if|if
condition|(
name|argc
operator|==
literal|4
condition|)
name|thisScreen
operator|->
name|minor_num
operator|=
name|atoi
argument_list|(
name|argv
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
else|else
name|thisScreen
operator|->
name|minor_num
operator|=
literal|0
expr_stmt|;
name|thisScreen
operator|->
name|screenBlanked
operator|=
name|FALSE
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|void
name|hyperMaskConfig
parameter_list|(
name|pScreen
parameter_list|,
name|writeEnableMask
parameter_list|,
name|replacementRule
parameter_list|)
specifier|register
name|ScreenPtr
name|pScreen
decl_stmt|;
specifier|register
name|int
name|writeEnableMask
decl_stmt|,
name|replacementRule
decl_stmt|;
block|{
comment|/* no-op */
empty_stmt|;
block|}
end_function

begin_function_decl
specifier|extern
name|Bool
name|hpmfbCloseScreen
parameter_list|()
function_decl|;
end_function_decl

begin_function
specifier|static
name|Bool
name|hyperCloseScreen
parameter_list|(
name|index
parameter_list|,
name|pScreen
parameter_list|)
name|int
name|index
decl_stmt|;
name|ScreenPtr
name|pScreen
decl_stmt|;
block|{
specifier|register
name|HYPER
modifier|*
name|gp_hardware
init|=
name|getHyHardware
argument_list|(
name|pScreen
argument_list|)
decl_stmt|;
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
operator|->
name|screenBlanked
operator|=
name|FALSE
expr_stmt|;
name|gp_hardware
operator|->
name|nblank
operator|=
name|HY_VIDEO_ON
expr_stmt|;
comment|/* this should probably be done with a wrapper */
return|return
name|hpmfbCloseScreen
argument_list|(
name|index
argument_list|,
name|pScreen
argument_list|)
return|;
block|}
end_function

begin_function
name|Bool
name|hyperScreenInit
parameter_list|(
name|index
parameter_list|,
name|pScreen
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|index
decl_stmt|;
name|ScreenPtr
name|pScreen
decl_stmt|;
name|int
name|argc
decl_stmt|;
comment|/* these two may NOT be changed */
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|dpi
decl_stmt|;
name|HYPER
modifier|*
name|gp_hardware
decl_stmt|;
name|hpPrivScreenPtr
name|pPrivScreen
decl_stmt|;
comment|/* always restore the devPrivate field here;      * if it has not been allocated, this will null it out so code elsewhere      * will be sure to allocate one;      * If we've already allocated one, this will restore it;      */
name|pScreen
operator|->
name|devPrivate
operator|=
operator|(
name|pointer
operator|)
name|hp_screens
index|[
name|index
index|]
expr_stmt|;
name|pPrivScreen
operator|=
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
expr_stmt|;
name|gp_hardware
operator|=
operator|(
name|HYPER
operator|*
operator|)
operator|(
name|pPrivScreen
operator|->
name|pHardwareScreen
operator|)
expr_stmt|;
name|pPrivScreen
operator|->
name|MoveBits
operator|=
name|hyperMoveBits
expr_stmt|;
name|pPrivScreen
operator|->
name|MaskConfig
operator|=
name|hyperMaskConfig
expr_stmt|;
name|pPrivScreen
operator|->
name|ChangeScreen
operator|=
name|hpChangeScreens
expr_stmt|;
name|dpi
operator|=
literal|109
expr_stmt|;
comment|/* XXX probably bogus */
if|if
condition|(
operator|!
name|hpmfbScreenInit
argument_list|(
name|pScreen
argument_list|,
operator|(
operator|(
name|u_char
operator|*
operator|)
name|gp_hardware
operator|)
operator|+
name|pPrivScreen
operator|->
name|fbOffset
argument_list|,
operator|(
name|gp_hardware
operator|->
name|t_dispwide
operator|<<
literal|8
operator|)
operator|+
name|gp_hardware
operator|->
name|b_dispwide
argument_list|,
operator|(
name|gp_hardware
operator|->
name|t_disphigh
operator|<<
literal|8
operator|)
operator|+
name|gp_hardware
operator|->
name|b_disphigh
argument_list|,
name|dpi
argument_list|,
name|dpi
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|pScreen
operator|->
name|SaveScreen
operator|=
name|hyperSaveScreen
expr_stmt|;
name|pScreen
operator|->
name|CloseScreen
operator|=
name|hyperCloseScreen
expr_stmt|;
if|if
condition|(
operator|!
name|hpInitCursor
argument_list|(
name|pScreen
argument_list|,
literal|1
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|pScreen
operator|->
name|whitePixel
operator|=
literal|1
expr_stmt|;
name|pScreen
operator|->
name|blackPixel
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|mfbCreateDefColormap
argument_list|(
name|pScreen
argument_list|)
condition|)
block|{
name|ErrorF
argument_list|(
literal|"Can't alloc black& white pixels in hyperScreenInit\n"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
operator|(
name|void
operator|)
name|hyperSaveScreen
argument_list|(
name|pScreen
argument_list|,
name|SCREEN_SAVER_OFF
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

end_unit


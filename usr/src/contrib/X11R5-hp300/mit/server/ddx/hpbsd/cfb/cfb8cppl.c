begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $XConsortium: cfb8cppl.c,v 1.5 91/08/22 15:41:05 keith Exp $  *  * Copyright 1990 Massachusetts Institute of Technology  *  * Permission to use, copy, modify, distribute, and sell this software and its  * documentation for any purpose is hereby granted without fee, provided that  * the above copyright notice appear in all copies and that both that  * copyright notice and this permission notice appear in supporting  * documentation, and that the name of M.I.T. not be used in advertising or  * publicity pertaining to distribution of the software without specific,  * written prior permission.  M.I.T. makes no representations about the  * suitability of this software for any purpose.  It is provided "as is"  * without express or implied warranty.  *  * M.I.T. DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL M.I.T.  * BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION  * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN   * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * Author:  Keith Packard, MIT X Consortium  */
end_comment

begin_comment
comment|/*   * this is actually an mfb-specific function, except that  * it knows how to read from 8-bit cfb pixmaps.  Alas, this  * means that it doesn't know PPW so it is always compiled  */
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xmd.h"
end_include

begin_include
include|#
directive|include
file|"gcstruct.h"
end_include

begin_include
include|#
directive|include
file|"window.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"cfb.h"
end_include

begin_include
include|#
directive|include
file|"maskbits.h"
end_include

begin_include
include|#
directive|include
file|"mergerop.h"
end_include

begin_if
if|#
directive|if
name|BITMAP_BIT_ORDER
operator|==
name|MSBFirst
end_if

begin_define
define|#
directive|define
name|LeftMost
value|31
end_define

begin_define
define|#
directive|define
name|StepBit
parameter_list|(
name|bit
parameter_list|,
name|inc
parameter_list|)
value|((bit) -= (inc))
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|LeftMost
value|0
end_define

begin_define
define|#
directive|define
name|StepBit
parameter_list|(
name|bit
parameter_list|,
name|inc
parameter_list|)
value|((bit) += (inc))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|GetBits
parameter_list|(
name|psrc
parameter_list|,
name|nBits
parameter_list|,
name|curBit
parameter_list|,
name|bitPos
parameter_list|,
name|bits
parameter_list|)
value|{\     bits = 0; \     while (nBits--) \     { \ 	bits |= ((*psrc++>> bitPos)& 1)<< curBit; \ 	StepBit (curBit, 1); \     } \ }
end_define

begin_macro
name|cfbCopyImagePlane
argument_list|(
argument|pSrcDrawable
argument_list|,
argument|pDstDrawable
argument_list|,
argument|rop
argument_list|,
argument|prgnDst
argument_list|,
argument|pptSrc
argument_list|,
argument|planemask
argument_list|)
end_macro

begin_decl_stmt
name|DrawablePtr
name|pSrcDrawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DrawablePtr
name|pDstDrawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|planemask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|RegionPtr
name|prgnDst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DDXPointPtr
name|pptSrc
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|cfbCopyPlane8to1
argument_list|(
name|pSrcDrawable
argument_list|,
name|pDstDrawable
argument_list|,
name|rop
argument_list|,
name|prgnDst
argument_list|,
name|pptSrc
argument_list|,
operator|(
name|unsigned
name|long
operator|)
operator|~
literal|0L
argument_list|,
name|planemask
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cfbCopyPlane8to1
argument_list|(
argument|pSrcDrawable
argument_list|,
argument|pDstDrawable
argument_list|,
argument|rop
argument_list|,
argument|prgnDst
argument_list|,
argument|pptSrc
argument_list|,
argument|planemask
argument_list|,
argument|bitPlane
argument_list|)
end_macro

begin_decl_stmt
name|DrawablePtr
name|pSrcDrawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DrawablePtr
name|pDstDrawable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|RegionPtr
name|prgnDst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DDXPointPtr
name|pptSrc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|planemask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|bitPlane
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|srcx
decl_stmt|,
name|srcy
decl_stmt|,
name|dstx
decl_stmt|,
name|dsty
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|;
name|unsigned
name|char
modifier|*
name|psrcBase
decl_stmt|;
name|unsigned
name|long
modifier|*
name|pdstBase
decl_stmt|;
name|int
name|widthSrc
decl_stmt|,
name|widthDst
decl_stmt|;
name|unsigned
name|char
modifier|*
name|psrcLine
decl_stmt|;
name|unsigned
name|long
modifier|*
name|pdstLine
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|psrc
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|curBit
decl_stmt|;
specifier|register
name|int
name|bitPos
decl_stmt|;
specifier|register
name|unsigned
name|long
name|bits
decl_stmt|;
specifier|register
name|unsigned
name|long
modifier|*
name|pdst
decl_stmt|;
name|unsigned
name|long
name|startmask
decl_stmt|,
name|endmask
decl_stmt|;
name|int
name|niStart
decl_stmt|,
name|niEnd
decl_stmt|;
name|int
name|bitStart
decl_stmt|,
name|bitEnd
decl_stmt|;
name|int
name|nl
decl_stmt|,
name|nlMiddle
decl_stmt|;
name|int
name|nbox
decl_stmt|;
name|BoxPtr
name|pbox
decl_stmt|;
name|MROP_DECLARE
argument_list|()
if|if
condition|(
operator|!
operator|(
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
if|if
condition|(
name|rop
operator|!=
name|GXcopy
condition|)
name|MROP_INITIALIZE
argument_list|(
name|rop
argument_list|,
name|planemask
argument_list|)
expr_stmt|;
name|cfbGetByteWidthAndPointer
argument_list|(
argument|pSrcDrawable
argument_list|,
argument|widthSrc
argument_list|,
argument|psrcBase
argument_list|)
name|mfbGetLongWidthAndPointer
argument_list|(
argument|pDstDrawable
argument_list|,
argument|widthDst
argument_list|,
argument|pdstBase
argument_list|)
name|bitPos
operator|=
name|ffs
argument_list|(
name|bitPlane
argument_list|)
operator|-
literal|1
expr_stmt|;
name|nbox
operator|=
name|REGION_NUM_RECTS
argument_list|(
name|prgnDst
argument_list|)
expr_stmt|;
name|pbox
operator|=
name|REGION_RECTS
argument_list|(
name|prgnDst
argument_list|)
expr_stmt|;
comment|/* XXX ??? */
name|WAIT_READY_TO_RENDER
argument_list|(
name|pSrcDrawable
operator|->
name|pScreen
argument_list|)
expr_stmt|;
name|SET_REGISTERS_FOR_WRITING
argument_list|(
name|pDstDrawable
operator|->
name|pScreen
argument_list|,
operator|~
literal|0
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
while|while
condition|(
name|nbox
operator|--
condition|)
block|{
name|dstx
operator|=
name|pbox
operator|->
name|x1
expr_stmt|;
name|dsty
operator|=
name|pbox
operator|->
name|y1
expr_stmt|;
name|srcx
operator|=
name|pptSrc
operator|->
name|x
expr_stmt|;
name|srcy
operator|=
name|pptSrc
operator|->
name|y
expr_stmt|;
name|width
operator|=
name|pbox
operator|->
name|x2
operator|-
name|pbox
operator|->
name|x1
expr_stmt|;
name|height
operator|=
name|pbox
operator|->
name|y2
operator|-
name|pbox
operator|->
name|y1
expr_stmt|;
name|pbox
operator|++
expr_stmt|;
name|pptSrc
operator|++
expr_stmt|;
name|psrcLine
operator|=
name|psrcBase
operator|+
name|srcy
operator|*
name|widthSrc
operator|+
name|srcx
expr_stmt|;
name|pdstLine
operator|=
name|pdstBase
operator|+
name|dsty
operator|*
name|widthDst
operator|+
operator|(
name|dstx
operator|>>
literal|5
operator|)
expr_stmt|;
name|dstx
operator|&=
literal|0x1f
expr_stmt|;
if|if
condition|(
name|dstx
operator|+
name|width
operator|<=
literal|32
condition|)
block|{
name|maskpartialbits
argument_list|(
name|dstx
argument_list|,
name|width
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|nlMiddle
operator|=
literal|0
expr_stmt|;
name|endmask
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|dstx
argument_list|,
name|width
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlMiddle
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|startmask
condition|)
block|{
name|niStart
operator|=
literal|32
operator|-
name|dstx
expr_stmt|;
name|bitStart
operator|=
name|LeftMost
expr_stmt|;
name|StepBit
argument_list|(
name|bitStart
argument_list|,
name|dstx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
name|niEnd
operator|=
operator|(
name|dstx
operator|+
name|width
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|bitEnd
operator|=
name|LeftMost
expr_stmt|;
block|}
if|if
condition|(
name|rop
operator|==
name|GXcopy
condition|)
block|{
while|while
condition|(
name|height
operator|--
condition|)
block|{
name|psrc
operator|=
name|psrcLine
expr_stmt|;
name|pdst
operator|=
name|pdstLine
expr_stmt|;
name|psrcLine
operator|+=
name|widthSrc
expr_stmt|;
name|pdstLine
operator|+=
name|widthDst
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|i
operator|=
name|niStart
expr_stmt|;
name|curBit
operator|=
name|bitStart
expr_stmt|;
name|GetBits
argument_list|(
name|psrc
argument_list|,
name|i
argument_list|,
name|curBit
argument_list|,
name|bitPos
argument_list|,
name|bits
argument_list|)
expr_stmt|;
operator|*
name|pdst
operator|=
operator|*
name|pdst
operator|&
operator|~
name|startmask
operator||
name|bits
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
block|}
name|nl
operator|=
name|nlMiddle
expr_stmt|;
while|while
condition|(
name|nl
operator|--
condition|)
block|{
name|i
operator|=
literal|32
expr_stmt|;
name|curBit
operator|=
name|LeftMost
expr_stmt|;
name|GetBits
argument_list|(
name|psrc
argument_list|,
name|i
argument_list|,
name|curBit
argument_list|,
name|bitPos
argument_list|,
name|bits
argument_list|)
expr_stmt|;
operator|*
name|pdst
operator|++
operator|=
name|bits
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
name|i
operator|=
name|niEnd
expr_stmt|;
name|curBit
operator|=
name|bitEnd
expr_stmt|;
name|GetBits
argument_list|(
name|psrc
argument_list|,
name|i
argument_list|,
name|curBit
argument_list|,
name|bitPos
argument_list|,
name|bits
argument_list|)
expr_stmt|;
operator|*
name|pdst
operator|=
operator|*
name|pdst
operator|&
operator|~
name|endmask
operator||
name|bits
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
while|while
condition|(
name|height
operator|--
condition|)
block|{
name|psrc
operator|=
name|psrcLine
expr_stmt|;
name|pdst
operator|=
name|pdstLine
expr_stmt|;
name|psrcLine
operator|+=
name|widthSrc
expr_stmt|;
name|pdstLine
operator|+=
name|widthDst
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|i
operator|=
name|niStart
expr_stmt|;
name|curBit
operator|=
name|bitStart
expr_stmt|;
name|GetBits
argument_list|(
name|psrc
argument_list|,
name|i
argument_list|,
name|curBit
argument_list|,
name|bitPos
argument_list|,
name|bits
argument_list|)
expr_stmt|;
operator|*
name|pdst
operator|=
name|MROP_MASK
argument_list|(
name|bits
argument_list|,
operator|*
name|pdst
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
block|}
name|nl
operator|=
name|nlMiddle
expr_stmt|;
while|while
condition|(
name|nl
operator|--
condition|)
block|{
name|i
operator|=
literal|32
expr_stmt|;
name|curBit
operator|=
name|LeftMost
expr_stmt|;
name|GetBits
argument_list|(
name|psrc
argument_list|,
name|i
argument_list|,
name|curBit
argument_list|,
name|bitPos
argument_list|,
name|bits
argument_list|)
expr_stmt|;
operator|*
name|pdst
operator|=
name|MROP_SOLID
argument_list|(
name|bits
argument_list|,
operator|*
name|pdst
argument_list|)
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
name|i
operator|=
name|niEnd
expr_stmt|;
name|curBit
operator|=
name|bitEnd
expr_stmt|;
name|GetBits
argument_list|(
name|psrc
argument_list|,
name|i
argument_list|,
name|curBit
argument_list|,
name|bitPos
argument_list|,
name|bits
argument_list|)
expr_stmt|;
operator|*
name|pdst
operator|=
name|MROP_MASK
argument_list|(
name|bits
argument_list|,
operator|*
name|pdst
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_block

end_unit


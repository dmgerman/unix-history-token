begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* This file contains the same code as hpPolyFSR.c 'cept for 	 *   code in PaintBlockClipped() which can paint a block in 1 	 *   block move (instead of 2) which means no visual glitches. 	 * Topcat and Catseye code 	 */
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"servermd.h"
end_include

begin_include
include|#
directive|include
file|"gcstruct.h"
end_include

begin_include
include|#
directive|include
file|"window.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"regionstr.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"topcat.h"
end_include

begin_include
include|#
directive|include
file|"../cfb/cfb.h"
end_include

begin_decl_stmt
specifier|extern
name|u_char
name|XHP_NewRule
index|[
literal|16
index|]
index|[
literal|6
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PIXER
parameter_list|(
name|Drawable
parameter_list|)
value|((hpPrivPixmapPtr)((PixmapPtr)Drawable)->devPrivate.ptr)
end_define

begin_comment
comment|/*  * tcPaintBlockClipped  *   This routine paints a solid-colored block clipped to the composite  * clipping region described in the devPriv of the GC.  * Basically it programs the replacement rule registers to place a   * rectangle "width" pixels wide by "height" pixels tall  * with the appropriate color (fgPixel) and alu starting at x, y.  *  ~jra  *  ~hp  *  ~cd  *  ~sph  */
end_comment

begin_function
specifier|static
name|void
name|tcPaintBlockClipped
parameter_list|(
name|dst
parameter_list|,
name|pGC
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|,
name|width
parameter_list|,
name|height
parameter_list|)
name|DrawablePtr
name|dst
decl_stmt|;
name|GC
modifier|*
name|pGC
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|;
block|{
name|ScreenPtr
name|pScreen
init|=
name|dst
operator|->
name|pScreen
decl_stmt|;
name|RegionPtr
name|pRegion
init|=
operator|(
operator|(
name|cfbPrivGC
operator|*
operator|)
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|->
name|pCompositeClip
decl_stmt|;
name|u_char
name|pMask
init|=
name|getPlanesMask
argument_list|(
name|pScreen
argument_list|)
decl_stmt|;
name|int
name|clippedWidth
decl_stmt|,
name|clippedHeight
decl_stmt|,
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|zmask
init|=
name|pMask
operator|&
name|pGC
operator|->
name|planemask
decl_stmt|,
name|srcpix
init|=
name|pGC
operator|->
name|fgPixel
decl_stmt|,
name|alu
init|=
name|pGC
operator|->
name|alu
decl_stmt|,
name|nbox
init|=
name|REGION_NUM_RECTS
argument_list|(
name|pRegion
argument_list|)
decl_stmt|,
name|ctx
init|=
literal|0
decl_stmt|,
name|cty
init|=
literal|0
decl_stmt|;
comment|/* clip list translation */
specifier|register
name|TOPCAT
modifier|*
name|gp_hardware
init|=
name|getTcHardware
argument_list|(
name|pScreen
argument_list|)
decl_stmt|;
specifier|register
name|BoxPtr
name|pBox
init|=
name|REGION_RECTS
argument_list|(
name|pRegion
argument_list|)
decl_stmt|;
comment|/* translate cliplist from pixmap coordinates to window coordinates */
if|if
condition|(
name|dst
operator|->
name|type
operator|==
name|DRAWABLE_PIXMAP
condition|)
comment|/* offscreen memory pixmap */
block|{
name|ctx
operator|=
name|PIXER
argument_list|(
name|dst
argument_list|)
operator|->
name|pChunk
operator|->
name|x
expr_stmt|;
name|cty
operator|=
name|PIXER
argument_list|(
name|dst
argument_list|)
operator|->
name|pChunk
operator|->
name|y
expr_stmt|;
block|}
name|waitbusy
argument_list|(
name|pMask
argument_list|,
name|gp_hardware
argument_list|)
expr_stmt|;
name|gp_hardware
operator|->
name|write_enable
operator|=
name|zmask
operator|&
name|srcpix
expr_stmt|;
name|gp_hardware
operator|->
name|window_move_replacement_rule
operator|=
name|XHP_NewRule
index|[
name|alu
index|]
index|[
literal|3
index|]
expr_stmt|;
name|gp_hardware
operator|->
name|write_enable
operator|=
name|zmask
operator|&
operator|~
name|srcpix
expr_stmt|;
name|gp_hardware
operator|->
name|window_move_replacement_rule
operator|=
name|XHP_NewRule
index|[
name|alu
index|]
index|[
literal|0
index|]
expr_stmt|;
name|gp_hardware
operator|->
name|write_enable
operator|=
name|zmask
expr_stmt|;
name|gp_hardware
operator|->
name|pixel_write_replacement_rule
operator|=
name|GXcopy
expr_stmt|;
name|gp_hardware
operator|->
name|frame_buf_write_enable
operator|=
name|zmask
expr_stmt|;
for|for
control|(
init|;
name|nbox
operator|--
condition|;
name|pBox
operator|++
control|)
block|{
comment|/* 	 * for each clipping rectangle, put out the portion of the 	 * block contained in the clipping rect 	 */
name|clipper
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|pBox
operator|->
name|x1
operator|+
name|ctx
argument_list|,
name|pBox
operator|->
name|y1
operator|+
name|cty
argument_list|,
name|pBox
operator|->
name|x2
operator|+
name|ctx
argument_list|,
name|pBox
operator|->
name|y2
operator|+
name|cty
argument_list|,
operator|&
name|startx
argument_list|,
operator|&
name|starty
argument_list|,
operator|&
name|clippedWidth
argument_list|,
operator|&
name|clippedHeight
argument_list|)
expr_stmt|;
comment|/* 	 * put out the block part in this clip box 	 */
if|if
condition|(
literal|0
operator|<
name|clippedWidth
operator|&&
literal|0
operator|<
name|clippedHeight
condition|)
block|{
name|clippedWidth
operator|<<=
name|gp_hardware
operator|->
name|bits
expr_stmt|;
name|startx
operator|<<=
name|gp_hardware
operator|->
name|bits
expr_stmt|;
name|waitbusy
argument_list|(
name|pMask
argument_list|,
name|gp_hardware
argument_list|)
expr_stmt|;
name|gp_hardware
operator|->
name|source_x
operator|=
name|startx
expr_stmt|;
name|gp_hardware
operator|->
name|source_y
operator|=
name|starty
expr_stmt|;
name|gp_hardware
operator|->
name|dest_x
operator|=
name|startx
expr_stmt|;
name|gp_hardware
operator|->
name|dest_y
operator|=
name|starty
expr_stmt|;
name|gp_hardware
operator|->
name|window_width
operator|=
name|clippedWidth
expr_stmt|;
name|gp_hardware
operator|->
name|window_height
operator|=
name|clippedHeight
expr_stmt|;
name|gp_hardware
operator|->
name|start_move
operator|=
name|zmask
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * tcPolyFillStippledRect -- A sometimes fast fill routine for filling  * rectangles in video ram with a stipple.  */
end_comment

begin_function
name|void
name|tcPolyFillStippledRect
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nrectFill
parameter_list|,
name|prect
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|nrectFill
decl_stmt|;
comment|/* number of rectangles to fill */
specifier|register
name|xRectangle
modifier|*
name|prect
decl_stmt|;
comment|/* Pointer to first rectangle to fill */
block|{
name|PixmapPtr
name|pTile
decl_stmt|,
name|pOldTile
decl_stmt|,
name|cfbCreateOffscreenPixmap
argument_list|()
decl_stmt|;
name|cfbPrivGC
modifier|*
name|priv
decl_stmt|;
name|GC
modifier|*
name|tempGC
decl_stmt|,
modifier|*
name|GetScratchGC
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|)
condition|)
return|return;
name|priv
operator|=
operator|(
name|cfbPrivGC
operator|*
operator|)
name|pGC
operator|->
name|devPrivates
index|[
name|cfbGCPrivateIndex
index|]
operator|.
name|ptr
expr_stmt|;
if|if
condition|(
name|pGC
operator|->
name|fillStyle
operator|==
name|FillStippled
operator|||
operator|(
name|pTile
operator|=
name|cfbCreateOffscreenPixmap
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|,
name|priv
operator|->
name|pRotatedPixmap
operator|->
name|drawable
operator|.
name|width
argument_list|,
name|priv
operator|->
name|pRotatedPixmap
operator|->
name|drawable
operator|.
name|height
argument_list|,
name|pDrawable
operator|->
name|depth
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|tcPolyFillRect
argument_list|(
name|pDrawable
argument_list|,
name|pGC
argument_list|,
name|nrectFill
argument_list|,
name|prect
argument_list|)
expr_stmt|;
return|return;
block|}
name|tempGC
operator|=
name|GetScratchGC
argument_list|(
name|pTile
operator|->
name|drawable
operator|.
name|depth
argument_list|,
name|pTile
operator|->
name|drawable
operator|.
name|pScreen
argument_list|)
expr_stmt|;
name|tempGC
operator|->
name|fgPixel
operator|=
name|pGC
operator|->
name|fgPixel
expr_stmt|;
name|tempGC
operator|->
name|bgPixel
operator|=
name|pGC
operator|->
name|bgPixel
expr_stmt|;
name|ValidateGC
argument_list|(
name|pTile
argument_list|,
name|tempGC
argument_list|)
expr_stmt|;
call|(
name|pGC
operator|->
name|ops
operator|->
name|CopyPlane
call|)
argument_list|(
name|priv
operator|->
name|pRotatedPixmap
argument_list|,
name|pTile
argument_list|,
name|tempGC
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|priv
operator|->
name|pRotatedPixmap
operator|->
name|drawable
operator|.
name|width
argument_list|,
name|priv
operator|->
name|pRotatedPixmap
operator|->
name|drawable
operator|.
name|height
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|unsigned
name|long
operator|)
literal|0x1
argument_list|)
expr_stmt|;
name|FreeScratchGC
argument_list|(
name|tempGC
argument_list|)
expr_stmt|;
name|pOldTile
operator|=
name|priv
operator|->
name|pRotatedPixmap
expr_stmt|;
name|priv
operator|->
name|pRotatedPixmap
operator|=
name|pTile
expr_stmt|;
name|pGC
operator|->
name|fillStyle
operator|=
name|FillTiled
expr_stmt|;
name|ValidateGC
argument_list|(
name|pDrawable
argument_list|,
name|pGC
argument_list|)
expr_stmt|;
name|tcPolyFillRect
argument_list|(
name|pDrawable
argument_list|,
name|pGC
argument_list|,
name|nrectFill
argument_list|,
name|prect
argument_list|)
expr_stmt|;
name|priv
operator|->
name|pRotatedPixmap
operator|=
name|pOldTile
expr_stmt|;
name|pGC
operator|->
name|fillStyle
operator|=
name|FillOpaqueStippled
expr_stmt|;
name|ValidateGC
argument_list|(
name|pDrawable
argument_list|,
name|pGC
argument_list|)
expr_stmt|;
name|cfbDestroyPixmap
argument_list|(
name|pTile
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


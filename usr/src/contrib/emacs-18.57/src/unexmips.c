begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Unexec for MIPS (including IRIS4D).    Copyright (C) 1988 Free Software Foundation, Inc.     Note that the GNU project considers support for MIPS operation    a peripheral activity which should not be allowed to divert effort    from development of the GNU system.  Changes in this code will be    installed when users send them in, but aside from that    we don't plan to think about it, or about whether other Emacs    maintenance might break it.      This program is free software; you can redistribute it and/or modify     it under the terms of the GNU General Public License as published by     the Free Software Foundation; either version 1, or (at your option)     any later version.      This program is distributed in the hope that it will be useful,     but WITHOUT ANY WARRANTY; without even the implied warranty of     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the     GNU General Public License for more details.      You should have received a copy of the GNU General Public License     along with this program; if not, write to the Free Software     Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  In other words, you are welcome to use, share and improve this program. You are forbidden to forbid anyone else to use, share and improve what you give them.   Help stamp out software-hoarding!  */
end_comment

begin_escape
end_escape

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<varargs.h>
end_include

begin_include
include|#
directive|include
file|<filehdr.h>
end_include

begin_include
include|#
directive|include
file|<aouthdr.h>
end_include

begin_include
include|#
directive|include
file|<scnhdr.h>
end_include

begin_include
include|#
directive|include
file|<sym.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|IRIS_4D
end_ifdef

begin_include
include|#
directive|include
file|"getpagesize.h"
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|fatal_unexec
parameter_list|()
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|READ
parameter_list|(
name|_fd
parameter_list|,
name|_buffer
parameter_list|,
name|_size
parameter_list|,
name|_error_message
parameter_list|,
name|_error_arg
parameter_list|)
define|\
value|errno = EEOF; \ 	if (read(_fd, _buffer, _size) != _size) \ 	  fatal_unexec(_error_message, _error_arg);
end_define

begin_define
define|#
directive|define
name|WRITE
parameter_list|(
name|_fd
parameter_list|,
name|_buffer
parameter_list|,
name|_size
parameter_list|,
name|_error_message
parameter_list|,
name|_error_arg
parameter_list|)
define|\
value|if (write(_fd, _buffer, _size) != _size) \ 	  fatal_unexec(_error_message, _error_arg);
end_define

begin_define
define|#
directive|define
name|SEEK
parameter_list|(
name|_fd
parameter_list|,
name|_position
parameter_list|,
name|_error_message
parameter_list|,
name|_error_arg
parameter_list|)
define|\
value|errno = EEOF; \ 	if (lseek(_fd, _position, L_SET) != _position) \ 	  fatal_unexec(_error_message, _error_arg);
end_define

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|sys_nerr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|sys_errlist
index|[]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|EEOF
value|-1
end_define

begin_decl_stmt
specifier|static
name|struct
name|scnhdr
modifier|*
name|text_section
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scnhdr
modifier|*
name|init_section
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scnhdr
modifier|*
name|finit_section
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scnhdr
modifier|*
name|rdata_section
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scnhdr
modifier|*
name|data_section
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scnhdr
modifier|*
name|lit8_section
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scnhdr
modifier|*
name|lit4_section
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scnhdr
modifier|*
name|sdata_section
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scnhdr
modifier|*
name|sbss_section
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scnhdr
modifier|*
name|bss_section
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|headers
block|{
name|struct
name|filehdr
name|fhdr
decl_stmt|;
name|struct
name|aouthdr
name|aout
decl_stmt|;
name|struct
name|scnhdr
name|section
index|[
literal|10
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Define name of label for entry point for the dumped executable.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|DEFAULT_ENTRY_ADDRESS
end_ifndef

begin_define
define|#
directive|define
name|DEFAULT_ENTRY_ADDRESS
value|__start
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_escape
end_escape

begin_macro
name|unexec
argument_list|(
argument|new_name
argument_list|,
argument|a_name
argument_list|,
argument|data_start
argument_list|,
argument|bss_start
argument_list|,
argument|entry_address
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|new_name
decl_stmt|,
modifier|*
name|a_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|data_start
decl_stmt|,
name|bss_start
decl_stmt|,
name|entry_address
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|new
decl_stmt|,
name|old
decl_stmt|;
name|int
name|pagesize
decl_stmt|,
name|brk
decl_stmt|;
name|int
name|newsyms
decl_stmt|,
name|symrel
decl_stmt|;
name|int
name|nread
decl_stmt|;
name|struct
name|headers
name|hdr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|vaddr
decl_stmt|,
name|scnptr
decl_stmt|;
define|#
directive|define
name|BUFSIZE
value|8192
name|char
name|buffer
index|[
name|BUFSIZE
index|]
decl_stmt|;
name|old
operator|=
name|open
argument_list|(
name|a_name
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|old
operator|<
literal|0
condition|)
name|fatal_unexec
argument_list|(
literal|"opening %s"
argument_list|,
name|a_name
argument_list|)
expr_stmt|;
name|new
operator|=
name|creat
argument_list|(
name|new_name
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|<
literal|0
condition|)
name|fatal_unexec
argument_list|(
literal|"creating %s"
argument_list|,
name|new_name
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|*
operator|(
operator|(
expr|struct
name|headers
operator|*
operator|)
name|TEXT_START
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MIPS2
if|if
condition|(
name|hdr
operator|.
name|fhdr
operator|.
name|f_magic
operator|!=
name|MIPSELMAGIC
operator|&&
name|hdr
operator|.
name|fhdr
operator|.
name|f_magic
operator|!=
name|MIPSEBMAGIC
operator|&&
name|hdr
operator|.
name|fhdr
operator|.
name|f_magic
operator|!=
operator|(
name|MIPSELMAGIC
operator||
literal|1
operator|)
operator|&&
name|hdr
operator|.
name|fhdr
operator|.
name|f_magic
operator|!=
operator|(
name|MIPSEBMAGIC
operator||
literal|1
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unexec: input file magic number is %x, not %x, %x, %x or %x.\n"
argument_list|,
name|hdr
operator|.
name|fhdr
operator|.
name|f_magic
argument_list|,
name|MIPSELMAGIC
argument_list|,
name|MIPSEBMAGIC
argument_list|,
name|MIPSELMAGIC
operator||
literal|1
argument_list|,
name|MIPSEBMAGIC
operator||
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* not MIPS2 */
if|if
condition|(
name|hdr
operator|.
name|fhdr
operator|.
name|f_magic
operator|!=
name|MIPSELMAGIC
operator|&&
name|hdr
operator|.
name|fhdr
operator|.
name|f_magic
operator|!=
name|MIPSEBMAGIC
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unexec: input file magic number is %x, not %x or %x.\n"
argument_list|,
name|hdr
operator|.
name|fhdr
operator|.
name|f_magic
argument_list|,
name|MIPSELMAGIC
argument_list|,
name|MIPSEBMAGIC
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* not MIPS2 */
if|if
condition|(
name|hdr
operator|.
name|fhdr
operator|.
name|f_opthdr
operator|!=
sizeof|sizeof
argument_list|(
name|hdr
operator|.
name|aout
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unexec: input a.out header is %d bytes, not %d.\n"
argument_list|,
name|hdr
operator|.
name|fhdr
operator|.
name|f_opthdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
operator|.
name|aout
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hdr
operator|.
name|aout
operator|.
name|magic
operator|!=
name|ZMAGIC
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unexec: input file a.out magic number is %o, not %o.\n"
argument_list|,
name|hdr
operator|.
name|aout
operator|.
name|magic
argument_list|,
name|ZMAGIC
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
define|#
directive|define
name|CHECK_SCNHDR
parameter_list|(
name|ptr
parameter_list|,
name|name
parameter_list|,
name|flags
parameter_list|)
define|\
value|if (strcmp(hdr.section[i].s_name, name) == 0) { \     if (hdr.section[i].s_flags != flags) { \       fprintf(stderr, "unexec: %x flags where %x expected in %s section.\n", \ 	      hdr.section[i].s_flags, flags, name); \     } \     ptr = hdr.section + i; \     i += 1; \   } \   else { \     ptr = NULL; \     }
name|i
operator|=
literal|0
expr_stmt|;
name|CHECK_SCNHDR
argument_list|(
name|text_section
argument_list|,
name|_TEXT
argument_list|,
name|STYP_TEXT
argument_list|)
expr_stmt|;
name|CHECK_SCNHDR
argument_list|(
name|init_section
argument_list|,
name|_INIT
argument_list|,
name|STYP_INIT
argument_list|)
expr_stmt|;
name|CHECK_SCNHDR
argument_list|(
name|rdata_section
argument_list|,
name|_RDATA
argument_list|,
name|STYP_RDATA
argument_list|)
expr_stmt|;
name|CHECK_SCNHDR
argument_list|(
name|data_section
argument_list|,
name|_DATA
argument_list|,
name|STYP_DATA
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|_LIT8
name|CHECK_SCNHDR
argument_list|(
name|lit8_section
argument_list|,
name|_LIT8
argument_list|,
name|STYP_LIT8
argument_list|)
expr_stmt|;
name|CHECK_SCNHDR
argument_list|(
name|lit4_section
argument_list|,
name|_LIT4
argument_list|,
name|STYP_LIT4
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* _LIT8 */
name|CHECK_SCNHDR
argument_list|(
name|sdata_section
argument_list|,
name|_SDATA
argument_list|,
name|STYP_SDATA
argument_list|)
expr_stmt|;
name|CHECK_SCNHDR
argument_list|(
name|sbss_section
argument_list|,
name|_SBSS
argument_list|,
name|STYP_SBSS
argument_list|)
expr_stmt|;
name|CHECK_SCNHDR
argument_list|(
name|bss_section
argument_list|,
name|_BSS
argument_list|,
name|STYP_BSS
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
name|hdr
operator|.
name|fhdr
operator|.
name|f_nscns
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unexec: %d sections found instead of %d.\n"
argument_list|,
name|i
argument_list|,
name|hdr
operator|.
name|fhdr
operator|.
name|f_nscns
argument_list|)
expr_stmt|;
name|pagesize
operator|=
name|getpagesize
argument_list|()
expr_stmt|;
name|brk
operator|=
operator|(
name|sbrk
argument_list|(
literal|0
argument_list|)
operator|+
name|pagesize
operator|-
literal|1
operator|)
operator|&
operator|(
operator|-
name|pagesize
operator|)
expr_stmt|;
name|hdr
operator|.
name|aout
operator|.
name|dsize
operator|=
name|brk
operator|-
name|DATA_START
expr_stmt|;
name|hdr
operator|.
name|aout
operator|.
name|bsize
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|entry_address
operator|==
literal|0
condition|)
block|{
extern|extern DEFAULT_ENTRY_ADDRESS(
block|)
empty_stmt|;
name|hdr
operator|.
name|aout
operator|.
name|entry
operator|=
operator|(
name|unsigned
operator|)
name|DEFAULT_ENTRY_ADDRESS
expr_stmt|;
block|}
end_block

begin_else
else|else
name|hdr
operator|.
name|aout
operator|.
name|entry
operator|=
name|entry_address
expr_stmt|;
end_else

begin_expr_stmt
name|hdr
operator|.
name|aout
operator|.
name|bss_start
operator|=
name|hdr
operator|.
name|aout
operator|.
name|data_start
operator|+
name|hdr
operator|.
name|aout
operator|.
name|dsize
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|rdata_section
operator|->
name|s_size
operator|=
name|data_start
operator|-
name|DATA_START
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|data_section
operator|->
name|s_vaddr
operator|=
name|data_start
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|data_section
operator|->
name|s_paddr
operator|=
name|data_start
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|data_section
operator|->
name|s_size
operator|=
name|brk
operator|-
name|DATA_START
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|data_section
operator|->
name|s_scnptr
operator|=
name|rdata_section
operator|->
name|s_scnptr
operator|+
name|rdata_section
operator|->
name|s_size
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|vaddr
operator|=
name|data_section
operator|->
name|s_vaddr
operator|+
name|data_section
operator|->
name|s_size
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|scnptr
operator|=
name|data_section
operator|->
name|s_scnptr
operator|+
name|data_section
operator|->
name|s_size
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|lit8_section
operator|!=
name|NULL
condition|)
block|{
name|lit8_section
operator|->
name|s_vaddr
operator|=
name|vaddr
expr_stmt|;
name|lit8_section
operator|->
name|s_paddr
operator|=
name|vaddr
expr_stmt|;
name|lit8_section
operator|->
name|s_size
operator|=
literal|0
expr_stmt|;
name|lit8_section
operator|->
name|s_scnptr
operator|=
name|scnptr
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|lit4_section
operator|!=
name|NULL
condition|)
block|{
name|lit4_section
operator|->
name|s_vaddr
operator|=
name|vaddr
expr_stmt|;
name|lit4_section
operator|->
name|s_paddr
operator|=
name|vaddr
expr_stmt|;
name|lit4_section
operator|->
name|s_size
operator|=
literal|0
expr_stmt|;
name|lit4_section
operator|->
name|s_scnptr
operator|=
name|scnptr
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|sdata_section
operator|!=
name|NULL
condition|)
block|{
name|sdata_section
operator|->
name|s_vaddr
operator|=
name|vaddr
expr_stmt|;
name|sdata_section
operator|->
name|s_paddr
operator|=
name|vaddr
expr_stmt|;
name|sdata_section
operator|->
name|s_size
operator|=
literal|0
expr_stmt|;
name|sdata_section
operator|->
name|s_scnptr
operator|=
name|scnptr
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|sbss_section
operator|!=
name|NULL
condition|)
block|{
name|sbss_section
operator|->
name|s_vaddr
operator|=
name|vaddr
expr_stmt|;
name|sbss_section
operator|->
name|s_paddr
operator|=
name|vaddr
expr_stmt|;
name|sbss_section
operator|->
name|s_size
operator|=
literal|0
expr_stmt|;
name|sbss_section
operator|->
name|s_scnptr
operator|=
name|scnptr
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|bss_section
operator|!=
name|NULL
condition|)
block|{
name|bss_section
operator|->
name|s_vaddr
operator|=
name|vaddr
expr_stmt|;
name|bss_section
operator|->
name|s_paddr
operator|=
name|vaddr
expr_stmt|;
name|bss_section
operator|->
name|s_size
operator|=
literal|0
expr_stmt|;
name|bss_section
operator|->
name|s_scnptr
operator|=
name|scnptr
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|WRITE
argument_list|(
name|new
argument_list|,
name|TEXT_START
argument_list|,
name|hdr
operator|.
name|aout
operator|.
name|tsize
argument_list|,
literal|"writing text section to %s"
argument_list|,
name|new_name
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|WRITE
argument_list|(
name|new
argument_list|,
name|DATA_START
argument_list|,
name|hdr
operator|.
name|aout
operator|.
name|dsize
argument_list|,
literal|"writing text section to %s"
argument_list|,
name|new_name
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SEEK
argument_list|(
name|old
argument_list|,
name|hdr
operator|.
name|fhdr
operator|.
name|f_symptr
argument_list|,
literal|"seeking to start of symbols in %s"
argument_list|,
name|a_name
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|errno
operator|=
name|EEOF
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|nread
operator|=
name|read
argument_list|(
name|old
argument_list|,
name|buffer
argument_list|,
name|BUFSIZE
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|nread
operator|<
sizeof|sizeof
argument_list|(
name|HDRR
argument_list|)
condition|)
name|fatal_unexec
argument_list|(
literal|"reading symbols from %s"
argument_list|,
name|a_name
argument_list|)
expr_stmt|;
end_if

begin_define
define|#
directive|define
name|symhdr
value|((pHDRR)buffer)
end_define

begin_expr_stmt
name|newsyms
operator|=
name|hdr
operator|.
name|aout
operator|.
name|tsize
operator|+
name|hdr
operator|.
name|aout
operator|.
name|dsize
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symrel
operator|=
name|newsyms
operator|-
name|hdr
operator|.
name|fhdr
operator|.
name|f_symptr
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|hdr
operator|.
name|fhdr
operator|.
name|f_symptr
operator|=
name|newsyms
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbLineOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbDnOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbPdOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbSymOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbOptOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbAuxOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbSsOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbSsExtOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbFdOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbRfdOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|symhdr
operator|->
name|cbExtOffset
operator|+=
name|symrel
expr_stmt|;
end_expr_stmt

begin_undef
undef|#
directive|undef
name|symhdr
end_undef

begin_do
do|do
block|{
if|if
condition|(
name|write
argument_list|(
name|new
argument_list|,
name|buffer
argument_list|,
name|nread
argument_list|)
operator|!=
name|nread
condition|)
name|fatal_unexec
argument_list|(
literal|"writing symbols to %s"
argument_list|,
name|new_name
argument_list|)
expr_stmt|;
name|nread
operator|=
name|read
argument_list|(
name|old
argument_list|,
name|buffer
argument_list|,
name|BUFSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|nread
operator|<
literal|0
condition|)
name|fatal_unexec
argument_list|(
literal|"reading symbols from %s"
argument_list|,
name|a_name
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|BUFSIZE
block|}
do|while
condition|(
name|nread
operator|!=
literal|0
condition|)
do|;
end_do

begin_expr_stmt
name|SEEK
argument_list|(
name|new
argument_list|,
literal|0
argument_list|,
literal|"seeking to start of header in %s"
argument_list|,
name|new_name
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|WRITE
argument_list|(
name|new
argument_list|,
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|,
literal|"writing header of %s"
argument_list|,
name|new_name
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|close
argument_list|(
name|old
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|close
argument_list|(
name|new
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|mark_x
argument_list|(
name|new_name
argument_list|)
expr_stmt|;
end_expr_stmt

begin_escape
unit|}
end_escape

begin_comment
comment|/*  * mark_x  *  * After succesfully building the new a.out, mark it executable  */
end_comment

begin_macro
unit|static
name|mark_x
argument_list|(
argument|name
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|stat
name|sbuf
decl_stmt|;
name|int
name|um
init|=
name|umask
argument_list|(
literal|777
argument_list|)
decl_stmt|;
name|umask
argument_list|(
name|um
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|name
argument_list|,
operator|&
name|sbuf
argument_list|)
operator|<
literal|0
condition|)
name|fatal_unexec
argument_list|(
literal|"getting protection on %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|sbuf
operator|.
name|st_mode
operator||=
literal|0111
operator|&
operator|~
name|um
expr_stmt|;
if|if
condition|(
name|chmod
argument_list|(
name|name
argument_list|,
name|sbuf
operator|.
name|st_mode
argument_list|)
operator|<
literal|0
condition|)
name|fatal_unexec
argument_list|(
literal|"setting protection on %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|void
name|fatal_unexec
parameter_list|(
name|s
parameter_list|,
name|va_alist
parameter_list|)
function|va_dcl
block|{
name|va_list
name|ap
decl_stmt|;
if|if
condition|(
name|errno
operator|==
name|EEOF
condition|)
name|fputs
argument_list|(
literal|"unexec: unexpected end of file, "
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|errno
operator|<
name|sys_nerr
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unexec: %s, "
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unexec: error code %d, "
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|_doprnt
argument_list|(
name|s
argument_list|,
name|ap
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|".\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* getbbent.c - subroutines for accessing the BBoards file */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|ident
index|[]
init|=
literal|"@(#)$Id: getbbent.c,v 1.14 1992/12/15 00:20:22 jromine Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* lint */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|"bboards.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|MMDFONLY
end_ifndef

begin_include
include|#
directive|include
file|"../h/strings.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* MMDFONLY */
end_comment

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"mmdf.h"
end_include

begin_include
include|#
directive|include
file|"strings.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* MMDFONLY */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|MMDFONLY
end_ifndef

begin_define
define|#
directive|define
name|NOTOK
value|(-1)
end_define

begin_define
define|#
directive|define
name|OK
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not MMDFONLY */
end_comment

begin_define
define|#
directive|define
name|MaxBBAka
value|100
end_define

begin_define
define|#
directive|define
name|MaxBBLdr
value|100
end_define

begin_define
define|#
directive|define
name|MaxBBDist
value|100
end_define

begin_define
define|#
directive|define
name|NCOLON
value|9
end_define

begin_comment
comment|/* currently 10 fields per entry */
end_comment

begin_define
define|#
directive|define
name|COLON
value|':'
end_define

begin_define
define|#
directive|define
name|COMMA
value|','
end_define

begin_define
define|#
directive|define
name|NEWLINE
value|'\n'
end_define

begin_define
define|#
directive|define
name|ARCHIVE
value|"archive"
end_define

begin_define
define|#
directive|define
name|CNTFILE
value|".cnt"
end_define

begin_define
define|#
directive|define
name|DSTFILE
value|".dist"
end_define

begin_define
define|#
directive|define
name|MAPFILE
value|".map"
end_define

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
specifier|static
name|int
name|BBuid
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|BBflags
init|=
name|SB_NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBName
index|[
name|BUFSIZ
index|]
init|=
name|BBOARDS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBDir
index|[
name|BUFSIZ
index|]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBData
index|[
name|BUFSIZ
index|]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|BBfile
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|bboard
name|BB
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|bboard
modifier|*
name|bb
init|=
operator|&
name|BB
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|BBload
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBFile
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBArchive
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBInfo
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBMap
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|BBAkas
index|[
name|MaxBBAka
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|BBLeaders
index|[
name|MaxBBLdr
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|BBDists
index|[
name|MaxBBDist
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBAddr
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBRequest
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBDate
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|BBErrors
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|MMDFONLY
end_ifdef

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|logptr
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* MMDFONLY */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|bbskip
argument_list|()
decl_stmt|,
modifier|*
name|getcpy
argument_list|()
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__STDC__
argument_list|)
operator|&&
name|defined
argument_list|(
name|SVR4
argument_list|)
end_if

begin_include
include|#
directive|include
file|<crypt.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|UNISTD
argument_list|)
operator|||
name|defined
argument_list|(
name|_AIX
argument_list|)
end_if

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_else
else|#
directive|else
end_else

begin_ifndef
ifndef|#
directive|ifndef
name|__STDC__
end_ifndef

begin_decl_stmt
name|char
modifier|*
name|crypt
argument_list|()
decl_stmt|,
modifier|*
name|getpass
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|struct
name|group
modifier|*
name|getgrnam
parameter_list|()
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|SYS5
end_ifdef

begin_decl_stmt
name|struct
name|passwd
modifier|*
name|getpwnam
argument_list|()
decl_stmt|,
modifier|*
name|getpwuid
argument_list|()
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !__STDC__ */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _AIX */
end_comment

begin_decl_stmt
specifier|static
name|int
name|setpwaux
argument_list|()
decl_stmt|,
name|getbbitem
argument_list|()
decl_stmt|,
name|bblose
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|BBread
parameter_list|()
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|UCL
end_ifdef

begin_decl_stmt
name|int
name|called_bbc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|bbs
index|[
literal|101
index|]
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|setbbfile
parameter_list|(
name|file
parameter_list|,
name|f
parameter_list|)
specifier|register
name|char
modifier|*
name|file
decl_stmt|;
specifier|register
name|int
name|f
decl_stmt|;
block|{
if|if
condition|(
name|BBuid
operator|==
operator|-
literal|1
condition|)
return|return
name|setbbinfo
argument_list|(
name|BBOARDS
argument_list|,
name|file
argument_list|,
name|f
argument_list|)
return|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|BBData
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|BBflags
operator|=
name|SB_NULL
expr_stmt|;
operator|(
name|void
operator|)
name|endbbent
argument_list|()
expr_stmt|;
return|return
name|setbbent
argument_list|(
name|f
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|setbbinfo
parameter_list|(
name|user
parameter_list|,
name|file
parameter_list|,
name|f
parameter_list|)
specifier|register
name|char
modifier|*
name|user
decl_stmt|,
decl|*
name|file
decl_stmt|;
end_function

begin_decl_stmt
specifier|register
name|int
name|f
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
if|if
condition|(
operator|(
name|pw
operator|=
name|getpwnam
argument_list|(
name|user
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBErrors
argument_list|,
literal|"unknown user: %s"
argument_list|,
name|user
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|setpwinfo
argument_list|(
name|pw
argument_list|,
name|file
argument_list|,
name|f
argument_list|)
return|;
block|}
end_block

begin_function
name|int
name|setpwinfo
parameter_list|(
name|pw
parameter_list|,
name|file
parameter_list|,
name|f
parameter_list|)
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
specifier|register
name|char
modifier|*
name|file
decl_stmt|;
specifier|register
name|int
name|f
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|setpwaux
argument_list|(
name|pw
argument_list|,
name|file
argument_list|)
condition|)
return|return
literal|0
return|;
name|BBflags
operator|=
name|SB_NULL
expr_stmt|;
operator|(
name|void
operator|)
name|endbbent
argument_list|()
expr_stmt|;
return|return
name|setbbent
argument_list|(
name|f
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|setbbaux
parameter_list|(
name|name
parameter_list|,
name|file
parameter_list|)
specifier|register
name|char
modifier|*
name|name
decl_stmt|,
decl|*
name|file
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
if|if
condition|(
operator|(
name|pw
operator|=
name|getpwnam
argument_list|(
name|name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBErrors
argument_list|,
literal|"unknown user: %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|setpwaux
argument_list|(
name|pw
argument_list|,
name|file
argument_list|)
return|;
block|}
end_block

begin_function
specifier|static
name|int
name|setpwaux
parameter_list|(
name|pw
parameter_list|,
name|file
parameter_list|)
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
specifier|register
name|char
modifier|*
name|file
decl_stmt|;
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|BBName
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
name|BBuid
operator|=
name|pw
operator|->
name|pw_uid
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|BBDir
argument_list|,
name|pw
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBData
argument_list|,
literal|"%s/%s"
argument_list|,
operator|*
name|file
operator|!=
literal|'/'
condition|?
name|BBDir
else|:
literal|""
argument_list|,
operator|*
name|file
operator|!=
literal|'/'
condition|?
name|file
else|:
name|file
operator|+
literal|1
argument_list|)
expr_stmt|;
name|BBflags
operator|=
name|SB_NULL
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|setbbent
parameter_list|(
name|f
parameter_list|)
specifier|register
name|int
name|f
decl_stmt|;
block|{
if|if
condition|(
name|BBfile
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|BBuid
operator|==
operator|-
literal|1
operator|&&
operator|!
name|setbbaux
argument_list|(
name|BBOARDS
argument_list|,
name|BBDB
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|BBfile
operator|=
name|fopen
argument_list|(
name|BBData
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBErrors
argument_list|,
literal|"unable to open: %s"
argument_list|,
name|BBData
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
else|else
name|rewind
argument_list|(
name|BBfile
argument_list|)
expr_stmt|;
name|BBflags
operator||=
name|f
expr_stmt|;
return|return
operator|(
name|BBfile
operator|!=
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|int
name|endbbent
parameter_list|()
block|{
if|if
condition|(
name|BBfile
operator|!=
name|NULL
operator|&&
operator|!
operator|(
name|BBflags
operator|&
name|SB_STAY
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|BBfile
argument_list|)
expr_stmt|;
name|BBfile
operator|=
name|NULL
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|long
name|getbbtime
parameter_list|()
block|{
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
name|BBfile
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|BBuid
operator|==
operator|-
literal|1
operator|&&
operator|!
name|setbbaux
argument_list|(
name|BBOARDS
argument_list|,
name|BBDB
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|stat
argument_list|(
name|BBData
argument_list|,
operator|&
name|st
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBErrors
argument_list|,
literal|"unable to stat: %s"
argument_list|,
name|BBData
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|BBfile
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBErrors
argument_list|,
literal|"unable to fstat: %s"
argument_list|,
name|BBData
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|(
operator|(
name|long
operator|)
name|st
operator|.
name|st_mtime
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|struct
name|bboard
modifier|*
name|getbbent
parameter_list|()
block|{
specifier|register
name|int
name|count
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|,
modifier|*
name|r
decl_stmt|,
modifier|*
name|d
decl_stmt|,
modifier|*
name|f
decl_stmt|,
modifier|*
modifier|*
name|s
decl_stmt|;
specifier|static
name|char
name|line
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|BBfile
operator|==
name|NULL
operator|&&
operator|!
name|setbbent
argument_list|(
name|SB_NULL
argument_list|)
condition|)
return|return
name|NULL
return|;
name|retry
label|:
empty_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
name|line
argument_list|,
name|BBfile
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|q
operator|=
name|p
operator|,
name|count
operator|=
literal|0
init|;
operator|*
name|q
operator|!=
literal|0
operator|&&
operator|*
name|q
operator|!=
name|NEWLINE
condition|;
name|q
operator|++
control|)
if|if
condition|(
operator|*
name|q
operator|==
name|COLON
condition|)
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|!=
name|NCOLON
condition|)
block|{
ifdef|#
directive|ifdef
name|MMDFONLY
if|if
condition|(
name|q
operator|=
name|index
argument_list|(
name|p
argument_list|,
name|NEWLINE
argument_list|)
condition|)
operator|*
name|q
operator|=
literal|0
expr_stmt|;
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGTMP
argument_list|,
literal|"bad entry in %s: %s"
argument_list|,
name|BBData
argument_list|,
name|p
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* MMDFONLY */
goto|goto
name|retry
goto|;
block|}
name|bb
operator|->
name|bb_name
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|q
operator|=
name|bbskip
argument_list|(
name|p
argument_list|,
name|COLON
argument_list|)
expr_stmt|;
name|p
operator|=
name|bb
operator|->
name|bb_file
operator|=
name|bbskip
argument_list|(
name|p
argument_list|,
name|COLON
argument_list|)
expr_stmt|;
name|bb
operator|->
name|bb_archive
operator|=
name|bb
operator|->
name|bb_info
operator|=
name|bb
operator|->
name|bb_map
operator|=
literal|""
expr_stmt|;
name|p
operator|=
name|bb
operator|->
name|bb_passwd
operator|=
name|bbskip
argument_list|(
name|p
argument_list|,
name|COLON
argument_list|)
expr_stmt|;
name|p
operator|=
name|r
operator|=
name|bbskip
argument_list|(
name|p
argument_list|,
name|COLON
argument_list|)
expr_stmt|;
name|p
operator|=
name|bb
operator|->
name|bb_addr
operator|=
name|bbskip
argument_list|(
name|p
argument_list|,
name|COLON
argument_list|)
expr_stmt|;
name|p
operator|=
name|bb
operator|->
name|bb_request
operator|=
name|bbskip
argument_list|(
name|p
argument_list|,
name|COLON
argument_list|)
expr_stmt|;
name|p
operator|=
name|bb
operator|->
name|bb_relay
operator|=
name|bbskip
argument_list|(
name|p
argument_list|,
name|COLON
argument_list|)
expr_stmt|;
name|p
operator|=
name|d
operator|=
name|bbskip
argument_list|(
name|p
argument_list|,
name|COLON
argument_list|)
expr_stmt|;
name|p
operator|=
name|f
operator|=
name|bbskip
argument_list|(
name|p
argument_list|,
name|COLON
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|bbskip
argument_list|(
name|p
argument_list|,
name|NEWLINE
argument_list|)
expr_stmt|;
name|s
operator|=
name|bb
operator|->
name|bb_aka
operator|=
name|BBAkas
expr_stmt|;
while|while
condition|(
operator|*
name|q
condition|)
block|{
operator|*
name|s
operator|++
operator|=
name|q
expr_stmt|;
name|q
operator|=
name|bbskip
argument_list|(
name|q
argument_list|,
name|COMMA
argument_list|)
expr_stmt|;
block|}
operator|*
name|s
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|bb
operator|->
name|bb_leader
operator|=
name|BBLeaders
expr_stmt|;
if|if
condition|(
operator|*
name|r
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|BBflags
operator|&
name|SB_FAST
operator|)
condition|)
block|{
operator|*
name|s
operator|++
operator|=
name|BBName
expr_stmt|;
operator|*
name|s
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
operator|*
name|r
condition|)
block|{
operator|*
name|s
operator|++
operator|=
name|r
expr_stmt|;
name|r
operator|=
name|bbskip
argument_list|(
name|r
argument_list|,
name|COMMA
argument_list|)
expr_stmt|;
block|}
operator|*
name|s
operator|=
literal|0
expr_stmt|;
block|}
name|s
operator|=
name|bb
operator|->
name|bb_dist
operator|=
name|BBDists
expr_stmt|;
while|while
condition|(
operator|*
name|d
condition|)
block|{
operator|*
name|s
operator|++
operator|=
name|d
expr_stmt|;
name|d
operator|=
name|bbskip
argument_list|(
name|d
argument_list|,
name|COMMA
argument_list|)
expr_stmt|;
block|}
operator|*
name|s
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|f
condition|)
operator|(
name|void
operator|)
name|sscanf
argument_list|(
name|f
argument_list|,
literal|"%o"
argument_list|,
operator|&
name|bb
operator|->
name|bb_flags
argument_list|)
expr_stmt|;
else|else
name|bb
operator|->
name|bb_flags
operator|=
name|BB_NULL
expr_stmt|;
name|bb
operator|->
name|bb_count
operator|=
name|bb
operator|->
name|bb_maxima
operator|=
literal|0
expr_stmt|;
name|bb
operator|->
name|bb_date
operator|=
name|NULL
expr_stmt|;
name|bb
operator|->
name|bb_next
operator|=
name|bb
operator|->
name|bb_link
operator|=
name|bb
operator|->
name|bb_chain
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|UCL
comment|/* 	 * Only do a BBread on bboards that the user has expressed an 	 * interest in, if we were called by bbc. 	 */
if|if
condition|(
name|BBload
condition|)
block|{
specifier|register
name|char
modifier|*
modifier|*
name|ap
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|bbp
decl_stmt|;
if|if
condition|(
name|called_bbc
operator|==
literal|0
condition|)
name|BBread
argument_list|()
expr_stmt|;
else|else
block|{
for|for
control|(
name|bbp
operator|=
literal|0
init|;
name|cp
operator|=
name|bbs
index|[
name|bbp
index|]
condition|;
name|bbp
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|bb
operator|->
name|bb_name
argument_list|,
name|cp
argument_list|)
condition|)
block|{
name|BBread
argument_list|()
expr_stmt|;
break|break;
block|}
for|for
control|(
name|ap
operator|=
name|bb
operator|->
name|bb_aka
init|;
operator|*
name|ap
condition|;
name|ap
operator|++
control|)
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|ap
argument_list|,
name|cp
argument_list|)
condition|)
block|{
name|BBread
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
else|#
directive|else
if|if
condition|(
name|BBload
condition|)
name|BBread
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
name|bb
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|struct
name|bboard
modifier|*
name|getbbnam
parameter_list|(
name|name
parameter_list|)
specifier|register
name|char
modifier|*
name|name
decl_stmt|;
block|{
specifier|register
name|struct
name|bboard
modifier|*
name|b
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|setbbent
argument_list|(
name|SB_NULL
argument_list|)
condition|)
return|return
name|NULL
return|;
name|BBload
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|b
operator|=
name|getbbent
argument_list|()
operator|)
operator|&&
name|strcmp
argument_list|(
name|name
argument_list|,
name|b
operator|->
name|bb_name
argument_list|)
condition|)
continue|continue;
name|BBload
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|endbbent
argument_list|()
expr_stmt|;
if|if
condition|(
name|b
operator|!=
name|NULL
condition|)
name|BBread
argument_list|()
expr_stmt|;
return|return
name|b
return|;
block|}
end_function

begin_function
name|struct
name|bboard
modifier|*
name|getbbaka
parameter_list|(
name|aka
parameter_list|)
specifier|register
name|char
modifier|*
name|aka
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
modifier|*
name|ap
decl_stmt|;
specifier|register
name|struct
name|bboard
modifier|*
name|b
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|setbbent
argument_list|(
name|SB_NULL
argument_list|)
condition|)
return|return
name|NULL
return|;
name|BBload
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|b
operator|=
name|getbbent
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
for|for
control|(
name|ap
operator|=
name|b
operator|->
name|bb_aka
init|;
operator|*
name|ap
condition|;
name|ap
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|aka
argument_list|,
operator|*
name|ap
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|hit
goto|;
name|hit
label|:
empty_stmt|;
name|BBload
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|endbbent
argument_list|()
expr_stmt|;
if|if
condition|(
name|b
operator|!=
name|NULL
condition|)
name|BBread
argument_list|()
expr_stmt|;
return|return
name|b
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|void
name|BBread
parameter_list|()
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|r
decl_stmt|;
name|char
name|prf
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|static
name|char
name|line
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|FILE
modifier|*
name|info
decl_stmt|;
if|if
condition|(
name|BBflags
operator|&
name|SB_FAST
condition|)
return|return;
name|p
operator|=
name|index
argument_list|(
name|bb
operator|->
name|bb_request
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
name|r
operator|=
name|index
argument_list|(
name|bb
operator|->
name|bb_addr
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
name|BBRequest
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|bb
operator|->
name|bb_request
operator|==
literal|'-'
condition|)
if|if
condition|(
name|p
operator|==
name|NULL
operator|&&
name|r
operator|&&
operator|*
name|r
operator|==
literal|'@'
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBRequest
argument_list|,
literal|"%s%s%s"
argument_list|,
name|bb
operator|->
name|bb_name
argument_list|,
name|bb
operator|->
name|bb_request
argument_list|,
name|r
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBRequest
argument_list|,
literal|"%s%s"
argument_list|,
name|bb
operator|->
name|bb_name
argument_list|,
name|bb
operator|->
name|bb_request
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|==
name|NULL
operator|&&
name|r
operator|&&
operator|*
name|r
operator|==
literal|'@'
operator|&&
operator|*
name|bb
operator|->
name|bb_request
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBRequest
argument_list|,
literal|"%s%s"
argument_list|,
name|bb
operator|->
name|bb_request
argument_list|,
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|BBRequest
index|[
literal|0
index|]
condition|)
name|bb
operator|->
name|bb_request
operator|=
name|BBRequest
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|bb
operator|->
name|bb_request
operator|==
literal|0
condition|)
name|bb
operator|->
name|bb_request
operator|=
operator|*
name|bb
operator|->
name|bb_addr
condition|?
name|bb
operator|->
name|bb_addr
else|:
name|bb
operator|->
name|bb_leader
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|bb
operator|->
name|bb_addr
operator|==
literal|'@'
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBAddr
argument_list|,
literal|"%s%s"
argument_list|,
name|bb
operator|->
name|bb_name
argument_list|,
name|bb
operator|->
name|bb_addr
argument_list|)
expr_stmt|;
name|bb
operator|->
name|bb_addr
operator|=
name|BBAddr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|bb
operator|->
name|bb_addr
operator|==
literal|0
condition|)
name|bb
operator|->
name|bb_addr
operator|=
name|bb
operator|->
name|bb_name
expr_stmt|;
if|if
condition|(
operator|*
name|bb
operator|->
name|bb_file
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|*
name|bb
operator|->
name|bb_file
operator|!=
literal|'/'
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBFile
argument_list|,
literal|"%s/%s"
argument_list|,
name|BBDir
argument_list|,
name|bb
operator|->
name|bb_file
argument_list|)
expr_stmt|;
name|bb
operator|->
name|bb_file
operator|=
name|BBFile
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cp
operator|=
name|rindex
argument_list|(
name|bb
operator|->
name|bb_file
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|*
operator|++
name|cp
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|prf
argument_list|,
literal|""
argument_list|)
operator|,
name|cp
operator|=
name|bb
operator|->
name|bb_file
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|prf
argument_list|,
literal|"%.*s"
argument_list|,
name|cp
operator|-
name|bb
operator|->
name|bb_file
argument_list|,
name|bb
operator|->
name|bb_file
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dp
operator|=
name|index
argument_list|(
name|cp
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|dp
operator|=
name|cp
operator|+
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBArchive
argument_list|,
literal|"%s%s/%s"
argument_list|,
name|prf
argument_list|,
name|ARCHIVE
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|bb
operator|->
name|bb_archive
operator|=
name|BBArchive
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBInfo
argument_list|,
literal|"%s.%.*s%s"
argument_list|,
name|prf
argument_list|,
name|dp
operator|-
name|cp
argument_list|,
name|cp
argument_list|,
name|CNTFILE
argument_list|)
expr_stmt|;
name|bb
operator|->
name|bb_info
operator|=
name|BBInfo
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBMap
argument_list|,
literal|"%s.%.*s%s"
argument_list|,
name|prf
argument_list|,
name|dp
operator|-
name|cp
argument_list|,
name|cp
argument_list|,
name|MAPFILE
argument_list|)
expr_stmt|;
name|bb
operator|->
name|bb_map
operator|=
name|BBMap
expr_stmt|;
if|if
condition|(
operator|(
name|info
operator|=
name|fopen
argument_list|(
name|bb
operator|->
name|bb_info
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
name|line
argument_list|,
name|info
argument_list|)
operator|&&
operator|(
name|i
operator|=
name|atoi
argument_list|(
name|line
argument_list|)
operator|)
operator|>
literal|0
condition|)
name|bb
operator|->
name|bb_maxima
operator|=
operator|(
name|unsigned
operator|)
name|i
expr_stmt|;
if|if
condition|(
operator|!
name|feof
argument_list|(
name|info
argument_list|)
operator|&&
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
name|line
argument_list|,
name|info
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|BBDate
argument_list|,
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|=
name|index
argument_list|(
name|BBDate
argument_list|,
name|NEWLINE
argument_list|)
condition|)
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
name|bb
operator|->
name|bb_date
operator|=
name|BBDate
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|ldrbb
parameter_list|(
name|b
parameter_list|)
specifier|register
name|struct
name|bboard
modifier|*
name|b
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
modifier|*
name|q
decl_stmt|,
modifier|*
modifier|*
name|r
decl_stmt|;
specifier|static
name|int
name|uid
init|=
literal|0
decl_stmt|,
name|gid
init|=
literal|0
decl_stmt|;
specifier|static
name|char
name|username
index|[
literal|10
index|]
init|=
literal|""
decl_stmt|;
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
specifier|register
name|struct
name|group
modifier|*
name|gr
decl_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|BBuid
operator|==
operator|-
literal|1
operator|&&
operator|!
name|setbbaux
argument_list|(
name|BBOARDS
argument_list|,
name|BBDB
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|username
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|pw
operator|=
name|getpwuid
argument_list|(
name|uid
operator|=
name|getuid
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|gid
operator|=
name|getgid
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|username
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|uid
operator|==
name|BBuid
condition|)
return|return
literal|1
return|;
name|q
operator|=
name|b
operator|->
name|bb_leader
expr_stmt|;
while|while
condition|(
name|p
operator|=
operator|*
name|q
operator|++
condition|)
if|if
condition|(
operator|*
name|p
operator|==
literal|'='
condition|)
block|{
if|if
condition|(
operator|(
name|gr
operator|=
name|getgrnam
argument_list|(
operator|++
name|p
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|gid
operator|==
name|gr
operator|->
name|gr_gid
condition|)
return|return
literal|1
return|;
name|r
operator|=
name|gr
operator|->
name|gr_mem
expr_stmt|;
while|while
condition|(
name|p
operator|=
operator|*
name|r
operator|++
condition|)
if|if
condition|(
name|strcmp
argument_list|(
name|username
argument_list|,
name|p
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|username
argument_list|,
name|p
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|ldrchk
parameter_list|(
name|b
parameter_list|)
specifier|register
name|struct
name|bboard
modifier|*
name|b
decl_stmt|;
block|{
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|b
operator|->
name|bb_passwd
operator|==
literal|0
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|b
operator|->
name|bb_passwd
argument_list|,
name|crypt
argument_list|(
name|getpass
argument_list|(
literal|"Password: "
argument_list|)
argument_list|,
name|b
operator|->
name|bb_passwd
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sorry\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|struct
name|bboard
modifier|*
name|getbbcpy
parameter_list|(
name|bp
parameter_list|)
specifier|register
name|struct
name|bboard
modifier|*
name|bp
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
modifier|*
name|p
decl_stmt|,
modifier|*
modifier|*
name|q
decl_stmt|;
specifier|register
name|struct
name|bboard
modifier|*
name|b
decl_stmt|;
if|if
condition|(
name|bp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|b
operator|=
operator|(
expr|struct
name|bboard
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
sizeof|sizeof
expr|*
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|b
operator|->
name|bb_name
operator|=
name|getcpy
argument_list|(
name|bp
operator|->
name|bb_name
argument_list|)
expr_stmt|;
name|b
operator|->
name|bb_file
operator|=
name|getcpy
argument_list|(
name|bp
operator|->
name|bb_file
argument_list|)
expr_stmt|;
name|b
operator|->
name|bb_archive
operator|=
name|getcpy
argument_list|(
name|bp
operator|->
name|bb_archive
argument_list|)
expr_stmt|;
name|b
operator|->
name|bb_info
operator|=
name|getcpy
argument_list|(
name|bp
operator|->
name|bb_info
argument_list|)
expr_stmt|;
name|b
operator|->
name|bb_map
operator|=
name|getcpy
argument_list|(
name|bp
operator|->
name|bb_map
argument_list|)
expr_stmt|;
name|b
operator|->
name|bb_passwd
operator|=
name|getcpy
argument_list|(
name|bp
operator|->
name|bb_passwd
argument_list|)
expr_stmt|;
name|b
operator|->
name|bb_flags
operator|=
name|bp
operator|->
name|bb_flags
expr_stmt|;
name|b
operator|->
name|bb_count
operator|=
name|bp
operator|->
name|bb_count
expr_stmt|;
name|b
operator|->
name|bb_maxima
operator|=
name|bp
operator|->
name|bb_maxima
expr_stmt|;
name|b
operator|->
name|bb_date
operator|=
name|getcpy
argument_list|(
name|bp
operator|->
name|bb_date
argument_list|)
expr_stmt|;
name|b
operator|->
name|bb_addr
operator|=
name|getcpy
argument_list|(
name|bp
operator|->
name|bb_addr
argument_list|)
expr_stmt|;
name|b
operator|->
name|bb_request
operator|=
name|getcpy
argument_list|(
name|bp
operator|->
name|bb_request
argument_list|)
expr_stmt|;
name|b
operator|->
name|bb_relay
operator|=
name|getcpy
argument_list|(
name|bp
operator|->
name|bb_relay
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|bp
operator|->
name|bb_aka
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
continue|continue;
name|b
operator|->
name|bb_aka
operator|=
name|q
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|calloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|p
operator|-
name|bp
operator|->
name|bb_aka
operator|+
literal|1
argument_list|)
argument_list|,
sizeof|sizeof
expr|*
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|p
operator|=
name|bp
operator|->
name|bb_aka
init|;
operator|*
name|p
condition|;
operator|*
name|q
operator|++
operator|=
name|getcpy
argument_list|(
operator|*
name|p
operator|++
argument_list|)
control|)
continue|continue;
operator|*
name|q
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|p
operator|=
name|bp
operator|->
name|bb_leader
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
continue|continue;
name|b
operator|->
name|bb_leader
operator|=
name|q
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|calloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|p
operator|-
name|bp
operator|->
name|bb_leader
operator|+
literal|1
argument_list|)
argument_list|,
sizeof|sizeof
expr|*
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|p
operator|=
name|bp
operator|->
name|bb_leader
init|;
operator|*
name|p
condition|;
operator|*
name|q
operator|++
operator|=
name|getcpy
argument_list|(
operator|*
name|p
operator|++
argument_list|)
control|)
continue|continue;
operator|*
name|q
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|p
operator|=
name|bp
operator|->
name|bb_dist
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
continue|continue;
name|b
operator|->
name|bb_dist
operator|=
name|q
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|calloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|p
operator|-
name|bp
operator|->
name|bb_dist
operator|+
literal|1
argument_list|)
argument_list|,
sizeof|sizeof
expr|*
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|p
operator|=
name|bp
operator|->
name|bb_dist
init|;
operator|*
name|p
condition|;
operator|*
name|q
operator|++
operator|=
name|getcpy
argument_list|(
operator|*
name|p
operator|++
argument_list|)
control|)
continue|continue;
operator|*
name|q
operator|=
name|NULL
expr_stmt|;
name|b
operator|->
name|bb_next
operator|=
name|bp
operator|->
name|bb_next
expr_stmt|;
name|b
operator|->
name|bb_link
operator|=
name|bp
operator|->
name|bb_link
expr_stmt|;
name|b
operator|->
name|bb_chain
operator|=
name|bp
operator|->
name|bb_chain
expr_stmt|;
return|return
name|b
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
name|int
name|getbbdist
argument_list|(
name|bb
argument_list|,
name|action
argument_list|)
decl|register struct
name|bboard
modifier|*
name|bb
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|register
name|int
function_decl|(
modifier|*
name|action
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|register
name|int
name|result
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|dp
decl_stmt|;
name|BBErrors
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|bb
operator|->
name|bb_dist
init|;
operator|*
name|dp
condition|;
name|dp
operator|++
control|)
if|if
condition|(
name|result
operator|=
name|getbbitem
argument_list|(
name|bb
argument_list|,
operator|*
name|dp
argument_list|,
name|action
argument_list|)
condition|)
return|return
name|result
return|;
return|return
name|result
return|;
block|}
end_block

begin_function
name|char
modifier|*
name|getbberr
parameter_list|()
block|{
return|return
operator|(
name|BBErrors
index|[
literal|0
index|]
condition|?
name|BBErrors
else|:
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
specifier|static
name|int
name|getbbitem
argument_list|(
name|bb
argument_list|,
name|item
argument_list|,
name|action
argument_list|)
decl|register struct
name|bboard
modifier|*
name|bb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|char
modifier|*
name|item
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|register
name|int
function_decl|(
modifier|*
name|action
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|register
name|int
name|result
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|,
modifier|*
name|hp
decl_stmt|,
modifier|*
name|np
decl_stmt|;
name|char
name|mbox
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|file
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|host
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|prf
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
switch|switch
condition|(
operator|*
name|item
condition|)
block|{
case|case
literal|'*'
case|:
switch|switch
condition|(
operator|*
operator|++
name|item
condition|)
block|{
case|case
literal|'/'
case|:
name|hp
operator|=
name|item
expr_stmt|;
break|break;
case|case
literal|0
case|:
if|if
condition|(
operator|(
name|cp
operator|=
name|rindex
argument_list|(
name|bb
operator|->
name|bb_file
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|*
operator|++
name|cp
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|prf
argument_list|,
literal|""
argument_list|)
operator|,
name|cp
operator|=
name|bb
operator|->
name|bb_file
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|prf
argument_list|,
literal|"%.*s"
argument_list|,
name|cp
operator|-
name|bb
operator|->
name|bb_file
argument_list|,
name|bb
operator|->
name|bb_file
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dp
operator|=
name|index
argument_list|(
name|cp
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|dp
operator|=
name|cp
operator|+
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|file
argument_list|,
literal|"%s.%.*s%s"
argument_list|,
name|prf
argument_list|,
name|dp
operator|-
name|cp
argument_list|,
name|cp
argument_list|,
name|DSTFILE
argument_list|)
expr_stmt|;
name|hp
operator|=
name|file
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|file
argument_list|,
literal|"%s/%s"
argument_list|,
name|BBDir
argument_list|,
name|item
argument_list|)
expr_stmt|;
name|hp
operator|=
name|file
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|hp
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|bblose
argument_list|(
literal|"unable to read file %s"
argument_list|,
name|hp
argument_list|)
return|;
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|fp
argument_list|)
condition|)
block|{
if|if
condition|(
name|np
operator|=
name|index
argument_list|(
name|buffer
argument_list|,
literal|'\n'
argument_list|)
condition|)
operator|*
name|np
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|result
operator|=
name|getbbitem
argument_list|(
name|bb
argument_list|,
name|buffer
argument_list|,
name|action
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|bblose
argument_list|(
literal|"error with file %s, item %s"
argument_list|,
name|hp
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
default|default:
if|if
condition|(
name|hp
operator|=
name|rindex
argument_list|(
name|item
argument_list|,
literal|'@'
argument_list|)
condition|)
block|{
operator|*
name|hp
operator|++
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|mbox
argument_list|,
name|item
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|host
argument_list|,
name|hp
argument_list|)
expr_stmt|;
operator|*
operator|--
name|hp
operator|=
literal|'@'
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|mbox
argument_list|,
literal|"%s%s"
argument_list|,
name|DISTADR
argument_list|,
name|bb
operator|->
name|bb_name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|host
argument_list|,
name|item
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|=
call|(
modifier|*
name|action
call|)
argument_list|(
name|mbox
argument_list|,
name|host
argument_list|)
condition|)
operator|(
name|void
operator|)
name|bblose
argument_list|(
literal|"action (%s, %s) returned 0%o"
argument_list|,
name|mbox
argument_list|,
name|host
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* VARARGS1 */
end_comment

begin_function
specifier|static
name|int
name|bblose
parameter_list|(
name|fmt
parameter_list|,
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
name|char
modifier|*
name|fmt
decl_stmt|,
decl|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|,
modifier|*
name|c
decl_stmt|;
end_function

begin_block
block|{
if|if
condition|(
name|BBErrors
index|[
literal|0
index|]
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|BBErrors
argument_list|,
name|fmt
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|void
name|make_lower
parameter_list|(
name|s1
parameter_list|,
name|s2
parameter_list|)
specifier|register
name|char
modifier|*
name|s1
decl_stmt|,
decl|*
name|s2
decl_stmt|;
end_function

begin_block
block|{
if|if
condition|(
name|s1
operator|==
name|NULL
operator|||
name|s2
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
init|;
operator|*
name|s2
condition|;
name|s2
operator|++
control|)
operator|*
name|s1
operator|++
operator|=
name|isupper
argument_list|(
operator|*
name|s2
argument_list|)
condition|?
name|tolower
argument_list|(
operator|*
name|s2
argument_list|)
else|:
operator|*
name|s2
expr_stmt|;
operator|*
name|s1
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|char
modifier|*
name|bbskip
parameter_list|(
name|p
parameter_list|,
name|c
parameter_list|)
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
name|c
decl_stmt|;
block|{
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
name|c
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
condition|)
operator|*
name|p
operator|++
operator|=
literal|0
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|getcpy
parameter_list|(
name|s
parameter_list|)
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|p
operator|=
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|1
argument_list|)
argument_list|)
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|p
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* popi.c - POP initiator - for MPOP */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|ident
index|[]
init|=
literal|"@(#)$Id: popi.c,v 1.8 1992/10/28 18:52:45 jromine Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|"../h/mh.h"
end_include

begin_include
include|#
directive|include
file|"../h/formatsbr.h"
end_include

begin_include
include|#
directive|include
file|"../h/scansbr.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SMTP
end_ifdef

begin_include
include|#
directive|include
file|"../h/local.h"
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* SMTP */
end_comment

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SMTP */
end_comment

begin_include
include|#
directive|include
file|"../zotnet/mts.h"
end_include

begin_comment
comment|/*
comment|*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|RPOP
end_ifndef

begin_define
define|#
directive|define
name|RPOPminc
parameter_list|(
name|a
parameter_list|)
value|(a)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|RPOPminc
parameter_list|(
name|a
parameter_list|)
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|APOP
end_ifndef

begin_define
define|#
directive|define
name|APOPminc
parameter_list|(
name|a
parameter_list|)
value|(a)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|APOPminc
parameter_list|(
name|a
parameter_list|)
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|BPOP
end_ifndef

begin_define
define|#
directive|define
name|BPOPminc
parameter_list|(
name|a
parameter_list|)
value|(a)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|BPOPminc
parameter_list|(
name|a
parameter_list|)
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|SMTP
end_ifndef

begin_define
define|#
directive|define
name|BULKminc
parameter_list|(
name|a
parameter_list|)
value|(a)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|BULKminc
parameter_list|(
name|a
parameter_list|)
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|struct
name|swit
name|switches
index|[]
init|=
block|{
define|#
directive|define
name|APOPSW
value|0
literal|"apop"
block|,
name|APOPminc
argument_list|(
operator|-
literal|4
argument_list|)
block|,
define|#
directive|define
name|NAPOPSW
value|1
literal|"noapop"
block|,
name|APOPminc
argument_list|(
operator|-
literal|6
argument_list|)
block|,
define|#
directive|define
name|AUTOSW
value|2
literal|"auto"
block|,
name|BPOPminc
argument_list|(
operator|-
literal|4
argument_list|)
block|,
define|#
directive|define
name|NAUTOSW
value|3
literal|"noauto"
block|,
name|BPOPminc
argument_list|(
operator|-
literal|6
argument_list|)
block|,
define|#
directive|define
name|BULKSW
value|4
literal|"bulk directory"
block|,
name|BULKminc
argument_list|(
operator|-
literal|4
argument_list|)
block|,
define|#
directive|define
name|FORMSW
value|5
literal|"form formatfile"
block|,
literal|0
block|,
define|#
directive|define
name|FMTSW
value|6
literal|"format string"
block|,
literal|5
block|,
define|#
directive|define
name|HOSTSW
value|7
literal|"host host"
block|,
literal|0
block|,
define|#
directive|define
name|PROGSW
value|8
literal|"mshproc program"
block|,
literal|0
block|,
define|#
directive|define
name|RPOPSW
value|9
literal|"rpop"
block|,
name|RPOPminc
argument_list|(
operator|-
literal|4
argument_list|)
block|,
define|#
directive|define
name|NRPOPSW
value|10
literal|"norpop"
block|,
name|RPOPminc
argument_list|(
operator|-
literal|6
argument_list|)
block|,
define|#
directive|define
name|USERSW
value|11
literal|"user user"
block|,
literal|0
block|,
define|#
directive|define
name|WIDSW
value|12
literal|"width columns"
block|,
literal|0
block|,
define|#
directive|define
name|HELPSW
value|13
literal|"help"
block|,
literal|4
block|,
name|NULL
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|bulksw
init|=
name|NULLCP
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|snoop
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|width
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|mailname
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|nfs
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|msgs
modifier|*
name|mp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|response
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|autosw
init|=
literal|1
decl_stmt|,
name|noisy
init|=
literal|1
decl_stmt|,
name|rpop
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|maildir
decl_stmt|,
modifier|*
name|folder
init|=
name|NULL
decl_stmt|,
modifier|*
name|form
init|=
name|NULL
decl_stmt|,
modifier|*
name|format
init|=
name|NULL
decl_stmt|,
modifier|*
name|host
init|=
name|NULL
decl_stmt|,
modifier|*
name|user
init|=
name|NULL
decl_stmt|,
modifier|*
name|pass
init|=
name|NULL
decl_stmt|,
name|buf
index|[
literal|100
index|]
decl_stmt|,
modifier|*
modifier|*
name|ap
decl_stmt|,
modifier|*
modifier|*
name|argp
decl_stmt|,
modifier|*
name|arguments
index|[
name|MAXARGS
index|]
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|invo_name
operator|=
name|r1bindex
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
name|mts_init
argument_list|(
name|invo_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|pophost
operator|&&
operator|*
name|pophost
condition|)
name|host
operator|=
name|pophost
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|getenv
argument_list|(
literal|"MHPOPDEBUG"
argument_list|)
operator|)
operator|&&
operator|*
name|cp
condition|)
name|snoop
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|m_find
argument_list|(
name|invo_name
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ap
operator|=
name|brkstring
argument_list|(
name|cp
operator|=
name|getcpy
argument_list|(
name|cp
argument_list|)
argument_list|,
literal|" "
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|ap
operator|=
name|copyip
argument_list|(
name|ap
argument_list|,
name|arguments
argument_list|)
expr_stmt|;
block|}
else|else
name|ap
operator|=
name|arguments
expr_stmt|;
operator|(
name|void
operator|)
name|copyip
argument_list|(
name|argv
operator|+
literal|1
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|argp
operator|=
name|arguments
expr_stmt|;
name|rpop
operator|=
name|getuid
argument_list|()
operator|&&
operator|!
name|geteuid
argument_list|()
expr_stmt|;
comment|/*
comment|*/
while|while
condition|(
name|cp
operator|=
operator|*
name|argp
operator|++
condition|)
block|{
if|if
condition|(
operator|*
name|cp
operator|==
literal|'-'
condition|)
switch|switch
condition|(
name|smatch
argument_list|(
operator|++
name|cp
argument_list|,
name|switches
argument_list|)
condition|)
block|{
case|case
name|AMBIGSW
case|:
name|ambigsw
argument_list|(
name|cp
argument_list|,
name|switches
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
case|case
name|UNKWNSW
case|:
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"-%s unknown"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
case|case
name|HELPSW
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s [+folder] [switches]"
argument_list|,
name|invo_name
argument_list|)
expr_stmt|;
name|help
argument_list|(
name|buf
argument_list|,
name|switches
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
case|case
name|AUTOSW
case|:
name|autosw
operator|=
literal|1
expr_stmt|;
continue|continue;
case|case
name|NAUTOSW
case|:
name|autosw
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|BULKSW
case|:
if|if
condition|(
operator|!
operator|(
name|bulksw
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|bulksw
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|FORMSW
case|:
if|if
condition|(
operator|!
operator|(
name|form
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|form
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
name|format
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|FMTSW
case|:
if|if
condition|(
operator|!
operator|(
name|format
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|format
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
name|form
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|WIDSW
case|:
if|if
condition|(
operator|!
operator|(
name|cp
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|cp
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
name|width
operator|=
name|atoi
argument_list|(
name|cp
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|HOSTSW
case|:
if|if
condition|(
operator|!
operator|(
name|host
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|host
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|USERSW
case|:
if|if
condition|(
operator|!
operator|(
name|user
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|user
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|APOPSW
case|:
name|rpop
operator|=
operator|-
literal|1
expr_stmt|;
continue|continue;
case|case
name|RPOPSW
case|:
name|rpop
operator|=
literal|1
expr_stmt|;
continue|continue;
case|case
name|NAPOPSW
case|:
case|case
name|NRPOPSW
case|:
name|rpop
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|PROGSW
case|:
if|if
condition|(
operator|!
operator|(
name|mshproc
operator|=
operator|*
name|argp
operator|++
operator|)
operator|||
operator|*
name|mshproc
operator|==
literal|'-'
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|argp
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|*
name|cp
operator|==
literal|'+'
operator|||
operator|*
name|cp
operator|==
literal|'@'
condition|)
block|{
if|if
condition|(
name|folder
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"only one folder at a time!"
argument_list|)
expr_stmt|;
else|else
name|folder
operator|=
name|path
argument_list|(
name|cp
operator|+
literal|1
argument_list|,
operator|*
name|cp
operator|==
literal|'+'
condition|?
name|TFOLDER
else|:
name|TSUBCWF
argument_list|)
expr_stmt|;
block|}
else|else
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"usage: %s [+folder] [switches]"
argument_list|,
name|invo_name
argument_list|)
expr_stmt|;
block|}
comment|/*
comment|*/
if|if
condition|(
operator|!
name|host
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"usage: %s -host \"host\""
argument_list|,
name|invo_name
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SMTP
if|if
condition|(
name|bulksw
condition|)
name|do_bulk
argument_list|(
name|host
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
name|user
operator|=
name|getusr
argument_list|()
expr_stmt|;
if|if
condition|(
name|rpop
operator|>
literal|0
condition|)
name|pass
operator|=
name|getusr
argument_list|()
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|setuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
name|ruserpass
argument_list|(
name|host
argument_list|,
operator|&
name|user
argument_list|,
operator|&
name|pass
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|mailname
argument_list|,
literal|"PO box for %s@%s"
argument_list|,
name|user
argument_list|,
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|pop_init
argument_list|(
name|host
argument_list|,
name|user
argument_list|,
name|pass
argument_list|,
name|snoop
argument_list|,
name|rpop
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s"
argument_list|,
name|response
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpop
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|setuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
name|nfs
operator|=
name|new_fs
argument_list|(
name|form
argument_list|,
name|format
argument_list|,
name|FORMAT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m_find
argument_list|(
literal|"path"
argument_list|)
condition|)
name|free
argument_list|(
name|path
argument_list|(
literal|"./"
argument_list|,
name|TFOLDER
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|folder
operator|&&
operator|!
operator|(
name|folder
operator|=
name|m_find
argument_list|(
name|inbox
argument_list|)
operator|)
condition|)
name|folder
operator|=
name|defalt
expr_stmt|;
name|maildir
operator|=
name|m_maildir
argument_list|(
name|folder
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|maildir
argument_list|,
operator|&
name|st
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|ENOENT
condition|)
name|adios
argument_list|(
name|maildir
argument_list|,
literal|"error on folder"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|concat
argument_list|(
literal|"Create folder \""
argument_list|,
name|maildir
argument_list|,
literal|"\"? "
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|noisy
operator|&&
operator|!
name|getanswer
argument_list|(
name|cp
argument_list|)
condition|)
name|done
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|makedir
argument_list|(
name|maildir
argument_list|)
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to create folder %s"
argument_list|,
name|maildir
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|chdir
argument_list|(
name|maildir
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|maildir
argument_list|,
literal|"unable to change directory to"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mp
operator|=
name|m_gmsg
argument_list|(
name|folder
argument_list|)
operator|)
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to read folder %s"
argument_list|,
name|folder
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BPOP
if|if
condition|(
name|autosw
condition|)
name|msh
argument_list|()
expr_stmt|;
else|else
endif|#
directive|endif
name|popi
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|pop_quit
argument_list|()
expr_stmt|;
name|m_replace
argument_list|(
name|pfolder
argument_list|,
name|folder
argument_list|)
expr_stmt|;
name|m_setvis
argument_list|(
name|mp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m_sync
argument_list|(
name|mp
argument_list|)
expr_stmt|;
name|m_update
argument_list|()
expr_stmt|;
name|done
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
specifier|static
name|struct
name|swit
name|popicmds
index|[]
init|=
block|{
define|#
directive|define
name|DELECMD
value|0
literal|"dele"
block|,
literal|0
block|,
define|#
directive|define
name|LASTCMD
value|1
literal|"last"
block|,
literal|0
block|,
define|#
directive|define
name|LISTCMD
value|2
literal|"list"
block|,
literal|0
block|,
define|#
directive|define
name|NOOPCMD
value|3
literal|"noop"
block|,
literal|0
block|,
define|#
directive|define
name|QUITCMD
value|4
literal|"quit"
block|,
literal|0
block|,
define|#
directive|define
name|RETRCMD
value|5
literal|"retr"
block|,
literal|0
block|,
define|#
directive|define
name|RSETCMD
value|6
literal|"rset"
block|,
literal|0
block|,
define|#
directive|define
name|SCANCMD
value|7
literal|"scan"
block|,
literal|0
block|,
define|#
directive|define
name|STATCMD
value|8
literal|"stat"
block|,
literal|0
block|,
define|#
directive|define
name|TOPCMD
value|9
literal|"top"
block|,
literal|0
block|,
ifdef|#
directive|ifdef
name|BPOP
define|#
directive|define
name|MSHCMD
value|10
literal|"msh"
block|,
literal|0
block|,
endif|#
directive|endif
name|NULL
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|popi
argument_list|()
block|{
name|int
name|eof
block|;
name|eof
operator|=
literal|0
block|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|eof
condition|)
return|return;
name|printf
argument_list|(
literal|"(%s) "
argument_list|,
name|invo_name
argument_list|)
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|buffer
init|;
operator|(
name|i
operator|=
name|getchar
argument_list|()
operator|)
operator|!=
literal|'\n'
condition|;
control|)
block|{
if|if
condition|(
name|i
operator|==
name|EOF
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|buffer
condition|)
return|return;
name|eof
operator|=
literal|1
expr_stmt|;
break|break;
block|}
end_expr_stmt

begin_if
if|if
condition|(
name|cp
operator|<
name|buffer
operator|+
sizeof|sizeof
name|buffer
operator|-
literal|2
condition|)
operator|*
name|cp
operator|++
operator|=
name|i
expr_stmt|;
end_if

begin_expr_stmt
unit|} 	*
name|cp
operator|=
literal|'\0'
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|buffer
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
continue|continue;
end_if

begin_if
if|if
condition|(
name|buffer
index|[
literal|0
index|]
operator|==
literal|'?'
condition|)
block|{
name|printf
argument_list|(
literal|"commands:\n"
argument_list|)
expr_stmt|;
name|printsw
argument_list|(
name|ALL
argument_list|,
name|popicmds
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type CTRL-D or use \"quit\" to leave %s\n"
argument_list|,
name|invo_name
argument_list|)
expr_stmt|;
continue|continue;
block|}
end_if

begin_if
if|if
condition|(
name|cp
operator|=
name|index
argument_list|(
name|buffer
argument_list|,
literal|' '
argument_list|)
condition|)
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
end_if

begin_switch
switch|switch
condition|(
name|i
operator|=
name|smatch
argument_list|(
name|buffer
argument_list|,
name|popicmds
argument_list|)
condition|)
block|{
case|case
name|AMBIGSW
case|:
name|ambigsw
argument_list|(
name|buffer
argument_list|,
name|popicmds
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|UNKWNSW
case|:
name|printf
argument_list|(
literal|"%s unknown -- type \"?\" for help\n"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|QUITCMD
case|:
return|return;
case|case
name|STATCMD
case|:
case|case
name|DELECMD
case|:
case|case
name|NOOPCMD
case|:
case|case
name|LASTCMD
case|:
case|case
name|RSETCMD
case|:
case|case
name|TOPCMD
case|:
if|if
condition|(
name|cp
condition|)
operator|*
name|cp
operator|=
literal|' '
expr_stmt|;
operator|(
name|void
operator|)
name|pop_command
argument_list|(
literal|"%s%s"
argument_list|,
name|popicmds
index|[
name|i
index|]
operator|.
name|sw
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|""
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|response
argument_list|)
expr_stmt|;
break|break;
case|case
name|LISTCMD
case|:
if|if
condition|(
name|cp
condition|)
operator|*
name|cp
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
name|pop_command
argument_list|(
literal|"%s%s"
argument_list|,
name|popicmds
index|[
name|i
index|]
operator|.
name|sw
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|""
argument_list|)
operator|==
name|OK
condition|)
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|response
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
for|for
control|(
init|;
condition|;
control|)
block|{
switch|switch
condition|(
name|pop_multiline
argument_list|()
condition|)
block|{
case|case
name|DONE
case|:
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|response
argument_list|,
literal|"."
argument_list|)
expr_stmt|;
comment|/* and fall... */
case|case
name|NOTOK
case|:
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|response
argument_list|)
expr_stmt|;
break|break;
case|case
name|OK
case|:
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|response
argument_list|)
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
block|}
break|break;
case|case
name|RETRCMD
case|:
if|if
condition|(
operator|!
name|cp
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"missing argument to %s"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
break|break;
block|}
name|retr_action
argument_list|(
name|NULLCP
argument_list|,
name|OK
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|pop_retr
argument_list|(
name|atoi
argument_list|(
operator|++
name|cp
argument_list|)
argument_list|,
name|retr_action
argument_list|)
expr_stmt|;
name|retr_action
argument_list|(
name|NULLCP
argument_list|,
name|DONE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|response
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCANCMD
case|:
block|{
name|char
modifier|*
name|dp
decl_stmt|,
modifier|*
name|ep
decl_stmt|,
modifier|*
name|fp
decl_stmt|;
if|if
condition|(
name|width
operator|==
literal|0
condition|)
name|width
operator|=
name|sc_width
argument_list|()
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|nfs
operator|,
name|i
operator|=
literal|0
init|;
operator|*
name|dp
condition|;
name|dp
operator|++
operator|,
name|i
operator|++
control|)
if|if
condition|(
operator|*
name|dp
operator|==
literal|'\\'
operator|||
operator|*
name|dp
operator|==
literal|'"'
operator|||
operator|*
name|dp
operator|==
literal|'\n'
condition|)
name|i
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|ep
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|i
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|dp
operator|=
name|nfs
operator|,
name|fp
operator|=
name|ep
init|;
operator|*
name|dp
condition|;
name|dp
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|dp
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|fp
operator|++
operator|=
literal|'\\'
operator|,
operator|*
name|fp
operator|++
operator|=
literal|'n'
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|*
name|dp
operator|==
literal|'"'
operator|||
operator|*
name|dp
operator|==
literal|'\\'
condition|)
operator|*
name|fp
operator|++
operator|=
literal|'\\'
expr_stmt|;
operator|*
name|fp
operator|++
operator|=
operator|*
name|dp
expr_stmt|;
block|}
operator|*
name|fp
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|pop_command
argument_list|(
literal|"xtnd scan %d \"%s\""
argument_list|,
name|width
argument_list|,
name|ep
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|response
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ep
argument_list|)
expr_stmt|;
block|}
break|break;
ifdef|#
directive|ifdef
name|BPOP
case|case
name|MSHCMD
case|:
name|msh
argument_list|()
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
end_switch

begin_comment
unit|} }
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|retr_action
parameter_list|(
name|rsp
parameter_list|,
name|flag
parameter_list|)
name|char
modifier|*
name|rsp
decl_stmt|;
name|int
name|flag
decl_stmt|;
block|{
specifier|static
name|FILE
modifier|*
name|fp
decl_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
specifier|static
name|int
name|msgnum
decl_stmt|;
specifier|static
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
name|flag
operator|==
name|OK
condition|)
block|{
if|if
condition|(
operator|(
name|mp
operator|=
name|m_remsg
argument_list|(
name|mp
argument_list|,
literal|0
argument_list|,
name|msgnum
operator|=
name|mp
operator|->
name|hghmsg
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to allocate folder storage"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|getcpy
argument_list|(
name|m_name
argument_list|(
name|mp
operator|->
name|hghmsg
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|cp
argument_list|,
literal|"w+"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|cp
argument_list|,
literal|"unable to write"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|chmod
argument_list|(
name|cp
argument_list|,
name|m_gmprot
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|stat
name|st
decl_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|fp
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|!=
name|NOTOK
operator|&&
name|st
operator|.
name|st_size
operator|>
literal|0
condition|)
block|{
name|mp
operator|->
name|msgstats
index|[
name|msgnum
index|]
operator|=
name|EXISTS
operator||
name|UNSEEN
expr_stmt|;
name|mp
operator|->
name|msgflags
operator||=
name|SEQMOD
expr_stmt|;
if|if
condition|(
name|ferror
argument_list|(
name|fp
argument_list|)
condition|)
name|advise
argument_list|(
name|cp
argument_list|,
literal|"write error on"
argument_list|)
expr_stmt|;
name|mp
operator|->
name|hghmsg
operator|=
name|msgnum
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|cp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
operator|,
name|fp
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|cp
argument_list|)
operator|,
name|cp
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s\n"
argument_list|,
name|rsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|BPOP
end_ifdef

begin_expr_stmt
specifier|static
name|msh
argument_list|()
block|{
name|int
name|child_id
block|,
name|vecp
block|;
name|char
name|buf1
index|[
name|BUFSIZ
index|]
block|,
name|buf2
index|[
name|BUFSIZ
index|]
block|,
operator|*
name|vec
index|[
literal|9
index|]
block|;
if|if
condition|(
name|pop_fd
argument_list|(
name|buf1
argument_list|,
name|buf2
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"%s"
argument_list|,
name|response
argument_list|)
expr_stmt|;
name|vecp
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|r1bindex
argument_list|(
name|mshproc
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
end_expr_stmt

begin_switch
switch|switch
condition|(
name|child_id
operator|=
name|fork
argument_list|()
condition|)
block|{
case|case
name|NOTOK
case|:
name|adios
argument_list|(
literal|"fork"
argument_list|,
literal|"unable to"
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
literal|"-popread"
expr_stmt|;
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|buf1
expr_stmt|;
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
literal|"-popwrite"
expr_stmt|;
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|buf2
expr_stmt|;
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
literal|"-idname"
expr_stmt|;
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|mailname
expr_stmt|;
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|mailname
expr_stmt|;
name|vec
index|[
name|vecp
index|]
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|execvp
argument_list|(
name|mshproc
argument_list|,
name|vec
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unable to exec "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|mshproc
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
default|default:
operator|(
name|void
operator|)
name|pidXwait
argument_list|(
name|child_id
argument_list|,
name|mshproc
argument_list|)
expr_stmt|;
break|break;
block|}
end_switch

begin_endif
unit|}
endif|#
directive|endif
end_endif

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SMTP
end_ifdef

begin_include
include|#
directive|include
file|"../zotnet/mts.h"
end_include

begin_include
include|#
directive|include
file|"../mts/sendmail/smail.h"
end_include

begin_function
unit|static
name|int
name|dselect
parameter_list|(
name|d
parameter_list|)
specifier|register
name|struct
name|direct
modifier|*
name|d
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|strlen
argument_list|(
name|d
operator|->
name|d_name
argument_list|)
operator|)
operator|<
sizeof|sizeof
expr|"smtp"
operator|||
name|strncmp
argument_list|(
name|d
operator|->
name|d_name
argument_list|,
literal|"smtp"
argument_list|,
sizeof|sizeof
expr|"smtp"
operator|-
literal|1
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
operator|(
operator|(
name|i
operator|-=
operator|(
sizeof|sizeof
expr|".bulk"
operator|-
literal|1
operator|)
operator|)
operator|>
literal|0
operator|&&
operator|!
name|strcmp
argument_list|(
name|d
operator|->
name|d_name
operator|+
name|i
argument_list|,
literal|".bulk"
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dcompar
parameter_list|(
name|d1
parameter_list|,
name|d2
parameter_list|)
name|struct
name|direct
modifier|*
modifier|*
name|d1
decl_stmt|,
decl|*
modifier|*
name|d2
decl_stmt|;
end_function

begin_block
block|{
name|struct
name|stat
name|s1
decl_stmt|,
name|s2
decl_stmt|;
if|if
condition|(
name|stat
argument_list|(
operator|(
operator|*
name|d1
operator|)
operator|->
name|d_name
argument_list|,
operator|&
name|s1
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|stat
argument_list|(
operator|(
operator|*
name|d2
operator|)
operator|->
name|d_name
argument_list|,
operator|&
name|s2
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
operator|-
literal|1
return|;
return|return
operator|(
call|(
name|int
call|)
argument_list|(
name|s1
operator|.
name|st_mtime
operator|-
name|s2
operator|.
name|st_mtime
argument_list|)
operator|)
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|do_bulk
argument_list|(
argument|host
argument_list|)
name|char
operator|*
name|host
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|n
decl_stmt|,
name|retval
decl_stmt|,
name|sm
decl_stmt|;
name|struct
name|direct
modifier|*
modifier|*
name|namelist
decl_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|bulksw
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|bulksw
argument_list|,
literal|"unable to change directory to"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|scandir
argument_list|(
literal|"."
argument_list|,
operator|&
name|namelist
argument_list|,
name|dselect
argument_list|,
name|dcompar
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|bulksw
argument_list|,
literal|"unable to scan directory"
argument_list|)
expr_stmt|;
name|sm
operator|=
name|NOTOK
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
specifier|register
name|struct
name|direct
modifier|*
name|d
init|=
name|namelist
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_init
argument_list|(
name|NULLCP
argument_list|,
name|host
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|snoop
argument_list|)
argument_list|)
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"problem initializing server: %s"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|sm
operator|=
name|OK
expr_stmt|;
block|}
switch|switch
condition|(
name|retval
operator|=
name|sm_bulk
argument_list|(
name|d
operator|->
name|d_name
argument_list|)
condition|)
block|{
default|default:
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
argument_list|)
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"problem delivering msg %s: %s"
argument_list|,
name|d
operator|->
name|d_name
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
comment|/* else fall... */
case|case
name|RP_OK
case|:
case|case
name|RP_NO
case|:
case|case
name|RP_NDEL
case|:
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"msg %s: %s"
argument_list|,
name|d
operator|->
name|d_name
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|sm
operator|==
name|OK
condition|)
block|{
specifier|register
name|int
name|j
decl_stmt|;
name|int
name|l
decl_stmt|,
name|m
decl_stmt|;
name|struct
name|direct
modifier|*
modifier|*
name|newlist
decl_stmt|;
while|while
condition|(
operator|(
name|l
operator|=
name|scandir
argument_list|(
literal|"."
argument_list|,
operator|&
name|newlist
argument_list|,
name|dselect
argument_list|,
name|dcompar
argument_list|)
operator|)
operator|>
name|OK
condition|)
block|{
name|m
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|l
condition|;
name|j
operator|++
control|)
block|{
specifier|register
name|struct
name|direct
modifier|*
name|d
init|=
name|newlist
index|[
name|j
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|d
operator|->
name|d_name
argument_list|,
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|n
condition|)
block|{
switch|switch
condition|(
name|retval
operator|=
name|sm_bulk
argument_list|(
name|d
operator|->
name|d_name
argument_list|)
condition|)
block|{
default|default:
if|if
condition|(
name|rp_isbad
argument_list|(
name|retval
argument_list|)
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"problem delivering msg %s: %s"
argument_list|,
name|d
operator|->
name|d_name
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
comment|/* else fall... */
case|case
name|RP_OK
case|:
case|case
name|RP_NO
case|:
case|case
name|RP_NDEL
case|:
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"msg %s: %s"
argument_list|,
name|d
operator|->
name|d_name
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|m
operator|=
literal|1
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|namelist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|namelist
argument_list|)
expr_stmt|;
name|namelist
operator|=
name|newlist
operator|,
name|n
operator|=
name|l
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
break|break;
name|newlist
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sm
operator|==
name|OK
operator|&&
name|rp_isbad
argument_list|(
name|retval
operator|=
name|sm_end
argument_list|(
name|OK
argument_list|)
argument_list|)
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"problem finalizing server: %s"
argument_list|,
name|rp_string
argument_list|(
name|retval
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|namelist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|namelist
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|namelist
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)dumpdev.c	1.2 (CWI) 85/10/24"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_comment
comment|/*  * inverse of makethev, dump de information of the (binary) device information  * will also dump the font info of standard (default) mounted fonts.  *  * Usage:  * dumpdev [flags] device  *  * flags:  *	-f name;	take info from dir name instead of default dir  *	-Tdevice;	device for wich the dump is made;  *	-D;		dump only the device info, not the font info  *	-F F1 F2 ...;	dump only the named fonts info  *	-d;		give extra debug info on error output  *  * Author: jaap akkerhuis, Mathematisch Centrum, O
comment|c 1982  *  */
end_comment

begin_include
include|#
directive|include
file|"../dev.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_define
define|#
directive|define
name|BMASK
value|0377
end_define

begin_define
define|#
directive|define
name|FATAL
value|1
end_define

begin_decl_stmt
name|struct
name|dev
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|Font
name|font
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fontdir
init|=
literal|"/usr/local/lib/ditroff/font"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|devname
init|=
literal|"har"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* devicename */
end_comment

begin_decl_stmt
name|int
name|nfonts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nsizes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nchtab
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NSIZE
value|100
end_define

begin_comment
comment|/* maximum number of sizes */
end_comment

begin_define
define|#
directive|define
name|NCH
value|256
end_define

begin_comment
comment|/* maximum number of characters with funny names */
end_comment

begin_define
define|#
directive|define
name|FSIZE
value|200
end_define

begin_comment
comment|/* size of physical font */
end_comment

begin_define
define|#
directive|define
name|NFONT
value|10
end_define

begin_comment
comment|/* Maximum number of default fonts */
end_comment

begin_decl_stmt
name|int
name|dbg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Dflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Fflag
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
operator|&&
name|argv
index|[
literal|1
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
name|argv
index|[
literal|1
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'f'
case|:
name|fontdir
operator|=
name|argv
index|[
literal|2
index|]
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|dbg
operator|++
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|devname
operator|=
operator|&
name|argv
index|[
literal|1
index|]
index|[
literal|2
index|]
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|Dflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
name|Fflag
operator|++
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown option %c\n"
argument_list|,
name|argv
index|[
literal|1
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|devname
operator|==
name|NULL
condition|)
name|error
argument_list|(
name|FATAL
argument_list|,
literal|"No device specified"
argument_list|)
expr_stmt|;
name|getdesc
argument_list|()
expr_stmt|;
if|if
condition|(
name|Dflag
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|Fflag
condition|)
while|while
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|getfont
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_macro
name|error
argument_list|(
argument|f
argument_list|,
argument|s
argument_list|,
argument|a1
argument_list|,
argument|a2
argument_list|,
argument|a3
argument_list|,
argument|a4
argument_list|,
argument|a5
argument_list|,
argument|a6
argument_list|,
argument|a7
argument_list|)
end_macro

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"dumpdev: "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|s
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|,
name|a6
argument_list|,
name|a7
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * structure of a device file.  *  * the first part consists of the structure dev.  *  * Notes: dev.filesize contains the size of the file minus the strcture dev  * 	dev.nchtab contains the nimber of funny charnames +1  *  * then follows a list of sizes (shorts), ended with a zero.  *  * then follows a table of dev.nchtab pointers ( shorts  ),  * 	these will point to the strings with all the funnynames.  *	this is called chtab.  *  * after this is the table of funny names (chname) which is dev.lnchname  *	bytes big.  *  * So up uo here the device charactistics are read.  *  * Then follows the default mounted font info, dev.nfont times (max NFONT).  *  * first the font structure.  *  * font.nwfonts is the amount of widths of the font, so it will be used  * as the amount of characters in the font as well.  *   * so now will follow:  *	the widthtable (font.nwfonts bytes) containg the widths info  *	the kerntable (font.nwfonts bytes) containing the de-& ascender info  *	the codetable (font.nwfonts bytes) containing the codes for the chars  *	the fitable (dev.nchtab+128-32 bytes) containing indexes to the  *		previous three tables.  *	  *	if font.fonttab == 1  *		will also follow the fcodetable (font.nwfonts (sizeof(short))  *		containing the physical font numbers ( see also the comment  *		added by jna in makedev.c)  *  * for info about the use of this tables, see the comment at dumpfont.  *  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|chname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
modifier|*
name|chtab
decl_stmt|;
end_decl_stmt

begin_macro
name|getdesc
argument_list|()
end_macro

begin_block
block|{
name|char
modifier|*
name|malloc
argument_list|()
decl_stmt|,
modifier|*
name|filebase
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|struct
name|Font
modifier|*
name|fontbase
index|[
name|NFONT
index|]
decl_stmt|;
name|short
modifier|*
name|pstab
decl_stmt|,
modifier|*
name|p1
decl_stmt|;
name|int
name|i
decl_stmt|,
name|fin
decl_stmt|,
name|nw
decl_stmt|;
name|char
name|temp
index|[
literal|60
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|temp
argument_list|,
literal|"%s/dev%s/DESC.out"
argument_list|,
name|fontdir
argument_list|,
name|devname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fin
operator|=
name|open
argument_list|(
name|temp
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|error
argument_list|(
name|FATAL
argument_list|,
literal|"can't open DESC.out for %s\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"# Dump of device %s (%s)\n"
argument_list|,
name|devname
argument_list|,
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|read
argument_list|(
name|fin
argument_list|,
operator|&
name|dev
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|dev
argument_list|)
argument_list|)
operator|)
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|dev
argument_list|)
condition|)
name|error
argument_list|(
name|FATAL
argument_list|,
literal|"read error reading devstruct %s"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|nfonts
operator|=
name|dev
operator|.
name|nfonts
expr_stmt|;
name|nsizes
operator|=
name|dev
operator|.
name|nsizes
expr_stmt|;
name|nchtab
operator|=
name|dev
operator|.
name|nchtab
expr_stmt|;
if|if
condition|(
name|nfonts
operator|>
name|NFONT
condition|)
name|error
argument_list|(
operator|!
name|FATAL
argument_list|,
literal|"More (%d) fonts then possible (%d)"
argument_list|,
name|nfonts
argument_list|,
name|NFONT
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsizes
operator|>
name|NSIZE
condition|)
name|error
argument_list|(
operator|!
name|FATAL
argument_list|,
literal|"More (%d) sizes then possible (%d)"
argument_list|,
name|nsizes
argument_list|,
name|NSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|nchtab
operator|>
name|NCH
condition|)
name|error
argument_list|(
operator|!
name|FATAL
argument_list|,
literal|"More (%d) names then possible (%d)"
argument_list|,
name|nchtab
argument_list|,
name|NCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbg
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"filesize %d, default fonts %d, sizes %d, funny names %d lchname %d\n"
argument_list|,
name|dev
operator|.
name|filesize
argument_list|,
name|dev
operator|.
name|nfonts
argument_list|,
name|dev
operator|.
name|nsizes
argument_list|,
name|dev
operator|.
name|nchtab
argument_list|,
name|dev
operator|.
name|lchname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"sizescale %d, paperwidth %d, paperlenght %d, spare1 %d, spare2 %d\n"
argument_list|,
name|dev
operator|.
name|sizescale
argument_list|,
name|dev
operator|.
name|paperwidth
argument_list|,
name|dev
operator|.
name|paperlength
argument_list|,
name|dev
operator|.
name|spare1
argument_list|,
name|dev
operator|.
name|spare2
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"res %d\nhor %d\nvert %d\nunitwidth %d\n"
argument_list|,
name|dev
operator|.
name|res
argument_list|,
name|dev
operator|.
name|hor
argument_list|,
name|dev
operator|.
name|vert
argument_list|,
name|dev
operator|.
name|unitwidth
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|.
name|sizescale
condition|)
name|printf
argument_list|(
literal|"sizescale %d\n"
argument_list|,
name|dev
operator|.
name|sizescale
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|.
name|paperwidth
condition|)
name|printf
argument_list|(
literal|"paperwidth %d\n"
argument_list|,
name|dev
operator|.
name|paperwidth
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|.
name|paperlength
condition|)
name|printf
argument_list|(
literal|"paperlength %d\n"
argument_list|,
name|dev
operator|.
name|paperlength
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|.
name|spare1
condition|)
name|printf
argument_list|(
literal|"spare1 %d\n"
argument_list|,
name|dev
operator|.
name|spare1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|.
name|spare2
condition|)
name|printf
argument_list|(
literal|"spare2 %d\n"
argument_list|,
name|dev
operator|.
name|spare2
argument_list|)
expr_stmt|;
name|filebase
operator|=
name|malloc
argument_list|(
name|dev
operator|.
name|filesize
argument_list|)
expr_stmt|;
comment|/* enough room for whole file */
if|if
condition|(
operator|(
name|read
argument_list|(
name|fin
argument_list|,
name|filebase
argument_list|,
name|dev
operator|.
name|filesize
argument_list|)
operator|)
operator|!=
name|dev
operator|.
name|filesize
condition|)
comment|/* all at once */
name|error
argument_list|(
name|FATAL
argument_list|,
literal|"read error reading fontinfo %s"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|pstab
operator|=
operator|(
name|short
operator|*
operator|)
name|filebase
expr_stmt|;
name|printf
argument_list|(
literal|"sizes "
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|p1
operator|=
name|pstab
init|;
operator|*
name|p1
condition|;
name|p1
operator|++
control|)
block|{
name|i
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"%d "
argument_list|,
operator|*
name|p1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
name|nsizes
condition|)
name|error
argument_list|(
operator|!
name|FATAL
argument_list|,
literal|"%s sizes (%d) then expected (%d)\n"
argument_list|,
name|i
operator|>
name|nsizes
condition|?
literal|"More"
else|:
literal|"Less"
argument_list|,
name|i
argument_list|,
name|nsizes
argument_list|)
expr_stmt|;
name|chtab
operator|=
name|pstab
operator|+
name|nsizes
operator|+
literal|1
expr_stmt|;
comment|/* table of indexes in chname */
name|chname
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|chtab
operator|+
name|dev
operator|.
name|nchtab
operator|)
expr_stmt|;
comment|/* start of name table */
name|p
operator|=
name|chname
operator|+
name|dev
operator|.
name|lchname
expr_stmt|;
comment|/* beginning of first font */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfonts
condition|;
name|i
operator|++
control|)
block|{
comment|/* pickup the font names */
name|fontbase
index|[
name|i
index|]
operator|=
operator|(
expr|struct
name|Font
operator|*
operator|)
name|p
expr_stmt|;
name|nw
operator|=
operator|*
name|p
operator|&
name|BMASK
expr_stmt|;
comment|/* first thing is width count */
name|p
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|Font
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|3
operator|*
name|nw
operator|+
name|dev
operator|.
name|nchtab
operator|+
literal|128
operator|-
literal|32
expr_stmt|;
if|if
condition|(
name|fontbase
index|[
name|i
index|]
operator|->
name|fonttab
operator|==
literal|1
condition|)
name|p
operator|+=
name|nw
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"fonts %d"
argument_list|,
name|nfonts
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfonts
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|fontbase
index|[
name|i
index|]
operator|->
name|namefont
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbg
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Indexes:"
argument_list|)
expr_stmt|;
name|p1
operator|=
name|chtab
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|p1
operator|=
name|chtab
init|;
name|p1
operator|<
name|chtab
operator|+
name|dev
operator|.
name|nchtab
operator|-
literal|1
condition|;
name|p1
operator|++
control|)
block|{
name|i
operator|++
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" %d"
argument_list|,
operator|*
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|16
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"charset\n"
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|p1
operator|=
name|chtab
init|;
name|p1
operator|<
name|chtab
operator|+
name|dev
operator|.
name|nchtab
operator|-
literal|1
condition|;
name|p1
operator|++
control|)
block|{
name|int
name|i2
decl_stmt|;
name|i
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"  %s"
argument_list|,
name|chname
operator|+
operator|*
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|16
operator|||
operator|(
name|i2
operator|==
literal|0
operator|&
name|i
operator|==
literal|4
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|i2
operator|==
literal|0
condition|)
name|i2
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Dflag
condition|)
if|if
condition|(
operator|!
name|Fflag
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfonts
condition|;
name|i
operator|++
control|)
name|dumpfont
argument_list|(
name|fontbase
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fin
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * How to use the tables  *  * the fitable (font index table) contains indexes to the information about  * all the characters of a device that can be printed.  * The device is supposed to have all (128-32) printable ascii chars.  * We rely on thus idea  * There are also an unknown numer (den.nchtab -1) funny chars.  * So this make it clear why fitab is device dependent and not font dependent.   *  * For ascii characters you get your information by:  *	fitab[inputchar-32] will have the index in the tables,  *	if the index is 0, the char doesn't exist on this font  *		so f.i. codetab[fitab[inputchar-32]] will give you the  *		outputcode.  *  * For funny chars:  * 	Compare the string of the funny char with strings in nchname table  *	if the nth string are the same, you can find the index by  *	fitab[n + 128-32]  *	if the index is 0, the char doesn't exist on this font  *	and the kerning info f.i. by  *	kerntab[fitab[n + 128-32]]  *	if font.fonttab == 1  *		There will also be a font code table, this is found by  *		the same ways.  *	if n>= dev.nchtab, the funny name was illegal.  *  * Note:  *	Width[0] contains the spacesize, set by or the spacesize command  *	while constructing the font file, or the default spacesize.  *  */
end_comment

begin_macro
name|dumpfont
argument_list|(
argument|font
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|Font
modifier|*
name|font
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|nw
decl_stmt|;
name|int
name|i
decl_stmt|,
name|c
decl_stmt|;
name|char
modifier|*
name|kerntab
decl_stmt|,
modifier|*
name|fitab
decl_stmt|,
modifier|*
name|widthtab
decl_stmt|,
modifier|*
name|codetab
decl_stmt|;
name|short
modifier|*
name|fcode
decl_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|font
expr_stmt|;
name|nw
operator|=
operator|*
name|p
operator|&
name|BMASK
expr_stmt|;
name|p
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|Font
argument_list|)
expr_stmt|;
name|widthtab
operator|=
name|p
expr_stmt|;
name|p
operator|+=
name|nw
expr_stmt|;
name|kerntab
operator|=
name|p
expr_stmt|;
name|p
operator|+=
name|nw
expr_stmt|;
name|codetab
operator|=
name|p
expr_stmt|;
name|p
operator|+=
name|nw
expr_stmt|;
name|fitab
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|font
operator|->
name|fonttab
operator|==
literal|1
condition|)
block|{
comment|/* the fcode tab is here */
name|p
operator|+=
name|nchtab
operator|+
literal|128
operator|-
literal|32
expr_stmt|;
name|fcode
operator|=
operator|(
name|short
operator|*
operator|)
name|p
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"# Fontinfo for %s\n"
argument_list|,
name|devname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"name %s\n"
argument_list|,
name|font
operator|->
name|namefont
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"internalname %s\n"
argument_list|,
name|font
operator|->
name|intname
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|->
name|specfont
condition|)
name|printf
argument_list|(
literal|"special\n"
argument_list|)
expr_stmt|;
name|mklig
argument_list|(
name|font
operator|->
name|ligfont
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|->
name|fonttab
condition|)
name|printf
argument_list|(
literal|"fonttab\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|->
name|slant
condition|)
name|printf
argument_list|(
literal|"slant %d\n"
argument_list|,
name|font
operator|->
name|slant
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|widthtab
condition|)
comment|/* widthtab[0] contains the spacewidth */
name|printf
argument_list|(
literal|"spacewidth %d\n"
argument_list|,
operator|*
name|widthtab
operator|&
name|BMASK
argument_list|)
expr_stmt|;
comment|/* now print the contents of this font */
comment|/* first the ascii chars */
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|128
operator|-
literal|32
condition|;
name|c
operator|++
control|)
block|{
name|i
operator|=
name|fitab
index|[
name|c
index|]
expr_stmt|;
if|if
condition|(
name|i
condition|)
block|{
name|printf
argument_list|(
literal|"%c\t%d\t%o\t0%o"
argument_list|,
operator|(
name|c
operator|+
literal|32
operator|)
operator|&
name|BMASK
argument_list|,
name|widthtab
index|[
name|i
index|]
operator|&
name|BMASK
argument_list|,
name|kerntab
index|[
name|i
index|]
operator|&
name|BMASK
argument_list|,
name|codetab
index|[
name|i
index|]
operator|&
name|BMASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|->
name|fonttab
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|"\t%d\n"
argument_list|,
name|fcode
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* and now the special ones */
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|nchtab
condition|;
name|c
operator|++
control|)
block|{
name|i
operator|=
operator|(
name|unsigned
name|char
operator|)
name|fitab
index|[
name|c
operator|+
literal|128
operator|-
literal|32
index|]
expr_stmt|;
if|if
condition|(
name|i
condition|)
block|{
name|printf
argument_list|(
literal|"%s\t%d\t%o\t0%o"
argument_list|,
operator|&
name|chname
index|[
name|chtab
index|[
name|c
index|]
index|]
argument_list|,
name|widthtab
index|[
name|i
index|]
operator|&
name|BMASK
argument_list|,
name|kerntab
index|[
name|i
index|]
operator|&
name|BMASK
argument_list|,
name|codetab
index|[
name|i
index|]
operator|&
name|BMASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|->
name|fonttab
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|"\t%d\n"
argument_list|,
name|fcode
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|mklig
argument_list|(
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|char
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|c
condition|)
return|return;
name|printf
argument_list|(
literal|"ligatures"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|LFF
condition|)
name|printf
argument_list|(
literal|" ff"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|LFI
condition|)
name|printf
argument_list|(
literal|" fi"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|LFL
condition|)
name|printf
argument_list|(
literal|" fl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|LFFI
condition|)
name|printf
argument_list|(
literal|" ffi"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|LFFL
condition|)
name|printf
argument_list|(
literal|" ffl"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" 0\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|getfont
argument_list|(
argument|fname
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|fname
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|malloc
argument_list|()
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|int
name|fin
decl_stmt|,
name|size
decl_stmt|;
name|char
name|temp
index|[
literal|60
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|temp
argument_list|,
literal|"%s/dev%s/%s.out"
argument_list|,
name|fontdir
argument_list|,
name|devname
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fin
operator|=
name|open
argument_list|(
name|temp
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|error
argument_list|(
name|FATAL
argument_list|,
literal|"can't open %s\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"# Dump of font %s (%s)\n"
argument_list|,
name|fname
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|size
operator|=
name|lseek
argument_list|(
name|fin
argument_list|,
literal|0L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/*get size of file*/
if|if
condition|(
name|dbg
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Size of font %s: %d\n"
argument_list|,
name|temp
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|fin
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|p
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|read
argument_list|(
name|fin
argument_list|,
name|p
argument_list|,
name|size
argument_list|)
operator|)
operator|!=
name|size
condition|)
name|error
argument_list|(
name|FATAL
argument_list|,
literal|"read error at %s\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|dumpfont
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fin
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* gprint.c-  *  * Copyright -C- 1982 Barry S. Roitblat  *  *	This file contains the main and file system dependent routines  * for producing hard copy from gremlin files.  It is extensively modified  * from the vplot source.  */
end_comment

begin_include
include|#
directive|include
file|"gprint.h"
end_include

begin_include
include|#
directive|include
file|"grem2.h"
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<vfont.h>
end_include

begin_define
define|#
directive|define
name|LPR
value|"/usr/ucb/lpr"
end_define

begin_define
define|#
directive|define
name|VAX
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|VAX
end_ifdef

begin_define
define|#
directive|define
name|NB
value|1024
end_define

begin_comment
comment|/* Number of blocks in virtual memory */
end_comment

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|NB
value|88
end_define

begin_comment
comment|/* Number of blocks kept in memory */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|BSIZ
value|512
end_define

begin_comment
comment|/* Size of blocks */
end_comment

begin_define
define|#
directive|define
name|LOGBSIZ
value|9
end_define

begin_comment
comment|/* log base 2 of BSIZ */
end_comment

begin_function_decl
specifier|extern
name|char
modifier|*
name|mktemp
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|rindex
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* imports */
end_comment

begin_extern
extern|extern HGtline(
end_extern

begin_operator
unit|)
operator|,
end_operator

begin_expr_stmt
name|HGArc
argument_list|()
operator|,
name|HGPutText
argument_list|()
operator|,
name|HGMove
argument_list|()
operator|,
name|HGSetFont
argument_list|()
expr_stmt|;
end_expr_stmt

begin_extern
extern|extern HGSetBrush(
end_extern

begin_operator
unit|)
operator|,
end_operator

begin_expr_stmt
name|HGInitFont
argument_list|()
operator|,
name|HGPrintElt
argument_list|()
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|extern
name|int
name|style
index|[]
decl_stmt|,
name|thick
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|tfont
index|[]
decl_stmt|,
modifier|*
name|tsize
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* database imports */
end_comment

begin_decl_stmt
specifier|extern
name|ELT
modifier|*
name|DBInit
argument_list|()
decl_stmt|,
modifier|*
name|DBRead
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|POINT
modifier|*
name|PTInit
argument_list|()
decl_stmt|,
modifier|*
name|PTMakePoint
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|linethickness
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* brush styles */
end_comment

begin_decl_stmt
name|int
name|linmod
init|=
name|SOLID
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|chrtab
index|[]
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|blocks
index|[
name|NB
index|]
index|[
name|BSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lastx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lasty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|angle
decl_stmt|,
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|endx
decl_stmt|,
name|endy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|scale
init|=
literal|4.0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Variables used to map gremlin screen */
end_comment

begin_decl_stmt
name|double
name|topx
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* coordinates into output device coordinates */
end_comment

begin_decl_stmt
name|double
name|topy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|botx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|boty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|centx
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|centy
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|delx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|dely
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|del
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|VAX
end_ifdef

begin_decl_stmt
name|char
name|dirty
index|[
name|NB
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* marks if a block has been written into */
end_comment

begin_else
else|#
directive|else
end_else

begin_struct
struct|struct
name|buf
block|{
name|int
name|bno
decl_stmt|;
name|char
modifier|*
name|block
decl_stmt|;
block|}
name|bufs
index|[
name|NB
index|]
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|fd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of current picture */
end_comment

begin_decl_stmt
name|char
name|picture
index|[]
init|=
literal|"/usr/tmp/rastAXXXXXX"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|run
init|=
literal|13
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* index of 'a' in picture[] */
end_comment

begin_decl_stmt
name|int
name|DevRange
init|=
literal|1536
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Bits per line for output device */
end_comment

begin_decl_stmt
name|int
name|BytesPerLine
init|=
literal|264
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Bytes per raster line (different from range 				   due to non-square paper). */
end_comment

begin_decl_stmt
name|char
name|device
init|=
literal|'V'
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default device */
end_comment

begin_decl_stmt
name|int
name|lparg
init|=
literal|6
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* index into lpargs */
end_comment

begin_decl_stmt
name|char
modifier|*
name|lpargs
index|[
literal|50
index|]
init|=
block|{
literal|"lpr"
block|,
literal|"-Pvarian"
block|,
literal|"-v"
block|,
literal|"-s"
block|,
literal|"-r"
block|,
literal|"-J"
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* variables used to print from font file */
end_comment

begin_decl_stmt
name|int
name|Orientation
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cfont
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|csize
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|header
name|header
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|dispatch
name|dispatch
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|bits
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fontdir
init|=
literal|"/usr/lib/vfont/"
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|FILE
modifier|*
name|fp
decl_stmt|,
modifier|*
name|fopen
argument_list|()
decl_stmt|;
name|ELT
modifier|*
name|PICTURE
decl_stmt|,
modifier|*
name|e
decl_stmt|;
name|POINT
modifier|*
name|p1
decl_stmt|,
name|pos
decl_stmt|;
name|char
modifier|*
name|file
index|[
literal|50
index|]
decl_stmt|,
name|string
index|[
literal|10
index|]
decl_stmt|,
modifier|*
name|arg
decl_stmt|;
name|char
name|c
decl_stmt|,
name|string1
index|[
literal|50
index|]
decl_stmt|,
name|string2
index|[
literal|50
index|]
decl_stmt|,
name|string3
index|[
literal|50
index|]
decl_stmt|,
name|string4
index|[
literal|50
index|]
decl_stmt|,
name|string5
index|[
literal|50
index|]
decl_stmt|,
name|string6
index|[
literal|50
index|]
decl_stmt|,
name|string7
index|[
literal|50
index|]
decl_stmt|,
name|string8
index|[
literal|50
index|]
decl_stmt|;
specifier|extern
name|int
name|cleanup
parameter_list|()
function_decl|;
name|float
name|mult
decl_stmt|;
name|int
name|WriteRaster
init|=
name|FALSE
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|int
name|brsh
decl_stmt|,
name|gfil
init|=
literal|0
decl_stmt|;
comment|/* Parse the command line. */
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|--
condition|)
block|{
if|if
condition|(
operator|*
operator|(
name|arg
operator|=
operator|*
name|argv
operator|++
operator|)
operator|!=
literal|'-'
condition|)
name|file
index|[
name|gfil
operator|++
index|]
operator|=
name|arg
expr_stmt|;
else|else
switch|switch
condition|(
operator|*
operator|++
name|arg
condition|)
block|{
case|case
literal|'W'
case|:
comment|/* Print to wide (versatec) device */
name|device
operator|=
literal|'W'
expr_stmt|;
name|DevRange
operator|=
literal|2047
expr_stmt|;
name|BytesPerLine
operator|=
literal|880
expr_stmt|;
name|lpargs
index|[
literal|1
index|]
operator|=
literal|"-Pversatec"
expr_stmt|;
break|break;
case|case
literal|'V'
case|:
comment|/* Print to narrow (varian) device */
name|device
operator|=
literal|'V'
expr_stmt|;
name|DevRange
operator|=
literal|1536
expr_stmt|;
name|BytesPerLine
operator|=
literal|264
expr_stmt|;
name|lpargs
index|[
literal|1
index|]
operator|=
literal|"-Pvarian"
expr_stmt|;
break|break;
case|case
literal|'1'
case|:
comment|/* select size 1 */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|tsize
index|[
literal|0
index|]
operator|=
name|arg
expr_stmt|;
break|break;
case|case
literal|'2'
case|:
comment|/* select size 2 */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|tsize
index|[
literal|1
index|]
operator|=
name|arg
expr_stmt|;
break|break;
case|case
literal|'3'
case|:
comment|/* select size 3 */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|tsize
index|[
literal|2
index|]
operator|=
name|arg
expr_stmt|;
break|break;
case|case
literal|'4'
case|:
comment|/* select size 4 */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|tsize
index|[
literal|3
index|]
operator|=
name|arg
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
comment|/* select Roman font */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|tfont
index|[
literal|0
index|]
operator|=
name|arg
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
comment|/* select italics font */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|tfont
index|[
literal|1
index|]
operator|=
name|arg
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* select bold font */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|tfont
index|[
literal|2
index|]
operator|=
name|arg
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* select special font */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|tfont
index|[
literal|3
index|]
operator|=
name|arg
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
comment|/* select narrow brush width */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|sscanf
argument_list|(
name|arg
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|brsh
argument_list|)
expr_stmt|;
name|thick
index|[
literal|0
index|]
operator|=
name|thick
index|[
literal|1
index|]
operator|=
name|thick
index|[
literal|3
index|]
operator|=
name|thick
index|[
literal|4
index|]
operator|=
name|brsh
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
comment|/* select thick brush width */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|sscanf
argument_list|(
name|arg
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|brsh
argument_list|)
expr_stmt|;
name|thick
index|[
literal|2
index|]
operator|=
name|brsh
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
comment|/* select medium brush width */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|sscanf
argument_list|(
name|arg
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|brsh
argument_list|)
expr_stmt|;
name|thick
index|[
literal|5
index|]
operator|=
name|brsh
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
comment|/* send raster to standard output */
name|WriteRaster
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
comment|/* select scale */
if|if
condition|(
operator|*
operator|++
name|arg
operator|==
literal|'\0'
operator|&&
name|argc
operator|--
condition|)
name|arg
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|sscanf
argument_list|(
name|arg
argument_list|,
literal|"%f"
argument_list|,
operator|&
name|mult
argument_list|)
expr_stmt|;
name|scale
operator|*=
name|mult
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* prompt for font and size parameters */
name|printf
argument_list|(
literal|"Roman font name? (%s): "
argument_list|,
name|tfont
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string1
operator|!=
literal|'\0'
condition|)
name|tfont
index|[
literal|0
index|]
operator|=
name|string1
expr_stmt|;
name|printf
argument_list|(
literal|"Italic font name? (%s): "
argument_list|,
name|tfont
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string2
operator|!=
literal|'\0'
condition|)
name|tfont
index|[
literal|1
index|]
operator|=
name|string2
expr_stmt|;
name|printf
argument_list|(
literal|"Bold font name? (%s): "
argument_list|,
name|tfont
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string3
operator|!=
literal|'\0'
condition|)
name|tfont
index|[
literal|2
index|]
operator|=
name|string3
expr_stmt|;
name|printf
argument_list|(
literal|"Special font name? (%s): "
argument_list|,
name|tfont
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string4
operator|!=
literal|'\0'
condition|)
name|tfont
index|[
literal|3
index|]
operator|=
name|string4
expr_stmt|;
name|printf
argument_list|(
literal|"font size 1? (%s): "
argument_list|,
name|tsize
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string5
operator|!=
literal|'\0'
condition|)
name|tsize
index|[
literal|0
index|]
operator|=
name|string5
expr_stmt|;
name|printf
argument_list|(
literal|"font size 2? (%s): "
argument_list|,
name|tsize
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string6
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string6
operator|!=
literal|'\0'
condition|)
name|tsize
index|[
literal|1
index|]
operator|=
name|string6
expr_stmt|;
name|printf
argument_list|(
literal|"font size 3? (%s): "
argument_list|,
name|tsize
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string7
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string7
operator|!=
literal|'\0'
condition|)
name|tsize
index|[
literal|2
index|]
operator|=
name|string7
expr_stmt|;
name|printf
argument_list|(
literal|"font size 4? (%s): "
argument_list|,
name|tsize
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string8
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string8
operator|!=
literal|'\0'
condition|)
name|tsize
index|[
literal|3
index|]
operator|=
name|string8
expr_stmt|;
name|printf
argument_list|(
literal|"narrow brush size? (%d): "
argument_list|,
name|thick
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string
operator|!=
literal|'\0'
condition|)
block|{
name|sscanf
argument_list|(
name|string
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|brsh
argument_list|)
expr_stmt|;
name|thick
index|[
literal|0
index|]
operator|=
name|thick
index|[
literal|1
index|]
operator|=
name|thick
index|[
literal|3
index|]
operator|=
name|thick
index|[
literal|4
index|]
operator|=
name|brsh
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"medium brush size? (%d): "
argument_list|,
name|thick
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string
operator|!=
literal|'\0'
condition|)
block|{
name|sscanf
argument_list|(
name|string
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|brsh
argument_list|)
expr_stmt|;
name|thick
index|[
literal|5
index|]
operator|=
name|brsh
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"thick brush size? (%d): "
argument_list|,
name|thick
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|string
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|string
operator|!=
literal|'\0'
condition|)
block|{
name|sscanf
argument_list|(
name|string
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|brsh
argument_list|)
expr_stmt|;
name|thick
index|[
literal|2
index|]
operator|=
name|brsh
expr_stmt|;
block|}
break|break;
default|default:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"unknown switch: %c"
argument_list|,
operator|*
name|arg
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* init constants for scaling */
name|topx
operator|=
name|topy
operator|=
name|DevRange
expr_stmt|;
name|botx
operator|=
name|boty
operator|=
literal|0
expr_stmt|;
name|delx
operator|=
name|dely
operator|=
name|del
operator|=
name|DevRange
expr_stmt|;
name|centx
operator|=
operator|(
name|DevRange
operator|-
name|mapx
argument_list|(
name|topx
operator|/
name|scale
argument_list|)
operator|)
operator|/
literal|2
expr_stmt|;
name|centy
operator|=
name|mapy
argument_list|(
name|topy
operator|/
name|scale
argument_list|)
operator|/
literal|2
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|cleanup
argument_list|)
expr_stmt|;
if|if
condition|(
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
operator|!=
name|SIG_IGN
condition|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|cleanup
argument_list|)
expr_stmt|;
name|mktemp
argument_list|(
name|picture
argument_list|)
expr_stmt|;
if|if
condition|(
name|gfil
operator|==
literal|0
condition|)
block|{
comment|/* no filename, use standard input */
name|file
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|gfil
operator|++
expr_stmt|;
block|}
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|gfil
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
name|file
index|[
name|k
index|]
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|file
index|[
name|k
index|]
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"gprint: can't open %s"
argument_list|,
name|file
index|[
name|k
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|k
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|arg
operator|=
name|rindex
argument_list|(
name|file
index|[
name|k
index|]
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|arg
operator|=
name|file
index|[
name|k
index|]
expr_stmt|;
else|else
name|arg
operator|++
expr_stmt|;
name|lpargs
index|[
name|lparg
operator|++
index|]
operator|=
name|arg
expr_stmt|;
block|}
block|}
else|else
block|{
name|fp
operator|=
name|stdin
expr_stmt|;
name|lpargs
index|[
name|lparg
operator|++
index|]
operator|=
literal|"gremlin"
expr_stmt|;
block|}
comment|/* read picture file */
name|PICTURE
operator|=
name|DBRead
argument_list|(
name|fp
argument_list|,
operator|&
name|Orientation
argument_list|,
operator|&
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|DBNullelt
argument_list|(
name|PICTURE
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|fd
operator|=
name|creat
argument_list|(
name|picture
argument_list|,
literal|0666
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"gprint: can't create %s\n"
argument_list|,
name|picture
argument_list|)
expr_stmt|;
name|cleanup
argument_list|()
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|VAX
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|picture
argument_list|,
literal|2
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"gprint: can't reopen %s\n"
argument_list|,
name|picture
argument_list|)
expr_stmt|;
name|cleanup
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
name|i
operator|=
name|strlen
argument_list|(
name|picture
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|arg
operator|=
name|malloc
argument_list|(
name|i
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"gprint: ran out of memory\n"
argument_list|)
expr_stmt|;
name|cleanup
argument_list|()
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|arg
argument_list|,
name|picture
argument_list|)
expr_stmt|;
name|lpargs
index|[
name|lparg
operator|++
index|]
operator|=
name|arg
expr_stmt|;
name|picture
index|[
name|run
index|]
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NB
condition|;
name|i
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|VAX
name|dirty
index|[
name|i
index|]
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|BSIZ
condition|;
operator|++
name|j
control|)
name|blocks
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|bufs
index|[
name|i
index|]
operator|.
name|bno
operator|=
operator|-
literal|1
expr_stmt|;
name|bufs
index|[
name|i
index|]
operator|.
name|block
operator|=
name|blocks
index|[
name|i
index|]
expr_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|NOHOLES
comment|/* clear the entire file */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BSIZ
condition|;
name|i
operator|++
control|)
name|blocks
index|[
literal|0
index|]
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1024
condition|;
name|i
operator|++
control|)
name|write
argument_list|(
name|fd
argument_list|,
name|blocks
index|[
literal|0
index|]
argument_list|,
name|BSIZ
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|e
operator|=
name|PICTURE
expr_stmt|;
while|while
condition|(
operator|!
name|DBNullelt
argument_list|(
name|e
argument_list|)
condition|)
block|{
name|HGPrintElt
argument_list|(
name|e
argument_list|)
expr_stmt|;
comment|/* traverse picture, printing elements */
name|e
operator|=
name|DBNextElt
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NB
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|WriteRaster
condition|)
block|{
name|fwrite
argument_list|(
name|blocks
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|BSIZ
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|VAX
if|if
condition|(
name|dirty
index|[
name|i
index|]
condition|)
block|{
comment|/* write out non-zero blocks */
name|zseek
argument_list|(
name|fd
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|fd
argument_list|,
name|blocks
index|[
name|i
index|]
argument_list|,
name|BSIZ
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|bufs
index|[
name|i
index|]
operator|.
name|bno
operator|!=
operator|-
literal|1
condition|)
block|{
name|zseek
argument_list|(
name|fd
argument_list|,
name|bufs
index|[
name|i
index|]
operator|.
name|bno
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|fd
argument_list|,
name|bufs
index|[
name|i
index|]
operator|.
name|blocks
index|[
name|i
index|]
argument_list|,
name|BSIZ
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|WriteRaster
condition|)
block|{
name|lpargs
index|[
name|lparg
index|]
operator|=
literal|0
expr_stmt|;
name|execv
argument_list|(
name|LPR
argument_list|,
name|lpargs
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"gprint: can't exec %s\n"
argument_list|,
name|LPR
argument_list|)
expr_stmt|;
name|cleanup
argument_list|()
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|VAX
end_ifndef

begin_expr_stmt
name|getblk
argument_list|(
name|b
argument_list|)
specifier|register
name|b
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|buf
modifier|*
name|bp1
decl_stmt|;
specifier|register
name|char
modifier|*
name|tp
decl_stmt|;
if|if
condition|(
name|b
operator|<
literal|0
operator|||
name|b
operator|>=
name|NB
condition|)
block|{
comment|/* bad block number */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"gprint: internal error, b out of range in getblk\n"
argument_list|)
expr_stmt|;
name|cleanup
argument_list|()
expr_stmt|;
block|}
name|loop
label|:
for|for
control|(
name|bp1
operator|=
name|bufs
init|;
name|bp1
operator|<
operator|&
name|bufs
index|[
name|NB
index|]
condition|;
name|bp1
operator|++
control|)
block|{
if|if
condition|(
name|bp1
operator|->
name|bno
operator|==
name|b
operator|||
name|bp1
operator|->
name|bno
operator|==
operator|-
literal|1
condition|)
block|{
name|tp
operator|=
name|bp1
operator|->
name|block
expr_stmt|;
while|while
condition|(
name|bp1
operator|>
name|bufs
condition|)
block|{
name|bp1
operator|->
name|bno
operator|=
operator|(
name|bp1
operator|-
literal|1
operator|)
operator|->
name|bno
expr_stmt|;
name|bp1
operator|->
name|block
operator|=
operator|(
name|bp1
operator|-
literal|1
operator|)
operator|->
name|block
expr_stmt|;
name|bp1
operator|--
expr_stmt|;
block|}
name|bp1
operator|->
name|bno
operator|=
name|b
expr_stmt|;
name|bp1
operator|->
name|block
operator|=
name|tp
expr_stmt|;
return|return;
block|}
block|}
name|zseek
argument_list|(
name|fd
argument_list|,
name|bufs
index|[
name|NB
operator|-
literal|1
index|]
operator|.
name|bno
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|fd
argument_list|,
name|bufs
index|[
name|NB
operator|-
literal|1
index|]
operator|.
name|block
argument_list|,
name|BSIZ
argument_list|)
expr_stmt|;
name|zseek
argument_list|(
name|fd
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|fd
argument_list|,
name|bufs
index|[
name|NB
operator|-
literal|1
index|]
operator|.
name|block
argument_list|,
name|BSIZ
argument_list|)
expr_stmt|;
name|bufs
index|[
name|NB
operator|-
literal|1
index|]
operator|.
name|bno
operator|=
name|b
expr_stmt|;
goto|goto
name|loop
goto|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_macro
name|cleanup
argument_list|()
end_macro

begin_block
block|{
while|while
condition|(
name|picture
index|[
name|run
index|]
operator|!=
literal|'a'
condition|)
block|{
name|unlink
argument_list|(
name|picture
argument_list|)
expr_stmt|;
name|picture
index|[
name|run
index|]
operator|--
expr_stmt|;
block|}
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Points should be in the range 0<= x (or y)<= DevRange.  * The origin is the top left-hand corner with increasing x towards the  * right and increasing y going down.  */
end_comment

begin_expr_stmt
name|point
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
specifier|register
name|int
name|x
operator|,
name|y
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|unsigned
name|bno
decl_stmt|,
name|byte
decl_stmt|;
name|byte
operator|=
name|y
operator|*
name|BytesPerLine
operator|+
operator|(
name|x
operator|>>
literal|3
operator|)
expr_stmt|;
name|bno
operator|=
name|byte
operator|>>
name|LOGBSIZ
expr_stmt|;
name|byte
operator|&=
name|BSIZ
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|bno
operator|>=
literal|1024
condition|)
return|return;
ifndef|#
directive|ifndef
name|VAX
if|if
condition|(
name|bno
operator|!=
name|bufs
index|[
literal|0
index|]
operator|.
name|bno
condition|)
name|getblk
argument_list|(
name|bno
argument_list|)
expr_stmt|;
name|bufs
index|[
literal|0
index|]
operator|.
name|block
index|[
name|byte
index|]
operator||=
literal|1
operator|<<
operator|(
literal|7
operator|-
operator|(
name|x
operator|&
literal|07
operator|)
operator|)
expr_stmt|;
else|#
directive|else
name|blocks
index|[
name|bno
index|]
index|[
name|byte
index|]
operator||=
literal|1
operator|<<
operator|(
literal|7
operator|-
operator|(
name|x
operator|&
literal|07
operator|)
operator|)
expr_stmt|;
name|dirty
index|[
name|bno
index|]
operator|=
name|TRUE
expr_stmt|;
endif|#
directive|endif
block|}
end_block

begin_macro
name|zseek
argument_list|(
argument|a
argument_list|,
argument|b
argument_list|)
end_macro

begin_block
block|{
return|return
operator|(
name|lseek
argument_list|(
name|a
argument_list|,
operator|(
name|long
operator|)
name|b
operator|*
name|BSIZ
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_block

end_unit


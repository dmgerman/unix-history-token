begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"../hdr/defines.h"
end_include

begin_include
include|#
directive|include
file|"../hdr/had.h"
end_include

begin_expr_stmt
name|SCCSID
argument_list|(
argument|@
operator|(
operator|#
operator|)
name|delta
operator|.
name|c
literal|4.6
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|USXALLOC
argument_list|()
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|LOGDELTA
end_ifdef

begin_decl_stmt
name|char
name|LogFile
index|[]
init|=
literal|"/usr/adm/sccs-log"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|Logf
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|char
name|Diffpgm
index|[]
init|=
literal|"/usr/local/bdiff"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|Diffin
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|int
name|Debug
literal|0
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|packet
name|gpkt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sid
name|sid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|num_files
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|had
index|[
literal|26
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|ilist
decl_stmt|,
modifier|*
name|elist
decl_stmt|,
modifier|*
name|glist
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Comments
decl_stmt|,
modifier|*
name|Mrs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Domrs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|verbosity
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Did_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|Szqfile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Pfilename
index|[
name|FILESIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|Xiop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Xcreate
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
specifier|register
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|char
name|c
decl_stmt|;
name|int
name|testmore
decl_stmt|;
extern|extern delta(
block|)
function|;
end_function

begin_decl_stmt
specifier|extern
name|int
name|Fcnt
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|Fflags
operator|=
name|FTLEXIT
operator||
name|FTLMSG
operator||
name|FTLCLN
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
operator|&&
operator|(
name|c
operator|=
name|argv
index|[
name|i
index|]
index|[
literal|1
index|]
operator|)
condition|)
block|{
name|p
operator|=
operator|&
name|argv
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|testmore
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'r'
case|:
if|if
condition|(
operator|!
name|p
index|[
literal|0
index|]
condition|)
block|{
name|argv
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
name|chksid
argument_list|(
name|sid_ab
argument_list|(
name|p
argument_list|,
operator|&
name|sid
argument_list|)
argument_list|,
operator|&
name|sid
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|glist
operator|=
name|p
expr_stmt|;
break|break;
case|case
literal|'y'
case|:
name|Comments
operator|=
name|p
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|Mrs
operator|=
name|p
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
case|case
literal|'n'
case|:
case|case
literal|'s'
case|:
name|testmore
operator|++
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|"unknown key letter (cm1)"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|testmore
condition|)
block|{
name|testmore
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|p
condition|)
name|fatal
argument_list|(
name|sprintf
argument_list|(
name|Error
argument_list|,
literal|"value after %c arg (cm7)"
argument_list|,
name|c
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|had
index|[
name|c
operator|-
literal|'a'
index|]
operator|++
condition|)
name|fatal
argument_list|(
literal|"key letter twice (cm2)"
argument_list|)
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|num_files
operator|++
expr_stmt|;
end_for

begin_if
if|if
condition|(
name|num_files
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"missing file arg (cm3)"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|!
name|HADS
condition|)
name|verbosity
operator|=
operator|-
literal|1
expr_stmt|;
end_if

begin_ifdef
ifdef|#
directive|ifdef
name|LOGDELTA
end_ifdef

begin_expr_stmt
name|Logf
operator|=
name|fopen
argument_list|(
name|LogFile
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|setsig
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|Fflags
operator|=
operator|&
operator|~
name|FTLEXIT
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|Fflags
operator|=
operator||
name|FTLJMP
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p
operator|=
name|argv
index|[
name|i
index|]
condition|)
name|do_file
argument_list|(
name|p
argument_list|,
name|delta
argument_list|)
expr_stmt|;
end_for

begin_ifdef
ifdef|#
directive|ifdef
name|LOGDELTA
end_ifdef

begin_if
if|if
condition|(
name|Logf
operator|!=
name|NULL
condition|)
name|fclose
argument_list|(
name|Logf
argument_list|)
expr_stmt|;
end_if

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|exit
argument_list|(
name|Fcnt
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}   delta
operator|(
name|file
operator|)
name|char
operator|*
name|file
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|static
name|int
name|first
literal|1
expr_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|n
decl_stmt|,
name|linenum
decl_stmt|;
name|char
name|type
decl_stmt|;
specifier|register
name|int
name|ser
decl_stmt|;
specifier|extern
name|char
name|had_dir
decl_stmt|,
name|had_standinp
decl_stmt|;
specifier|extern
name|char
modifier|*
name|Sflags
index|[]
decl_stmt|;
name|char
name|dfilename
index|[
name|FILESIZE
index|]
decl_stmt|;
name|char
name|gfilename
index|[
name|FILESIZE
index|]
decl_stmt|;
name|char
name|line
index|[
literal|512
index|]
decl_stmt|;
name|FILE
modifier|*
name|gin
decl_stmt|;
name|struct
name|stats
name|stats
decl_stmt|;
name|struct
name|pfile
modifier|*
name|pp
decl_stmt|;
name|int
name|inserted
decl_stmt|,
name|deleted
decl_stmt|,
name|orig
decl_stmt|;
name|int
name|newser
decl_stmt|;
name|int
name|status
decl_stmt|;
name|int
name|diffloop
decl_stmt|;
name|int
name|difflim
decl_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|Fjmp
argument_list|)
condition|)
return|return;
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
literal|0
expr_stmt|;
name|dohist
argument_list|(
name|file
argument_list|)
expr_stmt|;
block|}
name|sinit
argument_list|(
operator|&
name|gpkt
argument_list|,
name|file
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|lockit
argument_list|(
name|auxf
argument_list|(
name|gpkt
operator|.
name|p_file
argument_list|,
literal|'z'
argument_list|)
argument_list|,
literal|2
argument_list|,
name|getpid
argument_list|()
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"cannot create lock file (cm4)"
argument_list|)
expr_stmt|;
name|gpkt
operator|.
name|p_reopen
operator|=
literal|1
expr_stmt|;
name|gpkt
operator|.
name|p_stdout
operator|=
name|stdout
expr_stmt|;
name|copy
argument_list|(
name|auxf
argument_list|(
name|gpkt
operator|.
name|p_file
argument_list|,
literal|'g'
argument_list|)
argument_list|,
name|gfilename
argument_list|)
expr_stmt|;
name|gin
operator|=
name|xfopen
argument_list|(
name|gfilename
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pp
operator|=
name|rdpfile
argument_list|(
operator|&
name|gpkt
argument_list|,
operator|&
name|sid
argument_list|)
expr_stmt|;
name|gpkt
operator|.
name|p_cutoff
operator|=
name|pp
operator|->
name|pf_date
expr_stmt|;
name|ilist
operator|=
name|pp
operator|->
name|pf_ilist
expr_stmt|;
name|elist
operator|=
name|pp
operator|->
name|pf_elist
expr_stmt|;
if|if
condition|(
name|dodelt
argument_list|(
operator|&
name|gpkt
argument_list|,
operator|&
name|stats
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
name|fmterr
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ser
operator|=
name|sidtoser
argument_list|(
operator|&
name|pp
operator|->
name|pf_gsid
argument_list|,
operator|&
name|gpkt
argument_list|)
operator|)
operator|==
literal|0
operator|||
name|sidtoser
argument_list|(
operator|&
name|pp
operator|->
name|pf_nsid
argument_list|,
operator|&
name|gpkt
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"invalid sid in p-file (de3)"
argument_list|)
expr_stmt|;
name|doie
argument_list|(
operator|&
name|gpkt
argument_list|,
name|ilist
argument_list|,
name|elist
argument_list|,
name|glist
argument_list|)
expr_stmt|;
name|setup
argument_list|(
operator|&
name|gpkt
argument_list|,
name|ser
argument_list|)
expr_stmt|;
name|finduser
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
name|doflags
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
name|move
argument_list|(
operator|&
name|pp
operator|->
name|pf_nsid
argument_list|,
operator|&
name|gpkt
operator|.
name|p_reqsid
argument_list|,
sizeof|sizeof
argument_list|(
name|gpkt
operator|.
name|p_reqsid
argument_list|)
argument_list|)
expr_stmt|;
name|permiss
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
name|flushto
argument_list|(
operator|&
name|gpkt
argument_list|,
name|EUSERTXT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gpkt
operator|.
name|p_chkeof
operator|=
literal|1
expr_stmt|;
name|copy
argument_list|(
name|auxf
argument_list|(
name|gpkt
operator|.
name|p_file
argument_list|,
literal|'d'
argument_list|)
argument_list|,
name|dfilename
argument_list|)
expr_stmt|;
name|gpkt
operator|.
name|p_gout
operator|=
name|xfcreat
argument_list|(
name|dfilename
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
while|while
condition|(
name|readmod
argument_list|(
operator|&
name|gpkt
argument_list|)
condition|)
block|{
name|chkid
argument_list|(
name|gpkt
operator|.
name|p_line
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|gpkt
operator|.
name|p_line
argument_list|,
name|gpkt
operator|.
name|p_gout
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|gpkt
operator|.
name|p_gout
argument_list|)
expr_stmt|;
name|orig
operator|=
name|gpkt
operator|.
name|p_glnno
expr_stmt|;
name|gpkt
operator|.
name|p_glnno
operator|=
literal|0
expr_stmt|;
name|gpkt
operator|.
name|p_verbose
operator|=
name|verbosity
expr_stmt|;
name|Did_id
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|gin
argument_list|)
operator|!=
name|NULL
operator|&&
operator|!
name|chkid
argument_list|(
name|line
argument_list|)
condition|)
empty_stmt|;
name|fclose
argument_list|(
name|gin
argument_list|)
expr_stmt|;
if|if
condition|(
name|gpkt
operator|.
name|p_verbose
operator|&&
operator|(
name|num_files
operator|>
literal|1
operator|||
name|had_dir
operator|||
name|had_standinp
operator|)
condition|)
name|fprintf
argument_list|(
name|gpkt
operator|.
name|p_stdout
argument_list|,
literal|"\n%s:\n"
argument_list|,
name|gpkt
operator|.
name|p_file
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Did_id
condition|)
if|if
condition|(
name|Sflags
index|[
name|IDFLAG
operator|-
literal|'a'
index|]
condition|)
name|fatal
argument_list|(
literal|"no id keywords (cm6)"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|gpkt
operator|.
name|p_verbose
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No id keywords (cm7)\n"
argument_list|)
expr_stmt|;
comment|/* 	The following while loop executes 'bdiff' on g-file and 	d-file. If 'bdiff' fails (usually because segmentation 	limit it is using is too large for 'diff'), it is 	invoked again, with a lower segmentation limit. 	*/
name|difflim
operator|=
literal|3500
expr_stmt|;
name|diffloop
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|inserted
operator|=
name|deleted
operator|=
literal|0
expr_stmt|;
name|gpkt
operator|.
name|p_glnno
operator|=
literal|0
expr_stmt|;
name|gpkt
operator|.
name|p_upd
operator|=
literal|1
expr_stmt|;
name|gpkt
operator|.
name|p_wrttn
operator|=
literal|1
expr_stmt|;
name|getline
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
name|gpkt
operator|.
name|p_wrttn
operator|=
literal|1
expr_stmt|;
name|newser
operator|=
name|mkdelt
argument_list|(
operator|&
name|gpkt
argument_list|,
operator|&
name|pp
operator|->
name|pf_nsid
argument_list|,
operator|&
name|pp
operator|->
name|pf_gsid
argument_list|,
name|diffloop
argument_list|,
name|orig
argument_list|)
expr_stmt|;
name|diffloop
operator|=
literal|1
expr_stmt|;
name|flushto
argument_list|(
operator|&
name|gpkt
argument_list|,
name|EUSERTXT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Diffin
operator|=
name|dodiff
argument_list|(
name|auxf
argument_list|(
name|gpkt
operator|.
name|p_file
argument_list|,
literal|'g'
argument_list|)
argument_list|,
name|dfilename
argument_list|,
name|difflim
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|=
name|getdiff
argument_list|(
operator|&
name|type
argument_list|,
operator|&
name|linenum
argument_list|)
condition|)
block|{
if|if
condition|(
name|type
operator|==
name|INS
condition|)
block|{
name|inserted
operator|=
operator|+
name|n
expr_stmt|;
name|insert
argument_list|(
operator|&
name|gpkt
argument_list|,
name|linenum
argument_list|,
name|n
argument_list|,
name|newser
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|deleted
operator|=
operator|+
name|n
expr_stmt|;
name|delete
argument_list|(
operator|&
name|gpkt
argument_list|,
name|linenum
argument_list|,
name|n
argument_list|,
name|newser
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|Diffin
argument_list|)
expr_stmt|;
if|if
condition|(
name|gpkt
operator|.
name|p_iop
condition|)
while|while
condition|(
name|readmod
argument_list|(
operator|&
name|gpkt
argument_list|)
condition|)
empty_stmt|;
name|wait
argument_list|(
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
comment|/* diff failed */
comment|/* 			Check top byte (exit code of child). 			*/
if|if
condition|(
operator|(
operator|(
name|status
operator|>>
literal|8
operator|)
operator|&
literal|0377
operator|)
operator|==
literal|32
condition|)
comment|/* 'execl' failed */
name|fatal
argument_list|(
name|sprintf
argument_list|(
name|Error
argument_list|,
literal|"cannot execute '%s' (de12)"
argument_list|,
name|Diffpgm
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 			Re-try. 			*/
if|if
condition|(
name|difflim
operator|=
operator|-
literal|500
condition|)
block|{
comment|/* reduce segmentation */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"'%s' failed, re-trying, segmentation = %d (de13)\n"
argument_list|,
name|Diffpgm
argument_list|,
name|difflim
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|Xiop
argument_list|)
expr_stmt|;
comment|/* set up */
name|Xiop
operator|=
literal|0
expr_stmt|;
comment|/* for new x-file */
name|Xcreate
operator|=
literal|0
expr_stmt|;
comment|/* 				Re-open s-file. 				*/
name|gpkt
operator|.
name|p_iop
operator|=
name|xfopen
argument_list|(
name|gpkt
operator|.
name|p_file
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|setbuf
argument_list|(
name|gpkt
operator|.
name|p_iop
argument_list|,
name|gpkt
operator|.
name|p_buf
argument_list|)
expr_stmt|;
comment|/* 				Reset counters. 				*/
name|gpkt
operator|.
name|p_slnno
operator|=
literal|0
expr_stmt|;
name|gpkt
operator|.
name|p_ihash
operator|=
literal|0
expr_stmt|;
name|gpkt
operator|.
name|p_chash
operator|=
literal|0
expr_stmt|;
name|gpkt
operator|.
name|p_nhash
operator|=
literal|0
expr_stmt|;
name|gpkt
operator|.
name|p_keep
operator|=
literal|0
expr_stmt|;
block|}
else|else
comment|/* tried up to 500 lines, can't go on */
name|fatal
argument_list|(
literal|"diff failed (de4)"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no need to try again, worked */
break|break;
comment|/* exit while loop */
block|}
block|}
name|unlink
argument_list|(
name|dfilename
argument_list|)
expr_stmt|;
name|stats
operator|.
name|s_ins
operator|=
name|inserted
expr_stmt|;
name|stats
operator|.
name|s_del
operator|=
name|deleted
expr_stmt|;
name|stats
operator|.
name|s_unc
operator|=
name|orig
operator|-
name|deleted
expr_stmt|;
if|if
condition|(
name|gpkt
operator|.
name|p_verbose
condition|)
block|{
name|fprintf
argument_list|(
name|gpkt
operator|.
name|p_stdout
argument_list|,
literal|"%u inserted\n"
argument_list|,
name|stats
operator|.
name|s_ins
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|gpkt
operator|.
name|p_stdout
argument_list|,
literal|"%u deleted\n"
argument_list|,
name|stats
operator|.
name|s_del
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|gpkt
operator|.
name|p_stdout
argument_list|,
literal|"%u unchanged\n"
argument_list|,
name|stats
operator|.
name|s_unc
argument_list|)
expr_stmt|;
block|}
name|flushline
argument_list|(
operator|&
name|gpkt
argument_list|,
operator|&
name|stats
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|auxf
argument_list|(
name|gpkt
operator|.
name|p_file
argument_list|,
literal|'x'
argument_list|)
argument_list|,
name|gpkt
operator|.
name|p_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|Szqfile
condition|)
name|rename
argument_list|(
name|auxf
argument_list|(
operator|&
name|gpkt
operator|.
name|p_file
argument_list|,
literal|'q'
argument_list|)
argument_list|,
name|Pfilename
argument_list|)
expr_stmt|;
else|else
block|{
name|xunlink
argument_list|(
name|Pfilename
argument_list|)
expr_stmt|;
name|xunlink
argument_list|(
name|auxf
argument_list|(
operator|&
name|gpkt
operator|.
name|p_file
argument_list|,
literal|'q'
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|clean_up
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|HADN
condition|)
block|{
name|setuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|gfilename
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|mkdelt
argument_list|(
argument|pkt
argument_list|,
argument|sp
argument_list|,
argument|osp
argument_list|,
argument|diffloop
argument_list|,
argument|orig_nlines
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|packet
modifier|*
name|pkt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sid
modifier|*
name|sp
decl_stmt|,
modifier|*
name|osp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|diffloop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|orig_nlines
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|long
name|Timenow
decl_stmt|;
name|struct
name|deltab
name|dt
decl_stmt|;
name|char
name|str
index|[
literal|128
index|]
decl_stmt|;
name|int
name|newser
decl_stmt|;
specifier|extern
name|char
modifier|*
name|Sflags
index|[]
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|ser_inc
decl_stmt|,
name|opred
decl_stmt|,
name|nulldel
decl_stmt|;
if|if
condition|(
operator|!
name|diffloop
operator|&&
name|pkt
operator|->
name|p_verbose
condition|)
block|{
name|sid_ba
argument_list|(
name|sp
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|pkt
operator|->
name|p_stdout
argument_list|,
literal|"%s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%c%c00000\n"
argument_list|,
name|CTLCHAR
argument_list|,
name|HEAD
argument_list|)
argument_list|)
expr_stmt|;
name|newstats
argument_list|(
name|pkt
argument_list|,
name|str
argument_list|,
literal|"0"
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|sp
argument_list|,
operator|&
name|dt
operator|.
name|d_sid
argument_list|,
sizeof|sizeof
argument_list|(
name|dt
operator|.
name|d_sid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	Check if 'null' deltas should be inserted 	(only if 'null' flag is in file and 	releases are being skipped) and set 	'nulldel' indicator appropriately. 	*/
if|if
condition|(
name|Sflags
index|[
name|NULLFLAG
operator|-
literal|'a'
index|]
operator|&&
operator|(
name|sp
operator|->
name|s_rel
operator|>
name|osp
operator|->
name|s_rel
operator|+
literal|1
operator|)
operator|&&
operator|!
name|sp
operator|->
name|s_br
operator|&&
operator|!
name|sp
operator|->
name|s_seq
operator|&&
operator|!
name|osp
operator|->
name|s_br
operator|&&
operator|!
name|osp
operator|->
name|s_seq
condition|)
name|nulldel
operator|=
literal|1
expr_stmt|;
else|else
name|nulldel
operator|=
literal|0
expr_stmt|;
comment|/* 	Calculate how many serial numbers are needed. 	*/
if|if
condition|(
name|nulldel
condition|)
name|ser_inc
operator|=
name|sp
operator|->
name|s_rel
operator|-
name|osp
operator|->
name|s_rel
expr_stmt|;
else|else
name|ser_inc
operator|=
literal|1
expr_stmt|;
comment|/* 	Find serial number of the new delta. 	*/
name|newser
operator|=
name|dt
operator|.
name|d_serial
operator|=
name|maxser
argument_list|(
name|pkt
argument_list|)
operator|+
name|ser_inc
expr_stmt|;
comment|/* 	Find old predecessor's serial number. 	*/
name|opred
operator|=
name|sidtoser
argument_list|(
name|osp
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
if|if
condition|(
name|nulldel
condition|)
name|dt
operator|.
name|d_pred
operator|=
name|newser
operator|-
literal|1
expr_stmt|;
comment|/* set predecessor to 'null' delta */
else|else
name|dt
operator|.
name|d_pred
operator|=
name|opred
expr_stmt|;
name|dt
operator|.
name|d_datetime
operator|=
name|Timenow
expr_stmt|;
name|substr
argument_list|(
name|logname
argument_list|()
argument_list|,
name|dt
operator|.
name|d_pgmr
argument_list|,
literal|0
argument_list|,
name|LNLNAM
argument_list|)
expr_stmt|;
name|dt
operator|.
name|d_type
operator|=
literal|'D'
expr_stmt|;
name|del_ba
argument_list|(
operator|&
name|dt
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|str
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|LOGDELTA
if|if
condition|(
name|Logf
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|pkt
operator|->
name|p_file
index|[
literal|0
index|]
operator|!=
literal|'/'
condition|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
if|if
condition|(
name|getwd
argument_list|(
name|buf
argument_list|)
operator|!=
name|NULL
condition|)
name|fprintf
argument_list|(
name|Logf
argument_list|,
literal|"%s/"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|Logf
argument_list|,
literal|"%s:\n%s%s\n"
argument_list|,
name|pkt
operator|->
name|p_file
argument_list|,
name|str
operator|+
literal|5
argument_list|,
name|Comments
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|ilist
condition|)
name|mkixg
argument_list|(
name|pkt
argument_list|,
name|INCLUSER
argument_list|,
name|INCLUDE
argument_list|)
expr_stmt|;
if|if
condition|(
name|elist
condition|)
name|mkixg
argument_list|(
name|pkt
argument_list|,
name|EXCLUSER
argument_list|,
name|EXCLUDE
argument_list|)
expr_stmt|;
if|if
condition|(
name|glist
condition|)
name|mkixg
argument_list|(
name|pkt
argument_list|,
name|IGNRUSER
argument_list|,
name|IGNORE
argument_list|)
expr_stmt|;
if|if
condition|(
name|Mrs
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|p
operator|=
name|Sflags
index|[
name|VALFLAG
operator|-
literal|'a'
index|]
operator|)
condition|)
name|fatal
argument_list|(
literal|"MRs not allowed (de8)"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|&&
operator|!
name|diffloop
operator|&&
name|valmrs
argument_list|(
name|pkt
argument_list|,
name|p
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"invalid MRs (de9)"
argument_list|)
expr_stmt|;
name|putmrs
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Sflags
index|[
name|VALFLAG
operator|-
literal|'a'
index|]
condition|)
name|fatal
argument_list|(
literal|"MRs required (de10)"
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%c%c "
argument_list|,
name|CTLCHAR
argument_list|,
name|COMMENTS
argument_list|)
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|Comments
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
name|CTLSTR
argument_list|,
name|CTLCHAR
argument_list|,
name|EDELTAB
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nulldel
condition|)
comment|/* insert 'null' deltas */
while|while
condition|(
operator|--
name|ser_inc
condition|)
block|{
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%c%c %s/%s/%05u\n"
argument_list|,
name|CTLCHAR
argument_list|,
name|STATS
argument_list|,
literal|"00000"
argument_list|,
literal|"00000"
argument_list|,
name|orig_nlines
argument_list|)
argument_list|)
expr_stmt|;
name|dt
operator|.
name|d_sid
operator|.
name|s_rel
operator|=
operator|-
literal|1
expr_stmt|;
name|dt
operator|.
name|d_serial
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ser_inc
operator|!=
literal|1
condition|)
name|dt
operator|.
name|d_pred
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|dt
operator|.
name|d_pred
operator|=
name|opred
expr_stmt|;
comment|/* point to old pred */
name|del_ba
argument_list|(
operator|&
name|dt
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%c%c "
argument_list|,
name|CTLCHAR
argument_list|,
name|COMMENTS
argument_list|)
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
literal|"AUTO NULL DELTA\n"
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
name|CTLSTR
argument_list|,
name|CTLCHAR
argument_list|,
name|EDELTAB
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|newser
operator|)
return|;
block|}
end_block

begin_macro
name|mkixg
argument_list|(
argument|pkt
argument_list|,
argument|reason
argument_list|,
argument|ch
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|packet
modifier|*
name|pkt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|reason
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|ch
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|n
decl_stmt|;
name|char
name|str
index|[
literal|512
index|]
decl_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%c%c"
argument_list|,
name|CTLCHAR
argument_list|,
name|ch
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|maxser
argument_list|(
name|pkt
argument_list|)
init|;
name|n
condition|;
name|n
operator|--
control|)
block|{
if|if
condition|(
name|pkt
operator|->
name|p_apply
index|[
name|n
index|]
operator|.
name|a_reason
operator|==
name|reason
condition|)
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|" %u"
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|putline
argument_list|(
name|pkt
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|putmrs
argument_list|(
argument|pkt
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|packet
modifier|*
name|pkt
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|char
name|str
index|[
literal|64
index|]
decl_stmt|;
specifier|extern
name|char
modifier|*
name|Varg
index|[]
decl_stmt|;
for|for
control|(
name|argv
operator|=
operator|&
name|Varg
index|[
name|VSTART
index|]
init|;
operator|*
name|argv
condition|;
name|argv
operator|++
control|)
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%c%c %s\n"
argument_list|,
name|CTLCHAR
argument_list|,
name|MRNUM
argument_list|,
operator|*
name|argv
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|rdpfile
argument_list|(
name|pkt
argument_list|,
name|sp
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|sid
modifier|*
name|sp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|user
decl_stmt|;
name|struct
name|pfile
name|pf
decl_stmt|;
specifier|static
name|struct
name|pfile
name|goodpf
decl_stmt|;
name|char
name|line
index|[
literal|512
index|]
decl_stmt|;
name|int
name|cnt
decl_stmt|,
name|root
decl_stmt|;
name|FILE
modifier|*
name|in
decl_stmt|,
modifier|*
name|out
decl_stmt|;
name|cnt
operator|=
operator|-
literal|1
expr_stmt|;
name|user
operator|=
name|logname
argument_list|()
expr_stmt|;
name|zero
argument_list|(
operator|&
name|goodpf
argument_list|,
sizeof|sizeof
argument_list|(
name|goodpf
argument_list|)
argument_list|)
expr_stmt|;
name|in
operator|=
name|xfopen
argument_list|(
name|auxf
argument_list|(
name|pkt
operator|->
name|p_file
argument_list|,
literal|'p'
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|out
operator|=
name|xfcreat
argument_list|(
name|auxf
argument_list|(
name|pkt
operator|->
name|p_file
argument_list|,
literal|'q'
argument_list|)
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
name|root
operator|=
name|getuid
argument_list|()
operator|==
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|in
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|pf_ab
argument_list|(
name|line
argument_list|,
operator|&
name|pf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|root
operator|||
name|equal
argument_list|(
name|pf
operator|.
name|pf_user
argument_list|,
name|user
argument_list|)
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|s_rel
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|cnt
condition|)
block|{
name|fclose
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"missing -r argument (de1)"
argument_list|)
expr_stmt|;
block|}
name|move
argument_list|(
operator|&
name|pf
argument_list|,
operator|&
name|goodpf
argument_list|,
sizeof|sizeof
argument_list|(
name|pf
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|sp
operator|->
name|s_rel
operator|==
name|pf
operator|.
name|pf_gsid
operator|.
name|s_rel
operator|&&
name|sp
operator|->
name|s_lev
operator|==
name|pf
operator|.
name|pf_gsid
operator|.
name|s_lev
operator|&&
name|sp
operator|->
name|s_br
operator|==
name|pf
operator|.
name|pf_gsid
operator|.
name|s_br
operator|&&
name|sp
operator|->
name|s_seq
operator|==
name|pf
operator|.
name|pf_gsid
operator|.
name|s_seq
condition|)
block|{
name|move
argument_list|(
operator|&
name|pf
argument_list|,
operator|&
name|goodpf
argument_list|,
sizeof|sizeof
argument_list|(
name|pf
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|fputs
argument_list|(
name|line
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
name|fflush
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|fstat
argument_list|(
name|fileno
argument_list|(
name|out
argument_list|)
argument_list|,
operator|&
name|Statbuf
argument_list|)
expr_stmt|;
name|Szqfile
operator|=
name|Statbuf
operator|.
name|st_size
expr_stmt|;
name|copy
argument_list|(
name|auxf
argument_list|(
name|pkt
operator|->
name|p_file
argument_list|,
literal|'p'
argument_list|)
argument_list|,
name|Pfilename
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|goodpf
operator|.
name|pf_user
index|[
literal|0
index|]
condition|)
name|fatal
argument_list|(
literal|"not in p-file (de2)"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|goodpf
operator|)
return|;
block|}
end_block

begin_macro
name|dodiff
argument_list|(
argument|newf
argument_list|,
argument|oldf
argument_list|,
argument|difflim
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|newf
decl_stmt|,
modifier|*
name|oldf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|difflim
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|pfd
index|[
literal|2
index|]
decl_stmt|;
name|FILE
modifier|*
name|iop
decl_stmt|;
specifier|extern
name|char
name|Diffpgm
index|[]
decl_stmt|;
name|char
name|num
index|[
literal|10
index|]
decl_stmt|;
name|xpipe
argument_list|(
name|pfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|fork
argument_list|()
operator|)
operator|<
literal|0
condition|)
block|{
name|close
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"cannot fork, try again (de11)"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dup
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|5
init|;
name|i
operator|<
literal|15
condition|;
name|i
operator|++
control|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|num
argument_list|,
literal|"%d"
argument_list|,
name|difflim
argument_list|)
expr_stmt|;
name|execl
argument_list|(
name|Diffpgm
argument_list|,
name|Diffpgm
argument_list|,
name|oldf
argument_list|,
name|newf
argument_list|,
name|num
argument_list|,
literal|"-s"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|32
argument_list|)
expr_stmt|;
comment|/* tell parent that 'execl' failed */
block|}
else|else
block|{
name|close
argument_list|(
name|pfd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|iop
operator|=
name|fdfopen
argument_list|(
name|pfd
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|iop
operator|)
return|;
block|}
block|}
end_block

begin_expr_stmt
name|getdiff
argument_list|(
name|type
argument_list|,
name|plinenum
argument_list|)
specifier|register
name|char
operator|*
name|type
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
modifier|*
name|plinenum
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|line
index|[
literal|512
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|num_lines
decl_stmt|;
specifier|static
name|int
name|chg_num
decl_stmt|,
name|chg_ln
decl_stmt|;
name|int
name|lowline
decl_stmt|,
name|highline
decl_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|rddiff
argument_list|(
name|line
argument_list|,
literal|512
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'-'
condition|)
block|{
operator|*
name|type
operator|=
name|INS
expr_stmt|;
operator|*
name|plinenum
operator|=
name|chg_ln
expr_stmt|;
name|num_lines
operator|=
name|chg_num
expr_stmt|;
block|}
else|else
block|{
name|p
operator|=
name|linerange
argument_list|(
name|p
argument_list|,
operator|&
name|lowline
argument_list|,
operator|&
name|highline
argument_list|)
expr_stmt|;
operator|*
name|plinenum
operator|=
name|lowline
expr_stmt|;
switch|switch
condition|(
operator|*
name|p
operator|++
condition|)
block|{
case|case
literal|'d'
case|:
name|num_lines
operator|=
name|highline
operator|-
name|lowline
operator|+
literal|1
expr_stmt|;
operator|*
name|type
operator|=
name|DEL
expr_stmt|;
name|skiplines
argument_list|(
name|line
argument_list|,
name|num_lines
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|linerange
argument_list|(
name|p
argument_list|,
operator|&
name|lowline
argument_list|,
operator|&
name|highline
argument_list|)
expr_stmt|;
name|num_lines
operator|=
name|highline
operator|-
name|lowline
operator|+
literal|1
expr_stmt|;
operator|*
name|type
operator|=
name|INS
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|chg_ln
operator|=
name|lowline
expr_stmt|;
name|num_lines
operator|=
name|highline
operator|-
name|lowline
operator|+
literal|1
expr_stmt|;
name|linerange
argument_list|(
name|p
argument_list|,
operator|&
name|lowline
argument_list|,
operator|&
name|highline
argument_list|)
expr_stmt|;
name|chg_num
operator|=
name|highline
operator|-
name|lowline
operator|+
literal|1
expr_stmt|;
operator|*
name|type
operator|=
name|DEL
expr_stmt|;
name|skiplines
argument_list|(
name|line
argument_list|,
name|num_lines
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|num_lines
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|insert
argument_list|(
name|pkt
argument_list|,
name|linenum
argument_list|,
name|n
argument_list|,
name|ser
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|linenum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ser
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|str
index|[
literal|512
index|]
decl_stmt|;
name|after
argument_list|(
name|pkt
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%c%c %u\n"
argument_list|,
name|CTLCHAR
argument_list|,
name|INS
argument_list|,
name|ser
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
operator|++
name|n
init|;
operator|--
name|n
condition|;
control|)
block|{
name|rddiff
argument_list|(
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
operator|&
name|str
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%c%c %u\n"
argument_list|,
name|CTLCHAR
argument_list|,
name|END
argument_list|,
name|ser
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|delete
argument_list|(
name|pkt
argument_list|,
name|linenum
argument_list|,
name|n
argument_list|,
name|ser
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|linenum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|ser
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|str
index|[
literal|512
index|]
decl_stmt|;
name|before
argument_list|(
name|pkt
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%c%c %u\n"
argument_list|,
name|CTLCHAR
argument_list|,
name|DEL
argument_list|,
name|ser
argument_list|)
argument_list|)
expr_stmt|;
name|after
argument_list|(
name|pkt
argument_list|,
name|linenum
operator|+
name|n
operator|-
literal|1
argument_list|)
expr_stmt|;
name|putline
argument_list|(
name|pkt
argument_list|,
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%c%c %u\n"
argument_list|,
name|CTLCHAR
argument_list|,
name|END
argument_list|,
name|ser
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|after
argument_list|(
name|pkt
argument_list|,
name|n
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|before
argument_list|(
name|pkt
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|p_glnno
operator|==
name|n
condition|)
name|putline
argument_list|(
name|pkt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|before
argument_list|(
name|pkt
argument_list|,
name|n
argument_list|)
specifier|register
expr|struct
name|packet
operator|*
name|pkt
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
name|pkt
operator|->
name|p_glnno
operator|<
name|n
condition|)
block|{
if|if
condition|(
operator|!
name|readmod
argument_list|(
name|pkt
argument_list|)
condition|)
break|break;
block|}
block|}
end_block

begin_expr_stmt
name|linerange
argument_list|(
name|cp
argument_list|,
name|low
argument_list|,
name|high
argument_list|)
specifier|register
name|char
operator|*
name|cp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
modifier|*
name|low
decl_stmt|,
modifier|*
name|high
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|cp
operator|=
name|satoi
argument_list|(
name|cp
argument_list|,
name|low
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|','
condition|)
name|cp
operator|=
name|satoi
argument_list|(
operator|++
name|cp
argument_list|,
name|high
argument_list|)
expr_stmt|;
else|else
operator|*
name|high
operator|=
operator|*
name|low
expr_stmt|;
return|return
operator|(
name|cp
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|skiplines
argument_list|(
name|lp
argument_list|,
name|num
argument_list|)
specifier|register
name|char
operator|*
name|lp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|num
decl_stmt|;
end_decl_stmt

begin_block
block|{
for|for
control|(
operator|++
name|num
init|;
operator|--
name|num
condition|;
control|)
name|rddiff
argument_list|(
name|lp
argument_list|,
literal|512
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|rddiff
argument_list|(
name|s
argument_list|,
name|n
argument_list|)
specifier|register
name|char
operator|*
name|s
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|fgets
argument_list|(
name|s
argument_list|,
name|n
argument_list|,
name|Diffin
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
name|HADP
condition|)
name|fputs
argument_list|(
name|s
argument_list|,
name|gpkt
operator|.
name|p_stdout
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_block

begin_macro
name|enter
argument_list|(
argument|pkt
argument_list|,
argument|ch
argument_list|,
argument|n
argument_list|,
argument|sidp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|packet
modifier|*
name|pkt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|ch
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sid
modifier|*
name|sidp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|str
index|[
literal|32
index|]
decl_stmt|;
specifier|register
name|struct
name|apply
modifier|*
name|ap
decl_stmt|;
name|sid_ba
argument_list|(
name|sidp
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|ap
operator|=
operator|&
name|pkt
operator|->
name|p_apply
index|[
name|n
index|]
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|p_cutoff
operator|>
name|pkt
operator|->
name|p_idel
index|[
name|n
index|]
operator|.
name|i_datetime
condition|)
switch|switch
condition|(
name|ap
operator|->
name|a_code
condition|)
block|{
case|case
name|EMPTY
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|INCLUDE
case|:
name|condset
argument_list|(
name|ap
argument_list|,
name|APPLY
argument_list|,
name|INCLUSER
argument_list|)
expr_stmt|;
break|break;
case|case
name|EXCLUDE
case|:
name|condset
argument_list|(
name|ap
argument_list|,
name|NOAPPLY
argument_list|,
name|EXCLUSER
argument_list|)
expr_stmt|;
break|break;
case|case
name|IGNORE
case|:
name|condset
argument_list|(
name|ap
argument_list|,
name|EMPTY
argument_list|,
name|IGNRUSER
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|APPLY
case|:
name|fatal
argument_list|(
literal|"internal error in delta/enter() (de5)"
argument_list|)
expr_stmt|;
break|break;
case|case
name|NOAPPLY
case|:
name|fatal
argument_list|(
literal|"internal error in delta/enter() (de6)"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|"internal error in delta/enter() (de7)"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_macro
name|escdodelt
argument_list|()
end_macro

begin_comment
comment|/* dummy routine for dodelt() */
end_comment

begin_block
block|{ }
end_block

begin_macro
name|clean_up
argument_list|(
argument|n
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|gpkt
operator|.
name|p_file
index|[
literal|0
index|]
condition|)
name|unlockit
argument_list|(
name|auxf
argument_list|(
name|gpkt
operator|.
name|p_file
argument_list|,
literal|'z'
argument_list|)
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|xrm
argument_list|(
operator|&
name|gpkt
argument_list|)
expr_stmt|;
name|xfreeall
argument_list|()
expr_stmt|;
block|}
end_block

end_unit


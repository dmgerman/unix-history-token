begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_empty
empty|#
end_empty

begin_comment
comment|/*  * login [ name ]  */
end_comment

begin_struct
struct|struct
block|{
name|char
name|name
index|[
literal|8
index|]
decl_stmt|;
name|char
name|tty
decl_stmt|;
name|char
name|ifill
decl_stmt|;
name|int
name|time
index|[
literal|2
index|]
decl_stmt|;
name|int
name|ufill
decl_stmt|;
block|}
name|utmp
struct|;
end_struct

begin_struct
struct|struct
block|{
name|int
name|regs
index|[
literal|2
index|]
decl_stmt|;
name|int
name|tflags
decl_stmt|;
block|}
name|ttyb
struct|;
end_struct

begin_decl_stmt
name|char
modifier|*
name|ttyx
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ECHO
value|010
end_define

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|char
name|pbuf
index|[
literal|128
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|namep
decl_stmt|,
modifier|*
name|np
decl_stmt|;
name|char
name|pwbuf
index|[
literal|9
index|]
decl_stmt|;
name|int
name|t
decl_stmt|,
name|sflags
decl_stmt|,
name|f
decl_stmt|,
name|c
decl_stmt|,
name|uid
decl_stmt|,
name|gid
decl_stmt|;
name|signal
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|signal
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ttyx
operator|=
literal|"/dev/ttyx"
expr_stmt|;
if|if
condition|(
operator|(
name|utmp
operator|.
name|tty
operator|=
name|ttyn
argument_list|(
literal|0
argument_list|)
operator|)
operator|==
literal|'x'
condition|)
block|{
name|write
argument_list|(
literal|1
argument_list|,
literal|"Sorry.\n"
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|exit
argument_list|()
expr_stmt|;
block|}
name|ttyx
index|[
literal|8
index|]
operator|=
name|utmp
operator|.
name|tty
expr_stmt|;
name|loop
label|:
name|namep
operator|=
name|utmp
operator|.
name|name
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|np
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
while|while
condition|(
name|namep
operator|<
name|utmp
operator|.
name|name
operator|+
literal|8
operator|&&
operator|*
name|np
condition|)
operator|*
name|namep
operator|++
operator|=
operator|*
name|np
operator|++
expr_stmt|;
name|argc
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|write
argument_list|(
literal|1
argument_list|,
literal|"Name: "
argument_list|,
literal|7
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getchar
argument_list|()
operator|)
operator|!=
literal|'\n'
condition|)
block|{
if|if
condition|(
name|c
operator|<=
literal|0
condition|)
name|exit
argument_list|()
expr_stmt|;
if|if
condition|(
name|namep
operator|<
name|utmp
operator|.
name|name
operator|+
literal|8
condition|)
operator|*
name|namep
operator|++
operator|=
name|c
expr_stmt|;
block|}
block|}
while|while
condition|(
name|namep
operator|<
name|utmp
operator|.
name|name
operator|+
literal|8
condition|)
operator|*
name|namep
operator|++
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
name|getpwentry
argument_list|(
name|utmp
operator|.
name|name
argument_list|,
name|pbuf
argument_list|)
condition|)
goto|goto
name|bad
goto|;
name|np
operator|=
name|colon
argument_list|(
name|pbuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|np
operator|!=
literal|':'
condition|)
block|{
name|gtty
argument_list|(
literal|0
argument_list|,
operator|&
name|ttyb
argument_list|)
expr_stmt|;
name|sflags
operator|=
name|ttyb
operator|.
name|tflags
expr_stmt|;
name|ttyb
operator|.
name|tflags
operator|=
operator|&
operator|~
name|ECHO
expr_stmt|;
name|stty
argument_list|(
literal|0
argument_list|,
operator|&
name|ttyb
argument_list|)
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
literal|"Password: "
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|namep
operator|=
name|pwbuf
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getchar
argument_list|()
operator|)
operator|!=
literal|'\n'
condition|)
block|{
if|if
condition|(
name|c
operator|<=
literal|0
condition|)
name|exit
argument_list|()
expr_stmt|;
if|if
condition|(
name|namep
operator|<
name|pwbuf
operator|+
literal|8
condition|)
operator|*
name|namep
operator|++
operator|=
name|c
expr_stmt|;
block|}
operator|*
name|namep
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|ttyb
operator|.
name|tflags
operator|=
name|sflags
expr_stmt|;
name|stty
argument_list|(
literal|0
argument_list|,
operator|&
name|ttyb
argument_list|)
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|namep
operator|=
name|crypt
argument_list|(
name|pwbuf
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|namep
operator|++
operator|==
operator|*
name|np
operator|++
condition|)
empty_stmt|;
if|if
condition|(
operator|*
operator|--
name|namep
operator|!=
literal|'\0'
operator|||
operator|*
operator|--
name|np
operator|!=
literal|':'
condition|)
goto|goto
name|bad
goto|;
block|}
name|np
operator|=
name|colon
argument_list|(
name|np
argument_list|)
expr_stmt|;
name|uid
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|np
operator|!=
literal|':'
condition|)
name|uid
operator|=
name|uid
operator|*
literal|10
operator|+
operator|*
name|np
operator|++
operator|-
literal|'0'
expr_stmt|;
name|np
operator|++
expr_stmt|;
name|gid
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|np
operator|!=
literal|':'
condition|)
name|gid
operator|=
name|gid
operator|*
literal|10
operator|+
operator|*
name|np
operator|++
operator|-
literal|'0'
expr_stmt|;
name|np
operator|++
expr_stmt|;
name|np
operator|=
name|colon
argument_list|(
name|np
argument_list|)
expr_stmt|;
name|namep
operator|=
name|np
expr_stmt|;
name|np
operator|=
name|colon
argument_list|(
name|np
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|namep
argument_list|)
operator|<
literal|0
condition|)
block|{
name|write
argument_list|(
literal|1
argument_list|,
literal|"No directory\n"
argument_list|,
literal|13
argument_list|)
expr_stmt|;
goto|goto
name|loop
goto|;
block|}
name|time
argument_list|(
name|utmp
operator|.
name|time
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|open
argument_list|(
literal|"/etc/utmp"
argument_list|,
literal|1
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|t
operator|=
name|utmp
operator|.
name|tty
expr_stmt|;
if|if
condition|(
name|t
operator|>=
literal|'a'
condition|)
name|t
operator|=
operator|-
literal|'a'
operator|-
operator|(
literal|10
operator|+
literal|'0'
operator|)
expr_stmt|;
name|seek
argument_list|(
name|f
argument_list|,
operator|(
name|t
operator|-
literal|'0'
operator|)
operator|*
literal|16
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
operator|&
name|utmp
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|open
argument_list|(
literal|"/usr/adm/wtmp"
argument_list|,
literal|1
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|seek
argument_list|(
name|f
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
operator|&
name|utmp
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|open
argument_list|(
literal|"/etc/motd"
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
while|while
condition|(
name|read
argument_list|(
name|f
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
operator|>
literal|0
condition|)
name|write
argument_list|(
literal|1
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|open
argument_list|(
literal|"mailbox"
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|write
argument_list|(
literal|1
argument_list|,
literal|"You have mail.\n"
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
name|chown
argument_list|(
name|ttyx
argument_list|,
name|uid
argument_list|)
expr_stmt|;
name|setgid
argument_list|(
name|gid
argument_list|)
expr_stmt|;
name|setuid
argument_list|(
name|uid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|np
operator|==
literal|'\0'
condition|)
name|np
operator|=
literal|"/bin/sh"
expr_stmt|;
name|execl
argument_list|(
name|np
argument_list|,
literal|"-"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
literal|"No shell.\n"
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|exit
argument_list|()
expr_stmt|;
name|bad
label|:
name|write
argument_list|(
literal|1
argument_list|,
literal|"Login incorrect.\n"
argument_list|,
literal|17
argument_list|)
expr_stmt|;
goto|goto
name|loop
goto|;
block|}
end_function

begin_macro
name|getpwentry
argument_list|(
argument|name
argument_list|,
argument|buf
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
extern|extern fin;
name|int
name|fi
decl_stmt|,
name|r
decl_stmt|,
name|c
decl_stmt|;
specifier|register
name|char
modifier|*
name|gnp
decl_stmt|,
modifier|*
name|rnp
decl_stmt|;
name|fi
operator|=
name|fin
expr_stmt|;
name|r
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|fin
operator|=
name|open
argument_list|(
literal|"/etc/passwd"
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
goto|goto
name|ret
goto|;
name|loop
label|:
name|gnp
operator|=
name|name
expr_stmt|;
name|rnp
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getchar
argument_list|()
operator|)
operator|!=
literal|'\n'
condition|)
block|{
if|if
condition|(
name|c
operator|<=
literal|0
condition|)
goto|goto
name|ret
goto|;
operator|*
name|rnp
operator|++
operator|=
name|c
expr_stmt|;
block|}
operator|*
name|rnp
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|rnp
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|gnp
operator|++
operator|==
operator|*
name|rnp
operator|++
condition|)
empty_stmt|;
if|if
condition|(
operator|(
operator|*
operator|--
name|gnp
operator|!=
literal|' '
operator|&&
name|gnp
operator|<
name|name
operator|+
literal|8
operator|)
operator|||
operator|*
operator|--
name|rnp
operator|!=
literal|':'
condition|)
goto|goto
name|loop
goto|;
name|r
operator|=
literal|0
expr_stmt|;
name|ret
label|:
name|close
argument_list|(
name|fin
argument_list|)
expr_stmt|;
name|fin
operator|=
literal|0
expr_stmt|;
operator|(
operator|&
name|fin
operator|)
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
operator|(
operator|&
name|fin
operator|)
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_block

begin_macro
name|colon
argument_list|(
argument|p
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|rp
decl_stmt|;
name|rp
operator|=
name|p
expr_stmt|;
while|while
condition|(
operator|*
name|rp
operator|!=
literal|':'
condition|)
block|{
if|if
condition|(
operator|*
name|rp
operator|++
operator|==
literal|'\0'
condition|)
block|{
name|write
argument_list|(
literal|1
argument_list|,
literal|"Bad /etc/passwd\n"
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|exit
argument_list|()
expr_stmt|;
block|}
block|}
operator|*
name|rp
operator|++
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|rp
operator|)
return|;
block|}
end_block

end_unit


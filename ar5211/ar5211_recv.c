begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2008 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2006 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $Id: ar5211_recv.c,v 1.4 2008/11/10 04:08:02 sam Exp $  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|AH_SUPPORT_AR5211
end_ifdef

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_desc.h"
end_include

begin_include
include|#
directive|include
file|"ar5211/ar5211.h"
end_include

begin_include
include|#
directive|include
file|"ar5211/ar5211reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5211/ar5211desc.h"
end_include

begin_comment
comment|/*  * Get the RXDP.  */
end_comment

begin_function
name|uint32_t
name|ar5211GetRxDP
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RXDP
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set the RxDP.  */
end_comment

begin_function
name|void
name|ar5211SetRxDP
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|rxdp
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_RXDP
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RXDP
argument_list|)
operator|==
name|rxdp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set Receive Enable bits.  */
end_comment

begin_function
name|void
name|ar5211EnableReceive
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|,
name|AR_CR_RXE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Stop Receive at the DMA engine  */
end_comment

begin_function
name|HAL_BOOL
name|ar5211StopDmaReceive
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|,
name|AR_CR_RXD
argument_list|)
expr_stmt|;
comment|/* Set receive disable bit */
if|if
condition|(
operator|!
name|ath_hal_wait
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|,
name|AR_CR_RXE
argument_list|,
literal|0
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|AH_DEBUG
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s failed to stop in 10ms\n"
literal|"AR_CR=0x%08X\nAR_DIAG_SW=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|)
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|AH_FALSE
return|;
block|}
else|else
block|{
return|return
name|AH_TRUE
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Start Transmit at the PCU engine (unpause receive)  */
end_comment

begin_function
name|void
name|ar5211StartPcuReceive
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|)
operator|&
operator|~
operator|(
name|AR_DIAG_SW_DIS_RX
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Stop Transmit at the PCU engine (pause receive)  */
end_comment

begin_function
name|void
name|ar5211StopPcuReceive
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|)
operator||
name|AR_DIAG_SW_DIS_RX
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set multicast filter 0 (lower 32-bits)  *			   filter 1 (upper 32-bits)  */
end_comment

begin_function
name|void
name|ar5211SetMulticastFilter
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|filter0
parameter_list|,
name|uint32_t
name|filter1
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL0
argument_list|,
name|filter0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL1
argument_list|,
name|filter1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Clear multicast filter by index  */
end_comment

begin_function
name|HAL_BOOL
name|ar5211ClrMulticastFilterIndex
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|ix
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
if|if
condition|(
name|ix
operator|>=
literal|64
condition|)
return|return
name|AH_FALSE
return|;
if|if
condition|(
name|ix
operator|>=
literal|32
condition|)
block|{
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL1
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL1
argument_list|,
operator|(
name|val
operator|&
operator|~
operator|(
literal|1
operator|<<
operator|(
name|ix
operator|-
literal|32
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL0
argument_list|,
operator|(
name|val
operator|&
operator|~
operator|(
literal|1
operator|<<
name|ix
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Set multicast filter by index  */
end_comment

begin_function
name|HAL_BOOL
name|ar5211SetMulticastFilterIndex
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|ix
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
if|if
condition|(
name|ix
operator|>=
literal|64
condition|)
return|return
name|AH_FALSE
return|;
if|if
condition|(
name|ix
operator|>=
literal|32
condition|)
block|{
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL1
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL1
argument_list|,
operator|(
name|val
operator||
operator|(
literal|1
operator|<<
operator|(
name|ix
operator|-
literal|32
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL0
argument_list|,
operator|(
name|val
operator||
operator|(
literal|1
operator|<<
name|ix
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Get receive filter.  */
end_comment

begin_function
name|uint32_t
name|ar5211GetRxFilter
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RX_FILTER
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set receive filter.  */
end_comment

begin_function
name|void
name|ar5211SetRxFilter
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|bits
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_RX_FILTER
argument_list|,
name|bits
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize RX descriptor, by clearing the status and clearing  * the size.  This is not strictly HW dependent, but we want the  * control and status words to be opaque above the hal.  */
end_comment

begin_function
name|HAL_BOOL
name|ar5211SetupRxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|struct
name|ar5211_desc
modifier|*
name|ads
init|=
name|AR5211DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|ads
operator|->
name|ds_ctl0
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|=
name|size
operator|&
name|AR_BufLen
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_ctl1
operator|!=
name|size
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: buffer size %u too large\n"
argument_list|,
name|__func__
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|HAL_RXDESC_INTREQ
condition|)
name|ads
operator|->
name|ds_ctl1
operator||=
name|AR_RxInterReq
expr_stmt|;
name|ads
operator|->
name|ds_status0
operator|=
name|ads
operator|->
name|ds_status1
operator|=
literal|0
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Process an RX descriptor, and return the status to the caller.  * Copy some hardware specific items into the software portion  * of the descriptor.  *  * NB: the caller is responsible for validating the memory contents  *     of the descriptor (e.g. flushing any cached copy).  */
end_comment

begin_function
name|HAL_STATUS
name|ar5211ProcRxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|uint32_t
name|pa
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|nds
parameter_list|,
name|uint64_t
name|tsf
parameter_list|,
name|struct
name|ath_rx_status
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ar5211_desc
modifier|*
name|ads
init|=
name|AR5211DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|struct
name|ar5211_desc
modifier|*
name|ands
init|=
name|AR5211DESC
argument_list|(
name|nds
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ads
operator|->
name|ds_status1
operator|&
name|AR_Done
operator|)
operator|==
literal|0
condition|)
return|return
name|HAL_EINPROGRESS
return|;
comment|/* 	 * Given the use of a self-linked tail be very sure that the hw is 	 * done with this descriptor; the hw may have done this descriptor 	 * once and picked it up again...make sure the hw has moved on. 	 */
if|if
condition|(
operator|(
name|ands
operator|->
name|ds_status1
operator|&
name|AR_Done
operator|)
operator|==
literal|0
operator|&&
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RXDP
argument_list|)
operator|==
name|pa
condition|)
return|return
name|HAL_EINPROGRESS
return|;
name|rs
operator|->
name|rs_datalen
operator|=
name|ads
operator|->
name|ds_status0
operator|&
name|AR_DataLen
expr_stmt|;
name|rs
operator|->
name|rs_tstamp
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_status1
argument_list|,
name|AR_RcvTimestamp
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ads
operator|->
name|ds_status1
operator|&
name|AR_FrmRcvOK
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ads
operator|->
name|ds_status1
operator|&
name|AR_CRCErr
condition|)
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_CRC
expr_stmt|;
elseif|else
if|if
condition|(
name|ads
operator|->
name|ds_status1
operator|&
name|AR_DecryptCRCErr
condition|)
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_DECRYPT
expr_stmt|;
else|else
block|{
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_PHY
expr_stmt|;
name|rs
operator|->
name|rs_phyerr
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_status1
argument_list|,
name|AR_PHYErr
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* XXX what about KeyCacheMiss? */
name|rs
operator|->
name|rs_rssi
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_status0
argument_list|,
name|AR_RcvSigStrength
argument_list|)
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_status1
operator|&
name|AR_KeyIdxValid
condition|)
name|rs
operator|->
name|rs_keyix
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_status1
argument_list|,
name|AR_KeyIdx
argument_list|)
expr_stmt|;
else|else
name|rs
operator|->
name|rs_keyix
operator|=
name|HAL_RXKEYIX_INVALID
expr_stmt|;
comment|/* NB: caller expected to do rate table mapping */
name|rs
operator|->
name|rs_rate
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_status0
argument_list|,
name|AR_RcvRate
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_antenna
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_status0
argument_list|,
name|AR_RcvAntenna
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_more
operator|=
operator|(
name|ads
operator|->
name|ds_status0
operator|&
name|AR_More
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
return|return
name|HAL_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* AH_SUPPORT_AR5211 */
end_comment

end_unit


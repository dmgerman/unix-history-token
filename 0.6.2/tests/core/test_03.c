begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2014, Juniper Networks, Inc.  * All rights reserved.  * This SOFTWARE is licensed under the LICENSE provided in the  * ../Copyright file. By downloading, installing, copying, or otherwise  * using the SOFTWARE, you agree to be bound by the terms of that  * LICENSE.  * Phil Shafer, July 2014  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"xo.h"
end_include

begin_decl_stmt
name|xo_info_t
name|info
index|[]
init|=
block|{
block|{
literal|"employee"
block|,
literal|"object"
block|,
literal|"Employee data"
block|}
block|,
block|{
literal|"first-name"
block|,
literal|"string"
block|,
literal|"First name of employee"
block|}
block|,
block|{
literal|"last-name"
block|,
literal|"string"
block|,
literal|"Last name of employee"
block|}
block|,
block|{
literal|"department"
block|,
literal|"number"
block|,
literal|"Department number"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|info_count
init|=
operator|(
sizeof|sizeof
argument_list|(
name|info
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|info
index|[
literal|0
index|]
argument_list|)
operator|)
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|unsigned
name|opt_count
init|=
literal|1
decl_stmt|;
name|unsigned
name|opt_extra
init|=
literal|0
decl_stmt|;
struct|struct
name|employee
block|{
specifier|const
name|char
modifier|*
name|e_first
decl_stmt|;
specifier|const
name|char
modifier|*
name|e_last
decl_stmt|;
name|unsigned
name|e_dept
decl_stmt|;
block|}
name|employees
index|[]
init|=
block|{
block|{
literal|"Terry"
block|,
literal|"Jones"
block|,
literal|660
block|}
block|,
block|{
literal|"Leslie"
block|,
literal|"Patterson"
block|,
literal|341
block|}
block|,
block|{
literal|"Ashley"
block|,
literal|"Smith"
block|,
literal|1440
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
struct|,
modifier|*
name|ep
struct|;
name|argc
operator|=
name|xo_parse_args
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|0
condition|)
return|return
literal|1
return|;
for|for
control|(
name|argc
operator|=
literal|1
init|;
name|argv
index|[
name|argc
index|]
condition|;
name|argc
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|argc
index|]
argument_list|,
literal|"count"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argv
index|[
name|argc
operator|+
literal|1
index|]
condition|)
name|opt_count
operator|=
name|atoi
argument_list|(
name|argv
index|[
operator|++
name|argc
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|argc
index|]
argument_list|,
literal|"extra"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argv
index|[
name|argc
operator|+
literal|1
index|]
condition|)
name|opt_extra
operator|=
name|atoi
argument_list|(
name|argv
index|[
operator|++
name|argc
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|xo_set_info
argument_list|(
name|NULL
argument_list|,
name|info
argument_list|,
name|info_count
argument_list|)
expr_stmt|;
name|xo_open_container
argument_list|(
literal|"employees"
argument_list|)
expr_stmt|;
name|xo_open_list
argument_list|(
literal|"employee"
argument_list|)
expr_stmt|;
name|xo_emit
argument_list|(
literal|"[{:extra/%*s}]\n"
argument_list|,
name|opt_extra
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|xo_emit
argument_list|(
literal|"{T:/%13s} {T:/%5s} {T:/%6s} {T:/%7s} {T:/%8s}  {T:Size(s)}\n"
argument_list|,
literal|"Type"
argument_list|,
literal|"InUse"
argument_list|,
literal|"MemUse"
argument_list|,
literal|"HighUse"
argument_list|,
literal|"Requests"
argument_list|)
expr_stmt|;
name|xo_open_list
argument_list|(
literal|"memory"
argument_list|)
expr_stmt|;
name|xo_open_instance
argument_list|(
literal|"memory"
argument_list|)
expr_stmt|;
define|#
directive|define
name|PRIu64
value|"llu"
define|#
directive|define
name|TO_ULL
parameter_list|(
name|_x
parameter_list|)
value|((unsigned long long) _x)
name|xo_emit
argument_list|(
literal|"{k:type/%13s} {:in-use/%5"
name|PRIu64
literal|"} "
literal|"{:memory-use/%5"
name|PRIu64
literal|"}{U:K} {:high-use/%7s} "
literal|"{:requests/%8"
name|PRIu64
literal|"}  "
argument_list|,
literal|"name"
argument_list|,
name|TO_ULL
argument_list|(
literal|12345
argument_list|)
argument_list|,
name|TO_ULL
argument_list|(
literal|54321
argument_list|)
argument_list|,
literal|"-"
argument_list|,
name|TO_ULL
argument_list|(
literal|32145
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|first
init|=
literal|1
decl_stmt|,
name|i
decl_stmt|;
if|#
directive|if
literal|0
block|xo_open_list("size");     for (i = 0; i< 32; i++) { 	if (!first) 	    xo_emit(","); 	xo_emit("{l:size/%d}", 1<< (i + 4)); 	first = 0;     }     xo_close_list("size");
endif|#
directive|endif
name|xo_close_instance
argument_list|(
literal|"memory"
argument_list|)
expr_stmt|;
name|xo_emit
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|xo_close_list
argument_list|(
literal|"memory"
argument_list|)
expr_stmt|;
while|while
condition|(
name|opt_count
operator|--
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|ep
operator|=
name|employees
init|;
name|ep
operator|->
name|e_first
condition|;
name|ep
operator|++
control|)
block|{
name|xo_open_instance
argument_list|(
literal|"employee"
argument_list|)
expr_stmt|;
name|xo_emit
argument_list|(
literal|"{:first-name} {:last-name} works in "
literal|"dept #{:department/%u}\n"
argument_list|,
name|ep
operator|->
name|e_first
argument_list|,
name|ep
operator|->
name|e_last
argument_list|,
name|ep
operator|->
name|e_dept
argument_list|)
expr_stmt|;
name|xo_close_instance
argument_list|(
literal|"employee"
argument_list|)
expr_stmt|;
block|}
block|}
name|xo_emit
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
name|xo_close_list
argument_list|(
literal|"employee"
argument_list|)
expr_stmt|;
name|xo_close_container
argument_list|(
literal|"employees"
argument_list|)
expr_stmt|;
name|xo_finish
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//===-- llvm/CallingConvLower.h - Calling Conventions -----------*- C++ -*-===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file declares the CCState and CCValAssign classes, used for lowering
end_comment

begin_comment
comment|// and implementing calling conventions.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|LLVM_CODEGEN_CALLINGCONVLOWER_H
end_ifndef

begin_define
define|#
directive|define
name|LLVM_CODEGEN_CALLINGCONVLOWER_H
end_define

begin_include
include|#
directive|include
file|"llvm/ADT/SmallVector.h"
end_include

begin_include
include|#
directive|include
file|"llvm/CodeGen/ValueTypes.h"
end_include

begin_include
include|#
directive|include
file|"llvm/Target/TargetCallingConv.h"
end_include

begin_include
include|#
directive|include
file|"llvm/CallingConv.h"
end_include

begin_decl_stmt
name|namespace
name|llvm
block|{
name|class
name|TargetRegisterInfo
decl_stmt|;
name|class
name|TargetMachine
decl_stmt|;
name|class
name|CCState
decl_stmt|;
comment|/// CCValAssign - Represent assignment of one arg/retval to a location.
name|class
name|CCValAssign
block|{
name|public
label|:
enum|enum
name|LocInfo
block|{
name|Full
block|,
comment|// The value fills the full location.
name|SExt
block|,
comment|// The value is sign extended in the location.
name|ZExt
block|,
comment|// The value is zero extended in the location.
name|AExt
block|,
comment|// The value is extended with undefined upper bits.
name|BCvt
block|,
comment|// The value is bit-converted in the location.
name|VExt
block|,
comment|// The value is vector-widened in the location.
comment|// FIXME: Not implemented yet. Code that uses AExt to mean
comment|// vector-widen should be fixed to use VExt instead.
name|Indirect
comment|// The location contains pointer to the value.
comment|// TODO: a subset of the value is in the location.
block|}
enum|;
name|private
label|:
comment|/// ValNo - This is the value number begin assigned (e.g. an argument number).
name|unsigned
name|ValNo
decl_stmt|;
comment|/// Loc is either a stack offset or a register number.
name|unsigned
name|Loc
decl_stmt|;
comment|/// isMem - True if this is a memory loc, false if it is a register loc.
name|bool
name|isMem
range|:
literal|1
decl_stmt|;
comment|/// isCustom - True if this arg/retval requires special handling.
name|bool
name|isCustom
range|:
literal|1
decl_stmt|;
comment|/// Information about how the value is assigned.
name|LocInfo
name|HTP
range|:
literal|6
decl_stmt|;
comment|/// ValVT - The type of the value being assigned.
name|EVT
name|ValVT
decl_stmt|;
comment|/// LocVT - The type of the location being assigned to.
name|EVT
name|LocVT
decl_stmt|;
name|public
label|:
specifier|static
name|CCValAssign
name|getReg
parameter_list|(
name|unsigned
name|ValNo
parameter_list|,
name|EVT
name|ValVT
parameter_list|,
name|unsigned
name|RegNo
parameter_list|,
name|EVT
name|LocVT
parameter_list|,
name|LocInfo
name|HTP
parameter_list|)
block|{
name|CCValAssign
name|Ret
decl_stmt|;
name|Ret
operator|.
name|ValNo
operator|=
name|ValNo
expr_stmt|;
name|Ret
operator|.
name|Loc
operator|=
name|RegNo
expr_stmt|;
name|Ret
operator|.
name|isMem
operator|=
name|false
expr_stmt|;
name|Ret
operator|.
name|isCustom
operator|=
name|false
expr_stmt|;
name|Ret
operator|.
name|HTP
operator|=
name|HTP
expr_stmt|;
name|Ret
operator|.
name|ValVT
operator|=
name|ValVT
expr_stmt|;
name|Ret
operator|.
name|LocVT
operator|=
name|LocVT
expr_stmt|;
return|return
name|Ret
return|;
block|}
specifier|static
name|CCValAssign
name|getCustomReg
parameter_list|(
name|unsigned
name|ValNo
parameter_list|,
name|EVT
name|ValVT
parameter_list|,
name|unsigned
name|RegNo
parameter_list|,
name|EVT
name|LocVT
parameter_list|,
name|LocInfo
name|HTP
parameter_list|)
block|{
name|CCValAssign
name|Ret
decl_stmt|;
name|Ret
operator|=
name|getReg
argument_list|(
name|ValNo
argument_list|,
name|ValVT
argument_list|,
name|RegNo
argument_list|,
name|LocVT
argument_list|,
name|HTP
argument_list|)
expr_stmt|;
name|Ret
operator|.
name|isCustom
operator|=
name|true
expr_stmt|;
return|return
name|Ret
return|;
block|}
specifier|static
name|CCValAssign
name|getMem
parameter_list|(
name|unsigned
name|ValNo
parameter_list|,
name|EVT
name|ValVT
parameter_list|,
name|unsigned
name|Offset
parameter_list|,
name|EVT
name|LocVT
parameter_list|,
name|LocInfo
name|HTP
parameter_list|)
block|{
name|CCValAssign
name|Ret
decl_stmt|;
name|Ret
operator|.
name|ValNo
operator|=
name|ValNo
expr_stmt|;
name|Ret
operator|.
name|Loc
operator|=
name|Offset
expr_stmt|;
name|Ret
operator|.
name|isMem
operator|=
name|true
expr_stmt|;
name|Ret
operator|.
name|isCustom
operator|=
name|false
expr_stmt|;
name|Ret
operator|.
name|HTP
operator|=
name|HTP
expr_stmt|;
name|Ret
operator|.
name|ValVT
operator|=
name|ValVT
expr_stmt|;
name|Ret
operator|.
name|LocVT
operator|=
name|LocVT
expr_stmt|;
return|return
name|Ret
return|;
block|}
specifier|static
name|CCValAssign
name|getCustomMem
parameter_list|(
name|unsigned
name|ValNo
parameter_list|,
name|EVT
name|ValVT
parameter_list|,
name|unsigned
name|Offset
parameter_list|,
name|EVT
name|LocVT
parameter_list|,
name|LocInfo
name|HTP
parameter_list|)
block|{
name|CCValAssign
name|Ret
decl_stmt|;
name|Ret
operator|=
name|getMem
argument_list|(
name|ValNo
argument_list|,
name|ValVT
argument_list|,
name|Offset
argument_list|,
name|LocVT
argument_list|,
name|HTP
argument_list|)
expr_stmt|;
name|Ret
operator|.
name|isCustom
operator|=
name|true
expr_stmt|;
return|return
name|Ret
return|;
block|}
name|unsigned
name|getValNo
argument_list|()
specifier|const
block|{
return|return
name|ValNo
return|;
block|}
name|EVT
name|getValVT
argument_list|()
specifier|const
block|{
return|return
name|ValVT
return|;
block|}
name|bool
name|isRegLoc
argument_list|()
specifier|const
block|{
return|return
operator|!
name|isMem
return|;
block|}
name|bool
name|isMemLoc
argument_list|()
specifier|const
block|{
return|return
name|isMem
return|;
block|}
name|bool
name|needsCustom
argument_list|()
specifier|const
block|{
return|return
name|isCustom
return|;
block|}
name|unsigned
name|getLocReg
argument_list|()
specifier|const
block|{
name|assert
argument_list|(
name|isRegLoc
argument_list|()
argument_list|)
block|;
return|return
name|Loc
return|;
block|}
name|unsigned
name|getLocMemOffset
argument_list|()
specifier|const
block|{
name|assert
argument_list|(
name|isMemLoc
argument_list|()
argument_list|)
block|;
return|return
name|Loc
return|;
block|}
name|EVT
name|getLocVT
argument_list|()
specifier|const
block|{
return|return
name|LocVT
return|;
block|}
name|LocInfo
name|getLocInfo
argument_list|()
specifier|const
block|{
return|return
name|HTP
return|;
block|}
name|bool
name|isExtInLoc
argument_list|()
specifier|const
block|{
return|return
operator|(
name|HTP
operator|==
name|AExt
operator|||
name|HTP
operator|==
name|SExt
operator|||
name|HTP
operator|==
name|ZExt
operator|)
return|;
block|}
block|}
empty_stmt|;
comment|/// CCAssignFn - This function assigns a location for Val, updating State to
comment|/// reflect the change.
typedef|typedef
name|bool
name|CCAssignFn
argument_list|(
name|unsigned
name|ValNo
argument_list|,
name|EVT
name|ValVT
argument_list|,
name|EVT
name|LocVT
argument_list|,
name|CCValAssign
operator|::
name|LocInfo
name|LocInfo
argument_list|,
name|ISD
operator|::
name|ArgFlagsTy
name|ArgFlags
argument_list|,
name|CCState
operator|&
name|State
argument_list|)
typedef|;
comment|/// CCCustomFn - This function assigns a location for Val, possibly updating
comment|/// all args to reflect changes and indicates if it handled it. It must set
comment|/// isCustom if it handles the arg and returns true.
typedef|typedef
name|bool
name|CCCustomFn
argument_list|(
name|unsigned
operator|&
name|ValNo
argument_list|,
name|EVT
operator|&
name|ValVT
argument_list|,
name|EVT
operator|&
name|LocVT
argument_list|,
name|CCValAssign
operator|::
name|LocInfo
operator|&
name|LocInfo
argument_list|,
name|ISD
operator|::
name|ArgFlagsTy
operator|&
name|ArgFlags
argument_list|,
name|CCState
operator|&
name|State
argument_list|)
typedef|;
comment|/// CCState - This class holds information needed while lowering arguments and
comment|/// return values.  It captures which registers are already assigned and which
comment|/// stack slots are used.  It provides accessors to allocate these values.
name|class
name|CCState
block|{
name|CallingConv
operator|::
name|ID
name|CallingConv
expr_stmt|;
name|bool
name|IsVarArg
decl_stmt|;
specifier|const
name|TargetMachine
modifier|&
name|TM
decl_stmt|;
specifier|const
name|TargetRegisterInfo
modifier|&
name|TRI
decl_stmt|;
name|SmallVector
operator|<
name|CCValAssign
operator|,
literal|16
operator|>
operator|&
name|Locs
expr_stmt|;
name|LLVMContext
modifier|&
name|Context
decl_stmt|;
name|unsigned
name|StackOffset
decl_stmt|;
name|SmallVector
operator|<
name|uint32_t
operator|,
literal|16
operator|>
name|UsedRegs
expr_stmt|;
name|public
label|:
name|CCState
argument_list|(
argument|CallingConv::ID CC
argument_list|,
argument|bool isVarArg
argument_list|,
argument|const TargetMachine&TM
argument_list|,
argument|SmallVector<CCValAssign
argument_list|,
literal|16
argument|>&locs
argument_list|,
argument|LLVMContext&C
argument_list|)
empty_stmt|;
name|void
name|addLoc
parameter_list|(
specifier|const
name|CCValAssign
modifier|&
name|V
parameter_list|)
block|{
name|Locs
operator|.
name|push_back
argument_list|(
name|V
argument_list|)
expr_stmt|;
block|}
name|LLVMContext
operator|&
name|getContext
argument_list|()
specifier|const
block|{
return|return
name|Context
return|;
block|}
specifier|const
name|TargetMachine
operator|&
name|getTarget
argument_list|()
specifier|const
block|{
return|return
name|TM
return|;
block|}
name|CallingConv
operator|::
name|ID
name|getCallingConv
argument_list|()
specifier|const
block|{
return|return
name|CallingConv
return|;
block|}
name|bool
name|isVarArg
argument_list|()
specifier|const
block|{
return|return
name|IsVarArg
return|;
block|}
name|unsigned
name|getNextStackOffset
argument_list|()
specifier|const
block|{
return|return
name|StackOffset
return|;
block|}
comment|/// isAllocated - Return true if the specified register (or an alias) is
comment|/// allocated.
name|bool
name|isAllocated
argument_list|(
name|unsigned
name|Reg
argument_list|)
decl|const
block|{
return|return
name|UsedRegs
index|[
name|Reg
operator|/
literal|32
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|Reg
operator|&
literal|31
operator|)
operator|)
return|;
block|}
comment|/// AnalyzeFormalArguments - Analyze an array of argument values,
comment|/// incorporating info about the formals into this state.
name|void
name|AnalyzeFormalArguments
argument_list|(
specifier|const
name|SmallVectorImpl
operator|<
name|ISD
operator|::
name|InputArg
operator|>
operator|&
name|Ins
argument_list|,
name|CCAssignFn
name|Fn
argument_list|)
decl_stmt|;
comment|/// AnalyzeReturn - Analyze the returned values of a return,
comment|/// incorporating info about the result values into this state.
name|void
name|AnalyzeReturn
argument_list|(
specifier|const
name|SmallVectorImpl
operator|<
name|ISD
operator|::
name|OutputArg
operator|>
operator|&
name|Outs
argument_list|,
name|CCAssignFn
name|Fn
argument_list|)
decl_stmt|;
comment|/// CheckReturn - Analyze the return values of a function, returning
comment|/// true if the return can be performed without sret-demotion, and
comment|/// false otherwise.
name|bool
name|CheckReturn
argument_list|(
specifier|const
name|SmallVectorImpl
operator|<
name|ISD
operator|::
name|OutputArg
operator|>
operator|&
name|ArgsFlags
argument_list|,
name|CCAssignFn
name|Fn
argument_list|)
decl_stmt|;
comment|/// AnalyzeCallOperands - Analyze the outgoing arguments to a call,
comment|/// incorporating info about the passed values into this state.
name|void
name|AnalyzeCallOperands
argument_list|(
specifier|const
name|SmallVectorImpl
operator|<
name|ISD
operator|::
name|OutputArg
operator|>
operator|&
name|Outs
argument_list|,
name|CCAssignFn
name|Fn
argument_list|)
decl_stmt|;
comment|/// AnalyzeCallOperands - Same as above except it takes vectors of types
comment|/// and argument flags.
name|void
name|AnalyzeCallOperands
argument_list|(
name|SmallVectorImpl
operator|<
name|EVT
operator|>
operator|&
name|ArgVTs
argument_list|,
name|SmallVectorImpl
operator|<
name|ISD
operator|::
name|ArgFlagsTy
operator|>
operator|&
name|Flags
argument_list|,
name|CCAssignFn
name|Fn
argument_list|)
decl_stmt|;
comment|/// AnalyzeCallResult - Analyze the return values of a call,
comment|/// incorporating info about the passed values into this state.
name|void
name|AnalyzeCallResult
argument_list|(
specifier|const
name|SmallVectorImpl
operator|<
name|ISD
operator|::
name|InputArg
operator|>
operator|&
name|Ins
argument_list|,
name|CCAssignFn
name|Fn
argument_list|)
decl_stmt|;
comment|/// AnalyzeCallResult - Same as above except it's specialized for calls which
comment|/// produce a single value.
name|void
name|AnalyzeCallResult
parameter_list|(
name|EVT
name|VT
parameter_list|,
name|CCAssignFn
name|Fn
parameter_list|)
function_decl|;
comment|/// getFirstUnallocated - Return the first unallocated register in the set, or
comment|/// NumRegs if they are all allocated.
name|unsigned
name|getFirstUnallocated
argument_list|(
specifier|const
name|unsigned
operator|*
name|Regs
argument_list|,
name|unsigned
name|NumRegs
argument_list|)
decl|const
block|{
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|;
name|i
operator|!=
name|NumRegs
condition|;
operator|++
name|i
control|)
if|if
condition|(
operator|!
name|isAllocated
argument_list|(
name|Regs
index|[
name|i
index|]
argument_list|)
condition|)
return|return
name|i
return|;
return|return
name|NumRegs
return|;
block|}
comment|/// AllocateReg - Attempt to allocate one register.  If it is not available,
comment|/// return zero.  Otherwise, return the register, marking it and any aliases
comment|/// as allocated.
name|unsigned
name|AllocateReg
parameter_list|(
name|unsigned
name|Reg
parameter_list|)
block|{
if|if
condition|(
name|isAllocated
argument_list|(
name|Reg
argument_list|)
condition|)
return|return
literal|0
return|;
name|MarkAllocated
argument_list|(
name|Reg
argument_list|)
expr_stmt|;
return|return
name|Reg
return|;
block|}
comment|/// Version of AllocateReg with extra register to be shadowed.
name|unsigned
name|AllocateReg
parameter_list|(
name|unsigned
name|Reg
parameter_list|,
name|unsigned
name|ShadowReg
parameter_list|)
block|{
if|if
condition|(
name|isAllocated
argument_list|(
name|Reg
argument_list|)
condition|)
return|return
literal|0
return|;
name|MarkAllocated
argument_list|(
name|Reg
argument_list|)
expr_stmt|;
name|MarkAllocated
argument_list|(
name|ShadowReg
argument_list|)
expr_stmt|;
return|return
name|Reg
return|;
block|}
comment|/// AllocateReg - Attempt to allocate one of the specified registers.  If none
comment|/// are available, return zero.  Otherwise, return the first one available,
comment|/// marking it and any aliases as allocated.
name|unsigned
name|AllocateReg
parameter_list|(
specifier|const
name|unsigned
modifier|*
name|Regs
parameter_list|,
name|unsigned
name|NumRegs
parameter_list|)
block|{
name|unsigned
name|FirstUnalloc
init|=
name|getFirstUnallocated
argument_list|(
name|Regs
argument_list|,
name|NumRegs
argument_list|)
decl_stmt|;
if|if
condition|(
name|FirstUnalloc
operator|==
name|NumRegs
condition|)
return|return
literal|0
return|;
comment|// Didn't find the reg.
comment|// Mark the register and any aliases as allocated.
name|unsigned
name|Reg
init|=
name|Regs
index|[
name|FirstUnalloc
index|]
decl_stmt|;
name|MarkAllocated
argument_list|(
name|Reg
argument_list|)
expr_stmt|;
return|return
name|Reg
return|;
block|}
comment|/// Version of AllocateReg with list of registers to be shadowed.
name|unsigned
name|AllocateReg
parameter_list|(
specifier|const
name|unsigned
modifier|*
name|Regs
parameter_list|,
specifier|const
name|unsigned
modifier|*
name|ShadowRegs
parameter_list|,
name|unsigned
name|NumRegs
parameter_list|)
block|{
name|unsigned
name|FirstUnalloc
init|=
name|getFirstUnallocated
argument_list|(
name|Regs
argument_list|,
name|NumRegs
argument_list|)
decl_stmt|;
if|if
condition|(
name|FirstUnalloc
operator|==
name|NumRegs
condition|)
return|return
literal|0
return|;
comment|// Didn't find the reg.
comment|// Mark the register and any aliases as allocated.
name|unsigned
name|Reg
init|=
name|Regs
index|[
name|FirstUnalloc
index|]
decl_stmt|,
name|ShadowReg
init|=
name|ShadowRegs
index|[
name|FirstUnalloc
index|]
decl_stmt|;
name|MarkAllocated
argument_list|(
name|Reg
argument_list|)
expr_stmt|;
name|MarkAllocated
argument_list|(
name|ShadowReg
argument_list|)
expr_stmt|;
return|return
name|Reg
return|;
block|}
comment|/// AllocateStack - Allocate a chunk of stack space with the specified size
comment|/// and alignment.
name|unsigned
name|AllocateStack
parameter_list|(
name|unsigned
name|Size
parameter_list|,
name|unsigned
name|Align
parameter_list|)
block|{
name|assert
argument_list|(
name|Align
operator|&&
operator|(
operator|(
name|Align
operator|-
literal|1
operator|)
operator|&
name|Align
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|// Align is power of 2.
name|StackOffset
operator|=
operator|(
operator|(
name|StackOffset
operator|+
name|Align
operator|-
literal|1
operator|)
operator|&
operator|~
operator|(
name|Align
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|unsigned
name|Result
init|=
name|StackOffset
decl_stmt|;
name|StackOffset
operator|+=
name|Size
expr_stmt|;
return|return
name|Result
return|;
block|}
comment|// HandleByVal - Allocate a stack slot large enough to pass an argument by
comment|// value. The size and alignment information of the argument is encoded in its
comment|// parameter attribute.
name|void
name|HandleByVal
argument_list|(
name|unsigned
name|ValNo
argument_list|,
name|EVT
name|ValVT
argument_list|,
name|EVT
name|LocVT
argument_list|,
name|CCValAssign
operator|::
name|LocInfo
name|LocInfo
argument_list|,
name|int
name|MinSize
argument_list|,
name|int
name|MinAlign
argument_list|,
name|ISD
operator|::
name|ArgFlagsTy
name|ArgFlags
argument_list|)
decl_stmt|;
name|private
label|:
comment|/// MarkAllocated - Mark a register and all of its aliases as allocated.
name|void
name|MarkAllocated
parameter_list|(
name|unsigned
name|Reg
parameter_list|)
function_decl|;
block|}
empty_stmt|;
block|}
end_decl_stmt

begin_comment
comment|// end namespace llvm
end_comment

begin_endif
endif|#
directive|endif
end_endif

end_unit


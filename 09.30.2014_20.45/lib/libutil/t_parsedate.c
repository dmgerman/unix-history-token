begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $NetBSD: t_parsedate.c,v 1.7 2013/01/19 15:21:43 apb Exp $ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2010 The NetBSD Foundation, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE  * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$NetBSD: t_parsedate.c,v 1.7 2013/01/19 15:21:43 apb Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<atf-c.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<util.h>
end_include

begin_expr_stmt
name|ATF_TC
argument_list|(
name|dates
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|dates
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test unambiguous dates"
literal|" (PR lib/44255)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|dates
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"69-09-10"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"2006-11-17"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"10/1/2000"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"20 Jun 1994"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"23jun2001"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"1-sep-06"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"1/11"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"1500-01-02"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"9999-12-21"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|times
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|times
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test times"
literal|" (PR lib/44255)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|times
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"10:01"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"10:12pm"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"12:11:01.000012"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"12:21-0500"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|relative
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|relative
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test relative items"
literal|" (PR lib/44255)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|relative
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"-1 month"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"last friday"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"one week ago"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"this thursday"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"next sunday"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"+2 years"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|atsecs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|atsecs
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test seconds past the epoch"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|atsecs
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|tzoff
decl_stmt|;
comment|/* "@0" -> (time_t)0, regardless of timezone */
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|putenv
argument_list|(
name|__UNCONST
argument_list|(
literal|"TZ=Europe/Berlin"
argument_list|)
argument_list|)
expr_stmt|;
name|tzset
argument_list|()
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|putenv
argument_list|(
name|__UNCONST
argument_list|(
literal|"TZ=America/New_York"
argument_list|)
argument_list|)
expr_stmt|;
name|tzset
argument_list|()
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|tzoff
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
operator|&
name|tzoff
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|tzoff
operator|=
literal|3600
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
operator|&
name|tzoff
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|tzoff
operator|=
operator|-
literal|3600
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
operator|&
name|tzoff
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|/* -1 or other negative numbers are not errors */
name|errno
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@-1"
argument_list|,
name|NULL
argument_list|,
operator|&
name|tzoff
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
operator|&&
name|errno
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@-2"
argument_list|,
name|NULL
argument_list|,
operator|&
name|tzoff
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|2
operator|&&
name|errno
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* junk is an error */
name|errno
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@junk"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
operator|&&
name|errno
operator|!=
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TP_ADD_TCS
argument_list|(
argument|tp
argument_list|)
end_macro

begin_block
block|{
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|dates
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|times
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|relative
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|atsecs
argument_list|)
expr_stmt|;
return|return
name|atf_no_error
argument_list|()
return|;
block|}
end_block

end_unit


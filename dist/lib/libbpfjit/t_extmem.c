begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: t_extmem.c,v 1.3 2014/07/14 19:11:15 alnsn Exp $ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2014 Alexander Nasonov.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE  * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$NetBSD: t_extmem.c,v 1.3 2014/07/14 19:11:15 alnsn Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<atf-c.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_define
define|#
directive|define
name|__BPF_PRIVATE
end_define

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/bpfjit.h>
end_include

begin_function_decl
specifier|static
name|uint32_t
name|retM
parameter_list|(
specifier|const
name|bpf_ctx_t
modifier|*
name|bc
parameter_list|,
name|bpf_args_t
modifier|*
name|args
parameter_list|,
name|uint32_t
name|A
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|bpf_copfunc_t
name|copfuncs
index|[]
init|=
block|{
operator|&
name|retM
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|bpf_ctx_t
name|ctx
init|=
block|{
operator|.
name|copfuncs
operator|=
name|copfuncs
block|,
operator|.
name|nfuncs
operator|=
sizeof|sizeof
argument_list|(
name|copfuncs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|copfuncs
index|[
literal|0
index|]
argument_list|)
block|,
operator|.
name|extwords
operator|=
literal|4
block|,
operator|.
name|preinited
operator|=
name|BPF_MEMWORD_INIT
argument_list|(
literal|0
argument_list|)
operator||
name|BPF_MEMWORD_INIT
argument_list|(
literal|3
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|uint32_t
name|retM
parameter_list|(
specifier|const
name|bpf_ctx_t
modifier|*
name|bc
parameter_list|,
name|bpf_args_t
modifier|*
name|args
parameter_list|,
name|uint32_t
name|A
parameter_list|)
block|{
return|return
name|args
operator|->
name|mem
index|[
operator|(
name|uintptr_t
operator|)
name|args
operator|->
name|arg
index|]
return|;
block|}
end_function

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_extmem_load_default
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_extmem_load_default
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test that external memory "
literal|"is zero initialized by default"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_extmem_load_default
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_MEM
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|mem
index|[
name|ctx
operator|.
name|extwords
index|]
decl_stmt|;
comment|/* Pre-inited words. */
name|mem
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|mem
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
name|bpf_args_t
name|args
init|=
block|{
operator|.
name|pkt
operator|=
name|pkt
block|,
operator|.
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|wirelen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|mem
operator|=
name|mem
block|, 	}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
operator|&
name|ctx
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|code
argument_list|(
operator|&
name|ctx
argument_list|,
operator|&
name|args
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_extmem_load_preinited
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_extmem_load_preinited
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test a load of external "
literal|"pre-initialized memory"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_extmem_load_preinited
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_MEM
argument_list|,
literal|3
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|mem
index|[
name|ctx
operator|.
name|extwords
index|]
decl_stmt|;
comment|/* Pre-inited words. */
name|mem
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|mem
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
name|bpf_args_t
name|args
init|=
block|{
operator|.
name|pkt
operator|=
name|pkt
block|,
operator|.
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|wirelen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|mem
operator|=
name|mem
block|, 	}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
operator|&
name|ctx
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|code
argument_list|(
operator|&
name|ctx
argument_list|,
operator|&
name|args
argument_list|)
operator|==
literal|3
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_extmem_invalid_load
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_extmem_invalid_load
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test that out-of-range load "
literal|"fails validation"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_extmem_invalid_load
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_MEM
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpfjit_generate_code
argument_list|(
operator|&
name|ctx
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_extmem_store
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_extmem_store
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test stores to external memory"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_extmem_store
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|1
argument_list|)
block|,
comment|/* A<- 1     */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|2
argument_list|)
block|,
comment|/* X<- 2     */
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|1
argument_list|)
block|,
comment|/* M[1]<- A  */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* A<- A + X */
name|BPF_STMT
argument_list|(
name|BPF_STX
argument_list|,
literal|2
argument_list|)
block|,
comment|/* M[2]<- X  */
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|3
argument_list|)
block|,
comment|/* M[3]<- A  */
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
comment|/* ret A      */
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|mem
index|[
name|ctx
operator|.
name|extwords
index|]
decl_stmt|;
comment|/* Pre-inited words. */
name|mem
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|mem
index|[
literal|3
index|]
operator|=
literal|7
expr_stmt|;
name|mem
index|[
literal|1
index|]
operator|=
name|mem
index|[
literal|2
index|]
operator|=
literal|0xdeadbeef
expr_stmt|;
name|bpf_args_t
name|args
init|=
block|{
operator|.
name|pkt
operator|=
name|pkt
block|,
operator|.
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|wirelen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|mem
operator|=
name|mem
block|, 	}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
operator|&
name|ctx
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|code
argument_list|(
operator|&
name|ctx
argument_list|,
operator|&
name|args
argument_list|)
operator|==
literal|3
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|mem
index|[
literal|0
index|]
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|mem
index|[
literal|1
index|]
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|mem
index|[
literal|2
index|]
operator|==
literal|2
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|mem
index|[
literal|3
index|]
operator|==
literal|3
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_extmem_side_effect
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_extmem_side_effect
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test that ABC optimization doesn\'t "
literal|"skip stores to external memory"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_extmem_side_effect
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|0
argument_list|)
block|,
comment|/* A<- P[0]  */
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_W
operator|+
name|BPF_IMM
argument_list|,
literal|2
argument_list|)
block|,
comment|/* X<- 2     */
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|1
argument_list|)
block|,
comment|/* M[1]<- A  */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator|+
name|BPF_ADD
operator|+
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* A<- A + X */
name|BPF_STMT
argument_list|(
name|BPF_STX
argument_list|,
literal|2
argument_list|)
block|,
comment|/* M[2]<- X  */
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|3
argument_list|)
block|,
comment|/* M[3]<- A  */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_B
operator|+
name|BPF_ABS
argument_list|,
literal|99
argument_list|)
block|,
comment|/* A<- P[99] */
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
comment|/* ret A      */
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
init|=
block|{
literal|1
block|}
decl_stmt|;
name|uint32_t
name|mem
index|[
name|ctx
operator|.
name|extwords
index|]
decl_stmt|;
comment|/* Pre-inited words. */
name|mem
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|mem
index|[
literal|3
index|]
operator|=
literal|7
expr_stmt|;
name|mem
index|[
literal|1
index|]
operator|=
name|mem
index|[
literal|2
index|]
operator|=
literal|0xdeadbeef
expr_stmt|;
name|bpf_args_t
name|args
init|=
block|{
operator|.
name|pkt
operator|=
name|pkt
block|,
operator|.
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|wirelen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|mem
operator|=
name|mem
block|, 	}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
operator|&
name|ctx
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|code
argument_list|(
operator|&
name|ctx
argument_list|,
operator|&
name|args
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|mem
index|[
literal|0
index|]
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|mem
index|[
literal|1
index|]
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|mem
index|[
literal|2
index|]
operator|==
literal|2
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|mem
index|[
literal|3
index|]
operator|==
literal|3
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_extmem_invalid_store
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_extmem_invalid_store
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test that out-of-range store "
literal|"fails validation"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_extmem_invalid_store
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|ATF_CHECK
argument_list|(
name|bpfjit_generate_code
argument_list|(
operator|&
name|ctx
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_cop_ret_mem
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_cop_ret_mem
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test coprocessor function "
literal|"that returns a content of external memory word"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_cop_ret_mem
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|13
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|137
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator|+
name|BPF_COP
argument_list|,
literal|0
argument_list|)
block|,
comment|// retM
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|mem
index|[
name|ctx
operator|.
name|extwords
index|]
decl_stmt|;
name|void
modifier|*
name|arg
init|=
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|2
decl_stmt|;
comment|/* Pre-inited words. */
name|mem
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|mem
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
name|bpf_args_t
name|args
init|=
block|{
operator|.
name|pkt
operator|=
name|pkt
block|,
operator|.
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|wirelen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|arg
operator|=
name|arg
block|,
operator|.
name|mem
operator|=
name|mem
block|, 	}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
operator|&
name|ctx
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|code
argument_list|(
operator|&
name|ctx
argument_list|,
operator|&
name|args
argument_list|)
operator|==
literal|13
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_cop_ret_preinited_mem
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_cop_ret_preinited_mem
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test coprocessor function that "
literal|"returns a content of external pre-initialized memory word"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_cop_ret_preinited_mem
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|13
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|137
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator|+
name|BPF_COP
argument_list|,
literal|0
argument_list|)
block|,
comment|// retM
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|mem
index|[
name|ctx
operator|.
name|extwords
index|]
decl_stmt|;
name|void
modifier|*
name|arg
init|=
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|3
decl_stmt|;
comment|/* Pre-inited words. */
name|mem
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|mem
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
name|bpf_args_t
name|args
init|=
block|{
operator|.
name|pkt
operator|=
name|pkt
block|,
operator|.
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|wirelen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|arg
operator|=
name|arg
block|,
operator|.
name|mem
operator|=
name|mem
block|, 	}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
operator|&
name|ctx
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|code
argument_list|(
operator|&
name|ctx
argument_list|,
operator|&
name|args
argument_list|)
operator|==
literal|3
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_copx_ret_mem
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_copx_ret_mem
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test coprocessor function "
literal|"that returns a content of external memory word"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_copx_ret_mem
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|13
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|137
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_IMM
argument_list|,
literal|0
argument_list|)
block|,
comment|// retM
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator|+
name|BPF_COPX
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|mem
index|[
name|ctx
operator|.
name|extwords
index|]
decl_stmt|;
name|void
modifier|*
name|arg
init|=
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|2
decl_stmt|;
comment|/* Pre-inited words. */
name|mem
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|mem
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
name|bpf_args_t
name|args
init|=
block|{
operator|.
name|pkt
operator|=
name|pkt
block|,
operator|.
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|wirelen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|arg
operator|=
name|arg
block|,
operator|.
name|mem
operator|=
name|mem
block|, 	}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
operator|&
name|ctx
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|code
argument_list|(
operator|&
name|ctx
argument_list|,
operator|&
name|args
argument_list|)
operator|==
literal|13
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|libbpfjit_copx_ret_preinited_mem
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|libbpfjit_copx_ret_preinited_mem
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test coprocessor function that "
literal|"returns a content of external pre-initialized memory word"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|libbpfjit_copx_ret_preinited_mem
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|struct
name|bpf_insn
name|insns
index|[]
init|=
block|{
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|13
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|2
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator|+
name|BPF_IMM
argument_list|,
literal|137
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_ST
argument_list|,
literal|1
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LDX
operator|+
name|BPF_IMM
argument_list|,
literal|0
argument_list|)
block|,
comment|// retM
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator|+
name|BPF_COPX
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_STMT
argument_list|(
argument|BPF_RET+BPF_A
argument_list|,
literal|0
argument_list|)
block|}
decl_stmt|;
name|bpfjit_func_t
name|code
decl_stmt|;
name|uint8_t
name|pkt
index|[
literal|1
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|mem
index|[
name|ctx
operator|.
name|extwords
index|]
decl_stmt|;
name|void
modifier|*
name|arg
init|=
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|3
decl_stmt|;
comment|/* Pre-inited words. */
name|mem
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|mem
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
name|bpf_args_t
name|args
init|=
block|{
operator|.
name|pkt
operator|=
name|pkt
block|,
operator|.
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|wirelen
operator|=
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
block|,
operator|.
name|arg
operator|=
name|arg
block|,
operator|.
name|mem
operator|=
name|mem
block|, 	}
decl_stmt|;
name|size_t
name|insn_count
init|=
sizeof|sizeof
argument_list|(
name|insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|insns
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|code
operator|=
name|bpfjit_generate_code
argument_list|(
operator|&
name|ctx
argument_list|,
name|insns
argument_list|,
name|insn_count
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|code
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|code
argument_list|(
operator|&
name|ctx
argument_list|,
operator|&
name|args
argument_list|)
operator|==
literal|3
argument_list|)
expr_stmt|;
name|bpfjit_free_code
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TP_ADD_TCS
argument_list|(
argument|tp
argument_list|)
end_macro

begin_block
block|{
comment|/* 	 * For every new test please also add a similar test 	 * to ../../net/bpfjit/t_extmem.c 	 */
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_extmem_load_default
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_extmem_load_preinited
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_extmem_invalid_load
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_extmem_store
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_extmem_side_effect
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_extmem_invalid_store
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_cop_ret_mem
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_cop_ret_preinited_mem
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_copx_ret_mem
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|libbpfjit_copx_ret_preinited_mem
argument_list|)
expr_stmt|;
return|return
name|atf_no_error
argument_list|()
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $NetBSD: t_strchr.c,v 1.2 2017/01/10 15:34:49 christos Exp $ */
end_comment

begin_comment
comment|/*  * Written by J.T. Conklin<jtc@acorntoolworks.com>  * Public domain.  */
end_comment

begin_include
include|#
directive|include
file|<atf-c.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_function_decl
specifier|static
name|char
modifier|*
name|slow_strchr
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|verify_strchr
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|unsigned
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
name|char
argument_list|*
operator|(
operator|*
specifier|volatile
name|strchr_fn
operator|)
operator|(
specifier|const
name|char
operator|*
operator|,
name|int
operator|)
argument_list|;
specifier|static
name|char
operator|*
name|slow_strchr
argument_list|(
argument|char *buf
argument_list|,
argument|int ch
argument_list|)
block|{
name|unsigned
name|char
name|c
operator|=
literal|1
block|;
name|ch
operator|&=
literal|0xff
block|;
for|for
control|(
init|;
name|c
operator|!=
literal|0
condition|;
name|buf
operator|++
control|)
block|{
name|c
operator|=
operator|*
name|buf
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|ch
condition|)
return|return
name|buf
return|;
block|}
return|return
literal|0
return|;
end_expr_stmt

begin_function
unit|}  static
name|void
name|verify_strchr
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|ch
parameter_list|,
name|unsigned
name|int
name|t
parameter_list|,
name|unsigned
name|int
name|a
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|off
decl_stmt|,
modifier|*
name|ok_off
decl_stmt|;
name|off
operator|=
name|strchr_fn
argument_list|(
name|buf
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|ok_off
operator|=
name|slow_strchr
argument_list|(
name|buf
argument_list|,
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|off
operator|==
name|ok_off
condition|)
return|return;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"test_strchr(\"%s\", %#x) gave %zd not %zd (test %d, "
literal|"alignment %d)\n"
argument_list|,
name|buf
argument_list|,
name|ch
argument_list|,
name|off
condition|?
name|off
operator|-
name|buf
else|:
operator|-
literal|1
argument_list|,
name|ok_off
condition|?
name|ok_off
operator|-
name|buf
else|:
operator|-
literal|1
argument_list|,
name|t
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"Check stderr for details"
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|ATF_TC
argument_list|(
name|strchr_basic
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|strchr_basic
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test strchr(3) results"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|strchr_basic
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|void
modifier|*
name|dl_handle
decl_stmt|;
name|char
modifier|*
name|off
decl_stmt|;
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|unsigned
name|int
name|t
decl_stmt|,
name|a
decl_stmt|;
specifier|const
name|char
modifier|*
name|tab
index|[]
init|=
block|{
literal|""
block|,
literal|"a"
block|,
literal|"aa"
block|,
literal|"abc"
block|,
literal|"abcd"
block|,
literal|"abcde"
block|,
literal|"abcdef"
block|,
literal|"abcdefg"
block|,
literal|"abcdefgh"
block|,
literal|"/"
block|,
literal|"//"
block|,
literal|"/a"
block|,
literal|"/a/"
block|,
literal|"/ab"
block|,
literal|"/ab/"
block|,
literal|"/abc"
block|,
literal|"/abc/"
block|,
literal|"/abcd"
block|,
literal|"/abcd/"
block|,
literal|"/abcde"
block|,
literal|"/abcde/"
block|,
literal|"/abcdef"
block|,
literal|"/abcdef/"
block|,
literal|"/abcdefg"
block|,
literal|"/abcdefg/"
block|,
literal|"/abcdefgh"
block|,
literal|"/abcdefgh/"
block|,
literal|"a/"
block|,
literal|"a//"
block|,
literal|"a/a"
block|,
literal|"a/a/"
block|,
literal|"a/ab"
block|,
literal|"a/ab/"
block|,
literal|"a/abc"
block|,
literal|"a/abc/"
block|,
literal|"a/abcd"
block|,
literal|"a/abcd/"
block|,
literal|"a/abcde"
block|,
literal|"a/abcde/"
block|,
literal|"a/abcdef"
block|,
literal|"a/abcdef/"
block|,
literal|"a/abcdefg"
block|,
literal|"a/abcdefg/"
block|,
literal|"a/abcdefgh"
block|,
literal|"a/abcdefgh/"
block|,
literal|"ab/"
block|,
literal|"ab//"
block|,
literal|"ab/a"
block|,
literal|"ab/a/"
block|,
literal|"ab/ab"
block|,
literal|"ab/ab/"
block|,
literal|"ab/abc"
block|,
literal|"ab/abc/"
block|,
literal|"ab/abcd"
block|,
literal|"ab/abcd/"
block|,
literal|"ab/abcde"
block|,
literal|"ab/abcde/"
block|,
literal|"ab/abcdef"
block|,
literal|"ab/abcdef/"
block|,
literal|"ab/abcdefg"
block|,
literal|"ab/abcdefg/"
block|,
literal|"ab/abcdefgh"
block|,
literal|"ab/abcdefgh/"
block|,
literal|"abc/"
block|,
literal|"abc//"
block|,
literal|"abc/a"
block|,
literal|"abc/a/"
block|,
literal|"abc/ab"
block|,
literal|"abc/ab/"
block|,
literal|"abc/abc"
block|,
literal|"abc/abc/"
block|,
literal|"abc/abcd"
block|,
literal|"abc/abcd/"
block|,
literal|"abc/abcde"
block|,
literal|"abc/abcde/"
block|,
literal|"abc/abcdef"
block|,
literal|"abc/abcdef/"
block|,
literal|"abc/abcdefg"
block|,
literal|"abc/abcdefg/"
block|,
literal|"abc/abcdefgh"
block|,
literal|"abc/abcdefgh/"
block|,
literal|"abcd/"
block|,
literal|"abcd//"
block|,
literal|"abcd/a"
block|,
literal|"abcd/a/"
block|,
literal|"abcd/ab"
block|,
literal|"abcd/ab/"
block|,
literal|"abcd/abc"
block|,
literal|"abcd/abc/"
block|,
literal|"abcd/abcd"
block|,
literal|"abcd/abcd/"
block|,
literal|"abcd/abcde"
block|,
literal|"abcd/abcde/"
block|,
literal|"abcd/abcdef"
block|,
literal|"abcd/abcdef/"
block|,
literal|"abcd/abcdefg"
block|,
literal|"abcd/abcdefg/"
block|,
literal|"abcd/abcdefgh"
block|,
literal|"abcd/abcdefgh/"
block|,
literal|"abcde/"
block|,
literal|"abcde//"
block|,
literal|"abcde/a"
block|,
literal|"abcde/a/"
block|,
literal|"abcde/ab"
block|,
literal|"abcde/ab/"
block|,
literal|"abcde/abc"
block|,
literal|"abcde/abc/"
block|,
literal|"abcde/abcd"
block|,
literal|"abcde/abcd/"
block|,
literal|"abcde/abcde"
block|,
literal|"abcde/abcde/"
block|,
literal|"abcde/abcdef"
block|,
literal|"abcde/abcdef/"
block|,
literal|"abcde/abcdefg"
block|,
literal|"abcde/abcdefg/"
block|,
literal|"abcde/abcdefgh"
block|,
literal|"abcde/abcdefgh/"
block|,
literal|"abcdef/"
block|,
literal|"abcdef//"
block|,
literal|"abcdef/a"
block|,
literal|"abcdef/a/"
block|,
literal|"abcdef/ab"
block|,
literal|"abcdef/ab/"
block|,
literal|"abcdef/abc"
block|,
literal|"abcdef/abc/"
block|,
literal|"abcdef/abcd"
block|,
literal|"abcdef/abcd/"
block|,
literal|"abcdef/abcde"
block|,
literal|"abcdef/abcde/"
block|,
literal|"abcdef/abcdef"
block|,
literal|"abcdef/abcdef/"
block|,
literal|"abcdef/abcdefg"
block|,
literal|"abcdef/abcdefg/"
block|,
literal|"abcdef/abcdefgh"
block|,
literal|"abcdef/abcdefgh/"
block|,
literal|"abcdefg/"
block|,
literal|"abcdefg//"
block|,
literal|"abcdefg/a"
block|,
literal|"abcdefg/a/"
block|,
literal|"abcdefg/ab"
block|,
literal|"abcdefg/ab/"
block|,
literal|"abcdefg/abc"
block|,
literal|"abcdefg/abc/"
block|,
literal|"abcdefg/abcd"
block|,
literal|"abcdefg/abcd/"
block|,
literal|"abcdefg/abcde"
block|,
literal|"abcdefg/abcde/"
block|,
literal|"abcdefg/abcdef"
block|,
literal|"abcdefg/abcdef/"
block|,
literal|"abcdefg/abcdefg"
block|,
literal|"abcdefg/abcdefg/"
block|,
literal|"abcdefg/abcdefgh"
block|,
literal|"abcdefg/abcdefgh/"
block|,
literal|"abcdefgh/"
block|,
literal|"abcdefgh//"
block|,
literal|"abcdefgh/a"
block|,
literal|"abcdefgh/a/"
block|,
literal|"abcdefgh/ab"
block|,
literal|"abcdefgh/ab/"
block|,
literal|"abcdefgh/abc"
block|,
literal|"abcdefgh/abc/"
block|,
literal|"abcdefgh/abcd"
block|,
literal|"abcdefgh/abcd/"
block|,
literal|"abcdefgh/abcde"
block|,
literal|"abcdefgh/abcde/"
block|,
literal|"abcdefgh/abcdef"
block|,
literal|"abcdefgh/abcdef/"
block|,
literal|"abcdefgh/abcdefg"
block|,
literal|"abcdefgh/abcdefg/"
block|,
literal|"abcdefgh/abcdefgh"
block|,
literal|"abcdefgh/abcdefgh/"
block|, 	}
decl_stmt|;
name|dl_handle
operator|=
name|dlopen
argument_list|(
name|NULL
argument_list|,
name|RTLD_LAZY
argument_list|)
expr_stmt|;
name|strchr_fn
operator|=
name|dlsym
argument_list|(
name|dl_handle
argument_list|,
literal|"test_strlen"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strchr_fn
condition|)
name|strchr_fn
operator|=
name|strchr
expr_stmt|;
for|for
control|(
name|a
operator|=
literal|3
init|;
name|a
operator|<
literal|3
operator|+
sizeof|sizeof
argument_list|(
name|long
argument_list|)
condition|;
operator|++
name|a
control|)
block|{
comment|/* Put char and a \0 before the buffer */
name|buf
index|[
name|a
operator|-
literal|1
index|]
operator|=
literal|'/'
expr_stmt|;
name|buf
index|[
name|a
operator|-
literal|2
index|]
operator|=
literal|'0'
expr_stmt|;
name|buf
index|[
name|a
operator|-
literal|3
index|]
operator|=
literal|0xff
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|tab
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|tab
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
operator|++
name|t
control|)
block|{
name|int
name|len
init|=
name|strlen
argument_list|(
name|tab
index|[
name|t
index|]
argument_list|)
operator|+
literal|1
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|buf
index|[
name|a
index|]
argument_list|,
name|tab
index|[
name|t
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Put the char we are looking for after the \0 */
name|buf
index|[
name|a
operator|+
name|len
index|]
operator|=
literal|'/'
expr_stmt|;
comment|/* Check search for NUL at end of string */
name|verify_strchr
argument_list|(
name|buf
operator|+
name|a
argument_list|,
literal|0
argument_list|,
name|t
argument_list|,
name|a
argument_list|)
expr_stmt|;
comment|/* Then for the '/' in the strings */
name|verify_strchr
argument_list|(
name|buf
operator|+
name|a
argument_list|,
literal|'/'
argument_list|,
name|t
argument_list|,
name|a
argument_list|)
expr_stmt|;
comment|/* check zero extension of char arg */
name|verify_strchr
argument_list|(
name|buf
operator|+
name|a
argument_list|,
literal|0xffffff00
operator||
literal|'/'
argument_list|,
name|t
argument_list|,
name|a
argument_list|)
expr_stmt|;
comment|/* Replace all the '/' with 0xff */
while|while
condition|(
operator|(
name|off
operator|=
name|slow_strchr
argument_list|(
name|buf
operator|+
name|a
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|off
operator|=
literal|0xff
expr_stmt|;
name|buf
index|[
name|a
operator|+
name|len
index|]
operator|=
literal|0xff
expr_stmt|;
comment|/* Check we can search for 0xff as well as '/' */
name|verify_strchr
argument_list|(
name|buf
operator|+
name|a
argument_list|,
literal|0xff
argument_list|,
name|t
argument_list|,
name|a
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|dlclose
argument_list|(
name|dl_handle
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TP_ADD_TCS
argument_list|(
argument|tp
argument_list|)
end_macro

begin_block
block|{
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|strchr_basic
argument_list|)
expr_stmt|;
return|return
name|atf_no_error
argument_list|()
return|;
block|}
end_block

end_unit


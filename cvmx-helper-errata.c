begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***********************license start***************  * Copyright (c) 2003-2010  Cavium Inc. (support@cavium.com). All rights  * reserved.  *  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  *   * Redistributions in binary form must reproduce the above  *     copyright notice, this list of conditions and the following  *     disclaimer in the documentation and/or other materials provided  *     with the distribution.   *   * Neither the name of Cavium Inc. nor the names of  *     its contributors may be used to endorse or promote products  *     derived from this software without specific prior written  *     permission.   * This Software, including technical data, may be subject to U.S. export  control  * laws, including the U.S. Export Administration Act and its  associated  * regulations, and may be subject to export or import  regulations in other  * countries.   * TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED "AS IS"  * AND WITH ALL FAULTS AND CAVIUM INC. MAKES NO PROMISES, REPRESENTATIONS OR  * WARRANTIES, EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH RESPECT TO  * THE SOFTWARE, INCLUDING ITS CONDITION, ITS CONFORMITY TO ANY REPRESENTATION OR  * DESCRIPTION, OR THE EXISTENCE OF ANY LATENT OR PATENT DEFECTS, AND CAVIUM  * SPECIFICALLY DISCLAIMS ALL IMPLIED (IF ANY) WARRANTIES OF TITLE,  * MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A PARTICULAR PURPOSE, LACK OF  * VIRUSES, ACCURACY OR COMPLETENESS, QUIET ENJOYMENT, QUIET POSSESSION OR  * CORRESPONDENCE TO DESCRIPTION. THE ENTIRE  RISK ARISING OUT OF USE OR  * PERFORMANCE OF THE SOFTWARE LIES WITH YOU.  ***********************license end**************************************/
end_comment

begin_comment
comment|/**  * @file  *  * Fixes and workaround for Octeon chip errata. This file  * contains functions called by cvmx-helper to workaround known  * chip errata. For the most part, code doesn't need to call  * these functions directly.  *  *<hr>$Revision: 70030 $<hr>  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_include
include|#
directive|include
file|<asm/octeon/cvmx.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-helper.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-helper-jtag.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-pko.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-asxx-defs.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-gmxx-defs.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"executive-config.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-config.h"
end_include

begin_include
include|#
directive|include
file|"cvmx.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-fpa.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-pip.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-pko.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-ipd.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-gmx.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-spi.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-pow.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-sysinfo.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-helper.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-helper-jtag.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_ENABLE_PKO_FUNCTIONS
end_ifdef

begin_comment
comment|/**  * @INTERNAL  * Function to adjust internal IPD pointer alignments  *  * @return 0 on success  *         !0 on failure  */
end_comment

begin_function
name|int
name|__cvmx_helper_errata_fix_ipd_ptr_alignment
parameter_list|(
name|void
parameter_list|)
block|{
define|#
directive|define
name|FIX_IPD_FIRST_BUFF_PAYLOAD_BYTES
value|(CVMX_FPA_PACKET_POOL_SIZE-8-CVMX_HELPER_FIRST_MBUFF_SKIP)
define|#
directive|define
name|FIX_IPD_NON_FIRST_BUFF_PAYLOAD_BYTES
value|(CVMX_FPA_PACKET_POOL_SIZE-8-CVMX_HELPER_NOT_FIRST_MBUFF_SKIP)
define|#
directive|define
name|FIX_IPD_OUTPORT
value|0
define|#
directive|define
name|INTERFACE
parameter_list|(
name|port
parameter_list|)
value|(port>> 4)
comment|/* Ports 0-15 are interface 0, 16-31 are interface 1 */
define|#
directive|define
name|INDEX
parameter_list|(
name|port
parameter_list|)
value|(port& 0xf)
name|uint64_t
modifier|*
name|p64
decl_stmt|;
name|cvmx_pko_command_word0_t
name|pko_command
decl_stmt|;
name|cvmx_buf_ptr_t
name|g_buffer
decl_stmt|,
name|pkt_buffer
decl_stmt|;
name|cvmx_wqe_t
modifier|*
name|work
decl_stmt|;
name|int
name|size
decl_stmt|,
name|num_segs
init|=
literal|0
decl_stmt|,
name|wqe_pcnt
decl_stmt|,
name|pkt_pcnt
decl_stmt|;
name|cvmx_gmxx_prtx_cfg_t
name|gmx_cfg
decl_stmt|;
name|int
name|retry_cnt
decl_stmt|;
name|int
name|retry_loop_cnt
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cvmx_helper_link_info_t
name|link_info
decl_stmt|;
comment|/* Save values for restore at end */
name|uint64_t
name|prtx_cfg
init|=
name|cvmx_read_csr
argument_list|(
name|CVMX_GMXX_PRTX_CFG
argument_list|(
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|uint64_t
name|tx_ptr_en
init|=
name|cvmx_read_csr
argument_list|(
name|CVMX_ASXX_TX_PRT_EN
argument_list|(
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|uint64_t
name|rx_ptr_en
init|=
name|cvmx_read_csr
argument_list|(
name|CVMX_ASXX_RX_PRT_EN
argument_list|(
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|uint64_t
name|rxx_jabber
init|=
name|cvmx_read_csr
argument_list|(
name|CVMX_GMXX_RXX_JABBER
argument_list|(
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|uint64_t
name|frame_max
init|=
name|cvmx_read_csr
argument_list|(
name|CVMX_GMXX_RXX_FRM_MAX
argument_list|(
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
comment|/* Configure port to gig FDX as required for loopback mode */
name|cvmx_helper_rgmii_internal_loopback
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
expr_stmt|;
comment|/* Disable reception on all ports so if traffic is present it will not interfere. */
name|cvmx_write_csr
argument_list|(
name|CVMX_ASXX_RX_PRT_EN
argument_list|(
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cvmx_wait
argument_list|(
literal|100000000ull
argument_list|)
expr_stmt|;
for|for
control|(
name|retry_loop_cnt
operator|=
literal|0
init|;
name|retry_loop_cnt
operator|<
literal|10
condition|;
name|retry_loop_cnt
operator|++
control|)
block|{
name|retry_cnt
operator|=
literal|100000
expr_stmt|;
name|wqe_pcnt
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_IPD_PTR_COUNT
argument_list|)
expr_stmt|;
name|pkt_pcnt
operator|=
operator|(
name|wqe_pcnt
operator|>>
literal|7
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|wqe_pcnt
operator|&=
literal|0x7f
expr_stmt|;
name|num_segs
operator|=
operator|(
literal|2
operator|+
name|pkt_pcnt
operator|-
name|wqe_pcnt
operator|)
operator|&
literal|3
expr_stmt|;
if|if
condition|(
name|num_segs
operator|==
literal|0
condition|)
goto|goto
name|fix_ipd_exit
goto|;
name|num_segs
operator|+=
literal|1
expr_stmt|;
name|size
operator|=
name|FIX_IPD_FIRST_BUFF_PAYLOAD_BYTES
operator|+
operator|(
operator|(
name|num_segs
operator|-
literal|1
operator|)
operator|*
name|FIX_IPD_NON_FIRST_BUFF_PAYLOAD_BYTES
operator|)
operator|-
operator|(
name|FIX_IPD_NON_FIRST_BUFF_PAYLOAD_BYTES
operator|/
literal|2
operator|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_ASXX_PRT_LOOP
argument_list|(
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
literal|1
operator|<<
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
expr_stmt|;
name|CVMX_SYNC
expr_stmt|;
name|g_buffer
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
name|g_buffer
operator|.
name|s
operator|.
name|addr
operator|=
name|cvmx_ptr_to_phys
argument_list|(
name|cvmx_fpa_alloc
argument_list|(
name|CVMX_FPA_WQE_POOL
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_buffer
operator|.
name|s
operator|.
name|addr
operator|==
literal|0
condition|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"WARNING: FIX_IPD_PTR_ALIGNMENT buffer allocation failure.\n"
argument_list|)
expr_stmt|;
goto|goto
name|fix_ipd_exit
goto|;
block|}
name|g_buffer
operator|.
name|s
operator|.
name|pool
operator|=
name|CVMX_FPA_WQE_POOL
expr_stmt|;
name|g_buffer
operator|.
name|s
operator|.
name|size
operator|=
name|num_segs
expr_stmt|;
name|pkt_buffer
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
name|pkt_buffer
operator|.
name|s
operator|.
name|addr
operator|=
name|cvmx_ptr_to_phys
argument_list|(
name|cvmx_fpa_alloc
argument_list|(
name|CVMX_FPA_PACKET_POOL
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkt_buffer
operator|.
name|s
operator|.
name|addr
operator|==
literal|0
condition|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"WARNING: FIX_IPD_PTR_ALIGNMENT buffer allocation failure.\n"
argument_list|)
expr_stmt|;
goto|goto
name|fix_ipd_exit
goto|;
block|}
name|pkt_buffer
operator|.
name|s
operator|.
name|i
operator|=
literal|1
expr_stmt|;
name|pkt_buffer
operator|.
name|s
operator|.
name|pool
operator|=
name|CVMX_FPA_PACKET_POOL
expr_stmt|;
name|pkt_buffer
operator|.
name|s
operator|.
name|size
operator|=
name|FIX_IPD_FIRST_BUFF_PAYLOAD_BYTES
expr_stmt|;
name|p64
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|cvmx_phys_to_ptr
argument_list|(
name|pkt_buffer
operator|.
name|s
operator|.
name|addr
argument_list|)
expr_stmt|;
name|p64
index|[
literal|0
index|]
operator|=
literal|0xffffffffffff0000ull
expr_stmt|;
name|p64
index|[
literal|1
index|]
operator|=
literal|0x08004510ull
expr_stmt|;
name|p64
index|[
literal|2
index|]
operator|=
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|size
operator|-
literal|14
argument_list|)
operator|<<
literal|48
operator|)
operator||
literal|0x5ae740004000ull
expr_stmt|;
name|p64
index|[
literal|3
index|]
operator|=
literal|0x3a5fc0a81073c0a8ull
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_segs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|pkt_buffer
operator|.
name|s
operator|.
name|size
operator|=
name|FIX_IPD_NON_FIRST_BUFF_PAYLOAD_BYTES
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|num_segs
operator|-
literal|1
operator|)
condition|)
name|pkt_buffer
operator|.
name|s
operator|.
name|i
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|cvmx_phys_to_ptr
argument_list|(
name|g_buffer
operator|.
name|s
operator|.
name|addr
operator|+
literal|8
operator|*
name|i
argument_list|)
operator|=
name|pkt_buffer
operator|.
name|u64
expr_stmt|;
block|}
comment|/* Build the PKO command */
name|pko_command
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
name|pko_command
operator|.
name|s
operator|.
name|segs
operator|=
name|num_segs
expr_stmt|;
name|pko_command
operator|.
name|s
operator|.
name|total_bytes
operator|=
name|size
expr_stmt|;
name|pko_command
operator|.
name|s
operator|.
name|dontfree
operator|=
literal|0
expr_stmt|;
name|pko_command
operator|.
name|s
operator|.
name|gather
operator|=
literal|1
expr_stmt|;
name|gmx_cfg
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_GMXX_PRTX_CFG
argument_list|(
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|gmx_cfg
operator|.
name|s
operator|.
name|en
operator|=
literal|1
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_GMXX_PRTX_CFG
argument_list|(
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
name|gmx_cfg
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_ASXX_TX_PRT_EN
argument_list|(
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
literal|1
operator|<<
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_ASXX_RX_PRT_EN
argument_list|(
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
literal|1
operator|<<
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_GMXX_RXX_JABBER
argument_list|(
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
literal|65392
operator|-
literal|14
operator|-
literal|4
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_GMXX_RXX_FRM_MAX
argument_list|(
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
literal|65392
operator|-
literal|14
operator|-
literal|4
argument_list|)
expr_stmt|;
name|cvmx_pko_send_packet_prepare
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|,
name|cvmx_pko_get_base_queue
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|CVMX_PKO_LOCK_CMD_QUEUE
argument_list|)
expr_stmt|;
name|cvmx_pko_send_packet_finish
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|,
name|cvmx_pko_get_base_queue
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|pko_command
argument_list|,
name|g_buffer
argument_list|,
name|CVMX_PKO_LOCK_CMD_QUEUE
argument_list|)
expr_stmt|;
name|CVMX_SYNC
expr_stmt|;
do|do
block|{
name|work
operator|=
name|cvmx_pow_work_request_sync
argument_list|(
name|CVMX_POW_WAIT
argument_list|)
expr_stmt|;
name|retry_cnt
operator|--
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|work
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|retry_cnt
operator|>
literal|0
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|retry_cnt
condition|)
name|cvmx_dprintf
argument_list|(
literal|"WARNING: FIX_IPD_PTR_ALIGNMENT get_work() timeout occurred.\n"
argument_list|)
expr_stmt|;
comment|/* Free packet */
if|if
condition|(
name|work
condition|)
name|cvmx_helper_free_packet_data
argument_list|(
name|work
argument_list|)
expr_stmt|;
block|}
name|fix_ipd_exit
label|:
comment|/* Return CSR configs to saved values */
name|cvmx_write_csr
argument_list|(
name|CVMX_GMXX_PRTX_CFG
argument_list|(
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
name|prtx_cfg
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_ASXX_TX_PRT_EN
argument_list|(
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
name|tx_ptr_en
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_ASXX_RX_PRT_EN
argument_list|(
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
name|rx_ptr_en
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_GMXX_RXX_JABBER
argument_list|(
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
name|rxx_jabber
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_GMXX_RXX_FRM_MAX
argument_list|(
name|INDEX
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|,
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
name|frame_max
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_ASXX_PRT_LOOP
argument_list|(
name|INTERFACE
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|link_info
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
comment|/* Set link to down so autonegotiation will set it up again */
name|cvmx_helper_link_set
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|,
name|link_info
argument_list|)
expr_stmt|;
comment|/* Bring the link back up as autonegotiation is not done in user applications. */
name|cvmx_helper_link_autoconf
argument_list|(
name|FIX_IPD_OUTPORT
argument_list|)
expr_stmt|;
name|CVMX_SYNC
expr_stmt|;
if|if
condition|(
name|num_segs
condition|)
name|cvmx_dprintf
argument_list|(
literal|"WARNING: FIX_IPD_PTR_ALIGNMENT failed.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|!
operator|!
name|num_segs
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * This function needs to be called on all Octeon chips with  * errata PKI-100.  *  * The Size field is 8 too large in WQE and next pointers  *  *  The Size field generated by IPD is 8 larger than it should  *  be. The Size field is<55:40> of both:  *      - WORD3 in the work queue entry, and  *      - the next buffer pointer (which precedes the packet data  *        in each buffer).  *  * @param work   Work queue entry to fix  * @return Zero on success. Negative on failure  */
end_comment

begin_function
name|int
name|cvmx_helper_fix_ipd_packet_chain
parameter_list|(
name|cvmx_wqe_t
modifier|*
name|work
parameter_list|)
block|{
name|uint64_t
name|number_buffers
init|=
name|work
operator|->
name|word2
operator|.
name|s
operator|.
name|bufs
decl_stmt|;
comment|/* We only need to do this if the work has buffers */
if|if
condition|(
name|number_buffers
condition|)
block|{
name|cvmx_buf_ptr_t
name|buffer_ptr
init|=
name|work
operator|->
name|packet_ptr
decl_stmt|;
comment|/* Check for errata PKI-100 */
if|if
condition|(
operator|(
name|buffer_ptr
operator|.
name|s
operator|.
name|pool
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|buffer_ptr
operator|.
name|s
operator|.
name|size
operator|+
operator|(
operator|(
name|uint64_t
operator|)
name|buffer_ptr
operator|.
name|s
operator|.
name|back
operator|<<
literal|7
operator|)
operator|+
operator|(
operator|(
name|uint64_t
operator|)
name|buffer_ptr
operator|.
name|s
operator|.
name|addr
operator|&
literal|0x7F
operator|)
operator|)
operator|!=
operator|(
name|CVMX_FPA_PACKET_POOL_SIZE
operator|+
literal|8
operator|)
operator|)
condition|)
block|{
comment|/* fix is not needed */
return|return
literal|0
return|;
block|}
comment|/* Decrement the work packet pointer */
name|buffer_ptr
operator|.
name|s
operator|.
name|size
operator|-=
literal|8
expr_stmt|;
name|work
operator|->
name|packet_ptr
operator|=
name|buffer_ptr
expr_stmt|;
comment|/* Now loop through decrementing the size for each additional buffer */
while|while
condition|(
operator|--
name|number_buffers
condition|)
block|{
comment|/* Chain pointers are 8 bytes before the data */
name|cvmx_buf_ptr_t
modifier|*
name|ptr
init|=
operator|(
name|cvmx_buf_ptr_t
operator|*
operator|)
name|cvmx_phys_to_ptr
argument_list|(
name|buffer_ptr
operator|.
name|s
operator|.
name|addr
operator|-
literal|8
argument_list|)
decl_stmt|;
name|buffer_ptr
operator|=
operator|*
name|ptr
expr_stmt|;
name|buffer_ptr
operator|.
name|s
operator|.
name|size
operator|-=
literal|8
expr_stmt|;
operator|*
name|ptr
operator|=
name|buffer_ptr
expr_stmt|;
block|}
block|}
comment|/* Make sure that these write go out before other operations such as FPA frees */
name|CVMX_SYNCWS
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CVMX_ENABLE_PKO_FUNCTIONS */
end_comment

begin_comment
comment|/**  * Due to errata G-720, the 2nd order CDR circuit on CN52XX pass  * 1 doesn't work properly. The following code disables 2nd order  * CDR for the specified QLM.  *  * @param qlm    QLM to disable 2nd order CDR for.  */
end_comment

begin_function
name|void
name|__cvmx_helper_errata_qlm_disable_2nd_order_cdr
parameter_list|(
name|int
name|qlm
parameter_list|)
block|{
name|int
name|lane
decl_stmt|;
comment|/* Apply the workaround only once. */
name|cvmx_ciu_qlm_jtgd_t
name|qlm_jtgd
decl_stmt|;
name|qlm_jtgd
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_CIU_QLM_JTGD
argument_list|)
expr_stmt|;
if|if
condition|(
name|qlm_jtgd
operator|.
name|s
operator|.
name|select
operator|!=
literal|0
condition|)
return|return;
name|cvmx_helper_qlm_jtag_init
argument_list|()
expr_stmt|;
comment|/* We need to load all four lanes of the QLM, a total of 1072 bits */
for|for
control|(
name|lane
operator|=
literal|0
init|;
name|lane
operator|<
literal|4
condition|;
name|lane
operator|++
control|)
block|{
comment|/* Each lane has 268 bits. We need to set cfg_cdr_incx<67:64>=3 and             cfg_cdr_secord<77>=1. All other bits are zero. Bits go in LSB             first, so start off with the zeros for bits<63:0> */
name|cvmx_helper_qlm_jtag_shift_zeros
argument_list|(
name|qlm
argument_list|,
literal|63
operator|-
literal|0
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* cfg_cdr_incx<67:64>=3 */
name|cvmx_helper_qlm_jtag_shift
argument_list|(
name|qlm
argument_list|,
literal|67
operator|-
literal|64
operator|+
literal|1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* Zeros for bits<76:68> */
name|cvmx_helper_qlm_jtag_shift_zeros
argument_list|(
name|qlm
argument_list|,
literal|76
operator|-
literal|68
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* cfg_cdr_secord<77>=1 */
name|cvmx_helper_qlm_jtag_shift
argument_list|(
name|qlm
argument_list|,
literal|77
operator|-
literal|77
operator|+
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Zeros for bits<267:78> */
name|cvmx_helper_qlm_jtag_shift_zeros
argument_list|(
name|qlm
argument_list|,
literal|267
operator|-
literal|78
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|cvmx_helper_qlm_jtag_update
argument_list|(
name|qlm
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


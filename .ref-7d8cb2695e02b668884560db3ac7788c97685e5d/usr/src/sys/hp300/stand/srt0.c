begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1988 University of Utah.  * Copyright (c) 1982, 1990 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * the Systems Programming Group of the University of Utah Computer  * Science Department.  *  * %sccs.include.redist.c%  *  * from: Utah $Hdr: srt0.c 1.18 92/12/21$  *  *	@(#)srt0.c	7.7 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * Startup code for standalone system  */
end_comment

begin_expr_stmt
operator|.
name|globl
name|begin
operator|.
name|globl
name|_end
operator|.
name|globl
name|_edata
operator|.
name|globl
name|_main
operator|.
name|globl
name|_configure
operator|.
name|globl
name|_firstopen
operator|.
name|globl
name|__rtt
operator|.
name|globl
name|_bootdev
operator|,
name|_howto
operator|,
name|_lowram
operator|,
name|_machineid
operator|.
name|globl
name|_internalhpib
name|STACK
operator|=
literal|0xfffff000
operator||
name|below
name|the
name|ROM
name|page
name|BOOTTYPE
operator|=
literal|0xfffffdc0
name|LOWRAM
operator|=
literal|0xfffffdce
name|SYSFLAG
operator|=
literal|0xfffffed2
operator||
name|system
name|flags
name|MSUS
operator|=
literal|0xfffffedc
operator||
name|MSUS
argument_list|(
argument|?
argument_list|)
name|structure
name|VECTORS
operator|=
literal|0xfffffee0
operator||
name|beginning
name|of
name|jump
name|vectors
name|NMIRESET
operator|=
literal|0xffffff9c
operator||
name|reset
name|vector
name|BUSERR
operator|=
literal|0xfffffffc
name|MAXADDR
operator|=
literal|0xfffff000
name|NBPG
operator|=
literal|4096
name|MMUCMD
operator|=
literal|0x005f400c
operator||
name|MMU
name|command
operator|/
name|status
specifier|register
operator|.
name|data
name|_bootdev
operator|:
operator|.
name|long
literal|0
name|_howto
operator|:
operator|.
name|long
literal|0
name|_lowram
operator|:
operator|.
name|long
literal|0
name|_machineid
operator|:
operator|.
name|long
literal|0
operator|.
name|text
name|begin
operator|:
name|movl
operator|#
name|STACK
operator|,
name|sp
name|moveq
operator|#
literal|47
operator|,
name|d0
operator||
operator|#
name|of
name|vectors
operator|-
literal|1
name|movl
operator|#
name|VECTORS
operator|+
literal|2
operator|,
name|a0
operator||
name|addr
name|part
name|of
name|first
name|vector
name|vecloop
operator|:
name|movl
operator|#
name|trap
operator|,
name|a0
expr|@
operator||
name|make
name|it
name|direct
name|to
name|trap
name|addql
operator|#
literal|6
operator|,
name|a0
operator||
name|move
name|to
name|next
name|vector
name|addr
name|dbf
name|d0
operator|,
name|vecloop
operator||
name|go
name|til
name|done
name|movl
operator|#
name|NMIRESET
operator|,
name|a0
operator||
name|NMI
name|keyboard
name|reset
name|addr
name|movl
operator|#
name|nmi
operator|,
name|a0
expr|@
operator||
name|catch
name|in
name|reset
name|routine
comment|/*  * Determine our CPU type and look for internal HP-IB  * (really only care about detecting 320 (no DIO-II) right now).  */
name|lea
name|_machineid
operator|,
name|a0
name|movl
operator|#
literal|0x808
operator|,
name|d0
name|movc
name|d0
operator|,
name|cacr
operator||
name|clear
name|and
name|disable
name|on
operator|-
name|chip
name|cache
argument_list|(
argument|s
argument_list|)
name|movl
operator|#
literal|0x200
operator|,
name|d0
operator||
name|data
name|freeze
name|bit
name|movc
name|d0
operator|,
name|cacr
operator||
name|only
name|exists
name|on
literal|68030
name|movc
name|cacr
operator|,
name|d0
operator||
name|read
name|it
name|back
name|tstl
name|d0
operator||
name|zero
condition|?
name|jeq
name|not68030
operator||
name|yes
operator|,
name|we
name|have
literal|68020
operator|/
literal|68040
name|movl
operator|#
literal|0x808
operator|,
name|d0
name|movc
name|d0
operator|,
name|cacr
operator||
name|clear
name|data
name|freeze
name|bit
name|again
name|movl
operator|#
literal|0x80
operator|,
name|MMUCMD
operator||
name|set
name|magic
name|cookie
name|movl
name|MMUCMD
operator|,
name|d0
operator||
name|read
name|it
name|back
name|btst
operator|#
literal|7
operator|,
name|d0
operator||
name|cookie
name|still
name|on
condition|?
name|jeq
name|not370
operator||
name|no
operator|,
literal|360
name|or
literal|375
name|movl
operator|#
literal|4
operator|,
name|a0
expr|@
operator||
name|consider
name|a
literal|370
end_expr_stmt

begin_for
for|for now 	movl	#0
operator|,
name|MMUCMD
operator||
name|clear
name|magic
name|cookie
name|movl
name|MMUCMD
operator|,
name|d0
operator||
name|read
name|it
name|back
name|btst
operator|#
literal|7
operator|,
name|d0
operator||
name|still
name|on
condition|?
name|jeq
name|ihpibcheck
operator||
name|no
operator|,
name|a
literal|370
name|movl
operator|#
literal|5
operator|,
name|a0
expr|@
operator||
name|yes
operator|,
name|must
name|be
name|a
literal|340
name|jra
name|ihpibcheck
name|not370
operator|:
name|movl
operator|#
literal|3
operator|,
name|a0
expr|@
operator||
name|type
name|is
name|at
name|least
name|a
literal|360
name|movl
operator|#
literal|0
operator|,
name|MMUCMD
operator||
name|clear
name|magic
name|cookie2
name|movl
name|MMUCMD
operator|,
name|d0
operator||
name|read
name|it
name|back
name|btst
operator|#
literal|16
operator|,
name|d0
operator||
name|still
name|on
condition|?
name|jeq
name|ihpibcheck
operator||
name|no
operator|,
name|a
literal|360
name|movl
operator|#
literal|6
operator|,
name|a0
expr|@
operator||
name|yes
operator|,
name|must
name|be
name|a
literal|345
operator|/
literal|375
operator|/
literal|400
name|jra
name|ihpibcheck
name|not68030
operator|:
name|bset
operator|#
literal|31
operator|,
name|d0
operator||
name|data
name|cache
name|enable
name|bit
name|movc
name|d0
operator|,
name|cacr
operator||
name|only
name|exists
name|on
literal|68040
name|movc
name|cacr
operator|,
name|d0
operator||
name|read
name|it
name|back
name|tstl
name|d0
operator||
name|zero
condition|?
name|beq
name|is68020
operator||
name|yes
operator|,
name|we
name|have
literal|68020
name|moveq
operator|#
literal|0
operator|,
name|d0
operator||
name|now
name|turn
name|it
name|back
name|off
name|movec
name|d0
operator|,
name|cacr
operator||
name|before
name|we
name|access
name|any
name|data
operator|.
name|long
literal|0x4e7b0004
operator||
name|movc
name|d0
operator|,
name|itt0
operator|.
name|long
literal|0x4e7b0005
operator||
name|movc
name|d0
operator|,
name|itt1
operator|.
name|long
literal|0x4e7b0006
operator||
name|movc
name|d0
operator|,
name|dtt0
operator|.
name|long
literal|0x4e7b0007
operator||
name|movc
name|d0
operator|,
name|dtt1
operator|.
name|word
literal|0xf4d8
operator||
name|cinva
name|bc
name|movl
name|MMUCMD
operator|,
name|d0
operator||
name|get
name|MMU
specifier|register
name|lsrl
operator|#
literal|8
operator|,
name|d0
operator||
name|get
name|apparent
name|ID
name|cmpb
operator|#
literal|6
operator|,
name|d0
operator||
name|id
operator|==
literal|6
condition|?
name|jeq
name|is33mhz
operator||
name|yes
operator|,
name|we
name|have
name|a
literal|433s
name|movl
operator|#
literal|7
operator|,
name|a0
expr|@
operator||
name|no
operator|,
name|we
name|have
name|a
literal|380
operator|/
literal|425t
name|jra
name|ihpibcheck
name|is33mhz
operator|:
name|movl
operator|#
literal|8
operator|,
name|a0
expr|@
operator||
literal|433s
operator|(
name|XXX
literal|425s
name|returns
name|same
name|ID
operator|,
name|ugh
operator|!
operator|)
name|jra
name|ihpibcheck
name|is68020
operator|:
name|movl
operator|#
literal|1
operator|,
name|a0
expr|@
operator||
name|consider
name|a
literal|330
end_for

begin_for
for|for now 	movl	#1
operator|,
name|MMUCMD
operator||
name|a
literal|68020
operator|,
name|write
name|HP
name|MMU
name|location
name|movl
name|MMUCMD
operator|,
name|d0
operator||
name|read
name|it
name|back
name|btst
operator|#
literal|0
operator|,
name|d0
operator||
name|zero
condition|?
name|jeq
name|ihpibcheck
operator||
name|yes
operator|,
name|a
literal|330
name|movl
operator|#
literal|0
operator|,
name|a0
expr|@
operator||
name|no
operator|,
name|consider
name|a
literal|320
end_for

begin_for
for|for now 	movl	#0x80
operator|,
name|MMUCMD
operator||
name|set
name|magic
name|cookie
name|movl
name|MMUCMD
operator|,
name|d0
operator||
name|read
name|it
name|back
name|btst
operator|#
literal|7
operator|,
name|d0
operator||
name|cookie
name|still
name|on
condition|?
name|jeq
name|ihpibcheck
operator||
name|no
operator|,
name|just
name|a
literal|320
name|movl
operator|#
literal|2
operator|,
name|a0
expr|@
operator||
name|yes
operator|,
name|a
literal|350
name|ihpibcheck
operator|:
name|movl
operator|#
literal|0
operator|,
name|MMUCMD
operator||
name|make
name|sure
name|MMU
name|is
name|off
name|btst
operator|#
literal|5
operator|,
name|SYSFLAG
operator||
end_for

begin_do
do|do
name|we
name|have
name|an
name|internal
name|HP
operator|-
name|IB
condition|?
name|jeq
name|boottype
operator||
name|yes
operator|,
continue|continue
name|clrl
name|_internalhpib
continue||
name|no
operator|,
name|clear
name|the
name|internal
name|address
comment|/*  * If this is a reboot, extract howto/bootdev stored by kernel  */
name|boottype
continue|:
name|cmpw
continue|#12
operator|,
name|BOOTTYPE
continue||
name|is
name|this
name|a
name|reboot
continue|(
name|REQ_REBOOT
end_do

begin_expr_stmt
unit|)
operator|?
name|jne
name|notreboot
operator||
name|no
operator|,
name|skip
name|lea
name|MAXADDR
operator|,
name|a0
operator||
name|find
name|last
name|page
name|movl
name|a0
expr|@
operator|+
operator|,
name|d7
operator||
name|and
name|extract
name|howto
operator|,
name|bootdev
name|movl
name|a0
expr|@
operator|+
operator|,
name|d6
operator||
name|from
name|where
name|doboot
argument_list|()
name|left
name|them
name|jra
name|boot1
comment|/*  * At this point we do not know which logical device the MSUS select  * code refers to so we cannot construct bootdev.  So we just punt  * and let configure() construct it.  */
name|notreboot
operator|:
name|moveq
operator|#
literal|0
operator|,
name|d6
operator||
name|make
name|sure
name|bootdev
name|is
name|invalid
name|cmpw
operator|#
literal|18
operator|,
name|BOOTTYPE
operator||
name|does
name|the
name|user
name|want
name|to
name|interact
condition|?
name|jeq
name|askme
operator||
name|yes
operator|,
name|go
name|to
name|it
name|moveq
operator|#
literal|0
operator|,
name|d7
operator||
expr|default
name|to
name|RB_AUTOBOOT
name|jra
name|boot1
name|askme
operator|:
name|moveq
operator|#
literal|3
operator|,
name|d7
operator||
expr|default
name|to
name|RB_SINGLE
operator||
name|RB_ASKNAME
name|boot1
operator|:
name|movl
name|d6
operator|,
name|_bootdev
operator||
name|save
name|bootdev
name|and
name|howto
name|movl
name|d7
operator|,
name|_howto
operator||
name|globally
name|so
name|all
name|can
name|access
name|movl
name|LOWRAM
operator|,
name|d0
operator||
name|read
name|lowram
name|value
name|from
name|bootrom
name|addl
operator|#
name|NBPG
operator|,
name|d0
operator||
name|must
name|preserve
name|this
end_expr_stmt

begin_for
for|for bootrom to reboot 	andl	#0xfffff000
operator|,
name|d0
operator||
name|round
name|to
name|next
name|page
name|movl
name|d0
operator|,
name|_lowram
operator||
name|stash
name|that
name|value
name|start
operator|:
name|movl
operator|#
name|_edata
operator|,
name|a2
operator||
name|start
name|of
name|BSS
name|movl
operator|#
name|_end
operator|,
name|a3
operator||
name|end
name|clr
operator|:
name|clrb
name|a2
expr|@
operator|+
operator||
name|clear
name|BSS
name|cmpl
name|a2
operator|,
name|a3
operator||
name|done
condition|?
name|bne
name|clr
operator||
name|no
operator|,
name|keep
name|going
name|jsr
name|_configure
operator||
name|configure
name|critical
name|devices
name|movl
operator|#
literal|1
operator|,
name|_firstopen
operator||
name|mark
name|this
name|as
name|the
name|first
name|open
name|jsr
name|_main
operator||
name|lets
name|go
name|__rtt
operator|:
name|movl
operator|#
literal|3
operator|,
name|_howto
operator||
name|restarts
name|get
name|RB_SINGLE
operator||
name|RB_ASKNAME
name|jmp
name|start
comment|/*  * probe a location and see if it causes a bus error  */
operator|.
name|globl
name|_badaddr
name|_badaddr
operator|:
name|movl
name|BUSERR
operator|,
name|__bsave
operator||
name|save
name|ROM
name|bus
name|error
name|handler
name|address
name|movl
name|sp
operator|,
name|__ssave
operator||
name|and
name|current
name|stack
name|pointer
name|movl
operator|#
name|catchbad
operator|,
name|BUSERR
operator||
name|plug
name|in
name|our
name|handler
name|movl
name|sp
expr|@
operator|(
literal|4
operator|)
operator|,
name|a0
operator||
name|address
name|to
name|probe
name|movw
name|a0
expr|@
operator|,
name|d1
operator||
end_for

begin_do
do|do
name|it
name|movl
name|__bsave
decl_stmt|,
name|BUSERR
decl|| if
name|we
name|got
name|here
decl_stmt|,
name|it
name|did
name|not
name|fault
name|clrl
name|d0
decl|| return
name|that
name|this
name|was
name|not
name|a
name|bad
name|addr
name|rts
name|catchbad
range|:
name|movl
name|__bsave
decl_stmt|,
name|BUSERR
decl||
name|got
name|a
name|bus
name|error
decl_stmt|,
name|so
name|restore
name|old
name|handler
name|movl
name|__ssave
decl_stmt|,
name|sp
decl||
name|manually
name|restore
name|stack
name|moveq
decl|#1
decl_stmt|,
name|d0
decl||
name|indicate
name|that
name|we
name|got
name|a
name|fault
name|rts
decl|| return
name|to
name|caller
name|of
name|badaddr
argument_list|()
name|__bsave
range|:
operator|.
name|long
literal|0
name|__ssave
operator|:
operator|.
name|long
literal|0
operator|.
name|globl
name|_trap
name|trap
operator|:
name|moveml
operator|#
literal|0xFFFF
decl_stmt|,
name|sp
decl|@-	|
name|save
name|registers
name|movl
name|sp
decl_stmt|,
name|sp
decl|@-		|
name|push
name|pointer
name|to
name|frame
name|jsr
name|_trap
decl||
name|call
name|C
name|routine
name|to
name|deal
name|with
name|it
name|tstl
name|d0
name|jeq
name|Lstop
name|addql
decl|#4
decl_stmt|,
name|sp
name|moveml
name|sp
decl|@+
decl_stmt|,#0x7FFF
name|addql
decl|#8
decl_stmt|,
name|sp
name|rte
name|Lstop
range|:
name|stop
operator|#
literal|0x2700
operator||
name|stop
name|cold
name|nmi
operator|:
name|movw
operator|#
literal|18
decl_stmt|,
name|BOOTTYPE
decl||
name|mark
name|as
name|system
decl|switch
name|jsr
name|_kbdnmi
decl||
name|clear
name|the
name|interrupt
name|jra
name|begin
decl||
name|start
name|over
ifdef|#
directive|ifdef
name|ROMPRF
operator|.
name|globl
name|_romout
name|_romout
range|:
name|movl
name|sp
expr|@
operator|(
literal|4
operator|)
decl_stmt|,
name|d0
decl||
name|line
name|number
name|movl
name|sp
decl|@
argument_list|(
literal|8
argument_list|)
decl_stmt|,
name|a0
decl||
name|string
name|jsr
decl|0x150		| do
name|it
name|rts
end_do

begin_endif
endif|#
directive|endif
end_endif

end_unit


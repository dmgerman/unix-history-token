begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Sony Corp. and Kazumasa Utashiro of Software Research Associates, Inc.  *  * %sccs.include.redist.c%  *  * from: $Hdr: fb_start.c,v 4.300 91/06/27 20:42:40 root Rel41 $ SONY  *  *	@(#)fb_start.c	7.4 (Berkeley) %G%  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_include
include|#
directive|include
file|"../../iop/framebuf.h"
end_include

begin_include
include|#
directive|include
file|"../../iop/fbreg.h"
end_include

begin_include
include|#
directive|include
file|"page.h"
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<news3400/iop/framebuf.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iop/fbreg.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<news3400/fb/fbdefs.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_decl_stmt
specifier|extern
name|struct
name|tty
name|cons
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|int
name|cnstart
parameter_list|()
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|PRE_EMPT
value|need_resched()
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|struct
name|fbdev
modifier|*
name|cfb
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|lPoint
name|mp
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|curs_pending
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|struct
name|fbdevsw
name|fbdevsw
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|nfbdev
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|ext_fnt_addr
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|ext_fnt24_addr
index|[]
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|ext_fnt_addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|ext_fnt24_addr
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|char
name|copyfuncv
index|[
name|MAXPLANE
index|]
init|=
block|{
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
comment|/* SRC */
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
comment|/* SRC */
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
block|,
name|BF_S
comment|/* SRC */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|fb_color_pallet_def
index|[
literal|48
index|]
init|=
block|{
comment|/* define initial color */
comment|/*	R,	G,	B	*/
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0x44
block|,
literal|0
block|,
literal|0x44
block|,
literal|0
block|,
literal|0
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0
block|,
literal|0
block|,
literal|0x44
block|,
literal|0
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0x88
block|,
literal|0x88
block|,
literal|0x88
block|,
literal|0
block|,
literal|0
block|,
literal|0xff
block|,
literal|0
block|,
literal|0xff
block|,
literal|0
block|,
literal|0
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0
block|,
literal|0
block|,
literal|0xff
block|,
literal|0
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|fb_gray_pallet_def
index|[
literal|48
index|]
init|=
block|{
comment|/* define initial color */
comment|/*	R,	G,	B	*/
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0
block|,
literal|0xff
block|,
literal|0
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0
block|,
literal|0xff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xff
block|,
literal|0x88
block|,
literal|0x88
block|,
literal|0x88
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0
block|,
literal|0x44
block|,
literal|0
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0x44
block|,
literal|0x44
block|,
literal|0
block|,
literal|0x44
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0x44
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|bitmap_use
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* shared variable for bitmap exclusion ctrl */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_decl_stmt
name|struct
name|fb_map
name|rommap
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_function
name|void
name|lock_bitmap
parameter_list|()
block|{
name|int
name|s
decl_stmt|;
comment|/* wait(bitmap_use) */
name|s
operator|=
name|splbitmap
argument_list|()
expr_stmt|;
while|while
condition|(
name|bitmap_use
operator|&
name|FB_BUSY
condition|)
block|{
name|bitmap_use
operator||=
name|FB_WANTED
expr_stmt|;
name|sleep
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|bitmap_use
argument_list|,
name|FBPRI
argument_list|)
expr_stmt|;
block|}
name|bitmap_use
operator||=
name|FB_BUSY
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|unlock_bitmap
parameter_list|()
block|{
name|int
name|s
decl_stmt|;
comment|/* signal(bitmap_use) */
name|s
operator|=
name|splbitmap
argument_list|()
expr_stmt|;
if|if
condition|(
name|bitmap_use
operator|&
name|FB_WANTED
condition|)
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|bitmap_use
argument_list|)
expr_stmt|;
name|bitmap_use
operator|&=
operator|~
operator|(
name|FB_BUSY
operator||
name|FB_WANTED
operator|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|lock_bitmap_poll
argument_list|()
end_macro

begin_block
block|{
name|int
name|s
decl_stmt|;
comment|/* wait(bitmap_use) */
name|s
operator|=
name|splbitmap
argument_list|()
expr_stmt|;
if|if
condition|(
name|bitmap_use
operator|&
operator|(
name|FB_BUSY
operator||
name|FB_WANTED
operator|)
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|bitmap_use
operator||=
name|FB_BUSY
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_function
name|void
name|unlock_bitmap_poll
parameter_list|()
block|{
name|int
name|s
decl_stmt|;
comment|/* signal(bitmap_use) */
name|s
operator|=
name|splbitmap
argument_list|()
expr_stmt|;
if|if
condition|(
name|bitmap_use
operator|&
name|FB_WANTED
condition|)
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|bitmap_use
argument_list|)
expr_stmt|;
name|bitmap_use
operator|&=
operator|~
operator|(
name|FB_BUSY
operator||
name|FB_WANTED
operator|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|bmlockedp
argument_list|()
end_macro

begin_block
block|{
return|return
operator|(
name|bitmap_use
operator|&
operator|(
name|FB_WANTED
operator||
name|FB_BUSY
operator|)
operator|)
return|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|NOTDEF
end_ifdef

begin_comment
comment|/* KU:XXX not necessary for news3200 */
end_comment

begin_function
name|void
name|rop_wait
parameter_list|(
name|fb
parameter_list|)
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
block|{
specifier|register
name|int
name|s
decl_stmt|;
name|int
name|i
decl_stmt|;
name|s
operator|=
name|splbitmap
argument_list|()
expr_stmt|;
comment|/* KU:XXX trick! */
define|#
directive|define
name|in_interrupt
parameter_list|()
value|((caddr_t)&fb< (caddr_t)MACH_CODE_START)
if|if
condition|(
name|in_interrupt
argument_list|()
operator|||
operator|(
name|fb
operator|->
name|run_flag
operator|&
name|FB_WAITING
operator|)
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|fbbm_rop_wait
argument_list|(
name|fb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_STATUSCHECK
argument_list|,
literal|0
argument_list|)
operator|&
operator|(
name|FB_STATUS_ROPWAIT
operator||
name|FB_STATUS_ROPEXEC
operator|)
condition|)
block|{
name|i
operator|=
name|FB_INT_ROPDONE
expr_stmt|;
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_INTENABLE
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_STATUSCHECK
argument_list|,
literal|0
argument_list|)
operator|&
operator|(
name|FB_STATUS_ROPWAIT
operator||
name|FB_STATUS_ROPEXEC
operator|)
operator|)
condition|)
block|{
name|i
operator|=
name|FB_INT_ROPDONE
expr_stmt|;
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_INTCLEAR
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fb
operator|->
name|run_flag
operator||=
name|FB_WAITING
expr_stmt|;
name|sleep
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|fb
operator|->
name|run_flag
argument_list|,
name|FBPRI
argument_list|)
expr_stmt|;
block|}
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NOTDEF */
end_comment

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CPU_SINGLE */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_struct
struct|struct
name|page
block|{
name|char
name|bytes
index|[
name|NBPG
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|extern
name|struct
name|page
modifier|*
name|page_base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|page
modifier|*
name|page_max
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|map
name|pagemap
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|pte_iop
name|page_pt
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|mapped_page
decl_stmt|;
end_decl_stmt

begin_function
name|caddr_t
name|fb_map_page
parameter_list|(
name|map
parameter_list|,
name|n
parameter_list|,
name|prot
parameter_list|)
specifier|register
name|int
modifier|*
name|map
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|int
name|prot
decl_stmt|;
block|{
specifier|register
name|int
name|x
decl_stmt|;
specifier|register
name|struct
name|pte_iop
modifier|*
name|p
decl_stmt|;
specifier|register
name|struct
name|page
modifier|*
name|addr
decl_stmt|;
specifier|register
name|int
name|s
init|=
name|spl7
argument_list|()
decl_stmt|;
specifier|static
name|int
name|last_x
decl_stmt|,
name|last_n
decl_stmt|;
if|if
condition|(
name|last_n
operator|>=
name|n
condition|)
block|{
name|x
operator|=
name|last_x
expr_stmt|;
block|}
else|else
block|{
name|rmfree
argument_list|(
name|pagemap
argument_list|,
name|last_n
argument_list|,
name|last_x
argument_list|)
expr_stmt|;
name|mapped_page
operator|-=
name|last_n
expr_stmt|;
name|last_x
operator|=
literal|0
expr_stmt|;
name|last_n
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|=
name|rmalloc
argument_list|(
name|pagemap
argument_list|,
name|n
argument_list|)
operator|)
operator|<=
literal|0
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|mapped_page
operator|+=
name|n
expr_stmt|;
name|last_x
operator|=
name|x
expr_stmt|;
name|last_n
operator|=
name|n
expr_stmt|;
block|}
name|addr
operator|=
name|page_base
operator|+
name|x
expr_stmt|;
name|prot
operator||=
name|PG_PAGE
expr_stmt|;
for|for
control|(
name|p
operator|=
name|page_pt
operator|+
name|x
init|;
name|n
operator|>
literal|0
condition|;
name|p
operator|++
operator|,
name|n
operator|--
control|)
block|{
operator|*
operator|(
name|int
operator|*
operator|)
name|p
operator|=
name|prot
operator||
operator|*
name|map
operator|++
expr_stmt|;
name|tbis
argument_list|(
operator|(
name|caddr_t
operator|)
name|addr
argument_list|)
expr_stmt|;
name|addr
operator|++
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
call|(
name|caddr_t
call|)
argument_list|(
name|page_base
operator|+
name|x
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|caddr_t
name|fb_map_page2
parameter_list|(
name|map
parameter_list|,
name|n
parameter_list|,
name|prot
parameter_list|)
specifier|register
name|int
modifier|*
name|map
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|int
name|prot
decl_stmt|;
block|{
specifier|register
name|int
name|x
decl_stmt|;
specifier|register
name|struct
name|pte_iop
modifier|*
name|p
decl_stmt|;
specifier|register
name|struct
name|page
modifier|*
name|addr
decl_stmt|;
specifier|register
name|int
name|s
decl_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|s
operator|=
name|spl7
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|=
name|rmalloc
argument_list|(
name|pagemap
argument_list|,
name|n
argument_list|)
operator|)
operator|<=
literal|0
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|mapped_page
operator|+=
name|n
expr_stmt|;
name|addr
operator|=
name|page_base
operator|+
name|x
expr_stmt|;
name|prot
operator||=
name|PG_PAGE
expr_stmt|;
for|for
control|(
name|p
operator|=
name|page_pt
operator|+
name|x
init|;
name|n
operator|>
literal|0
condition|;
name|p
operator|++
operator|,
name|n
operator|--
control|)
block|{
operator|*
operator|(
name|int
operator|*
operator|)
name|p
operator|=
name|prot
operator||
operator|(
operator|*
name|map
operator|++
operator|)
expr_stmt|;
name|tbis
argument_list|(
operator|(
name|caddr_t
operator|)
name|addr
argument_list|)
expr_stmt|;
name|addr
operator|++
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
call|(
name|caddr_t
call|)
argument_list|(
name|page_base
operator|+
name|x
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IPC_MRX */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CPU_SINGLE */
end_comment

begin_expr_stmt
name|iopmemfbmap
argument_list|(
name|addr
argument_list|,
name|len
argument_list|,
name|map
argument_list|)
specifier|register
name|caddr_t
name|addr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|caddr_t
modifier|*
name|p
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|map
operator|->
name|fm_vaddr
operator|=
name|addr
expr_stmt|;
name|map
operator|->
name|fm_offset
operator|=
operator|(
name|unsigned
operator|)
name|addr
operator|&
name|CLOFSET
expr_stmt|;
name|map
operator|->
name|fm_count
operator|=
name|len
expr_stmt|;
name|len
operator|+=
name|map
operator|->
name|fm_offset
expr_stmt|;
name|p
operator|=
name|map
operator|->
name|fm_addr
expr_stmt|;
name|addr
operator|-=
name|map
operator|->
name|fm_offset
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFBMAP
operator|&&
name|len
operator|>
literal|0
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|p
operator|++
operator|=
name|addr
expr_stmt|;
name|addr
operator|+=
name|CLBYTES
expr_stmt|;
name|len
operator|-=
name|CLBYTES
expr_stmt|;
block|}
block|}
end_block

begin_function
name|int
name|nofunc
parameter_list|()
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|error
parameter_list|()
block|{
return|return
name|FB_RERROR
return|;
block|}
end_function

begin_function
name|void
name|checkArea
parameter_list|(
name|fb
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|)
specifier|register
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
specifier|register
name|int
modifier|*
name|x
decl_stmt|,
decl|*
name|y
decl_stmt|;
end_function

begin_block
block|{
if|if
condition|(
operator|*
name|x
operator|<
name|fb
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|x
condition|)
operator|*
name|x
operator|=
name|fb
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|x
expr_stmt|;
if|if
condition|(
operator|*
name|y
operator|<
name|fb
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|y
condition|)
operator|*
name|y
operator|=
name|fb
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|y
expr_stmt|;
if|if
condition|(
operator|*
name|x
operator|>=
operator|(
name|fb
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|x
operator|+
name|fb
operator|->
name|moveArea
operator|.
name|extent
operator|.
name|x
operator|)
condition|)
operator|*
name|x
operator|=
operator|(
name|fb
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|x
operator|+
name|fb
operator|->
name|moveArea
operator|.
name|extent
operator|.
name|x
operator|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|y
operator|>=
operator|(
name|fb
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|y
operator|+
name|fb
operator|->
name|moveArea
operator|.
name|extent
operator|.
name|y
operator|)
condition|)
operator|*
name|y
operator|=
operator|(
name|fb
operator|->
name|moveArea
operator|.
name|origin
operator|.
name|y
operator|+
name|fb
operator|->
name|moveArea
operator|.
name|extent
operator|.
name|y
operator|)
operator|-
literal|1
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|cursorIn
argument_list|(
name|fb
argument_list|,
name|clip
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lRectangle
modifier|*
name|clip
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|clip
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|cfb
operator|!=
name|fb
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|clip
operator|->
name|origin
operator|.
name|x
operator|<
name|fb
operator|->
name|cursorP
operator|.
name|x
operator|+
name|fb
operator|->
name|size
operator|.
name|x
operator|&&
name|clip
operator|->
name|origin
operator|.
name|x
operator|+
name|clip
operator|->
name|extent
operator|.
name|x
operator|>
name|fb
operator|->
name|cursorP
operator|.
name|x
operator|&&
name|clip
operator|->
name|origin
operator|.
name|y
operator|<
name|fb
operator|->
name|cursorP
operator|.
name|y
operator|+
name|fb
operator|->
name|size
operator|.
name|y
operator|&&
name|clip
operator|->
name|origin
operator|.
name|y
operator|+
name|clip
operator|->
name|extent
operator|.
name|y
operator|>
name|fb
operator|->
name|cursorP
operator|.
name|y
operator|)
return|;
block|}
end_block

begin_function
name|void
name|fbcopy1
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|,
name|fv
parameter_list|)
name|lPoint
name|src
decl_stmt|;
name|lPoint
name|dst
decl_stmt|;
name|char
modifier|*
name|fv
decl_stmt|;
block|{
name|lRectangle
name|sr
decl_stmt|,
name|dr
decl_stmt|;
name|sr
operator|.
name|origin
operator|=
name|src
expr_stmt|;
name|sr
operator|.
name|extent
operator|=
name|cfb
operator|->
name|size
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
name|dst
expr_stmt|;
if|if
condition|(
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|cfb
operator|->
name|FrameRect
argument_list|,
operator|&
name|dr
argument_list|,
operator|&
name|cfb
operator|->
name|VisRect
argument_list|)
condition|)
block|{
name|fbbm_rop_init
argument_list|(
name|cfb
argument_list|,
name|fv
argument_list|)
expr_stmt|;
name|fbbm_rop_copy
argument_list|(
name|cfb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|,
literal|1
argument_list|,
name|FB_PLANEALL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|fbcopy2
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|)
name|lPoint
name|src
decl_stmt|;
name|lPoint
name|dst
decl_stmt|;
block|{
name|lRectangle
name|sr
decl_stmt|,
name|dr
decl_stmt|;
name|sr
operator|.
name|origin
operator|=
name|src
expr_stmt|;
name|sr
operator|.
name|extent
operator|=
name|cfb
operator|->
name|size
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
name|dst
expr_stmt|;
if|if
condition|(
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|cfb
operator|->
name|FrameRect
argument_list|,
operator|&
name|dr
argument_list|,
operator|&
name|cfb
operator|->
name|FrameRect
argument_list|)
condition|)
block|{
name|fbbm_rop_init
argument_list|(
name|cfb
argument_list|,
name|copyfuncv
argument_list|)
expr_stmt|;
name|fbbm_rop_copy
argument_list|(
name|cfb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|,
literal|0
argument_list|,
name|FB_PLANEALL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|fbcopy3
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|)
name|lPoint
name|src
decl_stmt|;
name|lPoint
name|dst
decl_stmt|;
block|{
name|lRectangle
name|sr
decl_stmt|,
name|dr
decl_stmt|;
name|sr
operator|.
name|origin
operator|=
name|src
expr_stmt|;
name|sr
operator|.
name|extent
operator|=
name|cfb
operator|->
name|size
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
name|dst
expr_stmt|;
if|if
condition|(
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|cfb
operator|->
name|FrameRect
argument_list|,
operator|&
name|dr
argument_list|,
operator|&
name|cfb
operator|->
name|VisRect
argument_list|)
condition|)
block|{
name|fbbm_rop_init
argument_list|(
name|cfb
argument_list|,
name|copyfuncv
argument_list|)
expr_stmt|;
name|fbbm_rop_copy
argument_list|(
name|cfb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|,
literal|0
argument_list|,
name|FB_PLANEALL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|cursorOn
parameter_list|(
name|fb
parameter_list|)
specifier|register
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|int
name|s
init|=
name|splbitmap
argument_list|()
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cfb
operator|==
name|fb
operator|&&
name|fb
operator|->
name|cursorShow
operator|&&
operator|!
name|fb
operator|->
name|cursorVis
condition|)
block|{
if|if
condition|(
name|fb
operator|->
name|hard_cursor
condition|)
block|{
name|fbbm_cursor_on
argument_list|(
name|fb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fbcopy2
argument_list|(
name|fb
operator|->
name|cursorP
argument_list|,
name|fb
operator|->
name|SaveRect
operator|.
name|origin
argument_list|)
expr_stmt|;
name|fbcopy1
argument_list|(
name|fb
operator|->
name|MaskRect
operator|.
name|origin
argument_list|,
name|fb
operator|->
name|cursorP
argument_list|,
name|fb
operator|->
name|maskfuncv
argument_list|)
expr_stmt|;
name|fbcopy1
argument_list|(
name|fb
operator|->
name|CursorRect
operator|.
name|origin
argument_list|,
name|fb
operator|->
name|cursorP
argument_list|,
name|fb
operator|->
name|curfuncv
argument_list|)
expr_stmt|;
block|}
name|fb
operator|->
name|cursorVis
operator|=
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|cursorOff
parameter_list|(
name|fb
parameter_list|)
specifier|register
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|int
name|s
init|=
name|splbitmap
argument_list|()
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cfb
operator|==
name|fb
operator|&&
name|fb
operator|->
name|cursorShow
operator|&&
name|fb
operator|->
name|cursorVis
condition|)
block|{
if|if
condition|(
name|fb
operator|->
name|hard_cursor
condition|)
name|fbbm_cursor_off
argument_list|(
name|fb
argument_list|)
expr_stmt|;
else|else
name|fbcopy3
argument_list|(
name|fb
operator|->
name|SaveRect
operator|.
name|origin
argument_list|,
name|fb
operator|->
name|cursorP
argument_list|)
expr_stmt|;
name|fb
operator|->
name|cursorVis
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|softCursorCheck
parameter_list|(
name|fb
parameter_list|,
name|stype
parameter_list|,
name|srect
parameter_list|,
name|dtype
parameter_list|,
name|drect
parameter_list|)
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
name|char
name|stype
decl_stmt|,
name|dtype
decl_stmt|;
name|lRectangle
modifier|*
name|srect
decl_stmt|,
decl|*
name|drect
decl_stmt|;
end_function

begin_block
block|{
if|if
condition|(
name|cfb
operator|==
name|fb
operator|&&
name|cfb
operator|->
name|cursorVis
operator|&&
operator|(
operator|(
name|stype
operator|==
name|BM_FB
operator|&&
name|cursorIn
argument_list|(
name|fb
argument_list|,
name|srect
argument_list|)
operator|)
operator|||
operator|(
name|dtype
operator|==
name|BM_FB
operator|&&
name|cursorIn
argument_list|(
name|fb
argument_list|,
name|drect
argument_list|)
operator|)
operator|)
condition|)
name|cursorOff
argument_list|(
name|cfb
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|void
name|cursorCheck
parameter_list|(
name|fb
parameter_list|,
name|stype
parameter_list|,
name|srect
parameter_list|,
name|dtype
parameter_list|,
name|drect
parameter_list|)
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
name|char
name|stype
decl_stmt|,
name|dtype
decl_stmt|;
name|lRectangle
modifier|*
name|srect
decl_stmt|,
decl|*
name|drect
decl_stmt|;
end_function

begin_block
block|{
if|if
condition|(
operator|!
name|fb
operator|->
name|hard_cursor
condition|)
name|softCursorCheck
argument_list|(
name|fb
argument_list|,
name|stype
argument_list|,
name|srect
argument_list|,
name|dtype
argument_list|,
name|drect
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|int
name|redrawCursor
parameter_list|(
name|fb
parameter_list|)
specifier|register
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
block|{
name|int
name|s
decl_stmt|;
name|lPoint
name|tmp
decl_stmt|;
if|if
condition|(
name|cfb
operator|==
name|fb
operator|&&
name|fb
operator|->
name|cursorSet
condition|)
block|{
name|s
operator|=
name|spl7
argument_list|()
expr_stmt|;
name|tmp
operator|=
name|mp
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|s
operator|=
name|splbitmap
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|fb
operator|->
name|cursorP
operator|.
name|x
operator|!=
name|tmp
operator|.
name|x
operator|||
name|fb
operator|->
name|cursorP
operator|.
name|y
operator|!=
name|tmp
operator|.
name|y
condition|)
block|{
if|if
condition|(
name|fb
operator|->
name|cursorVis
condition|)
block|{
if|if
condition|(
operator|!
name|fb
operator|->
name|hard_cursor
condition|)
block|{
name|fbcopy3
argument_list|(
name|fb
operator|->
name|SaveRect
operator|.
name|origin
argument_list|,
name|fb
operator|->
name|cursorP
argument_list|)
expr_stmt|;
block|}
block|}
name|fb
operator|->
name|cursorP
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|hard_cursor
condition|)
block|{
name|fbbm_cursor_off
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|fbbm_cursor_move
argument_list|(
name|fb
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fb
operator|->
name|cursorVis
condition|)
block|{
if|if
condition|(
name|fb
operator|->
name|hard_cursor
condition|)
block|{
name|fbbm_cursor_on
argument_list|(
name|fb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fbcopy2
argument_list|(
name|fb
operator|->
name|cursorP
argument_list|,
name|fb
operator|->
name|SaveRect
operator|.
name|origin
argument_list|)
expr_stmt|;
name|fbcopy1
argument_list|(
name|fb
operator|->
name|MaskRect
operator|.
name|origin
argument_list|,
name|fb
operator|->
name|cursorP
argument_list|,
name|fb
operator|->
name|maskfuncv
argument_list|)
expr_stmt|;
name|fbcopy1
argument_list|(
name|fb
operator|->
name|CursorRect
operator|.
name|origin
argument_list|,
name|fb
operator|->
name|cursorP
argument_list|,
name|fb
operator|->
name|curfuncv
argument_list|)
expr_stmt|;
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|updateCursor
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|flag
parameter_list|)
name|int
modifier|*
name|x
decl_stmt|,
decl|*
name|y
decl_stmt|;
end_function

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|s
decl_stmt|;
if|if
condition|(
name|cfb
operator|&&
name|cfb
operator|->
name|cursorSet
condition|)
block|{
name|checkArea
argument_list|(
name|cfb
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|s
operator|=
name|spl7
argument_list|()
expr_stmt|;
name|mp
operator|.
name|x
operator|=
operator|*
name|x
operator|-
name|cfb
operator|->
name|hot
operator|.
name|x
expr_stmt|;
name|mp
operator|.
name|y
operator|=
operator|*
name|y
operator|-
name|cfb
operator|->
name|hot
operator|.
name|y
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
if|if
condition|(
name|flag
operator|||
name|cfb
operator|->
name|hard_cursor
condition|)
block|{
name|curs_pending
operator|=
literal|0
expr_stmt|;
name|redrawCursor
argument_list|(
name|cfb
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cfb
operator|->
name|type
operator|==
name|FB_LCDM
condition|)
block|{
if|if
condition|(
operator|!
name|lock_bitmap_poll
argument_list|()
condition|)
block|{
name|curs_pending
operator|=
literal|0
expr_stmt|;
name|redrawCursor
argument_list|(
name|cfb
argument_list|)
expr_stmt|;
name|unlock_bitmap_poll
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|curs_pending
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|#
directive|else
name|redrawCursor
argument_list|(
name|cfb
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_block

begin_expr_stmt
name|setCursor
argument_list|(
name|fb
argument_list|,
name|cursor
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lCursor2
modifier|*
name|cursor
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|fv
decl_stmt|;
specifier|register
name|int
name|f0
decl_stmt|,
name|f1
decl_stmt|,
name|i
decl_stmt|,
name|color
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
specifier|register
name|int
name|s
init|=
name|splbitmap
argument_list|()
decl_stmt|;
endif|#
directive|endif
name|int
name|data
decl_stmt|;
if|if
condition|(
name|cfb
operator|==
name|fb
condition|)
block|{
name|cursorOff
argument_list|(
name|cfb
argument_list|)
expr_stmt|;
name|fb
operator|->
name|cursorShow
operator|=
literal|0
expr_stmt|;
name|fb
operator|->
name|cursorP
operator|.
name|x
operator|+=
name|cfb
operator|->
name|hot
operator|.
name|x
expr_stmt|;
name|fb
operator|->
name|cursorP
operator|.
name|y
operator|+=
name|cfb
operator|->
name|hot
operator|.
name|y
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|data
operator|=
name|FB_INT_VSYNC
expr_stmt|;
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_INTCLEAR
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cfb
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|cursor
condition|)
block|{
name|fb
operator|->
name|CursorRect
operator|=
name|cursor
operator|->
name|cursorRect
expr_stmt|;
name|fb
operator|->
name|MaskRect
operator|=
name|cursor
operator|->
name|maskRect
expr_stmt|;
name|fb
operator|->
name|SaveRect
operator|=
name|cursor
operator|->
name|saveRect
expr_stmt|;
name|fb
operator|->
name|moveArea
operator|=
name|cursor
operator|->
name|moveArea
expr_stmt|;
name|fb
operator|->
name|hot
operator|=
name|cursor
operator|->
name|hot
expr_stmt|;
name|fb
operator|->
name|size
operator|=
name|cursor
operator|->
name|size
expr_stmt|;
name|f0
operator|=
literal|0x4
operator||
operator|(
operator|(
name|cursor
operator|->
name|func
operator|>>
literal|2
operator|)
operator|&
literal|0x3
operator|)
expr_stmt|;
name|f1
operator|=
literal|0x4
operator||
operator|(
name|cursor
operator|->
name|func
operator|&
literal|0x3
operator|)
expr_stmt|;
name|i
operator|=
name|fb
operator|->
name|fbNplane
expr_stmt|;
name|fv
operator|=
name|fb
operator|->
name|curfuncv
expr_stmt|;
name|color
operator|=
name|cursor
operator|->
name|cursor_color
expr_stmt|;
while|while
condition|(
name|i
operator|--
operator|>
literal|0
condition|)
block|{
operator|*
name|fv
operator|++
operator|=
operator|(
name|color
operator|&
literal|1
operator|)
condition|?
name|f1
else|:
name|f0
expr_stmt|;
name|color
operator|>>=
literal|1
expr_stmt|;
block|}
name|i
operator|=
name|fb
operator|->
name|fbNplane
expr_stmt|;
name|fv
operator|=
name|fb
operator|->
name|maskfuncv
expr_stmt|;
name|color
operator|=
name|cursor
operator|->
name|mask_color
expr_stmt|;
while|while
condition|(
name|i
operator|--
operator|>
literal|0
condition|)
block|{
operator|*
name|fv
operator|++
operator|=
operator|(
name|color
operator|&
literal|1
operator|)
condition|?
name|f1
else|:
name|f0
expr_stmt|;
name|color
operator|>>=
literal|1
expr_stmt|;
block|}
name|checkArea
argument_list|(
name|fb
argument_list|,
operator|&
name|fb
operator|->
name|cursorP
operator|.
name|x
argument_list|,
operator|&
name|fb
operator|->
name|cursorP
operator|.
name|y
argument_list|)
expr_stmt|;
name|fb
operator|->
name|cursorP
operator|.
name|x
operator|-=
name|fb
operator|->
name|hot
operator|.
name|x
expr_stmt|;
name|fb
operator|->
name|cursorP
operator|.
name|y
operator|-=
name|fb
operator|->
name|hot
operator|.
name|y
expr_stmt|;
name|fb
operator|->
name|cursorSet
operator|=
literal|1
expr_stmt|;
name|fb
operator|->
name|cursorShow
operator|=
literal|0
expr_stmt|;
name|fb
operator|->
name|cursorVis
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|hard_cursor
condition|)
block|{
name|fbbm_cursor_off
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|fbbm_cursor_set
argument_list|(
name|fb
argument_list|,
name|cursor
operator|->
name|cursor_color
argument_list|,
name|cursor
operator|->
name|mask_color
argument_list|)
expr_stmt|;
name|fbbm_cursor_move
argument_list|(
name|fb
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fb
operator|->
name|cursorP
operator|.
name|x
operator|=
name|fb
operator|->
name|VisRect
operator|.
name|extent
operator|.
name|x
operator|/
literal|2
expr_stmt|;
name|fb
operator|->
name|cursorP
operator|.
name|y
operator|=
name|fb
operator|->
name|VisRect
operator|.
name|extent
operator|.
name|y
operator|/
literal|2
expr_stmt|;
name|fb
operator|->
name|cursorSet
operator|=
literal|0
expr_stmt|;
name|fb
operator|->
name|cursorShow
operator|=
literal|0
expr_stmt|;
name|fb
operator|->
name|cursorVis
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|hard_cursor
condition|)
name|fbbm_cursor_off
argument_list|(
name|fb
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|showCursor
argument_list|(
name|fb
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|data
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
specifier|register
name|int
name|s
init|=
name|splbitmap
argument_list|()
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|fb
operator|->
name|cursorSet
operator|&&
operator|!
name|fb
operator|->
name|cursorShow
condition|)
block|{
if|if
condition|(
name|cfb
operator|&&
name|cfb
operator|!=
name|fb
condition|)
block|{
name|cursorOff
argument_list|(
name|cfb
argument_list|)
expr_stmt|;
name|cfb
operator|->
name|cursorShow
operator|=
literal|0
expr_stmt|;
block|}
name|cfb
operator|=
name|fb
expr_stmt|;
name|fb
operator|->
name|cursorShow
operator|=
literal|1
expr_stmt|;
name|mp
operator|=
name|fb
operator|->
name|cursorP
expr_stmt|;
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|data
operator|=
name|FB_INT_VSYNC
expr_stmt|;
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_INTENABLE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|FB_RERROR
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|hideCursor
argument_list|(
name|fb
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|data
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|int
name|s
init|=
name|splbitmap
argument_list|()
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cfb
operator|==
name|fb
condition|)
block|{
name|cursorOff
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|fb
operator|->
name|cursorShow
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|data
operator|=
name|FB_INT_VSYNC
expr_stmt|;
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_INTCLEAR
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|FB_RERROR
operator|)
return|;
block|}
end_block

begin_macro
name|moveCursor
argument_list|(
argument|fb
argument_list|,
argument|point
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lPoint
modifier|*
name|point
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|cfb
operator|==
name|fb
condition|)
block|{
name|updateCursor
argument_list|(
operator|&
name|point
operator|->
name|x
argument_list|,
operator|&
name|point
operator|->
name|y
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
return|return
operator|(
name|FB_RERROR
operator|)
return|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_macro
name|rop_xint
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|done
init|=
literal|0
decl_stmt|;
name|int
name|event
decl_stmt|,
name|data
decl_stmt|;
name|int
name|s
init|=
name|splbitmap
argument_list|()
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|fb
operator|=
name|fbdev
init|;
name|i
operator|<
name|nfbdev
condition|;
name|i
operator|++
operator|,
name|fb
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|type
operator|&&
operator|(
name|event
operator|=
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_INTCHECK
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|notyet
comment|/* KU:XXX */
name|intrcnt
index|[
name|INTR_BITMAP
index|]
operator|++
expr_stmt|;
endif|#
directive|endif
name|done
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|FB_INT_VSYNC
condition|)
block|{
name|data
operator|=
name|FB_INT_VSYNC
expr_stmt|;
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_INTCLEAR
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lock_bitmap_poll
argument_list|()
condition|)
block|{
name|curs_pending
operator|=
literal|0
expr_stmt|;
name|redrawCursor
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|unlock_bitmap_poll
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|curs_pending
operator|=
literal|1
expr_stmt|;
block|}
name|data
operator|=
name|FB_INT_VSYNC
expr_stmt|;
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_INTENABLE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|event
operator|&
name|FB_INT_ROPDONE
condition|)
block|{
if|if
condition|(
name|fb
operator|->
name|run_flag
operator|&
name|FB_WAITING
condition|)
block|{
name|data
operator|=
name|FB_INT_ROPDONE
expr_stmt|;
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_INTCLEAR
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_STATUSCHECK
argument_list|,
literal|0
argument_list|)
operator|&
operator|(
name|FB_STATUS_ROPWAIT
operator||
name|FB_STATUS_ROPEXEC
operator|)
operator|)
condition|)
block|{
name|fb
operator|->
name|run_flag
operator|&=
operator|~
name|FB_WAITING
expr_stmt|;
name|wakeup
argument_list|(
operator|&
operator|(
name|fb
operator|->
name|run_flag
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|data
operator|=
name|FB_INT_ROPDONE
operator||
literal|0x100
expr_stmt|;
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_INTENABLE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|done
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CPU_SINGLE */
end_comment

begin_expr_stmt
name|cliprect2
argument_list|(
name|sr
argument_list|,
name|sc
argument_list|,
name|dr
argument_list|,
name|dc
argument_list|)
specifier|register
name|lRectangle
operator|*
name|sr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lRectangle
modifier|*
name|sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lRectangle
modifier|*
name|dr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lRectangle
modifier|*
name|dc
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|d
decl_stmt|;
comment|/* src left/right edge */
if|if
condition|(
operator|(
name|d
operator|=
name|sr
operator|->
name|origin
operator|.
name|x
operator|-
name|sc
operator|->
name|origin
operator|.
name|x
operator|)
operator|<
literal|0
condition|)
block|{
name|sr
operator|->
name|extent
operator|.
name|x
operator|+=
name|d
expr_stmt|;
name|sr
operator|->
name|origin
operator|.
name|x
operator|-=
name|d
expr_stmt|;
name|dr
operator|->
name|origin
operator|.
name|x
operator|-=
name|d
expr_stmt|;
name|d
operator|=
name|sr
operator|->
name|extent
operator|.
name|x
operator|-
name|sc
operator|->
name|extent
operator|.
name|x
expr_stmt|;
block|}
else|else
name|d
operator|+=
name|sr
operator|->
name|extent
operator|.
name|x
operator|-
name|sc
operator|->
name|extent
operator|.
name|x
expr_stmt|;
if|if
condition|(
name|d
operator|>
literal|0
condition|)
name|sr
operator|->
name|extent
operator|.
name|x
operator|-=
name|d
expr_stmt|;
comment|/* src top/bottom edge */
if|if
condition|(
operator|(
name|d
operator|=
name|sr
operator|->
name|origin
operator|.
name|y
operator|-
name|sc
operator|->
name|origin
operator|.
name|y
operator|)
operator|<
literal|0
condition|)
block|{
name|sr
operator|->
name|extent
operator|.
name|y
operator|+=
name|d
expr_stmt|;
name|sr
operator|->
name|origin
operator|.
name|y
operator|-=
name|d
expr_stmt|;
name|dr
operator|->
name|origin
operator|.
name|y
operator|-=
name|d
expr_stmt|;
name|d
operator|=
name|sr
operator|->
name|extent
operator|.
name|y
operator|-
name|sc
operator|->
name|extent
operator|.
name|y
expr_stmt|;
block|}
else|else
name|d
operator|+=
name|sr
operator|->
name|extent
operator|.
name|y
operator|-
name|sc
operator|->
name|extent
operator|.
name|y
expr_stmt|;
if|if
condition|(
name|d
operator|>
literal|0
condition|)
name|sr
operator|->
name|extent
operator|.
name|y
operator|-=
name|d
expr_stmt|;
if|if
condition|(
name|sr
operator|->
name|extent
operator|.
name|x
operator|<=
literal|0
operator|||
name|sr
operator|->
name|extent
operator|.
name|y
operator|<=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* dst left/right edge */
if|if
condition|(
operator|(
name|d
operator|=
name|dr
operator|->
name|origin
operator|.
name|x
operator|-
name|dc
operator|->
name|origin
operator|.
name|x
operator|)
operator|<
literal|0
condition|)
block|{
name|dr
operator|->
name|origin
operator|.
name|x
operator|-=
name|d
expr_stmt|;
name|sr
operator|->
name|extent
operator|.
name|x
operator|+=
name|d
expr_stmt|;
name|sr
operator|->
name|origin
operator|.
name|x
operator|-=
name|d
expr_stmt|;
name|d
operator|=
name|sr
operator|->
name|extent
operator|.
name|x
operator|-
name|dc
operator|->
name|extent
operator|.
name|x
expr_stmt|;
block|}
else|else
name|d
operator|+=
name|sr
operator|->
name|extent
operator|.
name|x
operator|-
name|dc
operator|->
name|extent
operator|.
name|x
expr_stmt|;
if|if
condition|(
name|d
operator|>
literal|0
condition|)
name|sr
operator|->
name|extent
operator|.
name|x
operator|-=
name|d
expr_stmt|;
comment|/* dst top/bottom edge */
if|if
condition|(
operator|(
name|d
operator|=
name|dr
operator|->
name|origin
operator|.
name|y
operator|-
name|dc
operator|->
name|origin
operator|.
name|y
operator|)
operator|<
literal|0
condition|)
block|{
name|dr
operator|->
name|origin
operator|.
name|y
operator|-=
name|d
expr_stmt|;
name|sr
operator|->
name|extent
operator|.
name|y
operator|+=
name|d
expr_stmt|;
name|sr
operator|->
name|origin
operator|.
name|y
operator|-=
name|d
expr_stmt|;
name|d
operator|=
name|sr
operator|->
name|extent
operator|.
name|y
operator|-
name|dc
operator|->
name|extent
operator|.
name|y
expr_stmt|;
block|}
else|else
name|d
operator|+=
name|sr
operator|->
name|extent
operator|.
name|y
operator|-
name|dc
operator|->
name|extent
operator|.
name|y
expr_stmt|;
if|if
condition|(
name|d
operator|>
literal|0
condition|)
name|sr
operator|->
name|extent
operator|.
name|y
operator|-=
name|d
expr_stmt|;
if|if
condition|(
name|sr
operator|->
name|extent
operator|.
name|x
operator|<=
literal|0
operator|||
name|sr
operator|->
name|extent
operator|.
name|y
operator|<=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|dr
operator|->
name|extent
operator|=
name|sr
operator|->
name|extent
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|cliprect
argument_list|(
name|r
argument_list|,
name|crp
argument_list|,
name|p
argument_list|)
specifier|register
name|lRectangle
operator|*
name|r
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lRectangle
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|d
decl_stmt|;
comment|/* left edge */
if|if
condition|(
operator|(
name|d
operator|=
name|r
operator|->
name|origin
operator|.
name|x
operator|-
name|crp
operator|->
name|origin
operator|.
name|x
operator|)
operator|<
literal|0
condition|)
block|{
name|r
operator|->
name|extent
operator|.
name|x
operator|+=
name|d
expr_stmt|;
name|r
operator|->
name|origin
operator|.
name|x
operator|-=
name|d
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|p
operator|->
name|extent
operator|.
name|x
operator|+=
name|d
expr_stmt|;
name|p
operator|->
name|origin
operator|.
name|x
operator|-=
name|d
expr_stmt|;
block|}
name|d
operator|=
name|r
operator|->
name|extent
operator|.
name|x
operator|-
name|crp
operator|->
name|extent
operator|.
name|x
expr_stmt|;
block|}
else|else
name|d
operator|+=
name|r
operator|->
name|extent
operator|.
name|x
operator|-
name|crp
operator|->
name|extent
operator|.
name|x
expr_stmt|;
comment|/* right edge */
if|if
condition|(
name|d
operator|>
literal|0
condition|)
block|{
name|r
operator|->
name|extent
operator|.
name|x
operator|-=
name|d
expr_stmt|;
if|if
condition|(
name|p
condition|)
name|p
operator|->
name|extent
operator|.
name|x
operator|-=
name|d
expr_stmt|;
block|}
comment|/* top edge */
if|if
condition|(
operator|(
name|d
operator|=
name|r
operator|->
name|origin
operator|.
name|y
operator|-
name|crp
operator|->
name|origin
operator|.
name|y
operator|)
operator|<
literal|0
condition|)
block|{
name|r
operator|->
name|extent
operator|.
name|y
operator|+=
name|d
expr_stmt|;
name|r
operator|->
name|origin
operator|.
name|y
operator|-=
name|d
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|p
operator|->
name|extent
operator|.
name|y
operator|+=
name|d
expr_stmt|;
name|p
operator|->
name|origin
operator|.
name|y
operator|-=
name|d
expr_stmt|;
block|}
name|d
operator|=
name|r
operator|->
name|extent
operator|.
name|y
operator|-
name|crp
operator|->
name|extent
operator|.
name|y
expr_stmt|;
block|}
else|else
name|d
operator|+=
name|r
operator|->
name|extent
operator|.
name|y
operator|-
name|crp
operator|->
name|extent
operator|.
name|y
expr_stmt|;
comment|/* bottom edge */
if|if
condition|(
name|d
operator|>
literal|0
condition|)
block|{
name|r
operator|->
name|extent
operator|.
name|y
operator|-=
name|d
expr_stmt|;
if|if
condition|(
name|p
condition|)
name|p
operator|->
name|extent
operator|.
name|y
operator|-=
name|d
expr_stmt|;
block|}
return|return
operator|(
name|r
operator|->
name|extent
operator|.
name|x
operator|>
literal|0
operator|&&
name|r
operator|->
name|extent
operator|.
name|y
operator|>
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|getclip
argument_list|(
argument|fb
argument_list|,
argument|bmp
argument_list|,
argument|crp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lBitmap
modifier|*
name|bmp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* limit clip rectangle to bitmap rectangle */
if|if
condition|(
operator|!
name|cliprect
argument_list|(
name|crp
argument_list|,
operator|&
name|bmp
operator|->
name|rect
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* limit clip rectangle to frame buffer */
if|if
condition|(
operator|(
name|bmp
operator|->
name|type
operator|==
name|BM_FB
operator|)
operator|&&
operator|!
name|cliprect
argument_list|(
name|crp
argument_list|,
operator|&
name|fb
operator|->
name|FrameRect
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|clipsrc
argument_list|(
argument|fb
argument_list|,
argument|bmp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lBitmap
modifier|*
name|bmp
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* limit clip rectangle to frame buffer */
if|if
condition|(
name|bmp
operator|->
name|type
operator|==
name|BM_FB
operator|&&
operator|!
name|cliprect
argument_list|(
operator|&
name|bmp
operator|->
name|rect
argument_list|,
operator|&
name|fb
operator|->
name|FrameRect
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|setrop
argument_list|(
name|fb
argument_list|,
name|func
argument_list|,
name|pmask
argument_list|,
name|fore
argument_list|,
name|aux
argument_list|,
name|trans
argument_list|,
name|sbp
argument_list|,
name|dbp
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|unsigned
name|int
name|func
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pmask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|fore
decl_stmt|,
name|aux
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|trans
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lBitmap
modifier|*
name|sbp
decl_stmt|,
modifier|*
name|dbp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|funcp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|char
name|tmp
index|[
literal|4
index|]
decl_stmt|;
comment|/* set plane register */
name|fb
operator|->
name|Mode
operator|=
literal|0
expr_stmt|;
name|fb
operator|->
name|Pmask
operator|=
name|pmask
expr_stmt|;
name|fb
operator|->
name|func
operator|=
name|func
expr_stmt|;
name|fb
operator|->
name|fore
operator|=
name|fore
expr_stmt|;
name|fb
operator|->
name|aux
operator|=
name|aux
expr_stmt|;
name|fb
operator|->
name|trans
operator|=
name|trans
expr_stmt|;
if|if
condition|(
name|sbp
operator|->
name|depth
operator|>
literal|1
condition|)
name|fb
operator|->
name|Mode
operator||=
literal|2
expr_stmt|;
if|if
condition|(
name|dbp
operator|->
name|depth
operator|>
literal|1
condition|)
name|fb
operator|->
name|Mode
operator||=
literal|1
expr_stmt|;
comment|/* set rop function register */
name|func
operator|&=
literal|0xf
expr_stmt|;
name|tmp
index|[
literal|0
index|]
operator|=
name|TRANS
argument_list|(
name|trans
argument_list|,
operator|(
name|func
operator|&
literal|0x0c
operator|)
operator||
operator|(
name|func
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|1
index|]
operator|=
name|TRANS
argument_list|(
name|trans
argument_list|,
operator|(
name|func
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
name|func
operator|<<
literal|2
operator|)
operator|&
literal|0x0c
operator|)
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|2
index|]
operator|=
name|TRANS
argument_list|(
name|trans
argument_list|,
name|func
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|3
index|]
operator|=
name|TRANS
argument_list|(
name|trans
argument_list|,
operator|(
name|func
operator|<<
literal|2
operator|)
operator|&
literal|0x0c
operator||
name|func
operator|&
literal|3
argument_list|)
expr_stmt|;
name|funcp
operator|=
name|fb
operator|->
name|funcvec
expr_stmt|;
for|for
control|(
name|i
operator|=
name|fb
operator|->
name|fbNplane
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
control|)
block|{
operator|*
name|funcp
operator|++
operator|=
name|tmp
index|[
operator|(
operator|(
name|fore
operator|&
literal|1
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
name|aux
operator|&
literal|1
operator|)
index|]
expr_stmt|;
name|fore
operator|>>=
literal|1
expr_stmt|;
name|aux
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * bitblt within frame buffer  */
end_comment

begin_expr_stmt
name|bitblt_fb
argument_list|(
name|fb
argument_list|,
name|sbp
argument_list|,
name|srp
argument_list|,
name|dbp
argument_list|,
name|dpp
argument_list|,
name|crp
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source bitmap (FB) */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|srp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source rectangle */
end_comment

begin_decl_stmt
name|lBitmap
modifier|*
name|dbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination bitmap (FB) */
end_comment

begin_decl_stmt
name|lPoint
modifier|*
name|dpp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination point */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* clip region in destination */
end_comment

begin_block
block|{
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
specifier|register
name|int
name|wplane
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|sr
operator|=
operator|*
name|srp
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
operator|*
name|dpp
expr_stmt|;
if|if
condition|(
name|crp
operator|&&
operator|!
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|crp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|fbbm_rop_init
argument_list|(
name|fb
argument_list|,
name|fb
operator|->
name|funcvec
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
name|fb
operator|->
name|Pmask
operator|&=
literal|1
expr_stmt|;
case|case
name|MODE_NtoN
case|:
name|fbbm_rop_copy
argument_list|(
name|fb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|,
literal|0
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODE_1toN
case|:
name|fbbm_rop_copy
argument_list|(
name|fb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|,
literal|1
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODE_Nto1
case|:
name|wplane
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|sbp
operator|->
name|depth
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|wplane
condition|)
block|{
name|fbbm_rop_copy
argument_list|(
name|fb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|fb
operator|->
name|Pmask
operator|>>
literal|16
argument_list|)
expr_stmt|;
break|break;
block|}
name|wplane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * bitblt from main memory to frame buffer  */
end_comment

begin_expr_stmt
name|bitblt_tofb
argument_list|(
name|fb
argument_list|,
name|sbp
argument_list|,
name|srp
argument_list|,
name|dbp
argument_list|,
name|dpp
argument_list|,
name|crp
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source bitmap (MEM) */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|srp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source rectangle */
end_comment

begin_decl_stmt
name|lBitmap
modifier|*
name|dbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination bitmap (FB) */
end_comment

begin_decl_stmt
name|lPoint
modifier|*
name|dpp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination point */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* clip region in destination */
end_comment

begin_block
block|{
specifier|register
name|unsigned
name|p
decl_stmt|;
specifier|register
name|struct
name|fb_map
modifier|*
name|smap
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
name|m
decl_stmt|;
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
specifier|register
name|int
name|wplane
decl_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
specifier|extern
name|struct
name|fb_map
name|rommap
decl_stmt|;
specifier|register
name|int
name|pages
decl_stmt|;
endif|#
directive|endif
name|smap
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|sbp
operator|->
name|base
expr_stmt|;
name|sr
operator|=
operator|*
name|srp
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
operator|*
name|dpp
expr_stmt|;
if|if
condition|(
name|crp
operator|&&
operator|!
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|crp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|dr
operator|.
name|extent
operator|=
name|sr
operator|.
name|extent
expr_stmt|;
comment|/* transform source rectangle */
name|sr
operator|.
name|origin
operator|.
name|x
operator|-=
name|sbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|sr
operator|.
name|origin
operator|.
name|y
operator|-=
name|sbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
comment|/* 	 * check memory map specification 	 */
name|p
operator|=
name|smap
operator|->
name|fm_offset
expr_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
name|pages
operator|=
name|btoc
argument_list|(
name|smap
operator|->
name|fm_offset
operator|+
name|smap
operator|->
name|fm_count
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
name|fb_map_page
argument_list|(
name|smap
operator|->
name|fm_addr
argument_list|,
name|pages
argument_list|,
name|fb
operator|->
name|cache_off
condition|?
name|PG_S
operator||
name|PG_WP
operator||
name|PG_CI
else|:
name|PG_S
operator||
name|PG_WP
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
name|smap
operator|=
operator|&
name|rommap
expr_stmt|;
endif|#
directive|endif
name|wplane
operator|=
literal|1
expr_stmt|;
name|fbbm_rop_winit
argument_list|(
name|fb
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
name|fbbm_rop_write
argument_list|(
name|fb
argument_list|,
name|smap
argument_list|,
name|p
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
name|fb
operator|->
name|Pmask
operator|&
literal|0x01
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODE_1toN
case|:
name|fbbm_rop_write
argument_list|(
name|fb
argument_list|,
name|smap
argument_list|,
name|p
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODE_Nto1
case|:
name|m
operator|=
name|sbp
operator|->
name|width
operator|*
name|sbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sbp
operator|->
name|depth
condition|;
name|i
operator|++
operator|,
name|wplane
operator|<<=
literal|1
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|wplane
condition|)
block|{
name|p
operator|+=
operator|(
name|m
operator|*
name|i
operator|)
operator|<<
literal|1
expr_stmt|;
name|fbbm_rop_write
argument_list|(
name|fb
argument_list|,
name|smap
argument_list|,
name|p
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
name|wplane
argument_list|)
expr_stmt|;
break|break;
block|}
name|wplane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|MODE_NtoN
case|:
name|n
operator|=
name|min
argument_list|(
name|sbp
operator|->
name|depth
argument_list|,
name|fb
operator|->
name|fbNplane
argument_list|)
expr_stmt|;
name|m
operator|=
name|sbp
operator|->
name|width
operator|*
name|sbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|p
operator|+=
operator|(
name|m
operator|<<
literal|1
operator|)
operator|*
name|n
expr_stmt|;
name|wplane
operator|=
literal|1
operator|<<
operator|(
name|n
operator|-
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
comment|/* get next plane */
name|p
operator|-=
name|m
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|wplane
condition|)
name|fbbm_rop_write
argument_list|(
name|fb
argument_list|,
name|smap
argument_list|,
name|p
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
name|wplane
argument_list|)
expr_stmt|;
comment|/* next plane mask */
name|wplane
operator|>>=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * bitblt from frame buffer to main memroy  */
end_comment

begin_macro
name|bitblt_tomem
argument_list|(
argument|fb
argument_list|,
argument|sbp
argument_list|,
argument|srp
argument_list|,
argument|dbp
argument_list|,
argument|dpp
argument_list|,
argument|crp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source bitmap (FB) */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|srp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source rectangle */
end_comment

begin_decl_stmt
name|lBitmap
modifier|*
name|dbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination bitmap (MEM) */
end_comment

begin_decl_stmt
name|lPoint
modifier|*
name|dpp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination point */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* clip region in destination */
end_comment

begin_block
block|{
specifier|register
name|struct
name|fb_map
modifier|*
name|dmap
decl_stmt|;
specifier|register
name|unsigned
name|p
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
name|m
decl_stmt|;
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
name|int
name|plane
decl_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
specifier|extern
name|struct
name|fb_map
name|rommap
decl_stmt|;
specifier|register
name|int
name|pages
decl_stmt|;
endif|#
directive|endif
name|dmap
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|dbp
operator|->
name|base
expr_stmt|;
name|sr
operator|=
operator|*
name|srp
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
operator|*
name|dpp
expr_stmt|;
if|if
condition|(
name|crp
operator|&&
operator|!
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|crp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|dr
operator|.
name|extent
operator|=
name|sr
operator|.
name|extent
expr_stmt|;
name|dr
operator|.
name|origin
operator|.
name|x
operator|-=
name|dbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|dr
operator|.
name|origin
operator|.
name|y
operator|-=
name|dbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|p
operator|=
name|dmap
operator|->
name|fm_offset
expr_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
name|pages
operator|=
name|btoc
argument_list|(
name|dmap
operator|->
name|fm_offset
operator|+
name|dmap
operator|->
name|fm_count
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
name|fb_map_page
argument_list|(
name|dmap
operator|->
name|fm_addr
argument_list|,
name|pages
argument_list|,
name|PG_S
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
name|dmap
operator|=
operator|&
name|rommap
expr_stmt|;
endif|#
directive|endif
name|plane
operator|=
literal|1
expr_stmt|;
comment|/*	Wait for rop busy */
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
name|fbbm_rop_read
argument_list|(
name|fb
argument_list|,
name|dmap
argument_list|,
name|p
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODE_1toN
case|:
name|m
operator|=
operator|(
name|dbp
operator|->
name|width
operator|*
name|dbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|)
operator|<<
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dbp
operator|->
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
name|fbbm_rop_read
argument_list|(
name|fb
argument_list|,
name|dmap
argument_list|,
name|p
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
literal|0
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* next plane */
name|p
operator|+=
name|m
expr_stmt|;
name|plane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|MODE_Nto1
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sbp
operator|->
name|depth
condition|;
name|i
operator|++
operator|,
name|plane
operator|<<=
literal|1
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
block|{
name|fbbm_rop_read
argument_list|(
name|fb
argument_list|,
name|dmap
argument_list|,
name|p
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
name|MODE_NtoN
case|:
name|n
operator|=
name|min
argument_list|(
name|dbp
operator|->
name|depth
argument_list|,
name|fb
operator|->
name|fbNplane
argument_list|)
expr_stmt|;
name|m
operator|=
operator|(
name|dbp
operator|->
name|width
operator|*
name|dbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|)
operator|<<
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
name|fbbm_rop_read
argument_list|(
name|fb
argument_list|,
name|dmap
argument_list|,
name|p
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
name|i
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* next plane */
name|p
operator|+=
name|m
expr_stmt|;
name|plane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|bitblt_mem
argument_list|(
argument|fb
argument_list|,
argument|sbp
argument_list|,
argument|srp
argument_list|,
argument|dbp
argument_list|,
argument|dpp
argument_list|,
argument|crp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lRectangle
modifier|*
name|srp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lBitmap
modifier|*
name|dbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lPoint
modifier|*
name|dpp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|plane
decl_stmt|;
specifier|register
name|struct
name|fb_map
modifier|*
name|smap
decl_stmt|,
modifier|*
name|dmap
decl_stmt|;
specifier|register
name|unsigned
name|int
name|ps
decl_stmt|,
name|pd
decl_stmt|;
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
specifier|static
name|struct
name|fb_map
name|drommap
decl_stmt|;
name|int
name|spages
decl_stmt|,
name|dpages
decl_stmt|;
endif|#
directive|endif
name|smap
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|sbp
operator|->
name|base
expr_stmt|;
name|dmap
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|dbp
operator|->
name|base
expr_stmt|;
name|sr
operator|=
operator|*
name|srp
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
operator|*
name|dpp
expr_stmt|;
if|if
condition|(
name|crp
operator|&&
operator|!
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|crp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* normalize source/destination coordinates */
name|sr
operator|.
name|origin
operator|.
name|x
operator|-=
name|sbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|sr
operator|.
name|origin
operator|.
name|y
operator|-=
name|sbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|dr
operator|.
name|origin
operator|.
name|x
operator|-=
name|dbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|dr
operator|.
name|origin
operator|.
name|y
operator|-=
name|dbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|ps
operator|=
name|smap
operator|->
name|fm_offset
expr_stmt|;
name|pd
operator|=
name|dmap
operator|->
name|fm_offset
expr_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
name|spages
operator|=
name|btoc
argument_list|(
name|smap
operator|->
name|fm_offset
operator|+
name|smap
operator|->
name|fm_count
argument_list|)
expr_stmt|;
name|dpages
operator|=
name|btoc
argument_list|(
name|dmap
operator|->
name|fm_offset
operator|+
name|dmap
operator|->
name|fm_count
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
name|fb_map_page2
argument_list|(
name|smap
operator|->
name|fm_addr
argument_list|,
name|spages
argument_list|,
name|PG_S
operator||
name|PG_WP
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
name|drommap
operator|.
name|fm_vaddr
operator|=
name|fb_map_page2
argument_list|(
name|dmap
operator|->
name|fm_addr
argument_list|,
name|dpages
argument_list|,
name|PG_S
argument_list|)
expr_stmt|;
name|drommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
name|smap
operator|=
operator|&
name|rommap
expr_stmt|;
name|dmap
operator|=
operator|&
name|drommap
expr_stmt|;
endif|#
directive|endif
name|plane
operator|=
literal|0x1
expr_stmt|;
comment|/* plane 0 */
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
block|{
name|mem_to_mem
argument_list|(
name|fb
operator|->
name|funcvec
index|[
literal|0
index|]
argument_list|,
name|smap
argument_list|,
name|ps
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
name|dmap
argument_list|,
name|pd
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MODE_1toN
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dbp
operator|->
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
block|{
name|mem_to_mem
argument_list|(
name|fb
operator|->
name|funcvec
index|[
name|i
index|]
argument_list|,
name|smap
argument_list|,
name|ps
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
name|dmap
argument_list|,
name|pd
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|)
expr_stmt|;
block|}
name|pd
operator|+=
operator|(
name|dbp
operator|->
name|width
operator|*
name|dbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|)
operator|<<
literal|1
expr_stmt|;
name|plane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|MODE_Nto1
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sbp
operator|->
name|depth
condition|;
name|i
operator|++
operator|,
name|plane
operator|<<=
literal|1
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|<
name|sbp
operator|->
name|depth
condition|)
block|{
name|ps
operator|+=
operator|(
name|sbp
operator|->
name|width
operator|*
name|sbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|*
name|i
operator|)
operator|<<
literal|1
expr_stmt|;
name|mem_to_mem
argument_list|(
name|fb
operator|->
name|funcvec
index|[
name|i
index|]
argument_list|,
name|smap
argument_list|,
name|ps
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
name|dmap
argument_list|,
name|pd
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MODE_NtoN
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dbp
operator|->
name|depth
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
block|{
name|mem_to_mem
argument_list|(
name|fb
operator|->
name|funcvec
index|[
name|i
index|]
argument_list|,
name|smap
argument_list|,
name|ps
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
name|dmap
argument_list|,
name|pd
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|)
expr_stmt|;
block|}
name|ps
operator|+=
operator|(
name|sbp
operator|->
name|width
operator|*
name|sbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|)
operator|<<
literal|1
expr_stmt|;
name|pd
operator|+=
operator|(
name|dbp
operator|->
name|width
operator|*
name|dbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|)
operator|<<
literal|1
expr_stmt|;
name|plane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|IPC_MRX
name|page_unmap
argument_list|(
name|rommap
operator|.
name|fm_vaddr
argument_list|,
name|spages
argument_list|)
expr_stmt|;
name|page_unmap
argument_list|(
name|drommap
operator|.
name|fm_vaddr
argument_list|,
name|dpages
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|bitblt_nop
argument_list|()
end_macro

begin_block
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * bitblt from '0' bitmap to frame buffer  */
end_comment

begin_expr_stmt
name|bitblt_0tofb
argument_list|(
name|fb
argument_list|,
name|sbp
argument_list|,
name|srp
argument_list|,
name|dbp
argument_list|,
name|dpp
argument_list|,
name|crp
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source bitmap (0) */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|srp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source rectangle */
end_comment

begin_decl_stmt
name|lBitmap
modifier|*
name|dbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination bitmap (FB) */
end_comment

begin_decl_stmt
name|lPoint
modifier|*
name|dpp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination point */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* clip region in destination */
end_comment

begin_block
block|{
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
name|sr
operator|=
operator|*
name|srp
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
operator|*
name|dpp
expr_stmt|;
if|if
condition|(
name|crp
operator|&&
operator|!
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|crp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|dr
operator|.
name|extent
operator|=
name|sr
operator|.
name|extent
expr_stmt|;
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
case|case
name|MODE_Nto1
case|:
name|fb
operator|->
name|Pmask
operator|&=
literal|1
expr_stmt|;
break|break;
case|case
name|MODE_1toN
case|:
case|case
name|MODE_NtoN
case|:
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * write data into ROP data register 	 */
name|fbbm_rop_cinit
argument_list|(
name|fb
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fbbm_rop_clear
argument_list|(
name|fb
argument_list|,
operator|&
name|dr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * bitblt from '1' bitmap to frame buffer  */
end_comment

begin_expr_stmt
name|bitblt_1tofb
argument_list|(
name|fb
argument_list|,
name|sbp
argument_list|,
name|srp
argument_list|,
name|dbp
argument_list|,
name|dpp
argument_list|,
name|crp
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source bitmap (1) */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|srp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source rectangle */
end_comment

begin_decl_stmt
name|lBitmap
modifier|*
name|dbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination bitmap (FB) */
end_comment

begin_decl_stmt
name|lPoint
modifier|*
name|dpp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination point */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* clip region in destination */
end_comment

begin_block
block|{
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
name|sr
operator|=
operator|*
name|srp
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
operator|*
name|dpp
expr_stmt|;
if|if
condition|(
name|crp
operator|&&
operator|!
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|crp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|dr
operator|.
name|extent
operator|=
name|sr
operator|.
name|extent
expr_stmt|;
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
case|case
name|MODE_Nto1
case|:
comment|/* plane mask set */
name|fb
operator|->
name|Pmask
operator|&=
literal|0x1
expr_stmt|;
break|break;
case|case
name|MODE_1toN
case|:
case|case
name|MODE_NtoN
case|:
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * write data into ROP data register 	 */
name|fbbm_rop_cinit
argument_list|(
name|fb
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fbbm_rop_clear
argument_list|(
name|fb
argument_list|,
operator|&
name|dr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_ifndef
ifndef|#
directive|ifndef
name|CPU_DOUBLE
end_ifndef

begin_comment
comment|/*  * bitblt from '0' bitmap to main memory  */
end_comment

begin_expr_stmt
name|bitblt_0tomem
argument_list|(
name|fb
argument_list|,
name|sbp
argument_list|,
name|srp
argument_list|,
name|dbp
argument_list|,
name|dpp
argument_list|,
name|crp
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source bitmap (0) */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|srp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source rectangle */
end_comment

begin_decl_stmt
specifier|register
name|lBitmap
modifier|*
name|dbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination bitmap (MEM) */
end_comment

begin_decl_stmt
name|lPoint
modifier|*
name|dpp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination point */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* clip region in destination */
end_comment

begin_block
block|{
specifier|register
name|struct
name|fb_map
modifier|*
name|dmap
decl_stmt|;
specifier|register
name|unsigned
name|int
name|p
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|int
name|plane
decl_stmt|;
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
name|int
name|skip
decl_stmt|;
name|dmap
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|dbp
operator|->
name|base
expr_stmt|;
name|sr
operator|=
operator|*
name|srp
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
operator|*
name|dpp
expr_stmt|;
if|if
condition|(
name|crp
operator|&&
operator|!
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|crp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|dr
operator|.
name|extent
operator|=
name|sr
operator|.
name|extent
expr_stmt|;
name|dr
operator|.
name|origin
operator|.
name|x
operator|-=
name|dbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|dr
operator|.
name|origin
operator|.
name|y
operator|-=
name|dbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|p
operator|=
name|dmap
operator|->
name|fm_offset
expr_stmt|;
name|plane
operator|=
literal|0x1
expr_stmt|;
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
name|mem_clear
argument_list|(
name|fb
operator|->
name|funcvec
index|[
literal|0
index|]
argument_list|,
name|dmap
argument_list|,
name|p
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|dr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODE_1toN
case|:
case|case
name|MODE_NtoN
case|:
name|skip
operator|=
operator|(
name|dbp
operator|->
name|width
operator|*
name|dbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|)
operator|<<
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|dbp
operator|->
name|depth
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
name|mem_clear
argument_list|(
name|fb
operator|->
name|funcvec
index|[
name|i
index|]
argument_list|,
name|dmap
argument_list|,
name|p
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|dr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* next plane */
name|p
operator|+=
name|skip
expr_stmt|;
name|plane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|MODE_Nto1
case|:
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|sbp
operator|->
name|depth
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
block|{
name|mem_clear
argument_list|(
name|fb
operator|->
name|funcvec
index|[
name|i
index|]
argument_list|,
name|dmap
argument_list|,
name|p
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|dr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|plane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * bitblt from '1' bitmap to main memory  */
end_comment

begin_expr_stmt
name|bitblt_1tomem
argument_list|(
name|fb
argument_list|,
name|sbp
argument_list|,
name|srp
argument_list|,
name|dbp
argument_list|,
name|dpp
argument_list|,
name|crp
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source bitmap (1) */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|srp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source rectangle */
end_comment

begin_decl_stmt
specifier|register
name|lBitmap
modifier|*
name|dbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination bitmap (MEM) */
end_comment

begin_decl_stmt
name|lPoint
modifier|*
name|dpp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination point */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* clip region in destination */
end_comment

begin_block
block|{
specifier|register
name|struct
name|fb_map
modifier|*
name|dmap
decl_stmt|;
specifier|register
name|unsigned
name|p
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|int
name|plane
decl_stmt|;
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
name|int
name|skip
decl_stmt|;
name|dmap
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|dbp
operator|->
name|base
expr_stmt|;
name|sr
operator|=
operator|*
name|srp
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
operator|*
name|dpp
expr_stmt|;
if|if
condition|(
name|crp
operator|&&
operator|!
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|crp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|dr
operator|.
name|extent
operator|=
name|sr
operator|.
name|extent
expr_stmt|;
name|dr
operator|.
name|origin
operator|.
name|x
operator|-=
name|dbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|dr
operator|.
name|origin
operator|.
name|y
operator|-=
name|dbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|p
operator|=
name|dmap
operator|->
name|fm_offset
expr_stmt|;
name|plane
operator|=
literal|0x1
expr_stmt|;
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
name|mem_clear
argument_list|(
name|fb
operator|->
name|funcvec
index|[
literal|0
index|]
argument_list|,
name|dmap
argument_list|,
name|p
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|dr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODE_1toN
case|:
case|case
name|MODE_NtoN
case|:
name|skip
operator|=
operator|(
name|dbp
operator|->
name|width
operator|*
name|dbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|)
operator|<<
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|dbp
operator|->
name|depth
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
name|mem_clear
argument_list|(
name|fb
operator|->
name|funcvec
index|[
name|i
index|]
argument_list|,
name|dmap
argument_list|,
name|p
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|dr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* next plane */
name|p
operator|+=
name|skip
expr_stmt|;
name|plane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|MODE_Nto1
case|:
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|sbp
operator|->
name|depth
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|plane
condition|)
block|{
name|mem_clear
argument_list|(
name|fb
operator|->
name|funcvec
index|[
name|i
index|]
argument_list|,
name|dmap
argument_list|,
name|p
argument_list|,
name|dbp
operator|->
name|width
argument_list|,
operator|&
name|dr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|plane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !CPU_DOUBLE */
end_comment

begin_macro
name|int
argument_list|(
argument|*sel_ropfunc(stype, dtype)
argument_list|)
end_macro

begin_expr_stmt
operator|(
operator|)
name|int
name|stype
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* source bitmap type */
end_comment

begin_decl_stmt
name|int
name|dtype
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dest bitmap type */
end_comment

begin_block
block|{
if|if
condition|(
name|dtype
operator|==
name|BM_0
condition|)
return|return
operator|(
name|bitblt_nop
operator|)
return|;
if|if
condition|(
name|dtype
operator|==
name|BM_1
condition|)
return|return
operator|(
name|bitblt_nop
operator|)
return|;
ifdef|#
directive|ifdef
name|CPU_DOUBLE
switch|switch
condition|(
name|stype
condition|)
block|{
case|case
name|BM_FB
case|:
return|return
operator|(
name|dtype
operator|==
name|BM_FB
operator|)
condition|?
name|bitblt_fb
else|:
name|bitblt_tomem
return|;
break|break;
case|case
name|BM_MEM
case|:
return|return
operator|(
name|dtype
operator|==
name|BM_FB
operator|)
condition|?
name|bitblt_tofb
else|:
name|bitblt_mem
return|;
break|break;
case|case
name|BM_0
case|:
return|return
operator|(
name|dtype
operator|==
name|BM_FB
operator|)
condition|?
name|bitblt_0tofb
else|:
name|bitblt_nop
return|;
break|break;
case|case
name|BM_1
case|:
return|return
operator|(
name|dtype
operator|==
name|BM_FB
operator|)
condition|?
name|bitblt_1tofb
else|:
name|bitblt_nop
return|;
break|break;
block|}
else|#
directive|else
comment|/* CPU_DOUBLE */
switch|switch
condition|(
name|stype
condition|)
block|{
case|case
name|BM_FB
case|:
return|return
operator|(
name|dtype
operator|==
name|BM_FB
operator|)
condition|?
name|bitblt_fb
else|:
name|bitblt_tomem
return|;
break|break;
case|case
name|BM_MEM
case|:
return|return
operator|(
name|dtype
operator|==
name|BM_FB
operator|)
condition|?
name|bitblt_tofb
else|:
name|bitblt_mem
return|;
break|break;
case|case
name|BM_0
case|:
return|return
operator|(
name|dtype
operator|==
name|BM_FB
operator|)
condition|?
name|bitblt_0tofb
else|:
name|bitblt_0tomem
return|;
break|break;
case|case
name|BM_1
case|:
return|return
operator|(
name|dtype
operator|==
name|BM_FB
operator|)
condition|?
name|bitblt_1tofb
else|:
name|bitblt_1tomem
return|;
break|break;
block|}
endif|#
directive|endif
comment|/* CPU_DOUBLE */
return|return
operator|(
name|bitblt_nop
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|bitbltcmd
argument_list|(
name|fb
argument_list|,
name|cmd
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lBitblt
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lRectangle
name|cr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cr
operator|=
name|cmd
operator|->
name|destClip
expr_stmt|;
if|if
condition|(
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|,
operator|&
name|cr
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|clipsrc
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|setrop
argument_list|(
name|fb
argument_list|,
name|cmd
operator|->
name|func
argument_list|,
name|cmd
operator|->
name|planemask
argument_list|,
name|cmd
operator|->
name|fore_color
argument_list|,
name|cmd
operator|->
name|aux_color
argument_list|,
name|cmd
operator|->
name|transp
argument_list|,
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FB_RERROR
operator|)
return|;
name|cursorCheck
argument_list|(
name|fb
argument_list|,
name|cmd
operator|->
name|srcBitmap
operator|.
name|type
argument_list|,
operator|&
name|cmd
operator|->
name|srcRect
argument_list|,
name|cmd
operator|->
name|destBitmap
operator|.
name|type
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|(
operator|*
name|sel_ropfunc
argument_list|(
name|cmd
operator|->
name|srcBitmap
operator|.
name|type
argument_list|,
name|cmd
operator|->
name|destBitmap
operator|.
name|type
argument_list|)
operator|)
operator|(
name|fb
operator|,
operator|&
name|cmd
operator|->
name|srcBitmap
operator|,
operator|&
name|cmd
operator|->
name|srcRect
operator|,
operator|&
name|cmd
operator|->
name|destBitmap
operator|,
operator|&
name|cmd
operator|->
name|destPoint
operator|,
operator|&
name|cr
operator|)
expr_stmt|;
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|batch_bitblt_01tofb
argument_list|(
name|fb
argument_list|,
name|sbp
argument_list|,
name|clip
argument_list|,
name|sdp
argument_list|,
name|n
argument_list|,
name|sw
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source bitmap (MEM) */
end_comment

begin_decl_stmt
specifier|register
name|lRectangle
modifier|*
name|clip
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lSrcDest
modifier|*
name|sdp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sw
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|void
function_decl|(
modifier|*
name|rop_clear
function_decl|)
parameter_list|()
function_decl|;
name|lRectangle
modifier|*
name|srect
init|=
operator|&
name|sbp
operator|->
name|rect
decl_stmt|;
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
case|case
name|MODE_Nto1
case|:
name|fb
operator|->
name|Pmask
operator|&=
literal|1
expr_stmt|;
break|break;
case|case
name|MODE_1toN
case|:
case|case
name|MODE_NtoN
case|:
break|break;
default|default:
return|return
operator|(
name|FB_RERROR
operator|)
return|;
block|}
name|fbbm_rop_cinit
argument_list|(
name|fb
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|,
name|sw
argument_list|)
expr_stmt|;
name|rop_clear
operator|=
name|fb
operator|->
name|fbbm_op
operator|->
name|fb_rop_clear
expr_stmt|;
while|while
condition|(
operator|--
name|n
operator|>=
literal|0
condition|)
block|{
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
name|sr
operator|=
name|sdp
operator|->
name|srcRect
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
name|sdp
operator|->
name|destPoint
expr_stmt|;
if|if
condition|(
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
name|srect
argument_list|,
operator|&
name|dr
argument_list|,
name|clip
argument_list|)
condition|)
call|(
modifier|*
name|rop_clear
call|)
argument_list|(
name|fb
argument_list|,
operator|&
name|dr
argument_list|)
expr_stmt|;
name|sdp
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|batch_bitblt_fb
argument_list|(
name|fb
argument_list|,
name|sbp
argument_list|,
name|clip
argument_list|,
name|sdp
argument_list|,
name|n
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lRectangle
modifier|*
name|clip
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lSrcDest
modifier|*
name|sdp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|wplane
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
name|fbbm_rop_init
argument_list|(
name|fb
argument_list|,
name|fb
operator|->
name|funcvec
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
name|fb
operator|->
name|Pmask
operator|&=
literal|1
expr_stmt|;
while|while
condition|(
operator|--
name|n
operator|>=
literal|0
condition|)
block|{
name|sr
operator|=
name|sdp
operator|->
name|srcRect
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
name|sdp
operator|->
name|destPoint
expr_stmt|;
if|if
condition|(
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|clip
argument_list|)
condition|)
name|fbbm_rop_copy
argument_list|(
name|fb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|,
literal|0
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|)
expr_stmt|;
name|sdp
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|MODE_NtoN
case|:
while|while
condition|(
operator|--
name|n
operator|>=
literal|0
condition|)
block|{
name|sr
operator|=
name|sdp
operator|->
name|srcRect
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
name|sdp
operator|->
name|destPoint
expr_stmt|;
if|if
condition|(
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|clip
argument_list|)
condition|)
name|fbbm_rop_copy
argument_list|(
name|fb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|,
literal|0
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|)
expr_stmt|;
name|sdp
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|MODE_1toN
case|:
while|while
condition|(
operator|--
name|n
operator|>=
literal|0
condition|)
block|{
name|sr
operator|=
name|sdp
operator|->
name|srcRect
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
name|sdp
operator|->
name|destPoint
expr_stmt|;
if|if
condition|(
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|clip
argument_list|)
condition|)
name|fbbm_rop_copy
argument_list|(
name|fb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|,
literal|1
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|)
expr_stmt|;
name|sdp
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|MODE_Nto1
case|:
for|for
control|(
init|;
operator|--
name|n
operator|>=
literal|0
condition|;
name|sdp
operator|++
control|)
block|{
name|sr
operator|=
name|sdp
operator|->
name|srcRect
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
name|sdp
operator|->
name|destPoint
expr_stmt|;
if|if
condition|(
operator|!
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|clip
argument_list|)
condition|)
continue|continue;
name|wplane
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|sbp
operator|->
name|depth
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|wplane
condition|)
block|{
name|fbbm_rop_copy
argument_list|(
name|fb
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
operator|.
name|origin
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|fb
operator|->
name|Pmask
operator|>>
literal|16
argument_list|)
expr_stmt|;
break|break;
block|}
name|wplane
operator|<<=
literal|1
expr_stmt|;
block|}
block|}
break|break;
default|default:
return|return
operator|(
name|FB_RERROR
operator|)
return|;
block|}
block|}
end_block

begin_expr_stmt
specifier|static
name|batch_bitblt_tofb
argument_list|(
name|fb
argument_list|,
name|sbp
argument_list|,
name|dbp
argument_list|,
name|crp
argument_list|,
name|sdp
argument_list|,
name|n
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lBitmap
modifier|*
name|sbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* source bitmap (MEM) */
end_comment

begin_decl_stmt
name|lBitmap
modifier|*
name|dbp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* destination bitmap (FB) */
end_comment

begin_decl_stmt
name|lRectangle
modifier|*
name|crp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* clip region in destination */
end_comment

begin_decl_stmt
specifier|register
name|lSrcDest
modifier|*
name|sdp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|unsigned
name|p
decl_stmt|;
specifier|register
name|struct
name|fb_map
modifier|*
name|smap
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|m
decl_stmt|;
name|lRectangle
name|sr
decl_stmt|;
name|lRectangle
name|dr
decl_stmt|;
specifier|register
name|int
name|wplane
decl_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
specifier|extern
name|struct
name|fb_map
name|rommap
decl_stmt|;
specifier|register
name|int
name|pages
decl_stmt|;
endif|#
directive|endif
name|fbbm_rop_winit
argument_list|(
name|fb
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|n
operator|>=
literal|0
condition|)
block|{
name|sr
operator|=
name|sdp
operator|->
name|srcRect
expr_stmt|;
name|dr
operator|.
name|origin
operator|=
name|sdp
operator|->
name|destPoint
expr_stmt|;
if|if
condition|(
name|crp
operator|&&
operator|!
name|cliprect2
argument_list|(
operator|&
name|sr
argument_list|,
operator|&
name|sbp
operator|->
name|rect
argument_list|,
operator|&
name|dr
argument_list|,
name|crp
argument_list|)
condition|)
block|{
name|sdp
operator|++
expr_stmt|;
continue|continue;
block|}
name|dr
operator|.
name|extent
operator|=
name|sr
operator|.
name|extent
expr_stmt|;
comment|/* transform source rectangle */
name|sr
operator|.
name|origin
operator|.
name|x
operator|-=
name|sbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|sr
operator|.
name|origin
operator|.
name|y
operator|-=
name|sbp
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
comment|/* 		 * check memory map specification 		 */
name|smap
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|sbp
operator|->
name|base
expr_stmt|;
name|p
operator|=
name|smap
operator|->
name|fm_offset
expr_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
name|pages
operator|=
name|btoc
argument_list|(
name|smap
operator|->
name|fm_offset
operator|+
name|smap
operator|->
name|fm_count
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
name|fb_map_page
argument_list|(
name|smap
operator|->
name|fm_addr
argument_list|,
name|pages
argument_list|,
name|fb
operator|->
name|cache_off
condition|?
name|PG_S
operator||
name|PG_WP
operator||
name|PG_CI
else|:
name|PG_S
operator||
name|PG_WP
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
name|smap
operator|=
operator|&
name|rommap
expr_stmt|;
endif|#
directive|endif
name|wplane
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|fb
operator|->
name|Mode
condition|)
block|{
case|case
name|MODE_1to1
case|:
name|fbbm_rop_write
argument_list|(
name|fb
argument_list|,
name|smap
argument_list|,
name|p
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
name|fb
operator|->
name|Pmask
operator|&
literal|0x01
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODE_1toN
case|:
name|fbbm_rop_write
argument_list|(
name|fb
argument_list|,
name|smap
argument_list|,
name|p
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODE_Nto1
case|:
name|m
operator|=
name|sbp
operator|->
name|width
operator|*
name|sbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sbp
operator|->
name|depth
condition|;
name|i
operator|++
operator|,
name|wplane
operator|<<=
literal|1
control|)
block|{
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|wplane
condition|)
block|{
name|p
operator|+=
operator|(
name|m
operator|*
name|i
operator|)
operator|<<
literal|1
expr_stmt|;
name|fbbm_rop_write
argument_list|(
name|fb
argument_list|,
name|smap
argument_list|,
name|p
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
name|wplane
argument_list|)
expr_stmt|;
break|break;
block|}
name|wplane
operator|<<=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|MODE_NtoN
case|:
name|j
operator|=
name|min
argument_list|(
name|sbp
operator|->
name|depth
argument_list|,
name|fb
operator|->
name|fbNplane
argument_list|)
expr_stmt|;
name|m
operator|=
name|sbp
operator|->
name|width
operator|*
name|sbp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|p
operator|+=
operator|(
name|m
operator|<<
literal|1
operator|)
operator|*
name|j
expr_stmt|;
name|wplane
operator|=
literal|1
operator|<<
operator|(
name|j
operator|-
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|j
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
comment|/* get next plane */
name|p
operator|-=
name|m
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|fb
operator|->
name|Pmask
operator|&
name|wplane
condition|)
name|fbbm_rop_write
argument_list|(
name|fb
argument_list|,
name|smap
argument_list|,
name|p
argument_list|,
name|sbp
operator|->
name|width
argument_list|,
operator|&
name|sr
argument_list|,
operator|&
name|dr
argument_list|,
name|wplane
argument_list|)
expr_stmt|;
comment|/* next plane mask */
name|wplane
operator|>>=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sdp
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|batchbitbltcmd
argument_list|(
name|fb
argument_list|,
name|cmd
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lBatchBitblt
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|lSrcDest
modifier|*
name|sdp
decl_stmt|;
specifier|register
name|int
function_decl|(
modifier|*
name|blt
function_decl|)
parameter_list|()
function_decl|;
name|lRectangle
name|cr
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
name|unsigned
name|int
name|p
decl_stmt|;
endif|#
directive|endif
name|int
name|error
decl_stmt|;
if|if
condition|(
name|setrop
argument_list|(
name|fb
argument_list|,
name|cmd
operator|->
name|func
argument_list|,
name|cmd
operator|->
name|planemask
argument_list|,
name|cmd
operator|->
name|fore_color
argument_list|,
name|cmd
operator|->
name|aux_color
argument_list|,
name|cmd
operator|->
name|transp
argument_list|,
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FB_RERROR
operator|)
return|;
name|cr
operator|=
name|cmd
operator|->
name|destClip
expr_stmt|;
if|if
condition|(
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|,
operator|&
name|cr
argument_list|)
condition|)
return|return
operator|(
name|FB_ROK
operator|)
return|;
if|if
condition|(
operator|!
name|clipsrc
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|map
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
operator|(
name|cmd
operator|->
name|srcDestList
operator|)
expr_stmt|;
name|p
operator|=
name|map
operator|->
name|fm_offset
expr_stmt|;
name|sdp
operator|=
operator|(
name|lSrcDest
operator|*
operator|)
name|TypeAt
argument_list|(
name|map
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|#
directive|else
name|sdp
operator|=
name|cmd
operator|->
name|srcDestList
expr_stmt|;
endif|#
directive|endif
name|n
operator|=
name|cmd
operator|->
name|nSrcDest
expr_stmt|;
name|cursorCheck
argument_list|(
name|fb
argument_list|,
name|cmd
operator|->
name|srcBitmap
operator|.
name|type
argument_list|,
operator|&
name|cmd
operator|->
name|srcBitmap
operator|.
name|rect
argument_list|,
name|cmd
operator|->
name|destBitmap
operator|.
name|type
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
name|blt
operator|=
name|sel_ropfunc
argument_list|(
name|cmd
operator|->
name|srcBitmap
operator|.
name|type
argument_list|,
name|cmd
operator|->
name|destBitmap
operator|.
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|blt
operator|==
name|bitblt_0tofb
operator|||
name|blt
operator|==
name|bitblt_1tofb
condition|)
block|{
if|if
condition|(
name|error
operator|=
name|batch_bitblt_01tofb
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|cr
argument_list|,
name|sdp
argument_list|,
name|n
argument_list|,
name|blt
operator|==
name|bitblt_1tofb
argument_list|)
condition|)
block|{
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|blt
operator|==
name|bitblt_fb
condition|)
block|{
if|if
condition|(
name|error
operator|=
name|batch_bitblt_fb
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|cr
argument_list|,
name|sdp
argument_list|,
name|n
argument_list|)
condition|)
block|{
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|blt
operator|==
name|bitblt_tofb
condition|)
block|{
if|if
condition|(
name|error
operator|=
name|batch_bitblt_tofb
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|,
operator|&
name|cr
argument_list|,
name|sdp
argument_list|,
name|n
argument_list|)
condition|)
block|{
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
else|else
while|while
condition|(
operator|--
name|n
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|srcBitmap
argument_list|,
operator|&
name|sdp
operator|->
name|srcRect
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|,
operator|&
name|sdp
operator|->
name|destPoint
argument_list|,
operator|&
name|cr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_RERROR
operator|)
return|;
block|}
name|PRE_EMPT
expr_stmt|;
name|sdp
operator|++
expr_stmt|;
block|}
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_macro
name|tilebitbltcmd
argument_list|(
argument|fb
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lTileBitblt
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lRectangle
name|trect
decl_stmt|,
name|rect
decl_stmt|,
name|prect
decl_stmt|;
name|lPoint
name|dp
decl_stmt|;
specifier|register
name|int
name|dx
decl_stmt|;
name|int
name|dy
decl_stmt|;
specifier|register
name|int
name|offx
decl_stmt|,
name|offy
decl_stmt|;
specifier|register
name|int
name|xlen
decl_stmt|,
name|ylen
decl_stmt|;
name|int
name|first
decl_stmt|;
specifier|register
name|int
function_decl|(
modifier|*
name|blt
function_decl|)
parameter_list|()
function_decl|;
name|int
name|t
decl_stmt|;
name|rect
operator|=
name|cmd
operator|->
name|destRect
expr_stmt|;
name|prect
operator|=
name|cmd
operator|->
name|ptnRect
expr_stmt|;
if|if
condition|(
name|prect
operator|.
name|extent
operator|.
name|x
operator|<=
literal|0
operator|||
name|prect
operator|.
name|extent
operator|.
name|y
operator|<=
literal|0
condition|)
return|return;
if|if
condition|(
name|cmd
operator|->
name|ptnBitmap
operator|.
name|type
operator|==
name|BM_FB
operator|&&
operator|!
name|cliprect
argument_list|(
operator|&
name|cmd
operator|->
name|ptnBitmap
operator|.
name|rect
argument_list|,
operator|&
name|fb
operator|->
name|FrameRect
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
condition|)
return|return;
comment|/* clip pattern rectangle */
if|if
condition|(
operator|!
name|cliprect
argument_list|(
operator|&
name|prect
argument_list|,
operator|&
name|cmd
operator|->
name|ptnBitmap
operator|.
name|rect
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|,
operator|&
name|cmd
operator|->
name|destClip
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|cliprect
argument_list|(
operator|&
name|rect
argument_list|,
operator|&
name|cmd
operator|->
name|destClip
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
condition|)
return|return;
if|if
condition|(
name|setrop
argument_list|(
name|fb
argument_list|,
name|cmd
operator|->
name|func
argument_list|,
name|cmd
operator|->
name|planemask
argument_list|,
name|cmd
operator|->
name|fore_color
argument_list|,
name|cmd
operator|->
name|aux_color
argument_list|,
name|cmd
operator|->
name|transp
argument_list|,
operator|&
name|cmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FB_RERROR
operator|)
return|;
name|blt
operator|=
name|sel_ropfunc
argument_list|(
name|cmd
operator|->
name|ptnBitmap
operator|.
name|type
argument_list|,
name|cmd
operator|->
name|destBitmap
operator|.
name|type
argument_list|)
expr_stmt|;
name|offx
operator|=
name|MOD
argument_list|(
name|rect
operator|.
name|origin
operator|.
name|x
operator|-
name|cmd
operator|->
name|refPoint
operator|.
name|x
argument_list|,
name|prect
operator|.
name|extent
operator|.
name|x
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|offy
operator|=
name|MOD
argument_list|(
name|rect
operator|.
name|origin
operator|.
name|y
operator|-
name|cmd
operator|->
name|refPoint
operator|.
name|y
argument_list|,
name|prect
operator|.
name|extent
operator|.
name|y
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|dp
operator|=
name|rect
operator|.
name|origin
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|x
operator|=
name|prect
operator|.
name|origin
operator|.
name|x
operator|+
name|offx
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|y
operator|=
name|prect
operator|.
name|origin
operator|.
name|y
operator|+
name|offy
expr_stmt|;
name|dy
operator|=
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|cursorCheck
argument_list|(
name|fb
argument_list|,
name|cmd
operator|->
name|ptnBitmap
operator|.
name|type
argument_list|,
operator|&
name|prect
argument_list|,
name|cmd
operator|->
name|destBitmap
operator|.
name|type
argument_list|,
operator|&
name|rect
argument_list|)
expr_stmt|;
name|first
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|dy
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|first
condition|)
block|{
comment|/* for the first time */
name|ylen
operator|=
name|prect
operator|.
name|extent
operator|.
name|y
operator|-
name|offy
expr_stmt|;
name|ylen
operator|=
name|min
argument_list|(
name|ylen
argument_list|,
name|dy
argument_list|)
expr_stmt|;
name|trect
operator|.
name|extent
operator|.
name|y
operator|=
name|ylen
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|y
operator|=
name|prect
operator|.
name|origin
operator|.
name|y
operator|+
name|offy
expr_stmt|;
name|first
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ylen
operator|=
name|min
argument_list|(
name|prect
operator|.
name|extent
operator|.
name|y
argument_list|,
name|dy
argument_list|)
expr_stmt|;
name|trect
operator|.
name|extent
operator|.
name|y
operator|=
name|ylen
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|y
operator|=
name|prect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
block|}
name|dp
operator|.
name|x
operator|=
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|dx
operator|=
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|xlen
operator|=
name|prect
operator|.
name|extent
operator|.
name|x
operator|-
name|offx
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|x
operator|=
name|prect
operator|.
name|origin
operator|.
name|x
operator|+
name|offx
expr_stmt|;
if|if
condition|(
name|dx
operator|<
name|xlen
condition|)
block|{
name|trect
operator|.
name|extent
operator|.
name|x
operator|=
name|dx
expr_stmt|;
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|trect
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|,
operator|&
name|dp
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|trect
operator|.
name|extent
operator|.
name|x
operator|=
name|xlen
expr_stmt|;
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|trect
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|,
operator|&
name|dp
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|dp
operator|.
name|x
operator|+=
name|xlen
expr_stmt|;
name|dx
operator|-=
name|xlen
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|x
operator|=
name|prect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
while|while
condition|(
name|dx
operator|>
literal|0
condition|)
block|{
name|xlen
operator|=
name|min
argument_list|(
name|dx
argument_list|,
name|prect
operator|.
name|extent
operator|.
name|x
argument_list|)
expr_stmt|;
name|trect
operator|.
name|extent
operator|.
name|x
operator|=
name|xlen
expr_stmt|;
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
operator|&
name|cmd
operator|->
name|ptnBitmap
argument_list|,
operator|&
name|trect
argument_list|,
operator|&
name|cmd
operator|->
name|destBitmap
argument_list|,
operator|&
name|dp
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|dp
operator|.
name|x
operator|+=
name|xlen
expr_stmt|;
name|dx
operator|-=
name|xlen
expr_stmt|;
block|}
block|}
name|dp
operator|.
name|y
operator|+=
name|ylen
expr_stmt|;
name|dy
operator|-=
name|ylen
expr_stmt|;
block|}
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|bitblt3cmd
argument_list|(
argument|fb
argument_list|,
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lBitblt3
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_macro
name|draw_rectangle
argument_list|(
argument|fb
argument_list|,
argument|dp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lPrimRect
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lRectangle
name|trect
decl_stmt|,
name|rect
decl_stmt|,
name|prect
decl_stmt|;
name|lPoint
name|p
decl_stmt|;
specifier|register
name|int
name|dx
decl_stmt|;
name|int
name|dy
decl_stmt|;
specifier|register
name|int
name|offx
decl_stmt|,
name|offy
decl_stmt|;
specifier|register
name|int
name|xlen
decl_stmt|,
name|ylen
decl_stmt|;
name|int
name|first
decl_stmt|;
specifier|register
name|int
function_decl|(
modifier|*
name|blt
function_decl|)
parameter_list|()
function_decl|;
name|int
name|t
decl_stmt|;
name|rect
operator|=
name|dp
operator|->
name|rect
expr_stmt|;
name|prect
operator|=
name|dp
operator|->
name|ptnRect
expr_stmt|;
if|if
condition|(
name|prect
operator|.
name|extent
operator|.
name|x
operator|<=
literal|0
operator|||
name|prect
operator|.
name|extent
operator|.
name|y
operator|<=
literal|0
condition|)
return|return;
if|if
condition|(
name|dp
operator|->
name|ptnBM
operator|.
name|type
operator|==
name|BM_FB
operator|&&
operator|!
name|cliprect
argument_list|(
operator|&
name|dp
operator|->
name|ptnBM
operator|.
name|rect
argument_list|,
operator|&
name|fb
operator|->
name|FrameRect
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
condition|)
return|return;
comment|/* clip pattern rectangle */
if|if
condition|(
operator|!
name|cliprect
argument_list|(
operator|&
name|prect
argument_list|,
operator|&
name|dp
operator|->
name|ptnBM
operator|.
name|rect
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
operator|&
name|dp
operator|->
name|clip
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|cliprect
argument_list|(
operator|&
name|rect
argument_list|,
operator|&
name|dp
operator|->
name|clip
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
condition|)
return|return;
if|if
condition|(
name|setrop
argument_list|(
name|fb
argument_list|,
name|dp
operator|->
name|func
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
name|dp
operator|->
name|fore_color
argument_list|,
name|dp
operator|->
name|aux_color
argument_list|,
name|dp
operator|->
name|transp
argument_list|,
operator|&
name|dp
operator|->
name|ptnBM
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FB_RERROR
operator|)
return|;
name|blt
operator|=
name|sel_ropfunc
argument_list|(
name|dp
operator|->
name|ptnBM
operator|.
name|type
argument_list|,
name|dp
operator|->
name|drawBM
operator|.
name|type
argument_list|)
expr_stmt|;
name|offx
operator|=
name|MOD
argument_list|(
name|rect
operator|.
name|origin
operator|.
name|x
operator|-
name|dp
operator|->
name|refPoint
operator|.
name|x
argument_list|,
name|prect
operator|.
name|extent
operator|.
name|x
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|offy
operator|=
name|MOD
argument_list|(
name|rect
operator|.
name|origin
operator|.
name|y
operator|-
name|dp
operator|->
name|refPoint
operator|.
name|y
argument_list|,
name|prect
operator|.
name|extent
operator|.
name|y
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|p
operator|=
name|rect
operator|.
name|origin
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|x
operator|=
name|prect
operator|.
name|origin
operator|.
name|x
operator|+
name|offx
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|y
operator|=
name|prect
operator|.
name|origin
operator|.
name|y
operator|+
name|offy
expr_stmt|;
name|dy
operator|=
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|cursorCheck
argument_list|(
name|fb
argument_list|,
name|dp
operator|->
name|ptnBM
operator|.
name|type
argument_list|,
operator|&
name|prect
argument_list|,
name|dp
operator|->
name|drawBM
operator|.
name|type
argument_list|,
operator|&
name|rect
argument_list|)
expr_stmt|;
name|first
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|dy
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|first
condition|)
block|{
comment|/* for the first time */
name|ylen
operator|=
name|prect
operator|.
name|extent
operator|.
name|y
operator|-
name|offy
expr_stmt|;
name|ylen
operator|=
name|min
argument_list|(
name|ylen
argument_list|,
name|dy
argument_list|)
expr_stmt|;
name|trect
operator|.
name|extent
operator|.
name|y
operator|=
name|ylen
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|y
operator|=
name|prect
operator|.
name|origin
operator|.
name|y
operator|+
name|offy
expr_stmt|;
name|first
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ylen
operator|=
name|min
argument_list|(
name|prect
operator|.
name|extent
operator|.
name|y
argument_list|,
name|dy
argument_list|)
expr_stmt|;
name|trect
operator|.
name|extent
operator|.
name|y
operator|=
name|ylen
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|y
operator|=
name|prect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
block|}
name|p
operator|.
name|x
operator|=
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|dx
operator|=
name|rect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|xlen
operator|=
name|prect
operator|.
name|extent
operator|.
name|x
operator|-
name|offx
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|x
operator|=
name|prect
operator|.
name|origin
operator|.
name|x
operator|+
name|offx
expr_stmt|;
if|if
condition|(
name|dx
operator|<
name|xlen
condition|)
block|{
name|trect
operator|.
name|extent
operator|.
name|x
operator|=
name|dx
expr_stmt|;
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
operator|&
name|dp
operator|->
name|ptnBM
argument_list|,
operator|&
name|trect
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
operator|&
name|p
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|trect
operator|.
name|extent
operator|.
name|x
operator|=
name|xlen
expr_stmt|;
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
operator|&
name|dp
operator|->
name|ptnBM
argument_list|,
operator|&
name|trect
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
operator|&
name|p
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|p
operator|.
name|x
operator|+=
name|xlen
expr_stmt|;
name|dx
operator|-=
name|xlen
expr_stmt|;
name|trect
operator|.
name|origin
operator|.
name|x
operator|=
name|prect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
while|while
condition|(
name|dx
operator|>
literal|0
condition|)
block|{
name|xlen
operator|=
name|min
argument_list|(
name|dx
argument_list|,
name|prect
operator|.
name|extent
operator|.
name|x
argument_list|)
expr_stmt|;
name|trect
operator|.
name|extent
operator|.
name|x
operator|=
name|xlen
expr_stmt|;
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
operator|&
name|dp
operator|->
name|ptnBM
argument_list|,
operator|&
name|trect
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
operator|&
name|p
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|p
operator|.
name|x
operator|+=
name|xlen
expr_stmt|;
name|dx
operator|-=
name|xlen
expr_stmt|;
block|}
block|}
name|p
operator|.
name|y
operator|+=
name|ylen
expr_stmt|;
name|dy
operator|-=
name|ylen
expr_stmt|;
block|}
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|draw_polymarker
argument_list|(
argument|fb
argument_list|,
argument|dp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lPrimMarker
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|lPoint
modifier|*
name|ps
decl_stmt|;
specifier|register
name|int
name|np
decl_stmt|;
name|lRectangle
name|cr
decl_stmt|;
specifier|register
name|int
function_decl|(
modifier|*
name|blt
function_decl|)
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
name|unsigned
name|int
name|p
decl_stmt|;
endif|#
directive|endif
name|cr
operator|=
name|dp
operator|->
name|clip
expr_stmt|;
if|if
condition|(
operator|(
name|dp
operator|->
name|drawBM
operator|.
name|type
operator|==
name|BM_FB
operator|)
operator|&&
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
operator|&
name|cr
argument_list|)
condition|)
return|return
operator|(
name|FB_ROK
operator|)
return|;
if|if
condition|(
name|dp
operator|->
name|ptnBM
operator|.
name|type
operator|==
name|BM_FB
operator|&&
operator|!
name|cliprect
argument_list|(
operator|&
name|dp
operator|->
name|ptnBM
operator|.
name|rect
argument_list|,
operator|&
name|fb
operator|->
name|FrameRect
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
condition|)
return|return
operator|(
name|FB_ROK
operator|)
return|;
if|if
condition|(
name|setrop
argument_list|(
name|fb
argument_list|,
name|dp
operator|->
name|func
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
name|dp
operator|->
name|fore_color
argument_list|,
name|dp
operator|->
name|aux_color
argument_list|,
name|dp
operator|->
name|transp
argument_list|,
operator|&
name|dp
operator|->
name|ptnBM
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FB_RERROR
operator|)
return|;
name|blt
operator|=
name|sel_ropfunc
argument_list|(
name|dp
operator|->
name|ptnBM
operator|.
name|type
argument_list|,
name|dp
operator|->
name|drawBM
operator|.
name|type
argument_list|)
expr_stmt|;
name|cursorCheck
argument_list|(
name|fb
argument_list|,
name|dp
operator|->
name|ptnBM
operator|.
name|type
argument_list|,
operator|&
operator|(
name|dp
operator|->
name|ptnRect
operator|)
argument_list|,
name|dp
operator|->
name|drawBM
operator|.
name|type
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|map
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
operator|(
name|dp
operator|->
name|plist
operator|)
expr_stmt|;
name|p
operator|=
name|map
operator|->
name|fm_offset
expr_stmt|;
name|ps
operator|=
operator|(
name|lPoint
operator|*
operator|)
name|TypeAt
argument_list|(
name|map
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|#
directive|else
name|ps
operator|=
name|dp
operator|->
name|plist
expr_stmt|;
endif|#
directive|endif
name|np
operator|=
name|dp
operator|->
name|np
expr_stmt|;
while|while
condition|(
operator|--
name|np
operator|>=
literal|0
condition|)
block|{
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
operator|&
name|dp
operator|->
name|ptnBM
argument_list|,
operator|&
name|dp
operator|->
name|ptnRect
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
name|ps
operator|++
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
block|}
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_decl_stmt
specifier|static
name|int
name|patternx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|patterny
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|patternwidth
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|lBitmap
modifier|*
name|pbm
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* pattern bitmap */
end_comment

begin_decl_stmt
specifier|static
name|lBitmap
modifier|*
name|drawbm
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* drawing bitmap */
end_comment

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|blt
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_expr_stmt
specifier|static
name|fill_line
argument_list|(
name|fb
argument_list|,
name|len
argument_list|,
name|dp
argument_list|,
name|offx
argument_list|,
name|offy
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lPoint
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|offx
decl_stmt|,
name|offy
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|plen
decl_stmt|;
specifier|static
name|lRectangle
name|srec
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|}
decl_stmt|;
name|srec
operator|.
name|origin
operator|.
name|x
operator|=
name|patternx
operator|+
name|offx
expr_stmt|;
name|srec
operator|.
name|origin
operator|.
name|y
operator|=
name|patterny
operator|+
name|offy
expr_stmt|;
if|if
condition|(
operator|(
name|plen
operator|=
name|patternwidth
operator|-
name|offx
operator|)
operator|>
name|len
condition|)
block|{
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|len
expr_stmt|;
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
name|pbm
argument_list|,
operator|&
name|srec
argument_list|,
name|drawbm
argument_list|,
name|dp
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|plen
expr_stmt|;
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
name|pbm
argument_list|,
operator|&
name|srec
argument_list|,
name|drawbm
argument_list|,
name|dp
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|dp
operator|->
name|x
operator|+=
name|plen
expr_stmt|;
name|len
operator|-=
name|plen
expr_stmt|;
name|srec
operator|.
name|origin
operator|.
name|x
operator|=
name|patternx
expr_stmt|;
name|plen
operator|=
name|patternwidth
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|min
argument_list|(
name|plen
argument_list|,
name|len
argument_list|)
expr_stmt|;
call|(
modifier|*
name|blt
call|)
argument_list|(
name|fb
argument_list|,
name|pbm
argument_list|,
operator|&
name|srec
argument_list|,
name|drawbm
argument_list|,
name|dp
argument_list|,
operator|(
name|lRectangle
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|dp
operator|->
name|x
operator|+=
name|plen
expr_stmt|;
name|len
operator|-=
name|plen
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|fill_scan
argument_list|(
name|fb
argument_list|,
name|fdata
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lPrimFill
modifier|*
name|fdata
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|lScanl
modifier|*
name|ls
decl_stmt|;
name|int
name|nscan
decl_stmt|;
name|lRectangle
name|clip
decl_stmt|;
name|lRectangle
name|prect
decl_stmt|;
specifier|register
name|int
name|minx
decl_stmt|,
name|maxx
decl_stmt|,
name|miny
decl_stmt|,
name|maxy
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
endif|#
directive|endif
specifier|register
name|void
function_decl|(
modifier|*
name|rop_clear
function_decl|)
parameter_list|()
function_decl|;
name|int
argument_list|(
operator|*
name|sel_ropfunc
argument_list|()
argument_list|)
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|nscan
operator|=
name|fdata
operator|->
name|nscan
operator|)
operator|<=
literal|0
condition|)
return|return
operator|(
name|FB_RERROR
operator|)
return|;
comment|/* clip pattern rectangle */
name|prect
operator|=
name|fdata
operator|->
name|ptnRect
expr_stmt|;
if|if
condition|(
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|fdata
operator|->
name|ptnBM
argument_list|,
operator|&
name|prect
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|prect
operator|.
name|extent
operator|.
name|x
operator|<=
literal|0
operator|||
name|prect
operator|.
name|extent
operator|.
name|y
operator|<=
literal|0
condition|)
return|return
operator|(
name|FB_RERROR
operator|)
return|;
comment|/* clip clip rectangle */
name|clip
operator|=
name|fdata
operator|->
name|clip
expr_stmt|;
if|if
condition|(
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|fdata
operator|->
name|drawBM
argument_list|,
operator|&
name|clip
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|setrop
argument_list|(
name|fb
argument_list|,
name|fdata
operator|->
name|func
argument_list|,
name|fdata
operator|->
name|planemask
argument_list|,
name|fdata
operator|->
name|fore_color
argument_list|,
name|fdata
operator|->
name|aux_color
argument_list|,
name|fdata
operator|->
name|transp
argument_list|,
operator|&
name|fdata
operator|->
name|ptnBM
argument_list|,
operator|&
name|fdata
operator|->
name|drawBM
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FB_RERROR
operator|)
return|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|map
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
operator|(
name|fdata
operator|->
name|scan
operator|)
expr_stmt|;
name|ls
operator|=
operator|(
name|lScanl
operator|*
operator|)
name|TypeAt
argument_list|(
name|map
argument_list|,
name|map
operator|->
name|fm_offset
argument_list|)
expr_stmt|;
else|#
directive|else
name|ls
operator|=
name|fdata
operator|->
name|scan
expr_stmt|;
endif|#
directive|endif
name|minx
operator|=
name|clip
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|maxx
operator|=
name|minx
operator|+
name|clip
operator|.
name|extent
operator|.
name|x
operator|-
literal|1
expr_stmt|;
name|miny
operator|=
name|clip
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|maxy
operator|=
name|miny
operator|+
name|clip
operator|.
name|extent
operator|.
name|y
operator|-
literal|1
expr_stmt|;
name|cursorCheck
argument_list|(
name|fb
argument_list|,
name|fdata
operator|->
name|ptnBM
operator|.
name|type
argument_list|,
operator|&
name|prect
argument_list|,
name|fdata
operator|->
name|drawBM
operator|.
name|type
argument_list|,
operator|&
name|clip
argument_list|)
expr_stmt|;
name|blt
operator|=
name|sel_ropfunc
argument_list|(
name|fdata
operator|->
name|ptnBM
operator|.
name|type
argument_list|,
name|fdata
operator|->
name|drawBM
operator|.
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|blt
operator|==
name|bitblt_1tofb
operator|||
name|blt
operator|==
name|bitblt_0tofb
condition|)
block|{
name|lRectangle
name|dr
decl_stmt|;
if|if
condition|(
name|fb
operator|->
name|fbbm_op
operator|->
name|fb_rop_fillscan
operator|!=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|nofunc
condition|)
block|{
name|fbbm_rop_fillscan
argument_list|(
name|fb
argument_list|,
name|ls
argument_list|,
name|nscan
argument_list|,
operator|&
name|clip
argument_list|,
name|blt
operator|==
name|bitblt_1tofb
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dr
operator|.
name|extent
operator|.
name|y
operator|=
literal|1
expr_stmt|;
name|fbbm_rop_cinit
argument_list|(
name|fb
argument_list|,
name|fb
operator|->
name|Pmask
argument_list|,
name|blt
operator|==
name|bitblt_1tofb
argument_list|)
expr_stmt|;
name|rop_clear
operator|=
name|fb
operator|->
name|fbbm_op
operator|->
name|fb_rop_clear
expr_stmt|;
while|while
condition|(
operator|--
name|nscan
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|dr
operator|.
name|origin
operator|.
name|y
operator|=
name|ls
operator|->
name|y
operator|)
operator|>=
name|miny
operator|&&
name|dr
operator|.
name|origin
operator|.
name|y
operator|<=
name|maxy
condition|)
block|{
name|dr
operator|.
name|origin
operator|.
name|x
operator|=
name|max
argument_list|(
name|ls
operator|->
name|x0
argument_list|,
name|minx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dr
operator|.
name|extent
operator|.
name|x
operator|=
name|min
argument_list|(
name|ls
operator|->
name|x1
argument_list|,
name|maxx
argument_list|)
operator|-
name|dr
operator|.
name|origin
operator|.
name|x
operator|+
literal|1
operator|)
operator|>
literal|0
condition|)
call|(
modifier|*
name|rop_clear
call|)
argument_list|(
name|fb
argument_list|,
operator|&
name|dr
argument_list|)
expr_stmt|;
block|}
name|ls
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|int
name|len
decl_stmt|;
name|int
name|refx
decl_stmt|,
name|refy
decl_stmt|;
name|lPoint
name|dp
decl_stmt|;
name|int
name|sizex
decl_stmt|,
name|sizey
decl_stmt|;
name|int
name|t
decl_stmt|;
name|sizex
operator|=
name|prect
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|sizey
operator|=
name|prect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|refx
operator|=
name|fdata
operator|->
name|refPoint
operator|.
name|x
expr_stmt|;
name|refy
operator|=
name|fdata
operator|->
name|refPoint
operator|.
name|y
expr_stmt|;
name|patternx
operator|=
name|prect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|patterny
operator|=
name|prect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|patternwidth
operator|=
name|sizex
expr_stmt|;
name|pbm
operator|=
operator|&
name|fdata
operator|->
name|ptnBM
expr_stmt|;
name|drawbm
operator|=
operator|&
name|fdata
operator|->
name|drawBM
expr_stmt|;
while|while
condition|(
operator|--
name|nscan
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|dp
operator|.
name|y
operator|=
name|ls
operator|->
name|y
operator|)
operator|>=
name|miny
operator|&&
name|dp
operator|.
name|y
operator|<=
name|maxy
condition|)
block|{
name|dp
operator|.
name|x
operator|=
name|max
argument_list|(
name|ls
operator|->
name|x0
argument_list|,
name|minx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|min
argument_list|(
name|ls
operator|->
name|x1
argument_list|,
name|maxx
argument_list|)
operator|-
name|dp
operator|.
name|x
operator|+
literal|1
operator|)
operator|>
literal|0
condition|)
name|fill_line
argument_list|(
name|fb
argument_list|,
name|len
argument_list|,
operator|&
name|dp
argument_list|,
name|MOD
argument_list|(
operator|(
name|dp
operator|.
name|x
operator|-
name|refx
operator|)
argument_list|,
name|sizex
argument_list|,
name|t
argument_list|)
argument_list|,
name|MOD
argument_list|(
operator|(
name|dp
operator|.
name|y
operator|-
name|refy
operator|)
argument_list|,
name|sizey
argument_list|,
name|t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ls
operator|++
expr_stmt|;
block|}
block|}
name|out
label|:
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_macro
name|put_string
argument_list|(
argument|fb
argument_list|,
argument|sdata
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lPrimText
modifier|*
name|sdata
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
specifier|register
name|int
name|ex_factor
init|=
name|sdata
operator|->
name|ex_factor
decl_stmt|;
specifier|register
name|unsigned
name|c
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|len
init|=
name|sdata
operator|->
name|len
decl_stmt|;
name|int
name|flen
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|l
decl_stmt|;
name|unsigned
name|fchar
init|=
name|sdata
operator|->
name|first_chr
decl_stmt|;
name|unsigned
name|lchar
init|=
name|sdata
operator|->
name|last_chr
decl_stmt|;
name|lRectangle
name|cr
decl_stmt|,
name|save
decl_stmt|;
specifier|register
name|int
function_decl|(
modifier|*
name|bltfunc
function_decl|)
parameter_list|()
function_decl|;
specifier|register
name|char
modifier|*
name|f_addr
decl_stmt|;
comment|/* font address */
specifier|register
name|char
modifier|*
modifier|*
name|fnt_addr
decl_stmt|;
specifier|static
name|struct
name|fb_map
name|rommap
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
name|unsigned
name|int
name|p
decl_stmt|;
endif|#
directive|endif
name|lBitmap
modifier|*
name|fontBM
decl_stmt|;
name|lRectangle
name|srec
decl_stmt|;
name|lPoint
name|dp
decl_stmt|;
specifier|extern
name|int
name|tmode
decl_stmt|;
comment|/* in ../bm/vt100if.c */
name|x
operator|=
name|sdata
operator|->
name|p
operator|.
name|x
operator|<<
literal|16
expr_stmt|;
name|y
operator|=
name|sdata
operator|->
name|p
operator|.
name|y
operator|<<
literal|16
expr_stmt|;
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|sdata
operator|->
name|width
expr_stmt|;
name|srec
operator|.
name|extent
operator|.
name|y
operator|=
name|sdata
operator|->
name|height
expr_stmt|;
switch|switch
condition|(
name|sdata
operator|->
name|type
condition|)
block|{
case|case
name|ASCII
case|:
name|fontBM
operator|=
operator|&
name|sdata
operator|->
name|fontBM
expr_stmt|;
break|break;
case|case
name|ROM_ASCII
case|:
case|case
name|ROM_CONS
case|:
if|if
condition|(
name|sdata
operator|->
name|width
operator|>=
literal|12
operator|&&
name|sdata
operator|->
name|height
operator|>=
literal|24
condition|)
block|{
if|if
condition|(
name|fb
operator|->
name|Krom_BM1
operator|.
name|type
operator|==
operator|(
name|char
operator|)
literal|0xff
condition|)
block|{
name|fontBM
operator|=
operator|&
name|fb
operator|->
name|Krom_BM0
expr_stmt|;
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|fb
operator|->
name|Krom_font_extent0
operator|.
name|x
operator|>>
literal|1
expr_stmt|;
name|srec
operator|.
name|extent
operator|.
name|y
operator|=
name|fb
operator|->
name|Krom_font_extent0
operator|.
name|y
expr_stmt|;
name|fnt_addr
operator|=
name|ext_fnt_addr
expr_stmt|;
block|}
else|else
block|{
name|fontBM
operator|=
operator|&
name|fb
operator|->
name|Krom_BM1
expr_stmt|;
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|fb
operator|->
name|Krom_font_extent1
operator|.
name|x
operator|>>
literal|1
expr_stmt|;
name|srec
operator|.
name|extent
operator|.
name|y
operator|=
name|fb
operator|->
name|Krom_font_extent1
operator|.
name|y
expr_stmt|;
name|fnt_addr
operator|=
name|ext_fnt24_addr
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|fb
operator|->
name|Krom_BM0
operator|.
name|type
operator|==
operator|(
name|char
operator|)
literal|0xff
condition|)
block|{
name|fontBM
operator|=
operator|&
name|fb
operator|->
name|Krom_BM1
expr_stmt|;
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|fb
operator|->
name|Krom_font_extent1
operator|.
name|x
operator|>>
literal|1
expr_stmt|;
name|srec
operator|.
name|extent
operator|.
name|y
operator|=
name|fb
operator|->
name|Krom_font_extent1
operator|.
name|y
expr_stmt|;
name|fnt_addr
operator|=
name|ext_fnt24_addr
expr_stmt|;
block|}
else|else
block|{
name|fontBM
operator|=
operator|&
name|fb
operator|->
name|Krom_BM0
expr_stmt|;
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|fb
operator|->
name|Krom_font_extent0
operator|.
name|x
operator|>>
literal|1
expr_stmt|;
name|srec
operator|.
name|extent
operator|.
name|y
operator|=
name|fb
operator|->
name|Krom_font_extent0
operator|.
name|y
expr_stmt|;
name|fnt_addr
operator|=
name|ext_fnt_addr
expr_stmt|;
block|}
block|}
if|if
condition|(
name|srec
operator|.
name|extent
operator|.
name|x
operator|>
name|sdata
operator|->
name|width
condition|)
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|sdata
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|srec
operator|.
name|extent
operator|.
name|y
operator|>
name|sdata
operator|->
name|height
condition|)
name|srec
operator|.
name|extent
operator|.
name|y
operator|=
name|sdata
operator|->
name|height
expr_stmt|;
name|flen
operator|=
operator|(
name|fontBM
operator|->
name|width
operator|<<
literal|1
operator|)
operator|*
name|fontBM
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|fontBM
operator|->
name|base
operator|=
operator|(
name|Word
operator|*
operator|)
operator|&
name|rommap
expr_stmt|;
break|break;
case|case
name|ROM_KANJI
case|:
if|if
condition|(
name|sdata
operator|->
name|width
operator|>=
literal|24
operator|&&
name|sdata
operator|->
name|height
operator|>=
literal|24
condition|)
block|{
if|if
condition|(
name|fb
operator|->
name|Krom_BM1
operator|.
name|type
operator|==
operator|(
name|char
operator|)
literal|0xff
condition|)
block|{
name|fontBM
operator|=
operator|&
name|fb
operator|->
name|Krom_BM0
expr_stmt|;
name|srec
operator|.
name|extent
operator|=
name|fb
operator|->
name|Krom_font_extent0
expr_stmt|;
name|fnt_addr
operator|=
name|ext_fnt_addr
expr_stmt|;
block|}
else|else
block|{
name|fontBM
operator|=
operator|&
name|fb
operator|->
name|Krom_BM1
expr_stmt|;
name|srec
operator|.
name|extent
operator|=
name|fb
operator|->
name|Krom_font_extent1
expr_stmt|;
name|fnt_addr
operator|=
name|ext_fnt24_addr
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|fb
operator|->
name|Krom_BM0
operator|.
name|type
operator|==
operator|(
name|char
operator|)
literal|0xff
condition|)
block|{
name|fontBM
operator|=
operator|&
name|fb
operator|->
name|Krom_BM1
expr_stmt|;
name|srec
operator|.
name|extent
operator|=
name|fb
operator|->
name|Krom_font_extent1
expr_stmt|;
name|fnt_addr
operator|=
name|ext_fnt24_addr
expr_stmt|;
block|}
else|else
block|{
name|fontBM
operator|=
operator|&
name|fb
operator|->
name|Krom_BM0
expr_stmt|;
name|srec
operator|.
name|extent
operator|=
name|fb
operator|->
name|Krom_font_extent0
expr_stmt|;
name|fnt_addr
operator|=
name|ext_fnt_addr
expr_stmt|;
block|}
block|}
if|if
condition|(
name|srec
operator|.
name|extent
operator|.
name|x
operator|>
name|sdata
operator|->
name|width
condition|)
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|sdata
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|srec
operator|.
name|extent
operator|.
name|y
operator|>
name|sdata
operator|->
name|height
condition|)
name|srec
operator|.
name|extent
operator|.
name|y
operator|=
name|sdata
operator|->
name|height
expr_stmt|;
name|save
operator|.
name|extent
operator|.
name|x
operator|=
name|srec
operator|.
name|extent
operator|.
name|x
expr_stmt|;
name|flen
operator|=
operator|(
name|fontBM
operator|->
name|width
operator|<<
literal|1
operator|)
operator|*
name|fontBM
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
expr_stmt|;
name|fontBM
operator|->
name|base
operator|=
operator|(
name|Word
operator|*
operator|)
operator|&
name|rommap
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|FB_RERROR
operator|)
return|;
block|}
comment|/* get clipping rectangle */
name|cr
operator|=
name|sdata
operator|->
name|clip
expr_stmt|;
if|if
condition|(
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|sdata
operator|->
name|drawBM
argument_list|,
operator|&
name|cr
argument_list|)
condition|)
return|return
operator|(
name|FB_ROK
operator|)
return|;
comment|/* set rop code */
if|if
condition|(
name|setrop
argument_list|(
name|fb
argument_list|,
name|sdata
operator|->
name|func
argument_list|,
name|sdata
operator|->
name|planemask
argument_list|,
name|sdata
operator|->
name|fore_color
argument_list|,
name|sdata
operator|->
name|aux_color
argument_list|,
name|sdata
operator|->
name|transp
argument_list|,
name|fontBM
argument_list|,
operator|&
name|sdata
operator|->
name|drawBM
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FB_RERROR
operator|)
return|;
comment|/* select rop function */
name|bltfunc
operator|=
name|sel_ropfunc
argument_list|(
name|fontBM
operator|->
name|type
argument_list|,
name|sdata
operator|->
name|drawBM
operator|.
name|type
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|map
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
operator|(
name|sdata
operator|->
name|str
operator|)
expr_stmt|;
name|p
operator|=
name|map
operator|->
name|fm_offset
expr_stmt|;
name|str
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|TypeAt
argument_list|(
name|map
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|#
directive|else
name|str
operator|=
name|sdata
operator|->
name|str
expr_stmt|;
endif|#
directive|endif
name|cursorCheck
argument_list|(
name|fb
argument_list|,
name|fontBM
operator|->
name|type
argument_list|,
operator|&
name|fontBM
operator|->
name|rect
argument_list|,
name|sdata
operator|->
name|drawBM
operator|.
name|type
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sdata
operator|->
name|type
condition|)
block|{
case|case
name|ASCII
case|:
if|if
condition|(
name|sdata
operator|->
name|column
operator|==
literal|0
condition|)
return|return
operator|(
name|FB_RERROR
operator|)
return|;
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|c
operator|=
operator|*
name|str
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|<
name|fchar
operator|||
name|c
operator|>
name|lchar
condition|)
continue|continue;
name|c
operator|-=
name|fchar
expr_stmt|;
name|srec
operator|.
name|origin
operator|.
name|x
operator|=
name|sdata
operator|->
name|fp
operator|.
name|x
operator|+
name|sdata
operator|->
name|width
operator|*
operator|(
name|c
operator|%
name|sdata
operator|->
name|column
operator|)
expr_stmt|;
name|srec
operator|.
name|origin
operator|.
name|y
operator|=
name|sdata
operator|->
name|fp
operator|.
name|y
operator|+
name|sdata
operator|->
name|height
operator|*
operator|(
name|c
operator|/
name|sdata
operator|->
name|column
operator|)
expr_stmt|;
name|dp
operator|.
name|x
operator|=
name|x
operator|>>
literal|16
expr_stmt|;
name|dp
operator|.
name|y
operator|=
name|y
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|ex_factor
operator|==
literal|1
condition|)
block|{
call|(
modifier|*
name|bltfunc
call|)
argument_list|(
name|fb
argument_list|,
name|fontBM
argument_list|,
operator|&
name|srec
argument_list|,
operator|&
name|sdata
operator|->
name|drawBM
argument_list|,
operator|&
name|dp
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sdata
operator|->
name|width
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ex_factor
condition|;
name|j
operator|++
control|)
block|{
call|(
modifier|*
name|bltfunc
call|)
argument_list|(
name|fb
argument_list|,
name|fontBM
argument_list|,
operator|&
name|srec
argument_list|,
operator|&
name|sdata
operator|->
name|drawBM
argument_list|,
operator|&
name|dp
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
name|dp
operator|.
name|x
operator|++
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
block|}
name|srec
operator|.
name|origin
operator|.
name|x
operator|++
expr_stmt|;
block|}
block|}
name|x
operator|+=
name|sdata
operator|->
name|dx
expr_stmt|;
name|y
operator|+=
name|sdata
operator|->
name|dy
expr_stmt|;
block|}
break|break;
case|case
name|ROM_ASCII
case|:
case|case
name|ROM_CONS
case|:
ifdef|#
directive|ifdef
name|IPC_MRX
if|if
condition|(
name|fb
operator|->
name|type
operator|==
name|FB_NWB251
condition|)
name|fb
operator|->
name|cache_off
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|c
operator|=
operator|*
name|str
operator|++
expr_stmt|;
name|dp
operator|.
name|x
operator|=
name|x
operator|>>
literal|16
expr_stmt|;
name|dp
operator|.
name|y
operator|=
name|y
operator|>>
literal|16
expr_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
name|srec
operator|.
name|origin
operator|.
name|x
operator|=
name|srec
operator|.
name|origin
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|f_addr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|>=
literal|0x20
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0x7e
operator|)
condition|)
block|{
comment|/* 				 * ASCII char 				 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
index|]
expr_stmt|;
goto|goto
name|disp
goto|;
block|}
if|if
condition|(
name|sdata
operator|->
name|type
operator|==
name|ROM_ASCII
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa1
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xdf
operator|)
condition|)
block|{
comment|/* 					 * KANA char 					 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
operator|+
literal|64
index|]
expr_stmt|;
goto|goto
name|disp
goto|;
block|}
block|}
if|if
condition|(
name|sdata
operator|->
name|type
operator|==
name|ROM_CONS
condition|)
block|{
ifdef|#
directive|ifdef
name|KM_ASCII
if|if
condition|(
name|tmode
operator|==
name|KM_ASCII
condition|)
block|{
endif|#
directive|endif
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa0
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xff
operator|)
condition|)
block|{
comment|/* 						 * ISO char 						 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
operator|-
literal|32
index|]
expr_stmt|;
goto|goto
name|disp
goto|;
block|}
ifdef|#
directive|ifdef
name|KM_ASCII
block|}
else|else
block|{
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa1
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xdf
operator|)
condition|)
block|{
comment|/* 						 * KANA char 						 */
name|f_addr
operator|=
name|fnt_addr
index|[
name|c
operator|+
literal|64
index|]
expr_stmt|;
goto|goto
name|disp
goto|;
block|}
block|}
endif|#
directive|endif
block|}
name|disp
label|:
if|if
condition|(
name|f_addr
condition|)
block|{
comment|/* 				 * not ROM font 				 *	(font is in kernel data area) 				 */
name|bltfunc
operator|=
name|sel_ropfunc
argument_list|(
name|BM_MEM
argument_list|,
name|sdata
operator|->
name|drawBM
operator|.
name|type
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
name|f_addr
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
name|iopmemfbmap
argument_list|(
name|f_addr
argument_list|,
name|flen
argument_list|,
operator|&
name|rommap
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|k
operator|=
literal|1
expr_stmt|;
name|l
operator|=
name|fontBM
operator|->
name|width
expr_stmt|;
name|fontBM
operator|->
name|width
operator|=
literal|1
expr_stmt|;
name|save
operator|=
name|fontBM
operator|->
name|rect
expr_stmt|;
name|fontBM
operator|->
name|rect
operator|.
name|origin
operator|=
name|srec
operator|.
name|origin
expr_stmt|;
name|fontBM
operator|->
name|rect
operator|.
name|extent
operator|.
name|x
operator|=
literal|12
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fontBM
operator|->
name|type
operator|==
name|BM_MEM
condition|)
block|{
comment|/* 				 * KANJI ROM except pop[cm]fb 				 */
name|f_addr
operator|=
name|fbbm_Krom_addr
argument_list|(
name|fb
argument_list|,
name|c
argument_list|,
operator|&
name|srec
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
name|f_addr
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
name|iopmemfbmap
argument_list|(
name|f_addr
argument_list|,
name|flen
argument_list|,
operator|&
name|rommap
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
comment|/* 				 * XXX 				 * fontBM->type == BM_FB -> fbbm_pop[cm] 				 * 				 * see fbpop[cm]_setup() routine 				 * in fbbm_pop[cm].c 				 */
name|bltfunc
operator|=
name|sel_ropfunc
argument_list|(
name|fontBM
operator|->
name|type
argument_list|,
name|sdata
operator|->
name|drawBM
operator|.
name|type
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|fontBM
operator|->
name|base
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fb_map
argument_list|)
argument_list|)
expr_stmt|;
name|fbbm_Krom_addr
argument_list|(
name|fb
argument_list|,
name|c
argument_list|,
operator|&
name|srec
argument_list|)
expr_stmt|;
name|fontBM
operator|->
name|rect
operator|.
name|origin
operator|=
name|srec
operator|.
name|origin
expr_stmt|;
block|}
if|if
condition|(
name|ex_factor
operator|==
literal|1
condition|)
block|{
call|(
modifier|*
name|bltfunc
call|)
argument_list|(
name|fb
argument_list|,
name|fontBM
argument_list|,
operator|&
name|srec
argument_list|,
operator|&
name|sdata
operator|->
name|drawBM
argument_list|,
operator|&
name|dp
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sdata
operator|->
name|width
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ex_factor
condition|;
name|j
operator|++
control|)
block|{
call|(
modifier|*
name|bltfunc
call|)
argument_list|(
name|fb
argument_list|,
name|fontBM
argument_list|,
operator|&
name|srec
argument_list|,
operator|&
name|sdata
operator|->
name|drawBM
argument_list|,
operator|&
name|dp
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
name|dp
operator|.
name|x
operator|++
expr_stmt|;
block|}
name|srec
operator|.
name|origin
operator|.
name|x
operator|++
expr_stmt|;
block|}
block|}
name|PRE_EMPT
expr_stmt|;
if|if
condition|(
name|k
operator|!=
literal|0
condition|)
block|{
name|fontBM
operator|->
name|rect
operator|=
name|save
expr_stmt|;
name|fontBM
operator|->
name|width
operator|=
name|l
expr_stmt|;
block|}
name|x
operator|+=
name|sdata
operator|->
name|dx
expr_stmt|;
name|y
operator|+=
name|sdata
operator|->
name|dy
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|IPC_MRX
name|fb
operator|->
name|cache_off
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|ROM_KANJI
case|:
ifdef|#
directive|ifdef
name|IPC_MRX
if|if
condition|(
name|fb
operator|->
name|type
operator|==
name|FB_NWB251
condition|)
name|fb
operator|->
name|cache_off
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
name|len
operator|>
literal|1
condition|)
block|{
name|c
operator|=
operator|*
name|str
operator|++
expr_stmt|;
name|c
operator|<<=
literal|8
expr_stmt|;
name|c
operator||=
operator|*
name|str
operator|++
expr_stmt|;
name|dp
operator|.
name|x
operator|=
name|x
operator|>>
literal|16
expr_stmt|;
name|dp
operator|.
name|y
operator|=
name|y
operator|>>
literal|16
expr_stmt|;
name|srec
operator|.
name|origin
operator|.
name|x
operator|=
name|srec
operator|.
name|origin
operator|.
name|y
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fontBM
operator|->
name|type
operator|==
name|BM_MEM
condition|)
block|{
comment|/* 				 * KANJI ROM except pop[cm]fb 				 */
name|f_addr
operator|=
name|fbbm_Krom_addr
argument_list|(
name|fb
argument_list|,
name|c
argument_list|,
operator|&
name|srec
argument_list|)
expr_stmt|;
name|rommap
operator|.
name|fm_vaddr
operator|=
name|f_addr
expr_stmt|;
name|rommap
operator|.
name|fm_offset
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
name|iopmemfbmap
argument_list|(
name|f_addr
argument_list|,
name|flen
argument_list|,
operator|&
name|rommap
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
comment|/* 				 * XXX 				 * fontBM->type == BM_FB ---> fbbm_pop[cm] 				 * 				 * see fbpop[cm]_setup() in fbbm_pop[cm].c 				 */
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|fontBM
operator|->
name|base
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fb_map
argument_list|)
argument_list|)
expr_stmt|;
name|fbbm_Krom_addr
argument_list|(
name|fb
argument_list|,
name|c
argument_list|,
operator|&
name|srec
argument_list|)
expr_stmt|;
name|fontBM
operator|->
name|rect
operator|.
name|origin
operator|=
name|srec
operator|.
name|origin
expr_stmt|;
block|}
if|if
condition|(
name|ex_factor
operator|==
literal|1
condition|)
block|{
call|(
modifier|*
name|bltfunc
call|)
argument_list|(
name|fb
argument_list|,
name|fontBM
argument_list|,
operator|&
name|srec
argument_list|,
operator|&
name|sdata
operator|->
name|drawBM
argument_list|,
operator|&
name|dp
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sdata
operator|->
name|width
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ex_factor
condition|;
name|j
operator|++
control|)
block|{
call|(
modifier|*
name|bltfunc
call|)
argument_list|(
name|fb
argument_list|,
name|fontBM
argument_list|,
operator|&
name|srec
argument_list|,
operator|&
name|sdata
operator|->
name|drawBM
argument_list|,
operator|&
name|dp
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
name|dp
operator|.
name|x
operator|++
expr_stmt|;
block|}
name|srec
operator|.
name|origin
operator|.
name|x
operator|++
expr_stmt|;
block|}
name|srec
operator|.
name|extent
operator|.
name|x
operator|=
name|save
operator|.
name|extent
operator|.
name|x
expr_stmt|;
block|}
name|PRE_EMPT
expr_stmt|;
name|x
operator|+=
name|sdata
operator|->
name|dx
expr_stmt|;
name|y
operator|+=
name|sdata
operator|->
name|dy
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|IPC_MRX
name|fb
operator|->
name|cache_off
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_RERROR
operator|)
return|;
block|}
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_function
name|void
name|linerop
parameter_list|(
name|fb
parameter_list|,
name|func
parameter_list|,
name|fore
parameter_list|,
name|aux
parameter_list|,
name|trans
parameter_list|)
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
specifier|register
name|unsigned
name|func
decl_stmt|;
specifier|register
name|int
name|fore
decl_stmt|;
specifier|register
name|int
name|aux
decl_stmt|;
name|int
name|trans
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|funcv
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|char
name|tmp
index|[
literal|4
index|]
decl_stmt|;
comment|/* set rop function register */
name|func
operator|&=
literal|0xf
expr_stmt|;
name|tmp
index|[
literal|0
index|]
operator|=
name|TRANS
argument_list|(
name|trans
argument_list|,
operator|(
name|func
operator|&
literal|0x0c
operator|)
operator||
operator|(
name|func
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|1
index|]
operator|=
name|TRANS
argument_list|(
name|trans
argument_list|,
operator|(
name|func
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
name|func
operator|<<
literal|2
operator|)
operator|&
literal|0x0c
operator|)
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|2
index|]
operator|=
name|TRANS
argument_list|(
name|trans
argument_list|,
name|func
argument_list|)
expr_stmt|;
name|tmp
index|[
literal|3
index|]
operator|=
name|TRANS
argument_list|(
name|trans
argument_list|,
operator|(
name|func
operator|<<
literal|2
operator|)
operator|&
literal|0x0c
operator||
name|func
operator|&
literal|3
argument_list|)
expr_stmt|;
name|funcv
operator|=
name|fb
operator|->
name|funcvec
expr_stmt|;
for|for
control|(
name|i
operator|=
name|fb
operator|->
name|fbNplane
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
control|)
block|{
operator|*
name|funcv
operator|++
operator|=
name|tmp
index|[
operator|(
operator|(
name|fore
operator|&
literal|1
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
name|aux
operator|&
literal|1
operator|)
index|]
expr_stmt|;
name|fore
operator|>>=
literal|1
expr_stmt|;
name|aux
operator|>>=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * line clipping routine  *  *	DRAW	visual  *	NODRAW	not visual  */
end_comment

begin_expr_stmt
name|lineclip
argument_list|(
name|p0
argument_list|,
name|p1
argument_list|,
name|r
argument_list|)
specifier|register
name|lPoint
operator|*
name|p0
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lPoint
modifier|*
name|p1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lRectangle
modifier|*
name|r
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* clipping rectangle */
end_comment

begin_block
block|{
specifier|register
name|lPoint
modifier|*
name|ptmp
decl_stmt|;
specifier|register
name|int
name|d0
decl_stmt|,
name|d1
decl_stmt|,
name|d2
decl_stmt|,
name|limit
decl_stmt|;
comment|/* sort 2 points by x-coordinate */
if|if
condition|(
name|p0
operator|->
name|x
operator|>
name|p1
operator|->
name|x
condition|)
block|{
name|ptmp
operator|=
name|p1
expr_stmt|;
name|p1
operator|=
name|p0
expr_stmt|;
name|p0
operator|=
name|ptmp
expr_stmt|;
block|}
name|limit
operator|=
name|r
operator|->
name|origin
operator|.
name|x
expr_stmt|;
name|d0
operator|=
name|p1
operator|->
name|y
operator|-
name|p0
operator|->
name|y
expr_stmt|;
name|d1
operator|=
name|p1
operator|->
name|x
operator|-
name|p0
operator|->
name|x
expr_stmt|;
if|if
condition|(
operator|(
name|d2
operator|=
name|limit
operator|-
name|p0
operator|->
name|x
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|p1
operator|->
name|x
operator|<
name|limit
condition|)
return|return
operator|(
name|NODRAW
operator|)
return|;
name|p0
operator|->
name|y
operator|+=
name|d2
operator|*
name|d0
operator|/
name|d1
expr_stmt|;
name|p0
operator|->
name|x
operator|=
name|limit
expr_stmt|;
block|}
name|limit
operator|+=
name|r
operator|->
name|extent
operator|.
name|x
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|d2
operator|=
name|limit
operator|-
name|p1
operator|->
name|x
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|p0
operator|->
name|x
operator|>
name|limit
condition|)
return|return
operator|(
name|NODRAW
operator|)
return|;
name|p1
operator|->
name|y
operator|+=
name|d2
operator|*
name|d0
operator|/
name|d1
expr_stmt|;
name|p1
operator|->
name|x
operator|=
name|limit
expr_stmt|;
block|}
comment|/* sort 2 points by y-coordinate */
if|if
condition|(
name|p0
operator|->
name|y
operator|>
name|p1
operator|->
name|y
condition|)
block|{
name|ptmp
operator|=
name|p1
expr_stmt|;
name|p1
operator|=
name|p0
expr_stmt|;
name|p0
operator|=
name|ptmp
expr_stmt|;
block|}
name|limit
operator|=
name|r
operator|->
name|origin
operator|.
name|y
expr_stmt|;
name|d0
operator|=
name|p1
operator|->
name|x
operator|-
name|p0
operator|->
name|x
expr_stmt|;
name|d1
operator|=
name|p1
operator|->
name|y
operator|-
name|p0
operator|->
name|y
expr_stmt|;
if|if
condition|(
operator|(
name|d2
operator|=
name|limit
operator|-
name|p0
operator|->
name|y
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|p1
operator|->
name|y
operator|<
name|limit
condition|)
return|return
operator|(
name|NODRAW
operator|)
return|;
name|p0
operator|->
name|x
operator|+=
name|d2
operator|*
name|d0
operator|/
name|d1
expr_stmt|;
name|p0
operator|->
name|y
operator|=
name|limit
expr_stmt|;
block|}
name|limit
operator|+=
name|r
operator|->
name|extent
operator|.
name|y
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|d2
operator|=
name|limit
operator|-
name|p1
operator|->
name|y
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|p0
operator|->
name|y
operator|>
name|limit
condition|)
return|return
operator|(
name|NODRAW
operator|)
return|;
name|p1
operator|->
name|x
operator|+=
name|d2
operator|*
name|d0
operator|/
name|d1
expr_stmt|;
name|p1
operator|->
name|y
operator|=
name|limit
expr_stmt|;
block|}
return|return
operator|(
name|DRAW
operator|)
return|;
block|}
end_block

begin_ifndef
ifndef|#
directive|ifndef
name|CPU_DOUBLE
end_ifndef

begin_comment
comment|/* void point(p, x, s, fp) 	register char *p; 	register int x; 	register int s; 	register char *fp; { 	x = 7 - (x& 7); 	if ((1<< (3 - (((s& 1)<< 1) | ((*p>> x)& 1))))& *fp) 		*p |= (1<< x); 	else 		*p&= ~(1<< x); } */
end_comment

begin_define
define|#
directive|define
name|point
parameter_list|(
name|p
parameter_list|,
name|x
parameter_list|,
name|s
parameter_list|,
name|fp
parameter_list|)
value|{ \ 	int xx = 7 - ((x)& 7); \ 	if ((1<< (3 - ((((s)& 1)<< 1) | ((*(p)>> xx)& 1))))& *(fp)) \ 		*(p) |= (1<< xx); \ 	else \ 		*(p)&= ~(1<< xx); \ }
end_define

begin_macro
name|mem_vector
argument_list|(
argument|fb
argument_list|,
argument|p0
argument_list|,
argument|p1
argument_list|,
argument|mask
argument_list|,
argument|dbmp
argument_list|,
argument|lpf
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lPoint
modifier|*
name|p0
decl_stmt|,
modifier|*
name|p1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* plane mask */
end_comment

begin_decl_stmt
name|lBitmap
modifier|*
name|dbmp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* drawing bitmap */
end_comment

begin_decl_stmt
name|int
name|lpf
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* if 0, don't draw last point */
end_comment

begin_block
block|{
specifier|register
name|struct
name|fb_map
modifier|*
name|map
init|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|dbmp
operator|->
name|base
decl_stmt|;
specifier|register
name|char
modifier|*
name|funcv
init|=
name|fb
operator|->
name|funcvec
decl_stmt|;
comment|/* rop function */
name|int
name|p
init|=
operator|(
name|int
operator|)
name|map
operator|->
name|fm_offset
decl_stmt|;
specifier|register
name|int
name|pmask
decl_stmt|;
specifier|register
name|unsigned
name|int
name|pat
decl_stmt|;
specifier|register
name|int
name|x
init|=
name|p0
operator|->
name|x
decl_stmt|;
specifier|register
name|int
name|y
init|=
name|p0
operator|->
name|y
decl_stmt|;
specifier|register
name|char
modifier|*
name|fp
decl_stmt|;
name|int
name|width
init|=
name|dbmp
operator|->
name|width
operator|<<
literal|1
decl_stmt|;
name|int
name|lim
decl_stmt|;
name|int
name|size
init|=
name|width
operator|*
name|dbmp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
decl_stmt|;
name|int
name|ddx
decl_stmt|,
name|ddy
decl_stmt|;
name|int
name|s
decl_stmt|,
name|d
decl_stmt|,
name|c
decl_stmt|;
name|int
name|dx
init|=
name|p1
operator|->
name|x
operator|-
name|x
decl_stmt|;
name|int
name|dy
init|=
name|p1
operator|->
name|y
operator|-
name|y
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|depth
init|=
name|dbmp
operator|->
name|depth
decl_stmt|;
comment|/* transformation */
name|x
operator|-=
name|dbmp
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|y
operator|-=
name|dbmp
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|pat
operator|=
name|fb
operator|->
name|pat
expr_stmt|;
name|ddx
operator|=
literal|1
expr_stmt|;
name|ddy
operator|=
name|dbmp
operator|->
name|width
operator|<<
literal|1
expr_stmt|;
name|y
operator|=
operator|(
name|int
operator|)
name|p
operator|+
name|y
operator|*
name|ddy
expr_stmt|;
if|if
condition|(
name|dx
operator|==
literal|0
condition|)
name|ddx
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|dx
operator|<
literal|0
condition|)
block|{
name|dx
operator|=
operator|-
name|dx
expr_stmt|;
name|ddx
operator|=
operator|-
name|ddx
expr_stmt|;
block|}
if|if
condition|(
name|dy
operator|==
literal|0
condition|)
name|ddy
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|dy
operator|<
literal|0
condition|)
block|{
name|dy
operator|=
operator|-
name|dy
expr_stmt|;
name|ddy
operator|=
operator|-
name|ddy
expr_stmt|;
block|}
if|if
condition|(
name|dx
operator|>
name|dy
condition|)
block|{
comment|/* case x */
name|lim
operator|=
name|dx
expr_stmt|;
if|if
condition|(
name|lpf
condition|)
name|lim
operator|++
expr_stmt|;
name|s
operator|=
operator|-
name|dx
expr_stmt|;
name|d
operator|=
name|dx
operator|<<
literal|1
expr_stmt|;
name|c
operator|=
name|dy
operator|<<
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|lim
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
operator|(
name|int
operator|)
name|p
operator|=
name|y
operator|+
operator|(
name|x
operator|>>
literal|3
operator|)
expr_stmt|;
name|pat
operator|=
operator|(
name|pat
operator|<<
literal|1
operator|)
operator||
operator|(
operator|(
name|pat
operator|&
literal|0x80000000
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
name|fp
operator|=
name|funcv
expr_stmt|;
name|pmask
operator|=
name|mask
expr_stmt|;
for|for
control|(
name|j
operator|=
name|depth
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
block|{
if|if
condition|(
name|pmask
operator|&
literal|1
condition|)
block|{
name|point
argument_list|(
name|_TypeAt
argument_list|(
name|map
argument_list|,
name|p
argument_list|)
argument_list|,
name|x
argument_list|,
name|pat
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
name|p
operator|+=
name|size
expr_stmt|;
name|pmask
operator|>>=
literal|1
expr_stmt|;
name|fp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|s
operator|+=
name|c
operator|)
operator|>=
literal|0
condition|)
block|{
name|s
operator|-=
name|d
expr_stmt|;
name|y
operator|+=
name|ddy
expr_stmt|;
block|}
name|x
operator|+=
name|ddx
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* case y */
name|lim
operator|=
name|dy
expr_stmt|;
if|if
condition|(
name|lpf
condition|)
name|lim
operator|++
expr_stmt|;
name|s
operator|=
operator|-
name|dy
expr_stmt|;
name|d
operator|=
name|dy
operator|<<
literal|1
expr_stmt|;
name|c
operator|=
name|dx
operator|<<
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|lim
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
operator|(
name|int
operator|)
name|p
operator|=
name|y
operator|+
operator|(
name|x
operator|>>
literal|3
operator|)
expr_stmt|;
name|pat
operator|=
operator|(
name|pat
operator|<<
literal|1
operator|)
operator||
operator|(
operator|(
name|pat
operator|&
literal|0x80000000
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
name|fp
operator|=
name|funcv
expr_stmt|;
name|pmask
operator|=
name|mask
expr_stmt|;
for|for
control|(
name|j
operator|=
name|depth
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
block|{
if|if
condition|(
name|pmask
operator|&
literal|1
condition|)
block|{
name|point
argument_list|(
name|_TypeAt
argument_list|(
name|map
argument_list|,
name|p
argument_list|)
argument_list|,
name|x
argument_list|,
name|pat
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
name|p
operator|+=
name|size
expr_stmt|;
name|pmask
operator|>>=
literal|1
expr_stmt|;
name|fp
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|s
operator|+=
name|c
operator|)
operator|>=
literal|0
condition|)
block|{
name|s
operator|-=
name|d
expr_stmt|;
name|x
operator|+=
name|ddx
expr_stmt|;
block|}
name|y
operator|+=
name|ddy
expr_stmt|;
block|}
block|}
comment|/* rotate pattern */
name|pat
operator|=
name|fb
operator|->
name|pat
expr_stmt|;
block|{
specifier|register
name|int
name|tmp
decl_stmt|;
name|tmp
operator|=
name|lim
operator|&
literal|31
expr_stmt|;
name|pat
operator|=
operator|(
name|pat
operator|<<
name|tmp
operator|)
operator||
operator|(
name|pat
operator|>>
operator|(
literal|32
operator|-
name|tmp
operator|)
operator|)
expr_stmt|;
block|}
name|fb
operator|->
name|pat
operator|=
name|pat
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !CPU_DOUBLE */
end_comment

begin_comment
comment|/* polyline drawing */
end_comment

begin_macro
name|draw_polyline
argument_list|(
argument|fb
argument_list|,
argument|dp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lPrimLine
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|lPoint
modifier|*
name|ps
decl_stmt|;
name|lPoint
name|p0
decl_stmt|,
name|p1
decl_stmt|;
specifier|register
name|int
name|np
decl_stmt|;
name|lRectangle
name|clip
decl_stmt|,
modifier|*
name|clipp
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
name|unsigned
name|int
name|p
decl_stmt|;
endif|#
directive|endif
comment|/* clip rectangle */
name|clip
operator|=
name|dp
operator|->
name|clip
expr_stmt|;
if|if
condition|(
name|clip
operator|.
name|origin
operator|.
name|x
operator|==
operator|-
literal|1
condition|)
name|clipp
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|clipp
operator|=
operator|&
name|clip
expr_stmt|;
if|if
condition|(
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
name|clipp
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|map
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
operator|(
name|dp
operator|->
name|plist
operator|)
expr_stmt|;
name|p
operator|=
name|map
operator|->
name|fm_offset
expr_stmt|;
name|ps
operator|=
operator|(
name|lPoint
operator|*
operator|)
name|TypeAt
argument_list|(
name|map
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|#
directive|else
name|ps
operator|=
name|dp
operator|->
name|plist
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|dp
operator|->
name|drawBM
operator|.
name|type
operator|==
name|BM_FB
condition|)
block|{
name|cursorCheck
argument_list|(
name|fb
argument_list|,
operator|~
name|BM_FB
argument_list|,
literal|0
argument_list|,
name|dp
operator|->
name|drawBM
operator|.
name|type
argument_list|,
name|clipp
argument_list|)
expr_stmt|;
name|fbbm_rop_vect
argument_list|(
name|fb
argument_list|,
name|clipp
argument_list|,
name|dp
operator|->
name|func
argument_list|,
name|dp
operator|->
name|fore_color
argument_list|,
name|dp
operator|->
name|aux_color
argument_list|,
name|dp
operator|->
name|transp
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
name|dp
operator|->
name|np
argument_list|,
name|ps
argument_list|,
name|dp
operator|->
name|lptn
argument_list|,
operator|(
name|dp
operator|->
name|dlpf
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
ifndef|#
directive|ifndef
name|CPU_DOUBLE
name|linerop
argument_list|(
name|fb
argument_list|,
name|dp
operator|->
name|func
argument_list|,
name|dp
operator|->
name|fore_color
argument_list|,
name|dp
operator|->
name|aux_color
argument_list|,
name|dp
operator|->
name|transp
argument_list|)
expr_stmt|;
name|p0
operator|=
operator|*
name|ps
operator|++
expr_stmt|;
name|np
operator|=
name|dp
operator|->
name|np
operator|-
literal|1
expr_stmt|;
name|fb
operator|->
name|pat
operator|=
name|dp
operator|->
name|lptn
expr_stmt|;
if|if
condition|(
name|clipp
condition|)
block|{
while|while
condition|(
operator|--
name|np
operator|>
literal|0
condition|)
block|{
name|p1
operator|=
operator|*
name|ps
expr_stmt|;
if|if
condition|(
name|lineclip
argument_list|(
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|clipp
argument_list|)
condition|)
block|{
name|mem_vector
argument_list|(
name|fb
argument_list|,
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
name|ps
operator|->
name|x
operator|!=
name|p1
operator|.
name|x
operator|||
name|ps
operator|->
name|y
operator|!=
name|p1
operator|.
name|y
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
block|}
name|p0
operator|=
operator|*
name|ps
operator|++
expr_stmt|;
block|}
name|p1
operator|=
operator|*
name|ps
expr_stmt|;
if|if
condition|(
name|lineclip
argument_list|(
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|clipp
argument_list|)
condition|)
block|{
name|mem_vector
argument_list|(
name|fb
argument_list|,
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
name|ps
operator|->
name|x
operator|!=
name|p1
operator|.
name|x
operator|||
name|ps
operator|->
name|y
operator|!=
name|p1
operator|.
name|y
operator|||
name|dp
operator|->
name|dlpf
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
operator|--
name|np
operator|>
literal|0
condition|)
block|{
name|p1
operator|=
operator|*
name|ps
expr_stmt|;
name|mem_vector
argument_list|(
name|fb
argument_list|,
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
name|p0
operator|=
operator|*
name|ps
operator|++
expr_stmt|;
block|}
name|p1
operator|=
operator|*
name|ps
expr_stmt|;
name|mem_vector
argument_list|(
name|fb
argument_list|,
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
name|dp
operator|->
name|dlpf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* !CPU_DOUBLE */
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_comment
comment|/* disjoint polyline drawing */
end_comment

begin_macro
name|draw_dj_polyline
argument_list|(
argument|fb
argument_list|,
argument|dp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lPrimLine
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|lPoint
modifier|*
name|ps
decl_stmt|;
name|lPoint
name|p0
decl_stmt|,
name|p1
decl_stmt|;
specifier|register
name|int
name|np
decl_stmt|;
name|lRectangle
name|clip
decl_stmt|,
modifier|*
name|clipp
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
name|unsigned
name|int
name|p
decl_stmt|;
endif|#
directive|endif
name|int
name|lpf
init|=
operator|(
name|dp
operator|->
name|dlpf
operator|)
condition|?
literal|1
else|:
literal|0
decl_stmt|;
comment|/* clip rectangle */
name|clip
operator|=
name|dp
operator|->
name|clip
expr_stmt|;
if|if
condition|(
name|clip
operator|.
name|origin
operator|.
name|x
operator|==
operator|-
literal|1
condition|)
name|clipp
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|clipp
operator|=
operator|&
name|clip
expr_stmt|;
if|if
condition|(
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
name|clipp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|map
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
operator|(
name|dp
operator|->
name|plist
operator|)
expr_stmt|;
name|p
operator|=
name|map
operator|->
name|fm_offset
expr_stmt|;
name|ps
operator|=
operator|(
name|lPoint
operator|*
operator|)
name|TypeAt
argument_list|(
name|map
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|#
directive|else
name|ps
operator|=
name|dp
operator|->
name|plist
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|dp
operator|->
name|drawBM
operator|.
name|type
operator|==
name|BM_FB
condition|)
block|{
name|cursorCheck
argument_list|(
name|fb
argument_list|,
operator|~
name|BM_FB
argument_list|,
literal|0
argument_list|,
name|dp
operator|->
name|drawBM
operator|.
name|type
argument_list|,
name|clipp
argument_list|)
expr_stmt|;
name|fbbm_rop_vect
argument_list|(
name|fb
argument_list|,
name|clipp
argument_list|,
name|dp
operator|->
name|func
argument_list|,
name|dp
operator|->
name|fore_color
argument_list|,
name|dp
operator|->
name|aux_color
argument_list|,
name|dp
operator|->
name|transp
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
name|dp
operator|->
name|np
argument_list|,
name|ps
argument_list|,
name|dp
operator|->
name|lptn
argument_list|,
name|lpf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
ifndef|#
directive|ifndef
name|CPU_DOUBLE
name|linerop
argument_list|(
name|fb
argument_list|,
name|dp
operator|->
name|func
argument_list|,
name|dp
operator|->
name|fore_color
argument_list|,
name|dp
operator|->
name|aux_color
argument_list|,
name|dp
operator|->
name|transp
argument_list|)
expr_stmt|;
name|np
operator|=
name|dp
operator|->
name|np
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|lpf
condition|)
block|{
if|if
condition|(
name|clipp
condition|)
block|{
while|while
condition|(
operator|--
name|np
operator|>=
literal|0
condition|)
block|{
name|p0
operator|=
operator|*
name|ps
operator|++
expr_stmt|;
name|p1
operator|=
operator|*
name|ps
operator|++
expr_stmt|;
name|fb
operator|->
name|pat
operator|=
name|dp
operator|->
name|lptn
expr_stmt|;
if|if
condition|(
name|lineclip
argument_list|(
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|clipp
argument_list|)
condition|)
block|{
name|mem_vector
argument_list|(
name|fb
argument_list|,
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
while|while
condition|(
operator|--
name|np
operator|>=
literal|0
condition|)
block|{
name|p0
operator|=
operator|*
name|ps
operator|++
expr_stmt|;
name|p1
operator|=
operator|*
name|ps
operator|++
expr_stmt|;
name|fb
operator|->
name|pat
operator|=
name|dp
operator|->
name|lptn
expr_stmt|;
name|mem_vector
argument_list|(
name|fb
argument_list|,
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|clipp
condition|)
block|{
while|while
condition|(
operator|--
name|np
operator|>=
literal|0
condition|)
block|{
name|p0
operator|=
operator|*
name|ps
operator|++
expr_stmt|;
name|p1
operator|=
operator|*
name|ps
expr_stmt|;
name|fb
operator|->
name|pat
operator|=
name|dp
operator|->
name|lptn
expr_stmt|;
if|if
condition|(
name|lineclip
argument_list|(
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|clipp
argument_list|)
condition|)
block|{
name|mem_vector
argument_list|(
name|fb
argument_list|,
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
name|ps
operator|->
name|x
operator|!=
name|p1
operator|.
name|x
operator|||
name|ps
operator|->
name|y
operator|!=
name|p1
operator|.
name|y
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
block|}
name|ps
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
operator|--
name|np
operator|>=
literal|0
condition|)
block|{
name|p0
operator|=
operator|*
name|ps
operator|++
expr_stmt|;
name|p1
operator|=
operator|*
name|ps
operator|++
expr_stmt|;
name|fb
operator|->
name|pat
operator|=
name|dp
operator|->
name|lptn
expr_stmt|;
name|mem_vector
argument_list|(
name|fb
argument_list|,
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
comment|/* !CPU_DOUBLE */
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_decl_stmt
specifier|static
name|lRectangle
name|dotRect
init|=
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|emulate_polydot
argument_list|(
argument|fb
argument_list|,
argument|dp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lPrimDot
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|lPrimMarker
name|marker
decl_stmt|;
name|lPrimMarker
modifier|*
name|cmdp
decl_stmt|;
specifier|register
name|lPoint
modifier|*
name|ps
decl_stmt|;
specifier|register
name|int
name|np
decl_stmt|;
name|lRectangle
name|cr
decl_stmt|;
specifier|register
name|int
function_decl|(
modifier|*
name|blt
function_decl|)
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
name|unsigned
name|int
name|p
decl_stmt|;
endif|#
directive|endif
name|cmdp
operator|=
operator|&
name|marker
expr_stmt|;
name|cmdp
operator|->
name|func
operator|=
name|dp
operator|->
name|func
expr_stmt|;
name|cmdp
operator|->
name|transp
operator|=
name|dp
operator|->
name|transp
expr_stmt|;
name|cmdp
operator|->
name|fore_color
operator|=
name|dp
operator|->
name|fore_color
expr_stmt|;
name|cmdp
operator|->
name|aux_color
operator|=
name|dp
operator|->
name|aux_color
expr_stmt|;
name|cmdp
operator|->
name|planemask
operator|=
name|dp
operator|->
name|planemask
expr_stmt|;
name|cmdp
operator|->
name|ptnRect
operator|=
name|dotRect
expr_stmt|;
name|cmdp
operator|->
name|ptnBM
operator|.
name|type
operator|=
name|BM_1
expr_stmt|;
name|cmdp
operator|->
name|ptnBM
operator|.
name|depth
operator|=
literal|1
expr_stmt|;
name|cmdp
operator|->
name|ptnBM
operator|.
name|rect
operator|=
name|dotRect
expr_stmt|;
name|cmdp
operator|->
name|drawBM
operator|=
name|dp
operator|->
name|drawBM
expr_stmt|;
name|cmdp
operator|->
name|clip
operator|=
name|dp
operator|->
name|clip
expr_stmt|;
name|cmdp
operator|->
name|np
operator|=
name|dp
operator|->
name|np
expr_stmt|;
name|cmdp
operator|->
name|plist
operator|=
name|dp
operator|->
name|plist
expr_stmt|;
return|return
operator|(
name|draw_polymarker
argument_list|(
name|fb
argument_list|,
name|cmdp
argument_list|)
operator|)
return|;
block|}
end_block

begin_ifndef
ifndef|#
directive|ifndef
name|CPU_DOUBLE
end_ifndef

begin_macro
name|mem_dot
argument_list|(
argument|fb
argument_list|,
argument|p0
argument_list|,
argument|mask
argument_list|,
argument|dbmp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lPoint
modifier|*
name|p0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|mask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* plane mask */
end_comment

begin_decl_stmt
name|lBitmap
modifier|*
name|dbmp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* drawing bitmap */
end_comment

begin_block
block|{
specifier|register
name|struct
name|fb_map
modifier|*
name|map
init|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
name|dbmp
operator|->
name|base
decl_stmt|;
specifier|register
name|char
modifier|*
name|funcv
decl_stmt|;
comment|/* rop function */
specifier|register
name|int
name|p
init|=
operator|(
name|int
operator|)
name|map
operator|->
name|fm_offset
decl_stmt|;
specifier|register
name|int
name|depth
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|x
operator|=
name|p0
operator|->
name|x
operator|-
name|dbmp
operator|->
name|rect
operator|.
name|origin
operator|.
name|x
expr_stmt|;
name|y
operator|=
name|p0
operator|->
name|y
operator|-
name|dbmp
operator|->
name|rect
operator|.
name|origin
operator|.
name|y
expr_stmt|;
name|size
operator|=
operator|(
name|dbmp
operator|->
name|width
operator|*
name|dbmp
operator|->
name|rect
operator|.
name|extent
operator|.
name|y
operator|)
operator|<<
literal|1
expr_stmt|;
name|p
operator|+=
name|y
operator|*
operator|(
name|dbmp
operator|->
name|width
operator|<<
literal|1
operator|)
operator|+
operator|(
name|x
operator|>>
literal|3
operator|)
expr_stmt|;
name|funcv
operator|=
name|fb
operator|->
name|funcvec
expr_stmt|;
for|for
control|(
name|depth
operator|=
name|dbmp
operator|->
name|depth
init|;
operator|--
name|depth
operator|>=
literal|0
condition|;
control|)
block|{
if|if
condition|(
name|mask
operator|&
literal|1
condition|)
block|{
name|point
argument_list|(
name|_TypeAt
argument_list|(
name|map
argument_list|,
name|p
argument_list|)
argument_list|,
name|x
argument_list|,
operator|~
literal|0
argument_list|,
name|funcv
argument_list|)
expr_stmt|;
block|}
name|p
operator|+=
name|size
expr_stmt|;
name|mask
operator|>>=
literal|1
expr_stmt|;
name|funcv
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !CPU_DOUBLE */
end_comment

begin_macro
name|draw_polydot
argument_list|(
argument|fb
argument_list|,
argument|dp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|fbdev
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|lPrimDot
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|lPoint
modifier|*
name|ps
decl_stmt|;
name|lRectangle
name|clip
decl_stmt|,
modifier|*
name|clipp
decl_stmt|;
specifier|register
name|int
name|np
decl_stmt|;
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|struct
name|fb_map
modifier|*
name|map
decl_stmt|;
name|unsigned
name|int
name|p
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|fb
operator|->
name|fbbm_op
operator|->
name|fb_rop_dot
operator|==
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|nofunc
condition|)
return|return
operator|(
name|emulate_polydot
argument_list|(
name|fb
argument_list|,
name|dp
argument_list|)
operator|)
return|;
comment|/* clip rectangle */
name|clip
operator|=
name|dp
operator|->
name|clip
expr_stmt|;
if|if
condition|(
name|clip
operator|.
name|origin
operator|.
name|x
operator|==
operator|-
literal|1
condition|)
name|clipp
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|clipp
operator|=
operator|&
name|clip
expr_stmt|;
if|if
condition|(
operator|!
name|getclip
argument_list|(
name|fb
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|,
name|clipp
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
name|map
operator|=
operator|(
expr|struct
name|fb_map
operator|*
operator|)
operator|(
name|dp
operator|->
name|plist
operator|)
expr_stmt|;
name|p
operator|=
name|map
operator|->
name|fm_offset
expr_stmt|;
name|ps
operator|=
operator|(
name|lPoint
operator|*
operator|)
name|TypeAt
argument_list|(
name|map
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|#
directive|else
name|ps
operator|=
name|dp
operator|->
name|plist
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|dp
operator|->
name|drawBM
operator|.
name|type
operator|==
name|BM_FB
condition|)
block|{
name|cursorCheck
argument_list|(
name|fb
argument_list|,
operator|~
name|BM_FB
argument_list|,
literal|0
argument_list|,
name|dp
operator|->
name|drawBM
operator|.
name|type
argument_list|,
name|clipp
argument_list|)
expr_stmt|;
name|fbbm_rop_dot
argument_list|(
name|fb
argument_list|,
name|clipp
argument_list|,
name|dp
operator|->
name|func
argument_list|,
name|dp
operator|->
name|fore_color
argument_list|,
name|dp
operator|->
name|aux_color
argument_list|,
name|dp
operator|->
name|transp
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
name|dp
operator|->
name|np
argument_list|,
name|ps
argument_list|)
expr_stmt|;
name|cursorOn
argument_list|(
name|fb
argument_list|)
expr_stmt|;
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
ifndef|#
directive|ifndef
name|CPU_DOUBLE
name|linerop
argument_list|(
name|fb
argument_list|,
name|dp
operator|->
name|func
argument_list|,
name|dp
operator|->
name|fore_color
argument_list|,
name|dp
operator|->
name|aux_color
argument_list|,
name|dp
operator|->
name|transp
argument_list|)
expr_stmt|;
name|np
operator|=
name|dp
operator|->
name|np
expr_stmt|;
if|if
condition|(
name|clipp
condition|)
block|{
specifier|register
name|int
name|x0
decl_stmt|,
name|y0
decl_stmt|,
name|x1
decl_stmt|,
name|y1
decl_stmt|;
name|x0
operator|=
name|clipp
operator|->
name|origin
operator|.
name|x
expr_stmt|;
name|y0
operator|=
name|clipp
operator|->
name|origin
operator|.
name|y
expr_stmt|;
name|x1
operator|=
name|x0
operator|+
name|clipp
operator|->
name|extent
operator|.
name|x
operator|-
literal|1
expr_stmt|;
name|y1
operator|=
name|y0
operator|+
name|clipp
operator|->
name|extent
operator|.
name|y
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|x1
operator|<=
literal|0
operator|||
name|y1
operator|<=
literal|0
condition|)
return|return;
while|while
condition|(
operator|--
name|np
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ps
operator|->
name|x
operator|>=
name|x0
operator|)
operator|&&
operator|(
name|ps
operator|->
name|y
operator|>=
name|y0
operator|)
operator|&&
operator|(
name|ps
operator|->
name|x
operator|<=
name|x1
operator|)
operator|&&
operator|(
name|ps
operator|->
name|y
operator|<=
name|y1
operator|)
condition|)
block|{
name|mem_dot
argument_list|(
name|fb
argument_list|,
name|ps
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
block|}
name|ps
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
operator|--
name|np
operator|>=
literal|0
condition|)
block|{
name|mem_dot
argument_list|(
name|fb
argument_list|,
name|ps
argument_list|,
name|dp
operator|->
name|planemask
argument_list|,
operator|&
name|dp
operator|->
name|drawBM
argument_list|)
expr_stmt|;
name|PRE_EMPT
expr_stmt|;
name|ps
operator|++
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* !CPU_DOUBLE */
return|return
operator|(
name|FB_ROK
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|get_scrtype
argument_list|(
name|fb
argument_list|,
name|cmd
argument_list|)
specifier|register
expr|struct
name|fbdev
operator|*
name|fb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|lScrType
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|cmd
operator|->
name|colorwidth
operator|=
name|fb
operator|->
name|Colorwidth
expr_stmt|;
name|cmd
operator|->
name|plane
operator|=
name|fb
operator|->
name|fbNplane
expr_stmt|;
name|cmd
operator|->
name|bufferrect
operator|=
name|fb
operator|->
name|FrameRect
expr_stmt|;
name|cmd
operator|->
name|visiblerect
operator|=
name|fb
operator|->
name|VisRect
expr_stmt|;
name|cmd
operator|->
name|type
operator|=
name|fb
operator|->
name|type
expr_stmt|;
name|cmd
operator|->
name|unit
operator|=
name|fb
operator|->
name|unit
expr_stmt|;
return|return
name|FB_ROK
return|;
block|}
end_block

begin_expr_stmt
name|fbstart
argument_list|(
name|fbaddr
argument_list|,
name|dummy
argument_list|)
specifier|register
expr|struct
name|fbreg
operator|*
name|fbaddr
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|dummy
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|fbdev
modifier|*
name|fb
init|=
operator|&
name|fbdev
index|[
name|fbaddr
operator|->
name|fb_device
index|]
decl_stmt|;
specifier|register
name|int
name|s
decl_stmt|;
name|FB_LOCK
expr_stmt|;
if|if
condition|(
operator|!
name|fb
condition|)
block|{
return|return
operator|(
name|FB_RERROR
operator|)
return|;
block|}
comment|/* reset dimmer count */
name|rst_dimmer_cnt
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|fbaddr
operator|->
name|fb_command
condition|)
block|{
case|case
name|FB_CPROBE
case|:
name|fbaddr
operator|->
name|fb_data
operator|=
name|search_fbdev
argument_list|(
name|fbaddr
operator|->
name|fb_device
argument_list|,
name|fbaddr
operator|->
name|fb_unit
argument_list|)
expr_stmt|;
name|fbaddr
operator|->
name|fb_result
operator|=
name|FB_ROK
expr_stmt|;
break|break;
case|case
name|FB_CATTACH
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|get_scrtype
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_scrtype
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_COPEN
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|fbbm_open
argument_list|(
name|fb
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CCLOSE
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|fbbm_close
argument_list|(
name|fb
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CSETDIM
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|fbbm_set_dimmer
argument_list|(
name|fb
argument_list|,
name|fbaddr
operator|->
name|fb_data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CGETDIM
case|:
if|if
condition|(
operator|(
name|fbaddr
operator|->
name|fb_data
operator|=
name|fbbm_get_dimmer
argument_list|(
name|fb
argument_list|)
operator|)
operator|==
name|FB_RERROR
condition|)
name|fbaddr
operator|->
name|fb_result
operator|=
name|FB_RERROR
expr_stmt|;
else|else
name|fbaddr
operator|->
name|fb_result
operator|=
name|FB_ROK
expr_stmt|;
break|break;
case|case
name|FB_CBITBLT
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|bitbltcmd
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_bitblt
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CBATCHBITBLT
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|batchbitbltcmd
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_batchbitblt
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CTILEBITBLT
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|tilebitbltcmd
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_tilebitblt
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CBITBLT3
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|bitblt3cmd
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_bitblt3
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CPOLYLINE
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|draw_polyline
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_polyline
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CDJPOLYLINE
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|draw_dj_polyline
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_polyline
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CRECTANGLE
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|draw_rectangle
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_rectangle
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CFILLSCAN
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|fill_scan
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_fillscan
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CPOLYMARKER
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|draw_polymarker
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_polymarker
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CTEXT
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|put_string
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_text
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CPOLYDOT
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|draw_polydot
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_polydot
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CGETSCRTYPE
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|get_scrtype
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_scrtype
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CSETPALETTE
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|fbbm_set_palette
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_palette
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CGETPALETTE
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|fbbm_get_palette
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_palette
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CSETCURSOR
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|setCursor
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_cursor
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CUNSETCURSOR
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|setCursor
argument_list|(
name|fb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CSHOWCURSOR
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|showCursor
argument_list|(
name|fb
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CHIDECURSOR
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|hideCursor
argument_list|(
name|fb
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CSETXY
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|moveCursor
argument_list|(
name|fb
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_point
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CAUTODIM
case|:
if|if
condition|(
name|fbaddr
operator|->
name|fb_data
condition|)
name|auto_dimmer_on
argument_list|(
name|fb
argument_list|)
expr_stmt|;
else|else
name|auto_dimmer_off
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|fbaddr
operator|->
name|fb_result
operator|=
name|FB_ROK
expr_stmt|;
break|break;
case|case
name|FB_CSETVIDEO
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_SETVIDEOCTL
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_videoctl
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CGETVIDEO
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_GETVIDEOSTATUS
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_videostatus
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CSETPMODE
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_SETPALETTEMODE
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FB_CGETPMODE
case|:
name|fbaddr
operator|->
name|fb_result
operator|=
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|FB_GETPALETTEMODE
argument_list|,
operator|&
name|fbaddr
operator|->
name|fb_data
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CPU_SINGLE
case|case
name|FB_CGETPAGE
case|:
name|fbaddr
operator|->
name|fb_data
operator|=
name|fbbm_get_page
argument_list|(
name|fb
argument_list|,
name|fbaddr
operator|->
name|fb_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|fbaddr
operator|->
name|fb_data
operator|==
operator|-
literal|1
condition|)
name|fbaddr
operator|->
name|fb_result
operator|=
name|FB_RERROR
expr_stmt|;
else|else
name|fbaddr
operator|->
name|fb_result
operator|=
name|FB_ROK
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|FB_CIOCTL
case|:
name|fbaddr
operator|->
name|fb_fbioctl
operator|.
name|request
operator|=
name|fbbm_ioctl
argument_list|(
name|fb
argument_list|,
name|fbaddr
operator|->
name|fb_fbioctl
operator|.
name|request
argument_list|,
name|fbaddr
operator|->
name|fb_fbioctl
operator|.
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
name|fbaddr
operator|->
name|fb_fbioctl
operator|.
name|request
operator|==
operator|-
literal|1
condition|)
name|fbaddr
operator|->
name|fb_result
operator|=
name|FB_RERROR
expr_stmt|;
else|else
name|fbaddr
operator|->
name|fb_result
operator|=
name|FB_ROK
expr_stmt|;
break|break;
default|default:
name|fbaddr
operator|->
name|fb_result
operator|=
name|FB_RERROR
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|CPU_SINGLE
if|if
condition|(
name|cfb
operator|&&
name|curs_pending
condition|)
block|{
name|curs_pending
operator|=
literal|0
expr_stmt|;
name|redrawCursor
argument_list|(
name|cfb
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|FB_UNLOCK
expr_stmt|;
block|}
end_block

end_unit


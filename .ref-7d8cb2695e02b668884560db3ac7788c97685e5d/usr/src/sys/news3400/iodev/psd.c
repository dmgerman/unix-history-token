begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Sony Corp. and Kazumasa Utashiro of Software Research Associates, Inc.  *  * %sccs.include.redist.c%  *  * from: $Hdr: psd.c,v 4.300 91/06/09 06:38:07 root Rel41 $ SONY  *  *	@(#)psd.c	7.3 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * Copyright (c) 1987, 1988 by SONY Corporation.  */
end_comment

begin_comment
comment|/*  * psd.c	ver 1.0  *			Fri Mar 31 16:01:42 JST 1989  *  * Probe SCSI device routine  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<sys/dkstat.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|mips
end_ifdef

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_include
include|#
directive|include
file|"../iop/iopvar.h"
end_include

begin_include
include|#
directive|include
file|"../ipc/newsipc.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_SINGLE
end_ifdef

begin_include
include|#
directive|include
file|<news3400/hbdev/hbvar.h>
end_include

begin_include
include|#
directive|include
file|<news3400/hbdev/scsic.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<news3400/iodev/scsireg.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iodev/scu.h>
end_include

begin_include
include|#
directive|include
file|<news3400/iodev/ioptohb.h>
end_include

begin_define
define|#
directive|define
name|PROBE_MAXRETRY
value|100
end_define

begin_define
define|#
directive|define
name|NRETRY
value|10
end_define

begin_define
define|#
directive|define
name|MAXHRDERR
value|100
end_define

begin_define
define|#
directive|define
name|NSCSICHAN
value|7
end_define

begin_define
define|#
directive|define
name|NOSUCHDEV
value|0x7f
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|news3400
end_ifdef

begin_define
define|#
directive|define
name|MAXCTLR
value|8
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|news3800
end_ifdef

begin_define
define|#
directive|define
name|MAXCTLR
value|16
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAXSLAVE
value|8
end_define

begin_decl_stmt
name|struct
name|scsi
name|scsi
index|[
name|MAXCTLR
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sc_map
name|scmap
index|[
name|MAXCTLR
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sc_inq
name|scinq
index|[
name|MAXCTLR
index|]
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|IPC_MRX
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|port_scsi
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* UNIX port of SCSI */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|iop_scsi
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* IOP port of SCSI process */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|CPU_DOUBLE
end_ifdef

begin_decl_stmt
specifier|extern
name|struct
name|scintsw
name|scintsw
index|[]
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Universal SCSI probe routine  *	for mass storage controller.  */
end_comment

begin_expr_stmt
name|psdprobe
argument_list|(
name|im
argument_list|)
specifier|register
expr|struct
name|iop
comment|/**/
name|_ctlr
operator|*
name|im
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|intr
init|=
name|im
operator|->
name|im_intr
decl_stmt|;
name|struct
name|scintsw
modifier|*
name|sci
decl_stmt|;
name|int
name|ctlrintr
decl_stmt|;
name|int
name|j
decl_stmt|;
name|char
name|name
index|[
literal|16
index|]
decl_stmt|;
specifier|register
name|struct
name|sc_inq
modifier|*
name|inq
init|=
operator|&
name|scinq
index|[
name|intr
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|IPC_MRX
name|int
name|scintr
parameter_list|()
function_decl|;
if|if
condition|(
name|port_scsi
operator|==
literal|0
condition|)
block|{
name|port_scsi
operator|=
name|port_create
argument_list|(
literal|"@scsi"
argument_list|,
name|scintr
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MAXCTLR
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|==
literal|7
operator|||
name|j
operator|==
literal|15
condition|)
continue|continue;
name|iop_scsi
index|[
name|j
index|]
operator|=
name|object_query
argument_list|(
name|make_name
argument_list|(
name|name
argument_list|,
literal|"scsiportXX"
argument_list|,
name|j
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* IPC_MRX */
name|sci
operator|=
operator|&
name|scintsw
index|[
name|intr
index|]
expr_stmt|;
if|if
condition|(
name|sci
operator|->
name|sci_inthandler
condition|)
block|{
comment|/* 		 * already probed. 		 */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * probe device product ID 	 *& set driver interrupt handler 	 */
if|if
condition|(
name|probe_inq
argument_list|(
name|im
argument_list|,
name|inq
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * inquiry command terminate with bad status 		 *	set 0x7f(Specified device is nonexistent) to devtype 		 */
name|inq
operator|->
name|sci_devtype
operator|=
name|NOSUCHDEV
expr_stmt|;
block|}
return|return
operator|(
name|inq
operator|->
name|sci_devtype
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|set_inthandler
argument_list|(
name|im
argument_list|,
name|handler
argument_list|)
specifier|register
expr|struct
name|iop
comment|/**/
name|_ctlr
operator|*
name|im
expr_stmt|;
end_expr_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
name|struct
name|scintsw
modifier|*
name|sci
decl_stmt|;
name|sci
operator|=
operator|&
name|scintsw
index|[
name|im
operator|->
name|im_intr
index|]
expr_stmt|;
if|if
condition|(
name|sci
operator|->
name|sci_inthandler
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* already probed. */
name|sci
operator|->
name|sci_inthandler
operator|=
name|handler
expr_stmt|;
name|sci
operator|->
name|sci_ctlr
operator|=
name|im
operator|->
name|im_ctlr
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|probe_inq
argument_list|(
name|im
argument_list|,
name|inq
argument_list|)
specifier|register
expr|struct
name|iop
comment|/**/
name|_ctlr
operator|*
name|im
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|sc_inq
modifier|*
name|inq
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|intr
init|=
name|im
operator|->
name|im_intr
decl_stmt|;
specifier|register
name|struct
name|scsi
modifier|*
name|sc
init|=
operator|&
name|scsi
index|[
name|intr
index|]
decl_stmt|;
specifier|register
name|int
name|retry
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
name|inq
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sc_inq
argument_list|)
argument_list|)
expr_stmt|;
name|psdprobe_loop
label|:
name|scop_inquiry
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|SCSI_INTDIS
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sc_inq
argument_list|)
argument_list|,
name|inq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_istatus
operator|!=
name|INST_EP
condition|)
block|{
comment|/* 		 * probe fault. 		 */
if|if
condition|(
name|sc
operator|->
name|sc_istatus
operator|==
operator|(
name|INST_EP
operator||
name|INST_HE
operator|)
condition|)
block|{
comment|/* 			 * bus reset, retry 			 */
goto|goto
name|psdprobe_loop
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
ifndef|#
directive|ifndef
name|NO_STATUS_BYTE_MASK
name|sc
operator|->
name|sc_tstatus
operator|&=
name|TGSTMASK
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|sc
operator|->
name|sc_tstatus
operator|!=
name|TGST_GOOD
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_tstatus
operator|==
name|TGST_CC
condition|)
name|scop_rsense
argument_list|(
name|intr
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|SCSI_INTDIS
argument_list|,
literal|18
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry
operator|++
operator|<
name|PROBE_MAXRETRY
condition|)
block|{
name|DELAY
argument_list|(
literal|600000
argument_list|)
expr_stmt|;
comment|/* XXX  1 sec */
goto|goto
name|psdprobe_loop
goto|;
block|}
comment|/* 		 * probe fault. 		 */
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_function
name|struct
name|scsi
modifier|*
name|get_scsi
parameter_list|(
name|intr
parameter_list|)
name|int
name|intr
decl_stmt|;
block|{
return|return
operator|(
operator|&
name|scsi
index|[
name|intr
index|]
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|sc_map
modifier|*
name|get_sc_map
parameter_list|(
name|intr
parameter_list|)
name|int
name|intr
decl_stmt|;
block|{
return|return
operator|(
operator|&
name|scmap
index|[
name|intr
index|]
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|sc_inq
modifier|*
name|get_sc_inq
parameter_list|(
name|intr
parameter_list|)
name|int
name|intr
decl_stmt|;
block|{
return|return
operator|(
operator|&
name|scinq
index|[
name|intr
index|]
operator|)
return|;
block|}
end_function

end_unit


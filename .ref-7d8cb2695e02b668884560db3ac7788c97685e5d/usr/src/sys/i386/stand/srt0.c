begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1990 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz.  *  * %sccs.include.redist.c%  *  *	@(#)srt0.c	7.3 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * Startup code for standalone system  * Non-relocating version -- for programs which are loaded by boot  * Relocating version for boot  * Small relocating version for "micro" boot  */
end_comment

begin_expr_stmt
operator|.
name|globl
name|_end
operator|.
name|globl
name|_edata
operator|.
name|globl
name|_main
operator|.
name|globl
name|__rtt
operator|.
name|globl
name|_exit
operator|.
name|globl
name|_bootdev
operator|.
name|globl
name|_cyloffset
ifdef|#
directive|ifdef
name|SMALL
comment|/* where the disklabel goes if we have one */
operator|.
name|globl
name|_disklabel
name|_disklabel
operator|:
operator|.
name|space
literal|512
endif|#
directive|endif
name|entry
operator|:
operator|.
name|globl
name|entry
operator|.
name|globl
name|start
if|#
directive|if
name|defined
argument_list|(
name|REL
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|SMALL
argument_list|)
comment|/* relocate program and enter at symbol "start" */
empty|#movl	$entry-RELOC,%esi	# from beginning of ram
name|movl
name|$0
operator|,
operator|%
name|esi
empty|#movl	$entry,%edi		# to relocated area
name|movl
name|$
name|RELOC
operator|,
operator|%
name|edi
operator|#
name|to
name|relocated
name|area
empty|# movl	$_edata-RELOC,%ecx	# this much
name|movl
name|$64
operator|*
literal|1024
operator|,
operator|%
name|ecx
name|cld
name|rep
name|movsb
empty|# relocate program counter to relocation base
name|pushl
name|$start
name|ret
endif|#
directive|endif
name|start
operator|:
comment|/* setup stack pointer */
ifdef|#
directive|ifdef
name|REL
name|leal
literal|4
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|eax
comment|/* ignore old pc */
name|movl
name|$
name|RELOC
operator|-
literal|4
operator|*
literal|4
operator|,
operator|%
name|esp
comment|/* copy down boot parameters */
name|movl
operator|%
name|esp
operator|,
operator|%
name|ebx
name|pushl
name|$3
operator|*
literal|4
name|pushl
operator|%
name|ebx
name|pushl
operator|%
name|eax
name|call
name|_bcopy
name|movl
operator|%
name|ebx
operator|,
operator|%
name|esp
else|#
directive|else
comment|/* save old stack state */
name|movl
operator|%
name|esp
operator|,
name|savearea
name|movl
operator|%
name|ebp
operator|,
name|savearea
operator|+
literal|4
name|movl
name|$
name|RELOC
operator|-
literal|0x2400
operator|,
operator|%
name|esp
endif|#
directive|endif
comment|/* clear memory as needed */
name|movl
operator|%
name|esp
operator|,
operator|%
name|esi
ifdef|#
directive|ifdef
name|REL
comment|/* 	 * Clear Bss and up to 64K heap 	 */
name|movl
name|$64
operator|*
literal|1024
operator|,
operator|%
name|ebx
name|movl
name|$_end
operator|,
operator|%
name|eax
operator|#
name|should
name|be
name|movl
name|$_end
operator|-
name|_edata
name|but
operator|...
name|subl
name|$_edata
operator|,
operator|%
name|eax
name|addl
operator|%
name|ebx
operator|,
operator|%
name|eax
name|pushl
operator|%
name|eax
name|pushl
name|$_edata
name|call
name|_bzero
comment|/* 	 * Clear 64K of stack 	 */
name|movl
operator|%
name|esi
operator|,
operator|%
name|eax
name|subl
operator|%
name|ebx
operator|,
operator|%
name|eax
name|subl
name|$5
operator|*
literal|4
operator|,
operator|%
name|ebx
name|pushl
operator|%
name|ebx
name|pushl
operator|%
name|eax
name|call
name|_bzero
else|#
directive|else
name|movl
name|$_edata
operator|,
operator|%
name|edx
name|movl
operator|%
name|esp
operator|,
operator|%
name|eax
name|subl
operator|%
name|edx
operator|,
operator|%
name|eax
name|pushl
operator|%
name|edx
name|pushl
operator|%
name|esp
name|call
name|_bzero
endif|#
directive|endif
name|movl
operator|%
name|esi
operator|,
operator|%
name|esp
name|pushl
name|$0
name|popf
ifndef|#
directive|ifndef
name|SMALL
name|call
name|_kbdreset
comment|/* resets keyboard and gatea20 brain damage */
endif|#
directive|endif
name|call
name|_main
name|jmp
literal|1f
operator|.
name|data
name|_bootdev
operator|:
operator|.
name|long
literal|0
name|_cyloffset
operator|:
operator|.
name|long
literal|0
name|savearea
operator|:
operator|.
name|long
literal|0
operator|,
literal|0
operator|#
name|sp
operator|&
name|bp
name|to
end_expr_stmt

begin_return
return|return
name|to
operator|.
name|text
ifndef|#
directive|ifndef
name|SMALL
operator|.
name|globl
name|_getchar
endif|#
directive|endif
operator|.
name|globl
name|_wait
name|__rtt
operator|:
ifndef|#
directive|ifndef
name|SMALL
name|call
name|_getchar
else|#
directive|else
name|_exit
operator|:
name|pushl
name|$1000000
name|call
name|_wait
name|popl
operator|%
name|eax
endif|#
directive|endif
name|movl
name|$
operator|-
literal|7
operator|,
operator|%
name|eax
name|jmp
literal|1f
ifndef|#
directive|ifndef
name|SMALL
name|_exit
operator|:
name|call
name|_getchar
endif|#
directive|endif
name|movl
literal|4
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|eax
literal|1
operator|:
ifdef|#
directive|ifdef
name|REL
ifndef|#
directive|ifndef
name|SMALL
name|call
name|_reset_cpu
endif|#
directive|endif
name|movw
name|$0x1234
operator|,
operator|%
name|ax
name|movw
operator|%
name|ax
operator|,
literal|0x472
operator|#
name|warm
name|boot
name|movl
name|$0
operator|,
operator|%
name|esp
operator|#
name|segment
name|violation
name|ret
else|#
directive|else
name|movl
name|savearea
operator|,
operator|%
name|esp
name|movl
name|savearea
operator|+
literal|4
operator|,
operator|%
name|ebp
name|ret
endif|#
directive|endif
operator|.
name|globl
name|_inb
name|_inb
operator|:
name|movl
literal|4
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|edx
name|subl
operator|%
name|eax
operator|,
operator|%
name|eax
operator|#
name|clr
name|eax
name|inb
operator|%
name|dx
operator|,
operator|%
name|al
name|ret
operator|.
name|globl
name|_outb
name|_outb
operator|:
name|movl
literal|4
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|edx
name|movl
literal|8
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|eax
name|outb
operator|%
name|al
operator|,
operator|%
name|dx
name|ret
operator|.
name|globl
name|___udivsi3
name|___udivsi3
operator|:
name|movl
literal|4
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|eax
name|xorl
operator|%
name|edx
operator|,
operator|%
name|edx
name|divl
literal|8
operator|(
operator|%
name|esp
operator|)
name|ret
operator|.
name|globl
name|___divsi3
name|___divsi3
operator|:
name|movl
literal|4
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|eax
name|xorl
operator|%
name|edx
operator|,
operator|%
name|edx
name|cltd
name|idivl
literal|8
operator|(
operator|%
name|esp
operator|)
name|ret
empty|#
empty|# bzero (base,cnt)
empty|#
operator|.
name|globl
name|_bzero
name|_bzero
operator|:
name|pushl
operator|%
name|edi
name|movl
literal|8
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|edi
name|movl
literal|12
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|ecx
name|movb
name|$0x00
operator|,
operator|%
name|al
name|cld
name|rep
name|stosb
name|popl
operator|%
name|edi
name|ret
empty|#
empty|# bcopy (src,dst,cnt)
empty|# NOTE: does not (yet) handle overlapped copies
empty|#
operator|.
name|globl
name|_bcopy
name|_bcopy
operator|:
name|pushl
operator|%
name|esi
name|pushl
operator|%
name|edi
name|movl
literal|12
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|esi
name|movl
literal|16
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|edi
name|movl
literal|20
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|ecx
name|cld
name|rep
name|movsb
name|popl
operator|%
name|edi
name|popl
operator|%
name|esi
name|ret
empty|# insw(port,addr,cnt)
operator|.
name|globl
name|_insw
name|_insw
operator|:
name|pushl
operator|%
name|edi
name|movw
literal|8
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|dx
name|movl
literal|12
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|edi
name|movl
literal|16
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|ecx
name|cld
name|nop
operator|.
name|byte
literal|0x66
operator|,
literal|0xf2
operator|,
literal|0x6d
operator|#
name|rep
name|insw
name|nop
name|movl
operator|%
name|edi
operator|,
operator|%
name|eax
name|popl
operator|%
name|edi
name|ret
empty|# outsw(port,addr,cnt)
operator|.
name|globl
name|_outsw
name|_outsw
operator|:
name|pushl
operator|%
name|esi
name|movw
literal|8
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|dx
name|movl
literal|12
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|esi
name|movl
literal|16
operator|(
operator|%
name|esp
operator|)
operator|,
operator|%
name|ecx
name|cld
name|nop
operator|.
name|byte
literal|0x66
operator|,
literal|0xf2
operator|,
literal|0x6f
operator|#
name|rep
name|outsw
name|nop
name|movl
operator|%
name|esi
operator|,
operator|%
name|eax
name|popl
operator|%
name|esi
name|ret
end_return

end_unit


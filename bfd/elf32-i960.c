begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Intel 960 specific support for 32-bit ELF    Copyright 1999, 2000, 2001, 2002, 2003, 2005 Free Software Foundation, Inc.     This file is part of BFD, the Binary File Descriptor library.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston,    MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"elf-bfd.h"
end_include

begin_include
include|#
directive|include
file|"elf/i960.h"
end_include

begin_define
define|#
directive|define
name|USE_REL
value|1
end_define

begin_define
define|#
directive|define
name|bfd_elf32_bfd_reloc_type_lookup
value|elf32_i960_reloc_type_lookup
end_define

begin_define
define|#
directive|define
name|elf_info_to_howto
value|elf32_i960_info_to_howto
end_define

begin_define
define|#
directive|define
name|elf_info_to_howto_rel
value|elf32_i960_info_to_howto_rel
end_define

begin_comment
comment|/* ELF relocs are against symbols.  If we are producing relocatable    output, and the reloc is against an external symbol, and nothing    has given us any additional addend, the resulting reloc will also    be against the same symbol.  In such a case, we don't want to    change anything about the way the reloc is handled, since it will    all be done at final link time.  Rather than put special case code    into bfd_perform_relocation, all the reloc types use this howto    function.  It just short circuits the reloc if producing    relocatable output against an external symbol.  */
end_comment

begin_function
specifier|static
name|bfd_reloc_status_type
name|elf32_i960_relocate
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|arelent
modifier|*
name|reloc_entry
parameter_list|,
name|asymbol
modifier|*
name|symbol
parameter_list|,
name|PTR
name|data
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|input_section
parameter_list|,
name|bfd
modifier|*
name|output_bfd
parameter_list|,
name|char
modifier|*
modifier|*
name|error_message
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
comment|/* HACK: I think this first condition is necessary when producing      relocatable output.  After the end of HACK, the code is identical      to bfd_elf_generic_reloc().  I would _guess_ the first change      belongs there rather than here.  martindo 1998-10-23.  */
if|if
condition|(
name|output_bfd
operator|!=
operator|(
name|bfd
operator|*
operator|)
name|NULL
operator|&&
name|reloc_entry
operator|->
name|howto
operator|->
name|pc_relative
operator|&&
operator|!
name|reloc_entry
operator|->
name|howto
operator|->
name|pcrel_offset
condition|)
name|reloc_entry
operator|->
name|addend
operator|-=
name|symbol
operator|->
name|value
expr_stmt|;
comment|/* This is more dubious.  */
elseif|else
if|if
condition|(
name|output_bfd
operator|!=
operator|(
name|bfd
operator|*
operator|)
name|NULL
operator|&&
operator|(
name|symbol
operator|->
name|flags
operator|&
name|BSF_SECTION_SYM
operator|)
operator|!=
literal|0
condition|)
name|reloc_entry
operator|->
name|addend
operator|-=
name|symbol
operator|->
name|section
operator|->
name|output_section
operator|->
name|vma
expr_stmt|;
else|else
block|{
comment|/* ...end of HACK.  */
if|if
condition|(
name|output_bfd
operator|!=
operator|(
name|bfd
operator|*
operator|)
name|NULL
operator|&&
operator|(
name|symbol
operator|->
name|flags
operator|&
name|BSF_SECTION_SYM
operator|)
operator|==
literal|0
operator|&&
operator|(
operator|!
name|reloc_entry
operator|->
name|howto
operator|->
name|partial_inplace
operator|||
name|reloc_entry
operator|->
name|addend
operator|==
literal|0
operator|)
condition|)
block|{
name|reloc_entry
operator|->
name|address
operator|+=
name|input_section
operator|->
name|output_offset
expr_stmt|;
return|return
name|bfd_reloc_ok
return|;
block|}
block|}
return|return
name|bfd_reloc_continue
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|reloc_howto_type
name|elf_howto_table
index|[]
init|=
block|{
name|HOWTO
argument_list|(
name|R_960_NONE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
name|complain_overflow_bitfield
argument_list|,
name|elf32_i960_relocate
argument_list|,
literal|"R_960_NONE"
argument_list|,
name|TRUE
argument_list|,
literal|0x00000000
argument_list|,
literal|0x00000000
argument_list|,
name|FALSE
argument_list|)
block|,
name|EMPTY_HOWTO
argument_list|(
literal|1
argument_list|)
block|,
name|HOWTO
argument_list|(
name|R_960_32
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|32
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|,
name|complain_overflow_bitfield
argument_list|,
name|elf32_i960_relocate
argument_list|,
literal|"R_960_32"
argument_list|,
name|TRUE
argument_list|,
literal|0xffffffff
argument_list|,
literal|0xffffffff
argument_list|,
name|FALSE
argument_list|)
block|,
name|HOWTO
argument_list|(
name|R_960_IP24
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|24
argument_list|,
name|TRUE
argument_list|,
literal|0
argument_list|,
name|complain_overflow_signed
argument_list|,
name|elf32_i960_relocate
argument_list|,
literal|"R_960_IP24 "
argument_list|,
name|TRUE
argument_list|,
literal|0x00ffffff
argument_list|,
literal|0x00ffffff
argument_list|,
name|FALSE
argument_list|)
block|,
name|EMPTY_HOWTO
argument_list|(
literal|4
argument_list|)
block|,
name|EMPTY_HOWTO
argument_list|(
literal|5
argument_list|)
block|,
name|EMPTY_HOWTO
argument_list|(
literal|6
argument_list|)
block|,
name|EMPTY_HOWTO
argument_list|(
literal|7
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|enum
name|elf_i960_reloc_type
name|elf32_i960_bfd_to_reloc_type
parameter_list|(
name|bfd_reloc_code_real_type
name|code
parameter_list|)
block|{
switch|switch
condition|(
name|code
condition|)
block|{
default|default:
return|return
name|R_960_NONE
return|;
case|case
name|BFD_RELOC_I960_CALLJ
case|:
return|return
name|R_960_OPTCALL
return|;
case|case
name|BFD_RELOC_32
case|:
case|case
name|BFD_RELOC_CTOR
case|:
return|return
name|R_960_32
return|;
case|case
name|BFD_RELOC_24_PCREL
case|:
return|return
name|R_960_IP24
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|elf32_i960_info_to_howto
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|arelent
modifier|*
name|cache_ptr
name|ATTRIBUTE_UNUSED
parameter_list|,
name|Elf_Internal_Rela
modifier|*
name|dst
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|elf32_i960_info_to_howto_rel
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|arelent
modifier|*
name|cache_ptr
parameter_list|,
name|Elf_Internal_Rela
modifier|*
name|dst
parameter_list|)
block|{
name|enum
name|elf_i960_reloc_type
name|type
decl_stmt|;
name|type
operator|=
operator|(
expr|enum
name|elf_i960_reloc_type
operator|)
name|ELF32_R_TYPE
argument_list|(
name|dst
operator|->
name|r_info
argument_list|)
expr_stmt|;
name|BFD_ASSERT
argument_list|(
name|type
operator|<
name|R_960_max
argument_list|)
expr_stmt|;
name|cache_ptr
operator|->
name|howto
operator|=
operator|&
name|elf_howto_table
index|[
operator|(
name|int
operator|)
name|type
index|]
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|reloc_howto_type
modifier|*
name|elf32_i960_reloc_type_lookup
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_reloc_code_real_type
name|code
parameter_list|)
block|{
return|return
name|elf_howto_table
operator|+
name|elf32_i960_bfd_to_reloc_type
argument_list|(
name|code
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|TARGET_LITTLE_SYM
value|bfd_elf32_i960_vec
end_define

begin_define
define|#
directive|define
name|TARGET_LITTLE_NAME
value|"elf32-i960"
end_define

begin_define
define|#
directive|define
name|ELF_ARCH
value|bfd_arch_i960
end_define

begin_define
define|#
directive|define
name|ELF_MACHINE_CODE
value|EM_960
end_define

begin_define
define|#
directive|define
name|ELF_MAXPAGESIZE
value|1
end_define

begin_comment
comment|/* FIXME: This number is wrong,  It should be the page size in bytes.  */
end_comment

begin_include
include|#
directive|include
file|"elf32-target.h"
end_include

end_unit


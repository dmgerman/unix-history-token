begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* AVR-specific support for 32-bit ELF    Copyright 1999, 2000, 2001, 2002, 2003, 2004    Free Software Foundation, Inc.    Contributed by Denis Chertykov<denisc@overta.ru>  This file is part of BFD, the Binary File Descriptor library.  This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"elf-bfd.h"
end_include

begin_include
include|#
directive|include
file|"elf/avr.h"
end_include

begin_decl_stmt
specifier|static
name|reloc_howto_type
modifier|*
name|bfd_elf32_bfd_reloc_type_lookup
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
name|abfd
operator|,
name|bfd_reloc_code_real_type
name|code
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|avr_info_to_howto_rela
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
operator|,
name|arelent
operator|*
operator|,
name|Elf_Internal_Rela
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|asection
modifier|*
name|elf32_avr_gc_mark_hook
name|PARAMS
argument_list|(
operator|(
name|asection
operator|*
operator|,
expr|struct
name|bfd_link_info
operator|*
operator|,
name|Elf_Internal_Rela
operator|*
operator|,
expr|struct
name|elf_link_hash_entry
operator|*
operator|,
name|Elf_Internal_Sym
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bfd_boolean
name|elf32_avr_gc_sweep_hook
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
operator|,
expr|struct
name|bfd_link_info
operator|*
operator|,
name|asection
operator|*
operator|,
specifier|const
name|Elf_Internal_Rela
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bfd_boolean
name|elf32_avr_check_relocs
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
operator|,
expr|struct
name|bfd_link_info
operator|*
operator|,
name|asection
operator|*
operator|,
specifier|const
name|Elf_Internal_Rela
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bfd_reloc_status_type
name|avr_final_link_relocate
name|PARAMS
argument_list|(
operator|(
name|reloc_howto_type
operator|*
operator|,
name|bfd
operator|*
operator|,
name|asection
operator|*
operator|,
name|bfd_byte
operator|*
operator|,
name|Elf_Internal_Rela
operator|*
operator|,
name|bfd_vma
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bfd_boolean
name|elf32_avr_relocate_section
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
operator|,
expr|struct
name|bfd_link_info
operator|*
operator|,
name|bfd
operator|*
operator|,
name|asection
operator|*
operator|,
name|bfd_byte
operator|*
operator|,
name|Elf_Internal_Rela
operator|*
operator|,
name|Elf_Internal_Sym
operator|*
operator|,
name|asection
operator|*
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|bfd_elf_avr_final_write_processing
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
operator|,
name|bfd_boolean
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bfd_boolean
name|elf32_avr_object_p
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|reloc_howto_type
name|elf_avr_howto_table
index|[]
init|=
block|{
name|HOWTO
argument_list|(
name|R_AVR_NONE
argument_list|,
comment|/* type */
literal|0
argument_list|,
comment|/* rightshift */
literal|2
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|32
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_bitfield
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_NONE"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0
argument_list|,
comment|/* src_mask */
literal|0
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
name|HOWTO
argument_list|(
name|R_AVR_32
argument_list|,
comment|/* type */
literal|0
argument_list|,
comment|/* rightshift */
literal|2
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|32
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_bitfield
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_32"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffffffff
argument_list|,
comment|/* src_mask */
literal|0xffffffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A 7 bit PC relative relocation.  */
name|HOWTO
argument_list|(
name|R_AVR_7_PCREL
argument_list|,
comment|/* type */
literal|1
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|7
argument_list|,
comment|/* bitsize */
name|TRUE
argument_list|,
comment|/* pc_relative */
literal|3
argument_list|,
comment|/* bitpos */
name|complain_overflow_bitfield
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_7_PCREL"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|TRUE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A 13 bit PC relative relocation.  */
name|HOWTO
argument_list|(
name|R_AVR_13_PCREL
argument_list|,
comment|/* type */
literal|1
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|13
argument_list|,
comment|/* bitsize */
name|TRUE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_bitfield
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_13_PCREL"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xfff
argument_list|,
comment|/* src_mask */
literal|0xfff
argument_list|,
comment|/* dst_mask */
name|TRUE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A 16 bit absolute relocation.  */
name|HOWTO
argument_list|(
name|R_AVR_16
argument_list|,
comment|/* type */
literal|0
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|16
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_16"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A 16 bit absolute relocation for command address.  */
name|HOWTO
argument_list|(
name|R_AVR_16_PM
argument_list|,
comment|/* type */
literal|1
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|16
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_bitfield
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_16_PM"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A low 8 bit absolute relocation of 16 bit address.      For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_LO8_LDI
argument_list|,
comment|/* type */
literal|0
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_LO8_LDI"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A high 8 bit absolute relocation of 16 bit address.      For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_HI8_LDI
argument_list|,
comment|/* type */
literal|8
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_HI8_LDI"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A high 6 bit absolute relocation of 22 bit address.      For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_HH8_LDI
argument_list|,
comment|/* type */
literal|16
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_HH8_LDI"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A negative low 8 bit absolute relocation of 16 bit address.      For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_LO8_LDI_NEG
argument_list|,
comment|/* type */
literal|0
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_LO8_LDI_NEG"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A hegative high 8 bit absolute relocation of 16 bit address.      For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_HI8_LDI_NEG
argument_list|,
comment|/* type */
literal|8
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_HI8_LDI_NEG"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A hegative high 6 bit absolute relocation of 22 bit address.      For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_HH8_LDI_NEG
argument_list|,
comment|/* type */
literal|16
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_HH8_LDI_NEG"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A low 8 bit absolute relocation of 24 bit program memory address.      For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_LO8_LDI_PM
argument_list|,
comment|/* type */
literal|1
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_LO8_LDI_PM"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A high 8 bit absolute relocation of 16 bit program memory address.      For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_HI8_LDI_PM
argument_list|,
comment|/* type */
literal|9
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_HI8_LDI_PM"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A high 8 bit absolute relocation of 24 bit program memory address.      For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_HH8_LDI_PM
argument_list|,
comment|/* type */
literal|17
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_HH8_LDI_PM"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A low 8 bit absolute relocation of a negative 24 bit      program memory address.  For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_LO8_LDI_PM_NEG
argument_list|,
comment|/* type */
literal|1
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_LO8_LDI_PM_NEG"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A high 8 bit absolute relocation of a negative 16 bit      program memory address.  For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_HI8_LDI_PM_NEG
argument_list|,
comment|/* type */
literal|9
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_HI8_LDI_PM_NEG"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* A high 8 bit absolute relocation of a negative 24 bit      program memory address.  For LDI command.  */
name|HOWTO
argument_list|(
name|R_AVR_HH8_LDI_PM_NEG
argument_list|,
comment|/* type */
literal|17
argument_list|,
comment|/* rightshift */
literal|1
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|8
argument_list|,
comment|/* bitsize */
name|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
name|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
name|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_HH8_LDI_PM_NEG"
argument_list|,
comment|/* name */
name|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffff
argument_list|,
comment|/* src_mask */
literal|0xffff
argument_list|,
comment|/* dst_mask */
name|FALSE
argument_list|)
block|,
comment|/* pcrel_offset */
comment|/* Relocation for CALL command in ATmega.  */
name|HOWTO
argument_list|(
argument|R_AVR_CALL
argument_list|,
comment|/* type */
literal|1
argument_list|,
comment|/* rightshift */
literal|2
argument_list|,
comment|/* size (0 = byte, 1 = short, 2 = long) */
literal|23
argument_list|,
comment|/* bitsize */
argument|FALSE
argument_list|,
comment|/* pc_relative */
literal|0
argument_list|,
comment|/* bitpos */
argument|complain_overflow_dont
argument_list|,
comment|/* complain_on_overflow */
argument|bfd_elf_generic_reloc
argument_list|,
comment|/* special_function */
literal|"R_AVR_CALL"
argument_list|,
comment|/* name */
argument|FALSE
argument_list|,
comment|/* partial_inplace */
literal|0xffffffff
argument_list|,
comment|/* src_mask */
literal|0xffffffff
argument_list|,
comment|/* dst_mask */
argument|FALSE
argument_list|)
comment|/* pcrel_offset */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Map BFD reloc types to AVR ELF reloc types.  */
end_comment

begin_struct
struct|struct
name|avr_reloc_map
block|{
name|bfd_reloc_code_real_type
name|bfd_reloc_val
decl_stmt|;
name|unsigned
name|int
name|elf_reloc_val
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|avr_reloc_map
name|avr_reloc_map
index|[]
init|=
block|{
block|{
name|BFD_RELOC_NONE
block|,
name|R_AVR_NONE
block|}
block|,
block|{
name|BFD_RELOC_32
block|,
name|R_AVR_32
block|}
block|,
block|{
name|BFD_RELOC_AVR_7_PCREL
block|,
name|R_AVR_7_PCREL
block|}
block|,
block|{
name|BFD_RELOC_AVR_13_PCREL
block|,
name|R_AVR_13_PCREL
block|}
block|,
block|{
name|BFD_RELOC_16
block|,
name|R_AVR_16
block|}
block|,
block|{
name|BFD_RELOC_AVR_16_PM
block|,
name|R_AVR_16_PM
block|}
block|,
block|{
name|BFD_RELOC_AVR_LO8_LDI
block|,
name|R_AVR_LO8_LDI
block|}
block|,
block|{
name|BFD_RELOC_AVR_HI8_LDI
block|,
name|R_AVR_HI8_LDI
block|}
block|,
block|{
name|BFD_RELOC_AVR_HH8_LDI
block|,
name|R_AVR_HH8_LDI
block|}
block|,
block|{
name|BFD_RELOC_AVR_LO8_LDI_NEG
block|,
name|R_AVR_LO8_LDI_NEG
block|}
block|,
block|{
name|BFD_RELOC_AVR_HI8_LDI_NEG
block|,
name|R_AVR_HI8_LDI_NEG
block|}
block|,
block|{
name|BFD_RELOC_AVR_HH8_LDI_NEG
block|,
name|R_AVR_HH8_LDI_NEG
block|}
block|,
block|{
name|BFD_RELOC_AVR_LO8_LDI_PM
block|,
name|R_AVR_LO8_LDI_PM
block|}
block|,
block|{
name|BFD_RELOC_AVR_HI8_LDI_PM
block|,
name|R_AVR_HI8_LDI_PM
block|}
block|,
block|{
name|BFD_RELOC_AVR_HH8_LDI_PM
block|,
name|R_AVR_HH8_LDI_PM
block|}
block|,
block|{
name|BFD_RELOC_AVR_LO8_LDI_PM_NEG
block|,
name|R_AVR_LO8_LDI_PM_NEG
block|}
block|,
block|{
name|BFD_RELOC_AVR_HI8_LDI_PM_NEG
block|,
name|R_AVR_HI8_LDI_PM_NEG
block|}
block|,
block|{
name|BFD_RELOC_AVR_HH8_LDI_PM_NEG
block|,
name|R_AVR_HH8_LDI_PM_NEG
block|}
block|,
block|{
name|BFD_RELOC_AVR_CALL
block|,
name|R_AVR_CALL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|reloc_howto_type
modifier|*
name|bfd_elf32_bfd_reloc_type_lookup
parameter_list|(
name|abfd
parameter_list|,
name|code
parameter_list|)
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
decl_stmt|;
name|bfd_reloc_code_real_type
name|code
decl_stmt|;
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|avr_reloc_map
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|avr_reloc_map
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|avr_reloc_map
index|[
name|i
index|]
operator|.
name|bfd_reloc_val
operator|==
name|code
condition|)
return|return
operator|&
name|elf_avr_howto_table
index|[
name|avr_reloc_map
index|[
name|i
index|]
operator|.
name|elf_reloc_val
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* Set the howto pointer for an AVR ELF reloc.  */
end_comment

begin_function
specifier|static
name|void
name|avr_info_to_howto_rela
parameter_list|(
name|abfd
parameter_list|,
name|cache_ptr
parameter_list|,
name|dst
parameter_list|)
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
decl_stmt|;
name|arelent
modifier|*
name|cache_ptr
decl_stmt|;
name|Elf_Internal_Rela
modifier|*
name|dst
decl_stmt|;
block|{
name|unsigned
name|int
name|r_type
decl_stmt|;
name|r_type
operator|=
name|ELF32_R_TYPE
argument_list|(
name|dst
operator|->
name|r_info
argument_list|)
expr_stmt|;
name|BFD_ASSERT
argument_list|(
name|r_type
operator|<
operator|(
name|unsigned
name|int
operator|)
name|R_AVR_max
argument_list|)
expr_stmt|;
name|cache_ptr
operator|->
name|howto
operator|=
operator|&
name|elf_avr_howto_table
index|[
name|r_type
index|]
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|asection
modifier|*
name|elf32_avr_gc_mark_hook
parameter_list|(
name|sec
parameter_list|,
name|info
parameter_list|,
name|rel
parameter_list|,
name|h
parameter_list|,
name|sym
parameter_list|)
name|asection
modifier|*
name|sec
decl_stmt|;
name|struct
name|bfd_link_info
modifier|*
name|info
name|ATTRIBUTE_UNUSED
decl_stmt|;
name|Elf_Internal_Rela
modifier|*
name|rel
decl_stmt|;
name|struct
name|elf_link_hash_entry
modifier|*
name|h
decl_stmt|;
name|Elf_Internal_Sym
modifier|*
name|sym
decl_stmt|;
block|{
if|if
condition|(
name|h
operator|!=
name|NULL
condition|)
block|{
switch|switch
condition|(
name|ELF32_R_TYPE
argument_list|(
name|rel
operator|->
name|r_info
argument_list|)
condition|)
block|{
default|default:
switch|switch
condition|(
name|h
operator|->
name|root
operator|.
name|type
condition|)
block|{
case|case
name|bfd_link_hash_defined
case|:
case|case
name|bfd_link_hash_defweak
case|:
return|return
name|h
operator|->
name|root
operator|.
name|u
operator|.
name|def
operator|.
name|section
return|;
case|case
name|bfd_link_hash_common
case|:
return|return
name|h
operator|->
name|root
operator|.
name|u
operator|.
name|c
operator|.
name|p
operator|->
name|section
return|;
default|default:
break|break;
block|}
block|}
block|}
else|else
return|return
name|bfd_section_from_elf_index
argument_list|(
name|sec
operator|->
name|owner
argument_list|,
name|sym
operator|->
name|st_shndx
argument_list|)
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|bfd_boolean
name|elf32_avr_gc_sweep_hook
parameter_list|(
name|abfd
parameter_list|,
name|info
parameter_list|,
name|sec
parameter_list|,
name|relocs
parameter_list|)
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
decl_stmt|;
name|struct
name|bfd_link_info
modifier|*
name|info
name|ATTRIBUTE_UNUSED
decl_stmt|;
name|asection
modifier|*
name|sec
name|ATTRIBUTE_UNUSED
decl_stmt|;
specifier|const
name|Elf_Internal_Rela
modifier|*
name|relocs
name|ATTRIBUTE_UNUSED
decl_stmt|;
block|{
comment|/* We don't use got and plt entries for avr.  */
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Look through the relocs for a section during the first phase.    Since we don't do .gots or .plts, we just need to consider the    virtual table relocs for gc.  */
end_comment

begin_function
specifier|static
name|bfd_boolean
name|elf32_avr_check_relocs
parameter_list|(
name|abfd
parameter_list|,
name|info
parameter_list|,
name|sec
parameter_list|,
name|relocs
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
name|struct
name|bfd_link_info
modifier|*
name|info
decl_stmt|;
name|asection
modifier|*
name|sec
decl_stmt|;
specifier|const
name|Elf_Internal_Rela
modifier|*
name|relocs
decl_stmt|;
block|{
name|Elf_Internal_Shdr
modifier|*
name|symtab_hdr
decl_stmt|;
name|struct
name|elf_link_hash_entry
modifier|*
modifier|*
name|sym_hashes
decl_stmt|,
modifier|*
modifier|*
name|sym_hashes_end
decl_stmt|;
specifier|const
name|Elf_Internal_Rela
modifier|*
name|rel
decl_stmt|;
specifier|const
name|Elf_Internal_Rela
modifier|*
name|rel_end
decl_stmt|;
if|if
condition|(
name|info
operator|->
name|relocatable
condition|)
return|return
name|TRUE
return|;
name|symtab_hdr
operator|=
operator|&
name|elf_tdata
argument_list|(
name|abfd
argument_list|)
operator|->
name|symtab_hdr
expr_stmt|;
name|sym_hashes
operator|=
name|elf_sym_hashes
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
name|sym_hashes_end
operator|=
name|sym_hashes
operator|+
name|symtab_hdr
operator|->
name|sh_size
operator|/
sizeof|sizeof
argument_list|(
name|Elf32_External_Sym
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|elf_bad_symtab
argument_list|(
name|abfd
argument_list|)
condition|)
name|sym_hashes_end
operator|-=
name|symtab_hdr
operator|->
name|sh_info
expr_stmt|;
name|rel_end
operator|=
name|relocs
operator|+
name|sec
operator|->
name|reloc_count
expr_stmt|;
for|for
control|(
name|rel
operator|=
name|relocs
init|;
name|rel
operator|<
name|rel_end
condition|;
name|rel
operator|++
control|)
block|{
name|struct
name|elf_link_hash_entry
modifier|*
name|h
decl_stmt|;
name|unsigned
name|long
name|r_symndx
decl_stmt|;
name|r_symndx
operator|=
name|ELF32_R_SYM
argument_list|(
name|rel
operator|->
name|r_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|r_symndx
operator|<
name|symtab_hdr
operator|->
name|sh_info
condition|)
name|h
operator|=
name|NULL
expr_stmt|;
else|else
name|h
operator|=
name|sym_hashes
index|[
name|r_symndx
operator|-
name|symtab_hdr
operator|->
name|sh_info
index|]
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Perform a single relocation.  By default we use the standard BFD    routines, but a few relocs, we have to do them ourselves.  */
end_comment

begin_function
specifier|static
name|bfd_reloc_status_type
name|avr_final_link_relocate
parameter_list|(
name|howto
parameter_list|,
name|input_bfd
parameter_list|,
name|input_section
parameter_list|,
name|contents
parameter_list|,
name|rel
parameter_list|,
name|relocation
parameter_list|)
name|reloc_howto_type
modifier|*
name|howto
decl_stmt|;
name|bfd
modifier|*
name|input_bfd
decl_stmt|;
name|asection
modifier|*
name|input_section
decl_stmt|;
name|bfd_byte
modifier|*
name|contents
decl_stmt|;
name|Elf_Internal_Rela
modifier|*
name|rel
decl_stmt|;
name|bfd_vma
name|relocation
decl_stmt|;
block|{
name|bfd_reloc_status_type
name|r
init|=
name|bfd_reloc_ok
decl_stmt|;
name|bfd_vma
name|x
decl_stmt|;
name|bfd_signed_vma
name|srel
decl_stmt|;
switch|switch
condition|(
name|howto
operator|->
name|type
condition|)
block|{
case|case
name|R_AVR_7_PCREL
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
expr_stmt|;
name|srel
operator|+=
name|rel
operator|->
name|r_addend
expr_stmt|;
name|srel
operator|-=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|-=
literal|2
expr_stmt|;
comment|/* Branch instructions add 2 to the PC...  */
name|srel
operator|-=
operator|(
name|input_section
operator|->
name|output_section
operator|->
name|vma
operator|+
name|input_section
operator|->
name|output_offset
operator|)
expr_stmt|;
if|if
condition|(
name|srel
operator|&
literal|1
condition|)
return|return
name|bfd_reloc_outofrange
return|;
if|if
condition|(
name|srel
operator|>
operator|(
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|-
literal|1
operator|)
operator|||
operator|(
name|srel
operator|<
operator|-
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|)
condition|)
return|return
name|bfd_reloc_overflow
return|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xfc07
operator|)
operator||
operator|(
operator|(
operator|(
name|srel
operator|>>
literal|1
operator|)
operator|<<
literal|3
operator|)
operator|&
literal|0x3f8
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_13_PCREL
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
expr_stmt|;
name|srel
operator|+=
name|rel
operator|->
name|r_addend
expr_stmt|;
name|srel
operator|-=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|-=
literal|2
expr_stmt|;
comment|/* Branch instructions add 2 to the PC...  */
name|srel
operator|-=
operator|(
name|input_section
operator|->
name|output_section
operator|->
name|vma
operator|+
name|input_section
operator|->
name|output_offset
operator|)
expr_stmt|;
if|if
condition|(
name|srel
operator|&
literal|1
condition|)
return|return
name|bfd_reloc_outofrange
return|;
comment|/* AVR addresses commands as words.  */
name|srel
operator|>>=
literal|1
expr_stmt|;
comment|/* Check for overflow.  */
if|if
condition|(
name|srel
operator|<
operator|-
literal|2048
operator|||
name|srel
operator|>
literal|2047
condition|)
block|{
comment|/* Apply WRAPAROUND if possible.  */
switch|switch
condition|(
name|bfd_get_mach
argument_list|(
name|input_bfd
argument_list|)
condition|)
block|{
case|case
name|bfd_mach_avr2
case|:
case|case
name|bfd_mach_avr4
case|:
break|break;
default|default:
return|return
name|bfd_reloc_overflow
return|;
block|}
block|}
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf000
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xfff
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_LO8_LDI
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_HI8_LDI
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
name|srel
operator|=
operator|(
name|srel
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_HH8_LDI
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
name|srel
operator|=
operator|(
name|srel
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_LO8_LDI_NEG
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
name|srel
operator|=
operator|-
name|srel
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_HI8_LDI_NEG
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
name|srel
operator|=
operator|-
name|srel
expr_stmt|;
name|srel
operator|=
operator|(
name|srel
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_HH8_LDI_NEG
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
name|srel
operator|=
operator|-
name|srel
expr_stmt|;
name|srel
operator|=
operator|(
name|srel
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_LO8_LDI_PM
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
if|if
condition|(
name|srel
operator|&
literal|1
condition|)
return|return
name|bfd_reloc_outofrange
return|;
name|srel
operator|=
name|srel
operator|>>
literal|1
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_HI8_LDI_PM
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
if|if
condition|(
name|srel
operator|&
literal|1
condition|)
return|return
name|bfd_reloc_outofrange
return|;
name|srel
operator|=
name|srel
operator|>>
literal|1
expr_stmt|;
name|srel
operator|=
operator|(
name|srel
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_HH8_LDI_PM
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
if|if
condition|(
name|srel
operator|&
literal|1
condition|)
return|return
name|bfd_reloc_outofrange
return|;
name|srel
operator|=
name|srel
operator|>>
literal|1
expr_stmt|;
name|srel
operator|=
operator|(
name|srel
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_LO8_LDI_PM_NEG
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
name|srel
operator|=
operator|-
name|srel
expr_stmt|;
if|if
condition|(
name|srel
operator|&
literal|1
condition|)
return|return
name|bfd_reloc_outofrange
return|;
name|srel
operator|=
name|srel
operator|>>
literal|1
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_HI8_LDI_PM_NEG
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
name|srel
operator|=
operator|-
name|srel
expr_stmt|;
if|if
condition|(
name|srel
operator|&
literal|1
condition|)
return|return
name|bfd_reloc_outofrange
return|;
name|srel
operator|=
name|srel
operator|>>
literal|1
expr_stmt|;
name|srel
operator|=
operator|(
name|srel
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_HH8_LDI_PM_NEG
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
name|srel
operator|=
operator|-
name|srel
expr_stmt|;
if|if
condition|(
name|srel
operator|&
literal|1
condition|)
return|return
name|bfd_reloc_outofrange
return|;
name|srel
operator|=
name|srel
operator|>>
literal|1
expr_stmt|;
name|srel
operator|=
operator|(
name|srel
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|x
operator|&
literal|0xf0f0
operator|)
operator||
operator|(
name|srel
operator|&
literal|0xf
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|4
operator|)
operator|&
literal|0xf00
operator|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_AVR_CALL
case|:
name|contents
operator|+=
name|rel
operator|->
name|r_offset
expr_stmt|;
name|srel
operator|=
operator|(
name|bfd_signed_vma
operator|)
name|relocation
operator|+
name|rel
operator|->
name|r_addend
expr_stmt|;
if|if
condition|(
name|srel
operator|&
literal|1
condition|)
return|return
name|bfd_reloc_outofrange
return|;
name|srel
operator|=
name|srel
operator|>>
literal|1
expr_stmt|;
name|x
operator|=
name|bfd_get_16
argument_list|(
name|input_bfd
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|srel
operator|&
literal|0x10000
operator|)
operator||
operator|(
operator|(
name|srel
operator|<<
literal|3
operator|)
operator|&
literal|0x1f00000
operator|)
operator|)
operator|>>
literal|16
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
name|x
argument_list|,
name|contents
argument_list|)
expr_stmt|;
name|bfd_put_16
argument_list|(
name|input_bfd
argument_list|,
operator|(
name|bfd_vma
operator|)
name|srel
operator|&
literal|0xffff
argument_list|,
name|contents
operator|+
literal|2
argument_list|)
expr_stmt|;
break|break;
default|default:
name|r
operator|=
name|_bfd_final_link_relocate
argument_list|(
name|howto
argument_list|,
name|input_bfd
argument_list|,
name|input_section
argument_list|,
name|contents
argument_list|,
name|rel
operator|->
name|r_offset
argument_list|,
name|relocation
argument_list|,
name|rel
operator|->
name|r_addend
argument_list|)
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Relocate an AVR ELF section.  */
end_comment

begin_function
specifier|static
name|bfd_boolean
name|elf32_avr_relocate_section
parameter_list|(
name|output_bfd
parameter_list|,
name|info
parameter_list|,
name|input_bfd
parameter_list|,
name|input_section
parameter_list|,
name|contents
parameter_list|,
name|relocs
parameter_list|,
name|local_syms
parameter_list|,
name|local_sections
parameter_list|)
name|bfd
modifier|*
name|output_bfd
name|ATTRIBUTE_UNUSED
decl_stmt|;
name|struct
name|bfd_link_info
modifier|*
name|info
decl_stmt|;
name|bfd
modifier|*
name|input_bfd
decl_stmt|;
name|asection
modifier|*
name|input_section
decl_stmt|;
name|bfd_byte
modifier|*
name|contents
decl_stmt|;
name|Elf_Internal_Rela
modifier|*
name|relocs
decl_stmt|;
name|Elf_Internal_Sym
modifier|*
name|local_syms
decl_stmt|;
name|asection
modifier|*
modifier|*
name|local_sections
decl_stmt|;
block|{
name|Elf_Internal_Shdr
modifier|*
name|symtab_hdr
decl_stmt|;
name|struct
name|elf_link_hash_entry
modifier|*
modifier|*
name|sym_hashes
decl_stmt|;
name|Elf_Internal_Rela
modifier|*
name|rel
decl_stmt|;
name|Elf_Internal_Rela
modifier|*
name|relend
decl_stmt|;
if|if
condition|(
name|info
operator|->
name|relocatable
condition|)
return|return
name|TRUE
return|;
name|symtab_hdr
operator|=
operator|&
name|elf_tdata
argument_list|(
name|input_bfd
argument_list|)
operator|->
name|symtab_hdr
expr_stmt|;
name|sym_hashes
operator|=
name|elf_sym_hashes
argument_list|(
name|input_bfd
argument_list|)
expr_stmt|;
name|relend
operator|=
name|relocs
operator|+
name|input_section
operator|->
name|reloc_count
expr_stmt|;
for|for
control|(
name|rel
operator|=
name|relocs
init|;
name|rel
operator|<
name|relend
condition|;
name|rel
operator|++
control|)
block|{
name|reloc_howto_type
modifier|*
name|howto
decl_stmt|;
name|unsigned
name|long
name|r_symndx
decl_stmt|;
name|Elf_Internal_Sym
modifier|*
name|sym
decl_stmt|;
name|asection
modifier|*
name|sec
decl_stmt|;
name|struct
name|elf_link_hash_entry
modifier|*
name|h
decl_stmt|;
name|bfd_vma
name|relocation
decl_stmt|;
name|bfd_reloc_status_type
name|r
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|int
name|r_type
decl_stmt|;
comment|/* This is a final link.  */
name|r_type
operator|=
name|ELF32_R_TYPE
argument_list|(
name|rel
operator|->
name|r_info
argument_list|)
expr_stmt|;
name|r_symndx
operator|=
name|ELF32_R_SYM
argument_list|(
name|rel
operator|->
name|r_info
argument_list|)
expr_stmt|;
name|howto
operator|=
name|elf_avr_howto_table
operator|+
name|ELF32_R_TYPE
argument_list|(
name|rel
operator|->
name|r_info
argument_list|)
expr_stmt|;
name|h
operator|=
name|NULL
expr_stmt|;
name|sym
operator|=
name|NULL
expr_stmt|;
name|sec
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|r_symndx
operator|<
name|symtab_hdr
operator|->
name|sh_info
condition|)
block|{
name|sym
operator|=
name|local_syms
operator|+
name|r_symndx
expr_stmt|;
name|sec
operator|=
name|local_sections
index|[
name|r_symndx
index|]
expr_stmt|;
name|relocation
operator|=
name|_bfd_elf_rela_local_sym
argument_list|(
name|output_bfd
argument_list|,
name|sym
argument_list|,
operator|&
name|sec
argument_list|,
name|rel
argument_list|)
expr_stmt|;
name|name
operator|=
name|bfd_elf_string_from_elf_section
argument_list|(
name|input_bfd
argument_list|,
name|symtab_hdr
operator|->
name|sh_link
argument_list|,
name|sym
operator|->
name|st_name
argument_list|)
expr_stmt|;
name|name
operator|=
operator|(
name|name
operator|==
name|NULL
operator|)
condition|?
name|bfd_section_name
argument_list|(
name|input_bfd
argument_list|,
name|sec
argument_list|)
else|:
name|name
expr_stmt|;
block|}
else|else
block|{
name|bfd_boolean
name|unresolved_reloc
decl_stmt|,
name|warned
decl_stmt|;
name|RELOC_FOR_GLOBAL_SYMBOL
argument_list|(
name|info
argument_list|,
name|input_bfd
argument_list|,
name|input_section
argument_list|,
name|rel
argument_list|,
name|r_symndx
argument_list|,
name|symtab_hdr
argument_list|,
name|sym_hashes
argument_list|,
name|h
argument_list|,
name|sec
argument_list|,
name|relocation
argument_list|,
name|unresolved_reloc
argument_list|,
name|warned
argument_list|)
expr_stmt|;
block|}
name|r
operator|=
name|avr_final_link_relocate
argument_list|(
name|howto
argument_list|,
name|input_bfd
argument_list|,
name|input_section
argument_list|,
name|contents
argument_list|,
name|rel
argument_list|,
name|relocation
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|bfd_reloc_ok
condition|)
block|{
specifier|const
name|char
modifier|*
name|msg
init|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
decl_stmt|;
switch|switch
condition|(
name|r
condition|)
block|{
case|case
name|bfd_reloc_overflow
case|:
name|r
operator|=
name|info
operator|->
name|callbacks
operator|->
name|reloc_overflow
argument_list|(
name|info
argument_list|,
name|name
argument_list|,
name|howto
operator|->
name|name
argument_list|,
operator|(
name|bfd_vma
operator|)
literal|0
argument_list|,
name|input_bfd
argument_list|,
name|input_section
argument_list|,
name|rel
operator|->
name|r_offset
argument_list|)
expr_stmt|;
break|break;
case|case
name|bfd_reloc_undefined
case|:
name|r
operator|=
name|info
operator|->
name|callbacks
operator|->
name|undefined_symbol
argument_list|(
name|info
argument_list|,
name|name
argument_list|,
name|input_bfd
argument_list|,
name|input_section
argument_list|,
name|rel
operator|->
name|r_offset
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
break|break;
case|case
name|bfd_reloc_outofrange
case|:
name|msg
operator|=
name|_
argument_list|(
literal|"internal error: out of range error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|bfd_reloc_notsupported
case|:
name|msg
operator|=
name|_
argument_list|(
literal|"internal error: unsupported relocation error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|bfd_reloc_dangerous
case|:
name|msg
operator|=
name|_
argument_list|(
literal|"internal error: dangerous relocation"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|msg
operator|=
name|_
argument_list|(
literal|"internal error: unknown error"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|msg
condition|)
name|r
operator|=
name|info
operator|->
name|callbacks
operator|->
name|warning
argument_list|(
name|info
argument_list|,
name|msg
argument_list|,
name|name
argument_list|,
name|input_bfd
argument_list|,
name|input_section
argument_list|,
name|rel
operator|->
name|r_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
return|return
name|FALSE
return|;
block|}
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* The final processing done just before writing out a AVR ELF object    file.  This gets the AVR architecture right based on the machine    number.  */
end_comment

begin_function
specifier|static
name|void
name|bfd_elf_avr_final_write_processing
parameter_list|(
name|abfd
parameter_list|,
name|linker
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
name|bfd_boolean
name|linker
name|ATTRIBUTE_UNUSED
decl_stmt|;
block|{
name|unsigned
name|long
name|val
decl_stmt|;
switch|switch
condition|(
name|bfd_get_mach
argument_list|(
name|abfd
argument_list|)
condition|)
block|{
default|default:
case|case
name|bfd_mach_avr2
case|:
name|val
operator|=
name|E_AVR_MACH_AVR2
expr_stmt|;
break|break;
case|case
name|bfd_mach_avr1
case|:
name|val
operator|=
name|E_AVR_MACH_AVR1
expr_stmt|;
break|break;
case|case
name|bfd_mach_avr3
case|:
name|val
operator|=
name|E_AVR_MACH_AVR3
expr_stmt|;
break|break;
case|case
name|bfd_mach_avr4
case|:
name|val
operator|=
name|E_AVR_MACH_AVR4
expr_stmt|;
break|break;
case|case
name|bfd_mach_avr5
case|:
name|val
operator|=
name|E_AVR_MACH_AVR5
expr_stmt|;
break|break;
block|}
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_machine
operator|=
name|EM_AVR
expr_stmt|;
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_flags
operator|&=
operator|~
name|EF_AVR_MACH
expr_stmt|;
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_flags
operator||=
name|val
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Set the right machine number.  */
end_comment

begin_function
specifier|static
name|bfd_boolean
name|elf32_avr_object_p
parameter_list|(
name|abfd
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
block|{
name|unsigned
name|int
name|e_set
init|=
name|bfd_mach_avr2
decl_stmt|;
if|if
condition|(
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_machine
operator|==
name|EM_AVR
operator|||
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_machine
operator|==
name|EM_AVR_OLD
condition|)
block|{
name|int
name|e_mach
init|=
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_flags
operator|&
name|EF_AVR_MACH
decl_stmt|;
switch|switch
condition|(
name|e_mach
condition|)
block|{
default|default:
case|case
name|E_AVR_MACH_AVR2
case|:
name|e_set
operator|=
name|bfd_mach_avr2
expr_stmt|;
break|break;
case|case
name|E_AVR_MACH_AVR1
case|:
name|e_set
operator|=
name|bfd_mach_avr1
expr_stmt|;
break|break;
case|case
name|E_AVR_MACH_AVR3
case|:
name|e_set
operator|=
name|bfd_mach_avr3
expr_stmt|;
break|break;
case|case
name|E_AVR_MACH_AVR4
case|:
name|e_set
operator|=
name|bfd_mach_avr4
expr_stmt|;
break|break;
case|case
name|E_AVR_MACH_AVR5
case|:
name|e_set
operator|=
name|bfd_mach_avr5
expr_stmt|;
break|break;
block|}
block|}
return|return
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_avr
argument_list|,
name|e_set
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ELF_ARCH
value|bfd_arch_avr
end_define

begin_define
define|#
directive|define
name|ELF_MACHINE_CODE
value|EM_AVR
end_define

begin_define
define|#
directive|define
name|ELF_MACHINE_ALT1
value|EM_AVR_OLD
end_define

begin_define
define|#
directive|define
name|ELF_MAXPAGESIZE
value|1
end_define

begin_define
define|#
directive|define
name|TARGET_LITTLE_SYM
value|bfd_elf32_avr_vec
end_define

begin_define
define|#
directive|define
name|TARGET_LITTLE_NAME
value|"elf32-avr"
end_define

begin_define
define|#
directive|define
name|elf_info_to_howto
value|avr_info_to_howto_rela
end_define

begin_define
define|#
directive|define
name|elf_info_to_howto_rel
value|NULL
end_define

begin_define
define|#
directive|define
name|elf_backend_relocate_section
value|elf32_avr_relocate_section
end_define

begin_define
define|#
directive|define
name|elf_backend_gc_mark_hook
value|elf32_avr_gc_mark_hook
end_define

begin_define
define|#
directive|define
name|elf_backend_gc_sweep_hook
value|elf32_avr_gc_sweep_hook
end_define

begin_define
define|#
directive|define
name|elf_backend_check_relocs
value|elf32_avr_check_relocs
end_define

begin_define
define|#
directive|define
name|elf_backend_can_gc_sections
value|1
end_define

begin_define
define|#
directive|define
name|elf_backend_rela_normal
value|1
end_define

begin_define
define|#
directive|define
name|elf_backend_final_write_processing
define|\
value|bfd_elf_avr_final_write_processing
end_define

begin_define
define|#
directive|define
name|elf_backend_object_p
value|elf32_avr_object_p
end_define

begin_include
include|#
directive|include
file|"elf32-target.h"
end_include

end_unit


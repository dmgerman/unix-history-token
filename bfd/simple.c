begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* simple.c -- BFD simple client routines    Copyright 2002, 2003, 2004, 2005, 2007    Free Software Foundation, Inc.    Contributed by MontaVista Software, Inc.     This file is part of BFD, the Binary File Descriptor library.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"bfdlink.h"
end_include

begin_function
specifier|static
name|bfd_boolean
name|simple_dummy_warning
parameter_list|(
name|struct
name|bfd_link_info
modifier|*
name|link_info
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|char
modifier|*
name|warning
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|char
modifier|*
name|symbol
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|section
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_vma
name|address
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|bfd_boolean
name|simple_dummy_undefined_symbol
parameter_list|(
name|struct
name|bfd_link_info
modifier|*
name|link_info
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|char
modifier|*
name|name
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|section
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_vma
name|address
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_boolean
name|fatal
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|bfd_boolean
name|simple_dummy_reloc_overflow
parameter_list|(
name|struct
name|bfd_link_info
modifier|*
name|link_info
name|ATTRIBUTE_UNUSED
parameter_list|,
name|struct
name|bfd_link_hash_entry
modifier|*
name|entry
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|char
modifier|*
name|name
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|char
modifier|*
name|reloc_name
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_vma
name|addend
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|section
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_vma
name|address
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|bfd_boolean
name|simple_dummy_reloc_dangerous
parameter_list|(
name|struct
name|bfd_link_info
modifier|*
name|link_info
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|char
modifier|*
name|message
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|section
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_vma
name|address
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|bfd_boolean
name|simple_dummy_unattached_reloc
parameter_list|(
name|struct
name|bfd_link_info
modifier|*
name|link_info
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|char
modifier|*
name|name
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|section
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_vma
name|address
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|bfd_boolean
name|simple_dummy_multiple_definition
parameter_list|(
name|struct
name|bfd_link_info
modifier|*
name|link_info
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|char
modifier|*
name|name
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd
modifier|*
name|obfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|osec
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_vma
name|oval
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd
modifier|*
name|nbfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|nsec
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_vma
name|nval
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|simple_dummy_einfo
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
name|ATTRIBUTE_UNUSED
parameter_list|,
modifier|...
parameter_list|)
block|{ }
end_function

begin_struct
struct|struct
name|saved_output_info
block|{
name|bfd_vma
name|offset
decl_stmt|;
name|asection
modifier|*
name|section
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|simple_save_output_info
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|section
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|struct
name|saved_output_info
modifier|*
name|output_info
init|=
name|ptr
decl_stmt|;
name|output_info
index|[
name|section
operator|->
name|index
index|]
operator|.
name|offset
operator|=
name|section
operator|->
name|output_offset
expr_stmt|;
name|output_info
index|[
name|section
operator|->
name|index
index|]
operator|.
name|section
operator|=
name|section
operator|->
name|output_section
expr_stmt|;
if|if
condition|(
operator|(
name|section
operator|->
name|flags
operator|&
name|SEC_DEBUGGING
operator|)
operator|!=
literal|0
operator|||
name|section
operator|->
name|output_section
operator|==
name|NULL
condition|)
block|{
name|section
operator|->
name|output_offset
operator|=
literal|0
expr_stmt|;
name|section
operator|->
name|output_section
operator|=
name|section
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|simple_restore_output_info
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|section
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|struct
name|saved_output_info
modifier|*
name|output_info
init|=
name|ptr
decl_stmt|;
name|section
operator|->
name|output_offset
operator|=
name|output_info
index|[
name|section
operator|->
name|index
index|]
operator|.
name|offset
expr_stmt|;
name|section
operator|->
name|output_section
operator|=
name|output_info
index|[
name|section
operator|->
name|index
index|]
operator|.
name|section
expr_stmt|;
block|}
end_function

begin_comment
comment|/* FUNCTION 	bfd_simple_relocate_secton  SYNOPSIS 	bfd_byte *bfd_simple_get_relocated_section_contents 	  (bfd *abfd, asection *sec, bfd_byte *outbuf, asymbol **symbol_table);  DESCRIPTION 	Returns the relocated contents of section @var{sec}.  The symbols in 	@var{symbol_table} will be used, or the symbols from @var{abfd} if 	@var{symbol_table} is NULL.  The output offsets for debug sections will 	be temporarily reset to 0.  The result will be stored at @var{outbuf} 	or allocated with @code{bfd_malloc} if @var{outbuf} is @code{NULL}.  	Returns @code{NULL} on a fatal error; ignores errors applying 	particular relocations. */
end_comment

begin_function
name|bfd_byte
modifier|*
name|bfd_simple_get_relocated_section_contents
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|asection
modifier|*
name|sec
parameter_list|,
name|bfd_byte
modifier|*
name|outbuf
parameter_list|,
name|asymbol
modifier|*
modifier|*
name|symbol_table
parameter_list|)
block|{
name|struct
name|bfd_link_info
name|link_info
decl_stmt|;
name|struct
name|bfd_link_order
name|link_order
decl_stmt|;
name|struct
name|bfd_link_callbacks
name|callbacks
decl_stmt|;
name|bfd_byte
modifier|*
name|contents
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|int
name|storage_needed
decl_stmt|;
name|void
modifier|*
name|saved_offsets
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|sec
operator|->
name|flags
operator|&
name|SEC_RELOC
operator|)
condition|)
block|{
name|bfd_size_type
name|amt
init|=
name|sec
operator|->
name|rawsize
operator|>
name|sec
operator|->
name|size
condition|?
name|sec
operator|->
name|rawsize
else|:
name|sec
operator|->
name|size
decl_stmt|;
name|bfd_size_type
name|size
init|=
name|sec
operator|->
name|rawsize
condition|?
name|sec
operator|->
name|rawsize
else|:
name|sec
operator|->
name|size
decl_stmt|;
if|if
condition|(
name|outbuf
operator|==
name|NULL
condition|)
name|contents
operator|=
name|bfd_malloc
argument_list|(
name|amt
argument_list|)
expr_stmt|;
else|else
name|contents
operator|=
name|outbuf
expr_stmt|;
if|if
condition|(
name|contents
condition|)
name|bfd_get_section_contents
argument_list|(
name|abfd
argument_list|,
name|sec
argument_list|,
name|contents
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
name|contents
return|;
block|}
comment|/* In order to use bfd_get_relocated_section_contents, we need      to forge some data structures that it expects.  */
comment|/* Fill in the bare minimum number of fields for our purposes.  */
name|memset
argument_list|(
operator|&
name|link_info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|link_info
argument_list|)
argument_list|)
expr_stmt|;
name|link_info
operator|.
name|input_bfds
operator|=
name|abfd
expr_stmt|;
name|link_info
operator|.
name|input_bfds_tail
operator|=
operator|&
name|abfd
operator|->
name|link_next
expr_stmt|;
name|link_info
operator|.
name|hash
operator|=
name|_bfd_generic_link_hash_table_create
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
name|link_info
operator|.
name|callbacks
operator|=
operator|&
name|callbacks
expr_stmt|;
name|callbacks
operator|.
name|warning
operator|=
name|simple_dummy_warning
expr_stmt|;
name|callbacks
operator|.
name|undefined_symbol
operator|=
name|simple_dummy_undefined_symbol
expr_stmt|;
name|callbacks
operator|.
name|reloc_overflow
operator|=
name|simple_dummy_reloc_overflow
expr_stmt|;
name|callbacks
operator|.
name|reloc_dangerous
operator|=
name|simple_dummy_reloc_dangerous
expr_stmt|;
name|callbacks
operator|.
name|unattached_reloc
operator|=
name|simple_dummy_unattached_reloc
expr_stmt|;
name|callbacks
operator|.
name|multiple_definition
operator|=
name|simple_dummy_multiple_definition
expr_stmt|;
name|callbacks
operator|.
name|einfo
operator|=
name|simple_dummy_einfo
expr_stmt|;
name|memset
argument_list|(
operator|&
name|link_order
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|link_order
argument_list|)
argument_list|)
expr_stmt|;
name|link_order
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|link_order
operator|.
name|type
operator|=
name|bfd_indirect_link_order
expr_stmt|;
name|link_order
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|link_order
operator|.
name|size
operator|=
name|sec
operator|->
name|size
expr_stmt|;
name|link_order
operator|.
name|u
operator|.
name|indirect
operator|.
name|section
operator|=
name|sec
expr_stmt|;
name|data
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|outbuf
operator|==
name|NULL
condition|)
block|{
name|data
operator|=
name|bfd_malloc
argument_list|(
name|sec
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|outbuf
operator|=
name|data
expr_stmt|;
block|}
comment|/* The sections in ABFD may already have output sections and offsets set.      Because this function is primarily for debug sections, and GCC uses the      knowledge that debug sections will generally have VMA 0 when emitting      relocations between DWARF-2 sections (which are supposed to be      section-relative offsets anyway), we need to reset the output offsets      to zero.  We also need to arrange for section->output_section->vma plus      section->output_offset to equal section->vma, which we do by setting      section->output_section to point back to section.  Save the original      output offset and output section to restore later.  */
name|saved_offsets
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|saved_output_info
argument_list|)
operator|*
name|abfd
operator|->
name|section_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|saved_offsets
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|data
condition|)
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bfd_map_over_sections
argument_list|(
name|abfd
argument_list|,
name|simple_save_output_info
argument_list|,
name|saved_offsets
argument_list|)
expr_stmt|;
if|if
condition|(
name|symbol_table
operator|==
name|NULL
condition|)
block|{
name|_bfd_generic_link_add_symbols
argument_list|(
name|abfd
argument_list|,
operator|&
name|link_info
argument_list|)
expr_stmt|;
name|storage_needed
operator|=
name|bfd_get_symtab_upper_bound
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
name|symbol_table
operator|=
name|bfd_malloc
argument_list|(
name|storage_needed
argument_list|)
expr_stmt|;
name|bfd_canonicalize_symtab
argument_list|(
name|abfd
argument_list|,
name|symbol_table
argument_list|)
expr_stmt|;
block|}
else|else
name|storage_needed
operator|=
literal|0
expr_stmt|;
name|contents
operator|=
name|bfd_get_relocated_section_contents
argument_list|(
name|abfd
argument_list|,
operator|&
name|link_info
argument_list|,
operator|&
name|link_order
argument_list|,
name|outbuf
argument_list|,
literal|0
argument_list|,
name|symbol_table
argument_list|)
expr_stmt|;
if|if
condition|(
name|contents
operator|==
name|NULL
operator|&&
name|data
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|bfd_map_over_sections
argument_list|(
name|abfd
argument_list|,
name|simple_restore_output_info
argument_list|,
name|saved_offsets
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|saved_offsets
argument_list|)
expr_stmt|;
name|_bfd_generic_link_hash_table_free
argument_list|(
name|link_info
operator|.
name|hash
argument_list|)
expr_stmt|;
return|return
name|contents
return|;
block|}
end_function

end_unit


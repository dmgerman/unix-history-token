begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* vms-hdr.c -- BFD back-end for VMS/VAX (openVMS/VAX) and    EVAX (openVMS/Alpha) files.    Copyright 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2005, 2006,    2007 Free Software Foundation, Inc.     HDR record handling functions    EMH record handling functions    and    EOM record handling functions    EEOM record handling functions     Written by Klaus K"ampf (kkaempf@rmi.de)     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"bfdver.h"
end_include

begin_include
include|#
directive|include
file|"bfdlink.h"
end_include

begin_include
include|#
directive|include
file|"safe-ctype.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"vms.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_ALLOCA_H
end_ifdef

begin_include
include|#
directive|include
file|<alloca.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Read& process emh record    return 0 on success, -1 on error.  */
end_comment

begin_function
name|int
name|_bfd_vms_slurp_hdr
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|int
name|objtype
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|unsigned
name|char
modifier|*
name|vms_rec
decl_stmt|;
name|int
name|subtype
decl_stmt|;
name|vms_rec
operator|=
name|PRIV
argument_list|(
name|vms_rec
argument_list|)
expr_stmt|;
if|#
directive|if
name|VMS_DEBUG
name|vms_debug
argument_list|(
literal|2
argument_list|,
literal|"HDR/EMH\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|objtype
condition|)
block|{
case|case
name|OBJ_S_C_HDR
case|:
name|subtype
operator|=
name|vms_rec
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|EOBJ_S_C_EMH
case|:
name|subtype
operator|=
name|bfd_getl16
argument_list|(
name|vms_rec
operator|+
literal|4
argument_list|)
operator|+
name|EVAX_OFFSET
expr_stmt|;
break|break;
default|default:
name|subtype
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|#
directive|if
name|VMS_DEBUG
name|vms_debug
argument_list|(
literal|3
argument_list|,
literal|"subtype %d\n"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|subtype
condition|)
block|{
case|case
name|MHD_S_C_MHD
case|:
comment|/* Module header.  */
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_b_strlvl
operator|=
name|vms_rec
index|[
literal|2
index|]
expr_stmt|;
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_l_recsiz
operator|=
name|bfd_getl16
argument_list|(
name|vms_rec
operator|+
literal|3
argument_list|)
expr_stmt|;
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_t_name
operator|=
name|_bfd_vms_save_counted_string
argument_list|(
name|vms_rec
operator|+
literal|5
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|vms_rec
operator|+
literal|5
operator|+
name|vms_rec
index|[
literal|5
index|]
operator|+
literal|1
expr_stmt|;
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_t_version
operator|=
name|_bfd_vms_save_counted_string
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|+=
operator|*
name|ptr
operator|+
literal|1
expr_stmt|;
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_t_date
operator|=
name|_bfd_vms_save_sized_string
argument_list|(
name|ptr
argument_list|,
literal|17
argument_list|)
expr_stmt|;
break|break;
case|case
name|MHD_S_C_LNM
case|:
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_c_lnm
operator|=
name|_bfd_vms_save_sized_string
argument_list|(
name|vms_rec
argument_list|,
name|PRIV
argument_list|(
name|rec_length
operator|-
literal|2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MHD_S_C_SRC
case|:
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_c_src
operator|=
name|_bfd_vms_save_sized_string
argument_list|(
name|vms_rec
argument_list|,
name|PRIV
argument_list|(
name|rec_length
operator|-
literal|2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MHD_S_C_TTL
case|:
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_c_ttl
operator|=
name|_bfd_vms_save_sized_string
argument_list|(
name|vms_rec
argument_list|,
name|PRIV
argument_list|(
name|rec_length
operator|-
literal|2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|EMH_S_C_MHD
operator|+
name|EVAX_OFFSET
case|:
comment|/* Module header.  */
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_b_strlvl
operator|=
name|vms_rec
index|[
literal|6
index|]
expr_stmt|;
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_l_arch1
operator|=
name|bfd_getl32
argument_list|(
name|vms_rec
operator|+
literal|8
argument_list|)
expr_stmt|;
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_l_arch2
operator|=
name|bfd_getl32
argument_list|(
name|vms_rec
operator|+
literal|12
argument_list|)
expr_stmt|;
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_l_recsiz
operator|=
name|bfd_getl32
argument_list|(
name|vms_rec
operator|+
literal|16
argument_list|)
expr_stmt|;
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_t_name
operator|=
name|_bfd_vms_save_counted_string
argument_list|(
name|vms_rec
operator|+
literal|20
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|vms_rec
operator|+
literal|20
operator|+
name|vms_rec
index|[
literal|20
index|]
operator|+
literal|1
expr_stmt|;
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_t_version
operator|=
name|_bfd_vms_save_counted_string
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|+=
operator|*
name|ptr
operator|+
literal|1
expr_stmt|;
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_t_date
operator|=
name|_bfd_vms_save_sized_string
argument_list|(
name|ptr
argument_list|,
literal|17
argument_list|)
expr_stmt|;
break|break;
case|case
name|EMH_S_C_LNM
operator|+
name|EVAX_OFFSET
case|:
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_c_lnm
operator|=
name|_bfd_vms_save_sized_string
argument_list|(
name|vms_rec
argument_list|,
name|PRIV
argument_list|(
name|rec_length
operator|-
literal|6
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|EMH_S_C_SRC
operator|+
name|EVAX_OFFSET
case|:
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_c_src
operator|=
name|_bfd_vms_save_sized_string
argument_list|(
name|vms_rec
argument_list|,
name|PRIV
argument_list|(
name|rec_length
operator|-
literal|6
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|EMH_S_C_TTL
operator|+
name|EVAX_OFFSET
case|:
name|PRIV
argument_list|(
name|hdr_data
argument_list|)
operator|.
name|hdr_c_ttl
operator|=
name|_bfd_vms_save_sized_string
argument_list|(
name|vms_rec
argument_list|,
name|PRIV
argument_list|(
name|rec_length
operator|-
literal|6
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MHD_S_C_CPR
case|:
case|case
name|MHD_S_C_MTC
case|:
case|case
name|MHD_S_C_GTX
case|:
case|case
name|EMH_S_C_CPR
operator|+
name|EVAX_OFFSET
case|:
case|case
name|EMH_S_C_MTC
operator|+
name|EVAX_OFFSET
case|:
case|case
name|EMH_S_C_GTX
operator|+
name|EVAX_OFFSET
case|:
break|break;
default|default:
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Output routines.  */
end_comment

begin_comment
comment|/* Manufacture a VMS like time on a unix based system.    stolen from obj-vms.c.  */
end_comment

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|get_vms_time_string
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|unsigned
name|char
name|tbuf
index|[
literal|18
index|]
decl_stmt|;
ifndef|#
directive|ifndef
name|VMS
include|#
directive|include
file|<time.h>
name|char
modifier|*
name|pnt
decl_stmt|;
name|time_t
name|timeb
decl_stmt|;
name|time
argument_list|(
operator|&
name|timeb
argument_list|)
expr_stmt|;
name|pnt
operator|=
name|ctime
argument_list|(
operator|&
name|timeb
argument_list|)
expr_stmt|;
name|pnt
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|pnt
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|pnt
index|[
literal|10
index|]
operator|=
literal|0
expr_stmt|;
name|pnt
index|[
literal|16
index|]
operator|=
literal|0
expr_stmt|;
name|pnt
index|[
literal|24
index|]
operator|=
literal|0
expr_stmt|;
name|sprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tbuf
argument_list|,
literal|"%2s-%3s-%s %s"
argument_list|,
name|pnt
operator|+
literal|8
argument_list|,
name|pnt
operator|+
literal|4
argument_list|,
name|pnt
operator|+
literal|20
argument_list|,
name|pnt
operator|+
literal|11
argument_list|)
expr_stmt|;
else|#
directive|else
include|#
directive|include
file|<starlet.h>
struct|struct
block|{
name|int
name|Size
decl_stmt|;
name|unsigned
name|char
modifier|*
name|Ptr
decl_stmt|;
block|}
name|Descriptor
struct|;
name|Descriptor
operator|.
name|Size
operator|=
literal|17
expr_stmt|;
name|Descriptor
operator|.
name|Ptr
operator|=
name|tbuf
expr_stmt|;
name|SYS$ASCTIM
argument_list|(
literal|0
argument_list|,
operator|&
name|Descriptor
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* not VMS */
if|#
directive|if
name|VMS_DEBUG
name|vms_debug
argument_list|(
literal|6
argument_list|,
literal|"vmstimestring:'%s'\n"
argument_list|,
name|tbuf
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|tbuf
return|;
block|}
end_function

begin_comment
comment|/* Write object header for bfd abfd.  */
end_comment

begin_function
name|int
name|_bfd_vms_write_hdr
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|int
name|objtype
parameter_list|)
block|{
name|asymbol
modifier|*
name|symbol
decl_stmt|;
name|unsigned
name|int
name|symnum
decl_stmt|;
name|int
name|had_case
init|=
literal|0
decl_stmt|;
name|int
name|had_file
init|=
literal|0
decl_stmt|;
if|#
directive|if
name|VMS_DEBUG
name|vms_debug
argument_list|(
literal|2
argument_list|,
literal|"vms_write_hdr (%p)\n"
argument_list|,
name|abfd
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|_bfd_vms_output_alignment
argument_list|(
name|abfd
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* MHD.  */
if|if
condition|(
name|objtype
operator|!=
name|OBJ_S_C_HDR
condition|)
block|{
name|_bfd_vms_output_begin
argument_list|(
name|abfd
argument_list|,
name|EOBJ_S_C_EMH
argument_list|,
name|EMH_S_C_MHD
argument_list|)
expr_stmt|;
name|_bfd_vms_output_short
argument_list|(
name|abfd
argument_list|,
name|EOBJ_S_C_STRLVL
argument_list|)
expr_stmt|;
name|_bfd_vms_output_long
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_bfd_vms_output_long
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_bfd_vms_output_long
argument_list|(
name|abfd
argument_list|,
name|MAX_OUTREC_SIZE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bfd_get_filename
argument_list|(
name|abfd
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* Strip path and suffix information.  */
name|char
modifier|*
name|fname
decl_stmt|,
modifier|*
name|fout
decl_stmt|,
modifier|*
name|fptr
decl_stmt|;
name|fptr
operator|=
name|bfd_get_filename
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
name|fname
operator|=
name|alloca
argument_list|(
name|strlen
argument_list|(
name|fptr
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|fname
argument_list|,
name|fptr
argument_list|)
expr_stmt|;
name|fout
operator|=
name|strrchr
argument_list|(
name|fname
argument_list|,
literal|']'
argument_list|)
expr_stmt|;
if|if
condition|(
name|fout
operator|==
literal|0
condition|)
name|fout
operator|=
name|strchr
argument_list|(
name|fname
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|fout
operator|!=
literal|0
condition|)
name|fout
operator|++
expr_stmt|;
else|else
name|fout
operator|=
name|fname
expr_stmt|;
comment|/* Strip .obj suffix.  */
name|fptr
operator|=
name|strrchr
argument_list|(
name|fname
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fptr
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|strcasecmp
argument_list|(
name|fptr
argument_list|,
literal|".OBJ"
argument_list|)
operator|==
literal|0
operator|)
condition|)
operator|*
name|fptr
operator|=
literal|0
expr_stmt|;
name|fptr
operator|=
name|fout
expr_stmt|;
while|while
condition|(
operator|*
name|fptr
operator|!=
literal|0
condition|)
block|{
operator|*
name|fptr
operator|=
name|TOUPPER
argument_list|(
operator|*
name|fptr
argument_list|)
expr_stmt|;
name|fptr
operator|++
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|fptr
operator|==
literal|';'
operator|)
operator|||
operator|(
operator|(
name|fptr
operator|-
name|fout
operator|)
operator|>
literal|31
operator|)
condition|)
operator|*
name|fptr
operator|=
literal|0
expr_stmt|;
block|}
name|_bfd_vms_output_counted
argument_list|(
name|abfd
argument_list|,
name|fout
argument_list|)
expr_stmt|;
block|}
else|else
name|_bfd_vms_output_counted
argument_list|(
name|abfd
argument_list|,
literal|"NONAME"
argument_list|)
expr_stmt|;
name|_bfd_vms_output_counted
argument_list|(
name|abfd
argument_list|,
name|BFD_VERSION_STRING
argument_list|)
expr_stmt|;
name|_bfd_vms_output_dump
argument_list|(
name|abfd
argument_list|,
name|get_vms_time_string
argument_list|()
argument_list|,
literal|17
argument_list|)
expr_stmt|;
name|_bfd_vms_output_fill
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|)
expr_stmt|;
name|_bfd_vms_output_flush
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
comment|/* LMN.  */
name|_bfd_vms_output_begin
argument_list|(
name|abfd
argument_list|,
name|EOBJ_S_C_EMH
argument_list|,
name|EMH_S_C_LNM
argument_list|)
expr_stmt|;
name|_bfd_vms_output_dump
argument_list|(
name|abfd
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|STRING_COMMA_LEN
argument_list|(
literal|"GAS proGIS"
argument_list|)
argument_list|)
expr_stmt|;
name|_bfd_vms_output_flush
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
comment|/* SRC.  */
name|_bfd_vms_output_begin
argument_list|(
name|abfd
argument_list|,
name|EOBJ_S_C_EMH
argument_list|,
name|EMH_S_C_SRC
argument_list|)
expr_stmt|;
for|for
control|(
name|symnum
operator|=
literal|0
init|;
name|symnum
operator|<
name|abfd
operator|->
name|symcount
condition|;
name|symnum
operator|++
control|)
block|{
name|symbol
operator|=
name|abfd
operator|->
name|outsymbols
index|[
name|symnum
index|]
expr_stmt|;
if|if
condition|(
name|symbol
operator|->
name|flags
operator|&
name|BSF_FILE
condition|)
block|{
if|if
condition|(
name|CONST_STRNEQ
argument_list|(
operator|(
name|char
operator|*
operator|)
name|symbol
operator|->
name|name
argument_list|,
literal|"<CASE:"
argument_list|)
condition|)
block|{
name|PRIV
argument_list|(
name|flag_hash_long_names
argument_list|)
operator|=
name|symbol
operator|->
name|name
index|[
literal|6
index|]
operator|-
literal|'0'
expr_stmt|;
name|PRIV
argument_list|(
name|flag_show_after_trunc
argument_list|)
operator|=
name|symbol
operator|->
name|name
index|[
literal|7
index|]
operator|-
literal|'0'
expr_stmt|;
if|if
condition|(
name|had_file
condition|)
break|break;
name|had_case
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|_bfd_vms_output_dump
argument_list|(
name|abfd
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|symbol
operator|->
name|name
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|symbol
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|had_case
condition|)
break|break;
name|had_file
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|symnum
operator|==
name|abfd
operator|->
name|symcount
condition|)
name|_bfd_vms_output_dump
argument_list|(
name|abfd
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|STRING_COMMA_LEN
argument_list|(
literal|"noname"
argument_list|)
argument_list|)
expr_stmt|;
name|_bfd_vms_output_flush
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
comment|/* TTL.  */
name|_bfd_vms_output_begin
argument_list|(
name|abfd
argument_list|,
name|EOBJ_S_C_EMH
argument_list|,
name|EMH_S_C_TTL
argument_list|)
expr_stmt|;
name|_bfd_vms_output_dump
argument_list|(
name|abfd
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|STRING_COMMA_LEN
argument_list|(
literal|"TTL"
argument_list|)
argument_list|)
expr_stmt|;
name|_bfd_vms_output_flush
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
comment|/* CPR.  */
name|_bfd_vms_output_begin
argument_list|(
name|abfd
argument_list|,
name|EOBJ_S_C_EMH
argument_list|,
name|EMH_S_C_CPR
argument_list|)
expr_stmt|;
name|_bfd_vms_output_dump
argument_list|(
name|abfd
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"GNU BFD ported by Klaus Kämpf 1994-1996"
argument_list|,
literal|39
argument_list|)
expr_stmt|;
name|_bfd_vms_output_flush
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Process EOM/EEOM record    return 0 on success, -1 on error.  */
end_comment

begin_function
name|int
name|_bfd_vms_slurp_eom
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|int
name|objtype
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|vms_rec
decl_stmt|;
if|#
directive|if
name|VMS_DEBUG
name|vms_debug
argument_list|(
literal|2
argument_list|,
literal|"EOM/EEOM\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vms_rec
operator|=
name|PRIV
argument_list|(
name|vms_rec
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|objtype
operator|==
name|OBJ_S_C_EOM
operator|)
operator|||
operator|(
name|objtype
operator|==
name|OBJ_S_C_EOMW
operator|)
condition|)
block|{     }
else|else
block|{
name|PRIV
argument_list|(
name|eom_data
argument_list|)
operator|.
name|eom_l_total_lps
operator|=
name|bfd_getl32
argument_list|(
name|vms_rec
operator|+
literal|4
argument_list|)
expr_stmt|;
name|PRIV
argument_list|(
name|eom_data
argument_list|)
operator|.
name|eom_b_comcod
operator|=
operator|*
operator|(
name|vms_rec
operator|+
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|PRIV
argument_list|(
name|eom_data
argument_list|)
operator|.
name|eom_b_comcod
operator|>
literal|1
condition|)
block|{
call|(
modifier|*
name|_bfd_error_handler
call|)
argument_list|(
name|_
argument_list|(
literal|"Object module NOT error-free !\n"
argument_list|)
argument_list|)
expr_stmt|;
name|bfd_set_error
argument_list|(
name|bfd_error_bad_value
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|PRIV
argument_list|(
name|eom_data
argument_list|)
operator|.
name|eom_has_transfer
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|PRIV
argument_list|(
name|rec_size
argument_list|)
operator|>
literal|10
condition|)
block|{
name|PRIV
argument_list|(
name|eom_data
argument_list|)
operator|.
name|eom_has_transfer
operator|=
name|TRUE
expr_stmt|;
name|PRIV
argument_list|(
name|eom_data
argument_list|)
operator|.
name|eom_b_tfrflg
operator|=
operator|*
operator|(
name|vms_rec
operator|+
literal|9
operator|)
expr_stmt|;
name|PRIV
argument_list|(
name|eom_data
argument_list|)
operator|.
name|eom_l_psindx
operator|=
name|bfd_getl32
argument_list|(
name|vms_rec
operator|+
literal|12
argument_list|)
expr_stmt|;
name|PRIV
argument_list|(
name|eom_data
argument_list|)
operator|.
name|eom_l_tfradr
operator|=
name|bfd_getl32
argument_list|(
name|vms_rec
operator|+
literal|16
argument_list|)
expr_stmt|;
name|abfd
operator|->
name|start_address
operator|=
name|PRIV
argument_list|(
name|eom_data
argument_list|)
operator|.
name|eom_l_tfradr
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Write eom record for bfd abfd.  */
end_comment

begin_function
name|int
name|_bfd_vms_write_eom
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|int
name|objtype
parameter_list|)
block|{
if|#
directive|if
name|VMS_DEBUG
name|vms_debug
argument_list|(
literal|2
argument_list|,
literal|"vms_write_eom (%p, %d)\n"
argument_list|,
name|abfd
argument_list|,
name|objtype
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|_bfd_vms_output_begin
argument_list|(
name|abfd
argument_list|,
name|objtype
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|_bfd_vms_output_long
argument_list|(
name|abfd
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|PRIV
argument_list|(
name|vms_linkage_index
argument_list|)
operator|>>
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|_bfd_vms_output_byte
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Completion code.  */
name|_bfd_vms_output_byte
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Fill byte.  */
if|if
condition|(
name|bfd_get_start_address
argument_list|(
name|abfd
argument_list|)
operator|!=
operator|(
name|bfd_vma
operator|)
operator|-
literal|1
condition|)
block|{
name|asection
modifier|*
name|section
decl_stmt|;
name|section
operator|=
name|bfd_get_section_by_name
argument_list|(
name|abfd
argument_list|,
literal|".link"
argument_list|)
expr_stmt|;
if|if
condition|(
name|section
operator|==
literal|0
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_nonrepresentable_section
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|_bfd_vms_output_short
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_bfd_vms_output_long
argument_list|(
name|abfd
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|section
operator|->
name|index
argument_list|)
argument_list|)
expr_stmt|;
name|_bfd_vms_output_long
argument_list|(
name|abfd
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|bfd_get_start_address
argument_list|(
name|abfd
argument_list|)
argument_list|)
expr_stmt|;
name|_bfd_vms_output_long
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|_bfd_vms_output_end
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


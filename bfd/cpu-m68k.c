begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* BFD library support routines for architectures.    Copyright 1990, 1991, 1992, 1993, 1994, 1997, 1998, 2000, 2001, 2002,    2003, 2004, 2006 Free Software Foundation, Inc.    Hacked by Steve Chamberlain of Cygnus Support.     This file is part of BFD, the Binary File Descriptor library.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"opcode/m68k.h"
end_include

begin_function_decl
specifier|static
specifier|const
name|bfd_arch_info_type
modifier|*
name|bfd_m68k_compatible
parameter_list|(
specifier|const
name|bfd_arch_info_type
modifier|*
name|a
parameter_list|,
specifier|const
name|bfd_arch_info_type
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|N
parameter_list|(
name|name
parameter_list|,
name|print
parameter_list|,
name|d
parameter_list|,
name|next
parameter_list|)
define|\
value|{  32, 32, 8, bfd_arch_m68k, name, "m68k",print,2,d,bfd_m68k_compatible,bfd_default_scan, next, }
end_define

begin_decl_stmt
specifier|static
specifier|const
name|bfd_arch_info_type
name|arch_info_struct
index|[]
init|=
block|{
name|N
argument_list|(
name|bfd_mach_m68000
argument_list|,
literal|"m68k:68000"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|1
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_m68008
argument_list|,
literal|"m68k:68008"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|2
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_m68010
argument_list|,
literal|"m68k:68010"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|3
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_m68020
argument_list|,
literal|"m68k:68020"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|4
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_m68030
argument_list|,
literal|"m68k:68030"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|5
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_m68040
argument_list|,
literal|"m68k:68040"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|6
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_m68060
argument_list|,
literal|"m68k:68060"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|7
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_cpu32
argument_list|,
literal|"m68k:cpu32"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|8
index|]
argument_list|)
block|,
comment|/* Various combinations of CF architecture features */
name|N
argument_list|(
name|bfd_mach_mcf_isa_a_nodiv
argument_list|,
literal|"m68k:isa-a:nodiv"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|9
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_a
argument_list|,
literal|"m68k:isa-a"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|10
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_a_mac
argument_list|,
literal|"m68k:isa-a:mac"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|11
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_a_emac
argument_list|,
literal|"m68k:isa-a:emac"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|12
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_aplus
argument_list|,
literal|"m68k:isa-aplus"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|13
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_aplus_mac
argument_list|,
literal|"m68k:isa-aplus:mac"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|14
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_aplus_emac
argument_list|,
literal|"m68k:isa-aplus:emac"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|15
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_nousp
argument_list|,
literal|"m68k:isa-b:nousp"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|16
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_nousp_mac
argument_list|,
literal|"m68k:isa-b:nousp:mac"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|17
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_nousp_emac
argument_list|,
literal|"m68k:isa-b:nousp:emac"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|18
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b
argument_list|,
literal|"m68k:isa-b"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|19
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_mac
argument_list|,
literal|"m68k:isa-b:mac"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|20
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_emac
argument_list|,
literal|"m68k:isa-b:emac"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|21
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_float
argument_list|,
literal|"m68k:isa-b:float"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|22
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_float_mac
argument_list|,
literal|"m68k:isa-b:float:mac"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|23
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_float_emac
argument_list|,
literal|"m68k:isa-b:float:emac"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|24
index|]
argument_list|)
block|,
comment|/* Legacy names for CF architectures */
name|N
argument_list|(
name|bfd_mach_mcf_isa_a_nodiv
argument_list|,
literal|"m68k:5200"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|25
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_a_mac
argument_list|,
literal|"m68k:5206e"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|26
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_a_mac
argument_list|,
literal|"m68k:5307"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|27
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_nousp_mac
argument_list|,
literal|"m68k:5407"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|28
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_aplus_emac
argument_list|,
literal|"m68k:528x"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|29
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_aplus_emac
argument_list|,
literal|"m68k:521x"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|30
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_a_emac
argument_list|,
literal|"m68k:5249"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|31
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_float_emac
argument_list|,
literal|"m68k:547x"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|32
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_float_emac
argument_list|,
literal|"m68k:548x"
argument_list|,
name|FALSE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|33
index|]
argument_list|)
block|,
name|N
argument_list|(
name|bfd_mach_mcf_isa_b_float_emac
argument_list|,
literal|"m68k:cfv4e"
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
block|,   }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|bfd_arch_info_type
name|bfd_m68k_arch
init|=
name|N
argument_list|(
literal|0
argument_list|,
literal|"m68k"
argument_list|,
name|TRUE
argument_list|,
operator|&
name|arch_info_struct
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Table indexed by bfd_mach_arch number indicating which    architectural features are supported.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|unsigned
name|m68k_arch_features
index|[]
init|=
block|{
literal|0
block|,
name|m68000
operator||
name|m68881
operator||
name|m68851
block|,
name|m68000
operator||
name|m68881
operator||
name|m68851
block|,
name|m68010
operator||
name|m68881
operator||
name|m68851
block|,
name|m68020
operator||
name|m68881
operator||
name|m68851
block|,
name|m68030
operator||
name|m68881
operator||
name|m68851
block|,
name|m68040
operator||
name|m68881
operator||
name|m68851
block|,
name|m68060
operator||
name|m68881
operator||
name|m68851
block|,
name|cpu32
operator||
name|m68881
block|,
name|mcfisa_a
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfmac
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfemac
block|,
name|mcfisa_a
operator||
name|mcfisa_aa
operator||
name|mcfhwdiv
operator||
name|mcfusp
block|,
name|mcfisa_a
operator||
name|mcfisa_aa
operator||
name|mcfhwdiv
operator||
name|mcfusp
operator||
name|mcfmac
block|,
name|mcfisa_a
operator||
name|mcfisa_aa
operator||
name|mcfhwdiv
operator||
name|mcfusp
operator||
name|mcfemac
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfisa_b
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfisa_b
operator||
name|mcfmac
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfisa_b
operator||
name|mcfemac
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfisa_b
operator||
name|mcfusp
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfisa_b
operator||
name|mcfusp
operator||
name|mcfmac
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfisa_b
operator||
name|mcfusp
operator||
name|mcfemac
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfisa_b
operator||
name|mcfusp
operator||
name|cfloat
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfisa_b
operator||
name|mcfusp
operator||
name|cfloat
operator||
name|mcfmac
block|,
name|mcfisa_a
operator||
name|mcfhwdiv
operator||
name|mcfisa_b
operator||
name|mcfusp
operator||
name|cfloat
operator||
name|mcfemac
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Return the count of bits set in MASK  */
end_comment

begin_function
specifier|static
name|unsigned
name|bit_count
parameter_list|(
name|unsigned
name|mask
parameter_list|)
block|{
name|unsigned
name|ix
decl_stmt|;
for|for
control|(
name|ix
operator|=
literal|0
init|;
name|mask
condition|;
name|ix
operator|++
control|)
comment|/* Clear the LSB set */
name|mask
operator|^=
name|mask
operator|&
operator|-
name|mask
expr_stmt|;
return|return
name|ix
return|;
block|}
end_function

begin_comment
comment|/* Return the architectural features supported by MACH */
end_comment

begin_function
name|unsigned
name|bfd_m68k_mach_to_features
parameter_list|(
name|int
name|mach
parameter_list|)
block|{
if|if
condition|(
operator|(
name|unsigned
operator|)
name|mach
operator|>=
sizeof|sizeof
argument_list|(
name|m68k_arch_features
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|m68k_arch_features
index|[
literal|0
index|]
argument_list|)
condition|)
name|mach
operator|=
literal|0
expr_stmt|;
return|return
name|m68k_arch_features
index|[
name|mach
index|]
return|;
block|}
end_function

begin_comment
comment|/* Return the bfd machine that most closely represents the    architectural features.  We find the machine with the smallest    number of additional features.  If there is no such machine, we    find the one with the smallest number of missing features.  */
end_comment

begin_function
name|int
name|bfd_m68k_features_to_mach
parameter_list|(
name|unsigned
name|features
parameter_list|)
block|{
name|int
name|superset
init|=
literal|0
decl_stmt|,
name|subset
init|=
literal|0
decl_stmt|;
name|unsigned
name|extra
init|=
literal|99
decl_stmt|,
name|missing
init|=
literal|99
decl_stmt|;
name|unsigned
name|ix
decl_stmt|;
for|for
control|(
name|ix
operator|=
literal|0
init|;
name|ix
operator|!=
sizeof|sizeof
argument_list|(
name|m68k_arch_features
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|m68k_arch_features
index|[
literal|0
index|]
argument_list|)
condition|;
name|ix
operator|++
control|)
block|{
name|unsigned
name|this_extra
decl_stmt|,
name|this_missing
decl_stmt|;
if|if
condition|(
name|m68k_arch_features
index|[
name|ix
index|]
operator|==
name|features
condition|)
return|return
name|ix
return|;
name|this_extra
operator|=
name|bit_count
argument_list|(
name|m68k_arch_features
index|[
name|ix
index|]
operator|&
operator|~
name|features
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_extra
operator|<
name|extra
condition|)
block|{
name|extra
operator|=
name|this_extra
expr_stmt|;
name|superset
operator|=
name|ix
expr_stmt|;
block|}
name|this_missing
operator|=
name|bit_count
argument_list|(
name|features
operator|&
operator|~
name|m68k_arch_features
index|[
name|ix
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_missing
operator|<
name|missing
condition|)
block|{
name|missing
operator|=
name|this_missing
expr_stmt|;
name|superset
operator|=
name|ix
expr_stmt|;
block|}
block|}
return|return
name|superset
condition|?
name|superset
else|:
name|subset
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|bfd_arch_info_type
modifier|*
name|bfd_m68k_compatible
parameter_list|(
specifier|const
name|bfd_arch_info_type
modifier|*
name|a
parameter_list|,
specifier|const
name|bfd_arch_info_type
modifier|*
name|b
parameter_list|)
block|{
if|if
condition|(
name|a
operator|->
name|arch
operator|!=
name|b
operator|->
name|arch
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|a
operator|->
name|bits_per_word
operator|!=
name|b
operator|->
name|bits_per_word
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|a
operator|->
name|mach
condition|)
return|return
name|b
return|;
if|if
condition|(
operator|!
name|b
operator|->
name|mach
condition|)
return|return
name|a
return|;
if|if
condition|(
name|a
operator|->
name|mach
operator|<=
name|bfd_mach_m68060
operator|&&
name|b
operator|->
name|mach
operator|<=
name|bfd_mach_m68060
condition|)
comment|/* Merge m68k machine. */
return|return
name|a
operator|->
name|mach
operator|>
name|b
operator|->
name|mach
condition|?
name|a
else|:
name|b
return|;
elseif|else
if|if
condition|(
name|a
operator|->
name|mach
operator|==
name|bfd_mach_cpu32
operator|&&
name|b
operator|->
name|mach
operator|==
name|bfd_mach_cpu32
condition|)
comment|/* CPU32 is compatible with itself. */
return|return
name|a
return|;
elseif|else
if|if
condition|(
name|a
operator|->
name|mach
operator|>=
name|bfd_mach_mcf_isa_a_nodiv
operator|&&
name|b
operator|->
name|mach
operator|>=
name|bfd_mach_mcf_isa_a_nodiv
condition|)
block|{
comment|/* Merge cf machine.  */
name|unsigned
name|features
init|=
operator|(
name|bfd_m68k_mach_to_features
argument_list|(
name|a
operator|->
name|mach
argument_list|)
operator||
name|bfd_m68k_mach_to_features
argument_list|(
name|b
operator|->
name|mach
argument_list|)
operator|)
decl_stmt|;
comment|/* ISA A+ and ISA B are incompatible.  */
if|if
condition|(
operator|(
operator|~
name|features
operator|&
operator|(
name|mcfisa_aa
operator||
name|mcfisa_b
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
comment|/* MAC and EMAC code cannot be merged.  */
if|if
condition|(
operator|(
operator|~
name|features
operator|&
operator|(
name|mcfmac
operator||
name|mcfemac
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
return|return
name|bfd_lookup_arch
argument_list|(
name|a
operator|->
name|arch
argument_list|,
name|bfd_m68k_features_to_mach
argument_list|(
name|features
argument_list|)
argument_list|)
return|;
block|}
else|else
comment|/* They are incompatible.  */
return|return
name|NULL
return|;
block|}
end_function

end_unit


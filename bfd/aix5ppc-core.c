begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* IBM RS/6000 "XCOFF" back-end for BFD.    Copyright 2001, 2002, 2003, 2004, 2005    Free Software Foundation, Inc.    Written by Tom Rix    Contributed by Red Hat Inc.     This file is part of BFD, the Binary File Descriptor library.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston,    MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_function_decl
specifier|const
name|bfd_target
modifier|*
name|xcoff64_core_p
parameter_list|(
name|bfd
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|bfd_boolean
name|xcoff64_core_file_matches_executable_p
parameter_list|(
name|bfd
modifier|*
parameter_list|,
name|bfd
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|xcoff64_core_file_failing_command
parameter_list|(
name|bfd
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|xcoff64_core_file_failing_signal
parameter_list|(
name|bfd
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|AIX_5_CORE
end_ifdef

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_comment
comment|/* Aix 5.1 system include file.  */
end_comment

begin_comment
comment|/* Need to define this macro so struct ld_info64 get included.  */
end_comment

begin_define
define|#
directive|define
name|__LDINFO_PTRACE64__
end_define

begin_include
include|#
directive|include
file|<sys/ldr.h>
end_include

begin_include
include|#
directive|include
file|<core.h>
end_include

begin_define
define|#
directive|define
name|core_hdr
parameter_list|(
name|abfd
parameter_list|)
value|((struct core_dumpxx *) abfd->tdata.any)
end_define

begin_define
define|#
directive|define
name|CHECK_FILE_OFFSET
parameter_list|(
name|s
parameter_list|,
name|v
parameter_list|)
define|\
value|((bfd_signed_vma)(v)< 0 || (bfd_signed_vma)(v)> (bfd_signed_vma)(s).st_size)
end_define

begin_function
specifier|const
name|bfd_target
modifier|*
name|xcoff64_core_p
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|struct
name|core_dumpxx
name|core
decl_stmt|,
modifier|*
name|new_core_hdr
decl_stmt|;
name|struct
name|stat
name|statbuf
decl_stmt|;
name|asection
modifier|*
name|sec
decl_stmt|;
name|struct
name|__ld_info64
name|ldinfo
decl_stmt|;
name|bfd_vma
name|ld_offset
decl_stmt|;
name|bfd_size_type
name|i
decl_stmt|;
name|struct
name|vm_infox
name|vminfo
decl_stmt|;
specifier|const
name|bfd_target
modifier|*
name|return_value
init|=
name|NULL
decl_stmt|;
comment|/* Get the header.  */
if|if
condition|(
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|xcoff64_core_p_error
goto|;
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|core_dumpxx
argument_list|)
operator|!=
name|bfd_bread
argument_list|(
operator|&
name|core
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|core_dumpxx
argument_list|)
argument_list|,
name|abfd
argument_list|)
condition|)
goto|goto
name|xcoff64_core_p_error
goto|;
if|if
condition|(
name|bfd_stat
argument_list|(
name|abfd
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|xcoff64_core_p_error
goto|;
comment|/* Sanity checks      c_flag has CORE_VERSION_1, Aix 4+      c_entries = 0 for Aix 4.3+      IS_PROC64 is a macro defined in procinfo.h, test for 64 bit process.       We will still be confused if a Aix 4.3 64 bit core file is      copied over to a Aix 5 machine.       Check file header offsets       See rs6000-core.c for comment on size of core      If there isn't enough of a real core file, bail.  */
if|if
condition|(
operator|(
name|CORE_VERSION_1
operator|!=
operator|(
name|core
operator|.
name|c_flag
operator|&
name|CORE_VERSION_1
operator|)
operator|)
operator|||
operator|(
literal|0
operator|!=
name|core
operator|.
name|c_entries
operator|)
operator|||
operator|(
operator|!
operator|(
name|IS_PROC64
argument_list|(
operator|&
name|core
operator|.
name|c_u
operator|.
name|U_proc
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|CHECK_FILE_OFFSET
argument_list|(
name|statbuf
argument_list|,
name|core
operator|.
name|c_fdsinfox
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|CHECK_FILE_OFFSET
argument_list|(
name|statbuf
argument_list|,
name|core
operator|.
name|c_loader
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|CHECK_FILE_OFFSET
argument_list|(
name|statbuf
argument_list|,
name|core
operator|.
name|c_loader
operator|+
name|core
operator|.
name|c_lsize
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|CHECK_FILE_OFFSET
argument_list|(
name|statbuf
argument_list|,
name|core
operator|.
name|c_thr
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|CHECK_FILE_OFFSET
argument_list|(
name|statbuf
argument_list|,
name|core
operator|.
name|c_segregion
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|CHECK_FILE_OFFSET
argument_list|(
name|statbuf
argument_list|,
name|core
operator|.
name|c_stack
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|CHECK_FILE_OFFSET
argument_list|(
name|statbuf
argument_list|,
name|core
operator|.
name|c_stack
operator|+
name|core
operator|.
name|c_size
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|CHECK_FILE_OFFSET
argument_list|(
name|statbuf
argument_list|,
name|core
operator|.
name|c_data
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|CHECK_FILE_OFFSET
argument_list|(
name|statbuf
argument_list|,
name|core
operator|.
name|c_data
operator|+
name|core
operator|.
name|c_datasize
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|!
operator|(
name|core
operator|.
name|c_flag
operator|&
name|UBLOCK_VALID
operator|)
operator|)
operator|||
operator|(
operator|!
operator|(
name|core
operator|.
name|c_flag
operator|&
name|LE_VALID
operator|)
operator|)
condition|)
goto|goto
name|xcoff64_core_p_error
goto|;
comment|/* Check for truncated stack or general truncating.  */
if|if
condition|(
operator|(
operator|!
operator|(
name|core
operator|.
name|c_flag
operator|&
name|USTACK_VALID
operator|)
operator|)
operator|||
operator|(
name|core
operator|.
name|c_flag
operator|&
name|CORE_TRUNC
operator|)
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_file_truncated
argument_list|)
expr_stmt|;
return|return
name|return_value
return|;
block|}
name|new_core_hdr
operator|=
name|bfd_zalloc
argument_list|(
name|abfd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|core_dumpxx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|new_core_hdr
condition|)
return|return
name|return_value
return|;
name|memcpy
argument_list|(
name|new_core_hdr
argument_list|,
operator|&
name|core
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|core_dumpxx
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The core_hdr() macro is no longer used here because it would      expand to code relying on gcc's cast-as-lvalue extension,      which was removed in gcc 4.0.  */
name|abfd
operator|->
name|tdata
operator|.
name|any
operator|=
name|new_core_hdr
expr_stmt|;
comment|/* .stack section.  */
name|sec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
literal|".stack"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|sec
condition|)
return|return
name|return_value
return|;
name|sec
operator|->
name|flags
operator|=
name|SEC_ALLOC
operator||
name|SEC_LOAD
operator||
name|SEC_HAS_CONTENTS
expr_stmt|;
name|sec
operator|->
name|size
operator|=
name|core
operator|.
name|c_size
expr_stmt|;
name|sec
operator|->
name|vma
operator|=
name|core
operator|.
name|c_stackorg
expr_stmt|;
name|sec
operator|->
name|filepos
operator|=
name|core
operator|.
name|c_stack
expr_stmt|;
comment|/* .reg section for all registers.  */
name|sec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
literal|".reg"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|sec
condition|)
return|return
name|return_value
return|;
name|sec
operator|->
name|flags
operator|=
name|SEC_HAS_CONTENTS
operator||
name|SEC_IN_MEMORY
expr_stmt|;
name|sec
operator|->
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|__context64
argument_list|)
expr_stmt|;
name|sec
operator|->
name|vma
operator|=
literal|0
expr_stmt|;
name|sec
operator|->
name|filepos
operator|=
literal|0
expr_stmt|;
name|sec
operator|->
name|contents
operator|=
operator|(
name|bfd_byte
operator|*
operator|)
operator|&
name|new_core_hdr
operator|->
name|c_flt
operator|.
name|r64
expr_stmt|;
comment|/* .ldinfo section.      To actually find out how long this section is in this particular      core dump would require going down the whole list of struct      ld_info's.   See if we can just fake it.  */
name|sec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
literal|".ldinfo"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|sec
condition|)
return|return
name|return_value
return|;
name|sec
operator|->
name|flags
operator|=
name|SEC_HAS_CONTENTS
expr_stmt|;
name|sec
operator|->
name|size
operator|=
name|core
operator|.
name|c_lsize
expr_stmt|;
name|sec
operator|->
name|vma
operator|=
literal|0
expr_stmt|;
name|sec
operator|->
name|filepos
operator|=
name|core
operator|.
name|c_loader
expr_stmt|;
comment|/* AIX 4 adds data sections from loaded objects to the core file,      which can be found by examining ldinfo, and anonymously mmapped      regions.  */
comment|/* .data section from executable.  */
name|sec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
literal|".data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|sec
condition|)
return|return
name|return_value
return|;
name|sec
operator|->
name|flags
operator|=
name|SEC_ALLOC
operator||
name|SEC_LOAD
operator||
name|SEC_HAS_CONTENTS
expr_stmt|;
name|sec
operator|->
name|size
operator|=
name|core
operator|.
name|c_datasize
expr_stmt|;
name|sec
operator|->
name|vma
operator|=
name|core
operator|.
name|c_dataorg
expr_stmt|;
name|sec
operator|->
name|filepos
operator|=
name|core
operator|.
name|c_data
expr_stmt|;
comment|/* .data sections from loaded objects.  */
name|ld_offset
operator|=
name|core
operator|.
name|c_loader
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|ld_offset
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|return_value
return|;
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|__ld_info64
argument_list|)
operator|!=
name|bfd_bread
argument_list|(
operator|&
name|ldinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|__ld_info64
argument_list|)
argument_list|,
name|abfd
argument_list|)
condition|)
return|return
name|return_value
return|;
if|if
condition|(
name|ldinfo
operator|.
name|ldinfo_core
condition|)
block|{
name|sec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
literal|".data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|sec
condition|)
return|return
name|return_value
return|;
name|sec
operator|->
name|flags
operator|=
name|SEC_ALLOC
operator||
name|SEC_LOAD
operator||
name|SEC_HAS_CONTENTS
expr_stmt|;
name|sec
operator|->
name|size
operator|=
name|ldinfo
operator|.
name|ldinfo_datasize
expr_stmt|;
name|sec
operator|->
name|vma
operator|=
name|ldinfo
operator|.
name|ldinfo_dataorg
expr_stmt|;
name|sec
operator|->
name|filepos
operator|=
name|ldinfo
operator|.
name|ldinfo_core
expr_stmt|;
block|}
if|if
condition|(
literal|0
operator|==
name|ldinfo
operator|.
name|ldinfo_next
condition|)
break|break;
name|ld_offset
operator|+=
name|ldinfo
operator|.
name|ldinfo_next
expr_stmt|;
block|}
comment|/* .vmdata sections from anonymously mmapped regions.  */
if|if
condition|(
name|core
operator|.
name|c_vmregions
condition|)
block|{
if|if
condition|(
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|core
operator|.
name|c_vmm
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|return_value
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|core
operator|.
name|c_vmregions
condition|;
name|i
operator|++
control|)
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|vm_infox
argument_list|)
operator|!=
name|bfd_bread
argument_list|(
operator|&
name|vminfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|vm_infox
argument_list|)
argument_list|,
name|abfd
argument_list|)
condition|)
return|return
name|return_value
return|;
if|if
condition|(
name|vminfo
operator|.
name|vminfo_offset
condition|)
block|{
name|sec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
literal|".vmdata"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|sec
condition|)
return|return
name|return_value
return|;
name|sec
operator|->
name|flags
operator|=
name|SEC_ALLOC
operator||
name|SEC_LOAD
operator||
name|SEC_HAS_CONTENTS
expr_stmt|;
name|sec
operator|->
name|size
operator|=
name|vminfo
operator|.
name|vminfo_size
expr_stmt|;
name|sec
operator|->
name|vma
operator|=
name|vminfo
operator|.
name|vminfo_addr
expr_stmt|;
name|sec
operator|->
name|filepos
operator|=
name|vminfo
operator|.
name|vminfo_offset
expr_stmt|;
block|}
block|}
name|return_value
operator|=
operator|(
name|bfd_target
operator|*
operator|)
name|abfd
operator|->
name|xvec
expr_stmt|;
comment|/* This is garbage for now.  */
name|xcoff64_core_p_error
label|:
if|if
condition|(
name|bfd_get_error
argument_list|()
operator|!=
name|bfd_error_system_call
condition|)
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
return|return
name|return_value
return|;
block|}
end_function

begin_comment
comment|/* Return `TRUE' if given core is from the given executable.  */
end_comment

begin_function
name|bfd_boolean
name|xcoff64_core_file_matches_executable_p
parameter_list|(
name|bfd
modifier|*
name|core_bfd
parameter_list|,
name|bfd
modifier|*
name|exec_bfd
parameter_list|)
block|{
name|struct
name|core_dumpxx
name|core
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|size_t
name|alloc
decl_stmt|;
specifier|const
name|char
modifier|*
name|str1
decl_stmt|,
modifier|*
name|str2
decl_stmt|;
name|bfd_boolean
name|return_value
init|=
name|FALSE
decl_stmt|;
comment|/* Get the header.  */
if|if
condition|(
name|bfd_seek
argument_list|(
name|core_bfd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|return_value
return|;
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|core_dumpxx
argument_list|)
operator|!=
name|bfd_bread
argument_list|(
operator|&
name|core
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|core_dumpxx
argument_list|)
argument_list|,
name|core_bfd
argument_list|)
condition|)
return|return
name|return_value
return|;
if|if
condition|(
name|bfd_seek
argument_list|(
name|core_bfd
argument_list|,
name|core
operator|.
name|c_loader
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|return_value
return|;
name|alloc
operator|=
literal|100
expr_stmt|;
name|path
operator|=
name|bfd_malloc
argument_list|(
name|alloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
operator|==
name|NULL
condition|)
return|return
name|return_value
return|;
name|s
operator|=
name|path
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|bfd_bread
argument_list|(
name|s
argument_list|,
literal|1
argument_list|,
name|core_bfd
argument_list|)
operator|!=
literal|1
condition|)
goto|goto
name|xcoff64_core_file_matches_executable_p_end_1
goto|;
if|if
condition|(
operator|*
name|s
operator|==
literal|'\0'
condition|)
break|break;
operator|++
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|path
operator|+
name|alloc
condition|)
block|{
name|char
modifier|*
name|n
decl_stmt|;
name|alloc
operator|*=
literal|2
expr_stmt|;
name|n
operator|=
name|bfd_realloc
argument_list|(
name|path
argument_list|,
name|alloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
goto|goto
name|xcoff64_core_file_matches_executable_p_end_1
goto|;
name|s
operator|=
name|n
operator|+
operator|(
name|path
operator|-
name|s
operator|)
expr_stmt|;
name|path
operator|=
name|n
expr_stmt|;
block|}
block|}
name|str1
operator|=
name|strrchr
argument_list|(
name|path
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
name|str2
operator|=
name|strrchr
argument_list|(
name|exec_bfd
operator|->
name|filename
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
comment|/* Step over character '/'.  */
name|str1
operator|=
name|str1
operator|!=
name|NULL
condition|?
name|str1
operator|+
literal|1
else|:
name|path
expr_stmt|;
name|str2
operator|=
name|str2
operator|!=
name|NULL
condition|?
name|str2
operator|+
literal|1
else|:
name|exec_bfd
operator|->
name|filename
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|str1
argument_list|,
name|str2
argument_list|)
operator|==
literal|0
condition|)
name|return_value
operator|=
name|TRUE
expr_stmt|;
name|xcoff64_core_file_matches_executable_p_end_1
label|:
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
return|return
name|return_value
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|xcoff64_core_file_failing_command
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|struct
name|core_dumpxx
modifier|*
name|c
init|=
name|core_hdr
argument_list|(
name|abfd
argument_list|)
decl_stmt|;
name|char
modifier|*
name|return_value
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|NULL
operator|!=
name|c
condition|)
name|return_value
operator|=
name|c
operator|->
name|c_u
operator|.
name|U_proc
operator|.
name|pi_comm
expr_stmt|;
return|return
name|return_value
return|;
block|}
end_function

begin_function
name|int
name|xcoff64_core_file_failing_signal
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|struct
name|core_dumpxx
modifier|*
name|c
init|=
name|core_hdr
argument_list|(
name|abfd
argument_list|)
decl_stmt|;
name|int
name|return_value
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|NULL
operator|!=
name|c
condition|)
name|return_value
operator|=
name|c
operator|->
name|c_signo
expr_stmt|;
return|return
name|return_value
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* AIX_5_CORE */
end_comment

begin_function
specifier|const
name|bfd_target
modifier|*
name|xcoff64_core_p
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|bfd_boolean
name|xcoff64_core_file_matches_executable_p
parameter_list|(
name|bfd
modifier|*
name|core_bfd
parameter_list|,
name|bfd
modifier|*
name|exec_bfd
parameter_list|)
block|{
return|return
name|generic_core_file_matches_executable_p
argument_list|(
name|core_bfd
argument_list|,
name|exec_bfd
argument_list|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|xcoff64_core_file_failing_command
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|xcoff64_core_file_failing_signal
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* AIX_5_CORE */
end_comment

end_unit


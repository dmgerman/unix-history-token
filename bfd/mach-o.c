begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Mach-O support for BFD.    Copyright 1999, 2000, 2001, 2002, 2003, 2004, 2005    Free Software Foundation, Inc.     This file is part of BFD, the Binary File Descriptor library.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"mach-o.h"
end_include

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"libiberty.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|BFD_IO_FUNCS
end_ifndef

begin_define
define|#
directive|define
name|BFD_IO_FUNCS
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|bfd_mach_o_mkarchive
value|_bfd_noarchive_mkarchive
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_read_ar_hdr
value|_bfd_noarchive_read_ar_hdr
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_slurp_armap
value|_bfd_noarchive_slurp_armap
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_slurp_extended_name_table
value|_bfd_noarchive_slurp_extended_name_table
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_construct_extended_name_table
value|_bfd_noarchive_construct_extended_name_table
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_truncate_arname
value|_bfd_noarchive_truncate_arname
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_write_armap
value|_bfd_noarchive_write_armap
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_get_elt_at_index
value|_bfd_noarchive_get_elt_at_index
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_generic_stat_arch_elt
value|_bfd_noarchive_generic_stat_arch_elt
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_update_armap_timestamp
value|_bfd_noarchive_update_armap_timestamp
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_close_and_cleanup
value|_bfd_generic_close_and_cleanup
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_free_cached_info
value|_bfd_generic_bfd_free_cached_info
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_new_section_hook
value|_bfd_generic_new_section_hook
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_get_section_contents_in_window
value|_bfd_generic_get_section_contents_in_window
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_is_local_label_name
value|_bfd_nosymbols_bfd_is_local_label_name
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_is_target_special_symbol
value|((bfd_boolean (*) (bfd *, asymbol *)) bfd_false)
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_is_local_label_name
value|_bfd_nosymbols_bfd_is_local_label_name
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_get_lineno
value|_bfd_nosymbols_get_lineno
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_find_nearest_line
value|_bfd_nosymbols_find_nearest_line
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_find_inliner_info
value|_bfd_nosymbols_find_inliner_info
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_make_debug_symbol
value|_bfd_nosymbols_bfd_make_debug_symbol
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_read_minisymbols
value|_bfd_generic_read_minisymbols
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_minisymbol_to_symbol
value|_bfd_generic_minisymbol_to_symbol
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_get_reloc_upper_bound
value|_bfd_norelocs_get_reloc_upper_bound
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_canonicalize_reloc
value|_bfd_norelocs_canonicalize_reloc
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_reloc_type_lookup
value|_bfd_norelocs_bfd_reloc_type_lookup
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_get_relocated_section_contents
value|bfd_generic_get_relocated_section_contents
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_relax_section
value|bfd_generic_relax_section
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_link_hash_table_create
value|_bfd_generic_link_hash_table_create
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_link_hash_table_free
value|_bfd_generic_link_hash_table_free
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_link_add_symbols
value|_bfd_generic_link_add_symbols
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_link_just_syms
value|_bfd_generic_link_just_syms
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_final_link
value|_bfd_generic_final_link
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_link_split_section
value|_bfd_generic_link_split_section
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_set_arch_mach
value|bfd_default_set_arch_mach
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_merge_private_bfd_data
value|_bfd_generic_bfd_merge_private_bfd_data
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_set_private_flags
value|_bfd_generic_bfd_set_private_flags
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_print_private_bfd_data
value|_bfd_generic_bfd_print_private_bfd_data
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_get_section_contents
value|_bfd_generic_get_section_contents
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_set_section_contents
value|_bfd_generic_set_section_contents
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_gc_sections
value|bfd_generic_gc_sections
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_merge_sections
value|bfd_generic_merge_sections
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_is_group_section
value|bfd_generic_is_group_section
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_discard_group
value|bfd_generic_discard_group
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_section_already_linked
value|_bfd_generic_section_already_linked
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_bfd_copy_private_header_data
value|_bfd_generic_bfd_copy_private_header_data
end_define

begin_define
define|#
directive|define
name|bfd_mach_o_core_file_matches_executable_p
value|generic_core_file_matches_executable_p
end_define

begin_comment
comment|/* The flags field of a section structure is separated into two parts a section    type and section attributes.  The section types are mutually exclusive (it    can only have one type) but the section attributes are not (it may have more    than one attribute).  */
end_comment

begin_define
define|#
directive|define
name|SECTION_TYPE
value|0x000000ff
end_define

begin_comment
comment|/* 256 section types.  */
end_comment

begin_define
define|#
directive|define
name|SECTION_ATTRIBUTES
value|0xffffff00
end_define

begin_comment
comment|/*  24 section attributes.  */
end_comment

begin_comment
comment|/* Constants for the section attributes part of the flags field of a section    structure.  */
end_comment

begin_define
define|#
directive|define
name|SECTION_ATTRIBUTES_USR
value|0xff000000
end_define

begin_comment
comment|/* User-settable attributes.  */
end_comment

begin_define
define|#
directive|define
name|S_ATTR_PURE_INSTRUCTIONS
value|0x80000000
end_define

begin_comment
comment|/* Section contains only true machine instructions.  */
end_comment

begin_define
define|#
directive|define
name|SECTION_ATTRIBUTES_SYS
value|0x00ffff00
end_define

begin_comment
comment|/* System setable attributes.  */
end_comment

begin_define
define|#
directive|define
name|S_ATTR_SOME_INSTRUCTIONS
value|0x00000400
end_define

begin_comment
comment|/* Section contains some machine instructions.  */
end_comment

begin_define
define|#
directive|define
name|S_ATTR_EXT_RELOC
value|0x00000200
end_define

begin_comment
comment|/* Section has external relocation entries.  */
end_comment

begin_define
define|#
directive|define
name|S_ATTR_LOC_RELOC
value|0x00000100
end_define

begin_comment
comment|/* Section has local relocation entries.  */
end_comment

begin_define
define|#
directive|define
name|N_STAB
value|0xe0
end_define

begin_define
define|#
directive|define
name|N_TYPE
value|0x1e
end_define

begin_define
define|#
directive|define
name|N_EXT
value|0x01
end_define

begin_define
define|#
directive|define
name|N_UNDF
value|0x0
end_define

begin_define
define|#
directive|define
name|N_ABS
value|0x2
end_define

begin_define
define|#
directive|define
name|N_SECT
value|0xe
end_define

begin_define
define|#
directive|define
name|N_INDR
value|0xa
end_define

begin_function
name|bfd_boolean
name|bfd_mach_o_valid
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
if|if
condition|(
name|abfd
operator|==
name|NULL
operator|||
name|abfd
operator|->
name|xvec
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
operator|(
name|abfd
operator|->
name|xvec
operator|==
operator|&
name|mach_o_be_vec
operator|)
operator|||
operator|(
name|abfd
operator|->
name|xvec
operator|==
operator|&
name|mach_o_le_vec
operator|)
operator|||
operator|(
name|abfd
operator|->
name|xvec
operator|==
operator|&
name|mach_o_fat_vec
operator|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Copy any private info we understand from the input symbol    to the output symbol.  */
end_comment

begin_function
specifier|static
name|bfd_boolean
name|bfd_mach_o_bfd_copy_private_symbol_data
parameter_list|(
name|bfd
modifier|*
name|ibfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asymbol
modifier|*
name|isymbol
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd
modifier|*
name|obfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asymbol
modifier|*
name|osymbol
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Copy any private info we understand from the input section    to the output section.  */
end_comment

begin_function
specifier|static
name|bfd_boolean
name|bfd_mach_o_bfd_copy_private_section_data
parameter_list|(
name|bfd
modifier|*
name|ibfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|isection
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd
modifier|*
name|obfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asection
modifier|*
name|osection
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Copy any private info we understand from the input bfd    to the output bfd.  */
end_comment

begin_function
specifier|static
name|bfd_boolean
name|bfd_mach_o_bfd_copy_private_bfd_data
parameter_list|(
name|bfd
modifier|*
name|ibfd
parameter_list|,
name|bfd
modifier|*
name|obfd
parameter_list|)
block|{
name|BFD_ASSERT
argument_list|(
name|bfd_mach_o_valid
argument_list|(
name|ibfd
argument_list|)
argument_list|)
expr_stmt|;
name|BFD_ASSERT
argument_list|(
name|bfd_mach_o_valid
argument_list|(
name|obfd
argument_list|)
argument_list|)
expr_stmt|;
name|obfd
operator|->
name|tdata
operator|.
name|mach_o_data
operator|=
name|ibfd
operator|->
name|tdata
operator|.
name|mach_o_data
expr_stmt|;
name|obfd
operator|->
name|tdata
operator|.
name|mach_o_data
operator|->
name|ibfd
operator|=
name|ibfd
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|long
name|bfd_mach_o_count_symbols
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|bfd_mach_o_data_struct
modifier|*
name|mdata
init|=
name|NULL
decl_stmt|;
name|long
name|nsyms
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|bfd_mach_o_valid
argument_list|(
name|abfd
argument_list|)
argument_list|)
expr_stmt|;
name|mdata
operator|=
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mdata
operator|->
name|header
operator|.
name|ncmds
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|type
operator|==
name|BFD_MACH_O_LC_SYMTAB
condition|)
block|{
name|bfd_mach_o_symtab_command
modifier|*
name|sym
init|=
operator|&
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|command
operator|.
name|symtab
decl_stmt|;
name|nsyms
operator|+=
name|sym
operator|->
name|nsyms
expr_stmt|;
block|}
return|return
name|nsyms
return|;
block|}
end_function

begin_function
specifier|static
name|long
name|bfd_mach_o_get_symtab_upper_bound
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|long
name|nsyms
init|=
name|bfd_mach_o_count_symbols
argument_list|(
name|abfd
argument_list|)
decl_stmt|;
if|if
condition|(
name|nsyms
operator|<
literal|0
condition|)
return|return
name|nsyms
return|;
return|return
operator|(
operator|(
name|nsyms
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|asymbol
operator|*
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|long
name|bfd_mach_o_canonicalize_symtab
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|asymbol
modifier|*
modifier|*
name|alocation
parameter_list|)
block|{
name|bfd_mach_o_data_struct
modifier|*
name|mdata
init|=
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
decl_stmt|;
name|long
name|nsyms
init|=
name|bfd_mach_o_count_symbols
argument_list|(
name|abfd
argument_list|)
decl_stmt|;
name|asymbol
modifier|*
modifier|*
name|csym
init|=
name|alocation
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|nsyms
operator|<
literal|0
condition|)
return|return
name|nsyms
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mdata
operator|->
name|header
operator|.
name|ncmds
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|type
operator|==
name|BFD_MACH_O_LC_SYMTAB
condition|)
block|{
name|bfd_mach_o_symtab_command
modifier|*
name|sym
init|=
operator|&
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|command
operator|.
name|symtab
decl_stmt|;
if|if
condition|(
name|bfd_mach_o_scan_read_symtab_symbols
argument_list|(
name|abfd
argument_list|,
operator|&
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|command
operator|.
name|symtab
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_canonicalize_symtab: unable to load symbols for section %lu\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|BFD_ASSERT
argument_list|(
name|sym
operator|->
name|symbols
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|sym
operator|->
name|nsyms
condition|;
name|j
operator|++
control|)
block|{
name|BFD_ASSERT
argument_list|(
name|csym
operator|<
operator|(
name|alocation
operator|+
name|nsyms
operator|)
argument_list|)
expr_stmt|;
operator|*
name|csym
operator|++
operator|=
operator|&
name|sym
operator|->
name|symbols
index|[
name|j
index|]
expr_stmt|;
block|}
block|}
block|}
operator|*
name|csym
operator|++
operator|=
name|NULL
expr_stmt|;
return|return
name|nsyms
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bfd_mach_o_get_symbol_info
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|asymbol
modifier|*
name|symbol
parameter_list|,
name|symbol_info
modifier|*
name|ret
parameter_list|)
block|{
name|bfd_symbol_info
argument_list|(
name|symbol
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bfd_mach_o_print_symbol
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|PTR
name|afile
parameter_list|,
name|asymbol
modifier|*
name|symbol
parameter_list|,
name|bfd_print_symbol_type
name|how
parameter_list|)
block|{
name|FILE
modifier|*
name|file
init|=
operator|(
name|FILE
operator|*
operator|)
name|afile
decl_stmt|;
switch|switch
condition|(
name|how
condition|)
block|{
case|case
name|bfd_print_symbol_name
case|:
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%s"
argument_list|,
name|symbol
operator|->
name|name
argument_list|)
expr_stmt|;
break|break;
default|default:
name|bfd_print_symbol_vandf
argument_list|(
name|abfd
argument_list|,
operator|(
name|PTR
operator|)
name|file
argument_list|,
name|symbol
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" %-5s %s"
argument_list|,
name|symbol
operator|->
name|section
operator|->
name|name
argument_list|,
name|symbol
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bfd_mach_o_convert_architecture
parameter_list|(
name|bfd_mach_o_cpu_type
name|mtype
parameter_list|,
name|bfd_mach_o_cpu_subtype
name|msubtype
name|ATTRIBUTE_UNUSED
parameter_list|,
name|enum
name|bfd_architecture
modifier|*
name|type
parameter_list|,
name|unsigned
name|long
modifier|*
name|subtype
parameter_list|)
block|{
operator|*
name|subtype
operator|=
name|bfd_arch_unknown
expr_stmt|;
switch|switch
condition|(
name|mtype
condition|)
block|{
case|case
name|BFD_MACH_O_CPU_TYPE_VAX
case|:
operator|*
name|type
operator|=
name|bfd_arch_vax
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_MC680x0
case|:
operator|*
name|type
operator|=
name|bfd_arch_m68k
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_I386
case|:
operator|*
name|type
operator|=
name|bfd_arch_i386
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_MIPS
case|:
operator|*
name|type
operator|=
name|bfd_arch_mips
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_MC98000
case|:
operator|*
name|type
operator|=
name|bfd_arch_m98k
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_HPPA
case|:
operator|*
name|type
operator|=
name|bfd_arch_hppa
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_ARM
case|:
operator|*
name|type
operator|=
name|bfd_arch_arm
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_MC88000
case|:
operator|*
name|type
operator|=
name|bfd_arch_m88k
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_SPARC
case|:
operator|*
name|type
operator|=
name|bfd_arch_sparc
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_I860
case|:
operator|*
name|type
operator|=
name|bfd_arch_i860
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_ALPHA
case|:
operator|*
name|type
operator|=
name|bfd_arch_alpha
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_POWERPC
case|:
operator|*
name|type
operator|=
name|bfd_arch_powerpc
expr_stmt|;
break|break;
default|default:
operator|*
name|type
operator|=
name|bfd_arch_unknown
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
operator|*
name|type
condition|)
block|{
case|case
name|bfd_arch_i386
case|:
operator|*
name|subtype
operator|=
name|bfd_mach_i386_i386
expr_stmt|;
break|break;
case|case
name|bfd_arch_sparc
case|:
operator|*
name|subtype
operator|=
name|bfd_mach_sparc
expr_stmt|;
break|break;
default|default:
operator|*
name|subtype
operator|=
name|bfd_arch_unknown
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_write_header
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_header
modifier|*
name|header
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|28
index|]
decl_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|header
operator|->
name|magic
argument_list|,
name|buf
operator|+
literal|0
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|header
operator|->
name|cputype
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|header
operator|->
name|cpusubtype
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|header
operator|->
name|filetype
argument_list|,
name|buf
operator|+
literal|12
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|header
operator|->
name|ncmds
argument_list|,
name|buf
operator|+
literal|16
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|header
operator|->
name|sizeofcmds
argument_list|,
name|buf
operator|+
literal|20
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|header
operator|->
name|flags
argument_list|,
name|buf
operator|+
literal|24
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bwrite
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|28
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|28
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_write_thread
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|bfd_mach_o_thread_command
modifier|*
name|cmd
init|=
operator|&
name|command
operator|->
name|command
operator|.
name|thread
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|bfd_vma
name|offset
decl_stmt|;
name|unsigned
name|int
name|nflavours
decl_stmt|;
name|BFD_ASSERT
argument_list|(
operator|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_THREAD
operator|)
operator|||
operator|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_UNIXTHREAD
operator|)
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|8
expr_stmt|;
name|nflavours
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|nflavours
condition|;
name|i
operator|++
control|)
block|{
name|BFD_ASSERT
argument_list|(
operator|(
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|size
operator|%
literal|4
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|BFD_ASSERT
argument_list|(
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|offset
operator|==
operator|(
name|command
operator|->
name|offset
operator|+
name|offset
operator|+
literal|8
operator|)
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|flavour
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
operator|(
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|size
operator|/
literal|4
operator|)
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
operator|+
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bwrite
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|8
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|8
condition|)
return|return
operator|-
literal|1
return|;
name|offset
operator|+=
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|size
operator|+
literal|8
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_write_section
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_section
modifier|*
name|section
parameter_list|,
name|bfd_vma
name|offset
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|68
index|]
decl_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|section
operator|->
name|sectname
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
operator|+
literal|16
argument_list|,
name|section
operator|->
name|segname
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|section
operator|->
name|addr
argument_list|,
name|buf
operator|+
literal|32
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|section
operator|->
name|size
argument_list|,
name|buf
operator|+
literal|36
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|section
operator|->
name|offset
argument_list|,
name|buf
operator|+
literal|40
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|section
operator|->
name|align
argument_list|,
name|buf
operator|+
literal|44
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|section
operator|->
name|reloff
argument_list|,
name|buf
operator|+
literal|48
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|section
operator|->
name|nreloc
argument_list|,
name|buf
operator|+
literal|52
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|section
operator|->
name|flags
argument_list|,
name|buf
operator|+
literal|56
argument_list|)
expr_stmt|;
comment|/* bfd_h_put_32 (abfd, section->reserved1, buf + 60); */
comment|/* bfd_h_put_32 (abfd, section->reserved2, buf + 64); */
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bwrite
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|68
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|68
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_write_segment
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|48
index|]
decl_stmt|;
name|bfd_mach_o_segment_command
modifier|*
name|seg
init|=
operator|&
name|command
operator|->
name|command
operator|.
name|segment
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_SEGMENT
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|seg
operator|->
name|segname
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|vmaddr
argument_list|,
name|buf
operator|+
literal|16
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|vmsize
argument_list|,
name|buf
operator|+
literal|20
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|fileoff
argument_list|,
name|buf
operator|+
literal|24
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|filesize
argument_list|,
name|buf
operator|+
literal|28
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
literal|0
comment|/* seg->maxprot */
argument_list|,
name|buf
operator|+
literal|32
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
literal|0
comment|/* seg->initprot */
argument_list|,
name|buf
operator|+
literal|36
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|nsects
argument_list|,
name|buf
operator|+
literal|40
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|flags
argument_list|,
name|buf
operator|+
literal|44
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
operator|+
literal|8
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bwrite
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|48
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|48
condition|)
return|return
operator|-
literal|1
return|;
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|bfd_vma
name|nbytes
init|=
name|seg
operator|->
name|filesize
decl_stmt|;
name|bfd_vma
name|curoff
init|=
name|seg
operator|->
name|fileoff
decl_stmt|;
while|while
condition|(
name|nbytes
operator|>
literal|0
condition|)
block|{
name|bfd_vma
name|thisread
init|=
name|nbytes
decl_stmt|;
if|if
condition|(
name|thisread
operator|>
literal|1024
condition|)
name|thisread
operator|=
literal|1024
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|curoff
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
name|thisread
argument_list|,
name|abfd
argument_list|)
operator|!=
name|thisread
condition|)
return|return
operator|-
literal|1
return|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|curoff
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bwrite
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
name|thisread
argument_list|,
name|abfd
argument_list|)
operator|!=
name|thisread
condition|)
return|return
operator|-
literal|1
return|;
name|nbytes
operator|-=
name|thisread
expr_stmt|;
name|curoff
operator|+=
name|thisread
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|seg
operator|->
name|nsects
condition|;
name|i
operator|++
control|)
block|{
name|bfd_vma
name|segoff
init|=
name|command
operator|->
name|offset
operator|+
literal|48
operator|+
literal|8
operator|+
operator|(
name|i
operator|*
literal|68
operator|)
decl_stmt|;
if|if
condition|(
name|bfd_mach_o_scan_write_section
argument_list|(
name|abfd
argument_list|,
operator|&
name|seg
operator|->
name|sections
index|[
name|i
index|]
argument_list|,
name|segoff
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_write_symtab_symbols
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|bfd_mach_o_symtab_command
modifier|*
name|sym
init|=
operator|&
name|command
operator|->
name|command
operator|.
name|symtab
decl_stmt|;
name|asymbol
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sym
operator|->
name|nsyms
condition|;
name|i
operator|++
control|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|12
index|]
decl_stmt|;
name|bfd_vma
name|symoff
init|=
name|sym
operator|->
name|symoff
operator|+
operator|(
name|i
operator|*
literal|12
operator|)
decl_stmt|;
name|unsigned
name|char
name|ntype
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|nsect
init|=
literal|0
decl_stmt|;
name|short
name|ndesc
init|=
literal|0
decl_stmt|;
name|s
operator|=
operator|&
name|sym
operator|->
name|symbols
index|[
name|i
index|]
expr_stmt|;
comment|/* Instead just set from the stored values.  */
name|ntype
operator|=
operator|(
name|s
operator|->
name|udata
operator|.
name|i
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|nsect
operator|=
operator|(
name|s
operator|->
name|udata
operator|.
name|i
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|ndesc
operator|=
name|s
operator|->
name|udata
operator|.
name|i
operator|&
literal|0xffff
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|s
operator|->
name|name
operator|-
name|sym
operator|->
name|strtab
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|bfd_h_put_8
argument_list|(
name|abfd
argument_list|,
name|ntype
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|bfd_h_put_8
argument_list|(
name|abfd
argument_list|,
name|nsect
argument_list|,
name|buf
operator|+
literal|5
argument_list|)
expr_stmt|;
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
name|ndesc
argument_list|,
name|buf
operator|+
literal|6
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|s
operator|->
name|section
operator|->
name|vma
operator|+
name|s
operator|->
name|value
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|symoff
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bwrite
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|12
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|12
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_scan_write_symtab_symbols: unable to write %d bytes at %lu\n"
argument_list|,
literal|12
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|symoff
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_write_symtab
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|bfd_mach_o_symtab_command
modifier|*
name|seg
init|=
operator|&
name|command
operator|->
name|command
operator|.
name|symtab
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_SYMTAB
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|symoff
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|nsyms
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|stroff
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|strsize
argument_list|,
name|buf
operator|+
literal|12
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
operator|+
literal|8
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bwrite
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|16
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|16
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bfd_mach_o_scan_write_symtab_symbols
argument_list|(
name|abfd
argument_list|,
name|command
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|bfd_boolean
name|bfd_mach_o_write_contents
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|asection
modifier|*
name|s
decl_stmt|;
name|bfd_mach_o_data_struct
modifier|*
name|mdata
init|=
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
decl_stmt|;
comment|/* Write data sections first in case they overlap header data to be      written later.  */
for|for
control|(
name|s
operator|=
name|abfd
operator|->
name|sections
init|;
name|s
operator|!=
operator|(
name|asection
operator|*
operator|)
name|NULL
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
empty_stmt|;
comment|/* Now write header information.  */
if|if
condition|(
name|bfd_mach_o_write_header
argument_list|(
name|abfd
argument_list|,
operator|&
name|mdata
operator|->
name|header
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|FALSE
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mdata
operator|->
name|header
operator|.
name|ncmds
condition|;
name|i
operator|++
control|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|bfd_mach_o_load_command
modifier|*
name|cur
init|=
operator|&
name|mdata
operator|->
name|commands
index|[
name|i
index|]
decl_stmt|;
name|unsigned
name|long
name|typeflag
decl_stmt|;
name|typeflag
operator|=
name|cur
operator|->
name|type_required
condition|?
name|cur
operator|->
name|type
operator|&
name|BFD_MACH_O_LC_REQ_DYLD
else|:
name|cur
operator|->
name|type
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|typeflag
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|bfd_h_put_32
argument_list|(
name|abfd
argument_list|,
name|cur
operator|->
name|len
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|cur
operator|->
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bwrite
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|8
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|8
condition|)
return|return
name|FALSE
return|;
switch|switch
condition|(
name|cur
operator|->
name|type
condition|)
block|{
case|case
name|BFD_MACH_O_LC_SEGMENT
case|:
if|if
condition|(
name|bfd_mach_o_scan_write_segment
argument_list|(
name|abfd
argument_list|,
name|cur
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|FALSE
return|;
break|break;
case|case
name|BFD_MACH_O_LC_SYMTAB
case|:
if|if
condition|(
name|bfd_mach_o_scan_write_symtab
argument_list|(
name|abfd
argument_list|,
name|cur
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|FALSE
return|;
break|break;
case|case
name|BFD_MACH_O_LC_SYMSEG
case|:
break|break;
case|case
name|BFD_MACH_O_LC_THREAD
case|:
case|case
name|BFD_MACH_O_LC_UNIXTHREAD
case|:
if|if
condition|(
name|bfd_mach_o_scan_write_thread
argument_list|(
name|abfd
argument_list|,
name|cur
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|FALSE
return|;
break|break;
case|case
name|BFD_MACH_O_LC_LOADFVMLIB
case|:
case|case
name|BFD_MACH_O_LC_IDFVMLIB
case|:
case|case
name|BFD_MACH_O_LC_IDENT
case|:
case|case
name|BFD_MACH_O_LC_FVMFILE
case|:
case|case
name|BFD_MACH_O_LC_PREPAGE
case|:
case|case
name|BFD_MACH_O_LC_DYSYMTAB
case|:
case|case
name|BFD_MACH_O_LC_LOAD_DYLIB
case|:
case|case
name|BFD_MACH_O_LC_LOAD_WEAK_DYLIB
case|:
case|case
name|BFD_MACH_O_LC_ID_DYLIB
case|:
case|case
name|BFD_MACH_O_LC_LOAD_DYLINKER
case|:
case|case
name|BFD_MACH_O_LC_ID_DYLINKER
case|:
case|case
name|BFD_MACH_O_LC_PREBOUND_DYLIB
case|:
case|case
name|BFD_MACH_O_LC_ROUTINES
case|:
case|case
name|BFD_MACH_O_LC_SUB_FRAMEWORK
case|:
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unable to write unknown load command 0x%lx\n"
argument_list|,
operator|(
name|long
operator|)
name|cur
operator|->
name|type
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_sizeof_headers
parameter_list|(
name|bfd
modifier|*
name|a
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_boolean
name|b
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Make an empty symbol.  This is required only because    bfd_make_section_anyway wants to create a symbol for the section.  */
end_comment

begin_function
specifier|static
name|asymbol
modifier|*
name|bfd_mach_o_make_empty_symbol
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|asymbol
modifier|*
name|new
decl_stmt|;
name|new
operator|=
name|bfd_zalloc
argument_list|(
name|abfd
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|NULL
condition|)
return|return
name|new
return|;
name|new
operator|->
name|the_bfd
operator|=
name|abfd
expr_stmt|;
return|return
name|new
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_read_header
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_header
modifier|*
name|header
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|28
index|]
decl_stmt|;
name|bfd_vma
function_decl|(
modifier|*
name|get32
function_decl|)
parameter_list|(
specifier|const
name|void
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|28
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|28
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bfd_getb32
argument_list|(
name|buf
argument_list|)
operator|==
literal|0xfeedface
condition|)
block|{
name|header
operator|->
name|byteorder
operator|=
name|BFD_ENDIAN_BIG
expr_stmt|;
name|header
operator|->
name|magic
operator|=
literal|0xfeedface
expr_stmt|;
name|get32
operator|=
name|bfd_getb32
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bfd_getl32
argument_list|(
name|buf
argument_list|)
operator|==
literal|0xfeedface
condition|)
block|{
name|header
operator|->
name|byteorder
operator|=
name|BFD_ENDIAN_LITTLE
expr_stmt|;
name|header
operator|->
name|magic
operator|=
literal|0xfeedface
expr_stmt|;
name|get32
operator|=
name|bfd_getl32
expr_stmt|;
block|}
else|else
block|{
name|header
operator|->
name|byteorder
operator|=
name|BFD_ENDIAN_UNKNOWN
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|header
operator|->
name|cputype
operator|=
call|(
modifier|*
name|get32
call|)
argument_list|(
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|header
operator|->
name|cpusubtype
operator|=
call|(
modifier|*
name|get32
call|)
argument_list|(
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
name|header
operator|->
name|filetype
operator|=
call|(
modifier|*
name|get32
call|)
argument_list|(
name|buf
operator|+
literal|12
argument_list|)
expr_stmt|;
name|header
operator|->
name|ncmds
operator|=
call|(
modifier|*
name|get32
call|)
argument_list|(
name|buf
operator|+
literal|16
argument_list|)
expr_stmt|;
name|header
operator|->
name|sizeofcmds
operator|=
call|(
modifier|*
name|get32
call|)
argument_list|(
name|buf
operator|+
literal|20
argument_list|)
expr_stmt|;
name|header
operator|->
name|flags
operator|=
call|(
modifier|*
name|get32
call|)
argument_list|(
name|buf
operator|+
literal|24
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|asection
modifier|*
name|bfd_mach_o_make_bfd_section
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_section
modifier|*
name|section
parameter_list|)
block|{
name|asection
modifier|*
name|bfdsec
decl_stmt|;
name|char
modifier|*
name|sname
decl_stmt|;
specifier|const
name|char
modifier|*
name|prefix
init|=
literal|"LC_SEGMENT"
decl_stmt|;
name|unsigned
name|int
name|snamelen
decl_stmt|;
name|snamelen
operator|=
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|+
literal|1
operator|+
name|strlen
argument_list|(
name|section
operator|->
name|segname
argument_list|)
operator|+
literal|1
operator|+
name|strlen
argument_list|(
name|section
operator|->
name|sectname
argument_list|)
operator|+
literal|1
expr_stmt|;
name|sname
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|snamelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|sprintf
argument_list|(
name|sname
argument_list|,
literal|"%s.%s.%s"
argument_list|,
name|prefix
argument_list|,
name|section
operator|->
name|segname
argument_list|,
name|section
operator|->
name|sectname
argument_list|)
expr_stmt|;
name|bfdsec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfdsec
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|bfdsec
operator|->
name|vma
operator|=
name|section
operator|->
name|addr
expr_stmt|;
name|bfdsec
operator|->
name|lma
operator|=
name|section
operator|->
name|addr
expr_stmt|;
name|bfdsec
operator|->
name|size
operator|=
name|section
operator|->
name|size
expr_stmt|;
name|bfdsec
operator|->
name|filepos
operator|=
name|section
operator|->
name|offset
expr_stmt|;
name|bfdsec
operator|->
name|alignment_power
operator|=
name|section
operator|->
name|align
expr_stmt|;
if|if
condition|(
name|section
operator|->
name|flags
operator|&
name|BFD_MACH_O_S_ZEROFILL
condition|)
name|bfdsec
operator|->
name|flags
operator|=
name|SEC_ALLOC
expr_stmt|;
else|else
name|bfdsec
operator|->
name|flags
operator|=
name|SEC_HAS_CONTENTS
operator||
name|SEC_LOAD
operator||
name|SEC_ALLOC
operator||
name|SEC_CODE
expr_stmt|;
return|return
name|bfdsec
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_read_section
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_section
modifier|*
name|section
parameter_list|,
name|bfd_vma
name|offset
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|68
index|]
decl_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|68
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|68
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|section
operator|->
name|sectname
argument_list|,
name|buf
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|section
operator|->
name|sectname
index|[
literal|16
index|]
operator|=
literal|'\0'
expr_stmt|;
name|memcpy
argument_list|(
name|section
operator|->
name|segname
argument_list|,
name|buf
operator|+
literal|16
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|section
operator|->
name|segname
index|[
literal|16
index|]
operator|=
literal|'\0'
expr_stmt|;
name|section
operator|->
name|addr
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|32
argument_list|)
expr_stmt|;
name|section
operator|->
name|size
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|36
argument_list|)
expr_stmt|;
name|section
operator|->
name|offset
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|40
argument_list|)
expr_stmt|;
name|section
operator|->
name|align
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|44
argument_list|)
expr_stmt|;
name|section
operator|->
name|reloff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|48
argument_list|)
expr_stmt|;
name|section
operator|->
name|nreloc
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|52
argument_list|)
expr_stmt|;
name|section
operator|->
name|flags
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|56
argument_list|)
expr_stmt|;
name|section
operator|->
name|reserved1
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|60
argument_list|)
expr_stmt|;
name|section
operator|->
name|reserved2
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|64
argument_list|)
expr_stmt|;
name|section
operator|->
name|bfdsection
operator|=
name|bfd_mach_o_make_bfd_section
argument_list|(
name|abfd
argument_list|,
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|section
operator|->
name|bfdsection
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|bfd_mach_o_scan_read_symtab_symbol
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_symtab_command
modifier|*
name|sym
parameter_list|,
name|asymbol
modifier|*
name|s
parameter_list|,
name|unsigned
name|long
name|i
parameter_list|)
block|{
name|bfd_mach_o_data_struct
modifier|*
name|mdata
init|=
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
decl_stmt|;
name|bfd_vma
name|symoff
init|=
name|sym
operator|->
name|symoff
operator|+
operator|(
name|i
operator|*
literal|12
operator|)
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|12
index|]
decl_stmt|;
name|unsigned
name|char
name|type
init|=
operator|-
literal|1
decl_stmt|;
name|unsigned
name|char
name|section
init|=
operator|-
literal|1
decl_stmt|;
name|short
name|desc
init|=
operator|-
literal|1
decl_stmt|;
name|unsigned
name|long
name|value
init|=
operator|-
literal|1
decl_stmt|;
name|unsigned
name|long
name|stroff
init|=
operator|-
literal|1
decl_stmt|;
name|unsigned
name|int
name|symtype
init|=
operator|-
literal|1
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|sym
operator|->
name|strtab
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|symoff
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|12
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|12
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_scan_read_symtab_symbol: unable to read %d bytes at %lu\n"
argument_list|,
literal|12
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|symoff
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|stroff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|type
operator|=
name|bfd_h_get_8
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|symtype
operator|=
operator|(
name|type
operator|&
literal|0x0e
operator|)
expr_stmt|;
name|section
operator|=
name|bfd_h_get_8
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|5
argument_list|)
operator|-
literal|1
expr_stmt|;
name|desc
operator|=
name|bfd_h_get_16
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|6
argument_list|)
expr_stmt|;
name|value
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|stroff
operator|>=
name|sym
operator|->
name|strsize
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_scan_read_symtab_symbol: symbol name out of range (%lu>= %lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|stroff
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|sym
operator|->
name|strsize
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|s
operator|->
name|the_bfd
operator|=
name|abfd
expr_stmt|;
name|s
operator|->
name|name
operator|=
name|sym
operator|->
name|strtab
operator|+
name|stroff
expr_stmt|;
name|s
operator|->
name|value
operator|=
name|value
expr_stmt|;
name|s
operator|->
name|udata
operator|.
name|i
operator|=
operator|(
name|type
operator|<<
literal|24
operator|)
operator||
operator|(
name|section
operator|<<
literal|16
operator|)
operator||
name|desc
expr_stmt|;
name|s
operator|->
name|flags
operator|=
literal|0x0
expr_stmt|;
if|if
condition|(
name|type
operator|&
name|BFD_MACH_O_N_STAB
condition|)
block|{
name|s
operator|->
name|flags
operator||=
name|BSF_DEBUGGING
expr_stmt|;
name|s
operator|->
name|section
operator|=
name|bfd_und_section_ptr
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|type
operator|&
name|BFD_MACH_O_N_PEXT
condition|)
block|{
name|type
operator|&=
operator|~
name|BFD_MACH_O_N_PEXT
expr_stmt|;
name|s
operator|->
name|flags
operator||=
name|BSF_GLOBAL
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|&
name|BFD_MACH_O_N_EXT
condition|)
block|{
name|type
operator|&=
operator|~
name|BFD_MACH_O_N_EXT
expr_stmt|;
name|s
operator|->
name|flags
operator||=
name|BSF_GLOBAL
expr_stmt|;
block|}
switch|switch
condition|(
name|symtype
condition|)
block|{
case|case
name|BFD_MACH_O_N_UNDF
case|:
name|s
operator|->
name|section
operator|=
name|bfd_und_section_ptr
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_N_PBUD
case|:
name|s
operator|->
name|section
operator|=
name|bfd_und_section_ptr
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_N_ABS
case|:
name|s
operator|->
name|section
operator|=
name|bfd_abs_section_ptr
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_N_SECT
case|:
if|if
condition|(
operator|(
name|section
operator|>
literal|0
operator|)
operator|&&
operator|(
name|section
operator|<=
name|mdata
operator|->
name|nsects
operator|)
condition|)
block|{
name|s
operator|->
name|section
operator|=
name|mdata
operator|->
name|sections
index|[
name|section
operator|-
literal|1
index|]
operator|->
name|bfdsection
expr_stmt|;
name|s
operator|->
name|value
operator|=
name|s
operator|->
name|value
operator|-
name|mdata
operator|->
name|sections
index|[
name|section
operator|-
literal|1
index|]
operator|->
name|addr
expr_stmt|;
block|}
else|else
block|{
comment|/* Mach-O uses 0 to mean "no section"; not an error.  */
if|if
condition|(
name|section
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_scan_read_symtab_symbol: "
literal|"symbol \"%s\" specified invalid section %d (max %lu): setting to undefined\n"
argument_list|,
name|s
operator|->
name|name
argument_list|,
name|section
argument_list|,
name|mdata
operator|->
name|nsects
argument_list|)
expr_stmt|;
block|}
name|s
operator|->
name|section
operator|=
name|bfd_und_section_ptr
expr_stmt|;
block|}
break|break;
case|case
name|BFD_MACH_O_N_INDR
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_scan_read_symtab_symbol: "
literal|"symbol \"%s\" is unsupported 'indirect' reference: setting to undefined\n"
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
name|s
operator|->
name|section
operator|=
name|bfd_und_section_ptr
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_scan_read_symtab_symbol: "
literal|"symbol \"%s\" specified invalid type field 0x%x: setting to undefined\n"
argument_list|,
name|s
operator|->
name|name
argument_list|,
name|symtype
argument_list|)
expr_stmt|;
name|s
operator|->
name|section
operator|=
name|bfd_und_section_ptr
expr_stmt|;
break|break;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|bfd_mach_o_scan_read_symtab_strtab
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_symtab_command
modifier|*
name|sym
parameter_list|)
block|{
name|BFD_ASSERT
argument_list|(
name|sym
operator|->
name|strtab
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|abfd
operator|->
name|flags
operator|&
name|BFD_IN_MEMORY
condition|)
block|{
name|struct
name|bfd_in_memory
modifier|*
name|b
decl_stmt|;
name|b
operator|=
operator|(
expr|struct
name|bfd_in_memory
operator|*
operator|)
name|abfd
operator|->
name|iostream
expr_stmt|;
if|if
condition|(
operator|(
name|sym
operator|->
name|stroff
operator|+
name|sym
operator|->
name|strsize
operator|)
operator|>
name|b
operator|->
name|size
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_file_truncated
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sym
operator|->
name|strtab
operator|=
operator|(
name|char
operator|*
operator|)
name|b
operator|->
name|buffer
operator|+
name|sym
operator|->
name|stroff
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sym
operator|->
name|strtab
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|sym
operator|->
name|strsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|sym
operator|->
name|strtab
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|sym
operator|->
name|stroff
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|sym
operator|->
name|strtab
argument_list|,
name|sym
operator|->
name|strsize
argument_list|,
name|abfd
argument_list|)
operator|!=
name|sym
operator|->
name|strsize
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_scan_read_symtab_strtab: unable to read %lu bytes at %lu\n"
argument_list|,
name|sym
operator|->
name|strsize
argument_list|,
name|sym
operator|->
name|stroff
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|bfd_mach_o_scan_read_symtab_symbols
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_symtab_command
modifier|*
name|sym
parameter_list|)
block|{
name|unsigned
name|long
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|sym
operator|->
name|symbols
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|sym
operator|->
name|symbols
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|sym
operator|->
name|nsyms
operator|*
sizeof|sizeof
argument_list|(
name|asymbol
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sym
operator|->
name|symbols
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_scan_read_symtab_symbols: unable to allocate memory for symbols\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|bfd_mach_o_scan_read_symtab_strtab
argument_list|(
name|abfd
argument_list|,
name|sym
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
name|ret
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sym
operator|->
name|nsyms
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|bfd_mach_o_scan_read_symtab_symbol
argument_list|(
name|abfd
argument_list|,
name|sym
argument_list|,
operator|&
name|sym
operator|->
name|symbols
index|[
name|i
index|]
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|bfd_mach_o_scan_read_dysymtab_symbol
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_dysymtab_command
modifier|*
name|dysym
parameter_list|,
name|bfd_mach_o_symtab_command
modifier|*
name|sym
parameter_list|,
name|asymbol
modifier|*
name|s
parameter_list|,
name|unsigned
name|long
name|i
parameter_list|)
block|{
name|unsigned
name|long
name|isymoff
init|=
name|dysym
operator|->
name|indirectsymoff
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
decl_stmt|;
name|unsigned
name|long
name|symindex
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|i
operator|<
name|dysym
operator|->
name|nindirectsyms
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|isymoff
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|4
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|4
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_scan_read_dysymtab_symbol: unable to read %lu bytes at %lu\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
literal|4
argument_list|,
name|isymoff
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|symindex
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
name|bfd_mach_o_scan_read_symtab_symbol
argument_list|(
name|abfd
argument_list|,
name|sym
argument_list|,
name|s
argument_list|,
name|symindex
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|bfd_mach_o_i386_flavour_string
parameter_list|(
name|unsigned
name|int
name|flavour
parameter_list|)
block|{
switch|switch
condition|(
operator|(
name|int
operator|)
name|flavour
condition|)
block|{
case|case
name|BFD_MACH_O_i386_NEW_THREAD_STATE
case|:
return|return
literal|"i386_NEW_THREAD_STATE"
return|;
case|case
name|BFD_MACH_O_i386_FLOAT_STATE
case|:
return|return
literal|"i386_FLOAT_STATE"
return|;
case|case
name|BFD_MACH_O_i386_ISA_PORT_MAP_STATE
case|:
return|return
literal|"i386_ISA_PORT_MAP_STATE"
return|;
case|case
name|BFD_MACH_O_i386_V86_ASSIST_STATE
case|:
return|return
literal|"i386_V86_ASSIST_STATE"
return|;
case|case
name|BFD_MACH_O_i386_REGS_SEGS_STATE
case|:
return|return
literal|"i386_REGS_SEGS_STATE"
return|;
case|case
name|BFD_MACH_O_i386_THREAD_SYSCALL_STATE
case|:
return|return
literal|"i386_THREAD_SYSCALL_STATE"
return|;
case|case
name|BFD_MACH_O_i386_THREAD_STATE_NONE
case|:
return|return
literal|"i386_THREAD_STATE_NONE"
return|;
case|case
name|BFD_MACH_O_i386_SAVED_STATE
case|:
return|return
literal|"i386_SAVED_STATE"
return|;
case|case
name|BFD_MACH_O_i386_THREAD_STATE
case|:
return|return
literal|"i386_THREAD_STATE"
return|;
case|case
name|BFD_MACH_O_i386_THREAD_FPSTATE
case|:
return|return
literal|"i386_THREAD_FPSTATE"
return|;
case|case
name|BFD_MACH_O_i386_THREAD_EXCEPTSTATE
case|:
return|return
literal|"i386_THREAD_EXCEPTSTATE"
return|;
case|case
name|BFD_MACH_O_i386_THREAD_CTHREADSTATE
case|:
return|return
literal|"i386_THREAD_CTHREADSTATE"
return|;
default|default:
return|return
literal|"UNKNOWN"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|bfd_mach_o_ppc_flavour_string
parameter_list|(
name|unsigned
name|int
name|flavour
parameter_list|)
block|{
switch|switch
condition|(
operator|(
name|int
operator|)
name|flavour
condition|)
block|{
case|case
name|BFD_MACH_O_PPC_THREAD_STATE
case|:
return|return
literal|"PPC_THREAD_STATE"
return|;
case|case
name|BFD_MACH_O_PPC_FLOAT_STATE
case|:
return|return
literal|"PPC_FLOAT_STATE"
return|;
case|case
name|BFD_MACH_O_PPC_EXCEPTION_STATE
case|:
return|return
literal|"PPC_EXCEPTION_STATE"
return|;
case|case
name|BFD_MACH_O_PPC_VECTOR_STATE
case|:
return|return
literal|"PPC_VECTOR_STATE"
return|;
default|default:
return|return
literal|"UNKNOWN"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_read_dylinker
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|bfd_mach_o_dylinker_command
modifier|*
name|cmd
init|=
operator|&
name|command
operator|->
name|command
operator|.
name|dylinker
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|unsigned
name|int
name|nameoff
decl_stmt|;
name|asection
modifier|*
name|bfdsec
decl_stmt|;
name|char
modifier|*
name|sname
decl_stmt|;
specifier|const
name|char
modifier|*
name|prefix
decl_stmt|;
name|BFD_ASSERT
argument_list|(
operator|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_ID_DYLINKER
operator|)
operator|||
operator|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_LOAD_DYLINKER
operator|)
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
operator|+
literal|8
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|4
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|4
condition|)
return|return
operator|-
literal|1
return|;
name|nameoff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|0
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|name_offset
operator|=
name|command
operator|->
name|offset
operator|+
name|nameoff
expr_stmt|;
name|cmd
operator|->
name|name_len
operator|=
name|command
operator|->
name|len
operator|-
name|nameoff
expr_stmt|;
if|if
condition|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_LOAD_DYLINKER
condition|)
name|prefix
operator|=
literal|"LC_LOAD_DYLINKER"
expr_stmt|;
elseif|else
if|if
condition|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_ID_DYLINKER
condition|)
name|prefix
operator|=
literal|"LC_ID_DYLINKER"
expr_stmt|;
else|else
name|abort
argument_list|()
expr_stmt|;
name|sname
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|strcpy
argument_list|(
name|sname
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|bfdsec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfdsec
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bfdsec
operator|->
name|vma
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|lma
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|size
operator|=
name|command
operator|->
name|len
operator|-
literal|8
expr_stmt|;
name|bfdsec
operator|->
name|filepos
operator|=
name|command
operator|->
name|offset
operator|+
literal|8
expr_stmt|;
name|bfdsec
operator|->
name|alignment_power
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|flags
operator|=
name|SEC_HAS_CONTENTS
expr_stmt|;
name|cmd
operator|->
name|section
operator|=
name|bfdsec
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_read_dylib
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|bfd_mach_o_dylib_command
modifier|*
name|cmd
init|=
operator|&
name|command
operator|->
name|command
operator|.
name|dylib
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|unsigned
name|int
name|nameoff
decl_stmt|;
name|asection
modifier|*
name|bfdsec
decl_stmt|;
name|char
modifier|*
name|sname
decl_stmt|;
specifier|const
name|char
modifier|*
name|prefix
decl_stmt|;
name|BFD_ASSERT
argument_list|(
operator|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_ID_DYLIB
operator|)
operator|||
operator|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_LOAD_DYLIB
operator|)
operator|||
operator|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_LOAD_WEAK_DYLIB
operator|)
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
operator|+
literal|8
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|16
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|16
condition|)
return|return
operator|-
literal|1
return|;
name|nameoff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|0
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|timestamp
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|current_version
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|compatibility_version
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|12
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|name_offset
operator|=
name|command
operator|->
name|offset
operator|+
name|nameoff
expr_stmt|;
name|cmd
operator|->
name|name_len
operator|=
name|command
operator|->
name|len
operator|-
name|nameoff
expr_stmt|;
if|if
condition|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_LOAD_DYLIB
condition|)
name|prefix
operator|=
literal|"LC_LOAD_DYLIB"
expr_stmt|;
elseif|else
if|if
condition|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_LOAD_WEAK_DYLIB
condition|)
name|prefix
operator|=
literal|"LC_LOAD_WEAK_DYLIB"
expr_stmt|;
elseif|else
if|if
condition|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_ID_DYLIB
condition|)
name|prefix
operator|=
literal|"LC_ID_DYLIB"
expr_stmt|;
else|else
name|abort
argument_list|()
expr_stmt|;
name|sname
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|strcpy
argument_list|(
name|sname
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|bfdsec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfdsec
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bfdsec
operator|->
name|vma
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|lma
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|size
operator|=
name|command
operator|->
name|len
operator|-
literal|8
expr_stmt|;
name|bfdsec
operator|->
name|filepos
operator|=
name|command
operator|->
name|offset
operator|+
literal|8
expr_stmt|;
name|bfdsec
operator|->
name|alignment_power
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|flags
operator|=
name|SEC_HAS_CONTENTS
expr_stmt|;
name|cmd
operator|->
name|section
operator|=
name|bfdsec
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_read_prebound_dylib
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
comment|/* bfd_mach_o_prebound_dylib_command *cmd =&command->command.prebound_dylib; */
name|BFD_ASSERT
argument_list|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_PREBOUND_DYLIB
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_read_thread
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|bfd_mach_o_data_struct
modifier|*
name|mdata
init|=
name|NULL
decl_stmt|;
name|bfd_mach_o_thread_command
modifier|*
name|cmd
init|=
operator|&
name|command
operator|->
name|command
operator|.
name|thread
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|bfd_vma
name|offset
decl_stmt|;
name|unsigned
name|int
name|nflavours
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|BFD_ASSERT
argument_list|(
operator|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_THREAD
operator|)
operator|||
operator|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_UNIXTHREAD
operator|)
argument_list|)
expr_stmt|;
name|BFD_ASSERT
argument_list|(
name|bfd_mach_o_valid
argument_list|(
name|abfd
argument_list|)
argument_list|)
expr_stmt|;
name|mdata
operator|=
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
expr_stmt|;
name|offset
operator|=
literal|8
expr_stmt|;
name|nflavours
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|offset
operator|!=
name|command
operator|->
name|len
condition|)
block|{
if|if
condition|(
name|offset
operator|>=
name|command
operator|->
name|len
condition|)
return|return
operator|-
literal|1
return|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
operator|+
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|8
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|8
condition|)
return|return
operator|-
literal|1
return|;
name|offset
operator|+=
literal|8
operator|+
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
operator|*
literal|4
expr_stmt|;
name|nflavours
operator|++
expr_stmt|;
block|}
name|cmd
operator|->
name|flavours
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|nflavours
operator|*
sizeof|sizeof
argument_list|(
name|bfd_mach_o_thread_flavour
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|flavours
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|cmd
operator|->
name|nflavours
operator|=
name|nflavours
expr_stmt|;
name|offset
operator|=
literal|8
expr_stmt|;
name|nflavours
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|offset
operator|!=
name|command
operator|->
name|len
condition|)
block|{
if|if
condition|(
name|offset
operator|>=
name|command
operator|->
name|len
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nflavours
operator|>=
name|cmd
operator|->
name|nflavours
condition|)
return|return
operator|-
literal|1
return|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
operator|+
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|8
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|8
condition|)
return|return
operator|-
literal|1
return|;
name|cmd
operator|->
name|flavours
index|[
name|nflavours
index|]
operator|.
name|flavour
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|flavours
index|[
name|nflavours
index|]
operator|.
name|offset
operator|=
name|command
operator|->
name|offset
operator|+
name|offset
operator|+
literal|8
expr_stmt|;
name|cmd
operator|->
name|flavours
index|[
name|nflavours
index|]
operator|.
name|size
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
operator|*
literal|4
expr_stmt|;
name|offset
operator|+=
name|cmd
operator|->
name|flavours
index|[
name|nflavours
index|]
operator|.
name|size
operator|+
literal|8
expr_stmt|;
name|nflavours
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nflavours
condition|;
name|i
operator|++
control|)
block|{
name|asection
modifier|*
name|bfdsec
decl_stmt|;
name|unsigned
name|int
name|snamelen
decl_stmt|;
name|char
modifier|*
name|sname
decl_stmt|;
specifier|const
name|char
modifier|*
name|flavourstr
decl_stmt|;
specifier|const
name|char
modifier|*
name|prefix
init|=
literal|"LC_THREAD"
decl_stmt|;
name|unsigned
name|int
name|j
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|mdata
operator|->
name|header
operator|.
name|cputype
condition|)
block|{
case|case
name|BFD_MACH_O_CPU_TYPE_POWERPC
case|:
name|flavourstr
operator|=
name|bfd_mach_o_ppc_flavour_string
argument_list|(
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|flavour
argument_list|)
expr_stmt|;
break|break;
case|case
name|BFD_MACH_O_CPU_TYPE_I386
case|:
name|flavourstr
operator|=
name|bfd_mach_o_i386_flavour_string
argument_list|(
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|flavour
argument_list|)
expr_stmt|;
break|break;
default|default:
name|flavourstr
operator|=
literal|"UNKNOWN_ARCHITECTURE"
expr_stmt|;
break|break;
block|}
name|snamelen
operator|=
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|+
literal|1
operator|+
literal|20
operator|+
literal|1
operator|+
name|strlen
argument_list|(
name|flavourstr
argument_list|)
operator|+
literal|1
expr_stmt|;
name|sname
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|snamelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|sprintf
argument_list|(
name|sname
argument_list|,
literal|"%s.%s.%u"
argument_list|,
name|prefix
argument_list|,
name|flavourstr
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_get_section_by_name
argument_list|(
name|abfd
argument_list|,
name|sname
argument_list|)
operator|==
name|NULL
condition|)
break|break;
name|j
operator|++
expr_stmt|;
block|}
name|bfdsec
operator|=
name|bfd_make_section
argument_list|(
name|abfd
argument_list|,
name|sname
argument_list|)
expr_stmt|;
name|bfdsec
operator|->
name|vma
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|lma
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|size
operator|=
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|size
expr_stmt|;
name|bfdsec
operator|->
name|filepos
operator|=
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|offset
expr_stmt|;
name|bfdsec
operator|->
name|alignment_power
operator|=
literal|0x0
expr_stmt|;
name|bfdsec
operator|->
name|flags
operator|=
name|SEC_HAS_CONTENTS
expr_stmt|;
name|cmd
operator|->
name|section
operator|=
name|bfdsec
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_read_dysymtab
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|bfd_mach_o_dysymtab_command
modifier|*
name|seg
init|=
operator|&
name|command
operator|->
name|command
operator|.
name|dysymtab
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|72
index|]
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_DYSYMTAB
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
operator|+
literal|8
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|72
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|72
condition|)
return|return
operator|-
literal|1
return|;
name|seg
operator|->
name|ilocalsym
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|0
argument_list|)
expr_stmt|;
name|seg
operator|->
name|nlocalsym
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|seg
operator|->
name|iextdefsym
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
name|seg
operator|->
name|nextdefsym
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|12
argument_list|)
expr_stmt|;
name|seg
operator|->
name|iundefsym
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|16
argument_list|)
expr_stmt|;
name|seg
operator|->
name|nundefsym
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|20
argument_list|)
expr_stmt|;
name|seg
operator|->
name|tocoff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|24
argument_list|)
expr_stmt|;
name|seg
operator|->
name|ntoc
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|28
argument_list|)
expr_stmt|;
name|seg
operator|->
name|modtaboff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|32
argument_list|)
expr_stmt|;
name|seg
operator|->
name|nmodtab
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|36
argument_list|)
expr_stmt|;
name|seg
operator|->
name|extrefsymoff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|40
argument_list|)
expr_stmt|;
name|seg
operator|->
name|nextrefsyms
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|44
argument_list|)
expr_stmt|;
name|seg
operator|->
name|indirectsymoff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|48
argument_list|)
expr_stmt|;
name|seg
operator|->
name|nindirectsyms
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|52
argument_list|)
expr_stmt|;
name|seg
operator|->
name|extreloff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|56
argument_list|)
expr_stmt|;
name|seg
operator|->
name|nextrel
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|60
argument_list|)
expr_stmt|;
name|seg
operator|->
name|locreloff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|64
argument_list|)
expr_stmt|;
name|seg
operator|->
name|nlocrel
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|68
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_read_symtab
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|bfd_mach_o_symtab_command
modifier|*
name|seg
init|=
operator|&
name|command
operator|->
name|command
operator|.
name|symtab
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|asection
modifier|*
name|bfdsec
decl_stmt|;
name|char
modifier|*
name|sname
decl_stmt|;
specifier|const
name|char
modifier|*
name|prefix
init|=
literal|"LC_SYMTAB.stabs"
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_SYMTAB
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
operator|+
literal|8
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|16
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|16
condition|)
return|return
operator|-
literal|1
return|;
name|seg
operator|->
name|symoff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|seg
operator|->
name|nsyms
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|seg
operator|->
name|stroff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
name|seg
operator|->
name|strsize
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|12
argument_list|)
expr_stmt|;
name|seg
operator|->
name|symbols
operator|=
name|NULL
expr_stmt|;
name|seg
operator|->
name|strtab
operator|=
name|NULL
expr_stmt|;
name|sname
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|strcpy
argument_list|(
name|sname
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|bfdsec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfdsec
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bfdsec
operator|->
name|vma
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|lma
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|size
operator|=
name|seg
operator|->
name|nsyms
operator|*
literal|12
expr_stmt|;
name|bfdsec
operator|->
name|filepos
operator|=
name|seg
operator|->
name|symoff
expr_stmt|;
name|bfdsec
operator|->
name|alignment_power
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|flags
operator|=
name|SEC_HAS_CONTENTS
expr_stmt|;
name|seg
operator|->
name|stabs_segment
operator|=
name|bfdsec
expr_stmt|;
name|prefix
operator|=
literal|"LC_SYMTAB.stabstr"
expr_stmt|;
name|sname
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|strcpy
argument_list|(
name|sname
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|bfdsec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfdsec
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bfdsec
operator|->
name|vma
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|lma
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|size
operator|=
name|seg
operator|->
name|strsize
expr_stmt|;
name|bfdsec
operator|->
name|filepos
operator|=
name|seg
operator|->
name|stroff
expr_stmt|;
name|bfdsec
operator|->
name|alignment_power
operator|=
literal|0
expr_stmt|;
name|bfdsec
operator|->
name|flags
operator|=
name|SEC_HAS_CONTENTS
expr_stmt|;
name|seg
operator|->
name|stabstr_segment
operator|=
name|bfdsec
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_read_segment
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|48
index|]
decl_stmt|;
name|bfd_mach_o_segment_command
modifier|*
name|seg
init|=
operator|&
name|command
operator|->
name|command
operator|.
name|segment
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|;
name|asection
modifier|*
name|bfdsec
decl_stmt|;
name|char
modifier|*
name|sname
decl_stmt|;
specifier|const
name|char
modifier|*
name|prefix
init|=
literal|"LC_SEGMENT"
decl_stmt|;
name|unsigned
name|int
name|snamelen
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|command
operator|->
name|type
operator|==
name|BFD_MACH_O_LC_SEGMENT
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
operator|+
literal|8
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|48
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|48
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|seg
operator|->
name|segname
argument_list|,
name|buf
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|seg
operator|->
name|vmaddr
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|16
argument_list|)
expr_stmt|;
name|seg
operator|->
name|vmsize
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|20
argument_list|)
expr_stmt|;
name|seg
operator|->
name|fileoff
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|24
argument_list|)
expr_stmt|;
name|seg
operator|->
name|filesize
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|28
argument_list|)
expr_stmt|;
comment|/* seg->maxprot = bfd_h_get_32 (abfd, buf + 32); */
comment|/* seg->initprot = bfd_h_get_32 (abfd, buf + 36); */
name|seg
operator|->
name|nsects
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|40
argument_list|)
expr_stmt|;
name|seg
operator|->
name|flags
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|44
argument_list|)
expr_stmt|;
name|snamelen
operator|=
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|+
literal|1
operator|+
name|strlen
argument_list|(
name|seg
operator|->
name|segname
argument_list|)
operator|+
literal|1
expr_stmt|;
name|sname
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|snamelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|sprintf
argument_list|(
name|sname
argument_list|,
literal|"%s.%s"
argument_list|,
name|prefix
argument_list|,
name|seg
operator|->
name|segname
argument_list|)
expr_stmt|;
name|bfdsec
operator|=
name|bfd_make_section_anyway
argument_list|(
name|abfd
argument_list|,
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfdsec
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bfdsec
operator|->
name|vma
operator|=
name|seg
operator|->
name|vmaddr
expr_stmt|;
name|bfdsec
operator|->
name|lma
operator|=
name|seg
operator|->
name|vmaddr
expr_stmt|;
name|bfdsec
operator|->
name|size
operator|=
name|seg
operator|->
name|filesize
expr_stmt|;
name|bfdsec
operator|->
name|filepos
operator|=
name|seg
operator|->
name|fileoff
expr_stmt|;
name|bfdsec
operator|->
name|alignment_power
operator|=
literal|0x0
expr_stmt|;
name|bfdsec
operator|->
name|flags
operator|=
name|SEC_HAS_CONTENTS
operator||
name|SEC_LOAD
operator||
name|SEC_ALLOC
operator||
name|SEC_CODE
expr_stmt|;
name|seg
operator|->
name|segment
operator|=
name|bfdsec
expr_stmt|;
if|if
condition|(
name|seg
operator|->
name|nsects
operator|!=
literal|0
condition|)
block|{
name|seg
operator|->
name|sections
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|seg
operator|->
name|nsects
operator|*
sizeof|sizeof
argument_list|(
name|bfd_mach_o_section
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|seg
operator|->
name|sections
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|seg
operator|->
name|nsects
condition|;
name|i
operator|++
control|)
block|{
name|bfd_vma
name|segoff
init|=
name|command
operator|->
name|offset
operator|+
literal|48
operator|+
literal|8
operator|+
operator|(
name|i
operator|*
literal|68
operator|)
decl_stmt|;
if|if
condition|(
name|bfd_mach_o_scan_read_section
argument_list|(
name|abfd
argument_list|,
operator|&
name|seg
operator|->
name|sections
index|[
name|i
index|]
argument_list|,
name|segoff
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bfd_mach_o_scan_read_command
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
name|command
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|command
operator|->
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|8
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|8
condition|)
return|return
operator|-
literal|1
return|;
name|command
operator|->
name|type
operator|=
operator|(
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
argument_list|)
operator|&
operator|~
name|BFD_MACH_O_LC_REQ_DYLD
operator|)
expr_stmt|;
name|command
operator|->
name|type_required
operator|=
operator|(
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
argument_list|)
operator|&
name|BFD_MACH_O_LC_REQ_DYLD
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
name|command
operator|->
name|len
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|command
operator|->
name|type
condition|)
block|{
case|case
name|BFD_MACH_O_LC_SEGMENT
case|:
if|if
condition|(
name|bfd_mach_o_scan_read_segment
argument_list|(
name|abfd
argument_list|,
name|command
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|BFD_MACH_O_LC_SYMTAB
case|:
if|if
condition|(
name|bfd_mach_o_scan_read_symtab
argument_list|(
name|abfd
argument_list|,
name|command
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|BFD_MACH_O_LC_SYMSEG
case|:
break|break;
case|case
name|BFD_MACH_O_LC_THREAD
case|:
case|case
name|BFD_MACH_O_LC_UNIXTHREAD
case|:
if|if
condition|(
name|bfd_mach_o_scan_read_thread
argument_list|(
name|abfd
argument_list|,
name|command
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|BFD_MACH_O_LC_LOAD_DYLINKER
case|:
case|case
name|BFD_MACH_O_LC_ID_DYLINKER
case|:
if|if
condition|(
name|bfd_mach_o_scan_read_dylinker
argument_list|(
name|abfd
argument_list|,
name|command
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|BFD_MACH_O_LC_LOAD_DYLIB
case|:
case|case
name|BFD_MACH_O_LC_ID_DYLIB
case|:
case|case
name|BFD_MACH_O_LC_LOAD_WEAK_DYLIB
case|:
if|if
condition|(
name|bfd_mach_o_scan_read_dylib
argument_list|(
name|abfd
argument_list|,
name|command
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|BFD_MACH_O_LC_PREBOUND_DYLIB
case|:
if|if
condition|(
name|bfd_mach_o_scan_read_prebound_dylib
argument_list|(
name|abfd
argument_list|,
name|command
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|BFD_MACH_O_LC_LOADFVMLIB
case|:
case|case
name|BFD_MACH_O_LC_IDFVMLIB
case|:
case|case
name|BFD_MACH_O_LC_IDENT
case|:
case|case
name|BFD_MACH_O_LC_FVMFILE
case|:
case|case
name|BFD_MACH_O_LC_PREPAGE
case|:
case|case
name|BFD_MACH_O_LC_ROUTINES
case|:
case|case
name|BFD_MACH_O_LC_SUB_FRAMEWORK
case|:
break|break;
case|case
name|BFD_MACH_O_LC_DYSYMTAB
case|:
if|if
condition|(
name|bfd_mach_o_scan_read_dysymtab
argument_list|(
name|abfd
argument_list|,
name|command
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|BFD_MACH_O_LC_SUB_UMBRELLA
case|:
case|case
name|BFD_MACH_O_LC_SUB_CLIENT
case|:
case|case
name|BFD_MACH_O_LC_SUB_LIBRARY
case|:
case|case
name|BFD_MACH_O_LC_TWOLEVEL_HINTS
case|:
case|case
name|BFD_MACH_O_LC_PREBIND_CKSUM
case|:
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unable to read unknown load command 0x%lx\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|command
operator|->
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bfd_mach_o_flatten_sections
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|bfd_mach_o_data_struct
modifier|*
name|mdata
init|=
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
decl_stmt|;
name|long
name|csect
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|,
name|j
decl_stmt|;
name|mdata
operator|->
name|nsects
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mdata
operator|->
name|header
operator|.
name|ncmds
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|type
operator|==
name|BFD_MACH_O_LC_SEGMENT
condition|)
block|{
name|bfd_mach_o_segment_command
modifier|*
name|seg
decl_stmt|;
name|seg
operator|=
operator|&
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|command
operator|.
name|segment
expr_stmt|;
name|mdata
operator|->
name|nsects
operator|+=
name|seg
operator|->
name|nsects
expr_stmt|;
block|}
block|}
name|mdata
operator|->
name|sections
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|mdata
operator|->
name|nsects
operator|*
sizeof|sizeof
argument_list|(
name|bfd_mach_o_section
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|csect
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mdata
operator|->
name|header
operator|.
name|ncmds
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|type
operator|==
name|BFD_MACH_O_LC_SEGMENT
condition|)
block|{
name|bfd_mach_o_segment_command
modifier|*
name|seg
decl_stmt|;
name|seg
operator|=
operator|&
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|command
operator|.
name|segment
expr_stmt|;
name|BFD_ASSERT
argument_list|(
name|csect
operator|+
name|seg
operator|->
name|nsects
operator|<=
name|mdata
operator|->
name|nsects
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|seg
operator|->
name|nsects
condition|;
name|j
operator|++
control|)
name|mdata
operator|->
name|sections
index|[
name|csect
operator|++
index|]
operator|=
operator|&
name|seg
operator|->
name|sections
index|[
name|j
index|]
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|bfd_mach_o_scan_start_address
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|bfd_mach_o_data_struct
modifier|*
name|mdata
init|=
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
decl_stmt|;
name|bfd_mach_o_thread_command
modifier|*
name|cmd
init|=
name|NULL
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mdata
operator|->
name|header
operator|.
name|ncmds
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|type
operator|==
name|BFD_MACH_O_LC_THREAD
operator|)
operator|||
operator|(
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|type
operator|==
name|BFD_MACH_O_LC_UNIXTHREAD
operator|)
condition|)
block|{
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
name|cmd
operator|=
operator|&
name|mdata
operator|->
name|commands
index|[
name|i
index|]
operator|.
name|command
operator|.
name|thread
expr_stmt|;
else|else
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|nflavours
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|mdata
operator|->
name|header
operator|.
name|cputype
operator|==
name|BFD_MACH_O_CPU_TYPE_I386
operator|)
operator|&&
operator|(
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|flavour
operator|==
operator|(
name|unsigned
name|long
operator|)
name|BFD_MACH_O_i386_THREAD_STATE
operator|)
condition|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|offset
operator|+
literal|40
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|4
condition|)
return|return
operator|-
literal|1
return|;
name|abfd
operator|->
name|start_address
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|mdata
operator|->
name|header
operator|.
name|cputype
operator|==
name|BFD_MACH_O_CPU_TYPE_POWERPC
operator|)
operator|&&
operator|(
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|flavour
operator|==
name|BFD_MACH_O_PPC_THREAD_STATE
operator|)
condition|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|cmd
operator|->
name|flavours
index|[
name|i
index|]
operator|.
name|offset
operator|+
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|4
condition|)
return|return
operator|-
literal|1
return|;
name|abfd
operator|->
name|start_address
operator|=
name|bfd_h_get_32
argument_list|(
name|abfd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|bfd_mach_o_scan
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_header
modifier|*
name|header
parameter_list|,
name|bfd_mach_o_data_struct
modifier|*
name|mdata
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|enum
name|bfd_architecture
name|cputype
decl_stmt|;
name|unsigned
name|long
name|cpusubtype
decl_stmt|;
name|mdata
operator|->
name|header
operator|=
operator|*
name|header
expr_stmt|;
name|mdata
operator|->
name|symbols
operator|=
name|NULL
expr_stmt|;
name|abfd
operator|->
name|flags
operator|=
operator|(
name|abfd
operator|->
name|xvec
operator|->
name|object_flags
operator||
operator|(
name|abfd
operator|->
name|flags
operator|&
operator|(
name|BFD_IN_MEMORY
operator||
name|BFD_IO_FUNCS
operator|)
operator|)
operator|)
expr_stmt|;
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
operator|=
name|mdata
expr_stmt|;
name|bfd_mach_o_convert_architecture
argument_list|(
name|header
operator|->
name|cputype
argument_list|,
name|header
operator|->
name|cpusubtype
argument_list|,
operator|&
name|cputype
argument_list|,
operator|&
name|cpusubtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|cputype
operator|==
name|bfd_arch_unknown
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bfd_mach_o_scan: unknown architecture 0x%lx/0x%lx\n"
argument_list|,
name|header
operator|->
name|cputype
argument_list|,
name|header
operator|->
name|cpusubtype
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|bfd_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|cputype
argument_list|,
name|cpusubtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
operator|->
name|ncmds
operator|!=
literal|0
condition|)
block|{
name|mdata
operator|->
name|commands
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|header
operator|->
name|ncmds
operator|*
sizeof|sizeof
argument_list|(
name|bfd_mach_o_load_command
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdata
operator|->
name|commands
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|header
operator|->
name|ncmds
condition|;
name|i
operator|++
control|)
block|{
name|bfd_mach_o_load_command
modifier|*
name|cur
init|=
operator|&
name|mdata
operator|->
name|commands
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|cur
operator|->
name|offset
operator|=
literal|28
expr_stmt|;
else|else
block|{
name|bfd_mach_o_load_command
modifier|*
name|prev
init|=
operator|&
name|mdata
operator|->
name|commands
index|[
name|i
operator|-
literal|1
index|]
decl_stmt|;
name|cur
operator|->
name|offset
operator|=
name|prev
operator|->
name|offset
operator|+
name|prev
operator|->
name|len
expr_stmt|;
block|}
if|if
condition|(
name|bfd_mach_o_scan_read_command
argument_list|(
name|abfd
argument_list|,
name|cur
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|bfd_mach_o_scan_start_address
argument_list|(
name|abfd
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|bfd_mach_o_flatten_sections
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|bfd_boolean
name|bfd_mach_o_mkobject
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|bfd_mach_o_data_struct
modifier|*
name|mdata
init|=
name|NULL
decl_stmt|;
name|mdata
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
sizeof|sizeof
argument_list|(
name|bfd_mach_o_data_struct
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdata
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
operator|=
name|mdata
expr_stmt|;
name|mdata
operator|->
name|header
operator|.
name|magic
operator|=
literal|0
expr_stmt|;
name|mdata
operator|->
name|header
operator|.
name|cputype
operator|=
literal|0
expr_stmt|;
name|mdata
operator|->
name|header
operator|.
name|cpusubtype
operator|=
literal|0
expr_stmt|;
name|mdata
operator|->
name|header
operator|.
name|filetype
operator|=
literal|0
expr_stmt|;
name|mdata
operator|->
name|header
operator|.
name|ncmds
operator|=
literal|0
expr_stmt|;
name|mdata
operator|->
name|header
operator|.
name|sizeofcmds
operator|=
literal|0
expr_stmt|;
name|mdata
operator|->
name|header
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|mdata
operator|->
name|header
operator|.
name|byteorder
operator|=
name|BFD_ENDIAN_UNKNOWN
expr_stmt|;
name|mdata
operator|->
name|commands
operator|=
name|NULL
expr_stmt|;
name|mdata
operator|->
name|nsymbols
operator|=
literal|0
expr_stmt|;
name|mdata
operator|->
name|symbols
operator|=
name|NULL
expr_stmt|;
name|mdata
operator|->
name|nsects
operator|=
literal|0
expr_stmt|;
name|mdata
operator|->
name|sections
operator|=
name|NULL
expr_stmt|;
name|mdata
operator|->
name|ibfd
operator|=
name|NULL
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|const
name|bfd_target
modifier|*
name|bfd_mach_o_object_p
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|struct
name|bfd_preserve
name|preserve
decl_stmt|;
name|bfd_mach_o_header
name|header
decl_stmt|;
name|preserve
operator|.
name|marker
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|bfd_mach_o_read_header
argument_list|(
name|abfd
argument_list|,
operator|&
name|header
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|wrong
goto|;
if|if
condition|(
operator|!
operator|(
name|header
operator|.
name|byteorder
operator|==
name|BFD_ENDIAN_BIG
operator|||
name|header
operator|.
name|byteorder
operator|==
name|BFD_ENDIAN_LITTLE
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown header byte-order value 0x%lx\n"
argument_list|,
operator|(
name|long
operator|)
name|header
operator|.
name|byteorder
argument_list|)
expr_stmt|;
goto|goto
name|wrong
goto|;
block|}
if|if
condition|(
operator|!
operator|(
operator|(
name|header
operator|.
name|byteorder
operator|==
name|BFD_ENDIAN_BIG
operator|&&
name|abfd
operator|->
name|xvec
operator|->
name|byteorder
operator|==
name|BFD_ENDIAN_BIG
operator|&&
name|abfd
operator|->
name|xvec
operator|->
name|header_byteorder
operator|==
name|BFD_ENDIAN_BIG
operator|)
operator|||
operator|(
name|header
operator|.
name|byteorder
operator|==
name|BFD_ENDIAN_LITTLE
operator|&&
name|abfd
operator|->
name|xvec
operator|->
name|byteorder
operator|==
name|BFD_ENDIAN_LITTLE
operator|&&
name|abfd
operator|->
name|xvec
operator|->
name|header_byteorder
operator|==
name|BFD_ENDIAN_LITTLE
operator|)
operator|)
condition|)
goto|goto
name|wrong
goto|;
name|preserve
operator|.
name|marker
operator|=
name|bfd_zalloc
argument_list|(
name|abfd
argument_list|,
sizeof|sizeof
argument_list|(
name|bfd_mach_o_data_struct
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|preserve
operator|.
name|marker
operator|==
name|NULL
operator|||
operator|!
name|bfd_preserve_save
argument_list|(
name|abfd
argument_list|,
operator|&
name|preserve
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|bfd_mach_o_scan
argument_list|(
name|abfd
argument_list|,
operator|&
name|header
argument_list|,
operator|(
name|bfd_mach_o_data_struct
operator|*
operator|)
name|preserve
operator|.
name|marker
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|wrong
goto|;
name|bfd_preserve_finish
argument_list|(
name|abfd
argument_list|,
operator|&
name|preserve
argument_list|)
expr_stmt|;
return|return
name|abfd
operator|->
name|xvec
return|;
name|wrong
label|:
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|preserve
operator|.
name|marker
operator|!=
name|NULL
condition|)
name|bfd_preserve_restore
argument_list|(
name|abfd
argument_list|,
operator|&
name|preserve
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|bfd_target
modifier|*
name|bfd_mach_o_core_p
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|struct
name|bfd_preserve
name|preserve
decl_stmt|;
name|bfd_mach_o_header
name|header
decl_stmt|;
name|preserve
operator|.
name|marker
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|bfd_mach_o_read_header
argument_list|(
name|abfd
argument_list|,
operator|&
name|header
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|wrong
goto|;
if|if
condition|(
operator|!
operator|(
name|header
operator|.
name|byteorder
operator|==
name|BFD_ENDIAN_BIG
operator|||
name|header
operator|.
name|byteorder
operator|==
name|BFD_ENDIAN_LITTLE
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown header byte-order value 0x%lx\n"
argument_list|,
operator|(
name|long
operator|)
name|header
operator|.
name|byteorder
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
operator|(
name|header
operator|.
name|byteorder
operator|==
name|BFD_ENDIAN_BIG
operator|&&
name|abfd
operator|->
name|xvec
operator|->
name|byteorder
operator|==
name|BFD_ENDIAN_BIG
operator|&&
name|abfd
operator|->
name|xvec
operator|->
name|header_byteorder
operator|==
name|BFD_ENDIAN_BIG
operator|)
operator|||
operator|(
name|header
operator|.
name|byteorder
operator|==
name|BFD_ENDIAN_LITTLE
operator|&&
name|abfd
operator|->
name|xvec
operator|->
name|byteorder
operator|==
name|BFD_ENDIAN_LITTLE
operator|&&
name|abfd
operator|->
name|xvec
operator|->
name|header_byteorder
operator|==
name|BFD_ENDIAN_LITTLE
operator|)
operator|)
condition|)
goto|goto
name|wrong
goto|;
if|if
condition|(
name|header
operator|.
name|filetype
operator|!=
name|BFD_MACH_O_MH_CORE
condition|)
goto|goto
name|wrong
goto|;
name|preserve
operator|.
name|marker
operator|=
name|bfd_zalloc
argument_list|(
name|abfd
argument_list|,
sizeof|sizeof
argument_list|(
name|bfd_mach_o_data_struct
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|preserve
operator|.
name|marker
operator|==
name|NULL
operator|||
operator|!
name|bfd_preserve_save
argument_list|(
name|abfd
argument_list|,
operator|&
name|preserve
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|bfd_mach_o_scan
argument_list|(
name|abfd
argument_list|,
operator|&
name|header
argument_list|,
operator|(
name|bfd_mach_o_data_struct
operator|*
operator|)
name|preserve
operator|.
name|marker
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|wrong
goto|;
name|bfd_preserve_finish
argument_list|(
name|abfd
argument_list|,
operator|&
name|preserve
argument_list|)
expr_stmt|;
return|return
name|abfd
operator|->
name|xvec
return|;
name|wrong
label|:
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|preserve
operator|.
name|marker
operator|!=
name|NULL
condition|)
name|bfd_preserve_restore
argument_list|(
name|abfd
argument_list|,
operator|&
name|preserve
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|mach_o_fat_archentry
block|{
name|unsigned
name|long
name|cputype
decl_stmt|;
name|unsigned
name|long
name|cpusubtype
decl_stmt|;
name|unsigned
name|long
name|offset
decl_stmt|;
name|unsigned
name|long
name|size
decl_stmt|;
name|unsigned
name|long
name|align
decl_stmt|;
name|bfd
modifier|*
name|abfd
decl_stmt|;
block|}
name|mach_o_fat_archentry
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|mach_o_fat_data_struct
block|{
name|unsigned
name|long
name|magic
decl_stmt|;
name|unsigned
name|long
name|nfat_arch
decl_stmt|;
name|mach_o_fat_archentry
modifier|*
name|archentries
decl_stmt|;
block|}
name|mach_o_fat_data_struct
typedef|;
end_typedef

begin_function
specifier|const
name|bfd_target
modifier|*
name|bfd_mach_o_archive_p
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|mach_o_fat_data_struct
modifier|*
name|adata
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|8
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|8
condition|)
goto|goto
name|error
goto|;
name|adata
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
sizeof|sizeof
argument_list|(
name|mach_o_fat_data_struct
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|adata
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|adata
operator|->
name|magic
operator|=
name|bfd_getb32
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|adata
operator|->
name|nfat_arch
operator|=
name|bfd_getb32
argument_list|(
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|adata
operator|->
name|magic
operator|!=
literal|0xcafebabe
condition|)
goto|goto
name|error
goto|;
name|adata
operator|->
name|archentries
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|adata
operator|->
name|nfat_arch
operator|*
sizeof|sizeof
argument_list|(
name|mach_o_fat_archentry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|adata
operator|->
name|archentries
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|adata
operator|->
name|nfat_arch
condition|;
name|i
operator|++
control|)
block|{
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
literal|8
operator|+
literal|20
operator|*
name|i
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_bread
argument_list|(
operator|(
name|PTR
operator|)
name|buf
argument_list|,
literal|20
argument_list|,
name|abfd
argument_list|)
operator|!=
literal|20
condition|)
goto|goto
name|error
goto|;
name|adata
operator|->
name|archentries
index|[
name|i
index|]
operator|.
name|cputype
operator|=
name|bfd_getb32
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|adata
operator|->
name|archentries
index|[
name|i
index|]
operator|.
name|cpusubtype
operator|=
name|bfd_getb32
argument_list|(
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
name|adata
operator|->
name|archentries
index|[
name|i
index|]
operator|.
name|offset
operator|=
name|bfd_getb32
argument_list|(
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
name|adata
operator|->
name|archentries
index|[
name|i
index|]
operator|.
name|size
operator|=
name|bfd_getb32
argument_list|(
name|buf
operator|+
literal|12
argument_list|)
expr_stmt|;
name|adata
operator|->
name|archentries
index|[
name|i
index|]
operator|.
name|align
operator|=
name|bfd_getb32
argument_list|(
name|buf
operator|+
literal|16
argument_list|)
expr_stmt|;
name|adata
operator|->
name|archentries
index|[
name|i
index|]
operator|.
name|abfd
operator|=
name|NULL
expr_stmt|;
block|}
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_fat_data
operator|=
name|adata
expr_stmt|;
return|return
name|abfd
operator|->
name|xvec
return|;
name|error
label|:
if|if
condition|(
name|adata
operator|!=
name|NULL
condition|)
name|bfd_release
argument_list|(
name|abfd
argument_list|,
name|adata
argument_list|)
expr_stmt|;
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|bfd
modifier|*
name|bfd_mach_o_openr_next_archived_file
parameter_list|(
name|bfd
modifier|*
name|archive
parameter_list|,
name|bfd
modifier|*
name|prev
parameter_list|)
block|{
name|mach_o_fat_data_struct
modifier|*
name|adata
decl_stmt|;
name|mach_o_fat_archentry
modifier|*
name|entry
init|=
name|NULL
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|;
name|adata
operator|=
operator|(
name|mach_o_fat_data_struct
operator|*
operator|)
name|archive
operator|->
name|tdata
operator|.
name|mach_o_fat_data
expr_stmt|;
name|BFD_ASSERT
argument_list|(
name|adata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Find index of previous entry.  */
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
name|i
operator|=
literal|0
expr_stmt|;
comment|/* Start at first one.  */
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|adata
operator|->
name|nfat_arch
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|adata
operator|->
name|archentries
index|[
name|i
index|]
operator|.
name|abfd
operator|==
name|prev
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|adata
operator|->
name|nfat_arch
condition|)
block|{
comment|/* Not found.  */
name|bfd_set_error
argument_list|(
name|bfd_error_bad_value
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|i
operator|++
expr_stmt|;
comment|/* Get next entry.  */
block|}
if|if
condition|(
name|i
operator|>=
name|adata
operator|->
name|nfat_arch
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_no_more_archived_files
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|entry
operator|=
operator|&
name|adata
operator|->
name|archentries
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|abfd
operator|==
name|NULL
condition|)
block|{
name|bfd
modifier|*
name|nbfd
init|=
name|_bfd_new_bfd_contained_in
argument_list|(
name|archive
argument_list|)
decl_stmt|;
name|char
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|nbfd
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|nbfd
operator|->
name|origin
operator|=
name|entry
operator|->
name|offset
expr_stmt|;
name|s
operator|=
name|bfd_malloc
argument_list|(
name|strlen
argument_list|(
name|archive
operator|->
name|filename
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|strcpy
argument_list|(
name|s
argument_list|,
name|archive
operator|->
name|filename
argument_list|)
expr_stmt|;
name|nbfd
operator|->
name|filename
operator|=
name|s
expr_stmt|;
name|nbfd
operator|->
name|iostream
operator|=
name|NULL
expr_stmt|;
name|entry
operator|->
name|abfd
operator|=
name|nbfd
expr_stmt|;
block|}
return|return
name|entry
operator|->
name|abfd
return|;
block|}
end_function

begin_function
name|int
name|bfd_mach_o_lookup_section
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|asection
modifier|*
name|section
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
modifier|*
name|mcommand
parameter_list|,
name|bfd_mach_o_section
modifier|*
modifier|*
name|msection
parameter_list|)
block|{
name|struct
name|mach_o_data_struct
modifier|*
name|md
init|=
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|num
decl_stmt|;
name|bfd_mach_o_load_command
modifier|*
name|ncmd
init|=
name|NULL
decl_stmt|;
name|bfd_mach_o_section
modifier|*
name|nsect
init|=
name|NULL
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|mcommand
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|BFD_ASSERT
argument_list|(
name|msection
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|num
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|md
operator|->
name|header
operator|.
name|ncmds
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|bfd_mach_o_load_command
modifier|*
name|cmd
init|=
operator|&
name|md
operator|->
name|commands
index|[
name|i
index|]
decl_stmt|;
name|struct
name|bfd_mach_o_segment_command
modifier|*
name|seg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|cmd
operator|->
name|type
operator|!=
name|BFD_MACH_O_LC_SEGMENT
condition|)
continue|continue;
name|seg
operator|=
operator|&
name|cmd
operator|->
name|command
operator|.
name|segment
expr_stmt|;
if|if
condition|(
name|seg
operator|->
name|segment
operator|==
name|section
condition|)
block|{
if|if
condition|(
name|num
operator|==
literal|0
condition|)
name|ncmd
operator|=
name|cmd
expr_stmt|;
name|num
operator|++
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|seg
operator|->
name|nsects
condition|;
name|j
operator|++
control|)
block|{
name|struct
name|bfd_mach_o_section
modifier|*
name|sect
init|=
operator|&
name|seg
operator|->
name|sections
index|[
name|j
index|]
decl_stmt|;
if|if
condition|(
name|sect
operator|->
name|bfdsection
operator|==
name|section
condition|)
block|{
if|if
condition|(
name|num
operator|==
literal|0
condition|)
name|nsect
operator|=
name|sect
expr_stmt|;
name|num
operator|++
expr_stmt|;
block|}
block|}
block|}
operator|*
name|mcommand
operator|=
name|ncmd
expr_stmt|;
operator|*
name|msection
operator|=
name|nsect
expr_stmt|;
return|return
name|num
return|;
block|}
end_function

begin_function
name|int
name|bfd_mach_o_lookup_command
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_mach_o_load_command_type
name|type
parameter_list|,
name|bfd_mach_o_load_command
modifier|*
modifier|*
name|mcommand
parameter_list|)
block|{
name|struct
name|mach_o_data_struct
modifier|*
name|md
init|=
name|NULL
decl_stmt|;
name|bfd_mach_o_load_command
modifier|*
name|ncmd
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|num
decl_stmt|;
name|md
operator|=
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
expr_stmt|;
name|BFD_ASSERT
argument_list|(
name|md
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|BFD_ASSERT
argument_list|(
name|mcommand
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|num
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|md
operator|->
name|header
operator|.
name|ncmds
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|bfd_mach_o_load_command
modifier|*
name|cmd
init|=
operator|&
name|md
operator|->
name|commands
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|cmd
operator|->
name|type
operator|!=
name|type
condition|)
continue|continue;
if|if
condition|(
name|num
operator|==
literal|0
condition|)
name|ncmd
operator|=
name|cmd
expr_stmt|;
name|num
operator|++
expr_stmt|;
block|}
operator|*
name|mcommand
operator|=
name|ncmd
expr_stmt|;
return|return
name|num
return|;
block|}
end_function

begin_function
name|unsigned
name|long
name|bfd_mach_o_stack_addr
parameter_list|(
name|enum
name|bfd_mach_o_cpu_type
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|BFD_MACH_O_CPU_TYPE_MC680x0
case|:
return|return
literal|0x04000000
return|;
case|case
name|BFD_MACH_O_CPU_TYPE_MC88000
case|:
return|return
literal|0xffffe000
return|;
case|case
name|BFD_MACH_O_CPU_TYPE_POWERPC
case|:
return|return
literal|0xc0000000
return|;
case|case
name|BFD_MACH_O_CPU_TYPE_I386
case|:
return|return
literal|0xc0000000
return|;
case|case
name|BFD_MACH_O_CPU_TYPE_SPARC
case|:
return|return
literal|0xf0000000
return|;
case|case
name|BFD_MACH_O_CPU_TYPE_I860
case|:
return|return
literal|0
return|;
case|case
name|BFD_MACH_O_CPU_TYPE_HPPA
case|:
return|return
literal|0xc0000000
operator|-
literal|0x04000000
return|;
default|default:
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|int
name|bfd_mach_o_core_fetch_environment
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|rbuf
parameter_list|,
name|unsigned
name|int
modifier|*
name|rlen
parameter_list|)
block|{
name|bfd_mach_o_data_struct
modifier|*
name|mdata
init|=
name|abfd
operator|->
name|tdata
operator|.
name|mach_o_data
decl_stmt|;
name|unsigned
name|long
name|stackaddr
init|=
name|bfd_mach_o_stack_addr
argument_list|(
name|mdata
operator|->
name|header
operator|.
name|cputype
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|i
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mdata
operator|->
name|header
operator|.
name|ncmds
condition|;
name|i
operator|++
control|)
block|{
name|bfd_mach_o_load_command
modifier|*
name|cur
init|=
operator|&
name|mdata
operator|->
name|commands
index|[
name|i
index|]
decl_stmt|;
name|bfd_mach_o_segment_command
modifier|*
name|seg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|cur
operator|->
name|type
operator|!=
name|BFD_MACH_O_LC_SEGMENT
condition|)
continue|continue;
name|seg
operator|=
operator|&
name|cur
operator|->
name|command
operator|.
name|segment
expr_stmt|;
if|if
condition|(
operator|(
name|seg
operator|->
name|vmaddr
operator|+
name|seg
operator|->
name|vmsize
operator|)
operator|==
name|stackaddr
condition|)
block|{
name|unsigned
name|long
name|start
init|=
name|seg
operator|->
name|fileoff
decl_stmt|;
name|unsigned
name|long
name|end
init|=
name|seg
operator|->
name|fileoff
operator|+
name|seg
operator|->
name|filesize
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
init|=
name|bfd_malloc
argument_list|(
literal|1024
argument_list|)
decl_stmt|;
name|unsigned
name|long
name|size
init|=
literal|1024
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|bfd_size_type
name|nread
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|offset
decl_stmt|;
name|int
name|found_nonnull
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|size
operator|>
operator|(
name|end
operator|-
name|start
operator|)
condition|)
name|size
operator|=
operator|(
name|end
operator|-
name|start
operator|)
expr_stmt|;
name|buf
operator|=
name|bfd_realloc
argument_list|(
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|end
operator|-
name|size
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|nread
operator|=
name|bfd_bread
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
name|abfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|nread
operator|!=
name|size
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|offset
operator|=
literal|4
init|;
name|offset
operator|<=
name|size
condition|;
name|offset
operator|+=
literal|4
control|)
block|{
name|unsigned
name|long
name|val
decl_stmt|;
name|val
operator|=
operator|*
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|(
name|buf
operator|+
name|size
operator|-
name|offset
operator|)
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|found_nonnull
condition|)
block|{
if|if
condition|(
name|val
operator|!=
literal|0
condition|)
name|found_nonnull
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|val
operator|==
literal|0x0
condition|)
block|{
name|unsigned
name|long
name|bottom
decl_stmt|;
name|unsigned
name|long
name|top
decl_stmt|;
name|bottom
operator|=
name|seg
operator|->
name|fileoff
operator|+
name|seg
operator|->
name|filesize
operator|-
name|offset
expr_stmt|;
name|top
operator|=
name|seg
operator|->
name|fileoff
operator|+
name|seg
operator|->
name|filesize
operator|-
literal|4
expr_stmt|;
operator|*
name|rbuf
operator|=
name|bfd_malloc
argument_list|(
name|top
operator|-
name|bottom
argument_list|)
expr_stmt|;
operator|*
name|rlen
operator|=
name|top
operator|-
name|bottom
expr_stmt|;
name|memcpy
argument_list|(
operator|*
name|rbuf
argument_list|,
name|buf
operator|+
name|size
operator|-
operator|*
name|rlen
argument_list|,
operator|*
name|rlen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|size
operator|==
operator|(
name|end
operator|-
name|start
operator|)
condition|)
break|break;
name|size
operator|*=
literal|2
expr_stmt|;
block|}
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|bfd_mach_o_core_file_failing_command
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|len
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|ret
operator|=
name|bfd_mach_o_core_fetch_environment
argument_list|(
name|abfd
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
return|return
operator|(
name|char
operator|*
operator|)
name|buf
return|;
block|}
end_function

begin_function
name|int
name|bfd_mach_o_core_file_failing_signal
parameter_list|(
name|bfd
modifier|*
name|abfd
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|TARGET_NAME
value|mach_o_be_vec
end_define

begin_define
define|#
directive|define
name|TARGET_STRING
value|"mach-o-be"
end_define

begin_define
define|#
directive|define
name|TARGET_BIG_ENDIAN
value|1
end_define

begin_define
define|#
directive|define
name|TARGET_ARCHIVE
value|0
end_define

begin_include
include|#
directive|include
file|"mach-o-target.c"
end_include

begin_undef
undef|#
directive|undef
name|TARGET_NAME
end_undef

begin_undef
undef|#
directive|undef
name|TARGET_STRING
end_undef

begin_undef
undef|#
directive|undef
name|TARGET_BIG_ENDIAN
end_undef

begin_undef
undef|#
directive|undef
name|TARGET_ARCHIVE
end_undef

begin_define
define|#
directive|define
name|TARGET_NAME
value|mach_o_le_vec
end_define

begin_define
define|#
directive|define
name|TARGET_STRING
value|"mach-o-le"
end_define

begin_define
define|#
directive|define
name|TARGET_BIG_ENDIAN
value|0
end_define

begin_define
define|#
directive|define
name|TARGET_ARCHIVE
value|0
end_define

begin_include
include|#
directive|include
file|"mach-o-target.c"
end_include

begin_undef
undef|#
directive|undef
name|TARGET_NAME
end_undef

begin_undef
undef|#
directive|undef
name|TARGET_STRING
end_undef

begin_undef
undef|#
directive|undef
name|TARGET_BIG_ENDIAN
end_undef

begin_undef
undef|#
directive|undef
name|TARGET_ARCHIVE
end_undef

begin_define
define|#
directive|define
name|TARGET_NAME
value|mach_o_fat_vec
end_define

begin_define
define|#
directive|define
name|TARGET_STRING
value|"mach-o-fat"
end_define

begin_define
define|#
directive|define
name|TARGET_BIG_ENDIAN
value|1
end_define

begin_define
define|#
directive|define
name|TARGET_ARCHIVE
value|1
end_define

begin_include
include|#
directive|include
file|"mach-o-target.c"
end_include

begin_undef
undef|#
directive|undef
name|TARGET_NAME
end_undef

begin_undef
undef|#
directive|undef
name|TARGET_STRING
end_undef

begin_undef
undef|#
directive|undef
name|TARGET_BIG_ENDIAN
end_undef

begin_undef
undef|#
directive|undef
name|TARGET_ARCHIVE
end_undef

end_unit


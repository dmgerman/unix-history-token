begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1995, 1996, 1997, 1998, and 1999 WIDE Project.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"@(#) pfkey.c $Revision: 1.10 $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/pfkeyv2.h>
end_include

begin_include
include|#
directive|include
file|<netkey/key_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet6/in6.h>
end_include

begin_include
include|#
directive|include
file|<netinet6/ipsec.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|"ipsec_strerror.h"
end_include

begin_define
define|#
directive|define
name|CALLOC
parameter_list|(
name|size
parameter_list|,
name|cast
parameter_list|)
value|(cast)calloc(1, (size))
end_define

begin_decl_stmt
specifier|static
name|int
name|pfkey_send_x1
name|__P
argument_list|(
operator|(
name|int
name|so
operator|,
name|u_int
name|type
operator|,
name|u_int
name|satype
operator|,
name|u_int
name|mode
operator|,
expr|struct
name|sockaddr
operator|*
name|src
operator|,
expr|struct
name|sockaddr
operator|*
name|dst
operator|,
name|u_int32_t
name|spi
operator|,
name|u_int
name|wsize
operator|,
name|caddr_t
name|keymat
operator|,
name|u_int
name|e_type
operator|,
name|u_int
name|e_keylen
operator|,
name|u_int
name|a_type
operator|,
name|u_int
name|a_keylen
operator|,
name|u_int
name|flags
operator|,
name|u_int32_t
name|l_alloc
operator|,
name|u_int32_t
name|l_bytes
operator|,
name|u_int32_t
name|l_addtime
operator|,
name|u_int32_t
name|l_usetime
operator|,
name|u_int32_t
name|seq
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pfkey_send_x2
name|__P
argument_list|(
operator|(
name|int
name|so
operator|,
name|u_int
name|type
operator|,
name|u_int
name|satype
operator|,
name|u_int
name|mode
operator|,
expr|struct
name|sockaddr
operator|*
name|src
operator|,
expr|struct
name|sockaddr
operator|*
name|dst
operator|,
name|u_int32_t
name|spi
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pfkey_send_x3
name|__P
argument_list|(
operator|(
name|int
name|so
operator|,
name|u_int
name|type
operator|,
name|u_int
name|satype
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|caddr_t
name|pfkey_setsadbmsg
name|__P
argument_list|(
operator|(
name|caddr_t
name|buf
operator|,
name|u_int
name|type
operator|,
name|u_int
name|tlen
operator|,
name|u_int
name|satype
operator|,
name|u_int
name|mode
operator|,
name|u_int32_t
name|seq
operator|,
name|pid_t
name|pid
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|caddr_t
name|pfkey_setsadbsa
name|__P
argument_list|(
operator|(
name|caddr_t
name|buf
operator|,
name|u_int32_t
name|spi
operator|,
name|u_int
name|wsize
operator|,
name|u_int
name|auth
operator|,
name|u_int
name|enc
operator|,
name|u_int32_t
name|flags
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|caddr_t
name|pfkey_setsadbaddr
name|__P
argument_list|(
operator|(
name|caddr_t
name|buf
operator|,
name|u_int
name|exttype
operator|,
expr|struct
name|sockaddr
operator|*
name|saddr
operator|,
name|u_int
name|prefixlen
operator|,
name|u_int
name|ul_proto
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|caddr_t
name|pfkey_setsadbkey
parameter_list|(
name|caddr_t
name|buf
parameter_list|,
name|u_int
name|type
parameter_list|,
name|caddr_t
name|key
parameter_list|,
name|u_int
name|keylen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|caddr_t
name|pfkey_setsadblifetime
parameter_list|(
name|caddr_t
name|buf
parameter_list|,
name|u_int
name|type
parameter_list|,
name|u_int32_t
name|l_alloc
parameter_list|,
name|u_int32_t
name|l_bytes
parameter_list|,
name|u_int32_t
name|l_addtime
parameter_list|,
name|u_int32_t
name|l_usetime
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * check key length against algorithm specified.  * supported is either SADB_EXT_SUPPORTED_ENCRYPT or SADB_EXT_SUPPORTED_AUTH.  * Refer to keyv2.h to get more info.  * keylen is the unit of bit.  * OUT:  *	-1: invalid.  *	 0: valid.  */
end_comment

begin_decl_stmt
name|struct
name|sadb_msg
modifier|*
name|ipsec_supported
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ipsec_check_keylen
parameter_list|(
name|supported
parameter_list|,
name|alg_id
parameter_list|,
name|keylen
parameter_list|)
name|u_int
name|supported
decl_stmt|;
name|u_int
name|alg_id
decl_stmt|;
name|u_int
name|keylen
decl_stmt|;
block|{
name|u_int
name|tlen
decl_stmt|;
name|caddr_t
name|p
decl_stmt|;
name|struct
name|sadb_supported
modifier|*
name|sup
decl_stmt|;
name|struct
name|sadb_alg
modifier|*
name|alg
decl_stmt|;
comment|/* validity check */
if|if
condition|(
name|ipsec_supported
operator|==
name|NULL
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_DO_GET_SUPP_LIST
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|supported
condition|)
block|{
case|case
name|SADB_EXT_SUPPORTED_AUTH
case|:
case|case
name|SADB_EXT_SUPPORTED_ENCRYPT
case|:
break|break;
default|default:
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_ARGUMENT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlen
operator|=
name|ipsec_supported
operator|->
name|sadb_msg_len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|caddr_t
operator|)
name|ipsec_supported
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|tlen
operator|>
literal|0
condition|;
name|tlen
operator|-=
name|sup
operator|->
name|sadb_supported_len
operator|,
name|p
operator|+=
name|sup
operator|->
name|sadb_supported_len
control|)
block|{
name|sup
operator|=
operator|(
expr|struct
name|sadb_supported
operator|*
operator|)
name|p
expr_stmt|;
if|if
condition|(
name|sup
operator|->
name|sadb_supported_exttype
operator|!=
name|supported
condition|)
continue|continue;
block|{
name|u_int
name|ttlen
init|=
name|sup
operator|->
name|sadb_supported_len
decl_stmt|;
name|caddr_t
name|pp
init|=
name|p
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|sup
argument_list|)
decl_stmt|;
for|for
control|(
init|;
name|ttlen
operator|>
literal|0
condition|;
name|ttlen
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|alg
argument_list|)
operator|,
name|pp
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|alg
argument_list|)
control|)
block|{
name|alg
operator|=
operator|(
expr|struct
name|sadb_alg
operator|*
operator|)
name|pp
expr_stmt|;
if|if
condition|(
name|alg
operator|->
name|sadb_alg_id
operator|==
name|alg_id
condition|)
goto|goto
name|found
goto|;
block|}
block|}
block|}
name|ipsec_errcode
operator|=
name|EIPSEC_NOT_SUPPORTED
expr_stmt|;
return|return
operator|-
literal|1
return|;
comment|/* NOTREACHED */
name|found
label|:
if|if
condition|(
name|keylen
operator|<
name|alg
operator|->
name|sadb_alg_minbits
operator|||
name|keylen
operator|>
name|alg
operator|->
name|sadb_alg_maxbits
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_KEYLEN
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * set the rate for SOFT lifetime against HARD one.  * If rate is more than 100 or equal to zero, then set to 100.  */
end_comment

begin_decl_stmt
specifier|static
name|u_int
name|soft_lifetime_allocations_rate
init|=
name|PFKEY_SOFT_LIFETIME_RATE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int
name|soft_lifetime_bytes_rate
init|=
name|PFKEY_SOFT_LIFETIME_RATE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int
name|soft_lifetime_addtime_rate
init|=
name|PFKEY_SOFT_LIFETIME_RATE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int
name|soft_lifetime_usetime_rate
init|=
name|PFKEY_SOFT_LIFETIME_RATE
decl_stmt|;
end_decl_stmt

begin_function
name|u_int
name|pfkey_set_softrate
parameter_list|(
name|type
parameter_list|,
name|rate
parameter_list|)
name|u_int
name|type
decl_stmt|,
name|rate
decl_stmt|;
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
if|if
condition|(
name|rate
operator|>
literal|100
operator|||
name|rate
operator|==
literal|0
condition|)
name|rate
operator|=
literal|100
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SADB_X_LIFETIME_ALLOCATIONS
case|:
name|soft_lifetime_allocations_rate
operator|=
name|rate
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SADB_X_LIFETIME_BYTES
case|:
name|soft_lifetime_bytes_rate
operator|=
name|rate
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SADB_X_LIFETIME_ADDTIME
case|:
name|soft_lifetime_addtime_rate
operator|=
name|rate
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SADB_X_LIFETIME_USETIME
case|:
name|soft_lifetime_usetime_rate
operator|=
name|rate
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_ARGUMENT
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * get current rate for SOFT lifetime against HARD one.  * ATTENTION: ~0 is returned if invalid type was passed.  */
end_comment

begin_function
name|u_int
name|pfkey_get_softrate
parameter_list|(
name|type
parameter_list|)
name|u_int
name|type
decl_stmt|;
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SADB_X_LIFETIME_ALLOCATIONS
case|:
return|return
name|soft_lifetime_allocations_rate
return|;
case|case
name|SADB_X_LIFETIME_BYTES
case|:
return|return
name|soft_lifetime_bytes_rate
return|;
case|case
name|SADB_X_LIFETIME_ADDTIME
case|:
return|return
name|soft_lifetime_addtime_rate
return|;
case|case
name|SADB_X_LIFETIME_USETIME
case|:
return|return
name|soft_lifetime_usetime_rate
return|;
block|}
return|return
operator|~
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * sending SADB_GETSPI message to the kernel.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_getspi
parameter_list|(
name|so
parameter_list|,
name|satype
parameter_list|,
name|mode
parameter_list|,
name|src
parameter_list|,
name|dst
parameter_list|,
name|min
parameter_list|,
name|max
parameter_list|,
name|seq
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|satype
decl_stmt|,
name|mode
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_decl_stmt
name|u_int32_t
name|min
decl_stmt|,
name|max
decl_stmt|,
name|seq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|sadb_msg
modifier|*
name|newmsg
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|need_spirange
init|=
literal|0
decl_stmt|;
name|caddr_t
name|p
decl_stmt|;
comment|/* validity check */
if|if
condition|(
name|src
operator|==
name|NULL
operator|||
name|dst
operator|==
name|NULL
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_ARGUMENT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|src
operator|->
name|sa_family
operator|!=
name|dst
operator|->
name|sa_family
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_FAMILY_MISMATCH
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|min
operator|>
name|max
operator|||
operator|(
name|min
operator|>
literal|0
operator|&&
name|min
operator|<=
literal|255
operator|)
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_SPI
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* create new sadb_msg to send. */
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|src
operator|->
name|sa_len
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|dst
operator|->
name|sa_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|min
operator|>
literal|255
operator|&&
name|max
operator|<
operator|~
literal|0
condition|)
block|{
name|need_spirange
operator|++
expr_stmt|;
name|len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_spirange
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|newmsg
operator|=
name|CALLOC
argument_list|(
name|len
argument_list|,
expr|struct
name|sadb_msg
operator|*
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p
operator|=
name|pfkey_setsadbmsg
argument_list|(
operator|(
name|caddr_t
operator|)
name|newmsg
argument_list|,
name|SADB_GETSPI
argument_list|,
name|len
argument_list|,
name|satype
argument_list|,
name|mode
argument_list|,
name|seq
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
comment|/* set sadb_address for source */
name|p
operator|=
name|pfkey_setsadbaddr
argument_list|(
name|p
argument_list|,
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|src
argument_list|,
name|_INALENBYAF
argument_list|(
name|src
operator|->
name|sa_family
argument_list|)
operator|<<
literal|3
argument_list|,
name|IPSEC_ULPROTO_ANY
argument_list|)
expr_stmt|;
comment|/* set sadb_address for destination */
name|p
operator|=
name|pfkey_setsadbaddr
argument_list|(
name|p
argument_list|,
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|dst
argument_list|,
name|_INALENBYAF
argument_list|(
name|dst
operator|->
name|sa_family
argument_list|)
operator|<<
literal|3
argument_list|,
name|IPSEC_ULPROTO_ANY
argument_list|)
expr_stmt|;
comment|/* proccessing spi range */
if|if
condition|(
name|need_spirange
condition|)
block|{
name|int
name|_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_spirange
argument_list|)
decl_stmt|;
define|#
directive|define
name|_SADB_SPIRANGE
parameter_list|(
name|p
parameter_list|)
value|((struct sadb_spirange *)(p))
name|_SADB_SPIRANGE
argument_list|(
name|p
argument_list|)
operator|->
name|sadb_spirange_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|_len
argument_list|)
expr_stmt|;
name|_SADB_SPIRANGE
argument_list|(
name|p
argument_list|)
operator|->
name|sadb_spirange_exttype
operator|=
name|SADB_EXT_SPIRANGE
expr_stmt|;
name|_SADB_SPIRANGE
argument_list|(
name|p
argument_list|)
operator|->
name|sadb_spirange_min
operator|=
name|min
expr_stmt|;
name|_SADB_SPIRANGE
argument_list|(
name|p
argument_list|)
operator|->
name|sadb_spirange_max
operator|=
name|max
expr_stmt|;
undef|#
directive|undef
name|_SADB_SPIRANGE
name|(
name|p
name|)
name|p
operator|+=
name|_len
expr_stmt|;
block|}
comment|/* send message */
name|len
operator|=
name|pfkey_send
argument_list|(
name|so
argument_list|,
name|newmsg
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
name|len
return|;
block|}
end_block

begin_comment
comment|/*  * sending SADB_UPDATE message to the kernel.  * The length of key material is a_keylen + e_keylen.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_update
parameter_list|(
name|so
parameter_list|,
name|satype
parameter_list|,
name|mode
parameter_list|,
name|src
parameter_list|,
name|dst
parameter_list|,
name|spi
parameter_list|,
name|wsize
parameter_list|,
name|keymat
parameter_list|,
name|e_type
parameter_list|,
name|e_keylen
parameter_list|,
name|a_type
parameter_list|,
name|a_keylen
parameter_list|,
name|flags
parameter_list|,
name|l_alloc
parameter_list|,
name|l_bytes
parameter_list|,
name|l_addtime
parameter_list|,
name|l_usetime
parameter_list|,
name|seq
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|satype
decl_stmt|,
name|mode
decl_stmt|,
name|wsize
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_decl_stmt
name|u_int32_t
name|spi
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|keymat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int
name|e_type
decl_stmt|,
name|e_keylen
decl_stmt|,
name|a_type
decl_stmt|,
name|a_keylen
decl_stmt|,
name|flags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int32_t
name|l_alloc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int64_t
name|l_bytes
decl_stmt|,
name|l_addtime
decl_stmt|,
name|l_usetime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int32_t
name|seq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|pfkey_send_x1
argument_list|(
name|so
argument_list|,
name|SADB_UPDATE
argument_list|,
name|satype
argument_list|,
name|mode
argument_list|,
name|src
argument_list|,
name|dst
argument_list|,
name|spi
argument_list|,
name|wsize
argument_list|,
name|keymat
argument_list|,
name|e_type
argument_list|,
name|e_keylen
argument_list|,
name|a_type
argument_list|,
name|a_keylen
argument_list|,
name|flags
argument_list|,
name|l_alloc
argument_list|,
name|l_bytes
argument_list|,
name|l_addtime
argument_list|,
name|l_usetime
argument_list|,
name|seq
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|len
return|;
block|}
end_block

begin_comment
comment|/*  * sending SADB_ADD message to the kernel.  * The length of key material is a_keylen + e_keylen.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_add
parameter_list|(
name|so
parameter_list|,
name|satype
parameter_list|,
name|mode
parameter_list|,
name|src
parameter_list|,
name|dst
parameter_list|,
name|spi
parameter_list|,
name|wsize
parameter_list|,
name|keymat
parameter_list|,
name|e_type
parameter_list|,
name|e_keylen
parameter_list|,
name|a_type
parameter_list|,
name|a_keylen
parameter_list|,
name|flags
parameter_list|,
name|l_alloc
parameter_list|,
name|l_bytes
parameter_list|,
name|l_addtime
parameter_list|,
name|l_usetime
parameter_list|,
name|seq
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|satype
decl_stmt|,
name|mode
decl_stmt|,
name|wsize
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_decl_stmt
name|u_int32_t
name|spi
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|keymat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int
name|e_type
decl_stmt|,
name|e_keylen
decl_stmt|,
name|a_type
decl_stmt|,
name|a_keylen
decl_stmt|,
name|flags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int32_t
name|l_alloc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int64_t
name|l_bytes
decl_stmt|,
name|l_addtime
decl_stmt|,
name|l_usetime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int32_t
name|seq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|pfkey_send_x1
argument_list|(
name|so
argument_list|,
name|SADB_ADD
argument_list|,
name|satype
argument_list|,
name|mode
argument_list|,
name|src
argument_list|,
name|dst
argument_list|,
name|spi
argument_list|,
name|wsize
argument_list|,
name|keymat
argument_list|,
name|e_type
argument_list|,
name|e_keylen
argument_list|,
name|a_type
argument_list|,
name|a_keylen
argument_list|,
name|flags
argument_list|,
name|l_alloc
argument_list|,
name|l_bytes
argument_list|,
name|l_addtime
argument_list|,
name|l_usetime
argument_list|,
name|seq
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|len
return|;
block|}
end_block

begin_comment
comment|/*  * sending SADB_DELETE message to the kernel.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_delete
parameter_list|(
name|so
parameter_list|,
name|satype
parameter_list|,
name|mode
parameter_list|,
name|src
parameter_list|,
name|dst
parameter_list|,
name|spi
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|satype
decl_stmt|,
name|mode
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_decl_stmt
name|u_int32_t
name|spi
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|pfkey_send_x2
argument_list|(
name|so
argument_list|,
name|SADB_DELETE
argument_list|,
name|satype
argument_list|,
name|mode
argument_list|,
name|src
argument_list|,
name|dst
argument_list|,
name|spi
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|len
return|;
block|}
end_block

begin_comment
comment|/*  * sending SADB_GET message to the kernel.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_get
parameter_list|(
name|so
parameter_list|,
name|satype
parameter_list|,
name|mode
parameter_list|,
name|src
parameter_list|,
name|dst
parameter_list|,
name|spi
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|satype
decl_stmt|,
name|mode
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_decl_stmt
name|u_int32_t
name|spi
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|pfkey_send_x2
argument_list|(
name|so
argument_list|,
name|SADB_GET
argument_list|,
name|satype
argument_list|,
name|mode
argument_list|,
name|src
argument_list|,
name|dst
argument_list|,
name|spi
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|len
return|;
block|}
end_block

begin_comment
comment|/*  * sending SADB_REGISTER message to the kernel.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_register
parameter_list|(
name|so
parameter_list|,
name|satype
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|satype
decl_stmt|;
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|pfkey_send_x3
argument_list|(
name|so
argument_list|,
name|SADB_REGISTER
argument_list|,
name|satype
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/*  * receiving SADB_REGISTER message from the kernel, and copy buffer for  * sadb_supported returned into ipsec_supported.  * OUT:  *	 0: success and return length sent.  *	-1: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_recv_register
parameter_list|(
name|so
parameter_list|)
name|int
name|so
decl_stmt|;
block|{
name|pid_t
name|pid
init|=
name|getpid
argument_list|()
decl_stmt|;
name|struct
name|sadb_msg
modifier|*
name|newmsg
decl_stmt|;
name|struct
name|sadb_supported
modifier|*
name|sup
decl_stmt|;
name|caddr_t
name|p
decl_stmt|;
name|int
name|tlen
decl_stmt|;
comment|/* receive message */
do|do
block|{
if|if
condition|(
operator|(
name|newmsg
operator|=
name|pfkey_recv
argument_list|(
name|so
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
do|while
condition|(
name|newmsg
operator|->
name|sadb_msg_type
operator|!=
name|SADB_REGISTER
operator|||
name|newmsg
operator|->
name|sadb_msg_pid
operator|!=
name|pid
condition|)
do|;
comment|/* check and fix */
name|newmsg
operator|->
name|sadb_msg_len
operator|=
name|PFKEY_UNUNIT64
argument_list|(
name|newmsg
operator|->
name|sadb_msg_len
argument_list|)
expr_stmt|;
name|tlen
operator|=
name|newmsg
operator|->
name|sadb_msg_len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|caddr_t
operator|)
name|newmsg
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
expr_stmt|;
while|while
condition|(
name|tlen
operator|>
literal|0
condition|)
block|{
name|sup
operator|=
operator|(
expr|struct
name|sadb_supported
operator|*
operator|)
name|p
expr_stmt|;
switch|switch
condition|(
name|sup
operator|->
name|sadb_supported_exttype
condition|)
block|{
case|case
name|SADB_EXT_SUPPORTED_AUTH
case|:
case|case
name|SADB_EXT_SUPPORTED_ENCRYPT
case|:
name|sup
operator|->
name|sadb_supported_len
operator|=
name|PFKEY_EXTLEN
argument_list|(
name|sup
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_SATYPE
expr_stmt|;
name|free
argument_list|(
name|newmsg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlen
operator|-=
name|sup
operator|->
name|sadb_supported_len
expr_stmt|;
name|p
operator|+=
name|sup
operator|->
name|sadb_supported_len
expr_stmt|;
block|}
if|if
condition|(
name|tlen
operator|<
literal|0
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_SATYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ipsec_supported
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|ipsec_supported
argument_list|)
expr_stmt|;
name|ipsec_supported
operator|=
name|newmsg
expr_stmt|;
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * sending SADB_FLUSH message to the kernel.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_flush
parameter_list|(
name|so
parameter_list|,
name|satype
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|satype
decl_stmt|;
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|pfkey_send_x3
argument_list|(
name|so
argument_list|,
name|SADB_FLUSH
argument_list|,
name|satype
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/*  * sending SADB_DUMP message to the kernel.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_dump
parameter_list|(
name|so
parameter_list|,
name|satype
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|satype
decl_stmt|;
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|pfkey_send_x3
argument_list|(
name|so
argument_list|,
name|SADB_DUMP
argument_list|,
name|satype
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/*  * sending SADB_X_PROMISC message to the kernel.  * NOTE that this function handles promisc mode toggle only.  * IN:  *	flag:	set promisc off if zero, set promisc on if non-zero.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  *	0     : error occured, and set errno.  *	others: a pointer to new allocated buffer in which supported  *	        algorithms is.  */
end_comment

begin_function
name|int
name|pfkey_send_promisc_toggle
parameter_list|(
name|so
parameter_list|,
name|flag
parameter_list|)
name|int
name|so
decl_stmt|;
name|int
name|flag
decl_stmt|;
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|pfkey_send_x3
argument_list|(
name|so
argument_list|,
name|SADB_X_PROMISC
argument_list|,
operator|(
name|flag
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/*  * sending SADB_X_SPDADD message to the kernel.  * The length of key material is a_keylen + e_keylen.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_spdadd
parameter_list|(
name|so
parameter_list|,
name|src
parameter_list|,
name|prefs
parameter_list|,
name|dst
parameter_list|,
name|prefd
parameter_list|,
name|proto
parameter_list|,
name|policy
parameter_list|,
name|policylen
parameter_list|,
name|seq
parameter_list|)
name|int
name|so
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_decl_stmt
name|u_int
name|prefs
decl_stmt|,
name|prefd
decl_stmt|,
name|proto
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|policy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|policylen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int32_t
name|seq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|sadb_msg
modifier|*
name|newmsg
decl_stmt|;
name|int
name|len
decl_stmt|;
name|caddr_t
name|p
decl_stmt|;
comment|/* validity check */
if|if
condition|(
name|src
operator|==
name|NULL
operator|||
name|dst
operator|==
name|NULL
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_ARGUMENT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|src
operator|->
name|sa_family
operator|!=
name|dst
operator|->
name|sa_family
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_FAMILY_MISMATCH
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|prefs
operator|>
operator|(
name|_INALENBYAF
argument_list|(
name|src
operator|->
name|sa_family
argument_list|)
operator|<<
literal|3
operator|)
operator|||
name|prefd
operator|>
operator|(
name|_INALENBYAF
argument_list|(
name|dst
operator|->
name|sa_family
argument_list|)
operator|<<
literal|3
operator|)
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_PREFIXLEN
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* create new sadb_msg to reply. */
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|_SALENBYAF
argument_list|(
name|src
operator|->
name|sa_family
argument_list|)
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|_SALENBYAF
argument_list|(
name|src
operator|->
name|sa_family
argument_list|)
argument_list|)
operator|+
name|policylen
expr_stmt|;
if|if
condition|(
operator|(
name|newmsg
operator|=
name|CALLOC
argument_list|(
name|len
argument_list|,
expr|struct
name|sadb_msg
operator|*
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p
operator|=
name|pfkey_setsadbmsg
argument_list|(
operator|(
name|caddr_t
operator|)
name|newmsg
argument_list|,
name|SADB_X_SPDADD
argument_list|,
name|len
argument_list|,
name|SADB_SATYPE_UNSPEC
argument_list|,
name|IPSEC_MODE_ANY
argument_list|,
name|seq
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadbaddr
argument_list|(
name|p
argument_list|,
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|src
argument_list|,
name|prefs
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadbaddr
argument_list|(
name|p
argument_list|,
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|dst
argument_list|,
name|prefd
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p
argument_list|,
name|policy
argument_list|,
name|policylen
argument_list|)
expr_stmt|;
comment|/* send message */
name|len
operator|=
name|pfkey_send
argument_list|(
name|so
argument_list|,
name|newmsg
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
name|len
return|;
block|}
end_block

begin_comment
comment|/*  * sending SADB_X_SPDDELETE message to the kernel.  * The length of key material is a_keylen + e_keylen.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_spddelete
parameter_list|(
name|so
parameter_list|,
name|src
parameter_list|,
name|prefs
parameter_list|,
name|dst
parameter_list|,
name|prefd
parameter_list|,
name|proto
parameter_list|,
name|seq
parameter_list|)
name|int
name|so
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_decl_stmt
name|u_int
name|prefs
decl_stmt|,
name|prefd
decl_stmt|,
name|proto
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int32_t
name|seq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|sadb_msg
modifier|*
name|newmsg
decl_stmt|;
name|int
name|len
decl_stmt|;
name|caddr_t
name|p
decl_stmt|;
comment|/* validity check */
if|if
condition|(
name|src
operator|==
name|NULL
operator|||
name|dst
operator|==
name|NULL
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_ARGUMENT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|src
operator|->
name|sa_family
operator|!=
name|dst
operator|->
name|sa_family
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_FAMILY_MISMATCH
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|prefs
operator|>
operator|(
name|_INALENBYAF
argument_list|(
name|src
operator|->
name|sa_family
argument_list|)
operator|<<
literal|3
operator|)
operator|||
name|prefd
operator|>
operator|(
name|_INALENBYAF
argument_list|(
name|dst
operator|->
name|sa_family
argument_list|)
operator|<<
literal|3
operator|)
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_PREFIXLEN
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* create new sadb_msg to reply. */
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|_SALENBYAF
argument_list|(
name|src
operator|->
name|sa_family
argument_list|)
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|_SALENBYAF
argument_list|(
name|src
operator|->
name|sa_family
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|newmsg
operator|=
name|CALLOC
argument_list|(
name|len
argument_list|,
expr|struct
name|sadb_msg
operator|*
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p
operator|=
name|pfkey_setsadbmsg
argument_list|(
operator|(
name|caddr_t
operator|)
name|newmsg
argument_list|,
name|SADB_X_SPDDELETE
argument_list|,
name|len
argument_list|,
name|SADB_SATYPE_UNSPEC
argument_list|,
name|IPSEC_MODE_ANY
argument_list|,
name|seq
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadbaddr
argument_list|(
name|p
argument_list|,
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|src
argument_list|,
name|prefs
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadbaddr
argument_list|(
name|p
argument_list|,
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|dst
argument_list|,
name|prefd
argument_list|,
name|proto
argument_list|)
expr_stmt|;
comment|/* send message */
name|len
operator|=
name|pfkey_send
argument_list|(
name|so
argument_list|,
name|newmsg
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
name|len
return|;
block|}
end_block

begin_comment
comment|/*  * sending SADB_SPDFLUSH message to the kernel.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_spdflush
parameter_list|(
name|so
parameter_list|)
name|int
name|so
decl_stmt|;
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|pfkey_send_x3
argument_list|(
name|so
argument_list|,
name|SADB_X_SPDFLUSH
argument_list|,
name|SADB_SATYPE_UNSPEC
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/*  * sending SADB_SPDDUMP message to the kernel.  * OUT:  *	positive: success and return length sent.  *	-1	: error occured, and set errno.  */
end_comment

begin_function
name|int
name|pfkey_send_spddump
parameter_list|(
name|so
parameter_list|)
name|int
name|so
decl_stmt|;
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|pfkey_send_x3
argument_list|(
name|so
argument_list|,
name|SADB_X_SPDDUMP
argument_list|,
name|SADB_SATYPE_UNSPEC
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/* sending SADB_ADD or SADB_UPDATE message to the kernel */
end_comment

begin_function
specifier|static
name|int
name|pfkey_send_x1
parameter_list|(
name|so
parameter_list|,
name|type
parameter_list|,
name|satype
parameter_list|,
name|mode
parameter_list|,
name|src
parameter_list|,
name|dst
parameter_list|,
name|spi
parameter_list|,
name|wsize
parameter_list|,
name|keymat
parameter_list|,
name|e_type
parameter_list|,
name|e_keylen
parameter_list|,
name|a_type
parameter_list|,
name|a_keylen
parameter_list|,
name|flags
parameter_list|,
name|l_alloc
parameter_list|,
name|l_bytes
parameter_list|,
name|l_addtime
parameter_list|,
name|l_usetime
parameter_list|,
name|seq
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|satype
decl_stmt|,
name|mode
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_decl_stmt
name|u_int32_t
name|spi
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int
name|wsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|keymat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int
name|e_type
decl_stmt|,
name|e_keylen
decl_stmt|,
name|a_type
decl_stmt|,
name|a_keylen
decl_stmt|,
name|flags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int32_t
name|l_alloc
decl_stmt|,
name|l_bytes
decl_stmt|,
name|l_addtime
decl_stmt|,
name|l_usetime
decl_stmt|,
name|seq
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|sadb_msg
modifier|*
name|newmsg
decl_stmt|;
name|int
name|len
decl_stmt|;
name|caddr_t
name|p
decl_stmt|;
comment|/* validity check */
if|if
condition|(
name|src
operator|==
name|NULL
operator|||
name|dst
operator|==
name|NULL
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_ARGUMENT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|src
operator|->
name|sa_family
operator|!=
name|dst
operator|->
name|sa_family
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_FAMILY_MISMATCH
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|satype
condition|)
block|{
case|case
name|SADB_SATYPE_ESP
case|:
if|if
condition|(
name|e_type
operator|==
name|SADB_EALG_NONE
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ALGS
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|SADB_SATYPE_AH
case|:
if|if
condition|(
name|e_type
operator|!=
name|SADB_EALG_NONE
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_ALGS
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|a_type
operator|==
name|SADB_AALG_NONE
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ALGS
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|SADB_X_SATYPE_IPCOMP
case|:
break|break;
default|default:
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_SATYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* create new sadb_msg to reply. */
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_sa
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|src
operator|->
name|sa_len
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|dst
operator|->
name|sa_len
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_lifetime
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_lifetime
argument_list|)
expr_stmt|;
if|if
condition|(
name|e_type
operator|!=
name|SADB_EALG_NONE
condition|)
name|len
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_key
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|e_keylen
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|a_type
operator|!=
name|SADB_AALG_NONE
condition|)
name|len
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_key
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|a_keylen
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|newmsg
operator|=
name|CALLOC
argument_list|(
name|len
argument_list|,
expr|struct
name|sadb_msg
operator|*
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p
operator|=
name|pfkey_setsadbmsg
argument_list|(
operator|(
name|caddr_t
operator|)
name|newmsg
argument_list|,
name|type
argument_list|,
name|len
argument_list|,
name|satype
argument_list|,
name|mode
argument_list|,
name|seq
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadbsa
argument_list|(
name|p
argument_list|,
name|spi
argument_list|,
name|wsize
argument_list|,
name|a_type
argument_list|,
name|e_type
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadbaddr
argument_list|(
name|p
argument_list|,
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|src
argument_list|,
name|_INALENBYAF
argument_list|(
name|src
operator|->
name|sa_family
argument_list|)
operator|<<
literal|3
argument_list|,
name|IPSEC_ULPROTO_ANY
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadbaddr
argument_list|(
name|p
argument_list|,
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|dst
argument_list|,
name|_INALENBYAF
argument_list|(
name|dst
operator|->
name|sa_family
argument_list|)
operator|<<
literal|3
argument_list|,
name|IPSEC_ULPROTO_ANY
argument_list|)
expr_stmt|;
if|if
condition|(
name|e_type
operator|!=
name|SADB_EALG_NONE
condition|)
name|p
operator|=
name|pfkey_setsadbkey
argument_list|(
name|p
argument_list|,
name|SADB_EXT_KEY_ENCRYPT
argument_list|,
name|keymat
argument_list|,
name|e_keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|a_type
operator|!=
name|SADB_AALG_NONE
condition|)
name|p
operator|=
name|pfkey_setsadbkey
argument_list|(
name|p
argument_list|,
name|SADB_EXT_KEY_AUTH
argument_list|,
name|keymat
operator|+
name|e_keylen
argument_list|,
name|a_keylen
argument_list|)
expr_stmt|;
comment|/* set sadb_lifetime for destination */
name|p
operator|=
name|pfkey_setsadblifetime
argument_list|(
name|p
argument_list|,
name|SADB_EXT_LIFETIME_HARD
argument_list|,
name|l_alloc
argument_list|,
name|l_bytes
argument_list|,
name|l_addtime
argument_list|,
name|l_usetime
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadblifetime
argument_list|(
name|p
argument_list|,
name|SADB_EXT_LIFETIME_SOFT
argument_list|,
name|l_alloc
argument_list|,
name|l_bytes
argument_list|,
name|l_addtime
argument_list|,
name|l_usetime
argument_list|)
expr_stmt|;
comment|/* send message */
name|len
operator|=
name|pfkey_send
argument_list|(
name|so
argument_list|,
name|newmsg
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
name|len
return|;
block|}
end_block

begin_comment
comment|/* sending SADB_DELETE or SADB_GET message to the kernel */
end_comment

begin_function
specifier|static
name|int
name|pfkey_send_x2
parameter_list|(
name|so
parameter_list|,
name|type
parameter_list|,
name|satype
parameter_list|,
name|mode
parameter_list|,
name|src
parameter_list|,
name|dst
parameter_list|,
name|spi
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|satype
decl_stmt|,
name|mode
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|src
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_decl_stmt
name|u_int32_t
name|spi
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|sadb_msg
modifier|*
name|newmsg
decl_stmt|;
name|int
name|len
decl_stmt|;
name|caddr_t
name|p
decl_stmt|;
comment|/* validity check */
if|if
condition|(
name|src
operator|==
name|NULL
operator|||
name|dst
operator|==
name|NULL
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_ARGUMENT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|src
operator|->
name|sa_family
operator|!=
name|dst
operator|->
name|sa_family
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_FAMILY_MISMATCH
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* create new sadb_msg to reply. */
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_sa
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|src
operator|->
name|sa_len
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|dst
operator|->
name|sa_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|newmsg
operator|=
name|CALLOC
argument_list|(
name|len
argument_list|,
expr|struct
name|sadb_msg
operator|*
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p
operator|=
name|pfkey_setsadbmsg
argument_list|(
operator|(
name|caddr_t
operator|)
name|newmsg
argument_list|,
name|type
argument_list|,
name|len
argument_list|,
name|satype
argument_list|,
name|mode
argument_list|,
literal|0
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadbsa
argument_list|(
name|p
argument_list|,
name|spi
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadbaddr
argument_list|(
name|p
argument_list|,
name|SADB_EXT_ADDRESS_SRC
argument_list|,
name|src
argument_list|,
name|_INALENBYAF
argument_list|(
name|src
operator|->
name|sa_family
argument_list|)
operator|<<
literal|3
argument_list|,
name|IPSEC_ULPROTO_ANY
argument_list|)
expr_stmt|;
name|p
operator|=
name|pfkey_setsadbaddr
argument_list|(
name|p
argument_list|,
name|SADB_EXT_ADDRESS_DST
argument_list|,
name|dst
argument_list|,
name|_INALENBYAF
argument_list|(
name|dst
operator|->
name|sa_family
argument_list|)
operator|<<
literal|3
argument_list|,
name|IPSEC_ULPROTO_ANY
argument_list|)
expr_stmt|;
comment|/* send message */
name|len
operator|=
name|pfkey_send
argument_list|(
name|so
argument_list|,
name|newmsg
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
name|len
return|;
block|}
end_block

begin_comment
comment|/*  * sending SADB_REGISTER, SADB_FLUSH, SADB_DUMP or SADB_X_PROMISC message  * to the kernel  */
end_comment

begin_function
specifier|static
name|int
name|pfkey_send_x3
parameter_list|(
name|so
parameter_list|,
name|type
parameter_list|,
name|satype
parameter_list|)
name|int
name|so
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|satype
decl_stmt|;
block|{
name|struct
name|sadb_msg
modifier|*
name|newmsg
decl_stmt|;
name|int
name|len
decl_stmt|;
comment|/* validity check */
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SADB_X_PROMISC
case|:
if|if
condition|(
name|satype
operator|!=
literal|0
operator|&&
name|satype
operator|!=
literal|1
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_SATYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
break|break;
default|default:
switch|switch
condition|(
name|satype
condition|)
block|{
case|case
name|SADB_SATYPE_UNSPEC
case|:
case|case
name|SADB_SATYPE_AH
case|:
case|case
name|SADB_SATYPE_ESP
case|:
case|case
name|SADB_X_SATYPE_IPCOMP
case|:
break|break;
default|default:
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_SATYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
comment|/* create new sadb_msg to send. */
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|newmsg
operator|=
name|CALLOC
argument_list|(
name|len
argument_list|,
expr|struct
name|sadb_msg
operator|*
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
name|void
operator|)
name|pfkey_setsadbmsg
argument_list|(
operator|(
name|caddr_t
operator|)
name|newmsg
argument_list|,
name|type
argument_list|,
name|len
argument_list|,
name|satype
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
comment|/* send message */
name|len
operator|=
name|pfkey_send
argument_list|(
name|so
argument_list|,
name|newmsg
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/*  * open a socket.  * OUT:  *	-1: fail.  *	others : success and return value of socket.  */
end_comment

begin_function
name|int
name|pfkey_open
parameter_list|()
block|{
name|int
name|so
decl_stmt|;
specifier|const
name|int
name|bufsiz
init|=
literal|128
operator|*
literal|1024
decl_stmt|;
comment|/*is 128K enough?*/
if|if
condition|(
operator|(
name|so
operator|=
name|socket
argument_list|(
name|PF_KEY
argument_list|,
name|SOCK_RAW
argument_list|,
name|PF_KEY_V2
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * This is a temporary workaround for KAME PR 154. 	 * Don't really care even if it fails. 	 */
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|so
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|bufsiz
argument_list|,
sizeof|sizeof
argument_list|(
name|bufsiz
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|so
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|bufsiz
argument_list|,
sizeof|sizeof
argument_list|(
name|bufsiz
argument_list|)
argument_list|)
expr_stmt|;
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
name|so
return|;
block|}
end_function

begin_comment
comment|/*  * close a socket.  * OUT:  *	 0: success.  *	-1: fail.  */
end_comment

begin_function
name|void
name|pfkey_close
parameter_list|(
name|so
parameter_list|)
name|int
name|so
decl_stmt|;
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|so
argument_list|)
expr_stmt|;
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * receive sadb_msg data, and return pointer to new buffer allocated.  * Must free this buffer later.  * OUT:  *	NULL	: error occured.  *	others	: a pointer to sadb_msg structure.  */
end_comment

begin_function
name|struct
name|sadb_msg
modifier|*
name|pfkey_recv
parameter_list|(
name|so
parameter_list|)
name|int
name|so
decl_stmt|;
block|{
name|struct
name|sadb_msg
name|buf
decl_stmt|,
modifier|*
name|newmsg
decl_stmt|;
name|int
name|len
decl_stmt|,
name|reallen
decl_stmt|;
while|while
condition|(
operator|(
name|len
operator|=
name|recv
argument_list|(
name|so
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|MSG_PEEK
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINTR
condition|)
continue|continue;
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|recv
argument_list|(
name|so
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipsec_errcode
operator|=
name|EIPSEC_MAX
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* read real message */
name|reallen
operator|=
name|PFKEY_UNUNIT64
argument_list|(
name|buf
operator|.
name|sadb_msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|newmsg
operator|=
name|CALLOC
argument_list|(
name|reallen
argument_list|,
expr|struct
name|sadb_msg
operator|*
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
while|while
condition|(
operator|(
name|len
operator|=
name|recv
argument_list|(
name|so
argument_list|,
operator|(
name|caddr_t
operator|)
name|newmsg
argument_list|,
name|reallen
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINTR
condition|)
continue|continue;
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newmsg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|len
operator|!=
name|reallen
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_SYSTEM_ERROR
expr_stmt|;
name|free
argument_list|(
name|newmsg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
name|newmsg
return|;
block|}
end_function

begin_comment
comment|/*  * send message to a socket.  * OUT:  *	 others: success and return length sent.  *	-1     : fail.  */
end_comment

begin_function
name|int
name|pfkey_send
parameter_list|(
name|so
parameter_list|,
name|msg
parameter_list|,
name|len
parameter_list|)
name|int
name|so
decl_stmt|;
name|struct
name|sadb_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
if|if
condition|(
operator|(
name|len
operator|=
name|send
argument_list|(
name|so
argument_list|,
operator|(
name|caddr_t
operator|)
name|msg
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ipsec_set_strerror
argument_list|(
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/*  * %%% Utilities  * NOTE: These functions are derived from netkey/key.c in KAME.  */
end_comment

begin_comment
comment|/*  * set the pointer to each header in this message buffer.  * IN:	msg: pointer to message buffer.  *	mhp: pointer to the buffer initialized like below:  *		caddr_t mhp[SADB_EXT_MAX + 1];  * OUT:	-1: invalid.  *	 0: valid.  */
end_comment

begin_function
name|int
name|pfkey_align
parameter_list|(
name|msg
parameter_list|,
name|mhp
parameter_list|)
name|struct
name|sadb_msg
modifier|*
name|msg
decl_stmt|;
name|caddr_t
modifier|*
name|mhp
decl_stmt|;
block|{
name|struct
name|sadb_ext
modifier|*
name|ext
decl_stmt|;
name|int
name|tlen
decl_stmt|,
name|extlen
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* validity check */
if|if
condition|(
name|msg
operator|==
name|NULL
operator|||
name|mhp
operator|==
name|NULL
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_ARGUMENT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* initialize */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SADB_EXT_MAX
operator|+
literal|1
condition|;
name|i
operator|++
control|)
name|mhp
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|mhp
index|[
literal|0
index|]
operator|=
operator|(
name|caddr_t
operator|)
name|msg
expr_stmt|;
name|tlen
operator|=
name|PFKEY_UNUNIT64
argument_list|(
name|msg
operator|->
name|sadb_msg_len
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
expr_stmt|;
name|ext
operator|=
operator|(
expr|struct
name|sadb_ext
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|msg
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_msg
argument_list|)
operator|)
expr_stmt|;
while|while
condition|(
name|tlen
operator|>
literal|0
condition|)
block|{
comment|/* duplicate check */
comment|/* XXX Are there duplication either KEY_AUTH or KEY_ENCRYPT ?*/
if|if
condition|(
name|mhp
index|[
name|ext
operator|->
name|sadb_ext_type
index|]
operator|!=
name|NULL
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_EXTTYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* set pointer */
switch|switch
condition|(
name|ext
operator|->
name|sadb_ext_type
condition|)
block|{
case|case
name|SADB_EXT_SA
case|:
case|case
name|SADB_EXT_LIFETIME_CURRENT
case|:
case|case
name|SADB_EXT_LIFETIME_HARD
case|:
case|case
name|SADB_EXT_LIFETIME_SOFT
case|:
case|case
name|SADB_EXT_ADDRESS_SRC
case|:
case|case
name|SADB_EXT_ADDRESS_DST
case|:
case|case
name|SADB_EXT_ADDRESS_PROXY
case|:
case|case
name|SADB_EXT_KEY_AUTH
case|:
comment|/* XXX should to be check weak keys. */
case|case
name|SADB_EXT_KEY_ENCRYPT
case|:
comment|/* XXX should to be check weak keys. */
case|case
name|SADB_EXT_IDENTITY_SRC
case|:
case|case
name|SADB_EXT_IDENTITY_DST
case|:
case|case
name|SADB_EXT_SENSITIVITY
case|:
case|case
name|SADB_EXT_PROPOSAL
case|:
case|case
name|SADB_EXT_SUPPORTED_AUTH
case|:
case|case
name|SADB_EXT_SUPPORTED_ENCRYPT
case|:
case|case
name|SADB_EXT_SPIRANGE
case|:
case|case
name|SADB_X_EXT_POLICY
case|:
name|mhp
index|[
name|ext
operator|->
name|sadb_ext_type
index|]
operator|=
operator|(
name|caddr_t
operator|)
name|ext
expr_stmt|;
break|break;
default|default:
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_EXTTYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|extlen
operator|=
name|PFKEY_EXTLEN
argument_list|(
name|ext
argument_list|)
expr_stmt|;
name|tlen
operator|-=
name|extlen
expr_stmt|;
name|ext
operator|=
operator|(
expr|struct
name|sadb_ext
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ext
operator|+
name|extlen
operator|)
expr_stmt|;
block|}
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * check basic usage for sadb_msg,  * NOTE: This routine is derived from netkey/key.c in KAME.  * IN:	msg: pointer to message buffer.  *	mhp: pointer to the buffer initialized like below:  *  *		caddr_t mhp[SADB_EXT_MAX + 1];  *  * OUT:	-1: invalid.  *	 0: valid.  */
end_comment

begin_function
name|int
name|pfkey_check
parameter_list|(
name|mhp
parameter_list|)
name|caddr_t
modifier|*
name|mhp
decl_stmt|;
block|{
name|struct
name|sadb_msg
modifier|*
name|msg
decl_stmt|;
comment|/* validity check */
if|if
condition|(
name|mhp
operator|==
name|NULL
operator|||
name|mhp
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_ARGUMENT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|=
operator|(
expr|struct
name|sadb_msg
operator|*
operator|)
name|mhp
index|[
literal|0
index|]
expr_stmt|;
comment|/* check version */
if|if
condition|(
name|msg
operator|->
name|sadb_msg_version
operator|!=
name|PF_KEY_V2
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_VERSION
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* check type */
if|if
condition|(
name|msg
operator|->
name|sadb_msg_type
operator|>
name|SADB_MAX
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_MSGTYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* check SA type */
switch|switch
condition|(
name|msg
operator|->
name|sadb_msg_satype
condition|)
block|{
case|case
name|SADB_SATYPE_UNSPEC
case|:
switch|switch
condition|(
name|msg
operator|->
name|sadb_msg_type
condition|)
block|{
case|case
name|SADB_GETSPI
case|:
case|case
name|SADB_UPDATE
case|:
case|case
name|SADB_ADD
case|:
case|case
name|SADB_DELETE
case|:
case|case
name|SADB_GET
case|:
case|case
name|SADB_ACQUIRE
case|:
case|case
name|SADB_EXPIRE
case|:
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_SATYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|SADB_SATYPE_ESP
case|:
case|case
name|SADB_SATYPE_AH
case|:
case|case
name|SADB_X_SATYPE_IPCOMP
case|:
switch|switch
condition|(
name|msg
operator|->
name|sadb_msg_type
condition|)
block|{
case|case
name|SADB_X_SPDADD
case|:
case|case
name|SADB_X_SPDDELETE
case|:
case|case
name|SADB_X_SPDGET
case|:
case|case
name|SADB_X_SPDDUMP
case|:
case|case
name|SADB_X_SPDFLUSH
case|:
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_SATYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|SADB_SATYPE_RSVP
case|:
case|case
name|SADB_SATYPE_OSPFV2
case|:
case|case
name|SADB_SATYPE_RIPV2
case|:
case|case
name|SADB_SATYPE_MIP
case|:
name|ipsec_errcode
operator|=
name|EIPSEC_NOT_SUPPORTED
expr_stmt|;
return|return
operator|-
literal|1
return|;
case|case
literal|1
case|:
comment|/* XXX: What does it do ? */
if|if
condition|(
name|msg
operator|->
name|sadb_msg_type
operator|==
name|SADB_X_PROMISC
condition|)
break|break;
comment|/*FALLTHROUGH*/
default|default:
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_SATYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* check field of upper layer protocol and address family */
if|if
condition|(
name|mhp
index|[
name|SADB_EXT_ADDRESS_SRC
index|]
operator|!=
name|NULL
operator|&&
name|mhp
index|[
name|SADB_EXT_ADDRESS_DST
index|]
operator|!=
name|NULL
condition|)
block|{
name|struct
name|sadb_address
modifier|*
name|src0
decl_stmt|,
modifier|*
name|dst0
decl_stmt|;
name|src0
operator|=
operator|(
expr|struct
name|sadb_address
operator|*
operator|)
operator|(
name|mhp
index|[
name|SADB_EXT_ADDRESS_SRC
index|]
operator|)
expr_stmt|;
name|dst0
operator|=
operator|(
expr|struct
name|sadb_address
operator|*
operator|)
operator|(
name|mhp
index|[
name|SADB_EXT_ADDRESS_DST
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|src0
operator|->
name|sadb_address_proto
operator|!=
name|dst0
operator|->
name|sadb_address_proto
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_PROTO_MISMATCH
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|PFKEY_ADDR_SADDR
argument_list|(
name|src0
argument_list|)
operator|->
name|sa_family
operator|!=
name|PFKEY_ADDR_SADDR
argument_list|(
name|dst0
argument_list|)
operator|->
name|sa_family
condition|)
block|{
name|ipsec_errcode
operator|=
name|EIPSEC_FAMILY_MISMATCH
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|PFKEY_ADDR_SADDR
argument_list|(
name|src0
argument_list|)
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
case|case
name|AF_INET6
case|:
break|break;
default|default:
name|ipsec_errcode
operator|=
name|EIPSEC_INVAL_FAMILY
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 		 * prefixlen == 0 is valid because there must be the case 		 * all addresses are matched. 		 */
block|}
name|ipsec_errcode
operator|=
name|EIPSEC_NO_ERROR
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * set data into sadb_msg.  * `buf' must has been allocated sufficiently.  */
end_comment

begin_function
specifier|static
name|caddr_t
name|pfkey_setsadbmsg
parameter_list|(
name|buf
parameter_list|,
name|type
parameter_list|,
name|tlen
parameter_list|,
name|satype
parameter_list|,
name|mode
parameter_list|,
name|seq
parameter_list|,
name|pid
parameter_list|)
name|caddr_t
name|buf
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|satype
decl_stmt|,
name|mode
decl_stmt|;
name|u_int
name|tlen
decl_stmt|;
name|u_int32_t
name|seq
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
block|{
name|struct
name|sadb_msg
modifier|*
name|p
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|sadb_msg
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_sa
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|sadb_msg_version
operator|=
name|PF_KEY_V2
expr_stmt|;
name|p
operator|->
name|sadb_msg_type
operator|=
name|type
expr_stmt|;
name|p
operator|->
name|sadb_msg_errno
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|sadb_msg_satype
operator|=
name|satype
expr_stmt|;
name|p
operator|->
name|sadb_msg_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|tlen
argument_list|)
expr_stmt|;
name|p
operator|->
name|sadb_msg_mode
operator|=
name|mode
expr_stmt|;
name|p
operator|->
name|sadb_msg_reserved
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|sadb_msg_seq
operator|=
name|seq
expr_stmt|;
name|p
operator|->
name|sadb_msg_pid
operator|=
operator|(
name|u_int32_t
operator|)
name|pid
expr_stmt|;
return|return
operator|(
name|buf
operator|+
name|len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * copy secasvar data into sadb_address.  * `buf' must has been allocated sufficiently.  */
end_comment

begin_function
specifier|static
name|caddr_t
name|pfkey_setsadbsa
parameter_list|(
name|buf
parameter_list|,
name|spi
parameter_list|,
name|wsize
parameter_list|,
name|auth
parameter_list|,
name|enc
parameter_list|,
name|flags
parameter_list|)
name|caddr_t
name|buf
decl_stmt|;
name|u_int32_t
name|spi
decl_stmt|,
name|flags
decl_stmt|;
name|u_int
name|wsize
decl_stmt|,
name|auth
decl_stmt|,
name|enc
decl_stmt|;
block|{
name|struct
name|sadb_sa
modifier|*
name|p
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|sadb_sa
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_sa
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|sadb_sa_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|sadb_sa_exttype
operator|=
name|SADB_EXT_SA
expr_stmt|;
name|p
operator|->
name|sadb_sa_spi
operator|=
name|spi
expr_stmt|;
name|p
operator|->
name|sadb_sa_replay
operator|=
name|wsize
expr_stmt|;
name|p
operator|->
name|sadb_sa_state
operator|=
name|SADB_SASTATE_LARVAL
expr_stmt|;
name|p
operator|->
name|sadb_sa_auth
operator|=
name|auth
expr_stmt|;
name|p
operator|->
name|sadb_sa_encrypt
operator|=
name|enc
expr_stmt|;
name|p
operator|->
name|sadb_sa_flags
operator|=
name|flags
expr_stmt|;
return|return
operator|(
name|buf
operator|+
name|len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * set data into sadb_address.  * `buf' must has been allocated sufficiently.  * prefixlen is in bits.  */
end_comment

begin_function
specifier|static
name|caddr_t
name|pfkey_setsadbaddr
parameter_list|(
name|buf
parameter_list|,
name|exttype
parameter_list|,
name|saddr
parameter_list|,
name|prefixlen
parameter_list|,
name|ul_proto
parameter_list|)
name|caddr_t
name|buf
decl_stmt|;
name|u_int
name|exttype
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|saddr
decl_stmt|;
name|u_int
name|prefixlen
decl_stmt|;
name|u_int
name|ul_proto
decl_stmt|;
block|{
name|struct
name|sadb_address
modifier|*
name|p
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|sadb_address
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_address
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|saddr
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|sadb_address_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|sadb_address_exttype
operator|=
name|exttype
operator|&
literal|0xffff
expr_stmt|;
name|p
operator|->
name|sadb_address_proto
operator|=
name|ul_proto
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|sadb_address_prefixlen
operator|=
name|prefixlen
expr_stmt|;
name|p
operator|->
name|sadb_address_reserved
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|p
operator|+
literal|1
argument_list|,
name|saddr
argument_list|,
name|saddr
operator|->
name|sa_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|+
name|len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * set sadb_key structure after clearing buffer with zero.  * OUT: the pointer of buf + len.  */
end_comment

begin_function
specifier|static
name|caddr_t
name|pfkey_setsadbkey
parameter_list|(
name|buf
parameter_list|,
name|type
parameter_list|,
name|key
parameter_list|,
name|keylen
parameter_list|)
name|caddr_t
name|buf
decl_stmt|,
name|key
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|keylen
decl_stmt|;
block|{
name|struct
name|sadb_key
modifier|*
name|p
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|sadb_key
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_key
argument_list|)
operator|+
name|PFKEY_ALIGN8
argument_list|(
name|keylen
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|sadb_key_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|sadb_key_exttype
operator|=
name|type
expr_stmt|;
name|p
operator|->
name|sadb_key_bits
operator|=
name|keylen
operator|<<
literal|3
expr_stmt|;
name|p
operator|->
name|sadb_key_reserved
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|p
operator|+
literal|1
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
expr_stmt|;
return|return
name|buf
operator|+
name|len
return|;
block|}
end_function

begin_comment
comment|/*  * set sadb_lifetime structure after clearing buffer with zero.  * OUT: the pointer of buf + len.  */
end_comment

begin_function
specifier|static
name|caddr_t
name|pfkey_setsadblifetime
parameter_list|(
name|buf
parameter_list|,
name|type
parameter_list|,
name|l_alloc
parameter_list|,
name|l_bytes
parameter_list|,
name|l_addtime
parameter_list|,
name|l_usetime
parameter_list|)
name|caddr_t
name|buf
decl_stmt|;
name|u_int
name|type
decl_stmt|;
name|u_int32_t
name|l_alloc
decl_stmt|,
name|l_bytes
decl_stmt|,
name|l_addtime
decl_stmt|,
name|l_usetime
decl_stmt|;
block|{
name|struct
name|sadb_lifetime
modifier|*
name|p
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|sadb_lifetime
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sadb_lifetime
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|sadb_lifetime_len
operator|=
name|PFKEY_UNIT64
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|sadb_lifetime_exttype
operator|=
name|type
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SADB_EXT_LIFETIME_SOFT
case|:
name|p
operator|->
name|sadb_lifetime_allocations
operator|=
operator|(
name|l_alloc
operator|*
name|soft_lifetime_allocations_rate
operator|)
operator|/
literal|100
expr_stmt|;
name|p
operator|->
name|sadb_lifetime_bytes
operator|=
operator|(
operator|(
name|l_bytes
operator|*
name|soft_lifetime_bytes_rate
operator|)
operator|/
literal|100
operator|)
operator|<<
literal|10
expr_stmt|;
name|p
operator|->
name|sadb_lifetime_addtime
operator|=
operator|(
name|l_addtime
operator|*
name|soft_lifetime_addtime_rate
operator|)
operator|/
literal|100
expr_stmt|;
name|p
operator|->
name|sadb_lifetime_usetime
operator|=
operator|(
name|l_usetime
operator|*
name|soft_lifetime_usetime_rate
operator|)
operator|/
literal|100
expr_stmt|;
break|break;
case|case
name|SADB_EXT_LIFETIME_HARD
case|:
name|p
operator|->
name|sadb_lifetime_allocations
operator|=
name|l_alloc
expr_stmt|;
name|p
operator|->
name|sadb_lifetime_bytes
operator|=
name|l_bytes
operator|<<
literal|10
expr_stmt|;
name|p
operator|->
name|sadb_lifetime_addtime
operator|=
name|l_addtime
expr_stmt|;
name|p
operator|->
name|sadb_lifetime_usetime
operator|=
name|l_usetime
expr_stmt|;
break|break;
block|}
return|return
name|buf
operator|+
name|len
return|;
block|}
end_function

end_unit


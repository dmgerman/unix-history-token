begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//===- ARMBaseInstrInfo.h - ARM Base Instruction Information -------------*- C++ -*-===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file contains the Base ARM implementation of the TargetInstrInfo class.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|ARMBASEINSTRUCTIONINFO_H
end_ifndef

begin_define
define|#
directive|define
name|ARMBASEINSTRUCTIONINFO_H
end_define

begin_include
include|#
directive|include
file|"ARM.h"
end_include

begin_include
include|#
directive|include
file|"ARMRegisterInfo.h"
end_include

begin_include
include|#
directive|include
file|"llvm/CodeGen/MachineInstrBuilder.h"
end_include

begin_include
include|#
directive|include
file|"llvm/Target/TargetInstrInfo.h"
end_include

begin_decl_stmt
name|namespace
name|llvm
block|{
comment|/// ARMII - This namespace holds all of the target specific flags that
comment|/// instruction info tracks.
comment|///
name|namespace
name|ARMII
block|{
enum|enum
block|{
comment|//===------------------------------------------------------------------===//
comment|// Instruction Flags.
comment|//===------------------------------------------------------------------===//
comment|// This four-bit field describes the addressing mode used.
name|AddrModeMask
init|=
literal|0xf
block|,
name|AddrModeNone
init|=
literal|0
block|,
name|AddrMode1
init|=
literal|1
block|,
name|AddrMode2
init|=
literal|2
block|,
name|AddrMode3
init|=
literal|3
block|,
name|AddrMode4
init|=
literal|4
block|,
name|AddrMode5
init|=
literal|5
block|,
name|AddrMode6
init|=
literal|6
block|,
name|AddrModeT1_1
init|=
literal|7
block|,
name|AddrModeT1_2
init|=
literal|8
block|,
name|AddrModeT1_4
init|=
literal|9
block|,
name|AddrModeT1_s
init|=
literal|10
block|,
comment|// i8 * 4 for pc and sp relative data
name|AddrModeT2_i12
init|=
literal|11
block|,
name|AddrModeT2_i8
init|=
literal|12
block|,
name|AddrModeT2_so
init|=
literal|13
block|,
name|AddrModeT2_pc
init|=
literal|14
block|,
comment|// +/- i12 for pc relative data
name|AddrModeT2_i8s4
init|=
literal|15
block|,
comment|// i8 * 4
comment|// Size* - Flags to keep track of the size of an instruction.
name|SizeShift
init|=
literal|4
block|,
name|SizeMask
init|=
literal|7
operator|<<
name|SizeShift
block|,
name|SizeSpecial
init|=
literal|1
block|,
comment|// 0 byte pseudo or special case.
name|Size8Bytes
init|=
literal|2
block|,
name|Size4Bytes
init|=
literal|3
block|,
name|Size2Bytes
init|=
literal|4
block|,
comment|// IndexMode - Unindex, pre-indexed, or post-indexed. Only valid for load
comment|// and store ops
name|IndexModeShift
init|=
literal|7
block|,
name|IndexModeMask
init|=
literal|3
operator|<<
name|IndexModeShift
block|,
name|IndexModePre
init|=
literal|1
block|,
name|IndexModePost
init|=
literal|2
block|,
comment|//===------------------------------------------------------------------===//
comment|// Instruction encoding formats.
comment|//
name|FormShift
init|=
literal|9
block|,
name|FormMask
init|=
literal|0x3f
operator|<<
name|FormShift
block|,
comment|// Pseudo instructions
name|Pseudo
init|=
literal|0
operator|<<
name|FormShift
block|,
comment|// Multiply instructions
name|MulFrm
init|=
literal|1
operator|<<
name|FormShift
block|,
comment|// Branch instructions
name|BrFrm
init|=
literal|2
operator|<<
name|FormShift
block|,
name|BrMiscFrm
init|=
literal|3
operator|<<
name|FormShift
block|,
comment|// Data Processing instructions
name|DPFrm
init|=
literal|4
operator|<<
name|FormShift
block|,
name|DPSoRegFrm
init|=
literal|5
operator|<<
name|FormShift
block|,
comment|// Load and Store
name|LdFrm
init|=
literal|6
operator|<<
name|FormShift
block|,
name|StFrm
init|=
literal|7
operator|<<
name|FormShift
block|,
name|LdMiscFrm
init|=
literal|8
operator|<<
name|FormShift
block|,
name|StMiscFrm
init|=
literal|9
operator|<<
name|FormShift
block|,
name|LdStMulFrm
init|=
literal|10
operator|<<
name|FormShift
block|,
comment|// Miscellaneous arithmetic instructions
name|ArithMiscFrm
init|=
literal|11
operator|<<
name|FormShift
block|,
comment|// Extend instructions
name|ExtFrm
init|=
literal|12
operator|<<
name|FormShift
block|,
comment|// VFP formats
name|VFPUnaryFrm
init|=
literal|13
operator|<<
name|FormShift
block|,
name|VFPBinaryFrm
init|=
literal|14
operator|<<
name|FormShift
block|,
name|VFPConv1Frm
init|=
literal|15
operator|<<
name|FormShift
block|,
name|VFPConv2Frm
init|=
literal|16
operator|<<
name|FormShift
block|,
name|VFPConv3Frm
init|=
literal|17
operator|<<
name|FormShift
block|,
name|VFPConv4Frm
init|=
literal|18
operator|<<
name|FormShift
block|,
name|VFPConv5Frm
init|=
literal|19
operator|<<
name|FormShift
block|,
name|VFPLdStFrm
init|=
literal|20
operator|<<
name|FormShift
block|,
name|VFPLdStMulFrm
init|=
literal|21
operator|<<
name|FormShift
block|,
name|VFPMiscFrm
init|=
literal|22
operator|<<
name|FormShift
block|,
comment|// Thumb format
name|ThumbFrm
init|=
literal|23
operator|<<
name|FormShift
block|,
comment|// NEON format
name|NEONFrm
init|=
literal|24
operator|<<
name|FormShift
block|,
name|NEONGetLnFrm
init|=
literal|25
operator|<<
name|FormShift
block|,
name|NEONSetLnFrm
init|=
literal|26
operator|<<
name|FormShift
block|,
name|NEONDupFrm
init|=
literal|27
operator|<<
name|FormShift
block|,
comment|//===------------------------------------------------------------------===//
comment|// Misc flags.
comment|// UnaryDP - Indicates this is a unary data processing instruction, i.e.
comment|// it doesn't have a Rn operand.
name|UnaryDP
init|=
literal|1
operator|<<
literal|15
block|,
comment|// Xform16Bit - Indicates this Thumb2 instruction may be transformed into
comment|// a 16-bit Thumb instruction if certain conditions are met.
name|Xform16Bit
init|=
literal|1
operator|<<
literal|16
block|,
comment|//===------------------------------------------------------------------===//
comment|// Code domain.
name|DomainShift
init|=
literal|17
block|,
name|DomainMask
init|=
literal|3
operator|<<
name|DomainShift
block|,
name|DomainGeneral
init|=
literal|0
operator|<<
name|DomainShift
block|,
name|DomainVFP
init|=
literal|1
operator|<<
name|DomainShift
block|,
name|DomainNEON
init|=
literal|2
operator|<<
name|DomainShift
block|,
comment|//===------------------------------------------------------------------===//
comment|// Field shifts - such shifts are used to set field while generating
comment|// machine instructions.
name|M_BitShift
init|=
literal|5
block|,
name|ShiftImmShift
init|=
literal|5
block|,
name|ShiftShift
init|=
literal|7
block|,
name|N_BitShift
init|=
literal|7
block|,
name|ImmHiShift
init|=
literal|8
block|,
name|SoRotImmShift
init|=
literal|8
block|,
name|RegRsShift
init|=
literal|8
block|,
name|ExtRotImmShift
init|=
literal|10
block|,
name|RegRdLoShift
init|=
literal|12
block|,
name|RegRdShift
init|=
literal|12
block|,
name|RegRdHiShift
init|=
literal|16
block|,
name|RegRnShift
init|=
literal|16
block|,
name|S_BitShift
init|=
literal|20
block|,
name|W_BitShift
init|=
literal|21
block|,
name|AM3_I_BitShift
init|=
literal|22
block|,
name|D_BitShift
init|=
literal|22
block|,
name|U_BitShift
init|=
literal|23
block|,
name|P_BitShift
init|=
literal|24
block|,
name|I_BitShift
init|=
literal|25
block|,
name|CondShift
init|=
literal|28
block|}
enum|;
block|}
name|class
name|ARMBaseInstrInfo
range|:
name|public
name|TargetInstrInfoImpl
block|{
specifier|const
name|ARMSubtarget
operator|&
name|Subtarget
block|;
name|protected
operator|:
comment|// Can be only subclassed.
name|explicit
name|ARMBaseInstrInfo
argument_list|(
specifier|const
name|ARMSubtarget
operator|&
name|STI
argument_list|)
block|;
name|public
operator|:
comment|// Return the non-pre/post incrementing version of 'Opc'. Return 0
comment|// if there is not such an opcode.
name|virtual
name|unsigned
name|getUnindexedOpcode
argument_list|(
argument|unsigned Opc
argument_list|)
specifier|const
operator|=
literal|0
block|;
comment|// Return true if the block does not fall through.
name|virtual
name|bool
name|BlockHasNoFallThrough
argument_list|(
argument|const MachineBasicBlock&MBB
argument_list|)
specifier|const
operator|=
literal|0
block|;
name|virtual
name|MachineInstr
operator|*
name|convertToThreeAddress
argument_list|(
argument|MachineFunction::iterator&MFI
argument_list|,
argument|MachineBasicBlock::iterator&MBBI
argument_list|,
argument|LiveVariables *LV
argument_list|)
specifier|const
block|;
name|virtual
specifier|const
name|ARMBaseRegisterInfo
operator|&
name|getRegisterInfo
argument_list|()
specifier|const
operator|=
literal|0
block|;
specifier|const
name|ARMSubtarget
operator|&
name|getSubtarget
argument_list|()
specifier|const
block|{
return|return
name|Subtarget
return|;
block|}
comment|// Branch analysis.
name|virtual
name|bool
name|AnalyzeBranch
argument_list|(
argument|MachineBasicBlock&MBB
argument_list|,
argument|MachineBasicBlock *&TBB
argument_list|,
argument|MachineBasicBlock *&FBB
argument_list|,
argument|SmallVectorImpl<MachineOperand>&Cond
argument_list|,
argument|bool AllowModify
argument_list|)
specifier|const
block|;
name|virtual
name|unsigned
name|RemoveBranch
argument_list|(
argument|MachineBasicBlock&MBB
argument_list|)
specifier|const
block|;
name|virtual
name|unsigned
name|InsertBranch
argument_list|(
argument|MachineBasicBlock&MBB
argument_list|,
argument|MachineBasicBlock *TBB
argument_list|,
argument|MachineBasicBlock *FBB
argument_list|,
argument|const SmallVectorImpl<MachineOperand>&Cond
argument_list|)
specifier|const
block|;
name|virtual
name|bool
name|ReverseBranchCondition
argument_list|(
argument|SmallVectorImpl<MachineOperand>&Cond
argument_list|)
specifier|const
block|;
comment|// Predication support.
name|bool
name|isPredicated
argument_list|(
argument|const MachineInstr *MI
argument_list|)
specifier|const
block|{
name|int
name|PIdx
operator|=
name|MI
operator|->
name|findFirstPredOperandIdx
argument_list|()
block|;
return|return
name|PIdx
operator|!=
operator|-
literal|1
operator|&&
name|MI
operator|->
name|getOperand
argument_list|(
name|PIdx
argument_list|)
operator|.
name|getImm
argument_list|()
operator|!=
name|ARMCC
operator|::
name|AL
return|;
block|}
name|ARMCC
operator|::
name|CondCodes
name|getPredicate
argument_list|(
argument|const MachineInstr *MI
argument_list|)
specifier|const
block|{
name|int
name|PIdx
operator|=
name|MI
operator|->
name|findFirstPredOperandIdx
argument_list|()
block|;
return|return
name|PIdx
operator|!=
operator|-
literal|1
condition|?
operator|(
name|ARMCC
operator|::
name|CondCodes
operator|)
name|MI
operator|->
name|getOperand
argument_list|(
name|PIdx
argument_list|)
operator|.
name|getImm
argument_list|()
else|:
name|ARMCC
operator|::
name|AL
return|;
block|}
name|virtual
name|bool
name|PredicateInstruction
argument_list|(
argument|MachineInstr *MI
argument_list|,
argument|const SmallVectorImpl<MachineOperand>&Pred
argument_list|)
specifier|const
block|;
name|virtual
name|bool
name|SubsumesPredicate
argument_list|(
argument|const SmallVectorImpl<MachineOperand>&Pred1
argument_list|,
argument|const SmallVectorImpl<MachineOperand>&Pred2
argument_list|)
specifier|const
block|;
name|virtual
name|bool
name|DefinesPredicate
argument_list|(
argument|MachineInstr *MI
argument_list|,
argument|std::vector<MachineOperand>&Pred
argument_list|)
specifier|const
block|;
comment|/// GetInstSize - Returns the size of the specified MachineInstr.
comment|///
name|virtual
name|unsigned
name|GetInstSizeInBytes
argument_list|(
argument|const MachineInstr* MI
argument_list|)
specifier|const
block|;
comment|/// Return true if the instruction is a register to register move and return
comment|/// the source and dest operands and their sub-register indices by reference.
name|virtual
name|bool
name|isMoveInstr
argument_list|(
argument|const MachineInstr&MI
argument_list|,
argument|unsigned&SrcReg
argument_list|,
argument|unsigned&DstReg
argument_list|,
argument|unsigned&SrcSubIdx
argument_list|,
argument|unsigned&DstSubIdx
argument_list|)
specifier|const
block|;
name|virtual
name|unsigned
name|isLoadFromStackSlot
argument_list|(
argument|const MachineInstr *MI
argument_list|,
argument|int&FrameIndex
argument_list|)
specifier|const
block|;
name|virtual
name|unsigned
name|isStoreToStackSlot
argument_list|(
argument|const MachineInstr *MI
argument_list|,
argument|int&FrameIndex
argument_list|)
specifier|const
block|;
name|virtual
name|bool
name|copyRegToReg
argument_list|(
argument|MachineBasicBlock&MBB
argument_list|,
argument|MachineBasicBlock::iterator I
argument_list|,
argument|unsigned DestReg
argument_list|,
argument|unsigned SrcReg
argument_list|,
argument|const TargetRegisterClass *DestRC
argument_list|,
argument|const TargetRegisterClass *SrcRC
argument_list|)
specifier|const
block|;
name|virtual
name|void
name|storeRegToStackSlot
argument_list|(
argument|MachineBasicBlock&MBB
argument_list|,
argument|MachineBasicBlock::iterator MBBI
argument_list|,
argument|unsigned SrcReg
argument_list|,
argument|bool isKill
argument_list|,
argument|int FrameIndex
argument_list|,
argument|const TargetRegisterClass *RC
argument_list|)
specifier|const
block|;
name|virtual
name|void
name|loadRegFromStackSlot
argument_list|(
argument|MachineBasicBlock&MBB
argument_list|,
argument|MachineBasicBlock::iterator MBBI
argument_list|,
argument|unsigned DestReg
argument_list|,
argument|int FrameIndex
argument_list|,
argument|const TargetRegisterClass *RC
argument_list|)
specifier|const
block|;
name|virtual
name|bool
name|canFoldMemoryOperand
argument_list|(
argument|const MachineInstr *MI
argument_list|,
argument|const SmallVectorImpl<unsigned>&Ops
argument_list|)
specifier|const
block|;
name|virtual
name|MachineInstr
operator|*
name|foldMemoryOperandImpl
argument_list|(
argument|MachineFunction&MF
argument_list|,
argument|MachineInstr* MI
argument_list|,
argument|const SmallVectorImpl<unsigned>&Ops
argument_list|,
argument|int FrameIndex
argument_list|)
specifier|const
block|;
name|virtual
name|MachineInstr
operator|*
name|foldMemoryOperandImpl
argument_list|(
argument|MachineFunction&MF
argument_list|,
argument|MachineInstr* MI
argument_list|,
argument|const SmallVectorImpl<unsigned>&Ops
argument_list|,
argument|MachineInstr* LoadMI
argument_list|)
specifier|const
block|;  }
decl_stmt|;
specifier|static
specifier|inline
specifier|const
name|MachineInstrBuilder
modifier|&
name|AddDefaultPred
parameter_list|(
specifier|const
name|MachineInstrBuilder
modifier|&
name|MIB
parameter_list|)
block|{
return|return
name|MIB
operator|.
name|addImm
argument_list|(
operator|(
name|int64_t
operator|)
name|ARMCC
operator|::
name|AL
argument_list|)
operator|.
name|addReg
argument_list|(
literal|0
argument_list|)
return|;
block|}
specifier|static
specifier|inline
specifier|const
name|MachineInstrBuilder
modifier|&
name|AddDefaultCC
parameter_list|(
specifier|const
name|MachineInstrBuilder
modifier|&
name|MIB
parameter_list|)
block|{
return|return
name|MIB
operator|.
name|addReg
argument_list|(
literal|0
argument_list|)
return|;
block|}
specifier|static
specifier|inline
specifier|const
name|MachineInstrBuilder
modifier|&
name|AddDefaultT1CC
parameter_list|(
specifier|const
name|MachineInstrBuilder
modifier|&
name|MIB
parameter_list|,
name|bool
name|isDead
init|=
name|false
parameter_list|)
block|{
return|return
name|MIB
operator|.
name|addReg
argument_list|(
name|ARM
operator|::
name|CPSR
argument_list|,
name|getDefRegState
argument_list|(
name|true
argument_list|)
operator||
name|getDeadRegState
argument_list|(
name|isDead
argument_list|)
argument_list|)
return|;
block|}
specifier|static
specifier|inline
specifier|const
name|MachineInstrBuilder
modifier|&
name|AddNoT1CC
parameter_list|(
specifier|const
name|MachineInstrBuilder
modifier|&
name|MIB
parameter_list|)
block|{
return|return
name|MIB
operator|.
name|addReg
argument_list|(
literal|0
argument_list|)
return|;
block|}
specifier|static
specifier|inline
name|bool
name|isUncondBranchOpcode
parameter_list|(
name|int
name|Opc
parameter_list|)
block|{
return|return
name|Opc
operator|==
name|ARM
operator|::
name|B
operator|||
name|Opc
operator|==
name|ARM
operator|::
name|tB
operator|||
name|Opc
operator|==
name|ARM
operator|::
name|t2B
return|;
block|}
specifier|static
specifier|inline
name|bool
name|isCondBranchOpcode
parameter_list|(
name|int
name|Opc
parameter_list|)
block|{
return|return
name|Opc
operator|==
name|ARM
operator|::
name|Bcc
operator|||
name|Opc
operator|==
name|ARM
operator|::
name|tBcc
operator|||
name|Opc
operator|==
name|ARM
operator|::
name|t2Bcc
return|;
block|}
specifier|static
specifier|inline
name|bool
name|isJumpTableBranchOpcode
parameter_list|(
name|int
name|Opc
parameter_list|)
block|{
return|return
name|Opc
operator|==
name|ARM
operator|::
name|BR_JTr
operator|||
name|Opc
operator|==
name|ARM
operator|::
name|BR_JTm
operator|||
name|Opc
operator|==
name|ARM
operator|::
name|BR_JTadd
operator|||
name|Opc
operator|==
name|ARM
operator|::
name|tBR_JTr
operator|||
name|Opc
operator|==
name|ARM
operator|::
name|t2BR_JT
return|;
block|}
specifier|static
specifier|inline
name|bool
name|isIndirectBranchOpcode
parameter_list|(
name|int
name|Opc
parameter_list|)
block|{
return|return
name|Opc
operator|==
name|ARM
operator|::
name|BRIND
operator|||
name|Opc
operator|==
name|ARM
operator|::
name|tBRIND
return|;
block|}
comment|/// getInstrPredicate - If instruction is predicated, returns its predicate
comment|/// condition, otherwise returns AL. It also returns the condition code
comment|/// register by reference.
name|ARMCC
operator|::
name|CondCodes
name|getInstrPredicate
argument_list|(
specifier|const
name|MachineInstr
operator|*
name|MI
argument_list|,
name|unsigned
operator|&
name|PredReg
argument_list|)
expr_stmt|;
name|int
name|getMatchingCondBranchOpcode
parameter_list|(
name|int
name|Opc
parameter_list|)
function_decl|;
comment|/// emitARMRegPlusImmediate / emitT2RegPlusImmediate - Emits a series of
comment|/// instructions to materializea destreg = basereg + immediate in ARM / Thumb2
comment|/// code.
name|void
name|emitARMRegPlusImmediate
argument_list|(
name|MachineBasicBlock
operator|&
name|MBB
argument_list|,
name|MachineBasicBlock
operator|::
name|iterator
operator|&
name|MBBI
argument_list|,
name|DebugLoc
name|dl
argument_list|,
name|unsigned
name|DestReg
argument_list|,
name|unsigned
name|BaseReg
argument_list|,
name|int
name|NumBytes
argument_list|,
name|ARMCC
operator|::
name|CondCodes
name|Pred
argument_list|,
name|unsigned
name|PredReg
argument_list|,
specifier|const
name|ARMBaseInstrInfo
operator|&
name|TII
argument_list|)
decl_stmt|;
name|void
name|emitT2RegPlusImmediate
argument_list|(
name|MachineBasicBlock
operator|&
name|MBB
argument_list|,
name|MachineBasicBlock
operator|::
name|iterator
operator|&
name|MBBI
argument_list|,
name|DebugLoc
name|dl
argument_list|,
name|unsigned
name|DestReg
argument_list|,
name|unsigned
name|BaseReg
argument_list|,
name|int
name|NumBytes
argument_list|,
name|ARMCC
operator|::
name|CondCodes
name|Pred
argument_list|,
name|unsigned
name|PredReg
argument_list|,
specifier|const
name|ARMBaseInstrInfo
operator|&
name|TII
argument_list|)
decl_stmt|;
comment|/// rewriteARMFrameIndex / rewriteT2FrameIndex -
comment|/// Rewrite MI to access 'Offset' bytes from the FP. Return false if the
comment|/// offset could not be handled directly in MI, and return the left-over
comment|/// portion by reference.
name|bool
name|rewriteARMFrameIndex
parameter_list|(
name|MachineInstr
modifier|&
name|MI
parameter_list|,
name|unsigned
name|FrameRegIdx
parameter_list|,
name|unsigned
name|FrameReg
parameter_list|,
name|int
modifier|&
name|Offset
parameter_list|,
specifier|const
name|ARMBaseInstrInfo
modifier|&
name|TII
parameter_list|)
function_decl|;
name|bool
name|rewriteT2FrameIndex
parameter_list|(
name|MachineInstr
modifier|&
name|MI
parameter_list|,
name|unsigned
name|FrameRegIdx
parameter_list|,
name|unsigned
name|FrameReg
parameter_list|,
name|int
modifier|&
name|Offset
parameter_list|,
specifier|const
name|ARMBaseInstrInfo
modifier|&
name|TII
parameter_list|)
function_decl|;
block|}
end_decl_stmt

begin_comment
comment|// End llvm namespace
end_comment

begin_endif
endif|#
directive|endif
end_endif

end_unit


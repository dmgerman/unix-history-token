begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//===-- PPCFrameInfo.h - Define TargetFrameInfo for PowerPC -----*- C++ -*-===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|POWERPC_FRAMEINFO_H
end_ifndef

begin_define
define|#
directive|define
name|POWERPC_FRAMEINFO_H
end_define

begin_include
include|#
directive|include
file|"PPC.h"
end_include

begin_include
include|#
directive|include
file|"PPCSubtarget.h"
end_include

begin_include
include|#
directive|include
file|"llvm/Target/TargetFrameInfo.h"
end_include

begin_include
include|#
directive|include
file|"llvm/Target/TargetMachine.h"
end_include

begin_include
include|#
directive|include
file|"llvm/ADT/STLExtras.h"
end_include

begin_decl_stmt
name|namespace
name|llvm
block|{
name|class
name|PPCFrameInfo
range|:
name|public
name|TargetFrameInfo
block|{
specifier|const
name|TargetMachine
operator|&
name|TM
block|;
name|public
operator|:
name|PPCFrameInfo
argument_list|(
argument|const TargetMachine&tm
argument_list|,
argument|bool LP64
argument_list|)
operator|:
name|TargetFrameInfo
argument_list|(
name|TargetFrameInfo
operator|::
name|StackGrowsDown
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|)
block|,
name|TM
argument_list|(
argument|tm
argument_list|)
block|{   }
comment|/// getReturnSaveOffset - Return the previous frame offset to save the
comment|/// return address.
specifier|static
name|unsigned
name|getReturnSaveOffset
argument_list|(
argument|bool LP64
argument_list|,
argument|bool isDarwinABI
argument_list|)
block|{
if|if
condition|(
name|isDarwinABI
condition|)
return|return
name|LP64
operator|?
literal|16
operator|:
literal|8
return|;
comment|// SVR4 ABI:
return|return
literal|4
return|;
block|}
comment|/// getFramePointerSaveOffset - Return the previous frame offset to save the
comment|/// frame pointer.
specifier|static
name|unsigned
name|getFramePointerSaveOffset
parameter_list|(
name|bool
name|LP64
parameter_list|,
name|bool
name|isDarwinABI
parameter_list|)
block|{
comment|// For the Darwin ABI:
comment|// Use the TOC save slot in the PowerPC linkage area for saving the frame
comment|// pointer (if needed.)  LLVM does not generate code that uses the TOC (R2
comment|// is treated as a caller saved register.)
if|if
condition|(
name|isDarwinABI
condition|)
return|return
name|LP64
condition|?
literal|40
else|:
literal|20
return|;
comment|// SVR4 ABI:
comment|// Save it right before the link register
return|return
operator|-
literal|4U
return|;
block|}
comment|/// getLinkageSize - Return the size of the PowerPC ABI linkage area.
comment|///
specifier|static
name|unsigned
name|getLinkageSize
parameter_list|(
name|bool
name|LP64
parameter_list|,
name|bool
name|isDarwinABI
parameter_list|)
block|{
if|if
condition|(
name|isDarwinABI
condition|)
return|return
literal|6
operator|*
operator|(
name|LP64
condition|?
literal|8
else|:
literal|4
operator|)
return|;
comment|// SVR4 ABI:
return|return
literal|8
return|;
block|}
comment|/// getMinCallArgumentsSize - Return the size of the minium PowerPC ABI
comment|/// argument area.
specifier|static
name|unsigned
name|getMinCallArgumentsSize
parameter_list|(
name|bool
name|LP64
parameter_list|,
name|bool
name|isDarwinABI
parameter_list|)
block|{
comment|// For the Darwin ABI:
comment|// The prolog code of the callee may store up to 8 GPR argument registers to
comment|// the stack, allowing va_start to index over them in memory if its varargs.
comment|// Because we cannot tell if this is needed on the caller side, we have to
comment|// conservatively assume that it is needed.  As such, make sure we have at
comment|// least enough stack space for the caller to store the 8 GPRs.
if|if
condition|(
name|isDarwinABI
condition|)
return|return
literal|8
operator|*
operator|(
name|LP64
condition|?
literal|8
else|:
literal|4
operator|)
return|;
comment|// SVR4 ABI:
comment|// There is no default stack allocated for the 8 first GPR arguments.
return|return
literal|0
return|;
block|}
comment|/// getMinCallFrameSize - Return the minimum size a call frame can be using
comment|/// the PowerPC ABI.
specifier|static
name|unsigned
name|getMinCallFrameSize
parameter_list|(
name|bool
name|LP64
parameter_list|,
name|bool
name|isDarwinABI
parameter_list|)
block|{
comment|// The call frame needs to be at least big enough for linkage and 8 args.
return|return
name|getLinkageSize
argument_list|(
name|LP64
argument_list|,
name|isDarwinABI
argument_list|)
operator|+
name|getMinCallArgumentsSize
argument_list|(
name|LP64
argument_list|,
name|isDarwinABI
argument_list|)
return|;
block|}
comment|// With the SVR4 ABI, callee-saved registers have fixed offsets on the stack.
specifier|const
name|std
operator|::
name|pair
operator|<
name|unsigned
operator|,
name|int
operator|>
operator|*
name|getCalleeSavedSpillSlots
argument_list|(
argument|unsigned&NumEntries
argument_list|)
specifier|const
block|{
comment|// Early exit if not using the SVR4 ABI.
if|if
condition|(
operator|!
name|TM
operator|.
name|getSubtarget
operator|<
name|PPCSubtarget
operator|>
operator|(
operator|)
operator|.
name|isSVR4ABI
argument_list|()
condition|)
block|{
name|NumEntries
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
specifier|static
specifier|const
name|std
operator|::
name|pair
operator|<
name|unsigned
operator|,
name|int
operator|>
name|Offsets
index|[]
operator|=
block|{
comment|// Floating-point register save area offsets.
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F31
operator|,
operator|-
literal|8
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F30
operator|,
operator|-
literal|16
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F29
operator|,
operator|-
literal|24
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F28
operator|,
operator|-
literal|32
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F27
operator|,
operator|-
literal|40
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F26
operator|,
operator|-
literal|48
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F25
operator|,
operator|-
literal|56
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F24
operator|,
operator|-
literal|64
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F23
operator|,
operator|-
literal|72
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F22
operator|,
operator|-
literal|80
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F21
operator|,
operator|-
literal|88
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F20
operator|,
operator|-
literal|96
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F19
operator|,
operator|-
literal|104
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F18
operator|,
operator|-
literal|112
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F17
operator|,
operator|-
literal|120
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F16
operator|,
operator|-
literal|128
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F15
operator|,
operator|-
literal|136
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|F14
operator|,
operator|-
literal|144
operator|)
block|,
comment|// General register save area offsets.
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R31
operator|,
operator|-
literal|4
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R30
operator|,
operator|-
literal|8
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R29
operator|,
operator|-
literal|12
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R28
operator|,
operator|-
literal|16
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R27
operator|,
operator|-
literal|20
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R26
operator|,
operator|-
literal|24
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R25
operator|,
operator|-
literal|28
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R24
operator|,
operator|-
literal|32
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R23
operator|,
operator|-
literal|36
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R22
operator|,
operator|-
literal|40
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R21
operator|,
operator|-
literal|44
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R20
operator|,
operator|-
literal|48
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R19
operator|,
operator|-
literal|52
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R18
operator|,
operator|-
literal|56
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R17
operator|,
operator|-
literal|60
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R16
operator|,
operator|-
literal|64
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R15
operator|,
operator|-
literal|68
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|R14
operator|,
operator|-
literal|72
operator|)
block|,
comment|// CR save area offset.
comment|// FIXME SVR4: Disable CR save area for now.
comment|//      std::pair<unsigned, int>(PPC::CR2, -4),
comment|//      std::pair<unsigned, int>(PPC::CR3, -4),
comment|//      std::pair<unsigned, int>(PPC::CR4, -4),
comment|//      std::pair<unsigned, int>(PPC::CR2LT, -4),
comment|//      std::pair<unsigned, int>(PPC::CR2GT, -4),
comment|//      std::pair<unsigned, int>(PPC::CR2EQ, -4),
comment|//      std::pair<unsigned, int>(PPC::CR2UN, -4),
comment|//      std::pair<unsigned, int>(PPC::CR3LT, -4),
comment|//      std::pair<unsigned, int>(PPC::CR3GT, -4),
comment|//      std::pair<unsigned, int>(PPC::CR3EQ, -4),
comment|//      std::pair<unsigned, int>(PPC::CR3UN, -4),
comment|//      std::pair<unsigned, int>(PPC::CR4LT, -4),
comment|//      std::pair<unsigned, int>(PPC::CR4GT, -4),
comment|//      std::pair<unsigned, int>(PPC::CR4EQ, -4),
comment|//      std::pair<unsigned, int>(PPC::CR4UN, -4),
comment|// VRSAVE save area offset.
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|VRSAVE
operator|,
operator|-
literal|4
operator|)
block|,
comment|// Vector register save area
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V31
operator|,
operator|-
literal|16
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V30
operator|,
operator|-
literal|32
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V29
operator|,
operator|-
literal|48
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V28
operator|,
operator|-
literal|64
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V27
operator|,
operator|-
literal|80
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V26
operator|,
operator|-
literal|96
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V25
operator|,
operator|-
literal|112
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V24
operator|,
operator|-
literal|128
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V23
operator|,
operator|-
literal|144
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V22
operator|,
operator|-
literal|160
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V21
operator|,
operator|-
literal|176
operator|)
block|,
name|std
operator|::
name|pair
operator|<
name|unsigned
block|,
name|int
operator|>
operator|(
name|PPC
operator|::
name|V20
operator|,
operator|-
literal|192
operator|)
block|}
expr_stmt|;
name|NumEntries
operator|=
name|array_lengthof
argument_list|(
name|Offsets
argument_list|)
expr_stmt|;
return|return
name|Offsets
return|;
block|}
end_decl_stmt

begin_comment
unit|};  }
comment|// End llvm namespace
end_comment

begin_endif
endif|#
directive|endif
end_endif

end_unit


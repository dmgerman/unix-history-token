begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* * Copyright (c) 2007, Novell, Inc. * Author: Matthias Koenig<mkoenig@suse.de> * * All rights reserved. * * Redistribution and use in source and binary forms, with or without * modification, are permitted provided that the following conditions are met: * * * Redistributions of source code must retain the above copyright notice, this *   list of conditions and the following disclaimer. * * * Redistributions in binary form must reproduce the above copyright notice, *   this list of conditions and the following disclaimer in the documentation *   and/or other materials provided with the distribution. * * * Neither the name of the Novell nor the names of its contributors may be used *   to endorse or promote products derived from this software without specific *   prior written permission. * * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE * POSSIBILITY OF SUCH DAMAGE. */
end_comment

begin_comment
comment|/* openssl diffie-hellman test code  * works with openssl-0.9.8e  * primes with 3072 and 6144 bits as specified in RFC3526  * fail since openssl-0.9.8f  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<roken.h>
end_include

begin_include
include|#
directive|include
file|<getarg.h>
end_include

begin_include
include|#
directive|include
file|<dh.h>
end_include

begin_include
include|#
directive|include
file|<evp.h>
end_include

begin_comment
comment|/*  *  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|id_string
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|verbose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|version_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|help_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|getargs
name|args
index|[]
init|=
block|{
block|{
literal|"id"
block|,
literal|0
block|,
name|arg_string
block|,
operator|&
name|id_string
block|,
literal|"type of ENGINE"
block|,
name|NULL
block|}
block|,
block|{
literal|"verbose"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|verbose
block|,
literal|"verbose output from tests"
block|,
name|NULL
block|}
block|,
block|{
literal|"version"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|version_flag
block|,
literal|"print version"
block|,
name|NULL
block|}
block|,
block|{
literal|"help"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|help_flag
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *  */
end_comment

begin_define
define|#
directive|define
name|OAKLEY_PRIME_MODP768
define|\
value|"FFFFFFFF FFFFFFFF C90FDAA2 2168C234 C4C6628B 80DC1CD1"	\     "29024E08 8A67CC74 020BBEA6 3B139B22 514A0879 8E3404DD"	\     "EF9519B3 CD3A431B 302B0A6D F25F1437 4FE1356D 6D51C245"	\     "E485B576 625E7EC6 F44C42E9 A63A3620 FFFFFFFF FFFFFFFF"
end_define

begin_define
define|#
directive|define
name|OAKLEY_PRIME_MODP1024
define|\
value|"FFFFFFFF FFFFFFFF C90FDAA2 2168C234 C4C6628B 80DC1CD1"	\     "29024E08 8A67CC74 020BBEA6 3B139B22 514A0879 8E3404DD"	\     "EF9519B3 CD3A431B 302B0A6D F25F1437 4FE1356D 6D51C245"	\     "E485B576 625E7EC6 F44C42E9 A637ED6B 0BFF5CB6 F406B7ED"	\     "EE386BFB 5A899FA5 AE9F2411 7C4B1FE6 49286651 ECE65381"	\     "FFFFFFFF FFFFFFFF"
end_define

begin_define
define|#
directive|define
name|OAKLEY_PRIME_MODP1536
define|\
value|"FFFFFFFF FFFFFFFF C90FDAA2 2168C234 C4C6628B 80DC1CD1"	\     "29024E08 8A67CC74 020BBEA6 3B139B22 514A0879 8E3404DD"	\     "EF9519B3 CD3A431B 302B0A6D F25F1437 4FE1356D 6D51C245"	\     "E485B576 625E7EC6 F44C42E9 A637ED6B 0BFF5CB6 F406B7ED"	\     "EE386BFB 5A899FA5 AE9F2411 7C4B1FE6 49286651 ECE45B3D"	\     "C2007CB8 A163BF05 98DA4836 1C55D39A 69163FA8 FD24CF5F"	\     "83655D23 DCA3AD96 1C62F356 208552BB 9ED52907 7096966D"	\     "670C354E 4ABC9804 F1746C08 CA237327 FFFFFFFF FFFFFFFF"
end_define

begin_comment
comment|/* RFC 3526 */
end_comment

begin_define
define|#
directive|define
name|OAKLEY_PRIME_MODP2048
define|\
value|"FFFFFFFF FFFFFFFF C90FDAA2 2168C234 C4C6628B 80DC1CD1"	\     "29024E08 8A67CC74 020BBEA6 3B139B22 514A0879 8E3404DD"	\     "EF9519B3 CD3A431B 302B0A6D F25F1437 4FE1356D 6D51C245"	\     "E485B576 625E7EC6 F44C42E9 A637ED6B 0BFF5CB6 F406B7ED"	\     "EE386BFB 5A899FA5 AE9F2411 7C4B1FE6 49286651 ECE45B3D"	\     "C2007CB8 A163BF05 98DA4836 1C55D39A 69163FA8 FD24CF5F"	\     "83655D23 DCA3AD96 1C62F356 208552BB 9ED52907 7096966D"	\     "670C354E 4ABC9804 F1746C08 CA18217C 32905E46 2E36CE3B"	\     "E39E772C 180E8603 9B2783A2 EC07A28F B5C55DF0 6F4C52C9"	\     "DE2BCBF6 95581718 3995497C EA956AE5 15D22618 98FA0510"	\     "15728E5A 8AACAA68 FFFFFFFF FFFFFFFF"
end_define

begin_define
define|#
directive|define
name|OAKLEY_PRIME_MODP3072
define|\
value|"FFFFFFFF FFFFFFFF C90FDAA2 2168C234 C4C6628B 80DC1CD1"	\     "29024E08 8A67CC74 020BBEA6 3B139B22 514A0879 8E3404DD"	\     "EF9519B3 CD3A431B 302B0A6D F25F1437 4FE1356D 6D51C245"	\     "E485B576 625E7EC6 F44C42E9 A637ED6B 0BFF5CB6 F406B7ED"	\     "EE386BFB 5A899FA5 AE9F2411 7C4B1FE6 49286651 ECE45B3D"	\     "C2007CB8 A163BF05 98DA4836 1C55D39A 69163FA8 FD24CF5F"	\     "83655D23 DCA3AD96 1C62F356 208552BB 9ED52907 7096966D"	\     "670C354E 4ABC9804 F1746C08 CA18217C 32905E46 2E36CE3B"	\     "E39E772C 180E8603 9B2783A2 EC07A28F B5C55DF0 6F4C52C9"	\     "DE2BCBF6 95581718 3995497C EA956AE5 15D22618 98FA0510"	\     "15728E5A 8AAAC42D AD33170D 04507A33 A85521AB DF1CBA64"	\     "ECFB8504 58DBEF0A 8AEA7157 5D060C7D B3970F85 A6E1E4C7"	\     "ABF5AE8C DB0933D7 1E8C94E0 4A25619D CEE3D226 1AD2EE6B"	\     "F12FFA06 D98A0864 D8760273 3EC86A64 521F2B18 177B200C"	\     "BBE11757 7A615D6C 770988C0 BAD946E2 08E24FA0 74E5AB31"	\     "43DB5BFC E0FD108E 4B82D120 A93AD2CA FFFFFFFF FFFFFFFF"
end_define

begin_define
define|#
directive|define
name|OAKLEY_PRIME_MODP4096
define|\
value|"FFFFFFFF FFFFFFFF C90FDAA2 2168C234 C4C6628B 80DC1CD1"	\     "29024E08 8A67CC74 020BBEA6 3B139B22 514A0879 8E3404DD"	\     "EF9519B3 CD3A431B 302B0A6D F25F1437 4FE1356D 6D51C245"	\     "E485B576 625E7EC6 F44C42E9 A637ED6B 0BFF5CB6 F406B7ED"	\     "EE386BFB 5A899FA5 AE9F2411 7C4B1FE6 49286651 ECE45B3D"	\     "C2007CB8 A163BF05 98DA4836 1C55D39A 69163FA8 FD24CF5F"	\     "83655D23 DCA3AD96 1C62F356 208552BB 9ED52907 7096966D"	\     "670C354E 4ABC9804 F1746C08 CA18217C 32905E46 2E36CE3B"	\     "E39E772C 180E8603 9B2783A2 EC07A28F B5C55DF0 6F4C52C9"	\     "DE2BCBF6 95581718 3995497C EA956AE5 15D22618 98FA0510"	\     "15728E5A 8AAAC42D AD33170D 04507A33 A85521AB DF1CBA64"	\     "ECFB8504 58DBEF0A 8AEA7157 5D060C7D B3970F85 A6E1E4C7"	\     "ABF5AE8C DB0933D7 1E8C94E0 4A25619D CEE3D226 1AD2EE6B"	\     "F12FFA06 D98A0864 D8760273 3EC86A64 521F2B18 177B200C"	\     "BBE11757 7A615D6C 770988C0 BAD946E2 08E24FA0 74E5AB31"	\     "43DB5BFC E0FD108E 4B82D120 A9210801 1A723C12 A787E6D7"	\     "88719A10 BDBA5B26 99C32718 6AF4E23C 1A946834 B6150BDA"	\     "2583E9CA 2AD44CE8 DBBBC2DB 04DE8EF9 2E8EFC14 1FBECAA6"	\     "287C5947 4E6BC05D 99B2964F A090C3A2 233BA186 515BE7ED"	\     "1F612970 CEE2D7AF B81BDD76 2170481C D0069127 D5B05AA9"	\     "93B4EA98 8D8FDDC1 86FFB7DC 90A6C08F 4DF435C9 34063199"	\     "FFFFFFFF FFFFFFFF"
end_define

begin_define
define|#
directive|define
name|OAKLEY_PRIME_MODP6144
define|\
value|"FFFFFFFF FFFFFFFF C90FDAA2 2168C234 C4C6628B 80DC1CD1"	\     "29024E08 8A67CC74 020BBEA6 3B139B22 514A0879 8E3404DD"	\     "EF9519B3 CD3A431B 302B0A6D F25F1437 4FE1356D 6D51C245"	\     "E485B576 625E7EC6 F44C42E9 A637ED6B 0BFF5CB6 F406B7ED"	\     "EE386BFB 5A899FA5 AE9F2411 7C4B1FE6 49286651 ECE45B3D"	\     "C2007CB8 A163BF05 98DA4836 1C55D39A 69163FA8 FD24CF5F"	\     "83655D23 DCA3AD96 1C62F356 208552BB 9ED52907 7096966D"	\     "670C354E 4ABC9804 F1746C08 CA18217C 32905E46 2E36CE3B"	\     "E39E772C 180E8603 9B2783A2 EC07A28F B5C55DF0 6F4C52C9"	\     "DE2BCBF6 95581718 3995497C EA956AE5 15D22618 98FA0510"	\     "15728E5A 8AAAC42D AD33170D 04507A33 A85521AB DF1CBA64"	\     "ECFB8504 58DBEF0A 8AEA7157 5D060C7D B3970F85 A6E1E4C7"	\     "ABF5AE8C DB0933D7 1E8C94E0 4A25619D CEE3D226 1AD2EE6B"	\     "F12FFA06 D98A0864 D8760273 3EC86A64 521F2B18 177B200C"	\     "BBE11757 7A615D6C 770988C0 BAD946E2 08E24FA0 74E5AB31"	\     "43DB5BFC E0FD108E 4B82D120 A9210801 1A723C12 A787E6D7"	\     "88719A10 BDBA5B26 99C32718 6AF4E23C 1A946834 B6150BDA"	\     "2583E9CA 2AD44CE8 DBBBC2DB 04DE8EF9 2E8EFC14 1FBECAA6"	\     "287C5947 4E6BC05D 99B2964F A090C3A2 233BA186 515BE7ED"	\     "1F612970 CEE2D7AF B81BDD76 2170481C D0069127 D5B05AA9"	\     "93B4EA98 8D8FDDC1 86FFB7DC 90A6C08F 4DF435C9 34028492"	\     "36C3FAB4 D27C7026 C1D4DCB2 602646DE C9751E76 3DBA37BD"	\     "F8FF9406 AD9E530E E5DB382F 413001AE B06A53ED 9027D831"	\     "179727B0 865A8918 DA3EDBEB CF9B14ED 44CE6CBA CED4BB1B"	\     "DB7F1447 E6CC254B 33205151 2BD7AF42 6FB8F401 378CD2BF"	\     "5983CA01 C64B92EC F032EA15 D1721D03 F482D7CE 6E74FEF6"	\     "D55E702F 46980C82 B5A84031 900B1C9E 59E7C97F BEC7E8F3"	\     "23A97A7E 36CC88BE 0F1D45B7 FF585AC5 4BD407B2 2B4154AA"	\     "CC8F6D7E BF48E1D8 14CC5ED2 0F8037E0 A79715EE F29BE328"	\     "06A1D58B B7C5DA76 F550AA3D 8A1FBFF0 EB19CCB1 A313D55C"	\     "DA56C9EC 2EF29632 387FE8D7 6E3C0468 043E8F66 3F4860EE"	\     "12BF2D5B 0B7474D6 E694F91E 6DCC4024 FFFFFFFF FFFFFFFF"
end_define

begin_define
define|#
directive|define
name|OAKLEY_PRIME_MODP8192
define|\
value|"FFFFFFFF FFFFFFFF C90FDAA2 2168C234 C4C6628B 80DC1CD1"	\     "29024E08 8A67CC74 020BBEA6 3B139B22 514A0879 8E3404DD"	\     "EF9519B3 CD3A431B 302B0A6D F25F1437 4FE1356D 6D51C245"	\     "E485B576 625E7EC6 F44C42E9 A637ED6B 0BFF5CB6 F406B7ED"	\     "EE386BFB 5A899FA5 AE9F2411 7C4B1FE6 49286651 ECE45B3D"	\     "C2007CB8 A163BF05 98DA4836 1C55D39A 69163FA8 FD24CF5F"	\     "83655D23 DCA3AD96 1C62F356 208552BB 9ED52907 7096966D"	\     "670C354E 4ABC9804 F1746C08 CA18217C 32905E46 2E36CE3B"	\     "E39E772C 180E8603 9B2783A2 EC07A28F B5C55DF0 6F4C52C9"	\     "DE2BCBF6 95581718 3995497C EA956AE5 15D22618 98FA0510"	\     "15728E5A 8AAAC42D AD33170D 04507A33 A85521AB DF1CBA64"	\     "ECFB8504 58DBEF0A 8AEA7157 5D060C7D B3970F85 A6E1E4C7"	\     "ABF5AE8C DB0933D7 1E8C94E0 4A25619D CEE3D226 1AD2EE6B"	\     "F12FFA06 D98A0864 D8760273 3EC86A64 521F2B18 177B200C"	\     "BBE11757 7A615D6C 770988C0 BAD946E2 08E24FA0 74E5AB31"	\     "43DB5BFC E0FD108E 4B82D120 A9210801 1A723C12 A787E6D7"	\     "88719A10 BDBA5B26 99C32718 6AF4E23C 1A946834 B6150BDA"	\     "2583E9CA 2AD44CE8 DBBBC2DB 04DE8EF9 2E8EFC14 1FBECAA6"	\     "287C5947 4E6BC05D 99B2964F A090C3A2 233BA186 515BE7ED"	\     "1F612970 CEE2D7AF B81BDD76 2170481C D0069127 D5B05AA9"	\     "93B4EA98 8D8FDDC1 86FFB7DC 90A6C08F 4DF435C9 34028492"	\     "36C3FAB4 D27C7026 C1D4DCB2 602646DE C9751E76 3DBA37BD"	\     "F8FF9406 AD9E530E E5DB382F 413001AE B06A53ED 9027D831"	\     "179727B0 865A8918 DA3EDBEB CF9B14ED 44CE6CBA CED4BB1B"	\     "DB7F1447 E6CC254B 33205151 2BD7AF42 6FB8F401 378CD2BF"	\     "5983CA01 C64B92EC F032EA15 D1721D03 F482D7CE 6E74FEF6"	\     "D55E702F 46980C82 B5A84031 900B1C9E 59E7C97F BEC7E8F3"	\     "23A97A7E 36CC88BE 0F1D45B7 FF585AC5 4BD407B2 2B4154AA"	\     "CC8F6D7E BF48E1D8 14CC5ED2 0F8037E0 A79715EE F29BE328"	\     "06A1D58B B7C5DA76 F550AA3D 8A1FBFF0 EB19CCB1 A313D55C"	\     "DA56C9EC 2EF29632 387FE8D7 6E3C0468 043E8F66 3F4860EE"	\     "12BF2D5B 0B7474D6 E694F91E 6DBE1159 74A3926F 12FEE5E4"	\     "38777CB6 A932DF8C D8BEC4D0 73B931BA 3BC832B6 8D9DD300"	\     "741FA7BF 8AFC47ED 2576F693 6BA42466 3AAB639C 5AE4F568"	\     "3423B474 2BF1C978 238F16CB E39D652D E3FDB8BE FC848AD9"	\     "22222E04 A4037C07 13EB57A8 1A23F0C7 3473FC64 6CEA306B"	\     "4BCBC886 2F8385DD FA9D4B7F A2C087E8 79683303 ED5BDD3A"	\     "062B3CF5 B3A278A6 6D2A13F8 3F44F82D DF310EE0 74AB6A36"	\     "4597E899 A0255DC1 64F31CC5 0846851D F9AB4819 5DED7EA1"	\     "B1D510BD 7EE74D73 FAF36BC3 1ECFA268 359046F4 EB879F92"	\     "4009438B 481C6CD7 889A002E D5EE382B C9190DA6 FC026E47"	\     "9558E447 5677E9AA 9E3050E2 765694DF C81F56E8 80B96E71"	\     "60C980DD 98EDD3DF FFFFFFFF FFFFFFFF"
end_define

begin_struct
struct|struct
name|prime
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
block|}
name|primes
index|[]
init|=
block|{
block|{
literal|"modp768"
block|,
name|OAKLEY_PRIME_MODP768
block|}
block|,
block|{
literal|"modp1024"
block|,
name|OAKLEY_PRIME_MODP1024
block|}
block|,
block|{
literal|"modp1536"
block|,
name|OAKLEY_PRIME_MODP1536
block|}
block|,
block|{
literal|"modp2048"
block|,
name|OAKLEY_PRIME_MODP2048
block|}
block|,
block|{
literal|"modp3072"
block|,
name|OAKLEY_PRIME_MODP3072
block|}
block|,
block|{
literal|"modp4096"
block|,
name|OAKLEY_PRIME_MODP4096
block|}
block|,
block|{
literal|"modp6144"
block|,
name|OAKLEY_PRIME_MODP6144
block|}
block|,
block|{
literal|"modp8192"
block|,
name|OAKLEY_PRIME_MODP8192
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_comment
comment|/*  * exchange a string based "base" to a value.  *  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|str2val
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|int
name|base
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|int
name|f
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|char
modifier|*
name|dst
decl_stmt|;
name|char
modifier|*
name|rp
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|char
name|b
index|[
literal|3
index|]
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|p
operator|=
name|str
init|;
operator|*
name|p
operator|!=
literal|'\0'
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|isxdigit
argument_list|(
operator|(
name|int
operator|)
operator|*
name|p
argument_list|)
condition|)
name|i
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|isspace
argument_list|(
operator|(
name|int
operator|)
operator|*
name|p
argument_list|)
condition|)
empty_stmt|;
else|else
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
operator|||
operator|(
name|i
operator|%
literal|2
operator|)
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
name|i
operator|/=
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|dst
operator|=
name|malloc
argument_list|(
name|i
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|i
operator|=
literal|0
expr_stmt|;
name|f
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|rp
operator|=
name|dst
operator|,
name|p
operator|=
name|str
init|;
operator|*
name|p
operator|!=
literal|'\0'
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|isxdigit
argument_list|(
operator|(
name|int
operator|)
operator|*
name|p
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|b
index|[
literal|0
index|]
operator|=
operator|*
name|p
expr_stmt|;
name|f
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|b
index|[
literal|1
index|]
operator|=
operator|*
name|p
expr_stmt|;
name|b
index|[
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|rp
operator|++
operator|=
operator|(
name|char
operator|)
name|strtol
argument_list|(
name|b
argument_list|,
name|NULL
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|f
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
operator|*
name|len
operator|=
name|i
expr_stmt|;
return|return
operator|(
name|dst
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_prime
parameter_list|(
name|BIGNUM
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|size_t
name|len
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
modifier|*
name|prime
decl_stmt|;
name|prime
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|str2val
argument_list|(
name|str
argument_list|,
literal|16
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|prime
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"failed to parse %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|BN_bin2bn
argument_list|(
name|prime
argument_list|,
name|len
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_generator
parameter_list|(
name|BIGNUM
modifier|*
name|g
parameter_list|)
block|{
name|BN_set_word
argument_list|(
name|g
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_secret
parameter_list|(
name|unsigned
name|char
modifier|*
name|sec
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
operator|++
name|i
control|)
name|printf
argument_list|(
literal|"%x"
argument_list|,
name|sec
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_prime
parameter_list|(
name|ENGINE
modifier|*
name|engine
parameter_list|,
name|struct
name|prime
modifier|*
name|pr
parameter_list|)
block|{
name|DH
modifier|*
name|dh1
decl_stmt|,
modifier|*
name|dh2
decl_stmt|;
name|BIGNUM
modifier|*
name|p
decl_stmt|,
modifier|*
name|g
decl_stmt|;
name|unsigned
name|char
modifier|*
name|sec1
decl_stmt|,
modifier|*
name|sec2
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Testing %s\n"
argument_list|,
name|pr
operator|->
name|name
argument_list|)
expr_stmt|;
name|p
operator|=
name|BN_new
argument_list|()
expr_stmt|;
name|g
operator|=
name|BN_new
argument_list|()
expr_stmt|;
name|dh1
operator|=
name|DH_new_method
argument_list|(
name|engine
argument_list|)
expr_stmt|;
name|dh2
operator|=
name|DH_new_method
argument_list|(
name|engine
argument_list|)
expr_stmt|;
comment|/* 1. set shared parameter */
name|set_prime
argument_list|(
name|p
argument_list|,
name|pr
operator|->
name|value
argument_list|)
expr_stmt|;
name|set_generator
argument_list|(
name|g
argument_list|)
expr_stmt|;
name|dh1
operator|->
name|p
operator|=
name|BN_dup
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|dh1
operator|->
name|g
operator|=
name|BN_dup
argument_list|(
name|g
argument_list|)
expr_stmt|;
name|dh2
operator|->
name|p
operator|=
name|BN_dup
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|dh2
operator|->
name|g
operator|=
name|BN_dup
argument_list|(
name|g
argument_list|)
expr_stmt|;
comment|/* 2. set keys */
name|ret
operator|=
name|DH_generate_key
argument_list|(
name|dh1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"DH_generate_key\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|DH_generate_key
argument_list|(
name|dh2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"DH_generate_key\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
comment|/* 3. compute shared secret */
name|size
operator|=
name|DH_size
argument_list|(
name|dh1
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|!=
name|DH_size
argument_list|(
name|dh2
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"size does not match!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|sec1
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|sec2
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sec1
operator|||
operator|!
name|sec2
condition|)
block|{
name|perror
argument_list|(
literal|"malloc"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|DH_compute_key
argument_list|(
name|sec1
argument_list|,
name|dh2
operator|->
name|pub_key
argument_list|,
name|dh1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"DH_compute_key"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|DH_compute_key
argument_list|(
name|sec2
argument_list|,
name|dh1
operator|->
name|pub_key
argument_list|,
name|dh2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"DH_compute_key"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
comment|/* 4. compare shared secret */
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"shared secret 1\n"
argument_list|)
expr_stmt|;
name|print_secret
argument_list|(
name|sec1
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"shared secret 2\n"
argument_list|)
expr_stmt|;
name|print_secret
argument_list|(
name|sec2
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|sec1
argument_list|,
name|sec2
argument_list|,
name|size
argument_list|)
operator|==
literal|0
condition|)
name|ret
operator|=
literal|1
expr_stmt|;
else|else
name|ret
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|sec2
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sec1
argument_list|)
expr_stmt|;
name|DH_free
argument_list|(
name|dh2
argument_list|)
expr_stmt|;
name|DH_free
argument_list|(
name|dh1
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|g
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|int
name|ret
parameter_list|)
block|{
name|arg_printusage
argument_list|(
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|args
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|ENGINE
modifier|*
name|engine
init|=
name|NULL
decl_stmt|;
name|int
name|idx
init|=
literal|0
decl_stmt|;
name|setprogname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|getarg
argument_list|(
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|idx
argument_list|)
condition|)
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|help_flag
condition|)
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|version_flag
condition|)
block|{
name|print_version
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|argc
operator|-=
name|idx
expr_stmt|;
name|argv
operator|+=
name|idx
expr_stmt|;
name|OpenSSL_add_all_algorithms
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL
name|ENGINE_load_openssl
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|ENGINE_load_builtin_engines
argument_list|()
expr_stmt|;
if|if
condition|(
name|id_string
condition|)
block|{
name|engine
operator|=
name|ENGINE_by_id
argument_list|(
name|id_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|engine
operator|==
name|NULL
condition|)
name|engine
operator|=
name|ENGINE_by_dso
argument_list|(
name|id_string
argument_list|,
name|id_string
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|engine
operator|=
name|ENGINE_by_id
argument_list|(
literal|"builtin"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|engine
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"ENGINE_by_dso failed"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dh %s\n"
argument_list|,
name|ENGINE_get_DH
argument_list|(
name|engine
argument_list|)
operator|->
name|name
argument_list|)
expr_stmt|;
block|{
name|struct
name|prime
modifier|*
name|p
init|=
name|primes
decl_stmt|;
for|for
control|(
init|;
name|p
operator|->
name|name
condition|;
operator|++
name|p
control|)
if|if
condition|(
name|check_prime
argument_list|(
name|engine
argument_list|,
name|p
argument_list|)
condition|)
name|printf
argument_list|(
literal|"%s: shared secret OK\n"
argument_list|,
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s: shared secret FAILURE\n"
argument_list|,
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


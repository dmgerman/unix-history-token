begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<evp.h>
end_include

begin_struct
struct|struct
name|tests
block|{
specifier|const
name|char
modifier|*
name|password
decl_stmt|;
specifier|const
name|char
modifier|*
name|salt
decl_stmt|;
name|int
name|iterations
decl_stmt|;
specifier|const
name|void
modifier|*
name|pbkdf2_128
decl_stmt|;
specifier|const
name|void
modifier|*
name|pbkdf2_256
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|const
name|struct
name|tests
name|pkcs5_tests
index|[]
init|=
block|{
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
literal|1
block|,
literal|"\xcd\xed\xb5\x28\x1b\xb2\xf8\x01\x56\x5a\x11\x22\xb2\x56\x35\x15"
block|,
literal|"\xcd\xed\xb5\x28\x1b\xb2\xf8\x01\x56\x5a\x11\x22\xb2\x56\x35\x15"
literal|"\x0a\xd1\xf7\xa0\x4b\xb9\xf3\xa3\x33\xec\xc0\xe2\xe1\xf7\x08\x37"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
literal|2
block|,
literal|"\x01\xdb\xee\x7f\x4a\x9e\x24\x3e\x98\x8b\x62\xc7\x3c\xda\x93\x5d"
block|,
literal|"\x01\xdb\xee\x7f\x4a\x9e\x24\x3e\x98\x8b\x62\xc7\x3c\xda\x93\x5d"
literal|"\xa0\x53\x78\xb9\x32\x44\xec\x8f\x48\xa9\x9e\x61\xad\x79\x9d\x86"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
literal|1200
block|,
literal|"\x5c\x08\xeb\x61\xfd\xf7\x1e\x4e\x4e\xc3\xcf\x6b\xa1\xf5\x51\x2b"
block|,
literal|"\x5c\x08\xeb\x61\xfd\xf7\x1e\x4e\x4e\xc3\xcf\x6b\xa1\xf5\x51\x2b"
literal|"\xa7\xe5\x2d\xdb\xc5\xe5\x14\x2f\x70\x8a\x31\xe2\xe6\x2b\x1e\x13"
block|}
block|,
block|{
literal|"password"
block|,
literal|"\x12\x34\x56\x78\x78\x56\x34\x12"
block|,
literal|5
block|,
literal|"\xd1\xda\xa7\x86\x15\xf2\x87\xe6\xa1\xc8\xb1\x20\xd7\x06\x2a\x49"
block|,
literal|"\xd1\xda\xa7\x86\x15\xf2\x87\xe6\xa1\xc8\xb1\x20\xd7\x06\x2a\x49"
literal|"\x3f\x98\xd2\x03\xe6\xbe\x49\xa6\xad\xf4\xfa\x57\x4b\x6e\x64\xee"
block|}
block|,
block|{
literal|"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
block|,
literal|"pass phrase equals block size"
block|,
literal|1200
block|,
literal|"\x13\x9c\x30\xc0\x96\x6b\xc3\x2b\xa5\x5f\xdb\xf2\x12\x53\x0a\xc9"
block|,
literal|"\x13\x9c\x30\xc0\x96\x6b\xc3\x2b\xa5\x5f\xdb\xf2\x12\x53\x0a\xc9"
literal|"\xc5\xec\x59\xf1\xa4\x52\xf5\xcc\x9a\xd9\x40\xfe\xa0\x59\x8e\xd1"
block|}
block|,
block|{
literal|"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
block|,
literal|"pass phrase exceeds block size"
block|,
literal|1200
block|,
literal|"\x9c\xca\xd6\xd4\x68\x77\x0c\xd5\x1b\x10\xe6\xa6\x87\x21\xbe\x61"
block|,
literal|"\x9c\xca\xd6\xd4\x68\x77\x0c\xd5\x1b\x10\xe6\xa6\x87\x21\xbe\x61"
literal|"\x1a\x8b\x4d\x28\x26\x01\xdb\x3b\x36\xbe\x92\x46\x91\x5e\xc8\x2a"
block|}
block|,
block|{
literal|"\xf0\x9d\x84\x9e"
comment|/* g-clef */
block|,
literal|"EXAMPLE.COMpianist"
block|,
literal|50
block|,
literal|"\x6b\x9c\xf2\x6d\x45\x45\x5a\x43\xa5\xb8\xbb\x27\x6a\x40\x3b\x39"
block|,
literal|"\x6b\x9c\xf2\x6d\x45\x45\x5a\x43\xa5\xb8\xbb\x27\x6a\x40\x3b\x39"
literal|"\xe7\xfe\x37\xa0\xc4\x1e\x02\xc2\x81\xff\x30\x69\xe1\xe9\x4f\x52"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|test_pkcs5_pbe2
parameter_list|(
specifier|const
name|struct
name|tests
modifier|*
name|t
parameter_list|)
block|{
name|unsigned
name|char
name|key
index|[
literal|32
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|ret
operator|=
name|PKCS5_PBKDF2_HMAC_SHA1
argument_list|(
name|t
operator|->
name|password
argument_list|,
name|strlen
argument_list|(
name|t
operator|->
name|password
argument_list|)
argument_list|,
name|t
operator|->
name|salt
argument_list|,
name|strlen
argument_list|(
name|t
operator|->
name|salt
argument_list|)
argument_list|,
name|t
operator|->
name|iterations
argument_list|,
literal|16
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"PKCS5_PBKDF2_HMAC_SHA1: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|t
operator|->
name|pbkdf2_128
argument_list|,
name|key
argument_list|,
literal|16
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"incorrect 128 key\n"
argument_list|)
expr_stmt|;
name|error
operator|++
expr_stmt|;
block|}
name|ret
operator|=
name|PKCS5_PBKDF2_HMAC_SHA1
argument_list|(
name|t
operator|->
name|password
argument_list|,
name|strlen
argument_list|(
name|t
operator|->
name|password
argument_list|)
argument_list|,
name|t
operator|->
name|salt
argument_list|,
name|strlen
argument_list|(
name|t
operator|->
name|salt
argument_list|)
argument_list|,
name|t
operator|->
name|iterations
argument_list|,
literal|32
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"PKCS5_PBKDF2_HMAC_SHA1: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|t
operator|->
name|pbkdf2_256
argument_list|,
name|key
argument_list|,
literal|32
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"incorrect 256 key\n"
argument_list|)
expr_stmt|;
name|error
operator|++
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|pkcs5_tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|pkcs5_tests
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
name|ret
operator|+=
name|test_pkcs5_pbe2
argument_list|(
operator|&
name|pkcs5_tests
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


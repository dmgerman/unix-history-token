begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2010 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<roken.h>
end_include

begin_include
include|#
directive|include
file|<evp.h>
end_include

begin_include
include|#
directive|include
file|<hmac.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_struct
struct|struct
name|tests
block|{
specifier|const
name|EVP_CIPHER
modifier|*
function_decl|(
modifier|*
name|cipher
function_decl|)
parameter_list|(
name|void
parameter_list|)
function_decl|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|void
modifier|*
name|key
decl_stmt|;
name|size_t
name|keysize
decl_stmt|;
name|void
modifier|*
name|iv
decl_stmt|;
name|size_t
name|datasize
decl_stmt|;
name|void
modifier|*
name|indata
decl_stmt|;
name|void
modifier|*
name|outdata
decl_stmt|;
name|void
modifier|*
name|outiv
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|tests
name|hc_tests
index|[]
init|=
block|{
block|{
name|EVP_aes_256_cbc
block|,
literal|"aes-256"
block|,
literal|"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
literal|"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
block|,
literal|32
block|,
literal|"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
block|,
literal|16
block|,
literal|"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
block|,
literal|"\xdc\x95\xc0\x78\xa2\x40\x89\x89\xad\x48\xa2\x14\x92\x84\x20\x87"
block|}
block|,
if|#
directive|if
literal|0
block|{ 	EVP_aes_128_cfb8, 	"aes-cfb8-128", 	"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", 	16, 	"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", 	16, 	"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", 	"\x66\xe9\x4b\xd4\xef\x8a\x2c\x3b\x88\x4c\xfa\x59\xca\x34\x2b\x2e"     },
endif|#
directive|endif
block|{
name|EVP_des_ede3_cbc
block|,
literal|"des-ede3"
block|,
literal|"\x19\x17\xff\xe6\xbb\x77\x2e\xfc"
literal|"\x29\x76\x43\xbc\x63\x56\x7e\x9a"
literal|"\x00\x2e\x4d\x43\x1d\x5f\xfd\x58"
block|,
literal|24
block|,
literal|"\xbf\x9a\x12\xb7\x26\x69\xfd\x05"
block|,
literal|16
block|,
literal|"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
block|,
literal|"\x55\x95\x97\x76\xa9\x6c\x66\x40\x64\xc7\xf4\x1c\x21\xb7\x14\x1b"
block|}
block|,
if|#
directive|if
literal|0
block|{ 	EVP_camellia_128_cbc, 	"camellia128", 	"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", 	16, 	"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", 	16, 	"\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", 	"\x07\x92\x3A\x39\xEB\x0A\x81\x7D\x1C\x4D\x87\xBD\xB8\x2D\x1F\x1C", 	NULL     },
endif|#
directive|endif
block|{
name|EVP_rc4
block|,
literal|"rc4 8"
block|,
literal|"\x01\x23\x45\x67\x89\xAB\xCD\xEF"
block|,
literal|8
block|,
name|NULL
block|,
literal|8
block|,
literal|"\x00\x00\x00\x00\x00\x00\x00\x00"
block|,
literal|"\x74\x94\xC2\xE7\x10\x4B\x08\x79"
block|,
name|NULL
block|}
block|,
block|{
name|EVP_rc4
block|,
literal|"rc4 5"
block|,
literal|"\x61\x8a\x63\xd2\xfb"
block|,
literal|5
block|,
name|NULL
block|,
literal|5
block|,
literal|"\xdc\xee\x4c\xf9\x2c"
block|,
literal|"\xf1\x38\x29\xc9\xde"
block|,
name|NULL
block|}
block|,
block|{
name|EVP_rc4
block|,
literal|"rc4 309"
block|,
literal|"\x29\x04\x19\x72\xfb\x42\xba\x5f\xc7\x12\x77\x12\xf1\x38\x29\xc9"
block|,
literal|16
block|,
name|NULL
block|,
literal|309
block|,
literal|"\x52\x75\x69\x73\x6c\x69\x6e\x6e"
literal|"\x75\x6e\x20\x6c\x61\x75\x6c\x75"
literal|"\x20\x6b\x6f\x72\x76\x69\x73\x73"
literal|"\x73\x61\x6e\x69\x2c\x20\x74\xe4"
literal|"\x68\x6b\xe4\x70\xe4\x69\x64\x65"
literal|"\x6e\x20\x70\xe4\xe4\x6c\x6c\xe4"
literal|"\x20\x74\xe4\x79\x73\x69\x6b\x75"
literal|"\x75\x2e\x20\x4b\x65\x73\xe4\x79"
literal|"\xf6\x6e\x20\x6f\x6e\x20\x6f\x6e"
literal|"\x6e\x69\x20\x6f\x6d\x61\x6e\x61"
literal|"\x6e\x69\x2c\x20\x6b\x61\x73\x6b"
literal|"\x69\x73\x61\x76\x75\x75\x6e\x20"
literal|"\x6c\x61\x61\x6b\x73\x6f\x74\x20"
literal|"\x76\x65\x72\x68\x6f\x75\x75\x2e"
literal|"\x20\x45\x6e\x20\x6d\x61\x20\x69"
literal|"\x6c\x6f\x69\x74\x73\x65\x2c\x20"
literal|"\x73\x75\x72\x65\x20\x68\x75\x6f"
literal|"\x6b\x61\x61\x2c\x20\x6d\x75\x74"
literal|"\x74\x61\x20\x6d\x65\x74\x73\xe4"
literal|"\x6e\x20\x74\x75\x6d\x6d\x75\x75"
literal|"\x73\x20\x6d\x75\x6c\x6c\x65\x20"
literal|"\x74\x75\x6f\x6b\x61\x61\x2e\x20"
literal|"\x50\x75\x75\x6e\x74\x6f\x20\x70"
literal|"\x69\x6c\x76\x65\x6e\x2c\x20\x6d"
literal|"\x69\x20\x68\x75\x6b\x6b\x75\x75"
literal|"\x2c\x20\x73\x69\x69\x6e\x74\x6f"
literal|"\x20\x76\x61\x72\x61\x6e\x20\x74"
literal|"\x75\x75\x6c\x69\x73\x65\x6e\x2c"
literal|"\x20\x6d\x69\x20\x6e\x75\x6b\x6b"
literal|"\x75\x75\x2e\x20\x54\x75\x6f\x6b"
literal|"\x73\x75\x74\x20\x76\x61\x6e\x61"
literal|"\x6d\x6f\x6e\x20\x6a\x61\x20\x76"
literal|"\x61\x72\x6a\x6f\x74\x20\x76\x65"
literal|"\x65\x6e\x2c\x20\x6e\x69\x69\x73"
literal|"\x74\xe4\x20\x73\x79\x64\xe4\x6d"
literal|"\x65\x6e\x69\x20\x6c\x61\x75\x6c"
literal|"\x75\x6e\x20\x74\x65\x65\x6e\x2e"
literal|"\x20\x2d\x20\x45\x69\x6e\x6f\x20"
literal|"\x4c\x65\x69\x6e\x6f"
block|,
literal|"\x35\x81\x86\x99\x90\x01\xe6\xb5"
literal|"\xda\xf0\x5e\xce\xeb\x7e\xee\x21"
literal|"\xe0\x68\x9c\x1f\x00\xee\xa8\x1f"
literal|"\x7d\xd2\xca\xae\xe1\xd2\x76\x3e"
literal|"\x68\xaf\x0e\xad\x33\xd6\x6c\x26"
literal|"\x8b\xc9\x46\xc4\x84\xfb\xe9\x4c"
literal|"\x5f\x5e\x0b\x86\xa5\x92\x79\xe4"
literal|"\xf8\x24\xe7\xa6\x40\xbd\x22\x32"
literal|"\x10\xb0\xa6\x11\x60\xb7\xbc\xe9"
literal|"\x86\xea\x65\x68\x80\x03\x59\x6b"
literal|"\x63\x0a\x6b\x90\xf8\xe0\xca\xf6"
literal|"\x91\x2a\x98\xeb\x87\x21\x76\xe8"
literal|"\x3c\x20\x2c\xaa\x64\x16\x6d\x2c"
literal|"\xce\x57\xff\x1b\xca\x57\xb2\x13"
literal|"\xf0\xed\x1a\xa7\x2f\xb8\xea\x52"
literal|"\xb0\xbe\x01\xcd\x1e\x41\x28\x67"
literal|"\x72\x0b\x32\x6e\xb3\x89\xd0\x11"
literal|"\xbd\x70\xd8\xaf\x03\x5f\xb0\xd8"
literal|"\x58\x9d\xbc\xe3\xc6\x66\xf5\xea"
literal|"\x8d\x4c\x79\x54\xc5\x0c\x3f\x34"
literal|"\x0b\x04\x67\xf8\x1b\x42\x59\x61"
literal|"\xc1\x18\x43\x07\x4d\xf6\x20\xf2"
literal|"\x08\x40\x4b\x39\x4c\xf9\xd3\x7f"
literal|"\xf5\x4b\x5f\x1a\xd8\xf6\xea\x7d"
literal|"\xa3\xc5\x61\xdf\xa7\x28\x1f\x96"
literal|"\x44\x63\xd2\xcc\x35\xa4\xd1\xb0"
literal|"\x34\x90\xde\xc5\x1b\x07\x11\xfb"
literal|"\xd6\xf5\x5f\x79\x23\x4d\x5b\x7c"
literal|"\x76\x66\x22\xa6\x6d\xe9\x2b\xe9"
literal|"\x96\x46\x1d\x5e\x4d\xc8\x78\xef"
literal|"\x9b\xca\x03\x05\x21\xe8\x35\x1e"
literal|"\x4b\xae\xd2\xfd\x04\xf9\x46\x73"
literal|"\x68\xc4\xad\x6a\xc1\x86\xd0\x82"
literal|"\x45\xb2\x63\xa2\x66\x6d\x1f\x6c"
literal|"\x54\x20\xf1\x59\x9d\xfd\x9f\x43"
literal|"\x89\x21\xc2\xf5\xa4\x63\x93\x8c"
literal|"\xe0\x98\x22\x65\xee\xf7\x01\x79"
literal|"\xbc\x55\x3f\x33\x9e\xb1\xa4\xc1"
literal|"\xaf\x5f\x6a\x54\x7f"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|test_cipher
parameter_list|(
name|struct
name|tests
modifier|*
name|t
parameter_list|)
block|{
specifier|const
name|EVP_CIPHER
modifier|*
name|c
init|=
name|t
operator|->
name|cipher
argument_list|()
decl_stmt|;
name|EVP_CIPHER_CTX
name|ectx
decl_stmt|;
name|EVP_CIPHER_CTX
name|dctx
decl_stmt|;
name|void
modifier|*
name|d
decl_stmt|;
name|EVP_CIPHER_CTX_init
argument_list|(
operator|&
name|ectx
argument_list|)
expr_stmt|;
name|EVP_CIPHER_CTX_init
argument_list|(
operator|&
name|dctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_CipherInit_ex
argument_list|(
operator|&
name|ectx
argument_list|,
name|c
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: EVP_CipherInit_ex einit"
argument_list|,
name|t
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_CipherInit_ex
argument_list|(
operator|&
name|dctx
argument_list|,
name|c
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: EVP_CipherInit_ex dinit"
argument_list|,
name|t
operator|->
name|name
argument_list|)
expr_stmt|;
name|EVP_CIPHER_CTX_set_key_length
argument_list|(
operator|&
name|ectx
argument_list|,
name|t
operator|->
name|keysize
argument_list|)
expr_stmt|;
name|EVP_CIPHER_CTX_set_key_length
argument_list|(
operator|&
name|dctx
argument_list|,
name|t
operator|->
name|keysize
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_CipherInit_ex
argument_list|(
operator|&
name|ectx
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|t
operator|->
name|key
argument_list|,
name|t
operator|->
name|iv
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: EVP_CipherInit_ex encrypt"
argument_list|,
name|t
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_CipherInit_ex
argument_list|(
operator|&
name|dctx
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|t
operator|->
name|key
argument_list|,
name|t
operator|->
name|iv
argument_list|,
literal|0
argument_list|)
operator|!=
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: EVP_CipherInit_ex decrypt"
argument_list|,
name|t
operator|->
name|name
argument_list|)
expr_stmt|;
name|d
operator|=
name|emalloc
argument_list|(
name|t
operator|->
name|datasize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EVP_Cipher
argument_list|(
operator|&
name|ectx
argument_list|,
name|d
argument_list|,
name|t
operator|->
name|indata
argument_list|,
name|t
operator|->
name|datasize
argument_list|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|memcmp
argument_list|(
name|d
argument_list|,
name|t
operator|->
name|outdata
argument_list|,
name|t
operator|->
name|datasize
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: encrypt not the same"
argument_list|,
name|t
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EVP_Cipher
argument_list|(
operator|&
name|dctx
argument_list|,
name|d
argument_list|,
name|d
argument_list|,
name|t
operator|->
name|datasize
argument_list|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|memcmp
argument_list|(
name|d
argument_list|,
name|t
operator|->
name|indata
argument_list|,
name|t
operator|->
name|datasize
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: decrypt not the same"
argument_list|,
name|t
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|outiv
condition|)
comment|/* XXXX check  */
empty_stmt|;
name|EVP_CIPHER_CTX_cleanup
argument_list|(
operator|&
name|ectx
argument_list|)
expr_stmt|;
name|EVP_CIPHER_CTX_cleanup
argument_list|(
operator|&
name|dctx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|d
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|check_hmac
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|char
name|hmackey
index|[]
init|=
literal|"hello-world"
decl_stmt|;
name|size_t
name|hmackey_size
init|=
sizeof|sizeof
argument_list|(
name|hmackey
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|hmaclen
decl_stmt|;
name|unsigned
name|char
name|hmac
index|[
name|EVP_MAX_MD_SIZE
index|]
decl_stmt|;
name|HMAC_CTX
name|c
decl_stmt|;
name|char
name|answer
index|[
literal|20
index|]
init|=
literal|"\x2c\xfa\x32\xb7\x2b\x8a\xf6\xdf\xcf\xda"
literal|"\x6f\xd1\x52\x4d\x54\x58\x73\x0f\xf3\x24"
decl_stmt|;
name|HMAC_CTX_init
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
name|HMAC_Init_ex
argument_list|(
operator|&
name|c
argument_list|,
name|hmackey
argument_list|,
name|hmackey_size
argument_list|,
name|EVP_sha1
argument_list|()
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|HMAC_Update
argument_list|(
operator|&
name|c
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|HMAC_Final
argument_list|(
operator|&
name|c
argument_list|,
name|hmac
argument_list|,
operator|&
name|hmaclen
argument_list|)
expr_stmt|;
name|HMAC_CTX_cleanup
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|hmaclen
operator|!=
literal|20
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hmaclen = %d\n"
argument_list|,
operator|(
name|int
operator|)
name|hmaclen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ct_memcmp
argument_list|(
name|hmac
argument_list|,
name|answer
argument_list|,
name|hmaclen
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"wrong answer\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hcrypto_validate
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|int
name|validated
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
comment|/* its ok to run this twice, do don't check for races */
if|if
condition|(
name|validated
condition|)
return|return;
name|validated
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|hc_tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|hc_tests
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
name|test_cipher
argument_list|(
operator|&
name|hc_tests
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|check_hmac
argument_list|()
expr_stmt|;
block|}
end_function

end_unit


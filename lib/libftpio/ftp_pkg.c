begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c)1995, 1996 Jordan Hubbard  *  * All rights reserved.  *  * This source code may be used, modified, copied, distributed, and  * sold, in both source and binary form provided that the above  * copyright and these terms are retained, verbatim, as the first  * lines of this file.  Under no circumstances is the author  * responsible for the proper functioning of the software nor does  * the author assume any responsibility for damages incurred with  * its use.  *  * $Id: ftp_pkg.c,v 1.1.1.1 1996/06/17 12:26:06 jkh Exp $  *  * TCL Interface code for functions provided by the ftp library.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ftpio.h>
end_include

begin_include
include|#
directive|include
file|"ftp_pkg.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|TRUE
end_ifndef

begin_define
define|#
directive|define
name|TRUE
value|(1)
end_define

begin_define
define|#
directive|define
name|FALSE
value|(0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|CHECK_ARGS
parameter_list|(
name|cnt
parameter_list|,
name|myname
parameter_list|,
name|str
parameter_list|)
define|\
value|if (argc<= (cnt)) { sprintf(interp->result, "usage: %s %s", myname, str); return TCL_ERROR; }
end_define

begin_define
define|#
directive|define
name|USAGE
parameter_list|(
name|myname
parameter_list|,
name|msg
parameter_list|)
define|\
value|{ fprintf(stderr, "%s: %s\n", myname, msg); return TCL_ERROR; }
end_define

begin_comment
comment|/* Registration function */
end_comment

begin_function
name|int
name|Ftp_Init
parameter_list|(
name|Tcl_Interp
modifier|*
name|interp
parameter_list|)
block|{
name|Tcl_CreateCommand
argument_list|(
name|interp
argument_list|,
literal|"ftp_login"
argument_list|,
name|Ftp_login
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|Tcl_CreateCommand
argument_list|(
name|interp
argument_list|,
literal|"ftp_chdir"
argument_list|,
name|Ftp_chdir
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|Tcl_CreateCommand
argument_list|(
name|interp
argument_list|,
literal|"ftp_getsize"
argument_list|,
name|Ftp_getsize
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|Tcl_CreateCommand
argument_list|(
name|interp
argument_list|,
literal|"ftp_get"
argument_list|,
name|Ftp_get
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|Tcl_CreateCommand
argument_list|(
name|interp
argument_list|,
literal|"ftp_put"
argument_list|,
name|Ftp_put
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|Tcl_CreateCommand
argument_list|(
name|interp
argument_list|,
literal|"ftp_binary"
argument_list|,
name|Ftp_binary
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|Tcl_CreateCommand
argument_list|(
name|interp
argument_list|,
literal|"ftp_passive"
argument_list|,
name|Ftp_passive
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|Tcl_CreateCommand
argument_list|(
name|interp
argument_list|,
literal|"ftp_get_url"
argument_list|,
name|Ftp_get_url
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|Tcl_CreateCommand
argument_list|(
name|interp
argument_list|,
literal|"ftp_put_url"
argument_list|,
name|Ftp_put_url
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|TCL_OK
return|;
block|}
end_function

begin_comment
comment|/*  * ftp_login  host user passwd port  *  -- returns new fileId  *   */
end_comment

begin_function
name|int
name|Ftp_login
parameter_list|(
name|ClientData
name|clientData
parameter_list|,
name|Tcl_Interp
modifier|*
name|interp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|user
decl_stmt|,
modifier|*
name|pass
decl_stmt|;
name|int
name|port
decl_stmt|;
name|CHECK_ARGS
argument_list|(
literal|1
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"host [user] [passwd] [port]"
argument_list|)
expr_stmt|;
name|user
operator|=
operator|(
name|argc
operator|>
literal|2
operator|)
condition|?
name|argv
index|[
literal|2
index|]
else|:
literal|"ftp"
expr_stmt|;
name|pass
operator|=
operator|(
name|argc
operator|>
literal|3
operator|)
condition|?
name|argv
index|[
literal|3
index|]
else|:
literal|"setup@"
expr_stmt|;
name|port
operator|=
operator|(
name|argc
operator|>
literal|4
operator|)
condition|?
name|atoi
argument_list|(
name|argv
index|[
literal|4
index|]
argument_list|)
else|:
literal|21
expr_stmt|;
comment|/* Debug("ftp_pkg: attempt login to host %s using %s/%s (port %d)", argv[1], user, pass, port); */
name|fp
operator|=
name|ftpLogin
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|user
argument_list|,
name|pass
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
condition|)
block|{
comment|/* Debug("ftp_pkg: logged successfully into host %s", argv[1]); */
name|Tcl_EnterFile
argument_list|(
name|interp
argument_list|,
name|fp
argument_list|,
name|TCL_FILE_READABLE
operator||
name|TCL_FILE_WRITABLE
argument_list|)
expr_stmt|;
return|return
name|TCL_OK
return|;
block|}
comment|/* Debug("ftp_pkg: login operation failed for host %s", argv[1]); */
return|return
name|TCL_ERROR
return|;
block|}
end_function

begin_comment
comment|/*  * ftp_chdir  file-handle newdir  *  -- returns status  */
end_comment

begin_function
name|int
name|Ftp_chdir
parameter_list|(
name|ClientData
name|clientData
parameter_list|,
name|Tcl_Interp
modifier|*
name|interp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|CHECK_ARGS
argument_list|(
literal|2
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"fileId directory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Tcl_GetOpenFile
argument_list|(
name|interp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|fp
argument_list|)
operator|!=
name|TCL_OK
condition|)
return|return
name|TCL_ERROR
return|;
comment|/* Debug("ftp_pkg: attempt chdir to dir %s", argv[2]); */
if|if
condition|(
operator|!
name|ftpChdir
argument_list|(
name|fp
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
condition|)
block|{
comment|/* Debug("ftp_pkg: chdir successful"); */
return|return
name|TCL_OK
return|;
block|}
comment|/* Debug("ftp_pkg: chdir failed"); */
return|return
name|TCL_ERROR
return|;
block|}
end_function

begin_comment
comment|/*  * ftp_getsize  file-handle filename  *  -- returns size  */
end_comment

begin_function
name|int
name|Ftp_getsize
parameter_list|(
name|ClientData
name|clientData
parameter_list|,
name|Tcl_Interp
modifier|*
name|interp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|sz
decl_stmt|;
name|CHECK_ARGS
argument_list|(
literal|2
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"fileId filename"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Tcl_GetOpenFile
argument_list|(
name|interp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|fp
argument_list|)
operator|!=
name|TCL_OK
condition|)
return|return
name|TCL_ERROR
return|;
comment|/* Debug("ftp_pkg: attempt to get size of %s", argv[2]); */
if|if
condition|(
operator|(
name|sz
operator|=
name|ftpGetSize
argument_list|(
name|fp
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
comment|/* Debug("ftp_pkg: getsize successful (%d)", sz); */
name|sprintf
argument_list|(
name|interp
operator|->
name|result
argument_list|,
literal|"%d"
argument_list|,
name|sz
argument_list|)
expr_stmt|;
return|return
name|TCL_OK
return|;
block|}
comment|/* Debug("ftp_pkg: chdir failed"); */
return|return
name|TCL_ERROR
return|;
block|}
end_function

begin_comment
comment|/*  * ftp_get  fileId filename  *  -- returns new fileId for filename  *   */
end_comment

begin_function
name|int
name|Ftp_get
parameter_list|(
name|ClientData
name|clientData
parameter_list|,
name|Tcl_Interp
modifier|*
name|interp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|,
modifier|*
name|fp2
decl_stmt|;
name|CHECK_ARGS
argument_list|(
literal|2
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"fileId filename"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Tcl_GetOpenFile
argument_list|(
name|interp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|fp
argument_list|)
operator|!=
name|TCL_OK
condition|)
return|return
name|TCL_ERROR
return|;
comment|/* Debug("ftp_pkg: attempt to get file %s", argv[2]); */
name|fp2
operator|=
name|ftpGet
argument_list|(
name|fp
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp2
condition|)
block|{
comment|/* Debug("ftp_pkg: get operation successful for: %s", argv[2]); */
name|Tcl_EnterFile
argument_list|(
name|interp
argument_list|,
name|fp2
argument_list|,
name|TCL_FILE_READABLE
argument_list|)
expr_stmt|;
return|return
name|TCL_OK
return|;
block|}
comment|/* Debug("ftp_pkg: get operation failed for file %s", argv[2]); */
return|return
name|TCL_ERROR
return|;
block|}
end_function

begin_comment
comment|/*  * ftp_put  fileId filename  *  -- returns new fileId for filename  *   */
end_comment

begin_function
name|int
name|Ftp_put
parameter_list|(
name|ClientData
name|clientData
parameter_list|,
name|Tcl_Interp
modifier|*
name|interp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|,
modifier|*
name|fp2
decl_stmt|;
name|CHECK_ARGS
argument_list|(
literal|2
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"fileId filename"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Tcl_GetOpenFile
argument_list|(
name|interp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|fp
argument_list|)
operator|!=
name|TCL_OK
condition|)
return|return
name|TCL_ERROR
return|;
comment|/* Debug("ftp_pkg: attempt to put file %s", argv[2]); */
name|fp2
operator|=
name|ftpPut
argument_list|(
name|fp
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp2
condition|)
block|{
comment|/* Debug("ftp_pkg: put operation successful for: %s", argv[2]); */
name|Tcl_EnterFile
argument_list|(
name|interp
argument_list|,
name|fp2
argument_list|,
name|TCL_FILE_READABLE
argument_list|)
expr_stmt|;
return|return
name|TCL_OK
return|;
block|}
comment|/* Debug("ftp_pkg: put operation failed for file %s", argv[2]); */
return|return
name|TCL_ERROR
return|;
block|}
end_function

begin_comment
comment|/*  * ftp_binary  fileId value  *  -- Set binary mode to truth value for FTP session represented by fileId  *   */
end_comment

begin_function
name|int
name|Ftp_binary
parameter_list|(
name|ClientData
name|clientData
parameter_list|,
name|Tcl_Interp
modifier|*
name|interp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|CHECK_ARGS
argument_list|(
literal|1
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"fileId"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Tcl_GetOpenFile
argument_list|(
name|interp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|fp
argument_list|)
operator|!=
name|TCL_OK
condition|)
return|return
name|TCL_ERROR
return|;
comment|/* Debug("ftp_pkg: set binary mode"); */
name|ftpBinary
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|TCL_OK
return|;
block|}
end_function

begin_comment
comment|/*  * ftp_passive  fileId value  *  -- Set passive mode to truth value for FTP session represented by fileId  *   */
end_comment

begin_function
name|int
name|Ftp_passive
parameter_list|(
name|ClientData
name|clientData
parameter_list|,
name|Tcl_Interp
modifier|*
name|interp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|CHECK_ARGS
argument_list|(
literal|2
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"fileId bool"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Tcl_GetOpenFile
argument_list|(
name|interp
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|fp
argument_list|)
operator|!=
name|TCL_OK
condition|)
return|return
name|TCL_ERROR
return|;
comment|/* Debug("ftp_pkg: set passive mode to %d", atoi(argv[2])); */
name|ftpPassive
argument_list|(
name|fp
argument_list|,
name|atoi
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|TCL_OK
return|;
block|}
end_function

begin_comment
comment|/*  * ftp_get_url  URL user pass  *  -- Return new fileId for open URL (using user and pass to log in)  *   */
end_comment

begin_function
name|int
name|Ftp_get_url
parameter_list|(
name|ClientData
name|clientData
parameter_list|,
name|Tcl_Interp
modifier|*
name|interp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|user
decl_stmt|,
modifier|*
name|pass
decl_stmt|;
name|CHECK_ARGS
argument_list|(
literal|1
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"URL [username] [password]"
argument_list|)
expr_stmt|;
name|user
operator|=
operator|(
name|argc
operator|>
literal|2
operator|)
condition|?
name|argv
index|[
literal|2
index|]
else|:
literal|"ftp"
expr_stmt|;
name|pass
operator|=
operator|(
name|argc
operator|>
literal|3
operator|)
condition|?
name|argv
index|[
literal|3
index|]
else|:
literal|"setup@"
expr_stmt|;
comment|/* Debug("ftp_pkg: attempt to get URL %s as %s/%s", argv[1], user, pass); */
name|fp
operator|=
name|ftpGetURL
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|user
argument_list|,
name|pass
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
condition|)
block|{
comment|/* Debug("ftp_pkg: get URL successful"); */
name|Tcl_EnterFile
argument_list|(
name|interp
argument_list|,
name|fp
argument_list|,
name|TCL_FILE_READABLE
argument_list|)
expr_stmt|;
return|return
name|TCL_OK
return|;
block|}
comment|/* Debug("ftp_pkg: get URL failed"); */
return|return
name|TCL_ERROR
return|;
block|}
end_function

begin_comment
comment|/*  * ftp_put_url  URL user pass  *  -- Return new fileId for open url (using user and pass to log in)  *   */
end_comment

begin_function
name|int
name|Ftp_put_url
parameter_list|(
name|ClientData
name|clientData
parameter_list|,
name|Tcl_Interp
modifier|*
name|interp
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|user
decl_stmt|,
modifier|*
name|pass
decl_stmt|;
name|CHECK_ARGS
argument_list|(
literal|1
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"URL [username] [password]"
argument_list|)
expr_stmt|;
name|user
operator|=
operator|(
name|argc
operator|>
literal|2
operator|)
condition|?
name|argv
index|[
literal|2
index|]
else|:
literal|"ftp"
expr_stmt|;
name|pass
operator|=
operator|(
name|argc
operator|>
literal|3
operator|)
condition|?
name|argv
index|[
literal|3
index|]
else|:
literal|"setup@"
expr_stmt|;
comment|/* Debug("ftp_pkg: attempt to put URL %s as %s/%s", argv[1], user, pass); */
name|fp
operator|=
name|ftpPutURL
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|user
argument_list|,
name|pass
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
condition|)
block|{
comment|/* Debug("ftp_pkg: put URL successful"); */
name|Tcl_EnterFile
argument_list|(
name|interp
argument_list|,
name|fp
argument_list|,
name|TCL_FILE_READABLE
argument_list|)
expr_stmt|;
return|return
name|TCL_OK
return|;
block|}
comment|/* Debug("ftp_pkg: put URL failed"); */
return|return
name|TCL_ERROR
return|;
block|}
end_function

end_unit


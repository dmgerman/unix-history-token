begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* MD2C.C - RSA Data Security, Inc., MD2 message-digest algorithm  * $FreeBSD$  */
end_comment

begin_comment
comment|/* Copyright (C) 1990-2, RSA Data Security, Inc. Created 1990. All    rights reserved.     License to copy and use this software is granted for    non-commercial Internet Privacy-Enhanced Mail provided that it is    identified as the "RSA Data Security, Inc. MD2 Message Digest    Algorithm" in all material mentioning or referencing this software    or this function.     RSA Data Security, Inc. makes no representations concerning either    the merchantability of this software or the suitability of this    software for any particular purpose. It is provided "as is"    without express or implied warranty of any kind.     These notices must be retained in any copies of any part of this    documentation and/or software.  */
end_comment

begin_include
include|#
directive|include
file|"md2.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_typedef
typedef|typedef
name|unsigned
name|char
modifier|*
name|POINTER
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|u_int16_t
name|UINT2
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|u_int32_t
name|UINT4
typedef|;
end_typedef

begin_define
define|#
directive|define
name|PROTO_LIST
parameter_list|(
name|list
parameter_list|)
value|list
end_define

begin_decl_stmt
specifier|static
name|void
name|MD2Transform
name|PROTO_LIST
argument_list|(
operator|(
name|unsigned
name|char
index|[
literal|16
index|]
operator|,
name|unsigned
name|char
index|[
literal|16
index|]
operator|,
specifier|const
name|unsigned
name|char
index|[
literal|16
index|]
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Permutation of 0..255 constructed from the digits of pi. It gives a    "random" nonlinear byte substitution operation.  */
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|PI_SUBST
index|[
literal|256
index|]
init|=
block|{
literal|41
block|,
literal|46
block|,
literal|67
block|,
literal|201
block|,
literal|162
block|,
literal|216
block|,
literal|124
block|,
literal|1
block|,
literal|61
block|,
literal|54
block|,
literal|84
block|,
literal|161
block|,
literal|236
block|,
literal|240
block|,
literal|6
block|,
literal|19
block|,
literal|98
block|,
literal|167
block|,
literal|5
block|,
literal|243
block|,
literal|192
block|,
literal|199
block|,
literal|115
block|,
literal|140
block|,
literal|152
block|,
literal|147
block|,
literal|43
block|,
literal|217
block|,
literal|188
block|,
literal|76
block|,
literal|130
block|,
literal|202
block|,
literal|30
block|,
literal|155
block|,
literal|87
block|,
literal|60
block|,
literal|253
block|,
literal|212
block|,
literal|224
block|,
literal|22
block|,
literal|103
block|,
literal|66
block|,
literal|111
block|,
literal|24
block|,
literal|138
block|,
literal|23
block|,
literal|229
block|,
literal|18
block|,
literal|190
block|,
literal|78
block|,
literal|196
block|,
literal|214
block|,
literal|218
block|,
literal|158
block|,
literal|222
block|,
literal|73
block|,
literal|160
block|,
literal|251
block|,
literal|245
block|,
literal|142
block|,
literal|187
block|,
literal|47
block|,
literal|238
block|,
literal|122
block|,
literal|169
block|,
literal|104
block|,
literal|121
block|,
literal|145
block|,
literal|21
block|,
literal|178
block|,
literal|7
block|,
literal|63
block|,
literal|148
block|,
literal|194
block|,
literal|16
block|,
literal|137
block|,
literal|11
block|,
literal|34
block|,
literal|95
block|,
literal|33
block|,
literal|128
block|,
literal|127
block|,
literal|93
block|,
literal|154
block|,
literal|90
block|,
literal|144
block|,
literal|50
block|,
literal|39
block|,
literal|53
block|,
literal|62
block|,
literal|204
block|,
literal|231
block|,
literal|191
block|,
literal|247
block|,
literal|151
block|,
literal|3
block|,
literal|255
block|,
literal|25
block|,
literal|48
block|,
literal|179
block|,
literal|72
block|,
literal|165
block|,
literal|181
block|,
literal|209
block|,
literal|215
block|,
literal|94
block|,
literal|146
block|,
literal|42
block|,
literal|172
block|,
literal|86
block|,
literal|170
block|,
literal|198
block|,
literal|79
block|,
literal|184
block|,
literal|56
block|,
literal|210
block|,
literal|150
block|,
literal|164
block|,
literal|125
block|,
literal|182
block|,
literal|118
block|,
literal|252
block|,
literal|107
block|,
literal|226
block|,
literal|156
block|,
literal|116
block|,
literal|4
block|,
literal|241
block|,
literal|69
block|,
literal|157
block|,
literal|112
block|,
literal|89
block|,
literal|100
block|,
literal|113
block|,
literal|135
block|,
literal|32
block|,
literal|134
block|,
literal|91
block|,
literal|207
block|,
literal|101
block|,
literal|230
block|,
literal|45
block|,
literal|168
block|,
literal|2
block|,
literal|27
block|,
literal|96
block|,
literal|37
block|,
literal|173
block|,
literal|174
block|,
literal|176
block|,
literal|185
block|,
literal|246
block|,
literal|28
block|,
literal|70
block|,
literal|97
block|,
literal|105
block|,
literal|52
block|,
literal|64
block|,
literal|126
block|,
literal|15
block|,
literal|85
block|,
literal|71
block|,
literal|163
block|,
literal|35
block|,
literal|221
block|,
literal|81
block|,
literal|175
block|,
literal|58
block|,
literal|195
block|,
literal|92
block|,
literal|249
block|,
literal|206
block|,
literal|186
block|,
literal|197
block|,
literal|234
block|,
literal|38
block|,
literal|44
block|,
literal|83
block|,
literal|13
block|,
literal|110
block|,
literal|133
block|,
literal|40
block|,
literal|132
block|,
literal|9
block|,
literal|211
block|,
literal|223
block|,
literal|205
block|,
literal|244
block|,
literal|65
block|,
literal|129
block|,
literal|77
block|,
literal|82
block|,
literal|106
block|,
literal|220
block|,
literal|55
block|,
literal|200
block|,
literal|108
block|,
literal|193
block|,
literal|171
block|,
literal|250
block|,
literal|36
block|,
literal|225
block|,
literal|123
block|,
literal|8
block|,
literal|12
block|,
literal|189
block|,
literal|177
block|,
literal|74
block|,
literal|120
block|,
literal|136
block|,
literal|149
block|,
literal|139
block|,
literal|227
block|,
literal|99
block|,
literal|232
block|,
literal|109
block|,
literal|233
block|,
literal|203
block|,
literal|213
block|,
literal|254
block|,
literal|59
block|,
literal|0
block|,
literal|29
block|,
literal|57
block|,
literal|242
block|,
literal|239
block|,
literal|183
block|,
literal|14
block|,
literal|102
block|,
literal|88
block|,
literal|208
block|,
literal|228
block|,
literal|166
block|,
literal|119
block|,
literal|114
block|,
literal|248
block|,
literal|235
block|,
literal|117
block|,
literal|75
block|,
literal|10
block|,
literal|49
block|,
literal|68
block|,
literal|80
block|,
literal|180
block|,
literal|143
block|,
literal|237
block|,
literal|31
block|,
literal|26
block|,
literal|219
block|,
literal|153
block|,
literal|141
block|,
literal|51
block|,
literal|159
block|,
literal|17
block|,
literal|131
block|,
literal|20
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
modifier|*
name|PADDING
index|[]
init|=
block|{
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|""
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\001"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\002\002"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\003\003\003"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\004\004\004\004"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\005\005\005\005\005"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\006\006\006\006\006\006"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\007\007\007\007\007\007\007"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\010\010\010\010\010\010\010\010"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\011\011\011\011\011\011\011\011\011"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\012\012\012\012\012\012\012\012\012\012"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\013\013\013\013\013\013\013\013\013\013\013"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\014\014\014\014\014\014\014\014\014\014\014\014"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\015\015\015\015\015\015\015\015\015\015\015\015\015"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\016\016\016\016\016\016\016\016\016\016\016\016\016\016"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\017\017\017\017\017\017\017\017\017\017\017\017\017\017\017"
block|,
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|"\020\020\020\020\020\020\020\020\020\020\020\020\020\020\020\020"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* MD2 initialization. Begins an MD2 operation, writing a new context.  */
end_comment

begin_function
name|void
name|MD2Init
parameter_list|(
name|context
parameter_list|)
name|MD2_CTX
modifier|*
name|context
decl_stmt|;
comment|/* context */
block|{
name|context
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|(
name|POINTER
operator|)
name|context
operator|->
name|state
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
operator|->
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|POINTER
operator|)
name|context
operator|->
name|checksum
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
operator|->
name|checksum
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* MD2 block update operation. Continues an MD2 message-digest      operation, processing another message block, and updating the      context.  */
end_comment

begin_function
name|void
name|MD2Update
parameter_list|(
name|context
parameter_list|,
name|input
parameter_list|,
name|inputLen
parameter_list|)
name|MD2_CTX
modifier|*
name|context
decl_stmt|;
comment|/* context */
specifier|const
name|unsigned
name|char
modifier|*
name|input
decl_stmt|;
comment|/* input block */
name|unsigned
name|int
name|inputLen
decl_stmt|;
comment|/* length of input block */
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|index
decl_stmt|,
name|partLen
decl_stmt|;
comment|/* Update number of bytes mod 16 */
name|index
operator|=
name|context
operator|->
name|count
expr_stmt|;
name|context
operator|->
name|count
operator|=
operator|(
name|index
operator|+
name|inputLen
operator|)
operator|&
literal|0xf
expr_stmt|;
name|partLen
operator|=
literal|16
operator|-
name|index
expr_stmt|;
comment|/* Transform as many times as possible.     */
if|if
condition|(
name|inputLen
operator|>=
name|partLen
condition|)
block|{
name|memcpy
argument_list|(
operator|(
name|POINTER
operator|)
operator|&
name|context
operator|->
name|buffer
index|[
name|index
index|]
argument_list|,
operator|(
name|POINTER
operator|)
name|input
argument_list|,
name|partLen
argument_list|)
expr_stmt|;
name|MD2Transform
argument_list|(
name|context
operator|->
name|state
argument_list|,
name|context
operator|->
name|checksum
argument_list|,
name|context
operator|->
name|buffer
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|partLen
init|;
name|i
operator|+
literal|15
operator|<
name|inputLen
condition|;
name|i
operator|+=
literal|16
control|)
name|MD2Transform
argument_list|(
name|context
operator|->
name|state
argument_list|,
name|context
operator|->
name|checksum
argument_list|,
operator|&
name|input
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|index
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|i
operator|=
literal|0
expr_stmt|;
comment|/* Buffer remaining input */
name|memcpy
argument_list|(
operator|(
name|POINTER
operator|)
operator|&
name|context
operator|->
name|buffer
index|[
name|index
index|]
argument_list|,
operator|(
name|POINTER
operator|)
operator|&
name|input
index|[
name|i
index|]
argument_list|,
name|inputLen
operator|-
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* MD2 padding.  */
end_comment

begin_function
name|void
name|MD2Pad
parameter_list|(
name|context
parameter_list|)
name|MD2_CTX
modifier|*
name|context
decl_stmt|;
comment|/* context */
block|{
name|unsigned
name|int
name|index
decl_stmt|,
name|padLen
decl_stmt|;
comment|/* Pad out to multiple of 16.    */
name|index
operator|=
name|context
operator|->
name|count
expr_stmt|;
name|padLen
operator|=
literal|16
operator|-
name|index
expr_stmt|;
name|MD2Update
argument_list|(
name|context
argument_list|,
name|PADDING
index|[
name|padLen
index|]
argument_list|,
name|padLen
argument_list|)
expr_stmt|;
comment|/* Extend with checksum */
name|MD2Update
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|checksum
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* MD2 finalization. Ends an MD2 message-digest operation, writing the      message digest and zeroizing the context.  */
end_comment

begin_function
name|void
name|MD2Final
parameter_list|(
name|digest
parameter_list|,
name|context
parameter_list|)
name|unsigned
name|char
name|digest
index|[
literal|16
index|]
decl_stmt|;
comment|/* message digest */
name|MD2_CTX
modifier|*
name|context
decl_stmt|;
comment|/* context */
block|{
comment|/* Do padding */
name|MD2Pad
argument_list|(
name|context
argument_list|)
expr_stmt|;
comment|/* Store state in digest */
name|memcpy
argument_list|(
operator|(
name|POINTER
operator|)
name|digest
argument_list|,
operator|(
name|POINTER
operator|)
name|context
operator|->
name|state
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* Zeroize sensitive information.    */
name|memset
argument_list|(
operator|(
name|POINTER
operator|)
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|context
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* MD2 basic transformation. Transforms state and updates checksum      based on block.  */
end_comment

begin_function
specifier|static
name|void
name|MD2Transform
parameter_list|(
name|state
parameter_list|,
name|checksum
parameter_list|,
name|block
parameter_list|)
name|unsigned
name|char
name|state
index|[
literal|16
index|]
decl_stmt|;
name|unsigned
name|char
name|checksum
index|[
literal|16
index|]
decl_stmt|;
specifier|const
name|unsigned
name|char
name|block
index|[
literal|16
index|]
decl_stmt|;
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|t
decl_stmt|;
name|unsigned
name|char
name|x
index|[
literal|48
index|]
decl_stmt|;
comment|/* Form encryption block from state, block, state ^ block.    */
name|memcpy
argument_list|(
operator|(
name|POINTER
operator|)
name|x
argument_list|,
operator|(
name|POINTER
operator|)
name|state
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|POINTER
operator|)
name|x
operator|+
literal|16
argument_list|,
operator|(
name|POINTER
operator|)
name|block
argument_list|,
literal|16
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|x
index|[
name|i
operator|+
literal|32
index|]
operator|=
name|state
index|[
name|i
index|]
operator|^
name|block
index|[
name|i
index|]
expr_stmt|;
comment|/* Encrypt block (18 rounds).    */
name|t
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|18
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|48
condition|;
name|j
operator|++
control|)
name|t
operator|=
name|x
index|[
name|j
index|]
operator|^=
name|PI_SUBST
index|[
name|t
index|]
expr_stmt|;
name|t
operator|=
operator|(
name|t
operator|+
name|i
operator|)
operator|&
literal|0xff
expr_stmt|;
block|}
comment|/* Save new state */
name|memcpy
argument_list|(
operator|(
name|POINTER
operator|)
name|state
argument_list|,
operator|(
name|POINTER
operator|)
name|x
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* Update checksum.    */
name|t
operator|=
name|checksum
index|[
literal|15
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|t
operator|=
name|checksum
index|[
name|i
index|]
operator|^=
name|PI_SUBST
index|[
name|block
index|[
name|i
index|]
operator|^
name|t
index|]
expr_stmt|;
comment|/* Zeroize sensitive information.    */
name|memset
argument_list|(
operator|(
name|POINTER
operator|)
name|x
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|x
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   *  Routines in this file based on the work of Volker Lendecke,  *  Adapted for ncplib by Boris Popov  *  Please note that ncpl_crypt.c file should be indentical to this one  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_comment
comment|/*$*********************************************************    $*    $* This code has been taken from DDJ 11/93, from an     $* article by Pawel Szczerbina.    $*    $* Password encryption routines follow.    $* Converted to C from Barry Nance's Pascal    $* prog published in the March -93 issue of Byte.    $*    $* Adapted to be useable for ncpfs by     $* Volker Lendecke<lendecke@namu01.gwdg.de> in     $* October 1995.     $*    $********************************************************* */
end_comment

begin_typedef
typedef|typedef
name|unsigned
name|char
name|buf32
index|[
literal|32
index|]
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|encrypttable
index|[
literal|256
index|]
init|=
block|{
literal|0x7
block|,
literal|0x8
block|,
literal|0x0
block|,
literal|0x8
block|,
literal|0x6
block|,
literal|0x4
block|,
literal|0xE
block|,
literal|0x4
block|,
literal|0x5
block|,
literal|0xC
block|,
literal|0x1
block|,
literal|0x7
block|,
literal|0xB
block|,
literal|0xF
block|,
literal|0xA
block|,
literal|0x8
block|,
literal|0xF
block|,
literal|0x8
block|,
literal|0xC
block|,
literal|0xC
block|,
literal|0x9
block|,
literal|0x4
block|,
literal|0x1
block|,
literal|0xE
block|,
literal|0x4
block|,
literal|0x6
block|,
literal|0x2
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0xA
block|,
literal|0xB
block|,
literal|0x9
block|,
literal|0x2
block|,
literal|0xF
block|,
literal|0xB
block|,
literal|0x1
block|,
literal|0xD
block|,
literal|0x2
block|,
literal|0x1
block|,
literal|0x9
block|,
literal|0x5
block|,
literal|0xE
block|,
literal|0x7
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x2
block|,
literal|0x6
block|,
literal|0x6
block|,
literal|0x0
block|,
literal|0x7
block|,
literal|0x3
block|,
literal|0x8
block|,
literal|0x2
block|,
literal|0x9
block|,
literal|0x3
block|,
literal|0xF
block|,
literal|0x7
block|,
literal|0xF
block|,
literal|0xC
block|,
literal|0xF
block|,
literal|0x6
block|,
literal|0x4
block|,
literal|0xA
block|,
literal|0x0
block|,
literal|0x2
block|,
literal|0x3
block|,
literal|0xA
block|,
literal|0xB
block|,
literal|0xD
block|,
literal|0x8
block|,
literal|0x3
block|,
literal|0xA
block|,
literal|0x1
block|,
literal|0x7
block|,
literal|0xC
block|,
literal|0xF
block|,
literal|0x1
block|,
literal|0x8
block|,
literal|0x9
block|,
literal|0xD
block|,
literal|0x9
block|,
literal|0x1
block|,
literal|0x9
block|,
literal|0x4
block|,
literal|0xE
block|,
literal|0x4
block|,
literal|0xC
block|,
literal|0x5
block|,
literal|0x5
block|,
literal|0xC
block|,
literal|0x8
block|,
literal|0xB
block|,
literal|0x2
block|,
literal|0x3
block|,
literal|0x9
block|,
literal|0xE
block|,
literal|0x7
block|,
literal|0x7
block|,
literal|0x6
block|,
literal|0x9
block|,
literal|0xE
block|,
literal|0xF
block|,
literal|0xC
block|,
literal|0x8
block|,
literal|0xD
block|,
literal|0x1
block|,
literal|0xA
block|,
literal|0x6
block|,
literal|0xE
block|,
literal|0xD
block|,
literal|0x0
block|,
literal|0x7
block|,
literal|0x7
block|,
literal|0xA
block|,
literal|0x0
block|,
literal|0x1
block|,
literal|0xF
block|,
literal|0x5
block|,
literal|0x4
block|,
literal|0xB
block|,
literal|0x7
block|,
literal|0xB
block|,
literal|0xE
block|,
literal|0xC
block|,
literal|0x9
block|,
literal|0x5
block|,
literal|0xD
block|,
literal|0x1
block|,
literal|0xB
block|,
literal|0xD
block|,
literal|0x1
block|,
literal|0x3
block|,
literal|0x5
block|,
literal|0xD
block|,
literal|0xE
block|,
literal|0x6
block|,
literal|0x3
block|,
literal|0x0
block|,
literal|0xB
block|,
literal|0xB
block|,
literal|0xF
block|,
literal|0x3
block|,
literal|0x6
block|,
literal|0x4
block|,
literal|0x9
block|,
literal|0xD
block|,
literal|0xA
block|,
literal|0x3
block|,
literal|0x1
block|,
literal|0x4
block|,
literal|0x9
block|,
literal|0x4
block|,
literal|0x8
block|,
literal|0x3
block|,
literal|0xB
block|,
literal|0xE
block|,
literal|0x5
block|,
literal|0x0
block|,
literal|0x5
block|,
literal|0x2
block|,
literal|0xC
block|,
literal|0xB
block|,
literal|0xD
block|,
literal|0x5
block|,
literal|0xD
block|,
literal|0x5
block|,
literal|0xD
block|,
literal|0x2
block|,
literal|0xD
block|,
literal|0x9
block|,
literal|0xA
block|,
literal|0xC
block|,
literal|0xA
block|,
literal|0x0
block|,
literal|0xB
block|,
literal|0x3
block|,
literal|0x5
block|,
literal|0x3
block|,
literal|0x6
block|,
literal|0x9
block|,
literal|0x5
block|,
literal|0x1
block|,
literal|0xE
block|,
literal|0xE
block|,
literal|0x0
block|,
literal|0xE
block|,
literal|0x8
block|,
literal|0x2
block|,
literal|0xD
block|,
literal|0x2
block|,
literal|0x2
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0xF
block|,
literal|0x8
block|,
literal|0x5
block|,
literal|0x9
block|,
literal|0x6
block|,
literal|0x8
block|,
literal|0x6
block|,
literal|0xB
block|,
literal|0xA
block|,
literal|0xB
block|,
literal|0xF
block|,
literal|0x0
block|,
literal|0x7
block|,
literal|0x2
block|,
literal|0x8
block|,
literal|0xC
block|,
literal|0x7
block|,
literal|0x3
block|,
literal|0xA
block|,
literal|0x1
block|,
literal|0x4
block|,
literal|0x2
block|,
literal|0x5
block|,
literal|0xF
block|,
literal|0x7
block|,
literal|0xA
block|,
literal|0xC
block|,
literal|0xE
block|,
literal|0x5
block|,
literal|0x9
block|,
literal|0x3
block|,
literal|0xE
block|,
literal|0x7
block|,
literal|0x1
block|,
literal|0x2
block|,
literal|0xE
block|,
literal|0x1
block|,
literal|0xF
block|,
literal|0x4
block|,
literal|0xA
block|,
literal|0x6
block|,
literal|0xC
block|,
literal|0x6
block|,
literal|0xF
block|,
literal|0x4
block|,
literal|0x3
block|,
literal|0x0
block|,
literal|0xC
block|,
literal|0x0
block|,
literal|0x3
block|,
literal|0x6
block|,
literal|0xF
block|,
literal|0x8
block|,
literal|0x7
block|,
literal|0xB
block|,
literal|0x2
block|,
literal|0xD
block|,
literal|0xC
block|,
literal|0x6
block|,
literal|0xA
block|,
literal|0xA
block|,
literal|0x8
block|,
literal|0xD
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|buf32
name|encryptkeys
init|=
block|{
literal|0x48
block|,
literal|0x93
block|,
literal|0x46
block|,
literal|0x67
block|,
literal|0x98
block|,
literal|0x3D
block|,
literal|0xE6
block|,
literal|0x8D
block|,
literal|0xB7
block|,
literal|0x10
block|,
literal|0x7A
block|,
literal|0x26
block|,
literal|0x5A
block|,
literal|0xB9
block|,
literal|0xB1
block|,
literal|0x35
block|,
literal|0x6B
block|,
literal|0x0F
block|,
literal|0xD5
block|,
literal|0x70
block|,
literal|0xAE
block|,
literal|0xFB
block|,
literal|0xAD
block|,
literal|0x11
block|,
literal|0xF4
block|,
literal|0x47
block|,
literal|0xDC
block|,
literal|0xA7
block|,
literal|0xEC
block|,
literal|0xCF
block|,
literal|0x50
block|,
literal|0xC0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Create table-based 16-bytes hash from a 32-bytes array  */
end_comment

begin_function
specifier|static
name|void
name|nw_hash
parameter_list|(
name|buf32
name|temp
parameter_list|,
name|unsigned
name|char
modifier|*
name|target
parameter_list|)
block|{
name|short
name|sum
decl_stmt|;
name|unsigned
name|char
name|b3
decl_stmt|;
name|int
name|s
decl_stmt|,
name|b2
decl_stmt|,
name|i
decl_stmt|;
name|sum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|b2
operator|=
literal|0
init|;
name|b2
operator|<=
literal|1
condition|;
operator|++
name|b2
control|)
block|{
for|for
control|(
name|s
operator|=
literal|0
init|;
name|s
operator|<=
literal|31
condition|;
operator|++
name|s
control|)
block|{
name|b3
operator|=
operator|(
name|temp
index|[
name|s
index|]
operator|+
name|sum
operator|)
operator|^
operator|(
name|temp
index|[
operator|(
name|s
operator|+
name|sum
operator|)
operator|&
literal|31
index|]
operator|-
name|encryptkeys
index|[
name|s
index|]
operator|)
expr_stmt|;
name|sum
operator|+=
name|b3
expr_stmt|;
name|temp
index|[
name|s
index|]
operator|=
name|b3
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|15
condition|;
operator|++
name|i
control|)
block|{
name|target
index|[
name|i
index|]
operator|=
name|encrypttable
index|[
name|temp
index|[
literal|2
operator|*
name|i
index|]
index|]
operator||
operator|(
name|encrypttable
index|[
name|temp
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
index|]
operator|<<
literal|4
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Create a 16-bytes pattern from given buffer based on a four bytes key  */
end_comment

begin_function
name|void
name|nw_keyhash
parameter_list|(
specifier|const
name|u_char
modifier|*
name|key
parameter_list|,
specifier|const
name|u_char
modifier|*
name|buf
parameter_list|,
name|int
name|buflen
parameter_list|,
name|u_char
modifier|*
name|target
parameter_list|)
block|{
name|int
name|b2
decl_stmt|,
name|d
decl_stmt|,
name|s
decl_stmt|;
name|buf32
name|temp
decl_stmt|;
while|while
condition|(
name|buflen
operator|>
literal|0
operator|&&
name|buf
index|[
name|buflen
operator|-
literal|1
index|]
operator|==
literal|0
condition|)
name|buflen
operator|--
expr_stmt|;
name|bzero
argument_list|(
name|temp
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|buflen
operator|>=
literal|32
condition|)
block|{
for|for
control|(
name|s
operator|=
literal|0
init|;
name|s
operator|<=
literal|31
condition|;
operator|++
name|s
control|)
name|temp
index|[
name|s
index|]
operator|^=
name|buf
index|[
name|d
operator|++
index|]
expr_stmt|;
name|buflen
operator|-=
literal|32
expr_stmt|;
block|}
name|b2
operator|=
name|d
expr_stmt|;
if|if
condition|(
name|buflen
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|s
operator|=
literal|0
init|;
name|s
operator|<=
literal|31
condition|;
operator|++
name|s
control|)
block|{
if|if
condition|(
name|d
operator|+
name|buflen
operator|==
name|b2
condition|)
block|{
name|temp
index|[
name|s
index|]
operator|^=
name|encryptkeys
index|[
name|s
index|]
expr_stmt|;
name|b2
operator|=
name|d
expr_stmt|;
block|}
else|else
name|temp
index|[
name|s
index|]
operator|^=
name|buf
index|[
name|b2
operator|++
index|]
expr_stmt|;
block|}
block|}
for|for
control|(
name|s
operator|=
literal|0
init|;
name|s
operator|<=
literal|31
condition|;
operator|++
name|s
control|)
name|temp
index|[
name|s
index|]
operator|^=
name|key
index|[
name|s
operator|&
literal|3
index|]
expr_stmt|;
name|nw_hash
argument_list|(
name|temp
argument_list|,
name|target
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Create an 8-bytes pattern from an 8-bytes key and 16-bytes of data  */
end_comment

begin_function
name|void
name|nw_encrypt
parameter_list|(
specifier|const
name|u_char
modifier|*
name|fra
parameter_list|,
specifier|const
name|u_char
modifier|*
name|buf
parameter_list|,
name|u_char
modifier|*
name|target
parameter_list|)
block|{
name|buf32
name|k
decl_stmt|;
name|int
name|s
decl_stmt|;
name|nw_keyhash
argument_list|(
name|fra
argument_list|,
name|buf
argument_list|,
literal|16
argument_list|,
name|k
argument_list|)
expr_stmt|;
name|nw_keyhash
argument_list|(
name|fra
operator|+
literal|4
argument_list|,
name|buf
argument_list|,
literal|16
argument_list|,
name|k
operator|+
literal|16
argument_list|)
expr_stmt|;
for|for
control|(
name|s
operator|=
literal|0
init|;
name|s
operator|<
literal|16
condition|;
name|s
operator|++
control|)
name|k
index|[
name|s
index|]
operator|^=
name|k
index|[
literal|31
operator|-
name|s
index|]
expr_stmt|;
for|for
control|(
name|s
operator|=
literal|0
init|;
name|s
operator|<
literal|8
condition|;
name|s
operator|++
control|)
operator|*
name|target
operator|++
operator|=
name|k
index|[
name|s
index|]
operator|^
name|k
index|[
literal|15
operator|-
name|s
index|]
expr_stmt|;
block|}
end_function

end_unit


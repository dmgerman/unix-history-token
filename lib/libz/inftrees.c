begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* inftrees.c -- generate Huffman trees for efficient decoding  * Copyright (C) 1995-1998 Mark Adler  * For conditions of distribution and use, see copyright notice in zlib.h   */
end_comment

begin_include
include|#
directive|include
file|"zutil.h"
end_include

begin_include
include|#
directive|include
file|"inftrees.h"
end_include

begin_decl_stmt
specifier|const
name|char
name|inflate_copyright
index|[]
init|=
literal|" inflate 1.1.1 Copyright 1995-1998 Mark Adler "
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*   If you use the zlib library in a product, an acknowledgment is welcome   in the documentation of your product. If for some reason you cannot   include such an acknowledgment, I would appreciate that you keep this   copyright string in the executable of your product.  */
end_comment

begin_struct
struct|struct
name|internal_state
block|{
name|int
name|dummy
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* for buggy compilers */
end_comment

begin_comment
comment|/* simplify the use of the inflate_huft type with some defines */
end_comment

begin_define
define|#
directive|define
name|base
value|more.Base
end_define

begin_define
define|#
directive|define
name|next
value|more.Next
end_define

begin_define
define|#
directive|define
name|exop
value|word.what.Exop
end_define

begin_define
define|#
directive|define
name|bits
value|word.what.Bits
end_define

begin_decl_stmt
name|local
name|int
name|huft_build
name|OF
argument_list|(
operator|(
name|uIntf
operator|*
operator|,
comment|/* code lengths in bits */
name|uInt
operator|,
comment|/* number of codes */
name|uInt
operator|,
comment|/* number of "simple" codes */
specifier|const
name|uIntf
operator|*
operator|,
comment|/* list of base values for non-simple codes */
specifier|const
name|uIntf
operator|*
operator|,
comment|/* list of extra bits for non-simple codes */
name|inflate_huft
operator|*
name|FAR
operator|*
operator|,
comment|/* result: starting table */
name|uIntf
operator|*
operator|,
comment|/* maximum lookup bits (returns actual) */
name|inflate_huft
operator|*
operator|,
comment|/* space for trees */
name|uInt
operator|*
operator|,
comment|/* hufts used in space */
name|uIntf
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* space for values */
end_comment

begin_comment
comment|/* Tables for deflate from PKZIP's appnote.txt. */
end_comment

begin_decl_stmt
name|local
specifier|const
name|uInt
name|cplens
index|[
literal|31
index|]
init|=
block|{
comment|/* Copy lengths for literal codes 257..285 */
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|13
block|,
literal|15
block|,
literal|17
block|,
literal|19
block|,
literal|23
block|,
literal|27
block|,
literal|31
block|,
literal|35
block|,
literal|43
block|,
literal|51
block|,
literal|59
block|,
literal|67
block|,
literal|83
block|,
literal|99
block|,
literal|115
block|,
literal|131
block|,
literal|163
block|,
literal|195
block|,
literal|227
block|,
literal|258
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* see note #13 above about 258 */
end_comment

begin_decl_stmt
name|local
specifier|const
name|uInt
name|cplext
index|[
literal|31
index|]
init|=
block|{
comment|/* Extra bits for literal codes 257..285 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|0
block|,
literal|112
block|,
literal|112
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 112==invalid */
end_comment

begin_decl_stmt
name|local
specifier|const
name|uInt
name|cpdist
index|[
literal|30
index|]
init|=
block|{
comment|/* Copy offsets for distance codes 0..29 */
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|7
block|,
literal|9
block|,
literal|13
block|,
literal|17
block|,
literal|25
block|,
literal|33
block|,
literal|49
block|,
literal|65
block|,
literal|97
block|,
literal|129
block|,
literal|193
block|,
literal|257
block|,
literal|385
block|,
literal|513
block|,
literal|769
block|,
literal|1025
block|,
literal|1537
block|,
literal|2049
block|,
literal|3073
block|,
literal|4097
block|,
literal|6145
block|,
literal|8193
block|,
literal|12289
block|,
literal|16385
block|,
literal|24577
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
specifier|const
name|uInt
name|cpdext
index|[
literal|30
index|]
init|=
block|{
comment|/* Extra bits for distance codes */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|5
block|,
literal|5
block|,
literal|6
block|,
literal|6
block|,
literal|7
block|,
literal|7
block|,
literal|8
block|,
literal|8
block|,
literal|9
block|,
literal|9
block|,
literal|10
block|,
literal|10
block|,
literal|11
block|,
literal|11
block|,
literal|12
block|,
literal|12
block|,
literal|13
block|,
literal|13
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    Huffman code decoding is performed using a multi-level table lookup.    The fastest way to decode is to simply build a lookup table whose    size is determined by the longest code.  However, the time it takes    to build this table can also be a factor if the data being decoded    is not very long.  The most common codes are necessarily the    shortest codes, so those codes dominate the decoding time, and hence    the speed.  The idea is you can have a shorter table that decodes the    shorter, more probable codes, and then point to subsidiary tables for    the longer codes.  The time it costs to decode the longer codes is    then traded against the time it takes to make longer tables.     This results of this trade are in the variables lbits and dbits    below.  lbits is the number of bits the first level table for literal/    length codes can decode in one step, and dbits is the same thing for    the distance codes.  Subsequent tables are also less than or equal to    those sizes.  These values may be adjusted either when all of the    codes are shorter than that, in which case the longest code length in    bits is used, or when the shortest code is *longer* than the requested    table size, in which case the length of the shortest code in bits is    used.     There are two different values for the two tables, since they code a    different number of possibilities each.  The literal/length table    codes 286 possible values, or in a flat code, a little over eight    bits.  The distance table codes 30 possible values, or a little less    than five bits, flat.  The optimum values for speed end up being    about one bit more than those, so lbits is 8+1 and dbits is 5+1.    The optimum values may differ though from machine to machine, and    possibly even between compilers.  Your mileage may vary.  */
end_comment

begin_comment
comment|/* If BMAX needs to be larger than 16, then h and x[] should be uLong. */
end_comment

begin_define
define|#
directive|define
name|BMAX
value|15
end_define

begin_comment
comment|/* maximum bit length of any code */
end_comment

begin_function
name|local
name|int
name|huft_build
parameter_list|(
name|b
parameter_list|,
name|n
parameter_list|,
name|s
parameter_list|,
name|d
parameter_list|,
name|e
parameter_list|,
name|t
parameter_list|,
name|m
parameter_list|,
name|hp
parameter_list|,
name|hn
parameter_list|,
name|v
parameter_list|)
name|uIntf
modifier|*
name|b
decl_stmt|;
comment|/* code lengths in bits (all assumed<= BMAX) */
name|uInt
name|n
decl_stmt|;
comment|/* number of codes (assumed<= 288) */
name|uInt
name|s
decl_stmt|;
comment|/* number of simple-valued codes (0..s-1) */
specifier|const
name|uIntf
modifier|*
name|d
decl_stmt|;
comment|/* list of base values for non-simple codes */
specifier|const
name|uIntf
modifier|*
name|e
decl_stmt|;
comment|/* list of extra bits for non-simple codes */
name|inflate_huft
modifier|*
name|FAR
modifier|*
name|t
decl_stmt|;
comment|/* result: starting table */
name|uIntf
modifier|*
name|m
decl_stmt|;
comment|/* maximum lookup bits, returns actual */
name|inflate_huft
modifier|*
name|hp
decl_stmt|;
comment|/* space for trees */
name|uInt
modifier|*
name|hn
decl_stmt|;
comment|/* hufts used in space */
name|uIntf
modifier|*
name|v
decl_stmt|;
comment|/* working area: values in order of bit length */
comment|/* Given a list of code lengths and a maximum table size, make a set of    tables to decode that set of codes.  Return Z_OK on success, Z_BUF_ERROR    if the given code set is incomplete (the tables are still built in this    case), Z_DATA_ERROR if the input is invalid (an over-subscribed set of    lengths), or Z_MEM_ERROR if not enough memory. */
block|{
name|uInt
name|a
decl_stmt|;
comment|/* counter for codes of length k */
name|uInt
name|c
index|[
name|BMAX
operator|+
literal|1
index|]
decl_stmt|;
comment|/* bit length count table */
name|uInt
name|f
decl_stmt|;
comment|/* i repeats in table every f entries */
name|int
name|g
decl_stmt|;
comment|/* maximum code length */
name|int
name|h
decl_stmt|;
comment|/* table level */
specifier|register
name|uInt
name|i
decl_stmt|;
comment|/* counter, current code */
specifier|register
name|uInt
name|j
decl_stmt|;
comment|/* counter */
specifier|register
name|int
name|k
decl_stmt|;
comment|/* number of bits in current code */
name|int
name|l
decl_stmt|;
comment|/* bits per table (returned in m) */
name|uInt
name|mask
decl_stmt|;
comment|/* (1<< w) - 1, to avoid cc -O bug on HP */
specifier|register
name|uIntf
modifier|*
name|p
decl_stmt|;
comment|/* pointer into c[], b[], or v[] */
name|inflate_huft
modifier|*
name|q
decl_stmt|;
comment|/* points to current table */
name|struct
name|inflate_huft_s
name|r
decl_stmt|;
comment|/* table entry for structure assignment */
name|inflate_huft
modifier|*
name|u
index|[
name|BMAX
index|]
decl_stmt|;
comment|/* table stack */
specifier|register
name|int
name|w
decl_stmt|;
comment|/* bits before this table == (l * h) */
name|uInt
name|x
index|[
name|BMAX
operator|+
literal|1
index|]
decl_stmt|;
comment|/* bit offsets, then code stack */
name|uIntf
modifier|*
name|xp
decl_stmt|;
comment|/* pointer into x */
name|int
name|y
decl_stmt|;
comment|/* number of dummy codes added */
name|uInt
name|z
decl_stmt|;
comment|/* number of entries in current table */
comment|/* Generate counts for each bit length */
name|p
operator|=
name|c
expr_stmt|;
define|#
directive|define
name|C0
value|*p++ = 0;
define|#
directive|define
name|C2
value|C0 C0 C0 C0
define|#
directive|define
name|C4
value|C2 C2 C2 C2
name|C4
comment|/* clear c[]--assume BMAX+1 is 16 */
name|p
init|=
name|b
decl_stmt|;
name|i
operator|=
name|n
expr_stmt|;
do|do
block|{
name|c
index|[
operator|*
name|p
operator|++
index|]
operator|++
expr_stmt|;
comment|/* assume all entries<= BMAX */
block|}
do|while
condition|(
operator|--
name|i
condition|)
do|;
if|if
condition|(
name|c
index|[
literal|0
index|]
operator|==
name|n
condition|)
comment|/* null input--all zero length codes */
block|{
operator|*
name|t
operator|=
operator|(
name|inflate_huft
operator|*
operator|)
name|Z_NULL
expr_stmt|;
operator|*
name|m
operator|=
literal|0
expr_stmt|;
return|return
name|Z_OK
return|;
block|}
comment|/* Find minimum and maximum length, bound *m by those */
name|l
operator|=
operator|*
name|m
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<=
name|BMAX
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|c
index|[
name|j
index|]
condition|)
break|break;
name|k
operator|=
name|j
expr_stmt|;
comment|/* minimum code length */
if|if
condition|(
operator|(
name|uInt
operator|)
name|l
operator|<
name|j
condition|)
name|l
operator|=
name|j
expr_stmt|;
for|for
control|(
name|i
operator|=
name|BMAX
init|;
name|i
condition|;
name|i
operator|--
control|)
if|if
condition|(
name|c
index|[
name|i
index|]
condition|)
break|break;
name|g
operator|=
name|i
expr_stmt|;
comment|/* maximum code length */
if|if
condition|(
operator|(
name|uInt
operator|)
name|l
operator|>
name|i
condition|)
name|l
operator|=
name|i
expr_stmt|;
operator|*
name|m
operator|=
name|l
expr_stmt|;
comment|/* Adjust last length count to fill out codes, if needed */
for|for
control|(
name|y
operator|=
literal|1
operator|<<
name|j
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
operator|,
name|y
operator|<<=
literal|1
control|)
if|if
condition|(
operator|(
name|y
operator|-=
name|c
index|[
name|j
index|]
operator|)
operator|<
literal|0
condition|)
return|return
name|Z_DATA_ERROR
return|;
if|if
condition|(
operator|(
name|y
operator|-=
name|c
index|[
name|i
index|]
operator|)
operator|<
literal|0
condition|)
return|return
name|Z_DATA_ERROR
return|;
name|c
index|[
name|i
index|]
operator|+=
name|y
expr_stmt|;
comment|/* Generate starting offsets into the value table for each length */
name|x
index|[
literal|1
index|]
operator|=
name|j
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|c
operator|+
literal|1
expr_stmt|;
name|xp
operator|=
name|x
operator|+
literal|2
expr_stmt|;
while|while
condition|(
operator|--
name|i
condition|)
block|{
comment|/* note that i == g from above */
operator|*
name|xp
operator|++
operator|=
operator|(
name|j
operator|+=
operator|*
name|p
operator|++
operator|)
expr_stmt|;
block|}
comment|/* Make a table of values in order of bit lengths */
name|p
operator|=
name|b
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|(
name|j
operator|=
operator|*
name|p
operator|++
operator|)
operator|!=
literal|0
condition|)
name|v
index|[
name|x
index|[
name|j
index|]
operator|++
index|]
operator|=
name|i
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|i
operator|<
name|n
condition|)
do|;
name|n
operator|=
name|x
index|[
name|g
index|]
expr_stmt|;
comment|/* set n to length of v */
comment|/* Generate the Huffman codes and for each, make the table entries */
name|x
index|[
literal|0
index|]
operator|=
name|i
operator|=
literal|0
expr_stmt|;
comment|/* first Huffman code is zero */
name|p
operator|=
name|v
expr_stmt|;
comment|/* grab values in bit order */
name|h
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* no tables yet--level -1 */
name|w
operator|=
operator|-
name|l
expr_stmt|;
comment|/* bits decoded == (l * h) */
name|u
index|[
literal|0
index|]
operator|=
operator|(
name|inflate_huft
operator|*
operator|)
name|Z_NULL
expr_stmt|;
comment|/* just to keep compilers happy */
name|q
operator|=
operator|(
name|inflate_huft
operator|*
operator|)
name|Z_NULL
expr_stmt|;
comment|/* ditto */
name|z
operator|=
literal|0
expr_stmt|;
comment|/* ditto */
comment|/* go through the bit lengths (k already is bits in shortest code) */
for|for
control|(
init|;
name|k
operator|<=
name|g
condition|;
name|k
operator|++
control|)
block|{
name|a
operator|=
name|c
index|[
name|k
index|]
expr_stmt|;
while|while
condition|(
name|a
operator|--
condition|)
block|{
comment|/* here i is the Huffman code of length k bits for value *p */
comment|/* make tables up to required level */
while|while
condition|(
name|k
operator|>
name|w
operator|+
name|l
condition|)
block|{
name|h
operator|++
expr_stmt|;
name|w
operator|+=
name|l
expr_stmt|;
comment|/* previous table always l bits */
comment|/* compute minimum size table less than or equal to l bits */
name|z
operator|=
name|g
operator|-
name|w
expr_stmt|;
name|z
operator|=
name|z
operator|>
operator|(
name|uInt
operator|)
name|l
condition|?
name|l
else|:
name|z
expr_stmt|;
comment|/* table size upper limit */
if|if
condition|(
operator|(
name|f
operator|=
literal|1
operator|<<
operator|(
name|j
operator|=
name|k
operator|-
name|w
operator|)
operator|)
operator|>
name|a
operator|+
literal|1
condition|)
comment|/* try a k-w bit table */
block|{
comment|/* too few codes for k-w bit table */
name|f
operator|-=
name|a
operator|+
literal|1
expr_stmt|;
comment|/* deduct codes from patterns left */
name|xp
operator|=
name|c
operator|+
name|k
expr_stmt|;
if|if
condition|(
name|j
operator|<
name|z
condition|)
while|while
condition|(
operator|++
name|j
operator|<
name|z
condition|)
comment|/* try smaller tables up to z bits */
block|{
if|if
condition|(
operator|(
name|f
operator|<<=
literal|1
operator|)
operator|<=
operator|*
operator|++
name|xp
condition|)
break|break;
comment|/* enough codes to use up j bits */
name|f
operator|-=
operator|*
name|xp
expr_stmt|;
comment|/* else deduct codes from patterns */
block|}
block|}
name|z
operator|=
literal|1
operator|<<
name|j
expr_stmt|;
comment|/* table entries for j-bit table */
comment|/* allocate new table */
if|if
condition|(
operator|*
name|hn
operator|+
name|z
operator|>
name|MANY
condition|)
comment|/* (note: doesn't matter for fixed) */
return|return
name|Z_MEM_ERROR
return|;
comment|/* not enough memory */
name|u
index|[
name|h
index|]
operator|=
name|q
operator|=
name|hp
operator|+
operator|*
name|hn
expr_stmt|;
operator|*
name|hn
operator|+=
name|z
expr_stmt|;
if|if
condition|(
name|t
operator|!=
name|Z_NULL
condition|)
comment|/* first table is returned result */
block|{
operator|*
name|t
operator|=
name|q
expr_stmt|;
name|t
operator|=
name|Z_NULL
expr_stmt|;
block|}
comment|/* connect to last table, if there is one */
if|if
condition|(
name|h
condition|)
block|{
name|x
index|[
name|h
index|]
operator|=
name|i
expr_stmt|;
comment|/* save pattern for backing up */
name|r
operator|.
name|bits
operator|=
operator|(
name|Byte
operator|)
name|l
expr_stmt|;
comment|/* bits to dump before this table */
name|r
operator|.
name|exop
operator|=
operator|(
name|Byte
operator|)
name|j
expr_stmt|;
comment|/* bits in this table */
name|r
operator|.
name|next
operator|=
name|q
expr_stmt|;
comment|/* pointer to this table */
name|j
operator|=
name|i
operator|>>
operator|(
name|w
operator|-
name|l
operator|)
expr_stmt|;
comment|/* (get around Turbo C bug) */
name|u
index|[
name|h
operator|-
literal|1
index|]
index|[
name|j
index|]
operator|=
name|r
expr_stmt|;
comment|/* connect to last table */
block|}
block|}
comment|/* set up table entry in r */
name|r
operator|.
name|bits
operator|=
call|(
name|Byte
call|)
argument_list|(
name|k
operator|-
name|w
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|>=
name|v
operator|+
name|n
condition|)
name|r
operator|.
name|exop
operator|=
literal|128
operator|+
literal|64
expr_stmt|;
comment|/* out of values--invalid code */
elseif|else
if|if
condition|(
operator|*
name|p
operator|<
name|s
condition|)
block|{
name|r
operator|.
name|exop
operator|=
call|(
name|Byte
call|)
argument_list|(
operator|*
name|p
operator|<
literal|256
condition|?
literal|0
else|:
literal|32
operator|+
literal|64
argument_list|)
expr_stmt|;
comment|/* 256 is end-of-block */
name|r
operator|.
name|base
operator|=
operator|*
name|p
operator|++
expr_stmt|;
comment|/* simple code is just the value */
block|}
else|else
block|{
name|r
operator|.
name|exop
operator|=
call|(
name|Byte
call|)
argument_list|(
name|e
index|[
operator|*
name|p
operator|-
name|s
index|]
operator|+
literal|16
operator|+
literal|64
argument_list|)
expr_stmt|;
comment|/* non-simple--look up in lists */
name|r
operator|.
name|base
operator|=
name|d
index|[
operator|*
name|p
operator|++
operator|-
name|s
index|]
expr_stmt|;
block|}
comment|/* fill code-like entries with r */
name|f
operator|=
literal|1
operator|<<
operator|(
name|k
operator|-
name|w
operator|)
expr_stmt|;
for|for
control|(
name|j
operator|=
name|i
operator|>>
name|w
init|;
name|j
operator|<
name|z
condition|;
name|j
operator|+=
name|f
control|)
name|q
index|[
name|j
index|]
operator|=
name|r
expr_stmt|;
comment|/* backwards increment the k-bit code i */
for|for
control|(
name|j
operator|=
literal|1
operator|<<
operator|(
name|k
operator|-
literal|1
operator|)
init|;
name|i
operator|&
name|j
condition|;
name|j
operator|>>=
literal|1
control|)
name|i
operator|^=
name|j
expr_stmt|;
name|i
operator|^=
name|j
expr_stmt|;
comment|/* backup over finished tables */
name|mask
operator|=
operator|(
literal|1
operator|<<
name|w
operator|)
operator|-
literal|1
expr_stmt|;
comment|/* needed on HP, cc -O bug */
while|while
condition|(
operator|(
name|i
operator|&
name|mask
operator|)
operator|!=
name|x
index|[
name|h
index|]
condition|)
block|{
name|h
operator|--
expr_stmt|;
comment|/* don't need to update q */
name|w
operator|-=
name|l
expr_stmt|;
name|mask
operator|=
operator|(
literal|1
operator|<<
name|w
operator|)
operator|-
literal|1
expr_stmt|;
block|}
block|}
block|}
comment|/* Return Z_BUF_ERROR if we were given an incomplete table */
return|return
name|y
operator|!=
literal|0
operator|&&
name|g
operator|!=
literal|1
condition|?
name|Z_BUF_ERROR
else|:
name|Z_OK
return|;
block|}
end_function

begin_function
name|int
name|inflate_trees_bits
parameter_list|(
name|c
parameter_list|,
name|bb
parameter_list|,
name|tb
parameter_list|,
name|hp
parameter_list|,
name|z
parameter_list|)
name|uIntf
modifier|*
name|c
decl_stmt|;
comment|/* 19 code lengths */
name|uIntf
modifier|*
name|bb
decl_stmt|;
comment|/* bits tree desired/actual depth */
name|inflate_huft
modifier|*
name|FAR
modifier|*
name|tb
decl_stmt|;
comment|/* bits tree result */
name|inflate_huft
modifier|*
name|hp
decl_stmt|;
comment|/* space for trees */
name|z_streamp
name|z
decl_stmt|;
comment|/* for messages */
block|{
name|int
name|r
decl_stmt|;
name|uInt
name|hn
init|=
literal|0
decl_stmt|;
comment|/* hufts used in space */
name|uIntf
modifier|*
name|v
decl_stmt|;
comment|/* work area for huft_build */
if|if
condition|(
operator|(
name|v
operator|=
operator|(
name|uIntf
operator|*
operator|)
name|ZALLOC
argument_list|(
name|z
argument_list|,
literal|19
argument_list|,
sizeof|sizeof
argument_list|(
name|uInt
argument_list|)
argument_list|)
operator|)
operator|==
name|Z_NULL
condition|)
return|return
name|Z_MEM_ERROR
return|;
name|r
operator|=
name|huft_build
argument_list|(
name|c
argument_list|,
literal|19
argument_list|,
literal|19
argument_list|,
operator|(
name|uIntf
operator|*
operator|)
name|Z_NULL
argument_list|,
operator|(
name|uIntf
operator|*
operator|)
name|Z_NULL
argument_list|,
name|tb
argument_list|,
name|bb
argument_list|,
name|hp
argument_list|,
operator|&
name|hn
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|Z_DATA_ERROR
condition|)
name|z
operator|->
name|msg
operator|=
operator|(
name|char
operator|*
operator|)
literal|"oversubscribed dynamic bit lengths tree"
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|==
name|Z_BUF_ERROR
operator|||
operator|*
name|bb
operator|==
literal|0
condition|)
block|{
name|z
operator|->
name|msg
operator|=
operator|(
name|char
operator|*
operator|)
literal|"incomplete dynamic bit lengths tree"
expr_stmt|;
name|r
operator|=
name|Z_DATA_ERROR
expr_stmt|;
block|}
name|ZFREE
argument_list|(
name|z
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|inflate_trees_dynamic
parameter_list|(
name|nl
parameter_list|,
name|nd
parameter_list|,
name|c
parameter_list|,
name|bl
parameter_list|,
name|bd
parameter_list|,
name|tl
parameter_list|,
name|td
parameter_list|,
name|hp
parameter_list|,
name|z
parameter_list|)
name|uInt
name|nl
decl_stmt|;
comment|/* number of literal/length codes */
name|uInt
name|nd
decl_stmt|;
comment|/* number of distance codes */
name|uIntf
modifier|*
name|c
decl_stmt|;
comment|/* that many (total) code lengths */
name|uIntf
modifier|*
name|bl
decl_stmt|;
comment|/* literal desired/actual bit depth */
name|uIntf
modifier|*
name|bd
decl_stmt|;
comment|/* distance desired/actual bit depth */
name|inflate_huft
modifier|*
name|FAR
modifier|*
name|tl
decl_stmt|;
comment|/* literal/length tree result */
name|inflate_huft
modifier|*
name|FAR
modifier|*
name|td
decl_stmt|;
comment|/* distance tree result */
name|inflate_huft
modifier|*
name|hp
decl_stmt|;
comment|/* space for trees */
name|z_streamp
name|z
decl_stmt|;
comment|/* for messages */
block|{
name|int
name|r
decl_stmt|;
name|uInt
name|hn
init|=
literal|0
decl_stmt|;
comment|/* hufts used in space */
name|uIntf
modifier|*
name|v
decl_stmt|;
comment|/* work area for huft_build */
comment|/* allocate work area */
if|if
condition|(
operator|(
name|v
operator|=
operator|(
name|uIntf
operator|*
operator|)
name|ZALLOC
argument_list|(
name|z
argument_list|,
literal|288
argument_list|,
sizeof|sizeof
argument_list|(
name|uInt
argument_list|)
argument_list|)
operator|)
operator|==
name|Z_NULL
condition|)
return|return
name|Z_MEM_ERROR
return|;
comment|/* build literal/length tree */
name|r
operator|=
name|huft_build
argument_list|(
name|c
argument_list|,
name|nl
argument_list|,
literal|257
argument_list|,
name|cplens
argument_list|,
name|cplext
argument_list|,
name|tl
argument_list|,
name|bl
argument_list|,
name|hp
argument_list|,
operator|&
name|hn
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|Z_OK
operator|||
operator|*
name|bl
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|r
operator|==
name|Z_DATA_ERROR
condition|)
name|z
operator|->
name|msg
operator|=
operator|(
name|char
operator|*
operator|)
literal|"oversubscribed literal/length tree"
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|!=
name|Z_MEM_ERROR
condition|)
block|{
name|z
operator|->
name|msg
operator|=
operator|(
name|char
operator|*
operator|)
literal|"incomplete literal/length tree"
expr_stmt|;
name|r
operator|=
name|Z_DATA_ERROR
expr_stmt|;
block|}
name|ZFREE
argument_list|(
name|z
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* build distance tree */
name|r
operator|=
name|huft_build
argument_list|(
name|c
operator|+
name|nl
argument_list|,
name|nd
argument_list|,
literal|0
argument_list|,
name|cpdist
argument_list|,
name|cpdext
argument_list|,
name|td
argument_list|,
name|bd
argument_list|,
name|hp
argument_list|,
operator|&
name|hn
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|Z_OK
operator|||
operator|(
operator|*
name|bd
operator|==
literal|0
operator|&&
name|nl
operator|>
literal|257
operator|)
condition|)
block|{
if|if
condition|(
name|r
operator|==
name|Z_DATA_ERROR
condition|)
name|z
operator|->
name|msg
operator|=
operator|(
name|char
operator|*
operator|)
literal|"oversubscribed distance tree"
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|==
name|Z_BUF_ERROR
condition|)
block|{
ifdef|#
directive|ifdef
name|PKZIP_BUG_WORKAROUND
name|r
operator|=
name|Z_OK
expr_stmt|;
block|}
else|#
directive|else
name|z
operator|->
name|msg
operator|=
operator|(
name|char
operator|*
operator|)
literal|"incomplete distance tree"
expr_stmt|;
name|r
operator|=
name|Z_DATA_ERROR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r
operator|!=
name|Z_MEM_ERROR
condition|)
block|{
name|z
operator|->
name|msg
operator|=
operator|(
name|char
operator|*
operator|)
literal|"empty distance tree with lengths"
expr_stmt|;
name|r
operator|=
name|Z_DATA_ERROR
expr_stmt|;
block|}
name|ZFREE
argument_list|(
name|z
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
name|r
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* done */
end_comment

begin_expr_stmt
name|ZFREE
argument_list|(
name|z
argument_list|,
name|v
argument_list|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
name|Z_OK
return|;
end_return

begin_comment
unit|}
comment|/* build fixed tables only once--keep them here */
end_comment

begin_decl_stmt
unit|local
name|int
name|fixed_built
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|FIXEDH
value|424
end_define

begin_comment
comment|/* number of hufts used by fixed tables */
end_comment

begin_decl_stmt
name|local
name|inflate_huft
name|fixed_mem
index|[
name|FIXEDH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|uInt
name|fixed_bl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|uInt
name|fixed_bd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|inflate_huft
modifier|*
name|fixed_tl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|inflate_huft
modifier|*
name|fixed_td
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|inflate_trees_fixed
parameter_list|(
name|bl
parameter_list|,
name|bd
parameter_list|,
name|tl
parameter_list|,
name|td
parameter_list|,
name|z
parameter_list|)
name|uIntf
modifier|*
name|bl
decl_stmt|;
comment|/* literal desired/actual bit depth */
name|uIntf
modifier|*
name|bd
decl_stmt|;
comment|/* distance desired/actual bit depth */
name|inflate_huft
modifier|*
name|FAR
modifier|*
name|tl
decl_stmt|;
comment|/* literal/length tree result */
name|inflate_huft
modifier|*
name|FAR
modifier|*
name|td
decl_stmt|;
comment|/* distance tree result */
name|z_streamp
name|z
decl_stmt|;
comment|/* for memory allocation */
block|{
comment|/* build fixed tables if not already (multiple overlapped executions ok) */
if|if
condition|(
operator|!
name|fixed_built
condition|)
block|{
name|int
name|k
decl_stmt|;
comment|/* temporary variable */
name|uInt
name|f
init|=
literal|0
decl_stmt|;
comment|/* number of hufts used in fixed_mem */
name|uIntf
modifier|*
name|c
decl_stmt|;
comment|/* length list for huft_build */
name|uIntf
modifier|*
name|v
decl_stmt|;
comment|/* work area for huft_build */
comment|/* allocate memory */
if|if
condition|(
operator|(
name|c
operator|=
operator|(
name|uIntf
operator|*
operator|)
name|ZALLOC
argument_list|(
name|z
argument_list|,
literal|288
argument_list|,
sizeof|sizeof
argument_list|(
name|uInt
argument_list|)
argument_list|)
operator|)
operator|==
name|Z_NULL
condition|)
return|return
name|Z_MEM_ERROR
return|;
if|if
condition|(
operator|(
name|v
operator|=
operator|(
name|uIntf
operator|*
operator|)
name|ZALLOC
argument_list|(
name|z
argument_list|,
literal|288
argument_list|,
sizeof|sizeof
argument_list|(
name|uInt
argument_list|)
argument_list|)
operator|)
operator|==
name|Z_NULL
condition|)
block|{
name|ZFREE
argument_list|(
name|z
argument_list|,
name|c
argument_list|)
expr_stmt|;
return|return
name|Z_MEM_ERROR
return|;
block|}
comment|/* literal table */
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|144
condition|;
name|k
operator|++
control|)
name|c
index|[
name|k
index|]
operator|=
literal|8
expr_stmt|;
for|for
control|(
init|;
name|k
operator|<
literal|256
condition|;
name|k
operator|++
control|)
name|c
index|[
name|k
index|]
operator|=
literal|9
expr_stmt|;
for|for
control|(
init|;
name|k
operator|<
literal|280
condition|;
name|k
operator|++
control|)
name|c
index|[
name|k
index|]
operator|=
literal|7
expr_stmt|;
for|for
control|(
init|;
name|k
operator|<
literal|288
condition|;
name|k
operator|++
control|)
name|c
index|[
name|k
index|]
operator|=
literal|8
expr_stmt|;
name|fixed_bl
operator|=
literal|7
expr_stmt|;
name|huft_build
argument_list|(
name|c
argument_list|,
literal|288
argument_list|,
literal|257
argument_list|,
name|cplens
argument_list|,
name|cplext
argument_list|,
operator|&
name|fixed_tl
argument_list|,
operator|&
name|fixed_bl
argument_list|,
name|fixed_mem
argument_list|,
operator|&
name|f
argument_list|,
name|v
argument_list|)
expr_stmt|;
comment|/* distance table */
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|30
condition|;
name|k
operator|++
control|)
name|c
index|[
name|k
index|]
operator|=
literal|5
expr_stmt|;
name|fixed_bd
operator|=
literal|5
expr_stmt|;
name|huft_build
argument_list|(
name|c
argument_list|,
literal|30
argument_list|,
literal|0
argument_list|,
name|cpdist
argument_list|,
name|cpdext
argument_list|,
operator|&
name|fixed_td
argument_list|,
operator|&
name|fixed_bd
argument_list|,
name|fixed_mem
argument_list|,
operator|&
name|f
argument_list|,
name|v
argument_list|)
expr_stmt|;
comment|/* done */
name|ZFREE
argument_list|(
name|z
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|ZFREE
argument_list|(
name|z
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|fixed_built
operator|=
literal|1
expr_stmt|;
block|}
operator|*
name|bl
operator|=
name|fixed_bl
expr_stmt|;
operator|*
name|bd
operator|=
name|fixed_bd
expr_stmt|;
operator|*
name|tl
operator|=
name|fixed_tl
expr_stmt|;
operator|*
name|td
operator|=
name|fixed_td
expr_stmt|;
return|return
name|Z_OK
return|;
block|}
end_function

end_unit


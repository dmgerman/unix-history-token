begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2001-2007, by Cisco Systems, Inc. All rights reserved.  * Copyright (c) 2008-2012, by Randall Stewart. All rights reserved.  * Copyright (c) 2008-2012, by Michael Tuexen. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *  * a) Redistributions of source code must retain the above copyright notice,  *    this list of conditions and the following disclaimer.  *  * b) Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the distribution.  *  * c) Neither the name of Cisco Systems, Inc. nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/syscall.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netinet/sctp_uio.h>
end_include

begin_include
include|#
directive|include
file|<netinet/sctp.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|IN6_IS_ADDR_V4MAPPED
end_ifndef

begin_define
define|#
directive|define
name|IN6_IS_ADDR_V4MAPPED
parameter_list|(
name|a
parameter_list|)
define|\
value|((*(const uint32_t *)(const void *)(&(a)->s6_addr[0]) == 0)&&	\ 	 (*(const uint32_t *)(const void *)(&(a)->s6_addr[4]) == 0)&&	\ 	 (*(const uint32_t *)(const void *)(&(a)->s6_addr[8]) == ntohl(0x0000ffff)))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|SCTP_CONTROL_VEC_SIZE_RCV
value|16384
end_define

begin_function
specifier|static
name|void
name|in6_sin6_2_sin
parameter_list|(
name|struct
name|sockaddr_in
modifier|*
name|sin
parameter_list|,
name|struct
name|sockaddr_in6
modifier|*
name|sin6
parameter_list|)
block|{
name|bzero
argument_list|(
name|sin
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sin
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|->
name|sin_port
operator|=
name|sin6
operator|->
name|sin6_port
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|sin6
operator|->
name|sin6_addr
operator|.
name|__u6_addr
operator|.
name|__u6_addr32
index|[
literal|3
index|]
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sctp_getaddrlen
parameter_list|(
name|sa_family_t
name|family
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|sd
decl_stmt|;
name|socklen_t
name|siz
decl_stmt|;
name|struct
name|sctp_assoc_value
name|av
decl_stmt|;
name|av
operator|.
name|assoc_value
operator|=
name|family
expr_stmt|;
name|siz
operator|=
sizeof|sizeof
argument_list|(
name|av
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|AF_INET
argument_list|)
name|sd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
name|IPPROTO_SCTP
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|AF_INET6
argument_list|)
name|sd
operator|=
name|socket
argument_list|(
name|AF_INET6
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
name|IPPROTO_SCTP
argument_list|)
expr_stmt|;
else|#
directive|else
name|sd
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|sd
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ret
operator|=
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_ADDR_LEN
argument_list|,
operator|&
name|av
argument_list|,
operator|&
name|siz
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
return|return
operator|(
operator|(
name|int
operator|)
name|av
operator|.
name|assoc_value
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
end_function

begin_function
name|int
name|sctp_connectx
parameter_list|(
name|int
name|sd
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|,
name|int
name|addrcnt
parameter_list|,
name|sctp_assoc_t
modifier|*
name|id
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|,
modifier|*
name|aa
decl_stmt|;
name|char
modifier|*
name|cpto
decl_stmt|;
specifier|const
name|struct
name|sockaddr
modifier|*
name|at
decl_stmt|;
name|size_t
name|len
decl_stmt|;
comment|/* validate the address count and list */
if|if
condition|(
operator|(
name|addrs
operator|==
name|NULL
operator|)
operator|||
operator|(
name|addrcnt
operator|<=
literal|0
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|addrcnt
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|E2BIG
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|at
operator|=
name|addrs
expr_stmt|;
name|cpto
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
comment|/* validate all the addresses and get the size */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addrcnt
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|at
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|at
operator|->
name|sa_len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|cpto
argument_list|,
name|at
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
argument_list|)
expr_stmt|;
name|cpto
operator|=
operator|(
operator|(
name|caddr_t
operator|)
name|cpto
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
operator|)
expr_stmt|;
name|len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
if|if
condition|(
name|at
operator|->
name|sa_len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|IN6_IS_ADDR_V4MAPPED
argument_list|(
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|at
operator|)
operator|->
name|sin6_addr
argument_list|)
condition|)
block|{
name|in6_sin6_2_sin
argument_list|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|cpto
argument_list|,
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|at
argument_list|)
expr_stmt|;
name|cpto
operator|=
operator|(
operator|(
name|caddr_t
operator|)
name|cpto
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
operator|)
expr_stmt|;
name|len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|cpto
argument_list|,
name|at
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
argument_list|)
expr_stmt|;
name|cpto
operator|=
operator|(
operator|(
name|caddr_t
operator|)
name|cpto
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
operator|)
expr_stmt|;
name|len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|at
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|at
operator|+
name|at
operator|->
name|sa_len
operator|)
expr_stmt|;
block|}
name|aa
operator|=
operator|(
name|int
operator|*
operator|)
name|buf
expr_stmt|;
operator|*
name|aa
operator|=
name|addrcnt
expr_stmt|;
name|ret
operator|=
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_CONNECT_X
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
operator|(
name|socklen_t
operator|)
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|==
literal|0
operator|)
operator|&&
operator|(
name|id
operator|!=
name|NULL
operator|)
condition|)
block|{
operator|*
name|id
operator|=
operator|*
operator|(
name|sctp_assoc_t
operator|*
operator|)
name|buf
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|sctp_bindx
parameter_list|(
name|int
name|sd
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|,
name|int
name|addrcnt
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|sctp_getaddresses
modifier|*
name|gaddrs
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
name|int
name|i
decl_stmt|;
name|size_t
name|argsz
decl_stmt|;
name|uint16_t
name|sport
init|=
literal|0
decl_stmt|;
comment|/* validate the flags */
if|if
condition|(
operator|(
name|flags
operator|!=
name|SCTP_BINDX_ADD_ADDR
operator|)
operator|&&
operator|(
name|flags
operator|!=
name|SCTP_BINDX_REM_ADDR
operator|)
condition|)
block|{
name|errno
operator|=
name|EFAULT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* validate the address count and list */
if|if
condition|(
operator|(
name|addrcnt
operator|<=
literal|0
operator|)
operator|||
operator|(
name|addrs
operator|==
name|NULL
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* First pre-screen the addresses */
name|sa
operator|=
name|addrs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addrcnt
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|sa
operator|->
name|sa_len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
expr_stmt|;
if|if
condition|(
name|sin
operator|->
name|sin_port
condition|)
block|{
comment|/* non-zero port, check or save */
if|if
condition|(
name|sport
condition|)
block|{
comment|/* Check against our port */
if|if
condition|(
name|sport
operator|!=
name|sin
operator|->
name|sin_port
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
comment|/* save off the port */
name|sport
operator|=
name|sin
operator|->
name|sin_port
expr_stmt|;
block|}
block|}
break|break;
case|case
name|AF_INET6
case|:
if|if
condition|(
name|sa
operator|->
name|sa_len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|sa
expr_stmt|;
if|if
condition|(
name|sin6
operator|->
name|sin6_port
condition|)
block|{
comment|/* non-zero port, check or save */
if|if
condition|(
name|sport
condition|)
block|{
comment|/* Check against our port */
if|if
condition|(
name|sport
operator|!=
name|sin6
operator|->
name|sin6_port
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
comment|/* save off the port */
name|sport
operator|=
name|sin6
operator|->
name|sin6_port
expr_stmt|;
block|}
block|}
break|break;
default|default:
comment|/* Invalid address family specified. */
name|errno
operator|=
name|EAFNOSUPPORT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|+
name|sa
operator|->
name|sa_len
operator|)
expr_stmt|;
block|}
name|argsz
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_getaddresses
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|gaddrs
operator|=
operator|(
expr|struct
name|sctp_getaddresses
operator|*
operator|)
name|malloc
argument_list|(
name|argsz
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sa
operator|=
name|addrs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addrcnt
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
name|gaddrs
argument_list|,
literal|0
argument_list|,
name|argsz
argument_list|)
expr_stmt|;
name|gaddrs
operator|->
name|sget_assoc_id
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|gaddrs
operator|->
name|addr
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
comment|/* 		 * Now, if there was a port mentioned, assure that the first 		 * address has that port to make sure it fails or succeeds 		 * correctly. 		 */
if|if
condition|(
operator|(
name|i
operator|==
literal|0
operator|)
operator|&&
operator|(
name|sport
operator|!=
literal|0
operator|)
condition|)
block|{
switch|switch
condition|(
name|gaddrs
operator|->
name|addr
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|gaddrs
operator|->
name|addr
expr_stmt|;
name|sin
operator|->
name|sin_port
operator|=
name|sport
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|gaddrs
operator|->
name|addr
expr_stmt|;
name|sin6
operator|->
name|sin6_port
operator|=
name|sport
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|flags
argument_list|,
name|gaddrs
argument_list|,
operator|(
name|socklen_t
operator|)
name|argsz
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|gaddrs
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|+
name|sa
operator|->
name|sa_len
operator|)
expr_stmt|;
block|}
name|free
argument_list|(
name|gaddrs
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|sctp_opt_info
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|id
parameter_list|,
name|int
name|opt
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|socklen_t
modifier|*
name|size
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|id
operator|==
name|SCTP_CURRENT_ASSOC
operator|)
operator|||
operator|(
name|id
operator|==
name|SCTP_ALL_ASSOC
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
switch|switch
condition|(
name|opt
condition|)
block|{
case|case
name|SCTP_RTOINFO
case|:
operator|(
operator|(
expr|struct
name|sctp_rtoinfo
operator|*
operator|)
name|arg
operator|)
operator|->
name|srto_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_ASSOCINFO
case|:
operator|(
operator|(
expr|struct
name|sctp_assocparams
operator|*
operator|)
name|arg
operator|)
operator|->
name|sasoc_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_DEFAULT_SEND_PARAM
case|:
operator|(
operator|(
expr|struct
name|sctp_assocparams
operator|*
operator|)
name|arg
operator|)
operator|->
name|sasoc_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_PRIMARY_ADDR
case|:
operator|(
operator|(
expr|struct
name|sctp_setprim
operator|*
operator|)
name|arg
operator|)
operator|->
name|ssp_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_PEER_ADDR_PARAMS
case|:
operator|(
operator|(
expr|struct
name|sctp_paddrparams
operator|*
operator|)
name|arg
operator|)
operator|->
name|spp_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_MAXSEG
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_AUTH_KEY
case|:
operator|(
operator|(
expr|struct
name|sctp_authkey
operator|*
operator|)
name|arg
operator|)
operator|->
name|sca_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_AUTH_ACTIVE_KEY
case|:
operator|(
operator|(
expr|struct
name|sctp_authkeyid
operator|*
operator|)
name|arg
operator|)
operator|->
name|scact_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_DELAYED_SACK
case|:
operator|(
operator|(
expr|struct
name|sctp_sack_info
operator|*
operator|)
name|arg
operator|)
operator|->
name|sack_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_CONTEXT
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_STATUS
case|:
operator|(
operator|(
expr|struct
name|sctp_status
operator|*
operator|)
name|arg
operator|)
operator|->
name|sstat_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_GET_PEER_ADDR_INFO
case|:
operator|(
operator|(
expr|struct
name|sctp_paddrinfo
operator|*
operator|)
name|arg
operator|)
operator|->
name|spinfo_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_PEER_AUTH_CHUNKS
case|:
operator|(
operator|(
expr|struct
name|sctp_authchunks
operator|*
operator|)
name|arg
operator|)
operator|->
name|gauth_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_LOCAL_AUTH_CHUNKS
case|:
operator|(
operator|(
expr|struct
name|sctp_authchunks
operator|*
operator|)
name|arg
operator|)
operator|->
name|gauth_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_TIMEOUTS
case|:
operator|(
operator|(
expr|struct
name|sctp_timeouts
operator|*
operator|)
name|arg
operator|)
operator|->
name|stimo_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_EVENT
case|:
operator|(
operator|(
expr|struct
name|sctp_event
operator|*
operator|)
name|arg
operator|)
operator|->
name|se_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_DEFAULT_SNDINFO
case|:
operator|(
operator|(
expr|struct
name|sctp_sndinfo
operator|*
operator|)
name|arg
operator|)
operator|->
name|snd_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_DEFAULT_PRINFO
case|:
operator|(
operator|(
expr|struct
name|sctp_default_prinfo
operator|*
operator|)
name|arg
operator|)
operator|->
name|pr_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_PEER_ADDR_THLDS
case|:
operator|(
operator|(
expr|struct
name|sctp_paddrthlds
operator|*
operator|)
name|arg
operator|)
operator|->
name|spt_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_REMOTE_UDP_ENCAPS_PORT
case|:
operator|(
operator|(
expr|struct
name|sctp_udpencaps
operator|*
operator|)
name|arg
operator|)
operator|->
name|sue_assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_ECN_SUPPORTED
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_PR_SUPPORTED
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_AUTH_SUPPORTED
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_ASCONF_SUPPORTED
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_RECONFIG_SUPPORTED
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_NRSACK_SUPPORTED
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_PKTDROP_SUPPORTED
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_MAX_BURST
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|SCTP_ENABLE_STREAM_RESET
case|:
operator|(
operator|(
expr|struct
name|sctp_assoc_value
operator|*
operator|)
name|arg
operator|)
operator|->
name|assoc_id
operator|=
name|id
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
operator|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|opt
argument_list|,
name|arg
argument_list|,
name|size
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|sctp_getpaddrs
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|id
parameter_list|,
name|struct
name|sockaddr
modifier|*
modifier|*
name|raddrs
parameter_list|)
block|{
name|struct
name|sctp_getaddresses
modifier|*
name|addrs
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|sctp_assoc_t
name|asoc
decl_stmt|;
name|caddr_t
name|lim
decl_stmt|;
name|socklen_t
name|opt_len
decl_stmt|;
name|int
name|cnt
decl_stmt|;
if|if
condition|(
name|raddrs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|EFAULT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|asoc
operator|=
name|id
expr_stmt|;
name|opt_len
operator|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|sctp_assoc_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_REMOTE_ADDR_SIZE
argument_list|,
operator|&
name|asoc
argument_list|,
operator|&
name|opt_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* size required is returned in 'asoc' */
name|opt_len
operator|=
call|(
name|socklen_t
call|)
argument_list|(
operator|(
name|size_t
operator|)
name|asoc
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_getaddresses
argument_list|)
argument_list|)
expr_stmt|;
name|addrs
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
operator|(
name|size_t
operator|)
name|opt_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|addrs
operator|->
name|sget_assoc_id
operator|=
name|id
expr_stmt|;
comment|/* Now lets get the array of addresses */
if|if
condition|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_PEER_ADDRESSES
argument_list|,
name|addrs
argument_list|,
operator|&
name|opt_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|addrs
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
name|raddrs
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addrs
operator|->
name|addr
index|[
literal|0
index|]
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addrs
operator|->
name|addr
index|[
literal|0
index|]
expr_stmt|;
name|lim
operator|=
operator|(
name|caddr_t
operator|)
name|addrs
operator|+
name|opt_len
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|<
name|lim
operator|)
operator|&&
operator|(
name|sa
operator|->
name|sa_len
operator|>
literal|0
operator|)
condition|)
block|{
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|+
name|sa
operator|->
name|sa_len
operator|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|cnt
operator|)
return|;
block|}
end_function

begin_function
name|void
name|sctp_freepaddrs
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|)
block|{
name|void
modifier|*
name|fr_addr
decl_stmt|;
comment|/* Take away the hidden association id */
name|fr_addr
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|addrs
operator|-
sizeof|sizeof
argument_list|(
name|sctp_assoc_t
argument_list|)
operator|)
expr_stmt|;
comment|/* Now free it */
name|free
argument_list|(
name|fr_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sctp_getladdrs
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|id
parameter_list|,
name|struct
name|sockaddr
modifier|*
modifier|*
name|raddrs
parameter_list|)
block|{
name|struct
name|sctp_getaddresses
modifier|*
name|addrs
decl_stmt|;
name|caddr_t
name|lim
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|size_t
name|size_of_addresses
decl_stmt|;
name|socklen_t
name|opt_len
decl_stmt|;
name|int
name|cnt
decl_stmt|;
if|if
condition|(
name|raddrs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|EFAULT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|size_of_addresses
operator|=
literal|0
expr_stmt|;
name|opt_len
operator|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_LOCAL_ADDR_SIZE
argument_list|,
operator|&
name|size_of_addresses
argument_list|,
operator|&
name|opt_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|size_of_addresses
operator|==
literal|0
condition|)
block|{
name|errno
operator|=
name|ENOTCONN
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|opt_len
operator|=
call|(
name|socklen_t
call|)
argument_list|(
name|size_of_addresses
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_getaddresses
argument_list|)
argument_list|)
expr_stmt|;
name|addrs
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
operator|(
name|size_t
operator|)
name|opt_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|addrs
operator|->
name|sget_assoc_id
operator|=
name|id
expr_stmt|;
comment|/* Now lets get the array of addresses */
if|if
condition|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_LOCAL_ADDRESSES
argument_list|,
name|addrs
argument_list|,
operator|&
name|opt_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|addrs
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
name|raddrs
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addrs
operator|->
name|addr
index|[
literal|0
index|]
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addrs
operator|->
name|addr
index|[
literal|0
index|]
expr_stmt|;
name|lim
operator|=
operator|(
name|caddr_t
operator|)
name|addrs
operator|+
name|opt_len
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|<
name|lim
operator|)
operator|&&
operator|(
name|sa
operator|->
name|sa_len
operator|>
literal|0
operator|)
condition|)
block|{
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|+
name|sa
operator|->
name|sa_len
operator|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|cnt
operator|)
return|;
block|}
end_function

begin_function
name|void
name|sctp_freeladdrs
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|)
block|{
name|void
modifier|*
name|fr_addr
decl_stmt|;
comment|/* Take away the hidden association id */
name|fr_addr
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|addrs
operator|-
sizeof|sizeof
argument_list|(
name|sctp_assoc_t
argument_list|)
operator|)
expr_stmt|;
comment|/* Now free it */
name|free
argument_list|(
name|fr_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ssize_t
name|sctp_sendmsg
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|to
parameter_list|,
name|socklen_t
name|tolen
parameter_list|,
name|uint32_t
name|ppid
parameter_list|,
name|uint32_t
name|flags
parameter_list|,
name|uint16_t
name|stream_no
parameter_list|,
name|uint32_t
name|timetolive
parameter_list|,
name|uint32_t
name|context
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|SYS_sctp_generic_sendmsg
name|struct
name|sctp_sndrcvinfo
name|sinfo
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sinfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
name|sinfo
operator|.
name|sinfo_ppid
operator|=
name|ppid
expr_stmt|;
name|sinfo
operator|.
name|sinfo_flags
operator|=
name|flags
expr_stmt|;
name|sinfo
operator|.
name|sinfo_stream
operator|=
name|stream_no
expr_stmt|;
name|sinfo
operator|.
name|sinfo_timetolive
operator|=
name|timetolive
expr_stmt|;
name|sinfo
operator|.
name|sinfo_context
operator|=
name|context
expr_stmt|;
name|sinfo
operator|.
name|sinfo_assoc_id
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|syscall
argument_list|(
name|SYS_sctp_generic_sendmsg
argument_list|,
name|s
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|to
argument_list|,
name|tolen
argument_list|,
operator|&
name|sinfo
argument_list|,
literal|0
argument_list|)
operator|)
return|;
else|#
directive|else
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|sctp_sndrcvinfo
modifier|*
name|sinfo
decl_stmt|;
name|struct
name|iovec
name|iov
decl_stmt|;
name|char
name|cmsgbuf
index|[
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
index|]
decl_stmt|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|who
init|=
name|NULL
decl_stmt|;
union|union
block|{
name|struct
name|sockaddr_in
name|in
decl_stmt|;
name|struct
name|sockaddr_in6
name|in6
decl_stmt|;
block|}
name|addr
union|;
if|if
condition|(
operator|(
name|tolen
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|(
name|to
operator|==
name|NULL
operator|)
operator|||
operator|(
name|tolen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
operator|)
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|to
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|tolen
operator|>
literal|0
operator|)
condition|)
block|{
switch|switch
condition|(
name|to
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|tolen
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|to
operator|->
name|sa_len
operator|>
literal|0
operator|)
operator|&&
operator|(
name|to
operator|->
name|sa_len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
name|to
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|in
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
if|if
condition|(
name|tolen
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|to
operator|->
name|sa_len
operator|>
literal|0
operator|)
operator|&&
operator|(
name|to
operator|->
name|sa_len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
name|to
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|in6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
break|break;
default|default:
name|errno
operator|=
name|EAFNOSUPPORT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|who
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
expr_stmt|;
block|}
name|iov
operator|.
name|iov_base
operator|=
operator|(
name|char
operator|*
operator|)
name|data
expr_stmt|;
name|iov
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|who
condition|)
block|{
name|msg
operator|.
name|msg_name
operator|=
operator|(
name|caddr_t
operator|)
name|who
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
name|who
operator|->
name|sa_len
expr_stmt|;
block|}
else|else
block|{
name|msg
operator|.
name|msg_name
operator|=
operator|(
name|caddr_t
operator|)
name|NULL
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
literal|0
expr_stmt|;
block|}
name|msg
operator|.
name|msg_iov
operator|=
operator|&
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
name|cmsgbuf
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
name|cmsgbuf
expr_stmt|;
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_SNDRCV
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
name|sinfo
operator|=
operator|(
expr|struct
name|sctp_sndrcvinfo
operator|*
operator|)
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|sinfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
name|sinfo
operator|->
name|sinfo_stream
operator|=
name|stream_no
expr_stmt|;
name|sinfo
operator|->
name|sinfo_ssn
operator|=
literal|0
expr_stmt|;
name|sinfo
operator|->
name|sinfo_flags
operator|=
name|flags
expr_stmt|;
name|sinfo
operator|->
name|sinfo_ppid
operator|=
name|ppid
expr_stmt|;
name|sinfo
operator|->
name|sinfo_context
operator|=
name|context
expr_stmt|;
name|sinfo
operator|->
name|sinfo_assoc_id
operator|=
literal|0
expr_stmt|;
name|sinfo
operator|->
name|sinfo_timetolive
operator|=
name|timetolive
expr_stmt|;
return|return
operator|(
name|sendmsg
argument_list|(
name|s
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|sctp_assoc_t
name|sctp_getassocid
parameter_list|(
name|int
name|sd
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|struct
name|sctp_paddrinfo
name|sp
decl_stmt|;
name|socklen_t
name|siz
decl_stmt|;
comment|/* First get the assoc id */
name|siz
operator|=
sizeof|sizeof
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|sp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sp
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|sp
operator|.
name|spinfo_address
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_PEER_ADDR_INFO
argument_list|,
operator|&
name|sp
argument_list|,
operator|&
name|siz
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* We depend on the fact that 0 can never be returned */
return|return
operator|(
operator|(
name|sctp_assoc_t
operator|)
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|sp
operator|.
name|spinfo_assoc_id
operator|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|sctp_send
parameter_list|(
name|int
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|struct
name|sctp_sndrcvinfo
modifier|*
name|sinfo
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|SYS_sctp_generic_sendmsg
name|struct
name|sockaddr
modifier|*
name|to
init|=
name|NULL
decl_stmt|;
return|return
operator|(
name|syscall
argument_list|(
name|SYS_sctp_generic_sendmsg
argument_list|,
name|sd
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|to
argument_list|,
literal|0
argument_list|,
name|sinfo
argument_list|,
name|flags
argument_list|)
operator|)
return|;
else|#
directive|else
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|iov
decl_stmt|;
name|char
name|cmsgbuf
index|[
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
index|]
decl_stmt|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
if|if
condition|(
name|sinfo
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|iov
operator|.
name|iov_base
operator|=
operator|(
name|char
operator|*
operator|)
name|data
expr_stmt|;
name|iov
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
name|NULL
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
operator|&
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
name|cmsgbuf
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
name|cmsgbuf
expr_stmt|;
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_SNDRCV
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
name|sinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|sendmsg
argument_list|(
name|sd
argument_list|,
operator|&
name|msg
argument_list|,
name|flags
argument_list|)
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|ssize_t
name|sctp_sendx
parameter_list|(
name|int
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|,
name|int
name|addrcnt
parameter_list|,
name|struct
name|sctp_sndrcvinfo
modifier|*
name|sinfo
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|sctp_sndrcvinfo
name|__sinfo
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|,
modifier|*
name|aa
decl_stmt|,
name|saved_errno
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|no_end_cx
init|=
literal|0
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|add_len
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|at
decl_stmt|;
if|if
condition|(
name|addrs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|SYS_sctp_generic_sendmsg
if|if
condition|(
name|addrcnt
operator|==
literal|1
condition|)
block|{
name|socklen_t
name|l
decl_stmt|;
comment|/* 		 * Quick way, we don't need to do a connectx so lets use the 		 * syscall directly. 		 */
name|l
operator|=
name|addrs
operator|->
name|sa_len
expr_stmt|;
return|return
operator|(
name|syscall
argument_list|(
name|SYS_sctp_generic_sendmsg
argument_list|,
name|sd
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|,
name|addrs
argument_list|,
name|l
argument_list|,
name|sinfo
argument_list|,
name|flags
argument_list|)
operator|)
return|;
block|}
endif|#
directive|endif
name|len
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|at
operator|=
name|addrs
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
comment|/* validate all the addresses and get the size */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addrcnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|at
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|add_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|at
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
name|add_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|len
operator|+=
name|add_len
expr_stmt|;
name|at
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|at
operator|+
name|add_len
operator|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
comment|/* do we have any? */
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|buf
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|aa
operator|=
operator|(
name|int
operator|*
operator|)
name|buf
expr_stmt|;
operator|*
name|aa
operator|=
name|cnt
expr_stmt|;
name|aa
operator|++
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|caddr_t
operator|)
name|aa
argument_list|,
name|addrs
argument_list|,
call|(
name|size_t
call|)
argument_list|(
name|len
operator|-
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_CONNECT_X_DELAYED
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
operator|(
name|socklen_t
operator|)
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EALREADY
condition|)
block|{
name|no_end_cx
operator|=
literal|1
expr_stmt|;
goto|goto
name|continue_send
goto|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
name|continue_send
label|:
if|if
condition|(
name|sinfo
operator|==
name|NULL
condition|)
block|{
name|sinfo
operator|=
operator|&
name|__sinfo
expr_stmt|;
name|memset
argument_list|(
operator|&
name|__sinfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|__sinfo
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|sinfo
operator|->
name|sinfo_assoc_id
operator|=
name|sctp_getassocid
argument_list|(
name|sd
argument_list|,
name|addrs
argument_list|)
expr_stmt|;
if|if
condition|(
name|sinfo
operator|->
name|sinfo_assoc_id
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_CONNECT_X_COMPLETE
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addrs
argument_list|,
operator|(
name|socklen_t
operator|)
name|addrs
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOENT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ret
operator|=
name|sctp_send
argument_list|(
name|sd
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|,
name|sinfo
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|saved_errno
operator|=
name|errno
expr_stmt|;
if|if
condition|(
name|no_end_cx
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_CONNECT_X_COMPLETE
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addrs
argument_list|,
operator|(
name|socklen_t
operator|)
name|addrs
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|errno
operator|=
name|saved_errno
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|sctp_sendmsgx
parameter_list|(
name|int
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|msg
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|,
name|int
name|addrcnt
parameter_list|,
name|uint32_t
name|ppid
parameter_list|,
name|uint32_t
name|flags
parameter_list|,
name|uint16_t
name|stream_no
parameter_list|,
name|uint32_t
name|timetolive
parameter_list|,
name|uint32_t
name|context
parameter_list|)
block|{
name|struct
name|sctp_sndrcvinfo
name|sinfo
decl_stmt|;
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|sinfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
name|sinfo
operator|.
name|sinfo_ppid
operator|=
name|ppid
expr_stmt|;
name|sinfo
operator|.
name|sinfo_flags
operator|=
name|flags
expr_stmt|;
name|sinfo
operator|.
name|sinfo_ssn
operator|=
name|stream_no
expr_stmt|;
name|sinfo
operator|.
name|sinfo_timetolive
operator|=
name|timetolive
expr_stmt|;
name|sinfo
operator|.
name|sinfo_context
operator|=
name|context
expr_stmt|;
return|return
operator|(
name|sctp_sendx
argument_list|(
name|sd
argument_list|,
name|msg
argument_list|,
name|len
argument_list|,
name|addrs
argument_list|,
name|addrcnt
argument_list|,
operator|&
name|sinfo
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|sctp_recvmsg
parameter_list|(
name|int
name|s
parameter_list|,
name|void
modifier|*
name|dbuf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|,
name|socklen_t
modifier|*
name|fromlen
parameter_list|,
name|struct
name|sctp_sndrcvinfo
modifier|*
name|sinfo
parameter_list|,
name|int
modifier|*
name|msg_flags
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|SYS_sctp_generic_recvmsg
name|struct
name|iovec
name|iov
decl_stmt|;
name|iov
operator|.
name|iov_base
operator|=
name|dbuf
expr_stmt|;
name|iov
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
return|return
operator|(
name|syscall
argument_list|(
name|SYS_sctp_generic_recvmsg
argument_list|,
name|s
argument_list|,
operator|&
name|iov
argument_list|,
literal|1
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|,
name|sinfo
argument_list|,
name|msg_flags
argument_list|)
operator|)
return|;
else|#
directive|else
name|ssize_t
name|sz
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|iov
decl_stmt|;
name|char
name|cmsgbuf
index|[
name|SCTP_CONTROL_VEC_SIZE_RCV
index|]
decl_stmt|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
if|if
condition|(
name|msg_flags
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|msg
operator|.
name|msg_flags
operator|=
literal|0
expr_stmt|;
name|iov
operator|.
name|iov_base
operator|=
name|dbuf
expr_stmt|;
name|iov
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|(
name|caddr_t
operator|)
name|from
expr_stmt|;
if|if
condition|(
name|fromlen
operator|==
name|NULL
condition|)
name|msg
operator|.
name|msg_namelen
operator|=
literal|0
expr_stmt|;
else|else
name|msg
operator|.
name|msg_namelen
operator|=
operator|*
name|fromlen
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
operator|&
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
name|cmsgbuf
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
sizeof|sizeof
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|sz
operator|=
name|recvmsg
argument_list|(
name|s
argument_list|,
operator|&
name|msg
argument_list|,
operator|*
name|msg_flags
argument_list|)
expr_stmt|;
operator|*
name|msg_flags
operator|=
name|msg
operator|.
name|msg_flags
expr_stmt|;
if|if
condition|(
name|sz
operator|<=
literal|0
condition|)
block|{
return|return
operator|(
name|sz
operator|)
return|;
block|}
if|if
condition|(
name|sinfo
condition|)
block|{
name|sinfo
operator|->
name|sinfo_assoc_id
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|msg
operator|.
name|msg_controllen
operator|>
literal|0
operator|)
operator|&&
operator|(
name|sinfo
operator|!=
name|NULL
operator|)
condition|)
block|{
comment|/* 		 * parse through and see if we find the sctp_sndrcvinfo (if 		 * the user wants it). 		 */
for|for
control|(
name|cmsg
operator|=
name|CMSG_FIRSTHDR
argument_list|(
operator|&
name|msg
argument_list|)
init|;
name|cmsg
condition|;
name|cmsg
operator|=
name|CMSG_NXTHDR
argument_list|(
operator|&
name|msg
argument_list|,
name|cmsg
argument_list|)
control|)
block|{
if|if
condition|(
name|cmsg
operator|->
name|cmsg_level
operator|!=
name|IPPROTO_SCTP
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|cmsg
operator|->
name|cmsg_type
operator|==
name|SCTP_SNDRCV
condition|)
block|{
name|memcpy
argument_list|(
name|sinfo
argument_list|,
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cmsg
operator|->
name|cmsg_type
operator|==
name|SCTP_EXTRCV
condition|)
block|{
comment|/* 				 * Let's hope that the user provided enough 				 * enough memory. At least he asked for more 				 * information. 				 */
name|memcpy
argument_list|(
name|sinfo
argument_list|,
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_extrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
operator|(
name|sz
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|ssize_t
name|sctp_recvv
parameter_list|(
name|int
name|sd
parameter_list|,
specifier|const
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
name|iovlen
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|,
name|socklen_t
modifier|*
name|fromlen
parameter_list|,
name|void
modifier|*
name|info
parameter_list|,
name|socklen_t
modifier|*
name|infolen
parameter_list|,
name|unsigned
name|int
modifier|*
name|infotype
parameter_list|,
name|int
modifier|*
name|flags
parameter_list|)
block|{
name|char
name|cmsgbuf
index|[
name|SCTP_CONTROL_VEC_SIZE_RCV
index|]
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|struct
name|sctp_rcvinfo
modifier|*
name|rcvinfo
decl_stmt|;
name|struct
name|sctp_nxtinfo
modifier|*
name|nxtinfo
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|info
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|infolen
operator|==
name|NULL
operator|)
operator|)
operator||
operator|(
operator|(
name|info
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|infolen
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|*
name|infolen
operator|!=
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|info
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|infotype
operator|==
name|NULL
operator|)
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|infotype
condition|)
block|{
operator|*
name|infotype
operator|=
name|SCTP_RECVV_NOINFO
expr_stmt|;
block|}
name|msg
operator|.
name|msg_name
operator|=
name|from
expr_stmt|;
if|if
condition|(
name|fromlen
operator|==
name|NULL
condition|)
block|{
name|msg
operator|.
name|msg_namelen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|msg
operator|.
name|msg_namelen
operator|=
operator|*
name|fromlen
expr_stmt|;
block|}
name|msg
operator|.
name|msg_iov
operator|=
operator|(
expr|struct
name|iovec
operator|*
operator|)
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
name|iovlen
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
name|cmsgbuf
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
sizeof|sizeof
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|ret
operator|=
name|recvmsg
argument_list|(
name|sd
argument_list|,
operator|&
name|msg
argument_list|,
operator|*
name|flags
argument_list|)
expr_stmt|;
operator|*
name|flags
operator|=
name|msg
operator|.
name|msg_flags
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|>
literal|0
operator|)
operator|&&
operator|(
name|msg
operator|.
name|msg_controllen
operator|>
literal|0
operator|)
operator|&&
operator|(
name|infotype
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|infolen
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|*
name|infolen
operator|>
literal|0
operator|)
condition|)
block|{
name|rcvinfo
operator|=
name|NULL
expr_stmt|;
name|nxtinfo
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|cmsg
operator|=
name|CMSG_FIRSTHDR
argument_list|(
operator|&
name|msg
argument_list|)
init|;
name|cmsg
condition|;
name|cmsg
operator|=
name|CMSG_NXTHDR
argument_list|(
operator|&
name|msg
argument_list|,
name|cmsg
argument_list|)
control|)
block|{
if|if
condition|(
name|cmsg
operator|->
name|cmsg_level
operator|!=
name|IPPROTO_SCTP
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|cmsg
operator|->
name|cmsg_type
operator|==
name|SCTP_RCVINFO
condition|)
block|{
name|rcvinfo
operator|=
operator|(
expr|struct
name|sctp_rcvinfo
operator|*
operator|)
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|nxtinfo
operator|!=
name|NULL
condition|)
block|{
break|break;
block|}
else|else
block|{
continue|continue;
block|}
block|}
if|if
condition|(
name|cmsg
operator|->
name|cmsg_type
operator|==
name|SCTP_NXTINFO
condition|)
block|{
name|nxtinfo
operator|=
operator|(
expr|struct
name|sctp_nxtinfo
operator|*
operator|)
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcvinfo
operator|!=
name|NULL
condition|)
block|{
break|break;
block|}
else|else
block|{
continue|continue;
block|}
block|}
block|}
if|if
condition|(
name|rcvinfo
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|nxtinfo
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|*
name|infolen
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_recvv_rn
argument_list|)
operator|)
condition|)
block|{
name|struct
name|sctp_recvv_rn
modifier|*
name|rn_info
decl_stmt|;
name|rn_info
operator|=
operator|(
expr|struct
name|sctp_recvv_rn
operator|*
operator|)
name|info
expr_stmt|;
name|rn_info
operator|->
name|recvv_rcvinfo
operator|=
operator|*
name|rcvinfo
expr_stmt|;
name|rn_info
operator|->
name|recvv_nxtinfo
operator|=
operator|*
name|nxtinfo
expr_stmt|;
operator|*
name|infolen
operator|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_recvv_rn
argument_list|)
expr_stmt|;
operator|*
name|infotype
operator|=
name|SCTP_RECVV_RN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|infolen
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_rcvinfo
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
name|info
argument_list|,
name|rcvinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_rcvinfo
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|infolen
operator|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_rcvinfo
argument_list|)
expr_stmt|;
operator|*
name|infotype
operator|=
name|SCTP_RECVV_RCVINFO
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|nxtinfo
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|*
name|infolen
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_nxtinfo
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
name|info
argument_list|,
name|nxtinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_nxtinfo
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|infolen
operator|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_nxtinfo
argument_list|)
expr_stmt|;
operator|*
name|infotype
operator|=
name|SCTP_RECVV_NXTINFO
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|sctp_sendv
parameter_list|(
name|int
name|sd
parameter_list|,
specifier|const
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
name|iovcnt
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|,
name|int
name|addrcnt
parameter_list|,
name|void
modifier|*
name|info
parameter_list|,
name|socklen_t
name|infolen
parameter_list|,
name|unsigned
name|int
name|infotype
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|ssize_t
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|socklen_t
name|addr_len
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
name|struct
name|sctp_sendv_spa
modifier|*
name|spa_info
decl_stmt|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
name|char
modifier|*
name|cmsgbuf
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|addr
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|addr_in
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|addr_in6
decl_stmt|;
if|if
condition|(
operator|(
name|addrcnt
operator|<
literal|0
operator|)
operator|||
operator|(
name|iovcnt
operator|<
literal|0
operator|)
operator|||
operator|(
operator|(
name|addrs
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|addrcnt
operator|>
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|addrs
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|addrcnt
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|iov
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|iovcnt
operator|>
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|iov
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|iovcnt
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|cmsgbuf
operator|=
name|malloc
argument_list|(
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndinfo
argument_list|)
argument_list|)
operator|+
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_prinfo
argument_list|)
argument_list|)
operator|+
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_authinfo
argument_list|)
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|addrcnt
operator|*
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmsgbuf
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|msg
operator|.
name|msg_control
operator|=
name|cmsgbuf
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
literal|0
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
name|cmsgbuf
expr_stmt|;
switch|switch
condition|(
name|infotype
condition|)
block|{
case|case
name|SCTP_SENDV_NOINFO
case|:
if|if
condition|(
operator|(
name|infolen
operator|!=
literal|0
operator|)
operator|||
operator|(
name|info
operator|!=
name|NULL
operator|)
condition|)
block|{
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
break|break;
case|case
name|SCTP_SENDV_SNDINFO
case|:
if|if
condition|(
operator|(
name|info
operator|==
name|NULL
operator|)
operator|||
operator|(
name|infolen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndinfo
argument_list|)
operator|)
condition|)
block|{
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_SNDINFO
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndinfo
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
name|info
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndinfo
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|+=
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndinfo
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|cmsg
operator|+
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndinfo
argument_list|)
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|SCTP_SENDV_PRINFO
case|:
if|if
condition|(
operator|(
name|info
operator|==
name|NULL
operator|)
operator|||
operator|(
name|infolen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_prinfo
argument_list|)
operator|)
condition|)
block|{
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_PRINFO
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_prinfo
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
name|info
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_prinfo
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|+=
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_prinfo
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|cmsg
operator|+
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_prinfo
argument_list|)
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|SCTP_SENDV_AUTHINFO
case|:
if|if
condition|(
operator|(
name|info
operator|==
name|NULL
operator|)
operator|||
operator|(
name|infolen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_authinfo
argument_list|)
operator|)
condition|)
block|{
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_AUTHINFO
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_authinfo
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
name|info
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_authinfo
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|+=
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_authinfo
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|cmsg
operator|+
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_authinfo
argument_list|)
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|SCTP_SENDV_SPA
case|:
if|if
condition|(
operator|(
name|info
operator|==
name|NULL
operator|)
operator|||
operator|(
name|infolen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sendv_spa
argument_list|)
operator|)
condition|)
block|{
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|spa_info
operator|=
operator|(
expr|struct
name|sctp_sendv_spa
operator|*
operator|)
name|info
expr_stmt|;
if|if
condition|(
name|spa_info
operator|->
name|sendv_flags
operator|&
name|SCTP_SEND_SNDINFO_VALID
condition|)
block|{
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_SNDINFO
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndinfo
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
operator|&
name|spa_info
operator|->
name|sendv_sndinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndinfo
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|+=
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndinfo
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|cmsg
operator|+
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndinfo
argument_list|)
argument_list|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|spa_info
operator|->
name|sendv_flags
operator|&
name|SCTP_SEND_PRINFO_VALID
condition|)
block|{
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_PRINFO
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_prinfo
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
operator|&
name|spa_info
operator|->
name|sendv_prinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_prinfo
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|+=
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_prinfo
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|cmsg
operator|+
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_prinfo
argument_list|)
argument_list|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|spa_info
operator|->
name|sendv_flags
operator|&
name|SCTP_SEND_AUTHINFO_VALID
condition|)
block|{
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_AUTHINFO
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_authinfo
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
operator|&
name|spa_info
operator|->
name|sendv_authinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_authinfo
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|+=
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_authinfo
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|cmsg
operator|+
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_authinfo
argument_list|)
argument_list|)
operator|)
expr_stmt|;
block|}
break|break;
default|default:
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|addr
operator|=
name|addrs
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
name|NULL
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addrcnt
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|addr
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|addr_len
operator|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|addr_in
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
if|if
condition|(
name|addr_in
operator|->
name|sin_len
operator|!=
name|addr_len
condition|)
block|{
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|port
operator|=
name|addr_in
operator|->
name|sin_port
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|port
operator|==
name|addr_in
operator|->
name|sin_port
condition|)
block|{
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_DSTADDRV4
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
operator|&
name|addr_in
operator|->
name|sin_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|+=
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|cmsg
operator|+
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
break|break;
case|case
name|AF_INET6
case|:
name|addr_len
operator|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
name|addr_in6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|addr
expr_stmt|;
if|if
condition|(
name|addr_in6
operator|->
name|sin6_len
operator|!=
name|addr_len
condition|)
block|{
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|port
operator|=
name|addr_in6
operator|->
name|sin6_port
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|port
operator|==
name|addr_in6
operator|->
name|sin6_port
condition|)
block|{
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_DSTADDRV6
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
operator|&
name|addr_in6
operator|->
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|+=
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|cmsg
operator|+
name|CMSG_SPACE
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
break|break;
default|default:
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|msg
operator|.
name|msg_name
operator|=
name|addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
name|addr_len
expr_stmt|;
block|}
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|addr
operator|+
name|addr_len
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|.
name|msg_controllen
operator|==
literal|0
condition|)
block|{
name|msg
operator|.
name|msg_control
operator|=
name|NULL
expr_stmt|;
block|}
name|msg
operator|.
name|msg_iov
operator|=
operator|(
expr|struct
name|iovec
operator|*
operator|)
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
name|iovcnt
expr_stmt|;
name|msg
operator|.
name|msg_flags
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|sendmsg
argument_list|(
name|sd
argument_list|,
operator|&
name|msg
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cmsgbuf
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|SYS_sctp_peeloff
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|HAVE_SCTP_PEELOFF_SOCKOPT
argument_list|)
end_if

begin_function
name|int
name|sctp_peeloff
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|assoc_id
parameter_list|)
block|{
comment|/* NOT supported, return invalid sd */
name|errno
operator|=
name|ENOTSUP
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|SYS_sctp_peeloff
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|HAVE_SCTP_PEELOFF_SOCKOPT
argument_list|)
end_if

begin_function
name|int
name|sctp_peeloff
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|assoc_id
parameter_list|)
block|{
return|return
operator|(
name|syscall
argument_list|(
name|SYS_sctp_peeloff
argument_list|,
name|sd
argument_list|,
name|assoc_id
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|SCTP_CONTROL_VEC_SIZE_RCV
end_undef

end_unit


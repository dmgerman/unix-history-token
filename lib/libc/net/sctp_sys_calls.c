begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$KAME: sctp_sys_calls.c,v 1.9 2004/08/17 06:08:53 itojun Exp $ */
end_comment

begin_comment
comment|/*  * Copyright (C) 2002-2006 Cisco Systems Inc,  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/syscall.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netinet/sctp_uio.h>
end_include

begin_include
include|#
directive|include
file|<netinet/sctp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|IN6_IS_ADDR_V4MAPPED
end_ifndef

begin_define
define|#
directive|define
name|IN6_IS_ADDR_V4MAPPED
parameter_list|(
name|a
parameter_list|)
define|\
value|((*(const u_int32_t *)(const void *)(&(a)->s6_addr[0]) == 0)&&	\ 	 (*(const u_int32_t *)(const void *)(&(a)->s6_addr[4]) == 0)&&	\ 	 (*(const u_int32_t *)(const void *)(&(a)->s6_addr[8]) == ntohl(0x0000ffff)))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|SCTP_CONTROL_VEC_SIZE_SND
value|8192
end_define

begin_define
define|#
directive|define
name|SCTP_CONTROL_VEC_SIZE_RCV
value|16384
end_define

begin_define
define|#
directive|define
name|SCTP_STACK_BUF_SIZE
value|2048
end_define

begin_define
define|#
directive|define
name|SCTP_SMALL_IOVEC_SIZE
value|2
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|SCTP_DEBUG_PRINT_ADDRESS
end_ifdef

begin_define
define|#
directive|define
name|SCTP_STRING_BUF_SZ
value|256
end_define

begin_function
specifier|static
name|void
name|SCTPPrintAnAddress
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|a
parameter_list|)
block|{
name|char
name|stringToPrint
index|[
name|SCTP_STRING_BUF_SZ
index|]
decl_stmt|;
name|u_short
name|prt
decl_stmt|;
name|char
modifier|*
name|srcaddr
decl_stmt|,
modifier|*
name|txt
decl_stmt|;
if|if
condition|(
name|a
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"NULL\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|a
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|srcaddr
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|a
operator|)
operator|->
name|sin_addr
expr_stmt|;
name|txt
operator|=
literal|"IPv4 Address: "
expr_stmt|;
name|prt
operator|=
name|ntohs
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|a
operator|)
operator|->
name|sin_port
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|a
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
name|srcaddr
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|a
operator|)
operator|->
name|sin6_addr
expr_stmt|;
name|prt
operator|=
name|ntohs
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|a
operator|)
operator|->
name|sin6_port
argument_list|)
expr_stmt|;
name|txt
operator|=
literal|"IPv6 Address: "
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|a
operator|->
name|sa_family
operator|==
name|AF_LINK
condition|)
block|{
name|int
name|i
decl_stmt|;
name|char
name|tbuf
index|[
name|SCTP_STRING_BUF_SZ
index|]
decl_stmt|;
name|u_char
name|adbuf
index|[
name|SCTP_STRING_BUF_SZ
index|]
decl_stmt|;
name|struct
name|sockaddr_dl
modifier|*
name|dl
decl_stmt|;
name|dl
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|a
expr_stmt|;
name|strncpy
argument_list|(
name|tbuf
argument_list|,
name|dl
operator|->
name|sdl_data
argument_list|,
name|dl
operator|->
name|sdl_nlen
argument_list|)
expr_stmt|;
name|tbuf
index|[
name|dl
operator|->
name|sdl_nlen
index|]
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"Intf:%s (len:%d)Interface index:%d type:%x(%d) ll-len:%d "
argument_list|,
name|tbuf
argument_list|,
name|dl
operator|->
name|sdl_nlen
argument_list|,
name|dl
operator|->
name|sdl_index
argument_list|,
name|dl
operator|->
name|sdl_type
argument_list|,
name|dl
operator|->
name|sdl_type
argument_list|,
name|dl
operator|->
name|sdl_alen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|adbuf
argument_list|,
name|LLADDR
argument_list|(
name|dl
argument_list|)
argument_list|,
name|dl
operator|->
name|sdl_alen
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dl
operator|->
name|sdl_alen
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%2.2x"
argument_list|,
name|adbuf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
operator|(
name|dl
operator|->
name|sdl_alen
operator|-
literal|1
operator|)
condition|)
name|printf
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
return|return;
block|}
if|if
condition|(
name|inet_ntop
argument_list|(
name|a
operator|->
name|sa_family
argument_list|,
name|srcaddr
argument_list|,
name|stringToPrint
argument_list|,
sizeof|sizeof
argument_list|(
name|stringToPrint
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|a
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
name|printf
argument_list|(
literal|"%s%s:%d scope:%d\n"
argument_list|,
name|txt
argument_list|,
name|stringToPrint
argument_list|,
name|prt
argument_list|,
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|a
operator|)
operator|->
name|sin6_scope_id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s%s:%d\n"
argument_list|,
name|txt
argument_list|,
name|stringToPrint
argument_list|,
name|prt
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s unprintable?\n"
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCTP_DEBUG_PRINT_ADDRESS */
end_comment

begin_function
specifier|static
name|void
name|in6_sin6_2_sin
parameter_list|(
name|struct
name|sockaddr_in
modifier|*
name|sin
parameter_list|,
name|struct
name|sockaddr_in6
modifier|*
name|sin6
parameter_list|)
block|{
name|bzero
argument_list|(
name|sin
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sin
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|->
name|sin_port
operator|=
name|sin6
operator|->
name|sin6_port
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|sin6
operator|->
name|sin6_addr
operator|.
name|__u6_addr
operator|.
name|__u6_addr32
index|[
literal|3
index|]
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sctp_getaddrlen
parameter_list|(
name|sa_family_t
name|family
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|sd
decl_stmt|;
name|socklen_t
name|siz
decl_stmt|;
name|struct
name|sctp_assoc_value
name|av
decl_stmt|;
name|av
operator|.
name|assoc_value
operator|=
name|family
expr_stmt|;
name|siz
operator|=
sizeof|sizeof
argument_list|(
name|av
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|AF_INET
argument_list|)
name|sd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
name|IPPROTO_SCTP
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|AF_INET6
argument_list|)
name|sd
operator|=
name|socket
argument_list|(
name|AF_INET6
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
name|IPPROTO_SCTP
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|sd
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|(
name|errno
operator|)
return|;
block|}
name|error
operator|=
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_ADDR_LEN
argument_list|,
operator|&
name|av
argument_list|,
operator|&
name|siz
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sd
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
return|return
operator|(
operator|(
name|int
operator|)
name|av
operator|.
name|assoc_value
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
end_function

begin_function
name|int
name|sctp_connectx
parameter_list|(
name|int
name|sd
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|,
name|int
name|addrcnt
parameter_list|,
name|sctp_assoc_t
modifier|*
name|id
parameter_list|)
block|{
name|char
name|buf
index|[
name|SCTP_STACK_BUF_SIZE
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|,
name|cnt
decl_stmt|,
modifier|*
name|aa
decl_stmt|;
name|char
modifier|*
name|cpto
decl_stmt|;
specifier|const
name|struct
name|sockaddr
modifier|*
name|at
decl_stmt|;
name|size_t
name|len
init|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
decl_stmt|;
name|sctp_assoc_t
modifier|*
name|p_id
decl_stmt|;
name|at
operator|=
name|addrs
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|cpto
operator|=
operator|(
operator|(
name|caddr_t
operator|)
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|)
expr_stmt|;
comment|/* validate all the addresses and get the size */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addrcnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|at
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|memcpy
argument_list|(
name|cpto
argument_list|,
name|at
argument_list|,
name|at
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|cpto
operator|=
operator|(
operator|(
name|caddr_t
operator|)
name|cpto
operator|+
name|at
operator|->
name|sa_len
operator|)
expr_stmt|;
name|len
operator|+=
name|at
operator|->
name|sa_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|at
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
if|if
condition|(
name|IN6_IS_ADDR_V4MAPPED
argument_list|(
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|at
operator|)
operator|->
name|sin6_addr
argument_list|)
condition|)
block|{
name|len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|in6_sin6_2_sin
argument_list|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|cpto
argument_list|,
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|at
argument_list|)
expr_stmt|;
name|cpto
operator|=
operator|(
operator|(
name|caddr_t
operator|)
name|cpto
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
operator|)
expr_stmt|;
name|len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|cpto
argument_list|,
name|at
argument_list|,
name|at
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|cpto
operator|=
operator|(
operator|(
name|caddr_t
operator|)
name|cpto
operator|+
name|at
operator|->
name|sa_len
operator|)
expr_stmt|;
name|len
operator|+=
name|at
operator|->
name|sa_len
expr_stmt|;
block|}
block|}
else|else
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|len
operator|>
operator|(
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|)
condition|)
block|{
comment|/* Never enough memory */
return|return
operator|(
name|E2BIG
operator|)
return|;
block|}
name|at
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|at
operator|+
name|at
operator|->
name|sa_len
operator|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
comment|/* do we have any? */
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|aa
operator|=
operator|(
name|int
operator|*
operator|)
name|buf
expr_stmt|;
operator|*
name|aa
operator|=
name|cnt
expr_stmt|;
name|ret
operator|=
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_CONNECT_X
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
operator|(
name|socklen_t
operator|)
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|==
literal|0
operator|)
operator|&&
name|id
condition|)
block|{
name|p_id
operator|=
operator|(
name|sctp_assoc_t
operator|*
operator|)
name|buf
expr_stmt|;
operator|*
name|id
operator|=
operator|*
name|p_id
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|sctp_bindx
parameter_list|(
name|int
name|sd
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|,
name|int
name|addrcnt
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|sctp_getaddresses
modifier|*
name|gaddrs
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|i
decl_stmt|,
name|sz
decl_stmt|,
name|fam
decl_stmt|,
name|argsz
decl_stmt|;
if|if
condition|(
operator|(
name|flags
operator|!=
name|SCTP_BINDX_ADD_ADDR
operator|)
operator|&&
operator|(
name|flags
operator|!=
name|SCTP_BINDX_REM_ADDR
operator|)
condition|)
block|{
name|errno
operator|=
name|EFAULT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|argsz
operator|=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_getaddresses
argument_list|)
operator|)
expr_stmt|;
name|gaddrs
operator|=
operator|(
expr|struct
name|sctp_getaddresses
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
name|argsz
argument_list|)
expr_stmt|;
if|if
condition|(
name|gaddrs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|gaddrs
operator|->
name|sget_assoc_id
operator|=
literal|0
expr_stmt|;
name|sa
operator|=
name|addrs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addrcnt
condition|;
name|i
operator|++
control|)
block|{
name|sz
operator|=
name|sa
operator|->
name|sa_len
expr_stmt|;
name|fam
operator|=
name|sa
operator|->
name|sa_family
expr_stmt|;
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|addrs
index|[
name|i
index|]
operator|)
operator|->
name|sin_port
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_port
expr_stmt|;
if|if
condition|(
operator|(
name|fam
operator|!=
name|AF_INET
operator|)
operator|&&
operator|(
name|fam
operator|!=
name|AF_INET6
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|gaddrs
operator|->
name|addr
argument_list|,
name|sa
argument_list|,
name|sz
argument_list|)
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|flags
argument_list|,
name|gaddrs
argument_list|,
operator|(
name|socklen_t
operator|)
name|argsz
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|gaddrs
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memset
argument_list|(
name|gaddrs
argument_list|,
literal|0
argument_list|,
name|argsz
argument_list|)
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|+
name|sz
operator|)
expr_stmt|;
block|}
name|free
argument_list|(
name|gaddrs
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|sctp_opt_info
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|id
parameter_list|,
name|int
name|opt
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|socklen_t
modifier|*
name|size
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
operator|*
operator|(
name|sctp_assoc_t
operator|*
operator|)
name|arg
operator|=
name|id
expr_stmt|;
return|return
operator|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|opt
argument_list|,
name|arg
argument_list|,
name|size
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|sctp_getpaddrs
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|id
parameter_list|,
name|struct
name|sockaddr
modifier|*
modifier|*
name|raddrs
parameter_list|)
block|{
name|struct
name|sctp_getaddresses
modifier|*
name|addrs
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|re
decl_stmt|;
name|sctp_assoc_t
name|asoc
decl_stmt|;
name|caddr_t
name|lim
decl_stmt|;
name|socklen_t
name|siz
decl_stmt|;
name|int
name|cnt
decl_stmt|;
if|if
condition|(
name|raddrs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|EFAULT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|asoc
operator|=
name|id
expr_stmt|;
name|siz
operator|=
sizeof|sizeof
argument_list|(
name|sctp_assoc_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_REMOTE_ADDR_SIZE
argument_list|,
operator|&
name|asoc
argument_list|,
operator|&
name|siz
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* size required is returned in 'asoc' */
name|siz
operator|=
operator|(
name|size_t
operator|)
name|asoc
expr_stmt|;
name|siz
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_getaddresses
argument_list|)
expr_stmt|;
name|addrs
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|siz
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memset
argument_list|(
name|addrs
argument_list|,
literal|0
argument_list|,
name|siz
argument_list|)
expr_stmt|;
name|addrs
operator|->
name|sget_assoc_id
operator|=
name|id
expr_stmt|;
comment|/* Now lets get the array of addresses */
if|if
condition|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_PEER_ADDRESSES
argument_list|,
name|addrs
argument_list|,
operator|&
name|siz
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|addrs
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|re
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addrs
operator|->
name|addr
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|raddrs
operator|=
name|re
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addrs
operator|->
name|addr
index|[
literal|0
index|]
expr_stmt|;
name|lim
operator|=
operator|(
name|caddr_t
operator|)
name|addrs
operator|+
name|siz
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|<
name|lim
operator|)
operator|&&
operator|(
name|sa
operator|->
name|sa_len
operator|>
literal|0
operator|)
condition|)
block|{
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|+
name|sa
operator|->
name|sa_len
operator|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|cnt
operator|)
return|;
block|}
end_function

begin_function
name|void
name|sctp_freepaddrs
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|)
block|{
comment|/* Take away the hidden association id */
name|void
modifier|*
name|fr_addr
decl_stmt|;
name|fr_addr
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|addrs
operator|-
sizeof|sizeof
argument_list|(
name|sctp_assoc_t
argument_list|)
operator|)
expr_stmt|;
comment|/* Now free it */
name|free
argument_list|(
name|fr_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sctp_getladdrs
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|id
parameter_list|,
name|struct
name|sockaddr
modifier|*
modifier|*
name|raddrs
parameter_list|)
block|{
name|struct
name|sctp_getaddresses
modifier|*
name|addrs
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|re
decl_stmt|;
name|caddr_t
name|lim
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|size_of_addresses
decl_stmt|;
name|socklen_t
name|siz
decl_stmt|;
name|int
name|cnt
decl_stmt|;
if|if
condition|(
name|raddrs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|EFAULT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|size_of_addresses
operator|=
literal|0
expr_stmt|;
name|siz
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_LOCAL_ADDR_SIZE
argument_list|,
operator|&
name|size_of_addresses
argument_list|,
operator|&
name|siz
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|size_of_addresses
operator|==
literal|0
condition|)
block|{
name|errno
operator|=
name|ENOTCONN
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|siz
operator|=
name|size_of_addresses
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
expr_stmt|;
name|siz
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_getaddresses
argument_list|)
expr_stmt|;
name|addrs
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|siz
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrs
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memset
argument_list|(
name|addrs
argument_list|,
literal|0
argument_list|,
name|siz
argument_list|)
expr_stmt|;
name|addrs
operator|->
name|sget_assoc_id
operator|=
name|id
expr_stmt|;
comment|/* Now lets get the array of addresses */
if|if
condition|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_GET_LOCAL_ADDRESSES
argument_list|,
name|addrs
argument_list|,
operator|&
name|siz
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|addrs
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|re
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addrs
operator|->
name|addr
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|raddrs
operator|=
name|re
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addrs
operator|->
name|addr
index|[
literal|0
index|]
expr_stmt|;
name|lim
operator|=
operator|(
name|caddr_t
operator|)
name|addrs
operator|+
name|siz
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|<
name|lim
operator|)
operator|&&
operator|(
name|sa
operator|->
name|sa_len
operator|>
literal|0
operator|)
condition|)
block|{
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|sa
operator|+
name|sa
operator|->
name|sa_len
operator|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|cnt
operator|)
return|;
block|}
end_function

begin_function
name|void
name|sctp_freeladdrs
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|)
block|{
comment|/* Take away the hidden association id */
name|void
modifier|*
name|fr_addr
decl_stmt|;
name|fr_addr
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|addrs
operator|-
sizeof|sizeof
argument_list|(
name|sctp_assoc_t
argument_list|)
operator|)
expr_stmt|;
comment|/* Now free it */
name|free
argument_list|(
name|fr_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ssize_t
name|sctp_sendmsg
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|to
parameter_list|,
name|socklen_t
name|tolen
parameter_list|,
name|u_int32_t
name|ppid
parameter_list|,
name|u_int32_t
name|flags
parameter_list|,
name|u_int16_t
name|stream_no
parameter_list|,
name|u_int32_t
name|timetolive
parameter_list|,
name|u_int32_t
name|context
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|SYS_sctp_generic_sendmsg
name|struct
name|sctp_sndrcvinfo
name|sinfo
decl_stmt|;
name|sinfo
operator|.
name|sinfo_ppid
operator|=
name|ppid
expr_stmt|;
name|sinfo
operator|.
name|sinfo_flags
operator|=
name|flags
expr_stmt|;
name|sinfo
operator|.
name|sinfo_stream
operator|=
name|stream_no
expr_stmt|;
name|sinfo
operator|.
name|sinfo_timetolive
operator|=
name|timetolive
expr_stmt|;
name|sinfo
operator|.
name|sinfo_context
operator|=
name|context
expr_stmt|;
name|sinfo
operator|.
name|sinfo_assoc_id
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|syscall
argument_list|(
name|SYS_sctp_generic_sendmsg
argument_list|,
name|s
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|to
argument_list|,
name|tolen
argument_list|,
operator|&
name|sinfo
argument_list|,
literal|0
argument_list|)
operator|)
return|;
else|#
directive|else
name|ssize_t
name|sz
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|sctp_sndrcvinfo
modifier|*
name|s_info
decl_stmt|;
name|struct
name|iovec
name|iov
index|[
name|SCTP_SMALL_IOVEC_SIZE
index|]
decl_stmt|;
name|char
name|controlVector
index|[
name|SCTP_CONTROL_VEC_SIZE_RCV
index|]
decl_stmt|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|who
init|=
name|NULL
decl_stmt|;
union|union
block|{
name|struct
name|sockaddr_in
name|in
decl_stmt|;
name|struct
name|sockaddr_in6
name|in6
decl_stmt|;
block|}
name|addr
union|;
comment|/*   fprintf(io, "sctp_sendmsg(sd:%d, data:%x, len:%d, to:%x, tolen:%d, ppid:%x, flags:%x str:%d ttl:%d ctx:%x\n",   s,   (u_int)data,   (int)len,   (u_int)to,   (int)tolen,   ppid, flags,   (int)stream_no,   (int)timetolive,   (u_int)context);   fflush(io); */
if|if
condition|(
operator|(
name|tolen
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|(
name|to
operator|==
name|NULL
operator|)
operator|||
operator|(
name|tolen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
operator|)
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|to
operator|&&
operator|(
name|tolen
operator|>
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|to
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
if|if
condition|(
name|tolen
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|to
operator|->
name|sa_len
operator|>
literal|0
operator|)
operator|&&
operator|(
name|to
operator|->
name|sa_len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
name|to
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|in
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|to
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
if|if
condition|(
name|tolen
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|to
operator|->
name|sa_len
operator|>
literal|0
operator|)
operator|&&
operator|(
name|to
operator|->
name|sa_len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|addr
argument_list|,
name|to
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|in6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|errno
operator|=
name|EAFNOSUPPORT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|who
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
expr_stmt|;
block|}
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
operator|(
name|char
operator|*
operator|)
name|data
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
name|NULL
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|who
condition|)
block|{
name|msg
operator|.
name|msg_name
operator|=
operator|(
name|caddr_t
operator|)
name|who
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
name|who
operator|->
name|sa_len
expr_stmt|;
block|}
else|else
block|{
name|msg
operator|.
name|msg_name
operator|=
operator|(
name|caddr_t
operator|)
name|NULL
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
literal|0
expr_stmt|;
block|}
name|msg
operator|.
name|msg_iov
operator|=
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
operator|(
name|caddr_t
operator|)
name|controlVector
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
name|controlVector
expr_stmt|;
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_SNDRCV
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
name|s_info
operator|=
operator|(
expr|struct
name|sctp_sndrcvinfo
operator|*
operator|)
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
expr_stmt|;
name|s_info
operator|->
name|sinfo_stream
operator|=
name|stream_no
expr_stmt|;
name|s_info
operator|->
name|sinfo_ssn
operator|=
literal|0
expr_stmt|;
name|s_info
operator|->
name|sinfo_flags
operator|=
name|flags
expr_stmt|;
name|s_info
operator|->
name|sinfo_ppid
operator|=
name|ppid
expr_stmt|;
name|s_info
operator|->
name|sinfo_context
operator|=
name|context
expr_stmt|;
name|s_info
operator|->
name|sinfo_assoc_id
operator|=
literal|0
expr_stmt|;
name|s_info
operator|->
name|sinfo_timetolive
operator|=
name|timetolive
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
name|cmsg
operator|->
name|cmsg_len
expr_stmt|;
name|sz
operator|=
name|sendmsg
argument_list|(
name|s
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|sz
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|sctp_assoc_t
name|sctp_getassocid
parameter_list|(
name|int
name|sd
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|struct
name|sctp_paddrparams
name|sp
decl_stmt|;
name|socklen_t
name|siz
decl_stmt|;
comment|/* First get the assoc id */
name|siz
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_paddrparams
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|sp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sp
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|sp
operator|.
name|spp_address
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_PEER_ADDR_PARAMS
argument_list|,
operator|&
name|sp
argument_list|,
operator|&
name|siz
argument_list|)
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
operator|(
name|sctp_assoc_t
operator|)
literal|0
operator|)
return|;
block|}
comment|/* We depend on the fact that 0 can never be returned */
return|return
operator|(
name|sp
operator|.
name|spp_assoc_id
operator|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|sctp_send
parameter_list|(
name|int
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|struct
name|sctp_sndrcvinfo
modifier|*
name|sinfo
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|SYS_sctp_generic_sendmsg
name|struct
name|sockaddr
modifier|*
name|to
init|=
name|NULL
decl_stmt|;
return|return
operator|(
name|syscall
argument_list|(
name|SYS_sctp_generic_sendmsg
argument_list|,
name|sd
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|to
argument_list|,
literal|0
argument_list|,
name|sinfo
argument_list|,
name|flags
argument_list|)
operator|)
return|;
else|#
directive|else
name|ssize_t
name|sz
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|iov
index|[
name|SCTP_SMALL_IOVEC_SIZE
index|]
decl_stmt|;
name|struct
name|sctp_sndrcvinfo
modifier|*
name|s_info
decl_stmt|;
name|char
name|controlVector
index|[
name|SCTP_CONTROL_VEC_SIZE_SND
index|]
decl_stmt|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
if|if
condition|(
name|sinfo
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
operator|(
name|char
operator|*
operator|)
name|data
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
name|NULL
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
operator|(
name|caddr_t
operator|)
name|controlVector
expr_stmt|;
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
name|controlVector
expr_stmt|;
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_SCTP
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|SCTP_SNDRCV
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
name|s_info
operator|=
operator|(
expr|struct
name|sctp_sndrcvinfo
operator|*
operator|)
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
expr_stmt|;
comment|/* copy in the data */
operator|*
name|s_info
operator|=
operator|*
name|sinfo
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
name|cmsg
operator|->
name|cmsg_len
expr_stmt|;
name|sz
operator|=
name|sendmsg
argument_list|(
name|sd
argument_list|,
operator|&
name|msg
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
operator|(
name|sz
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|ssize_t
name|sctp_sendx
parameter_list|(
name|int
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|,
name|int
name|addrcnt
parameter_list|,
name|struct
name|sctp_sndrcvinfo
modifier|*
name|sinfo
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|ssize_t
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|,
modifier|*
name|aa
decl_stmt|,
name|saved_errno
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|add_len
decl_stmt|,
name|len
decl_stmt|,
name|no_end_cx
init|=
literal|0
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|at
decl_stmt|;
ifdef|#
directive|ifdef
name|SYS_sctp_generic_sendmsg
if|if
condition|(
name|addrcnt
operator|<
name|SCTP_SMALL_IOVEC_SIZE
condition|)
block|{
name|socklen_t
name|l
decl_stmt|;
comment|/* 		 * Quick way, we don't need to do a connectx so lets use the 		 * syscall directly. 		 */
name|l
operator|=
name|addrs
operator|->
name|sa_len
expr_stmt|;
return|return
operator|(
name|syscall
argument_list|(
name|SYS_sctp_generic_sendmsg
argument_list|,
name|sd
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|,
name|addrs
argument_list|,
name|l
argument_list|,
name|sinfo
argument_list|,
name|flags
argument_list|)
operator|)
return|;
block|}
endif|#
directive|endif
name|len
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|at
operator|=
name|addrs
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
comment|/* validate all the addresses and get the size */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addrcnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|at
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|add_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|at
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
name|add_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|len
operator|+=
name|add_len
expr_stmt|;
name|at
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|at
operator|+
name|add_len
operator|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
comment|/* do we have any? */
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|buf
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|aa
operator|=
operator|(
name|int
operator|*
operator|)
name|buf
expr_stmt|;
operator|*
name|aa
operator|=
name|cnt
expr_stmt|;
name|aa
operator|++
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|caddr_t
operator|)
name|aa
argument_list|,
name|addrs
argument_list|,
operator|(
name|len
operator|-
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_CONNECT_X_DELAYED
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
operator|(
name|socklen_t
operator|)
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EALREADY
condition|)
block|{
name|no_end_cx
operator|=
literal|1
expr_stmt|;
empty_stmt|;
goto|goto
name|continue_send
goto|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
name|continue_send
label|:
name|sinfo
operator|->
name|sinfo_assoc_id
operator|=
name|sctp_getassocid
argument_list|(
name|sd
argument_list|,
name|addrs
argument_list|)
expr_stmt|;
if|if
condition|(
name|sinfo
operator|->
name|sinfo_assoc_id
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Huh, can't get associd? TSNH!\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_CONNECT_X_COMPLETE
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addrs
argument_list|,
operator|(
name|socklen_t
operator|)
name|addrs
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOENT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ret
operator|=
name|sctp_send
argument_list|(
name|sd
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|,
name|sinfo
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|saved_errno
operator|=
name|errno
expr_stmt|;
if|if
condition|(
name|no_end_cx
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_CONNECT_X_COMPLETE
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addrs
argument_list|,
operator|(
name|socklen_t
operator|)
name|addrs
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|errno
operator|=
name|saved_errno
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|sctp_sendmsgx
parameter_list|(
name|int
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|msg
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addrs
parameter_list|,
name|int
name|addrcnt
parameter_list|,
name|u_int32_t
name|ppid
parameter_list|,
name|u_int32_t
name|flags
parameter_list|,
name|u_int16_t
name|stream_no
parameter_list|,
name|u_int32_t
name|timetolive
parameter_list|,
name|u_int32_t
name|context
parameter_list|)
block|{
name|struct
name|sctp_sndrcvinfo
name|sinfo
decl_stmt|;
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|sinfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_sndrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
name|sinfo
operator|.
name|sinfo_ppid
operator|=
name|ppid
expr_stmt|;
name|sinfo
operator|.
name|sinfo_flags
operator|=
name|flags
expr_stmt|;
name|sinfo
operator|.
name|sinfo_ssn
operator|=
name|stream_no
expr_stmt|;
name|sinfo
operator|.
name|sinfo_timetolive
operator|=
name|timetolive
expr_stmt|;
name|sinfo
operator|.
name|sinfo_context
operator|=
name|context
expr_stmt|;
return|return
name|sctp_sendx
argument_list|(
name|sd
argument_list|,
name|msg
argument_list|,
name|len
argument_list|,
name|addrs
argument_list|,
name|addrcnt
argument_list|,
operator|&
name|sinfo
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|sctp_recvmsg
parameter_list|(
name|int
name|s
parameter_list|,
name|void
modifier|*
name|dbuf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|,
name|socklen_t
modifier|*
name|fromlen
parameter_list|,
name|struct
name|sctp_sndrcvinfo
modifier|*
name|sinfo
parameter_list|,
name|int
modifier|*
name|msg_flags
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|SYS_sctp_generic_recvmsg
name|struct
name|iovec
name|iov
index|[
name|SCTP_SMALL_IOVEC_SIZE
index|]
decl_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|dbuf
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
return|return
operator|(
name|syscall
argument_list|(
name|SYS_sctp_generic_recvmsg
argument_list|,
name|s
argument_list|,
name|iov
argument_list|,
literal|1
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|,
name|sinfo
argument_list|,
name|msg_flags
argument_list|)
operator|)
return|;
else|#
directive|else
name|struct
name|sctp_sndrcvinfo
modifier|*
name|s_info
decl_stmt|;
name|ssize_t
name|sz
decl_stmt|;
name|int
name|sinfo_found
init|=
literal|0
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|iov
index|[
name|SCTP_SMALL_IOVEC_SIZE
index|]
decl_stmt|;
name|char
name|controlVector
index|[
name|SCTP_CONTROL_VEC_SIZE_RCV
index|]
decl_stmt|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
if|if
condition|(
name|msg_flags
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|msg
operator|.
name|msg_flags
operator|=
literal|0
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|dbuf
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
name|NULL
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|(
name|caddr_t
operator|)
name|from
expr_stmt|;
if|if
condition|(
name|fromlen
operator|==
name|NULL
condition|)
name|msg
operator|.
name|msg_namelen
operator|=
literal|0
expr_stmt|;
else|else
name|msg
operator|.
name|msg_namelen
operator|=
operator|*
name|fromlen
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
operator|(
name|caddr_t
operator|)
name|controlVector
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
sizeof|sizeof
argument_list|(
name|controlVector
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|sz
operator|=
name|recvmsg
argument_list|(
name|s
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sz
operator|<=
literal|0
condition|)
return|return
operator|(
name|sz
operator|)
return|;
name|s_info
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
name|sz
expr_stmt|;
operator|*
name|msg_flags
operator|=
name|msg
operator|.
name|msg_flags
expr_stmt|;
if|if
condition|(
name|sinfo
condition|)
name|sinfo
operator|->
name|sinfo_assoc_id
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|msg
operator|.
name|msg_controllen
operator|)
operator|&&
name|sinfo
condition|)
block|{
comment|/* 		 * parse through and see if we find the sctp_sndrcvinfo (if 		 * the user wants it). 		 */
name|cmsg
operator|=
operator|(
expr|struct
name|cmsghdr
operator|*
operator|)
name|controlVector
expr_stmt|;
while|while
condition|(
name|cmsg
condition|)
block|{
if|if
condition|(
operator|(
name|cmsg
operator|->
name|cmsg_len
operator|==
literal|0
operator|)
operator|||
operator|(
name|cmsg
operator|->
name|cmsg_len
operator|>
name|msg
operator|.
name|msg_controllen
operator|)
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|cmsg
operator|->
name|cmsg_level
operator|==
name|IPPROTO_SCTP
condition|)
block|{
if|if
condition|(
name|cmsg
operator|->
name|cmsg_type
operator|==
name|SCTP_SNDRCV
condition|)
block|{
comment|/* Got it */
name|s_info
operator|=
operator|(
expr|struct
name|sctp_sndrcvinfo
operator|*
operator|)
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
expr_stmt|;
comment|/* Copy it to the user */
if|if
condition|(
name|sinfo
condition|)
operator|*
name|sinfo
operator|=
operator|*
name|s_info
expr_stmt|;
name|sinfo_found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|cmsg
operator|->
name|cmsg_type
operator|==
name|SCTP_EXTRCV
condition|)
block|{
comment|/* 					 * Got it, presumably the user has 					 * asked for this extra info, so the 					 * structure holds more room :-D 					 */
name|s_info
operator|=
operator|(
expr|struct
name|sctp_sndrcvinfo
operator|*
operator|)
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
expr_stmt|;
comment|/* Copy it to the user */
if|if
condition|(
name|sinfo
condition|)
block|{
name|memcpy
argument_list|(
name|sinfo
argument_list|,
name|s_info
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sctp_extrcvinfo
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|sinfo_found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|cmsg
operator|=
name|CMSG_NXTHDR
argument_list|(
operator|&
name|msg
argument_list|,
name|cmsg
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|sz
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SCTP_PEELOFF_SOCKOPT
argument_list|)
end_if

begin_include
include|#
directive|include
file|<netinet/sctp_peeloff.h>
end_include

begin_function
name|int
name|sctp_peeloff
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|assoc_id
parameter_list|)
block|{
name|struct
name|sctp_peeloff_opt
name|peeloff
decl_stmt|;
name|int
name|error
decl_stmt|;
name|socklen_t
name|optlen
decl_stmt|;
comment|/* set in the socket option params */
name|memset
argument_list|(
operator|&
name|peeloff
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|peeloff
argument_list|)
argument_list|)
expr_stmt|;
name|peeloff
operator|.
name|s
operator|=
name|sd
expr_stmt|;
name|peeloff
operator|.
name|assoc_id
operator|=
name|assoc_id
expr_stmt|;
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|peeloff
argument_list|)
expr_stmt|;
name|error
operator|=
name|getsockopt
argument_list|(
name|sd
argument_list|,
name|IPPROTO_SCTP
argument_list|,
name|SCTP_PEELOFF
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|peeloff
argument_list|,
operator|&
name|optlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|errno
operator|=
name|error
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|peeloff
operator|.
name|new_sd
operator|)
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|SYS_sctp_peeloff
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|HAVE_SCTP_PEELOFF_SOCKOPT
argument_list|)
end_if

begin_function
name|int
name|sctp_peeloff
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|assoc_id
parameter_list|)
block|{
comment|/* NOT supported, return invalid sd */
name|errno
operator|=
name|ENOTSUP
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|SYS_sctp_peeloff
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|HAVE_SCTP_PEELOFF_SOCKOPT
argument_list|)
end_if

begin_function
name|int
name|sctp_peeloff
parameter_list|(
name|int
name|sd
parameter_list|,
name|sctp_assoc_t
name|assoc_id
parameter_list|)
block|{
return|return
operator|(
name|syscall
argument_list|(
name|SYS_sctp_peeloff
argument_list|,
name|sd
argument_list|,
name|assoc_id
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|SCTP_CONTROL_VEC_SIZE_SND
end_undef

begin_undef
undef|#
directive|undef
name|SCTP_CONTROL_VEC_SIZE_RCV
end_undef

begin_undef
undef|#
directive|undef
name|SCTP_STACK_BUF_SIZE
end_undef

begin_undef
undef|#
directive|undef
name|SCTP_SMALL_IOVEC_SIZE
end_undef

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1995, 1996, 1997, 1998, and 1999 WIDE Project.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/* $Id: name6.c,v 1.9 1999/10/29 03:04:26 itojun Exp $ */
end_comment

begin_comment
comment|/*  *	Atsushi Onoe<onoe@sm.sony.co.jp>  */
end_comment

begin_comment
comment|/*  * TODO for thread safe  *	use mutex for _hostconf, _hostconf_init.  *	rewrite resolvers to be thread safe  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<arpa/nameser.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<resolv.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|_PATH_HOSTS
end_ifndef

begin_define
define|#
directive|define
name|_PATH_HOSTS
value|"/etc/hosts"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|MAXALIASES
end_ifndef

begin_define
define|#
directive|define
name|MAXALIASES
value|10
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|MAXADDRS
end_ifndef

begin_define
define|#
directive|define
name|MAXADDRS
value|20
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|MAXDNAME
end_ifndef

begin_define
define|#
directive|define
name|MAXDNAME
value|1025
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_define
define|#
directive|define
name|ADDRLEN
parameter_list|(
name|af
parameter_list|)
value|((af) == AF_INET6 ? sizeof(struct in6_addr) : \ 					    sizeof(struct in_addr))
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|ADDRLEN
parameter_list|(
name|af
parameter_list|)
value|sizeof(struct in_addr)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAPADDR
parameter_list|(
name|ab
parameter_list|,
name|ina
parameter_list|)
define|\
value|do {									\ 	memcpy(&(ab)->map_inaddr, ina, sizeof(struct in_addr));		\ 	memset((ab)->map_zero, 0, sizeof((ab)->map_zero));		\ 	memset((ab)->map_one, 0xff, sizeof((ab)->map_one));		\ } while (0)
end_define

begin_define
define|#
directive|define
name|MAPADDRENABLED
parameter_list|(
name|flags
parameter_list|)
define|\
value|(((flags)& AI_V4MAPPED) || \ 	 (((flags)& AI_V4MAPPED_CFG)&& _mapped_addr_enabled()))
end_define

begin_union
union|union
name|inx_addr
block|{
name|struct
name|in_addr
name|in_addr
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|struct
name|in6_addr
name|in6_addr
decl_stmt|;
endif|#
directive|endif
struct|struct
block|{
name|u_char
name|mau_zero
index|[
literal|10
index|]
decl_stmt|;
name|u_char
name|mau_one
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|in_addr
name|mau_inaddr
decl_stmt|;
block|}
name|map_addr_un
struct|;
define|#
directive|define
name|map_zero
value|map_addr_un.mau_zero
define|#
directive|define
name|map_one
value|map_addr_un.mau_one
define|#
directive|define
name|map_inaddr
value|map_addr_un.mau_inaddr
block|}
union|;
end_union

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_hpcopy
parameter_list|(
name|struct
name|hostent
modifier|*
name|hp
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_hpaddr
parameter_list|(
name|int
name|af
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_hpmerge
parameter_list|(
name|struct
name|hostent
modifier|*
name|hp1
parameter_list|,
name|struct
name|hostent
modifier|*
name|hp2
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_hpmapv6
parameter_list|(
name|struct
name|hostent
modifier|*
name|hp
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_hpsort
parameter_list|(
name|struct
name|hostent
modifier|*
name|hp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_ghbyname
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|af
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|_hgetword
parameter_list|(
name|char
modifier|*
modifier|*
name|pp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|_mapped_addr_enabled
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|FILE
modifier|*
name|_files_open
parameter_list|(
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_files_ghbyname
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_files_ghbyaddr
parameter_list|(
specifier|const
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|addrlen
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|_files_shent
parameter_list|(
name|int
name|stayopen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|_files_ehent
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_dns_ghbyname
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_dns_ghbyaddr
parameter_list|(
specifier|const
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|addrlen
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|_dns_shent
parameter_list|(
name|int
name|stayopen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|_dns_ehent
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|ICMPNL
end_ifdef

begin_function_decl
specifier|static
name|struct
name|hostent
modifier|*
name|_icmp_ghbyaddr
parameter_list|(
specifier|const
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|addrlen
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ICMPNL */
end_comment

begin_comment
comment|/*  * Select order host function.  */
end_comment

begin_define
define|#
directive|define
name|MAXHOSTCONF
value|4
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|HOSTCONF
end_ifndef

begin_define
define|#
directive|define
name|HOSTCONF
value|"/etc/host.conf"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !HOSTCONF */
end_comment

begin_struct
struct|struct
name|_hostconf
block|{
name|struct
name|hostent
modifier|*
function_decl|(
modifier|*
name|byname
function_decl|)
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
name|struct
name|hostent
modifier|*
function_decl|(
modifier|*
name|byaddr
function_decl|)
parameter_list|(
specifier|const
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|addrlen
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_comment
comment|/* default order */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|_hostconf
name|_hostconf
index|[
name|MAXHOSTCONF
index|]
init|=
block|{
block|{
name|_dns_ghbyname
block|,
name|_dns_ghbyaddr
block|}
block|,
block|{
name|_files_ghbyname
block|,
name|_files_ghbyaddr
block|}
block|,
ifdef|#
directive|ifdef
name|ICMPNL
block|{
name|NULL
block|,
name|_icmp_ghbyaddr
block|}
block|,
endif|#
directive|endif
comment|/* ICMPNL */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|_hostconf_init_done
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|_hostconf_init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Initialize hostconf structure.  */
end_comment

begin_function
specifier|static
name|void
name|_hostconf_init
parameter_list|(
name|void
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|n
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|line
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|_hostconf_init_done
operator|=
literal|1
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|HOSTCONF
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|p
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
while|while
condition|(
name|n
operator|<
name|MAXHOSTCONF
operator|&&
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|)
block|{
name|line
operator|=
name|buf
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|_hgetword
argument_list|(
operator|&
name|line
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
do|do
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"hosts"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"local"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"file"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"files"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|_hostconf
index|[
name|n
index|]
operator|.
name|byname
operator|=
name|_files_ghbyname
expr_stmt|;
name|_hostconf
index|[
name|n
index|]
operator|.
name|byaddr
operator|=
name|_files_ghbyaddr
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"dns"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"bind"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|_hostconf
index|[
name|n
index|]
operator|.
name|byname
operator|=
name|_dns_ghbyname
expr_stmt|;
name|_hostconf
index|[
name|n
index|]
operator|.
name|byaddr
operator|=
name|_dns_ghbyaddr
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|ICMPNL
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"icmp"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|_hostconf
index|[
name|n
index|]
operator|.
name|byname
operator|=
name|NULL
expr_stmt|;
name|_hostconf
index|[
name|n
index|]
operator|.
name|byaddr
operator|=
name|_icmp_ghbyaddr
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* ICMPNL */
block|}
do|while
condition|(
operator|(
name|p
operator|=
name|_hgetword
argument_list|(
operator|&
name|line
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
do|;
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
block|{
comment|/* no keyword found. do not change default configuration */
return|return;
block|}
for|for
control|(
init|;
name|n
operator|<
name|MAXHOSTCONF
condition|;
name|n
operator|++
control|)
block|{
name|_hostconf
index|[
name|n
index|]
operator|.
name|byname
operator|=
name|NULL
expr_stmt|;
name|_hostconf
index|[
name|n
index|]
operator|.
name|byaddr
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Check if kernel supports mapped address.  *	implementation dependent  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__KAME__
end_ifdef

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __KAME__ */
end_comment

begin_function
specifier|static
name|int
name|_mapped_addr_enabled
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* implementation dependent check */
if|#
directive|if
name|defined
argument_list|(
name|__KAME__
argument_list|)
operator|&&
name|defined
argument_list|(
name|IPV6CTL_MAPPED_ADDR
argument_list|)
name|int
name|mib
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|val
decl_stmt|;
name|mib
index|[
literal|0
index|]
operator|=
name|CTL_NET
expr_stmt|;
name|mib
index|[
literal|1
index|]
operator|=
name|PF_INET6
expr_stmt|;
name|mib
index|[
literal|2
index|]
operator|=
name|IPPROTO_IPV6
expr_stmt|;
name|mib
index|[
literal|3
index|]
operator|=
name|IPV6CTL_MAPPED_ADDR
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
literal|4
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
operator|&&
name|val
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
endif|#
directive|endif
comment|/* __KAME__&& IPV6CTL_MAPPED_ADDR */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Functions defined in RFC2553  *	getipnodebyname, getipnodebyadr, freehostent  */
end_comment

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_ghbyname
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|af
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|AI_ADDRCONFIG
condition|)
block|{
name|int
name|s
decl_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|socket
argument_list|(
name|af
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
comment|/* 		 * TODO: 		 * Note that implementation dependent test for address 		 * configuration should be done everytime called 		 * (or apropriate interval), 		 * because addresses will be dynamically assigned or deleted. 		 */
name|_libc_close
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXHOSTCONF
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|_hostconf
index|[
name|i
index|]
operator|.
name|byname
operator|&&
operator|(
name|hp
operator|=
operator|(
operator|*
name|_hostconf
index|[
name|i
index|]
operator|.
name|byname
operator|)
operator|(
name|name
operator|,
name|af
operator|,
name|errp
operator|)
operator|)
operator|!=
name|NULL
condition|)
return|return
name|hp
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|hostent
modifier|*
name|getipnodebyname
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|af
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|union
name|inx_addr
name|addrbuf
decl_stmt|;
if|if
condition|(
name|af
operator|!=
name|AF_INET
ifdef|#
directive|ifdef
name|INET6
operator|&&
name|af
operator|!=
name|AF_INET6
endif|#
directive|endif
condition|)
block|{
operator|*
name|errp
operator|=
name|NO_RECOVERY
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifdef|#
directive|ifdef
name|INET6
comment|/* special case for literal address */
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|name
argument_list|,
operator|&
name|addrbuf
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|af
operator|!=
name|AF_INET6
condition|)
block|{
operator|*
name|errp
operator|=
name|HOST_NOT_FOUND
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|_hpaddr
argument_list|(
name|af
argument_list|,
name|name
argument_list|,
operator|&
name|addrbuf
argument_list|,
name|errp
argument_list|)
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET
argument_list|,
name|name
argument_list|,
operator|&
name|addrbuf
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|af
operator|!=
name|AF_INET
condition|)
block|{
if|if
condition|(
name|MAPADDRENABLED
argument_list|(
name|flags
argument_list|)
condition|)
block|{
name|MAPADDR
argument_list|(
operator|&
name|addrbuf
argument_list|,
operator|&
name|addrbuf
operator|.
name|in_addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|errp
operator|=
name|HOST_NOT_FOUND
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
return|return
name|_hpaddr
argument_list|(
name|af
argument_list|,
name|name
argument_list|,
operator|&
name|addrbuf
argument_list|,
name|errp
argument_list|)
return|;
block|}
if|if
condition|(
operator|!
name|_hostconf_init_done
condition|)
name|_hostconf_init
argument_list|()
expr_stmt|;
operator|*
name|errp
operator|=
name|HOST_NOT_FOUND
expr_stmt|;
name|hp
operator|=
name|_ghbyname
argument_list|(
name|name
argument_list|,
name|af
argument_list|,
name|flags
argument_list|,
name|errp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
if|if
condition|(
name|af
operator|==
name|AF_INET6
operator|&&
operator|(
operator|(
name|flags
operator|&
name|AI_ALL
operator|)
operator|||
name|hp
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|MAPADDRENABLED
argument_list|(
name|flags
argument_list|)
operator|)
condition|)
block|{
name|struct
name|hostent
modifier|*
name|hp2
init|=
name|_ghbyname
argument_list|(
name|name
argument_list|,
name|AF_INET
argument_list|,
name|flags
argument_list|,
name|errp
argument_list|)
decl_stmt|;
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
name|hp
operator|=
name|_hpmapv6
argument_list|(
name|hp2
argument_list|,
name|errp
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|hp2
operator|&&
name|strcmp
argument_list|(
name|hp
operator|->
name|h_name
argument_list|,
name|hp2
operator|->
name|h_name
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|freehostent
argument_list|(
name|hp2
argument_list|)
expr_stmt|;
name|hp2
operator|=
name|NULL
expr_stmt|;
block|}
name|hp
operator|=
name|_hpmerge
argument_list|(
name|hp
argument_list|,
name|hp2
argument_list|,
name|errp
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
return|return
name|_hpsort
argument_list|(
name|hp
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|hostent
modifier|*
name|getipnodebyaddr
parameter_list|(
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|struct
name|in6_addr
name|addrbuf
decl_stmt|;
else|#
directive|else
name|struct
name|in_addr
name|addrbuf
decl_stmt|;
endif|#
directive|endif
operator|*
name|errp
operator|=
name|HOST_NOT_FOUND
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
condition|)
block|{
operator|*
name|errp
operator|=
name|NO_RECOVERY
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|(
name|long
operator|)
name|src
operator|&
operator|~
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
operator|-
literal|1
operator|)
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|addrbuf
argument_list|,
name|src
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|src
operator|=
operator|&
name|addrbuf
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
expr|struct
name|in_addr
operator|*
operator|)
name|src
operator|)
operator|->
name|s_addr
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
condition|)
block|{
operator|*
name|errp
operator|=
name|NO_RECOVERY
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|(
name|long
operator|)
name|src
operator|&
operator|~
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|/
literal|2
operator|-
literal|1
operator|)
condition|)
block|{
comment|/*XXX*/
name|memcpy
argument_list|(
operator|&
name|addrbuf
argument_list|,
name|src
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|src
operator|=
operator|&
name|addrbuf
expr_stmt|;
block|}
if|if
condition|(
name|IN6_IS_ADDR_V4MAPPED
argument_list|(
operator|(
expr|struct
name|in6_addr
operator|*
operator|)
name|src
argument_list|)
operator|||
name|IN6_IS_ADDR_V4COMPAT
argument_list|(
operator|(
expr|struct
name|in6_addr
operator|*
operator|)
name|src
argument_list|)
condition|)
block|{
name|src
operator|=
operator|(
name|char
operator|*
operator|)
name|src
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
operator|)
expr_stmt|;
name|af
operator|=
name|AF_INET
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
default|default:
operator|*
name|errp
operator|=
name|NO_RECOVERY
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|_hostconf_init_done
condition|)
name|_hostconf_init
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXHOSTCONF
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|_hostconf
index|[
name|i
index|]
operator|.
name|byaddr
operator|&&
operator|(
name|hp
operator|=
operator|(
operator|*
name|_hostconf
index|[
name|i
index|]
operator|.
name|byaddr
operator|)
operator|(
name|src
operator|,
name|len
operator|,
name|af
operator|,
name|errp
operator|)
operator|)
operator|!=
name|NULL
condition|)
return|return
name|hp
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|freehostent
parameter_list|(
name|struct
name|hostent
modifier|*
name|ptr
parameter_list|)
block|{
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* XXX: should be deprecated */
end_comment

begin_ifdef
unit|struct hostent * getnodebyname(const char *name, int af, int flags) { 	return getipnodebyname(name, af, flags,&h_errno); }
ifdef|#
directive|ifdef
name|__warn_references
end_ifdef

begin_endif
unit|__warn_references(getnodebyname, 	"warning: getnodebyname() deprecated, " 	"should use getaddrinfo() or getipnodebyname()");
endif|#
directive|endif
end_endif

begin_ifdef
unit|struct hostent * getnodebyaddr(const void *src, size_t len, int af) { 	return getipnodebyaddr(src, len, af,&h_errno); }
ifdef|#
directive|ifdef
name|__warn_references
end_ifdef

begin_endif
unit|__warn_references(getnodebyaddr, 	"warning: getnodebyaddr() deprecated, " 	"should use getnameinfo() or getipnodebyaddr()");
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Private utility functions  */
end_comment

begin_comment
comment|/*  * _hpcopy: allocate and copy hostent structure  */
end_comment

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_hpcopy
parameter_list|(
name|struct
name|hostent
modifier|*
name|hp
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|nhp
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
name|int
name|size
decl_stmt|,
name|addrsize
decl_stmt|;
name|int
name|nalias
init|=
literal|0
decl_stmt|,
name|naddr
init|=
literal|0
decl_stmt|;
name|int
name|al_off
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
return|return
name|hp
return|;
comment|/* count size to be allocated */
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|hostent
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|->
name|h_name
operator|!=
name|NULL
operator|&&
operator|*
name|hp
operator|->
name|h_name
operator|!=
literal|'\0'
condition|)
name|size
operator|+=
name|strlen
argument_list|(
name|hp
operator|->
name|h_name
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|pp
operator|=
name|hp
operator|->
name|h_aliases
operator|)
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|*
name|pp
operator|!=
name|NULL
condition|;
name|i
operator|++
operator|,
name|pp
operator|++
control|)
block|{
if|if
condition|(
operator|*
operator|*
name|pp
operator|!=
literal|'\0'
condition|)
block|{
name|size
operator|+=
name|strlen
argument_list|(
operator|*
name|pp
argument_list|)
operator|+
literal|1
expr_stmt|;
name|nalias
operator|++
expr_stmt|;
block|}
block|}
block|}
comment|/* adjust alignment */
name|size
operator|=
name|ALIGN
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|al_off
operator|=
name|size
expr_stmt|;
name|size
operator|+=
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|nalias
operator|+
literal|1
operator|)
expr_stmt|;
name|addrsize
operator|=
name|ALIGN
argument_list|(
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pp
operator|=
name|hp
operator|->
name|h_addr_list
operator|)
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
operator|*
name|pp
operator|++
operator|!=
name|NULL
condition|)
name|naddr
operator|++
expr_stmt|;
block|}
name|size
operator|+=
name|addrsize
operator|*
name|naddr
expr_stmt|;
name|size
operator|+=
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|naddr
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* copy */
if|if
condition|(
operator|(
name|nhp
operator|=
operator|(
expr|struct
name|hostent
operator|*
operator|)
name|malloc
argument_list|(
name|size
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|*
name|errp
operator|=
name|TRY_AGAIN
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|nhp
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|hp
operator|->
name|h_name
operator|!=
name|NULL
operator|&&
operator|*
name|hp
operator|->
name|h_name
operator|!=
literal|'\0'
condition|)
block|{
name|nhp
operator|->
name|h_name
operator|=
name|cp
expr_stmt|;
name|strcpy
argument_list|(
name|cp
argument_list|,
name|hp
operator|->
name|h_name
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
else|else
name|nhp
operator|->
name|h_name
operator|=
name|NULL
expr_stmt|;
name|nhp
operator|->
name|h_aliases
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|nhp
operator|+
name|al_off
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|pp
operator|=
name|hp
operator|->
name|h_aliases
operator|)
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|*
name|pp
operator|!=
name|NULL
condition|;
name|pp
operator|++
control|)
block|{
if|if
condition|(
operator|*
operator|*
name|pp
operator|!=
literal|'\0'
condition|)
block|{
name|nhp
operator|->
name|h_aliases
index|[
name|i
operator|++
index|]
operator|=
name|cp
expr_stmt|;
name|strcpy
argument_list|(
name|cp
argument_list|,
operator|*
name|pp
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
block|}
block|}
name|nhp
operator|->
name|h_aliases
index|[
name|nalias
index|]
operator|=
name|NULL
expr_stmt|;
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|nhp
operator|->
name|h_aliases
index|[
name|nalias
operator|+
literal|1
index|]
expr_stmt|;
name|nhp
operator|->
name|h_addrtype
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|nhp
operator|->
name|h_length
operator|=
name|hp
operator|->
name|h_length
expr_stmt|;
name|nhp
operator|->
name|h_addr_list
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|cp
expr_stmt|;
if|if
condition|(
operator|(
name|pp
operator|=
name|hp
operator|->
name|h_addr_list
operator|)
operator|!=
name|NULL
condition|)
block|{
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|nhp
operator|->
name|h_addr_list
index|[
name|naddr
operator|+
literal|1
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|*
name|pp
operator|!=
name|NULL
condition|;
name|pp
operator|++
control|)
block|{
name|nhp
operator|->
name|h_addr_list
index|[
name|i
operator|++
index|]
operator|=
name|cp
expr_stmt|;
name|memcpy
argument_list|(
name|cp
argument_list|,
operator|*
name|pp
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|addrsize
expr_stmt|;
block|}
block|}
name|nhp
operator|->
name|h_addr_list
index|[
name|naddr
index|]
operator|=
name|NULL
expr_stmt|;
return|return
name|nhp
return|;
block|}
end_function

begin_comment
comment|/*  * _hpaddr: construct hostent structure with one address  */
end_comment

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_hpaddr
parameter_list|(
name|int
name|af
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|,
name|hpbuf
decl_stmt|;
name|char
modifier|*
name|addrs
index|[
literal|2
index|]
decl_stmt|;
name|hp
operator|=
operator|&
name|hpbuf
expr_stmt|;
name|hp
operator|->
name|h_name
operator|=
operator|(
name|char
operator|*
operator|)
name|name
expr_stmt|;
name|hp
operator|->
name|h_aliases
operator|=
name|NULL
expr_stmt|;
name|hp
operator|->
name|h_addrtype
operator|=
name|af
expr_stmt|;
name|hp
operator|->
name|h_length
operator|=
name|ADDRLEN
argument_list|(
name|af
argument_list|)
expr_stmt|;
name|hp
operator|->
name|h_addr_list
operator|=
name|addrs
expr_stmt|;
name|addrs
index|[
literal|0
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|addr
expr_stmt|;
name|addrs
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
return|return
name|_hpcopy
argument_list|(
name|hp
argument_list|,
name|errp
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * _hpmerge: merge 2 hostent structure, arguments will be freed  */
end_comment

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_hpmerge
parameter_list|(
name|struct
name|hostent
modifier|*
name|hp1
parameter_list|,
name|struct
name|hostent
modifier|*
name|hp2
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|naddr
decl_stmt|,
name|nalias
decl_stmt|;
name|char
modifier|*
modifier|*
name|pp
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|,
name|hpbuf
decl_stmt|;
name|char
modifier|*
name|aliases
index|[
name|MAXALIASES
operator|+
literal|1
index|]
decl_stmt|,
modifier|*
name|addrs
index|[
name|MAXADDRS
operator|+
literal|1
index|]
decl_stmt|;
name|union
name|inx_addr
name|addrbuf
index|[
name|MAXADDRS
index|]
decl_stmt|;
if|if
condition|(
name|hp1
operator|==
name|NULL
condition|)
return|return
name|hp2
return|;
if|if
condition|(
name|hp2
operator|==
name|NULL
condition|)
return|return
name|hp1
return|;
define|#
directive|define
name|HP
parameter_list|(
name|i
parameter_list|)
value|(i == 1 ? hp1 : hp2)
name|hp
operator|=
operator|&
name|hpbuf
expr_stmt|;
name|hp
operator|->
name|h_name
operator|=
operator|(
name|hp1
operator|->
name|h_name
operator|!=
name|NULL
condition|?
name|hp1
operator|->
name|h_name
else|:
name|hp2
operator|->
name|h_name
operator|)
expr_stmt|;
name|hp
operator|->
name|h_aliases
operator|=
name|aliases
expr_stmt|;
name|nalias
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|pp
operator|=
name|HP
argument_list|(
name|i
argument_list|)
operator|->
name|h_aliases
operator|)
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
init|;
name|nalias
operator|<
name|MAXALIASES
operator|&&
operator|*
name|pp
operator|!=
name|NULL
condition|;
name|pp
operator|++
control|)
block|{
comment|/* check duplicates */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nalias
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|strcasecmp
argument_list|(
operator|*
name|pp
argument_list|,
name|aliases
index|[
name|j
index|]
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|j
operator|==
name|nalias
condition|)
name|aliases
index|[
name|nalias
operator|++
index|]
operator|=
operator|*
name|pp
expr_stmt|;
block|}
block|}
name|aliases
index|[
name|nalias
index|]
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
if|if
condition|(
name|hp1
operator|->
name|h_length
operator|!=
name|hp2
operator|->
name|h_length
condition|)
block|{
name|hp
operator|->
name|h_addrtype
operator|=
name|AF_INET6
expr_stmt|;
name|hp
operator|->
name|h_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
name|hp
operator|->
name|h_addrtype
operator|=
name|hp1
operator|->
name|h_addrtype
expr_stmt|;
name|hp
operator|->
name|h_length
operator|=
name|hp1
operator|->
name|h_length
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
block|}
endif|#
directive|endif
name|hp
operator|->
name|h_addr_list
operator|=
name|addrs
expr_stmt|;
name|naddr
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|pp
operator|=
name|HP
argument_list|(
name|i
argument_list|)
operator|->
name|h_addr_list
operator|)
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|HP
argument_list|(
name|i
argument_list|)
operator|->
name|h_length
operator|==
name|hp
operator|->
name|h_length
condition|)
block|{
while|while
condition|(
name|naddr
operator|<
name|MAXADDRS
operator|&&
operator|*
name|pp
operator|!=
name|NULL
condition|)
name|addrs
index|[
name|naddr
operator|++
index|]
operator|=
operator|*
name|pp
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/* copy IPv4 addr as mapped IPv6 addr */
while|while
condition|(
name|naddr
operator|<
name|MAXADDRS
operator|&&
operator|*
name|pp
operator|!=
name|NULL
condition|)
block|{
name|MAPADDR
argument_list|(
operator|&
name|addrbuf
index|[
name|naddr
index|]
argument_list|,
operator|*
name|pp
operator|++
argument_list|)
expr_stmt|;
name|addrs
index|[
name|naddr
index|]
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|addrbuf
index|[
name|naddr
index|]
expr_stmt|;
name|naddr
operator|++
expr_stmt|;
block|}
block|}
block|}
name|addrs
index|[
name|naddr
index|]
operator|=
name|NULL
expr_stmt|;
name|hp
operator|=
name|_hpcopy
argument_list|(
name|hp
argument_list|,
name|errp
argument_list|)
expr_stmt|;
name|freehostent
argument_list|(
name|hp1
argument_list|)
expr_stmt|;
name|freehostent
argument_list|(
name|hp2
argument_list|)
expr_stmt|;
return|return
name|hp
return|;
block|}
end_function

begin_comment
comment|/*  * _hpmapv6: convert IPv4 hostent into IPv4-mapped IPv6 addresses  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_hpmapv6
parameter_list|(
name|struct
name|hostent
modifier|*
name|hp
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|hp6
decl_stmt|;
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|hp
operator|->
name|h_addrtype
operator|==
name|AF_INET6
condition|)
return|return
name|hp
return|;
comment|/* make dummy hostent to convert IPv6 address */
if|if
condition|(
operator|(
name|hp6
operator|=
operator|(
expr|struct
name|hostent
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostent
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|*
name|errp
operator|=
name|TRY_AGAIN
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|hp6
operator|->
name|h_name
operator|=
name|NULL
expr_stmt|;
name|hp6
operator|->
name|h_aliases
operator|=
name|NULL
expr_stmt|;
name|hp6
operator|->
name|h_addrtype
operator|=
name|AF_INET6
expr_stmt|;
name|hp6
operator|->
name|h_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
name|hp6
operator|->
name|h_addr_list
operator|=
name|NULL
expr_stmt|;
return|return
name|_hpmerge
argument_list|(
name|hp6
argument_list|,
name|hp
argument_list|,
name|errp
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * _hpsort: sort address by sortlist  */
end_comment

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_hpsort
parameter_list|(
name|struct
name|hostent
modifier|*
name|hp
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|n
decl_stmt|;
name|u_char
modifier|*
name|ap
decl_stmt|,
modifier|*
name|sp
decl_stmt|,
modifier|*
name|mp
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
name|char
name|t
decl_stmt|;
name|char
name|order
index|[
name|MAXADDRS
index|]
decl_stmt|;
name|int
name|nsort
init|=
name|_res
operator|.
name|nsort
decl_stmt|;
if|if
condition|(
name|hp
operator|==
name|NULL
operator|||
name|hp
operator|->
name|h_addr_list
index|[
literal|1
index|]
operator|==
name|NULL
operator|||
name|nsort
operator|==
literal|0
condition|)
return|return
name|hp
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|ap
operator|=
operator|(
name|u_char
operator|*
operator|)
name|hp
operator|->
name|h_addr_list
index|[
name|i
index|]
operator|)
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nsort
condition|;
name|j
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|INET6
if|if
condition|(
name|_res_ext
operator|.
name|sort_list
index|[
name|j
index|]
operator|.
name|af
operator|!=
name|hp
operator|->
name|h_addrtype
condition|)
continue|continue;
name|sp
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|&
name|_res_ext
operator|.
name|sort_list
index|[
name|j
index|]
operator|.
name|addr
expr_stmt|;
name|mp
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|&
name|_res_ext
operator|.
name|sort_list
index|[
name|j
index|]
operator|.
name|mask
expr_stmt|;
else|#
directive|else
name|sp
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|&
name|_res
operator|.
name|sort_list
index|[
name|j
index|]
operator|.
name|addr
expr_stmt|;
name|mp
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|&
name|_res
operator|.
name|sort_list
index|[
name|j
index|]
operator|.
name|mask
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|hp
operator|->
name|h_length
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ap
index|[
name|n
index|]
operator|&
name|mp
index|[
name|n
index|]
operator|)
operator|!=
name|sp
index|[
name|n
index|]
condition|)
break|break;
block|}
if|if
condition|(
name|n
operator|==
name|hp
operator|->
name|h_length
condition|)
break|break;
block|}
name|order
index|[
name|i
index|]
operator|=
name|j
expr_stmt|;
block|}
name|n
operator|=
name|i
expr_stmt|;
name|pp
operator|=
operator|(
name|u_char
operator|*
operator|*
operator|)
name|hp
operator|->
name|h_addr_list
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
name|i
operator|+
literal|1
init|;
name|j
operator|<
name|n
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|order
index|[
name|i
index|]
operator|>
name|order
index|[
name|j
index|]
condition|)
block|{
name|ap
operator|=
name|pp
index|[
name|i
index|]
expr_stmt|;
name|pp
index|[
name|i
index|]
operator|=
name|pp
index|[
name|j
index|]
expr_stmt|;
name|pp
index|[
name|j
index|]
operator|=
name|ap
expr_stmt|;
name|t
operator|=
name|order
index|[
name|i
index|]
expr_stmt|;
name|order
index|[
name|i
index|]
operator|=
name|order
index|[
name|j
index|]
expr_stmt|;
name|order
index|[
name|j
index|]
operator|=
name|t
expr_stmt|;
block|}
block|}
block|}
return|return
name|hp
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|_hgetword
parameter_list|(
name|char
modifier|*
modifier|*
name|pp
parameter_list|)
block|{
name|char
name|c
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|ret
decl_stmt|;
specifier|const
name|char
modifier|*
name|sp
decl_stmt|;
specifier|static
specifier|const
name|char
name|sep
index|[]
init|=
literal|"# \t\n"
decl_stmt|;
name|ret
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|p
operator|=
operator|*
name|pp
init|;
operator|(
name|c
operator|=
operator|*
name|p
operator|)
operator|!=
literal|'\0'
condition|;
name|p
operator|++
control|)
block|{
for|for
control|(
name|sp
operator|=
name|sep
init|;
operator|*
name|sp
operator|!=
literal|'\0'
condition|;
name|sp
operator|++
control|)
block|{
if|if
condition|(
name|c
operator|==
operator|*
name|sp
condition|)
break|break;
block|}
if|if
condition|(
name|c
operator|==
literal|'#'
condition|)
name|p
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* ignore rest of line */
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|*
name|sp
operator|==
literal|'\0'
condition|)
name|ret
operator|=
name|p
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|sp
operator|!=
literal|'\0'
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
block|}
block|}
operator|*
name|pp
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
operator|||
operator|*
name|ret
operator|==
literal|'\0'
condition|)
return|return
name|NULL
return|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * FILES (/etc/hosts)  */
end_comment

begin_function
specifier|static
name|FILE
modifier|*
name|_files_open
parameter_list|(
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
name|_PATH_HOSTS
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
operator|*
name|errp
operator|=
name|NO_RECOVERY
expr_stmt|;
return|return
name|fp
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_files_ghbyname
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|int
name|match
decl_stmt|,
name|nalias
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|line
decl_stmt|,
modifier|*
name|addrstr
decl_stmt|,
modifier|*
name|cname
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|struct
name|hostent
modifier|*
name|rethp
decl_stmt|,
modifier|*
name|hp
decl_stmt|,
name|hpbuf
decl_stmt|;
name|char
modifier|*
name|aliases
index|[
name|MAXALIASES
operator|+
literal|1
index|]
decl_stmt|,
modifier|*
name|addrs
index|[
literal|2
index|]
decl_stmt|;
name|union
name|inx_addr
name|addrbuf
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|_files_open
argument_list|(
name|errp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|rethp
operator|=
name|hp
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|)
block|{
name|line
operator|=
name|buf
expr_stmt|;
if|if
condition|(
operator|(
name|addrstr
operator|=
name|_hgetword
argument_list|(
operator|&
name|line
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|cname
operator|=
name|_hgetword
argument_list|(
operator|&
name|line
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
name|match
operator|=
operator|(
name|strcasecmp
argument_list|(
name|cname
argument_list|,
name|name
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|nalias
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|p
operator|=
name|_hgetword
argument_list|(
operator|&
name|line
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|match
condition|)
name|match
operator|=
operator|(
name|strcasecmp
argument_list|(
name|p
argument_list|,
name|name
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|nalias
operator|<
name|MAXALIASES
condition|)
name|aliases
index|[
name|nalias
operator|++
index|]
operator|=
name|p
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|match
condition|)
continue|continue;
if|if
condition|(
name|inet_pton
argument_list|(
name|af
argument_list|,
name|addrstr
argument_list|,
operator|&
name|addrbuf
argument_list|)
operator|!=
literal|1
condition|)
block|{
operator|*
name|errp
operator|=
name|NO_DATA
expr_stmt|;
comment|/* name found */
continue|continue;
block|}
name|hp
operator|=
operator|&
name|hpbuf
expr_stmt|;
name|hp
operator|->
name|h_name
operator|=
name|cname
expr_stmt|;
name|hp
operator|->
name|h_aliases
operator|=
name|aliases
expr_stmt|;
name|aliases
index|[
name|nalias
index|]
operator|=
name|NULL
expr_stmt|;
name|hp
operator|->
name|h_addrtype
operator|=
name|af
expr_stmt|;
name|hp
operator|->
name|h_length
operator|=
name|ADDRLEN
argument_list|(
name|af
argument_list|)
expr_stmt|;
name|hp
operator|->
name|h_addr_list
operator|=
name|addrs
expr_stmt|;
name|addrs
index|[
literal|0
index|]
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|addrbuf
expr_stmt|;
name|addrs
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|hp
operator|=
name|_hpcopy
argument_list|(
name|hp
argument_list|,
name|errp
argument_list|)
expr_stmt|;
name|rethp
operator|=
name|_hpmerge
argument_list|(
name|rethp
argument_list|,
name|hp
argument_list|,
name|errp
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|rethp
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_files_ghbyaddr
parameter_list|(
specifier|const
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|addrlen
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|int
name|nalias
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|line
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|,
name|hpbuf
decl_stmt|;
name|char
modifier|*
name|aliases
index|[
name|MAXALIASES
operator|+
literal|1
index|]
decl_stmt|,
modifier|*
name|addrs
index|[
literal|2
index|]
decl_stmt|;
name|union
name|inx_addr
name|addrbuf
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|_files_open
argument_list|(
name|errp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|hp
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|)
block|{
name|line
operator|=
name|buf
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|_hgetword
argument_list|(
operator|&
name|line
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|inet_pton
argument_list|(
name|af
argument_list|,
name|p
argument_list|,
operator|&
name|addrbuf
argument_list|)
operator|!=
literal|1
operator|||
name|memcmp
argument_list|(
name|addr
argument_list|,
operator|&
name|addrbuf
argument_list|,
name|addrlen
argument_list|)
operator|!=
literal|0
operator|||
operator|(
name|p
operator|=
name|_hgetword
argument_list|(
operator|&
name|line
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
name|hp
operator|=
operator|&
name|hpbuf
expr_stmt|;
name|hp
operator|->
name|h_name
operator|=
name|p
expr_stmt|;
name|hp
operator|->
name|h_aliases
operator|=
name|aliases
expr_stmt|;
name|nalias
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|p
operator|=
name|_hgetword
argument_list|(
operator|&
name|line
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|nalias
operator|<
name|MAXALIASES
condition|)
name|aliases
index|[
name|nalias
operator|++
index|]
operator|=
name|p
expr_stmt|;
block|}
name|aliases
index|[
name|nalias
index|]
operator|=
name|NULL
expr_stmt|;
name|hp
operator|->
name|h_addrtype
operator|=
name|af
expr_stmt|;
name|hp
operator|->
name|h_length
operator|=
name|addrlen
expr_stmt|;
name|hp
operator|->
name|h_addr_list
operator|=
name|addrs
expr_stmt|;
name|addrs
index|[
literal|0
index|]
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|addrbuf
expr_stmt|;
name|addrs
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|hp
operator|=
name|_hpcopy
argument_list|(
name|hp
argument_list|,
name|errp
argument_list|)
expr_stmt|;
break|break;
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|hp
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DNS_ASSERT
parameter_list|(
name|X
parameter_list|)
value|if (!(X)) { fprintf(stderr, "ASSFAIL: %s %d: %s\n", __FILE__, __LINE__, #X); goto badanswer; }
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DNS_ASSERT
parameter_list|(
name|X
parameter_list|)
value|if (!(X)) { goto badanswer; }
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_dns_ghbyname
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|u_char
name|answer
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
name|tbuf
index|[
name|MAXDNAME
operator|+
literal|1
index|]
decl_stmt|;
name|HEADER
modifier|*
name|hp
decl_stmt|;
name|u_char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|eom
decl_stmt|;
name|int
name|qtype
decl_stmt|;
name|int
name|type
decl_stmt|,
name|class
decl_stmt|,
name|ancount
decl_stmt|,
name|qdcount
decl_stmt|;
name|u_long
name|ttl
decl_stmt|;
name|char
name|hostbuf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
modifier|*
name|bp
decl_stmt|;
name|char
modifier|*
name|alist
index|[
name|MAXALIASES
index|]
decl_stmt|;
name|char
modifier|*
name|hlist
index|[
name|MAXADDRS
index|]
decl_stmt|;
name|struct
name|hostent
name|hbuf
decl_stmt|;
name|int
name|buflen
decl_stmt|;
name|int
name|na
decl_stmt|,
name|nh
decl_stmt|;
if|if
condition|(
operator|(
name|_res
operator|.
name|options
operator|&
name|RES_INIT
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|res_init
argument_list|()
operator|<
literal|0
condition|)
block|{
operator|*
name|errp
operator|=
name|h_errno
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|hbuf
operator|.
name|h_aliases
operator|=
name|alist
expr_stmt|;
name|hbuf
operator|.
name|h_addrtype
operator|=
name|af
expr_stmt|;
name|hbuf
operator|.
name|h_length
operator|=
name|ADDRLEN
argument_list|(
name|af
argument_list|)
expr_stmt|;
name|hbuf
operator|.
name|h_addr_list
operator|=
name|hlist
expr_stmt|;
name|na
operator|=
name|nh
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|qtype
operator|=
operator|(
name|af
operator|==
name|AF_INET6
condition|?
name|T_AAAA
else|:
name|T_A
operator|)
expr_stmt|;
else|#
directive|else
name|qtype
operator|=
name|T_A
expr_stmt|;
endif|#
directive|endif
name|n
operator|=
name|res_search
argument_list|(
name|name
argument_list|,
name|C_IN
argument_list|,
name|qtype
argument_list|,
name|answer
argument_list|,
sizeof|sizeof
argument_list|(
name|answer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
block|{
operator|*
name|errp
operator|=
name|h_errno
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|hp
operator|=
operator|(
name|HEADER
operator|*
operator|)
name|answer
expr_stmt|;
name|eom
operator|=
name|answer
operator|+
name|n
expr_stmt|;
name|ancount
operator|=
name|ntohs
argument_list|(
name|hp
operator|->
name|ancount
argument_list|)
expr_stmt|;
name|qdcount
operator|=
name|ntohs
argument_list|(
name|hp
operator|->
name|qdcount
argument_list|)
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|qdcount
operator|==
literal|1
argument_list|)
expr_stmt|;
name|cp
operator|=
name|answer
operator|+
sizeof|sizeof
argument_list|(
name|HEADER
argument_list|)
expr_stmt|;
name|bp
operator|=
name|hostbuf
expr_stmt|;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|hostbuf
argument_list|)
expr_stmt|;
name|n
operator|=
name|dn_expand
argument_list|(
name|answer
argument_list|,
name|eom
argument_list|,
name|cp
argument_list|,
name|bp
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|n
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|n
operator|+
name|QFIXEDSZ
expr_stmt|;
name|hbuf
operator|.
name|h_name
operator|=
name|bp
expr_stmt|;
name|n
operator|=
name|strlen
argument_list|(
name|bp
argument_list|)
operator|+
literal|1
expr_stmt|;
name|bp
operator|+=
name|n
expr_stmt|;
name|buflen
operator|-=
name|n
expr_stmt|;
while|while
condition|(
name|ancount
operator|--
operator|>
literal|0
operator|&&
name|cp
operator|<
name|eom
condition|)
block|{
name|n
operator|=
name|dn_expand
argument_list|(
name|answer
argument_list|,
name|eom
argument_list|,
name|cp
argument_list|,
name|bp
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|n
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|n
expr_stmt|;
comment|/* name */
name|type
operator|=
name|_getshort
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
comment|/* type */
name|class
operator|=
name|_getshort
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
comment|/* class */
name|ttl
operator|=
name|_getlong
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|4
expr_stmt|;
comment|/* ttl */
name|n
operator|=
name|_getshort
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
comment|/* len */
name|DNS_ASSERT
argument_list|(
name|class
operator|==
name|C_IN
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|T_CNAME
case|:
if|if
condition|(
name|na
operator|>=
name|MAXALIASES
operator|-
literal|1
condition|)
block|{
name|cp
operator|+=
name|n
expr_stmt|;
break|break;
block|}
name|n
operator|=
name|dn_expand
argument_list|(
name|answer
argument_list|,
name|eom
argument_list|,
name|cp
argument_list|,
name|tbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tbuf
argument_list|)
argument_list|)
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|n
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|n
expr_stmt|;
comment|/* alias */
name|alist
index|[
name|na
operator|++
index|]
operator|=
name|bp
expr_stmt|;
name|n
operator|=
name|strlen
argument_list|(
name|bp
argument_list|)
operator|+
literal|1
expr_stmt|;
name|bp
operator|+=
name|n
expr_stmt|;
name|buflen
operator|-=
name|n
expr_stmt|;
comment|/* canon */
name|n
operator|=
name|strlen
argument_list|(
name|tbuf
argument_list|)
operator|+
literal|1
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|n
operator|<
name|buflen
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|bp
argument_list|,
name|tbuf
argument_list|)
expr_stmt|;
name|hbuf
operator|.
name|h_name
operator|=
name|bp
expr_stmt|;
name|bp
operator|+=
name|n
expr_stmt|;
name|buflen
operator|-=
name|n
expr_stmt|;
break|break;
case|case
name|T_A
case|:
ifdef|#
directive|ifdef
name|INET6
case|case
name|T_AAAA
case|:
endif|#
directive|endif
name|DNS_ASSERT
argument_list|(
name|type
operator|==
name|qtype
argument_list|)
expr_stmt|;
name|bp
operator|=
operator|(
name|char
operator|*
operator|)
name|ALIGN
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|n
operator|==
name|hbuf
operator|.
name|h_length
argument_list|)
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|n
operator|<
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|nh
operator|<
name|MAXADDRS
operator|-
literal|1
condition|)
block|{
name|hlist
index|[
name|nh
operator|++
index|]
operator|=
name|bp
expr_stmt|;
name|memcpy
argument_list|(
name|bp
argument_list|,
name|cp
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|n
expr_stmt|;
name|buflen
operator|-=
name|n
expr_stmt|;
block|}
name|cp
operator|+=
name|n
expr_stmt|;
break|break;
default|default:
name|DNS_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|n
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|nh
operator|==
literal|0
condition|)
block|{
name|badanswer
label|:
operator|*
name|errp
operator|=
name|NO_RECOVERY
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|alist
index|[
name|na
index|]
operator|=
name|NULL
expr_stmt|;
name|hlist
index|[
name|nh
index|]
operator|=
name|NULL
expr_stmt|;
return|return
name|_hpcopy
argument_list|(
operator|&
name|hbuf
argument_list|,
name|errp
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_dns_ghbyaddr
parameter_list|(
specifier|const
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|addrlen
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|u_char
name|answer
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|HEADER
modifier|*
name|hp
decl_stmt|;
name|u_char
name|c
decl_stmt|,
modifier|*
name|cp
decl_stmt|,
modifier|*
name|eom
decl_stmt|;
name|int
name|type
decl_stmt|,
name|class
decl_stmt|,
name|ancount
decl_stmt|,
name|qdcount
decl_stmt|;
name|u_long
name|ttl
decl_stmt|;
name|char
name|hostbuf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
modifier|*
name|bp
decl_stmt|;
name|char
modifier|*
name|alist
index|[
name|MAXALIASES
index|]
decl_stmt|;
name|char
modifier|*
name|hlist
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|hostent
name|hbuf
decl_stmt|;
name|int
name|buflen
decl_stmt|;
name|int
name|na
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
specifier|static
specifier|const
name|char
name|hex
index|[]
init|=
literal|"0123456789abcdef"
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
comment|/* XXX */
if|if
condition|(
name|af
operator|==
name|AF_INET6
operator|&&
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
operator|(
expr|struct
name|in6_addr
operator|*
operator|)
name|addr
argument_list|)
condition|)
return|return
name|NULL
return|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|_res
operator|.
name|options
operator|&
name|RES_INIT
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|res_init
argument_list|()
operator|<
literal|0
condition|)
block|{
operator|*
name|errp
operator|=
name|h_errno
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|hbuf
operator|.
name|h_name
operator|=
name|NULL
expr_stmt|;
name|hbuf
operator|.
name|h_aliases
operator|=
name|alist
expr_stmt|;
name|hbuf
operator|.
name|h_addrtype
operator|=
name|af
expr_stmt|;
name|hbuf
operator|.
name|h_length
operator|=
name|addrlen
expr_stmt|;
name|hbuf
operator|.
name|h_addr_list
operator|=
name|hlist
expr_stmt|;
name|hlist
index|[
literal|0
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|addr
expr_stmt|;
name|hlist
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|na
operator|=
literal|0
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|bp
operator|=
name|hostbuf
expr_stmt|;
name|cp
operator|=
operator|(
name|u_char
operator|*
operator|)
name|addr
operator|+
name|addrlen
operator|-
literal|1
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
for|for
control|(
init|;
name|n
operator|<
name|addrlen
condition|;
name|n
operator|++
operator|,
name|cp
operator|--
control|)
block|{
name|c
operator|=
operator|*
name|cp
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
name|hex
index|[
name|c
operator|&
literal|0xf
index|]
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|'.'
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
name|hex
index|[
name|c
operator|>>
literal|4
index|]
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|'.'
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|bp
argument_list|,
literal|"ip6.int"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
for|for
control|(
init|;
name|n
operator|<
name|addrlen
condition|;
name|n
operator|++
operator|,
name|cp
operator|--
control|)
block|{
name|c
operator|=
operator|*
name|cp
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|100
condition|)
operator|*
name|bp
operator|++
operator|=
literal|'0'
operator|+
name|c
operator|/
literal|100
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|10
condition|)
operator|*
name|bp
operator|++
operator|=
literal|'0'
operator|+
operator|(
name|c
operator|%
literal|100
operator|)
operator|/
literal|10
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|'0'
operator|+
name|c
operator|%
literal|10
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|'.'
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|bp
argument_list|,
literal|"in-addr.arpa"
argument_list|)
expr_stmt|;
break|break;
block|}
name|n
operator|=
name|res_query
argument_list|(
name|hostbuf
argument_list|,
name|C_IN
argument_list|,
name|T_PTR
argument_list|,
name|answer
argument_list|,
sizeof|sizeof
argument_list|(
name|answer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
block|{
operator|*
name|errp
operator|=
name|h_errno
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|hp
operator|=
operator|(
name|HEADER
operator|*
operator|)
name|answer
expr_stmt|;
name|eom
operator|=
name|answer
operator|+
name|n
expr_stmt|;
name|ancount
operator|=
name|ntohs
argument_list|(
name|hp
operator|->
name|ancount
argument_list|)
expr_stmt|;
name|qdcount
operator|=
name|ntohs
argument_list|(
name|hp
operator|->
name|qdcount
argument_list|)
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|qdcount
operator|==
literal|1
argument_list|)
expr_stmt|;
name|cp
operator|=
name|answer
operator|+
sizeof|sizeof
argument_list|(
name|HEADER
argument_list|)
expr_stmt|;
name|bp
operator|=
name|hostbuf
expr_stmt|;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|hostbuf
argument_list|)
expr_stmt|;
name|n
operator|=
name|dn_expand
argument_list|(
name|answer
argument_list|,
name|eom
argument_list|,
name|cp
argument_list|,
name|bp
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|n
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|n
operator|+
name|QFIXEDSZ
expr_stmt|;
while|while
condition|(
name|ancount
operator|--
operator|>
literal|0
operator|&&
name|cp
operator|<
name|eom
condition|)
block|{
name|n
operator|=
name|dn_expand
argument_list|(
name|answer
argument_list|,
name|eom
argument_list|,
name|cp
argument_list|,
name|bp
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|n
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|n
expr_stmt|;
comment|/* name */
name|type
operator|=
name|_getshort
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
comment|/* type */
name|class
operator|=
name|_getshort
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
comment|/* class */
name|ttl
operator|=
name|_getlong
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|4
expr_stmt|;
comment|/* ttl */
name|n
operator|=
name|_getshort
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|+=
literal|2
expr_stmt|;
comment|/* len */
name|DNS_ASSERT
argument_list|(
name|class
operator|==
name|C_IN
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|T_PTR
case|:
name|n
operator|=
name|dn_expand
argument_list|(
name|answer
argument_list|,
name|eom
argument_list|,
name|cp
argument_list|,
name|bp
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|DNS_ASSERT
argument_list|(
name|n
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|n
expr_stmt|;
if|if
condition|(
name|na
operator|>=
name|MAXALIASES
operator|-
literal|1
condition|)
break|break;
if|if
condition|(
name|hbuf
operator|.
name|h_name
operator|==
name|NULL
condition|)
name|hbuf
operator|.
name|h_name
operator|=
name|bp
expr_stmt|;
else|else
name|alist
index|[
name|na
operator|++
index|]
operator|=
name|bp
expr_stmt|;
name|n
operator|=
name|strlen
argument_list|(
name|bp
argument_list|)
operator|+
literal|1
expr_stmt|;
name|bp
operator|+=
name|n
expr_stmt|;
name|buflen
operator|-=
name|n
expr_stmt|;
break|break;
case|case
name|T_CNAME
case|:
name|cp
operator|+=
name|n
expr_stmt|;
break|break;
default|default:
name|badanswer
label|:
operator|*
name|errp
operator|=
name|NO_RECOVERY
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|hbuf
operator|.
name|h_name
operator|==
name|NULL
condition|)
block|{
operator|*
name|errp
operator|=
name|h_errno
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|alist
index|[
name|na
index|]
operator|=
name|NULL
expr_stmt|;
return|return
name|_hpcopy
argument_list|(
operator|&
name|hbuf
argument_list|,
name|errp
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|ICMPNL
end_ifdef

begin_comment
comment|/*  * experimental:  *	draft-ietf-ipngwg-icmp-namelookups-02.txt  *	ifindex is assumed to be encoded in addr.  */
end_comment

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip6.h>
end_include

begin_include
include|#
directive|include
file|<netinet/icmp6.h>
end_include

begin_struct
struct|struct
name|_icmp_host_cache
block|{
name|struct
name|_icmp_host_cache
modifier|*
name|hc_next
decl_stmt|;
name|int
name|hc_ifindex
decl_stmt|;
name|struct
name|in6_addr
name|hc_addr
decl_stmt|;
name|char
modifier|*
name|hc_name
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|char
modifier|*
name|_icmp_fqdn_query
parameter_list|(
specifier|const
name|struct
name|in6_addr
modifier|*
name|addr
parameter_list|,
name|int
name|ifindex
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|struct
name|icmp6_filter
name|filter
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
name|struct
name|in6_pktinfo
modifier|*
name|pkt
decl_stmt|;
name|char
name|cbuf
index|[
literal|256
index|]
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|cc
decl_stmt|;
name|struct
name|icmp6_fqdn_query
modifier|*
name|fq
decl_stmt|;
name|struct
name|icmp6_fqdn_reply
modifier|*
name|fr
decl_stmt|;
name|struct
name|_icmp_host_cache
modifier|*
name|hc
decl_stmt|;
name|struct
name|sockaddr_in6
name|sin6
decl_stmt|;
name|struct
name|iovec
name|iov
decl_stmt|;
name|fd_set
name|s_fds
decl_stmt|,
name|fds
decl_stmt|;
name|struct
name|timeval
name|tout
decl_stmt|;
name|int
name|len
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
specifier|static
name|int
name|pid
decl_stmt|;
specifier|static
name|struct
name|_icmp_host_cache
modifier|*
name|hc_head
decl_stmt|;
for|for
control|(
name|hc
operator|=
name|hc_head
init|;
name|hc
condition|;
name|hc
operator|=
name|hc
operator|->
name|hc_next
control|)
block|{
if|if
condition|(
name|hc
operator|->
name|hc_ifindex
operator|==
name|ifindex
operator|&&
name|IN6_ARE_ADDR_EQUAL
argument_list|(
operator|&
name|hc
operator|->
name|hc_addr
argument_list|,
name|addr
argument_list|)
condition|)
return|return
name|hc
operator|->
name|hc_name
return|;
block|}
if|if
condition|(
name|pid
operator|==
literal|0
condition|)
name|pid
operator|=
name|getpid
argument_list|()
expr_stmt|;
name|ICMP6_FILTER_SETBLOCKALL
argument_list|(
operator|&
name|filter
argument_list|)
expr_stmt|;
name|ICMP6_FILTER_SETPASS
argument_list|(
name|ICMP6_FQDN_REPLY
argument_list|,
operator|&
name|filter
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|s_fds
argument_list|)
expr_stmt|;
name|tout
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|tout
operator|.
name|tv_usec
operator|=
literal|200000
expr_stmt|;
comment|/*XXX: 200ms*/
name|fq
operator|=
operator|(
expr|struct
name|icmp6_fqdn_query
operator|*
operator|)
name|buf
expr_stmt|;
name|fq
operator|->
name|icmp6_fqdn_type
operator|=
name|ICMP6_FQDN_QUERY
expr_stmt|;
name|fq
operator|->
name|icmp6_fqdn_code
operator|=
literal|0
expr_stmt|;
name|fq
operator|->
name|icmp6_fqdn_cksum
operator|=
literal|0
expr_stmt|;
name|fq
operator|->
name|icmp6_fqdn_id
operator|=
operator|(
name|u_short
operator|)
name|pid
expr_stmt|;
name|fq
operator|->
name|icmp6_fqdn_unused
operator|=
literal|0
expr_stmt|;
name|fq
operator|->
name|icmp6_fqdn_cookie
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|fq
operator|->
name|icmp6_fqdn_cookie
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|sin6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sin6
argument_list|)
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|sin6
operator|.
name|sin6_addr
operator|=
operator|*
name|addr
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|sin6
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|sin6
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
operator|&
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
name|NULL
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
literal|0
expr_stmt|;
name|iov
operator|.
name|iov_base
operator|=
operator|(
name|caddr_t
operator|)
name|buf
expr_stmt|;
name|iov
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_fqdn_query
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifindex
condition|)
block|{
name|msg
operator|.
name|msg_control
operator|=
name|cbuf
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
expr_stmt|;
name|cmsg
operator|=
name|CMSG_FIRSTHDR
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|cmsg
operator|->
name|cmsg_len
operator|=
name|CMSG_LEN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_pktinfo
argument_list|)
argument_list|)
expr_stmt|;
name|cmsg
operator|->
name|cmsg_level
operator|=
name|IPPROTO_IPV6
expr_stmt|;
name|cmsg
operator|->
name|cmsg_type
operator|=
name|IPV6_PKTINFO
expr_stmt|;
name|pkt
operator|=
operator|(
expr|struct
name|in6_pktinfo
operator|*
operator|)
operator|&
name|cmsg
index|[
literal|1
index|]
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pkt
operator|->
name|ipi6_addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|ipi6_ifindex
operator|=
name|ifindex
expr_stmt|;
name|cmsg
operator|=
name|CMSG_NXTHDR
argument_list|(
operator|&
name|msg
argument_list|,
name|cmsg
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
operator|(
name|char
operator|*
operator|)
name|cmsg
operator|-
name|cbuf
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|s
operator|=
name|socket
argument_list|(
name|PF_INET6
argument_list|,
name|SOCK_RAW
argument_list|,
name|IPPROTO_ICMPV6
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|s
argument_list|,
name|IPPROTO_ICMPV6
argument_list|,
name|ICMP6_FILTER
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|filter
argument_list|,
sizeof|sizeof
argument_list|(
name|filter
argument_list|)
argument_list|)
expr_stmt|;
name|cc
operator|=
name|sendmsg
argument_list|(
name|s
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|<
literal|0
condition|)
block|{
name|_libc_close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|FD_SET
argument_list|(
name|s
argument_list|,
operator|&
name|s_fds
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|fds
operator|=
name|s_fds
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|s
operator|+
literal|1
argument_list|,
operator|&
name|fds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tout
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|_libc_close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|sin6
argument_list|)
expr_stmt|;
name|cc
operator|=
name|recvfrom
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin6
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|<=
literal|0
condition|)
block|{
name|_libc_close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|cc
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|IN6_ARE_ADDR_EQUAL
argument_list|(
name|addr
argument_list|,
operator|&
name|sin6
operator|.
name|sin6_addr
argument_list|)
condition|)
continue|continue;
name|fr
operator|=
operator|(
expr|struct
name|icmp6_fqdn_reply
operator|*
operator|)
operator|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|fr
operator|->
name|icmp6_fqdn_type
operator|==
name|ICMP6_FQDN_REPLY
condition|)
break|break;
block|}
name|_libc_close
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|fr
operator|->
name|icmp6_fqdn_cookie
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
block|{
comment|/* rfc1788 type */
name|name
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
operator|+
literal|4
expr_stmt|;
name|len
operator|=
operator|(
name|buf
operator|+
name|cc
operator|)
operator|-
name|name
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|fr
operator|->
name|icmp6_fqdn_namelen
expr_stmt|;
name|name
operator|=
name|fr
operator|->
name|icmp6_fqdn_name
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
return|return
name|NULL
return|;
name|name
index|[
name|len
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|hc
operator|=
operator|(
expr|struct
name|_icmp_host_cache
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hc
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* XXX: limit number of cached entries */
name|hc
operator|->
name|hc_ifindex
operator|=
name|ifindex
expr_stmt|;
name|hc
operator|->
name|hc_addr
operator|=
operator|*
name|addr
expr_stmt|;
name|hc
operator|->
name|hc_name
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|hc
operator|->
name|hc_next
operator|=
name|hc_head
expr_stmt|;
name|hc_head
operator|=
name|hc
expr_stmt|;
return|return
name|hc
operator|->
name|hc_name
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostent
modifier|*
name|_icmp_ghbyaddr
parameter_list|(
specifier|const
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|addrlen
parameter_list|,
name|int
name|af
parameter_list|,
name|int
modifier|*
name|errp
parameter_list|)
block|{
name|char
modifier|*
name|hname
decl_stmt|;
name|int
name|ifindex
decl_stmt|;
name|struct
name|in6_addr
name|addr6
decl_stmt|;
if|if
condition|(
name|af
operator|!=
name|AF_INET6
condition|)
block|{
comment|/* 		 * Note: rfc1788 defines Who Are You for IPv4, 		 * but no one implements it. 		 */
return|return
name|NULL
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|addr6
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
name|ifindex
operator|=
operator|(
name|addr6
operator|.
name|s6_addr
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
name|addr6
operator|.
name|s6_addr
index|[
literal|3
index|]
expr_stmt|;
name|addr6
operator|.
name|s6_addr
index|[
literal|2
index|]
operator|=
name|addr6
operator|.
name|s6_addr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
operator|&
name|addr6
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/*XXX*/
if|if
condition|(
operator|(
name|hname
operator|=
name|_icmp_fqdn_query
argument_list|(
operator|&
name|addr6
argument_list|,
name|ifindex
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
return|return
name|_hpaddr
argument_list|(
name|af
argument_list|,
name|hname
argument_list|,
operator|&
name|addr6
argument_list|,
name|errp
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ICMPNL */
end_comment

end_unit


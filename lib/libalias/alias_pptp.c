begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * alias_pptp.c  *  * Copyright (c) 2000 Whistle Communications, Inc.  * All rights reserved.  *  * Subject to the following obligations and disclaimer of warranty, use and  * redistribution of this software, in source or object code forms, with or  * without modifications are expressly permitted by Whistle Communications;  * provided, however, that:  * 1. Any and all reproductions of the source or object code must include the  *    copyright notice above and the following disclaimer of warranties; and  * 2. No rights are granted, in any manner or form, to use Whistle  *    Communications, Inc. trademarks, including the mark "WHISTLE  *    COMMUNICATIONS" on advertising, endorsements, or otherwise except as  *    such appears in the above copyright notice or in the software.  *  * THIS SOFTWARE IS BEING PROVIDED BY WHISTLE COMMUNICATIONS "AS IS", AND  * TO THE MAXIMUM EXTENT PERMITTED BY LAW, WHISTLE COMMUNICATIONS MAKES NO  * REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED, REGARDING THIS SOFTWARE,  * INCLUDING WITHOUT LIMITATION, ANY AND ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT.  * WHISTLE COMMUNICATIONS DOES NOT WARRANT, GUARANTEE, OR MAKE ANY  * REPRESENTATIONS REGARDING THE USE OF, OR THE RESULTS OF THE USE OF THIS  * SOFTWARE IN TERMS OF ITS CORRECTNESS, ACCURACY, RELIABILITY OR OTHERWISE.  * IN NO EVENT SHALL WHISTLE COMMUNICATIONS BE LIABLE FOR ANY DAMAGES  * RESULTING FROM OR ARISING OUT OF ANY USE OF THIS SOFTWARE, INCLUDING  * WITHOUT LIMITATION, ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,  * PUNITIVE, OR CONSEQUENTIAL DAMAGES, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES, LOSS OF USE, DATA OR PROFITS, HOWEVER CAUSED AND UNDER ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF WHISTLE COMMUNICATIONS IS ADVISED OF THE POSSIBILITY  * OF SUCH DAMAGE.  *  * Author: Erik Salander<erik@whistle.com>  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*    Alias_pptp.c performs special processing for PPTP sessions under TCP.    Specifically, watch PPTP control messages and alias the Call ID or the    Peer's Call ID in the appropriate messages.  Note, PPTP requires    "de-aliasing" of incoming packets, this is different than any other    TCP applications that are currently (ie. FTP, IRC and RTSP) aliased.     For Call IDs encountered for the first time, a PPTP alias link is created.    The PPTP alias link uses the Call ID in place of the original port number.    An alias Call ID is created.     For this routine to work, the PPTP control messages must fit entirely    into a single TCP packet.  This is typically the case, but is not    required by the spec.     Unlike some of the other TCP applications that are aliased (ie. FTP,    IRC and RTSP), the PPTP control messages that need to be aliased are    guaranteed to remain the same length.  The aliased Call ID is a fixed    length field.     Reference: RFC 2637     Initial version:  May, 2000 (eds)  */
end_comment

begin_comment
comment|/* Includes */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"alias_local.h"
end_include

begin_comment
comment|/*  * PPTP definitions  */
end_comment

begin_struct
struct|struct
name|grehdr
comment|/* Enhanced GRE header. */
block|{
name|u_int16_t
name|gh_flags
decl_stmt|;
comment|/* Flags. */
name|u_int16_t
name|gh_protocol
decl_stmt|;
comment|/* Protocol type. */
name|u_int16_t
name|gh_length
decl_stmt|;
comment|/* Payload length. */
name|u_int16_t
name|gh_call_id
decl_stmt|;
comment|/* Call ID. */
name|u_int32_t
name|gh_seq_no
decl_stmt|;
comment|/* Sequence number (optional). */
name|u_int32_t
name|gh_ack_no
decl_stmt|;
comment|/* Acknowledgment number (optional). */
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|grehdr
name|GreHdr
typedef|;
end_typedef

begin_comment
comment|/* The PPTP protocol ID used in the GRE 'proto' field. */
end_comment

begin_define
define|#
directive|define
name|PPTP_GRE_PROTO
value|0x880b
end_define

begin_comment
comment|/* Bits that must be set a certain way in all PPTP/GRE packets. */
end_comment

begin_define
define|#
directive|define
name|PPTP_INIT_VALUE
value|((0x2001<< 16) | PPTP_GRE_PROTO)
end_define

begin_define
define|#
directive|define
name|PPTP_INIT_MASK
value|0xef7fffff
end_define

begin_define
define|#
directive|define
name|PPTP_MAGIC
value|0x1a2b3c4d
end_define

begin_define
define|#
directive|define
name|PPTP_CTRL_MSG_TYPE
value|1
end_define

begin_enum
enum|enum
block|{
name|PPTP_StartCtrlConnRequest
init|=
literal|1
block|,
name|PPTP_StartCtrlConnReply
init|=
literal|2
block|,
name|PPTP_StopCtrlConnRequest
init|=
literal|3
block|,
name|PPTP_StopCtrlConnReply
init|=
literal|4
block|,
name|PPTP_EchoRequest
init|=
literal|5
block|,
name|PPTP_EchoReply
init|=
literal|6
block|,
name|PPTP_OutCallRequest
init|=
literal|7
block|,
name|PPTP_OutCallReply
init|=
literal|8
block|,
name|PPTP_InCallRequest
init|=
literal|9
block|,
name|PPTP_InCallReply
init|=
literal|10
block|,
name|PPTP_InCallConn
init|=
literal|11
block|,
name|PPTP_CallClearRequest
init|=
literal|12
block|,
name|PPTP_CallDiscNotify
init|=
literal|13
block|,
name|PPTP_WanErrorNotify
init|=
literal|14
block|,
name|PPTP_SetLinkInfo
init|=
literal|15
block|}
enum|;
end_enum

begin_comment
comment|/* Message structures */
end_comment

begin_struct
struct|struct
name|pptpMsgHead
block|{
name|u_int16_t
name|length
decl_stmt|;
comment|/* total length */
name|u_int16_t
name|msgType
decl_stmt|;
comment|/* PPTP message type */
name|u_int32_t
name|magic
decl_stmt|;
comment|/* magic cookie */
name|u_int16_t
name|type
decl_stmt|;
comment|/* control message type */
name|u_int16_t
name|resv0
decl_stmt|;
comment|/* reserved */
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|pptpMsgHead
modifier|*
name|PptpMsgHead
typedef|;
end_typedef

begin_struct
struct|struct
name|pptpCodes
block|{
name|u_int8_t
name|resCode
decl_stmt|;
comment|/* Result Code */
name|u_int8_t
name|errCode
decl_stmt|;
comment|/* Error Code */
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|pptpCodes
modifier|*
name|PptpCode
typedef|;
end_typedef

begin_struct
struct|struct
name|pptpCallIds
block|{
name|u_int16_t
name|cid1
decl_stmt|;
comment|/* Call ID field #1 */
name|u_int16_t
name|cid2
decl_stmt|;
comment|/* Call ID field #2 */
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|pptpCallIds
modifier|*
name|PptpCallId
typedef|;
end_typedef

begin_function_decl
specifier|static
name|PptpCallId
name|AliasVerifyPptp
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|AliasHandlePptpOut
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|,
comment|/* IP packet to examine/patch */
name|struct
name|alias_link
modifier|*
name|link
parameter_list|)
comment|/* The PPTP control link */
block|{
name|struct
name|alias_link
modifier|*
name|pptp_link
decl_stmt|;
name|PptpCallId
name|cptr
decl_stmt|;
name|PptpCode
name|codes
decl_stmt|;
name|u_int16_t
name|ctl_type
decl_stmt|;
comment|/* control message type */
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
comment|/* Verify valid PPTP control message */
if|if
condition|(
operator|(
name|cptr
operator|=
name|AliasVerifyPptp
argument_list|(
name|pip
argument_list|,
operator|&
name|ctl_type
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
comment|/* Modify certain PPTP messages */
switch|switch
condition|(
name|ctl_type
condition|)
block|{
case|case
name|PPTP_OutCallRequest
case|:
case|case
name|PPTP_OutCallReply
case|:
case|case
name|PPTP_InCallRequest
case|:
case|case
name|PPTP_InCallReply
case|:
comment|/* Establish PPTP link for address and Call ID found in control message. */
name|pptp_link
operator|=
name|AddPptp
argument_list|(
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
argument_list|,
name|GetDestAddress
argument_list|(
name|link
argument_list|)
argument_list|,
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
argument_list|,
name|cptr
operator|->
name|cid1
argument_list|)
expr_stmt|;
break|break;
case|case
name|PPTP_CallClearRequest
case|:
case|case
name|PPTP_CallDiscNotify
case|:
comment|/* Find PPTP link for address and Call ID found in control message. */
name|pptp_link
operator|=
name|FindPptpOutByCallId
argument_list|(
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
argument_list|,
name|GetDestAddress
argument_list|(
name|link
argument_list|)
argument_list|,
name|cptr
operator|->
name|cid1
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return;
block|}
if|if
condition|(
name|pptp_link
operator|!=
name|NULL
condition|)
block|{
name|int
name|accumulate
init|=
name|cptr
operator|->
name|cid1
decl_stmt|;
comment|/* alias the Call Id */
name|cptr
operator|->
name|cid1
operator|=
name|GetAliasPort
argument_list|(
name|pptp_link
argument_list|)
expr_stmt|;
comment|/* Compute TCP checksum for revised packet */
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|accumulate
operator|-=
name|cptr
operator|->
name|cid1
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
name|accumulate
argument_list|,
name|tc
operator|->
name|th_sum
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ctl_type
condition|)
block|{
case|case
name|PPTP_OutCallReply
case|:
case|case
name|PPTP_InCallReply
case|:
name|codes
operator|=
call|(
name|PptpCode
call|)
argument_list|(
name|cptr
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|codes
operator|->
name|resCode
operator|==
literal|1
condition|)
comment|/* Connection established, */
name|SetDestCallId
argument_list|(
name|pptp_link
argument_list|,
comment|/* note the Peer's Call ID. */
name|cptr
operator|->
name|cid2
argument_list|)
expr_stmt|;
else|else
name|SetExpire
argument_list|(
name|pptp_link
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Connection refused. */
break|break;
case|case
name|PPTP_CallDiscNotify
case|:
comment|/* Connection closed. */
name|SetExpire
argument_list|(
name|pptp_link
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
name|void
name|AliasHandlePptpIn
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|,
comment|/* IP packet to examine/patch */
name|struct
name|alias_link
modifier|*
name|link
parameter_list|)
comment|/* The PPTP control link */
block|{
name|struct
name|alias_link
modifier|*
name|pptp_link
decl_stmt|;
name|PptpCallId
name|cptr
decl_stmt|;
name|u_int16_t
modifier|*
name|pcall_id
decl_stmt|;
name|u_int16_t
name|ctl_type
decl_stmt|;
comment|/* control message type */
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
comment|/* Verify valid PPTP control message */
if|if
condition|(
operator|(
name|cptr
operator|=
name|AliasVerifyPptp
argument_list|(
name|pip
argument_list|,
operator|&
name|ctl_type
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
comment|/* Modify certain PPTP messages */
switch|switch
condition|(
name|ctl_type
condition|)
block|{
case|case
name|PPTP_InCallConn
case|:
case|case
name|PPTP_WanErrorNotify
case|:
case|case
name|PPTP_SetLinkInfo
case|:
name|pcall_id
operator|=
operator|&
name|cptr
operator|->
name|cid1
expr_stmt|;
break|break;
case|case
name|PPTP_OutCallReply
case|:
case|case
name|PPTP_InCallReply
case|:
name|pcall_id
operator|=
operator|&
name|cptr
operator|->
name|cid2
expr_stmt|;
break|break;
case|case
name|PPTP_CallDiscNotify
case|:
comment|/* Connection closed. */
name|pptp_link
operator|=
name|FindPptpInByCallId
argument_list|(
name|GetDestAddress
argument_list|(
name|link
argument_list|)
argument_list|,
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
argument_list|,
name|cptr
operator|->
name|cid1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pptp_link
operator|!=
name|NULL
condition|)
name|SetExpire
argument_list|(
name|pptp_link
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
default|default:
return|return;
block|}
comment|/* Find PPTP link for address and Call ID found in PPTP Control Msg */
name|pptp_link
operator|=
name|FindPptpInByPeerCallId
argument_list|(
name|GetDestAddress
argument_list|(
name|link
argument_list|)
argument_list|,
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
argument_list|,
operator|*
name|pcall_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|pptp_link
operator|!=
name|NULL
condition|)
block|{
name|int
name|accumulate
init|=
operator|*
name|pcall_id
decl_stmt|;
comment|/* De-alias the Peer's Call Id. */
operator|*
name|pcall_id
operator|=
name|GetOriginalPort
argument_list|(
name|pptp_link
argument_list|)
expr_stmt|;
comment|/* Compute TCP checksum for modified packet */
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|pcall_id
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
name|accumulate
argument_list|,
name|tc
operator|->
name|th_sum
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl_type
operator|==
name|PPTP_OutCallReply
operator|||
name|ctl_type
operator|==
name|PPTP_InCallReply
condition|)
block|{
name|PptpCode
name|codes
init|=
call|(
name|PptpCode
call|)
argument_list|(
name|cptr
operator|+
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|codes
operator|->
name|resCode
operator|==
literal|1
condition|)
comment|/* Connection established, */
name|SetDestCallId
argument_list|(
name|pptp_link
argument_list|,
comment|/* note the Call ID. */
name|cptr
operator|->
name|cid1
argument_list|)
expr_stmt|;
else|else
name|SetExpire
argument_list|(
name|pptp_link
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Connection refused. */
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|PptpCallId
name|AliasVerifyPptp
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|,
name|u_int16_t
modifier|*
name|ptype
parameter_list|)
comment|/* IP packet to examine/patch */
block|{
name|int
name|hlen
decl_stmt|,
name|tlen
decl_stmt|,
name|dlen
decl_stmt|;
name|PptpMsgHead
name|hptr
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
comment|/* Calculate some lengths */
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|hlen
operator|=
operator|(
name|pip
operator|->
name|ip_hl
operator|+
name|tc
operator|->
name|th_off
operator|)
operator|<<
literal|2
expr_stmt|;
name|tlen
operator|=
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|dlen
operator|=
name|tlen
operator|-
name|hlen
expr_stmt|;
comment|/* Verify data length */
if|if
condition|(
name|dlen
operator|<
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|pptpMsgHead
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|pptpCallIds
argument_list|)
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* Move up to PPTP message header */
name|hptr
operator|=
call|(
name|PptpMsgHead
call|)
argument_list|(
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|)
operator|+
name|hlen
argument_list|)
expr_stmt|;
comment|/* Return the control message type */
operator|*
name|ptype
operator|=
name|ntohs
argument_list|(
name|hptr
operator|->
name|type
argument_list|)
expr_stmt|;
comment|/* Verify PPTP Control Message */
if|if
condition|(
operator|(
name|ntohs
argument_list|(
name|hptr
operator|->
name|msgType
argument_list|)
operator|!=
name|PPTP_CTRL_MSG_TYPE
operator|)
operator|||
operator|(
name|ntohl
argument_list|(
name|hptr
operator|->
name|magic
argument_list|)
operator|!=
name|PPTP_MAGIC
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* Verify data length. */
if|if
condition|(
operator|(
operator|*
name|ptype
operator|==
name|PPTP_OutCallReply
operator|||
operator|*
name|ptype
operator|==
name|PPTP_InCallReply
operator|)
operator|&&
operator|(
name|dlen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|pptpMsgHead
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|pptpCallIds
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|pptpCodes
argument_list|)
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
else|else
return|return
call|(
name|PptpCallId
call|)
argument_list|(
name|hptr
operator|+
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|AliasHandlePptpGreOut
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|GreHdr
modifier|*
name|gr
decl_stmt|;
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|gr
operator|=
operator|(
name|GreHdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
comment|/* Check GRE header bits. */
if|if
condition|(
operator|(
name|ntohl
argument_list|(
operator|*
operator|(
operator|(
name|u_int32_t
operator|*
operator|)
name|gr
operator|)
argument_list|)
operator|&
name|PPTP_INIT_MASK
operator|)
operator|!=
name|PPTP_INIT_VALUE
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|link
operator|=
name|FindPptpOutByPeerCallId
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|gr
operator|->
name|gh_call_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|struct
name|in_addr
name|alias_addr
init|=
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
decl_stmt|;
comment|/* Change source IP address. */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_addr
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_src
operator|=
name|alias_addr
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|AliasHandlePptpGreIn
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|GreHdr
modifier|*
name|gr
decl_stmt|;
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|gr
operator|=
operator|(
name|GreHdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
comment|/* Check GRE header bits. */
if|if
condition|(
operator|(
name|ntohl
argument_list|(
operator|*
operator|(
operator|(
name|u_int32_t
operator|*
operator|)
name|gr
operator|)
argument_list|)
operator|&
name|PPTP_INIT_MASK
operator|)
operator|!=
name|PPTP_INIT_VALUE
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|link
operator|=
name|FindPptpInByPeerCallId
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|gr
operator|->
name|gh_call_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|struct
name|in_addr
name|src_addr
init|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
decl_stmt|;
comment|/* De-alias the Peer's Call Id. */
name|gr
operator|->
name|gh_call_id
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Restore original IP address. */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|src_addr
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|src_addr
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


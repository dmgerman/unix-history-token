begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2001 Charles Mott<cm@linktel.net>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*     Alias_util.c contains general utilities used by other functions     in the packet aliasing module.  At the moment, there are functions     for computing IP header and TCP packet checksums.      The checksum routines are based upon example code in a Unix networking     text written by Stevens (sorry, I can't remember the title -- but     at least this is a good author).      Initial Version:  August, 1996  (cjm)      Version 1.7:  January 9, 1997 	 Added differential checksum update function. */
end_comment

begin_comment
comment|/* Note: the checksum routines assume that the actual checksum word has been zeroed out.  If the checksum word is filled with the proper value, then these routines will give a result of zero (useful for testing purposes); */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|"alias.h"
end_include

begin_include
include|#
directive|include
file|"alias_local.h"
end_include

begin_function
name|u_short
name|LibAliasInternetChecksum
parameter_list|(
name|struct
name|libalias
modifier|*
name|la
parameter_list|,
name|u_short
modifier|*
name|ptr
parameter_list|,
name|int
name|nbytes
parameter_list|)
block|{
name|int
name|sum
decl_stmt|,
name|oddbyte
decl_stmt|;
operator|(
name|void
operator|)
name|la
expr_stmt|;
name|sum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|nbytes
operator|>
literal|1
condition|)
block|{
name|sum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|nbytes
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|nbytes
operator|==
literal|1
condition|)
block|{
name|oddbyte
operator|=
literal|0
expr_stmt|;
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|oddbyte
operator|)
index|[
literal|0
index|]
operator|=
operator|*
operator|(
name|u_char
operator|*
operator|)
name|ptr
expr_stmt|;
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|oddbyte
operator|)
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|sum
operator|+=
name|oddbyte
expr_stmt|;
block|}
name|sum
operator|=
operator|(
name|sum
operator|>>
literal|16
operator|)
operator|+
operator|(
name|sum
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|sum
operator|+=
operator|(
name|sum
operator|>>
literal|16
operator|)
expr_stmt|;
return|return
operator|(
operator|~
name|sum
operator|)
return|;
block|}
end_function

begin_function
name|u_short
name|IpChecksum
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
return|return
operator|(
name|PacketAliasInternetChecksum
argument_list|(
operator|(
name|u_short
operator|*
operator|)
name|pip
argument_list|,
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|u_short
name|TcpChecksum
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|u_short
modifier|*
name|ptr
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|int
name|nhdr
decl_stmt|,
name|ntcp
decl_stmt|,
name|nbytes
decl_stmt|;
name|int
name|sum
decl_stmt|,
name|oddbyte
decl_stmt|;
name|nhdr
operator|=
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
expr_stmt|;
name|ntcp
operator|=
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_len
argument_list|)
operator|-
name|nhdr
expr_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
name|ip_next
argument_list|(
name|pip
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
name|u_short
operator|*
operator|)
name|tc
expr_stmt|;
comment|/* Add up TCP header and data */
name|nbytes
operator|=
name|ntcp
expr_stmt|;
name|sum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|nbytes
operator|>
literal|1
condition|)
block|{
name|sum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|nbytes
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|nbytes
operator|==
literal|1
condition|)
block|{
name|oddbyte
operator|=
literal|0
expr_stmt|;
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|oddbyte
operator|)
index|[
literal|0
index|]
operator|=
operator|*
operator|(
name|u_char
operator|*
operator|)
name|ptr
expr_stmt|;
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|oddbyte
operator|)
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|sum
operator|+=
name|oddbyte
expr_stmt|;
block|}
comment|/* "Pseudo-header" data */
name|ptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_dst
operator|)
expr_stmt|;
name|sum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|sum
operator|+=
operator|*
name|ptr
expr_stmt|;
name|ptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|sum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|sum
operator|+=
operator|*
name|ptr
expr_stmt|;
name|sum
operator|+=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|ntcp
argument_list|)
expr_stmt|;
name|sum
operator|+=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|pip
operator|->
name|ip_p
argument_list|)
expr_stmt|;
comment|/* Roll over carry bits */
name|sum
operator|=
operator|(
name|sum
operator|>>
literal|16
operator|)
operator|+
operator|(
name|sum
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|sum
operator|+=
operator|(
name|sum
operator|>>
literal|16
operator|)
expr_stmt|;
comment|/* Return checksum */
return|return
operator|(
operator|(
name|u_short
operator|)
operator|~
name|sum
operator|)
return|;
block|}
end_function

begin_function
name|void
name|DifferentialChecksum
parameter_list|(
name|u_short
modifier|*
name|cksum
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|u_short
modifier|*
name|new
init|=
name|newp
decl_stmt|;
name|u_short
modifier|*
name|old
init|=
name|oldp
decl_stmt|;
name|accumulate
operator|=
operator|*
name|cksum
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|accumulate
operator|-=
operator|*
name|new
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|old
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|accumulate
operator|<
literal|0
condition|)
block|{
name|accumulate
operator|=
operator|-
name|accumulate
expr_stmt|;
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
operator|*
name|cksum
operator|=
operator|(
name|u_short
operator|)
operator|~
name|accumulate
expr_stmt|;
block|}
else|else
block|{
name|accumulate
operator|=
operator|(
name|accumulate
operator|>>
literal|16
operator|)
operator|+
operator|(
name|accumulate
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|accumulate
operator|+=
name|accumulate
operator|>>
literal|16
expr_stmt|;
operator|*
name|cksum
operator|=
operator|(
name|u_short
operator|)
name|accumulate
expr_stmt|;
block|}
block|}
end_function

end_unit


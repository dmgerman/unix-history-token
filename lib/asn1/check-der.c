begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1999 - 2007 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of the Institute nor the names of its contributors   *    may be used to endorse or promote products derived from this software   *    without specific prior written permission.   *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF   * SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|"der_locl.h"
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<roken.h>
end_include

begin_include
include|#
directive|include
file|<asn1-common.h>
end_include

begin_include
include|#
directive|include
file|<asn1_err.h>
end_include

begin_include
include|#
directive|include
file|<der.h>
end_include

begin_include
include|#
directive|include
file|"check-common.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: check-der.c 21359 2007-06-27 08:15:41Z lha $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|cmp_integer
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
name|int
modifier|*
name|ia
init|=
operator|(
name|int
operator|*
operator|)
name|a
decl_stmt|;
name|int
modifier|*
name|ib
init|=
operator|(
name|int
operator|*
operator|)
name|b
decl_stmt|;
return|return
operator|*
name|ib
operator|-
operator|*
name|ia
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_integer
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x00"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x7f"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x00\x80"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x01\x00"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x80"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\xff\x7f"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\xff"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\xff\x01"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x00\xff"
block|}
block|,
block|{
name|NULL
block|,
literal|4
block|,
literal|"\x7f\xff\xff\xff"
block|}
block|}
decl_stmt|;
name|int
name|values
index|[]
init|=
block|{
literal|0
block|,
literal|127
block|,
literal|128
block|,
literal|256
block|,
operator|-
literal|128
block|,
operator|-
literal|129
block|,
operator|-
literal|1
block|,
operator|-
literal|255
block|,
literal|255
block|,
literal|0x7fffffff
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
block|{
name|tests
index|[
name|i
index|]
operator|.
name|val
operator|=
operator|&
name|values
index|[
name|i
index|]
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|,
literal|"integer %d"
argument_list|,
name|values
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
name|i
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_integer
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_integer
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_integer
argument_list|,
operator|(
name|generic_free
operator|)
name|NULL
argument_list|,
name|cmp_integer
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
name|free
argument_list|(
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_one_int
parameter_list|(
name|int
name|val
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|dval
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len_len
decl_stmt|,
name|len
decl_stmt|;
name|len
operator|=
name|_heim_len_int
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|buf
operator|=
name|emalloc
argument_list|(
name|len
operator|+
literal|2
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\xff'
expr_stmt|;
name|buf
index|[
name|len
operator|+
literal|1
index|]
operator|=
literal|'\xff'
expr_stmt|;
name|memset
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|der_put_integer
argument_list|(
name|buf
operator|+
literal|1
operator|+
name|len
operator|-
literal|1
argument_list|,
name|len
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|len_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"integer %d encode failed %d\n"
argument_list|,
name|val
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|len
operator|!=
name|len_len
condition|)
block|{
name|printf
argument_list|(
literal|"integer %d encode fail with %d len %lu, result len %lu\n"
argument_list|,
name|val
argument_list|,
name|ret
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len_len
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|ret
operator|=
name|der_get_integer
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
name|len
argument_list|,
operator|&
name|dval
argument_list|,
operator|&
name|len_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"integer %d decode failed %d\n"
argument_list|,
name|val
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|len
operator|!=
name|len_len
condition|)
block|{
name|printf
argument_list|(
literal|"integer %d decoded diffrent len %lu != %lu"
argument_list|,
name|val
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len_len
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|val
operator|!=
name|dval
condition|)
block|{
name|printf
argument_list|(
literal|"decode decoded to diffrent value %d != %d"
argument_list|,
name|val
argument_list|,
name|dval
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|!=
operator|(
name|unsigned
name|char
operator|)
literal|'\xff'
condition|)
block|{
name|printf
argument_list|(
literal|"precanary dead %d\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|buf
index|[
name|len
operator|+
literal|1
index|]
operator|!=
operator|(
name|unsigned
name|char
operator|)
literal|'\xff'
condition|)
block|{
name|printf
argument_list|(
literal|"postecanary dead %d\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_integer_more
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n1
decl_stmt|,
name|n2
decl_stmt|,
name|n3
decl_stmt|,
name|n4
decl_stmt|,
name|n5
decl_stmt|,
name|n6
decl_stmt|;
name|n2
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
literal|8
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|n1
operator|=
literal|0x01
operator|<<
name|i
expr_stmt|;
name|n2
operator|=
name|n2
operator||
name|n1
expr_stmt|;
name|n3
operator|=
operator|~
name|n1
expr_stmt|;
name|n4
operator|=
operator|~
name|n2
expr_stmt|;
name|n5
operator|=
operator|(
operator|-
literal|1
operator|)
operator|&
operator|~
operator|(
literal|0x3f
operator|<<
name|i
operator|)
expr_stmt|;
name|n6
operator|=
operator|(
operator|-
literal|1
operator|)
operator|&
operator|~
operator|(
literal|0x7f
operator|<<
name|i
operator|)
expr_stmt|;
name|test_one_int
argument_list|(
name|n1
argument_list|)
expr_stmt|;
name|test_one_int
argument_list|(
name|n2
argument_list|)
expr_stmt|;
name|test_one_int
argument_list|(
name|n3
argument_list|)
expr_stmt|;
name|test_one_int
argument_list|(
name|n4
argument_list|)
expr_stmt|;
name|test_one_int
argument_list|(
name|n5
argument_list|)
expr_stmt|;
name|test_one_int
argument_list|(
name|n6
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmp_unsigned
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|b
operator|-
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|a
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_unsigned
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x00"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x7f"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x00\x80"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x01\x00"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x02\x00"
block|}
block|,
block|{
name|NULL
block|,
literal|3
block|,
literal|"\x00\x80\x00"
block|}
block|,
block|{
name|NULL
block|,
literal|5
block|,
literal|"\x00\x80\x00\x00\x00"
block|}
block|,
block|{
name|NULL
block|,
literal|4
block|,
literal|"\x7f\xff\xff\xff"
block|}
block|}
decl_stmt|;
name|unsigned
name|int
name|values
index|[]
init|=
block|{
literal|0
block|,
literal|127
block|,
literal|128
block|,
literal|256
block|,
literal|512
block|,
literal|32768
block|,
literal|0x80000000
block|,
literal|0x7fffffff
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
block|{
name|tests
index|[
name|i
index|]
operator|.
name|val
operator|=
operator|&
name|values
index|[
name|i
index|]
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|,
literal|"unsigned %u"
argument_list|,
name|values
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
name|i
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_unsigned
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_unsigned
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_unsigned
argument_list|,
operator|(
name|generic_free
operator|)
name|NULL
argument_list|,
name|cmp_unsigned
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
name|free
argument_list|(
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmp_octet_string
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
name|heim_octet_string
modifier|*
name|oa
init|=
operator|(
name|heim_octet_string
operator|*
operator|)
name|a
decl_stmt|;
name|heim_octet_string
modifier|*
name|ob
init|=
operator|(
name|heim_octet_string
operator|*
operator|)
name|b
decl_stmt|;
if|if
condition|(
name|oa
operator|->
name|length
operator|!=
name|ob
operator|->
name|length
condition|)
return|return
name|ob
operator|->
name|length
operator|-
name|oa
operator|->
name|length
return|;
return|return
operator|(
name|memcmp
argument_list|(
name|oa
operator|->
name|data
argument_list|,
name|ob
operator|->
name|data
argument_list|,
name|oa
operator|->
name|length
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_octet_string
parameter_list|(
name|void
parameter_list|)
block|{
name|heim_octet_string
name|s1
init|=
block|{
literal|8
block|,
literal|"\x01\x23\x45\x67\x89\xab\xcd\xef"
block|}
decl_stmt|;
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|8
block|,
literal|"\x01\x23\x45\x67\x89\xab\xcd\xef"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|tests
index|[
literal|0
index|]
operator|.
name|val
operator|=
operator|&
name|s1
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
literal|0
index|]
operator|.
name|name
argument_list|,
literal|"a octet string"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
literal|0
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_octet_string
argument_list|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_octet_string
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_octet_string
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_octet_string
argument_list|,
operator|(
name|generic_free
operator|)
name|der_free_octet_string
argument_list|,
name|cmp_octet_string
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tests
index|[
literal|0
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmp_bmp_string
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
name|heim_bmp_string
modifier|*
name|oa
init|=
operator|(
name|heim_bmp_string
operator|*
operator|)
name|a
decl_stmt|;
name|heim_bmp_string
modifier|*
name|ob
init|=
operator|(
name|heim_bmp_string
operator|*
operator|)
name|b
decl_stmt|;
return|return
name|der_heim_bmp_string_cmp
argument_list|(
name|oa
argument_list|,
name|ob
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|uint16_t
name|bmp_d1
index|[]
init|=
block|{
literal|32
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|bmp_d2
index|[]
init|=
block|{
literal|32
block|,
literal|32
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|test_bmp_string
parameter_list|(
name|void
parameter_list|)
block|{
name|heim_bmp_string
name|s1
init|=
block|{
literal|1
block|,
name|bmp_d1
block|}
decl_stmt|;
name|heim_bmp_string
name|s2
init|=
block|{
literal|2
block|,
name|bmp_d2
block|}
decl_stmt|;
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x00\x20"
block|}
block|,
block|{
name|NULL
block|,
literal|4
block|,
literal|"\x00\x20\x00\x20"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|tests
index|[
literal|0
index|]
operator|.
name|val
operator|=
operator|&
name|s1
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
literal|0
index|]
operator|.
name|name
argument_list|,
literal|"a bmp string"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
literal|0
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
name|tests
index|[
literal|1
index|]
operator|.
name|val
operator|=
operator|&
name|s2
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
literal|1
index|]
operator|.
name|name
argument_list|,
literal|"second bmp string"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
literal|1
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_bmp_string
argument_list|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_bmp_string
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_bmp_string
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_bmp_string
argument_list|,
operator|(
name|generic_free
operator|)
name|der_free_bmp_string
argument_list|,
name|cmp_bmp_string
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tests
index|[
literal|0
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tests
index|[
literal|1
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmp_universal_string
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
name|heim_universal_string
modifier|*
name|oa
init|=
operator|(
name|heim_universal_string
operator|*
operator|)
name|a
decl_stmt|;
name|heim_universal_string
modifier|*
name|ob
init|=
operator|(
name|heim_universal_string
operator|*
operator|)
name|b
decl_stmt|;
return|return
name|der_heim_universal_string_cmp
argument_list|(
name|oa
argument_list|,
name|ob
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|uint32_t
name|universal_d1
index|[]
init|=
block|{
literal|32
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|universal_d2
index|[]
init|=
block|{
literal|32
block|,
literal|32
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|test_universal_string
parameter_list|(
name|void
parameter_list|)
block|{
name|heim_universal_string
name|s1
init|=
block|{
literal|1
block|,
name|universal_d1
block|}
decl_stmt|;
name|heim_universal_string
name|s2
init|=
block|{
literal|2
block|,
name|universal_d2
block|}
decl_stmt|;
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|4
block|,
literal|"\x00\x00\x00\x20"
block|}
block|,
block|{
name|NULL
block|,
literal|8
block|,
literal|"\x00\x00\x00\x20\x00\x00\x00\x20"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|tests
index|[
literal|0
index|]
operator|.
name|val
operator|=
operator|&
name|s1
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
literal|0
index|]
operator|.
name|name
argument_list|,
literal|"a universal string"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
literal|0
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
name|tests
index|[
literal|1
index|]
operator|.
name|val
operator|=
operator|&
name|s2
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
literal|1
index|]
operator|.
name|name
argument_list|,
literal|"second universal string"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
literal|1
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_universal_string
argument_list|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_universal_string
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_universal_string
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_universal_string
argument_list|,
operator|(
name|generic_free
operator|)
name|der_free_universal_string
argument_list|,
name|cmp_universal_string
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tests
index|[
literal|0
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tests
index|[
literal|1
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmp_general_string
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|sa
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|a
decl_stmt|;
name|char
modifier|*
modifier|*
name|sb
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|b
decl_stmt|;
return|return
name|strcmp
argument_list|(
operator|*
name|sa
argument_list|,
operator|*
name|sb
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_general_string
parameter_list|(
name|void
parameter_list|)
block|{
name|char
modifier|*
name|s1
init|=
literal|"Test User 1"
decl_stmt|;
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|11
block|,
literal|"\x54\x65\x73\x74\x20\x55\x73\x65\x72\x20\x31"
block|}
block|}
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
name|tests
index|[
literal|0
index|]
operator|.
name|val
operator|=
operator|&
name|s1
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
literal|0
index|]
operator|.
name|name
argument_list|,
literal|"the string \"%s\""
argument_list|,
name|s1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
literal|0
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_general_string
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_general_string
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_general_string
argument_list|,
operator|(
name|generic_free
operator|)
name|der_free_general_string
argument_list|,
name|cmp_general_string
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tests
index|[
literal|0
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmp_generalized_time
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
name|time_t
modifier|*
name|ta
init|=
operator|(
name|time_t
operator|*
operator|)
name|a
decl_stmt|;
name|time_t
modifier|*
name|tb
init|=
operator|(
name|time_t
operator|*
operator|)
name|b
decl_stmt|;
return|return
operator|*
name|tb
operator|-
operator|*
name|ta
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_generalized_time
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|15
block|,
literal|"19700101000000Z"
block|}
block|,
block|{
name|NULL
block|,
literal|15
block|,
literal|"19851106210627Z"
block|}
block|}
decl_stmt|;
name|time_t
name|values
index|[]
init|=
block|{
literal|0
block|,
literal|500159187
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
block|{
name|tests
index|[
name|i
index|]
operator|.
name|val
operator|=
operator|&
name|values
index|[
name|i
index|]
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|,
literal|"time %d"
argument_list|,
operator|(
name|int
operator|)
name|values
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
name|i
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|time_t
argument_list|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_generalized_time
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_generalized_time
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_generalized_time
argument_list|,
operator|(
name|generic_free
operator|)
name|NULL
argument_list|,
name|cmp_generalized_time
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
name|free
argument_list|(
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_cmp_oid
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
return|return
name|der_heim_oid_cmp
argument_list|(
operator|(
name|heim_oid
operator|*
operator|)
name|a
argument_list|,
operator|(
name|heim_oid
operator|*
operator|)
name|b
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|unsigned
name|oid_comp1
index|[]
init|=
block|{
literal|1
block|,
literal|1
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|oid_comp2
index|[]
init|=
block|{
literal|1
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|oid_comp3
index|[]
init|=
block|{
literal|6
block|,
literal|15
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|oid_comp4
index|[]
init|=
block|{
literal|6
block|,
literal|15
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|test_oid
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x29\x01"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x29"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\xff\x01"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\xff"
block|}
block|}
decl_stmt|;
name|heim_oid
name|values
index|[]
init|=
block|{
block|{
literal|3
block|,
name|oid_comp1
block|}
block|,
block|{
literal|2
block|,
name|oid_comp2
block|}
block|,
block|{
literal|3
block|,
name|oid_comp3
block|}
block|,
block|{
literal|2
block|,
name|oid_comp4
block|}
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
block|{
name|tests
index|[
name|i
index|]
operator|.
name|val
operator|=
operator|&
name|values
index|[
name|i
index|]
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|,
literal|"oid %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
name|i
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_oid
argument_list|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_oid
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_oid
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_oid
argument_list|,
operator|(
name|generic_free
operator|)
name|der_free_oid
argument_list|,
name|test_cmp_oid
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
name|free
argument_list|(
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_cmp_bit_string
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
return|return
name|der_heim_bit_string_cmp
argument_list|(
operator|(
name|heim_bit_string
operator|*
operator|)
name|a
argument_list|,
operator|(
name|heim_bit_string
operator|*
operator|)
name|b
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_bit_string
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x00"
block|}
block|}
decl_stmt|;
name|heim_bit_string
name|values
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|""
block|}
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
block|{
name|tests
index|[
name|i
index|]
operator|.
name|val
operator|=
operator|&
name|values
index|[
name|i
index|]
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|,
literal|"bit_string %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
name|i
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_bit_string
argument_list|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_bit_string
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_bit_string
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_bit_string
argument_list|,
operator|(
name|generic_free
operator|)
name|der_free_bit_string
argument_list|,
name|test_cmp_bit_string
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
name|free
argument_list|(
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_cmp_heim_integer
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
return|return
name|der_heim_integer_cmp
argument_list|(
operator|(
name|heim_integer
operator|*
operator|)
name|a
argument_list|,
operator|(
name|heim_integer
operator|*
operator|)
name|b
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_heim_integer
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|2
block|,
literal|"\xfe\x01"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\xef\x01"
block|}
block|,
block|{
name|NULL
block|,
literal|3
block|,
literal|"\xff\x00\xff"
block|}
block|,
block|{
name|NULL
block|,
literal|3
block|,
literal|"\xff\x01\x00"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x00"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x01"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x00\x80"
block|}
block|}
decl_stmt|;
name|heim_integer
name|values
index|[]
init|=
block|{
block|{
literal|2
block|,
literal|"\x01\xff"
block|,
literal|1
block|}
block|,
block|{
literal|2
block|,
literal|"\x10\xff"
block|,
literal|1
block|}
block|,
block|{
literal|2
block|,
literal|"\xff\x01"
block|,
literal|1
block|}
block|,
block|{
literal|2
block|,
literal|"\xff\x00"
block|,
literal|1
block|}
block|,
block|{
literal|0
block|,
literal|""
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|"\x01"
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|"\x80"
block|,
literal|0
block|}
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|tests
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|heim_integer
name|i2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
block|{
name|tests
index|[
name|i
index|]
operator|.
name|val
operator|=
operator|&
name|values
index|[
name|i
index|]
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|,
literal|"heim_integer %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
name|i
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_integer
argument_list|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_heim_integer
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_heim_integer
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_heim_integer
argument_list|,
operator|(
name|generic_free
operator|)
name|der_free_heim_integer
argument_list|,
name|test_cmp_heim_integer
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
name|free
argument_list|(
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* test zero length integer (BER format) */
name|ret
operator|=
name|der_get_heim_integer
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|i2
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"der_get_heim_integer"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2
operator|.
name|length
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"der_get_heim_integer wrong length"
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|i2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_cmp_boolean
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|!
operator|!
operator|*
operator|(
name|int
operator|*
operator|)
name|a
operator|!=
operator|!
operator|!
operator|*
operator|(
name|int
operator|*
operator|)
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_boolean
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|1
block|,
literal|"\xff"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x00"
block|}
block|}
decl_stmt|;
name|int
name|values
index|[]
init|=
block|{
literal|1
block|,
literal|0
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|tests
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|heim_integer
name|i2
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
block|{
name|tests
index|[
name|i
index|]
operator|.
name|val
operator|=
operator|&
name|values
index|[
name|i
index|]
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|,
literal|"heim_boolean %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|tests
index|[
name|i
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|generic_test
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
operator|(
name|generic_encode
operator|)
name|der_put_boolean
argument_list|,
operator|(
name|generic_length
operator|)
name|der_length_boolean
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_boolean
argument_list|,
operator|(
name|generic_free
operator|)
name|NULL
argument_list|,
name|test_cmp_boolean
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
operator|++
name|i
control|)
name|free
argument_list|(
name|tests
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* test zero length integer (BER format) */
name|ret
operator|=
name|der_get_heim_integer
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|i2
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"der_get_heim_integer"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2
operator|.
name|length
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"der_get_heim_integer wrong length"
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|i2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_unsigned
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
operator|+
literal|1
block|,
literal|"\x01\x01\x01\x01\x01\x01\x01\x01\x01"
block|,
literal|"data overrun"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
return|return
name|generic_decode_fail
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_unsigned
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_integer
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
literal|1
block|,
literal|"\x01\x01\x01\x01\x01\x01\x01\x01\x01"
block|,
literal|"data overrun"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
return|return
name|generic_decode_fail
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_integer
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_length
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|0
block|,
literal|""
block|,
literal|"empty input data"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x82"
block|,
literal|"internal length overrun"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
return|return
name|generic_decode_fail
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_length
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_boolean
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|0
block|,
literal|""
block|,
literal|"empty input data"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
return|return
name|generic_decode_fail
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_boolean
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_general_string
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|3
block|,
literal|"A\x00i"
block|,
literal|"NUL char in string"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
return|return
name|generic_decode_fail
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_general_string
argument_list|)
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_general_string
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_bmp_string
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x00"
block|,
literal|"odd (1) length bmpstring"
block|}
block|,
block|{
name|NULL
block|,
literal|3
block|,
literal|"\x00\x00\x00"
block|,
literal|"odd (3) length bmpstring"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
return|return
name|generic_decode_fail
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_bmp_string
argument_list|)
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_bmp_string
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_universal_string
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x00"
block|,
literal|"x& 3 == 1 universal string"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x00\x00"
block|,
literal|"x& 3 == 2 universal string"
block|}
block|,
block|{
name|NULL
block|,
literal|3
block|,
literal|"\x00\x00\x00"
block|,
literal|"x& 3 == 3 universal string"
block|}
block|,
block|{
name|NULL
block|,
literal|5
block|,
literal|"\x00\x00\x00\x00\x00"
block|,
literal|"x& 3 == 1 universal string"
block|}
block|,
block|{
name|NULL
block|,
literal|6
block|,
literal|"\x00\x00\x00\x00\x00\x00"
block|,
literal|"x& 3 == 2 universal string"
block|}
block|,
block|{
name|NULL
block|,
literal|7
block|,
literal|"\x00\x00\x00\x00\x00\x00\x00"
block|,
literal|"x& 3 == 3 universal string"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
return|return
name|generic_decode_fail
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_universal_string
argument_list|)
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_universal_string
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_heim_integer
parameter_list|(
name|void
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct test_case tests[] = {     };     int ntests = sizeof(tests) / sizeof(*tests);      return generic_decode_fail(tests, ntests, sizeof(heim_integer), 			       (generic_decode)der_get_heim_integer);
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_generalized_time
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x00"
block|,
literal|"no time"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
return|return
name|generic_decode_fail
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|time_t
argument_list|)
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_generalized_time
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_oid
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|0
block|,
literal|""
block|,
literal|"empty input data"
block|}
block|,
block|{
name|NULL
block|,
literal|2
block|,
literal|"\x00\x80"
block|,
literal|"last byte continuation"
block|}
block|,
block|{
name|NULL
block|,
literal|11
block|,
literal|"\x00\x81\x80\x80\x80\x80\x80\x80\x80\x80\x00"
block|,
literal|"oid element overflow"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
return|return
name|generic_decode_fail
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_oid
argument_list|)
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_oid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail_bitstring
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|test_case
name|tests
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|0
block|,
literal|""
block|,
literal|"empty input data"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x08"
block|,
literal|"larger then 8 bits trailer"
block|}
block|,
block|{
name|NULL
block|,
literal|1
block|,
literal|"\x01"
block|,
literal|"to few bytes for bits"
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|2
block|,
literal|"\x00"
block|,
literal|"length overrun"
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|,
literal|""
block|,
literal|"length to short"
block|}
block|}
decl_stmt|;
name|int
name|ntests
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tests
argument_list|)
decl_stmt|;
return|return
name|generic_decode_fail
argument_list|(
name|tests
argument_list|,
name|ntests
argument_list|,
sizeof|sizeof
argument_list|(
name|heim_bit_string
argument_list|)
argument_list|,
operator|(
name|generic_decode
operator|)
name|der_get_bit_string
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_heim_integer_same
parameter_list|(
specifier|const
name|char
modifier|*
name|p
parameter_list|,
specifier|const
name|char
modifier|*
name|norm_p
parameter_list|,
name|heim_integer
modifier|*
name|i
parameter_list|)
block|{
name|heim_integer
name|i2
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|der_print_hex_heim_integer
argument_list|(
name|i
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"der_print_hex_heim_integer: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|str
argument_list|,
name|norm_p
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"der_print_hex_heim_integer: %s != %s"
argument_list|,
name|str
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ret
operator|=
name|der_parse_hex_heim_integer
argument_list|(
name|str
argument_list|,
operator|&
name|i2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"der_parse_hex_heim_integer: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|der_heim_integer_cmp
argument_list|(
name|i
argument_list|,
operator|&
name|i2
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"der_heim_integer_cmp: p %s"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|i2
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|ret
operator|=
name|der_parse_hex_heim_integer
argument_list|(
name|p
argument_list|,
operator|&
name|i2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"der_parse_hex_heim_integer: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|der_heim_integer_cmp
argument_list|(
name|i
argument_list|,
operator|&
name|i2
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"der_heim_integer_cmp: norm"
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|i2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_heim_int_format
parameter_list|(
name|void
parameter_list|)
block|{
name|heim_integer
name|i
init|=
block|{
literal|1
block|,
literal|"\x10"
block|,
literal|0
block|}
decl_stmt|;
name|heim_integer
name|i2
init|=
block|{
literal|1
block|,
literal|"\x10"
block|,
literal|1
block|}
decl_stmt|;
name|heim_integer
name|i3
init|=
block|{
literal|1
block|,
literal|"\01"
block|,
literal|0
block|}
decl_stmt|;
name|char
modifier|*
name|p
init|=
literal|"FFFFFFFF"
literal|"FFFFFFFF"
literal|"C90FDAA2"
literal|"2168C234"
literal|"C4C6628B"
literal|"80DC1CD1"
literal|"29024E08"
literal|"8A67CC74"
literal|"020BBEA6"
literal|"3B139B22"
literal|"514A0879"
literal|"8E3404DD"
literal|"EF9519B3"
literal|"CD3A431B"
literal|"302B0A6D"
literal|"F25F1437"
literal|"4FE1356D"
literal|"6D51C245"
literal|"E485B576"
literal|"625E7EC6"
literal|"F44C42E9"
literal|"A637ED6B"
literal|"0BFF5CB6"
literal|"F406B7ED"
literal|"EE386BFB"
literal|"5A899FA5"
literal|"AE9F2411"
literal|"7C4B1FE6"
literal|"49286651"
literal|"ECE65381"
literal|"FFFFFFFF"
literal|"FFFFFFFF"
decl_stmt|;
name|heim_integer
name|bni
init|=
block|{
literal|128
block|,
literal|"\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xC9\x0F\xDA\xA2"
literal|"\x21\x68\xC2\x34\xC4\xC6\x62\x8B\x80\xDC\x1C\xD1"
literal|"\x29\x02\x4E\x08\x8A\x67\xCC\x74\x02\x0B\xBE\xA6"
literal|"\x3B\x13\x9B\x22\x51\x4A\x08\x79\x8E\x34\x04\xDD"
literal|"\xEF\x95\x19\xB3\xCD\x3A\x43\x1B\x30\x2B\x0A\x6D"
literal|"\xF2\x5F\x14\x37\x4F\xE1\x35\x6D\x6D\x51\xC2\x45"
literal|"\xE4\x85\xB5\x76\x62\x5E\x7E\xC6\xF4\x4C\x42\xE9"
literal|"\xA6\x37\xED\x6B\x0B\xFF\x5C\xB6\xF4\x06\xB7\xED"
literal|"\xEE\x38\x6B\xFB\x5A\x89\x9F\xA5\xAE\x9F\x24\x11"
literal|"\x7C\x4B\x1F\xE6\x49\x28\x66\x51\xEC\xE6\x53\x81"
literal|"\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF"
block|,
literal|0
block|}
decl_stmt|;
name|heim_integer
name|f
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ret
operator|+=
name|check_heim_integer_same
argument_list|(
name|p
argument_list|,
name|p
argument_list|,
operator|&
name|bni
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|check_heim_integer_same
argument_list|(
literal|"10"
argument_list|,
literal|"10"
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|check_heim_integer_same
argument_list|(
literal|"00000010"
argument_list|,
literal|"10"
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|check_heim_integer_same
argument_list|(
literal|"-10"
argument_list|,
literal|"-10"
argument_list|,
operator|&
name|i2
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|check_heim_integer_same
argument_list|(
literal|"-00000010"
argument_list|,
literal|"-10"
argument_list|,
operator|&
name|i2
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|check_heim_integer_same
argument_list|(
literal|"01"
argument_list|,
literal|"01"
argument_list|,
operator|&
name|i3
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|check_heim_integer_same
argument_list|(
literal|"1"
argument_list|,
literal|"01"
argument_list|,
operator|&
name|i3
argument_list|)
expr_stmt|;
block|{
name|int
name|r
decl_stmt|;
name|r
operator|=
name|der_parse_hex_heim_integer
argument_list|(
literal|"-"
argument_list|,
operator|&
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
literal|0
condition|)
block|{
name|der_free_heim_integer
argument_list|(
operator|&
name|f
argument_list|)
expr_stmt|;
name|ret
operator|++
expr_stmt|;
block|}
comment|/* used to cause UMR */
name|r
operator|=
name|der_parse_hex_heim_integer
argument_list|(
literal|"00"
argument_list|,
operator|&
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
literal|0
condition|)
name|der_free_heim_integer
argument_list|(
operator|&
name|f
argument_list|)
expr_stmt|;
else|else
name|ret
operator|++
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_heim_oid_format_same
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
specifier|const
name|heim_oid
modifier|*
name|oid
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|heim_oid
name|o2
decl_stmt|;
name|ret
operator|=
name|der_print_heim_oid
argument_list|(
name|oid
argument_list|,
literal|' '
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"fail to print oid: %s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|ret
operator|=
name|strcmp
argument_list|(
name|p
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"oid %s != formated oid %s\n"
argument_list|,
name|str
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|der_parse_heim_oid
argument_list|(
name|p
argument_list|,
literal|" "
argument_list|,
operator|&
name|o2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"failed to parse %s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ret
operator|=
name|der_heim_oid_cmp
argument_list|(
operator|&
name|o2
argument_list|,
name|oid
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|o2
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|unsigned
name|sha1_oid_tree
index|[]
init|=
block|{
literal|1
block|,
literal|3
block|,
literal|14
block|,
literal|3
block|,
literal|2
block|,
literal|26
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|test_heim_oid_format
parameter_list|(
name|void
parameter_list|)
block|{
name|heim_oid
name|sha1
init|=
block|{
literal|6
block|,
name|sha1_oid_tree
block|}
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ret
operator|+=
name|test_heim_oid_format_same
argument_list|(
literal|"1 3 14 3 2 26"
argument_list|,
operator|&
name|sha1
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_trailing_nul
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
struct|struct
block|{
name|int
name|fail
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
specifier|const
name|char
modifier|*
name|s
decl_stmt|;
name|size_t
name|size
decl_stmt|;
block|}
name|foo
index|[]
init|=
block|{
block|{
literal|1
block|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
literal|"foo\x00o"
block|,
literal|5
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
literal|"\x00o"
block|,
literal|2
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
literal|"\x00\x00\x00\x00\x00"
block|,
literal|5
block|,
literal|""
block|,
literal|5
block|}
block|,
block|{
literal|0
block|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
literal|"\x00"
block|,
literal|1
block|,
literal|""
block|,
literal|1
block|}
block|,
block|{
literal|0
block|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
literal|""
block|,
literal|0
block|,
literal|""
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
literal|"foo\x00\x00"
block|,
literal|5
block|,
literal|"foo"
block|,
literal|5
block|}
block|,
block|{
literal|0
block|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
literal|"foo\0"
block|,
literal|4
block|,
literal|"foo"
block|,
literal|4
block|}
block|,
block|{
literal|0
block|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
literal|"foo"
block|,
literal|3
block|,
literal|"foo"
block|,
literal|3
block|}
block|}
struct|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|foo
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|foo
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ret
operator|=
name|der_get_general_string
argument_list|(
name|foo
index|[
name|i
index|]
operator|.
name|p
argument_list|,
name|foo
index|[
name|i
index|]
operator|.
name|len
argument_list|,
operator|&
name|s
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|foo
index|[
name|i
index|]
operator|.
name|fail
condition|)
block|{
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"check %d NULL didn't fail"
argument_list|,
name|i
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"NULL check %d der_get_general_string failed"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|foo
index|[
name|i
index|]
operator|.
name|size
operator|!=
name|size
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"NUL check i = %d size failed"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|foo
index|[
name|i
index|]
operator|.
name|s
argument_list|,
name|s
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"NUL check i = %d content failed"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_misc_cmp
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
comment|/* diffrent lengths are diffrent */
block|{
specifier|const
name|heim_octet_string
name|os1
init|=
block|{
literal|1
block|,
literal|"a"
block|}
decl_stmt|,
name|os2
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
name|ret
operator|=
name|der_heim_octet_string_cmp
argument_list|(
operator|&
name|os1
argument_list|,
operator|&
name|os2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
comment|/* diffrent data are diffrent */
block|{
specifier|const
name|heim_octet_string
name|os1
init|=
block|{
literal|1
block|,
literal|"a"
block|}
decl_stmt|,
name|os2
init|=
block|{
literal|1
block|,
literal|"b"
block|}
decl_stmt|;
name|ret
operator|=
name|der_heim_octet_string_cmp
argument_list|(
operator|&
name|os1
argument_list|,
operator|&
name|os2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
comment|/* diffrent lengths are diffrent */
block|{
specifier|const
name|heim_bit_string
name|bs1
init|=
block|{
literal|8
block|,
literal|"a"
block|}
decl_stmt|,
name|bs2
init|=
block|{
literal|7
block|,
literal|"a"
block|}
decl_stmt|;
name|ret
operator|=
name|der_heim_bit_string_cmp
argument_list|(
operator|&
name|bs1
argument_list|,
operator|&
name|bs2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
comment|/* diffrent data are diffrent */
block|{
specifier|const
name|heim_bit_string
name|bs1
init|=
block|{
literal|7
block|,
literal|"\x0f"
block|}
decl_stmt|,
name|bs2
init|=
block|{
literal|7
block|,
literal|"\x02"
block|}
decl_stmt|;
name|ret
operator|=
name|der_heim_bit_string_cmp
argument_list|(
operator|&
name|bs1
argument_list|,
operator|&
name|bs2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
comment|/* diffrent lengths are diffrent */
block|{
name|uint16_t
name|data
init|=
literal|1
decl_stmt|;
name|heim_bmp_string
name|bs1
init|=
block|{
literal|1
block|,
name|NULL
block|}
decl_stmt|,
name|bs2
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
name|bs1
operator|.
name|data
operator|=
operator|&
name|data
expr_stmt|;
name|ret
operator|=
name|der_heim_bmp_string_cmp
argument_list|(
operator|&
name|bs1
argument_list|,
operator|&
name|bs2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
comment|/* diffrent lengths are diffrent */
block|{
name|uint32_t
name|data
decl_stmt|;
name|heim_universal_string
name|us1
init|=
block|{
literal|1
block|,
name|NULL
block|}
decl_stmt|,
name|us2
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
name|us1
operator|.
name|data
operator|=
operator|&
name|data
expr_stmt|;
name|ret
operator|=
name|der_heim_universal_string_cmp
argument_list|(
operator|&
name|us1
argument_list|,
operator|&
name|us2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
comment|/* same */
block|{
name|uint32_t
name|data
init|=
operator|(
name|uint32_t
operator|)
literal|'a'
decl_stmt|;
name|heim_universal_string
name|us1
init|=
block|{
literal|1
block|,
name|NULL
block|}
decl_stmt|,
name|us2
init|=
block|{
literal|1
block|,
name|NULL
block|}
decl_stmt|;
name|us1
operator|.
name|data
operator|=
operator|&
name|data
expr_stmt|;
name|us2
operator|.
name|data
operator|=
operator|&
name|data
expr_stmt|;
name|ret
operator|=
name|der_heim_universal_string_cmp
argument_list|(
operator|&
name|us1
argument_list|,
operator|&
name|us2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|corner_generalized_time
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
init|=
literal|"760520140000Z"
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|time_t
name|t
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|der_get_generalized_time
argument_list|(
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|,
operator|&
name|t
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|corner_tag
parameter_list|(
name|void
parameter_list|)
block|{
struct|struct
block|{
name|int
name|ok
decl_stmt|;
specifier|const
name|char
modifier|*
name|ptr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
block|}
name|tests
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|"\x00"
block|,
literal|1
block|}
block|,
block|{
literal|0
block|,
literal|"\xff"
block|,
literal|1
block|}
block|,
block|{
literal|0
block|,
literal|"\xff\xff\xff\xff\xff\xff\xff\xff"
block|,
literal|8
block|}
block|}
struct|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|Der_class
name|cl
decl_stmt|;
name|Der_type
name|ty
decl_stmt|;
name|unsigned
name|int
name|tag
decl_stmt|;
name|size_t
name|size
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|tests
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|der_get_tag
argument_list|(
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|tests
index|[
name|i
index|]
operator|.
name|ptr
argument_list|,
name|tests
index|[
name|i
index|]
operator|.
name|len
argument_list|,
operator|&
name|cl
argument_list|,
operator|&
name|ty
argument_list|,
operator|&
name|tag
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|tests
index|[
name|i
index|]
operator|.
name|ok
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"failed while shouldn't"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|tests
index|[
name|i
index|]
operator|.
name|ok
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"passed while shouldn't"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ret
operator|+=
name|test_integer
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_integer_more
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_unsigned
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_octet_string
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_bmp_string
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_universal_string
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_general_string
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_generalized_time
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_oid
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_bit_string
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_heim_integer
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_boolean
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_unsigned
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_integer
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_length
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_boolean
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_general_string
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_bmp_string
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_universal_string
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_heim_integer
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_generalized_time
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_oid
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_fail_bitstring
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_heim_int_format
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_heim_oid_format
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|check_trailing_nul
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|test_misc_cmp
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|corner_generalized_time
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|corner_tag
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


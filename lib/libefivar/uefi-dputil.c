begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2017 Netflix, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer  *    in this position and unchanged.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Routines to format EFI_DEVICE_PATHs from the UEFI standard. Much of  * this file is taken from EDK2 and rototilled.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<efivar.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|"efi-osdep.h"
end_include

begin_include
include|#
directive|include
file|"uefi-dplib.h"
end_include

begin_comment
comment|/* XXX maybe I should include the entire DevicePathUtiltiies.c and ifdef out what we don't use */
end_comment

begin_comment
comment|/*  * Taken from MdePkg/Library/UefiDevicePathLib/DevicePathUtilities.c  * hash a11928f3310518ab1c6fd34e8d0fdbb72de9602c 2017-Mar-01  */
end_comment

begin_comment
comment|/** @file   Device Path services. The thing to remember is device paths are built out of   nodes. The device path is terminated by an end node that is length   sizeof(EFI_DEVICE_PATH_PROTOCOL). That would be why there is sizeof(EFI_DEVICE_PATH_PROTOCOL)   all over this file.    The only place where multi-instance device paths are supported is in   environment varibles. Multi-instance device paths should never be placed   on a Handle.    Copyright (c) 2006 - 2016, Intel Corporation. All rights reserved.<BR>   This program and the accompanying materials   are licensed and made available under the terms and conditions of the BSD License   which accompanies this distribution.  The full text of the license may be found at   http://opensource.org/licenses/bsd-license.php.    THE PROGRAM IS DISTRIBUTED UNDER THE BSD LICENSE ON AN "AS IS" BASIS,   WITHOUT WARRANTIES OR REPRESENTATIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED.  **/
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Template for an end-of-device path node.
end_comment

begin_comment
comment|//
end_comment

begin_decl_stmt
specifier|static
name|CONST
name|EFI_DEVICE_PATH_PROTOCOL
name|mUefiDevicePathLibEndDevicePath
init|=
block|{
name|END_DEVICE_PATH_TYPE
block|,
name|END_ENTIRE_DEVICE_PATH_SUBTYPE
block|,
block|{
name|END_DEVICE_PATH_LENGTH
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**   Returns the size of a device path in bytes.    This function returns the size, in bytes, of the device path data structure   specified by DevicePath including the end of device path node.   If DevicePath is NULL or invalid, then 0 is returned.    @param  DevicePath  A pointer to a device path data structure.    @retval 0           If DevicePath is NULL or invalid.   @retval Others      The size of a device path in bytes.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|GetDevicePathSize
parameter_list|(
name|IN
name|CONST
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|DevicePath
parameter_list|)
block|{
name|CONST
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|Start
decl_stmt|;
if|if
condition|(
name|DevicePath
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|IsDevicePathValid
argument_list|(
name|DevicePath
argument_list|,
literal|0
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|//
comment|// Search for the end of the device path structure
comment|//
name|Start
operator|=
name|DevicePath
expr_stmt|;
while|while
condition|(
operator|!
name|IsDevicePathEnd
argument_list|(
name|DevicePath
argument_list|)
condition|)
block|{
name|DevicePath
operator|=
name|NextDevicePathNode
argument_list|(
name|DevicePath
argument_list|)
expr_stmt|;
block|}
comment|//
comment|// Compute the size and add back in the size of the end device path structure
comment|//
return|return
operator|(
operator|(
name|UINTN
operator|)
name|DevicePath
operator|-
operator|(
name|UINTN
operator|)
name|Start
operator|)
operator|+
name|DevicePathNodeLength
argument_list|(
name|DevicePath
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Determine whether a given device path is valid.   If DevicePath is NULL, then ASSERT().    @param  DevicePath  A pointer to a device path data structure.   @param  MaxSize     The maximum size of the device path data structure.    @retval TRUE        DevicePath is valid.   @retval FALSE       The length of any node node in the DevicePath is less                       than sizeof (EFI_DEVICE_PATH_PROTOCOL).   @retval FALSE       If MaxSize is not zero, the size of the DevicePath                       exceeds MaxSize.   @retval FALSE       If PcdMaximumDevicePathNodeCount is not zero, the node                       count of the DevicePath exceeds PcdMaximumDevicePathNodeCount. **/
end_comment

begin_function
name|BOOLEAN
name|EFIAPI
name|IsDevicePathValid
parameter_list|(
name|IN
name|CONST
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|DevicePath
parameter_list|,
name|IN
name|UINTN
name|MaxSize
parameter_list|)
block|{
name|UINTN
name|Count
decl_stmt|;
name|UINTN
name|Size
decl_stmt|;
name|UINTN
name|NodeLength
decl_stmt|;
name|ASSERT
argument_list|(
name|DevicePath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|MaxSize
operator|==
literal|0
condition|)
block|{
name|MaxSize
operator|=
name|MAX_UINTN
expr_stmt|;
block|}
comment|//
comment|// Validate the input size big enough to touch the first node.
comment|//
if|if
condition|(
name|MaxSize
operator|<
sizeof|sizeof
argument_list|(
name|EFI_DEVICE_PATH_PROTOCOL
argument_list|)
condition|)
block|{
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|Count
operator|=
literal|0
operator|,
name|Size
operator|=
literal|0
init|;
operator|!
name|IsDevicePathEnd
argument_list|(
name|DevicePath
argument_list|)
condition|;
name|DevicePath
operator|=
name|NextDevicePathNode
argument_list|(
name|DevicePath
argument_list|)
control|)
block|{
name|NodeLength
operator|=
name|DevicePathNodeLength
argument_list|(
name|DevicePath
argument_list|)
expr_stmt|;
if|if
condition|(
name|NodeLength
operator|<
sizeof|sizeof
argument_list|(
name|EFI_DEVICE_PATH_PROTOCOL
argument_list|)
condition|)
block|{
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|NodeLength
operator|>
name|MAX_UINTN
operator|-
name|Size
condition|)
block|{
return|return
name|FALSE
return|;
block|}
name|Size
operator|+=
name|NodeLength
expr_stmt|;
comment|//
comment|// Validate next node before touch it.
comment|//
if|if
condition|(
name|Size
operator|>
name|MaxSize
operator|-
name|END_DEVICE_PATH_LENGTH
condition|)
block|{
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|PcdGet32
argument_list|(
name|PcdMaximumDevicePathNodeCount
argument_list|)
operator|>
literal|0
condition|)
block|{
name|Count
operator|++
expr_stmt|;
if|if
condition|(
name|Count
operator|>=
name|PcdGet32
argument_list|(
name|PcdMaximumDevicePathNodeCount
argument_list|)
condition|)
block|{
return|return
name|FALSE
return|;
block|}
block|}
block|}
comment|//
comment|// Only return TRUE when the End Device Path node is valid.
comment|//
return|return
call|(
name|BOOLEAN
call|)
argument_list|(
name|DevicePathNodeLength
argument_list|(
name|DevicePath
argument_list|)
operator|==
name|END_DEVICE_PATH_LENGTH
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Returns the Type field of a device path node.    Returns the Type field of the device path node specified by Node.    If Node is NULL, then ASSERT().    @param  Node      A pointer to a device path node data structure.    @return The Type field of the device path node specified by Node.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|DevicePathType
parameter_list|(
name|IN
name|CONST
name|VOID
modifier|*
name|Node
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|Node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
specifier|const
name|EFI_DEVICE_PATH_PROTOCOL
operator|*
operator|)
operator|(
name|Node
operator|)
operator|)
operator|->
name|Type
return|;
block|}
end_function

begin_comment
comment|/**   Returns the SubType field of a device path node.    Returns the SubType field of the device path node specified by Node.    If Node is NULL, then ASSERT().    @param  Node      A pointer to a device path node data structure.    @return The SubType field of the device path node specified by Node.  **/
end_comment

begin_function
name|UINT8
name|EFIAPI
name|DevicePathSubType
parameter_list|(
name|IN
name|CONST
name|VOID
modifier|*
name|Node
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|Node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
specifier|const
name|EFI_DEVICE_PATH_PROTOCOL
operator|*
operator|)
operator|(
name|Node
operator|)
operator|)
operator|->
name|SubType
return|;
block|}
end_function

begin_comment
comment|/**   Returns the 16-bit Length field of a device path node.    Returns the 16-bit Length field of the device path node specified by Node.   Node is not required to be aligned on a 16-bit boundary, so it is recommended   that a function such as ReadUnaligned16() be used to extract the contents of   the Length field.    If Node is NULL, then ASSERT().    @param  Node      A pointer to a device path node data structure.    @return The 16-bit Length field of the device path node specified by Node.  **/
end_comment

begin_function
name|UINTN
name|EFIAPI
name|DevicePathNodeLength
parameter_list|(
name|IN
name|CONST
name|VOID
modifier|*
name|Node
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|Node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
specifier|const
name|EFI_DEVICE_PATH_PROTOCOL
operator|*
operator|)
name|Node
operator|)
operator|->
name|Length
index|[
literal|0
index|]
operator||
operator|(
operator|(
operator|(
specifier|const
name|EFI_DEVICE_PATH_PROTOCOL
operator|*
operator|)
name|Node
operator|)
operator|->
name|Length
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
return|;
block|}
end_function

begin_comment
comment|/**   Returns a pointer to the next node in a device path.    Returns a pointer to the device path node that follows the device path node   specified by Node.    If Node is NULL, then ASSERT().    @param  Node      A pointer to a device path node data structure.    @return a pointer to the device path node that follows the device path node   specified by Node.  **/
end_comment

begin_function
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|EFIAPI
name|NextDevicePathNode
parameter_list|(
name|IN
name|CONST
name|VOID
modifier|*
name|Node
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|Node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|EFI_DEVICE_PATH_PROTOCOL
operator|*
operator|)
operator|(
name|__DECONST
argument_list|(
name|UINT8
operator|*
argument_list|,
name|Node
argument_list|)
operator|+
name|DevicePathNodeLength
argument_list|(
name|Node
argument_list|)
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/**   Determines if a device path node is an end node of a device path.   This includes nodes that are the end of a device path instance and nodes that   are the end of an entire device path.    Determines if the device path node specified by Node is an end node of a device path.   This includes nodes that are the end of a device path instance and nodes that are the   end of an entire device path.  If Node represents an end node of a device path,   then TRUE is returned.  Otherwise, FALSE is returned.    If Node is NULL, then ASSERT().    @param  Node      A pointer to a device path node data structure.    @retval TRUE      The device path node specified by Node is an end node of a                     device path.   @retval FALSE     The device path node specified by Node is not an end node of                     a device path.  **/
end_comment

begin_function
name|BOOLEAN
name|EFIAPI
name|IsDevicePathEndType
parameter_list|(
name|IN
name|CONST
name|VOID
modifier|*
name|Node
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|Node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
call|(
name|BOOLEAN
call|)
argument_list|(
name|DevicePathType
argument_list|(
name|Node
argument_list|)
operator|==
name|END_DEVICE_PATH_TYPE
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Determines if a device path node is an end node of an entire device path.    Determines if a device path node specified by Node is an end node of an entire   device path. If Node represents the end of an entire device path, then TRUE is   returned.  Otherwise, FALSE is returned.    If Node is NULL, then ASSERT().    @param  Node      A pointer to a device path node data structure.    @retval TRUE      The device path node specified by Node is the end of an entire                     device path.   @retval FALSE     The device path node specified by Node is not the end of an                     entire device path.  **/
end_comment

begin_function
name|BOOLEAN
name|EFIAPI
name|IsDevicePathEnd
parameter_list|(
name|IN
name|CONST
name|VOID
modifier|*
name|Node
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|Node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
call|(
name|BOOLEAN
call|)
argument_list|(
name|IsDevicePathEndType
argument_list|(
name|Node
argument_list|)
operator|&&
name|DevicePathSubType
argument_list|(
name|Node
argument_list|)
operator|==
name|END_ENTIRE_DEVICE_PATH_SUBTYPE
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Fills in all the fields of a device path node that is the end of an entire device path.    Fills in all the fields of a device path node specified by Node so Node represents   the end of an entire device path.  The Type field of Node is set to   END_DEVICE_PATH_TYPE, the SubType field of Node is set to   END_ENTIRE_DEVICE_PATH_SUBTYPE, and the Length field of Node is set to   END_DEVICE_PATH_LENGTH.  Node is not required to be aligned on a 16-bit boundary,   so it is recommended that a function such as WriteUnaligned16() be used to set   the contents of the Length field.    If Node is NULL, then ASSERT().    @param  Node      A pointer to a device path node data structure.  **/
end_comment

begin_function
name|VOID
name|EFIAPI
name|SetDevicePathEndNode
parameter_list|(
name|OUT
name|VOID
modifier|*
name|Node
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|Node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|Node
argument_list|,
operator|&
name|mUefiDevicePathLibEndDevicePath
argument_list|,
sizeof|sizeof
argument_list|(
name|mUefiDevicePathLibEndDevicePath
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**   Sets the length, in bytes, of a device path node.    Sets the length of the device path node specified by Node to the value specified   by NodeLength.  NodeLength is returned.  Node is not required to be aligned on   a 16-bit boundary, so it is recommended that a function such as WriteUnaligned16()   be used to set the contents of the Length field.    If Node is NULL, then ASSERT().   If NodeLength>= SIZE_64KB, then ASSERT().   If NodeLength< sizeof (EFI_DEVICE_PATH_PROTOCOL), then ASSERT().    @param  Node      A pointer to a device path node data structure.   @param  Length    The length, in bytes, of the device path node.    @return Length  **/
end_comment

begin_function
name|UINT16
name|EFIAPI
name|SetDevicePathNodeLength
parameter_list|(
name|IN
name|OUT
name|VOID
modifier|*
name|Node
parameter_list|,
name|IN
name|UINTN
name|Length
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|Node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|(
name|Length
operator|>=
sizeof|sizeof
argument_list|(
name|EFI_DEVICE_PATH_PROTOCOL
argument_list|)
operator|)
operator|&&
operator|(
name|Length
operator|<
name|SIZE_64KB
operator|)
argument_list|)
expr_stmt|;
comment|//  return WriteUnaligned16 ((UINT16 *)&((EFI_DEVICE_PATH_PROTOCOL *)(Node))->Length[0], (UINT16)(Length));
name|le16enc
argument_list|(
operator|&
operator|(
operator|(
name|EFI_DEVICE_PATH_PROTOCOL
operator|*
operator|)
operator|(
name|Node
operator|)
operator|)
operator|->
name|Length
index|[
literal|0
index|]
argument_list|,
call|(
name|UINT16
call|)
argument_list|(
name|Length
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|Length
return|;
block|}
end_function

begin_comment
comment|/**   Creates a device node.    This function creates a new device node in a newly allocated buffer of size   NodeLength and initializes the device path node header with NodeType and NodeSubType.   The new device path node is returned.   If NodeLength is smaller than a device path header, then NULL is returned.   If there is not enough memory to allocate space for the new device path, then   NULL is returned.   The memory is allocated from EFI boot services memory. It is the responsibility   of the caller to free the memory allocated.    @param  NodeType                   The device node type for the new device node.   @param  NodeSubType                The device node sub-type for the new device node.   @param  NodeLength                 The length of the new device node.    @return The new device path.  **/
end_comment

begin_function
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|EFIAPI
name|CreateDeviceNode
parameter_list|(
name|IN
name|UINT8
name|NodeType
parameter_list|,
name|IN
name|UINT8
name|NodeSubType
parameter_list|,
name|IN
name|UINT16
name|NodeLength
parameter_list|)
block|{
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|DevicePath
decl_stmt|;
if|if
condition|(
name|NodeLength
operator|<
sizeof|sizeof
argument_list|(
name|EFI_DEVICE_PATH_PROTOCOL
argument_list|)
condition|)
block|{
comment|//
comment|// NodeLength is less than the size of the header.
comment|//
return|return
name|NULL
return|;
block|}
name|DevicePath
operator|=
name|AllocateZeroPool
argument_list|(
name|NodeLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|DevicePath
operator|!=
name|NULL
condition|)
block|{
name|DevicePath
operator|->
name|Type
operator|=
name|NodeType
expr_stmt|;
name|DevicePath
operator|->
name|SubType
operator|=
name|NodeSubType
expr_stmt|;
name|SetDevicePathNodeLength
argument_list|(
name|DevicePath
argument_list|,
name|NodeLength
argument_list|)
expr_stmt|;
block|}
return|return
name|DevicePath
return|;
block|}
end_function

begin_comment
comment|/**   Creates a new copy of an existing device path.    This function allocates space for a new copy of the device path specified by DevicePath.   If DevicePath is NULL, then NULL is returned.  If the memory is successfully   allocated, then the contents of DevicePath are copied to the newly allocated   buffer, and a pointer to that buffer is returned.  Otherwise, NULL is returned.   The memory for the new device path is allocated from EFI boot services memory.   It is the responsibility of the caller to free the memory allocated.    @param  DevicePath    A pointer to a device path data structure.    @retval NULL          DevicePath is NULL or invalid.   @retval Others        A pointer to the duplicated device path.  **/
end_comment

begin_function
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|EFIAPI
name|DuplicateDevicePath
parameter_list|(
name|IN
name|CONST
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|DevicePath
parameter_list|)
block|{
name|UINTN
name|Size
decl_stmt|;
comment|//
comment|// Compute the size
comment|//
name|Size
operator|=
name|GetDevicePathSize
argument_list|(
name|DevicePath
argument_list|)
expr_stmt|;
if|if
condition|(
name|Size
operator|==
literal|0
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|//
comment|// Allocate space for duplicate device path
comment|//
return|return
name|AllocateCopyPool
argument_list|(
name|Size
argument_list|,
name|DevicePath
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**   Creates a new device path by appending a second device path to a first device path.    This function creates a new device path by appending a copy of SecondDevicePath   to a copy of FirstDevicePath in a newly allocated buffer.  Only the end-of-device-path   device node from SecondDevicePath is retained. The newly created device path is   returned. If FirstDevicePath is NULL, then it is ignored, and a duplicate of   SecondDevicePath is returned.  If SecondDevicePath is NULL, then it is ignored,   and a duplicate of FirstDevicePath is returned. If both FirstDevicePath and   SecondDevicePath are NULL, then a copy of an end-of-device-path is returned.    If there is not enough memory for the newly allocated buffer, then NULL is returned.   The memory for the new device path is allocated from EFI boot services memory.   It is the responsibility of the caller to free the memory allocated.    @param  FirstDevicePath            A pointer to a device path data structure.   @param  SecondDevicePath           A pointer to a device path data structure.    @retval NULL      If there is not enough memory for the newly allocated buffer.   @retval NULL      If FirstDevicePath or SecondDevicePath is invalid.   @retval Others    A pointer to the new device path if success.                     Or a copy an end-of-device-path if both FirstDevicePath and SecondDevicePath are NULL.  **/
end_comment

begin_function
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|EFIAPI
name|AppendDevicePath
parameter_list|(
name|IN
name|CONST
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|FirstDevicePath
parameter_list|,
name|OPTIONAL
name|IN
name|CONST
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|SecondDevicePath
name|OPTIONAL
parameter_list|)
block|{
name|UINTN
name|Size
decl_stmt|;
name|UINTN
name|Size1
decl_stmt|;
name|UINTN
name|Size2
decl_stmt|;
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|NewDevicePath
decl_stmt|;
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|DevicePath2
decl_stmt|;
comment|//
comment|// If there's only 1 path, just duplicate it.
comment|//
if|if
condition|(
name|FirstDevicePath
operator|==
name|NULL
condition|)
block|{
return|return
name|DuplicateDevicePath
argument_list|(
operator|(
name|SecondDevicePath
operator|!=
name|NULL
operator|)
condition|?
name|SecondDevicePath
else|:
operator|&
name|mUefiDevicePathLibEndDevicePath
argument_list|)
return|;
block|}
if|if
condition|(
name|SecondDevicePath
operator|==
name|NULL
condition|)
block|{
return|return
name|DuplicateDevicePath
argument_list|(
name|FirstDevicePath
argument_list|)
return|;
block|}
if|if
condition|(
operator|!
name|IsDevicePathValid
argument_list|(
name|FirstDevicePath
argument_list|,
literal|0
argument_list|)
operator|||
operator|!
name|IsDevicePathValid
argument_list|(
name|SecondDevicePath
argument_list|,
literal|0
argument_list|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|//
comment|// Allocate space for the combined device path. It only has one end node of
comment|// length EFI_DEVICE_PATH_PROTOCOL.
comment|//
name|Size1
operator|=
name|GetDevicePathSize
argument_list|(
name|FirstDevicePath
argument_list|)
expr_stmt|;
name|Size2
operator|=
name|GetDevicePathSize
argument_list|(
name|SecondDevicePath
argument_list|)
expr_stmt|;
name|Size
operator|=
name|Size1
operator|+
name|Size2
operator|-
name|END_DEVICE_PATH_LENGTH
expr_stmt|;
name|NewDevicePath
operator|=
name|AllocatePool
argument_list|(
name|Size
argument_list|)
expr_stmt|;
if|if
condition|(
name|NewDevicePath
operator|!=
name|NULL
condition|)
block|{
name|NewDevicePath
operator|=
name|CopyMem
argument_list|(
name|NewDevicePath
argument_list|,
name|FirstDevicePath
argument_list|,
name|Size1
argument_list|)
expr_stmt|;
comment|//
comment|// Over write FirstDevicePath EndNode and do the copy
comment|//
name|DevicePath2
operator|=
operator|(
name|EFI_DEVICE_PATH_PROTOCOL
operator|*
operator|)
operator|(
operator|(
name|CHAR8
operator|*
operator|)
name|NewDevicePath
operator|+
operator|(
name|Size1
operator|-
name|END_DEVICE_PATH_LENGTH
operator|)
operator|)
expr_stmt|;
name|CopyMem
argument_list|(
name|DevicePath2
argument_list|,
name|SecondDevicePath
argument_list|,
name|Size2
argument_list|)
expr_stmt|;
block|}
return|return
name|NewDevicePath
return|;
block|}
end_function

begin_comment
comment|/**   Creates a new path by appending the device node to the device path.    This function creates a new device path by appending a copy of the device node   specified by DevicePathNode to a copy of the device path specified by DevicePath   in an allocated buffer. The end-of-device-path device node is moved after the   end of the appended device node.   If DevicePathNode is NULL then a copy of DevicePath is returned.   If DevicePath is NULL then a copy of DevicePathNode, followed by an end-of-device   path device node is returned.   If both DevicePathNode and DevicePath are NULL then a copy of an end-of-device-path   device node is returned.   If there is not enough memory to allocate space for the new device path, then   NULL is returned.   The memory is allocated from EFI boot services memory. It is the responsibility   of the caller to free the memory allocated.    @param  DevicePath                 A pointer to a device path data structure.   @param  DevicePathNode             A pointer to a single device path node.    @retval NULL      If there is not enough memory for the new device path.   @retval Others    A pointer to the new device path if success.                     A copy of DevicePathNode followed by an end-of-device-path node                     if both FirstDevicePath and SecondDevicePath are NULL.                     A copy of an end-of-device-path node if both FirstDevicePath                     and SecondDevicePath are NULL.  **/
end_comment

begin_function
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|EFIAPI
name|AppendDevicePathNode
parameter_list|(
name|IN
name|CONST
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|DevicePath
parameter_list|,
name|OPTIONAL
name|IN
name|CONST
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|DevicePathNode
name|OPTIONAL
parameter_list|)
block|{
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|TempDevicePath
decl_stmt|;
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|NextNode
decl_stmt|;
name|EFI_DEVICE_PATH_PROTOCOL
modifier|*
name|NewDevicePath
decl_stmt|;
name|UINTN
name|NodeLength
decl_stmt|;
if|if
condition|(
name|DevicePathNode
operator|==
name|NULL
condition|)
block|{
return|return
name|DuplicateDevicePath
argument_list|(
operator|(
name|DevicePath
operator|!=
name|NULL
operator|)
condition|?
name|DevicePath
else|:
operator|&
name|mUefiDevicePathLibEndDevicePath
argument_list|)
return|;
block|}
comment|//
comment|// Build a Node that has a terminator on it
comment|//
name|NodeLength
operator|=
name|DevicePathNodeLength
argument_list|(
name|DevicePathNode
argument_list|)
expr_stmt|;
name|TempDevicePath
operator|=
name|AllocatePool
argument_list|(
name|NodeLength
operator|+
name|END_DEVICE_PATH_LENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|TempDevicePath
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|TempDevicePath
operator|=
name|CopyMem
argument_list|(
name|TempDevicePath
argument_list|,
name|DevicePathNode
argument_list|,
name|NodeLength
argument_list|)
expr_stmt|;
comment|//
comment|// Add and end device path node to convert Node to device path
comment|//
name|NextNode
operator|=
name|NextDevicePathNode
argument_list|(
name|TempDevicePath
argument_list|)
expr_stmt|;
name|SetDevicePathEndNode
argument_list|(
name|NextNode
argument_list|)
expr_stmt|;
comment|//
comment|// Append device paths
comment|//
name|NewDevicePath
operator|=
name|AppendDevicePath
argument_list|(
name|DevicePath
argument_list|,
name|TempDevicePath
argument_list|)
expr_stmt|;
name|FreePool
argument_list|(
name|TempDevicePath
argument_list|)
expr_stmt|;
return|return
name|NewDevicePath
return|;
block|}
end_function

end_unit


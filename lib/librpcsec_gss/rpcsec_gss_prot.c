begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   rpcsec_gss_prot.c      Copyright (c) 2000 The Regents of the University of Michigan.   All rights reserved.      Copyright (c) 2000 Dug Song<dugsong@UMICH.EDU>.   All rights reserved, all wrongs reversed.      Redistribution and use in source and binary forms, with or without   modification, are permitted provided that the following conditions   are met:    1. Redistributions of source code must retain the above copyright      notice, this list of conditions and the following disclaimer.   2. Redistributions in binary form must reproduce the above copyright      notice, this list of conditions and the following disclaimer in the      documentation and/or other materials provided with the distribution.   3. Neither the name of the University nor the names of its      contributors may be used to endorse or promote products derived      from this software without specific prior written permission.    THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED   WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF   MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE   DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE   FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR   CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF   SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR   BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF   LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING   NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.    $Id: authgss_prot.c,v 1.18 2000/09/01 04:14:03 dugsong Exp $ */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpc.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpcsec_gss.h>
end_include

begin_include
include|#
directive|include
file|"rpcsec_gss_int.h"
end_include

begin_define
define|#
directive|define
name|MAX_GSS_SIZE
value|10240
end_define

begin_comment
comment|/* XXX */
end_comment

begin_function
name|bool_t
name|xdr_gss_buffer_desc
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|gss_buffer_desc
modifier|*
name|p
parameter_list|)
block|{
name|char
modifier|*
name|val
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|bool_t
name|ret
decl_stmt|;
name|val
operator|=
name|p
operator|->
name|value
expr_stmt|;
name|len
operator|=
name|p
operator|->
name|length
expr_stmt|;
name|ret
operator|=
name|xdr_bytes
argument_list|(
name|xdrs
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|len
argument_list|,
name|MAX_GSS_SIZE
argument_list|)
expr_stmt|;
name|p
operator|->
name|value
operator|=
name|val
expr_stmt|;
name|p
operator|->
name|length
operator|=
name|len
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|bool_t
name|xdr_rpc_gss_cred
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|struct
name|rpc_gss_cred
modifier|*
name|p
parameter_list|)
block|{
name|enum_t
name|proc
decl_stmt|,
name|svc
decl_stmt|;
name|bool_t
name|ret
decl_stmt|;
name|proc
operator|=
name|p
operator|->
name|gc_proc
expr_stmt|;
name|svc
operator|=
name|p
operator|->
name|gc_svc
expr_stmt|;
name|ret
operator|=
operator|(
name|xdr_u_int
argument_list|(
name|xdrs
argument_list|,
operator|&
name|p
operator|->
name|gc_version
argument_list|)
operator|&&
name|xdr_enum
argument_list|(
name|xdrs
argument_list|,
operator|&
name|proc
argument_list|)
operator|&&
name|xdr_u_int
argument_list|(
name|xdrs
argument_list|,
operator|&
name|p
operator|->
name|gc_seq
argument_list|)
operator|&&
name|xdr_enum
argument_list|(
name|xdrs
argument_list|,
operator|&
name|svc
argument_list|)
operator|&&
name|xdr_gss_buffer_desc
argument_list|(
name|xdrs
argument_list|,
operator|&
name|p
operator|->
name|gc_handle
argument_list|)
operator|)
expr_stmt|;
name|p
operator|->
name|gc_proc
operator|=
name|proc
expr_stmt|;
name|p
operator|->
name|gc_svc
operator|=
name|svc
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|bool_t
name|xdr_rpc_gss_init_res
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|struct
name|rpc_gss_init_res
modifier|*
name|p
parameter_list|)
block|{
return|return
operator|(
name|xdr_gss_buffer_desc
argument_list|(
name|xdrs
argument_list|,
operator|&
name|p
operator|->
name|gr_handle
argument_list|)
operator|&&
name|xdr_u_int
argument_list|(
name|xdrs
argument_list|,
operator|&
name|p
operator|->
name|gr_major
argument_list|)
operator|&&
name|xdr_u_int
argument_list|(
name|xdrs
argument_list|,
operator|&
name|p
operator|->
name|gr_minor
argument_list|)
operator|&&
name|xdr_u_int
argument_list|(
name|xdrs
argument_list|,
operator|&
name|p
operator|->
name|gr_win
argument_list|)
operator|&&
name|xdr_gss_buffer_desc
argument_list|(
name|xdrs
argument_list|,
operator|&
name|p
operator|->
name|gr_token
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|bool_t
name|xdr_rpc_gss_wrap_data
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|xdrproc_t
name|xdr_func
parameter_list|,
name|caddr_t
name|xdr_ptr
parameter_list|,
name|gss_ctx_id_t
name|ctx
parameter_list|,
name|gss_qop_t
name|qop
parameter_list|,
name|rpc_gss_service_t
name|svc
parameter_list|,
name|u_int
name|seq
parameter_list|)
block|{
name|gss_buffer_desc
name|databuf
decl_stmt|,
name|wrapbuf
decl_stmt|;
name|OM_uint32
name|maj_stat
decl_stmt|,
name|min_stat
decl_stmt|;
name|int
name|start
decl_stmt|,
name|end
decl_stmt|,
name|conf_state
decl_stmt|;
name|bool_t
name|xdr_stat
decl_stmt|;
comment|/* Skip databody length. */
name|start
operator|=
name|XDR_GETPOS
argument_list|(
name|xdrs
argument_list|)
expr_stmt|;
name|XDR_SETPOS
argument_list|(
name|xdrs
argument_list|,
name|start
operator|+
literal|4
argument_list|)
expr_stmt|;
comment|/* Marshal rpc_gss_data_t (sequence number + arguments). */
if|if
condition|(
operator|!
name|xdr_u_int
argument_list|(
name|xdrs
argument_list|,
operator|&
name|seq
argument_list|)
operator|||
operator|!
name|xdr_func
argument_list|(
name|xdrs
argument_list|,
name|xdr_ptr
argument_list|)
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|end
operator|=
name|XDR_GETPOS
argument_list|(
name|xdrs
argument_list|)
expr_stmt|;
comment|/* Set databuf to marshalled rpc_gss_data_t. */
name|databuf
operator|.
name|length
operator|=
name|end
operator|-
name|start
operator|-
literal|4
expr_stmt|;
name|XDR_SETPOS
argument_list|(
name|xdrs
argument_list|,
name|start
operator|+
literal|4
argument_list|)
expr_stmt|;
name|databuf
operator|.
name|value
operator|=
name|XDR_INLINE
argument_list|(
name|xdrs
argument_list|,
name|databuf
operator|.
name|length
argument_list|)
expr_stmt|;
name|xdr_stat
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|svc
operator|==
name|rpc_gss_svc_integrity
condition|)
block|{
comment|/* Marshal databody_integ length. */
name|XDR_SETPOS
argument_list|(
name|xdrs
argument_list|,
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xdr_u_int
argument_list|(
name|xdrs
argument_list|,
operator|&
name|databuf
operator|.
name|length
argument_list|)
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
comment|/* Checksum rpc_gss_data_t. */
name|maj_stat
operator|=
name|gss_get_mic
argument_list|(
operator|&
name|min_stat
argument_list|,
name|ctx
argument_list|,
name|qop
argument_list|,
operator|&
name|databuf
argument_list|,
operator|&
name|wrapbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
operator|!=
name|GSS_S_COMPLETE
condition|)
block|{
name|log_debug
argument_list|(
literal|"gss_get_mic failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
comment|/* Marshal checksum. */
name|XDR_SETPOS
argument_list|(
name|xdrs
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|xdr_stat
operator|=
name|xdr_gss_buffer_desc
argument_list|(
name|xdrs
argument_list|,
operator|&
name|wrapbuf
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|wrapbuf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|svc
operator|==
name|rpc_gss_svc_privacy
condition|)
block|{
comment|/* Encrypt rpc_gss_data_t. */
name|maj_stat
operator|=
name|gss_wrap
argument_list|(
operator|&
name|min_stat
argument_list|,
name|ctx
argument_list|,
name|TRUE
argument_list|,
name|qop
argument_list|,
operator|&
name|databuf
argument_list|,
operator|&
name|conf_state
argument_list|,
operator|&
name|wrapbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
operator|!=
name|GSS_S_COMPLETE
condition|)
block|{
name|log_status
argument_list|(
literal|"gss_wrap"
argument_list|,
name|NULL
argument_list|,
name|maj_stat
argument_list|,
name|min_stat
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
comment|/* Marshal databody_priv. */
name|XDR_SETPOS
argument_list|(
name|xdrs
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|xdr_stat
operator|=
name|xdr_gss_buffer_desc
argument_list|(
name|xdrs
argument_list|,
operator|&
name|wrapbuf
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|wrapbuf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|xdr_stat
operator|)
return|;
block|}
end_function

begin_function
name|bool_t
name|xdr_rpc_gss_unwrap_data
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|xdrproc_t
name|xdr_func
parameter_list|,
name|caddr_t
name|xdr_ptr
parameter_list|,
name|gss_ctx_id_t
name|ctx
parameter_list|,
name|gss_qop_t
name|qop
parameter_list|,
name|rpc_gss_service_t
name|svc
parameter_list|,
name|u_int
name|seq
parameter_list|)
block|{
name|XDR
name|tmpxdrs
decl_stmt|;
name|gss_buffer_desc
name|databuf
decl_stmt|,
name|wrapbuf
decl_stmt|;
name|OM_uint32
name|maj_stat
decl_stmt|,
name|min_stat
decl_stmt|;
name|u_int
name|seq_num
decl_stmt|,
name|conf_state
decl_stmt|,
name|qop_state
decl_stmt|;
name|bool_t
name|xdr_stat
decl_stmt|;
if|if
condition|(
name|xdr_func
operator|==
operator|(
name|xdrproc_t
operator|)
name|xdr_void
operator|||
name|xdr_ptr
operator|==
name|NULL
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
name|memset
argument_list|(
operator|&
name|databuf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|databuf
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|wrapbuf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wrapbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|svc
operator|==
name|rpc_gss_svc_integrity
condition|)
block|{
comment|/* Decode databody_integ. */
if|if
condition|(
operator|!
name|xdr_gss_buffer_desc
argument_list|(
name|xdrs
argument_list|,
operator|&
name|databuf
argument_list|)
condition|)
block|{
name|log_debug
argument_list|(
literal|"xdr decode databody_integ failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
comment|/* Decode checksum. */
if|if
condition|(
operator|!
name|xdr_gss_buffer_desc
argument_list|(
name|xdrs
argument_list|,
operator|&
name|wrapbuf
argument_list|)
condition|)
block|{
name|mem_free
argument_list|(
name|databuf
operator|.
name|value
argument_list|,
name|databuf
operator|.
name|length
argument_list|)
expr_stmt|;
name|log_debug
argument_list|(
literal|"xdr decode checksum failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
comment|/* Verify checksum and QOP. */
name|maj_stat
operator|=
name|gss_verify_mic
argument_list|(
operator|&
name|min_stat
argument_list|,
name|ctx
argument_list|,
operator|&
name|databuf
argument_list|,
operator|&
name|wrapbuf
argument_list|,
operator|&
name|qop_state
argument_list|)
expr_stmt|;
name|mem_free
argument_list|(
name|wrapbuf
operator|.
name|value
argument_list|,
name|wrapbuf
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
operator|!=
name|GSS_S_COMPLETE
operator|||
name|qop_state
operator|!=
name|qop
condition|)
block|{
name|mem_free
argument_list|(
name|databuf
operator|.
name|value
argument_list|,
name|databuf
operator|.
name|length
argument_list|)
expr_stmt|;
name|log_status
argument_list|(
literal|"gss_verify_mic"
argument_list|,
name|NULL
argument_list|,
name|maj_stat
argument_list|,
name|min_stat
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|svc
operator|==
name|rpc_gss_svc_privacy
condition|)
block|{
comment|/* Decode databody_priv. */
if|if
condition|(
operator|!
name|xdr_gss_buffer_desc
argument_list|(
name|xdrs
argument_list|,
operator|&
name|wrapbuf
argument_list|)
condition|)
block|{
name|log_debug
argument_list|(
literal|"xdr decode databody_priv failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
comment|/* Decrypt databody. */
name|maj_stat
operator|=
name|gss_unwrap
argument_list|(
operator|&
name|min_stat
argument_list|,
name|ctx
argument_list|,
operator|&
name|wrapbuf
argument_list|,
operator|&
name|databuf
argument_list|,
operator|&
name|conf_state
argument_list|,
operator|&
name|qop_state
argument_list|)
expr_stmt|;
name|mem_free
argument_list|(
name|wrapbuf
operator|.
name|value
argument_list|,
name|wrapbuf
operator|.
name|length
argument_list|)
expr_stmt|;
comment|/* Verify encryption and QOP. */
if|if
condition|(
name|maj_stat
operator|!=
name|GSS_S_COMPLETE
operator|||
name|qop_state
operator|!=
name|qop
operator|||
name|conf_state
operator|!=
name|TRUE
condition|)
block|{
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|databuf
argument_list|)
expr_stmt|;
name|log_status
argument_list|(
literal|"gss_unwrap"
argument_list|,
name|NULL
argument_list|,
name|maj_stat
argument_list|,
name|min_stat
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
block|}
comment|/* Decode rpc_gss_data_t (sequence number + arguments). */
name|xdrmem_create
argument_list|(
operator|&
name|tmpxdrs
argument_list|,
name|databuf
operator|.
name|value
argument_list|,
name|databuf
operator|.
name|length
argument_list|,
name|XDR_DECODE
argument_list|)
expr_stmt|;
name|xdr_stat
operator|=
operator|(
name|xdr_u_int
argument_list|(
operator|&
name|tmpxdrs
argument_list|,
operator|&
name|seq_num
argument_list|)
operator|&&
name|xdr_func
argument_list|(
operator|&
name|tmpxdrs
argument_list|,
name|xdr_ptr
argument_list|)
operator|)
expr_stmt|;
name|XDR_DESTROY
argument_list|(
operator|&
name|tmpxdrs
argument_list|)
expr_stmt|;
comment|/* 	 * Integrity service allocates databuf via XDR so free it the 	 * same way. 	 */
if|if
condition|(
name|svc
operator|==
name|rpc_gss_svc_integrity
condition|)
block|{
name|xdr_free
argument_list|(
operator|(
name|xdrproc_t
operator|)
name|xdr_gss_buffer_desc
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|databuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|databuf
argument_list|)
expr_stmt|;
block|}
comment|/* Verify sequence number. */
if|if
condition|(
name|xdr_stat
operator|==
name|TRUE
operator|&&
name|seq_num
operator|!=
name|seq
condition|)
block|{
name|log_debug
argument_list|(
literal|"wrong sequence number in databody"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
return|return
operator|(
name|xdr_stat
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_function
name|void
name|log_debug
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcsec_gss: "
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|log_status
parameter_list|(
specifier|const
name|char
modifier|*
name|m
parameter_list|,
name|gss_OID
name|mech
parameter_list|,
name|OM_uint32
name|maj_stat
parameter_list|,
name|OM_uint32
name|min_stat
parameter_list|)
block|{
name|OM_uint32
name|min
decl_stmt|;
name|gss_buffer_desc
name|msg
decl_stmt|;
name|int
name|msg_ctx
init|=
literal|0
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcsec_gss: %s: "
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|gss_display_status
argument_list|(
operator|&
name|min
argument_list|,
name|maj_stat
argument_list|,
name|GSS_C_GSS_CODE
argument_list|,
name|GSS_C_NULL_OID
argument_list|,
operator|&
name|msg_ctx
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s - "
argument_list|,
operator|(
name|char
operator|*
operator|)
name|msg
operator|.
name|value
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|min
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
name|gss_display_status
argument_list|(
operator|&
name|min
argument_list|,
name|min_stat
argument_list|,
name|GSS_C_MECH_CODE
argument_list|,
name|mech
argument_list|,
operator|&
name|msg_ctx
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|msg
operator|.
name|value
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|min
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
name|void
name|log_debug
parameter_list|(
name|__unused
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{ }
end_function

begin_function
name|void
name|log_status
parameter_list|(
name|__unused
specifier|const
name|char
modifier|*
name|m
parameter_list|,
name|__unused
name|gss_OID
name|mech
parameter_list|,
name|__unused
name|OM_uint32
name|maj_stat
parameter_list|,
name|__unused
name|OM_uint32
name|min_stat
parameter_list|)
block|{ }
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006 - 2007 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of the Institute nor the names of its contributors   *    may be used to endorse or promote products derived from this software   *    without specific prior written permission.   *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF   * SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|"hx_locl.h"
end_include

begin_include
include|#
directive|include
file|<pkinit_asn1.h>
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: ca.c 22456 2008-01-15 20:22:53Z lha $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/**  * @page page_ca Hx509 CA functions  *  * See the library functions here: @ref hx509_ca  */
end_comment

begin_struct
struct|struct
name|hx509_ca_tbs
block|{
name|hx509_name
name|subject
decl_stmt|;
name|SubjectPublicKeyInfo
name|spki
decl_stmt|;
name|ExtKeyUsage
name|eku
decl_stmt|;
name|GeneralNames
name|san
decl_stmt|;
name|unsigned
name|key_usage
decl_stmt|;
name|heim_integer
name|serial
decl_stmt|;
struct|struct
block|{
name|unsigned
name|int
name|proxy
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|ca
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|key
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|serial
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|domaincontroller
range|:
literal|1
decl_stmt|;
block|}
name|flags
struct|;
name|time_t
name|notBefore
decl_stmt|;
name|time_t
name|notAfter
decl_stmt|;
name|int
name|pathLenConstraint
decl_stmt|;
comment|/* both for CA and Proxy */
name|CRLDistributionPoints
name|crldp
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/**  * Allocate an to-be-signed certificate object that will be converted  * into an certificate.  *  * @param context A hx509 context.  * @param tbs returned to-be-signed certicate object, free with  * hx509_ca_tbs_free().  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_init
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
modifier|*
name|tbs
parameter_list|)
block|{
operator|*
name|tbs
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|tbs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|tbs
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
operator|(
operator|*
name|tbs
operator|)
operator|->
name|subject
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|tbs
operator|)
operator|->
name|san
operator|.
name|len
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|tbs
operator|)
operator|->
name|san
operator|.
name|val
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|tbs
operator|)
operator|->
name|eku
operator|.
name|len
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|tbs
operator|)
operator|->
name|eku
operator|.
name|val
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|tbs
operator|)
operator|->
name|pathLenConstraint
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|tbs
operator|)
operator|->
name|crldp
operator|.
name|len
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|tbs
operator|)
operator|->
name|crldp
operator|.
name|val
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Free an To Be Signed object.  *  * @param tbs object to free.  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|void
name|hx509_ca_tbs_free
parameter_list|(
name|hx509_ca_tbs
modifier|*
name|tbs
parameter_list|)
block|{
if|if
condition|(
name|tbs
operator|==
name|NULL
operator|||
operator|*
name|tbs
operator|==
name|NULL
condition|)
return|return;
name|free_SubjectPublicKeyInfo
argument_list|(
operator|&
operator|(
operator|*
name|tbs
operator|)
operator|->
name|spki
argument_list|)
expr_stmt|;
name|free_GeneralNames
argument_list|(
operator|&
operator|(
operator|*
name|tbs
operator|)
operator|->
name|san
argument_list|)
expr_stmt|;
name|free_ExtKeyUsage
argument_list|(
operator|&
operator|(
operator|*
name|tbs
operator|)
operator|->
name|eku
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
operator|(
operator|*
name|tbs
operator|)
operator|->
name|serial
argument_list|)
expr_stmt|;
name|free_CRLDistributionPoints
argument_list|(
operator|&
operator|(
operator|*
name|tbs
operator|)
operator|->
name|crldp
argument_list|)
expr_stmt|;
name|hx509_name_free
argument_list|(
operator|&
operator|(
operator|*
name|tbs
operator|)
operator|->
name|subject
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|*
name|tbs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|tbs
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|tbs
argument_list|)
expr_stmt|;
operator|*
name|tbs
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Set the absolute time when the certificate is valid from. If not  * set the current time will be used.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param t time the certificated will start to be valid  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_set_notBefore
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|time_t
name|t
parameter_list|)
block|{
name|tbs
operator|->
name|notBefore
operator|=
name|t
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Set the absolute time when the certificate is valid to.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param t time when the certificate will expire  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_set_notAfter
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|time_t
name|t
parameter_list|)
block|{
name|tbs
operator|->
name|notAfter
operator|=
name|t
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Set the relative time when the certificiate is going to expire.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param delta seconds to the certificate is going to expire.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_set_notAfter_lifetime
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|time_t
name|delta
parameter_list|)
block|{
return|return
name|hx509_ca_tbs_set_notAfter
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|time
argument_list|(
name|NULL
argument_list|)
operator|+
name|delta
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|units
name|templatebits
index|[]
init|=
block|{
block|{
literal|"ExtendedKeyUsage"
block|,
name|HX509_CA_TEMPLATE_EKU
block|}
block|,
block|{
literal|"KeyUsage"
block|,
name|HX509_CA_TEMPLATE_KU
block|}
block|,
block|{
literal|"SPKI"
block|,
name|HX509_CA_TEMPLATE_SPKI
block|}
block|,
block|{
literal|"notAfter"
block|,
name|HX509_CA_TEMPLATE_NOTAFTER
block|}
block|,
block|{
literal|"notBefore"
block|,
name|HX509_CA_TEMPLATE_NOTBEFORE
block|}
block|,
block|{
literal|"serial"
block|,
name|HX509_CA_TEMPLATE_SERIAL
block|}
block|,
block|{
literal|"subject"
block|,
name|HX509_CA_TEMPLATE_SUBJECT
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * Make of template units, use to build flags argument to  * hx509_ca_tbs_set_template() with parse_units().  *  * @return an units structure.  *  * @ingroup hx509_ca  */
end_comment

begin_function
specifier|const
name|struct
name|units
modifier|*
name|hx509_ca_tbs_template_units
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|templatebits
return|;
block|}
end_function

begin_comment
comment|/**  * Initialize the to-be-signed certificate object from a template certifiate.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param flags bit field selecting what to copy from the template  * certifiate.  * @param cert template certificate.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_set_template
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|int
name|flags
parameter_list|,
name|hx509_cert
name|cert
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|HX509_CA_TEMPLATE_SUBJECT
condition|)
block|{
if|if
condition|(
name|tbs
operator|->
name|subject
condition|)
name|hx509_name_free
argument_list|(
operator|&
name|tbs
operator|->
name|subject
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cert_get_subject
argument_list|(
name|cert
argument_list|,
operator|&
name|tbs
operator|->
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to get subject from template"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
if|if
condition|(
name|flags
operator|&
name|HX509_CA_TEMPLATE_SERIAL
condition|)
block|{
name|der_free_heim_integer
argument_list|(
operator|&
name|tbs
operator|->
name|serial
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cert_get_serialnumber
argument_list|(
name|cert
argument_list|,
operator|&
name|tbs
operator|->
name|serial
argument_list|)
expr_stmt|;
name|tbs
operator|->
name|flags
operator|.
name|serial
operator|=
operator|!
name|ret
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to copy serial number"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
if|if
condition|(
name|flags
operator|&
name|HX509_CA_TEMPLATE_NOTBEFORE
condition|)
name|tbs
operator|->
name|notBefore
operator|=
name|hx509_cert_get_notBefore
argument_list|(
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|HX509_CA_TEMPLATE_NOTAFTER
condition|)
name|tbs
operator|->
name|notAfter
operator|=
name|hx509_cert_get_notAfter
argument_list|(
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|HX509_CA_TEMPLATE_SPKI
condition|)
block|{
name|free_SubjectPublicKeyInfo
argument_list|(
operator|&
name|tbs
operator|->
name|spki
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cert_get_SPKI
argument_list|(
name|context
argument_list|,
name|cert
argument_list|,
operator|&
name|tbs
operator|->
name|spki
argument_list|)
expr_stmt|;
name|tbs
operator|->
name|flags
operator|.
name|key
operator|=
operator|!
name|ret
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|HX509_CA_TEMPLATE_KU
condition|)
block|{
name|KeyUsage
name|ku
decl_stmt|;
name|ret
operator|=
name|_hx509_cert_get_keyusage
argument_list|(
name|context
argument_list|,
name|cert
argument_list|,
operator|&
name|ku
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|tbs
operator|->
name|key_usage
operator|=
name|KeyUsage2int
argument_list|(
name|ku
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|HX509_CA_TEMPLATE_EKU
condition|)
block|{
name|ExtKeyUsage
name|eku
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ret
operator|=
name|_hx509_cert_get_eku
argument_list|(
name|context
argument_list|,
name|cert
argument_list|,
operator|&
name|eku
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|eku
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_add_eku
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
operator|&
name|eku
operator|.
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_ExtKeyUsage
argument_list|(
operator|&
name|eku
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|free_ExtKeyUsage
argument_list|(
operator|&
name|eku
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Make the to-be-signed certificate object a CA certificate. If the  * pathLenConstraint is negative path length constraint is used.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param pathLenConstraint path length constraint, negative, no  * constraint.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_set_ca
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|int
name|pathLenConstraint
parameter_list|)
block|{
name|tbs
operator|->
name|flags
operator|.
name|ca
operator|=
literal|1
expr_stmt|;
name|tbs
operator|->
name|pathLenConstraint
operator|=
name|pathLenConstraint
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Make the to-be-signed certificate object a proxy certificate. If the  * pathLenConstraint is negative path length constraint is used.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param pathLenConstraint path length constraint, negative, no  * constraint.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_set_proxy
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|int
name|pathLenConstraint
parameter_list|)
block|{
name|tbs
operator|->
name|flags
operator|.
name|proxy
operator|=
literal|1
expr_stmt|;
name|tbs
operator|->
name|pathLenConstraint
operator|=
name|pathLenConstraint
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Make the to-be-signed certificate object a windows domain controller certificate.  *  * @param context A hx509 context.  * @param tbs object to be signed.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_set_domaincontroller
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|)
block|{
name|tbs
operator|->
name|flags
operator|.
name|domaincontroller
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Set the subject public key info (SPKI) in the to-be-signed certificate  * object. SPKI is the public key and key related parameters in the  * certificate.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param spki subject public key info to use for the to-be-signed certificate object.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_set_spki
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|SubjectPublicKeyInfo
modifier|*
name|spki
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|free_SubjectPublicKeyInfo
argument_list|(
operator|&
name|tbs
operator|->
name|spki
argument_list|)
expr_stmt|;
name|ret
operator|=
name|copy_SubjectPublicKeyInfo
argument_list|(
name|spki
argument_list|,
operator|&
name|tbs
operator|->
name|spki
argument_list|)
expr_stmt|;
name|tbs
operator|->
name|flags
operator|.
name|key
operator|=
operator|!
name|ret
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Set the serial number to use for to-be-signed certificate object.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param serialNumber serial number to use for the to-be-signed  * certificate object.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_set_serialnumber
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|heim_integer
modifier|*
name|serialNumber
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|tbs
operator|->
name|serial
argument_list|)
expr_stmt|;
name|ret
operator|=
name|der_copy_heim_integer
argument_list|(
name|serialNumber
argument_list|,
operator|&
name|tbs
operator|->
name|serial
argument_list|)
expr_stmt|;
name|tbs
operator|->
name|flags
operator|.
name|serial
operator|=
operator|!
name|ret
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * An an extended key usage to the to-be-signed certificate object.  * Duplicates will detected and not added.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param oid extended key usage to add.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_add_eku
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|heim_oid
modifier|*
name|oid
parameter_list|)
block|{
name|void
modifier|*
name|ptr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
comment|/* search for duplicates */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tbs
operator|->
name|eku
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|der_heim_oid_cmp
argument_list|(
name|oid
argument_list|,
operator|&
name|tbs
operator|->
name|eku
operator|.
name|val
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
block|}
name|ptr
operator|=
name|realloc
argument_list|(
name|tbs
operator|->
name|eku
operator|.
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|tbs
operator|->
name|eku
operator|.
name|val
index|[
literal|0
index|]
argument_list|)
operator|*
operator|(
name|tbs
operator|->
name|eku
operator|.
name|len
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|tbs
operator|->
name|eku
operator|.
name|val
operator|=
name|ptr
expr_stmt|;
name|ret
operator|=
name|der_copy_oid
argument_list|(
name|oid
argument_list|,
operator|&
name|tbs
operator|->
name|eku
operator|.
name|val
index|[
name|tbs
operator|->
name|eku
operator|.
name|len
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|tbs
operator|->
name|eku
operator|.
name|len
operator|+=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Add CRL distribution point URI to the to-be-signed certificate  * object.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param uri uri to the CRL.  * @param issuername name of the issuer.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_add_crl_dp_uri
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|char
modifier|*
name|uri
parameter_list|,
name|hx509_name
name|issuername
parameter_list|)
block|{
name|DistributionPoint
name|dp
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|dp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dp
argument_list|)
argument_list|)
expr_stmt|;
name|dp
operator|.
name|distributionPoint
operator|=
name|ecalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dp
operator|.
name|distributionPoint
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|DistributionPointName
name|name
decl_stmt|;
name|GeneralName
name|gn
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|name
operator|.
name|element
operator|=
name|choice_DistributionPointName_fullName
expr_stmt|;
name|name
operator|.
name|u
operator|.
name|fullName
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|name
operator|.
name|u
operator|.
name|fullName
operator|.
name|val
operator|=
operator|&
name|gn
expr_stmt|;
name|gn
operator|.
name|element
operator|=
name|choice_GeneralName_uniformResourceIdentifier
expr_stmt|;
name|gn
operator|.
name|u
operator|.
name|uniformResourceIdentifier
operator|=
name|rk_UNCONST
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|DistributionPointName
argument_list|,
name|dp
operator|.
name|distributionPoint
operator|->
name|data
argument_list|,
name|dp
operator|.
name|distributionPoint
operator|->
name|length
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to encoded DistributionPointName"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|dp
operator|.
name|distributionPoint
operator|->
name|length
operator|!=
name|size
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|issuername
condition|)
block|{
if|#
directive|if
literal|1
comment|/** 	 * issuername not supported 	 */
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|EINVAL
argument_list|,
literal|"CRLDistributionPoints.name.issuername not yet supported"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
else|#
directive|else
name|GeneralNames
modifier|*
name|crlissuer
decl_stmt|;
name|GeneralName
name|gn
decl_stmt|;
name|Name
name|n
decl_stmt|;
name|crlissuer
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|crlissuer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|crlissuer
operator|==
name|NULL
condition|)
block|{
return|return
name|ENOMEM
return|;
block|}
name|memset
argument_list|(
operator|&
name|gn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gn
argument_list|)
argument_list|)
expr_stmt|;
name|gn
operator|.
name|element
operator|=
name|choice_GeneralName_directoryName
expr_stmt|;
name|ret
operator|=
name|hx509_name_to_Name
argument_list|(
name|issuername
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|gn
operator|.
name|u
operator|.
name|directoryName
operator|.
name|element
operator|=
name|n
operator|.
name|element
expr_stmt|;
name|gn
operator|.
name|u
operator|.
name|directoryName
operator|.
name|u
operator|.
name|rdnSequence
operator|=
name|n
operator|.
name|u
operator|.
name|rdnSequence
expr_stmt|;
name|ret
operator|=
name|add_GeneralNames
argument_list|(
operator|&
name|crlissuer
argument_list|,
operator|&
name|gn
argument_list|)
expr_stmt|;
name|free_Name
argument_list|(
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dp
operator|.
name|cRLIssuer
operator|=
operator|&
name|crlissuer
expr_stmt|;
endif|#
directive|endif
block|}
name|ret
operator|=
name|add_CRLDistributionPoints
argument_list|(
operator|&
name|tbs
operator|->
name|crldp
argument_list|,
operator|&
name|dp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|free_DistributionPoint
argument_list|(
operator|&
name|dp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Add Subject Alternative Name otherName to the to-be-signed  * certificate object.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param oid the oid of the OtherName.  * @param os data in the other name.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_add_san_otherName
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|heim_oid
modifier|*
name|oid
parameter_list|,
specifier|const
name|heim_octet_string
modifier|*
name|os
parameter_list|)
block|{
name|GeneralName
name|gn
decl_stmt|;
name|memset
argument_list|(
operator|&
name|gn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gn
argument_list|)
argument_list|)
expr_stmt|;
name|gn
operator|.
name|element
operator|=
name|choice_GeneralName_otherName
expr_stmt|;
name|gn
operator|.
name|u
operator|.
name|otherName
operator|.
name|type_id
operator|=
operator|*
name|oid
expr_stmt|;
name|gn
operator|.
name|u
operator|.
name|otherName
operator|.
name|value
operator|=
operator|*
name|os
expr_stmt|;
return|return
name|add_GeneralNames
argument_list|(
operator|&
name|tbs
operator|->
name|san
argument_list|,
operator|&
name|gn
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * Add Kerberos Subject Alternative Name to the to-be-signed  * certificate object. The principal string is a UTF8 string.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param principal Kerberos principal to add to the certificate.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_add_san_pkinit
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|char
modifier|*
name|principal
parameter_list|)
block|{
name|heim_octet_string
name|os
decl_stmt|;
name|KRB5PrincipalName
name|p
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|memset
argument_list|(
operator|&
name|p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
comment|/* parse principal */
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|char
modifier|*
name|q
decl_stmt|;
name|int
name|n
decl_stmt|;
comment|/* count number of component */
name|n
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|str
operator|=
name|principal
init|;
operator|*
name|str
operator|!=
literal|'\0'
operator|&&
operator|*
name|str
operator|!=
literal|'@'
condition|;
name|str
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|str
operator|==
literal|'\\'
condition|)
block|{
if|if
condition|(
name|str
index|[
literal|1
index|]
operator|==
literal|'\0'
operator|||
name|str
index|[
literal|1
index|]
operator|==
literal|'@'
condition|)
block|{
name|ret
operator|=
name|HX509_PARSING_NAME_FAILED
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"trailing \\ in principal name"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|str
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|str
operator|==
literal|'/'
condition|)
name|n
operator|++
expr_stmt|;
block|}
name|p
operator|.
name|principalName
operator|.
name|name_string
operator|.
name|val
operator|=
name|calloc
argument_list|(
name|n
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
operator|.
name|principalName
operator|.
name|name_string
operator|.
name|val
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|.
name|principalName
operator|.
name|name_string
operator|.
name|val
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p
operator|.
name|principalName
operator|.
name|name_string
operator|.
name|len
operator|=
name|n
expr_stmt|;
name|p
operator|.
name|principalName
operator|.
name|name_type
operator|=
name|KRB5_NT_PRINCIPAL
expr_stmt|;
name|q
operator|=
name|s
operator|=
name|strdup
argument_list|(
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p
operator|.
name|realm
operator|=
name|strrchr
argument_list|(
name|q
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|.
name|realm
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|HX509_PARSING_NAME_FAILED
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Missing @ in principal"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
empty_stmt|;
operator|*
name|p
operator|.
name|realm
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|q
condition|)
block|{
name|p
operator|.
name|principalName
operator|.
name|name_string
operator|.
name|val
index|[
name|n
operator|++
index|]
operator|=
name|q
expr_stmt|;
name|q
operator|=
name|strchr
argument_list|(
name|q
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
condition|)
operator|*
name|q
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|KRB5PrincipalName
argument_list|,
name|os
operator|.
name|data
argument_list|,
name|os
operator|.
name|length
argument_list|,
operator|&
name|p
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|os
operator|.
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_san_otherName
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkinit_san
argument_list|()
argument_list|,
operator|&
name|os
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|os
operator|.
name|data
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|p
operator|.
name|principalName
operator|.
name|name_string
operator|.
name|val
condition|)
name|free
argument_list|(
name|p
operator|.
name|principalName
operator|.
name|name_string
operator|.
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int
name|add_utf8_san
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|heim_oid
modifier|*
name|oid
parameter_list|,
specifier|const
name|char
modifier|*
name|string
parameter_list|)
block|{
specifier|const
name|PKIXXmppAddr
name|ustring
init|=
operator|(
specifier|const
name|PKIXXmppAddr
operator|)
name|string
decl_stmt|;
name|heim_octet_string
name|os
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|os
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|os
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|PKIXXmppAddr
argument_list|,
name|os
operator|.
name|data
argument_list|,
name|os
operator|.
name|length
argument_list|,
operator|&
name|ustring
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|os
operator|.
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_san_otherName
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid
argument_list|,
operator|&
name|os
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|os
operator|.
name|data
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Add Microsoft UPN Subject Alternative Name to the to-be-signed  * certificate object. The principal string is a UTF8 string.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param principal Microsoft UPN string.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_add_san_ms_upn
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|char
modifier|*
name|principal
parameter_list|)
block|{
return|return
name|add_utf8_san
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkinit_ms_san
argument_list|()
argument_list|,
name|principal
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * Add a Jabber/XMPP jid Subject Alternative Name to the to-be-signed  * certificate object. The jid is an UTF8 string.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param jid string of an a jabber id in UTF8.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_add_san_jid
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|char
modifier|*
name|jid
parameter_list|)
block|{
return|return
name|add_utf8_san
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkix_on_xmppAddr
argument_list|()
argument_list|,
name|jid
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * Add a Subject Alternative Name hostname to to-be-signed certificate  * object. A domain match starts with ., an exact match does not.  *  * Example of a an domain match: .domain.se matches the hostname  * host.domain.se.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param dnsname a hostame.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_add_san_hostname
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|char
modifier|*
name|dnsname
parameter_list|)
block|{
name|GeneralName
name|gn
decl_stmt|;
name|memset
argument_list|(
operator|&
name|gn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gn
argument_list|)
argument_list|)
expr_stmt|;
name|gn
operator|.
name|element
operator|=
name|choice_GeneralName_dNSName
expr_stmt|;
name|gn
operator|.
name|u
operator|.
name|dNSName
operator|=
name|rk_UNCONST
argument_list|(
name|dnsname
argument_list|)
expr_stmt|;
return|return
name|add_GeneralNames
argument_list|(
operator|&
name|tbs
operator|->
name|san
argument_list|,
operator|&
name|gn
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * Add a Subject Alternative Name rfc822 (email address) to  * to-be-signed certificate object.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param rfc822Name a string to a email address.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_add_san_rfc822name
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|char
modifier|*
name|rfc822Name
parameter_list|)
block|{
name|GeneralName
name|gn
decl_stmt|;
name|memset
argument_list|(
operator|&
name|gn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gn
argument_list|)
argument_list|)
expr_stmt|;
name|gn
operator|.
name|element
operator|=
name|choice_GeneralName_rfc822Name
expr_stmt|;
name|gn
operator|.
name|u
operator|.
name|rfc822Name
operator|=
name|rk_UNCONST
argument_list|(
name|rfc822Name
argument_list|)
expr_stmt|;
return|return
name|add_GeneralNames
argument_list|(
operator|&
name|tbs
operator|->
name|san
argument_list|,
operator|&
name|gn
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * Set the subject name of a to-be-signed certificate object.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param subject the name to set a subject.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_set_subject
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|hx509_name
name|subject
parameter_list|)
block|{
if|if
condition|(
name|tbs
operator|->
name|subject
condition|)
name|hx509_name_free
argument_list|(
operator|&
name|tbs
operator|->
name|subject
argument_list|)
expr_stmt|;
return|return
name|hx509_name_copy
argument_list|(
name|context
argument_list|,
name|subject
argument_list|,
operator|&
name|tbs
operator|->
name|subject
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * Expand the the subject name in the to-be-signed certificate object  * using hx509_name_expand().  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param env enviroment variable to expand variables in the subject  * name, see hx509_env_init().  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_tbs_subject_expand
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|hx509_env
name|env
parameter_list|)
block|{
return|return
name|hx509_name_expand
argument_list|(
name|context
argument_list|,
name|tbs
operator|->
name|subject
argument_list|,
name|env
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_extension
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|TBSCertificate
modifier|*
name|tbsc
parameter_list|,
name|int
name|critical_flag
parameter_list|,
specifier|const
name|heim_oid
modifier|*
name|oid
parameter_list|,
specifier|const
name|heim_octet_string
modifier|*
name|data
parameter_list|)
block|{
name|Extension
name|ext
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ext
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ext
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|critical_flag
condition|)
block|{
name|ext
operator|.
name|critical
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ext
operator|.
name|critical
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext
operator|.
name|critical
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|ext
operator|.
name|critical
operator|=
name|TRUE
expr_stmt|;
block|}
name|ret
operator|=
name|der_copy_oid
argument_list|(
name|oid
argument_list|,
operator|&
name|ext
operator|.
name|extnID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|der_copy_octet_string
argument_list|(
name|data
argument_list|,
operator|&
name|ext
operator|.
name|extnValue
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|add_Extensions
argument_list|(
name|tbsc
operator|->
name|extensions
argument_list|,
operator|&
name|ext
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|free_Extension
argument_list|(
operator|&
name|ext
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_proxy_prefix
parameter_list|(
name|hx509_context
name|context
parameter_list|,
specifier|const
name|Name
modifier|*
name|issuer
parameter_list|,
name|Name
modifier|*
name|subject
parameter_list|)
block|{
name|char
modifier|*
name|tstr
decl_stmt|;
name|time_t
name|t
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|copy_Name
argument_list|(
name|issuer
argument_list|,
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to copy subject name"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|t
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tstr
argument_list|,
literal|"ts-%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|tstr
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"Failed to copy subject name"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
comment|/* prefix with CN=<ts>,...*/
name|ret
operator|=
name|_hx509_name_modify
argument_list|(
name|context
argument_list|,
name|subject
argument_list|,
literal|1
argument_list|,
name|oid_id_at_commonName
argument_list|()
argument_list|,
name|tstr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|free_Name
argument_list|(
name|subject
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ca_sign
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|hx509_private_key
name|signer
parameter_list|,
specifier|const
name|AuthorityKeyIdentifier
modifier|*
name|ai
parameter_list|,
specifier|const
name|Name
modifier|*
name|issuername
parameter_list|,
name|hx509_cert
modifier|*
name|certificate
parameter_list|)
block|{
name|heim_octet_string
name|data
decl_stmt|;
name|Certificate
name|c
decl_stmt|;
name|TBSCertificate
modifier|*
name|tbsc
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
specifier|const
name|AlgorithmIdentifier
modifier|*
name|sigalg
decl_stmt|;
name|time_t
name|notBefore
decl_stmt|;
name|time_t
name|notAfter
decl_stmt|;
name|unsigned
name|key_usage
decl_stmt|;
name|sigalg
operator|=
name|_hx509_crypto_default_sig_alg
expr_stmt|;
name|memset
argument_list|(
operator|&
name|c
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
comment|/*      * Default values are: Valid since 24h ago, valid one year into      * the future, KeyUsage digitalSignature and keyEncipherment set,      * and keyCertSign for CA certificates.      */
name|notBefore
operator|=
name|tbs
operator|->
name|notBefore
expr_stmt|;
if|if
condition|(
name|notBefore
operator|==
literal|0
condition|)
name|notBefore
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
literal|3600
operator|*
literal|24
expr_stmt|;
name|notAfter
operator|=
name|tbs
operator|->
name|notAfter
expr_stmt|;
if|if
condition|(
name|notAfter
operator|==
literal|0
condition|)
name|notAfter
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|+
literal|3600
operator|*
literal|24
operator|*
literal|365
expr_stmt|;
name|key_usage
operator|=
name|tbs
operator|->
name|key_usage
expr_stmt|;
if|if
condition|(
name|key_usage
operator|==
literal|0
condition|)
block|{
name|KeyUsage
name|ku
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ku
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ku
argument_list|)
argument_list|)
expr_stmt|;
name|ku
operator|.
name|digitalSignature
operator|=
literal|1
expr_stmt|;
name|ku
operator|.
name|keyEncipherment
operator|=
literal|1
expr_stmt|;
name|key_usage
operator|=
name|KeyUsage2int
argument_list|(
name|ku
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tbs
operator|->
name|flags
operator|.
name|ca
condition|)
block|{
name|KeyUsage
name|ku
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ku
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ku
argument_list|)
argument_list|)
expr_stmt|;
name|ku
operator|.
name|keyCertSign
operator|=
literal|1
expr_stmt|;
name|ku
operator|.
name|cRLSign
operator|=
literal|1
expr_stmt|;
name|key_usage
operator||=
name|KeyUsage2int
argument_list|(
name|ku
argument_list|)
expr_stmt|;
block|}
comment|/*      *      */
name|tbsc
operator|=
operator|&
name|c
operator|.
name|tbsCertificate
expr_stmt|;
if|if
condition|(
name|tbs
operator|->
name|flags
operator|.
name|key
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"No public key set"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/*      * Don't put restrictions on proxy certificate's subject name, it      * will be generated below.      */
if|if
condition|(
operator|!
name|tbs
operator|->
name|flags
operator|.
name|proxy
condition|)
block|{
if|if
condition|(
name|tbs
operator|->
name|subject
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|EINVAL
argument_list|,
literal|"No subject name set"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|hx509_name_is_null_p
argument_list|(
name|tbs
operator|->
name|subject
argument_list|)
operator|&&
name|tbs
operator|->
name|san
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|EINVAL
argument_list|,
literal|"NULL subject and no SubjectAltNames"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
block|}
if|if
condition|(
name|tbs
operator|->
name|flags
operator|.
name|ca
operator|&&
name|tbs
operator|->
name|flags
operator|.
name|proxy
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|EINVAL
argument_list|,
literal|"Can't be proxy and CA "
literal|"at the same time"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|tbs
operator|->
name|flags
operator|.
name|proxy
condition|)
block|{
if|if
condition|(
name|tbs
operator|->
name|san
operator|.
name|len
operator|>
literal|0
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|EINVAL
argument_list|,
literal|"Proxy certificate is not allowed "
literal|"to have SubjectAltNames"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
block|}
comment|/* version         [0]  Version OPTIONAL, -- EXPLICIT nnn DEFAULT 1, */
name|tbsc
operator|->
name|version
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tbsc
operator|->
name|version
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tbsc
operator|->
name|version
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|tbsc
operator|->
name|version
operator|=
name|rfc3280_version_3
expr_stmt|;
comment|/* serialNumber         CertificateSerialNumber, */
if|if
condition|(
name|tbs
operator|->
name|flags
operator|.
name|serial
condition|)
block|{
name|ret
operator|=
name|der_copy_heim_integer
argument_list|(
operator|&
name|tbs
operator|->
name|serial
argument_list|,
operator|&
name|tbsc
operator|->
name|serialNumber
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
name|tbsc
operator|->
name|serialNumber
operator|.
name|length
operator|=
literal|20
expr_stmt|;
name|tbsc
operator|->
name|serialNumber
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|tbsc
operator|->
name|serialNumber
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|tbsc
operator|->
name|serialNumber
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* XXX diffrent */
name|RAND_bytes
argument_list|(
name|tbsc
operator|->
name|serialNumber
operator|.
name|data
argument_list|,
name|tbsc
operator|->
name|serialNumber
operator|.
name|length
argument_list|)
expr_stmt|;
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|tbsc
operator|->
name|serialNumber
operator|.
name|data
operator|)
index|[
literal|0
index|]
operator|&=
literal|0x7f
expr_stmt|;
block|}
comment|/* signature            AlgorithmIdentifier, */
name|ret
operator|=
name|copy_AlgorithmIdentifier
argument_list|(
name|sigalg
argument_list|,
operator|&
name|tbsc
operator|->
name|signature
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to copy sigature alg"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* issuer               Name, */
if|if
condition|(
name|issuername
condition|)
name|ret
operator|=
name|copy_Name
argument_list|(
name|issuername
argument_list|,
operator|&
name|tbsc
operator|->
name|issuer
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|hx509_name_to_Name
argument_list|(
name|tbs
operator|->
name|subject
argument_list|,
operator|&
name|tbsc
operator|->
name|issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to copy issuer name"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* validity             Validity, */
name|tbsc
operator|->
name|validity
operator|.
name|notBefore
operator|.
name|element
operator|=
name|choice_Time_generalTime
expr_stmt|;
name|tbsc
operator|->
name|validity
operator|.
name|notBefore
operator|.
name|u
operator|.
name|generalTime
operator|=
name|notBefore
expr_stmt|;
name|tbsc
operator|->
name|validity
operator|.
name|notAfter
operator|.
name|element
operator|=
name|choice_Time_generalTime
expr_stmt|;
name|tbsc
operator|->
name|validity
operator|.
name|notAfter
operator|.
name|u
operator|.
name|generalTime
operator|=
name|notAfter
expr_stmt|;
comment|/* subject              Name, */
if|if
condition|(
name|tbs
operator|->
name|flags
operator|.
name|proxy
condition|)
block|{
name|ret
operator|=
name|build_proxy_prefix
argument_list|(
name|context
argument_list|,
operator|&
name|tbsc
operator|->
name|issuer
argument_list|,
operator|&
name|tbsc
operator|->
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
else|else
block|{
name|ret
operator|=
name|hx509_name_to_Name
argument_list|(
name|tbs
operator|->
name|subject
argument_list|,
operator|&
name|tbsc
operator|->
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to copy subject name"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
comment|/* subjectPublicKeyInfo SubjectPublicKeyInfo, */
name|ret
operator|=
name|copy_SubjectPublicKeyInfo
argument_list|(
operator|&
name|tbs
operator|->
name|spki
argument_list|,
operator|&
name|tbsc
operator|->
name|subjectPublicKeyInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to copy spki"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* issuerUniqueID  [1]  IMPLICIT BIT STRING OPTIONAL */
comment|/* subjectUniqueID [2]  IMPLICIT BIT STRING OPTIONAL */
comment|/* extensions      [3]  EXPLICIT Extensions OPTIONAL */
name|tbsc
operator|->
name|extensions
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tbsc
operator|->
name|extensions
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tbsc
operator|->
name|extensions
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Add the text BMP string Domaincontroller to the cert */
if|if
condition|(
name|tbs
operator|->
name|flags
operator|.
name|domaincontroller
condition|)
block|{
name|data
operator|.
name|data
operator|=
name|rk_UNCONST
argument_list|(
literal|"\x1e\x20\x00\x44\x00\x6f\x00\x6d"
literal|"\x00\x61\x00\x69\x00\x6e\x00\x43"
literal|"\x00\x6f\x00\x6e\x00\x74\x00\x72"
literal|"\x00\x6f\x00\x6c\x00\x6c\x00\x65"
literal|"\x00\x72"
argument_list|)
expr_stmt|;
name|data
operator|.
name|length
operator|=
literal|34
expr_stmt|;
name|ret
operator|=
name|add_extension
argument_list|(
name|context
argument_list|,
name|tbsc
argument_list|,
literal|0
argument_list|,
name|oid_id_ms_cert_enroll_domaincontroller
argument_list|()
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* add KeyUsage */
block|{
name|KeyUsage
name|ku
decl_stmt|;
name|ku
operator|=
name|int2KeyUsage
argument_list|(
name|key_usage
argument_list|)
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|KeyUsage
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|ku
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|data
operator|.
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|add_extension
argument_list|(
name|context
argument_list|,
name|tbsc
argument_list|,
literal|1
argument_list|,
name|oid_id_x509_ce_keyUsage
argument_list|()
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* add ExtendedKeyUsage */
if|if
condition|(
name|tbs
operator|->
name|eku
operator|.
name|len
operator|>
literal|0
condition|)
block|{
name|ASN1_MALLOC_ENCODE
argument_list|(
name|ExtKeyUsage
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|tbs
operator|->
name|eku
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|data
operator|.
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|add_extension
argument_list|(
name|context
argument_list|,
name|tbsc
argument_list|,
literal|0
argument_list|,
name|oid_id_x509_ce_extKeyUsage
argument_list|()
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* add Subject Alternative Name */
if|if
condition|(
name|tbs
operator|->
name|san
operator|.
name|len
operator|>
literal|0
condition|)
block|{
name|ASN1_MALLOC_ENCODE
argument_list|(
name|GeneralNames
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|tbs
operator|->
name|san
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|data
operator|.
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|add_extension
argument_list|(
name|context
argument_list|,
name|tbsc
argument_list|,
literal|0
argument_list|,
name|oid_id_x509_ce_subjectAltName
argument_list|()
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* Add Authority Key Identifier */
if|if
condition|(
name|ai
condition|)
block|{
name|ASN1_MALLOC_ENCODE
argument_list|(
name|AuthorityKeyIdentifier
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
name|ai
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|data
operator|.
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|add_extension
argument_list|(
name|context
argument_list|,
name|tbsc
argument_list|,
literal|0
argument_list|,
name|oid_id_x509_ce_authorityKeyIdentifier
argument_list|()
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* Add Subject Key Identifier */
block|{
name|SubjectKeyIdentifier
name|si
decl_stmt|;
name|unsigned
name|char
name|hash
index|[
name|SHA_DIGEST_LENGTH
index|]
decl_stmt|;
block|{
name|SHA_CTX
name|m
decl_stmt|;
name|SHA1_Init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|SHA1_Update
argument_list|(
operator|&
name|m
argument_list|,
name|tbs
operator|->
name|spki
operator|.
name|subjectPublicKey
operator|.
name|data
argument_list|,
name|tbs
operator|->
name|spki
operator|.
name|subjectPublicKey
operator|.
name|length
operator|/
literal|8
argument_list|)
expr_stmt|;
name|SHA1_Final
argument_list|(
name|hash
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
name|si
operator|.
name|data
operator|=
name|hash
expr_stmt|;
name|si
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|hash
argument_list|)
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|SubjectKeyIdentifier
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|si
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|data
operator|.
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|add_extension
argument_list|(
name|context
argument_list|,
name|tbsc
argument_list|,
literal|0
argument_list|,
name|oid_id_x509_ce_subjectKeyIdentifier
argument_list|()
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* Add BasicConstraints */
block|{
name|BasicConstraints
name|bc
decl_stmt|;
name|int
name|aCA
init|=
literal|1
decl_stmt|;
name|uint32_t
name|path
decl_stmt|;
name|memset
argument_list|(
operator|&
name|bc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tbs
operator|->
name|flags
operator|.
name|ca
condition|)
block|{
name|bc
operator|.
name|cA
operator|=
operator|&
name|aCA
expr_stmt|;
if|if
condition|(
name|tbs
operator|->
name|pathLenConstraint
operator|>=
literal|0
condition|)
block|{
name|path
operator|=
name|tbs
operator|->
name|pathLenConstraint
expr_stmt|;
name|bc
operator|.
name|pathLenConstraint
operator|=
operator|&
name|path
expr_stmt|;
block|}
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|BasicConstraints
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|bc
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|data
operator|.
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
comment|/* Critical if this is a CA */
name|ret
operator|=
name|add_extension
argument_list|(
name|context
argument_list|,
name|tbsc
argument_list|,
name|tbs
operator|->
name|flags
operator|.
name|ca
argument_list|,
name|oid_id_x509_ce_basicConstraints
argument_list|()
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* add Proxy */
if|if
condition|(
name|tbs
operator|->
name|flags
operator|.
name|proxy
condition|)
block|{
name|ProxyCertInfo
name|info
decl_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tbs
operator|->
name|pathLenConstraint
operator|>=
literal|0
condition|)
block|{
name|info
operator|.
name|pCPathLenConstraint
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|info
operator|.
name|pCPathLenConstraint
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|.
name|pCPathLenConstraint
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|info
operator|.
name|pCPathLenConstraint
operator|=
name|tbs
operator|->
name|pathLenConstraint
expr_stmt|;
block|}
name|ret
operator|=
name|der_copy_oid
argument_list|(
name|oid_id_pkix_ppl_inheritAll
argument_list|()
argument_list|,
operator|&
name|info
operator|.
name|proxyPolicy
operator|.
name|policyLanguage
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_ProxyCertInfo
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|ProxyCertInfo
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|info
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_ProxyCertInfo
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|data
operator|.
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|add_extension
argument_list|(
name|context
argument_list|,
name|tbsc
argument_list|,
literal|0
argument_list|,
name|oid_id_pkix_pe_proxyCertInfo
argument_list|()
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|tbs
operator|->
name|crldp
operator|.
name|len
condition|)
block|{
name|ASN1_MALLOC_ENCODE
argument_list|(
name|CRLDistributionPoints
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|tbs
operator|->
name|crldp
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|data
operator|.
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|add_extension
argument_list|(
name|context
argument_list|,
name|tbsc
argument_list|,
name|FALSE
argument_list|,
name|oid_id_x509_ce_cRLDistributionPoints
argument_list|()
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|TBSCertificate
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
name|tbsc
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"malloc out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|data
operator|.
name|length
operator|!=
name|size
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_create_signature_bitstring
argument_list|(
name|context
argument_list|,
name|signer
argument_list|,
name|sigalg
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|c
operator|.
name|signatureAlgorithm
argument_list|,
operator|&
name|c
operator|.
name|signatureValue
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hx509_cert_init
argument_list|(
name|context
argument_list|,
operator|&
name|c
argument_list|,
name|certificate
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|free_Certificate
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|free_Certificate
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_AuthorityKeyIdentifier
parameter_list|(
name|hx509_context
name|context
parameter_list|,
specifier|const
name|Certificate
modifier|*
name|certificate
parameter_list|,
name|AuthorityKeyIdentifier
modifier|*
name|ai
parameter_list|)
block|{
name|SubjectKeyIdentifier
name|si
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|_hx509_find_extension_subject_key_id
argument_list|(
name|certificate
argument_list|,
operator|&
name|si
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|ai
operator|->
name|keyIdentifier
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ai
operator|->
name|keyIdentifier
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|keyIdentifier
operator|==
name|NULL
condition|)
block|{
name|free_SubjectKeyIdentifier
argument_list|(
operator|&
name|si
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|der_copy_octet_string
argument_list|(
operator|&
name|si
argument_list|,
name|ai
operator|->
name|keyIdentifier
argument_list|)
expr_stmt|;
name|free_SubjectKeyIdentifier
argument_list|(
operator|&
name|si
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
name|GeneralNames
name|gns
decl_stmt|;
name|GeneralName
name|gn
decl_stmt|;
name|Name
name|name
decl_stmt|;
name|memset
argument_list|(
operator|&
name|gn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gn
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|gns
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gns
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|ai
operator|->
name|authorityCertIssuer
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ai
operator|->
name|authorityCertIssuer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|authorityCertIssuer
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ai
operator|->
name|authorityCertSerialNumber
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ai
operator|->
name|authorityCertSerialNumber
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|authorityCertSerialNumber
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*  	 * XXX unbreak when asn1 compiler handle IMPLICIT 	 * 	 * This is so horrible. 	 */
name|ret
operator|=
name|copy_Name
argument_list|(
operator|&
name|certificate
operator|->
name|tbsCertificate
operator|.
name|subject
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|authorityCertSerialNumber
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memset
argument_list|(
operator|&
name|gn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gn
argument_list|)
argument_list|)
expr_stmt|;
name|gn
operator|.
name|element
operator|=
name|choice_GeneralName_directoryName
expr_stmt|;
name|gn
operator|.
name|u
operator|.
name|directoryName
operator|.
name|element
operator|=
name|choice_GeneralName_directoryName_rdnSequence
expr_stmt|;
name|gn
operator|.
name|u
operator|.
name|directoryName
operator|.
name|u
operator|.
name|rdnSequence
operator|=
name|name
operator|.
name|u
operator|.
name|rdnSequence
expr_stmt|;
name|ret
operator|=
name|add_GeneralNames
argument_list|(
operator|&
name|gns
argument_list|,
operator|&
name|gn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ai
operator|->
name|authorityCertIssuer
operator|->
name|val
operator|=
name|gns
operator|.
name|val
expr_stmt|;
name|ai
operator|->
name|authorityCertIssuer
operator|->
name|len
operator|=
name|gns
operator|.
name|len
expr_stmt|;
name|ret
operator|=
name|der_copy_heim_integer
argument_list|(
operator|&
name|certificate
operator|->
name|tbsCertificate
operator|.
name|serialNumber
argument_list|,
name|ai
operator|->
name|authorityCertSerialNumber
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|authorityCertSerialNumber
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|out
label|:
if|if
condition|(
name|ret
condition|)
name|free_AuthorityKeyIdentifier
argument_list|(
name|ai
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Sign a to-be-signed certificate object with a issuer certificate.   *  * The caller needs to at least have called the following functions on the  * to-be-signed certificate object:  * - hx509_ca_tbs_init()  * - hx509_ca_tbs_set_subject()  * - hx509_ca_tbs_set_spki()  *  * When done the to-be-signed certificate object should be freed with  * hx509_ca_tbs_free().  *  * When creating self-signed certificate use hx509_ca_sign_self() instead.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param signer the CA certificate object to sign with (need private key).  * @param certificate return cerificate, free with hx509_cert_free().  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_sign
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|hx509_cert
name|signer
parameter_list|,
name|hx509_cert
modifier|*
name|certificate
parameter_list|)
block|{
specifier|const
name|Certificate
modifier|*
name|signer_cert
decl_stmt|;
name|AuthorityKeyIdentifier
name|ai
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ai
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ai
argument_list|)
argument_list|)
expr_stmt|;
name|signer_cert
operator|=
name|_hx509_get_cert
argument_list|(
name|signer
argument_list|)
expr_stmt|;
name|ret
operator|=
name|get_AuthorityKeyIdentifier
argument_list|(
name|context
argument_list|,
name|signer_cert
argument_list|,
operator|&
name|ai
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|ca_sign
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|_hx509_cert_private_key
argument_list|(
name|signer
argument_list|)
argument_list|,
operator|&
name|ai
argument_list|,
operator|&
name|signer_cert
operator|->
name|tbsCertificate
operator|.
name|subject
argument_list|,
name|certificate
argument_list|)
expr_stmt|;
name|out
label|:
name|free_AuthorityKeyIdentifier
argument_list|(
operator|&
name|ai
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Work just like hx509_ca_sign() but signs it-self.  *  * @param context A hx509 context.  * @param tbs object to be signed.  * @param signer private key to sign with.  * @param certificate return cerificate, free with hx509_cert_free().  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_ca  */
end_comment

begin_function
name|int
name|hx509_ca_sign_self
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
name|hx509_private_key
name|signer
parameter_list|,
name|hx509_cert
modifier|*
name|certificate
parameter_list|)
block|{
return|return
name|ca_sign
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|signer
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|certificate
argument_list|)
return|;
block|}
end_function

end_unit


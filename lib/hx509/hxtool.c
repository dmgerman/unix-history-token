begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004 - 2007 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of the Institute nor the names of its contributors   *    may be used to endorse or promote products derived from this software   *    without specific prior written permission.   *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF   * SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|"hx_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: hxtool.c 22333 2007-12-17 01:03:43Z lha $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<hxtool-commands.h>
end_include

begin_include
include|#
directive|include
file|<sl.h>
end_include

begin_include
include|#
directive|include
file|<parse_time.h>
end_include

begin_decl_stmt
specifier|static
name|hx509_context
name|context
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|stat_file_string
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|version_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|help_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|getargs
name|args
index|[]
init|=
block|{
block|{
literal|"statistic-file"
block|,
literal|0
block|,
name|arg_string
block|,
operator|&
name|stat_file_string
block|}
block|,
block|{
literal|"version"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|version_flag
block|}
block|,
block|{
literal|"help"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|help_flag
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|num_args
init|=
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|int
name|code
parameter_list|)
block|{
name|arg_printusage
argument_list|(
name|args
argument_list|,
name|num_args
argument_list|,
name|NULL
argument_list|,
literal|"command"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Use \"%s help\" to get more help\n"
argument_list|,
name|getprogname
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|lock_strings
parameter_list|(
name|hx509_lock
name|lock
parameter_list|,
name|getarg_strings
modifier|*
name|pass
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pass
operator|->
name|num_strings
condition|;
name|i
operator|++
control|)
block|{
name|int
name|ret
init|=
name|hx509_lock_command_string
argument_list|(
name|lock
argument_list|,
name|pass
operator|->
name|strings
index|[
name|i
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_lock_command_string: %s: %d"
argument_list|,
name|pass
operator|->
name|strings
index|[
name|i
index|]
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|certs_strings
parameter_list|(
name|hx509_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
name|hx509_certs
name|certs
parameter_list|,
name|hx509_lock
name|lock
parameter_list|,
specifier|const
name|getarg_strings
modifier|*
name|s
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|s
operator|->
name|num_strings
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|lock
argument_list|,
name|s
operator|->
name|strings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_append: %s %s"
argument_list|,
name|type
argument_list|,
name|s
operator|->
name|strings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|parse_oid
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
specifier|const
name|heim_oid
modifier|*
name|def
parameter_list|,
name|heim_oid
modifier|*
name|oid
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|str
condition|)
name|ret
operator|=
name|der_parse_heim_oid
argument_list|(
name|str
argument_list|,
literal|" ."
argument_list|,
name|oid
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|der_copy_oid
argument_list|(
name|def
argument_list|,
name|oid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"parse_oid failed for: %s"
argument_list|,
name|str
condition|?
name|str
else|:
literal|"default oid"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|peer_strings
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_peer_info
modifier|*
name|peer
parameter_list|,
specifier|const
name|getarg_strings
modifier|*
name|s
parameter_list|)
block|{
name|AlgorithmIdentifier
modifier|*
name|val
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|ret
operator|=
name|hx509_peer_info_alloc
argument_list|(
name|context
argument_list|,
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_peer_info_alloc"
argument_list|)
expr_stmt|;
name|val
operator|=
name|calloc
argument_list|(
name|s
operator|->
name|num_strings
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|val
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|s
operator|->
name|num_strings
condition|;
name|i
operator|++
control|)
name|parse_oid
argument_list|(
name|s
operator|->
name|strings
index|[
name|i
index|]
argument_list|,
name|NULL
argument_list|,
operator|&
name|val
index|[
name|i
index|]
operator|.
name|algorithm
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_peer_info_set_cms_algs
argument_list|(
name|context
argument_list|,
operator|*
name|peer
argument_list|,
name|val
argument_list|,
name|s
operator|->
name|num_strings
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_peer_info_set_cms_algs"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|s
operator|->
name|num_strings
condition|;
name|i
operator|++
control|)
name|free_AlgorithmIdentifier
argument_list|(
operator|&
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|int
name|cms_verify_sd
parameter_list|(
name|struct
name|cms_verify_sd_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_verify_ctx
name|ctx
init|=
name|NULL
decl_stmt|;
name|heim_oid
name|type
decl_stmt|;
name|heim_octet_string
name|c
decl_stmt|,
name|co
decl_stmt|,
name|signeddata
decl_stmt|,
modifier|*
name|sd
init|=
name|NULL
decl_stmt|;
name|hx509_certs
name|store
init|=
name|NULL
decl_stmt|;
name|hx509_certs
name|signers
init|=
name|NULL
decl_stmt|;
name|hx509_certs
name|anchors
init|=
name|NULL
decl_stmt|;
name|hx509_lock
name|lock
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|size_t
name|sz
decl_stmt|;
name|void
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|opt
operator|->
name|missing_revoke_flag
condition|)
name|hx509_context_set_missing_revoke
argument_list|(
name|context
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pass_strings
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_map_file
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|p
argument_list|,
operator|&
name|sz
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"map_file: %s: %d"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|signed_content_string
condition|)
block|{
name|ret
operator|=
name|_hx509_map_file_os
argument_list|(
name|opt
operator|->
name|signed_content_string
argument_list|,
operator|&
name|signeddata
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"map_file: %s: %d"
argument_list|,
name|opt
operator|->
name|signed_content_string
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|sd
operator|=
operator|&
name|signeddata
expr_stmt|;
block|}
name|ret
operator|=
name|hx509_verify_init_ctx
argument_list|(
name|context
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:cms-anchors"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|anchors
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:cert-store"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|store
argument_list|)
expr_stmt|;
name|certs_strings
argument_list|(
name|context
argument_list|,
literal|"anchors"
argument_list|,
name|anchors
argument_list|,
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|anchors_strings
argument_list|)
expr_stmt|;
name|certs_strings
argument_list|(
name|context
argument_list|,
literal|"store"
argument_list|,
name|store
argument_list|,
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|certificate_strings
argument_list|)
expr_stmt|;
name|co
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|co
operator|.
name|length
operator|=
name|sz
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|content_info_flag
condition|)
block|{
name|heim_octet_string
name|uwco
decl_stmt|;
name|heim_oid
name|oid
decl_stmt|;
name|ret
operator|=
name|hx509_cms_unwrap_ContentInfo
argument_list|(
operator|&
name|co
argument_list|,
operator|&
name|oid
argument_list|,
operator|&
name|uwco
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_cms_unwrap_ContentInfo: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|der_heim_oid_cmp
argument_list|(
operator|&
name|oid
argument_list|,
name|oid_id_pkcs7_signedData
argument_list|()
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Content is not SignedData"
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|oid
argument_list|)
expr_stmt|;
name|co
operator|=
name|uwco
expr_stmt|;
block|}
name|hx509_verify_attach_anchors
argument_list|(
name|ctx
argument_list|,
name|anchors
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cms_verify_signed
argument_list|(
name|context
argument_list|,
name|ctx
argument_list|,
name|co
operator|.
name|data
argument_list|,
name|co
operator|.
name|length
argument_list|,
name|sd
argument_list|,
name|store
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|signers
argument_list|)
expr_stmt|;
if|if
condition|(
name|co
operator|.
name|data
operator|!=
name|p
condition|)
name|der_free_octet_string
argument_list|(
operator|&
name|co
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_cms_verify_signed"
argument_list|)
expr_stmt|;
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|der_print_heim_oid
argument_list|(
operator|&
name|type
argument_list|,
literal|'.'
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type: %s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|type
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"signers:\n"
argument_list|)
expr_stmt|;
name|hx509_certs_iter
argument_list|(
name|context
argument_list|,
name|signers
argument_list|,
name|hx509_ci_print_names
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|hx509_verify_destroy_ctx
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|store
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|signers
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|anchors
argument_list|)
expr_stmt|;
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_write_file
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|c
operator|.
name|data
argument_list|,
name|c
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_write_file: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|der_free_octet_string
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
name|_hx509_unmap_file
argument_list|(
name|p
argument_list|,
name|sz
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
condition|)
name|_hx509_unmap_file_os
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cms_create_sd
parameter_list|(
name|struct
name|cms_create_sd_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|heim_oid
name|contentType
decl_stmt|;
name|hx509_peer_info
name|peer
init|=
name|NULL
decl_stmt|;
name|heim_octet_string
name|o
decl_stmt|;
name|hx509_query
modifier|*
name|q
decl_stmt|;
name|hx509_lock
name|lock
decl_stmt|;
name|hx509_certs
name|store
decl_stmt|,
name|pool
decl_stmt|,
name|anchors
decl_stmt|;
name|hx509_cert
name|cert
decl_stmt|;
name|size_t
name|sz
decl_stmt|;
name|void
modifier|*
name|p
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|flags
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|signer_name
init|=
name|NULL
decl_stmt|;
name|memset
argument_list|(
operator|&
name|contentType
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|contentType
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"argc< 2"
argument_list|)
expr_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pass_strings
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:cert-store"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|store
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:cert-pool"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|pool
argument_list|)
expr_stmt|;
name|certs_strings
argument_list|(
name|context
argument_list|,
literal|"store"
argument_list|,
name|store
argument_list|,
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|certificate_strings
argument_list|)
expr_stmt|;
name|certs_strings
argument_list|(
name|context
argument_list|,
literal|"pool"
argument_list|,
name|pool
argument_list|,
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pool_strings
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|anchors_strings
operator|.
name|num_strings
condition|)
block|{
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:cert-anchors"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|anchors
argument_list|)
expr_stmt|;
name|certs_strings
argument_list|(
name|context
argument_list|,
literal|"anchors"
argument_list|,
name|anchors
argument_list|,
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|anchors_strings
argument_list|)
expr_stmt|;
block|}
else|else
name|anchors
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|detached_signature_flag
condition|)
name|flags
operator||=
name|HX509_CMS_SIGATURE_DETACHED
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|id_by_name_flag
condition|)
name|flags
operator||=
name|HX509_CMS_SIGATURE_ID_NAME
expr_stmt|;
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|context
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_query_alloc: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_PRIVATE_KEY
argument_list|)
expr_stmt|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_KU_DIGITALSIGNATURE
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|signer_string
condition|)
name|hx509_query_match_friendly_name
argument_list|(
name|q
argument_list|,
name|opt
operator|->
name|signer_string
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
argument_list|,
name|store
argument_list|,
name|q
argument_list|,
operator|&
name|cert
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|context
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_find"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_map_file
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|p
argument_list|,
operator|&
name|sz
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"map_file: %s: %d"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|peer_alg_strings
operator|.
name|num_strings
condition|)
name|peer_strings
argument_list|(
name|context
argument_list|,
operator|&
name|peer
argument_list|,
operator|&
name|opt
operator|->
name|peer_alg_strings
argument_list|)
expr_stmt|;
name|parse_oid
argument_list|(
name|opt
operator|->
name|content_type_string
argument_list|,
name|oid_id_pkcs7_data
argument_list|()
argument_list|,
operator|&
name|contentType
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cms_create_signed_1
argument_list|(
name|context
argument_list|,
name|flags
argument_list|,
operator|&
name|contentType
argument_list|,
name|p
argument_list|,
name|sz
argument_list|,
name|NULL
argument_list|,
name|cert
argument_list|,
name|peer
argument_list|,
name|anchors
argument_list|,
name|pool
argument_list|,
operator|&
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_cms_create_signed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|{
name|hx509_name
name|name
decl_stmt|;
name|ret
operator|=
name|hx509_cert_get_subject
argument_list|(
name|cert
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_cert_get_subject"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_name_to_string
argument_list|(
name|name
argument_list|,
operator|&
name|signer_name
argument_list|)
expr_stmt|;
name|hx509_name_free
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_name_to_string"
argument_list|)
expr_stmt|;
block|}
name|hx509_certs_free
argument_list|(
operator|&
name|anchors
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|pool
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|store
argument_list|)
expr_stmt|;
name|_hx509_unmap_file
argument_list|(
name|p
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
name|hx509_peer_info_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|contentType
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|content_info_flag
condition|)
block|{
name|heim_octet_string
name|wo
decl_stmt|;
name|ret
operator|=
name|hx509_cms_wrap_ContentInfo
argument_list|(
name|oid_id_pkcs7_signedData
argument_list|()
argument_list|,
operator|&
name|o
argument_list|,
operator|&
name|wo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_cms_wrap_ContentInfo: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|der_free_octet_string
argument_list|(
operator|&
name|o
argument_list|)
expr_stmt|;
name|o
operator|=
name|wo
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|pem_flag
condition|)
block|{
name|hx509_pem_header
modifier|*
name|header
init|=
name|NULL
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|hx509_pem_add_header
argument_list|(
operator|&
name|header
argument_list|,
literal|"Content-disposition"
argument_list|,
name|opt
operator|->
name|detached_signature_flag
condition|?
literal|"detached"
else|:
literal|"inline"
argument_list|)
expr_stmt|;
name|hx509_pem_add_header
argument_list|(
operator|&
name|header
argument_list|,
literal|"Signer"
argument_list|,
name|signer_name
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open %s"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_pem_write
argument_list|(
name|context
argument_list|,
literal|"CMS SIGNEDDATA"
argument_list|,
name|header
argument_list|,
name|f
argument_list|,
name|o
operator|.
name|data
argument_list|,
name|o
operator|.
name|length
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|hx509_pem_free_header
argument_list|(
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_pem_write: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|_hx509_write_file
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|o
operator|.
name|data
argument_list|,
name|o
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_write_file: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|signer_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|o
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cms_unenvelope
parameter_list|(
name|struct
name|cms_unenvelope_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|heim_oid
name|contentType
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
name|heim_octet_string
name|o
decl_stmt|,
name|co
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
name|size_t
name|sz
decl_stmt|;
name|void
modifier|*
name|p
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|hx509_lock
name|lock
decl_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pass_strings
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_map_file
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|p
argument_list|,
operator|&
name|sz
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"map_file: %s: %d"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|co
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|co
operator|.
name|length
operator|=
name|sz
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|content_info_flag
condition|)
block|{
name|heim_octet_string
name|uwco
decl_stmt|;
name|heim_oid
name|oid
decl_stmt|;
name|ret
operator|=
name|hx509_cms_unwrap_ContentInfo
argument_list|(
operator|&
name|co
argument_list|,
operator|&
name|oid
argument_list|,
operator|&
name|uwco
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_cms_unwrap_ContentInfo: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|der_heim_oid_cmp
argument_list|(
operator|&
name|oid
argument_list|,
name|oid_id_pkcs7_envelopedData
argument_list|()
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Content is not SignedData"
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|oid
argument_list|)
expr_stmt|;
name|co
operator|=
name|uwco
expr_stmt|;
block|}
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:cert-store"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_certs_init: MEMORY: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|certs_strings
argument_list|(
name|context
argument_list|,
literal|"store"
argument_list|,
name|certs
argument_list|,
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|certificate_strings
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cms_unenvelope
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
literal|0
argument_list|,
name|co
operator|.
name|data
argument_list|,
name|co
operator|.
name|length
argument_list|,
name|NULL
argument_list|,
operator|&
name|contentType
argument_list|,
operator|&
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
name|co
operator|.
name|data
operator|!=
name|p
condition|)
name|der_free_octet_string
argument_list|(
operator|&
name|co
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_cms_unenvelope"
argument_list|)
expr_stmt|;
name|_hx509_unmap_file
argument_list|(
name|p
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|contentType
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_write_file
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|o
operator|.
name|data
argument_list|,
name|o
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_write_file: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|der_free_octet_string
argument_list|(
operator|&
name|o
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cms_create_enveloped
parameter_list|(
name|struct
name|cms_envelope_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|heim_oid
name|contentType
decl_stmt|;
name|heim_octet_string
name|o
decl_stmt|;
specifier|const
name|heim_oid
modifier|*
name|enctype
init|=
name|NULL
decl_stmt|;
name|hx509_query
modifier|*
name|q
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
name|hx509_cert
name|cert
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|size_t
name|sz
decl_stmt|;
name|void
modifier|*
name|p
decl_stmt|;
name|hx509_lock
name|lock
decl_stmt|;
name|memset
argument_list|(
operator|&
name|contentType
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|contentType
argument_list|)
argument_list|)
expr_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pass_strings
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_map_file
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|p
argument_list|,
operator|&
name|sz
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"map_file: %s: %d"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:cert-store"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
name|certs_strings
argument_list|(
name|context
argument_list|,
literal|"store"
argument_list|,
name|certs
argument_list|,
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|certificate_strings
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|encryption_type_string
condition|)
block|{
name|enctype
operator|=
name|hx509_crypto_enctype_by_name
argument_list|(
name|opt
operator|->
name|encryption_type_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|enctype
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"encryption type: %s no found"
argument_list|,
name|opt
operator|->
name|encryption_type_string
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|context
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_query_alloc: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_KU_ENCIPHERMENT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|q
argument_list|,
operator|&
name|cert
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|context
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_certs_find: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|parse_oid
argument_list|(
name|opt
operator|->
name|content_type_string
argument_list|,
name|oid_id_pkcs7_data
argument_list|()
argument_list|,
operator|&
name|contentType
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cms_envelope_1
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|cert
argument_list|,
name|p
argument_list|,
name|sz
argument_list|,
name|enctype
argument_list|,
operator|&
name|contentType
argument_list|,
operator|&
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_cms_envelope_1: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
name|_hx509_unmap_file
argument_list|(
name|p
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|contentType
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|content_info_flag
condition|)
block|{
name|heim_octet_string
name|wo
decl_stmt|;
name|ret
operator|=
name|hx509_cms_wrap_ContentInfo
argument_list|(
name|oid_id_pkcs7_envelopedData
argument_list|()
argument_list|,
operator|&
name|o
argument_list|,
operator|&
name|wo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_cms_wrap_ContentInfo: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|der_free_octet_string
argument_list|(
operator|&
name|o
argument_list|)
expr_stmt|;
name|o
operator|=
name|wo
expr_stmt|;
block|}
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_write_file
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|o
operator|.
name|data
argument_list|,
name|o
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_write_file: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|der_free_octet_string
argument_list|(
operator|&
name|o
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_certificate
parameter_list|(
name|hx509_context
name|hxcontext
parameter_list|,
name|hx509_cert
name|cert
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
name|hx509_name
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|fn
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|fn
operator|=
name|hx509_cert_get_friendly_name
argument_list|(
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|fn
condition|)
name|printf
argument_list|(
literal|"    friendly name: %s\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    private key: %s\n"
argument_list|,
name|_hx509_cert_private_key
argument_list|(
name|cert
argument_list|)
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cert_get_issuer
argument_list|(
name|cert
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|hx509_name_to_string
argument_list|(
name|name
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
name|hx509_name_free
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    issuer:  \"%s\"\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cert_get_subject
argument_list|(
name|cert
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|hx509_name_to_string
argument_list|(
name|name
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
name|hx509_name_free
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    subject: \"%s\"\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|{
name|heim_integer
name|serialNumber
decl_stmt|;
name|hx509_cert_get_serialnumber
argument_list|(
name|cert
argument_list|,
operator|&
name|serialNumber
argument_list|)
expr_stmt|;
name|der_print_hex_heim_integer
argument_list|(
operator|&
name|serialNumber
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|serialNumber
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    serial: %s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"    keyusage: "
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cert_keyusage_print
argument_list|(
name|hxcontext
argument_list|,
name|cert
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"no"
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|hx509_validate_ctx
name|vctx
decl_stmt|;
name|hx509_validate_ctx_init
argument_list|(
name|hxcontext
argument_list|,
operator|&
name|vctx
argument_list|)
expr_stmt|;
name|hx509_validate_ctx_set_print
argument_list|(
name|vctx
argument_list|,
name|hx509_print_stdout
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|hx509_validate_ctx_add_flags
argument_list|(
name|vctx
argument_list|,
name|HX509_VALIDATE_F_VALIDATE
argument_list|)
expr_stmt|;
name|hx509_validate_ctx_add_flags
argument_list|(
name|vctx
argument_list|,
name|HX509_VALIDATE_F_VERBOSE
argument_list|)
expr_stmt|;
name|hx509_validate_cert
argument_list|(
name|hxcontext
argument_list|,
name|vctx
argument_list|,
name|cert
argument_list|)
expr_stmt|;
name|hx509_validate_ctx_free
argument_list|(
name|vctx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|print_s
block|{
name|int
name|counter
decl_stmt|;
name|int
name|verbose
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|print_f
parameter_list|(
name|hx509_context
name|hxcontext
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|hx509_cert
name|cert
parameter_list|)
block|{
name|struct
name|print_s
modifier|*
name|s
init|=
name|ctx
decl_stmt|;
name|printf
argument_list|(
literal|"cert: %d\n"
argument_list|,
name|s
operator|->
name|counter
operator|++
argument_list|)
expr_stmt|;
name|print_certificate
argument_list|(
name|context
argument_list|,
name|cert
argument_list|,
name|s
operator|->
name|verbose
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pcert_print
parameter_list|(
name|struct
name|print_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_certs
name|certs
decl_stmt|;
name|hx509_lock
name|lock
decl_stmt|;
name|struct
name|print_s
name|s
decl_stmt|;
name|s
operator|.
name|counter
operator|=
literal|0
expr_stmt|;
name|s
operator|.
name|verbose
operator|=
name|opt
operator|->
name|content_flag
expr_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pass_strings
argument_list|)
expr_stmt|;
while|while
condition|(
name|argc
operator|--
condition|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
name|lock
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_init"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|info_flag
condition|)
name|hx509_certs_info
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|hx509_certs_iter
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|print_f
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|validate_f
parameter_list|(
name|hx509_context
name|hxcontext
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|hx509_cert
name|c
parameter_list|)
block|{
name|hx509_validate_cert
argument_list|(
name|hxcontext
argument_list|,
name|ctx
argument_list|,
name|c
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pcert_validate
parameter_list|(
name|struct
name|validate_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_validate_ctx
name|ctx
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
name|hx509_lock
name|lock
decl_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pass_strings
argument_list|)
expr_stmt|;
name|hx509_validate_ctx_init
argument_list|(
name|context
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|hx509_validate_ctx_set_print
argument_list|(
name|ctx
argument_list|,
name|hx509_print_stdout
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|hx509_validate_ctx_add_flags
argument_list|(
name|ctx
argument_list|,
name|HX509_VALIDATE_F_VALIDATE
argument_list|)
expr_stmt|;
while|while
condition|(
name|argc
operator|--
condition|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
name|lock
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_certs_init: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|hx509_certs_iter
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|validate_f
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
name|hx509_validate_ctx_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|certificate_copy
parameter_list|(
name|struct
name|certificate_copy_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_certs
name|certs
decl_stmt|;
name|hx509_lock
name|lock
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|in_pass_strings
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
name|argv
index|[
name|argc
operator|-
literal|1
index|]
argument_list|,
name|HX509_CERTS_CREATE
argument_list|,
name|lock
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_init"
argument_list|)
expr_stmt|;
while|while
condition|(
name|argc
operator|--
operator|>
literal|1
condition|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|lock
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_append"
argument_list|)
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
name|ret
operator|=
name|hx509_certs_store
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_store"
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|verify
block|{
name|hx509_verify_ctx
name|ctx
decl_stmt|;
name|hx509_certs
name|chain
decl_stmt|;
specifier|const
name|char
modifier|*
name|hostname
decl_stmt|;
name|int
name|errors
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|verify_f
parameter_list|(
name|hx509_context
name|hxcontext
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|hx509_cert
name|c
parameter_list|)
block|{
name|struct
name|verify
modifier|*
name|v
init|=
name|ctx
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|hx509_verify_path
argument_list|(
name|hxcontext
argument_list|,
name|v
operator|->
name|ctx
argument_list|,
name|c
argument_list|,
name|v
operator|->
name|chain
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|char
modifier|*
name|s
init|=
name|hx509_get_error_string
argument_list|(
name|hxcontext
argument_list|,
name|ret
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"verify_path: %s: %d\n"
argument_list|,
name|s
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|hx509_free_error_string
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|v
operator|->
name|errors
operator|++
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"path ok\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|hostname
condition|)
block|{
name|ret
operator|=
name|hx509_verify_hostname
argument_list|(
name|hxcontext
argument_list|,
name|c
argument_list|,
literal|0
argument_list|,
name|HX509_HN_HOSTNAME
argument_list|,
name|v
operator|->
name|hostname
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"verify_hostname: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|v
operator|->
name|errors
operator|++
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pcert_verify
parameter_list|(
name|struct
name|verify_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_certs
name|anchors
decl_stmt|,
name|chain
decl_stmt|,
name|certs
decl_stmt|;
name|hx509_revoke_ctx
name|revoke_ctx
decl_stmt|;
name|hx509_verify_ctx
name|ctx
decl_stmt|;
name|struct
name|verify
name|v
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|v
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|v
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|missing_revoke_flag
condition|)
name|hx509_context_set_missing_revoke
argument_list|(
name|context
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_verify_init_ctx
argument_list|(
name|context
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:anchors"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|anchors
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:chain"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|chain
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:certs"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|allow_proxy_certificate_flag
condition|)
name|hx509_verify_set_proxy_certificate
argument_list|(
name|ctx
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|time_string
condition|)
block|{
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|struct
name|tm
name|tm
decl_stmt|;
name|time_t
name|t
decl_stmt|;
name|memset
argument_list|(
operator|&
name|tm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tm
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
name|strptime
argument_list|(
name|opt
operator|->
name|time_string
argument_list|,
literal|"%Y-%m-%d"
argument_list|,
operator|&
name|tm
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Failed to parse time %s, need to be on format %%Y-%%m-%%d"
argument_list|,
name|opt
operator|->
name|time_string
argument_list|)
expr_stmt|;
name|t
operator|=
name|tm2time
argument_list|(
name|tm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hx509_verify_set_time
argument_list|(
name|ctx
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|hostname_string
condition|)
name|v
operator|.
name|hostname
operator|=
name|opt
operator|->
name|hostname_string
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|max_depth_integer
condition|)
name|hx509_verify_set_max_depth
argument_list|(
name|ctx
argument_list|,
name|opt
operator|->
name|max_depth_integer
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_revoke_init
argument_list|(
name|context
argument_list|,
operator|&
name|revoke_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_revoke_init: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
while|while
condition|(
name|argc
operator|--
condition|)
block|{
name|char
modifier|*
name|s
init|=
operator|*
name|argv
operator|++
decl_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"chain:"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|+=
literal|6
expr_stmt|;
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
argument_list|,
name|chain
argument_list|,
name|NULL
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_append: chain: %s: %d"
argument_list|,
name|s
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"anchor:"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|+=
literal|7
expr_stmt|;
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
argument_list|,
name|anchors
argument_list|,
name|NULL
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_append: anchor: %s: %d"
argument_list|,
name|s
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"cert:"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|+=
literal|5
expr_stmt|;
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|NULL
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_append: certs: %s: %d"
argument_list|,
name|s
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"crl:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|+=
literal|4
expr_stmt|;
name|ret
operator|=
name|hx509_revoke_add_crl
argument_list|(
name|context
argument_list|,
name|revoke_ctx
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_revoke_add_crl: %s: %d"
argument_list|,
name|s
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"ocsp:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|+=
literal|5
expr_stmt|;
name|ret
operator|=
name|hx509_revoke_add_ocsp
argument_list|(
name|context
argument_list|,
name|revoke_ctx
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_revoke_add_ocsp: %s: %d"
argument_list|,
name|s
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown option to verify: `%s'\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
block|}
name|hx509_verify_attach_anchors
argument_list|(
name|ctx
argument_list|,
name|anchors
argument_list|)
expr_stmt|;
name|hx509_verify_attach_revoke
argument_list|(
name|ctx
argument_list|,
name|revoke_ctx
argument_list|)
expr_stmt|;
name|v
operator|.
name|ctx
operator|=
name|ctx
expr_stmt|;
name|v
operator|.
name|chain
operator|=
name|chain
expr_stmt|;
name|hx509_certs_iter
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|verify_f
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
name|hx509_verify_destroy_ctx
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|chain
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|anchors
argument_list|)
expr_stmt|;
name|hx509_revoke_free
argument_list|(
operator|&
name|revoke_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|.
name|errors
condition|)
block|{
name|printf
argument_list|(
literal|"failed verifing %d checks\n"
argument_list|,
name|v
operator|.
name|errors
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|query
parameter_list|(
name|struct
name|query_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_lock
name|lock
decl_stmt|;
name|hx509_query
modifier|*
name|q
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
name|hx509_cert
name|c
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|context
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_query_alloc: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pass_strings
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:cert-store"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|lock
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_certs_append: %s: %d"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|friendlyname_string
condition|)
name|hx509_query_match_friendly_name
argument_list|(
name|q
argument_list|,
name|opt
operator|->
name|friendlyname_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|private_key_flag
condition|)
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_PRIVATE_KEY
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|keyEncipherment_flag
condition|)
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_KU_ENCIPHERMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|digitalSignature_flag
condition|)
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_KU_DIGITALSIGNATURE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|q
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|context
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|printf
argument_list|(
literal|"no match found (%d)\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"match found\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|print_flag
condition|)
name|print_certificate
argument_list|(
name|context
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|hx509_cert_free
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|ocsp_fetch
parameter_list|(
name|struct
name|ocsp_fetch_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_certs
name|reqcerts
decl_stmt|,
name|pool
decl_stmt|;
name|heim_octet_string
name|req
decl_stmt|,
name|nonce_data
decl_stmt|,
modifier|*
name|nonce
init|=
operator|&
name|nonce_data
decl_stmt|;
name|hx509_lock
name|lock
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|char
modifier|*
name|file
decl_stmt|;
specifier|const
name|char
modifier|*
name|url
init|=
literal|"/"
decl_stmt|;
name|memset
argument_list|(
operator|&
name|nonce
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pass_strings
argument_list|)
expr_stmt|;
comment|/* no nonce */
if|if
condition|(
operator|!
name|opt
operator|->
name|nonce_flag
condition|)
name|nonce
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|url_path_string
condition|)
name|url
operator|=
name|opt
operator|->
name|url_path_string
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:ocsp-pool"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|pool
argument_list|)
expr_stmt|;
name|certs_strings
argument_list|(
name|context
argument_list|,
literal|"ocsp-pool"
argument_list|,
name|pool
argument_list|,
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pool_strings
argument_list|)
expr_stmt|;
name|file
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:ocsp-req"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|reqcerts
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
argument_list|,
name|reqcerts
argument_list|,
name|lock
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_certs_append: req: %s: %d"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|hx509_ocsp_request
argument_list|(
name|context
argument_list|,
name|reqcerts
argument_list|,
name|pool
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|req
argument_list|,
name|nonce
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_ocsp_request: req: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
name|abort
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"POST %s HTTP/1.0\r\n"
literal|"Content-Type: application/ocsp-request\r\n"
literal|"Content-Length: %ld\r\n"
literal|"\r\n"
argument_list|,
name|url
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|req
operator|.
name|length
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|req
operator|.
name|data
argument_list|,
name|req
operator|.
name|length
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nonce
condition|)
name|der_free_octet_string
argument_list|(
name|nonce
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|reqcerts
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|pool
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ocsp_print
parameter_list|(
name|struct
name|ocsp_print_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_revoke_ocsp_print
argument_list|(
name|context
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int
name|verify_o
parameter_list|(
name|hx509_context
name|hxcontext
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|hx509_cert
name|c
parameter_list|)
block|{
name|heim_octet_string
modifier|*
name|os
init|=
name|ctx
decl_stmt|;
name|time_t
name|expiration
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|hx509_ocsp_verify
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|c
argument_list|,
literal|0
argument_list|,
name|os
operator|->
name|data
argument_list|,
name|os
operator|->
name|length
argument_list|,
operator|&
name|expiration
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|char
modifier|*
name|s
init|=
name|hx509_get_error_string
argument_list|(
name|hxcontext
argument_list|,
name|ret
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"ocsp_verify: %s: %d\n"
argument_list|,
name|s
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|hx509_free_error_string
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"expire: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|expiration
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|ocsp_verify
parameter_list|(
name|struct
name|ocsp_verify_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_lock
name|lock
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|heim_octet_string
name|os
decl_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|ocsp_file_string
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"no ocsp file given"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_map_file
argument_list|(
name|opt
operator|->
name|ocsp_file_string
argument_list|,
operator|&
name|os
operator|.
name|data
argument_list|,
operator|&
name|os
operator|.
name|length
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"map_file: %s: %d"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:test-certs"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|lock
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_append: %s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|hx509_certs_iter
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|verify_o
argument_list|,
operator|&
name|os
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
name|_hx509_unmap_file
argument_list|(
name|os
operator|.
name|data
argument_list|,
name|os
operator|.
name|length
argument_list|)
expr_stmt|;
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|read_private_key
parameter_list|(
specifier|const
name|char
modifier|*
name|fn
parameter_list|,
name|hx509_private_key
modifier|*
name|key
parameter_list|)
block|{
name|hx509_private_key
modifier|*
name|keys
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
name|int
name|ret
decl_stmt|;
operator|*
name|key
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
name|fn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_init: %s"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_certs_keys_get
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
operator|&
name|keys
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_keys_get"
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"no keys in key store: %s"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
operator|*
name|key
operator|=
name|_hx509_private_key_ref
argument_list|(
name|keys
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|_hx509_certs_keys_free
argument_list|(
name|context
argument_list|,
name|keys
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_key
parameter_list|(
specifier|const
name|char
modifier|*
name|fn
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
name|int
name|optbits
parameter_list|,
name|hx509_private_key
modifier|*
name|signer
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|type
condition|)
block|{
name|BIGNUM
modifier|*
name|e
decl_stmt|;
name|RSA
modifier|*
name|rsa
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p0
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|bits
init|=
literal|1024
decl_stmt|;
if|if
condition|(
name|fn
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"no key argument, don't know here to store key"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|type
argument_list|,
literal|"rsa"
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"can only handle rsa keys for now"
argument_list|)
expr_stmt|;
name|e
operator|=
name|BN_new
argument_list|()
expr_stmt|;
name|BN_set_word
argument_list|(
name|e
argument_list|,
literal|0x10001
argument_list|)
expr_stmt|;
if|if
condition|(
name|optbits
condition|)
name|bits
operator|=
name|optbits
expr_stmt|;
name|rsa
operator|=
name|RSA_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|rsa
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"RSA_new failed"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RSA_generate_key_ex
argument_list|(
name|rsa
argument_list|,
name|bits
argument_list|,
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"RSA_new failed"
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|len
operator|=
name|i2d_RSAPrivateKey
argument_list|(
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|p0
operator|=
name|p
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|i2d_RSAPrivateKey
argument_list|(
name|rsa
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|rk_dumpdata
argument_list|(
name|fn
argument_list|,
name|p0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p0
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p0
argument_list|)
expr_stmt|;
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fn
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"no private key"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|read_private_key
argument_list|(
name|fn
argument_list|,
name|signer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"read_private_key"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|request_create
parameter_list|(
name|struct
name|request_create_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|heim_octet_string
name|request
decl_stmt|;
name|hx509_request
name|req
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|hx509_private_key
name|signer
decl_stmt|;
name|SubjectPublicKeyInfo
name|key
decl_stmt|;
specifier|const
name|char
modifier|*
name|outfile
init|=
name|argv
index|[
literal|0
index|]
decl_stmt|;
name|memset
argument_list|(
operator|&
name|key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|get_key
argument_list|(
name|opt
operator|->
name|key_string
argument_list|,
name|opt
operator|->
name|generate_key_string
argument_list|,
name|opt
operator|->
name|key_bits_integer
argument_list|,
operator|&
name|signer
argument_list|)
expr_stmt|;
name|_hx509_request_init
argument_list|(
name|context
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|subject_string
condition|)
block|{
name|hx509_name
name|name
init|=
name|NULL
decl_stmt|;
name|ret
operator|=
name|hx509_parse_name
argument_list|(
name|context
argument_list|,
name|opt
operator|->
name|subject_string
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_parse_name: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|_hx509_request_set_name
argument_list|(
name|context
argument_list|,
name|req
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|verbose_flag
condition|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|hx509_name_to_string
argument_list|(
name|name
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
name|hx509_name_free
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|opt
operator|->
name|email_strings
operator|.
name|num_strings
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|_hx509_request_add_email
argument_list|(
name|context
argument_list|,
name|req
argument_list|,
name|opt
operator|->
name|email_strings
operator|.
name|strings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|opt
operator|->
name|dnsname_strings
operator|.
name|num_strings
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|_hx509_request_add_dns_name
argument_list|(
name|context
argument_list|,
name|req
argument_list|,
name|opt
operator|->
name|dnsname_strings
operator|.
name|strings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|_hx509_private_key2SPKI
argument_list|(
name|context
argument_list|,
name|signer
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"_hx509_private_key2SPKI: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_request_set_SubjectPublicKeyInfo
argument_list|(
name|context
argument_list|,
name|req
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|free_SubjectPublicKeyInfo
argument_list|(
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"_hx509_request_set_SubjectPublicKeyInfo"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_request_to_pkcs10
argument_list|(
name|context
argument_list|,
name|req
argument_list|,
name|signer
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"_hx509_request_to_pkcs10"
argument_list|)
expr_stmt|;
name|_hx509_private_key_free
argument_list|(
operator|&
name|signer
argument_list|)
expr_stmt|;
name|_hx509_request_free
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|rk_dumpdata
argument_list|(
name|outfile
argument_list|,
name|request
operator|.
name|data
argument_list|,
name|request
operator|.
name|length
argument_list|)
expr_stmt|;
name|der_free_octet_string
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|request_print
parameter_list|(
name|struct
name|request_print_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"request print\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|hx509_request
name|req
decl_stmt|;
name|ret
operator|=
name|_hx509_request_parse
argument_list|(
name|context
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"parse_request: %s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_request_print
argument_list|(
name|context
argument_list|,
name|req
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|_hx509_request_free
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"Failed to print file %s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|info
parameter_list|(
name|void
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|ENGINE_add_conf_module
argument_list|()
expr_stmt|;
block|{
specifier|const
name|RSA_METHOD
modifier|*
name|m
init|=
name|RSA_get_default_method
argument_list|()
decl_stmt|;
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"rsa: %s\n"
argument_list|,
name|m
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
block|{
specifier|const
name|DH_METHOD
modifier|*
name|m
init|=
name|DH_get_default_method
argument_list|()
decl_stmt|;
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"dh: %s\n"
argument_list|,
name|m
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
block|{
name|int
name|ret
init|=
name|RAND_status
argument_list|()
decl_stmt|;
name|printf
argument_list|(
literal|"rand: %s\n"
argument_list|,
name|ret
operator|==
literal|1
condition|?
literal|"ok"
else|:
literal|"not available"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|random_data
parameter_list|(
name|void
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|void
modifier|*
name|ptr
decl_stmt|;
name|int
name|len
decl_stmt|,
name|ret
decl_stmt|;
name|len
operator|=
name|parse_bytes
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"byte"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad argument to random-data\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|ptr
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"out of memory\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|ret
operator|=
name|RAND_bytes
argument_list|(
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|1
condition|)
block|{
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"did not get cryptographic strong random\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|fwrite
argument_list|(
name|ptr
argument_list|,
name|len
argument_list|,
literal|1
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|crypto_available
parameter_list|(
name|struct
name|crypto_available_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|AlgorithmIdentifier
modifier|*
name|val
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|,
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|type
decl_stmt|;
if|if
condition|(
name|opt
operator|->
name|type_string
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|opt
operator|->
name|type_string
argument_list|,
literal|"all"
argument_list|)
operator|==
literal|0
condition|)
name|type
operator|=
name|HX509_SELECT_ALL
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
operator|->
name|type_string
argument_list|,
literal|"digest"
argument_list|)
operator|==
literal|0
condition|)
name|type
operator|=
name|HX509_SELECT_DIGEST
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
operator|->
name|type_string
argument_list|,
literal|"public-sig"
argument_list|)
operator|==
literal|0
condition|)
name|type
operator|=
name|HX509_SELECT_PUBLIC_SIG
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
operator|->
name|type_string
argument_list|,
literal|"secret"
argument_list|)
operator|==
literal|0
condition|)
name|type
operator|=
name|HX509_SELECT_SECRET_ENC
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown type: %s"
argument_list|,
name|opt
operator|->
name|type_string
argument_list|)
expr_stmt|;
block|}
else|else
name|type
operator|=
name|HX509_SELECT_ALL
expr_stmt|;
name|ret
operator|=
name|hx509_crypto_available
argument_list|(
name|context
argument_list|,
name|type
argument_list|,
name|NULL
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_crypto_available"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|der_print_heim_oid
argument_list|(
operator|&
name|val
index|[
name|i
index|]
operator|.
name|algorithm
argument_list|,
literal|'.'
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|hx509_crypto_free_algs
argument_list|(
name|val
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|crypto_select
parameter_list|(
name|struct
name|crypto_select_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_peer_info
name|peer
init|=
name|NULL
decl_stmt|;
name|AlgorithmIdentifier
name|selected
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|type
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|opt
operator|->
name|type_string
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|opt
operator|->
name|type_string
argument_list|,
literal|"digest"
argument_list|)
operator|==
literal|0
condition|)
name|type
operator|=
name|HX509_SELECT_DIGEST
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
operator|->
name|type_string
argument_list|,
literal|"public-sig"
argument_list|)
operator|==
literal|0
condition|)
name|type
operator|=
name|HX509_SELECT_PUBLIC_SIG
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|opt
operator|->
name|type_string
argument_list|,
literal|"secret"
argument_list|)
operator|==
literal|0
condition|)
name|type
operator|=
name|HX509_SELECT_SECRET_ENC
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown type: %s"
argument_list|,
name|opt
operator|->
name|type_string
argument_list|)
expr_stmt|;
block|}
else|else
name|type
operator|=
name|HX509_SELECT_DIGEST
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|peer_cmstype_strings
operator|.
name|num_strings
condition|)
name|peer_strings
argument_list|(
name|context
argument_list|,
operator|&
name|peer
argument_list|,
operator|&
name|opt
operator|->
name|peer_cmstype_strings
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_crypto_select
argument_list|(
name|context
argument_list|,
name|type
argument_list|,
name|NULL
argument_list|,
name|peer
argument_list|,
operator|&
name|selected
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_crypto_available"
argument_list|)
expr_stmt|;
name|der_print_heim_oid
argument_list|(
operator|&
name|selected
operator|.
name|algorithm
argument_list|,
literal|'.'
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|free_AlgorithmIdentifier
argument_list|(
operator|&
name|selected
argument_list|)
expr_stmt|;
name|hx509_peer_info_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|hxtool_hex
parameter_list|(
name|struct
name|hex_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
if|if
condition|(
name|opt
operator|->
name|decode_flag
condition|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|,
name|buf2
index|[
literal|1024
index|]
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|ssize_t
name|len
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|stdin
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|buf
index|[
name|strcspn
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|p
argument_list|)
condition|)
name|p
operator|++
expr_stmt|;
name|len
operator|=
name|hex_decode
argument_list|(
name|p
argument_list|,
name|buf2
argument_list|,
name|strlen
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hex_decode failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwrite
argument_list|(
name|buf2
argument_list|,
literal|1
argument_list|,
name|len
argument_list|,
name|stdout
argument_list|)
operator|!=
name|len
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"fwrite failed"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|char
name|buf
index|[
literal|28
index|]
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
while|while
condition|(
operator|(
name|len
operator|=
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|stdin
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|len
operator|=
name|hex_encode
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eval_types
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_ca_tbs
name|tbs
parameter_list|,
specifier|const
name|struct
name|certificate_sign_options
modifier|*
name|opt
parameter_list|)
block|{
name|int
name|pkinit
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|opt
operator|->
name|type_strings
operator|.
name|num_strings
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|type
init|=
name|opt
operator|->
name|type_strings
operator|.
name|strings
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
literal|"https-server"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_add_eku
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkix_kp_serverAuth
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_eku"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
literal|"https-client"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_add_eku
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkix_kp_clientAuth
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_eku"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
literal|"peap-server"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_add_eku
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkix_kp_serverAuth
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_eku"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
literal|"pkinit-kdc"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pkinit
operator|++
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_eku
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkkdcekuoid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_eku"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
literal|"pkinit-client"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pkinit
operator|++
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_eku
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkekuoid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_eku"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_eku
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_ms_client_authentication
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_eku"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_eku
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkinit_ms_eku
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_eku"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
literal|"email"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_add_eku
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkix_kp_emailProtection
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_eku"
argument_list|)
expr_stmt|;
block|}
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown type %s"
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pkinit
operator|>
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"More the one PK-INIT type given"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|pk_init_principal_string
condition|)
block|{
if|if
condition|(
operator|!
name|pkinit
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"pk-init principal given but no pk-init oid"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_san_pkinit
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|opt
operator|->
name|pk_init_principal_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_san_pkinit"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|ms_upn_string
condition|)
block|{
if|if
condition|(
operator|!
name|pkinit
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"MS up given but no pk-init oid"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_san_ms_upn
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|opt
operator|->
name|ms_upn_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_san_ms_upn"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|opt
operator|->
name|hostname_strings
operator|.
name|num_strings
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|hostname
init|=
name|opt
operator|->
name|hostname_strings
operator|.
name|strings
index|[
name|i
index|]
decl_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_san_hostname
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_san_hostname"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|opt
operator|->
name|email_strings
operator|.
name|num_strings
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|email
init|=
name|opt
operator|->
name|email_strings
operator|.
name|strings
index|[
name|i
index|]
decl_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_san_rfc822name
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|email
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_san_hostname"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_add_eku
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|oid_id_pkix_kp_emailProtection
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_eku"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|jid_string
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_add_san_jid
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|opt
operator|->
name|jid_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_san_jid"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|hxtool_ca
parameter_list|(
name|struct
name|certificate_sign_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|hx509_ca_tbs
name|tbs
decl_stmt|;
name|hx509_cert
name|signer
init|=
name|NULL
decl_stmt|,
name|cert
init|=
name|NULL
decl_stmt|;
name|hx509_private_key
name|private_key
init|=
name|NULL
decl_stmt|;
name|hx509_private_key
name|cert_key
init|=
name|NULL
decl_stmt|;
name|hx509_name
name|subject
init|=
name|NULL
decl_stmt|;
name|SubjectPublicKeyInfo
name|spki
decl_stmt|;
name|int
name|delta
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|spki
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|spki
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|ca_certificate_string
operator|==
name|NULL
operator|&&
operator|!
name|opt
operator|->
name|self_signed_flag
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"--ca-certificate argument missing (not using --self-signed)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|ca_private_key_string
operator|==
name|NULL
operator|&&
name|opt
operator|->
name|generate_key_string
operator|==
name|NULL
operator|&&
name|opt
operator|->
name|self_signed_flag
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"--ca-private-key argument missing (using --self-signed)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|certificate_string
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"--certificate argument missing"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|template_certificate_string
condition|)
block|{
if|if
condition|(
name|opt
operator|->
name|template_fields_string
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"--template-certificate not no --template-fields"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|lifetime_string
condition|)
block|{
name|delta
operator|=
name|parse_time
argument_list|(
name|opt
operator|->
name|lifetime_string
argument_list|,
literal|"day"
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Invalid lifetime: %s"
argument_list|,
name|opt
operator|->
name|lifetime_string
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|ca_certificate_string
condition|)
block|{
name|hx509_certs
name|cacerts
init|=
name|NULL
decl_stmt|;
name|hx509_query
modifier|*
name|q
decl_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
name|opt
operator|->
name|ca_certificate_string
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|cacerts
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_init: %s"
argument_list|,
name|opt
operator|->
name|ca_certificate_string
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|context
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_query_alloc: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_PRIVATE_KEY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opt
operator|->
name|issue_proxy_flag
condition|)
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_KU_KEYCERTSIGN
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
argument_list|,
name|cacerts
argument_list|,
name|q
argument_list|,
operator|&
name|signer
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|context
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|cacerts
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"no CA certificate found"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opt
operator|->
name|self_signed_flag
condition|)
block|{
if|if
condition|(
name|opt
operator|->
name|generate_key_string
operator|==
name|NULL
operator|&&
name|opt
operator|->
name|ca_private_key_string
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"no signing private key"
argument_list|)
expr_stmt|;
block|}
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"missing ca key"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|ca_private_key_string
condition|)
block|{
name|ret
operator|=
name|read_private_key
argument_list|(
name|opt
operator|->
name|ca_private_key_string
argument_list|,
operator|&
name|private_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"read_private_key"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_private_key2SPKI
argument_list|(
name|context
argument_list|,
name|private_key
argument_list|,
operator|&
name|spki
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"_hx509_private_key2SPKI: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|self_signed_flag
condition|)
name|cert_key
operator|=
name|private_key
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|req_string
condition|)
block|{
name|hx509_request
name|req
decl_stmt|;
name|ret
operator|=
name|_hx509_request_parse
argument_list|(
name|context
argument_list|,
name|opt
operator|->
name|req_string
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"parse_request: %s"
argument_list|,
name|opt
operator|->
name|req_string
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_request_get_name
argument_list|(
name|context
argument_list|,
name|req
argument_list|,
operator|&
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"get name"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_request_get_SubjectPublicKeyInfo
argument_list|(
name|context
argument_list|,
name|req
argument_list|,
operator|&
name|spki
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"get spki"
argument_list|)
expr_stmt|;
name|_hx509_request_free
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|generate_key_string
condition|)
block|{
name|struct
name|hx509_generate_private_context
modifier|*
name|keyctx
decl_stmt|;
name|ret
operator|=
name|_hx509_generate_private_key_init
argument_list|(
name|context
argument_list|,
name|oid_id_pkcs1_rsaEncryption
argument_list|()
argument_list|,
operator|&
name|keyctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|issue_ca_flag
condition|)
name|_hx509_generate_private_key_is_ca
argument_list|(
name|context
argument_list|,
name|keyctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|key_bits_integer
condition|)
name|_hx509_generate_private_key_bits
argument_list|(
name|context
argument_list|,
name|keyctx
argument_list|,
name|opt
operator|->
name|key_bits_integer
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_generate_private_key
argument_list|(
name|context
argument_list|,
name|keyctx
argument_list|,
operator|&
name|cert_key
argument_list|)
expr_stmt|;
name|_hx509_generate_private_key_free
argument_list|(
operator|&
name|keyctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"generate private key"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_private_key2SPKI
argument_list|(
name|context
argument_list|,
name|cert_key
argument_list|,
operator|&
name|spki
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"_hx509_private_key2SPKI: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|self_signed_flag
condition|)
name|private_key
operator|=
name|cert_key
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|certificate_private_key_string
condition|)
block|{
name|ret
operator|=
name|read_private_key
argument_list|(
name|opt
operator|->
name|certificate_private_key_string
argument_list|,
operator|&
name|cert_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"read_private_key for certificate"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|subject_string
condition|)
block|{
if|if
condition|(
name|subject
condition|)
name|hx509_name_free
argument_list|(
operator|&
name|subject
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_parse_name
argument_list|(
name|context
argument_list|,
name|opt
operator|->
name|subject_string
argument_list|,
operator|&
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_parse_name"
argument_list|)
expr_stmt|;
block|}
comment|/*      *      */
name|ret
operator|=
name|hx509_ca_tbs_init
argument_list|(
name|context
argument_list|,
operator|&
name|tbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_init"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|template_certificate_string
condition|)
block|{
name|hx509_cert
name|template
decl_stmt|;
name|hx509_certs
name|tcerts
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
name|opt
operator|->
name|template_certificate_string
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|tcerts
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_init: %s"
argument_list|,
name|opt
operator|->
name|template_certificate_string
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_get_one_cert
argument_list|(
name|context
argument_list|,
name|tcerts
argument_list|,
operator|&
name|template
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|tcerts
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"no template certificate found"
argument_list|)
expr_stmt|;
name|flags
operator|=
name|parse_units
argument_list|(
name|opt
operator|->
name|template_fields_string
argument_list|,
name|hx509_ca_tbs_template_units
argument_list|()
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_set_template
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|flags
argument_list|,
name|template
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_set_template"
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|template
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|serial_number_string
condition|)
block|{
name|heim_integer
name|serialNumber
decl_stmt|;
name|ret
operator|=
name|der_parse_hex_heim_integer
argument_list|(
name|opt
operator|->
name|serial_number_string
argument_list|,
operator|&
name|serialNumber
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"der_parse_hex_heim_integer"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_ca_tbs_set_serialnumber
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
operator|&
name|serialNumber
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_init"
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|serialNumber
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|spki
operator|.
name|subjectPublicKey
operator|.
name|length
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_set_spki
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
operator|&
name|spki
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_set_spki"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|subject
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_set_subject
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_set_subject"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|crl_uri_string
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_add_crl_dp_uri
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|opt
operator|->
name|crl_uri_string
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_add_crl_dp_uri"
argument_list|)
expr_stmt|;
block|}
name|eval_types
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|issue_ca_flag
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_set_ca
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|opt
operator|->
name|path_length_integer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_set_ca"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|issue_proxy_flag
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_set_proxy
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|opt
operator|->
name|path_length_integer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_set_proxy"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|domain_controller_flag
condition|)
block|{
name|hx509_ca_tbs_set_domaincontroller
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_set_domaincontroller"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|delta
condition|)
block|{
name|ret
operator|=
name|hx509_ca_tbs_set_notAfter_lifetime
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|delta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_tbs_set_notAfter_lifetime"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|self_signed_flag
condition|)
block|{
name|ret
operator|=
name|hx509_ca_sign_self
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|private_key
argument_list|,
operator|&
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_sign_self"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|hx509_ca_sign
argument_list|(
name|context
argument_list|,
name|tbs
argument_list|,
name|signer
argument_list|,
operator|&
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_ca_sign"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cert_key
condition|)
block|{
name|ret
operator|=
name|_hx509_cert_assign_key
argument_list|(
name|cert
argument_list|,
name|cert_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"_hx509_cert_assign_key"
argument_list|)
expr_stmt|;
block|}
block|{
name|hx509_certs
name|certs
decl_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
name|opt
operator|->
name|certificate_string
argument_list|,
name|HX509_CERTS_CREATE
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_init"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_add
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_add"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_store
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_store"
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|subject
condition|)
name|hx509_name_free
argument_list|(
operator|&
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|signer
condition|)
name|hx509_cert_free
argument_list|(
name|signer
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|free_SubjectPublicKeyInfo
argument_list|(
operator|&
name|spki
argument_list|)
expr_stmt|;
if|if
condition|(
name|private_key
operator|!=
name|cert_key
condition|)
name|_hx509_private_key_free
argument_list|(
operator|&
name|private_key
argument_list|)
expr_stmt|;
name|_hx509_private_key_free
argument_list|(
operator|&
name|cert_key
argument_list|)
expr_stmt|;
name|hx509_ca_tbs_free
argument_list|(
operator|&
name|tbs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_one_cert
parameter_list|(
name|hx509_context
name|hxcontext
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|hx509_cert
name|cert
parameter_list|)
block|{
name|heim_octet_string
name|sd
decl_stmt|,
name|c
decl_stmt|;
name|hx509_verify_ctx
name|vctx
init|=
name|ctx
decl_stmt|;
name|hx509_certs
name|signer
init|=
name|NULL
decl_stmt|;
name|heim_oid
name|type
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|_hx509_cert_private_key
argument_list|(
name|cert
argument_list|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|hx509_cms_create_signed_1
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|cert
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|sd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_cms_create_signed_1"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cms_verify_signed
argument_list|(
name|context
argument_list|,
name|vctx
argument_list|,
name|sd
operator|.
name|data
argument_list|,
name|sd
operator|.
name|length
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|signer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sd
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_cms_verify_signed"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"create-signature verify-sigature done\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|c
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|test_crypto
parameter_list|(
name|struct
name|test_crypto_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_verify_ctx
name|vctx
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
name|hx509_lock
name|lock
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pass_strings
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:test-crypto"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|lock
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_append"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|hx509_verify_init_ctx
argument_list|(
name|context
argument_list|,
operator|&
name|vctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_verify_init_ctx"
argument_list|)
expr_stmt|;
name|hx509_verify_attach_anchors
argument_list|(
name|vctx
argument_list|,
name|certs
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_iter
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|test_one_cert
argument_list|,
name|vctx
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|statistic_print
parameter_list|(
name|struct
name|statistic_print_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|type
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|stat_file_string
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"no stat file"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|type_integer
condition|)
name|type
operator|=
name|opt
operator|->
name|type_integer
expr_stmt|;
name|hx509_query_unparse_stats
argument_list|(
name|context
argument_list|,
name|type
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|int
name|crl_sign
parameter_list|(
name|struct
name|crl_sign_options
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|hx509_crl
name|crl
decl_stmt|;
name|heim_octet_string
name|os
decl_stmt|;
name|hx509_cert
name|signer
init|=
name|NULL
decl_stmt|;
name|hx509_lock
name|lock
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|hx509_lock_init
argument_list|(
name|context
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
name|lock_strings
argument_list|(
name|lock
argument_list|,
operator|&
name|opt
operator|->
name|pass_strings
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_crl_alloc
argument_list|(
name|context
argument_list|,
operator|&
name|crl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"crl alloc"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|signer_string
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"signer missing"
argument_list|)
expr_stmt|;
block|{
name|hx509_certs
name|certs
init|=
name|NULL
decl_stmt|;
name|hx509_query
modifier|*
name|q
decl_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
name|opt
operator|->
name|signer_string
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_init: %s"
argument_list|,
name|opt
operator|->
name|signer_string
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|context
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_query_alloc: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_PRIVATE_KEY
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|q
argument_list|,
operator|&
name|signer
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|context
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"no signer certificate found"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt
operator|->
name|lifetime_string
condition|)
block|{
name|int
name|delta
decl_stmt|;
name|delta
operator|=
name|parse_time
argument_list|(
name|opt
operator|->
name|lifetime_string
argument_list|,
literal|"day"
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Invalid lifetime: %s"
argument_list|,
name|opt
operator|->
name|lifetime_string
argument_list|)
expr_stmt|;
name|hx509_crl_lifetime
argument_list|(
name|context
argument_list|,
name|crl
argument_list|,
name|delta
argument_list|)
expr_stmt|;
block|}
block|{
name|hx509_certs
name|revoked
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:revoked-certs"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|revoked
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
argument_list|,
name|revoked
argument_list|,
name|lock
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|hx509_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hx509_certs_append: %s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|hx509_crl_add_revoked_certs
argument_list|(
name|context
argument_list|,
name|crl
argument_list|,
name|revoked
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|revoked
argument_list|)
expr_stmt|;
block|}
name|hx509_crl_sign
argument_list|(
name|context
argument_list|,
name|signer
argument_list|,
name|crl
argument_list|,
operator|&
name|os
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|crl_file_string
condition|)
name|rk_dumpdata
argument_list|(
name|opt
operator|->
name|crl_file_string
argument_list|,
name|os
operator|.
name|data
argument_list|,
name|os
operator|.
name|length
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|os
operator|.
name|data
argument_list|)
expr_stmt|;
name|hx509_crl_free
argument_list|(
name|context
argument_list|,
operator|&
name|crl
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|signer
argument_list|)
expr_stmt|;
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|int
name|help
parameter_list|(
name|void
modifier|*
name|opt
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|sl_slc_help
argument_list|(
name|commands
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|optidx
init|=
literal|0
decl_stmt|;
name|setprogname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|getarg
argument_list|(
name|args
argument_list|,
name|num_args
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|optidx
argument_list|)
condition|)
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|help_flag
condition|)
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|version_flag
condition|)
block|{
name|print_version
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|argv
operator|+=
name|optidx
expr_stmt|;
name|argc
operator|-=
name|optidx
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_context_init
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"hx509_context_init failed with %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat_file_string
condition|)
name|hx509_query_statistic_file
argument_list|(
name|context
argument_list|,
name|stat_file_string
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sl_command
argument_list|(
name|commands
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
name|warnx
argument_list|(
literal|"unrecognized command: %s"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|hx509_context_free
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


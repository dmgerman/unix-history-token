begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004 - 2006 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of the Institute nor the names of its contributors   *    may be used to endorse or promote products derived from this software   *    without specific prior written permission.   *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF   * SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|"hx_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: ks_p11.c 22071 2007-11-14 20:04:50Z lha $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_DLFCN_H
end_ifdef

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_DLOPEN
end_ifdef

begin_include
include|#
directive|include
file|"pkcs11.h"
end_include

begin_struct
struct|struct
name|p11_slot
block|{
name|int
name|flags
decl_stmt|;
define|#
directive|define
name|P11_SESSION
value|1
define|#
directive|define
name|P11_SESSION_IN_USE
value|2
define|#
directive|define
name|P11_LOGIN_REQ
value|4
define|#
directive|define
name|P11_LOGIN_DONE
value|8
define|#
directive|define
name|P11_TOKEN_PRESENT
value|16
name|CK_SESSION_HANDLE
name|session
decl_stmt|;
name|CK_SLOT_ID
name|id
decl_stmt|;
name|CK_BBOOL
name|token
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
name|char
modifier|*
name|pin
decl_stmt|;
struct|struct
block|{
name|CK_MECHANISM_TYPE_PTR
name|list
decl_stmt|;
name|CK_ULONG
name|num
decl_stmt|;
name|CK_MECHANISM_INFO_PTR
modifier|*
name|infos
decl_stmt|;
block|}
name|mechs
struct|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|p11_module
block|{
name|void
modifier|*
name|dl_handle
decl_stmt|;
name|CK_FUNCTION_LIST_PTR
name|funcs
decl_stmt|;
name|CK_ULONG
name|num_slots
decl_stmt|;
name|unsigned
name|int
name|refcount
decl_stmt|;
name|struct
name|p11_slot
modifier|*
name|slot
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|P11FUNC
parameter_list|(
name|module
parameter_list|,
name|f
parameter_list|,
name|args
parameter_list|)
value|(*(module)->funcs->C_##f)args
end_define

begin_function_decl
specifier|static
name|int
name|p11_get_session
parameter_list|(
name|hx509_context
parameter_list|,
name|struct
name|p11_module
modifier|*
parameter_list|,
name|struct
name|p11_slot
modifier|*
parameter_list|,
name|hx509_lock
parameter_list|,
name|CK_SESSION_HANDLE
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|p11_put_session
parameter_list|(
name|struct
name|p11_module
modifier|*
parameter_list|,
name|struct
name|p11_slot
modifier|*
parameter_list|,
name|CK_SESSION_HANDLE
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|p11_release_module
parameter_list|(
name|struct
name|p11_module
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|p11_list_keys
parameter_list|(
name|hx509_context
parameter_list|,
name|struct
name|p11_module
modifier|*
parameter_list|,
name|struct
name|p11_slot
modifier|*
parameter_list|,
name|CK_SESSION_HANDLE
parameter_list|,
name|hx509_lock
parameter_list|,
name|hx509_certs
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  *  */
end_comment

begin_struct
struct|struct
name|p11_rsa
block|{
name|struct
name|p11_module
modifier|*
name|p
decl_stmt|;
name|struct
name|p11_slot
modifier|*
name|slot
decl_stmt|;
name|CK_OBJECT_HANDLE
name|private_key
decl_stmt|;
name|CK_OBJECT_HANDLE
name|public_key
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|p11_rsa_public_encrypt
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_rsa_public_decrypt
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_rsa_private_encrypt
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|struct
name|p11_rsa
modifier|*
name|p11rsa
init|=
name|RSA_get_app_data
argument_list|(
name|rsa
argument_list|)
decl_stmt|;
name|CK_OBJECT_HANDLE
name|key
init|=
name|p11rsa
operator|->
name|private_key
decl_stmt|;
name|CK_SESSION_HANDLE
name|session
decl_stmt|;
name|CK_MECHANISM
name|mechanism
decl_stmt|;
name|CK_ULONG
name|ck_sigsize
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|padding
operator|!=
name|RSA_PKCS1_PADDING
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|mechanism
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mechanism
argument_list|)
argument_list|)
expr_stmt|;
name|mechanism
operator|.
name|mechanism
operator|=
name|CKM_RSA_PKCS
expr_stmt|;
name|ck_sigsize
operator|=
name|RSA_size
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
name|ret
operator|=
name|p11_get_session
argument_list|(
name|NULL
argument_list|,
name|p11rsa
operator|->
name|p
argument_list|,
name|p11rsa
operator|->
name|slot
argument_list|,
name|NULL
argument_list|,
operator|&
name|session
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p11rsa
operator|->
name|p
argument_list|,
name|SignInit
argument_list|,
operator|(
name|session
operator|,
operator|&
name|mechanism
operator|,
name|key
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
name|p11_put_session
argument_list|(
name|p11rsa
operator|->
name|p
argument_list|,
name|p11rsa
operator|->
name|slot
argument_list|,
name|session
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p11rsa
operator|->
name|p
argument_list|,
name|Sign
argument_list|,
operator|(
name|session
operator|,
operator|(
name|CK_BYTE
operator|*
operator|)
name|from
operator|,
name|flen
operator|,
name|to
operator|,
operator|&
name|ck_sigsize
operator|)
argument_list|)
expr_stmt|;
name|p11_put_session
argument_list|(
name|p11rsa
operator|->
name|p
argument_list|,
name|p11rsa
operator|->
name|slot
argument_list|,
name|session
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ck_sigsize
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_rsa_private_decrypt
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|struct
name|p11_rsa
modifier|*
name|p11rsa
init|=
name|RSA_get_app_data
argument_list|(
name|rsa
argument_list|)
decl_stmt|;
name|CK_OBJECT_HANDLE
name|key
init|=
name|p11rsa
operator|->
name|private_key
decl_stmt|;
name|CK_SESSION_HANDLE
name|session
decl_stmt|;
name|CK_MECHANISM
name|mechanism
decl_stmt|;
name|CK_ULONG
name|ck_sigsize
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|padding
operator|!=
name|RSA_PKCS1_PADDING
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|mechanism
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mechanism
argument_list|)
argument_list|)
expr_stmt|;
name|mechanism
operator|.
name|mechanism
operator|=
name|CKM_RSA_PKCS
expr_stmt|;
name|ck_sigsize
operator|=
name|RSA_size
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
name|ret
operator|=
name|p11_get_session
argument_list|(
name|NULL
argument_list|,
name|p11rsa
operator|->
name|p
argument_list|,
name|p11rsa
operator|->
name|slot
argument_list|,
name|NULL
argument_list|,
operator|&
name|session
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p11rsa
operator|->
name|p
argument_list|,
name|DecryptInit
argument_list|,
operator|(
name|session
operator|,
operator|&
name|mechanism
operator|,
name|key
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
name|p11_put_session
argument_list|(
name|p11rsa
operator|->
name|p
argument_list|,
name|p11rsa
operator|->
name|slot
argument_list|,
name|session
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p11rsa
operator|->
name|p
argument_list|,
name|Decrypt
argument_list|,
operator|(
name|session
operator|,
operator|(
name|CK_BYTE
operator|*
operator|)
name|from
operator|,
name|flen
operator|,
name|to
operator|,
operator|&
name|ck_sigsize
operator|)
argument_list|)
expr_stmt|;
name|p11_put_session
argument_list|(
name|p11rsa
operator|->
name|p
argument_list|,
name|p11rsa
operator|->
name|slot
argument_list|,
name|session
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ck_sigsize
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_rsa_init
parameter_list|(
name|RSA
modifier|*
name|rsa
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_rsa_finish
parameter_list|(
name|RSA
modifier|*
name|rsa
parameter_list|)
block|{
name|struct
name|p11_rsa
modifier|*
name|p11rsa
init|=
name|RSA_get_app_data
argument_list|(
name|rsa
argument_list|)
decl_stmt|;
name|p11_release_module
argument_list|(
name|p11rsa
operator|->
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p11rsa
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|RSA_METHOD
name|p11_rsa_pkcs1_method
init|=
block|{
literal|"hx509 PKCS11 PKCS#1 RSA"
block|,
name|p11_rsa_public_encrypt
block|,
name|p11_rsa_public_decrypt
block|,
name|p11_rsa_private_encrypt
block|,
name|p11_rsa_private_decrypt
block|,
name|NULL
block|,
name|NULL
block|,
name|p11_rsa_init
block|,
name|p11_rsa_finish
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int
name|p11_mech_info
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|struct
name|p11_module
modifier|*
name|p
parameter_list|,
name|struct
name|p11_slot
modifier|*
name|slot
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|CK_ULONG
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetMechanismList
argument_list|,
operator|(
name|slot
operator|->
name|id
operator|,
name|NULL_PTR
operator|,
operator|&
name|i
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_PKCS11_NO_MECH
argument_list|,
literal|"Failed to get mech list count for slot %d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
name|HX509_PKCS11_NO_MECH
return|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_PKCS11_NO_MECH
argument_list|,
literal|"no mech supported for slot %d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
name|HX509_PKCS11_NO_MECH
return|;
block|}
name|slot
operator|->
name|mechs
operator|.
name|list
operator|=
name|calloc
argument_list|(
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|slot
operator|->
name|mechs
operator|.
name|list
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot
operator|->
name|mechs
operator|.
name|list
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|slot
operator|->
name|mechs
operator|.
name|num
operator|=
name|i
expr_stmt|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetMechanismList
argument_list|,
operator|(
name|slot
operator|->
name|id
operator|,
name|slot
operator|->
name|mechs
operator|.
name|list
operator|,
operator|&
name|i
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_PKCS11_NO_MECH
argument_list|,
literal|"Failed to get mech list for slot %d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
name|HX509_PKCS11_NO_MECH
return|;
block|}
name|assert
argument_list|(
name|i
operator|==
name|slot
operator|->
name|mechs
operator|.
name|num
argument_list|)
expr_stmt|;
name|slot
operator|->
name|mechs
operator|.
name|infos
operator|=
name|calloc
argument_list|(
name|i
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|slot
operator|->
name|mechs
operator|.
name|infos
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot
operator|->
name|mechs
operator|.
name|list
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|slot
operator|->
name|mechs
operator|.
name|num
condition|;
name|i
operator|++
control|)
block|{
name|slot
operator|->
name|mechs
operator|.
name|infos
index|[
name|i
index|]
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|(
name|slot
operator|->
name|mechs
operator|.
name|infos
index|[
literal|0
index|]
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot
operator|->
name|mechs
operator|.
name|infos
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetMechanismInfo
argument_list|,
operator|(
name|slot
operator|->
name|id
operator|,
name|slot
operator|->
name|mechs
operator|.
name|list
index|[
name|i
index|]
operator|,
name|slot
operator|->
name|mechs
operator|.
name|infos
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_PKCS11_NO_MECH
argument_list|,
literal|"Failed to get mech info for slot %d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
name|HX509_PKCS11_NO_MECH
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_init_slot
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|struct
name|p11_module
modifier|*
name|p
parameter_list|,
name|hx509_lock
name|lock
parameter_list|,
name|CK_SLOT_ID
name|id
parameter_list|,
name|int
name|num
parameter_list|,
name|struct
name|p11_slot
modifier|*
name|slot
parameter_list|)
block|{
name|CK_SESSION_HANDLE
name|session
decl_stmt|;
name|CK_SLOT_INFO
name|slot_info
decl_stmt|;
name|CK_TOKEN_INFO
name|token_info
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|slot
operator|->
name|certs
operator|=
name|NULL
expr_stmt|;
name|slot
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetSlotInfo
argument_list|,
operator|(
name|slot
operator|->
name|id
operator|,
operator|&
name|slot_info
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_PKCS11_TOKEN_CONFUSED
argument_list|,
literal|"Failed to init PKCS11 slot %d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
name|HX509_PKCS11_TOKEN_CONFUSED
return|;
block|}
for|for
control|(
name|i
operator|=
sizeof|sizeof
argument_list|(
name|slot_info
operator|.
name|slotDescription
argument_list|)
operator|-
literal|1
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|char
name|c
init|=
name|slot_info
operator|.
name|slotDescription
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|c
operator|==
literal|' '
operator|||
name|c
operator|==
literal|'\t'
operator|||
name|c
operator|==
literal|'\n'
operator|||
name|c
operator|==
literal|'\r'
operator|||
name|c
operator|==
literal|'\0'
condition|)
continue|continue;
name|i
operator|++
expr_stmt|;
break|break;
block|}
name|asprintf
argument_list|(
operator|&
name|slot
operator|->
name|name
argument_list|,
literal|"%.*s"
argument_list|,
name|i
argument_list|,
name|slot_info
operator|.
name|slotDescription
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|slot_info
operator|.
name|flags
operator|&
name|CKF_TOKEN_PRESENT
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetTokenInfo
argument_list|,
operator|(
name|slot
operator|->
name|id
operator|,
operator|&
name|token_info
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_PKCS11_NO_TOKEN
argument_list|,
literal|"Failed to init PKCS11 slot %d "
literal|"with error 0x08x"
argument_list|,
name|num
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|HX509_PKCS11_NO_TOKEN
return|;
block|}
name|slot
operator|->
name|flags
operator||=
name|P11_TOKEN_PRESENT
expr_stmt|;
if|if
condition|(
name|token_info
operator|.
name|flags
operator|&
name|CKF_LOGIN_REQUIRED
condition|)
name|slot
operator|->
name|flags
operator||=
name|P11_LOGIN_REQ
expr_stmt|;
name|ret
operator|=
name|p11_get_session
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|slot
argument_list|,
name|lock
argument_list|,
operator|&
name|session
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|p11_mech_info
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|slot
argument_list|,
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|p11_list_keys
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|slot
argument_list|,
name|session
argument_list|,
name|lock
argument_list|,
operator|&
name|slot
operator|->
name|certs
argument_list|)
expr_stmt|;
name|out
label|:
name|p11_put_session
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|session
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_get_session
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|struct
name|p11_module
modifier|*
name|p
parameter_list|,
name|struct
name|p11_slot
modifier|*
name|slot
parameter_list|,
name|hx509_lock
name|lock
parameter_list|,
name|CK_SESSION_HANDLE
modifier|*
name|psession
parameter_list|)
block|{
name|CK_RV
name|ret
decl_stmt|;
if|if
condition|(
name|slot
operator|->
name|flags
operator|&
name|P11_SESSION_IN_USE
condition|)
name|_hx509_abort
argument_list|(
literal|"slot already in session"
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot
operator|->
name|flags
operator|&
name|P11_SESSION
condition|)
block|{
name|slot
operator|->
name|flags
operator||=
name|P11_SESSION_IN_USE
expr_stmt|;
operator|*
name|psession
operator|=
name|slot
operator|->
name|session
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|OpenSession
argument_list|,
operator|(
name|slot
operator|->
name|id
operator|,
name|CKF_SERIAL_SESSION
operator|,
name|NULL
operator|,
name|NULL
operator|,
operator|&
name|slot
operator|->
name|session
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
if|if
condition|(
name|context
condition|)
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_PKCS11_OPEN_SESSION
argument_list|,
literal|"Failed to OpenSession for slot id %d "
literal|"with error: 0x%08x"
argument_list|,
operator|(
name|int
operator|)
name|slot
operator|->
name|id
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|HX509_PKCS11_OPEN_SESSION
return|;
block|}
name|slot
operator|->
name|flags
operator||=
name|P11_SESSION
expr_stmt|;
comment|/*       * If we have have to login, and haven't tried before and have a      * prompter or known to work pin code.      *      * This code is very conversative and only uses the prompter in      * the hx509_lock, the reason is that it's bad to try many      * passwords on a pkcs11 token, it might lock up and have to be      * unlocked by a administrator.      *      * XXX try harder to not use pin several times on the same card.      */
if|if
condition|(
operator|(
name|slot
operator|->
name|flags
operator|&
name|P11_LOGIN_REQ
operator|)
operator|&&
operator|(
name|slot
operator|->
name|flags
operator|&
name|P11_LOGIN_DONE
operator|)
operator|==
literal|0
operator|&&
operator|(
name|lock
operator|||
name|slot
operator|->
name|pin
operator|)
condition|)
block|{
name|hx509_prompt
name|prompt
decl_stmt|;
name|char
name|pin
index|[
literal|20
index|]
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|slot
operator|->
name|flags
operator||=
name|P11_LOGIN_DONE
expr_stmt|;
if|if
condition|(
name|slot
operator|->
name|pin
operator|==
name|NULL
condition|)
block|{
name|memset
argument_list|(
operator|&
name|prompt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|prompt
argument_list|)
argument_list|)
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|str
argument_list|,
literal|"PIN code for %s: "
argument_list|,
name|slot
operator|->
name|name
argument_list|)
expr_stmt|;
name|prompt
operator|.
name|prompt
operator|=
name|str
expr_stmt|;
name|prompt
operator|.
name|type
operator|=
name|HX509_PROMPT_TYPE_PASSWORD
expr_stmt|;
name|prompt
operator|.
name|reply
operator|.
name|data
operator|=
name|pin
expr_stmt|;
name|prompt
operator|.
name|reply
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|pin
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_lock_prompt
argument_list|(
name|lock
argument_list|,
operator|&
name|prompt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
condition|)
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to get pin code for slot "
literal|"id %d with error: %d"
argument_list|,
operator|(
name|int
operator|)
name|slot
operator|->
name|id
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strlcpy
argument_list|(
name|pin
argument_list|,
name|slot
operator|->
name|pin
argument_list|,
sizeof|sizeof
argument_list|(
name|pin
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|Login
argument_list|,
operator|(
name|slot
operator|->
name|session
operator|,
name|CKU_USER
operator|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|pin
operator|,
name|strlen
argument_list|(
name|pin
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
if|if
condition|(
name|context
condition|)
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_PKCS11_LOGIN
argument_list|,
literal|"Failed to login on slot id %d "
literal|"with error: 0x%08x"
argument_list|,
operator|(
name|int
operator|)
name|slot
operator|->
name|id
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|p11_put_session
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|slot
operator|->
name|session
argument_list|)
expr_stmt|;
return|return
name|HX509_PKCS11_LOGIN
return|;
block|}
if|if
condition|(
name|slot
operator|->
name|pin
operator|==
name|NULL
condition|)
block|{
name|slot
operator|->
name|pin
operator|=
name|strdup
argument_list|(
name|pin
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot
operator|->
name|pin
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|context
condition|)
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|p11_put_session
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|slot
operator|->
name|session
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
block|}
block|}
else|else
name|slot
operator|->
name|flags
operator||=
name|P11_LOGIN_DONE
expr_stmt|;
name|slot
operator|->
name|flags
operator||=
name|P11_SESSION_IN_USE
expr_stmt|;
operator|*
name|psession
operator|=
name|slot
operator|->
name|session
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_put_session
parameter_list|(
name|struct
name|p11_module
modifier|*
name|p
parameter_list|,
name|struct
name|p11_slot
modifier|*
name|slot
parameter_list|,
name|CK_SESSION_HANDLE
name|session
parameter_list|)
block|{
if|if
condition|(
operator|(
name|slot
operator|->
name|flags
operator|&
name|P11_SESSION_IN_USE
operator|)
operator|==
literal|0
condition|)
name|_hx509_abort
argument_list|(
literal|"slot not in session"
argument_list|)
expr_stmt|;
name|slot
operator|->
name|flags
operator|&=
operator|~
name|P11_SESSION_IN_USE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iterate_entries
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|struct
name|p11_module
modifier|*
name|p
parameter_list|,
name|struct
name|p11_slot
modifier|*
name|slot
parameter_list|,
name|CK_SESSION_HANDLE
name|session
parameter_list|,
name|CK_ATTRIBUTE
modifier|*
name|search_data
parameter_list|,
name|int
name|num_search_data
parameter_list|,
name|CK_ATTRIBUTE
modifier|*
name|query
parameter_list|,
name|int
name|num_query
parameter_list|,
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|hx509_context
parameter_list|,
name|struct
name|p11_module
modifier|*
parameter_list|,
name|struct
name|p11_slot
modifier|*
parameter_list|,
name|CK_SESSION_HANDLE
name|session
parameter_list|,
name|CK_OBJECT_HANDLE
name|object
parameter_list|,
name|void
modifier|*
parameter_list|,
name|CK_ATTRIBUTE
modifier|*
parameter_list|,
name|int
parameter_list|)
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|CK_OBJECT_HANDLE
name|object
decl_stmt|;
name|CK_ULONG
name|object_count
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|FindObjectsInit
argument_list|,
operator|(
name|session
operator|,
name|search_data
operator|,
name|num_search_data
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|FindObjects
argument_list|,
operator|(
name|session
operator|,
operator|&
name|object
operator|,
literal|1
operator|,
operator|&
name|object_count
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|object_count
operator|==
literal|0
condition|)
break|break;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_query
condition|;
name|i
operator|++
control|)
name|query
index|[
name|i
index|]
operator|.
name|pValue
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetAttributeValue
argument_list|,
operator|(
name|session
operator|,
name|object
operator|,
name|query
operator|,
name|num_query
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_query
condition|;
name|i
operator|++
control|)
block|{
name|query
index|[
name|i
index|]
operator|.
name|pValue
operator|=
name|malloc
argument_list|(
name|query
index|[
name|i
index|]
operator|.
name|ulValueLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|query
index|[
name|i
index|]
operator|.
name|pValue
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetAttributeValue
argument_list|,
operator|(
name|session
operator|,
name|object
operator|,
name|query
operator|,
name|num_query
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
call|(
modifier|*
name|func
call|)
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|slot
argument_list|,
name|session
argument_list|,
name|object
argument_list|,
name|ptr
argument_list|,
name|query
argument_list|,
name|num_query
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_query
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|query
index|[
name|i
index|]
operator|.
name|pValue
condition|)
name|free
argument_list|(
name|query
index|[
name|i
index|]
operator|.
name|pValue
argument_list|)
expr_stmt|;
name|query
index|[
name|i
index|]
operator|.
name|pValue
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|out
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_query
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|query
index|[
name|i
index|]
operator|.
name|pValue
condition|)
name|free
argument_list|(
name|query
index|[
name|i
index|]
operator|.
name|pValue
argument_list|)
expr_stmt|;
name|query
index|[
name|i
index|]
operator|.
name|pValue
operator|=
name|NULL
expr_stmt|;
block|}
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|FindObjectsFinal
argument_list|,
operator|(
name|session
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
return|return
operator|-
literal|2
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|BIGNUM
modifier|*
name|getattr_bn
parameter_list|(
name|struct
name|p11_module
modifier|*
name|p
parameter_list|,
name|struct
name|p11_slot
modifier|*
name|slot
parameter_list|,
name|CK_SESSION_HANDLE
name|session
parameter_list|,
name|CK_OBJECT_HANDLE
name|object
parameter_list|,
name|unsigned
name|int
name|type
parameter_list|)
block|{
name|CK_ATTRIBUTE
name|query
decl_stmt|;
name|BIGNUM
modifier|*
name|bn
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|query
operator|.
name|type
operator|=
name|type
expr_stmt|;
name|query
operator|.
name|pValue
operator|=
name|NULL
expr_stmt|;
name|query
operator|.
name|ulValueLen
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetAttributeValue
argument_list|,
operator|(
name|session
operator|,
name|object
operator|,
operator|&
name|query
operator|,
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
return|return
name|NULL
return|;
name|query
operator|.
name|pValue
operator|=
name|malloc
argument_list|(
name|query
operator|.
name|ulValueLen
argument_list|)
expr_stmt|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetAttributeValue
argument_list|,
operator|(
name|session
operator|,
name|object
operator|,
operator|&
name|query
operator|,
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
name|free
argument_list|(
name|query
operator|.
name|pValue
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bn
operator|=
name|BN_bin2bn
argument_list|(
name|query
operator|.
name|pValue
argument_list|,
name|query
operator|.
name|ulValueLen
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|query
operator|.
name|pValue
argument_list|)
expr_stmt|;
return|return
name|bn
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_private_key
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|struct
name|p11_module
modifier|*
name|p
parameter_list|,
name|struct
name|p11_slot
modifier|*
name|slot
parameter_list|,
name|CK_SESSION_HANDLE
name|session
parameter_list|,
name|CK_OBJECT_HANDLE
name|object
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|CK_ATTRIBUTE
modifier|*
name|query
parameter_list|,
name|int
name|num_query
parameter_list|)
block|{
name|struct
name|hx509_collector
modifier|*
name|collector
init|=
name|ptr
decl_stmt|;
name|hx509_private_key
name|key
decl_stmt|;
name|heim_octet_string
name|localKeyId
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|RSA
modifier|*
name|rsa
decl_stmt|;
name|struct
name|p11_rsa
modifier|*
name|p11rsa
decl_stmt|;
name|localKeyId
operator|.
name|data
operator|=
name|query
index|[
literal|0
index|]
operator|.
name|pValue
expr_stmt|;
name|localKeyId
operator|.
name|length
operator|=
name|query
index|[
literal|0
index|]
operator|.
name|ulValueLen
expr_stmt|;
name|ret
operator|=
name|_hx509_private_key_init
argument_list|(
operator|&
name|key
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|rsa
operator|=
name|RSA_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|rsa
operator|==
name|NULL
condition|)
name|_hx509_abort
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
comment|/*       * The exponent and modulus should always be present according to      * the pkcs11 specification, but some smartcards leaves it out,      * let ignore any failure to fetch it.      */
name|rsa
operator|->
name|n
operator|=
name|getattr_bn
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|session
argument_list|,
name|object
argument_list|,
name|CKA_MODULUS
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|e
operator|=
name|getattr_bn
argument_list|(
name|p
argument_list|,
name|slot
argument_list|,
name|session
argument_list|,
name|object
argument_list|,
name|CKA_PUBLIC_EXPONENT
argument_list|)
expr_stmt|;
name|p11rsa
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p11rsa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p11rsa
operator|==
name|NULL
condition|)
name|_hx509_abort
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|p11rsa
operator|->
name|p
operator|=
name|p
expr_stmt|;
name|p11rsa
operator|->
name|slot
operator|=
name|slot
expr_stmt|;
name|p11rsa
operator|->
name|private_key
operator|=
name|object
expr_stmt|;
name|p
operator|->
name|refcount
operator|++
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|refcount
operator|==
literal|0
condition|)
name|_hx509_abort
argument_list|(
literal|"pkcs11 refcount to high"
argument_list|)
expr_stmt|;
name|RSA_set_method
argument_list|(
name|rsa
argument_list|,
operator|&
name|p11_rsa_pkcs1_method
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RSA_set_app_data
argument_list|(
name|rsa
argument_list|,
name|p11rsa
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|1
condition|)
name|_hx509_abort
argument_list|(
literal|"RSA_set_app_data"
argument_list|)
expr_stmt|;
name|_hx509_private_key_assign_rsa
argument_list|(
name|key
argument_list|,
name|rsa
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_collector_private_key_add
argument_list|(
name|context
argument_list|,
name|collector
argument_list|,
name|hx509_signature_rsa
argument_list|()
argument_list|,
name|key
argument_list|,
name|NULL
argument_list|,
operator|&
name|localKeyId
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|_hx509_private_key_free
argument_list|(
operator|&
name|key
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|p11_cert_release
parameter_list|(
name|hx509_cert
name|cert
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|p11_module
modifier|*
name|p
init|=
name|ctx
decl_stmt|;
name|p11_release_module
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cert
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|struct
name|p11_module
modifier|*
name|p
parameter_list|,
name|struct
name|p11_slot
modifier|*
name|slot
parameter_list|,
name|CK_SESSION_HANDLE
name|session
parameter_list|,
name|CK_OBJECT_HANDLE
name|object
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|CK_ATTRIBUTE
modifier|*
name|query
parameter_list|,
name|int
name|num_query
parameter_list|)
block|{
name|struct
name|hx509_collector
modifier|*
name|collector
init|=
name|ptr
decl_stmt|;
name|hx509_cert
name|cert
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|CK_LONG
operator|)
name|query
index|[
literal|0
index|]
operator|.
name|ulValueLen
operator|==
operator|-
literal|1
operator|||
operator|(
name|CK_LONG
operator|)
name|query
index|[
literal|1
index|]
operator|.
name|ulValueLen
operator|==
operator|-
literal|1
condition|)
block|{
return|return
literal|0
return|;
block|}
name|ret
operator|=
name|hx509_cert_init_data
argument_list|(
name|context
argument_list|,
name|query
index|[
literal|1
index|]
operator|.
name|pValue
argument_list|,
name|query
index|[
literal|1
index|]
operator|.
name|ulValueLen
argument_list|,
operator|&
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|p
operator|->
name|refcount
operator|++
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|refcount
operator|==
literal|0
condition|)
name|_hx509_abort
argument_list|(
literal|"pkcs11 refcount to high"
argument_list|)
expr_stmt|;
name|_hx509_cert_set_release
argument_list|(
name|cert
argument_list|,
name|p11_cert_release
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|{
name|heim_octet_string
name|data
decl_stmt|;
name|data
operator|.
name|data
operator|=
name|query
index|[
literal|0
index|]
operator|.
name|pValue
expr_stmt|;
name|data
operator|.
name|length
operator|=
name|query
index|[
literal|0
index|]
operator|.
name|ulValueLen
expr_stmt|;
name|_hx509_set_cert_attribute
argument_list|(
name|context
argument_list|,
name|cert
argument_list|,
name|oid_id_pkcs_9_at_localKeyId
argument_list|()
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|CK_LONG
operator|)
name|query
index|[
literal|2
index|]
operator|.
name|ulValueLen
operator|!=
operator|-
literal|1
condition|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|asprintf
argument_list|(
operator|&
name|str
argument_list|,
literal|"%.*s"
argument_list|,
operator|(
name|int
operator|)
name|query
index|[
literal|2
index|]
operator|.
name|ulValueLen
argument_list|,
operator|(
name|char
operator|*
operator|)
name|query
index|[
literal|2
index|]
operator|.
name|pValue
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
condition|)
block|{
name|hx509_cert_set_friendly_name
argument_list|(
name|cert
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
block|}
name|ret
operator|=
name|_hx509_collector_certs_add
argument_list|(
name|context
argument_list|,
name|collector
argument_list|,
name|cert
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_list_keys
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|struct
name|p11_module
modifier|*
name|p
parameter_list|,
name|struct
name|p11_slot
modifier|*
name|slot
parameter_list|,
name|CK_SESSION_HANDLE
name|session
parameter_list|,
name|hx509_lock
name|lock
parameter_list|,
name|hx509_certs
modifier|*
name|certs
parameter_list|)
block|{
name|struct
name|hx509_collector
modifier|*
name|collector
decl_stmt|;
name|CK_OBJECT_CLASS
name|key_class
decl_stmt|;
name|CK_ATTRIBUTE
name|search_data
index|[]
init|=
block|{
block|{
name|CKA_CLASS
block|,
name|NULL
block|,
literal|0
block|}
block|,     }
decl_stmt|;
name|CK_ATTRIBUTE
name|query_data
index|[
literal|3
index|]
init|=
block|{
block|{
name|CKA_ID
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|CKA_VALUE
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|CKA_LABEL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|search_data
index|[
literal|0
index|]
operator|.
name|pValue
operator|=
operator|&
name|key_class
expr_stmt|;
name|search_data
index|[
literal|0
index|]
operator|.
name|ulValueLen
operator|=
sizeof|sizeof
argument_list|(
name|key_class
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock
operator|==
name|NULL
condition|)
name|lock
operator|=
name|_hx509_empty_lock
expr_stmt|;
name|ret
operator|=
name|_hx509_collector_alloc
argument_list|(
name|context
argument_list|,
name|lock
argument_list|,
operator|&
name|collector
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|key_class
operator|=
name|CKO_PRIVATE_KEY
expr_stmt|;
name|ret
operator|=
name|iterate_entries
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|slot
argument_list|,
name|session
argument_list|,
name|search_data
argument_list|,
literal|1
argument_list|,
name|query_data
argument_list|,
literal|1
argument_list|,
name|collect_private_key
argument_list|,
name|collector
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|key_class
operator|=
name|CKO_CERTIFICATE
expr_stmt|;
name|ret
operator|=
name|iterate_entries
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|slot
argument_list|,
name|session
argument_list|,
name|search_data
argument_list|,
literal|1
argument_list|,
name|query_data
argument_list|,
literal|3
argument_list|,
name|collect_cert
argument_list|,
name|collector
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|_hx509_collector_collect_certs
argument_list|(
name|context
argument_list|,
name|collector
argument_list|,
operator|&
name|slot
operator|->
name|certs
argument_list|)
expr_stmt|;
name|out
label|:
name|_hx509_collector_free
argument_list|(
name|collector
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_init
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_certs
name|certs
parameter_list|,
name|void
modifier|*
modifier|*
name|data
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|char
modifier|*
name|residue
parameter_list|,
name|hx509_lock
name|lock
parameter_list|)
block|{
name|CK_C_GetFunctionList
name|getFuncs
decl_stmt|;
name|struct
name|p11_module
modifier|*
name|p
decl_stmt|;
name|char
modifier|*
name|list
decl_stmt|,
modifier|*
name|str
decl_stmt|;
name|int
name|ret
decl_stmt|;
operator|*
name|data
operator|=
name|NULL
expr_stmt|;
name|list
operator|=
name|strdup
argument_list|(
name|residue
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|p
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|list
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|p
operator|->
name|refcount
operator|=
literal|1
expr_stmt|;
name|str
operator|=
name|strchr
argument_list|(
name|list
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
condition|)
operator|*
name|str
operator|++
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
name|str
condition|)
block|{
name|char
modifier|*
name|strnext
decl_stmt|;
name|strnext
operator|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|strnext
condition|)
operator|*
name|strnext
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|#
directive|if
literal|0
block|if (strncasecmp(str, "slot=", 5) == 0) 	    p->selected_slot = atoi(str + 5);
endif|#
directive|endif
name|str
operator|=
name|strnext
expr_stmt|;
block|}
name|p
operator|->
name|dl_handle
operator|=
name|dlopen
argument_list|(
name|list
argument_list|,
name|RTLD_NOW
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|dl_handle
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|HX509_PKCS11_LOAD
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to open %s: %s"
argument_list|,
name|list
argument_list|,
name|dlerror
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|getFuncs
operator|=
name|dlsym
argument_list|(
name|p
operator|->
name|dl_handle
argument_list|,
literal|"C_GetFunctionList"
argument_list|)
expr_stmt|;
if|if
condition|(
name|getFuncs
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|HX509_PKCS11_LOAD
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"C_GetFunctionList missing in %s: %s"
argument_list|,
name|list
argument_list|,
name|dlerror
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
call|(
modifier|*
name|getFuncs
call|)
argument_list|(
operator|&
name|p
operator|->
name|funcs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
name|HX509_PKCS11_LOAD
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"C_GetFunctionList failed in %s"
argument_list|,
name|list
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|Initialize
argument_list|,
operator|(
name|NULL_PTR
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
block|{
name|ret
operator|=
name|HX509_PKCS11_TOKEN_CONFUSED
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed initialize the PKCS11 module"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetSlotList
argument_list|,
operator|(
name|FALSE
operator|,
name|NULL
operator|,
operator|&
name|p
operator|->
name|num_slots
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
name|HX509_PKCS11_TOKEN_CONFUSED
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to get number of PKCS11 slots"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|p
operator|->
name|num_slots
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|HX509_PKCS11_NO_SLOT
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Selected PKCS11 module have no slots"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|{
name|CK_SLOT_ID_PTR
name|slot_ids
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_tokens
init|=
literal|0
decl_stmt|;
name|slot_ids
operator|=
name|malloc
argument_list|(
name|p
operator|->
name|num_slots
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|slot_ids
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot_ids
operator|==
name|NULL
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|GetSlotList
argument_list|,
operator|(
name|FALSE
operator|,
name|slot_ids
operator|,
operator|&
name|p
operator|->
name|num_slots
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|slot_ids
argument_list|)
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_PKCS11_TOKEN_CONFUSED
argument_list|,
literal|"Failed getting slot-list from "
literal|"PKCS11 module"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|HX509_PKCS11_TOKEN_CONFUSED
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p
operator|->
name|slot
operator|=
name|calloc
argument_list|(
name|p
operator|->
name|num_slots
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|->
name|slot
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|slot
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|slot_ids
argument_list|)
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"Failed to get memory for slot-list"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|num_slots
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|p11_init_slot
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|lock
argument_list|,
name|slot_ids
index|[
name|i
index|]
argument_list|,
name|i
argument_list|,
operator|&
name|p
operator|->
name|slot
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
if|if
condition|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|P11_TOKEN_PRESENT
condition|)
name|num_tokens
operator|++
expr_stmt|;
block|}
name|free
argument_list|(
name|slot_ids
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|num_tokens
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|HX509_PKCS11_NO_TOKEN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
operator|*
name|data
operator|=
name|p
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|p11_release_module
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|p11_release_module
parameter_list|(
name|struct
name|p11_module
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|refcount
operator|==
literal|0
condition|)
name|_hx509_abort
argument_list|(
literal|"pkcs11 refcount to low"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|p
operator|->
name|refcount
operator|>
literal|0
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|num_slots
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|P11_SESSION_IN_USE
condition|)
name|_hx509_abort
argument_list|(
literal|"pkcs11 module release while session in use"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|P11_SESSION
condition|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|CloseSession
argument_list|,
operator|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|session
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|CKR_OK
condition|)
empty_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|name
condition|)
name|free
argument_list|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|pin
condition|)
block|{
name|memset
argument_list|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|pin
argument_list|,
literal|0
argument_list|,
name|strlen
argument_list|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|pin
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|pin
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|mechs
operator|.
name|num
condition|)
block|{
name|free
argument_list|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|mechs
operator|.
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|mechs
operator|.
name|infos
condition|)
block|{
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|mechs
operator|.
name|num
condition|;
name|j
operator|++
control|)
name|free
argument_list|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|mechs
operator|.
name|infos
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|mechs
operator|.
name|infos
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|free
argument_list|(
name|p
operator|->
name|slot
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|funcs
condition|)
name|P11FUNC
argument_list|(
name|p
argument_list|,
name|Finalize
argument_list|,
operator|(
name|NULL
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|dl_handle
condition|)
name|dlclose
argument_list|(
name|p
operator|->
name|dl_handle
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_free
parameter_list|(
name|hx509_certs
name|certs
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|p11_module
modifier|*
name|p
init|=
name|data
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|num_slots
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|certs
condition|)
name|hx509_certs_free
argument_list|(
operator|&
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|certs
argument_list|)
expr_stmt|;
block|}
name|p11_release_module
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|p11_cursor
block|{
name|hx509_certs
name|certs
decl_stmt|;
name|void
modifier|*
name|cursor
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|p11_iter_start
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_certs
name|certs
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|void
modifier|*
modifier|*
name|cursor
parameter_list|)
block|{
name|struct
name|p11_module
modifier|*
name|p
init|=
name|data
decl_stmt|;
name|struct
name|p11_cursor
modifier|*
name|c
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|c
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:pkcs11-iter"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|c
operator|->
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|num_slots
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|certs
operator|==
name|NULL
condition|)
continue|continue;
name|ret
operator|=
name|hx509_certs_merge
argument_list|(
name|context
argument_list|,
name|c
operator|->
name|certs
argument_list|,
name|p
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_certs_free
argument_list|(
operator|&
name|c
operator|->
name|certs
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|ret
operator|=
name|hx509_certs_start_seq
argument_list|(
name|context
argument_list|,
name|c
operator|->
name|certs
argument_list|,
operator|&
name|c
operator|->
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_certs_free
argument_list|(
operator|&
name|c
operator|->
name|certs
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|cursor
operator|=
name|c
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_iter
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_certs
name|certs
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|void
modifier|*
name|cursor
parameter_list|,
name|hx509_cert
modifier|*
name|cert
parameter_list|)
block|{
name|struct
name|p11_cursor
modifier|*
name|c
init|=
name|cursor
decl_stmt|;
return|return
name|hx509_certs_next_cert
argument_list|(
name|context
argument_list|,
name|c
operator|->
name|certs
argument_list|,
name|c
operator|->
name|cursor
argument_list|,
name|cert
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p11_iter_end
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_certs
name|certs
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|void
modifier|*
name|cursor
parameter_list|)
block|{
name|struct
name|p11_cursor
modifier|*
name|c
init|=
name|cursor
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|hx509_certs_end_seq
argument_list|(
name|context
argument_list|,
name|c
operator|->
name|certs
argument_list|,
name|c
operator|->
name|cursor
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|c
operator|->
name|certs
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_define
define|#
directive|define
name|MECHFLAG
parameter_list|(
name|x
parameter_list|)
value|{ "unknown-flag-" #x, x }
end_define

begin_decl_stmt
specifier|static
name|struct
name|units
name|mechflags
index|[]
init|=
block|{
name|MECHFLAG
argument_list|(
literal|0x80000000
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x40000000
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x20000000
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x10000000
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x08000000
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x04000000
argument_list|)
block|,
block|{
literal|"ec-compress"
block|,
literal|0x2000000
block|}
block|,
block|{
literal|"ec-uncompress"
block|,
literal|0x1000000
block|}
block|,
block|{
literal|"ec-namedcurve"
block|,
literal|0x0800000
block|}
block|,
block|{
literal|"ec-ecparameters"
block|,
literal|0x0400000
block|}
block|,
block|{
literal|"ec-f-2m"
block|,
literal|0x0200000
block|}
block|,
block|{
literal|"ec-f-p"
block|,
literal|0x0100000
block|}
block|,
block|{
literal|"derive"
block|,
literal|0x0080000
block|}
block|,
block|{
literal|"unwrap"
block|,
literal|0x0040000
block|}
block|,
block|{
literal|"wrap"
block|,
literal|0x0020000
block|}
block|,
block|{
literal|"genereate-key-pair"
block|,
literal|0x0010000
block|}
block|,
block|{
literal|"generate"
block|,
literal|0x0008000
block|}
block|,
block|{
literal|"verify-recover"
block|,
literal|0x0004000
block|}
block|,
block|{
literal|"verify"
block|,
literal|0x0002000
block|}
block|,
block|{
literal|"sign-recover"
block|,
literal|0x0001000
block|}
block|,
block|{
literal|"sign"
block|,
literal|0x0000800
block|}
block|,
block|{
literal|"digest"
block|,
literal|0x0000400
block|}
block|,
block|{
literal|"decrypt"
block|,
literal|0x0000200
block|}
block|,
block|{
literal|"encrypt"
block|,
literal|0x0000100
block|}
block|,
name|MECHFLAG
argument_list|(
literal|0x00080
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x00040
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x00020
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x00010
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x00008
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x00004
argument_list|)
block|,
name|MECHFLAG
argument_list|(
literal|0x00002
argument_list|)
block|,
block|{
literal|"hw"
block|,
literal|0x0000001
block|}
block|,
block|{
name|NULL
block|,
literal|0x0000000
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|MECHFLAG
end_undef

begin_function
specifier|static
name|int
name|p11_printinfo
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_certs
name|certs
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|p11_module
modifier|*
name|p
init|=
name|data
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|_hx509_pi_printf
argument_list|(
name|func
argument_list|,
name|ctx
argument_list|,
literal|"pkcs11 driver with %d slot%s"
argument_list|,
name|p
operator|->
name|num_slots
argument_list|,
name|p
operator|->
name|num_slots
operator|>
literal|1
condition|?
literal|"s"
else|:
literal|""
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|num_slots
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|p11_slot
modifier|*
name|s
init|=
operator|&
name|p
operator|->
name|slot
index|[
name|i
index|]
decl_stmt|;
name|_hx509_pi_printf
argument_list|(
name|func
argument_list|,
name|ctx
argument_list|,
literal|"slot %d: id: %d name: %s flags: %08x"
argument_list|,
name|i
argument_list|,
operator|(
name|int
operator|)
name|s
operator|->
name|id
argument_list|,
name|s
operator|->
name|name
argument_list|,
name|s
operator|->
name|flags
argument_list|)
expr_stmt|;
name|_hx509_pi_printf
argument_list|(
name|func
argument_list|,
name|ctx
argument_list|,
literal|"number of supported mechanisms: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|s
operator|->
name|mechs
operator|.
name|num
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|s
operator|->
name|mechs
operator|.
name|num
condition|;
name|j
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|mechname
init|=
literal|"unknown"
decl_stmt|;
name|char
name|flags
index|[
literal|256
index|]
decl_stmt|,
name|unknownname
index|[
literal|40
index|]
decl_stmt|;
define|#
directive|define
name|MECHNAME
parameter_list|(
name|s
parameter_list|,
name|n
parameter_list|)
value|case s: mechname = n; break
switch|switch
condition|(
name|s
operator|->
name|mechs
operator|.
name|list
index|[
name|j
index|]
condition|)
block|{
name|MECHNAME
argument_list|(
name|CKM_RSA_PKCS_KEY_PAIR_GEN
argument_list|,
literal|"rsa-pkcs-key-pair-gen"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_RSA_PKCS
argument_list|,
literal|"rsa-pkcs"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_RSA_X_509
argument_list|,
literal|"rsa-x-509"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_MD5_RSA_PKCS
argument_list|,
literal|"md5-rsa-pkcs"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA1_RSA_PKCS
argument_list|,
literal|"sha1-rsa-pkcs"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA256_RSA_PKCS
argument_list|,
literal|"sha256-rsa-pkcs"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA384_RSA_PKCS
argument_list|,
literal|"sha384-rsa-pkcs"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA512_RSA_PKCS
argument_list|,
literal|"sha512-rsa-pkcs"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_RIPEMD160_RSA_PKCS
argument_list|,
literal|"ripemd160-rsa-pkcs"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_RSA_PKCS_OAEP
argument_list|,
literal|"rsa-pkcs-oaep"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA512_HMAC
argument_list|,
literal|"sha512-hmac"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA512
argument_list|,
literal|"sha512"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA384_HMAC
argument_list|,
literal|"sha384-hmac"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA384
argument_list|,
literal|"sha384"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA256_HMAC
argument_list|,
literal|"sha256-hmac"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA256
argument_list|,
literal|"sha256"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_SHA_1
argument_list|,
literal|"sha1"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_MD5
argument_list|,
literal|"md5"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_MD2
argument_list|,
literal|"md2"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_RIPEMD160
argument_list|,
literal|"ripemd-160"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_DES_ECB
argument_list|,
literal|"des-ecb"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_DES_CBC
argument_list|,
literal|"des-cbc"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_AES_ECB
argument_list|,
literal|"aes-ecb"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_AES_CBC
argument_list|,
literal|"aes-cbc"
argument_list|)
expr_stmt|;
name|MECHNAME
argument_list|(
name|CKM_DH_PKCS_PARAMETER_GEN
argument_list|,
literal|"dh-pkcs-parameter-gen"
argument_list|)
expr_stmt|;
default|default:
name|snprintf
argument_list|(
name|unknownname
argument_list|,
sizeof|sizeof
argument_list|(
name|unknownname
argument_list|)
argument_list|,
literal|"unknown-mech-%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|s
operator|->
name|mechs
operator|.
name|list
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|mechname
operator|=
name|unknownname
expr_stmt|;
break|break;
block|}
undef|#
directive|undef
name|MECHNAME
name|unparse_flags
argument_list|(
name|s
operator|->
name|mechs
operator|.
name|infos
index|[
name|j
index|]
operator|->
name|flags
argument_list|,
name|mechflags
argument_list|,
name|flags
argument_list|,
sizeof|sizeof
argument_list|(
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|_hx509_pi_printf
argument_list|(
name|func
argument_list|,
name|ctx
argument_list|,
literal|"  %s: %s"
argument_list|,
name|mechname
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|hx509_keyset_ops
name|keyset_pkcs11
init|=
block|{
literal|"PKCS11"
block|,
literal|0
block|,
name|p11_init
block|,
name|NULL
block|,
name|p11_free
block|,
name|NULL
block|,
name|NULL
block|,
name|p11_iter_start
block|,
name|p11_iter
block|,
name|p11_iter_end
block|,
name|p11_printinfo
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_DLOPEN */
end_comment

begin_function
name|void
name|_hx509_ks_pkcs11_register
parameter_list|(
name|hx509_context
name|context
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|HAVE_DLOPEN
name|_hx509_ks_register
argument_list|(
name|context
argument_list|,
operator|&
name|keyset_pkcs11
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

end_unit


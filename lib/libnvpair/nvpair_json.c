begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * This file and its contents are supplied under the terms of the  * Common Development and Distribution License ("CDDL"), version 1.0.  * You may only use this file in accordance with the terms of version  * 1.0 of the CDDL.  *  * A full copy of the text of the CDDL should have accompanied this  * source.  A copy of the CDDL is also available via the Internet at  * http://www.illumos.org/license/CDDL.  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2014, Joyent, Inc.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<wchar.h>
end_include

begin_include
include|#
directive|include
file|<sys/debug.h>
end_include

begin_include
include|#
directive|include
file|"libnvpair.h"
end_include

begin_define
define|#
directive|define
name|FPRINTF
parameter_list|(
name|fp
parameter_list|,
modifier|...
parameter_list|)
define|\
value|do {						\ 		if (fprintf(fp, __VA_ARGS__)< 0)	\ 			return (-1);			\ 	} while (0)
end_define

begin_comment
comment|/*  * When formatting a string for JSON output we must escape certain characters,  * as described in RFC4627.  This applies to both member names and  * DATA_TYPE_STRING values.  *  * This function will only operate correctly if the following conditions are  * met:  *  *       1. The input String is encoded in the current locale.  *  *       2. The current locale includes the Basic Multilingual Plane (plane 0)  *          as defined in the Unicode standard.  *  * The output will be entirely 7-bit ASCII (as a subset of UTF-8) with all  * representable Unicode characters included in their escaped numeric form.  */
end_comment

begin_function
specifier|static
name|int
name|nvlist_print_json_string
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
specifier|const
name|char
modifier|*
name|input
parameter_list|)
block|{
name|mbstate_t
name|mbr
decl_stmt|;
name|wchar_t
name|c
decl_stmt|;
name|size_t
name|sz
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbr
argument_list|,
sizeof|sizeof
argument_list|(
name|mbr
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\""
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|sz
operator|=
name|mbrtowc
argument_list|(
operator|&
name|c
argument_list|,
name|input
argument_list|,
name|MB_CUR_MAX
argument_list|,
operator|&
name|mbr
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'"'
case|:
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\\\""
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\r'
case|:
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\\r"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\\'
case|:
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\\\\"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\f'
case|:
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\\f"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\t'
case|:
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\\t"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\b'
case|:
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\\b"
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|(
name|c
operator|>=
literal|0x00
operator|&&
name|c
operator|<=
literal|0x1f
operator|)
operator|||
operator|(
name|c
operator|>
literal|0x7f
operator|&&
name|c
operator|<=
literal|0xffff
operator|)
condition|)
block|{
comment|/* 				 * Render both Control Characters and Unicode 				 * characters in the Basic Multilingual Plane 				 * as JSON-escaped multibyte characters. 				 */
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\\u%04x"
argument_list|,
call|(
name|int
call|)
argument_list|(
literal|0xffff
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|>=
literal|0x20
operator|&&
name|c
operator|<=
literal|0x7f
condition|)
block|{
comment|/* 				 * Render other 7-bit ASCII characters directly 				 * and drop other, unrepresentable characters. 				 */
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%c"
argument_list|,
call|(
name|int
call|)
argument_list|(
literal|0xff
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|input
operator|+=
name|sz
expr_stmt|;
block|}
if|if
condition|(
name|sz
operator|==
operator|(
name|size_t
operator|)
operator|-
literal|1
operator|||
name|sz
operator|==
operator|(
name|size_t
operator|)
operator|-
literal|2
condition|)
block|{
comment|/* 		 * We last read an invalid multibyte character sequence, 		 * so return an error. 		 */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"\""
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Dump a JSON-formatted representation of an nvlist to the provided FILE *.  * This routine does not output any new-lines or additional whitespace other  * than that contained in strings, nor does it call fflush(3C).  */
end_comment

begin_function
name|int
name|nvlist_print_json
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|nvlist_t
modifier|*
name|nvl
parameter_list|)
block|{
name|nvpair_t
modifier|*
name|curr
decl_stmt|;
name|boolean_t
name|first
init|=
name|B_TRUE
decl_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"{"
argument_list|)
expr_stmt|;
for|for
control|(
name|curr
operator|=
name|nvlist_next_nvpair
argument_list|(
name|nvl
argument_list|,
name|NULL
argument_list|)
init|;
name|curr
condition|;
name|curr
operator|=
name|nvlist_next_nvpair
argument_list|(
name|nvl
argument_list|,
name|curr
argument_list|)
control|)
block|{
name|data_type_t
name|type
init|=
name|nvpair_type
argument_list|(
name|curr
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|first
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
else|else
name|first
operator|=
name|B_FALSE
expr_stmt|;
if|if
condition|(
name|nvlist_print_json_string
argument_list|(
name|fp
argument_list|,
name|nvpair_name
argument_list|(
name|curr
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|DATA_TYPE_STRING
case|:
block|{
name|char
modifier|*
name|string
init|=
name|fnvpair_value_string
argument_list|(
name|curr
argument_list|)
decl_stmt|;
if|if
condition|(
name|nvlist_print_json_string
argument_list|(
name|fp
argument_list|,
name|string
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
block|}
case|case
name|DATA_TYPE_BOOLEAN
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_BOOLEAN_VALUE
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%s"
argument_list|,
name|fnvpair_value_boolean_value
argument_list|(
name|curr
argument_list|)
operator|==
name|B_TRUE
condition|?
literal|"true"
else|:
literal|"false"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_BYTE
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%hhu"
argument_list|,
name|fnvpair_value_byte
argument_list|(
name|curr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_INT8
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%hhd"
argument_list|,
name|fnvpair_value_int8
argument_list|(
name|curr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_UINT8
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%hhu"
argument_list|,
name|fnvpair_value_uint8_t
argument_list|(
name|curr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_INT16
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%hd"
argument_list|,
name|fnvpair_value_int16
argument_list|(
name|curr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_UINT16
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%hu"
argument_list|,
name|fnvpair_value_uint16
argument_list|(
name|curr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_INT32
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%d"
argument_list|,
name|fnvpair_value_int32
argument_list|(
name|curr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_UINT32
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%u"
argument_list|,
name|fnvpair_value_uint32
argument_list|(
name|curr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_INT64
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%lld"
argument_list|,
operator|(
name|long
name|long
operator|)
name|fnvpair_value_int64
argument_list|(
name|curr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_UINT64
case|:
block|{
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%llu"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|fnvpair_value_uint64
argument_list|(
name|curr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_HRTIME
case|:
block|{
name|hrtime_t
name|val
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_hrtime
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%llu"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|val
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_DOUBLE
case|:
block|{
name|double
name|val
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_double
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%f"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_NVLIST
case|:
block|{
if|if
condition|(
name|nvlist_print_json
argument_list|(
name|fp
argument_list|,
name|fnvpair_value_nvlist
argument_list|(
name|curr
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
block|}
case|case
name|DATA_TYPE_STRING_ARRAY
case|:
block|{
name|char
modifier|*
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_string_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvlist_print_json_string
argument_list|(
name|fp
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_NVLIST_ARRAY
case|:
block|{
name|nvlist_t
modifier|*
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_nvlist_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvlist_print_json
argument_list|(
name|fp
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_BOOLEAN_ARRAY
case|:
block|{
name|boolean_t
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_boolean_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
name|val
index|[
name|i
index|]
operator|==
name|B_TRUE
condition|?
literal|"true"
else|:
literal|"false"
argument_list|)
expr_stmt|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_BYTE_ARRAY
case|:
block|{
name|uchar_t
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_byte_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%hhu"
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_UINT8_ARRAY
case|:
block|{
name|uint8_t
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_uint8_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%hhu"
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_INT8_ARRAY
case|:
block|{
name|int8_t
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_int8_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%hd"
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_UINT16_ARRAY
case|:
block|{
name|uint16_t
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_uint16_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%hu"
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_INT16_ARRAY
case|:
block|{
name|int16_t
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_int16_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%hd"
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_UINT32_ARRAY
case|:
block|{
name|uint32_t
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_uint32_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%u"
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_INT32_ARRAY
case|:
block|{
name|int32_t
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_int32_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%d"
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_UINT64_ARRAY
case|:
block|{
name|uint64_t
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_uint64_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%llu"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_INT64_ARRAY
case|:
block|{
name|int64_t
modifier|*
name|val
decl_stmt|;
name|uint_t
name|valsz
decl_stmt|,
name|i
decl_stmt|;
name|VERIFY0
argument_list|(
name|nvpair_value_int64_array
argument_list|(
name|curr
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|valsz
argument_list|)
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"["
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|valsz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|","
argument_list|)
expr_stmt|;
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"%lld"
argument_list|,
operator|(
name|long
name|long
operator|)
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|DATA_TYPE_UNKNOWN
case|:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|FPRINTF
argument_list|(
name|fp
argument_list|,
literal|"}"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


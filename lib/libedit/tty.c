begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1992, 1993  *	The Regents of the University of California.  All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Christos Zoulas of Cornell University.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$NetBSD: tty.c,v 1.24 2006/03/18 09:07:05 christos Exp $  */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|SCCSID
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)tty.c	8.1 (Berkeley) 6/4/93"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint&& not SCCSID */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * tty.c: tty interface stuff  */
end_comment

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"sys.h"
end_include

begin_include
include|#
directive|include
file|"tty.h"
end_include

begin_include
include|#
directive|include
file|"el.h"
end_include

begin_typedef
typedef|typedef
struct|struct
name|ttymodes_t
block|{
specifier|const
name|char
modifier|*
name|m_name
decl_stmt|;
name|unsigned
name|int
name|m_value
decl_stmt|;
name|int
name|m_type
decl_stmt|;
block|}
name|ttymodes_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|ttymap_t
block|{
name|int
name|nch
decl_stmt|,
name|och
decl_stmt|;
comment|/* Internal and termio rep of chars */
name|el_action_t
name|bind
index|[
literal|3
index|]
decl_stmt|;
comment|/* emacs, vi, and vi-cmd */
block|}
name|ttymap_t
typedef|;
end_typedef

begin_decl_stmt
name|private
specifier|const
name|ttyperm_t
name|ttyperm
init|=
block|{
block|{
block|{
literal|"iflag:"
block|,
name|ICRNL
block|,
operator|(
name|INLCR
operator||
name|IGNCR
operator|)
block|}
block|,
block|{
literal|"oflag:"
block|,
operator|(
name|OPOST
operator||
name|ONLCR
operator|)
block|,
name|ONLRET
block|}
block|,
block|{
literal|"cflag:"
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"lflag:"
block|,
operator|(
name|ISIG
operator||
name|ICANON
operator||
name|ECHO
operator||
name|ECHOE
operator||
name|ECHOCTL
operator||
name|IEXTEN
operator|)
block|,
operator|(
name|NOFLSH
operator||
name|ECHONL
operator||
name|EXTPROC
operator||
name|FLUSHO
operator|)
block|}
block|,
block|{
literal|"chars:"
block|,
literal|0
block|,
literal|0
block|}
block|, 	}
block|,
block|{
block|{
literal|"iflag:"
block|,
operator|(
name|INLCR
operator||
name|ICRNL
operator|)
block|,
name|IGNCR
block|}
block|,
block|{
literal|"oflag:"
block|,
operator|(
name|OPOST
operator||
name|ONLCR
operator|)
block|,
name|ONLRET
block|}
block|,
block|{
literal|"cflag:"
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"lflag:"
block|,
name|ISIG
block|,
operator|(
name|NOFLSH
operator||
name|ICANON
operator||
name|ECHO
operator||
name|ECHOK
operator||
name|ECHONL
operator||
name|EXTPROC
operator||
name|IEXTEN
operator||
name|FLUSHO
operator|)
block|}
block|,
block|{
literal|"chars:"
block|,
operator|(
name|C_SH
argument_list|(
name|C_MIN
argument_list|)
operator||
name|C_SH
argument_list|(
name|C_TIME
argument_list|)
operator||
name|C_SH
argument_list|(
name|C_SWTCH
argument_list|)
operator||
name|C_SH
argument_list|(
name|C_DSWTCH
argument_list|)
operator||
name|C_SH
argument_list|(
name|C_SUSP
argument_list|)
operator||
name|C_SH
argument_list|(
name|C_DSUSP
argument_list|)
operator||
name|C_SH
argument_list|(
name|C_EOL
argument_list|)
operator||
name|C_SH
argument_list|(
name|C_DISCARD
argument_list|)
operator||
name|C_SH
argument_list|(
name|C_PGOFF
argument_list|)
operator||
name|C_SH
argument_list|(
name|C_PAGE
argument_list|)
operator||
name|C_SH
argument_list|(
name|C_STATUS
argument_list|)
operator|)
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|"iflag:"
block|,
literal|0
block|,
name|IXON
operator||
name|IXOFF
operator||
name|INLCR
operator||
name|ICRNL
block|}
block|,
block|{
literal|"oflag:"
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"cflag:"
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"lflag:"
block|,
literal|0
block|,
name|ISIG
operator||
name|IEXTEN
block|}
block|,
block|{
literal|"chars:"
block|,
literal|0
block|,
literal|0
block|}
block|, 	}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
specifier|const
name|ttychar_t
name|ttychar
init|=
block|{
block|{
name|CINTR
block|,
name|CQUIT
block|,
name|CERASE
block|,
name|CKILL
block|,
name|CEOF
block|,
name|CEOL
block|,
name|CEOL2
block|,
name|CSWTCH
block|,
name|CDSWTCH
block|,
name|CERASE2
block|,
name|CSTART
block|,
name|CSTOP
block|,
name|CWERASE
block|,
name|CSUSP
block|,
name|CDSUSP
block|,
name|CREPRINT
block|,
name|CDISCARD
block|,
name|CLNEXT
block|,
name|CSTATUS
block|,
name|CPAGE
block|,
name|CPGOFF
block|,
name|CKILL2
block|,
name|CBRK
block|,
name|CMIN
block|,
name|CTIME
block|}
block|,
block|{
name|CINTR
block|,
name|CQUIT
block|,
name|CERASE
block|,
name|CKILL
block|,
name|_POSIX_VDISABLE
block|,
name|_POSIX_VDISABLE
block|,
name|_POSIX_VDISABLE
block|,
name|_POSIX_VDISABLE
block|,
name|_POSIX_VDISABLE
block|,
name|CERASE2
block|,
name|CSTART
block|,
name|CSTOP
block|,
name|_POSIX_VDISABLE
block|,
name|CSUSP
block|,
name|_POSIX_VDISABLE
block|,
name|_POSIX_VDISABLE
block|,
name|CDISCARD
block|,
name|_POSIX_VDISABLE
block|,
name|_POSIX_VDISABLE
block|,
name|_POSIX_VDISABLE
block|,
name|_POSIX_VDISABLE
block|,
name|_POSIX_VDISABLE
block|,
name|_POSIX_VDISABLE
block|,
literal|1
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
specifier|const
name|ttymap_t
name|tty_map
index|[]
init|=
block|{
ifdef|#
directive|ifdef
name|VERASE
block|{
name|C_ERASE
block|,
name|VERASE
block|,
block|{
name|EM_DELETE_PREV_CHAR
block|,
name|VI_DELETE_PREV_CHAR
block|,
name|ED_PREV_CHAR
block|}
block|}
block|,
endif|#
directive|endif
comment|/* VERASE */
ifdef|#
directive|ifdef
name|VERASE2
block|{
name|C_ERASE2
block|,
name|VERASE2
block|,
block|{
name|EM_DELETE_PREV_CHAR
block|,
name|VI_DELETE_PREV_CHAR
block|,
name|ED_PREV_CHAR
block|}
block|}
block|,
endif|#
directive|endif
comment|/* VERASE2 */
ifdef|#
directive|ifdef
name|VKILL
block|{
name|C_KILL
block|,
name|VKILL
block|,
block|{
name|EM_KILL_LINE
block|,
name|VI_KILL_LINE_PREV
block|,
name|ED_UNASSIGNED
block|}
block|}
block|,
endif|#
directive|endif
comment|/* VKILL */
ifdef|#
directive|ifdef
name|VKILL2
block|{
name|C_KILL2
block|,
name|VKILL2
block|,
block|{
name|EM_KILL_LINE
block|,
name|VI_KILL_LINE_PREV
block|,
name|ED_UNASSIGNED
block|}
block|}
block|,
endif|#
directive|endif
comment|/* VKILL2 */
ifdef|#
directive|ifdef
name|VEOF
block|{
name|C_EOF
block|,
name|VEOF
block|,
block|{
name|EM_DELETE_OR_LIST
block|,
name|VI_LIST_OR_EOF
block|,
name|ED_UNASSIGNED
block|}
block|}
block|,
endif|#
directive|endif
comment|/* VEOF */
ifdef|#
directive|ifdef
name|VWERASE
block|{
name|C_WERASE
block|,
name|VWERASE
block|,
block|{
name|ED_DELETE_PREV_WORD
block|,
name|ED_DELETE_PREV_WORD
block|,
name|ED_PREV_WORD
block|}
block|}
block|,
endif|#
directive|endif
comment|/* VWERASE */
ifdef|#
directive|ifdef
name|VREPRINT
block|{
name|C_REPRINT
block|,
name|VREPRINT
block|,
block|{
name|ED_REDISPLAY
block|,
name|ED_INSERT
block|,
name|ED_REDISPLAY
block|}
block|}
block|,
endif|#
directive|endif
comment|/* VREPRINT */
ifdef|#
directive|ifdef
name|VLNEXT
block|{
name|C_LNEXT
block|,
name|VLNEXT
block|,
block|{
name|ED_QUOTED_INSERT
block|,
name|ED_QUOTED_INSERT
block|,
name|ED_UNASSIGNED
block|}
block|}
block|,
endif|#
directive|endif
comment|/* VLNEXT */
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
block|{
name|ED_UNASSIGNED
block|,
name|ED_UNASSIGNED
block|,
name|ED_UNASSIGNED
block|}
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
specifier|const
name|ttymodes_t
name|ttymodes
index|[]
init|=
block|{
ifdef|#
directive|ifdef
name|IGNBRK
block|{
literal|"ignbrk"
block|,
name|IGNBRK
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* IGNBRK */
ifdef|#
directive|ifdef
name|BRKINT
block|{
literal|"brkint"
block|,
name|BRKINT
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* BRKINT */
ifdef|#
directive|ifdef
name|IGNPAR
block|{
literal|"ignpar"
block|,
name|IGNPAR
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* IGNPAR */
ifdef|#
directive|ifdef
name|PARMRK
block|{
literal|"parmrk"
block|,
name|PARMRK
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* PARMRK */
ifdef|#
directive|ifdef
name|INPCK
block|{
literal|"inpck"
block|,
name|INPCK
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* INPCK */
ifdef|#
directive|ifdef
name|ISTRIP
block|{
literal|"istrip"
block|,
name|ISTRIP
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* ISTRIP */
ifdef|#
directive|ifdef
name|INLCR
block|{
literal|"inlcr"
block|,
name|INLCR
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* INLCR */
ifdef|#
directive|ifdef
name|IGNCR
block|{
literal|"igncr"
block|,
name|IGNCR
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* IGNCR */
ifdef|#
directive|ifdef
name|ICRNL
block|{
literal|"icrnl"
block|,
name|ICRNL
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* ICRNL */
ifdef|#
directive|ifdef
name|IUCLC
block|{
literal|"iuclc"
block|,
name|IUCLC
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* IUCLC */
ifdef|#
directive|ifdef
name|IXON
block|{
literal|"ixon"
block|,
name|IXON
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* IXON */
ifdef|#
directive|ifdef
name|IXANY
block|{
literal|"ixany"
block|,
name|IXANY
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* IXANY */
ifdef|#
directive|ifdef
name|IXOFF
block|{
literal|"ixoff"
block|,
name|IXOFF
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* IXOFF */
ifdef|#
directive|ifdef
name|IMAXBEL
block|{
literal|"imaxbel"
block|,
name|IMAXBEL
block|,
name|MD_INP
block|}
block|,
endif|#
directive|endif
comment|/* IMAXBEL */
ifdef|#
directive|ifdef
name|OPOST
block|{
literal|"opost"
block|,
name|OPOST
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* OPOST */
ifdef|#
directive|ifdef
name|OLCUC
block|{
literal|"olcuc"
block|,
name|OLCUC
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* OLCUC */
ifdef|#
directive|ifdef
name|ONLCR
block|{
literal|"onlcr"
block|,
name|ONLCR
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* ONLCR */
ifdef|#
directive|ifdef
name|OCRNL
block|{
literal|"ocrnl"
block|,
name|OCRNL
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* OCRNL */
ifdef|#
directive|ifdef
name|ONOCR
block|{
literal|"onocr"
block|,
name|ONOCR
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* ONOCR */
ifdef|#
directive|ifdef
name|ONOEOT
block|{
literal|"onoeot"
block|,
name|ONOEOT
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* ONOEOT */
ifdef|#
directive|ifdef
name|ONLRET
block|{
literal|"onlret"
block|,
name|ONLRET
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* ONLRET */
ifdef|#
directive|ifdef
name|OFILL
block|{
literal|"ofill"
block|,
name|OFILL
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* OFILL */
ifdef|#
directive|ifdef
name|OFDEL
block|{
literal|"ofdel"
block|,
name|OFDEL
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* OFDEL */
ifdef|#
directive|ifdef
name|NLDLY
block|{
literal|"nldly"
block|,
name|NLDLY
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* NLDLY */
ifdef|#
directive|ifdef
name|CRDLY
block|{
literal|"crdly"
block|,
name|CRDLY
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* CRDLY */
ifdef|#
directive|ifdef
name|TABDLY
block|{
literal|"tabdly"
block|,
name|TABDLY
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* TABDLY */
ifdef|#
directive|ifdef
name|XTABS
block|{
literal|"xtabs"
block|,
name|XTABS
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* XTABS */
ifdef|#
directive|ifdef
name|BSDLY
block|{
literal|"bsdly"
block|,
name|BSDLY
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* BSDLY */
ifdef|#
directive|ifdef
name|VTDLY
block|{
literal|"vtdly"
block|,
name|VTDLY
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* VTDLY */
ifdef|#
directive|ifdef
name|FFDLY
block|{
literal|"ffdly"
block|,
name|FFDLY
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* FFDLY */
ifdef|#
directive|ifdef
name|PAGEOUT
block|{
literal|"pageout"
block|,
name|PAGEOUT
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* PAGEOUT */
ifdef|#
directive|ifdef
name|WRAP
block|{
literal|"wrap"
block|,
name|WRAP
block|,
name|MD_OUT
block|}
block|,
endif|#
directive|endif
comment|/* WRAP */
ifdef|#
directive|ifdef
name|CIGNORE
block|{
literal|"cignore"
block|,
name|CIGNORE
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* CBAUD */
ifdef|#
directive|ifdef
name|CBAUD
block|{
literal|"cbaud"
block|,
name|CBAUD
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* CBAUD */
ifdef|#
directive|ifdef
name|CSTOPB
block|{
literal|"cstopb"
block|,
name|CSTOPB
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* CSTOPB */
ifdef|#
directive|ifdef
name|CREAD
block|{
literal|"cread"
block|,
name|CREAD
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* CREAD */
ifdef|#
directive|ifdef
name|PARENB
block|{
literal|"parenb"
block|,
name|PARENB
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* PARENB */
ifdef|#
directive|ifdef
name|PARODD
block|{
literal|"parodd"
block|,
name|PARODD
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* PARODD */
ifdef|#
directive|ifdef
name|HUPCL
block|{
literal|"hupcl"
block|,
name|HUPCL
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* HUPCL */
ifdef|#
directive|ifdef
name|CLOCAL
block|{
literal|"clocal"
block|,
name|CLOCAL
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* CLOCAL */
ifdef|#
directive|ifdef
name|LOBLK
block|{
literal|"loblk"
block|,
name|LOBLK
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* LOBLK */
ifdef|#
directive|ifdef
name|CIBAUD
block|{
literal|"cibaud"
block|,
name|CIBAUD
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* CIBAUD */
ifdef|#
directive|ifdef
name|CRTSCTS
ifdef|#
directive|ifdef
name|CCTS_OFLOW
block|{
literal|"ccts_oflow"
block|,
name|CCTS_OFLOW
block|,
name|MD_CTL
block|}
block|,
else|#
directive|else
block|{
literal|"crtscts"
block|,
name|CRTSCTS
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* CCTS_OFLOW */
endif|#
directive|endif
comment|/* CRTSCTS */
ifdef|#
directive|ifdef
name|CRTS_IFLOW
block|{
literal|"crts_iflow"
block|,
name|CRTS_IFLOW
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* CRTS_IFLOW */
ifdef|#
directive|ifdef
name|CDTRCTS
block|{
literal|"cdtrcts"
block|,
name|CDTRCTS
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* CDTRCTS */
ifdef|#
directive|ifdef
name|MDMBUF
block|{
literal|"mdmbuf"
block|,
name|MDMBUF
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* MDMBUF */
ifdef|#
directive|ifdef
name|RCV1EN
block|{
literal|"rcv1en"
block|,
name|RCV1EN
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* RCV1EN */
ifdef|#
directive|ifdef
name|XMT1EN
block|{
literal|"xmt1en"
block|,
name|XMT1EN
block|,
name|MD_CTL
block|}
block|,
endif|#
directive|endif
comment|/* XMT1EN */
ifdef|#
directive|ifdef
name|ISIG
block|{
literal|"isig"
block|,
name|ISIG
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* ISIG */
ifdef|#
directive|ifdef
name|ICANON
block|{
literal|"icanon"
block|,
name|ICANON
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* ICANON */
ifdef|#
directive|ifdef
name|XCASE
block|{
literal|"xcase"
block|,
name|XCASE
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* XCASE */
ifdef|#
directive|ifdef
name|ECHO
block|{
literal|"echo"
block|,
name|ECHO
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* ECHO */
ifdef|#
directive|ifdef
name|ECHOE
block|{
literal|"echoe"
block|,
name|ECHOE
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* ECHOE */
ifdef|#
directive|ifdef
name|ECHOK
block|{
literal|"echok"
block|,
name|ECHOK
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* ECHOK */
ifdef|#
directive|ifdef
name|ECHONL
block|{
literal|"echonl"
block|,
name|ECHONL
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* ECHONL */
ifdef|#
directive|ifdef
name|NOFLSH
block|{
literal|"noflsh"
block|,
name|NOFLSH
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* NOFLSH */
ifdef|#
directive|ifdef
name|TOSTOP
block|{
literal|"tostop"
block|,
name|TOSTOP
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* TOSTOP */
ifdef|#
directive|ifdef
name|ECHOCTL
block|{
literal|"echoctl"
block|,
name|ECHOCTL
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* ECHOCTL */
ifdef|#
directive|ifdef
name|ECHOPRT
block|{
literal|"echoprt"
block|,
name|ECHOPRT
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* ECHOPRT */
ifdef|#
directive|ifdef
name|ECHOKE
block|{
literal|"echoke"
block|,
name|ECHOKE
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* ECHOKE */
ifdef|#
directive|ifdef
name|DEFECHO
block|{
literal|"defecho"
block|,
name|DEFECHO
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* DEFECHO */
ifdef|#
directive|ifdef
name|FLUSHO
block|{
literal|"flusho"
block|,
name|FLUSHO
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* FLUSHO */
ifdef|#
directive|ifdef
name|PENDIN
block|{
literal|"pendin"
block|,
name|PENDIN
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* PENDIN */
ifdef|#
directive|ifdef
name|IEXTEN
block|{
literal|"iexten"
block|,
name|IEXTEN
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* IEXTEN */
ifdef|#
directive|ifdef
name|NOKERNINFO
block|{
literal|"nokerninfo"
block|,
name|NOKERNINFO
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* NOKERNINFO */
ifdef|#
directive|ifdef
name|ALTWERASE
block|{
literal|"altwerase"
block|,
name|ALTWERASE
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* ALTWERASE */
ifdef|#
directive|ifdef
name|EXTPROC
block|{
literal|"extproc"
block|,
name|EXTPROC
block|,
name|MD_LIN
block|}
block|,
endif|#
directive|endif
comment|/* EXTPROC */
if|#
directive|if
name|defined
argument_list|(
name|VINTR
argument_list|)
block|{
literal|"intr"
block|,
name|C_SH
argument_list|(
name|C_INTR
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VINTR */
if|#
directive|if
name|defined
argument_list|(
name|VQUIT
argument_list|)
block|{
literal|"quit"
block|,
name|C_SH
argument_list|(
name|C_QUIT
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VQUIT */
if|#
directive|if
name|defined
argument_list|(
name|VERASE
argument_list|)
block|{
literal|"erase"
block|,
name|C_SH
argument_list|(
name|C_ERASE
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VERASE */
if|#
directive|if
name|defined
argument_list|(
name|VKILL
argument_list|)
block|{
literal|"kill"
block|,
name|C_SH
argument_list|(
name|C_KILL
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VKILL */
if|#
directive|if
name|defined
argument_list|(
name|VEOF
argument_list|)
block|{
literal|"eof"
block|,
name|C_SH
argument_list|(
name|C_EOF
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VEOF */
if|#
directive|if
name|defined
argument_list|(
name|VEOL
argument_list|)
block|{
literal|"eol"
block|,
name|C_SH
argument_list|(
name|C_EOL
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VEOL */
if|#
directive|if
name|defined
argument_list|(
name|VEOL2
argument_list|)
block|{
literal|"eol2"
block|,
name|C_SH
argument_list|(
name|C_EOL2
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VEOL2 */
if|#
directive|if
name|defined
argument_list|(
name|VSWTCH
argument_list|)
block|{
literal|"swtch"
block|,
name|C_SH
argument_list|(
name|C_SWTCH
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VSWTCH */
if|#
directive|if
name|defined
argument_list|(
name|VDSWTCH
argument_list|)
block|{
literal|"dswtch"
block|,
name|C_SH
argument_list|(
name|C_DSWTCH
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VDSWTCH */
if|#
directive|if
name|defined
argument_list|(
name|VERASE2
argument_list|)
block|{
literal|"erase2"
block|,
name|C_SH
argument_list|(
name|C_ERASE2
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VERASE2 */
if|#
directive|if
name|defined
argument_list|(
name|VSTART
argument_list|)
block|{
literal|"start"
block|,
name|C_SH
argument_list|(
name|C_START
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VSTART */
if|#
directive|if
name|defined
argument_list|(
name|VSTOP
argument_list|)
block|{
literal|"stop"
block|,
name|C_SH
argument_list|(
name|C_STOP
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VSTOP */
if|#
directive|if
name|defined
argument_list|(
name|VWERASE
argument_list|)
block|{
literal|"werase"
block|,
name|C_SH
argument_list|(
name|C_WERASE
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VWERASE */
if|#
directive|if
name|defined
argument_list|(
name|VSUSP
argument_list|)
block|{
literal|"susp"
block|,
name|C_SH
argument_list|(
name|C_SUSP
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VSUSP */
if|#
directive|if
name|defined
argument_list|(
name|VDSUSP
argument_list|)
block|{
literal|"dsusp"
block|,
name|C_SH
argument_list|(
name|C_DSUSP
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VDSUSP */
if|#
directive|if
name|defined
argument_list|(
name|VREPRINT
argument_list|)
block|{
literal|"reprint"
block|,
name|C_SH
argument_list|(
name|C_REPRINT
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VREPRINT */
if|#
directive|if
name|defined
argument_list|(
name|VDISCARD
argument_list|)
block|{
literal|"discard"
block|,
name|C_SH
argument_list|(
name|C_DISCARD
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VDISCARD */
if|#
directive|if
name|defined
argument_list|(
name|VLNEXT
argument_list|)
block|{
literal|"lnext"
block|,
name|C_SH
argument_list|(
name|C_LNEXT
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VLNEXT */
if|#
directive|if
name|defined
argument_list|(
name|VSTATUS
argument_list|)
block|{
literal|"status"
block|,
name|C_SH
argument_list|(
name|C_STATUS
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VSTATUS */
if|#
directive|if
name|defined
argument_list|(
name|VPAGE
argument_list|)
block|{
literal|"page"
block|,
name|C_SH
argument_list|(
name|C_PAGE
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VPAGE */
if|#
directive|if
name|defined
argument_list|(
name|VPGOFF
argument_list|)
block|{
literal|"pgoff"
block|,
name|C_SH
argument_list|(
name|C_PGOFF
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VPGOFF */
if|#
directive|if
name|defined
argument_list|(
name|VKILL2
argument_list|)
block|{
literal|"kill2"
block|,
name|C_SH
argument_list|(
name|C_KILL2
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VKILL2 */
if|#
directive|if
name|defined
argument_list|(
name|VBRK
argument_list|)
block|{
literal|"brk"
block|,
name|C_SH
argument_list|(
name|C_BRK
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VBRK */
if|#
directive|if
name|defined
argument_list|(
name|VMIN
argument_list|)
block|{
literal|"min"
block|,
name|C_SH
argument_list|(
name|C_MIN
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VMIN */
if|#
directive|if
name|defined
argument_list|(
name|VTIME
argument_list|)
block|{
literal|"time"
block|,
name|C_SH
argument_list|(
name|C_TIME
argument_list|)
block|,
name|MD_CHAR
block|}
block|,
endif|#
directive|endif
comment|/* VTIME */
block|{
name|NULL
block|,
literal|0
block|,
operator|-
literal|1
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|tty_getty
parameter_list|(
name|el
parameter_list|,
name|td
parameter_list|)
value|tcgetattr((el)->el_infd, (td))
end_define

begin_define
define|#
directive|define
name|tty_setty
parameter_list|(
name|el
parameter_list|,
name|td
parameter_list|)
value|tcsetattr((el)->el_infd, TCSADRAIN, (td))
end_define

begin_define
define|#
directive|define
name|tty__gettabs
parameter_list|(
name|td
parameter_list|)
value|((((td)->c_oflag& TAB3) == TAB3) ? 0 : 1)
end_define

begin_define
define|#
directive|define
name|tty__geteightbit
parameter_list|(
name|td
parameter_list|)
value|(((td)->c_cflag& CSIZE) == CS8)
end_define

begin_define
define|#
directive|define
name|tty__cooked_mode
parameter_list|(
name|td
parameter_list|)
value|((td)->c_lflag& ICANON)
end_define

begin_function_decl
name|private
name|int
name|tty__getcharindex
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|private
name|void
name|tty__getchar
parameter_list|(
name|struct
name|termios
modifier|*
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|private
name|void
name|tty__setchar
parameter_list|(
name|struct
name|termios
modifier|*
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|private
name|speed_t
name|tty__getspeed
parameter_list|(
name|struct
name|termios
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|private
name|int
name|tty_setup
parameter_list|(
name|EditLine
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|t_qu
value|t_ts
end_define

begin_comment
comment|/* tty_setup():  *	Get the tty parameters and initialize the editing state  */
end_comment

begin_function
name|private
name|int
name|tty_setup
parameter_list|(
name|EditLine
modifier|*
name|el
parameter_list|)
block|{
name|int
name|rst
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|el
operator|->
name|el_flags
operator|&
name|EDIT_DISABLED
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|tty_getty
argument_list|(
name|el
argument_list|,
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ed
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_TTY
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"tty_setup: tty_getty: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG_TTY */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_ex
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_ed
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_speed
operator|=
name|tty__getspeed
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ex
argument_list|)
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_tabs
operator|=
name|tty__gettabs
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ex
argument_list|)
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_eight
operator|=
name|tty__geteightbit
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ex
argument_list|)
expr_stmt|;
comment|/*          * Reset the tty chars to reasonable defaults          * If they are disabled, then enable them.          */
if|if
condition|(
name|rst
condition|)
block|{
if|if
condition|(
name|tty__cooked_mode
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ts
argument_list|)
condition|)
block|{
name|tty__getchar
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ts
argument_list|,
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
argument_list|)
expr_stmt|;
comment|/* 	                 * Don't affect CMIN and CTIME for the editor mode 	                 */
for|for
control|(
name|rst
operator|=
literal|0
init|;
name|rst
operator|<
name|C_NCC
operator|-
literal|2
condition|;
name|rst
operator|++
control|)
if|if
condition|(
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
index|[
name|rst
index|]
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_vdisable
operator|&&
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|ED_IO
index|]
index|[
name|rst
index|]
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_vdisable
condition|)
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|ED_IO
index|]
index|[
name|rst
index|]
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
index|[
name|rst
index|]
expr_stmt|;
for|for
control|(
name|rst
operator|=
literal|0
init|;
name|rst
operator|<
name|C_NCC
condition|;
name|rst
operator|++
control|)
if|if
condition|(
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
index|[
name|rst
index|]
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_vdisable
condition|)
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|EX_IO
index|]
index|[
name|rst
index|]
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
index|[
name|rst
index|]
expr_stmt|;
block|}
block|}
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_iflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_INP
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_iflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_INP
index|]
operator|.
name|t_setmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_oflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_OUT
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_oflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_OUT
index|]
operator|.
name|t_setmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_cflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_CTL
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_cflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_CTL
index|]
operator|.
name|t_setmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_lflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_LIN
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_lflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_LIN
index|]
operator|.
name|t_setmask
expr_stmt|;
name|tty__setchar
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ed
argument_list|,
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|ED_IO
index|]
argument_list|)
expr_stmt|;
name|tty_bind_char
argument_list|(
name|el
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|protected
name|int
name|tty_init
parameter_list|(
name|EditLine
modifier|*
name|el
parameter_list|)
block|{
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|=
name|EX_IO
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_vdisable
operator|=
name|_POSIX_VDISABLE
expr_stmt|;
operator|(
name|void
operator|)
name|memcpy
argument_list|(
name|el
operator|->
name|el_tty
operator|.
name|t_t
argument_list|,
name|ttyperm
argument_list|,
sizeof|sizeof
argument_list|(
name|ttyperm_t
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memcpy
argument_list|(
name|el
operator|->
name|el_tty
operator|.
name|t_c
argument_list|,
name|ttychar
argument_list|,
sizeof|sizeof
argument_list|(
name|ttychar_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|tty_setup
argument_list|(
name|el
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* tty_end():  *	Restore the tty to its original settings  */
end_comment

begin_function
name|protected
name|void
comment|/*ARGSUSED*/
name|tty_end
parameter_list|(
name|EditLine
modifier|*
name|el
name|__unused
parameter_list|)
block|{
comment|/* XXX: Maybe reset to an initial state? */
block|}
end_function

begin_comment
comment|/* tty__getspeed():  *	Get the tty speed  */
end_comment

begin_function
name|private
name|speed_t
name|tty__getspeed
parameter_list|(
name|struct
name|termios
modifier|*
name|td
parameter_list|)
block|{
name|speed_t
name|spd
decl_stmt|;
if|if
condition|(
operator|(
name|spd
operator|=
name|cfgetispeed
argument_list|(
name|td
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|spd
operator|=
name|cfgetospeed
argument_list|(
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|spd
operator|)
return|;
block|}
end_function

begin_comment
comment|/* tty__getspeed():  *	Return the index of the asked char in the c_cc array  */
end_comment

begin_function
name|private
name|int
name|tty__getcharindex
parameter_list|(
name|int
name|i
parameter_list|)
block|{
switch|switch
condition|(
name|i
condition|)
block|{
ifdef|#
directive|ifdef
name|VINTR
case|case
name|C_INTR
case|:
return|return
name|VINTR
return|;
endif|#
directive|endif
comment|/* VINTR */
ifdef|#
directive|ifdef
name|VQUIT
case|case
name|C_QUIT
case|:
return|return
name|VQUIT
return|;
endif|#
directive|endif
comment|/* VQUIT */
ifdef|#
directive|ifdef
name|VERASE
case|case
name|C_ERASE
case|:
return|return
name|VERASE
return|;
endif|#
directive|endif
comment|/* VERASE */
ifdef|#
directive|ifdef
name|VKILL
case|case
name|C_KILL
case|:
return|return
name|VKILL
return|;
endif|#
directive|endif
comment|/* VKILL */
ifdef|#
directive|ifdef
name|VEOF
case|case
name|C_EOF
case|:
return|return
name|VEOF
return|;
endif|#
directive|endif
comment|/* VEOF */
ifdef|#
directive|ifdef
name|VEOL
case|case
name|C_EOL
case|:
return|return
name|VEOL
return|;
endif|#
directive|endif
comment|/* VEOL */
ifdef|#
directive|ifdef
name|VEOL2
case|case
name|C_EOL2
case|:
return|return
name|VEOL2
return|;
endif|#
directive|endif
comment|/* VEOL2 */
ifdef|#
directive|ifdef
name|VSWTCH
case|case
name|C_SWTCH
case|:
return|return
name|VSWTCH
return|;
endif|#
directive|endif
comment|/* VSWTCH */
ifdef|#
directive|ifdef
name|VDSWTCH
case|case
name|C_DSWTCH
case|:
return|return
name|VDSWTCH
return|;
endif|#
directive|endif
comment|/* VDSWTCH */
ifdef|#
directive|ifdef
name|VERASE2
case|case
name|C_ERASE2
case|:
return|return
name|VERASE2
return|;
endif|#
directive|endif
comment|/* VERASE2 */
ifdef|#
directive|ifdef
name|VSTART
case|case
name|C_START
case|:
return|return
name|VSTART
return|;
endif|#
directive|endif
comment|/* VSTART */
ifdef|#
directive|ifdef
name|VSTOP
case|case
name|C_STOP
case|:
return|return
name|VSTOP
return|;
endif|#
directive|endif
comment|/* VSTOP */
ifdef|#
directive|ifdef
name|VWERASE
case|case
name|C_WERASE
case|:
return|return
name|VWERASE
return|;
endif|#
directive|endif
comment|/* VWERASE */
ifdef|#
directive|ifdef
name|VSUSP
case|case
name|C_SUSP
case|:
return|return
name|VSUSP
return|;
endif|#
directive|endif
comment|/* VSUSP */
ifdef|#
directive|ifdef
name|VDSUSP
case|case
name|C_DSUSP
case|:
return|return
name|VDSUSP
return|;
endif|#
directive|endif
comment|/* VDSUSP */
ifdef|#
directive|ifdef
name|VREPRINT
case|case
name|C_REPRINT
case|:
return|return
name|VREPRINT
return|;
endif|#
directive|endif
comment|/* VREPRINT */
ifdef|#
directive|ifdef
name|VDISCARD
case|case
name|C_DISCARD
case|:
return|return
name|VDISCARD
return|;
endif|#
directive|endif
comment|/* VDISCARD */
ifdef|#
directive|ifdef
name|VLNEXT
case|case
name|C_LNEXT
case|:
return|return
name|VLNEXT
return|;
endif|#
directive|endif
comment|/* VLNEXT */
ifdef|#
directive|ifdef
name|VSTATUS
case|case
name|C_STATUS
case|:
return|return
name|VSTATUS
return|;
endif|#
directive|endif
comment|/* VSTATUS */
ifdef|#
directive|ifdef
name|VPAGE
case|case
name|C_PAGE
case|:
return|return
name|VPAGE
return|;
endif|#
directive|endif
comment|/* VPAGE */
ifdef|#
directive|ifdef
name|VPGOFF
case|case
name|C_PGOFF
case|:
return|return
name|VPGOFF
return|;
endif|#
directive|endif
comment|/* VPGOFF */
ifdef|#
directive|ifdef
name|VKILL2
case|case
name|C_KILL2
case|:
return|return
name|VKILL2
return|;
endif|#
directive|endif
comment|/* KILL2 */
ifdef|#
directive|ifdef
name|VMIN
case|case
name|C_MIN
case|:
return|return
name|VMIN
return|;
endif|#
directive|endif
comment|/* VMIN */
ifdef|#
directive|ifdef
name|VTIME
case|case
name|C_TIME
case|:
return|return
name|VTIME
return|;
endif|#
directive|endif
comment|/* VTIME */
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_comment
comment|/* tty__getchar():  *	Get the tty characters  */
end_comment

begin_function
name|private
name|void
name|tty__getchar
parameter_list|(
name|struct
name|termios
modifier|*
name|td
parameter_list|,
name|unsigned
name|char
modifier|*
name|s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|VINTR
name|s
index|[
name|C_INTR
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VINTR
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VINTR */
ifdef|#
directive|ifdef
name|VQUIT
name|s
index|[
name|C_QUIT
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VQUIT
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VQUIT */
ifdef|#
directive|ifdef
name|VERASE
name|s
index|[
name|C_ERASE
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VERASE
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VERASE */
ifdef|#
directive|ifdef
name|VKILL
name|s
index|[
name|C_KILL
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VKILL
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VKILL */
ifdef|#
directive|ifdef
name|VEOF
name|s
index|[
name|C_EOF
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VEOF
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VEOF */
ifdef|#
directive|ifdef
name|VEOL
name|s
index|[
name|C_EOL
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VEOL
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VEOL */
ifdef|#
directive|ifdef
name|VEOL2
name|s
index|[
name|C_EOL2
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VEOL2
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VEOL2 */
ifdef|#
directive|ifdef
name|VSWTCH
name|s
index|[
name|C_SWTCH
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VSWTCH
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VSWTCH */
ifdef|#
directive|ifdef
name|VDSWTCH
name|s
index|[
name|C_DSWTCH
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VDSWTCH
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VDSWTCH */
ifdef|#
directive|ifdef
name|VERASE2
name|s
index|[
name|C_ERASE2
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VERASE2
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VERASE2 */
ifdef|#
directive|ifdef
name|VSTART
name|s
index|[
name|C_START
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VSTART
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VSTART */
ifdef|#
directive|ifdef
name|VSTOP
name|s
index|[
name|C_STOP
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VSTOP
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VSTOP */
ifdef|#
directive|ifdef
name|VWERASE
name|s
index|[
name|C_WERASE
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VWERASE
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VWERASE */
ifdef|#
directive|ifdef
name|VSUSP
name|s
index|[
name|C_SUSP
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VSUSP
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VSUSP */
ifdef|#
directive|ifdef
name|VDSUSP
name|s
index|[
name|C_DSUSP
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VDSUSP
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VDSUSP */
ifdef|#
directive|ifdef
name|VREPRINT
name|s
index|[
name|C_REPRINT
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VREPRINT
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VREPRINT */
ifdef|#
directive|ifdef
name|VDISCARD
name|s
index|[
name|C_DISCARD
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VDISCARD
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VDISCARD */
ifdef|#
directive|ifdef
name|VLNEXT
name|s
index|[
name|C_LNEXT
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VLNEXT
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VLNEXT */
ifdef|#
directive|ifdef
name|VSTATUS
name|s
index|[
name|C_STATUS
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VSTATUS
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VSTATUS */
ifdef|#
directive|ifdef
name|VPAGE
name|s
index|[
name|C_PAGE
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VPAGE
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VPAGE */
ifdef|#
directive|ifdef
name|VPGOFF
name|s
index|[
name|C_PGOFF
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VPGOFF
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VPGOFF */
ifdef|#
directive|ifdef
name|VKILL2
name|s
index|[
name|C_KILL2
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VKILL2
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* KILL2 */
ifdef|#
directive|ifdef
name|VMIN
name|s
index|[
name|C_MIN
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VMIN
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VMIN */
ifdef|#
directive|ifdef
name|VTIME
name|s
index|[
name|C_TIME
index|]
operator|=
name|td
operator|->
name|c_cc
index|[
name|VTIME
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VTIME */
block|}
end_function

begin_comment
comment|/* tty__getchar */
end_comment

begin_comment
comment|/* tty__setchar():  *	Set the tty characters  */
end_comment

begin_function
name|private
name|void
name|tty__setchar
parameter_list|(
name|struct
name|termios
modifier|*
name|td
parameter_list|,
name|unsigned
name|char
modifier|*
name|s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|VINTR
name|td
operator|->
name|c_cc
index|[
name|VINTR
index|]
operator|=
name|s
index|[
name|C_INTR
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VINTR */
ifdef|#
directive|ifdef
name|VQUIT
name|td
operator|->
name|c_cc
index|[
name|VQUIT
index|]
operator|=
name|s
index|[
name|C_QUIT
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VQUIT */
ifdef|#
directive|ifdef
name|VERASE
name|td
operator|->
name|c_cc
index|[
name|VERASE
index|]
operator|=
name|s
index|[
name|C_ERASE
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VERASE */
ifdef|#
directive|ifdef
name|VKILL
name|td
operator|->
name|c_cc
index|[
name|VKILL
index|]
operator|=
name|s
index|[
name|C_KILL
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VKILL */
ifdef|#
directive|ifdef
name|VEOF
name|td
operator|->
name|c_cc
index|[
name|VEOF
index|]
operator|=
name|s
index|[
name|C_EOF
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VEOF */
ifdef|#
directive|ifdef
name|VEOL
name|td
operator|->
name|c_cc
index|[
name|VEOL
index|]
operator|=
name|s
index|[
name|C_EOL
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VEOL */
ifdef|#
directive|ifdef
name|VEOL2
name|td
operator|->
name|c_cc
index|[
name|VEOL2
index|]
operator|=
name|s
index|[
name|C_EOL2
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VEOL2 */
ifdef|#
directive|ifdef
name|VSWTCH
name|td
operator|->
name|c_cc
index|[
name|VSWTCH
index|]
operator|=
name|s
index|[
name|C_SWTCH
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VSWTCH */
ifdef|#
directive|ifdef
name|VDSWTCH
name|td
operator|->
name|c_cc
index|[
name|VDSWTCH
index|]
operator|=
name|s
index|[
name|C_DSWTCH
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VDSWTCH */
ifdef|#
directive|ifdef
name|VERASE2
name|td
operator|->
name|c_cc
index|[
name|VERASE2
index|]
operator|=
name|s
index|[
name|C_ERASE2
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VERASE2 */
ifdef|#
directive|ifdef
name|VSTART
name|td
operator|->
name|c_cc
index|[
name|VSTART
index|]
operator|=
name|s
index|[
name|C_START
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VSTART */
ifdef|#
directive|ifdef
name|VSTOP
name|td
operator|->
name|c_cc
index|[
name|VSTOP
index|]
operator|=
name|s
index|[
name|C_STOP
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VSTOP */
ifdef|#
directive|ifdef
name|VWERASE
name|td
operator|->
name|c_cc
index|[
name|VWERASE
index|]
operator|=
name|s
index|[
name|C_WERASE
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VWERASE */
ifdef|#
directive|ifdef
name|VSUSP
name|td
operator|->
name|c_cc
index|[
name|VSUSP
index|]
operator|=
name|s
index|[
name|C_SUSP
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VSUSP */
ifdef|#
directive|ifdef
name|VDSUSP
name|td
operator|->
name|c_cc
index|[
name|VDSUSP
index|]
operator|=
name|s
index|[
name|C_DSUSP
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VDSUSP */
ifdef|#
directive|ifdef
name|VREPRINT
name|td
operator|->
name|c_cc
index|[
name|VREPRINT
index|]
operator|=
name|s
index|[
name|C_REPRINT
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VREPRINT */
ifdef|#
directive|ifdef
name|VDISCARD
name|td
operator|->
name|c_cc
index|[
name|VDISCARD
index|]
operator|=
name|s
index|[
name|C_DISCARD
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VDISCARD */
ifdef|#
directive|ifdef
name|VLNEXT
name|td
operator|->
name|c_cc
index|[
name|VLNEXT
index|]
operator|=
name|s
index|[
name|C_LNEXT
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VLNEXT */
ifdef|#
directive|ifdef
name|VSTATUS
name|td
operator|->
name|c_cc
index|[
name|VSTATUS
index|]
operator|=
name|s
index|[
name|C_STATUS
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VSTATUS */
ifdef|#
directive|ifdef
name|VPAGE
name|td
operator|->
name|c_cc
index|[
name|VPAGE
index|]
operator|=
name|s
index|[
name|C_PAGE
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VPAGE */
ifdef|#
directive|ifdef
name|VPGOFF
name|td
operator|->
name|c_cc
index|[
name|VPGOFF
index|]
operator|=
name|s
index|[
name|C_PGOFF
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VPGOFF */
ifdef|#
directive|ifdef
name|VKILL2
name|td
operator|->
name|c_cc
index|[
name|VKILL2
index|]
operator|=
name|s
index|[
name|C_KILL2
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VKILL2 */
ifdef|#
directive|ifdef
name|VMIN
name|td
operator|->
name|c_cc
index|[
name|VMIN
index|]
operator|=
name|s
index|[
name|C_MIN
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VMIN */
ifdef|#
directive|ifdef
name|VTIME
name|td
operator|->
name|c_cc
index|[
name|VTIME
index|]
operator|=
name|s
index|[
name|C_TIME
index|]
expr_stmt|;
endif|#
directive|endif
comment|/* VTIME */
block|}
end_function

begin_comment
comment|/* tty__setchar */
end_comment

begin_comment
comment|/* tty_bind_char():  *	Rebind the editline functions  */
end_comment

begin_function
name|protected
name|void
name|tty_bind_char
parameter_list|(
name|EditLine
modifier|*
name|el
parameter_list|,
name|int
name|force
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|t_n
init|=
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|ED_IO
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|t_o
init|=
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_cc
decl_stmt|;
name|unsigned
name|char
name|new
index|[
literal|2
index|]
decl_stmt|,
name|old
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|ttymap_t
modifier|*
name|tp
decl_stmt|;
name|el_action_t
modifier|*
name|map
decl_stmt|,
modifier|*
name|alt
decl_stmt|;
specifier|const
name|el_action_t
modifier|*
name|dmap
decl_stmt|,
modifier|*
name|dalt
decl_stmt|;
name|new
index|[
literal|1
index|]
operator|=
name|old
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|map
operator|=
name|el
operator|->
name|el_map
operator|.
name|key
expr_stmt|;
name|alt
operator|=
name|el
operator|->
name|el_map
operator|.
name|alt
expr_stmt|;
if|if
condition|(
name|el
operator|->
name|el_map
operator|.
name|type
operator|==
name|MAP_VI
condition|)
block|{
name|dmap
operator|=
name|el
operator|->
name|el_map
operator|.
name|vii
expr_stmt|;
name|dalt
operator|=
name|el
operator|->
name|el_map
operator|.
name|vic
expr_stmt|;
block|}
else|else
block|{
name|dmap
operator|=
name|el
operator|->
name|el_map
operator|.
name|emacs
expr_stmt|;
name|dalt
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|tp
operator|=
name|tty_map
init|;
name|tp
operator|->
name|nch
operator|!=
operator|-
literal|1
condition|;
name|tp
operator|++
control|)
block|{
name|new
index|[
literal|0
index|]
operator|=
name|t_n
index|[
name|tp
operator|->
name|nch
index|]
expr_stmt|;
name|old
index|[
literal|0
index|]
operator|=
name|t_o
index|[
name|tp
operator|->
name|och
index|]
expr_stmt|;
if|if
condition|(
name|new
index|[
literal|0
index|]
operator|==
name|old
index|[
literal|0
index|]
operator|&&
operator|!
name|force
condition|)
continue|continue;
comment|/* Put the old default binding back, and set the new binding */
name|key_clear
argument_list|(
name|el
argument_list|,
name|map
argument_list|,
operator|(
name|char
operator|*
operator|)
name|old
argument_list|)
expr_stmt|;
name|map
index|[
name|old
index|[
literal|0
index|]
index|]
operator|=
name|dmap
index|[
name|old
index|[
literal|0
index|]
index|]
expr_stmt|;
name|key_clear
argument_list|(
name|el
argument_list|,
name|map
argument_list|,
operator|(
name|char
operator|*
operator|)
name|new
argument_list|)
expr_stmt|;
comment|/* MAP_VI == 1, MAP_EMACS == 0... */
name|map
index|[
name|new
index|[
literal|0
index|]
index|]
operator|=
name|tp
operator|->
name|bind
index|[
name|el
operator|->
name|el_map
operator|.
name|type
index|]
expr_stmt|;
if|if
condition|(
name|dalt
condition|)
block|{
name|key_clear
argument_list|(
name|el
argument_list|,
name|alt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|old
argument_list|)
expr_stmt|;
name|alt
index|[
name|old
index|[
literal|0
index|]
index|]
operator|=
name|dalt
index|[
name|old
index|[
literal|0
index|]
index|]
expr_stmt|;
name|key_clear
argument_list|(
name|el
argument_list|,
name|alt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|new
argument_list|)
expr_stmt|;
name|alt
index|[
name|new
index|[
literal|0
index|]
index|]
operator|=
name|tp
operator|->
name|bind
index|[
name|el
operator|->
name|el_map
operator|.
name|type
operator|+
literal|1
index|]
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* tty_rawmode():  * 	Set terminal into 1 character at a time mode.  */
end_comment

begin_function
name|protected
name|int
name|tty_rawmode
parameter_list|(
name|EditLine
modifier|*
name|el
parameter_list|)
block|{
if|if
condition|(
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|==
name|ED_IO
operator|||
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|==
name|QU_IO
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|el
operator|->
name|el_flags
operator|&
name|EDIT_DISABLED
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|tty_getty
argument_list|(
name|el
argument_list|,
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ts
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_TTY
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"tty_rawmode: tty_getty: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG_TTY */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/*          * We always keep up with the eight bit setting and the speed of the          * tty. But only we only believe changes that are made to cooked mode!          */
name|el
operator|->
name|el_tty
operator|.
name|t_eight
operator|=
name|tty__geteightbit
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ts
argument_list|)
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_speed
operator|=
name|tty__getspeed
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ts
argument_list|)
expr_stmt|;
if|if
condition|(
name|tty__getspeed
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ed
argument_list|)
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_speed
condition|)
block|{
operator|(
name|void
operator|)
name|cfsetispeed
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ed
argument_list|,
name|el
operator|->
name|el_tty
operator|.
name|t_speed
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfsetospeed
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ed
argument_list|,
name|el
operator|->
name|el_tty
operator|.
name|t_speed
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tty__cooked_mode
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ts
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_cflag
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_ex
operator|.
name|c_cflag
operator|)
operator|&&
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_cflag
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_cflag
operator|)
condition|)
block|{
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_cflag
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_cflag
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_cflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_CTL
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_cflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_CTL
index|]
operator|.
name|t_setmask
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_lflag
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_ex
operator|.
name|c_lflag
operator|)
operator|&&
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_lflag
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_lflag
operator|)
condition|)
block|{
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_lflag
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_lflag
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_lflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_LIN
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_lflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_LIN
index|]
operator|.
name|t_setmask
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_iflag
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_ex
operator|.
name|c_iflag
operator|)
operator|&&
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_iflag
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_iflag
operator|)
condition|)
block|{
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_iflag
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_iflag
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_iflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_INP
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_iflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_INP
index|]
operator|.
name|t_setmask
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_oflag
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_ex
operator|.
name|c_oflag
operator|)
operator|&&
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_oflag
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_oflag
operator|)
condition|)
block|{
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_oflag
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_ts
operator|.
name|c_oflag
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_oflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_OUT
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_ed
operator|.
name|c_oflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_OUT
index|]
operator|.
name|t_setmask
expr_stmt|;
block|}
if|if
condition|(
name|tty__gettabs
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ex
argument_list|)
operator|==
literal|0
condition|)
name|el
operator|->
name|el_tty
operator|.
name|t_tabs
operator|=
literal|0
expr_stmt|;
else|else
name|el
operator|->
name|el_tty
operator|.
name|t_tabs
operator|=
name|EL_CAN_TAB
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|tty__getchar
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ts
argument_list|,
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
argument_list|)
expr_stmt|;
comment|/* 		         * Check if the user made any changes. 		         * If he did, then propagate the changes to the 		         * edit and execute data structures. 		         */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|C_NCC
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
index|[
name|i
index|]
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|EX_IO
index|]
index|[
name|i
index|]
condition|)
break|break;
if|if
condition|(
name|i
operator|!=
name|C_NCC
condition|)
block|{
comment|/* 				 * Propagate changes only to the unprotected 				 * chars that have been modified just now. 				 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|C_NCC
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_CHAR
index|]
operator|.
name|t_setmask
operator|&
name|C_SH
argument_list|(
name|i
argument_list|)
operator|)
operator|)
operator|&&
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
index|[
name|i
index|]
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|EX_IO
index|]
index|[
name|i
index|]
operator|)
condition|)
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|ED_IO
index|]
index|[
name|i
index|]
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|ED_IO
index|]
index|[
name|MD_CHAR
index|]
operator|.
name|t_clrmask
operator|&
name|C_SH
argument_list|(
name|i
argument_list|)
condition|)
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|ED_IO
index|]
index|[
name|i
index|]
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_vdisable
expr_stmt|;
block|}
name|tty_bind_char
argument_list|(
name|el
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tty__setchar
argument_list|(
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ed
argument_list|,
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|ED_IO
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|C_NCC
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|EX_IO
index|]
index|[
name|MD_CHAR
index|]
operator|.
name|t_setmask
operator|&
name|C_SH
argument_list|(
name|i
argument_list|)
operator|)
operator|)
operator|&&
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
index|[
name|i
index|]
operator|!=
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|EX_IO
index|]
index|[
name|i
index|]
operator|)
condition|)
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|EX_IO
index|]
index|[
name|i
index|]
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|TS_IO
index|]
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|EX_IO
index|]
index|[
name|MD_CHAR
index|]
operator|.
name|t_clrmask
operator|&
name|C_SH
argument_list|(
name|i
argument_list|)
condition|)
name|el
operator|->
name|el_tty
operator|.
name|t_c
index|[
name|EX_IO
index|]
index|[
name|i
index|]
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_vdisable
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|==
name|EX_IO
condition|)
name|el
operator|->
name|el_tty
operator|.
name|t_ex
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_ts
expr_stmt|;
if|if
condition|(
name|tty_setty
argument_list|(
name|el
argument_list|,
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ed
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_TTY
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"tty_rawmode: tty_setty: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG_TTY */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|=
name|ED_IO
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* tty_cookedmode():  *	Set the tty back to normal mode  */
end_comment

begin_function
name|protected
name|int
name|tty_cookedmode
parameter_list|(
name|EditLine
modifier|*
name|el
parameter_list|)
block|{
comment|/* set tty in normal setup */
if|if
condition|(
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|==
name|EX_IO
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|el
operator|->
name|el_flags
operator|&
name|EDIT_DISABLED
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|tty_setty
argument_list|(
name|el
argument_list|,
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ex
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_TTY
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"tty_cookedmode: tty_setty: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG_TTY */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|=
name|EX_IO
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* tty_quotemode():  *	Turn on quote mode  */
end_comment

begin_function
name|protected
name|int
name|tty_quotemode
parameter_list|(
name|EditLine
modifier|*
name|el
parameter_list|)
block|{
if|if
condition|(
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|==
name|QU_IO
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|el
operator|->
name|el_tty
operator|.
name|t_qu
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_ed
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_qu
operator|.
name|c_iflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|QU_IO
index|]
index|[
name|MD_INP
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_qu
operator|.
name|c_iflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|QU_IO
index|]
index|[
name|MD_INP
index|]
operator|.
name|t_setmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_qu
operator|.
name|c_oflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|QU_IO
index|]
index|[
name|MD_OUT
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_qu
operator|.
name|c_oflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|QU_IO
index|]
index|[
name|MD_OUT
index|]
operator|.
name|t_setmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_qu
operator|.
name|c_cflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|QU_IO
index|]
index|[
name|MD_CTL
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_qu
operator|.
name|c_cflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|QU_IO
index|]
index|[
name|MD_CTL
index|]
operator|.
name|t_setmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_qu
operator|.
name|c_lflag
operator|&=
operator|~
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|QU_IO
index|]
index|[
name|MD_LIN
index|]
operator|.
name|t_clrmask
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_qu
operator|.
name|c_lflag
operator||=
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|QU_IO
index|]
index|[
name|MD_LIN
index|]
operator|.
name|t_setmask
expr_stmt|;
if|if
condition|(
name|tty_setty
argument_list|(
name|el
argument_list|,
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_qu
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_TTY
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"QuoteModeOn: tty_setty: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG_TTY */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|=
name|QU_IO
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* tty_noquotemode():  *	Turn off quote mode  */
end_comment

begin_function
name|protected
name|int
name|tty_noquotemode
parameter_list|(
name|EditLine
modifier|*
name|el
parameter_list|)
block|{
if|if
condition|(
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|!=
name|QU_IO
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|tty_setty
argument_list|(
name|el
argument_list|,
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ed
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_TTY
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"QuoteModeOff: tty_setty: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG_TTY */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|el
operator|->
name|el_tty
operator|.
name|t_mode
operator|=
name|ED_IO
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* tty_stty():  *	Stty builtin  */
end_comment

begin_function
name|protected
name|int
comment|/*ARGSUSED*/
name|tty_stty
parameter_list|(
name|EditLine
modifier|*
name|el
parameter_list|,
name|int
name|argc
name|__unused
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|const
name|ttymodes_t
modifier|*
name|m
decl_stmt|;
name|char
name|x
decl_stmt|;
name|int
name|aflag
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|d
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|struct
name|termios
modifier|*
name|tios
init|=
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ex
decl_stmt|;
name|int
name|z
init|=
name|EX_IO
decl_stmt|;
if|if
condition|(
name|argv
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|name
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argv
operator|&&
operator|*
name|argv
operator|&&
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
operator|&&
name|argv
index|[
literal|0
index|]
index|[
literal|2
index|]
operator|==
literal|'\0'
condition|)
switch|switch
condition|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'a'
case|:
name|aflag
operator|++
expr_stmt|;
name|argv
operator|++
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|argv
operator|++
expr_stmt|;
name|tios
operator|=
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ed
expr_stmt|;
name|z
operator|=
name|ED_IO
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|argv
operator|++
expr_stmt|;
name|tios
operator|=
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ex
expr_stmt|;
name|z
operator|=
name|EX_IO
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|argv
operator|++
expr_stmt|;
name|tios
operator|=
operator|&
name|el
operator|->
name|el_tty
operator|.
name|t_ts
expr_stmt|;
name|z
operator|=
name|QU_IO
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"%s: Unknown switch `%c'.\n"
argument_list|,
name|name
argument_list|,
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|argv
operator|||
operator|!
operator|*
name|argv
condition|)
block|{
name|int
name|i
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|len
init|=
literal|0
decl_stmt|,
name|st
init|=
literal|0
decl_stmt|,
name|cu
decl_stmt|;
for|for
control|(
name|m
operator|=
name|ttymodes
init|;
name|m
operator|->
name|m_name
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
name|m
operator|->
name|m_type
operator|!=
name|i
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_outfile
argument_list|,
literal|"%s%s"
argument_list|,
name|i
operator|!=
operator|-
literal|1
condition|?
literal|"\n"
else|:
literal|""
argument_list|,
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|z
index|]
index|[
name|m
operator|->
name|m_type
index|]
operator|.
name|t_name
argument_list|)
expr_stmt|;
name|i
operator|=
name|m
operator|->
name|m_type
expr_stmt|;
name|st
operator|=
name|len
operator|=
name|strlen
argument_list|(
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|z
index|]
index|[
name|m
operator|->
name|m_type
index|]
operator|.
name|t_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
operator|-
literal|1
condition|)
block|{
name|x
operator|=
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|z
index|]
index|[
name|i
index|]
operator|.
name|t_setmask
operator|&
name|m
operator|->
name|m_value
operator|)
condition|?
literal|'+'
else|:
literal|'\0'
expr_stmt|;
name|x
operator|=
operator|(
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|z
index|]
index|[
name|i
index|]
operator|.
name|t_clrmask
operator|&
name|m
operator|->
name|m_value
operator|)
condition|?
literal|'-'
else|:
name|x
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|!=
literal|'\0'
operator|||
name|aflag
condition|)
block|{
name|cu
operator|=
name|strlen
argument_list|(
name|m
operator|->
name|m_name
argument_list|)
operator|+
operator|(
name|x
operator|!=
literal|'\0'
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|+
name|cu
operator|>=
name|el
operator|->
name|el_term
operator|.
name|t_size
operator|.
name|h
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_outfile
argument_list|,
literal|"\n%*s"
argument_list|,
name|st
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|len
operator|=
name|st
operator|+
name|cu
expr_stmt|;
block|}
else|else
name|len
operator|+=
name|cu
expr_stmt|;
if|if
condition|(
name|x
operator|!=
literal|'\0'
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_outfile
argument_list|,
literal|"%c%s "
argument_list|,
name|x
argument_list|,
name|m
operator|->
name|m_name
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_outfile
argument_list|,
literal|"%s "
argument_list|,
name|m
operator|->
name|m_name
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_outfile
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
while|while
condition|(
name|argv
operator|&&
operator|(
name|s
operator|=
operator|*
name|argv
operator|++
operator|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
switch|switch
condition|(
operator|*
name|s
condition|)
block|{
case|case
literal|'+'
case|:
case|case
literal|'-'
case|:
name|x
operator|=
operator|*
name|s
operator|++
expr_stmt|;
break|break;
default|default:
name|x
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|d
operator|=
name|s
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|s
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
name|ttymodes
init|;
name|m
operator|->
name|m_name
condition|;
name|m
operator|++
control|)
if|if
condition|(
operator|(
name|p
condition|?
name|strncmp
argument_list|(
name|m
operator|->
name|m_name
argument_list|,
name|d
argument_list|,
call|(
name|size_t
call|)
argument_list|(
name|p
operator|-
name|d
argument_list|)
argument_list|)
else|:
name|strcmp
argument_list|(
name|m
operator|->
name|m_name
argument_list|,
name|d
argument_list|)
operator|)
operator|==
literal|0
operator|&&
operator|(
name|p
operator|==
name|NULL
operator|||
name|m
operator|->
name|m_type
operator|==
name|MD_CHAR
operator|)
condition|)
break|break;
if|if
condition|(
operator|!
name|m
operator|->
name|m_name
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"%s: Invalid argument `%s'.\n"
argument_list|,
name|name
argument_list|,
name|d
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|p
condition|)
block|{
name|int
name|c
init|=
name|ffs
argument_list|(
operator|(
name|int
operator|)
name|m
operator|->
name|m_value
argument_list|)
decl_stmt|;
name|int
name|v
init|=
operator|*
operator|++
name|p
condition|?
name|parse__escape
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
operator|&
name|p
argument_list|)
else|:
name|el
operator|->
name|el_tty
operator|.
name|t_vdisable
decl_stmt|;
name|assert
argument_list|(
name|c
operator|--
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|c
operator|=
name|tty__getcharindex
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|c
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tios
operator|->
name|c_cc
index|[
name|c
index|]
operator|=
name|v
expr_stmt|;
continue|continue;
block|}
switch|switch
condition|(
name|x
condition|)
block|{
case|case
literal|'+'
case|:
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|z
index|]
index|[
name|m
operator|->
name|m_type
index|]
operator|.
name|t_setmask
operator||=
name|m
operator|->
name|m_value
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|z
index|]
index|[
name|m
operator|->
name|m_type
index|]
operator|.
name|t_clrmask
operator|&=
operator|~
name|m
operator|->
name|m_value
expr_stmt|;
break|break;
case|case
literal|'-'
case|:
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|z
index|]
index|[
name|m
operator|->
name|m_type
index|]
operator|.
name|t_setmask
operator|&=
operator|~
name|m
operator|->
name|m_value
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|z
index|]
index|[
name|m
operator|->
name|m_type
index|]
operator|.
name|t_clrmask
operator||=
name|m
operator|->
name|m_value
expr_stmt|;
break|break;
default|default:
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|z
index|]
index|[
name|m
operator|->
name|m_type
index|]
operator|.
name|t_setmask
operator|&=
operator|~
name|m
operator|->
name|m_value
expr_stmt|;
name|el
operator|->
name|el_tty
operator|.
name|t_t
index|[
name|z
index|]
index|[
name|m
operator|->
name|m_type
index|]
operator|.
name|t_clrmask
operator|&=
operator|~
name|m
operator|->
name|m_value
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|notyet
end_ifdef

begin_comment
comment|/* tty_printchar():  *	DEbugging routine to print the tty characters  */
end_comment

begin_function
name|private
name|void
name|tty_printchar
parameter_list|(
name|EditLine
modifier|*
name|el
parameter_list|,
name|unsigned
name|char
modifier|*
name|s
parameter_list|)
block|{
name|ttyperm_t
modifier|*
name|m
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|C_NCC
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|m
operator|=
name|el
operator|->
name|el_tty
operator|.
name|t_t
init|;
name|m
operator|->
name|m_name
condition|;
name|m
operator|++
control|)
if|if
condition|(
name|m
operator|->
name|m_type
operator|==
name|MD_CHAR
operator|&&
name|C_SH
argument_list|(
name|i
argument_list|)
operator|==
name|m
operator|->
name|m_value
condition|)
break|break;
if|if
condition|(
name|m
operator|->
name|m_name
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"%s ^%c "
argument_list|,
name|m
operator|->
name|m_name
argument_list|,
name|s
index|[
name|i
index|]
operator|+
literal|'A'
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|%
literal|5
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|el
operator|->
name|el_errfile
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* notyet */
end_comment

end_unit


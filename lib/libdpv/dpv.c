begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013-2014 Devin Teske<dteske@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *   * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<dialog.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<string_m.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"dialog_util.h"
end_include

begin_include
include|#
directive|include
file|"dialogrc.h"
end_include

begin_include
include|#
directive|include
file|"dprompt.h"
end_include

begin_include
include|#
directive|include
file|"dpv.h"
end_include

begin_include
include|#
directive|include
file|"dpv_private.h"
end_include

begin_include
include|#
directive|include
file|"status.h"
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_comment
comment|/* Test Mechanics (Only used when dpv_config.options |= DPV_TEST_MODE) */
end_comment

begin_define
define|#
directive|define
name|INCREMENT
value|1
end_define

begin_comment
comment|/* Increment % per-pass test-mode */
end_comment

begin_define
define|#
directive|define
name|XDIALOG_INCREMENT
value|15
end_define

begin_comment
comment|/* different for slower Xdialog(1) */
end_comment

begin_decl_stmt
specifier|static
name|uint8_t
name|increment
init|=
name|INCREMENT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Debugging */
end_comment

begin_decl_stmt
name|uint8_t
name|debug
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Data to process */
end_comment

begin_decl_stmt
name|int
name|dpv_interrupt
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dpv_abort
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|dpv_nfiles
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Data processing */
end_comment

begin_decl_stmt
name|long
name|long
name|dpv_overall_read
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|pathbuf
index|[
name|PATH_MAX
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Extra display information */
end_comment

begin_decl_stmt
name|uint8_t
name|no_labels
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dpv_config.options& DPV_NO_LABELS */
end_comment

begin_decl_stmt
name|uint8_t
name|wide
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dpv_config.options& DPV_WIDE_MODE */
end_comment

begin_decl_stmt
name|char
modifier|*
name|aprompt
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dpv_config.aprompt */
end_comment

begin_decl_stmt
name|char
modifier|*
name|msg_done
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dpv_config.msg_done */
end_comment

begin_decl_stmt
name|char
modifier|*
name|msg_fail
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dpv_config.msg_fail */
end_comment

begin_decl_stmt
name|char
modifier|*
name|msg_pending
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dpv_config.msg_pending */
end_comment

begin_decl_stmt
name|char
modifier|*
name|pprompt
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dpv_config.pprompt */
end_comment

begin_comment
comment|/* Status-Line format for when using dialog(3) */
end_comment

begin_decl_stmt
specifier|const
name|char
modifier|*
name|status_format_custom
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|status_format_default
index|[
name|DPV_STATUS_FORMAT_MAX
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Takes a pointer to a dpv_config structure containing layout details and  * pointer to initial element in a linked-list of dpv_file_node structures,  * each presenting a file to process. Executes the `action' function passed-in  * as a member to the `config' structure argument.  */
end_comment

begin_function
name|int
name|dpv
parameter_list|(
name|struct
name|dpv_config
modifier|*
name|config
parameter_list|,
name|struct
name|dpv_file_node
modifier|*
name|file_list
parameter_list|)
block|{
name|char
name|c
decl_stmt|;
name|uint8_t
name|keep_going
decl_stmt|;
name|uint8_t
name|nls
init|=
name|FALSE
decl_stmt|;
comment|/* See dialog_prompt_nlstate() */
name|uint8_t
name|no_overrun
init|=
name|FALSE
decl_stmt|;
name|uint8_t
name|pprompt_nls
init|=
name|FALSE
decl_stmt|;
comment|/* See dialog_prompt_nlstate() */
name|uint8_t
name|shrink_label_size
init|=
name|FALSE
decl_stmt|;
name|mode_t
name|mask
decl_stmt|;
name|uint16_t
name|options
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|char
modifier|*
name|fc
decl_stmt|;
name|char
modifier|*
name|last
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|output
decl_stmt|;
specifier|const
name|char
modifier|*
name|status_fmt
decl_stmt|;
specifier|const
name|char
modifier|*
name|path_fmt
decl_stmt|;
name|enum
name|dpv_display
name|display_type
decl_stmt|;
name|enum
name|dpv_output
name|output_type
decl_stmt|;
name|enum
name|dpv_status
name|status
decl_stmt|;
name|int
function_decl|(
modifier|*
name|action
function_decl|)
parameter_list|(
name|struct
name|dpv_file_node
modifier|*
name|file
parameter_list|,
name|int
name|out
parameter_list|)
function_decl|;
name|int
name|backslash
decl_stmt|;
name|int
name|dialog_last_update
init|=
literal|0
decl_stmt|;
name|int
name|dialog_old_nthfile
init|=
literal|0
decl_stmt|;
name|int
name|dialog_old_seconds
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|dialog_out
init|=
name|STDOUT_FILENO
decl_stmt|;
name|int
name|dialog_update_usec
init|=
literal|0
decl_stmt|;
name|int
name|dialog_updates_per_second
decl_stmt|;
name|int
name|files_left
decl_stmt|;
name|int
name|max_cols
decl_stmt|;
name|int
name|nthfile
init|=
literal|0
decl_stmt|;
name|int
name|output_out
decl_stmt|;
name|int
name|overall
init|=
literal|0
decl_stmt|;
name|int
name|pct
decl_stmt|;
name|int
name|res
decl_stmt|;
name|int
name|seconds
decl_stmt|;
name|int
name|status_last_update
init|=
literal|0
decl_stmt|;
name|int
name|status_old_nthfile
init|=
literal|0
decl_stmt|;
name|int
name|status_old_seconds
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|status_update_usec
init|=
literal|0
decl_stmt|;
name|int
name|status_updates_per_second
decl_stmt|;
name|pid_t
name|output_pid
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|dpv_file_node
modifier|*
name|curfile
decl_stmt|;
name|struct
name|dpv_file_node
modifier|*
name|first_file
decl_stmt|;
name|struct
name|dpv_file_node
modifier|*
name|list_head
decl_stmt|;
name|struct
name|timeval
name|now
decl_stmt|;
name|struct
name|timeval
name|start
decl_stmt|;
name|char
name|init_prompt
index|[
name|PROMPT_MAX
operator|+
literal|1
index|]
init|=
literal|""
decl_stmt|;
comment|/* Initialize globals to default values */
name|aprompt
operator|=
name|NULL
expr_stmt|;
name|pprompt
operator|=
name|NULL
expr_stmt|;
name|options
operator|=
literal|0
expr_stmt|;
name|action
operator|=
name|NULL
expr_stmt|;
name|backtitle
operator|=
name|NULL
expr_stmt|;
name|debug
operator|=
name|FALSE
expr_stmt|;
name|dialog_test
operator|=
name|FALSE
expr_stmt|;
name|dialog_updates_per_second
operator|=
name|DIALOG_UPDATES_PER_SEC
expr_stmt|;
name|display_limit
operator|=
name|DISPLAY_LIMIT_DEFAULT
expr_stmt|;
name|display_type
operator|=
name|DPV_DISPLAY_LIBDIALOG
expr_stmt|;
name|label_size
operator|=
name|LABEL_SIZE_DEFAULT
expr_stmt|;
name|msg_done
operator|=
name|NULL
expr_stmt|;
name|msg_fail
operator|=
name|NULL
expr_stmt|;
name|msg_pending
operator|=
name|NULL
expr_stmt|;
name|no_labels
operator|=
name|FALSE
expr_stmt|;
name|output
operator|=
name|NULL
expr_stmt|;
name|output_type
operator|=
name|DPV_OUTPUT_NONE
expr_stmt|;
name|pbar_size
operator|=
name|PBAR_SIZE_DEFAULT
expr_stmt|;
name|status_format_custom
operator|=
name|NULL
expr_stmt|;
name|status_updates_per_second
operator|=
name|STATUS_UPDATES_PER_SEC
expr_stmt|;
name|title
operator|=
name|NULL
expr_stmt|;
name|wide
operator|=
name|FALSE
expr_stmt|;
comment|/* Process config options (overriding defaults) */
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|config
operator|->
name|aprompt
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|aprompt
operator|==
name|NULL
condition|)
block|{
name|aprompt
operator|=
name|malloc
argument_list|(
name|DPV_APROMPT_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|aprompt
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|snprintf
argument_list|(
name|aprompt
argument_list|,
name|DPV_APROMPT_MAX
argument_list|,
literal|"%s"
argument_list|,
name|config
operator|->
name|aprompt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config
operator|->
name|pprompt
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|pprompt
operator|==
name|NULL
condition|)
block|{
name|pprompt
operator|=
name|malloc
argument_list|(
name|DPV_PPROMPT_MAX
operator|+
literal|2
argument_list|)
expr_stmt|;
comment|/* +2 is for implicit "\n" appended later */
if|if
condition|(
name|pprompt
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|snprintf
argument_list|(
name|pprompt
argument_list|,
name|DPV_APROMPT_MAX
argument_list|,
literal|"%s"
argument_list|,
name|config
operator|->
name|pprompt
argument_list|)
expr_stmt|;
block|}
name|options
operator|=
name|config
operator|->
name|options
expr_stmt|;
name|action
operator|=
name|config
operator|->
name|action
expr_stmt|;
name|backtitle
operator|=
name|config
operator|->
name|backtitle
expr_stmt|;
name|debug
operator|=
name|config
operator|->
name|debug
expr_stmt|;
name|dialog_test
operator|=
operator|(
operator|(
name|options
operator|&
name|DPV_TEST_MODE
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|dialog_updates_per_second
operator|=
name|config
operator|->
name|dialog_updates_per_second
expr_stmt|;
name|display_limit
operator|=
name|config
operator|->
name|display_limit
expr_stmt|;
name|display_type
operator|=
name|config
operator|->
name|display_type
expr_stmt|;
name|label_size
operator|=
name|config
operator|->
name|label_size
expr_stmt|;
name|msg_done
operator|=
operator|(
name|char
operator|*
operator|)
name|config
operator|->
name|msg_done
expr_stmt|;
name|msg_fail
operator|=
operator|(
name|char
operator|*
operator|)
name|config
operator|->
name|msg_fail
expr_stmt|;
name|msg_pending
operator|=
operator|(
name|char
operator|*
operator|)
name|config
operator|->
name|msg_pending
expr_stmt|;
name|no_labels
operator|=
operator|(
operator|(
name|options
operator|&
name|DPV_NO_LABELS
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|no_overrun
operator|=
operator|(
operator|(
name|options
operator|&
name|DPV_NO_OVERRUN
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|output
operator|=
name|config
operator|->
name|output
expr_stmt|;
name|output_type
operator|=
name|config
operator|->
name|output_type
expr_stmt|;
name|pbar_size
operator|=
name|config
operator|->
name|pbar_size
expr_stmt|;
name|status_updates_per_second
operator|=
name|config
operator|->
name|status_updates_per_second
expr_stmt|;
name|title
operator|=
name|config
operator|->
name|title
expr_stmt|;
name|wide
operator|=
operator|(
operator|(
name|options
operator|&
name|DPV_WIDE_MODE
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
comment|/* Enforce some minimums (pedantic) */
if|if
condition|(
name|display_limit
operator|<
operator|-
literal|1
condition|)
name|display_limit
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|label_size
operator|<
operator|-
literal|1
condition|)
name|label_size
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|pbar_size
operator|<
operator|-
literal|1
condition|)
name|pbar_size
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* For the mini-pbar, -1 means hide, zero is invalid unless 		 * only one file is given */
if|if
condition|(
name|pbar_size
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|file_list
operator|==
name|NULL
operator|||
name|file_list
operator|->
name|next
operator|==
name|NULL
condition|)
name|pbar_size
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|pbar_size
operator|=
name|PBAR_SIZE_DEFAULT
expr_stmt|;
block|}
comment|/* For the label, -1 means auto-size, zero is invalid unless 		 * specifically requested through the use of options flag */
if|if
condition|(
name|label_size
operator|==
literal|0
operator|&&
name|no_labels
operator|==
name|FALSE
condition|)
name|label_size
operator|=
name|LABEL_SIZE_DEFAULT
expr_stmt|;
comment|/* Status update should not be zero */
if|if
condition|(
name|status_updates_per_second
operator|==
literal|0
condition|)
name|status_updates_per_second
operator|=
name|STATUS_UPDATES_PER_SEC
expr_stmt|;
block|}
comment|/* config != NULL */
comment|/* Process the type of display we've been requested to produce */
switch|switch
condition|(
name|display_type
condition|)
block|{
case|case
name|DPV_DISPLAY_STDOUT
case|:
name|debug
operator|=
name|TRUE
expr_stmt|;
name|use_color
operator|=
name|FALSE
expr_stmt|;
name|use_dialog
operator|=
name|FALSE
expr_stmt|;
name|use_libdialog
operator|=
name|FALSE
expr_stmt|;
name|use_xdialog
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
name|DPV_DISPLAY_DIALOG
case|:
name|use_color
operator|=
name|TRUE
expr_stmt|;
name|use_dialog
operator|=
name|TRUE
expr_stmt|;
name|use_libdialog
operator|=
name|FALSE
expr_stmt|;
name|use_xdialog
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
name|DPV_DISPLAY_XDIALOG
case|:
name|snprintf
argument_list|(
name|dialog
argument_list|,
name|PATH_MAX
argument_list|,
name|XDIALOG
argument_list|)
expr_stmt|;
name|use_color
operator|=
name|FALSE
expr_stmt|;
name|use_dialog
operator|=
name|FALSE
expr_stmt|;
name|use_libdialog
operator|=
name|FALSE
expr_stmt|;
name|use_xdialog
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|use_color
operator|=
name|TRUE
expr_stmt|;
name|use_dialog
operator|=
name|FALSE
expr_stmt|;
name|use_libdialog
operator|=
name|TRUE
expr_stmt|;
name|use_xdialog
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
comment|/* display_type */
comment|/* Enforce additional minimums that require knowing our display type */
if|if
condition|(
name|dialog_updates_per_second
operator|==
literal|0
condition|)
name|dialog_updates_per_second
operator|=
name|use_xdialog
condition|?
name|XDIALOG_UPDATES_PER_SEC
else|:
name|DIALOG_UPDATES_PER_SEC
expr_stmt|;
comment|/* Allow forceful override of use_color */
if|if
condition|(
name|config
operator|!=
name|NULL
operator|&&
operator|(
name|config
operator|->
name|options
operator|&
name|DPV_USE_COLOR
operator|)
operator|!=
literal|0
condition|)
name|use_color
operator|=
name|TRUE
expr_stmt|;
comment|/* Count the number of files in provided list of dpv_file_node's */
if|if
condition|(
name|use_dialog
operator|&&
name|pprompt
operator|!=
name|NULL
operator|&&
operator|*
name|pprompt
operator|!=
literal|'\0'
condition|)
name|pprompt_nls
operator|=
name|dialog_prompt_nlstate
argument_list|(
name|pprompt
argument_list|)
expr_stmt|;
name|max_cols
operator|=
name|dialog_maxcols
argument_list|()
expr_stmt|;
if|if
condition|(
name|label_size
operator|==
operator|-
literal|1
condition|)
name|shrink_label_size
operator|=
name|TRUE
expr_stmt|;
comment|/* Process file arguments */
for|for
control|(
name|curfile
operator|=
name|file_list
init|;
name|curfile
operator|!=
name|NULL
condition|;
name|curfile
operator|=
name|curfile
operator|->
name|next
control|)
block|{
name|dpv_nfiles
operator|++
expr_stmt|;
comment|/* dialog(3) only expands literal newlines */
if|if
condition|(
name|use_libdialog
condition|)
name|strexpandnl
argument_list|(
name|curfile
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* Optionally calculate label size for file */
if|if
condition|(
name|shrink_label_size
condition|)
block|{
name|nls
operator|=
name|FALSE
expr_stmt|;
name|name
operator|=
name|curfile
operator|->
name|name
expr_stmt|;
if|if
condition|(
name|curfile
operator|==
name|file_list
condition|)
name|nls
operator|=
name|pprompt_nls
expr_stmt|;
name|last
operator|=
operator|(
name|char
operator|*
operator|)
name|dialog_prompt_lastline
argument_list|(
name|name
argument_list|,
name|nls
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_dialog
condition|)
block|{
name|c
operator|=
operator|*
name|last
expr_stmt|;
operator|*
name|last
operator|=
literal|'\0'
expr_stmt|;
name|nls
operator|=
name|dialog_prompt_nlstate
argument_list|(
name|name
argument_list|)
expr_stmt|;
operator|*
name|last
operator|=
name|c
expr_stmt|;
block|}
name|len
operator|=
name|dialog_prompt_longestline
argument_list|(
name|last
argument_list|,
name|nls
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|len
operator|>
operator|(
name|label_size
operator|-
literal|3
operator|)
condition|)
block|{
if|if
condition|(
name|label_size
operator|>
literal|0
condition|)
name|label_size
operator|+=
literal|3
expr_stmt|;
name|label_size
operator|=
name|len
expr_stmt|;
comment|/* Room for ellipsis (unless NULL) */
if|if
condition|(
name|label_size
operator|>
literal|0
condition|)
name|label_size
operator|+=
literal|3
expr_stmt|;
block|}
if|if
condition|(
name|max_cols
operator|>
literal|0
operator|&&
name|label_size
operator|>
operator|(
name|max_cols
operator|-
name|pbar_size
operator|-
literal|9
operator|)
condition|)
name|label_size
operator|=
name|max_cols
operator|-
name|pbar_size
operator|-
literal|9
expr_stmt|;
block|}
if|if
condition|(
name|debug
condition|)
name|warnx
argument_list|(
literal|"label=[%s] path=[%s] size=%lli"
argument_list|,
name|curfile
operator|->
name|name
argument_list|,
name|curfile
operator|->
name|path
argument_list|,
name|curfile
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
comment|/* file_list */
comment|/* Optionally process the contents of DIALOGRC (~/.dialogrc) */
if|if
condition|(
name|use_dialog
condition|)
block|{
name|res
operator|=
name|parse_dialogrc
argument_list|()
expr_stmt|;
if|if
condition|(
name|debug
operator|&&
name|res
operator|==
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"Successfully read `%s' config file"
argument_list|,
name|DIALOGRC
argument_list|)
expr_stmt|;
name|warnx
argument_list|(
literal|"use_shadow = %i (Boolean)"
argument_list|,
name|use_shadow
argument_list|)
expr_stmt|;
name|warnx
argument_list|(
literal|"use_colors = %i (Boolean)"
argument_list|,
name|use_colors
argument_list|)
expr_stmt|;
name|warnx
argument_list|(
literal|"gauge_color=[%s] (FBH)"
argument_list|,
name|gauge_color
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|use_libdialog
condition|)
block|{
name|init_dialog
argument_list|(
name|stdin
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|use_shadow
operator|=
name|dialog_state
operator|.
name|use_shadow
expr_stmt|;
name|use_colors
operator|=
name|dialog_state
operator|.
name|use_colors
expr_stmt|;
name|gauge_color
index|[
literal|0
index|]
operator|=
literal|48
operator|+
name|dlg_color_table
index|[
name|GAUGE_ATTR
index|]
operator|.
name|fg
expr_stmt|;
name|gauge_color
index|[
literal|1
index|]
operator|=
literal|48
operator|+
name|dlg_color_table
index|[
name|GAUGE_ATTR
index|]
operator|.
name|bg
expr_stmt|;
name|gauge_color
index|[
literal|2
index|]
operator|=
name|dlg_color_table
index|[
name|GAUGE_ATTR
index|]
operator|.
name|hilite
condition|?
literal|'b'
else|:
literal|'B'
expr_stmt|;
name|gauge_color
index|[
literal|3
index|]
operator|=
literal|'\0'
expr_stmt|;
name|end_dialog
argument_list|()
expr_stmt|;
if|if
condition|(
name|debug
condition|)
block|{
name|warnx
argument_list|(
literal|"Finished initializing dialog(3) library"
argument_list|)
expr_stmt|;
name|warnx
argument_list|(
literal|"use_shadow = %i (Boolean)"
argument_list|,
name|use_shadow
argument_list|)
expr_stmt|;
name|warnx
argument_list|(
literal|"use_colors = %i (Boolean)"
argument_list|,
name|use_colors
argument_list|)
expr_stmt|;
name|warnx
argument_list|(
literal|"gauge_color=[%s] (FBH)"
argument_list|,
name|gauge_color
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Enable mini progress bar automatically for stdin streams if unable 	 * to calculate progress (missing `lines:' syntax). */
if|if
condition|(
name|dpv_nfiles
operator|<=
literal|1
operator|&&
name|file_list
operator|!=
name|NULL
operator|&&
name|file_list
operator|->
name|length
operator|<
literal|0
operator|&&
operator|!
name|dialog_test
condition|)
name|pbar_size
operator|=
name|PBAR_SIZE_DEFAULT
expr_stmt|;
comment|/* If $USE_COLOR is set and non-NULL enable color; otherwise disable */
if|if
condition|(
operator|(
name|cp
operator|=
name|getenv
argument_list|(
name|ENV_USE_COLOR
argument_list|)
operator|)
operator|!=
literal|0
condition|)
name|use_color
operator|=
operator|*
name|cp
operator|!=
literal|'\0'
condition|?
literal|1
else|:
literal|0
expr_stmt|;
comment|/* Print error and return `-1' if not given at least one name */
if|if
condition|(
name|dpv_nfiles
operator|==
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: no labels provided"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|debug
condition|)
name|warnx
argument_list|(
literal|"%s: %u label%s provided"
argument_list|,
name|__func__
argument_list|,
name|dpv_nfiles
argument_list|,
name|dpv_nfiles
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
comment|/* If only one file and pbar size is zero, default to `-1' */
if|if
condition|(
name|dpv_nfiles
operator|<=
literal|1
operator|&&
name|pbar_size
operator|==
literal|0
condition|)
name|pbar_size
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Print some debugging information */
if|if
condition|(
name|debug
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: %s(%i) max rows x cols = %i x %i"
argument_list|,
name|__func__
argument_list|,
name|use_xdialog
condition|?
name|XDIALOG
else|:
name|DIALOG
argument_list|,
name|use_libdialog
condition|?
literal|3
else|:
literal|1
argument_list|,
name|dialog_maxrows
argument_list|()
argument_list|,
name|dialog_maxcols
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/* Xdialog(1) updates a lot slower than dialog(1) */
if|if
condition|(
name|dialog_test
operator|&&
name|use_xdialog
condition|)
name|increment
operator|=
name|XDIALOG_INCREMENT
expr_stmt|;
comment|/* Always add implicit newline to pprompt (when specified) */
if|if
condition|(
name|pprompt
operator|!=
name|NULL
operator|&&
operator|*
name|pprompt
operator|!=
literal|'\0'
condition|)
block|{
name|len
operator|=
name|strlen
argument_list|(
name|pprompt
argument_list|)
expr_stmt|;
comment|/* 		 * NOTE: pprompt = malloc(PPROMPT_MAX + 2) 		 * NOTE: (see getopt(2) section above for pprompt allocation) 		 */
name|pprompt
index|[
name|len
operator|++
index|]
operator|=
literal|'\\'
expr_stmt|;
name|pprompt
index|[
name|len
operator|++
index|]
operator|=
literal|'n'
expr_stmt|;
name|pprompt
index|[
name|len
operator|++
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
comment|/* Xdialog(1) requires newlines (a) escaped and (b) in triplicate */
if|if
condition|(
name|use_xdialog
operator|&&
name|pprompt
operator|!=
name|NULL
condition|)
block|{
comment|/* Replace `\n' with `\n\\n\n' in pprompt */
name|len
operator|=
name|strlen
argument_list|(
name|pprompt
argument_list|)
expr_stmt|;
name|len
operator|+=
name|strcount
argument_list|(
name|pprompt
argument_list|,
literal|"\\n"
argument_list|)
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|DPV_PPROMPT_MAX
condition|)
name|errx
argument_list|(
name|EXIT_FAILURE
argument_list|,
literal|"%s: Oops, pprompt buffer overflow "
literal|"(%zu> %i)"
argument_list|,
name|__func__
argument_list|,
name|len
argument_list|,
name|DPV_PPROMPT_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|replaceall
argument_list|(
name|pprompt
argument_list|,
literal|"\\n"
argument_list|,
literal|"\n\\n\n"
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
name|EXIT_FAILURE
argument_list|,
literal|"%s: replaceall()"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
comment|/* libdialog requires literal newlines */
elseif|else
if|if
condition|(
name|use_libdialog
operator|&&
name|pprompt
operator|!=
name|NULL
condition|)
name|strexpandnl
argument_list|(
name|pprompt
argument_list|)
expr_stmt|;
comment|/* Xdialog(1) requires newlines (a) escaped and (b) in triplicate */
if|if
condition|(
name|use_xdialog
operator|&&
name|aprompt
operator|!=
name|NULL
condition|)
block|{
comment|/* Replace `\n' with `\n\\n\n' in aprompt */
name|len
operator|=
name|strlen
argument_list|(
name|aprompt
argument_list|)
expr_stmt|;
name|len
operator|+=
name|strcount
argument_list|(
name|aprompt
argument_list|,
literal|"\\n"
argument_list|)
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|DPV_APROMPT_MAX
condition|)
name|errx
argument_list|(
name|EXIT_FAILURE
argument_list|,
literal|"%s: Oops, aprompt buffer overflow "
literal|" (%zu> %i)"
argument_list|,
name|__func__
argument_list|,
name|len
argument_list|,
name|DPV_APROMPT_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|replaceall
argument_list|(
name|aprompt
argument_list|,
literal|"\\n"
argument_list|,
literal|"\n\\n\n"
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
name|EXIT_FAILURE
argument_list|,
literal|"%s: replaceall()"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
comment|/* libdialog requires literal newlines */
elseif|else
if|if
condition|(
name|use_libdialog
operator|&&
name|aprompt
operator|!=
name|NULL
condition|)
name|strexpandnl
argument_list|(
name|aprompt
argument_list|)
expr_stmt|;
comment|/* 	 * Warn user about an obscure dialog(1) bug (neither Xdialog(1) nor 	 * libdialog are affected) in the `--gauge' widget. If the first non- 	 * whitespace letter of "{new_prompt}" in "XXX\n{new_prompt}\nXXX\n" 	 * is a number, the number can sometimes be mistaken for a percentage 	 * to the overall progressbar. Other nasty side-effects such as the 	 * entire prompt not displaying or displaying improperly are caused by 	 * this bug too. 	 * 	 * NOTE: When we can use color, we have a work-around... prefix the 	 * output with `\Zn' (used to terminate ANSI and reset to normal). 	 */
if|if
condition|(
name|use_dialog
operator|&&
operator|!
name|use_color
condition|)
block|{
name|backslash
operator|=
literal|0
expr_stmt|;
comment|/* First, check pprompt (falls through if NULL) */
name|fc
operator|=
name|pprompt
expr_stmt|;
while|while
condition|(
name|fc
operator|!=
name|NULL
operator|&&
operator|*
name|fc
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|fc
operator|==
literal|'\n'
condition|)
comment|/* leading literal newline OK */
break|break;
if|if
condition|(
operator|!
name|isspace
argument_list|(
operator|*
name|fc
argument_list|)
operator|&&
operator|*
name|fc
operator|!=
literal|'\\'
operator|&&
name|backslash
operator|==
literal|0
condition|)
break|break;
elseif|else
if|if
condition|(
name|backslash
operator|>
literal|0
operator|&&
operator|*
name|fc
operator|!=
literal|'n'
condition|)
break|break;
elseif|else
if|if
condition|(
operator|*
name|fc
operator|==
literal|'\\'
condition|)
block|{
name|backslash
operator|++
expr_stmt|;
if|if
condition|(
name|backslash
operator|>
literal|2
condition|)
break|break;
comment|/* we're safe */
block|}
name|fc
operator|++
expr_stmt|;
block|}
comment|/* First non-whitespace character that dialog(1) will see */
if|if
condition|(
name|fc
operator|!=
name|NULL
operator|&&
operator|*
name|fc
operator|>=
literal|'0'
operator|&&
operator|*
name|fc
operator|<=
literal|'9'
condition|)
name|warnx
argument_list|(
literal|"%s: WARNING! text argument to `-p' begins with "
literal|"a number (not recommended)"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fc
operator|>
name|pprompt
condition|)
name|warnx
argument_list|(
literal|"%s: WARNING! text argument to `-p' begins with "
literal|"whitespace (not recommended)"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* 		 * If no pprompt or pprompt is all whitespace, check the first 		 * file name provided to make sure it is alright too. 		 */
if|if
condition|(
operator|(
name|pprompt
operator|==
name|NULL
operator|||
operator|*
name|fc
operator|==
literal|'\0'
operator|)
operator|&&
name|file_list
operator|!=
name|NULL
condition|)
block|{
name|first_file
operator|=
name|file_list
expr_stmt|;
name|fc
operator|=
name|first_file
operator|->
name|name
expr_stmt|;
while|while
condition|(
name|fc
operator|!=
name|NULL
operator|&&
operator|*
name|fc
operator|!=
literal|'\0'
operator|&&
name|isspace
argument_list|(
operator|*
name|fc
argument_list|)
condition|)
name|fc
operator|++
expr_stmt|;
comment|/* First non-whitespace char that dialog(1) will see */
if|if
condition|(
name|fc
operator|!=
name|NULL
operator|&&
operator|*
name|fc
operator|>=
literal|'0'
operator|&&
operator|*
name|fc
operator|<=
literal|'9'
condition|)
name|warnx
argument_list|(
literal|"%s: WARNING! File name `%s' begins "
literal|"with a number (use `-p text' for safety)"
argument_list|,
name|__func__
argument_list|,
name|first_file
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
block|}
name|dprompt_init
argument_list|(
name|file_list
argument_list|)
expr_stmt|;
comment|/* Reads: label_size pbar_size pprompt aprompt dpv_nfiles */
comment|/* Inits: dheight and dwidth */
if|if
condition|(
operator|!
name|debug
condition|)
block|{
comment|/* Internally create the initial `--gauge' prompt text */
name|dprompt_recreate
argument_list|(
name|file_list
argument_list|,
operator|(
expr|struct
name|dpv_file_node
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Spawn [X]dialog(1) `--gauge', returning pipe descriptor */
if|if
condition|(
name|use_libdialog
condition|)
block|{
name|status_printf
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|dprompt_libprint
argument_list|(
name|pprompt
argument_list|,
name|aprompt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dprompt_sprint
argument_list|(
name|init_prompt
argument_list|,
name|pprompt
argument_list|,
name|aprompt
argument_list|)
expr_stmt|;
name|dialog_out
operator|=
name|dialog_spawn_gauge
argument_list|(
name|init_prompt
argument_list|,
operator|&
name|pid
argument_list|)
expr_stmt|;
name|dprompt_dprint
argument_list|(
name|dialog_out
argument_list|,
name|pprompt
argument_list|,
name|aprompt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* !debug */
comment|/* Seed the random(3) generator */
if|if
condition|(
name|dialog_test
condition|)
name|srandom
argument_list|(
literal|0xf1eeface
argument_list|)
expr_stmt|;
comment|/* Set default/custom status line format */
if|if
condition|(
name|dpv_nfiles
operator|>
literal|1
condition|)
block|{
name|snprintf
argument_list|(
name|status_format_default
argument_list|,
name|DPV_STATUS_FORMAT_MAX
argument_list|,
literal|"%s"
argument_list|,
name|DPV_STATUS_MANY
argument_list|)
expr_stmt|;
name|status_format_custom
operator|=
name|config
operator|->
name|status_many
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|status_format_default
argument_list|,
name|DPV_STATUS_FORMAT_MAX
argument_list|,
literal|"%s"
argument_list|,
name|DPV_STATUS_SOLO
argument_list|)
expr_stmt|;
name|status_format_custom
operator|=
name|config
operator|->
name|status_solo
expr_stmt|;
block|}
comment|/* Add test mode identifier to default status line if enabled */
if|if
condition|(
name|dialog_test
operator|&&
operator|(
name|strlen
argument_list|(
name|status_format_default
argument_list|)
operator|+
literal|12
operator|)
operator|<
name|DPV_STATUS_FORMAT_MAX
condition|)
name|strcat
argument_list|(
name|status_format_default
argument_list|,
literal|" [TEST MODE]"
argument_list|)
expr_stmt|;
comment|/* Verify custom status format */
name|status_fmt
operator|=
name|fmtcheck
argument_list|(
name|status_format_custom
argument_list|,
name|status_format_default
argument_list|)
expr_stmt|;
if|if
condition|(
name|status_format_custom
operator|!=
name|NULL
operator|&&
name|status_fmt
operator|==
name|status_format_default
condition|)
block|{
name|warnx
argument_list|(
literal|"WARNING! Invalid status_format configuration `%s'"
argument_list|,
name|status_format_custom
argument_list|)
expr_stmt|;
name|warnx
argument_list|(
literal|"Default status_format `%s'"
argument_list|,
name|status_format_default
argument_list|)
expr_stmt|;
block|}
comment|/* Record when we started (used to prevent updating too quickly) */
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|start
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
comment|/* Calculate number of microseconds in-between sub-second updates */
if|if
condition|(
name|status_updates_per_second
operator|!=
literal|0
condition|)
name|status_update_usec
operator|=
literal|1000000
operator|/
name|status_updates_per_second
expr_stmt|;
if|if
condition|(
name|dialog_updates_per_second
operator|!=
literal|0
condition|)
name|dialog_update_usec
operator|=
literal|1000000
operator|/
name|dialog_updates_per_second
expr_stmt|;
comment|/* 	 * Process the file list [serially] (one for each argument passed) 	 */
name|files_left
operator|=
name|dpv_nfiles
expr_stmt|;
name|list_head
operator|=
name|file_list
expr_stmt|;
for|for
control|(
name|curfile
operator|=
name|file_list
init|;
name|curfile
operator|!=
name|NULL
condition|;
name|curfile
operator|=
name|curfile
operator|->
name|next
control|)
block|{
name|keep_going
operator|=
name|TRUE
expr_stmt|;
name|output_out
operator|=
operator|-
literal|1
expr_stmt|;
name|pct
operator|=
literal|0
expr_stmt|;
name|nthfile
operator|++
expr_stmt|;
name|files_left
operator|--
expr_stmt|;
if|if
condition|(
name|dpv_interrupt
condition|)
break|break;
if|if
condition|(
name|dialog_test
condition|)
name|pct
operator|=
literal|0
operator|-
name|increment
expr_stmt|;
comment|/* Attempt to spawn output program for this file */
if|if
condition|(
operator|!
name|dialog_test
operator|&&
name|output
operator|!=
name|NULL
condition|)
block|{
name|mask
operator|=
name|umask
argument_list|(
literal|0022
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|umask
argument_list|(
name|mask
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|output_type
condition|)
block|{
case|case
name|DPV_OUTPUT_SHELL
case|:
name|output_out
operator|=
name|shell_spawn_pipecmd
argument_list|(
name|output
argument_list|,
name|curfile
operator|->
name|name
argument_list|,
operator|&
name|output_pid
argument_list|)
expr_stmt|;
break|break;
case|case
name|DPV_OUTPUT_FILE
case|:
name|path_fmt
operator|=
name|fmtcheck
argument_list|(
name|output
argument_list|,
literal|"%s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|path_fmt
operator|==
name|output
condition|)
name|len
operator|=
name|snprintf
argument_list|(
name|pathbuf
argument_list|,
name|PATH_MAX
argument_list|,
name|output
argument_list|,
name|curfile
operator|->
name|name
argument_list|)
expr_stmt|;
else|else
name|len
operator|=
name|snprintf
argument_list|(
name|pathbuf
argument_list|,
name|PATH_MAX
argument_list|,
literal|"%s"
argument_list|,
name|output
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|PATH_MAX
condition|)
block|{
name|warnx
argument_list|(
literal|"%s:%d:%s: pathbuf[%u] too small"
literal|"to hold output argument"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
name|__func__
argument_list|,
name|PATH_MAX
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|output_out
operator|=
name|open
argument_list|(
name|pathbuf
argument_list|,
name|O_CREAT
operator||
name|O_WRONLY
argument_list|,
name|DEFFILEMODE
operator|&
operator|~
name|mask
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|pathbuf
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
break|break;
default|default:
break|break;
block|}
block|}
while|while
condition|(
operator|!
name|dpv_interrupt
operator|&&
name|keep_going
condition|)
block|{
if|if
condition|(
name|dialog_test
condition|)
block|{
name|usleep
argument_list|(
literal|50000
argument_list|)
expr_stmt|;
name|pct
operator|+=
name|increment
expr_stmt|;
name|dpv_overall_read
operator|+=
call|(
name|int
call|)
argument_list|(
name|random
argument_list|()
operator|/
literal|512
operator|/
name|dpv_nfiles
argument_list|)
expr_stmt|;
comment|/* 512 limits fake readout to Megabytes */
block|}
elseif|else
if|if
condition|(
name|action
operator|!=
name|NULL
condition|)
name|pct
operator|=
name|action
argument_list|(
name|curfile
argument_list|,
name|output_out
argument_list|)
expr_stmt|;
if|if
condition|(
name|no_overrun
operator|||
name|dialog_test
condition|)
name|keep_going
operator|=
operator|(
name|pct
operator|<
literal|100
operator|)
expr_stmt|;
else|else
block|{
name|status
operator|=
name|curfile
operator|->
name|status
expr_stmt|;
name|keep_going
operator|=
operator|(
name|status
operator|==
name|DPV_STATUS_RUNNING
operator|)
expr_stmt|;
block|}
comment|/* Get current time and calculate seconds elapsed */
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|now
operator|.
name|tv_sec
operator|=
name|now
operator|.
name|tv_sec
operator|-
name|start
operator|.
name|tv_sec
expr_stmt|;
name|now
operator|.
name|tv_usec
operator|=
name|now
operator|.
name|tv_usec
operator|-
name|start
operator|.
name|tv_usec
expr_stmt|;
if|if
condition|(
name|now
operator|.
name|tv_usec
operator|<
literal|0
condition|)
name|now
operator|.
name|tv_sec
operator|--
operator|,
name|now
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
name|seconds
operator|=
name|now
operator|.
name|tv_sec
operator|+
operator|(
name|now
operator|.
name|tv_usec
operator|/
literal|1000000.0
operator|)
expr_stmt|;
comment|/* Update dialog (be it dialog(3), dialog(1), etc.) */
if|if
condition|(
operator|(
name|dialog_updates_per_second
operator|!=
literal|0
operator|&&
operator|(
name|seconds
operator|!=
name|dialog_old_seconds
operator|||
name|now
operator|.
name|tv_usec
operator|-
name|dialog_last_update
operator|>=
name|dialog_update_usec
operator|||
name|nthfile
operator|!=
name|dialog_old_nthfile
operator|)
operator|)
operator|||
name|pct
operator|==
literal|100
condition|)
block|{
comment|/* Calculate overall progress (rounding up) */
name|overall
operator|=
operator|(
literal|100
operator|*
name|nthfile
operator|-
literal|100
operator|+
name|pct
operator|)
operator|/
name|dpv_nfiles
expr_stmt|;
if|if
condition|(
operator|(
operator|(
literal|100
operator|*
name|nthfile
operator|-
literal|100
operator|+
name|pct
operator|)
operator|*
literal|10
operator|/
name|dpv_nfiles
operator|%
literal|100
operator|)
operator|>
literal|50
condition|)
name|overall
operator|++
expr_stmt|;
name|dprompt_recreate
argument_list|(
name|list_head
argument_list|,
name|curfile
argument_list|,
name|pct
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_libdialog
operator|&&
operator|!
name|debug
condition|)
block|{
comment|/* Update dialog(3) widget */
name|dprompt_libprint
argument_list|(
name|pprompt
argument_list|,
name|aprompt
argument_list|,
name|overall
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* stdout, dialog(1), or Xdialog(1) */
name|dprompt_dprint
argument_list|(
name|dialog_out
argument_list|,
name|pprompt
argument_list|,
name|aprompt
argument_list|,
name|overall
argument_list|)
expr_stmt|;
name|fsync
argument_list|(
name|dialog_out
argument_list|)
expr_stmt|;
block|}
name|dialog_old_seconds
operator|=
name|seconds
expr_stmt|;
name|dialog_old_nthfile
operator|=
name|nthfile
expr_stmt|;
name|dialog_last_update
operator|=
name|now
operator|.
name|tv_usec
expr_stmt|;
block|}
comment|/* Update the status line */
if|if
condition|(
operator|(
name|use_libdialog
operator|&&
operator|!
name|debug
operator|)
operator|&&
name|status_updates_per_second
operator|!=
literal|0
operator|&&
operator|(
name|keep_going
operator|!=
name|TRUE
operator|||
name|seconds
operator|!=
name|status_old_seconds
operator|||
name|now
operator|.
name|tv_usec
operator|-
name|status_last_update
operator|>=
name|status_update_usec
operator|||
name|nthfile
operator|!=
name|status_old_nthfile
operator|)
condition|)
block|{
name|status_printf
argument_list|(
name|status_fmt
argument_list|,
name|dpv_overall_read
argument_list|,
operator|(
name|dpv_overall_read
operator|/
operator|(
name|seconds
operator|==
literal|0
condition|?
literal|1
else|:
name|seconds
operator|)
operator|*
literal|1.0
operator|)
argument_list|,
literal|1
argument_list|,
comment|/* XXX until we add parallelism XXX */
name|files_left
argument_list|)
expr_stmt|;
name|status_old_seconds
operator|=
name|seconds
expr_stmt|;
name|status_old_nthfile
operator|=
name|nthfile
expr_stmt|;
name|status_last_update
operator|=
name|now
operator|.
name|tv_usec
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|dialog_test
operator|&&
name|output_out
operator|>=
literal|0
condition|)
block|{
name|close
argument_list|(
name|output_out
argument_list|)
expr_stmt|;
name|waitpid
argument_list|(
name|output_pid
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dpv_abort
condition|)
break|break;
comment|/* Advance head of list when we hit the max display lines */
if|if
condition|(
name|display_limit
operator|>
literal|0
operator|&&
name|nthfile
operator|%
name|display_limit
operator|==
literal|0
condition|)
name|list_head
operator|=
name|curfile
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|debug
condition|)
block|{
if|if
condition|(
name|use_libdialog
condition|)
name|end_dialog
argument_list|()
expr_stmt|;
else|else
block|{
name|close
argument_list|(
name|dialog_out
argument_list|)
expr_stmt|;
name|waitpid
argument_list|(
name|pid
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dpv_interrupt
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|warnx
argument_list|(
literal|"%s: %lli lines read"
argument_list|,
name|__func__
argument_list|,
name|dpv_overall_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|dpv_interrupt
operator|||
name|dpv_abort
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Free allocated items initialized by dpv()  */
end_comment

begin_function
name|void
name|dpv_free
parameter_list|(
name|void
parameter_list|)
block|{
name|dialogrc_free
argument_list|()
expr_stmt|;
name|dprompt_free
argument_list|()
expr_stmt|;
name|dialog_maxsize_free
argument_list|()
expr_stmt|;
if|if
condition|(
name|aprompt
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|aprompt
argument_list|)
expr_stmt|;
name|aprompt
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|pprompt
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|pprompt
argument_list|)
expr_stmt|;
name|pprompt
operator|=
name|NULL
expr_stmt|;
block|}
name|status_free
argument_list|()
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013-2014 Devin Teske<dteske@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *   * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_define
define|#
directive|define
name|_BSD_SOURCE
end_define

begin_comment
comment|/* to get dprintf() prototype in stdio.h below */
end_comment

begin_include
include|#
directive|include
file|<dialog.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<libutil.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<string_m.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"dialog_util.h"
end_include

begin_include
include|#
directive|include
file|"dialogrc.h"
end_include

begin_include
include|#
directive|include
file|"dprompt.h"
end_include

begin_include
include|#
directive|include
file|"dpv.h"
end_include

begin_include
include|#
directive|include
file|"dpv_private.h"
end_include

begin_define
define|#
directive|define
name|FLABEL_MAX
value|1024
end_define

begin_decl_stmt
specifier|static
name|int
name|fheight
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* initialized by dprompt_init() */
end_comment

begin_decl_stmt
specifier|static
name|char
name|dprompt
index|[
name|PROMPT_MAX
operator|+
literal|1
index|]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dprompt_pos
init|=
operator|(
name|char
operator|*
operator|)
operator|(
literal|0
operator|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* treated numerically */
end_comment

begin_comment
comment|/* Display characteristics */
end_comment

begin_define
define|#
directive|define
name|FM_DONE
value|0x01
end_define

begin_define
define|#
directive|define
name|FM_FAIL
value|0x02
end_define

begin_define
define|#
directive|define
name|FM_PEND
value|0x04
end_define

begin_decl_stmt
specifier|static
name|uint8_t
name|dprompt_free_mask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|done
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|fail
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|pend
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|display_limit
init|=
name|DISPLAY_LIMIT_DEFAULT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Max entries to show */
end_comment

begin_decl_stmt
name|int
name|label_size
init|=
name|LABEL_SIZE_DEFAULT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Max width for labels */
end_comment

begin_decl_stmt
name|int
name|pbar_size
init|=
name|PBAR_SIZE_DEFAULT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Mini-progressbar size */
end_comment

begin_decl_stmt
specifier|static
name|int
name|gauge_percent
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|done_size
decl_stmt|,
name|done_lsize
decl_stmt|,
name|done_rsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|fail_size
decl_stmt|,
name|fail_lsize
decl_stmt|,
name|fail_rsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|mesg_size
decl_stmt|,
name|mesg_lsize
decl_stmt|,
name|mesg_rsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pend_size
decl_stmt|,
name|pend_lsize
decl_stmt|,
name|pend_rsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pct_lsize
decl_stmt|,
name|pct_rsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
modifier|*
name|gauge
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SPIN_SIZE
value|4
end_define

begin_decl_stmt
specifier|static
name|char
name|spin
index|[
name|SPIN_SIZE
operator|+
literal|1
index|]
init|=
literal|"/-\\|"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|msg
index|[
name|PROMPT_MAX
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|spin_cp
init|=
name|spin
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Function prototypes */
end_comment

begin_function_decl
specifier|static
name|char
name|spin_char
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|dprompt_add_files
parameter_list|(
name|struct
name|dpv_file_node
modifier|*
name|file_list
parameter_list|,
name|struct
name|dpv_file_node
modifier|*
name|curfile
parameter_list|,
name|int
name|pct
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Returns a pointer to the current spin character in the spin string and  * advances the global position to the next character for the next call.  */
end_comment

begin_function
specifier|static
name|char
name|spin_char
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|ch
decl_stmt|;
if|if
condition|(
name|spin_cp
operator|==
literal|'\0'
condition|)
name|spin_cp
operator|=
name|spin
expr_stmt|;
name|ch
operator|=
operator|*
name|spin_cp
expr_stmt|;
comment|/* Advance the spinner to the next char */
if|if
condition|(
operator|++
name|spin_cp
operator|>=
operator|(
name|spin
operator|+
name|SPIN_SIZE
operator|)
condition|)
name|spin_cp
operator|=
name|spin
expr_stmt|;
return|return
operator|(
name|ch
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Initialize heights and widths based on various strings and environment  * variables (such as ENV_USE_COLOR).  */
end_comment

begin_function
name|void
name|dprompt_init
parameter_list|(
name|struct
name|dpv_file_node
modifier|*
name|file_list
parameter_list|)
block|{
name|uint8_t
name|nls
init|=
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|max_cols
decl_stmt|;
name|int
name|max_rows
decl_stmt|;
name|int
name|nthfile
decl_stmt|;
name|int
name|numlines
decl_stmt|;
name|struct
name|dpv_file_node
modifier|*
name|curfile
decl_stmt|;
comment|/* 	 * Initialize dialog(3) `colors' support and draw backtitle 	 */
if|if
condition|(
name|use_libdialog
operator|&&
operator|!
name|debug
condition|)
block|{
name|init_dialog
argument_list|(
name|stdin
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|dialog_vars
operator|.
name|colors
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|backtitle
operator|!=
name|NULL
condition|)
block|{
name|dialog_vars
operator|.
name|backtitle
operator|=
operator|(
name|char
operator|*
operator|)
name|backtitle
expr_stmt|;
name|dlg_put_backtitle
argument_list|()
expr_stmt|;
block|}
block|}
comment|/* Calculate width of dialog(3) or [X]dialog(1) --gauge box */
name|dwidth
operator|=
name|label_size
operator|+
name|pbar_size
operator|+
literal|9
expr_stmt|;
comment|/* 	 * Calculate height of dialog(3) or [X]dialog(1) --gauge box 	 */
name|dheight
operator|=
literal|5
expr_stmt|;
name|max_rows
operator|=
name|dialog_maxrows
argument_list|()
expr_stmt|;
comment|/* adjust max_rows for backtitle and/or dialog(3) statusLine */
if|if
condition|(
name|backtitle
operator|!=
name|NULL
condition|)
name|max_rows
operator|-=
name|use_shadow
condition|?
literal|3
else|:
literal|2
expr_stmt|;
if|if
condition|(
name|use_libdialog
operator|&&
name|use_shadow
condition|)
name|max_rows
operator|-=
literal|2
expr_stmt|;
comment|/* add lines for `-p text' */
name|numlines
operator|=
name|dialog_prompt_numlines
argument_list|(
name|pprompt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|warnx
argument_list|(
literal|"`-p text' is %i line%s long"
argument_list|,
name|numlines
argument_list|,
name|numlines
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
name|dheight
operator|+=
name|numlines
expr_stmt|;
comment|/* adjust dheight for various implementations */
if|if
condition|(
name|use_dialog
condition|)
block|{
name|dheight
operator|-=
name|dialog_prompt_nlstate
argument_list|(
name|pprompt
argument_list|)
expr_stmt|;
name|nls
operator|=
name|dialog_prompt_nlstate
argument_list|(
name|pprompt
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|use_xdialog
condition|)
block|{
if|if
condition|(
name|pprompt
operator|==
name|NULL
operator|||
operator|*
name|pprompt
operator|==
literal|'\0'
condition|)
name|dheight
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|use_libdialog
condition|)
block|{
if|if
condition|(
name|pprompt
operator|!=
name|NULL
operator|&&
operator|*
name|pprompt
operator|!=
literal|'\0'
condition|)
name|dheight
operator|--
expr_stmt|;
block|}
comment|/* limit the number of display items (necessary per dialog(1,3)) */
if|if
condition|(
name|display_limit
operator|==
literal|0
operator|||
name|display_limit
operator|>
name|DPV_DISPLAY_LIMIT
condition|)
name|display_limit
operator|=
name|DPV_DISPLAY_LIMIT
expr_stmt|;
comment|/* verify fheight will fit (stop if we hit 1) */
for|for
control|(
init|;
name|display_limit
operator|>
literal|0
condition|;
name|display_limit
operator|--
control|)
block|{
name|nthfile
operator|=
name|numlines
operator|=
literal|0
expr_stmt|;
name|fheight
operator|=
operator|(
name|int
operator|)
name|dpv_nfiles
operator|>
name|display_limit
condition|?
operator|(
name|unsigned
name|int
operator|)
name|display_limit
else|:
name|dpv_nfiles
expr_stmt|;
for|for
control|(
name|curfile
operator|=
name|file_list
init|;
name|curfile
operator|!=
name|NULL
condition|;
name|curfile
operator|=
name|curfile
operator|->
name|next
control|)
block|{
name|nthfile
operator|++
expr_stmt|;
name|numlines
operator|+=
name|dialog_prompt_numlines
argument_list|(
name|curfile
operator|->
name|name
argument_list|,
name|nls
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nthfile
operator|%
name|display_limit
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|numlines
operator|>
name|fheight
condition|)
name|fheight
operator|=
name|numlines
expr_stmt|;
name|numlines
operator|=
name|nthfile
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|numlines
operator|>
name|fheight
condition|)
name|fheight
operator|=
name|numlines
expr_stmt|;
if|if
condition|(
operator|(
name|dheight
operator|+
name|fheight
operator|+
operator|(
name|int
operator|)
name|dialog_prompt_numlines
argument_list|(
name|aprompt
argument_list|,
name|use_dialog
argument_list|)
operator|-
operator|(
name|use_dialog
condition|?
operator|(
name|int
operator|)
name|dialog_prompt_nlstate
argument_list|(
name|aprompt
argument_list|)
else|:
literal|0
operator|)
operator|)
operator|<=
name|max_rows
condition|)
break|break;
block|}
comment|/* don't show any items if we run the risk of hitting a blank set */
if|if
condition|(
operator|(
name|max_rows
operator|-
operator|(
name|use_shadow
condition|?
literal|5
else|:
literal|4
operator|)
operator|)
operator|>=
name|fheight
condition|)
name|dheight
operator|+=
name|fheight
expr_stmt|;
else|else
name|fheight
operator|=
literal|0
expr_stmt|;
comment|/* add lines for `-a text' */
name|numlines
operator|=
name|dialog_prompt_numlines
argument_list|(
name|aprompt
argument_list|,
name|use_dialog
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|warnx
argument_list|(
literal|"`-a text' is %i line%s long"
argument_list|,
name|numlines
argument_list|,
name|numlines
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
name|dheight
operator|+=
name|numlines
expr_stmt|;
comment|/* If using Xdialog(1), adjust accordingly (based on testing) */
if|if
condition|(
name|use_xdialog
condition|)
name|dheight
operator|+=
name|dheight
operator|/
literal|4
expr_stmt|;
comment|/* For wide mode, long prefix (`pprompt') or append (`aprompt') 	 * strings will bump width */
if|if
condition|(
name|wide
condition|)
block|{
name|len
operator|=
operator|(
name|int
operator|)
name|dialog_prompt_longestline
argument_list|(
name|pprompt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* !nls */
if|if
condition|(
operator|(
name|len
operator|+
literal|4
operator|)
operator|>
name|dwidth
condition|)
name|dwidth
operator|=
name|len
operator|+
literal|4
expr_stmt|;
name|len
operator|=
operator|(
name|int
operator|)
name|dialog_prompt_longestline
argument_list|(
name|aprompt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* nls */
if|if
condition|(
operator|(
name|len
operator|+
literal|4
operator|)
operator|>
name|dwidth
condition|)
name|dwidth
operator|=
name|len
operator|+
literal|4
expr_stmt|;
block|}
comment|/* Enforce width constraints to maximum values */
name|max_cols
operator|=
name|dialog_maxcols
argument_list|()
expr_stmt|;
if|if
condition|(
name|max_cols
operator|>
literal|0
operator|&&
name|dwidth
operator|>
name|max_cols
condition|)
name|dwidth
operator|=
name|max_cols
expr_stmt|;
comment|/* Optimize widths to sane values*/
if|if
condition|(
name|pbar_size
operator|>
name|dwidth
operator|-
literal|9
condition|)
block|{
name|pbar_size
operator|=
name|dwidth
operator|-
literal|9
expr_stmt|;
name|label_size
operator|=
literal|0
expr_stmt|;
comment|/* -9 = "|  - [" ... "] |" */
block|}
if|if
condition|(
name|pbar_size
operator|<
literal|0
condition|)
name|label_size
operator|=
name|dwidth
operator|-
literal|8
expr_stmt|;
comment|/* -8 = "|  " ... " -  |" */
elseif|else
if|if
condition|(
name|label_size
operator|>
operator|(
name|dwidth
operator|-
name|pbar_size
operator|-
literal|9
operator|)
operator|||
name|wide
condition|)
name|label_size
operator|=
name|no_labels
condition|?
literal|0
else|:
name|dwidth
operator|-
name|pbar_size
operator|-
literal|9
expr_stmt|;
comment|/* -9 = "| " ... " - [" ... "] |" */
comment|/* Hide labels if requested */
if|if
condition|(
name|no_labels
condition|)
name|label_size
operator|=
literal|0
expr_stmt|;
comment|/* Touch up the height (now that we know dwidth) */
name|dheight
operator|+=
name|dialog_prompt_wrappedlines
argument_list|(
name|pprompt
argument_list|,
name|dwidth
operator|-
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dheight
operator|+=
name|dialog_prompt_wrappedlines
argument_list|(
name|aprompt
argument_list|,
name|dwidth
operator|-
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|warnx
argument_list|(
literal|"dheight = %i dwidth = %i fheight = %i"
argument_list|,
name|dheight
argument_list|,
name|dwidth
argument_list|,
name|fheight
argument_list|)
expr_stmt|;
comment|/* Calculate left/right portions of % */
name|pct_lsize
operator|=
operator|(
name|pbar_size
operator|-
literal|4
operator|)
operator|/
literal|2
expr_stmt|;
comment|/* -4 == printf("%-3s%%", pct) */
name|pct_rsize
operator|=
name|pct_lsize
expr_stmt|;
comment|/* If not evenly divisible by 2, increment the right-side */
if|if
condition|(
operator|(
name|pct_rsize
operator|+
name|pct_rsize
operator|+
literal|4
operator|)
operator|!=
name|pbar_size
condition|)
name|pct_rsize
operator|++
expr_stmt|;
comment|/* Initialize "Done" text */
if|if
condition|(
name|done
operator|==
name|NULL
operator|&&
operator|(
name|done
operator|=
name|msg_done
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|done
operator|=
name|getenv
argument_list|(
name|ENV_MSG_DONE
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|done_size
operator|=
name|strlen
argument_list|(
name|done
argument_list|)
expr_stmt|;
else|else
block|{
name|done_size
operator|=
name|strlen
argument_list|(
name|DPV_DONE_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|done
operator|=
name|malloc
argument_list|(
name|done_size
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
name|EXIT_FAILURE
argument_list|,
literal|"Out of memory?!"
argument_list|)
expr_stmt|;
name|dprompt_free_mask
operator||=
name|FM_DONE
expr_stmt|;
name|snprintf
argument_list|(
name|done
argument_list|,
name|done_size
operator|+
literal|1
argument_list|,
name|DPV_DONE_DEFAULT
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pbar_size
operator|<
name|done_size
condition|)
block|{
name|done_lsize
operator|=
name|done_rsize
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
name|done
operator|+
name|pbar_size
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|done_size
operator|=
name|pbar_size
expr_stmt|;
block|}
else|else
block|{
comment|/* Calculate left/right portions for mini-progressbar */
name|done_lsize
operator|=
operator|(
name|pbar_size
operator|-
name|done_size
operator|)
operator|/
literal|2
expr_stmt|;
name|done_rsize
operator|=
name|done_lsize
expr_stmt|;
comment|/* If not evenly divisible by 2, increment the right-side */
if|if
condition|(
operator|(
name|done_rsize
operator|+
name|done_size
operator|+
name|done_lsize
operator|)
operator|!=
name|pbar_size
condition|)
name|done_rsize
operator|++
expr_stmt|;
block|}
comment|/* Initialize "Fail" text */
if|if
condition|(
name|fail
operator|==
name|NULL
operator|&&
operator|(
name|fail
operator|=
name|msg_fail
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|fail
operator|=
name|getenv
argument_list|(
name|ENV_MSG_FAIL
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|fail_size
operator|=
name|strlen
argument_list|(
name|fail
argument_list|)
expr_stmt|;
else|else
block|{
name|fail_size
operator|=
name|strlen
argument_list|(
name|DPV_FAIL_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fail
operator|=
name|malloc
argument_list|(
name|fail_size
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
name|EXIT_FAILURE
argument_list|,
literal|"Out of memory?!"
argument_list|)
expr_stmt|;
name|dprompt_free_mask
operator||=
name|FM_FAIL
expr_stmt|;
name|snprintf
argument_list|(
name|fail
argument_list|,
name|fail_size
operator|+
literal|1
argument_list|,
name|DPV_FAIL_DEFAULT
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pbar_size
operator|<
name|fail_size
condition|)
block|{
name|fail_lsize
operator|=
name|fail_rsize
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
name|fail
operator|+
name|pbar_size
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|fail_size
operator|=
name|pbar_size
expr_stmt|;
block|}
else|else
block|{
comment|/* Calculate left/right portions for mini-progressbar */
name|fail_lsize
operator|=
operator|(
name|pbar_size
operator|-
name|fail_size
operator|)
operator|/
literal|2
expr_stmt|;
name|fail_rsize
operator|=
name|fail_lsize
expr_stmt|;
comment|/* If not evenly divisible by 2, increment the right-side */
if|if
condition|(
operator|(
name|fail_rsize
operator|+
name|fail_size
operator|+
name|fail_lsize
operator|)
operator|!=
name|pbar_size
condition|)
name|fail_rsize
operator|++
expr_stmt|;
block|}
comment|/* Initialize "Pending" text */
if|if
condition|(
name|pend
operator|==
name|NULL
operator|&&
operator|(
name|pend
operator|=
name|msg_pending
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|pend
operator|=
name|getenv
argument_list|(
name|ENV_MSG_PENDING
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|pend_size
operator|=
name|strlen
argument_list|(
name|pend
argument_list|)
expr_stmt|;
else|else
block|{
name|pend_size
operator|=
name|strlen
argument_list|(
name|DPV_PENDING_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pend
operator|=
name|malloc
argument_list|(
name|pend_size
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
name|EXIT_FAILURE
argument_list|,
literal|"Out of memory?!"
argument_list|)
expr_stmt|;
name|dprompt_free_mask
operator||=
name|FM_PEND
expr_stmt|;
name|snprintf
argument_list|(
name|pend
argument_list|,
name|pend_size
operator|+
literal|1
argument_list|,
name|DPV_PENDING_DEFAULT
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pbar_size
operator|<
name|pend_size
condition|)
block|{
name|pend_lsize
operator|=
name|pend_rsize
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
name|pend
operator|+
name|pbar_size
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|pend_size
operator|=
name|pbar_size
expr_stmt|;
block|}
else|else
block|{
comment|/* Calculate left/right portions for mini-progressbar */
name|pend_lsize
operator|=
operator|(
name|pbar_size
operator|-
name|pend_size
operator|)
operator|/
literal|2
expr_stmt|;
name|pend_rsize
operator|=
name|pend_lsize
expr_stmt|;
comment|/* If not evenly divisible by 2, increment the right-side */
if|if
condition|(
operator|(
name|pend_rsize
operator|+
name|pend_lsize
operator|+
name|pend_size
operator|)
operator|!=
name|pbar_size
condition|)
name|pend_rsize
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|debug
condition|)
name|warnx
argument_list|(
literal|"label_size = %i pbar_size = %i"
argument_list|,
name|label_size
argument_list|,
name|pbar_size
argument_list|)
expr_stmt|;
name|dprompt_clear
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Clear the [X]dialog(1) `--gauge' prompt buffer.  */
end_comment

begin_function
name|void
name|dprompt_clear
parameter_list|(
name|void
parameter_list|)
block|{
operator|*
name|dprompt
operator|=
literal|'\0'
expr_stmt|;
name|dprompt_pos
operator|=
name|dprompt
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Append to the [X]dialog(1) `--gauge' prompt buffer. Syntax is like printf(3)  * and returns the number of bytes appended to the buffer.  */
end_comment

begin_function
name|int
name|dprompt_add
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
if|if
condition|(
name|dprompt_pos
operator|>=
operator|(
name|dprompt
operator|+
name|PROMPT_MAX
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|len
operator|=
name|vsnprintf
argument_list|(
name|dprompt_pos
argument_list|,
call|(
name|size_t
call|)
argument_list|(
name|PROMPT_MAX
operator|-
operator|(
name|dprompt_pos
operator|-
name|dprompt
operator|)
argument_list|)
argument_list|,
name|format
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
operator|-
literal|1
condition|)
name|errx
argument_list|(
name|EXIT_FAILURE
argument_list|,
literal|"%s: Oops, dprompt buffer overflow"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dprompt_pos
operator|+
name|len
operator|)
operator|<
operator|(
name|dprompt
operator|+
name|PROMPT_MAX
operator|)
condition|)
name|dprompt_pos
operator|+=
name|len
expr_stmt|;
else|else
name|dprompt_pos
operator|=
name|dprompt
operator|+
name|PROMPT_MAX
expr_stmt|;
return|return
operator|(
name|len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Append active files to the [X]dialog(1) `--gauge' prompt buffer. Syntax  * requires a pointer to the head of the dpv_file_node linked-list. Returns the  * number of files processed successfully.  */
end_comment

begin_function
specifier|static
name|int
name|dprompt_add_files
parameter_list|(
name|struct
name|dpv_file_node
modifier|*
name|file_list
parameter_list|,
name|struct
name|dpv_file_node
modifier|*
name|curfile
parameter_list|,
name|int
name|pct
parameter_list|)
block|{
name|char
name|c
decl_stmt|;
name|char
name|bold_code
init|=
literal|'b'
decl_stmt|;
comment|/* default: enabled */
name|char
name|color_code
init|=
literal|'4'
decl_stmt|;
comment|/* default: blue */
name|uint8_t
name|after_curfile
init|=
name|curfile
operator|!=
name|NULL
condition|?
name|FALSE
else|:
name|TRUE
decl_stmt|;
name|uint8_t
name|nls
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|char
modifier|*
name|lastline
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|bg_code
decl_stmt|;
specifier|const
name|char
modifier|*
name|estext
decl_stmt|;
specifier|const
name|char
modifier|*
name|format
decl_stmt|;
name|enum
name|dprompt_state
name|dstate
decl_stmt|;
name|int
name|estext_lsize
decl_stmt|;
name|int
name|estext_rsize
decl_stmt|;
name|int
name|estext_size
decl_stmt|;
name|int
name|flabel_size
decl_stmt|;
name|int
name|hlen
decl_stmt|;
name|int
name|lsize
decl_stmt|;
name|int
name|nlines
init|=
literal|0
decl_stmt|;
name|int
name|nthfile
init|=
literal|0
decl_stmt|;
name|int
name|pwidth
decl_stmt|;
name|int
name|rsize
decl_stmt|;
name|struct
name|dpv_file_node
modifier|*
name|fp
decl_stmt|;
name|char
name|flabel
index|[
name|FLABEL_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|human
index|[
literal|32
index|]
decl_stmt|;
name|char
name|pbar
index|[
name|pbar_size
operator|+
literal|16
index|]
decl_stmt|;
comment|/* +15 for optional color */
name|char
name|pbar_cap
index|[
sizeof|sizeof
argument_list|(
name|pbar
argument_list|)
index|]
decl_stmt|;
name|char
name|pbar_fill
index|[
sizeof|sizeof
argument_list|(
name|pbar
argument_list|)
index|]
decl_stmt|;
comment|/* Override color defaults with that of main progress bar */
if|if
condition|(
name|use_colors
operator|||
name|use_shadow
condition|)
block|{
comment|/* NB: shadow enables color */
name|color_code
operator|=
name|gauge_color
index|[
literal|0
index|]
expr_stmt|;
comment|/* NB: str[1] aka bg is unused */
name|bold_code
operator|=
name|gauge_color
index|[
literal|2
index|]
expr_stmt|;
block|}
comment|/* 	 * Create mini-progressbar for current file (if applicable) 	 */
operator|*
name|pbar
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|pbar_size
operator|>=
literal|0
operator|&&
name|pct
operator|>=
literal|0
operator|&&
name|curfile
operator|!=
name|NULL
operator|&&
operator|(
name|curfile
operator|->
name|length
operator|>=
literal|0
operator|||
name|dialog_test
operator|)
condition|)
block|{
name|snprintf
argument_list|(
name|pbar
argument_list|,
name|pbar_size
operator|+
literal|1
argument_list|,
literal|"%*s%3u%%%*s"
argument_list|,
name|pct_lsize
argument_list|,
literal|""
argument_list|,
name|pct
argument_list|,
name|pct_rsize
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_color
condition|)
block|{
comment|/* Calculate the fill-width of progressbar */
name|pwidth
operator|=
name|pct
operator|*
name|pbar_size
operator|/
literal|100
expr_stmt|;
comment|/* Round up based on one-tenth of a percent */
if|if
condition|(
operator|(
name|pct
operator|*
name|pbar_size
operator|%
literal|100
operator|)
operator|>
literal|50
condition|)
name|pwidth
operator|++
expr_stmt|;
comment|/* 			 * Make two copies of pbar. Make one represent the fill 			 * and the other the remainder (cap). We'll insert the 			 * ANSI delimiter in between. 			 */
operator|*
name|pbar_fill
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|pbar_cap
operator|=
literal|'\0'
expr_stmt|;
name|strncat
argument_list|(
name|pbar_fill
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
operator|(
name|pbar
operator|)
argument_list|,
name|dwidth
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pbar_fill
operator|+
name|pwidth
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|strncat
argument_list|(
name|pbar_cap
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
operator|(
name|pbar
operator|+
name|pwidth
operator|)
argument_list|,
name|dwidth
argument_list|)
expr_stmt|;
comment|/* Finalize the mini [color] progressbar */
name|snprintf
argument_list|(
name|pbar
argument_list|,
sizeof|sizeof
argument_list|(
name|pbar
argument_list|)
argument_list|,
literal|"\\Z%c\\Zr\\Z%c%s%s%s\\Zn"
argument_list|,
name|bold_code
argument_list|,
name|color_code
argument_list|,
name|pbar_fill
argument_list|,
literal|"\\ZR"
argument_list|,
name|pbar_cap
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|fp
operator|=
name|file_list
init|;
name|fp
operator|!=
name|NULL
condition|;
name|fp
operator|=
name|fp
operator|->
name|next
control|)
block|{
name|flabel_size
operator|=
name|label_size
expr_stmt|;
name|name
operator|=
name|fp
operator|->
name|name
expr_stmt|;
name|nthfile
operator|++
expr_stmt|;
comment|/* 		 * Support multiline filenames (where the filename is taken as 		 * the last line and the text leading up to the last line can 		 * be used as (for example) a heading/separator between files. 		 */
if|if
condition|(
name|use_dialog
condition|)
name|nls
operator|=
name|dialog_prompt_nlstate
argument_list|(
name|pprompt
argument_list|)
expr_stmt|;
name|nlines
operator|+=
name|dialog_prompt_numlines
argument_list|(
name|name
argument_list|,
name|nls
argument_list|)
expr_stmt|;
name|lastline
operator|=
name|dialog_prompt_lastline
argument_list|(
name|name
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|!=
name|lastline
condition|)
block|{
name|c
operator|=
operator|*
name|lastline
expr_stmt|;
operator|*
name|lastline
operator|=
literal|'\0'
expr_stmt|;
name|dprompt_add
argument_list|(
literal|"%s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
operator|*
name|lastline
operator|=
name|c
expr_stmt|;
name|name
operator|=
name|lastline
expr_stmt|;
block|}
comment|/* Support color codes (for dialog(1,3)) in file names */
if|if
condition|(
operator|(
name|use_dialog
operator|||
name|use_libdialog
operator|)
operator|&&
name|use_color
condition|)
block|{
name|cp
operator|=
name|name
expr_stmt|;
while|while
condition|(
operator|*
name|cp
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\\'
operator|&&
operator|*
operator|(
name|cp
operator|+
literal|1
operator|)
operator|!=
literal|'\0'
operator|&&
operator|*
operator|(
operator|++
name|cp
operator|)
operator|==
literal|'Z'
operator|&&
operator|*
operator|(
name|cp
operator|+
literal|1
operator|)
operator|!=
literal|'\0'
condition|)
block|{
name|cp
operator|++
expr_stmt|;
name|flabel_size
operator|+=
literal|3
expr_stmt|;
block|}
name|cp
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|flabel_size
operator|>
name|FLABEL_MAX
condition|)
name|flabel_size
operator|=
name|FLABEL_MAX
expr_stmt|;
block|}
comment|/* If no mini-progressbar, increase label width */
if|if
condition|(
name|pbar_size
operator|<
literal|0
operator|&&
name|flabel_size
operator|<=
name|FLABEL_MAX
operator|-
literal|2
operator|&&
name|no_labels
operator|==
name|FALSE
condition|)
name|flabel_size
operator|+=
literal|2
expr_stmt|;
comment|/* If name is too long, add an ellipsis */
if|if
condition|(
name|snprintf
argument_list|(
name|flabel
argument_list|,
name|flabel_size
operator|+
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|name
argument_list|)
operator|>
name|flabel_size
condition|)
name|sprintf
argument_list|(
name|flabel
operator|+
name|flabel_size
operator|-
literal|3
argument_list|,
literal|"..."
argument_list|)
expr_stmt|;
comment|/* 		 * Append the label (processing the current file differently) 		 */
if|if
condition|(
name|fp
operator|==
name|curfile
operator|&&
name|pct
operator|<
literal|100
condition|)
block|{
comment|/* 			 * Add an ellipsis to current file name if it will fit. 			 * There may be an ellipsis already from truncating the 			 * label (in which case, we already have one). 			 */
name|cp
operator|=
name|flabel
operator|+
name|strlen
argument_list|(
name|flabel
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|<
operator|(
name|flabel
operator|+
name|flabel_size
operator|)
condition|)
name|snprintf
argument_list|(
name|cp
argument_list|,
name|flabel_size
operator|-
operator|(
name|cp
operator|-
name|flabel
operator|)
operator|+
literal|1
argument_list|,
literal|"..."
argument_list|)
expr_stmt|;
comment|/* Append label (with spinner and optional color) */
name|dprompt_add
argument_list|(
literal|"%s%-*s%s %c"
argument_list|,
name|use_color
condition|?
literal|"\\Zb"
else|:
literal|""
argument_list|,
name|flabel_size
argument_list|,
name|flabel
argument_list|,
name|use_color
condition|?
literal|"\\Zn"
else|:
literal|""
argument_list|,
name|spin_char
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
name|dprompt_add
argument_list|(
literal|"%-*s%s %s"
argument_list|,
name|flabel_size
argument_list|,
name|flabel
argument_list|,
name|use_color
condition|?
literal|"\\Zn"
else|:
literal|""
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
comment|/* 		 * Append pbar/status (processing the current file differently) 		 */
name|dstate
operator|=
name|DPROMPT_NONE
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|msg
operator|!=
name|NULL
condition|)
name|dstate
operator|=
name|DPROMPT_CUSTOM_MSG
expr_stmt|;
elseif|else
if|if
condition|(
name|pbar_size
operator|<
literal|0
condition|)
name|dstate
operator|=
name|DPROMPT_NONE
expr_stmt|;
elseif|else
if|if
condition|(
name|pbar_size
operator|<
literal|4
condition|)
name|dstate
operator|=
name|DPROMPT_MINIMAL
expr_stmt|;
elseif|else
if|if
condition|(
name|after_curfile
condition|)
name|dstate
operator|=
name|DPROMPT_PENDING
expr_stmt|;
elseif|else
if|if
condition|(
name|fp
operator|==
name|curfile
condition|)
block|{
if|if
condition|(
operator|*
name|pbar
operator|==
literal|'\0'
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|length
operator|<
literal|0
condition|)
name|dstate
operator|=
name|DPROMPT_DETAILS
expr_stmt|;
elseif|else
if|if
condition|(
name|fp
operator|->
name|status
operator|==
name|DPV_STATUS_RUNNING
condition|)
name|dstate
operator|=
name|DPROMPT_DETAILS
expr_stmt|;
else|else
name|dstate
operator|=
name|DPROMPT_END_STATE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dialog_test
condition|)
comment|/* status/length ignored */
name|dstate
operator|=
name|pct
operator|<
literal|100
condition|?
name|DPROMPT_PBAR
else|:
name|DPROMPT_END_STATE
expr_stmt|;
elseif|else
if|if
condition|(
name|fp
operator|->
name|status
operator|==
name|DPV_STATUS_RUNNING
condition|)
name|dstate
operator|=
name|fp
operator|->
name|length
operator|<
literal|0
condition|?
name|DPROMPT_DETAILS
else|:
name|DPROMPT_PBAR
expr_stmt|;
else|else
comment|/* not running */
name|dstate
operator|=
name|fp
operator|->
name|length
operator|<
literal|0
condition|?
name|DPROMPT_DETAILS
else|:
name|DPROMPT_END_STATE
expr_stmt|;
block|}
else|else
block|{
comment|/* before curfile */
if|if
condition|(
name|dialog_test
condition|)
name|dstate
operator|=
name|DPROMPT_END_STATE
expr_stmt|;
else|else
name|dstate
operator|=
name|fp
operator|->
name|length
operator|<
literal|0
condition|?
name|DPROMPT_DETAILS
else|:
name|DPROMPT_END_STATE
expr_stmt|;
block|}
name|format
operator|=
name|use_color
condition|?
literal|" [\\Z%c%s%-*s%s%-*s\\Zn]\\n"
else|:
literal|" [%-*s%s%-*s]\\n"
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|status
operator|==
name|DPV_STATUS_FAILED
condition|)
block|{
name|bg_code
operator|=
literal|"\\Zr\\Z1"
expr_stmt|;
comment|/* Red */
name|estext_lsize
operator|=
name|fail_lsize
expr_stmt|;
name|estext_rsize
operator|=
name|fail_rsize
expr_stmt|;
name|estext_size
operator|=
name|fail_size
expr_stmt|;
name|estext
operator|=
name|fail
expr_stmt|;
block|}
else|else
block|{
comment|/* e.g., DPV_STATUS_DONE */
name|bg_code
operator|=
literal|"\\Zr\\Z2"
expr_stmt|;
comment|/* Green */
name|estext_lsize
operator|=
name|done_lsize
expr_stmt|;
name|estext_rsize
operator|=
name|done_rsize
expr_stmt|;
name|estext_size
operator|=
name|done_size
expr_stmt|;
name|estext
operator|=
name|done
expr_stmt|;
block|}
switch|switch
condition|(
name|dstate
condition|)
block|{
case|case
name|DPROMPT_PENDING
case|:
comment|/* Future file(s) */
name|dprompt_add
argument_list|(
literal|" [%-*s%s%-*s]\\n"
argument_list|,
name|pend_lsize
argument_list|,
literal|""
argument_list|,
name|pend
argument_list|,
name|pend_rsize
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|DPROMPT_PBAR
case|:
comment|/* Current file */
name|dprompt_add
argument_list|(
literal|" [%s]\\n"
argument_list|,
name|pbar
argument_list|)
expr_stmt|;
break|break;
case|case
name|DPROMPT_END_STATE
case|:
comment|/* Past/Current file(s) */
if|if
condition|(
name|use_color
condition|)
name|dprompt_add
argument_list|(
name|format
argument_list|,
name|bold_code
argument_list|,
name|bg_code
argument_list|,
name|estext_lsize
argument_list|,
literal|""
argument_list|,
name|estext
argument_list|,
name|estext_rsize
argument_list|,
literal|""
argument_list|)
expr_stmt|;
else|else
name|dprompt_add
argument_list|(
name|format
argument_list|,
name|estext_lsize
argument_list|,
literal|""
argument_list|,
name|estext
argument_list|,
name|estext_rsize
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|DPROMPT_DETAILS
case|:
comment|/* Past/Current file(s) */
name|humanize_number
argument_list|(
name|human
argument_list|,
name|pbar_size
operator|+
literal|2
argument_list|,
name|fp
operator|->
name|read
argument_list|,
literal|""
argument_list|,
name|HN_AUTOSCALE
argument_list|,
name|HN_NOSPACE
operator||
name|HN_DIVISOR_1000
argument_list|)
expr_stmt|;
comment|/* Calculate center alignment */
name|hlen
operator|=
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|human
argument_list|)
expr_stmt|;
name|lsize
operator|=
operator|(
name|pbar_size
operator|-
name|hlen
operator|)
operator|/
literal|2
expr_stmt|;
name|rsize
operator|=
name|lsize
expr_stmt|;
if|if
condition|(
operator|(
name|lsize
operator|+
name|hlen
operator|+
name|rsize
operator|)
operator|!=
name|pbar_size
condition|)
name|rsize
operator|++
expr_stmt|;
if|if
condition|(
name|use_color
condition|)
name|dprompt_add
argument_list|(
name|format
argument_list|,
name|bold_code
argument_list|,
name|bg_code
argument_list|,
name|lsize
argument_list|,
literal|""
argument_list|,
name|human
argument_list|,
name|rsize
argument_list|,
literal|""
argument_list|)
expr_stmt|;
else|else
name|dprompt_add
argument_list|(
name|format
argument_list|,
name|lsize
argument_list|,
literal|""
argument_list|,
name|human
argument_list|,
name|rsize
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|DPROMPT_CUSTOM_MSG
case|:
comment|/* File-specific message override */
name|snprintf
argument_list|(
name|msg
argument_list|,
name|PROMPT_MAX
operator|+
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|fp
operator|->
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|pbar_size
operator|<
operator|(
name|mesg_size
operator|=
name|strlen
argument_list|(
name|msg
argument_list|)
operator|)
condition|)
block|{
name|mesg_lsize
operator|=
name|mesg_rsize
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
name|msg
operator|+
name|pbar_size
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|mesg_size
operator|=
name|pbar_size
expr_stmt|;
block|}
else|else
block|{
name|mesg_lsize
operator|=
operator|(
name|pbar_size
operator|-
name|mesg_size
operator|)
operator|/
literal|2
expr_stmt|;
name|mesg_rsize
operator|=
name|mesg_lsize
expr_stmt|;
if|if
condition|(
operator|(
name|mesg_rsize
operator|+
name|mesg_size
operator|+
name|mesg_lsize
operator|)
operator|!=
name|pbar_size
condition|)
name|mesg_rsize
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|use_color
condition|)
name|dprompt_add
argument_list|(
name|format
argument_list|,
name|bold_code
argument_list|,
name|bg_code
argument_list|,
name|mesg_lsize
argument_list|,
literal|""
argument_list|,
name|msg
argument_list|,
name|mesg_rsize
argument_list|,
literal|""
argument_list|)
expr_stmt|;
else|else
name|dprompt_add
argument_list|(
name|format
argument_list|,
name|mesg_lsize
argument_list|,
literal|""
argument_list|,
name|msg
argument_list|,
name|mesg_rsize
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|DPROMPT_MINIMAL
case|:
comment|/* Short progress bar, minimal room */
if|if
condition|(
name|use_color
condition|)
name|dprompt_add
argument_list|(
name|format
argument_list|,
name|bold_code
argument_list|,
name|bg_code
argument_list|,
name|pbar_size
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
else|else
name|dprompt_add
argument_list|(
name|format
argument_list|,
name|pbar_size
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|DPROMPT_NONE
case|:
comment|/* pbar_size< 0 */
comment|/* FALLTHROUGH */
default|default:
name|dprompt_add
argument_list|(
literal|" \\n"
argument_list|)
expr_stmt|;
comment|/* 			 * NB: Leading space required for the case when 			 * spin_char() returns a single backslash [\] which 			 * without the space, changes the meaning of `\n' 			 */
block|}
comment|/* Stop building if we've hit the internal limit */
if|if
condition|(
name|nthfile
operator|>=
name|display_limit
condition|)
break|break;
comment|/* If this is the current file, all others are pending */
if|if
condition|(
name|fp
operator|==
name|curfile
condition|)
name|after_curfile
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* 	 * Since we cannot change the height/width of the [X]dialog(1) widget 	 * after spawn, to make things look nice let's pad the height so that 	 * the `-a text' always appears in the same spot. 	 * 	 * NOTE: fheight is calculated in dprompt_init(). It represents the 	 * maximum height required to display the set of items (broken up into 	 * pieces of display_limit chunks) whose names contain the most 	 * newlines for any given set. 	 */
while|while
condition|(
name|nlines
operator|<
name|fheight
condition|)
block|{
name|dprompt_add
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|nlines
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|nthfile
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Process the dpv_file_node linked-list of named files, re-generating the  * [X]dialog(1) `--gauge' prompt text for the current state of transfers.  */
end_comment

begin_function
name|void
name|dprompt_recreate
parameter_list|(
name|struct
name|dpv_file_node
modifier|*
name|file_list
parameter_list|,
name|struct
name|dpv_file_node
modifier|*
name|curfile
parameter_list|,
name|int
name|pct
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
comment|/* 	 * Re-Build the prompt text 	 */
name|dprompt_clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|display_limit
operator|>
literal|0
condition|)
name|dprompt_add_files
argument_list|(
name|file_list
argument_list|,
name|curfile
argument_list|,
name|pct
argument_list|)
expr_stmt|;
comment|/* Xdialog(1) requires newlines (a) escaped and (b) in triplicate */
if|if
condition|(
name|use_xdialog
condition|)
block|{
comment|/* Replace `\n' with `\n\\n\n' in dprompt */
name|len
operator|=
name|strlen
argument_list|(
name|dprompt
argument_list|)
expr_stmt|;
name|len
operator|+=
name|strcount
argument_list|(
name|dprompt
argument_list|,
literal|"\\n"
argument_list|)
operator|*
literal|5
expr_stmt|;
comment|/* +5 chars per count */
if|if
condition|(
name|len
operator|>
name|PROMPT_MAX
condition|)
name|errx
argument_list|(
name|EXIT_FAILURE
argument_list|,
literal|"%s: Oops, dprompt buffer overflow "
literal|"(%zu> %i)"
argument_list|,
name|__func__
argument_list|,
name|len
argument_list|,
name|PROMPT_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|replaceall
argument_list|(
name|dprompt
argument_list|,
literal|"\\n"
argument_list|,
literal|"\n\\n\n"
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
name|EXIT_FAILURE
argument_list|,
literal|"%s: replaceall()"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|use_libdialog
condition|)
name|strexpandnl
argument_list|(
name|dprompt
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print the [X]dialog(1) `--gauge' prompt text to a buffer.  */
end_comment

begin_function
name|int
name|dprompt_sprint
parameter_list|(
name|char
modifier|*
specifier|restrict
name|str
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
specifier|const
name|char
modifier|*
name|append
parameter_list|)
block|{
return|return
operator|(
name|snprintf
argument_list|(
name|str
argument_list|,
name|PROMPT_MAX
argument_list|,
literal|"%s%s%s%s"
argument_list|,
name|use_color
condition|?
literal|"\\Zn"
else|:
literal|""
argument_list|,
name|prefix
condition|?
name|prefix
else|:
literal|""
argument_list|,
name|dprompt
argument_list|,
name|append
condition|?
name|append
else|:
literal|""
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Print the [X]dialog(1) `--gauge' prompt text to file descriptor fd (could  * be STDOUT_FILENO or a pipe(2) file descriptor to actual [X]dialog(1)).  */
end_comment

begin_function
name|void
name|dprompt_dprint
parameter_list|(
name|int
name|fd
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
specifier|const
name|char
modifier|*
name|append
parameter_list|,
name|int
name|overall
parameter_list|)
block|{
name|int
name|percent
init|=
name|gauge_percent
decl_stmt|;
if|if
condition|(
name|overall
operator|>=
literal|0
operator|&&
name|overall
operator|<=
literal|100
condition|)
name|gauge_percent
operator|=
name|percent
operator|=
name|overall
expr_stmt|;
name|dprintf
argument_list|(
name|fd
argument_list|,
literal|"XXX\n%s%s%s%s\nXXX\n%i\n"
argument_list|,
name|use_color
condition|?
literal|"\\Zn"
else|:
literal|""
argument_list|,
name|prefix
condition|?
name|prefix
else|:
literal|""
argument_list|,
name|dprompt
argument_list|,
name|append
condition|?
name|append
else|:
literal|""
argument_list|,
name|percent
argument_list|)
expr_stmt|;
name|fsync
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print the dialog(3) `gauge' prompt text using libdialog.  */
end_comment

begin_function
name|void
name|dprompt_libprint
parameter_list|(
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
specifier|const
name|char
modifier|*
name|append
parameter_list|,
name|int
name|overall
parameter_list|)
block|{
name|int
name|percent
init|=
name|gauge_percent
decl_stmt|;
name|char
name|buf
index|[
name|DPV_PPROMPT_MAX
operator|+
name|DPV_APROMPT_MAX
operator|+
name|DPV_DISPLAY_LIMIT
operator|*
literal|1024
index|]
decl_stmt|;
name|dprompt_sprint
argument_list|(
name|buf
argument_list|,
name|prefix
argument_list|,
name|append
argument_list|)
expr_stmt|;
if|if
condition|(
name|overall
operator|>=
literal|0
operator|&&
name|overall
operator|<=
literal|100
condition|)
name|gauge_percent
operator|=
name|percent
operator|=
name|overall
expr_stmt|;
name|gauge
operator|=
name|dlg_reallocate_gauge
argument_list|(
name|gauge
argument_list|,
name|title
operator|==
name|NULL
condition|?
literal|""
else|:
name|title
argument_list|,
name|buf
argument_list|,
name|dheight
argument_list|,
name|dwidth
argument_list|,
name|percent
argument_list|)
expr_stmt|;
name|dlg_update_gauge
argument_list|(
name|gauge
argument_list|,
name|percent
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Free allocated items initialized by dprompt_init()  */
end_comment

begin_function
name|void
name|dprompt_free
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|(
name|dprompt_free_mask
operator|&
name|FM_DONE
operator|)
operator|!=
literal|0
condition|)
block|{
name|dprompt_free_mask
operator|^=
name|FM_DONE
expr_stmt|;
name|free
argument_list|(
name|done
argument_list|)
expr_stmt|;
name|done
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dprompt_free_mask
operator|&
name|FM_FAIL
operator|)
operator|!=
literal|0
condition|)
block|{
name|dprompt_free_mask
operator|^=
name|FM_FAIL
expr_stmt|;
name|free
argument_list|(
name|fail
argument_list|)
expr_stmt|;
name|fail
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dprompt_free_mask
operator|&
name|FM_PEND
operator|)
operator|!=
literal|0
condition|)
block|{
name|dprompt_free_mask
operator|^=
name|FM_PEND
expr_stmt|;
name|free
argument_list|(
name|pend
argument_list|)
expr_stmt|;
name|pend
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

end_unit


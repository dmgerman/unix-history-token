begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*===- InstrProfilingValue.c - Support library for PGO instrumentation ----===*\ |* |*                     The LLVM Compiler Infrastructure |* |* This file is distributed under the University of Illinois Open Source |* License. See LICENSE.TXT for details. |* \*===----------------------------------------------------------------------===*/
end_comment

begin_include
include|#
directive|include
file|"InstrProfiling.h"
end_include

begin_include
include|#
directive|include
file|"InstrProfilingInternal.h"
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_define
define|#
directive|define
name|INSTR_PROF_VALUE_PROF_DATA
end_define

begin_define
define|#
directive|define
name|INSTR_PROF_COMMON_API_IMPL
end_define

begin_include
include|#
directive|include
file|"InstrProfData.inc"
end_include

begin_define
define|#
directive|define
name|PROF_OOM
parameter_list|(
name|Msg
parameter_list|)
value|PROF_ERR(Msg ":%s\n", "Out of memory");
end_define

begin_define
define|#
directive|define
name|PROF_OOM_RETURN
parameter_list|(
name|Msg
parameter_list|)
define|\
value|{                                                                            \     PROF_OOM(Msg)                                                              \     free(ValueDataArray);                                                      \     return NULL;                                                               \   }
end_define

begin_if
if|#
directive|if
name|COMPILER_RT_HAS_ATOMICS
operator|!=
literal|1
end_if

begin_function
name|COMPILER_RT_VISIBILITY
name|uint32_t
name|BoolCmpXchg
parameter_list|(
name|void
modifier|*
modifier|*
name|Ptr
parameter_list|,
name|void
modifier|*
name|OldV
parameter_list|,
name|void
modifier|*
name|NewV
parameter_list|)
block|{
name|void
modifier|*
name|R
init|=
operator|*
name|Ptr
decl_stmt|;
if|if
condition|(
name|R
operator|==
name|OldV
condition|)
block|{
operator|*
name|Ptr
operator|=
name|NewV
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* This method is only used in value profiler mock testing.  */
end_comment

begin_function
name|COMPILER_RT_VISIBILITY
name|void
name|__llvm_profile_set_num_value_sites
parameter_list|(
name|__llvm_profile_data
modifier|*
name|Data
parameter_list|,
name|uint32_t
name|ValueKind
parameter_list|,
name|uint16_t
name|NumValueSites
parameter_list|)
block|{
operator|*
operator|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|Data
operator|->
name|NumValueSites
index|[
name|ValueKind
index|]
operator|)
operator|=
name|NumValueSites
expr_stmt|;
block|}
end_function

begin_comment
comment|/* This method is only used in value profiler mock testing.  */
end_comment

begin_function
name|COMPILER_RT_VISIBILITY
specifier|const
name|__llvm_profile_data
modifier|*
name|__llvm_profile_iterate_data
parameter_list|(
specifier|const
name|__llvm_profile_data
modifier|*
name|Data
parameter_list|)
block|{
return|return
name|Data
operator|+
literal|1
return|;
block|}
end_function

begin_comment
comment|/* This method is only used in value profiler mock testing.  */
end_comment

begin_function
name|COMPILER_RT_VISIBILITY
name|void
modifier|*
name|__llvm_get_function_addr
parameter_list|(
specifier|const
name|__llvm_profile_data
modifier|*
name|Data
parameter_list|)
block|{
return|return
name|Data
operator|->
name|FunctionPointer
return|;
block|}
end_function

begin_comment
comment|/* Allocate an array that holds the pointers to the linked lists of  * value profile counter nodes. The number of element of the array  * is the total number of value profile sites instrumented. Returns  * 0 if allocation fails.  */
end_comment

begin_function
specifier|static
name|int
name|allocateValueProfileCounters
parameter_list|(
name|__llvm_profile_data
modifier|*
name|Data
parameter_list|)
block|{
name|uint64_t
name|NumVSites
init|=
literal|0
decl_stmt|;
name|uint32_t
name|VKI
decl_stmt|;
for|for
control|(
name|VKI
operator|=
name|IPVK_First
init|;
name|VKI
operator|<=
name|IPVK_Last
condition|;
operator|++
name|VKI
control|)
name|NumVSites
operator|+=
name|Data
operator|->
name|NumValueSites
index|[
name|VKI
index|]
expr_stmt|;
name|ValueProfNode
modifier|*
modifier|*
name|Mem
init|=
operator|(
name|ValueProfNode
operator|*
operator|*
operator|)
name|calloc
argument_list|(
name|NumVSites
argument_list|,
sizeof|sizeof
argument_list|(
name|ValueProfNode
operator|*
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|Mem
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|COMPILER_RT_BOOL_CMPXCHG
argument_list|(
operator|&
name|Data
operator|->
name|Values
argument_list|,
literal|0
argument_list|,
name|Mem
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|Mem
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|COMPILER_RT_VISIBILITY
name|void
name|__llvm_profile_instrument_target
parameter_list|(
name|uint64_t
name|TargetValue
parameter_list|,
name|void
modifier|*
name|Data
parameter_list|,
name|uint32_t
name|CounterIndex
parameter_list|)
block|{
name|__llvm_profile_data
modifier|*
name|PData
init|=
operator|(
name|__llvm_profile_data
operator|*
operator|)
name|Data
decl_stmt|;
if|if
condition|(
operator|!
name|PData
condition|)
return|return;
if|if
condition|(
operator|!
name|PData
operator|->
name|Values
condition|)
block|{
if|if
condition|(
operator|!
name|allocateValueProfileCounters
argument_list|(
name|PData
argument_list|)
condition|)
return|return;
block|}
name|ValueProfNode
modifier|*
modifier|*
name|ValueCounters
init|=
operator|(
name|ValueProfNode
operator|*
operator|*
operator|)
name|PData
operator|->
name|Values
decl_stmt|;
name|ValueProfNode
modifier|*
name|PrevVNode
init|=
name|NULL
decl_stmt|;
name|ValueProfNode
modifier|*
name|CurrentVNode
init|=
name|ValueCounters
index|[
name|CounterIndex
index|]
decl_stmt|;
name|uint8_t
name|VDataCount
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|CurrentVNode
condition|)
block|{
if|if
condition|(
name|TargetValue
operator|==
name|CurrentVNode
operator|->
name|VData
operator|.
name|Value
condition|)
block|{
name|CurrentVNode
operator|->
name|VData
operator|.
name|Count
operator|++
expr_stmt|;
return|return;
block|}
name|PrevVNode
operator|=
name|CurrentVNode
expr_stmt|;
name|CurrentVNode
operator|=
name|CurrentVNode
operator|->
name|Next
expr_stmt|;
operator|++
name|VDataCount
expr_stmt|;
block|}
if|if
condition|(
name|VDataCount
operator|>=
name|INSTR_PROF_MAX_NUM_VAL_PER_SITE
condition|)
return|return;
name|CurrentVNode
operator|=
operator|(
name|ValueProfNode
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ValueProfNode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|CurrentVNode
condition|)
return|return;
name|CurrentVNode
operator|->
name|VData
operator|.
name|Value
operator|=
name|TargetValue
expr_stmt|;
name|CurrentVNode
operator|->
name|VData
operator|.
name|Count
operator|++
expr_stmt|;
name|uint32_t
name|Success
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|ValueCounters
index|[
name|CounterIndex
index|]
condition|)
name|Success
operator|=
name|COMPILER_RT_BOOL_CMPXCHG
argument_list|(
operator|&
name|ValueCounters
index|[
name|CounterIndex
index|]
argument_list|,
literal|0
argument_list|,
name|CurrentVNode
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|PrevVNode
operator|&&
operator|!
name|PrevVNode
operator|->
name|Next
condition|)
name|Success
operator|=
name|COMPILER_RT_BOOL_CMPXCHG
argument_list|(
operator|&
operator|(
name|PrevVNode
operator|->
name|Next
operator|)
argument_list|,
literal|0
argument_list|,
name|CurrentVNode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Success
condition|)
block|{
name|free
argument_list|(
name|CurrentVNode
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
name|COMPILER_RT_VISIBILITY
name|ValueProfData
modifier|*
modifier|*
name|__llvm_profile_gather_value_data
parameter_list|(
name|uint64_t
modifier|*
name|ValueDataSize
parameter_list|)
block|{
name|size_t
name|S
init|=
literal|0
decl_stmt|;
name|__llvm_profile_data
modifier|*
name|I
decl_stmt|;
name|ValueProfData
modifier|*
modifier|*
name|ValueDataArray
decl_stmt|;
specifier|const
name|__llvm_profile_data
modifier|*
name|DataEnd
init|=
name|__llvm_profile_end_data
argument_list|()
decl_stmt|;
specifier|const
name|__llvm_profile_data
modifier|*
name|DataBegin
init|=
name|__llvm_profile_begin_data
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|ValueDataSize
condition|)
return|return
name|NULL
return|;
name|ValueDataArray
operator|=
operator|(
name|ValueProfData
operator|*
operator|*
operator|)
name|calloc
argument_list|(
name|DataEnd
operator|-
name|DataBegin
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ValueDataArray
condition|)
name|PROF_OOM_RETURN
argument_list|(
literal|"Failed to write value profile data "
argument_list|)
expr_stmt|;
comment|/*    * Compute the total Size of the buffer to hold ValueProfData    * structures for functions with value profile data.    */
for|for
control|(
name|I
operator|=
operator|(
name|__llvm_profile_data
operator|*
operator|)
name|DataBegin
init|;
name|I
operator|!=
name|DataEnd
condition|;
operator|++
name|I
control|)
block|{
name|ValueProfRuntimeRecord
name|R
decl_stmt|;
if|if
condition|(
name|initializeValueProfRuntimeRecord
argument_list|(
operator|&
name|R
argument_list|,
name|I
operator|->
name|NumValueSites
argument_list|,
name|I
operator|->
name|Values
argument_list|)
condition|)
name|PROF_OOM_RETURN
argument_list|(
literal|"Failed to write value profile data "
argument_list|)
expr_stmt|;
comment|/* Compute the size of ValueProfData from this runtime record.  */
if|if
condition|(
name|getNumValueKindsRT
argument_list|(
operator|&
name|R
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ValueProfData
modifier|*
name|VD
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|VS
init|=
name|getValueProfDataSizeRT
argument_list|(
operator|&
name|R
argument_list|)
decl_stmt|;
name|VD
operator|=
operator|(
name|ValueProfData
operator|*
operator|)
name|calloc
argument_list|(
name|VS
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|VD
condition|)
name|PROF_OOM_RETURN
argument_list|(
literal|"Failed to write value profile data "
argument_list|)
expr_stmt|;
name|serializeValueProfDataFromRT
argument_list|(
operator|&
name|R
argument_list|,
name|VD
argument_list|)
expr_stmt|;
name|ValueDataArray
index|[
name|I
operator|-
name|DataBegin
index|]
operator|=
name|VD
expr_stmt|;
name|S
operator|+=
name|VS
expr_stmt|;
block|}
name|finalizeValueProfRuntimeRecord
argument_list|(
operator|&
name|R
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|S
condition|)
block|{
name|free
argument_list|(
name|ValueDataArray
argument_list|)
expr_stmt|;
name|ValueDataArray
operator|=
name|NULL
expr_stmt|;
block|}
operator|*
name|ValueDataSize
operator|=
name|S
expr_stmt|;
return|return
name|ValueDataArray
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*===- InstrProfiling.c - Support library for PGO instrumentation ---------===*\ |* |*                     The LLVM Compiler Infrastructure |* |* This file is distributed under the University of Illinois Open Source |* License. See LICENSE.TXT for details. |* \*===----------------------------------------------------------------------===*/
end_comment

begin_include
include|#
directive|include
file|"InstrProfiling.h"
end_include

begin_include
include|#
directive|include
file|"InstrProfilingInternal.h"
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_define
define|#
directive|define
name|INSTR_PROF_VALUE_PROF_DATA
end_define

begin_include
include|#
directive|include
file|"InstrProfData.inc"
end_include

begin_function_decl
name|char
modifier|*
function_decl|(
modifier|*
name|GetEnvHook
function_decl|)
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
init|=
literal|0
function_decl|;
end_function_decl

begin_function
name|COMPILER_RT_VISIBILITY
name|uint64_t
name|__llvm_profile_get_magic
parameter_list|(
name|void
parameter_list|)
block|{
return|return
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
condition|?
operator|(
name|INSTR_PROF_RAW_MAGIC_64
operator|)
else|:
operator|(
name|INSTR_PROF_RAW_MAGIC_32
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Return the number of bytes needed to add to SizeInBytes to make it  *   the result a multiple of 8.  */
end_comment

begin_function
name|COMPILER_RT_VISIBILITY
name|uint8_t
name|__llvm_profile_get_num_padding_bytes
parameter_list|(
name|uint64_t
name|SizeInBytes
parameter_list|)
block|{
return|return
literal|7
operator|&
operator|(
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|-
name|SizeInBytes
operator|%
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|COMPILER_RT_VISIBILITY
name|uint64_t
name|__llvm_profile_get_version
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|INSTR_PROF_RAW_VERSION
return|;
block|}
end_function

begin_function
name|COMPILER_RT_VISIBILITY
name|void
name|__llvm_profile_reset_counters
parameter_list|(
name|void
parameter_list|)
block|{
name|uint64_t
modifier|*
name|I
init|=
name|__llvm_profile_begin_counters
argument_list|()
decl_stmt|;
name|uint64_t
modifier|*
name|E
init|=
name|__llvm_profile_end_counters
argument_list|()
decl_stmt|;
name|memset
argument_list|(
name|I
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|*
operator|(
name|E
operator|-
name|I
operator|)
argument_list|)
expr_stmt|;
specifier|const
name|__llvm_profile_data
modifier|*
name|DataBegin
init|=
name|__llvm_profile_begin_data
argument_list|()
decl_stmt|;
specifier|const
name|__llvm_profile_data
modifier|*
name|DataEnd
init|=
name|__llvm_profile_end_data
argument_list|()
decl_stmt|;
specifier|const
name|__llvm_profile_data
modifier|*
name|DI
decl_stmt|;
for|for
control|(
name|DI
operator|=
name|DataBegin
init|;
name|DI
operator|!=
name|DataEnd
condition|;
operator|++
name|DI
control|)
block|{
name|uint64_t
name|CurrentVSiteCount
init|=
literal|0
decl_stmt|;
name|uint32_t
name|VKI
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|DI
operator|->
name|Values
condition|)
continue|continue;
name|ValueProfNode
modifier|*
modifier|*
name|ValueCounters
init|=
operator|(
name|ValueProfNode
operator|*
operator|*
operator|)
name|DI
operator|->
name|Values
decl_stmt|;
for|for
control|(
name|VKI
operator|=
name|IPVK_First
init|;
name|VKI
operator|<=
name|IPVK_Last
condition|;
operator|++
name|VKI
control|)
name|CurrentVSiteCount
operator|+=
name|DI
operator|->
name|NumValueSites
index|[
name|VKI
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CurrentVSiteCount
condition|;
operator|++
name|i
control|)
block|{
name|ValueProfNode
modifier|*
name|CurrentVNode
init|=
name|ValueCounters
index|[
name|i
index|]
decl_stmt|;
while|while
condition|(
name|CurrentVNode
condition|)
block|{
name|CurrentVNode
operator|->
name|VData
operator|.
name|Count
operator|=
literal|0
expr_stmt|;
name|CurrentVNode
operator|=
name|CurrentVNode
operator|->
name|Next
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

end_unit


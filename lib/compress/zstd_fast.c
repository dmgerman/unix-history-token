begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2016-present, Yann Collet, Facebook, Inc.  * All rights reserved.  *  * This source code is licensed under both the BSD-style license (found in the  * LICENSE file in the root directory of this source tree) and the GPLv2 (found  * in the COPYING file in the root directory of this source tree).  * You may select, at your option, one of the above-listed licenses.  */
end_comment

begin_include
include|#
directive|include
file|"zstd_fast.h"
end_include

begin_function
name|void
name|ZSTD_fillHashTable
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|zc
parameter_list|,
specifier|const
name|void
modifier|*
name|end
parameter_list|,
specifier|const
name|U32
name|mls
parameter_list|)
block|{
name|U32
modifier|*
specifier|const
name|hashTable
init|=
name|zc
operator|->
name|hashTable
decl_stmt|;
name|U32
specifier|const
name|hBits
init|=
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|hashLog
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|base
init|=
name|zc
operator|->
name|base
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|ip
init|=
name|base
operator|+
name|zc
operator|->
name|nextToUpdate
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|iend
init|=
operator|(
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|end
operator|)
operator|-
name|HASH_READ_SIZE
decl_stmt|;
specifier|const
name|size_t
name|fastHashFillStep
init|=
literal|3
decl_stmt|;
while|while
condition|(
name|ip
operator|<=
name|iend
condition|)
block|{
name|hashTable
index|[
name|ZSTD_hashPtr
argument_list|(
name|ip
argument_list|,
name|hBits
argument_list|,
name|mls
argument_list|)
index|]
operator|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|-
name|base
argument_list|)
expr_stmt|;
name|ip
operator|+=
name|fastHashFillStep
expr_stmt|;
block|}
block|}
end_function

begin_function
name|FORCE_INLINE_TEMPLATE
name|size_t
name|ZSTD_compressBlock_fast_generic
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
specifier|const
name|U32
name|mls
parameter_list|)
block|{
name|U32
modifier|*
specifier|const
name|hashTable
init|=
name|cctx
operator|->
name|hashTable
decl_stmt|;
name|U32
specifier|const
name|hBits
init|=
name|cctx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|hashLog
decl_stmt|;
name|seqStore_t
modifier|*
name|seqStorePtr
init|=
operator|&
operator|(
name|cctx
operator|->
name|seqStore
operator|)
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|base
init|=
name|cctx
operator|->
name|base
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|istart
init|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|src
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|ip
init|=
name|istart
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|anchor
init|=
name|istart
decl_stmt|;
specifier|const
name|U32
name|lowestIndex
init|=
name|cctx
operator|->
name|dictLimit
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|lowest
init|=
name|base
operator|+
name|lowestIndex
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|iend
init|=
name|istart
operator|+
name|srcSize
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|ilimit
init|=
name|iend
operator|-
name|HASH_READ_SIZE
decl_stmt|;
name|U32
name|offset_1
init|=
name|seqStorePtr
operator|->
name|rep
index|[
literal|0
index|]
decl_stmt|,
name|offset_2
init|=
name|seqStorePtr
operator|->
name|rep
index|[
literal|1
index|]
decl_stmt|;
name|U32
name|offsetSaved
init|=
literal|0
decl_stmt|;
comment|/* init */
name|ip
operator|+=
operator|(
name|ip
operator|==
name|lowest
operator|)
expr_stmt|;
block|{
name|U32
specifier|const
name|maxRep
init|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|-
name|lowest
argument_list|)
decl_stmt|;
if|if
condition|(
name|offset_2
operator|>
name|maxRep
condition|)
name|offsetSaved
operator|=
name|offset_2
operator|,
name|offset_2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|offset_1
operator|>
name|maxRep
condition|)
name|offsetSaved
operator|=
name|offset_1
operator|,
name|offset_1
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Main Search Loop */
while|while
condition|(
name|ip
operator|<
name|ilimit
condition|)
block|{
comment|/*< instead of<=, because repcode check at (ip+1) */
name|size_t
name|mLength
decl_stmt|;
name|size_t
specifier|const
name|h
init|=
name|ZSTD_hashPtr
argument_list|(
name|ip
argument_list|,
name|hBits
argument_list|,
name|mls
argument_list|)
decl_stmt|;
name|U32
specifier|const
name|current
init|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|-
name|base
argument_list|)
decl_stmt|;
name|U32
specifier|const
name|matchIndex
init|=
name|hashTable
index|[
name|h
index|]
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|match
init|=
name|base
operator|+
name|matchIndex
decl_stmt|;
name|hashTable
index|[
name|h
index|]
operator|=
name|current
expr_stmt|;
comment|/* update hash table */
if|if
condition|(
operator|(
name|offset_1
operator|>
literal|0
operator|)
operator|&
operator|(
name|MEM_read32
argument_list|(
name|ip
operator|+
literal|1
operator|-
name|offset_1
argument_list|)
operator|==
name|MEM_read32
argument_list|(
name|ip
operator|+
literal|1
argument_list|)
operator|)
condition|)
block|{
name|mLength
operator|=
name|ZSTD_count
argument_list|(
name|ip
operator|+
literal|1
operator|+
literal|4
argument_list|,
name|ip
operator|+
literal|1
operator|+
literal|4
operator|-
name|offset_1
argument_list|,
name|iend
argument_list|)
operator|+
literal|4
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|ZSTD_storeSeq
argument_list|(
name|seqStorePtr
argument_list|,
name|ip
operator|-
name|anchor
argument_list|,
name|anchor
argument_list|,
literal|0
argument_list|,
name|mLength
operator|-
name|MINMATCH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|U32
name|offset
decl_stmt|;
if|if
condition|(
operator|(
name|matchIndex
operator|<=
name|lowestIndex
operator|)
operator|||
operator|(
name|MEM_read32
argument_list|(
name|match
argument_list|)
operator|!=
name|MEM_read32
argument_list|(
name|ip
argument_list|)
operator|)
condition|)
block|{
name|ip
operator|+=
operator|(
operator|(
name|ip
operator|-
name|anchor
operator|)
operator|>>
name|g_searchStrength
operator|)
operator|+
literal|1
expr_stmt|;
continue|continue;
block|}
name|mLength
operator|=
name|ZSTD_count
argument_list|(
name|ip
operator|+
literal|4
argument_list|,
name|match
operator|+
literal|4
argument_list|,
name|iend
argument_list|)
operator|+
literal|4
expr_stmt|;
name|offset
operator|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|-
name|match
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|ip
operator|>
name|anchor
operator|)
operator|&
operator|(
name|match
operator|>
name|lowest
operator|)
operator|)
operator|&&
operator|(
name|ip
index|[
operator|-
literal|1
index|]
operator|==
name|match
index|[
operator|-
literal|1
index|]
operator|)
condition|)
block|{
name|ip
operator|--
expr_stmt|;
name|match
operator|--
expr_stmt|;
name|mLength
operator|++
expr_stmt|;
block|}
comment|/* catch up */
name|offset_2
operator|=
name|offset_1
expr_stmt|;
name|offset_1
operator|=
name|offset
expr_stmt|;
name|ZSTD_storeSeq
argument_list|(
name|seqStorePtr
argument_list|,
name|ip
operator|-
name|anchor
argument_list|,
name|anchor
argument_list|,
name|offset
operator|+
name|ZSTD_REP_MOVE
argument_list|,
name|mLength
operator|-
name|MINMATCH
argument_list|)
expr_stmt|;
block|}
comment|/* match found */
name|ip
operator|+=
name|mLength
expr_stmt|;
name|anchor
operator|=
name|ip
expr_stmt|;
if|if
condition|(
name|ip
operator|<=
name|ilimit
condition|)
block|{
comment|/* Fill Table */
name|hashTable
index|[
name|ZSTD_hashPtr
argument_list|(
name|base
operator|+
name|current
operator|+
literal|2
argument_list|,
name|hBits
argument_list|,
name|mls
argument_list|)
index|]
operator|=
name|current
operator|+
literal|2
expr_stmt|;
comment|/* here because current+2 could be> iend-8 */
name|hashTable
index|[
name|ZSTD_hashPtr
argument_list|(
name|ip
operator|-
literal|2
argument_list|,
name|hBits
argument_list|,
name|mls
argument_list|)
index|]
operator|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|-
literal|2
operator|-
name|base
argument_list|)
expr_stmt|;
comment|/* check immediate repcode */
while|while
condition|(
operator|(
name|ip
operator|<=
name|ilimit
operator|)
operator|&&
operator|(
operator|(
name|offset_2
operator|>
literal|0
operator|)
operator|&
operator|(
name|MEM_read32
argument_list|(
name|ip
argument_list|)
operator|==
name|MEM_read32
argument_list|(
name|ip
operator|-
name|offset_2
argument_list|)
operator|)
operator|)
condition|)
block|{
comment|/* store sequence */
name|size_t
specifier|const
name|rLength
init|=
name|ZSTD_count
argument_list|(
name|ip
operator|+
literal|4
argument_list|,
name|ip
operator|+
literal|4
operator|-
name|offset_2
argument_list|,
name|iend
argument_list|)
operator|+
literal|4
decl_stmt|;
block|{
name|U32
specifier|const
name|tmpOff
init|=
name|offset_2
decl_stmt|;
name|offset_2
operator|=
name|offset_1
expr_stmt|;
name|offset_1
operator|=
name|tmpOff
expr_stmt|;
block|}
comment|/* swap offset_2<=> offset_1 */
name|hashTable
index|[
name|ZSTD_hashPtr
argument_list|(
name|ip
argument_list|,
name|hBits
argument_list|,
name|mls
argument_list|)
index|]
operator|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|-
name|base
argument_list|)
expr_stmt|;
name|ZSTD_storeSeq
argument_list|(
name|seqStorePtr
argument_list|,
literal|0
argument_list|,
name|anchor
argument_list|,
literal|0
argument_list|,
name|rLength
operator|-
name|MINMATCH
argument_list|)
expr_stmt|;
name|ip
operator|+=
name|rLength
expr_stmt|;
name|anchor
operator|=
name|ip
expr_stmt|;
continue|continue;
comment|/* faster when present ... (?) */
block|}
block|}
block|}
comment|/* save reps for next block */
name|seqStorePtr
operator|->
name|repToConfirm
index|[
literal|0
index|]
operator|=
name|offset_1
condition|?
name|offset_1
else|:
name|offsetSaved
expr_stmt|;
name|seqStorePtr
operator|->
name|repToConfirm
index|[
literal|1
index|]
operator|=
name|offset_2
condition|?
name|offset_2
else|:
name|offsetSaved
expr_stmt|;
comment|/* Return the last literals size */
return|return
name|iend
operator|-
name|anchor
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compressBlock_fast
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
specifier|const
name|U32
name|mls
init|=
name|ctx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|searchLength
decl_stmt|;
switch|switch
condition|(
name|mls
condition|)
block|{
default|default:
comment|/* includes case 3 */
case|case
literal|4
case|:
return|return
name|ZSTD_compressBlock_fast_generic
argument_list|(
name|ctx
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|4
argument_list|)
return|;
case|case
literal|5
case|:
return|return
name|ZSTD_compressBlock_fast_generic
argument_list|(
name|ctx
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|5
argument_list|)
return|;
case|case
literal|6
case|:
return|return
name|ZSTD_compressBlock_fast_generic
argument_list|(
name|ctx
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|6
argument_list|)
return|;
case|case
literal|7
case|:
return|return
name|ZSTD_compressBlock_fast_generic
argument_list|(
name|ctx
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|7
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_compressBlock_fast_extDict_generic
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
specifier|const
name|U32
name|mls
parameter_list|)
block|{
name|U32
modifier|*
name|hashTable
init|=
name|ctx
operator|->
name|hashTable
decl_stmt|;
specifier|const
name|U32
name|hBits
init|=
name|ctx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|hashLog
decl_stmt|;
name|seqStore_t
modifier|*
name|seqStorePtr
init|=
operator|&
operator|(
name|ctx
operator|->
name|seqStore
operator|)
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|base
init|=
name|ctx
operator|->
name|base
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|dictBase
init|=
name|ctx
operator|->
name|dictBase
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|istart
init|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|src
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|ip
init|=
name|istart
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|anchor
init|=
name|istart
decl_stmt|;
specifier|const
name|U32
name|lowestIndex
init|=
name|ctx
operator|->
name|lowLimit
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|dictStart
init|=
name|dictBase
operator|+
name|lowestIndex
decl_stmt|;
specifier|const
name|U32
name|dictLimit
init|=
name|ctx
operator|->
name|dictLimit
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|lowPrefixPtr
init|=
name|base
operator|+
name|dictLimit
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|dictEnd
init|=
name|dictBase
operator|+
name|dictLimit
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|iend
init|=
name|istart
operator|+
name|srcSize
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|ilimit
init|=
name|iend
operator|-
literal|8
decl_stmt|;
name|U32
name|offset_1
init|=
name|seqStorePtr
operator|->
name|rep
index|[
literal|0
index|]
decl_stmt|,
name|offset_2
init|=
name|seqStorePtr
operator|->
name|rep
index|[
literal|1
index|]
decl_stmt|;
comment|/* Search Loop */
while|while
condition|(
name|ip
operator|<
name|ilimit
condition|)
block|{
comment|/*< instead of<=, because (ip+1) */
specifier|const
name|size_t
name|h
init|=
name|ZSTD_hashPtr
argument_list|(
name|ip
argument_list|,
name|hBits
argument_list|,
name|mls
argument_list|)
decl_stmt|;
specifier|const
name|U32
name|matchIndex
init|=
name|hashTable
index|[
name|h
index|]
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|matchBase
init|=
name|matchIndex
operator|<
name|dictLimit
condition|?
name|dictBase
else|:
name|base
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|match
init|=
name|matchBase
operator|+
name|matchIndex
decl_stmt|;
specifier|const
name|U32
name|current
init|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|-
name|base
argument_list|)
decl_stmt|;
specifier|const
name|U32
name|repIndex
init|=
name|current
operator|+
literal|1
operator|-
name|offset_1
decl_stmt|;
comment|/* offset_1 expected<= current +1 */
specifier|const
name|BYTE
modifier|*
name|repBase
init|=
name|repIndex
operator|<
name|dictLimit
condition|?
name|dictBase
else|:
name|base
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|repMatch
init|=
name|repBase
operator|+
name|repIndex
decl_stmt|;
name|size_t
name|mLength
decl_stmt|;
name|hashTable
index|[
name|h
index|]
operator|=
name|current
expr_stmt|;
comment|/* update hash table */
if|if
condition|(
operator|(
operator|(
call|(
name|U32
call|)
argument_list|(
operator|(
name|dictLimit
operator|-
literal|1
operator|)
operator|-
name|repIndex
argument_list|)
operator|>=
literal|3
operator|)
comment|/* intentional underflow */
operator|&
operator|(
name|repIndex
operator|>
name|lowestIndex
operator|)
operator|)
operator|&&
operator|(
name|MEM_read32
argument_list|(
name|repMatch
argument_list|)
operator|==
name|MEM_read32
argument_list|(
name|ip
operator|+
literal|1
argument_list|)
operator|)
condition|)
block|{
specifier|const
name|BYTE
modifier|*
name|repMatchEnd
init|=
name|repIndex
operator|<
name|dictLimit
condition|?
name|dictEnd
else|:
name|iend
decl_stmt|;
name|mLength
operator|=
name|ZSTD_count_2segments
argument_list|(
name|ip
operator|+
literal|1
operator|+
literal|4
argument_list|,
name|repMatch
operator|+
literal|4
argument_list|,
name|iend
argument_list|,
name|repMatchEnd
argument_list|,
name|lowPrefixPtr
argument_list|)
operator|+
literal|4
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|ZSTD_storeSeq
argument_list|(
name|seqStorePtr
argument_list|,
name|ip
operator|-
name|anchor
argument_list|,
name|anchor
argument_list|,
literal|0
argument_list|,
name|mLength
operator|-
name|MINMATCH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|matchIndex
operator|<
name|lowestIndex
operator|)
operator|||
operator|(
name|MEM_read32
argument_list|(
name|match
argument_list|)
operator|!=
name|MEM_read32
argument_list|(
name|ip
argument_list|)
operator|)
condition|)
block|{
name|ip
operator|+=
operator|(
operator|(
name|ip
operator|-
name|anchor
operator|)
operator|>>
name|g_searchStrength
operator|)
operator|+
literal|1
expr_stmt|;
continue|continue;
block|}
block|{
specifier|const
name|BYTE
modifier|*
name|matchEnd
init|=
name|matchIndex
operator|<
name|dictLimit
condition|?
name|dictEnd
else|:
name|iend
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|lowMatchPtr
init|=
name|matchIndex
operator|<
name|dictLimit
condition|?
name|dictStart
else|:
name|lowPrefixPtr
decl_stmt|;
name|U32
name|offset
decl_stmt|;
name|mLength
operator|=
name|ZSTD_count_2segments
argument_list|(
name|ip
operator|+
literal|4
argument_list|,
name|match
operator|+
literal|4
argument_list|,
name|iend
argument_list|,
name|matchEnd
argument_list|,
name|lowPrefixPtr
argument_list|)
operator|+
literal|4
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|ip
operator|>
name|anchor
operator|)
operator|&
operator|(
name|match
operator|>
name|lowMatchPtr
operator|)
operator|)
operator|&&
operator|(
name|ip
index|[
operator|-
literal|1
index|]
operator|==
name|match
index|[
operator|-
literal|1
index|]
operator|)
condition|)
block|{
name|ip
operator|--
expr_stmt|;
name|match
operator|--
expr_stmt|;
name|mLength
operator|++
expr_stmt|;
block|}
comment|/* catch up */
name|offset
operator|=
name|current
operator|-
name|matchIndex
expr_stmt|;
name|offset_2
operator|=
name|offset_1
expr_stmt|;
name|offset_1
operator|=
name|offset
expr_stmt|;
name|ZSTD_storeSeq
argument_list|(
name|seqStorePtr
argument_list|,
name|ip
operator|-
name|anchor
argument_list|,
name|anchor
argument_list|,
name|offset
operator|+
name|ZSTD_REP_MOVE
argument_list|,
name|mLength
operator|-
name|MINMATCH
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* found a match : store it */
name|ip
operator|+=
name|mLength
expr_stmt|;
name|anchor
operator|=
name|ip
expr_stmt|;
if|if
condition|(
name|ip
operator|<=
name|ilimit
condition|)
block|{
comment|/* Fill Table */
name|hashTable
index|[
name|ZSTD_hashPtr
argument_list|(
name|base
operator|+
name|current
operator|+
literal|2
argument_list|,
name|hBits
argument_list|,
name|mls
argument_list|)
index|]
operator|=
name|current
operator|+
literal|2
expr_stmt|;
name|hashTable
index|[
name|ZSTD_hashPtr
argument_list|(
name|ip
operator|-
literal|2
argument_list|,
name|hBits
argument_list|,
name|mls
argument_list|)
index|]
operator|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|-
literal|2
operator|-
name|base
argument_list|)
expr_stmt|;
comment|/* check immediate repcode */
while|while
condition|(
name|ip
operator|<=
name|ilimit
condition|)
block|{
name|U32
specifier|const
name|current2
init|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|-
name|base
argument_list|)
decl_stmt|;
name|U32
specifier|const
name|repIndex2
init|=
name|current2
operator|-
name|offset_2
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|repMatch2
init|=
name|repIndex2
operator|<
name|dictLimit
condition|?
name|dictBase
operator|+
name|repIndex2
else|:
name|base
operator|+
name|repIndex2
decl_stmt|;
if|if
condition|(
operator|(
operator|(
call|(
name|U32
call|)
argument_list|(
operator|(
name|dictLimit
operator|-
literal|1
operator|)
operator|-
name|repIndex2
argument_list|)
operator|>=
literal|3
operator|)
operator|&
operator|(
name|repIndex2
operator|>
name|lowestIndex
operator|)
operator|)
comment|/* intentional overflow */
operator|&&
operator|(
name|MEM_read32
argument_list|(
name|repMatch2
argument_list|)
operator|==
name|MEM_read32
argument_list|(
name|ip
argument_list|)
operator|)
condition|)
block|{
specifier|const
name|BYTE
modifier|*
specifier|const
name|repEnd2
init|=
name|repIndex2
operator|<
name|dictLimit
condition|?
name|dictEnd
else|:
name|iend
decl_stmt|;
name|size_t
specifier|const
name|repLength2
init|=
name|ZSTD_count_2segments
argument_list|(
name|ip
operator|+
literal|4
argument_list|,
name|repMatch2
operator|+
literal|4
argument_list|,
name|iend
argument_list|,
name|repEnd2
argument_list|,
name|lowPrefixPtr
argument_list|)
operator|+
literal|4
decl_stmt|;
name|U32
name|tmpOffset
init|=
name|offset_2
decl_stmt|;
name|offset_2
operator|=
name|offset_1
expr_stmt|;
name|offset_1
operator|=
name|tmpOffset
expr_stmt|;
comment|/* swap offset_2<=> offset_1 */
name|ZSTD_storeSeq
argument_list|(
name|seqStorePtr
argument_list|,
literal|0
argument_list|,
name|anchor
argument_list|,
literal|0
argument_list|,
name|repLength2
operator|-
name|MINMATCH
argument_list|)
expr_stmt|;
name|hashTable
index|[
name|ZSTD_hashPtr
argument_list|(
name|ip
argument_list|,
name|hBits
argument_list|,
name|mls
argument_list|)
index|]
operator|=
name|current2
expr_stmt|;
name|ip
operator|+=
name|repLength2
expr_stmt|;
name|anchor
operator|=
name|ip
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
block|}
block|}
comment|/* save reps for next block */
name|seqStorePtr
operator|->
name|repToConfirm
index|[
literal|0
index|]
operator|=
name|offset_1
expr_stmt|;
name|seqStorePtr
operator|->
name|repToConfirm
index|[
literal|1
index|]
operator|=
name|offset_2
expr_stmt|;
comment|/* Return the last literals size */
return|return
name|iend
operator|-
name|anchor
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compressBlock_fast_extDict
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
name|U32
specifier|const
name|mls
init|=
name|ctx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|searchLength
decl_stmt|;
switch|switch
condition|(
name|mls
condition|)
block|{
default|default:
comment|/* includes case 3 */
case|case
literal|4
case|:
return|return
name|ZSTD_compressBlock_fast_extDict_generic
argument_list|(
name|ctx
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|4
argument_list|)
return|;
case|case
literal|5
case|:
return|return
name|ZSTD_compressBlock_fast_extDict_generic
argument_list|(
name|ctx
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|5
argument_list|)
return|;
case|case
literal|6
case|:
return|return
name|ZSTD_compressBlock_fast_extDict_generic
argument_list|(
name|ctx
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|6
argument_list|)
return|;
case|case
literal|7
case|:
return|return
name|ZSTD_compressBlock_fast_extDict_generic
argument_list|(
name|ctx
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|7
argument_list|)
return|;
block|}
block|}
end_function

end_unit


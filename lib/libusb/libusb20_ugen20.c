begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2008 Hans Petter Selasky. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<poll.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|"libusb20.h"
end_include

begin_include
include|#
directive|include
file|"libusb20_desc.h"
end_include

begin_include
include|#
directive|include
file|"libusb20_int.h"
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_ioctl.h>
end_include

begin_decl_stmt
specifier|static
name|libusb20_init_backend_t
name|ugen20_init_backend
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_open_device_t
name|ugen20_open_device
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_close_device_t
name|ugen20_close_device
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_get_backend_name_t
name|ugen20_get_backend_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_exit_backend_t
name|ugen20_exit_backend
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_dev_get_iface_desc_t
name|ugen20_dev_get_iface_desc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_dev_get_info_t
name|ugen20_dev_get_info
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_root_get_dev_quirk_t
name|ugen20_root_get_dev_quirk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_root_get_quirk_name_t
name|ugen20_root_get_quirk_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_root_add_dev_quirk_t
name|ugen20_root_add_dev_quirk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_root_remove_dev_quirk_t
name|ugen20_root_remove_dev_quirk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_root_set_template_t
name|ugen20_root_set_template
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_root_get_template_t
name|ugen20_root_get_template
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|struct
name|libusb20_backend_methods
name|libusb20_ugen20_backend
init|=
block|{
name|LIBUSB20_BACKEND
argument_list|(
argument|LIBUSB20_DECLARE
argument_list|,
argument|ugen20
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* USB device specific */
end_comment

begin_decl_stmt
specifier|static
name|libusb20_get_config_desc_full_t
name|ugen20_get_config_desc_full
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_get_config_index_t
name|ugen20_get_config_index
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_set_config_index_t
name|ugen20_set_config_index
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_set_alt_index_t
name|ugen20_set_alt_index
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_reset_device_t
name|ugen20_reset_device
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_check_connected_t
name|ugen20_check_connected
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_set_power_mode_t
name|ugen20_set_power_mode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_get_power_mode_t
name|ugen20_get_power_mode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_kernel_driver_active_t
name|ugen20_kernel_driver_active
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_detach_kernel_driver_t
name|ugen20_detach_kernel_driver
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_do_request_sync_t
name|ugen20_do_request_sync
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_process_t
name|ugen20_process
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* USB transfer specific */
end_comment

begin_decl_stmt
specifier|static
name|libusb20_tr_open_t
name|ugen20_tr_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_tr_close_t
name|ugen20_tr_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_tr_clear_stall_sync_t
name|ugen20_tr_clear_stall_sync
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_tr_submit_t
name|ugen20_tr_submit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libusb20_tr_cancel_async_t
name|ugen20_tr_cancel_async
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|libusb20_device_methods
name|libusb20_ugen20_device_methods
init|=
block|{
name|LIBUSB20_DEVICE
argument_list|(
argument|LIBUSB20_DECLARE
argument_list|,
argument|ugen20
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|ugen20_get_backend_name
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
literal|"FreeBSD UGEN 2.0"
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|ugen20_path_convert_one
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|pp
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|ptr
decl_stmt|;
name|uint32_t
name|temp
init|=
literal|0
decl_stmt|;
name|ptr
operator|=
operator|*
name|pp
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|ptr
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|ptr
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|temp
operator|*=
literal|10
expr_stmt|;
name|temp
operator|+=
operator|(
operator|*
name|ptr
operator|-
literal|'0'
operator|)
expr_stmt|;
if|if
condition|(
name|temp
operator|>=
literal|1000000
condition|)
block|{
comment|/* catch overflow early */
return|return
operator|(
literal|0
operator|-
literal|1
operator|)
return|;
block|}
name|ptr
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'.'
condition|)
block|{
comment|/* skip dot */
name|ptr
operator|++
expr_stmt|;
block|}
operator|*
name|pp
operator|=
name|ptr
expr_stmt|;
return|return
operator|(
name|temp
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_enumerate
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
specifier|const
name|char
modifier|*
name|id
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|tmp
init|=
name|id
decl_stmt|;
name|struct
name|usb_device_descriptor
name|ddesc
decl_stmt|;
name|struct
name|usb_device_info
name|devinfo
decl_stmt|;
name|uint32_t
name|plugtime
decl_stmt|;
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|int
name|f
decl_stmt|;
name|int
name|error
decl_stmt|;
name|pdev
operator|->
name|bus_number
operator|=
name|ugen20_path_convert_one
argument_list|(
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|pdev
operator|->
name|device_address
operator|=
name|ugen20_path_convert_one
argument_list|(
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"/dev/"
name|USB_GENERIC_NAME
literal|"%u.%u"
argument_list|,
name|pdev
operator|->
name|bus_number
argument_list|,
name|pdev
operator|->
name|device_address
argument_list|)
expr_stmt|;
name|f
operator|=
name|open
argument_list|(
name|buf
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|<
literal|0
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|f
argument_list|,
name|USB_GET_PLUGTIME
argument_list|,
operator|&
name|plugtime
argument_list|)
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_OTHER
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* store when the device was plugged */
name|pdev
operator|->
name|session_data
operator|.
name|plugtime
operator|=
name|plugtime
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|f
argument_list|,
name|USB_GET_DEVICE_DESC
argument_list|,
operator|&
name|ddesc
argument_list|)
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_OTHER
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|LIBUSB20_INIT
argument_list|(
name|LIBUSB20_DEVICE_DESC
argument_list|,
operator|&
operator|(
name|pdev
operator|->
name|ddesc
operator|)
argument_list|)
expr_stmt|;
name|libusb20_me_decode
argument_list|(
operator|&
name|ddesc
argument_list|,
sizeof|sizeof
argument_list|(
name|ddesc
argument_list|)
argument_list|,
operator|&
operator|(
name|pdev
operator|->
name|ddesc
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdev
operator|->
name|ddesc
operator|.
name|bNumConfigurations
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_OTHER
expr_stmt|;
goto|goto
name|done
goto|;
block|}
elseif|else
if|if
condition|(
name|pdev
operator|->
name|ddesc
operator|.
name|bNumConfigurations
operator|>=
literal|8
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_OTHER
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|f
argument_list|,
name|USB_GET_DEVICEINFO
argument_list|,
operator|&
name|devinfo
argument_list|)
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_OTHER
expr_stmt|;
goto|goto
name|done
goto|;
block|}
switch|switch
condition|(
name|devinfo
operator|.
name|udi_mode
condition|)
block|{
case|case
name|USB_MODE_DEVICE
case|:
name|pdev
operator|->
name|usb_mode
operator|=
name|LIBUSB20_MODE_DEVICE
expr_stmt|;
break|break;
default|default:
name|pdev
operator|->
name|usb_mode
operator|=
name|LIBUSB20_MODE_HOST
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|devinfo
operator|.
name|udi_speed
condition|)
block|{
case|case
name|USB_SPEED_LOW
case|:
name|pdev
operator|->
name|usb_speed
operator|=
name|LIBUSB20_SPEED_LOW
expr_stmt|;
break|break;
case|case
name|USB_SPEED_FULL
case|:
name|pdev
operator|->
name|usb_speed
operator|=
name|LIBUSB20_SPEED_FULL
expr_stmt|;
break|break;
case|case
name|USB_SPEED_HIGH
case|:
name|pdev
operator|->
name|usb_speed
operator|=
name|LIBUSB20_SPEED_HIGH
expr_stmt|;
break|break;
case|case
name|USB_SPEED_VARIABLE
case|:
name|pdev
operator|->
name|usb_speed
operator|=
name|LIBUSB20_SPEED_VARIABLE
expr_stmt|;
break|break;
case|case
name|USB_SPEED_SUPER
case|:
name|pdev
operator|->
name|usb_speed
operator|=
name|LIBUSB20_SPEED_SUPER
expr_stmt|;
break|break;
default|default:
name|pdev
operator|->
name|usb_speed
operator|=
name|LIBUSB20_SPEED_UNKNOWN
expr_stmt|;
break|break;
block|}
comment|/* generate a nice description for printout */
name|snprintf
argument_list|(
name|pdev
operator|->
name|usb_desc
argument_list|,
sizeof|sizeof
argument_list|(
name|pdev
operator|->
name|usb_desc
argument_list|)
argument_list|,
name|USB_GENERIC_NAME
literal|"%u.%u:<%s %s> at usbus%u"
argument_list|,
name|pdev
operator|->
name|bus_number
argument_list|,
name|pdev
operator|->
name|device_address
argument_list|,
name|devinfo
operator|.
name|udi_product
argument_list|,
name|devinfo
operator|.
name|udi_vendor
argument_list|,
name|pdev
operator|->
name|bus_number
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|ugen20_urd_state
block|{
name|struct
name|usb_read_dir
name|urd
decl_stmt|;
name|uint32_t
name|nparsed
decl_stmt|;
name|int
name|f
decl_stmt|;
name|uint8_t
modifier|*
name|ptr
decl_stmt|;
specifier|const
name|char
modifier|*
name|src
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|uint8_t
name|dummy_zero
index|[
literal|1
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ugen20_readdir
parameter_list|(
name|struct
name|ugen20_urd_state
modifier|*
name|st
parameter_list|)
block|{
empty_stmt|;
comment|/* style fix */
name|repeat
label|:
if|if
condition|(
name|st
operator|->
name|ptr
operator|==
name|NULL
condition|)
block|{
name|st
operator|->
name|urd
operator|.
name|urd_startentry
operator|+=
name|st
operator|->
name|nparsed
expr_stmt|;
name|st
operator|->
name|urd
operator|.
name|urd_data
operator|=
name|st
operator|->
name|buf
expr_stmt|;
name|st
operator|->
name|urd
operator|.
name|urd_maxlen
operator|=
sizeof|sizeof
argument_list|(
name|st
operator|->
name|buf
argument_list|)
expr_stmt|;
name|st
operator|->
name|nparsed
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|st
operator|->
name|f
argument_list|,
name|USB_READ_DIR
argument_list|,
operator|&
name|st
operator|->
name|urd
argument_list|)
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|st
operator|->
name|ptr
operator|=
name|st
operator|->
name|buf
expr_stmt|;
block|}
if|if
condition|(
name|st
operator|->
name|ptr
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|st
operator|->
name|nparsed
condition|)
block|{
name|st
operator|->
name|ptr
operator|=
name|NULL
expr_stmt|;
goto|goto
name|repeat
goto|;
block|}
else|else
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
block|}
name|st
operator|->
name|src
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|st
operator|->
name|ptr
operator|+
literal|1
operator|)
expr_stmt|;
name|st
operator|->
name|dst
operator|=
name|st
operator|->
name|src
operator|+
name|strlen
argument_list|(
name|st
operator|->
name|src
argument_list|)
operator|+
literal|1
expr_stmt|;
name|st
operator|->
name|ptr
operator|=
name|st
operator|->
name|ptr
operator|+
name|st
operator|->
name|ptr
index|[
literal|0
index|]
expr_stmt|;
name|st
operator|->
name|nparsed
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|st
operator|->
name|ptr
operator|<
name|st
operator|->
name|buf
operator|)
operator|||
operator|(
name|st
operator|->
name|ptr
operator|>
name|st
operator|->
name|dummy_zero
operator|)
condition|)
block|{
comment|/* invalid entry */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_init_backend
parameter_list|(
name|struct
name|libusb20_backend
modifier|*
name|pbe
parameter_list|)
block|{
name|struct
name|ugen20_urd_state
name|state
decl_stmt|;
name|struct
name|libusb20_device
modifier|*
name|pdev
decl_stmt|;
name|memset
argument_list|(
operator|&
name|state
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|state
operator|.
name|f
operator|=
name|open
argument_list|(
literal|"/dev/"
name|USB_DEVICE_NAME
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|.
name|f
operator|<
literal|0
condition|)
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
while|while
condition|(
name|ugen20_readdir
argument_list|(
operator|&
name|state
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|state
operator|.
name|src
index|[
literal|0
index|]
operator|!=
literal|'u'
operator|)
operator|||
operator|(
name|state
operator|.
name|src
index|[
literal|1
index|]
operator|!=
literal|'g'
operator|)
operator|||
operator|(
name|state
operator|.
name|src
index|[
literal|2
index|]
operator|!=
literal|'e'
operator|)
operator|||
operator|(
name|state
operator|.
name|src
index|[
literal|3
index|]
operator|!=
literal|'n'
operator|)
condition|)
block|{
continue|continue;
block|}
name|pdev
operator|=
name|libusb20_dev_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|pdev
operator|==
name|NULL
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|ugen20_enumerate
argument_list|(
name|pdev
argument_list|,
name|state
operator|.
name|src
operator|+
literal|4
argument_list|)
condition|)
block|{
name|libusb20_dev_free
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* put the device on the backend list */
name|libusb20_be_enqueue_device
argument_list|(
name|pbe
argument_list|,
name|pdev
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|state
operator|.
name|f
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|void
name|ugen20_tr_release
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|)
block|{
name|struct
name|usb_fs_uninit
name|fs_uninit
decl_stmt|;
if|if
condition|(
name|pdev
operator|->
name|nTransfer
operator|==
literal|0
condition|)
block|{
return|return;
block|}
comment|/* release all pending USB transfers */
if|if
condition|(
name|pdev
operator|->
name|privBeData
operator|!=
name|NULL
condition|)
block|{
name|memset
argument_list|(
operator|&
name|fs_uninit
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fs_uninit
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file
argument_list|,
name|USB_FS_UNINIT
argument_list|,
operator|&
name|fs_uninit
argument_list|)
condition|)
block|{
comment|/* ignore any errors of this kind */
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_tr_renew
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|)
block|{
name|struct
name|usb_fs_init
name|fs_init
decl_stmt|;
name|struct
name|usb_fs_endpoint
modifier|*
name|pfse
decl_stmt|;
name|int
name|error
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|uint16_t
name|nMaxTransfer
decl_stmt|;
name|nMaxTransfer
operator|=
name|pdev
operator|->
name|nTransfer
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|nMaxTransfer
operator|==
literal|0
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|size
operator|=
name|nMaxTransfer
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|pfse
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdev
operator|->
name|privBeData
operator|==
name|NULL
condition|)
block|{
name|pfse
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfse
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_NO_MEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|pdev
operator|->
name|privBeData
operator|=
name|pfse
expr_stmt|;
block|}
comment|/* reset endpoint data */
name|memset
argument_list|(
name|pdev
operator|->
name|privBeData
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|fs_init
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fs_init
argument_list|)
argument_list|)
expr_stmt|;
name|fs_init
operator|.
name|pEndpoints
operator|=
name|pdev
operator|->
name|privBeData
expr_stmt|;
name|fs_init
operator|.
name|ep_index_max
operator|=
name|nMaxTransfer
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file
argument_list|,
name|USB_FS_INIT
argument_list|,
operator|&
name|fs_init
argument_list|)
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_OTHER
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|done
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_open_device
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint16_t
name|nMaxTransfer
parameter_list|)
block|{
name|uint32_t
name|plugtime
decl_stmt|;
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|int
name|f
decl_stmt|;
name|int
name|g
decl_stmt|;
name|int
name|error
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"/dev/"
name|USB_GENERIC_NAME
literal|"%u.%u"
argument_list|,
name|pdev
operator|->
name|bus_number
argument_list|,
name|pdev
operator|->
name|device_address
argument_list|)
expr_stmt|;
comment|/* 	 * We need two file handles, one for the control endpoint and one 	 * for BULK, INTERRUPT and ISOCHRONOUS transactions due to optimised 	 * kernel locking. 	 */
name|g
operator|=
name|open
argument_list|(
name|buf
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|g
operator|<
literal|0
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_NO_DEVICE
operator|)
return|;
block|}
name|f
operator|=
name|open
argument_list|(
name|buf
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|<
literal|0
condition|)
block|{
name|close
argument_list|(
name|g
argument_list|)
expr_stmt|;
return|return
operator|(
name|LIBUSB20_ERROR_NO_DEVICE
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|f
argument_list|,
name|USB_GET_PLUGTIME
argument_list|,
operator|&
name|plugtime
argument_list|)
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_OTHER
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* check that the correct device is still plugged */
if|if
condition|(
name|pdev
operator|->
name|session_data
operator|.
name|plugtime
operator|!=
name|plugtime
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_NO_DEVICE
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* need to set this before "tr_renew()" */
name|pdev
operator|->
name|file
operator|=
name|f
expr_stmt|;
name|pdev
operator|->
name|file_ctrl
operator|=
name|g
expr_stmt|;
comment|/* renew all USB transfers */
name|error
operator|=
name|ugen20_tr_renew
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* set methods */
name|pdev
operator|->
name|methods
operator|=
operator|&
name|libusb20_ugen20_device_methods
expr_stmt|;
name|done
label|:
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|pdev
operator|->
name|privBeData
condition|)
block|{
comment|/* cleanup after "tr_renew()" */
name|free
argument_list|(
name|pdev
operator|->
name|privBeData
argument_list|)
expr_stmt|;
name|pdev
operator|->
name|privBeData
operator|=
name|NULL
expr_stmt|;
block|}
name|pdev
operator|->
name|file
operator|=
operator|-
literal|1
expr_stmt|;
name|pdev
operator|->
name|file_ctrl
operator|=
operator|-
literal|1
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|g
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_close_device
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|)
block|{
name|struct
name|usb_fs_uninit
name|fs_uninit
decl_stmt|;
if|if
condition|(
name|pdev
operator|->
name|privBeData
condition|)
block|{
name|memset
argument_list|(
operator|&
name|fs_uninit
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fs_uninit
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file
argument_list|,
name|USB_FS_UNINIT
argument_list|,
operator|&
name|fs_uninit
argument_list|)
condition|)
block|{
comment|/* ignore this error */
block|}
name|free
argument_list|(
name|pdev
operator|->
name|privBeData
argument_list|)
expr_stmt|;
block|}
name|pdev
operator|->
name|nTransfer
operator|=
literal|0
expr_stmt|;
name|pdev
operator|->
name|privBeData
operator|=
name|NULL
expr_stmt|;
name|close
argument_list|(
name|pdev
operator|->
name|file
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|)
expr_stmt|;
name|pdev
operator|->
name|file
operator|=
operator|-
literal|1
expr_stmt|;
name|pdev
operator|->
name|file_ctrl
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|void
name|ugen20_exit_backend
parameter_list|(
name|struct
name|libusb20_backend
modifier|*
name|pbe
parameter_list|)
block|{
return|return;
comment|/* nothing to do */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_get_config_desc_full
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
modifier|*
modifier|*
name|ppbuf
parameter_list|,
name|uint16_t
modifier|*
name|plen
parameter_list|,
name|uint8_t
name|cfg_index
parameter_list|)
block|{
name|struct
name|usb_gen_descriptor
name|gen_desc
decl_stmt|;
name|struct
name|usb_config_descriptor
name|cdesc
decl_stmt|;
name|uint8_t
modifier|*
name|ptr
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* make sure memory is initialised */
name|memset
argument_list|(
operator|&
name|cdesc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cdesc
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|gen_desc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gen_desc
argument_list|)
argument_list|)
expr_stmt|;
name|gen_desc
operator|.
name|ugd_data
operator|=
operator|&
name|cdesc
expr_stmt|;
name|gen_desc
operator|.
name|ugd_maxlen
operator|=
sizeof|sizeof
argument_list|(
name|cdesc
argument_list|)
expr_stmt|;
name|gen_desc
operator|.
name|ugd_config_index
operator|=
name|cfg_index
expr_stmt|;
name|error
operator|=
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_GET_FULL_DESC
argument_list|,
operator|&
name|gen_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
name|len
operator|=
name|UGETW
argument_list|(
name|cdesc
operator|.
name|wTotalLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
name|cdesc
argument_list|)
condition|)
block|{
comment|/* corrupt descriptor */
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
name|ptr
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptr
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_NO_MEM
operator|)
return|;
block|}
comment|/* make sure memory is initialised */
name|memset
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|gen_desc
operator|.
name|ugd_data
operator|=
name|ptr
expr_stmt|;
name|gen_desc
operator|.
name|ugd_maxlen
operator|=
name|len
expr_stmt|;
name|error
operator|=
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_GET_FULL_DESC
argument_list|,
operator|&
name|gen_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
comment|/* make sure that the device doesn't fool us */
name|memcpy
argument_list|(
name|ptr
argument_list|,
operator|&
name|cdesc
argument_list|,
sizeof|sizeof
argument_list|(
name|cdesc
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|ppbuf
operator|=
name|ptr
expr_stmt|;
operator|*
name|plen
operator|=
name|len
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_get_config_index
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
modifier|*
name|pindex
parameter_list|)
block|{
name|int
name|temp
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_GET_CONFIG
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
operator|*
name|pindex
operator|=
name|temp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_set_config_index
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
name|cfg_index
parameter_list|)
block|{
name|int
name|temp
init|=
name|cfg_index
decl_stmt|;
comment|/* release all active USB transfers */
name|ugen20_tr_release
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_SET_CONFIG
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
return|return
operator|(
name|ugen20_tr_renew
argument_list|(
name|pdev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_set_alt_index
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|,
name|uint8_t
name|alt_index
parameter_list|)
block|{
name|struct
name|usb_alt_interface
name|alt_iface
decl_stmt|;
name|memset
argument_list|(
operator|&
name|alt_iface
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|alt_iface
argument_list|)
argument_list|)
expr_stmt|;
name|alt_iface
operator|.
name|uai_interface_index
operator|=
name|iface_index
expr_stmt|;
name|alt_iface
operator|.
name|uai_alt_index
operator|=
name|alt_index
expr_stmt|;
comment|/* release all active USB transfers */
name|ugen20_tr_release
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_SET_ALTINTERFACE
argument_list|,
operator|&
name|alt_iface
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
return|return
operator|(
name|ugen20_tr_renew
argument_list|(
name|pdev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_reset_device
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|)
block|{
name|int
name|temp
init|=
literal|0
decl_stmt|;
comment|/* release all active USB transfers */
name|ugen20_tr_release
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_DEVICEENUMERATE
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
return|return
operator|(
name|ugen20_tr_renew
argument_list|(
name|pdev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_check_connected
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|)
block|{
name|uint32_t
name|plugtime
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_GET_PLUGTIME
argument_list|,
operator|&
name|plugtime
argument_list|)
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_NO_DEVICE
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|pdev
operator|->
name|session_data
operator|.
name|plugtime
operator|!=
name|plugtime
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_NO_DEVICE
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|done
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_set_power_mode
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
name|power_mode
parameter_list|)
block|{
name|int
name|temp
decl_stmt|;
switch|switch
condition|(
name|power_mode
condition|)
block|{
case|case
name|LIBUSB20_POWER_OFF
case|:
name|temp
operator|=
name|USB_POWER_MODE_OFF
expr_stmt|;
break|break;
case|case
name|LIBUSB20_POWER_ON
case|:
name|temp
operator|=
name|USB_POWER_MODE_ON
expr_stmt|;
break|break;
case|case
name|LIBUSB20_POWER_SAVE
case|:
name|temp
operator|=
name|USB_POWER_MODE_SAVE
expr_stmt|;
break|break;
case|case
name|LIBUSB20_POWER_SUSPEND
case|:
name|temp
operator|=
name|USB_POWER_MODE_SUSPEND
expr_stmt|;
break|break;
case|case
name|LIBUSB20_POWER_RESUME
case|:
name|temp
operator|=
name|USB_POWER_MODE_RESUME
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|LIBUSB20_ERROR_INVALID_PARAM
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_SET_POWER_MODE
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_get_power_mode
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
modifier|*
name|power_mode
parameter_list|)
block|{
name|int
name|temp
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_GET_POWER_MODE
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
switch|switch
condition|(
name|temp
condition|)
block|{
case|case
name|USB_POWER_MODE_OFF
case|:
name|temp
operator|=
name|LIBUSB20_POWER_OFF
expr_stmt|;
break|break;
case|case
name|USB_POWER_MODE_ON
case|:
name|temp
operator|=
name|LIBUSB20_POWER_ON
expr_stmt|;
break|break;
case|case
name|USB_POWER_MODE_SAVE
case|:
name|temp
operator|=
name|LIBUSB20_POWER_SAVE
expr_stmt|;
break|break;
case|case
name|USB_POWER_MODE_SUSPEND
case|:
name|temp
operator|=
name|LIBUSB20_POWER_SUSPEND
expr_stmt|;
break|break;
case|case
name|USB_POWER_MODE_RESUME
case|:
name|temp
operator|=
name|LIBUSB20_POWER_RESUME
expr_stmt|;
break|break;
default|default:
name|temp
operator|=
name|LIBUSB20_POWER_ON
expr_stmt|;
break|break;
block|}
operator|*
name|power_mode
operator|=
name|temp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_kernel_driver_active
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|)
block|{
name|int
name|temp
init|=
name|iface_index
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_IFACE_DRIVER_ACTIVE
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* kernel driver is active */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_detach_kernel_driver
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|)
block|{
name|int
name|temp
init|=
name|iface_index
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_IFACE_DRIVER_DETACH
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* kernel driver is active */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_do_request_sync
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|struct
name|LIBUSB20_CONTROL_SETUP_DECODED
modifier|*
name|setup
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|uint16_t
modifier|*
name|pactlen
parameter_list|,
name|uint32_t
name|timeout
parameter_list|,
name|uint8_t
name|flags
parameter_list|)
block|{
name|struct
name|usb_ctl_request
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ucr_data
operator|=
name|data
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|LIBUSB20_TRANSFER_SINGLE_SHORT_NOT_OK
operator|)
condition|)
block|{
name|req
operator|.
name|ucr_flags
operator||=
name|USB_SHORT_XFER_OK
expr_stmt|;
block|}
if|if
condition|(
name|libusb20_me_encode
argument_list|(
operator|&
name|req
operator|.
name|ucr_request
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ucr_request
argument_list|)
argument_list|,
name|setup
argument_list|)
condition|)
block|{
comment|/* ignore */
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file_ctrl
argument_list|,
name|USB_DO_REQUEST
argument_list|,
operator|&
name|req
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
if|if
condition|(
name|pactlen
condition|)
block|{
comment|/* get actual length */
operator|*
name|pactlen
operator|=
name|req
operator|.
name|ucr_actlen
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* kernel driver is active */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_process
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|)
block|{
name|struct
name|usb_fs_complete
name|temp
decl_stmt|;
name|struct
name|usb_fs_endpoint
modifier|*
name|fsep
decl_stmt|;
name|struct
name|libusb20_transfer
modifier|*
name|xfer
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file
argument_list|,
name|USB_FS_COMPLETE
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EBUSY
condition|)
block|{
break|break;
block|}
else|else
block|{
comment|/* device detached */
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
block|}
block|}
name|fsep
operator|=
name|pdev
operator|->
name|privBeData
expr_stmt|;
name|xfer
operator|=
name|pdev
operator|->
name|pTransfer
expr_stmt|;
name|fsep
operator|+=
name|temp
operator|.
name|ep_index
expr_stmt|;
name|xfer
operator|+=
name|temp
operator|.
name|ep_index
expr_stmt|;
comment|/* update transfer status */
if|if
condition|(
name|fsep
operator|->
name|status
operator|==
literal|0
condition|)
block|{
name|xfer
operator|->
name|aFrames
operator|=
name|fsep
operator|->
name|aFrames
expr_stmt|;
name|xfer
operator|->
name|timeComplete
operator|=
name|fsep
operator|->
name|isoc_time_complete
expr_stmt|;
name|xfer
operator|->
name|status
operator|=
name|LIBUSB20_TRANSFER_COMPLETED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fsep
operator|->
name|status
operator|==
name|USB_ERR_CANCELLED
condition|)
block|{
name|xfer
operator|->
name|aFrames
operator|=
literal|0
expr_stmt|;
name|xfer
operator|->
name|timeComplete
operator|=
literal|0
expr_stmt|;
name|xfer
operator|->
name|status
operator|=
name|LIBUSB20_TRANSFER_CANCELLED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fsep
operator|->
name|status
operator|==
name|USB_ERR_STALLED
condition|)
block|{
name|xfer
operator|->
name|aFrames
operator|=
literal|0
expr_stmt|;
name|xfer
operator|->
name|timeComplete
operator|=
literal|0
expr_stmt|;
name|xfer
operator|->
name|status
operator|=
name|LIBUSB20_TRANSFER_STALL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fsep
operator|->
name|status
operator|==
name|USB_ERR_TIMEOUT
condition|)
block|{
name|xfer
operator|->
name|aFrames
operator|=
literal|0
expr_stmt|;
name|xfer
operator|->
name|timeComplete
operator|=
literal|0
expr_stmt|;
name|xfer
operator|->
name|status
operator|=
name|LIBUSB20_TRANSFER_TIMED_OUT
expr_stmt|;
block|}
else|else
block|{
name|xfer
operator|->
name|aFrames
operator|=
literal|0
expr_stmt|;
name|xfer
operator|->
name|timeComplete
operator|=
literal|0
expr_stmt|;
name|xfer
operator|->
name|status
operator|=
name|LIBUSB20_TRANSFER_ERROR
expr_stmt|;
block|}
name|libusb20_tr_callback_wrapper
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* done */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_tr_open
parameter_list|(
name|struct
name|libusb20_transfer
modifier|*
name|xfer
parameter_list|,
name|uint32_t
name|MaxBufSize
parameter_list|,
name|uint32_t
name|MaxFrameCount
parameter_list|,
name|uint8_t
name|ep_no
parameter_list|)
block|{
name|struct
name|usb_fs_open
name|temp
decl_stmt|;
name|struct
name|usb_fs_endpoint
modifier|*
name|fsep
decl_stmt|;
name|memset
argument_list|(
operator|&
name|temp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
argument_list|)
expr_stmt|;
name|fsep
operator|=
name|xfer
operator|->
name|pdev
operator|->
name|privBeData
expr_stmt|;
name|fsep
operator|+=
name|xfer
operator|->
name|trIndex
expr_stmt|;
name|temp
operator|.
name|max_bufsize
operator|=
name|MaxBufSize
expr_stmt|;
name|temp
operator|.
name|max_frames
operator|=
name|MaxFrameCount
expr_stmt|;
name|temp
operator|.
name|ep_index
operator|=
name|xfer
operator|->
name|trIndex
expr_stmt|;
name|temp
operator|.
name|ep_no
operator|=
name|ep_no
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|xfer
operator|->
name|pdev
operator|->
name|file
argument_list|,
name|USB_FS_OPEN
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_INVALID_PARAM
operator|)
return|;
block|}
comment|/* maximums might have changed - update */
name|xfer
operator|->
name|maxFrames
operator|=
name|temp
operator|.
name|max_frames
expr_stmt|;
comment|/* "max_bufsize" should be multiple of "max_packet_length" */
name|xfer
operator|->
name|maxTotalLength
operator|=
name|temp
operator|.
name|max_bufsize
expr_stmt|;
name|xfer
operator|->
name|maxPacketLen
operator|=
name|temp
operator|.
name|max_packet_length
expr_stmt|;
comment|/* setup buffer and length lists */
name|fsep
operator|->
name|ppBuffer
operator|=
name|xfer
operator|->
name|ppBuffer
expr_stmt|;
comment|/* zero copy */
name|fsep
operator|->
name|pLength
operator|=
name|xfer
operator|->
name|pLength
expr_stmt|;
comment|/* zero copy */
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_tr_close
parameter_list|(
name|struct
name|libusb20_transfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|usb_fs_close
name|temp
decl_stmt|;
name|memset
argument_list|(
operator|&
name|temp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
argument_list|)
expr_stmt|;
name|temp
operator|.
name|ep_index
operator|=
name|xfer
operator|->
name|trIndex
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|xfer
operator|->
name|pdev
operator|->
name|file
argument_list|,
name|USB_FS_CLOSE
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_INVALID_PARAM
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_tr_clear_stall_sync
parameter_list|(
name|struct
name|libusb20_transfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|usb_fs_clear_stall_sync
name|temp
decl_stmt|;
name|memset
argument_list|(
operator|&
name|temp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* if the transfer is active, an error will be returned */
name|temp
operator|.
name|ep_index
operator|=
name|xfer
operator|->
name|trIndex
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|xfer
operator|->
name|pdev
operator|->
name|file
argument_list|,
name|USB_FS_CLEAR_STALL_SYNC
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_INVALID_PARAM
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|void
name|ugen20_tr_submit
parameter_list|(
name|struct
name|libusb20_transfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|usb_fs_start
name|temp
decl_stmt|;
name|struct
name|usb_fs_endpoint
modifier|*
name|fsep
decl_stmt|;
name|memset
argument_list|(
operator|&
name|temp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
argument_list|)
expr_stmt|;
name|fsep
operator|=
name|xfer
operator|->
name|pdev
operator|->
name|privBeData
expr_stmt|;
name|fsep
operator|+=
name|xfer
operator|->
name|trIndex
expr_stmt|;
name|fsep
operator|->
name|nFrames
operator|=
name|xfer
operator|->
name|nFrames
expr_stmt|;
name|fsep
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|xfer
operator|->
name|flags
operator|&
name|LIBUSB20_TRANSFER_SINGLE_SHORT_NOT_OK
operator|)
condition|)
block|{
name|fsep
operator|->
name|flags
operator||=
name|USB_FS_FLAG_SINGLE_SHORT_OK
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|xfer
operator|->
name|flags
operator|&
name|LIBUSB20_TRANSFER_MULTI_SHORT_NOT_OK
operator|)
condition|)
block|{
name|fsep
operator|->
name|flags
operator||=
name|USB_FS_FLAG_MULTI_SHORT_OK
expr_stmt|;
block|}
if|if
condition|(
name|xfer
operator|->
name|flags
operator|&
name|LIBUSB20_TRANSFER_FORCE_SHORT
condition|)
block|{
name|fsep
operator|->
name|flags
operator||=
name|USB_FS_FLAG_FORCE_SHORT
expr_stmt|;
block|}
if|if
condition|(
name|xfer
operator|->
name|flags
operator|&
name|LIBUSB20_TRANSFER_DO_CLEAR_STALL
condition|)
block|{
name|fsep
operator|->
name|flags
operator||=
name|USB_FS_FLAG_CLEAR_STALL
expr_stmt|;
block|}
comment|/* NOTE: The "fsep->timeout" variable is 16-bit. */
if|if
condition|(
name|xfer
operator|->
name|timeout
operator|>
literal|65535
condition|)
name|fsep
operator|->
name|timeout
operator|=
literal|65535
expr_stmt|;
else|else
name|fsep
operator|->
name|timeout
operator|=
name|xfer
operator|->
name|timeout
expr_stmt|;
name|temp
operator|.
name|ep_index
operator|=
name|xfer
operator|->
name|trIndex
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|xfer
operator|->
name|pdev
operator|->
name|file
argument_list|,
name|USB_FS_START
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
comment|/* ignore any errors - should never happen */
block|}
return|return;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|void
name|ugen20_tr_cancel_async
parameter_list|(
name|struct
name|libusb20_transfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|usb_fs_stop
name|temp
decl_stmt|;
name|memset
argument_list|(
operator|&
name|temp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
argument_list|)
expr_stmt|;
name|temp
operator|.
name|ep_index
operator|=
name|xfer
operator|->
name|trIndex
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|xfer
operator|->
name|pdev
operator|->
name|file
argument_list|,
name|USB_FS_STOP
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
block|{
comment|/* ignore any errors - should never happen */
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_be_ioctl
parameter_list|(
name|uint32_t
name|cmd
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|f
decl_stmt|;
name|int
name|error
decl_stmt|;
name|f
operator|=
name|open
argument_list|(
literal|"/dev/"
name|USB_DEVICE_NAME
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|<
literal|0
condition|)
return|return
operator|(
name|LIBUSB20_ERROR_OTHER
operator|)
return|;
name|error
operator|=
name|ioctl
argument_list|(
name|f
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EPERM
condition|)
block|{
name|error
operator|=
name|LIBUSB20_ERROR_ACCESS
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|LIBUSB20_ERROR_OTHER
expr_stmt|;
block|}
block|}
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_dev_get_iface_desc
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|uint8_t
name|len
parameter_list|)
block|{
name|struct
name|usb_gen_descriptor
name|ugd
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ugd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ugd
argument_list|)
argument_list|)
expr_stmt|;
name|ugd
operator|.
name|ugd_data
operator|=
name|buf
expr_stmt|;
name|ugd
operator|.
name|ugd_maxlen
operator|=
name|len
expr_stmt|;
name|ugd
operator|.
name|ugd_iface_index
operator|=
name|iface_index
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file
argument_list|,
name|USB_GET_IFACE_DRIVER
argument_list|,
operator|&
name|ugd
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_INVALID_PARAM
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_dev_get_info
parameter_list|(
name|struct
name|libusb20_device
modifier|*
name|pdev
parameter_list|,
name|struct
name|usb_device_info
modifier|*
name|pinfo
parameter_list|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|pdev
operator|->
name|file
argument_list|,
name|USB_GET_DEVICEINFO
argument_list|,
name|pinfo
argument_list|)
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_INVALID_PARAM
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_root_get_dev_quirk
parameter_list|(
name|struct
name|libusb20_backend
modifier|*
name|pbe
parameter_list|,
name|uint16_t
name|quirk_index
parameter_list|,
name|struct
name|libusb20_quirk
modifier|*
name|pq
parameter_list|)
block|{
name|struct
name|usb_gen_quirk
name|q
decl_stmt|;
name|int
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|q
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|q
argument_list|)
argument_list|)
expr_stmt|;
name|q
operator|.
name|index
operator|=
name|quirk_index
expr_stmt|;
name|error
operator|=
name|ugen20_be_ioctl
argument_list|(
name|USB_DEV_QUIRK_GET
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINVAL
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_NOT_FOUND
operator|)
return|;
block|}
block|}
else|else
block|{
name|pq
operator|->
name|vid
operator|=
name|q
operator|.
name|vid
expr_stmt|;
name|pq
operator|->
name|pid
operator|=
name|q
operator|.
name|pid
expr_stmt|;
name|pq
operator|->
name|bcdDeviceLow
operator|=
name|q
operator|.
name|bcdDeviceLow
expr_stmt|;
name|pq
operator|->
name|bcdDeviceHigh
operator|=
name|q
operator|.
name|bcdDeviceHigh
expr_stmt|;
name|strlcpy
argument_list|(
name|pq
operator|->
name|quirkname
argument_list|,
name|q
operator|.
name|quirkname
argument_list|,
sizeof|sizeof
argument_list|(
name|pq
operator|->
name|quirkname
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_root_get_quirk_name
parameter_list|(
name|struct
name|libusb20_backend
modifier|*
name|pbe
parameter_list|,
name|uint16_t
name|quirk_index
parameter_list|,
name|struct
name|libusb20_quirk
modifier|*
name|pq
parameter_list|)
block|{
name|struct
name|usb_gen_quirk
name|q
decl_stmt|;
name|int
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|q
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|q
argument_list|)
argument_list|)
expr_stmt|;
name|q
operator|.
name|index
operator|=
name|quirk_index
expr_stmt|;
name|error
operator|=
name|ugen20_be_ioctl
argument_list|(
name|USB_QUIRK_NAME_GET
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINVAL
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_NOT_FOUND
operator|)
return|;
block|}
block|}
else|else
block|{
name|strlcpy
argument_list|(
name|pq
operator|->
name|quirkname
argument_list|,
name|q
operator|.
name|quirkname
argument_list|,
sizeof|sizeof
argument_list|(
name|pq
operator|->
name|quirkname
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_root_add_dev_quirk
parameter_list|(
name|struct
name|libusb20_backend
modifier|*
name|pbe
parameter_list|,
name|struct
name|libusb20_quirk
modifier|*
name|pq
parameter_list|)
block|{
name|struct
name|usb_gen_quirk
name|q
decl_stmt|;
name|int
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|q
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|q
argument_list|)
argument_list|)
expr_stmt|;
name|q
operator|.
name|vid
operator|=
name|pq
operator|->
name|vid
expr_stmt|;
name|q
operator|.
name|pid
operator|=
name|pq
operator|->
name|pid
expr_stmt|;
name|q
operator|.
name|bcdDeviceLow
operator|=
name|pq
operator|->
name|bcdDeviceLow
expr_stmt|;
name|q
operator|.
name|bcdDeviceHigh
operator|=
name|pq
operator|->
name|bcdDeviceHigh
expr_stmt|;
name|strlcpy
argument_list|(
name|q
operator|.
name|quirkname
argument_list|,
name|pq
operator|->
name|quirkname
argument_list|,
sizeof|sizeof
argument_list|(
name|q
operator|.
name|quirkname
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ugen20_be_ioctl
argument_list|(
name|USB_DEV_QUIRK_ADD
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOMEM
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_NO_MEM
operator|)
return|;
block|}
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_root_remove_dev_quirk
parameter_list|(
name|struct
name|libusb20_backend
modifier|*
name|pbe
parameter_list|,
name|struct
name|libusb20_quirk
modifier|*
name|pq
parameter_list|)
block|{
name|struct
name|usb_gen_quirk
name|q
decl_stmt|;
name|int
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|q
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|q
argument_list|)
argument_list|)
expr_stmt|;
name|q
operator|.
name|vid
operator|=
name|pq
operator|->
name|vid
expr_stmt|;
name|q
operator|.
name|pid
operator|=
name|pq
operator|->
name|pid
expr_stmt|;
name|q
operator|.
name|bcdDeviceLow
operator|=
name|pq
operator|->
name|bcdDeviceLow
expr_stmt|;
name|q
operator|.
name|bcdDeviceHigh
operator|=
name|pq
operator|->
name|bcdDeviceHigh
expr_stmt|;
name|strlcpy
argument_list|(
name|q
operator|.
name|quirkname
argument_list|,
name|pq
operator|->
name|quirkname
argument_list|,
sizeof|sizeof
argument_list|(
name|q
operator|.
name|quirkname
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ugen20_be_ioctl
argument_list|(
name|USB_DEV_QUIRK_REMOVE
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINVAL
condition|)
block|{
return|return
operator|(
name|LIBUSB20_ERROR_NOT_FOUND
operator|)
return|;
block|}
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_root_set_template
parameter_list|(
name|struct
name|libusb20_backend
modifier|*
name|pbe
parameter_list|,
name|int
name|temp
parameter_list|)
block|{
return|return
operator|(
name|ugen20_be_ioctl
argument_list|(
name|USB_SET_TEMPLATE
argument_list|,
operator|&
name|temp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen20_root_get_template
parameter_list|(
name|struct
name|libusb20_backend
modifier|*
name|pbe
parameter_list|,
name|int
modifier|*
name|ptemp
parameter_list|)
block|{
return|return
operator|(
name|ugen20_be_ioctl
argument_list|(
name|USB_GET_TEMPLATE
argument_list|,
name|ptemp
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


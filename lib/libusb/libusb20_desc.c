begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2008 Hans Petter Selasky. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<poll.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|"libusb20.h"
end_include

begin_include
include|#
directive|include
file|"libusb20_desc.h"
end_include

begin_include
include|#
directive|include
file|"libusb20_int.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|libusb20_me_encode_empty
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dummy */
end_comment

begin_expr_stmt
name|LIBUSB20_MAKE_STRUCT_FORMAT
argument_list|(
name|LIBUSB20_DEVICE_DESC
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|LIBUSB20_MAKE_STRUCT_FORMAT
argument_list|(
name|LIBUSB20_ENDPOINT_DESC
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|LIBUSB20_MAKE_STRUCT_FORMAT
argument_list|(
name|LIBUSB20_INTERFACE_DESC
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|LIBUSB20_MAKE_STRUCT_FORMAT
argument_list|(
name|LIBUSB20_CONFIG_DESC
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|LIBUSB20_MAKE_STRUCT_FORMAT
argument_list|(
name|LIBUSB20_CONTROL_SETUP
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*------------------------------------------------------------------------*  *	libusb20_parse_config_desc  *  * Return values:  * NULL: Out of memory.  * Else: A valid config structure pointer which must be passed to "free()"  *------------------------------------------------------------------------*/
end_comment

begin_function
name|struct
name|libusb20_config
modifier|*
name|libusb20_parse_config_desc
parameter_list|(
specifier|const
name|void
modifier|*
name|config_desc
parameter_list|)
block|{
name|struct
name|libusb20_config
modifier|*
name|lub_config
decl_stmt|;
name|struct
name|libusb20_interface
modifier|*
name|lub_interface
decl_stmt|;
name|struct
name|libusb20_interface
modifier|*
name|lub_alt_interface
decl_stmt|;
name|struct
name|libusb20_interface
modifier|*
name|last_if
decl_stmt|;
name|struct
name|libusb20_endpoint
modifier|*
name|lub_endpoint
decl_stmt|;
name|struct
name|libusb20_endpoint
modifier|*
name|last_ep
decl_stmt|;
name|struct
name|libusb20_me_struct
name|pcdesc
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|ptr
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|uint16_t
name|niface_no_alt
decl_stmt|;
name|uint16_t
name|niface
decl_stmt|;
name|uint16_t
name|nendpoint
decl_stmt|;
name|uint8_t
name|iface_no
decl_stmt|;
name|ptr
operator|=
name|config_desc
expr_stmt|;
if|if
condition|(
name|ptr
index|[
literal|1
index|]
operator|!=
name|LIBUSB20_DT_CONFIG
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* not config descriptor */
block|}
comment|/* 	 * The first "bInterfaceNumber" should never have the value 0xff. 	 * Then it is corrupt. 	 */
name|niface_no_alt
operator|=
literal|0
expr_stmt|;
name|nendpoint
operator|=
literal|0
expr_stmt|;
name|niface
operator|=
literal|0
expr_stmt|;
name|iface_no
operator|=
literal|0
operator|-
literal|1
expr_stmt|;
name|ptr
operator|=
name|NULL
expr_stmt|;
comment|/* get "wTotalLength" and setup "pcdesc" */
name|pcdesc
operator|.
name|ptr
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|config_desc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pcdesc
operator|.
name|len
operator|=
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|config_desc
operator|)
index|[
literal|2
index|]
operator||
operator|(
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|config_desc
operator|)
index|[
literal|3
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
name|pcdesc
operator|.
name|type
operator|=
name|LIBUSB20_ME_IS_RAW
expr_stmt|;
comment|/* descriptor pre-scan */
while|while
condition|(
operator|(
name|ptr
operator|=
name|libusb20_desc_foreach
argument_list|(
operator|&
name|pcdesc
argument_list|,
name|ptr
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|ptr
index|[
literal|1
index|]
operator|==
name|LIBUSB20_DT_ENDPOINT
condition|)
block|{
name|nendpoint
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ptr
index|[
literal|1
index|]
operator|==
name|LIBUSB20_DT_INTERFACE
operator|)
operator|&&
operator|(
name|ptr
index|[
literal|0
index|]
operator|>=
literal|4
operator|)
condition|)
block|{
name|niface
operator|++
expr_stmt|;
comment|/* check "bInterfaceNumber" */
if|if
condition|(
name|ptr
index|[
literal|2
index|]
operator|!=
name|iface_no
condition|)
block|{
name|iface_no
operator|=
name|ptr
index|[
literal|2
index|]
expr_stmt|;
name|niface_no_alt
operator|++
expr_stmt|;
block|}
block|}
block|}
comment|/* sanity checking */
if|if
condition|(
name|niface
operator|>=
literal|256
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* corrupt */
block|}
if|if
condition|(
name|nendpoint
operator|>=
literal|256
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* corrupt */
block|}
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|lub_config
argument_list|)
operator|+
operator|(
name|niface
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|lub_interface
argument_list|)
operator|)
operator|+
operator|(
name|nendpoint
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|lub_endpoint
argument_list|)
operator|)
operator|+
name|pcdesc
operator|.
name|len
expr_stmt|;
name|lub_config
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|lub_config
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* out of memory */
block|}
comment|/* make sure memory is initialised */
name|memset
argument_list|(
name|lub_config
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|lub_interface
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|lub_config
operator|+
literal|1
operator|)
expr_stmt|;
name|lub_alt_interface
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|lub_interface
operator|+
name|niface_no_alt
operator|)
expr_stmt|;
name|lub_endpoint
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|lub_interface
operator|+
name|niface
operator|)
expr_stmt|;
comment|/* 	 * Make a copy of the config descriptor, so that the caller can free 	 * the inital config descriptor pointer! 	 */
name|ptr
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|lub_endpoint
operator|+
name|nendpoint
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|LIBUSB20_ADD_BYTES
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|)
argument_list|,
name|config_desc
argument_list|,
name|pcdesc
operator|.
name|len
argument_list|)
expr_stmt|;
name|pcdesc
operator|.
name|ptr
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|config_desc
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* init config structure */
name|ptr
operator|=
name|config_desc
expr_stmt|;
name|LIBUSB20_INIT
argument_list|(
name|LIBUSB20_CONFIG_DESC
argument_list|,
operator|&
name|lub_config
operator|->
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|libusb20_me_decode
argument_list|(
name|ptr
argument_list|,
name|ptr
index|[
literal|0
index|]
argument_list|,
operator|&
name|lub_config
operator|->
name|desc
argument_list|)
condition|)
block|{
comment|/* ignore */
block|}
name|lub_config
operator|->
name|num_interface
operator|=
literal|0
expr_stmt|;
name|lub_config
operator|->
name|interface
operator|=
name|lub_interface
expr_stmt|;
name|lub_config
operator|->
name|extra
operator|.
name|ptr
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|ptr
argument_list|,
name|ptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|lub_config
operator|->
name|extra
operator|.
name|len
operator|=
operator|-
name|ptr
index|[
literal|0
index|]
expr_stmt|;
name|lub_config
operator|->
name|extra
operator|.
name|type
operator|=
name|LIBUSB20_ME_IS_RAW
expr_stmt|;
comment|/* reset states */
name|niface
operator|=
literal|0
expr_stmt|;
name|iface_no
operator|=
literal|0
operator|-
literal|1
expr_stmt|;
name|ptr
operator|=
name|NULL
expr_stmt|;
name|lub_interface
operator|--
expr_stmt|;
name|lub_endpoint
operator|--
expr_stmt|;
name|last_if
operator|=
name|NULL
expr_stmt|;
name|last_ep
operator|=
name|NULL
expr_stmt|;
comment|/* descriptor pre-scan */
while|while
condition|(
operator|(
name|ptr
operator|=
name|libusb20_desc_foreach
argument_list|(
operator|&
name|pcdesc
argument_list|,
name|ptr
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|ptr
index|[
literal|1
index|]
operator|==
name|LIBUSB20_DT_ENDPOINT
condition|)
block|{
if|if
condition|(
name|last_if
condition|)
block|{
name|lub_endpoint
operator|++
expr_stmt|;
name|last_ep
operator|=
name|lub_endpoint
expr_stmt|;
name|last_if
operator|->
name|num_endpoints
operator|++
expr_stmt|;
name|LIBUSB20_INIT
argument_list|(
name|LIBUSB20_ENDPOINT_DESC
argument_list|,
operator|&
name|last_ep
operator|->
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|libusb20_me_decode
argument_list|(
name|ptr
argument_list|,
name|ptr
index|[
literal|0
index|]
argument_list|,
operator|&
name|last_ep
operator|->
name|desc
argument_list|)
condition|)
block|{
comment|/* ignore */
block|}
name|last_ep
operator|->
name|extra
operator|.
name|ptr
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|ptr
argument_list|,
name|ptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|last_ep
operator|->
name|extra
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|last_ep
operator|->
name|extra
operator|.
name|type
operator|=
name|LIBUSB20_ME_IS_RAW
expr_stmt|;
block|}
else|else
block|{
name|lub_config
operator|->
name|extra
operator|.
name|len
operator|+=
name|ptr
index|[
literal|0
index|]
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ptr
index|[
literal|1
index|]
operator|==
name|LIBUSB20_DT_INTERFACE
operator|)
operator|&&
operator|(
name|ptr
index|[
literal|0
index|]
operator|>=
literal|4
operator|)
condition|)
block|{
if|if
condition|(
name|ptr
index|[
literal|2
index|]
operator|!=
name|iface_no
condition|)
block|{
comment|/* new interface */
name|iface_no
operator|=
name|ptr
index|[
literal|2
index|]
expr_stmt|;
name|lub_interface
operator|++
expr_stmt|;
name|lub_config
operator|->
name|num_interface
operator|++
expr_stmt|;
name|last_if
operator|=
name|lub_interface
expr_stmt|;
name|niface
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/* one more alternate setting */
name|lub_interface
operator|->
name|num_altsetting
operator|++
expr_stmt|;
name|last_if
operator|=
name|lub_alt_interface
expr_stmt|;
name|lub_alt_interface
operator|++
expr_stmt|;
block|}
name|LIBUSB20_INIT
argument_list|(
name|LIBUSB20_INTERFACE_DESC
argument_list|,
operator|&
name|last_if
operator|->
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|libusb20_me_decode
argument_list|(
name|ptr
argument_list|,
name|ptr
index|[
literal|0
index|]
argument_list|,
operator|&
name|last_if
operator|->
name|desc
argument_list|)
condition|)
block|{
comment|/* ignore */
block|}
comment|/* 			 * Sometimes USB devices have corrupt interface 			 * descriptors and we need to overwrite the provided 			 * interface number! 			 */
name|last_if
operator|->
name|desc
operator|.
name|bInterfaceNumber
operator|=
name|niface
operator|-
literal|1
expr_stmt|;
name|last_if
operator|->
name|extra
operator|.
name|ptr
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|ptr
argument_list|,
name|ptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|last_if
operator|->
name|extra
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|last_if
operator|->
name|extra
operator|.
name|type
operator|=
name|LIBUSB20_ME_IS_RAW
expr_stmt|;
name|last_if
operator|->
name|endpoints
operator|=
name|lub_endpoint
operator|+
literal|1
expr_stmt|;
name|last_if
operator|->
name|altsetting
operator|=
name|lub_alt_interface
expr_stmt|;
name|last_if
operator|->
name|num_altsetting
operator|=
literal|0
expr_stmt|;
name|last_if
operator|->
name|num_endpoints
operator|=
literal|0
expr_stmt|;
name|last_ep
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* unknown descriptor */
if|if
condition|(
name|last_if
condition|)
block|{
if|if
condition|(
name|last_ep
condition|)
block|{
name|last_ep
operator|->
name|extra
operator|.
name|len
operator|+=
name|ptr
index|[
literal|0
index|]
expr_stmt|;
block|}
else|else
block|{
name|last_if
operator|->
name|extra
operator|.
name|len
operator|+=
name|ptr
index|[
literal|0
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
name|lub_config
operator|->
name|extra
operator|.
name|len
operator|+=
name|ptr
index|[
literal|0
index|]
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
name|lub_config
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	libusb20_desc_foreach  *  * Safe traversal of USB descriptors.  *  * Return values:  * NULL: End of descriptors  * Else: Pointer to next descriptor  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|const
name|uint8_t
modifier|*
name|libusb20_desc_foreach
parameter_list|(
specifier|const
name|struct
name|libusb20_me_struct
modifier|*
name|pdesc
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|psubdesc
parameter_list|)
block|{
specifier|const
name|uint8_t
modifier|*
name|start
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|end
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|desc_next
decl_stmt|;
comment|/* be NULL safe */
if|if
condition|(
name|pdesc
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|start
operator|=
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|pdesc
operator|->
name|ptr
expr_stmt|;
name|end
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|start
argument_list|,
name|pdesc
operator|->
name|len
argument_list|)
expr_stmt|;
comment|/* get start of next descriptor */
if|if
condition|(
name|psubdesc
operator|==
name|NULL
condition|)
name|psubdesc
operator|=
name|start
expr_stmt|;
else|else
name|psubdesc
operator|=
name|psubdesc
operator|+
name|psubdesc
index|[
literal|0
index|]
expr_stmt|;
comment|/* check that the next USB descriptor is within the range */
if|if
condition|(
operator|(
name|psubdesc
operator|<
name|start
operator|)
operator|||
operator|(
name|psubdesc
operator|>=
name|end
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* out of range, or EOD */
comment|/* check start of the second next USB descriptor, if any */
name|desc_next
operator|=
name|psubdesc
operator|+
name|psubdesc
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|desc_next
operator|<
name|start
operator|)
operator|||
operator|(
name|desc_next
operator|>
name|end
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* out of range */
comment|/* check minimum descriptor length */
if|if
condition|(
name|psubdesc
index|[
literal|0
index|]
operator|<
literal|3
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* too short descriptor */
return|return
operator|(
name|psubdesc
operator|)
return|;
comment|/* return start of next descriptor */
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	libusb20_me_get_1 - safety wrapper to read out one byte  *------------------------------------------------------------------------*/
end_comment

begin_function
name|uint8_t
name|libusb20_me_get_1
parameter_list|(
specifier|const
name|struct
name|libusb20_me_struct
modifier|*
name|ie
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
if|if
condition|(
name|offset
operator|<
name|ie
operator|->
name|len
condition|)
block|{
return|return
operator|(
operator|*
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|LIBUSB20_ADD_BYTES
argument_list|(
name|ie
operator|->
name|ptr
argument_list|,
name|offset
argument_list|)
operator|)
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	libusb20_me_get_2 - safety wrapper to read out one word  *------------------------------------------------------------------------*/
end_comment

begin_function
name|uint16_t
name|libusb20_me_get_2
parameter_list|(
specifier|const
name|struct
name|libusb20_me_struct
modifier|*
name|ie
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
return|return
operator|(
name|libusb20_me_get_1
argument_list|(
name|ie
argument_list|,
name|offset
argument_list|)
operator||
operator|(
name|libusb20_me_get_1
argument_list|(
name|ie
argument_list|,
name|offset
operator|+
literal|1
argument_list|)
operator|<<
literal|8
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	libusb20_me_encode - encode a message structure  *  * Description of parameters:  * "len" - maximum length of output buffer  * "ptr" - pointer to output buffer. If NULL, no data will be written  * "pd" - source structure  *  * Return values:  * 0..65535 - Number of bytes used, limited by the "len" input parameter.  *------------------------------------------------------------------------*/
end_comment

begin_function
name|uint16_t
name|libusb20_me_encode
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|,
name|uint16_t
name|len
parameter_list|,
specifier|const
name|void
modifier|*
name|pd
parameter_list|)
block|{
specifier|const
name|uint8_t
modifier|*
name|pf
decl_stmt|;
comment|/* pointer to format data */
name|uint8_t
modifier|*
name|buf
decl_stmt|;
comment|/* pointer to output buffer */
name|uint32_t
name|pd_offset
decl_stmt|;
comment|/* decoded structure offset */
name|uint16_t
name|len_old
decl_stmt|;
comment|/* old length */
name|uint16_t
name|pd_count
decl_stmt|;
comment|/* decoded element count */
name|uint8_t
name|me
decl_stmt|;
comment|/* message element */
comment|/* initialise */
name|len_old
operator|=
name|len
expr_stmt|;
name|buf
operator|=
name|ptr
expr_stmt|;
name|pd_offset
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|pf
operator|=
operator|(
operator|*
operator|(
operator|(
expr|struct
name|libusb20_me_format
operator|*
specifier|const
operator|*
operator|)
name|pd
operator|)
operator|)
operator|->
name|format
expr_stmt|;
comment|/* scan */
while|while
condition|(
literal|1
condition|)
block|{
comment|/* get information element */
name|me
operator|=
operator|(
name|pf
index|[
literal|0
index|]
operator|)
operator|&
name|LIBUSB20_ME_MASK
expr_stmt|;
name|pd_count
operator|=
name|pf
index|[
literal|1
index|]
operator||
operator|(
name|pf
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
name|pf
operator|+=
literal|3
expr_stmt|;
comment|/* encode the message element */
switch|switch
condition|(
name|me
condition|)
block|{
case|case
name|LIBUSB20_ME_INT8
case|:
while|while
condition|(
name|pd_count
operator|--
condition|)
block|{
name|uint8_t
name|temp
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|1
condition|)
comment|/* overflow */
goto|goto
name|done
goto|;
if|if
condition|(
name|buf
condition|)
block|{
name|temp
operator|=
operator|*
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|LIBUSB20_ADD_BYTES
argument_list|(
name|pd
argument_list|,
name|pd_offset
argument_list|)
operator|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|temp
expr_stmt|;
name|buf
operator|+=
literal|1
expr_stmt|;
block|}
name|pd_offset
operator|+=
literal|1
expr_stmt|;
name|len
operator|-=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|LIBUSB20_ME_INT16
case|:
name|pd_offset
operator|=
operator|-
operator|(
operator|(
operator|-
name|pd_offset
operator|)
operator|&
operator|~
literal|1
operator|)
expr_stmt|;
comment|/* align */
while|while
condition|(
name|pd_count
operator|--
condition|)
block|{
name|uint16_t
name|temp
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
comment|/* overflow */
goto|goto
name|done
goto|;
if|if
condition|(
name|buf
condition|)
block|{
name|temp
operator|=
operator|*
operator|(
operator|(
specifier|const
name|uint16_t
operator|*
operator|)
name|LIBUSB20_ADD_BYTES
argument_list|(
name|pd
argument_list|,
name|pd_offset
argument_list|)
operator|)
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
operator|(
name|temp
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|temp
operator|&
literal|0xFF
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
name|pd_offset
operator|+=
literal|2
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
block|}
break|break;
case|case
name|LIBUSB20_ME_INT32
case|:
name|pd_offset
operator|=
operator|-
operator|(
operator|(
operator|-
name|pd_offset
operator|)
operator|&
operator|~
literal|3
operator|)
expr_stmt|;
comment|/* align */
while|while
condition|(
name|pd_count
operator|--
condition|)
block|{
name|uint32_t
name|temp
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|4
condition|)
comment|/* overflow */
goto|goto
name|done
goto|;
if|if
condition|(
name|buf
condition|)
block|{
name|temp
operator|=
operator|*
operator|(
operator|(
specifier|const
name|uint32_t
operator|*
operator|)
name|LIBUSB20_ADD_BYTES
argument_list|(
name|pd
argument_list|,
name|pd_offset
argument_list|)
operator|)
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
operator|(
name|temp
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
operator|(
name|temp
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
operator|(
name|temp
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|temp
operator|&
literal|0xFF
expr_stmt|;
name|buf
operator|+=
literal|4
expr_stmt|;
block|}
name|pd_offset
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
block|}
break|break;
case|case
name|LIBUSB20_ME_INT64
case|:
name|pd_offset
operator|=
operator|-
operator|(
operator|(
operator|-
name|pd_offset
operator|)
operator|&
operator|~
literal|7
operator|)
expr_stmt|;
comment|/* align */
while|while
condition|(
name|pd_count
operator|--
condition|)
block|{
name|uint64_t
name|temp
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|8
condition|)
comment|/* overflow */
goto|goto
name|done
goto|;
if|if
condition|(
name|buf
condition|)
block|{
name|temp
operator|=
operator|*
operator|(
operator|(
specifier|const
name|uint64_t
operator|*
operator|)
name|LIBUSB20_ADD_BYTES
argument_list|(
name|pd
argument_list|,
name|pd_offset
argument_list|)
operator|)
expr_stmt|;
name|buf
index|[
literal|7
index|]
operator|=
operator|(
name|temp
operator|>>
literal|56
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|6
index|]
operator|=
operator|(
name|temp
operator|>>
literal|48
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|5
index|]
operator|=
operator|(
name|temp
operator|>>
literal|40
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|4
index|]
operator|=
operator|(
name|temp
operator|>>
literal|32
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
operator|(
name|temp
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
operator|(
name|temp
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
operator|(
name|temp
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|temp
operator|&
literal|0xFF
expr_stmt|;
name|buf
operator|+=
literal|8
expr_stmt|;
block|}
name|pd_offset
operator|+=
literal|8
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
block|}
break|break;
case|case
name|LIBUSB20_ME_STRUCT
case|:
name|pd_offset
operator|=
operator|-
operator|(
operator|(
operator|-
name|pd_offset
operator|)
operator|&
operator|~
operator|(
name|LIBUSB20_ME_STRUCT_ALIGN
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
comment|/* align */
while|while
condition|(
name|pd_count
operator|--
condition|)
block|{
name|void
modifier|*
name|src_ptr
decl_stmt|;
name|uint16_t
name|src_len
decl_stmt|;
name|struct
name|libusb20_me_struct
modifier|*
name|ps
decl_stmt|;
name|ps
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|pd
argument_list|,
name|pd_offset
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ps
operator|->
name|type
condition|)
block|{
case|case
name|LIBUSB20_ME_IS_RAW
case|:
name|src_len
operator|=
name|ps
operator|->
name|len
expr_stmt|;
name|src_ptr
operator|=
name|ps
operator|->
name|ptr
expr_stmt|;
break|break;
case|case
name|LIBUSB20_ME_IS_ENCODED
case|:
if|if
condition|(
name|ps
operator|->
name|len
operator|==
literal|0
condition|)
block|{
comment|/* 						 * Length is encoded 						 * in the data itself 						 * and should be 						 * correct: 						 */
name|ps
operator|->
name|len
operator|=
literal|0
operator|-
literal|1
expr_stmt|;
block|}
name|src_len
operator|=
name|libusb20_me_get_1
argument_list|(
name|pd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|src_ptr
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|ps
operator|->
name|ptr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|src_len
operator|==
literal|0xFF
condition|)
block|{
comment|/* length is escaped */
name|src_len
operator|=
name|libusb20_me_get_2
argument_list|(
name|pd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|src_ptr
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|ps
operator|->
name|ptr
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|LIBUSB20_ME_IS_DECODED
case|:
comment|/* reserve 3 length bytes */
name|src_len
operator|=
name|libusb20_me_encode
argument_list|(
name|NULL
argument_list|,
literal|0
operator|-
literal|1
operator|-
literal|3
argument_list|,
name|ps
operator|->
name|ptr
argument_list|)
expr_stmt|;
name|src_ptr
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
comment|/* empty structure */
name|src_len
operator|=
literal|0
expr_stmt|;
name|src_ptr
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|src_len
operator|>
literal|0xFE
condition|)
block|{
if|if
condition|(
name|src_len
operator|>
call|(
name|uint16_t
call|)
argument_list|(
literal|0
operator|-
literal|1
operator|-
literal|3
argument_list|)
condition|)
comment|/* overflow */
goto|goto
name|done
goto|;
if|if
condition|(
name|len
operator|<
operator|(
name|src_len
operator|+
literal|3
operator|)
condition|)
comment|/* overflow */
goto|goto
name|done
goto|;
if|if
condition|(
name|buf
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
operator|(
name|src_len
operator|&
literal|0xFF
operator|)
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
operator|(
name|src_len
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|buf
operator|+=
literal|3
expr_stmt|;
block|}
name|len
operator|-=
operator|(
name|src_len
operator|+
literal|3
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|len
operator|<
operator|(
name|src_len
operator|+
literal|1
operator|)
condition|)
comment|/* overflow */
goto|goto
name|done
goto|;
if|if
condition|(
name|buf
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
operator|(
name|src_len
operator|&
literal|0xFF
operator|)
expr_stmt|;
name|buf
operator|+=
literal|1
expr_stmt|;
block|}
name|len
operator|-=
operator|(
name|src_len
operator|+
literal|1
operator|)
expr_stmt|;
block|}
comment|/* check for buffer and non-zero length */
if|if
condition|(
name|buf
operator|&&
name|src_len
condition|)
block|{
if|if
condition|(
name|ps
operator|->
name|type
operator|==
name|LIBUSB20_ME_IS_DECODED
condition|)
block|{
comment|/* 						 * Repeat encode 						 * procedure - we have 						 * room for the 						 * complete structure: 						 */
name|uint16_t
name|dummy
decl_stmt|;
name|dummy
operator|=
name|libusb20_me_encode
argument_list|(
name|buf
argument_list|,
literal|0
operator|-
literal|1
operator|-
literal|3
argument_list|,
name|ps
operator|->
name|ptr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bcopy
argument_list|(
name|src_ptr
argument_list|,
name|buf
argument_list|,
name|src_len
argument_list|)
expr_stmt|;
block|}
name|buf
operator|+=
name|src_len
expr_stmt|;
block|}
name|pd_offset
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|libusb20_me_struct
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
goto|goto
name|done
goto|;
block|}
block|}
name|done
label|:
return|return
operator|(
name|len_old
operator|-
name|len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	libusb20_me_decode - decode a message into a decoded structure  *  * Description of parameters:  * "ptr" - message pointer  * "len" - message length  * "pd" - pointer to decoded structure  *  * Returns:  * "0..65535" - number of bytes decoded, limited by "len"  *------------------------------------------------------------------------*/
end_comment

begin_function
name|uint16_t
name|libusb20_me_decode
parameter_list|(
specifier|const
name|void
modifier|*
name|ptr
parameter_list|,
name|uint16_t
name|len
parameter_list|,
name|void
modifier|*
name|pd
parameter_list|)
block|{
specifier|const
name|uint8_t
modifier|*
name|pf
decl_stmt|;
comment|/* pointer to format data */
specifier|const
name|uint8_t
modifier|*
name|buf
decl_stmt|;
comment|/* pointer to input buffer */
name|uint32_t
name|pd_offset
decl_stmt|;
comment|/* decoded structure offset */
name|uint16_t
name|len_old
decl_stmt|;
comment|/* old length */
name|uint16_t
name|pd_count
decl_stmt|;
comment|/* decoded element count */
name|uint8_t
name|me
decl_stmt|;
comment|/* message element */
comment|/* initialise */
name|len_old
operator|=
name|len
expr_stmt|;
name|buf
operator|=
name|ptr
expr_stmt|;
name|pd_offset
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|pf
operator|=
operator|(
operator|*
operator|(
operator|(
expr|struct
name|libusb20_me_format
operator|*
operator|*
operator|)
name|pd
operator|)
operator|)
operator|->
name|format
expr_stmt|;
comment|/* scan */
while|while
condition|(
literal|1
condition|)
block|{
comment|/* get information element */
name|me
operator|=
operator|(
name|pf
index|[
literal|0
index|]
operator|)
operator|&
name|LIBUSB20_ME_MASK
expr_stmt|;
name|pd_count
operator|=
name|pf
index|[
literal|1
index|]
operator||
operator|(
name|pf
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
name|pf
operator|+=
literal|3
expr_stmt|;
comment|/* decode the message element by type */
switch|switch
condition|(
name|me
condition|)
block|{
case|case
name|LIBUSB20_ME_INT8
case|:
while|while
condition|(
name|pd_count
operator|--
condition|)
block|{
name|uint8_t
name|temp
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|1
condition|)
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|temp
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|len
operator|-=
literal|1
expr_stmt|;
name|temp
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|buf
operator|++
expr_stmt|;
block|}
operator|*
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|LIBUSB20_ADD_BYTES
argument_list|(
name|pd
argument_list|,
name|pd_offset
argument_list|)
operator|)
operator|=
name|temp
expr_stmt|;
name|pd_offset
operator|+=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|LIBUSB20_ME_INT16
case|:
name|pd_offset
operator|=
operator|-
operator|(
operator|(
operator|-
name|pd_offset
operator|)
operator|&
operator|~
literal|1
operator|)
expr_stmt|;
comment|/* align */
while|while
condition|(
name|pd_count
operator|--
condition|)
block|{
name|uint16_t
name|temp
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|temp
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|len
operator|-=
literal|2
expr_stmt|;
name|temp
operator|=
name|buf
index|[
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
name|temp
operator||=
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
operator|*
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|LIBUSB20_ADD_BYTES
argument_list|(
name|pd
argument_list|,
name|pd_offset
argument_list|)
operator|)
operator|=
name|temp
expr_stmt|;
name|pd_offset
operator|+=
literal|2
expr_stmt|;
block|}
break|break;
case|case
name|LIBUSB20_ME_INT32
case|:
name|pd_offset
operator|=
operator|-
operator|(
operator|(
operator|-
name|pd_offset
operator|)
operator|&
operator|~
literal|3
operator|)
expr_stmt|;
comment|/* align */
while|while
condition|(
name|pd_count
operator|--
condition|)
block|{
name|uint32_t
name|temp
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|4
condition|)
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|temp
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|len
operator|-=
literal|4
expr_stmt|;
name|temp
operator|=
name|buf
index|[
literal|3
index|]
operator|<<
literal|24
expr_stmt|;
name|temp
operator||=
name|buf
index|[
literal|2
index|]
operator|<<
literal|16
expr_stmt|;
name|temp
operator||=
name|buf
index|[
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
name|temp
operator||=
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|buf
operator|+=
literal|4
expr_stmt|;
block|}
operator|*
operator|(
operator|(
name|uint32_t
operator|*
operator|)
name|LIBUSB20_ADD_BYTES
argument_list|(
name|pd
argument_list|,
name|pd_offset
argument_list|)
operator|)
operator|=
name|temp
expr_stmt|;
name|pd_offset
operator|+=
literal|4
expr_stmt|;
block|}
break|break;
case|case
name|LIBUSB20_ME_INT64
case|:
name|pd_offset
operator|=
operator|-
operator|(
operator|(
operator|-
name|pd_offset
operator|)
operator|&
operator|~
literal|7
operator|)
expr_stmt|;
comment|/* align */
while|while
condition|(
name|pd_count
operator|--
condition|)
block|{
name|uint64_t
name|temp
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|8
condition|)
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|temp
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|len
operator|-=
literal|8
expr_stmt|;
name|temp
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|buf
index|[
literal|7
index|]
operator|)
operator|<<
literal|56
expr_stmt|;
name|temp
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|buf
index|[
literal|6
index|]
operator|)
operator|<<
literal|48
expr_stmt|;
name|temp
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|buf
index|[
literal|5
index|]
operator|)
operator|<<
literal|40
expr_stmt|;
name|temp
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|buf
index|[
literal|4
index|]
operator|)
operator|<<
literal|32
expr_stmt|;
name|temp
operator||=
name|buf
index|[
literal|3
index|]
operator|<<
literal|24
expr_stmt|;
name|temp
operator||=
name|buf
index|[
literal|2
index|]
operator|<<
literal|16
expr_stmt|;
name|temp
operator||=
name|buf
index|[
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
name|temp
operator||=
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|buf
operator|+=
literal|8
expr_stmt|;
block|}
operator|*
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|LIBUSB20_ADD_BYTES
argument_list|(
name|pd
argument_list|,
name|pd_offset
argument_list|)
operator|)
operator|=
name|temp
expr_stmt|;
name|pd_offset
operator|+=
literal|8
expr_stmt|;
block|}
break|break;
case|case
name|LIBUSB20_ME_STRUCT
case|:
name|pd_offset
operator|=
operator|-
operator|(
operator|(
operator|-
name|pd_offset
operator|)
operator|&
operator|~
operator|(
name|LIBUSB20_ME_STRUCT_ALIGN
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
comment|/* align */
while|while
condition|(
name|pd_count
operator|--
condition|)
block|{
name|uint16_t
name|temp
decl_stmt|;
name|uint16_t
name|dummy
decl_stmt|;
name|struct
name|libusb20_me_struct
modifier|*
name|ps
decl_stmt|;
name|ps
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|pd
argument_list|,
name|pd_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|type
operator|==
name|LIBUSB20_ME_IS_ENCODED
condition|)
block|{
comment|/* 					 * Pre-store a de-constified 					 * pointer to the raw 					 * structure: 					 */
name|ps
operator|->
name|ptr
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 					 * Get the correct number of 					 * length bytes: 					 */
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|0xFF
condition|)
block|{
name|ps
operator|->
name|len
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|ps
operator|->
name|len
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|ps
operator|->
name|len
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* get the structure length */
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|0xFF
condition|)
block|{
if|if
condition|(
name|len
operator|<
literal|3
condition|)
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|temp
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|len
operator|-=
literal|3
expr_stmt|;
name|temp
operator|=
name|buf
index|[
literal|1
index|]
operator||
operator|(
name|buf
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
name|buf
operator|+=
literal|3
expr_stmt|;
block|}
block|}
else|else
block|{
name|len
operator|-=
literal|1
expr_stmt|;
name|temp
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|buf
operator|+=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|temp
operator|=
literal|0
expr_stmt|;
block|}
comment|/* check for invalid length */
if|if
condition|(
name|temp
operator|>
name|len
condition|)
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|temp
operator|=
literal|0
expr_stmt|;
block|}
comment|/* check wanted structure type */
switch|switch
condition|(
name|ps
operator|->
name|type
condition|)
block|{
case|case
name|LIBUSB20_ME_IS_ENCODED
case|:
comment|/* check for zero length */
if|if
condition|(
name|temp
operator|==
literal|0
condition|)
block|{
comment|/* 						 * The pointer must 						 * be valid: 						 */
name|ps
operator|->
name|ptr
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|libusb20_me_encode_empty
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ps
operator|->
name|len
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|ps
operator|->
name|len
operator|+=
name|temp
expr_stmt|;
block|}
break|break;
case|case
name|LIBUSB20_ME_IS_RAW
case|:
comment|/* update length and pointer */
name|ps
operator|->
name|len
operator|=
name|temp
expr_stmt|;
name|ps
operator|->
name|ptr
operator|=
name|LIBUSB20_ADD_BYTES
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|LIBUSB20_ME_IS_EMPTY
case|:
case|case
name|LIBUSB20_ME_IS_DECODED
case|:
comment|/* check for non-zero length */
if|if
condition|(
name|temp
operator|!=
literal|0
condition|)
block|{
comment|/* update type */
name|ps
operator|->
name|type
operator|=
name|LIBUSB20_ME_IS_DECODED
expr_stmt|;
name|ps
operator|->
name|len
operator|=
literal|0
expr_stmt|;
comment|/* 						 * Recursivly decode 						 * the next structure 						 */
name|dummy
operator|=
name|libusb20_me_decode
argument_list|(
name|buf
argument_list|,
name|temp
argument_list|,
name|ps
operator|->
name|ptr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* update type */
name|ps
operator|->
name|type
operator|=
name|LIBUSB20_ME_IS_EMPTY
expr_stmt|;
name|ps
operator|->
name|len
operator|=
literal|0
expr_stmt|;
block|}
break|break;
default|default:
comment|/* 					 * nothing to do - should 					 * not happen 					 */
name|ps
operator|->
name|ptr
operator|=
name|NULL
expr_stmt|;
name|ps
operator|->
name|len
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|buf
operator|+=
name|temp
expr_stmt|;
name|len
operator|-=
name|temp
expr_stmt|;
name|pd_offset
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|libusb20_me_struct
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
goto|goto
name|done
goto|;
block|}
block|}
name|done
label|:
return|return
operator|(
name|len_old
operator|-
name|len
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * This pam_krb5 module contains code that is:  *   Copyright (c) Derrick J. Brashear, 1996. All rights reserved.  *   Copyright (c) Frank Cusack, 1999-2001. All rights reserved.  *   Copyright (c) Jacques A. Vidrine, 2000-2001. All rights reserved.  *   Copyright (c) Nicolas Williams, 2001. All rights reserved.  *   Copyright (c) Perot Systems Corporation, 2001. All rights reserved.  *   Copyright (c) Mark R V Murray, 2001.  All rights reserved.  *   Copyright (c) Networks Associates Technology, Inc., 2002.  *       All rights reserved.  *  * Portions of this software were developed for the FreeBSD Project by  * ThinkSec AS and NAI Labs, the Security Research Division of Network  * Associates, Inc.  under DARPA/SPAWAR contract N66001-01-C-8035  * ("CBOSS"), as part of the DARPA CHATS research program.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notices, and the entire permission notice in its entirety,  *    including the disclaimer of warranties.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote  *    products derived from this software without specific prior  *    written permission.  *  * ALTERNATIVELY, this product may be distributed under the terms of  * the GNU Public License, in which case the provisions of the GPL are  * required INSTEAD OF the above restrictions.  (This clause is  * necessary due to a potential bad interaction between the GPL and  * the restrictions contained in a BSD-style copyright.)  *  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,  * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<krb5.h>
end_include

begin_include
include|#
directive|include
file|<com_err.h>
end_include

begin_define
define|#
directive|define
name|PAM_SM_AUTH
end_define

begin_define
define|#
directive|define
name|PAM_SM_ACCOUNT
end_define

begin_define
define|#
directive|define
name|PAM_SM_PASSWORD
end_define

begin_include
include|#
directive|include
file|<security/pam_appl.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_modules.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_mod_misc.h>
end_include

begin_include
include|#
directive|include
file|<security/openpam.h>
end_include

begin_define
define|#
directive|define
name|COMPAT_HEIMDAL
end_define

begin_comment
comment|/* #define	COMPAT_MIT */
end_comment

begin_function_decl
specifier|static
name|int
name|verify_krb_v5_tgt
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cleanup_cache
parameter_list|(
name|pam_handle_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|compat_princ_component
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_principal
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|compat_free_data_contents
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_data
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|USER_PROMPT
value|"Username: "
end_define

begin_define
define|#
directive|define
name|PASSWORD_PROMPT
value|"Password:"
end_define

begin_define
define|#
directive|define
name|NEW_PASSWORD_PROMPT
value|"New Password:"
end_define

begin_define
define|#
directive|define
name|PAM_OPT_CCACHE
value|"ccache"
end_define

begin_define
define|#
directive|define
name|PAM_OPT_FORWARDABLE
value|"forwardable"
end_define

begin_define
define|#
directive|define
name|PAM_OPT_NO_CCACHE
value|"no_ccache"
end_define

begin_define
define|#
directive|define
name|PAM_OPT_REUSE_CCACHE
value|"reuse_ccache"
end_define

begin_comment
comment|/*  * authentication management  */
end_comment

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_authenticate
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
name|__unused
parameter_list|,
name|int
name|argc
name|__unused
parameter_list|,
specifier|const
name|char
modifier|*
name|argv
index|[]
name|__unused
parameter_list|)
block|{
name|krb5_error_code
name|krbret
decl_stmt|;
name|krb5_context
name|pam_context
decl_stmt|;
name|krb5_creds
name|creds
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|krb5_ccache
name|ccache
decl_stmt|;
name|krb5_get_init_creds_opt
name|opts
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|int
name|retval
decl_stmt|;
specifier|const
name|char
modifier|*
name|sourceuser
decl_stmt|,
modifier|*
name|user
decl_stmt|,
modifier|*
name|pass
decl_stmt|,
modifier|*
name|service
decl_stmt|;
name|char
modifier|*
name|principal
decl_stmt|,
modifier|*
name|princ_name
decl_stmt|,
modifier|*
name|ccache_name
decl_stmt|,
name|luser
index|[
literal|32
index|]
decl_stmt|,
modifier|*
name|srvdup
decl_stmt|;
name|retval
operator|=
name|pam_get_user
argument_list|(
name|pamh
argument_list|,
operator|&
name|user
argument_list|,
name|USER_PROMPT
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
name|PAM_LOG
argument_list|(
literal|"Got user: %s"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|retval
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_RUSER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|sourceuser
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
name|PAM_LOG
argument_list|(
literal|"Got ruser: %s"
argument_list|,
name|sourceuser
argument_list|)
expr_stmt|;
name|service
operator|=
name|NULL
expr_stmt|;
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_SERVICE
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|==
name|NULL
condition|)
name|service
operator|=
literal|"unknown"
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Got service: %s"
argument_list|,
name|service
argument_list|)
expr_stmt|;
name|krbret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|pam_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
block|}
name|PAM_LOG
argument_list|(
literal|"Context initialised"
argument_list|)
expr_stmt|;
name|krb5_get_init_creds_opt_init
argument_list|(
operator|&
name|opts
argument_list|)
expr_stmt|;
if|if
condition|(
name|openpam_get_option
argument_list|(
name|pamh
argument_list|,
name|PAM_OPT_FORWARDABLE
argument_list|)
condition|)
name|krb5_get_init_creds_opt_set_forwardable
argument_list|(
operator|&
name|opts
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Credentials initialised"
argument_list|)
expr_stmt|;
name|krbret
operator|=
name|krb5_cc_register
argument_list|(
name|pam_context
argument_list|,
operator|&
name|krb5_mcc_ops
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
operator|&&
name|krbret
operator|!=
name|KRB5_CC_TYPE_EXISTS
condition|)
block|{
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Done krb5_cc_register()"
argument_list|)
expr_stmt|;
comment|/* Get principal name */
if|if
condition|(
name|openpam_get_option
argument_list|(
name|pamh
argument_list|,
name|PAM_OPT_AUTH_AS_SELF
argument_list|)
condition|)
name|asprintf
argument_list|(
operator|&
name|principal
argument_list|,
literal|"%s/%s"
argument_list|,
name|sourceuser
argument_list|,
name|user
argument_list|)
expr_stmt|;
else|else
name|principal
operator|=
name|strdup
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Created principal: %s"
argument_list|,
name|principal
argument_list|)
expr_stmt|;
name|krbret
operator|=
name|krb5_parse_name
argument_list|(
name|pam_context
argument_list|,
name|principal
argument_list|,
operator|&
name|princ
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_parse_name(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Done krb5_parse_name()"
argument_list|)
expr_stmt|;
comment|/* Now convert the principal name into something human readable */
name|princ_name
operator|=
name|NULL
expr_stmt|;
name|krbret
operator|=
name|krb5_unparse_name
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|,
operator|&
name|princ_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_unparse_name(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Got principal: %s"
argument_list|,
name|princ_name
argument_list|)
expr_stmt|;
comment|/* Get password */
name|retval
operator|=
name|pam_get_authtok
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|&
name|pass
argument_list|,
name|PASSWORD_PROMPT
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
goto|goto
name|cleanup2
goto|;
name|PAM_LOG
argument_list|(
literal|"Got password"
argument_list|)
expr_stmt|;
comment|/* Verify the local user exists (AFTER getting the password) */
if|if
condition|(
name|strchr
argument_list|(
name|user
argument_list|,
literal|'@'
argument_list|)
condition|)
block|{
comment|/* get a local account name for this principal */
name|krbret
operator|=
name|krb5_aname_to_localname
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|,
sizeof|sizeof
argument_list|(
name|luser
argument_list|)
argument_list|,
name|luser
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Error krb5_aname_to_localname(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_USER_UNKNOWN
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|retval
operator|=
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
name|luser
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
goto|goto
name|cleanup2
goto|;
name|retval
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
goto|goto
name|cleanup2
goto|;
name|PAM_LOG
argument_list|(
literal|"PAM_USER Redone"
argument_list|)
expr_stmt|;
block|}
name|pwd
operator|=
name|getpwnam
argument_list|(
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|==
name|NULL
condition|)
block|{
name|retval
operator|=
name|PAM_USER_UNKNOWN
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Done getpwnam()"
argument_list|)
expr_stmt|;
comment|/* Get a TGT */
name|memset
argument_list|(
operator|&
name|creds
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|krb5_creds
argument_list|)
argument_list|)
expr_stmt|;
name|krbret
operator|=
name|krb5_get_init_creds_password
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|,
name|princ
argument_list|,
name|pass
argument_list|,
name|NULL
argument_list|,
name|pamh
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|opts
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Error krb5_get_init_creds_password(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Got TGT"
argument_list|)
expr_stmt|;
comment|/* Generate a temporary cache */
name|krbret
operator|=
name|krb5_cc_gen_new
argument_list|(
name|pam_context
argument_list|,
operator|&
name|krb5_mcc_ops
argument_list|,
operator|&
name|ccache
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_gen_new(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|krbret
operator|=
name|krb5_cc_initialize
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|,
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_initialize(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|krbret
operator|=
name|krb5_cc_store_cred
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_store_cred(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Credentials stashed"
argument_list|)
expr_stmt|;
comment|/* Verify them */
if|if
condition|(
operator|(
name|srvdup
operator|=
name|strdup
argument_list|(
name|service
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|retval
operator|=
name|PAM_BUF_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|krbret
operator|=
name|verify_krb_v5_tgt
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|,
name|srvdup
argument_list|,
name|openpam_get_option
argument_list|(
name|pamh
argument_list|,
name|PAM_OPT_FORWARDABLE
argument_list|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|srvdup
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|==
operator|-
literal|1
condition|)
block|{
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Credentials stash verified"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|pam_get_data
argument_list|(
name|pamh
argument_list|,
literal|"ccache"
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|ccache_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|==
name|PAM_SUCCESS
condition|)
block|{
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Credentials stash not pre-existing"
argument_list|)
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|ccache_name
argument_list|,
literal|"%s:%s"
argument_list|,
name|krb5_cc_get_type
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
argument_list|,
name|krb5_cc_get_name
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccache_name
operator|==
name|NULL
condition|)
block|{
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_BUF_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|retval
operator|=
name|pam_set_data
argument_list|(
name|pamh
argument_list|,
literal|"ccache"
argument_list|,
name|ccache_name
argument_list|,
name|cleanup_cache
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
block|{
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 error"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Credentials stash saved"
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|krb5_free_cred_contents
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done cleanup"
argument_list|)
expr_stmt|;
name|cleanup2
label|:
name|krb5_free_principal
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done cleanup2"
argument_list|)
expr_stmt|;
name|cleanup3
label|:
if|if
condition|(
name|princ_name
condition|)
name|free
argument_list|(
name|princ_name
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|pam_context
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done cleanup3"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"Kerberos 5 refuses you"
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_setcred
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
name|__unused
parameter_list|,
specifier|const
name|char
modifier|*
name|argv
index|[]
name|__unused
parameter_list|)
block|{
name|krb5_error_code
name|krbret
decl_stmt|;
name|krb5_context
name|pam_context
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|krb5_creds
name|creds
decl_stmt|;
name|krb5_ccache
name|ccache_temp
decl_stmt|,
name|ccache_perm
decl_stmt|;
name|krb5_cc_cursor
name|cursor
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
init|=
name|NULL
decl_stmt|;
name|int
name|retval
decl_stmt|;
specifier|const
name|char
modifier|*
name|cache_name
decl_stmt|,
modifier|*
name|q
decl_stmt|,
modifier|*
name|user
decl_stmt|;
name|char
modifier|*
name|cache_name_buf
init|=
name|NULL
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|uid_t
name|euid
decl_stmt|;
name|gid_t
name|egid
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|PAM_DELETE_CRED
condition|)
return|return
operator|(
name|PAM_SUCCESS
operator|)
return|;
if|if
condition|(
name|flags
operator|&
name|PAM_REFRESH_CRED
condition|)
return|return
operator|(
name|PAM_SUCCESS
operator|)
return|;
if|if
condition|(
name|flags
operator|&
name|PAM_REINITIALIZE_CRED
condition|)
return|return
operator|(
name|PAM_SUCCESS
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|PAM_ESTABLISH_CRED
operator|)
condition|)
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
name|PAM_LOG
argument_list|(
literal|"Establishing credentials"
argument_list|)
expr_stmt|;
comment|/* Get username */
name|retval
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
name|PAM_LOG
argument_list|(
literal|"Got user: %s"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|krbret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|pam_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_init_context() failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
block|}
name|PAM_LOG
argument_list|(
literal|"Context initialised"
argument_list|)
expr_stmt|;
name|euid
operator|=
name|geteuid
argument_list|()
expr_stmt|;
comment|/* Usually 0 */
name|egid
operator|=
name|getegid
argument_list|()
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Got euid, egid: %d %d"
argument_list|,
name|euid
argument_list|,
name|egid
argument_list|)
expr_stmt|;
comment|/* Retrieve the temporary cache */
name|retval
operator|=
name|pam_get_data
argument_list|(
name|pamh
argument_list|,
literal|"ccache"
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|cache_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|retval
operator|=
name|PAM_CRED_UNAVAIL
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
name|krbret
operator|=
name|krb5_cc_resolve
argument_list|(
name|pam_context
argument_list|,
name|cache_name
argument_list|,
operator|&
name|ccache_temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_resolve(\"%s\"): %s"
argument_list|,
name|cache_name
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
comment|/* Get the uid. This should exist. */
name|pwd
operator|=
name|getpwnam
argument_list|(
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|==
name|NULL
condition|)
block|{
name|retval
operator|=
name|PAM_USER_UNKNOWN
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Done getpwnam()"
argument_list|)
expr_stmt|;
comment|/* Avoid following a symlink as root */
if|if
condition|(
name|setegid
argument_list|(
name|pwd
operator|->
name|pw_gid
argument_list|)
condition|)
block|{
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
if|if
condition|(
name|seteuid
argument_list|(
name|pwd
operator|->
name|pw_uid
argument_list|)
condition|)
block|{
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Done setegid()& seteuid()"
argument_list|)
expr_stmt|;
comment|/* Get the cache name */
name|cache_name
operator|=
name|openpam_get_option
argument_list|(
name|pamh
argument_list|,
name|PAM_OPT_CCACHE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache_name
operator|==
name|NULL
condition|)
block|{
name|asprintf
argument_list|(
operator|&
name|cache_name_buf
argument_list|,
literal|"FILE:/tmp/krb5cc_%d"
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|)
expr_stmt|;
name|cache_name
operator|=
name|cache_name_buf
expr_stmt|;
block|}
name|p
operator|=
name|calloc
argument_list|(
name|PATH_MAX
operator|+
literal|16
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
name|q
operator|=
name|cache_name
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error malloc(): failure"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_BUF_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
name|cache_name
operator|=
name|p
expr_stmt|;
comment|/* convert %u and %p */
while|while
condition|(
operator|*
name|q
condition|)
block|{
if|if
condition|(
operator|*
name|q
operator|==
literal|'%'
condition|)
block|{
name|q
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|q
operator|==
literal|'u'
condition|)
block|{
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"%d"
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|)
expr_stmt|;
name|p
operator|+=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|q
operator|==
literal|'p'
condition|)
block|{
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"%d"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|p
operator|+=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Not a special token */
operator|*
name|p
operator|++
operator|=
literal|'%'
expr_stmt|;
name|q
operator|--
expr_stmt|;
block|}
name|q
operator|++
expr_stmt|;
block|}
else|else
block|{
operator|*
name|p
operator|++
operator|=
operator|*
name|q
operator|++
expr_stmt|;
block|}
block|}
name|PAM_LOG
argument_list|(
literal|"Got cache_name: %s"
argument_list|,
name|cache_name
argument_list|)
expr_stmt|;
comment|/* Initialize the new ccache */
name|krbret
operator|=
name|krb5_cc_get_principal
argument_list|(
name|pam_context
argument_list|,
name|ccache_temp
argument_list|,
operator|&
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_get_principal(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
name|krbret
operator|=
name|krb5_cc_resolve
argument_list|(
name|pam_context
argument_list|,
name|cache_name
argument_list|,
operator|&
name|ccache_perm
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_resolve(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|krbret
operator|=
name|krb5_cc_initialize
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|,
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_initialize(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Cache initialised"
argument_list|)
expr_stmt|;
comment|/* Prepare for iteration over creds */
name|krbret
operator|=
name|krb5_cc_start_seq_get
argument_list|(
name|pam_context
argument_list|,
name|ccache_temp
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_start_seq_get(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Prepared for iteration"
argument_list|)
expr_stmt|;
comment|/* Copy the creds (should be two of them) */
while|while
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_next_cred
argument_list|(
name|pam_context
argument_list|,
name|ccache_temp
argument_list|,
operator|&
name|cursor
argument_list|,
operator|&
name|creds
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|krbret
operator|=
name|krb5_cc_store_cred
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_store_cred(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|krb5_free_cred_contents
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|krb5_free_cred_contents
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Iteration"
argument_list|)
expr_stmt|;
block|}
name|krb5_cc_end_seq_get
argument_list|(
name|pam_context
argument_list|,
name|ccache_temp
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done iterating"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strstr
argument_list|(
name|cache_name
argument_list|,
literal|"FILE:"
argument_list|)
operator|==
name|cache_name
condition|)
block|{
if|if
condition|(
name|chown
argument_list|(
operator|&
name|cache_name
index|[
literal|5
index|]
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|,
name|pwd
operator|->
name|pw_gid
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error chown(): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Done chown()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chmod
argument_list|(
operator|&
name|cache_name
index|[
literal|5
index|]
argument_list|,
operator|(
name|S_IRUSR
operator||
name|S_IWUSR
operator|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error chmod(): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Done chmod()"
argument_list|)
expr_stmt|;
block|}
name|krb5_cc_close
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Cache closed"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|pam_setenv
argument_list|(
name|pamh
argument_list|,
literal|"KRB5CCNAME"
argument_list|,
name|cache_name
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error pam_setenv(): %s"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|retval
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Environment done: KRB5CCNAME=%s"
argument_list|,
name|cache_name
argument_list|)
expr_stmt|;
name|cleanup2
label|:
name|krb5_free_principal
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done cleanup2"
argument_list|)
expr_stmt|;
name|cleanup3
label|:
name|krb5_free_context
argument_list|(
name|pam_context
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done cleanup3"
argument_list|)
expr_stmt|;
name|seteuid
argument_list|(
name|euid
argument_list|)
expr_stmt|;
name|setegid
argument_list|(
name|egid
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done seteuid()& setegid()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache_name_buf
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|cache_name_buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * account management  */
end_comment

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_acct_mgmt
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
name|__unused
parameter_list|,
name|int
name|argc
name|__unused
parameter_list|,
specifier|const
name|char
modifier|*
name|argv
index|[]
name|__unused
parameter_list|)
block|{
name|krb5_error_code
name|krbret
decl_stmt|;
name|krb5_context
name|pam_context
decl_stmt|;
name|krb5_ccache
name|ccache
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|int
name|retval
decl_stmt|;
specifier|const
name|char
modifier|*
name|user
decl_stmt|,
modifier|*
name|ccache_name
decl_stmt|;
name|retval
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
name|PAM_LOG
argument_list|(
literal|"Got user: %s"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|retval
operator|=
name|pam_get_data
argument_list|(
name|pamh
argument_list|,
literal|"ccache"
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|ccache_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
operator|(
name|PAM_SUCCESS
operator|)
return|;
name|PAM_LOG
argument_list|(
literal|"Got credentials"
argument_list|)
expr_stmt|;
name|krbret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|pam_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_init_context() failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_PERM_DENIED
operator|)
return|;
block|}
name|PAM_LOG
argument_list|(
literal|"Context initialised"
argument_list|)
expr_stmt|;
name|krbret
operator|=
name|krb5_cc_resolve
argument_list|(
name|pam_context
argument_list|,
name|ccache_name
argument_list|,
operator|&
name|ccache
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_resolve(\"%s\"): %s"
argument_list|,
name|ccache_name
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|pam_context
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_PERM_DENIED
operator|)
return|;
block|}
name|PAM_LOG
argument_list|(
literal|"Got ccache %s"
argument_list|,
name|ccache_name
argument_list|)
expr_stmt|;
name|krbret
operator|=
name|krb5_cc_get_principal
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|,
operator|&
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_cc_get_principal(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_PERM_DENIED
expr_stmt|;
empty_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Got principal"
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5_kuserok
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|,
name|user
argument_list|)
condition|)
name|retval
operator|=
name|PAM_SUCCESS
expr_stmt|;
else|else
name|retval
operator|=
name|PAM_PERM_DENIED
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done kuserok()"
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|krb5_free_context
argument_list|(
name|pam_context
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done cleanup"
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * password management  */
end_comment

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_chauthtok
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
name|__unused
parameter_list|,
specifier|const
name|char
modifier|*
name|argv
index|[]
name|__unused
parameter_list|)
block|{
name|krb5_error_code
name|krbret
decl_stmt|;
name|krb5_context
name|pam_context
decl_stmt|;
name|krb5_creds
name|creds
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|krb5_get_init_creds_opt
name|opts
decl_stmt|;
name|krb5_data
name|result_code_string
decl_stmt|,
name|result_string
decl_stmt|;
name|int
name|result_code
decl_stmt|,
name|retval
decl_stmt|;
specifier|const
name|char
modifier|*
name|user
decl_stmt|,
modifier|*
name|pass
decl_stmt|;
name|char
modifier|*
name|princ_name
decl_stmt|,
modifier|*
name|passdup
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|PAM_UPDATE_AUTHTOK
operator|)
condition|)
return|return
operator|(
name|PAM_AUTHTOK_ERR
operator|)
return|;
name|retval
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
name|PAM_LOG
argument_list|(
literal|"Got user: %s"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|krbret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|pam_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_init_context() failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
block|}
name|PAM_LOG
argument_list|(
literal|"Context initialised"
argument_list|)
expr_stmt|;
name|krb5_get_init_creds_opt_init
argument_list|(
operator|&
name|opts
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Credentials options initialised"
argument_list|)
expr_stmt|;
comment|/* Get principal name */
name|krbret
operator|=
name|krb5_parse_name
argument_list|(
name|pam_context
argument_list|,
name|user
argument_list|,
operator|&
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_parse_name(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_USER_UNKNOWN
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
comment|/* Now convert the principal name into something human readable */
name|princ_name
operator|=
name|NULL
expr_stmt|;
name|krbret
operator|=
name|krb5_unparse_name
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|,
operator|&
name|princ_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_unparse_name(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Got principal: %s"
argument_list|,
name|princ_name
argument_list|)
expr_stmt|;
comment|/* Get password */
name|retval
operator|=
name|pam_get_authtok
argument_list|(
name|pamh
argument_list|,
name|PAM_OLDAUTHTOK
argument_list|,
operator|&
name|pass
argument_list|,
name|PASSWORD_PROMPT
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
goto|goto
name|cleanup2
goto|;
name|PAM_LOG
argument_list|(
literal|"Got password"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|creds
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|krb5_creds
argument_list|)
argument_list|)
expr_stmt|;
name|krbret
operator|=
name|krb5_get_init_creds_password
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|,
name|princ
argument_list|,
name|pass
argument_list|,
name|NULL
argument_list|,
name|pamh
argument_list|,
literal|0
argument_list|,
literal|"kadmin/changepw"
argument_list|,
operator|&
name|opts
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_get_init_creds_password()"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Credentials established"
argument_list|)
expr_stmt|;
comment|/* Now get the new password */
for|for
control|(
init|;
condition|;
control|)
block|{
name|retval
operator|=
name|pam_get_authtok
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|&
name|pass
argument_list|,
name|NEW_PASSWORD_PROMPT
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_TRY_AGAIN
condition|)
break|break;
name|pam_error
argument_list|(
name|pamh
argument_list|,
literal|"Mismatch; try again, EOF to quit."
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|PAM_LOG
argument_list|(
literal|"Got new password"
argument_list|)
expr_stmt|;
comment|/* Change it */
if|if
condition|(
operator|(
name|passdup
operator|=
name|strdup
argument_list|(
name|pass
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|retval
operator|=
name|PAM_BUF_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|krbret
operator|=
name|krb5_change_password
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|,
name|passdup
argument_list|,
operator|&
name|result_code
argument_list|,
operator|&
name|result_code_string
argument_list|,
operator|&
name|result_string
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|passdup
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|!=
literal|0
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_change_password(): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|pam_context
argument_list|,
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_AUTHTOK_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|result_code
condition|)
block|{
name|PAM_LOG
argument_list|(
literal|"Error krb5_change_password(): (result_code)"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|PAM_AUTHTOK_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|PAM_LOG
argument_list|(
literal|"Password changed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result_string
operator|.
name|data
condition|)
name|free
argument_list|(
name|result_string
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|result_code_string
operator|.
name|data
condition|)
name|free
argument_list|(
name|result_code_string
operator|.
name|data
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|krb5_free_cred_contents
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done cleanup"
argument_list|)
expr_stmt|;
name|cleanup2
label|:
name|krb5_free_principal
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done cleanup2"
argument_list|)
expr_stmt|;
name|cleanup3
label|:
if|if
condition|(
name|princ_name
condition|)
name|free
argument_list|(
name|princ_name
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|pam_context
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Done cleanup3"
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|PAM_MODULE_ENTRY
argument_list|(
literal|"pam_krb5"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * This routine with some modification is from the MIT V5B6 appl/bsd/login.c  * Modified by Sam Hartman<hartmans@mit.edu> to support PAM services  * for Debian.  *  * Verify the Kerberos ticket-granting ticket just retrieved for the  * user.  If the Kerberos server doesn't respond, assume the user is  * trying to fake us out (since we DID just get a TGT from what is  * supposedly our KDC).  If the host/<host> service is unknown (i.e.,  * the local keytab doesn't have it), and we cannot find another  * service we do have, let her in.  *  * Returns 1 for confirmation, -1 for failure, 0 for uncertainty.  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|verify_krb_v5_tgt
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ccache
name|ccache
parameter_list|,
name|char
modifier|*
name|pam_service
parameter_list|,
name|int
name|debug
parameter_list|)
block|{
name|krb5_error_code
name|retval
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|krb5_keyblock
modifier|*
name|keyblock
decl_stmt|;
name|krb5_data
name|packet
decl_stmt|;
name|krb5_auth_context
name|auth_context
decl_stmt|;
name|char
name|phost
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|services
index|[
literal|3
index|]
decl_stmt|,
modifier|*
modifier|*
name|service
decl_stmt|;
name|packet
operator|.
name|data
operator|=
literal|0
expr_stmt|;
comment|/* If possible we want to try and verify the ticket we have 	 * received against a keytab.  We will try multiple service 	 * principals, including at least the host principal and the PAM 	 * service principal.  The host principal is preferred because access 	 * to that key is generally sufficient to compromise root, while the 	 * service key for this PAM service may be less carefully guarded. 	 * It is important to check the keytab first before the KDC so we do 	 * not get spoofed by a fake KDC. 	 */
name|services
index|[
literal|0
index|]
operator|=
literal|"host"
expr_stmt|;
name|services
index|[
literal|1
index|]
operator|=
name|pam_service
expr_stmt|;
name|services
index|[
literal|2
index|]
operator|=
name|NULL
expr_stmt|;
name|keyblock
operator|=
literal|0
expr_stmt|;
name|retval
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|service
operator|=
operator|&
name|services
index|[
literal|0
index|]
init|;
operator|*
name|service
operator|!=
name|NULL
condition|;
name|service
operator|++
control|)
block|{
name|retval
operator|=
name|krb5_sname_to_principal
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
operator|*
name|service
argument_list|,
name|KRB5_NT_SRV_HST
argument_list|,
operator|&
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|syslog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_krb5: verify_krb_v5_tgt(): %s: %s"
argument_list|,
literal|"krb5_sname_to_principal()"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|retval
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Extract the name directly. */
name|strncpy
argument_list|(
name|phost
argument_list|,
name|compat_princ_component
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
literal|1
argument_list|)
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
name|phost
index|[
name|BUFSIZ
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* 		 * Do we have service/<host> keys? 		 * (use default/configured keytab, kvno IGNORE_VNO to get the 		 * first match, and ignore enctype.) 		 */
name|retval
operator|=
name|krb5_kt_read_service_key
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|princ
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|keyblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
continue|continue;
break|break;
block|}
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
block|{
comment|/* failed to find key */
comment|/* Keytab or service key does not exist */
if|if
condition|(
name|debug
condition|)
name|syslog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_krb5: verify_krb_v5_tgt(): %s: %s"
argument_list|,
literal|"krb5_kt_read_service_key()"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|retval
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|keyblock
condition|)
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|keyblock
argument_list|)
expr_stmt|;
comment|/* Talk to the kdc and construct the ticket. */
name|auth_context
operator|=
name|NULL
expr_stmt|;
name|retval
operator|=
name|krb5_mk_req
argument_list|(
name|context
argument_list|,
operator|&
name|auth_context
argument_list|,
literal|0
argument_list|,
operator|*
name|service
argument_list|,
name|phost
argument_list|,
name|NULL
argument_list|,
name|ccache
argument_list|,
operator|&
name|packet
argument_list|)
expr_stmt|;
if|if
condition|(
name|auth_context
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|auth_context
argument_list|)
expr_stmt|;
name|auth_context
operator|=
name|NULL
expr_stmt|;
comment|/* setup for rd_req */
block|}
if|if
condition|(
name|retval
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|syslog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_krb5: verify_krb_v5_tgt(): %s: %s"
argument_list|,
literal|"krb5_mk_req()"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|retval
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Try to use the ticket. */
name|retval
operator|=
name|krb5_rd_req
argument_list|(
name|context
argument_list|,
operator|&
name|auth_context
argument_list|,
operator|&
name|packet
argument_list|,
name|princ
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|syslog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"pam_krb5: verify_krb_v5_tgt(): %s: %s"
argument_list|,
literal|"krb5_rd_req()"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|retval
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|retval
operator|=
literal|1
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|packet
operator|.
name|data
condition|)
name|compat_free_data_contents
argument_list|(
name|context
argument_list|,
operator|&
name|packet
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/* Free the memory for cache_name. Called by pam_end() */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|cleanup_cache
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
name|__unused
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|pam_end_status
name|__unused
parameter_list|)
block|{
name|krb5_context
name|pam_context
decl_stmt|;
name|krb5_ccache
name|ccache
decl_stmt|;
name|krb5_error_code
name|krbret
decl_stmt|;
if|if
condition|(
name|krb5_init_context
argument_list|(
operator|&
name|pam_context
argument_list|)
condition|)
return|return;
name|krbret
operator|=
name|krb5_cc_resolve
argument_list|(
name|pam_context
argument_list|,
name|data
argument_list|,
operator|&
name|ccache
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbret
operator|==
literal|0
condition|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|pam_context
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|COMPAT_HEIMDAL
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|COMPAT_MIT
end_ifdef

begin_error
error|#
directive|error
error|This cannot be MIT and Heimdal compatible!
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|COMPAT_HEIMDAL
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|COMPAT_MIT
end_ifndef

begin_error
error|#
directive|error
error|One of COMPAT_MIT and COMPAT_HEIMDAL must be specified!
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|COMPAT_HEIMDAL
end_ifdef

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|compat_princ_component
parameter_list|(
name|krb5_context
name|context
name|__unused
parameter_list|,
name|krb5_principal
name|princ
parameter_list|,
name|int
name|n
parameter_list|)
block|{
return|return
name|princ
operator|->
name|name
operator|.
name|name_string
operator|.
name|val
index|[
name|n
index|]
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|compat_free_data_contents
parameter_list|(
name|krb5_context
name|context
name|__unused
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_xfree
argument_list|(
name|data
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|COMPAT_MIT
end_ifdef

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|compat_princ_component
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_principal
name|princ
parameter_list|,
name|int
name|n
parameter_list|)
block|{
return|return
name|krb5_princ_component
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
name|n
argument_list|)
operator|->
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|compat_free_data_contents
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_free_data_contents
argument_list|(
name|context
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


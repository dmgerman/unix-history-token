begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * pam_krb5_pass.c  *  * PAM password management functions for pam_krb5  *  * $FreeBSD$  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$Id: pam_krb5_pass.c,v 1.3 1999/01/19 23:43:11 fcusack Exp $"
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_comment
comment|/* sprintf */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_comment
comment|/* malloc */
end_comment

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_comment
comment|/* syslog */
end_comment

begin_include
include|#
directive|include
file|<security/pam_appl.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_modules.h>
end_include

begin_include
include|#
directive|include
file|<krb5.h>
end_include

begin_include
include|#
directive|include
file|<com_err.h>
end_include

begin_include
include|#
directive|include
file|"pam_krb5.h"
end_include

begin_comment
comment|/* A useful logging macro */
end_comment

begin_define
define|#
directive|define
name|DLOG
parameter_list|(
name|error_func
parameter_list|,
name|error_msg
parameter_list|)
define|\
value|if (debug) \     syslog(LOG_DEBUG, "pam_krb5: pam_sm_chauthtok(%s %s): %s: %s", \ 	   service, name, error_func, error_msg)
end_define

begin_comment
comment|/* Change a user's password */
end_comment

begin_function
name|int
name|pam_sm_chauthtok
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|krb5_error_code
name|krbret
decl_stmt|;
name|krb5_context
name|pam_context
decl_stmt|;
name|krb5_creds
name|creds
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|krb5_get_init_creds_opt
name|opts
decl_stmt|;
name|int
name|result_code
decl_stmt|;
name|krb5_data
name|result_code_string
decl_stmt|,
name|result_string
decl_stmt|;
name|int
name|pamret
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|service
init|=
name|NULL
decl_stmt|,
modifier|*
name|pass
init|=
name|NULL
decl_stmt|,
modifier|*
name|pass2
decl_stmt|;
name|char
modifier|*
name|princ_name
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|prompt
init|=
name|NULL
decl_stmt|;
name|int
name|debug
init|=
literal|0
decl_stmt|;
name|int
name|try_first_pass
init|=
literal|0
decl_stmt|,
name|use_first_pass
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|PAM_UPDATE_AUTHTOK
operator|)
condition|)
return|return
name|PAM_AUTHTOK_ERR
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"debug"
argument_list|)
operator|==
literal|0
condition|)
name|debug
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"try_first_pass"
argument_list|)
operator|==
literal|0
condition|)
name|try_first_pass
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"use_first_pass"
argument_list|)
operator|==
literal|0
condition|)
name|use_first_pass
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Get username */
if|if
condition|(
operator|(
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|name
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
return|return
name|PAM_SERVICE_ERR
return|;
block|}
comment|/* Get service name */
operator|(
name|void
operator|)
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_SERVICE
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|service
condition|)
name|service
operator|=
literal|"unknown"
expr_stmt|;
name|DLOG
argument_list|(
literal|"entry"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|pam_context
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_init_context()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|PAM_SERVICE_ERR
return|;
block|}
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|pam_context
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_init_context()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|PAM_SERVICE_ERR
return|;
block|}
name|krb5_get_init_creds_opt_init
argument_list|(
operator|&
name|opts
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|creds
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|krb5_creds
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Get principal name */
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_parse_name
argument_list|(
name|pam_context
argument_list|,
name|name
argument_list|,
operator|&
name|princ
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_parse_name()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_USER_UNKNOWN
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
comment|/* Now convert the principal name into something human readable */
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_unparse_name
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|,
operator|&
name|princ_name
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_unparse_name()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
comment|/* Get password */
name|prompt
operator|=
name|malloc
argument_list|(
literal|16
operator|+
name|strlen
argument_list|(
name|princ_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|prompt
condition|)
block|{
name|DLOG
argument_list|(
literal|"malloc()"
argument_list|,
literal|"failure"
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_BUF_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|prompt
argument_list|,
literal|"Password for %s: "
argument_list|,
name|princ_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|try_first_pass
operator|||
name|use_first_pass
condition|)
operator|(
name|void
operator|)
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|pass
argument_list|)
expr_stmt|;
name|get_pass
label|:
if|if
condition|(
operator|!
name|pass
condition|)
block|{
name|try_first_pass
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|pamret
operator|=
name|get_user_info
argument_list|(
name|pamh
argument_list|,
name|prompt
argument_list|,
name|PAM_PROMPT_ECHO_OFF
argument_list|,
operator|&
name|pass
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"get_user_info()"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|pamret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
comment|/* We have to free pass. */
if|if
condition|(
operator|(
name|pamret
operator|=
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
name|pass
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"pam_set_item()"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|pamret
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
comment|/* Now we get it back from the library. */
operator|(
name|void
operator|)
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|pass
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_get_init_creds_password
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|,
name|princ
argument_list|,
name|pass
argument_list|,
name|pam_prompter
argument_list|,
name|pamh
argument_list|,
literal|0
argument_list|,
literal|"kadmin/changepw"
argument_list|,
operator|&
name|opts
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_get_init_creds_password()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|try_first_pass
operator|&&
name|krbret
operator|==
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
condition|)
block|{
name|pass
operator|=
name|NULL
expr_stmt|;
goto|goto
name|get_pass
goto|;
block|}
name|pamret
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
comment|/* Now get the new password */
name|free
argument_list|(
name|prompt
argument_list|)
expr_stmt|;
name|prompt
operator|=
literal|"Enter new password: "
expr_stmt|;
if|if
condition|(
operator|(
name|pamret
operator|=
name|get_user_info
argument_list|(
name|pamh
argument_list|,
name|prompt
argument_list|,
name|PAM_PROMPT_ECHO_OFF
argument_list|,
operator|&
name|pass
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"get_user_info()"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|pamret
argument_list|)
argument_list|)
expr_stmt|;
name|prompt
operator|=
name|NULL
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|prompt
operator|=
literal|"Enter it again: "
expr_stmt|;
if|if
condition|(
operator|(
name|pamret
operator|=
name|get_user_info
argument_list|(
name|pamh
argument_list|,
name|prompt
argument_list|,
name|PAM_PROMPT_ECHO_OFF
argument_list|,
operator|&
name|pass2
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"get_user_info()"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|pamret
argument_list|)
argument_list|)
expr_stmt|;
name|prompt
operator|=
name|NULL
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|prompt
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|pass
argument_list|,
name|pass2
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"strcmp()"
argument_list|,
literal|"passwords not equal"
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_AUTHTOK_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Change it */
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_change_password
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|,
name|pass
argument_list|,
operator|&
name|result_code
argument_list|,
operator|&
name|result_code_string
argument_list|,
operator|&
name|result_string
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_change_password()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_AUTHTOK_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|result_code
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_change_password() (result_code)"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_AUTHTOK_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|result_string
operator|.
name|data
condition|)
name|free
argument_list|(
name|result_string
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|result_code_string
operator|.
name|data
condition|)
name|free
argument_list|(
name|result_code_string
operator|.
name|data
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|krb5_free_cred_contents
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
name|cleanup2
label|:
name|krb5_free_principal
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|cleanup3
label|:
if|if
condition|(
name|prompt
condition|)
name|free
argument_list|(
name|prompt
argument_list|)
expr_stmt|;
if|if
condition|(
name|princ_name
condition|)
name|free
argument_list|(
name|princ_name
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|pam_context
argument_list|)
expr_stmt|;
name|DLOG
argument_list|(
literal|"exit"
argument_list|,
name|pamret
condition|?
literal|"failure"
else|:
literal|"success"
argument_list|)
expr_stmt|;
return|return
name|pamret
return|;
block|}
end_function

end_unit


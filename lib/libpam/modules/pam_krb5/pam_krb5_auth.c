begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * pam_krb5_auth.c  *  * PAM authentication management functions for pam_krb5  *  * $FreeBSD$  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$Id: pam_krb5_auth.c,v 1.18 2000/01/04 08:44:08 fcusack Exp $"
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_comment
comment|/* PATH_MAX */
end_comment

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_comment
comment|/* getpwnam */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_comment
comment|/* tmpnam */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_comment
comment|/* malloc  */
end_comment

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_comment
comment|/* strchr */
end_comment

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_comment
comment|/* syslog */
end_comment

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_comment
comment|/* chown */
end_comment

begin_include
include|#
directive|include
file|<security/pam_appl.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_modules.h>
end_include

begin_include
include|#
directive|include
file|<krb5.h>
end_include

begin_include
include|#
directive|include
file|<com_err.h>
end_include

begin_include
include|#
directive|include
file|"pam_krb5.h"
end_include

begin_decl_stmt
specifier|extern
name|krb5_cc_ops
name|krb5_mcc_ops
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* A useful logging macro */
end_comment

begin_define
define|#
directive|define
name|DLOG
parameter_list|(
name|error_func
parameter_list|,
name|error_msg
parameter_list|)
define|\
value|if (debug) \     syslog(LOG_DEBUG, "pam_krb5: pam_sm_authenticate(%s %s): %s: %s", \ 	   service, name, error_func, error_msg)
end_define

begin_comment
comment|/* Authenticate a user via krb5 */
end_comment

begin_function
name|int
name|pam_sm_authenticate
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|krb5_error_code
name|krbret
decl_stmt|;
name|krb5_context
name|pam_context
decl_stmt|;
name|krb5_creds
name|creds
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|krb5_ccache
name|ccache
decl_stmt|,
name|ccache_check
decl_stmt|;
name|krb5_get_init_creds_opt
name|opts
decl_stmt|;
name|int
name|pamret
decl_stmt|,
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|source_princ
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|princ_name
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|pass
init|=
name|NULL
decl_stmt|,
modifier|*
name|service
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|prompt
init|=
name|NULL
decl_stmt|;
name|char
name|cache_name
index|[
name|L_tmpnam
operator|+
literal|8
index|]
decl_stmt|;
name|char
name|lname
index|[
literal|64
index|]
decl_stmt|;
comment|/* local acct name */
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|uid_t
name|ruid
decl_stmt|;
name|int
name|debug
init|=
literal|0
decl_stmt|,
name|try_first_pass
init|=
literal|0
decl_stmt|,
name|use_first_pass
init|=
literal|0
decl_stmt|;
name|int
name|forwardable
init|=
literal|0
decl_stmt|,
name|reuse_ccache
init|=
literal|0
decl_stmt|,
name|no_ccache
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"debug"
argument_list|)
operator|==
literal|0
condition|)
name|debug
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"try_first_pass"
argument_list|)
operator|==
literal|0
condition|)
name|try_first_pass
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"use_first_pass"
argument_list|)
operator|==
literal|0
condition|)
name|use_first_pass
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"forwardable"
argument_list|)
operator|==
literal|0
condition|)
name|forwardable
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"reuse_ccache"
argument_list|)
operator|==
literal|0
condition|)
name|reuse_ccache
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"no_ccache"
argument_list|)
operator|==
literal|0
condition|)
name|no_ccache
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Get username */
if|if
condition|(
operator|(
name|pamret
operator|=
name|pam_get_user
argument_list|(
name|pamh
argument_list|,
operator|&
name|name
argument_list|,
literal|"login: "
argument_list|)
operator|)
operator|!=
name|PAM_SUCCESS
condition|)
block|{
return|return
name|PAM_SERVICE_ERR
return|;
block|}
comment|/* Get service name */
operator|(
name|void
operator|)
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_SERVICE
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|service
condition|)
name|service
operator|=
literal|"unknown"
expr_stmt|;
name|DLOG
argument_list|(
literal|"entry"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|pam_context
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_init_context()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|PAM_SERVICE_ERR
return|;
block|}
name|krb5_get_init_creds_opt_init
argument_list|(
operator|&
name|opts
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|creds
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|krb5_creds
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|cache_name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cache_name
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|lname
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|lname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|forwardable
condition|)
name|krb5_get_init_creds_opt_set_forwardable
argument_list|(
operator|&
name|opts
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* For CNS */
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_register
argument_list|(
name|pam_context
argument_list|,
operator|&
name|krb5_mcc_ops
argument_list|,
name|FALSE
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Solaris dtlogin doesn't call pam_end() on failure */
if|if
condition|(
name|krbret
operator|!=
name|KRB5_CC_TYPE_EXISTS
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_cc_register()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
block|}
comment|/* Get principal name */
comment|/* This case is for use mainly by su.        If non-root is authenticating as "root", use "source_user/root".  */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"root"
argument_list|)
operator|&&
operator|(
name|ruid
operator|=
name|getuid
argument_list|()
operator|)
operator|!=
literal|0
condition|)
block|{
name|pw
operator|=
name|getpwuid
argument_list|(
name|ruid
argument_list|)
expr_stmt|;
if|if
condition|(
name|pw
operator|!=
name|NULL
condition|)
name|source_princ
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|pw
operator|->
name|pw_name
argument_list|)
operator|+
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|source_princ
condition|)
name|sprintf
argument_list|(
name|source_princ
argument_list|,
literal|"%s/root"
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|source_princ
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|source_princ
condition|)
block|{
name|DLOG
argument_list|(
literal|"malloc()"
argument_list|,
literal|"failure"
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_BUF_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_parse_name
argument_list|(
name|pam_context
argument_list|,
name|source_princ
argument_list|,
operator|&
name|princ
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_parse_name()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
comment|/* Now convert the principal name into something human readable */
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_unparse_name
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|,
operator|&
name|princ_name
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_unparse_name()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
comment|/* Get password */
name|prompt
operator|=
name|malloc
argument_list|(
literal|16
operator|+
name|strlen
argument_list|(
name|princ_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|prompt
condition|)
block|{
name|DLOG
argument_list|(
literal|"malloc()"
argument_list|,
literal|"failure"
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_BUF_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|prompt
argument_list|,
literal|"Password for %s: "
argument_list|,
name|princ_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|try_first_pass
operator|||
name|use_first_pass
condition|)
operator|(
name|void
operator|)
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|pass
argument_list|)
expr_stmt|;
name|get_pass
label|:
if|if
condition|(
operator|!
name|pass
condition|)
block|{
name|try_first_pass
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|pamret
operator|=
name|get_user_info
argument_list|(
name|pamh
argument_list|,
name|prompt
argument_list|,
name|PAM_PROMPT_ECHO_OFF
argument_list|,
operator|&
name|pass
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"get_user_info()"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|pamret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
comment|/* We have to free pass. */
if|if
condition|(
operator|(
name|pamret
operator|=
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
name|pass
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"pam_set_item()"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|pamret
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
comment|/* Now we get it back from the library. */
operator|(
name|void
operator|)
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|pass
argument_list|)
expr_stmt|;
block|}
comment|/* get a local account name for this principal */
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_aname_to_localname
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|,
sizeof|sizeof
argument_list|(
name|lname
argument_list|)
argument_list|,
name|lname
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"changing PAM_USER to"
argument_list|,
name|lname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pamret
operator|=
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
name|lname
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"pam_set_item()"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|pamret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
if|if
condition|(
operator|(
name|pamret
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|name
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|DLOG
argument_list|(
literal|"pam_get_item()"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|pamret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
block|}
else|else
block|{
name|DLOG
argument_list|(
literal|"krb5_aname_to_localname()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Not an error.  */
block|}
comment|/* Verify the local user exists (AFTER getting the password) */
name|pw
operator|=
name|getpwnam
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pw
condition|)
block|{
name|DLOG
argument_list|(
literal|"getpwnam()"
argument_list|,
name|lname
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_USER_UNKNOWN
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
comment|/* Get a TGT */
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_get_init_creds_password
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|,
name|princ
argument_list|,
name|pass
argument_list|,
name|pam_prompter
argument_list|,
name|pamh
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|opts
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_get_init_creds_password()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|try_first_pass
operator|&&
name|krbret
operator|==
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
condition|)
block|{
name|pass
operator|=
name|NULL
expr_stmt|;
goto|goto
name|get_pass
goto|;
block|}
name|pamret
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
comment|/* Generate a unique cache_name */
name|strcpy
argument_list|(
name|cache_name
argument_list|,
literal|"MEMORY:"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|tmpnam
argument_list|(
operator|&
name|cache_name
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_resolve
argument_list|(
name|pam_context
argument_list|,
name|cache_name
argument_list|,
operator|&
name|ccache
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_cc_resolve()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_initialize
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|,
name|princ
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_cc_initialize()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_store_cred
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|,
operator|&
name|creds
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_cc_store_cred()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Verify it */
if|if
condition|(
name|verify_krb_v5_tgt
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|,
name|service
argument_list|,
name|debug
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* A successful authentication, store ccache for sm_setcred() */
if|if
condition|(
operator|!
name|pam_get_data
argument_list|(
name|pamh
argument_list|,
literal|"ccache"
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|ccache_check
argument_list|)
condition|)
block|{
name|DLOG
argument_list|(
literal|"pam_get_data()"
argument_list|,
literal|"ccache data already present"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_AUTH_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
operator|(
name|pamret
operator|=
name|pam_set_data
argument_list|(
name|pamh
argument_list|,
literal|"ccache"
argument_list|,
name|ccache
argument_list|,
name|cleanup_cache
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"pam_set_data()"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|pamret
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|cleanup
label|:
name|krb5_free_cred_contents
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
name|cleanup2
label|:
name|krb5_free_principal
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|cleanup3
label|:
if|if
condition|(
name|prompt
condition|)
name|free
argument_list|(
name|prompt
argument_list|)
expr_stmt|;
if|if
condition|(
name|princ_name
condition|)
name|free
argument_list|(
name|princ_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|source_princ
condition|)
name|free
argument_list|(
name|source_princ
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|pam_context
argument_list|)
expr_stmt|;
name|DLOG
argument_list|(
literal|"exit"
argument_list|,
name|pamret
condition|?
literal|"failure"
else|:
literal|"success"
argument_list|)
expr_stmt|;
return|return
name|pamret
return|;
block|}
end_function

begin_comment
comment|/* redefine this for pam_sm_setcred() */
end_comment

begin_undef
undef|#
directive|undef
name|DLOG
end_undef

begin_define
define|#
directive|define
name|DLOG
parameter_list|(
name|error_func
parameter_list|,
name|error_msg
parameter_list|)
define|\
value|if (debug) \     syslog(LOG_DEBUG, "pam_krb5: pam_sm_setcred(%s %s): %s: %s", \ 	   service, name, error_func, error_msg)
end_define

begin_comment
comment|/* Called after a successful authentication. Set user credentials. */
end_comment

begin_function
name|int
name|pam_sm_setcred
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|krb5_error_code
name|krbret
decl_stmt|;
name|krb5_context
name|pam_context
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|krb5_creds
name|creds
decl_stmt|;
name|krb5_ccache
name|ccache_temp
decl_stmt|,
name|ccache_perm
decl_stmt|;
name|krb5_cc_cursor
name|cursor
decl_stmt|;
name|int
name|i
decl_stmt|,
name|pamret
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|service
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|cache_name
init|=
name|NULL
decl_stmt|,
modifier|*
name|cache_env_name
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pw
init|=
name|NULL
decl_stmt|;
name|int
name|debug
init|=
literal|0
decl_stmt|;
name|uid_t
name|euid
decl_stmt|;
name|gid_t
name|egid
decl_stmt|;
if|if
condition|(
name|flags
operator|==
name|PAM_REINITIALIZE_CRED
condition|)
return|return
name|PAM_SUCCESS
return|;
comment|/* XXX Incorrect behavior */
if|if
condition|(
name|flags
operator|!=
name|PAM_ESTABLISH_CRED
operator|&&
name|flags
operator|!=
name|PAM_DELETE_CRED
condition|)
return|return
name|PAM_SERVICE_ERR
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"debug"
argument_list|)
operator|==
literal|0
condition|)
name|debug
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"no_ccache"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|PAM_SUCCESS
return|;
elseif|else
if|if
condition|(
name|strstr
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"ccache="
argument_list|)
operator|==
name|argv
index|[
name|i
index|]
condition|)
name|cache_name
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|argv
index|[
name|i
index|]
index|[
literal|7
index|]
expr_stmt|;
comment|/* save for later */
block|}
comment|/* Get username */
if|if
condition|(
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|name
argument_list|)
condition|)
block|{
return|return
name|PAM_SERVICE_ERR
return|;
block|}
comment|/* Get service name */
operator|(
name|void
operator|)
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_SERVICE
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|service
condition|)
name|service
operator|=
literal|"unknown"
expr_stmt|;
name|DLOG
argument_list|(
literal|"entry"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|pam_context
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_init_context()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|PAM_SERVICE_ERR
return|;
block|}
name|euid
operator|=
name|geteuid
argument_list|()
expr_stmt|;
comment|/* Usually 0 */
name|egid
operator|=
name|getegid
argument_list|()
expr_stmt|;
comment|/* Retrieve the cache name */
if|if
condition|(
operator|(
name|pamret
operator|=
name|pam_get_data
argument_list|(
name|pamh
argument_list|,
literal|"ccache"
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|*
operator|)
operator|&
name|ccache_temp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* User did not use krb5 to login */
name|DLOG
argument_list|(
literal|"ccache"
argument_list|,
literal|"not found"
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SUCCESS
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
comment|/* Get the uid. This should exist. */
name|pw
operator|=
name|getpwnam
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pw
condition|)
block|{
name|DLOG
argument_list|(
literal|"getpwnam()"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_USER_UNKNOWN
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
comment|/* Avoid following a symlink as root */
if|if
condition|(
name|setegid
argument_list|(
name|pw
operator|->
name|pw_gid
argument_list|)
condition|)
block|{
name|DLOG
argument_list|(
literal|"setegid()"
argument_list|,
name|name
argument_list|)
expr_stmt|;
comment|/* XXX should really log group name or id */
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
if|if
condition|(
name|seteuid
argument_list|(
name|pw
operator|->
name|pw_uid
argument_list|)
condition|)
block|{
name|DLOG
argument_list|(
literal|"seteuid()"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
comment|/* Get the cache name */
if|if
condition|(
operator|!
name|cache_name
condition|)
block|{
name|cache_name
operator|=
name|malloc
argument_list|(
literal|64
argument_list|)
expr_stmt|;
comment|/* plenty big */
if|if
condition|(
operator|!
name|cache_name
condition|)
block|{
name|DLOG
argument_list|(
literal|"malloc()"
argument_list|,
literal|"failure"
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_BUF_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
name|sprintf
argument_list|(
name|cache_name
argument_list|,
literal|"FILE:/tmp/krb5cc_%d"
argument_list|,
name|pw
operator|->
name|pw_uid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* cache_name was supplied */
name|char
modifier|*
name|p
init|=
name|calloc
argument_list|(
name|PATH_MAX
operator|+
literal|10
argument_list|,
literal|1
argument_list|)
decl_stmt|;
comment|/* should be plenty */
name|char
modifier|*
name|q
init|=
name|cache_name
decl_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|DLOG
argument_list|(
literal|"malloc()"
argument_list|,
literal|"failure"
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_BUF_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
name|cache_name
operator|=
name|p
expr_stmt|;
comment|/* convert %u and %p */
while|while
condition|(
operator|*
name|q
condition|)
block|{
if|if
condition|(
operator|*
name|q
operator|==
literal|'%'
condition|)
block|{
name|q
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|q
operator|==
literal|'u'
condition|)
block|{
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"%d"
argument_list|,
name|pw
operator|->
name|pw_uid
argument_list|)
expr_stmt|;
name|p
operator|+=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|q
operator|==
literal|'p'
condition|)
block|{
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"%d"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|p
operator|+=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Not a special token */
operator|*
name|p
operator|++
operator|=
literal|'%'
expr_stmt|;
name|q
operator|--
expr_stmt|;
block|}
name|q
operator|++
expr_stmt|;
block|}
else|else
block|{
operator|*
name|p
operator|++
operator|=
operator|*
name|q
operator|++
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_resolve
argument_list|(
name|pam_context
argument_list|,
name|cache_name
argument_list|,
operator|&
name|ccache_perm
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_cc_resolve()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
if|if
condition|(
name|flags
operator|==
name|PAM_ESTABLISH_CRED
condition|)
block|{
comment|/* Initialize the new ccache */
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_get_principal
argument_list|(
name|pam_context
argument_list|,
name|ccache_temp
argument_list|,
operator|&
name|princ
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_cc_get_principal()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup3
goto|;
block|}
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_initialize
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|,
name|princ
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_cc_initialize()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
comment|/* Prepare for iteration over creds */
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_start_seq_get
argument_list|(
name|pam_context
argument_list|,
name|ccache_temp
argument_list|,
operator|&
name|cursor
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_cc_start_seq_get()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
comment|/* Copy the creds (should be two of them) */
while|while
condition|(
operator|(
name|krbret
operator|=
name|compat_cc_next_cred
argument_list|(
name|pam_context
argument_list|,
name|ccache_temp
argument_list|,
operator|&
name|cursor
argument_list|,
operator|&
name|creds
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_store_cred
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|,
operator|&
name|creds
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"krb5_cc_store_cred()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|krb5_free_cred_contents
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|krb5_free_cred_contents
argument_list|(
name|pam_context
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|krb5_cc_end_seq_get
argument_list|(
name|pam_context
argument_list|,
name|ccache_temp
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
name|strstr
argument_list|(
name|cache_name
argument_list|,
literal|"FILE:"
argument_list|)
operator|==
name|cache_name
condition|)
block|{
if|if
condition|(
name|chown
argument_list|(
operator|&
name|cache_name
index|[
literal|5
index|]
argument_list|,
name|pw
operator|->
name|pw_uid
argument_list|,
name|pw
operator|->
name|pw_gid
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|DLOG
argument_list|(
literal|"chown()"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
if|if
condition|(
name|chmod
argument_list|(
operator|&
name|cache_name
index|[
literal|5
index|]
argument_list|,
operator|(
name|S_IRUSR
operator||
name|S_IWUSR
operator|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|DLOG
argument_list|(
literal|"chmod()"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
block|}
operator|(
name|void
operator|)
name|krb5_cc_close
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|cache_env_name
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|cache_name
argument_list|)
operator|+
literal|12
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cache_env_name
condition|)
block|{
name|DLOG
argument_list|(
literal|"malloc()"
argument_list|,
literal|"failure"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_BUF_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
name|sprintf
argument_list|(
name|cache_env_name
argument_list|,
literal|"KRB5CCNAME=%s"
argument_list|,
name|cache_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pamret
operator|=
name|pam_putenv
argument_list|(
name|pamh
argument_list|,
name|cache_env_name
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DLOG
argument_list|(
literal|"pam_putenv()"
argument_list|,
name|pam_strerror
argument_list|(
name|pamh
argument_list|,
name|pamret
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
expr_stmt|;
name|pamret
operator|=
name|PAM_SERVICE_ERR
expr_stmt|;
goto|goto
name|cleanup2
goto|;
block|}
block|}
else|else
block|{
comment|/* flag == PAM_DELETE_CRED */
if|if
condition|(
operator|(
name|krbret
operator|=
name|krb5_cc_destroy
argument_list|(
name|pam_context
argument_list|,
name|ccache_perm
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* log error, but otherwise ignore it */
name|DLOG
argument_list|(
literal|"krb5_cc_destroy()"
argument_list|,
name|error_message
argument_list|(
name|krbret
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|cleanup3
goto|;
block|}
name|cleanup2
label|:
name|krb5_free_principal
argument_list|(
name|pam_context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|cleanup3
label|:
name|krb5_free_context
argument_list|(
name|pam_context
argument_list|)
expr_stmt|;
name|DLOG
argument_list|(
literal|"exit"
argument_list|,
name|pamret
condition|?
literal|"failure"
else|:
literal|"success"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|seteuid
argument_list|(
name|euid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setegid
argument_list|(
name|egid
argument_list|)
expr_stmt|;
return|return
name|pamret
return|;
block|}
end_function

end_unit


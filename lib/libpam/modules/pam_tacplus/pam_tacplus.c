begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 1998 Juniper Networks, Inc.  * All rights reserved.  * Copyright (c) 2001,2002 Networks Associates Technology, Inc.  * All rights reserved.  *  * Portions of this software were developed for the FreeBSD Project by  * ThinkSec AS and NAI Labs, the Security Research Division of Network  * Associates, Inc.  under DARPA/SPAWAR contract N66001-01-C-8035  * ("CBOSS"), as part of the DARPA CHATS research program.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote  *    products derived from this software without specific prior written  *    permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<taclib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_define
define|#
directive|define
name|PAM_SM_AUTH
end_define

begin_include
include|#
directive|include
file|<security/pam_appl.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_modules.h>
end_include

begin_include
include|#
directive|include
file|<security/pam_mod_misc.h>
end_include

begin_enum
enum|enum
block|{
name|PAM_OPT_CONF
init|=
name|PAM_OPT_STD_MAX
block|,
name|PAM_OPT_TEMPLATE_USER
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
name|struct
name|opttab
name|other_options
index|[]
init|=
block|{
block|{
literal|"conf"
block|,
name|PAM_OPT_CONF
block|}
block|,
block|{
literal|"template_user"
block|,
name|PAM_OPT_TEMPLATE_USER
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
name|int
function_decl|(
modifier|*
name|set_func
function_decl|)
parameter_list|(
name|struct
name|tac_handle
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_typedef

begin_function_decl
specifier|static
name|int
name|do_item
parameter_list|(
name|pam_handle_t
modifier|*
parameter_list|,
name|struct
name|tac_handle
modifier|*
parameter_list|,
name|int
parameter_list|,
name|set_func
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|get_msg
parameter_list|(
name|struct
name|tac_handle
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|set_msg
parameter_list|(
name|struct
name|tac_handle
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|do_item
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|struct
name|tac_handle
modifier|*
name|tach
parameter_list|,
name|int
name|item
parameter_list|,
name|set_func
name|func
parameter_list|,
specifier|const
name|char
modifier|*
name|funcname
parameter_list|)
block|{
name|int
name|retval
decl_stmt|;
specifier|const
name|void
modifier|*
name|value
decl_stmt|;
name|retval
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|item
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
name|retval
return|;
if|if
condition|(
name|value
operator|!=
name|NULL
operator|&&
call|(
modifier|*
name|func
call|)
argument_list|(
name|tach
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|value
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"%s: %s"
argument_list|,
name|funcname
argument_list|,
name|tac_strerror
argument_list|(
name|tach
argument_list|)
argument_list|)
expr_stmt|;
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
return|return
name|PAM_SERVICE_ERR
return|;
block|}
return|return
name|PAM_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|get_msg
parameter_list|(
name|struct
name|tac_handle
modifier|*
name|tach
parameter_list|)
block|{
name|char
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|tac_get_msg
argument_list|(
name|tach
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"tac_get_msg: %s"
argument_list|,
name|tac_strerror
argument_list|(
name|tach
argument_list|)
argument_list|)
expr_stmt|;
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_msg
parameter_list|(
name|struct
name|tac_handle
modifier|*
name|tach
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|tac_set_msg
argument_list|(
name|tach
argument_list|,
name|msg
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"tac_set_msg: %s"
argument_list|,
name|tac_strerror
argument_list|(
name|tach
argument_list|)
argument_list|)
expr_stmt|;
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_authenticate
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
name|__unused
parameter_list|,
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|options
name|options
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|struct
name|tac_handle
modifier|*
name|tach
decl_stmt|;
name|char
modifier|*
name|conf_file
decl_stmt|;
name|char
modifier|*
name|template_user
decl_stmt|;
name|pam_std_option
argument_list|(
operator|&
name|options
argument_list|,
name|other_options
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Options processed"
argument_list|)
expr_stmt|;
name|conf_file
operator|=
name|NULL
expr_stmt|;
name|pam_test_option
argument_list|(
operator|&
name|options
argument_list|,
name|PAM_OPT_CONF
argument_list|,
operator|&
name|conf_file
argument_list|)
expr_stmt|;
name|template_user
operator|=
name|NULL
expr_stmt|;
name|pam_test_option
argument_list|(
operator|&
name|options
argument_list|,
name|PAM_OPT_TEMPLATE_USER
argument_list|,
operator|&
name|template_user
argument_list|)
expr_stmt|;
name|tach
operator|=
name|tac_open
argument_list|()
expr_stmt|;
if|if
condition|(
name|tach
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"tac_open failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
block|}
if|if
condition|(
name|tac_config
argument_list|(
name|tach
argument_list|,
name|conf_file
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ALERT
argument_list|,
literal|"tac_config: %s"
argument_list|,
name|tac_strerror
argument_list|(
name|tach
argument_list|)
argument_list|)
expr_stmt|;
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
block|}
if|if
condition|(
name|tac_create_authen
argument_list|(
name|tach
argument_list|,
name|TAC_AUTHEN_LOGIN
argument_list|,
name|TAC_AUTHEN_TYPE_ASCII
argument_list|,
name|TAC_AUTHEN_SVC_LOGIN
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"tac_create_authen: %s"
argument_list|,
name|tac_strerror
argument_list|(
name|tach
argument_list|)
argument_list|)
expr_stmt|;
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
block|}
name|PAM_LOG
argument_list|(
literal|"Done tac_open() ... tac_close()"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|do_item
argument_list|(
name|pamh
argument_list|,
name|tach
argument_list|,
name|PAM_USER
argument_list|,
name|tac_set_user
argument_list|,
literal|"tac_set_user"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
name|PAM_LOG
argument_list|(
literal|"Done user"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|do_item
argument_list|(
name|pamh
argument_list|,
name|tach
argument_list|,
name|PAM_TTY
argument_list|,
name|tac_set_port
argument_list|,
literal|"tac_set_port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
name|PAM_LOG
argument_list|(
literal|"Done tty"
argument_list|)
expr_stmt|;
name|retval
operator|=
name|do_item
argument_list|(
name|pamh
argument_list|,
name|tach
argument_list|,
name|PAM_RHOST
argument_list|,
name|tac_set_rem_addr
argument_list|,
literal|"tac_set_rem_addr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|char
modifier|*
name|srvr_msg
decl_stmt|;
name|size_t
name|msg_len
decl_stmt|;
specifier|const
name|char
modifier|*
name|user_msg
decl_stmt|;
name|char
modifier|*
name|data_msg
decl_stmt|;
name|int
name|sflags
decl_stmt|;
name|int
name|status
decl_stmt|;
name|sflags
operator|=
name|tac_send_authen
argument_list|(
name|tach
argument_list|)
expr_stmt|;
if|if
condition|(
name|sflags
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"tac_send_authen: %s"
argument_list|,
name|tac_strerror
argument_list|(
name|tach
argument_list|)
argument_list|)
expr_stmt|;
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_AUTHINFO_UNAVAIL
operator|)
return|;
block|}
name|status
operator|=
name|TAC_AUTHEN_STATUS
argument_list|(
name|sflags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TAC_AUTHEN_NOECHO
argument_list|(
name|sflags
argument_list|)
condition|)
name|pam_set_option
argument_list|(
operator|&
name|options
argument_list|,
name|PAM_OPT_ECHO_PASS
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|TAC_AUTHEN_STATUS_PASS
case|:
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
if|if
condition|(
name|template_user
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|void
modifier|*
name|item
decl_stmt|;
specifier|const
name|char
modifier|*
name|user
decl_stmt|;
name|PAM_LOG
argument_list|(
literal|"Trying template user: %s"
argument_list|,
name|template_user
argument_list|)
expr_stmt|;
comment|/* 				 * If the given user name doesn't exist in 				 * the local password database, change it 				 * to the value given in the "template_user" 				 * option. 				 */
name|retval
operator|=
name|pam_get_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
operator|&
name|item
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
name|user
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|item
expr_stmt|;
if|if
condition|(
name|getpwnam
argument_list|(
name|user
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|pam_set_item
argument_list|(
name|pamh
argument_list|,
name|PAM_USER
argument_list|,
name|template_user
argument_list|)
expr_stmt|;
name|PAM_LOG
argument_list|(
literal|"Using template user"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|PAM_SUCCESS
operator|)
return|;
case|case
name|TAC_AUTHEN_STATUS_FAIL
case|:
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
name|PAM_VERBOSE_ERROR
argument_list|(
literal|"TACACS+ authentication failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_AUTH_ERR
operator|)
return|;
case|case
name|TAC_AUTHEN_STATUS_GETUSER
case|:
case|case
name|TAC_AUTHEN_STATUS_GETPASS
case|:
if|if
condition|(
operator|(
name|srvr_msg
operator|=
name|get_msg
argument_list|(
name|tach
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
if|if
condition|(
name|status
operator|==
name|TAC_AUTHEN_STATUS_GETUSER
condition|)
name|retval
operator|=
name|pam_get_user
argument_list|(
name|pamh
argument_list|,
operator|&
name|user_msg
argument_list|,
operator|*
name|srvr_msg
condition|?
name|srvr_msg
else|:
name|NULL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|==
name|TAC_AUTHEN_STATUS_GETPASS
condition|)
name|retval
operator|=
name|pam_get_authtok
argument_list|(
name|pamh
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|&
name|user_msg
argument_list|,
operator|*
name|srvr_msg
condition|?
name|srvr_msg
else|:
literal|"Password:"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|srvr_msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
comment|/* XXX - send a TACACS+ abort packet */
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
if|if
condition|(
name|set_msg
argument_list|(
name|tach
argument_list|,
name|user_msg
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
break|break;
case|case
name|TAC_AUTHEN_STATUS_GETDATA
case|:
if|if
condition|(
operator|(
name|srvr_msg
operator|=
name|get_msg
argument_list|(
name|tach
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
name|retval
operator|=
name|pam_prompt
argument_list|(
name|pamh
argument_list|,
name|pam_test_option
argument_list|(
operator|&
name|options
argument_list|,
name|PAM_OPT_ECHO_PASS
argument_list|,
name|NULL
argument_list|)
condition|?
name|PAM_PROMPT_ECHO_ON
else|:
name|PAM_PROMPT_ECHO_OFF
argument_list|,
operator|&
name|data_msg
argument_list|,
literal|"%s"
argument_list|,
operator|*
name|srvr_msg
condition|?
name|srvr_msg
else|:
literal|"Data:"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|srvr_msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
name|PAM_SUCCESS
condition|)
block|{
comment|/* XXX - send a TACACS+ abort packet */
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
name|retval
operator|=
name|set_msg
argument_list|(
name|tach
argument_list|,
name|data_msg
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|data_msg
argument_list|,
literal|0
argument_list|,
name|strlen
argument_list|(
name|data_msg
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data_msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|PAM_SERVICE_ERR
operator|)
return|;
break|break;
case|case
name|TAC_AUTHEN_STATUS_ERROR
case|:
name|srvr_msg
operator|=
operator|(
name|char
operator|*
operator|)
name|tac_get_data
argument_list|(
name|tach
argument_list|,
operator|&
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|srvr_msg
operator|!=
name|NULL
operator|&&
name|msg_len
operator|!=
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"tac_send_authen:"
literal|" server detected error: %s"
argument_list|,
name|srvr_msg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|srvr_msg
argument_list|)
expr_stmt|;
block|}
else|else
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"tac_send_authen: server detected error"
argument_list|)
expr_stmt|;
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_AUTHINFO_UNAVAIL
operator|)
return|;
break|break;
case|case
name|TAC_AUTHEN_STATUS_RESTART
case|:
case|case
name|TAC_AUTHEN_STATUS_FOLLOW
case|:
default|default:
name|syslog
argument_list|(
name|LOG_CRIT
argument_list|,
literal|"tac_send_authen: unexpected status %#x"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|tac_close
argument_list|(
name|tach
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_AUTHINFO_UNAVAIL
operator|)
return|;
block|}
block|}
block|}
end_function

begin_function
name|PAM_EXTERN
name|int
name|pam_sm_setcred
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
name|__unused
parameter_list|,
name|int
name|flags
name|__unused
parameter_list|,
name|int
name|argc
name|__unused
parameter_list|,
specifier|const
name|char
modifier|*
name|argv
index|[]
name|__unused
parameter_list|)
block|{
return|return
operator|(
name|PAM_IGNORE
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|PAM_MODULE_ENTRY
argument_list|(
literal|"pam_tacplus"
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


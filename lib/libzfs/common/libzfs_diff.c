begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2010, Oracle and/or its affiliates. All rights reserved.  * Copyright 2015 Nexenta Systems, Inc. All rights reserved.  * Copyright (c) 2015 by Delphix. All rights reserved.  * Copyright 2016 Joyent, Inc.  * Copyright 2016 Igor Kozhukhov<ikozhukhov@gmail.com>  */
end_comment

begin_comment
comment|/*  * zfs diff support  */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<libintl.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<attr.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stropts.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<libzfs.h>
end_include

begin_include
include|#
directive|include
file|"libzfs_impl.h"
end_include

begin_define
define|#
directive|define
name|ZDIFF_SNAPDIR
value|"/.zfs/snapshot/"
end_define

begin_define
define|#
directive|define
name|ZDIFF_SHARESDIR
value|"/.zfs/shares/"
end_define

begin_define
define|#
directive|define
name|ZDIFF_PREFIX
value|"zfs-diff-%d"
end_define

begin_define
define|#
directive|define
name|ZDIFF_ADDED
value|'+'
end_define

begin_define
define|#
directive|define
name|ZDIFF_MODIFIED
value|'M'
end_define

begin_define
define|#
directive|define
name|ZDIFF_REMOVED
value|'-'
end_define

begin_define
define|#
directive|define
name|ZDIFF_RENAMED
value|'R'
end_define

begin_typedef
typedef|typedef
struct|struct
name|differ_info
block|{
name|zfs_handle_t
modifier|*
name|zhp
decl_stmt|;
name|char
modifier|*
name|fromsnap
decl_stmt|;
name|char
modifier|*
name|frommnt
decl_stmt|;
name|char
modifier|*
name|tosnap
decl_stmt|;
name|char
modifier|*
name|tomnt
decl_stmt|;
name|char
modifier|*
name|ds
decl_stmt|;
name|char
modifier|*
name|dsmnt
decl_stmt|;
name|char
modifier|*
name|tmpsnap
decl_stmt|;
name|char
name|errbuf
index|[
literal|1024
index|]
decl_stmt|;
name|boolean_t
name|isclone
decl_stmt|;
name|boolean_t
name|scripted
decl_stmt|;
name|boolean_t
name|classify
decl_stmt|;
name|boolean_t
name|timestamped
decl_stmt|;
name|uint64_t
name|shares
decl_stmt|;
name|int
name|zerr
decl_stmt|;
name|int
name|cleanupfd
decl_stmt|;
name|int
name|outputfd
decl_stmt|;
name|int
name|datafd
decl_stmt|;
block|}
name|differ_info_t
typedef|;
end_typedef

begin_comment
comment|/*  * Given a {dsname, object id}, get the object path  */
end_comment

begin_function
specifier|static
name|int
name|get_stats_for_obj
parameter_list|(
name|differ_info_t
modifier|*
name|di
parameter_list|,
specifier|const
name|char
modifier|*
name|dsname
parameter_list|,
name|uint64_t
name|obj
parameter_list|,
name|char
modifier|*
name|pn
parameter_list|,
name|int
name|maxlen
parameter_list|,
name|zfs_stat_t
modifier|*
name|sb
parameter_list|)
block|{
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|error
decl_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|dsname
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|)
argument_list|)
expr_stmt|;
name|zc
operator|.
name|zc_obj
operator|=
name|obj
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|ioctl
argument_list|(
name|di
operator|->
name|zhp
operator|->
name|zfs_hdl
operator|->
name|libzfs_fd
argument_list|,
name|ZFS_IOC_OBJ_TO_STATS
argument_list|,
operator|&
name|zc
argument_list|)
expr_stmt|;
name|di
operator|->
name|zerr
operator|=
name|errno
expr_stmt|;
comment|/* we can get stats even if we failed to get a path */
operator|(
name|void
operator|)
name|memcpy
argument_list|(
name|sb
argument_list|,
operator|&
name|zc
operator|.
name|zc_stat
argument_list|,
sizeof|sizeof
argument_list|(
name|zfs_stat_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|ASSERT
argument_list|(
name|di
operator|->
name|zerr
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|pn
argument_list|,
name|zc
operator|.
name|zc_value
argument_list|,
name|maxlen
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|di
operator|->
name|zerr
operator|==
name|EPERM
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"The sys_config privilege or diff delegated permission "
literal|"is needed\nto discover path names"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"Unable to determine path or stats for "
literal|"object %lld in %s"
argument_list|)
argument_list|,
name|obj
argument_list|,
name|dsname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * stream_bytes  *  * Prints a file name out a character at a time.  If the character is  * not in the range of what we consider "printable" ASCII, display it  * as an escaped 3-digit octal value.  ASCII values less than a space  * are all control characters and we declare the upper end as the  * DELete character.  This also is the last 7-bit ASCII character.  * We choose to treat all 8-bit ASCII as not printable for this  * application.  */
end_comment

begin_function
specifier|static
name|void
name|stream_bytes
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
specifier|const
name|char
modifier|*
name|string
parameter_list|)
block|{
name|char
name|c
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|string
operator|++
operator|)
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|c
operator|>
literal|' '
operator|&&
name|c
operator|!=
literal|'\\'
operator|&&
name|c
operator|<
literal|'\177'
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%c"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\\%03o"
argument_list|,
operator|(
name|uint8_t
operator|)
name|c
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_what
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|mode_t
name|what
parameter_list|)
block|{
name|char
name|symbol
decl_stmt|;
switch|switch
condition|(
name|what
operator|&
name|S_IFMT
condition|)
block|{
case|case
name|S_IFBLK
case|:
name|symbol
operator|=
literal|'B'
expr_stmt|;
break|break;
case|case
name|S_IFCHR
case|:
name|symbol
operator|=
literal|'C'
expr_stmt|;
break|break;
case|case
name|S_IFDIR
case|:
name|symbol
operator|=
literal|'/'
expr_stmt|;
break|break;
case|case
name|S_IFDOOR
case|:
name|symbol
operator|=
literal|'>'
expr_stmt|;
break|break;
case|case
name|S_IFIFO
case|:
name|symbol
operator|=
literal|'|'
expr_stmt|;
break|break;
case|case
name|S_IFLNK
case|:
name|symbol
operator|=
literal|'@'
expr_stmt|;
break|break;
case|case
name|S_IFPORT
case|:
name|symbol
operator|=
literal|'P'
expr_stmt|;
break|break;
case|case
name|S_IFSOCK
case|:
name|symbol
operator|=
literal|'='
expr_stmt|;
break|break;
case|case
name|S_IFREG
case|:
name|symbol
operator|=
literal|'F'
expr_stmt|;
break|break;
default|default:
name|symbol
operator|=
literal|'?'
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%c"
argument_list|,
name|symbol
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_cmn
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|differ_info_t
modifier|*
name|di
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|)
block|{
name|stream_bytes
argument_list|(
name|fp
argument_list|,
name|di
operator|->
name|dsmnt
argument_list|)
expr_stmt|;
name|stream_bytes
argument_list|(
name|fp
argument_list|,
name|file
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_rename
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|differ_info_t
modifier|*
name|di
parameter_list|,
specifier|const
name|char
modifier|*
name|old
parameter_list|,
specifier|const
name|char
modifier|*
name|new
parameter_list|,
name|zfs_stat_t
modifier|*
name|isb
parameter_list|)
block|{
if|if
condition|(
name|di
operator|->
name|timestamped
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%10lld.%09lld\t"
argument_list|,
operator|(
name|longlong_t
operator|)
name|isb
operator|->
name|zs_ctime
index|[
literal|0
index|]
argument_list|,
operator|(
name|longlong_t
operator|)
name|isb
operator|->
name|zs_ctime
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%c\t"
argument_list|,
name|ZDIFF_RENAMED
argument_list|)
expr_stmt|;
if|if
condition|(
name|di
operator|->
name|classify
condition|)
block|{
name|print_what
argument_list|(
name|fp
argument_list|,
name|isb
operator|->
name|zs_mode
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\t"
argument_list|)
expr_stmt|;
block|}
name|print_cmn
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|old
argument_list|)
expr_stmt|;
if|if
condition|(
name|di
operator|->
name|scripted
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\t"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" -> "
argument_list|)
expr_stmt|;
name|print_cmn
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|new
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_link_change
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|differ_info_t
modifier|*
name|di
parameter_list|,
name|int
name|delta
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|zfs_stat_t
modifier|*
name|isb
parameter_list|)
block|{
if|if
condition|(
name|di
operator|->
name|timestamped
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%10lld.%09lld\t"
argument_list|,
operator|(
name|longlong_t
operator|)
name|isb
operator|->
name|zs_ctime
index|[
literal|0
index|]
argument_list|,
operator|(
name|longlong_t
operator|)
name|isb
operator|->
name|zs_ctime
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%c\t"
argument_list|,
name|ZDIFF_MODIFIED
argument_list|)
expr_stmt|;
if|if
condition|(
name|di
operator|->
name|classify
condition|)
block|{
name|print_what
argument_list|(
name|fp
argument_list|,
name|isb
operator|->
name|zs_mode
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\t"
argument_list|)
expr_stmt|;
block|}
name|print_cmn
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|file
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\t(%+d)"
argument_list|,
name|delta
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_file
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|differ_info_t
modifier|*
name|di
parameter_list|,
name|char
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|zfs_stat_t
modifier|*
name|isb
parameter_list|)
block|{
if|if
condition|(
name|di
operator|->
name|timestamped
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%10lld.%09lld\t"
argument_list|,
operator|(
name|longlong_t
operator|)
name|isb
operator|->
name|zs_ctime
index|[
literal|0
index|]
argument_list|,
operator|(
name|longlong_t
operator|)
name|isb
operator|->
name|zs_ctime
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%c\t"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|di
operator|->
name|classify
condition|)
block|{
name|print_what
argument_list|(
name|fp
argument_list|,
name|isb
operator|->
name|zs_mode
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\t"
argument_list|)
expr_stmt|;
block|}
name|print_cmn
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|file
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|write_inuse_diffs_one
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|differ_info_t
modifier|*
name|di
parameter_list|,
name|uint64_t
name|dobj
parameter_list|)
block|{
name|struct
name|zfs_stat
name|fsb
decl_stmt|,
name|tsb
decl_stmt|;
name|mode_t
name|fmode
decl_stmt|,
name|tmode
decl_stmt|;
name|char
name|fobjname
index|[
name|MAXPATHLEN
index|]
decl_stmt|,
name|tobjname
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|int
name|fobjerr
decl_stmt|,
name|tobjerr
decl_stmt|;
name|int
name|change
decl_stmt|;
if|if
condition|(
name|dobj
operator|==
name|di
operator|->
name|shares
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* 	 * Check the from and to snapshots for info on the object. If 	 * we get ENOENT, then the object just didn't exist in that 	 * snapshot.  If we get ENOTSUP, then we tried to get 	 * info on a non-ZPL object, which we don't care about anyway. 	 */
name|fobjerr
operator|=
name|get_stats_for_obj
argument_list|(
name|di
argument_list|,
name|di
operator|->
name|fromsnap
argument_list|,
name|dobj
argument_list|,
name|fobjname
argument_list|,
name|MAXPATHLEN
argument_list|,
operator|&
name|fsb
argument_list|)
expr_stmt|;
if|if
condition|(
name|fobjerr
operator|&&
name|di
operator|->
name|zerr
operator|!=
name|ENOENT
operator|&&
name|di
operator|->
name|zerr
operator|!=
name|ENOTSUP
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|tobjerr
operator|=
name|get_stats_for_obj
argument_list|(
name|di
argument_list|,
name|di
operator|->
name|tosnap
argument_list|,
name|dobj
argument_list|,
name|tobjname
argument_list|,
name|MAXPATHLEN
argument_list|,
operator|&
name|tsb
argument_list|)
expr_stmt|;
if|if
condition|(
name|tobjerr
operator|&&
name|di
operator|->
name|zerr
operator|!=
name|ENOENT
operator|&&
name|di
operator|->
name|zerr
operator|!=
name|ENOTSUP
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* 	 * Unallocated object sharing the same meta dnode block 	 */
if|if
condition|(
name|fobjerr
operator|&&
name|tobjerr
condition|)
block|{
name|ASSERT
argument_list|(
name|di
operator|->
name|zerr
operator|==
name|ENOENT
operator|||
name|di
operator|->
name|zerr
operator|==
name|ENOTSUP
argument_list|)
expr_stmt|;
name|di
operator|->
name|zerr
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|di
operator|->
name|zerr
operator|=
literal|0
expr_stmt|;
comment|/* negate get_stats_for_obj() from side that failed */
name|fmode
operator|=
name|fsb
operator|.
name|zs_mode
operator|&
name|S_IFMT
expr_stmt|;
name|tmode
operator|=
name|tsb
operator|.
name|zs_mode
operator|&
name|S_IFMT
expr_stmt|;
if|if
condition|(
name|fmode
operator|==
name|S_IFDIR
operator|||
name|tmode
operator|==
name|S_IFDIR
operator|||
name|fsb
operator|.
name|zs_links
operator|==
literal|0
operator|||
name|tsb
operator|.
name|zs_links
operator|==
literal|0
condition|)
name|change
operator|=
literal|0
expr_stmt|;
else|else
name|change
operator|=
name|tsb
operator|.
name|zs_links
operator|-
name|fsb
operator|.
name|zs_links
expr_stmt|;
if|if
condition|(
name|fobjerr
condition|)
block|{
if|if
condition|(
name|change
condition|)
block|{
name|print_link_change
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|change
argument_list|,
name|tobjname
argument_list|,
operator|&
name|tsb
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|print_file
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|ZDIFF_ADDED
argument_list|,
name|tobjname
argument_list|,
operator|&
name|tsb
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|tobjerr
condition|)
block|{
if|if
condition|(
name|change
condition|)
block|{
name|print_link_change
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|change
argument_list|,
name|fobjname
argument_list|,
operator|&
name|fsb
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|print_file
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|ZDIFF_REMOVED
argument_list|,
name|fobjname
argument_list|,
operator|&
name|fsb
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|fmode
operator|!=
name|tmode
operator|&&
name|fsb
operator|.
name|zs_gen
operator|==
name|tsb
operator|.
name|zs_gen
condition|)
name|tsb
operator|.
name|zs_gen
operator|++
expr_stmt|;
comment|/* Force a generational difference */
comment|/* Simple modification or no change */
if|if
condition|(
name|fsb
operator|.
name|zs_gen
operator|==
name|tsb
operator|.
name|zs_gen
condition|)
block|{
comment|/* No apparent changes.  Could we assert !this?  */
if|if
condition|(
name|fsb
operator|.
name|zs_ctime
index|[
literal|0
index|]
operator|==
name|tsb
operator|.
name|zs_ctime
index|[
literal|0
index|]
operator|&&
name|fsb
operator|.
name|zs_ctime
index|[
literal|1
index|]
operator|==
name|tsb
operator|.
name|zs_ctime
index|[
literal|1
index|]
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|change
condition|)
block|{
name|print_link_change
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|change
argument_list|,
name|change
operator|>
literal|0
condition|?
name|fobjname
else|:
name|tobjname
argument_list|,
operator|&
name|tsb
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|fobjname
argument_list|,
name|tobjname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|print_file
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|ZDIFF_MODIFIED
argument_list|,
name|fobjname
argument_list|,
operator|&
name|tsb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|print_rename
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|fobjname
argument_list|,
name|tobjname
argument_list|,
operator|&
name|tsb
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
comment|/* file re-created or object re-used */
name|print_file
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|ZDIFF_REMOVED
argument_list|,
name|fobjname
argument_list|,
operator|&
name|fsb
argument_list|)
expr_stmt|;
name|print_file
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|ZDIFF_ADDED
argument_list|,
name|tobjname
argument_list|,
operator|&
name|tsb
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|write_inuse_diffs
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|differ_info_t
modifier|*
name|di
parameter_list|,
name|dmu_diff_record_t
modifier|*
name|dr
parameter_list|)
block|{
name|uint64_t
name|o
decl_stmt|;
name|int
name|err
decl_stmt|;
for|for
control|(
name|o
operator|=
name|dr
operator|->
name|ddr_first
init|;
name|o
operator|<=
name|dr
operator|->
name|ddr_last
condition|;
name|o
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|err
operator|=
name|write_inuse_diffs_one
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|o
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|err
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|describe_free
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|differ_info_t
modifier|*
name|di
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|char
modifier|*
name|namebuf
parameter_list|,
name|int
name|maxlen
parameter_list|)
block|{
name|struct
name|zfs_stat
name|sb
decl_stmt|;
if|if
condition|(
name|get_stats_for_obj
argument_list|(
name|di
argument_list|,
name|di
operator|->
name|fromsnap
argument_list|,
name|object
argument_list|,
name|namebuf
argument_list|,
name|maxlen
argument_list|,
operator|&
name|sb
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* Let it slide, if in the delete queue on from side */
if|if
condition|(
name|di
operator|->
name|zerr
operator|==
name|ENOENT
operator|&&
name|sb
operator|.
name|zs_links
operator|==
literal|0
condition|)
block|{
name|di
operator|->
name|zerr
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|print_file
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|ZDIFF_REMOVED
argument_list|,
name|namebuf
argument_list|,
operator|&
name|sb
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|write_free_diffs
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|differ_info_t
modifier|*
name|di
parameter_list|,
name|dmu_diff_record_t
modifier|*
name|dr
parameter_list|)
block|{
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|libzfs_handle_t
modifier|*
name|lhdl
init|=
name|di
operator|->
name|zhp
operator|->
name|zfs_hdl
decl_stmt|;
name|char
name|fobjname
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|di
operator|->
name|fromsnap
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|)
argument_list|)
expr_stmt|;
name|zc
operator|.
name|zc_obj
operator|=
name|dr
operator|->
name|ddr_first
operator|-
literal|1
expr_stmt|;
name|ASSERT
argument_list|(
name|di
operator|->
name|zerr
operator|==
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|zc
operator|.
name|zc_obj
operator|<
name|dr
operator|->
name|ddr_last
condition|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|ioctl
argument_list|(
name|lhdl
operator|->
name|libzfs_fd
argument_list|,
name|ZFS_IOC_NEXT_OBJ
argument_list|,
operator|&
name|zc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|zc
operator|.
name|zc_obj
operator|==
name|di
operator|->
name|shares
condition|)
block|{
name|zc
operator|.
name|zc_obj
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|zc
operator|.
name|zc_obj
operator|>
name|dr
operator|->
name|ddr_last
condition|)
block|{
break|break;
block|}
name|err
operator|=
name|describe_free
argument_list|(
name|fp
argument_list|,
name|di
argument_list|,
name|zc
operator|.
name|zc_obj
argument_list|,
name|fobjname
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
block|}
elseif|else
if|if
condition|(
name|errno
operator|==
name|ESRCH
condition|)
block|{
break|break;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"next allocated object (> %lld) find failure"
argument_list|)
argument_list|,
name|zc
operator|.
name|zc_obj
argument_list|)
expr_stmt|;
name|di
operator|->
name|zerr
operator|=
name|errno
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|di
operator|->
name|zerr
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|differ
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|differ_info_t
modifier|*
name|di
init|=
name|arg
decl_stmt|;
name|dmu_diff_record_t
name|dr
decl_stmt|;
name|FILE
modifier|*
name|ofp
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|ofp
operator|=
name|fdopen
argument_list|(
name|di
operator|->
name|outputfd
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|di
operator|->
name|zerr
operator|=
name|errno
expr_stmt|;
operator|(
name|void
operator|)
name|strerror_r
argument_list|(
name|errno
argument_list|,
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|di
operator|->
name|datafd
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|char
modifier|*
name|cp
init|=
operator|(
name|char
operator|*
operator|)
operator|&
name|dr
decl_stmt|;
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
name|dr
argument_list|)
decl_stmt|;
name|int
name|rv
decl_stmt|;
do|do
block|{
name|rv
operator|=
name|read
argument_list|(
name|di
operator|->
name|datafd
argument_list|,
name|cp
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|rv
expr_stmt|;
name|len
operator|-=
name|rv
expr_stmt|;
block|}
do|while
condition|(
name|len
operator|>
literal|0
operator|&&
name|rv
operator|>
literal|0
condition|)
do|;
if|if
condition|(
name|rv
operator|<
literal|0
operator|||
operator|(
name|rv
operator|==
literal|0
operator|&&
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|dr
argument_list|)
operator|)
condition|)
block|{
name|di
operator|->
name|zerr
operator|=
name|EPIPE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|rv
operator|==
literal|0
condition|)
block|{
comment|/* end of file at a natural breaking point */
break|break;
block|}
switch|switch
condition|(
name|dr
operator|.
name|ddr_type
condition|)
block|{
case|case
name|DDR_FREE
case|:
name|err
operator|=
name|write_free_diffs
argument_list|(
name|ofp
argument_list|,
name|di
argument_list|,
operator|&
name|dr
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDR_INUSE
case|:
name|err
operator|=
name|write_inuse_diffs
argument_list|(
name|ofp
argument_list|,
name|di
argument_list|,
operator|&
name|dr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|di
operator|->
name|zerr
operator|=
name|EPIPE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|err
operator|||
name|di
operator|->
name|zerr
condition|)
break|break;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|ofp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|di
operator|->
name|datafd
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|di
operator|->
name|zerr
condition|)
block|{
name|ASSERT
argument_list|(
name|di
operator|->
name|zerr
operator|==
name|EINVAL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"Internal error: bad data from diff IOCTL"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
operator|(
name|void
operator|*
operator|)
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|find_shares_object
parameter_list|(
name|differ_info_t
modifier|*
name|di
parameter_list|)
block|{
name|char
name|fullpath
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|struct
name|stat64
name|sb
init|=
block|{
literal|0
block|}
decl_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|fullpath
argument_list|,
name|di
operator|->
name|dsmnt
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcat
argument_list|(
name|fullpath
argument_list|,
name|ZDIFF_SHARESDIR
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat64
argument_list|(
name|fullpath
argument_list|,
operator|&
name|sb
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"Cannot stat %s"
argument_list|)
argument_list|,
name|fullpath
argument_list|)
expr_stmt|;
return|return
operator|(
name|zfs_error
argument_list|(
name|di
operator|->
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|EZFS_DIFF
argument_list|,
name|di
operator|->
name|errbuf
argument_list|)
operator|)
return|;
block|}
name|di
operator|->
name|shares
operator|=
operator|(
name|uint64_t
operator|)
name|sb
operator|.
name|st_ino
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|make_temp_snapshot
parameter_list|(
name|differ_info_t
modifier|*
name|di
parameter_list|)
block|{
name|libzfs_handle_t
modifier|*
name|hdl
init|=
name|di
operator|->
name|zhp
operator|->
name|zfs_hdl
decl_stmt|;
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|zc
operator|.
name|zc_value
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_value
argument_list|)
argument_list|,
name|ZDIFF_PREFIX
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|di
operator|->
name|ds
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|)
argument_list|)
expr_stmt|;
name|zc
operator|.
name|zc_cleanup_fd
operator|=
name|di
operator|->
name|cleanupfd
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|hdl
operator|->
name|libzfs_fd
argument_list|,
name|ZFS_IOC_TMP_SNAPSHOT
argument_list|,
operator|&
name|zc
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|int
name|err
init|=
name|errno
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|EPERM
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"The diff delegated "
literal|"permission is needed in order\nto create a "
literal|"just-in-time snapshot for diffing\n"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zfs_error
argument_list|(
name|hdl
argument_list|,
name|EZFS_DIFF
argument_list|,
name|di
operator|->
name|errbuf
argument_list|)
operator|)
return|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"Cannot create just-in-time "
literal|"snapshot of '%s'"
argument_list|)
argument_list|,
name|zc
operator|.
name|zc_name
argument_list|)
expr_stmt|;
return|return
operator|(
name|zfs_standard_error
argument_list|(
name|hdl
argument_list|,
name|err
argument_list|,
name|di
operator|->
name|errbuf
argument_list|)
operator|)
return|;
block|}
block|}
name|di
operator|->
name|tmpsnap
operator|=
name|zfs_strdup
argument_list|(
name|hdl
argument_list|,
name|zc
operator|.
name|zc_value
argument_list|)
expr_stmt|;
name|di
operator|->
name|tosnap
operator|=
name|zfs_asprintf
argument_list|(
name|hdl
argument_list|,
literal|"%s@%s"
argument_list|,
name|di
operator|->
name|ds
argument_list|,
name|di
operator|->
name|tmpsnap
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|teardown_differ_info
parameter_list|(
name|differ_info_t
modifier|*
name|di
parameter_list|)
block|{
name|free
argument_list|(
name|di
operator|->
name|ds
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|di
operator|->
name|dsmnt
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|di
operator|->
name|fromsnap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|di
operator|->
name|frommnt
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|di
operator|->
name|tosnap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|di
operator|->
name|tmpsnap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|di
operator|->
name|tomnt
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|di
operator|->
name|cleanupfd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_snapshot_names
parameter_list|(
name|differ_info_t
modifier|*
name|di
parameter_list|,
specifier|const
name|char
modifier|*
name|fromsnap
parameter_list|,
specifier|const
name|char
modifier|*
name|tosnap
parameter_list|)
block|{
name|libzfs_handle_t
modifier|*
name|hdl
init|=
name|di
operator|->
name|zhp
operator|->
name|zfs_hdl
decl_stmt|;
name|char
modifier|*
name|atptrf
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|atptrt
init|=
name|NULL
decl_stmt|;
name|int
name|fdslen
decl_stmt|,
name|fsnlen
decl_stmt|;
name|int
name|tdslen
decl_stmt|,
name|tsnlen
decl_stmt|;
comment|/* 	 * Can accept 	 *    dataset@snap1 	 *    dataset@snap1 dataset@snap2 	 *    dataset@snap1 @snap2 	 *    dataset@snap1 dataset 	 *    @snap1 dataset@snap2 	 */
if|if
condition|(
name|tosnap
operator|==
name|NULL
condition|)
block|{
comment|/* only a from snapshot given, must be valid */
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"Badly formed snapshot name %s"
argument_list|)
argument_list|,
name|fromsnap
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|zfs_validate_name
argument_list|(
name|hdl
argument_list|,
name|fromsnap
argument_list|,
name|ZFS_TYPE_SNAPSHOT
argument_list|,
name|B_FALSE
argument_list|)
condition|)
block|{
return|return
operator|(
name|zfs_error
argument_list|(
name|hdl
argument_list|,
name|EZFS_INVALIDNAME
argument_list|,
name|di
operator|->
name|errbuf
argument_list|)
operator|)
return|;
block|}
name|atptrf
operator|=
name|strchr
argument_list|(
name|fromsnap
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|atptrf
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|fdslen
operator|=
name|atptrf
operator|-
name|fromsnap
expr_stmt|;
name|di
operator|->
name|fromsnap
operator|=
name|zfs_strdup
argument_list|(
name|hdl
argument_list|,
name|fromsnap
argument_list|)
expr_stmt|;
name|di
operator|->
name|ds
operator|=
name|zfs_strdup
argument_list|(
name|hdl
argument_list|,
name|fromsnap
argument_list|)
expr_stmt|;
name|di
operator|->
name|ds
index|[
name|fdslen
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* the to snap will be a just-in-time snap of the head */
return|return
operator|(
name|make_temp_snapshot
argument_list|(
name|di
argument_list|)
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"Unable to determine which snapshots to compare"
argument_list|)
argument_list|)
expr_stmt|;
name|atptrf
operator|=
name|strchr
argument_list|(
name|fromsnap
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
name|atptrt
operator|=
name|strchr
argument_list|(
name|tosnap
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
name|fdslen
operator|=
name|atptrf
condition|?
name|atptrf
operator|-
name|fromsnap
else|:
name|strlen
argument_list|(
name|fromsnap
argument_list|)
expr_stmt|;
name|tdslen
operator|=
name|atptrt
condition|?
name|atptrt
operator|-
name|tosnap
else|:
name|strlen
argument_list|(
name|tosnap
argument_list|)
expr_stmt|;
name|fsnlen
operator|=
name|strlen
argument_list|(
name|fromsnap
argument_list|)
operator|-
name|fdslen
expr_stmt|;
comment|/* includes @ sign */
name|tsnlen
operator|=
name|strlen
argument_list|(
name|tosnap
argument_list|)
operator|-
name|tdslen
expr_stmt|;
comment|/* includes @ sign */
if|if
condition|(
name|fsnlen
operator|<=
literal|1
operator|||
name|tsnlen
operator|==
literal|1
operator|||
operator|(
name|fdslen
operator|==
literal|0
operator|&&
name|tdslen
operator|==
literal|0
operator|)
operator|||
operator|(
name|fsnlen
operator|==
literal|0
operator|&&
name|tsnlen
operator|==
literal|0
operator|)
condition|)
block|{
return|return
operator|(
name|zfs_error
argument_list|(
name|hdl
argument_list|,
name|EZFS_INVALIDNAME
argument_list|,
name|di
operator|->
name|errbuf
argument_list|)
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fdslen
operator|>
literal|0
operator|&&
name|tdslen
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|(
name|tdslen
operator|!=
name|fdslen
operator|||
name|strncmp
argument_list|(
name|fromsnap
argument_list|,
name|tosnap
argument_list|,
name|fdslen
argument_list|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
comment|/* 		 * not the same dataset name, might be okay if 		 * tosnap is a clone of a fromsnap descendant. 		 */
name|char
name|origin
index|[
name|ZFS_MAX_DATASET_NAME_LEN
index|]
decl_stmt|;
name|zprop_source_t
name|src
decl_stmt|;
name|zfs_handle_t
modifier|*
name|zhp
decl_stmt|;
name|di
operator|->
name|ds
operator|=
name|zfs_alloc
argument_list|(
name|di
operator|->
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|tdslen
operator|+
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|di
operator|->
name|ds
argument_list|,
name|tosnap
argument_list|,
name|tdslen
argument_list|)
expr_stmt|;
name|di
operator|->
name|ds
index|[
name|tdslen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|zhp
operator|=
name|zfs_open
argument_list|(
name|hdl
argument_list|,
name|di
operator|->
name|ds
argument_list|,
name|ZFS_TYPE_FILESYSTEM
argument_list|)
expr_stmt|;
while|while
condition|(
name|zhp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|zfs_prop_get
argument_list|(
name|zhp
argument_list|,
name|ZFS_PROP_ORIGIN
argument_list|,
name|origin
argument_list|,
sizeof|sizeof
argument_list|(
name|origin
argument_list|)
argument_list|,
operator|&
name|src
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|B_FALSE
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|zfs_close
argument_list|(
name|zhp
argument_list|)
expr_stmt|;
name|zhp
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|origin
argument_list|,
name|fromsnap
argument_list|,
name|fsnlen
argument_list|)
operator|==
literal|0
condition|)
break|break;
operator|(
name|void
operator|)
name|zfs_close
argument_list|(
name|zhp
argument_list|)
expr_stmt|;
name|zhp
operator|=
name|zfs_open
argument_list|(
name|hdl
argument_list|,
name|origin
argument_list|,
name|ZFS_TYPE_FILESYSTEM
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zhp
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"Not an earlier snapshot from the same fs"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zfs_error
argument_list|(
name|hdl
argument_list|,
name|EZFS_INVALIDNAME
argument_list|,
name|di
operator|->
name|errbuf
argument_list|)
operator|)
return|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|zfs_close
argument_list|(
name|zhp
argument_list|)
expr_stmt|;
block|}
name|di
operator|->
name|isclone
operator|=
name|B_TRUE
expr_stmt|;
name|di
operator|->
name|fromsnap
operator|=
name|zfs_strdup
argument_list|(
name|hdl
argument_list|,
name|fromsnap
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsnlen
condition|)
block|{
name|di
operator|->
name|tosnap
operator|=
name|zfs_strdup
argument_list|(
name|hdl
argument_list|,
name|tosnap
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
name|make_temp_snapshot
argument_list|(
name|di
argument_list|)
operator|)
return|;
block|}
block|}
else|else
block|{
name|int
name|dslen
init|=
name|fdslen
condition|?
name|fdslen
else|:
name|tdslen
decl_stmt|;
name|di
operator|->
name|ds
operator|=
name|zfs_alloc
argument_list|(
name|hdl
argument_list|,
name|dslen
operator|+
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|di
operator|->
name|ds
argument_list|,
name|fdslen
condition|?
name|fromsnap
else|:
name|tosnap
argument_list|,
name|dslen
argument_list|)
expr_stmt|;
name|di
operator|->
name|ds
index|[
name|dslen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|di
operator|->
name|fromsnap
operator|=
name|zfs_asprintf
argument_list|(
name|hdl
argument_list|,
literal|"%s%s"
argument_list|,
name|di
operator|->
name|ds
argument_list|,
name|atptrf
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsnlen
condition|)
block|{
name|di
operator|->
name|tosnap
operator|=
name|zfs_asprintf
argument_list|(
name|hdl
argument_list|,
literal|"%s%s"
argument_list|,
name|di
operator|->
name|ds
argument_list|,
name|atptrt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
name|make_temp_snapshot
argument_list|(
name|di
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_mountpoint
parameter_list|(
name|differ_info_t
modifier|*
name|di
parameter_list|,
name|char
modifier|*
name|dsnm
parameter_list|,
name|char
modifier|*
modifier|*
name|mntpt
parameter_list|)
block|{
name|boolean_t
name|mounted
decl_stmt|;
name|mounted
operator|=
name|is_mounted
argument_list|(
name|di
operator|->
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|dsnm
argument_list|,
name|mntpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|mounted
operator|==
name|B_FALSE
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|di
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"Cannot diff an unmounted snapshot"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zfs_error
argument_list|(
name|di
operator|->
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|EZFS_BADTYPE
argument_list|,
name|di
operator|->
name|errbuf
argument_list|)
operator|)
return|;
block|}
comment|/* Avoid a double slash at the beginning of root-mounted datasets */
if|if
condition|(
operator|*
operator|*
name|mntpt
operator|==
literal|'/'
operator|&&
operator|*
operator|(
operator|*
name|mntpt
operator|+
literal|1
operator|)
operator|==
literal|'\0'
condition|)
operator|*
operator|*
name|mntpt
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_mountpoints
parameter_list|(
name|differ_info_t
modifier|*
name|di
parameter_list|)
block|{
name|char
modifier|*
name|strptr
decl_stmt|;
name|char
modifier|*
name|frommntpt
decl_stmt|;
comment|/* 	 * first get the mountpoint for the parent dataset 	 */
if|if
condition|(
name|get_mountpoint
argument_list|(
name|di
argument_list|,
name|di
operator|->
name|ds
argument_list|,
operator|&
name|di
operator|->
name|dsmnt
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|strptr
operator|=
name|strchr
argument_list|(
name|di
operator|->
name|tosnap
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
name|ASSERT3P
argument_list|(
name|strptr
argument_list|,
operator|!=
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|di
operator|->
name|tomnt
operator|=
name|zfs_asprintf
argument_list|(
name|di
operator|->
name|zhp
operator|->
name|zfs_hdl
argument_list|,
literal|"%s%s%s"
argument_list|,
name|di
operator|->
name|dsmnt
argument_list|,
name|ZDIFF_SNAPDIR
argument_list|,
operator|++
name|strptr
argument_list|)
expr_stmt|;
name|strptr
operator|=
name|strchr
argument_list|(
name|di
operator|->
name|fromsnap
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
name|ASSERT3P
argument_list|(
name|strptr
argument_list|,
operator|!=
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|frommntpt
operator|=
name|di
operator|->
name|dsmnt
expr_stmt|;
if|if
condition|(
name|di
operator|->
name|isclone
condition|)
block|{
name|char
modifier|*
name|mntpt
decl_stmt|;
name|int
name|err
decl_stmt|;
operator|*
name|strptr
operator|=
literal|'\0'
expr_stmt|;
name|err
operator|=
name|get_mountpoint
argument_list|(
name|di
argument_list|,
name|di
operator|->
name|fromsnap
argument_list|,
operator|&
name|mntpt
argument_list|)
expr_stmt|;
operator|*
name|strptr
operator|=
literal|'@'
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|frommntpt
operator|=
name|mntpt
expr_stmt|;
block|}
name|di
operator|->
name|frommnt
operator|=
name|zfs_asprintf
argument_list|(
name|di
operator|->
name|zhp
operator|->
name|zfs_hdl
argument_list|,
literal|"%s%s%s"
argument_list|,
name|frommntpt
argument_list|,
name|ZDIFF_SNAPDIR
argument_list|,
operator|++
name|strptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|di
operator|->
name|isclone
condition|)
name|free
argument_list|(
name|frommntpt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|setup_differ_info
parameter_list|(
name|zfs_handle_t
modifier|*
name|zhp
parameter_list|,
specifier|const
name|char
modifier|*
name|fromsnap
parameter_list|,
specifier|const
name|char
modifier|*
name|tosnap
parameter_list|,
name|differ_info_t
modifier|*
name|di
parameter_list|)
block|{
name|di
operator|->
name|zhp
operator|=
name|zhp
expr_stmt|;
name|di
operator|->
name|cleanupfd
operator|=
name|open
argument_list|(
name|ZFS_DEV
argument_list|,
name|O_RDWR
operator||
name|O_EXCL
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|di
operator|->
name|cleanupfd
operator|>=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_snapshot_names
argument_list|(
name|di
argument_list|,
name|fromsnap
argument_list|,
name|tosnap
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|get_mountpoints
argument_list|(
name|di
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|find_shares_object
argument_list|(
name|di
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|zfs_show_diffs
parameter_list|(
name|zfs_handle_t
modifier|*
name|zhp
parameter_list|,
name|int
name|outfd
parameter_list|,
specifier|const
name|char
modifier|*
name|fromsnap
parameter_list|,
specifier|const
name|char
modifier|*
name|tosnap
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|char
name|errbuf
index|[
literal|1024
index|]
decl_stmt|;
name|differ_info_t
name|di
init|=
block|{
literal|0
block|}
decl_stmt|;
name|pthread_t
name|tid
decl_stmt|;
name|int
name|pipefd
index|[
literal|2
index|]
decl_stmt|;
name|int
name|iocerr
decl_stmt|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"zfs diff failed"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|setup_differ_info
argument_list|(
name|zhp
argument_list|,
name|fromsnap
argument_list|,
name|tosnap
argument_list|,
operator|&
name|di
argument_list|)
condition|)
block|{
name|teardown_differ_info
argument_list|(
operator|&
name|di
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|pipe
argument_list|(
name|pipefd
argument_list|)
condition|)
block|{
name|zfs_error_aux
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|teardown_differ_info
argument_list|(
operator|&
name|di
argument_list|)
expr_stmt|;
return|return
operator|(
name|zfs_error
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|EZFS_PIPEFAILED
argument_list|,
name|errbuf
argument_list|)
operator|)
return|;
block|}
name|di
operator|.
name|scripted
operator|=
operator|(
name|flags
operator|&
name|ZFS_DIFF_PARSEABLE
operator|)
expr_stmt|;
name|di
operator|.
name|classify
operator|=
operator|(
name|flags
operator|&
name|ZFS_DIFF_CLASSIFY
operator|)
expr_stmt|;
name|di
operator|.
name|timestamped
operator|=
operator|(
name|flags
operator|&
name|ZFS_DIFF_TIMESTAMP
operator|)
expr_stmt|;
name|di
operator|.
name|outputfd
operator|=
name|outfd
expr_stmt|;
name|di
operator|.
name|datafd
operator|=
name|pipefd
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|pthread_create
argument_list|(
operator|&
name|tid
argument_list|,
name|NULL
argument_list|,
name|differ
argument_list|,
operator|&
name|di
argument_list|)
condition|)
block|{
name|zfs_error_aux
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pipefd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pipefd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|teardown_differ_info
argument_list|(
operator|&
name|di
argument_list|)
expr_stmt|;
return|return
operator|(
name|zfs_error
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|EZFS_THREADCREATEFAILED
argument_list|,
name|errbuf
argument_list|)
operator|)
return|;
block|}
comment|/* do the ioctl() */
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_value
argument_list|,
name|di
operator|.
name|fromsnap
argument_list|,
name|strlen
argument_list|(
name|di
operator|.
name|fromsnap
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|di
operator|.
name|tosnap
argument_list|,
name|strlen
argument_list|(
name|di
operator|.
name|tosnap
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|zc
operator|.
name|zc_cookie
operator|=
name|pipefd
index|[
literal|1
index|]
expr_stmt|;
name|iocerr
operator|=
name|ioctl
argument_list|(
name|zhp
operator|->
name|zfs_hdl
operator|->
name|libzfs_fd
argument_list|,
name|ZFS_IOC_DIFF
argument_list|,
operator|&
name|zc
argument_list|)
expr_stmt|;
if|if
condition|(
name|iocerr
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|errbuf
argument_list|)
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"Unable to obtain diffs"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
name|EPERM
condition|)
block|{
name|zfs_error_aux
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"\n   The sys_mount privilege or diff delegated "
literal|"permission is needed\n   to execute the "
literal|"diff ioctl"
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|errno
operator|==
name|EXDEV
condition|)
block|{
name|zfs_error_aux
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|dgettext
argument_list|(
name|TEXT_DOMAIN
argument_list|,
literal|"\n   Not an earlier snapshot from the same fs"
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|errno
operator|!=
name|EPIPE
operator|||
name|di
operator|.
name|zerr
operator|==
literal|0
condition|)
block|{
name|zfs_error_aux
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|pipefd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|pthread_cancel
argument_list|(
name|tid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|pthread_join
argument_list|(
name|tid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|teardown_differ_info
argument_list|(
operator|&
name|di
argument_list|)
expr_stmt|;
if|if
condition|(
name|di
operator|.
name|zerr
operator|!=
literal|0
operator|&&
name|di
operator|.
name|zerr
operator|!=
name|EPIPE
condition|)
block|{
name|zfs_error_aux
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|strerror
argument_list|(
name|di
operator|.
name|zerr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zfs_error
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|EZFS_DIFF
argument_list|,
name|di
operator|.
name|errbuf
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|zfs_error
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|EZFS_DIFFDATA
argument_list|,
name|errbuf
argument_list|)
operator|)
return|;
block|}
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|pipefd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|pthread_join
argument_list|(
name|tid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|di
operator|.
name|zerr
operator|!=
literal|0
condition|)
block|{
name|zfs_error_aux
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|strerror
argument_list|(
name|di
operator|.
name|zerr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zfs_error
argument_list|(
name|zhp
operator|->
name|zfs_hdl
argument_list|,
name|EZFS_DIFF
argument_list|,
name|di
operator|.
name|errbuf
argument_list|)
operator|)
return|;
block|}
name|teardown_differ_info
argument_list|(
operator|&
name|di
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2010-2012 Semihalf.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/stdint.h>
end_include

begin_include
include|#
directive|include
file|<ufs/ufs/dinode.h>
end_include

begin_include
include|#
directive|include
file|<fs/nandfs/nandfs_fs.h>
end_include

begin_include
include|#
directive|include
file|"stand.h"
end_include

begin_include
include|#
directive|include
file|"string.h"
end_include

begin_include
include|#
directive|include
file|"zlib.h"
end_include

begin_define
define|#
directive|define
name|DEBUG
end_define

begin_undef
undef|#
directive|undef
name|DEBUG
end_undef

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|NANDFS_DEBUG
parameter_list|(
name|fmt
parameter_list|,
name|args
modifier|...
parameter_list|)
value|do { \     printf("NANDFS_DEBUG:" fmt "\n", ##args); } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|NANDFS_DEBUG
parameter_list|(
name|fmt
parameter_list|,
name|args
modifier|...
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|nandfs_mdt
block|{
name|uint32_t
name|entries_per_block
decl_stmt|;
name|uint32_t
name|entries_per_group
decl_stmt|;
name|uint32_t
name|blocks_per_group
decl_stmt|;
name|uint32_t
name|groups_per_desc_block
decl_stmt|;
comment|/* desc is super group */
name|uint32_t
name|blocks_per_desc_block
decl_stmt|;
comment|/* desc is super group */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|bmap_buf
block|{
name|LIST_ENTRY
argument_list|(
argument|bmap_buf
argument_list|)
name|list
expr_stmt|;
name|nandfs_daddr_t
name|blknr
decl_stmt|;
name|uint64_t
modifier|*
name|map
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|nandfs_node
block|{
name|struct
name|nandfs_inode
modifier|*
name|inode
decl_stmt|;
name|LIST_HEAD
argument_list|(
argument_list|,
argument|bmap_buf
argument_list|)
name|bmap_bufs
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|nandfs
block|{
name|int
name|nf_blocksize
decl_stmt|;
name|int
name|nf_sectorsize
decl_stmt|;
name|int
name|nf_cpno
decl_stmt|;
name|struct
name|open_file
modifier|*
name|nf_file
decl_stmt|;
name|struct
name|nandfs_node
modifier|*
name|nf_opened_node
decl_stmt|;
name|u_int
name|nf_offset
decl_stmt|;
name|uint8_t
modifier|*
name|nf_buf
decl_stmt|;
name|int64_t
name|nf_buf_blknr
decl_stmt|;
name|struct
name|nandfs_fsdata
modifier|*
name|nf_fsdata
decl_stmt|;
name|struct
name|nandfs_super_block
modifier|*
name|nf_sb
decl_stmt|;
name|struct
name|nandfs_segment_summary
name|nf_segsum
decl_stmt|;
name|struct
name|nandfs_checkpoint
name|nf_checkpoint
decl_stmt|;
name|struct
name|nandfs_super_root
name|nf_sroot
decl_stmt|;
name|struct
name|nandfs_node
name|nf_ifile
decl_stmt|;
name|struct
name|nandfs_node
name|nf_datfile
decl_stmt|;
name|struct
name|nandfs_node
name|nf_cpfile
decl_stmt|;
name|struct
name|nandfs_mdt
name|nf_datfile_mdt
decl_stmt|;
name|struct
name|nandfs_mdt
name|nf_ifile_mdt
decl_stmt|;
name|int
name|nf_nindir
index|[
name|NIADDR
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|nandfs_open
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|struct
name|open_file
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_close
parameter_list|(
name|struct
name|open_file
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_read
parameter_list|(
name|struct
name|open_file
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|size_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|off_t
name|nandfs_seek
parameter_list|(
name|struct
name|open_file
modifier|*
parameter_list|,
name|off_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_stat
parameter_list|(
name|struct
name|open_file
modifier|*
parameter_list|,
name|struct
name|stat
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_readdir
parameter_list|(
name|struct
name|open_file
modifier|*
parameter_list|,
name|struct
name|dirent
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_buf_read
parameter_list|(
name|struct
name|nandfs
modifier|*
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|,
name|size_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|nandfs_node
modifier|*
name|nandfs_lookup_inode
parameter_list|(
name|struct
name|nandfs
modifier|*
parameter_list|,
name|nandfs_daddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|nandfs_node
modifier|*
name|nandfs_lookup_path
parameter_list|(
name|struct
name|nandfs
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_read_inode
parameter_list|(
name|struct
name|nandfs
modifier|*
parameter_list|,
name|struct
name|nandfs_node
modifier|*
parameter_list|,
name|nandfs_lbn_t
parameter_list|,
name|u_int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_read_blk
parameter_list|(
name|struct
name|nandfs
modifier|*
parameter_list|,
name|nandfs_daddr_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_bmap_lookup
parameter_list|(
name|struct
name|nandfs
modifier|*
parameter_list|,
name|struct
name|nandfs_node
modifier|*
parameter_list|,
name|nandfs_lbn_t
parameter_list|,
name|nandfs_daddr_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_get_checkpoint
parameter_list|(
name|struct
name|nandfs
modifier|*
parameter_list|,
name|uint64_t
parameter_list|,
name|struct
name|nandfs_checkpoint
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|nandfs_daddr_t
name|nandfs_vtop
parameter_list|(
name|struct
name|nandfs
modifier|*
parameter_list|,
name|nandfs_daddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nandfs_calc_mdt_consts
parameter_list|(
name|int
parameter_list|,
name|struct
name|nandfs_mdt
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nandfs_mdt_trans
parameter_list|(
name|struct
name|nandfs_mdt
modifier|*
parameter_list|,
name|uint64_t
parameter_list|,
name|nandfs_daddr_t
modifier|*
parameter_list|,
name|uint32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ioread
parameter_list|(
name|struct
name|open_file
modifier|*
parameter_list|,
name|off_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandfs_probe_sectorsize
parameter_list|(
name|struct
name|open_file
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|fs_ops
name|nandfs_fsops
init|=
block|{
literal|"nandfs"
block|,
name|nandfs_open
block|,
name|nandfs_close
block|,
name|nandfs_read
block|,
name|null_write
block|,
name|nandfs_seek
block|,
name|nandfs_stat
block|,
name|nandfs_readdir
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NINDIR
parameter_list|(
name|fs
parameter_list|)
value|((fs)->nf_blocksize / sizeof(nandfs_daddr_t))
end_define

begin_comment
comment|/* from NetBSD's src/sys/net/if_ethersubr.c */
end_comment

begin_function
specifier|static
name|uint32_t
name|nandfs_crc32
parameter_list|(
name|uint32_t
name|crc
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|static
specifier|const
name|uint32_t
name|crctab
index|[]
init|=
block|{
literal|0x00000000
block|,
literal|0x1db71064
block|,
literal|0x3b6e20c8
block|,
literal|0x26d930ac
block|,
literal|0x76dc4190
block|,
literal|0x6b6b51f4
block|,
literal|0x4db26158
block|,
literal|0x5005713c
block|,
literal|0xedb88320
block|,
literal|0xf00f9344
block|,
literal|0xd6d6a3e8
block|,
literal|0xcb61b38c
block|,
literal|0x9b64c2b0
block|,
literal|0x86d3d2d4
block|,
literal|0xa00ae278
block|,
literal|0xbdbdf21c
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|crc
operator|=
name|crc
operator|^
operator|~
literal|0U
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|crc
operator|^=
name|buf
index|[
name|i
index|]
expr_stmt|;
name|crc
operator|=
operator|(
name|crc
operator|>>
literal|4
operator|)
operator|^
name|crctab
index|[
name|crc
operator|&
literal|0xf
index|]
expr_stmt|;
name|crc
operator|=
operator|(
name|crc
operator|>>
literal|4
operator|)
operator|^
name|crctab
index|[
name|crc
operator|&
literal|0xf
index|]
expr_stmt|;
block|}
return|return
operator|(
name|crc
operator|^
operator|~
literal|0U
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_check_fsdata_crc
parameter_list|(
name|struct
name|nandfs_fsdata
modifier|*
name|fsdata
parameter_list|)
block|{
name|uint32_t
name|fsdata_crc
decl_stmt|,
name|comp_crc
decl_stmt|;
if|if
condition|(
name|fsdata
operator|->
name|f_magic
operator|!=
name|NANDFS_FSDATA_MAGIC
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Preserve crc */
name|fsdata_crc
operator|=
name|fsdata
operator|->
name|f_sum
expr_stmt|;
comment|/* Calculate */
name|fsdata
operator|->
name|f_sum
operator|=
operator|(
literal|0
operator|)
expr_stmt|;
name|comp_crc
operator|=
name|nandfs_crc32
argument_list|(
literal|0
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|fsdata
argument_list|,
name|fsdata
operator|->
name|f_bytes
argument_list|)
expr_stmt|;
comment|/* Restore */
name|fsdata
operator|->
name|f_sum
operator|=
name|fsdata_crc
expr_stmt|;
comment|/* Check CRC */
return|return
operator|(
name|fsdata_crc
operator|==
name|comp_crc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_check_superblock_crc
parameter_list|(
name|struct
name|nandfs_fsdata
modifier|*
name|fsdata
parameter_list|,
name|struct
name|nandfs_super_block
modifier|*
name|super
parameter_list|)
block|{
name|uint32_t
name|super_crc
decl_stmt|,
name|comp_crc
decl_stmt|;
comment|/* Check super block magic */
if|if
condition|(
name|super
operator|->
name|s_magic
operator|!=
name|NANDFS_SUPER_MAGIC
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Preserve CRC */
name|super_crc
operator|=
name|super
operator|->
name|s_sum
expr_stmt|;
comment|/* Calculate */
name|super
operator|->
name|s_sum
operator|=
operator|(
literal|0
operator|)
expr_stmt|;
name|comp_crc
operator|=
name|nandfs_crc32
argument_list|(
literal|0
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|super
argument_list|,
name|fsdata
operator|->
name|f_sbbytes
argument_list|)
expr_stmt|;
comment|/* Restore */
name|super
operator|->
name|s_sum
operator|=
name|super_crc
expr_stmt|;
comment|/* Check CRC */
return|return
operator|(
name|super_crc
operator|==
name|comp_crc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_find_super_block
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|struct
name|open_file
modifier|*
name|f
parameter_list|)
block|{
name|struct
name|nandfs_super_block
modifier|*
name|sb
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|n
decl_stmt|,
name|s
decl_stmt|;
name|int
name|sectors_to_read
decl_stmt|,
name|error
decl_stmt|;
name|sb
operator|=
name|malloc
argument_list|(
name|fs
operator|->
name|nf_sectorsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|sb
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|memset
argument_list|(
name|fs
operator|->
name|nf_sb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fs
operator|->
name|nf_sb
argument_list|)
argument_list|)
expr_stmt|;
name|sectors_to_read
operator|=
operator|(
name|NANDFS_NFSAREAS
operator|*
name|fs
operator|->
name|nf_fsdata
operator|->
name|f_erasesize
operator|)
operator|/
name|fs
operator|->
name|nf_sectorsize
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sectors_to_read
condition|;
name|i
operator|++
control|)
block|{
name|NANDFS_DEBUG
argument_list|(
literal|"reading i %d offset %d\n"
argument_list|,
name|i
argument_list|,
name|i
operator|*
name|fs
operator|->
name|nf_sectorsize
argument_list|)
expr_stmt|;
name|error
operator|=
name|ioread
argument_list|(
name|f
argument_list|,
name|i
operator|*
name|fs
operator|->
name|nf_sectorsize
argument_list|,
operator|(
name|char
operator|*
operator|)
name|sb
argument_list|,
name|fs
operator|->
name|nf_sectorsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|NANDFS_DEBUG
argument_list|(
literal|"error %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|n
operator|=
name|fs
operator|->
name|nf_sectorsize
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_super_block
argument_list|)
expr_stmt|;
name|s
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|*
name|fs
operator|->
name|nf_sectorsize
operator|)
operator|%
name|fs
operator|->
name|nf_fsdata
operator|->
name|f_erasesize
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|fs
operator|->
name|nf_sectorsize
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_fsdata
argument_list|)
condition|)
continue|continue;
else|else
block|{
name|s
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_fsdata
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_super_block
argument_list|)
operator|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|j
operator|=
name|s
init|;
name|j
operator|<
name|n
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|nandfs_check_superblock_crc
argument_list|(
name|fs
operator|->
name|nf_fsdata
argument_list|,
operator|&
name|sb
index|[
name|j
index|]
argument_list|)
condition|)
continue|continue;
name|NANDFS_DEBUG
argument_list|(
literal|"magic %x wtime %jd, lastcp 0x%jx\n"
argument_list|,
name|sb
index|[
name|j
index|]
operator|.
name|s_magic
argument_list|,
name|sb
index|[
name|j
index|]
operator|.
name|s_wtime
argument_list|,
name|sb
index|[
name|j
index|]
operator|.
name|s_last_cno
argument_list|)
expr_stmt|;
if|if
condition|(
name|sb
index|[
name|j
index|]
operator|.
name|s_last_cno
operator|>
name|fs
operator|->
name|nf_sb
operator|->
name|s_last_cno
condition|)
name|memcpy
argument_list|(
name|fs
operator|->
name|nf_sb
argument_list|,
operator|&
name|sb
index|[
name|j
index|]
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fs
operator|->
name|nf_sb
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|sb
argument_list|)
expr_stmt|;
return|return
operator|(
name|fs
operator|->
name|nf_sb
operator|->
name|s_magic
operator|!=
literal|0
condition|?
literal|0
else|:
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_find_fsdata
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|struct
name|open_file
modifier|*
name|f
parameter_list|)
block|{
name|int
name|offset
decl_stmt|,
name|error
decl_stmt|,
name|i
decl_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"starting\n"
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
operator|*
name|NANDFS_NFSAREAS
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|ioread
argument_list|(
name|f
argument_list|,
name|offset
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fs
operator|->
name|nf_fsdata
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_fsdata
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|fs
operator|->
name|nf_fsdata
operator|->
name|f_magic
operator|==
name|NANDFS_FSDATA_MAGIC
condition|)
block|{
name|NANDFS_DEBUG
argument_list|(
literal|"found at %x, volume %s\n"
argument_list|,
name|offset
argument_list|,
name|fs
operator|->
name|nf_fsdata
operator|->
name|f_volume_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|nandfs_check_fsdata_crc
argument_list|(
name|fs
operator|->
name|nf_fsdata
argument_list|)
condition|)
break|break;
block|}
name|offset
operator|+=
name|fs
operator|->
name|nf_sectorsize
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_read_structures
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|struct
name|open_file
modifier|*
name|f
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|nandfs_find_fsdata
argument_list|(
name|fs
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|nandfs_find_super_block
argument_list|(
name|fs
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|NANDFS_DEBUG
argument_list|(
literal|"selected sb with w_time %jd last_pseg %jx\n"
argument_list|,
name|fs
operator|->
name|nf_sb
operator|->
name|s_wtime
argument_list|,
name|fs
operator|->
name|nf_sb
operator|->
name|s_last_pseg
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_mount
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|struct
name|open_file
modifier|*
name|f
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|,
name|level
decl_stmt|;
name|uint64_t
name|last_pseg
decl_stmt|;
name|fs
operator|->
name|nf_fsdata
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_fsdata
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|->
name|nf_sb
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_super_block
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|nandfs_read_structures
argument_list|(
name|fs
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|free
argument_list|(
name|fs
operator|->
name|nf_fsdata
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fs
operator|->
name|nf_sb
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|fs
operator|->
name|nf_blocksize
operator|=
literal|1
operator|<<
operator|(
name|fs
operator|->
name|nf_fsdata
operator|->
name|f_log_block_size
operator|+
literal|10
operator|)
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"using superblock with wtime %jd\n"
argument_list|,
name|fs
operator|->
name|nf_sb
operator|->
name|s_wtime
argument_list|)
expr_stmt|;
name|fs
operator|->
name|nf_cpno
operator|=
name|fs
operator|->
name|nf_sb
operator|->
name|s_last_cno
expr_stmt|;
name|last_pseg
operator|=
name|fs
operator|->
name|nf_sb
operator|->
name|s_last_pseg
expr_stmt|;
comment|/* 	 * Calculate indirect block levels. 	 */
name|nandfs_daddr_t
name|mult
decl_stmt|;
name|mult
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|level
operator|=
literal|0
init|;
name|level
operator|<
name|NIADDR
condition|;
name|level
operator|++
control|)
block|{
name|mult
operator|*=
name|NINDIR
argument_list|(
name|fs
argument_list|)
expr_stmt|;
name|fs
operator|->
name|nf_nindir
index|[
name|level
index|]
operator|=
name|mult
expr_stmt|;
block|}
name|nandfs_calc_mdt_consts
argument_list|(
name|fs
operator|->
name|nf_blocksize
argument_list|,
operator|&
name|fs
operator|->
name|nf_datfile_mdt
argument_list|,
name|fs
operator|->
name|nf_fsdata
operator|->
name|f_dat_entry_size
argument_list|)
expr_stmt|;
name|nandfs_calc_mdt_consts
argument_list|(
name|fs
operator|->
name|nf_blocksize
argument_list|,
operator|&
name|fs
operator|->
name|nf_ifile_mdt
argument_list|,
name|fs
operator|->
name|nf_fsdata
operator|->
name|f_inode_size
argument_list|)
expr_stmt|;
name|err
operator|=
name|ioread
argument_list|(
name|f
argument_list|,
name|last_pseg
operator|*
name|fs
operator|->
name|nf_blocksize
argument_list|,
operator|&
name|fs
operator|->
name|nf_segsum
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_segment_summary
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|free
argument_list|(
name|fs
operator|->
name|nf_sb
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fs
operator|->
name|nf_fsdata
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|ioread
argument_list|(
name|f
argument_list|,
operator|(
name|last_pseg
operator|+
name|fs
operator|->
name|nf_segsum
operator|.
name|ss_nblocks
operator|-
literal|1
operator|)
operator|*
name|fs
operator|->
name|nf_blocksize
argument_list|,
operator|&
name|fs
operator|->
name|nf_sroot
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_super_root
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|free
argument_list|(
name|fs
operator|->
name|nf_sb
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fs
operator|->
name|nf_fsdata
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|fs
operator|->
name|nf_datfile
operator|.
name|inode
operator|=
operator|&
name|fs
operator|->
name|nf_sroot
operator|.
name|sr_dat
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|fs
operator|->
name|nf_datfile
operator|.
name|bmap_bufs
argument_list|)
expr_stmt|;
name|fs
operator|->
name|nf_cpfile
operator|.
name|inode
operator|=
operator|&
name|fs
operator|->
name|nf_sroot
operator|.
name|sr_cpfile
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|fs
operator|->
name|nf_cpfile
operator|.
name|bmap_bufs
argument_list|)
expr_stmt|;
name|err
operator|=
name|nandfs_get_checkpoint
argument_list|(
name|fs
argument_list|,
name|fs
operator|->
name|nf_cpno
argument_list|,
operator|&
name|fs
operator|->
name|nf_checkpoint
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|free
argument_list|(
name|fs
operator|->
name|nf_sb
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fs
operator|->
name|nf_fsdata
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|NANDFS_DEBUG
argument_list|(
literal|"checkpoint cp_cno=%lld\n"
argument_list|,
name|fs
operator|->
name|nf_checkpoint
operator|.
name|cp_cno
argument_list|)
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"checkpoint cp_inodes_count=%lld\n"
argument_list|,
name|fs
operator|->
name|nf_checkpoint
operator|.
name|cp_inodes_count
argument_list|)
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"checkpoint cp_ifile_inode.i_blocks=%lld\n"
argument_list|,
name|fs
operator|->
name|nf_checkpoint
operator|.
name|cp_ifile_inode
operator|.
name|i_blocks
argument_list|)
expr_stmt|;
name|fs
operator|->
name|nf_ifile
operator|.
name|inode
operator|=
operator|&
name|fs
operator|->
name|nf_checkpoint
operator|.
name|cp_ifile_inode
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|fs
operator|->
name|nf_ifile
operator|.
name|bmap_bufs
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|NINDIR
parameter_list|(
name|fs
parameter_list|)
value|((fs)->nf_blocksize / sizeof(nandfs_daddr_t))
end_define

begin_function
specifier|static
name|int
name|nandfs_open
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|struct
name|open_file
modifier|*
name|f
parameter_list|)
block|{
name|struct
name|nandfs
modifier|*
name|fs
decl_stmt|;
name|struct
name|nandfs_node
modifier|*
name|node
decl_stmt|;
name|int
name|err
decl_stmt|,
name|bsize
decl_stmt|,
name|level
decl_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_open('%s', %p)\n"
argument_list|,
name|path
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|->
name|f_fsdata
operator|=
name|fs
expr_stmt|;
name|fs
operator|->
name|nf_file
operator|=
name|f
expr_stmt|;
name|bsize
operator|=
name|nandfs_probe_sectorsize
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsize
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Cannot probe medium sector size\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|fs
operator|->
name|nf_sectorsize
operator|=
name|bsize
expr_stmt|;
comment|/* 	 * Calculate indirect block levels. 	 */
name|nandfs_daddr_t
name|mult
decl_stmt|;
name|mult
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|level
operator|=
literal|0
init|;
name|level
operator|<
name|NIADDR
condition|;
name|level
operator|++
control|)
block|{
name|mult
operator|*=
name|NINDIR
argument_list|(
name|fs
argument_list|)
expr_stmt|;
name|fs
operator|->
name|nf_nindir
index|[
name|level
index|]
operator|=
name|mult
expr_stmt|;
block|}
name|NANDFS_DEBUG
argument_list|(
literal|"fs %p nf_sectorsize=%x\n"
argument_list|,
name|fs
argument_list|,
name|fs
operator|->
name|nf_sectorsize
argument_list|)
expr_stmt|;
name|err
operator|=
name|nandfs_mount
argument_list|(
name|fs
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|NANDFS_DEBUG
argument_list|(
literal|"Cannot mount nandfs: %s\n"
argument_list|,
name|strerror
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|node
operator|=
name|nandfs_lookup_path
argument_list|(
name|fs
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|fs
operator|->
name|nf_offset
operator|=
literal|0
expr_stmt|;
name|fs
operator|->
name|nf_buf
operator|=
name|NULL
expr_stmt|;
name|fs
operator|->
name|nf_buf_blknr
operator|=
operator|-
literal|1
expr_stmt|;
name|fs
operator|->
name|nf_opened_node
operator|=
name|node
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|fs
operator|->
name|nf_opened_node
operator|->
name|bmap_bufs
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nandfs_free_node
parameter_list|(
name|struct
name|nandfs_node
modifier|*
name|node
parameter_list|)
block|{
name|struct
name|bmap_buf
modifier|*
name|bmap
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|free
argument_list|(
name|node
operator|->
name|inode
argument_list|)
expr_stmt|;
name|LIST_FOREACH_SAFE
argument_list|(
argument|bmap
argument_list|,
argument|&node->bmap_bufs
argument_list|,
argument|list
argument_list|,
argument|tmp
argument_list|)
block|{
name|LIST_REMOVE
argument_list|(
name|bmap
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bmap
operator|->
name|map
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bmap
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_close
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|)
block|{
name|struct
name|nandfs
modifier|*
name|fs
init|=
name|f
operator|->
name|f_fsdata
decl_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_close(%p)\n"
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|fs
operator|->
name|nf_buf
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|fs
operator|->
name|nf_buf
argument_list|)
expr_stmt|;
name|nandfs_free_node
argument_list|(
name|fs
operator|->
name|nf_opened_node
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fs
operator|->
name|nf_sb
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fs
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_read
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
modifier|*
name|resid
parameter_list|)
block|{
name|struct
name|nandfs
modifier|*
name|fs
init|=
operator|(
expr|struct
name|nandfs
operator|*
operator|)
name|f
operator|->
name|f_fsdata
decl_stmt|;
name|size_t
name|csize
decl_stmt|,
name|buf_size
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_read(file=%p, addr=%p, size=%d)\n"
argument_list|,
name|f
argument_list|,
name|addr
argument_list|,
name|size
argument_list|)
expr_stmt|;
while|while
condition|(
name|size
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|fs
operator|->
name|nf_offset
operator|>=
name|fs
operator|->
name|nf_opened_node
operator|->
name|inode
operator|->
name|i_size
condition|)
break|break;
name|error
operator|=
name|nandfs_buf_read
argument_list|(
name|fs
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|buf
argument_list|,
operator|&
name|buf_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|csize
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|csize
operator|>
name|buf_size
condition|)
name|csize
operator|=
name|buf_size
expr_stmt|;
name|bcopy
argument_list|(
name|buf
argument_list|,
name|addr
argument_list|,
name|csize
argument_list|)
expr_stmt|;
name|fs
operator|->
name|nf_offset
operator|+=
name|csize
expr_stmt|;
name|addr
operator|=
operator|(
name|char
operator|*
operator|)
name|addr
operator|+
name|csize
expr_stmt|;
name|size
operator|-=
name|csize
expr_stmt|;
block|}
if|if
condition|(
name|resid
condition|)
operator|*
name|resid
operator|=
name|size
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|off_t
name|nandfs_seek
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|,
name|off_t
name|offset
parameter_list|,
name|int
name|where
parameter_list|)
block|{
name|struct
name|nandfs
modifier|*
name|fs
init|=
name|f
operator|->
name|f_fsdata
decl_stmt|;
name|off_t
name|off
decl_stmt|;
name|u_int
name|size
decl_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_seek(file=%p, offset=%lld, where=%d)\n"
argument_list|,
name|f
argument_list|,
name|offset
argument_list|,
name|where
argument_list|)
expr_stmt|;
name|size
operator|=
name|fs
operator|->
name|nf_opened_node
operator|->
name|inode
operator|->
name|i_size
expr_stmt|;
switch|switch
condition|(
name|where
condition|)
block|{
case|case
name|SEEK_SET
case|:
name|off
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SEEK_CUR
case|:
name|off
operator|=
name|fs
operator|->
name|nf_offset
expr_stmt|;
break|break;
case|case
name|SEEK_END
case|:
name|off
operator|=
name|size
expr_stmt|;
break|break;
default|default:
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|off
operator|+=
name|offset
expr_stmt|;
if|if
condition|(
name|off
operator|<
literal|0
operator|||
name|off
operator|>
name|size
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|fs
operator|->
name|nf_offset
operator|=
operator|(
name|u_int
operator|)
name|off
expr_stmt|;
return|return
operator|(
name|off
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_stat
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|,
name|struct
name|stat
modifier|*
name|sb
parameter_list|)
block|{
name|struct
name|nandfs
modifier|*
name|fs
init|=
name|f
operator|->
name|f_fsdata
decl_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_stat(file=%p, stat=%p)\n"
argument_list|,
name|f
argument_list|,
name|sb
argument_list|)
expr_stmt|;
name|sb
operator|->
name|st_size
operator|=
name|fs
operator|->
name|nf_opened_node
operator|->
name|inode
operator|->
name|i_size
expr_stmt|;
name|sb
operator|->
name|st_mode
operator|=
name|fs
operator|->
name|nf_opened_node
operator|->
name|inode
operator|->
name|i_mode
expr_stmt|;
name|sb
operator|->
name|st_uid
operator|=
name|fs
operator|->
name|nf_opened_node
operator|->
name|inode
operator|->
name|i_uid
expr_stmt|;
name|sb
operator|->
name|st_gid
operator|=
name|fs
operator|->
name|nf_opened_node
operator|->
name|inode
operator|->
name|i_gid
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_readdir
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|,
name|struct
name|dirent
modifier|*
name|d
parameter_list|)
block|{
name|struct
name|nandfs
modifier|*
name|fs
init|=
name|f
operator|->
name|f_fsdata
decl_stmt|;
name|struct
name|nandfs_dir_entry
modifier|*
name|dirent
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|size_t
name|buf_size
decl_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_readdir(file=%p, dirent=%p)\n"
argument_list|,
name|f
argument_list|,
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|fs
operator|->
name|nf_offset
operator|>=
name|fs
operator|->
name|nf_opened_node
operator|->
name|inode
operator|->
name|i_size
condition|)
block|{
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_readdir(file=%p, dirent=%p) ENOENT\n"
argument_list|,
name|f
argument_list|,
name|d
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
if|if
condition|(
name|nandfs_buf_read
argument_list|(
name|fs
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|buf
argument_list|,
operator|&
name|buf_size
argument_list|)
condition|)
block|{
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_readdir(file=%p, dirent=%p)"
literal|"buf_read failed\n"
argument_list|,
name|f
argument_list|,
name|d
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_readdir(file=%p, dirent=%p) moving forward\n"
argument_list|,
name|f
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|dirent
operator|=
operator|(
expr|struct
name|nandfs_dir_entry
operator|*
operator|)
name|buf
expr_stmt|;
name|fs
operator|->
name|nf_offset
operator|+=
name|dirent
operator|->
name|rec_len
expr_stmt|;
name|strncpy
argument_list|(
name|d
operator|->
name|d_name
argument_list|,
name|dirent
operator|->
name|name
argument_list|,
name|dirent
operator|->
name|name_len
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_name
index|[
name|dirent
operator|->
name|name_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|d
operator|->
name|d_type
operator|=
name|dirent
operator|->
name|file_type
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_buf_read
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|char
modifier|*
modifier|*
name|buf_p
parameter_list|,
name|size_t
modifier|*
name|size_p
parameter_list|)
block|{
name|nandfs_daddr_t
name|blknr
decl_stmt|,
name|blkoff
decl_stmt|;
name|blknr
operator|=
name|fs
operator|->
name|nf_offset
operator|/
name|fs
operator|->
name|nf_blocksize
expr_stmt|;
name|blkoff
operator|=
name|fs
operator|->
name|nf_offset
operator|%
name|fs
operator|->
name|nf_blocksize
expr_stmt|;
if|if
condition|(
name|blknr
operator|!=
name|fs
operator|->
name|nf_buf_blknr
condition|)
block|{
if|if
condition|(
name|fs
operator|->
name|nf_buf
operator|==
name|NULL
condition|)
name|fs
operator|->
name|nf_buf
operator|=
name|malloc
argument_list|(
name|fs
operator|->
name|nf_blocksize
argument_list|)
expr_stmt|;
if|if
condition|(
name|nandfs_read_inode
argument_list|(
name|fs
argument_list|,
name|fs
operator|->
name|nf_opened_node
argument_list|,
name|blknr
argument_list|,
literal|1
argument_list|,
name|fs
operator|->
name|nf_buf
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|fs
operator|->
name|nf_buf_blknr
operator|=
name|blknr
expr_stmt|;
block|}
operator|*
name|buf_p
operator|=
name|fs
operator|->
name|nf_buf
operator|+
name|blkoff
expr_stmt|;
operator|*
name|size_p
operator|=
name|fs
operator|->
name|nf_blocksize
operator|-
name|blkoff
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_buf_read buf_p=%p size_p=%d\n"
argument_list|,
operator|*
name|buf_p
argument_list|,
operator|*
name|size_p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|size_p
operator|>
name|fs
operator|->
name|nf_opened_node
operator|->
name|inode
operator|->
name|i_size
operator|-
name|fs
operator|->
name|nf_offset
condition|)
operator|*
name|size_p
operator|=
name|fs
operator|->
name|nf_opened_node
operator|->
name|inode
operator|->
name|i_size
operator|-
name|fs
operator|->
name|nf_offset
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|nandfs_node
modifier|*
name|nandfs_lookup_node
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|uint64_t
name|ino
parameter_list|)
block|{
name|uint64_t
name|blocknr
decl_stmt|;
name|int
name|entrynr
decl_stmt|;
name|struct
name|nandfs_inode
modifier|*
name|buffer
decl_stmt|;
name|struct
name|nandfs_node
modifier|*
name|node
decl_stmt|;
name|struct
name|nandfs_inode
modifier|*
name|inode
decl_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_lookup_node ino=%lld\n"
argument_list|,
name|ino
argument_list|)
expr_stmt|;
if|if
condition|(
name|ino
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nandfs_lookup_node: invalid inode requested\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|buffer
operator|=
name|malloc
argument_list|(
name|fs
operator|->
name|nf_blocksize
argument_list|)
expr_stmt|;
name|inode
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_inode
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_node
argument_list|)
argument_list|)
expr_stmt|;
name|nandfs_mdt_trans
argument_list|(
operator|&
name|fs
operator|->
name|nf_ifile_mdt
argument_list|,
name|ino
argument_list|,
operator|&
name|blocknr
argument_list|,
operator|&
name|entrynr
argument_list|)
expr_stmt|;
if|if
condition|(
name|nandfs_read_inode
argument_list|(
name|fs
argument_list|,
operator|&
name|fs
operator|->
name|nf_ifile
argument_list|,
name|blocknr
argument_list|,
literal|1
argument_list|,
name|buffer
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|memcpy
argument_list|(
name|inode
argument_list|,
operator|&
name|buffer
index|[
name|entrynr
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_inode
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|->
name|inode
operator|=
name|inode
expr_stmt|;
name|free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
name|node
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|nandfs_node
modifier|*
name|nandfs_lookup_path
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|nandfs_node
modifier|*
name|node
decl_stmt|;
name|struct
name|nandfs_dir_entry
modifier|*
name|dirent
decl_stmt|;
name|char
modifier|*
name|namebuf
decl_stmt|;
name|uint64_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|done
decl_stmt|,
name|counter
decl_stmt|,
name|pinode
decl_stmt|,
name|inode
decl_stmt|;
name|int
name|nlinks
init|=
literal|0
decl_stmt|,
name|len
decl_stmt|,
name|link_len
decl_stmt|,
name|nameidx
decl_stmt|;
name|uint8_t
modifier|*
name|buffer
decl_stmt|,
modifier|*
name|orig
decl_stmt|;
name|char
modifier|*
name|strp
decl_stmt|,
modifier|*
name|lpath
decl_stmt|;
name|buffer
operator|=
name|malloc
argument_list|(
name|fs
operator|->
name|nf_blocksize
argument_list|)
expr_stmt|;
name|orig
operator|=
name|buffer
expr_stmt|;
name|namebuf
operator|=
name|malloc
argument_list|(
literal|2
operator|*
name|MAXPATHLEN
operator|+
literal|2
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|namebuf
argument_list|,
name|path
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|namebuf
index|[
name|MAXPATHLEN
index|]
operator|=
literal|'\0'
expr_stmt|;
name|done
operator|=
name|nameidx
operator|=
literal|0
expr_stmt|;
name|lpath
operator|=
name|namebuf
expr_stmt|;
comment|/* Get the root inode */
name|node
operator|=
name|nandfs_lookup_node
argument_list|(
name|fs
argument_list|,
name|NANDFS_ROOT_INO
argument_list|)
expr_stmt|;
name|inode
operator|=
name|NANDFS_ROOT_INO
expr_stmt|;
while|while
condition|(
operator|(
name|strp
operator|=
name|strsep
argument_list|(
operator|&
name|lpath
argument_list|,
literal|"/"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|*
name|strp
operator|==
literal|'\0'
condition|)
continue|continue;
if|if
condition|(
operator|(
name|node
operator|->
name|inode
operator|->
name|i_mode
operator|&
name|IFMT
operator|)
operator|!=
name|IFDIR
condition|)
block|{
name|nandfs_free_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|strp
argument_list|)
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"%s: looking for %s\n"
argument_list|,
name|__func__
argument_list|,
name|strp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|node
operator|->
name|inode
operator|->
name|i_blocks
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nandfs_read_inode
argument_list|(
name|fs
argument_list|,
name|node
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
name|orig
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|node
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|buffer
operator|=
name|orig
expr_stmt|;
name|done
operator|=
name|counter
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|dirent
operator|=
operator|(
expr|struct
name|nandfs_dir_entry
operator|*
operator|)
name|buffer
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"%s: dirent.name = %s\n"
argument_list|,
name|__func__
argument_list|,
name|dirent
operator|->
name|name
argument_list|)
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"%s: dirent.rec_len = %d\n"
argument_list|,
name|__func__
argument_list|,
name|dirent
operator|->
name|rec_len
argument_list|)
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"%s: dirent.inode = %lld\n"
argument_list|,
name|__func__
argument_list|,
name|dirent
operator|->
name|inode
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|dirent
operator|->
name|name_len
operator|&&
operator|(
name|strncmp
argument_list|(
name|strp
argument_list|,
name|dirent
operator|->
name|name
argument_list|,
name|len
argument_list|)
operator|==
literal|0
operator|)
operator|&&
name|dirent
operator|->
name|inode
operator|!=
literal|0
condition|)
block|{
name|nandfs_free_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|nandfs_lookup_node
argument_list|(
name|fs
argument_list|,
name|dirent
operator|->
name|inode
argument_list|)
expr_stmt|;
name|pinode
operator|=
name|inode
expr_stmt|;
name|inode
operator|=
name|dirent
operator|->
name|inode
expr_stmt|;
name|done
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|counter
operator|+=
name|dirent
operator|->
name|rec_len
expr_stmt|;
name|buffer
operator|+=
name|dirent
operator|->
name|rec_len
expr_stmt|;
if|if
condition|(
name|counter
operator|==
name|fs
operator|->
name|nf_blocksize
condition|)
break|break;
block|}
if|if
condition|(
name|done
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|done
condition|)
block|{
name|node
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|NANDFS_DEBUG
argument_list|(
literal|"%s: %.*s has mode %o\n"
argument_list|,
name|__func__
argument_list|,
name|dirent
operator|->
name|name_len
argument_list|,
name|dirent
operator|->
name|name
argument_list|,
name|node
operator|->
name|inode
operator|->
name|i_mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|node
operator|->
name|inode
operator|->
name|i_mode
operator|&
name|IFMT
operator|)
operator|==
name|IFLNK
condition|)
block|{
name|NANDFS_DEBUG
argument_list|(
literal|"%s: %.*s is symlink\n"
argument_list|,
name|__func__
argument_list|,
name|dirent
operator|->
name|name_len
argument_list|,
name|dirent
operator|->
name|name
argument_list|)
expr_stmt|;
name|link_len
operator|=
name|node
operator|->
name|inode
operator|->
name|i_size
expr_stmt|;
if|if
condition|(
operator|++
name|nlinks
operator|>
name|MAXSYMLINKS
condition|)
block|{
name|nandfs_free_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|nandfs_read_inode
argument_list|(
name|fs
argument_list|,
name|node
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|orig
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|nandfs_free_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|NANDFS_DEBUG
argument_list|(
literal|"%s: symlink is  %.*s\n"
argument_list|,
name|__func__
argument_list|,
name|link_len
argument_list|,
operator|(
name|char
operator|*
operator|)
name|orig
argument_list|)
expr_stmt|;
name|nameidx
operator|=
operator|(
name|nameidx
operator|==
literal|0
operator|)
condition|?
name|MAXPATHLEN
operator|+
literal|1
else|:
literal|0
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|orig
argument_list|,
name|namebuf
operator|+
name|nameidx
argument_list|,
operator|(
name|unsigned
operator|)
name|link_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|lpath
operator|!=
name|NULL
condition|)
block|{
name|namebuf
index|[
name|nameidx
operator|+
name|link_len
operator|++
index|]
operator|=
literal|'/'
expr_stmt|;
name|strncpy
argument_list|(
name|namebuf
operator|+
name|nameidx
operator|+
name|link_len
argument_list|,
name|lpath
argument_list|,
name|MAXPATHLEN
operator|-
name|link_len
argument_list|)
expr_stmt|;
name|namebuf
index|[
name|nameidx
operator|+
name|MAXPATHLEN
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
name|namebuf
index|[
name|nameidx
operator|+
name|link_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"%s: strp=%s, lpath=%s, namebuf0=%s, "
literal|"namebuf1=%s, idx=%d\n"
argument_list|,
name|__func__
argument_list|,
name|strp
argument_list|,
name|lpath
argument_list|,
name|namebuf
operator|+
literal|0
argument_list|,
name|namebuf
operator|+
name|MAXPATHLEN
operator|+
literal|1
argument_list|,
name|nameidx
argument_list|)
expr_stmt|;
name|lpath
operator|=
name|namebuf
operator|+
name|nameidx
expr_stmt|;
name|nandfs_free_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
comment|/* 			 * If absolute pathname, restart at root. Otherwise 			 * continue with out parent inode. 			 */
name|inode
operator|=
operator|(
name|orig
index|[
literal|0
index|]
operator|==
literal|'/'
operator|)
condition|?
name|NANDFS_ROOT_INO
else|:
name|pinode
expr_stmt|;
name|node
operator|=
name|nandfs_lookup_node
argument_list|(
name|fs
argument_list|,
name|inode
argument_list|)
expr_stmt|;
block|}
block|}
name|out
label|:
name|free
argument_list|(
name|namebuf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|orig
argument_list|)
expr_stmt|;
return|return
operator|(
name|node
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_read_inode
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|struct
name|nandfs_node
modifier|*
name|node
parameter_list|,
name|nandfs_daddr_t
name|blknr
parameter_list|,
name|u_int
name|nblks
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|raw
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint64_t
modifier|*
name|pblks
decl_stmt|;
name|uint64_t
modifier|*
name|vblks
decl_stmt|;
name|int
name|error
decl_stmt|;
name|pblks
operator|=
name|malloc
argument_list|(
name|nblks
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
name|vblks
operator|=
name|malloc
argument_list|(
name|nblks
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_read_inode fs=%p node=%p blknr=%lld nblks=%d\n"
argument_list|,
name|fs
argument_list|,
name|node
argument_list|,
name|blknr
argument_list|,
name|nblks
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nblks
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|nandfs_bmap_lookup
argument_list|(
name|fs
argument_list|,
name|node
argument_list|,
name|blknr
operator|+
name|i
argument_list|,
operator|&
name|vblks
index|[
name|i
index|]
argument_list|,
name|raw
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|free
argument_list|(
name|pblks
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vblks
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|raw
operator|==
literal|0
condition|)
name|pblks
index|[
name|i
index|]
operator|=
name|nandfs_vtop
argument_list|(
name|fs
argument_list|,
name|vblks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|pblks
index|[
name|i
index|]
operator|=
name|vblks
index|[
name|i
index|]
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nblks
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ioread
argument_list|(
name|fs
operator|->
name|nf_file
argument_list|,
name|pblks
index|[
name|i
index|]
operator|*
name|fs
operator|->
name|nf_blocksize
argument_list|,
name|buf
argument_list|,
name|fs
operator|->
name|nf_blocksize
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|pblks
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vblks
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|buf
operator|+=
name|fs
operator|->
name|nf_blocksize
expr_stmt|;
block|}
name|free
argument_list|(
name|pblks
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vblks
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_read_blk
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|nandfs_daddr_t
name|blknr
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|phys
parameter_list|)
block|{
name|uint64_t
name|pblknr
decl_stmt|;
name|pblknr
operator|=
operator|(
name|phys
condition|?
name|blknr
else|:
name|nandfs_vtop
argument_list|(
name|fs
argument_list|,
name|blknr
argument_list|)
operator|)
expr_stmt|;
return|return
operator|(
name|ioread
argument_list|(
name|fs
operator|->
name|nf_file
argument_list|,
name|pblknr
operator|*
name|fs
operator|->
name|nf_blocksize
argument_list|,
name|buf
argument_list|,
name|fs
operator|->
name|nf_blocksize
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_get_checkpoint
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|uint64_t
name|cpno
parameter_list|,
name|struct
name|nandfs_checkpoint
modifier|*
name|cp
parameter_list|)
block|{
name|uint64_t
name|blocknr
decl_stmt|;
name|int
name|blockoff
decl_stmt|,
name|cp_per_block
decl_stmt|,
name|dlen
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_get_checkpoint(fs=%p cpno=%lld)\n"
argument_list|,
name|fs
argument_list|,
name|cpno
argument_list|)
expr_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|fs
operator|->
name|nf_blocksize
argument_list|)
expr_stmt|;
name|cpno
operator|+=
name|NANDFS_CPFILE_FIRST_CHECKPOINT_OFFSET
operator|-
literal|1
expr_stmt|;
name|dlen
operator|=
name|fs
operator|->
name|nf_fsdata
operator|->
name|f_checkpoint_size
expr_stmt|;
name|cp_per_block
operator|=
name|fs
operator|->
name|nf_blocksize
operator|/
name|dlen
expr_stmt|;
name|blocknr
operator|=
name|cpno
operator|/
name|cp_per_block
expr_stmt|;
name|blockoff
operator|=
operator|(
name|cpno
operator|%
name|cp_per_block
operator|)
operator|*
name|dlen
expr_stmt|;
if|if
condition|(
name|nandfs_read_inode
argument_list|(
name|fs
argument_list|,
operator|&
name|fs
operator|->
name|nf_cpfile
argument_list|,
name|blocknr
argument_list|,
literal|1
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|cp
argument_list|,
name|buf
operator|+
name|blockoff
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_checkpoint
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
modifier|*
name|nandfs_get_map
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|struct
name|nandfs_node
modifier|*
name|node
parameter_list|,
name|nandfs_daddr_t
name|blknr
parameter_list|,
name|int
name|phys
parameter_list|)
block|{
name|struct
name|bmap_buf
modifier|*
name|bmap
decl_stmt|;
name|uint64_t
modifier|*
name|map
decl_stmt|;
name|LIST_FOREACH
argument_list|(
argument|bmap
argument_list|,
argument|&node->bmap_bufs
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|bmap
operator|->
name|blknr
operator|==
name|blknr
condition|)
return|return
operator|(
name|bmap
operator|->
name|map
operator|)
return|;
block|}
name|map
operator|=
name|malloc
argument_list|(
name|fs
operator|->
name|nf_blocksize
argument_list|)
expr_stmt|;
if|if
condition|(
name|nandfs_read_blk
argument_list|(
name|fs
argument_list|,
name|blknr
argument_list|,
name|map
argument_list|,
name|phys
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|map
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|bmap
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bmap_buf
argument_list|)
argument_list|)
expr_stmt|;
name|bmap
operator|->
name|blknr
operator|=
name|blknr
expr_stmt|;
name|bmap
operator|->
name|map
operator|=
name|map
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|node
operator|->
name|bmap_bufs
argument_list|,
name|bmap
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"%s:(node=%p, map=%p)\n"
argument_list|,
name|__func__
argument_list|,
name|node
argument_list|,
name|map
argument_list|)
expr_stmt|;
return|return
operator|(
name|map
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_bmap_lookup
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|struct
name|nandfs_node
modifier|*
name|node
parameter_list|,
name|nandfs_lbn_t
name|lblknr
parameter_list|,
name|nandfs_daddr_t
modifier|*
name|vblknr
parameter_list|,
name|int
name|phys
parameter_list|)
block|{
name|struct
name|nandfs_inode
modifier|*
name|ino
decl_stmt|;
name|nandfs_daddr_t
name|ind_block_num
decl_stmt|;
name|uint64_t
modifier|*
name|map
decl_stmt|,
modifier|*
name|indir
decl_stmt|;
name|uint64_t
name|idx0
decl_stmt|,
name|idx1
decl_stmt|,
name|vblk
decl_stmt|,
name|tmp
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|int
name|level
decl_stmt|;
name|ino
operator|=
name|node
operator|->
name|inode
expr_stmt|;
if|if
condition|(
name|lblknr
operator|<
name|NDADDR
condition|)
block|{
operator|*
name|vblknr
operator|=
name|ino
operator|->
name|i_db
index|[
name|lblknr
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|lblknr
operator|-=
name|NDADDR
expr_stmt|;
comment|/* 	 * nindir[0] = NINDIR 	 * nindir[1] = NINDIR**2 	 * nindir[2] = NINDIR**3 	 *	etc 	 */
for|for
control|(
name|level
operator|=
literal|0
init|;
name|level
operator|<
name|NIADDR
condition|;
name|level
operator|++
control|)
block|{
name|NANDFS_DEBUG
argument_list|(
literal|"lblknr=%jx fs->nf_nindir[%d]=%d\n"
argument_list|,
name|lblknr
argument_list|,
name|level
argument_list|,
name|fs
operator|->
name|nf_nindir
index|[
name|level
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|lblknr
operator|<
name|fs
operator|->
name|nf_nindir
index|[
name|level
index|]
condition|)
break|break;
name|lblknr
operator|-=
name|fs
operator|->
name|nf_nindir
index|[
name|level
index|]
expr_stmt|;
block|}
if|if
condition|(
name|level
operator|==
name|NIADDR
condition|)
block|{
comment|/* Block number too high */
name|NANDFS_DEBUG
argument_list|(
literal|"lblknr %jx too high\n"
argument_list|,
name|lblknr
argument_list|)
expr_stmt|;
return|return
operator|(
name|EFBIG
operator|)
return|;
block|}
name|ind_block_num
operator|=
name|ino
operator|->
name|i_ib
index|[
name|level
index|]
expr_stmt|;
for|for
control|(
init|;
name|level
operator|>=
literal|0
condition|;
name|level
operator|--
control|)
block|{
if|if
condition|(
name|ind_block_num
operator|==
literal|0
condition|)
block|{
operator|*
name|vblknr
operator|=
literal|0
expr_stmt|;
comment|/* missing */
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|twiddle
argument_list|()
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"calling get_map with %jx\n"
argument_list|,
name|ind_block_num
argument_list|)
expr_stmt|;
name|map
operator|=
name|nandfs_get_map
argument_list|(
name|fs
argument_list|,
name|node
argument_list|,
name|ind_block_num
argument_list|,
name|phys
argument_list|)
expr_stmt|;
if|if
condition|(
name|map
operator|==
name|NULL
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
block|{
name|idx
operator|=
name|lblknr
operator|/
name|fs
operator|->
name|nf_nindir
index|[
name|level
operator|-
literal|1
index|]
expr_stmt|;
name|lblknr
operator|%=
name|fs
operator|->
name|nf_nindir
index|[
name|level
operator|-
literal|1
index|]
expr_stmt|;
block|}
else|else
name|idx
operator|=
name|lblknr
expr_stmt|;
name|ind_block_num
operator|=
operator|(
operator|(
name|nandfs_daddr_t
operator|*
operator|)
name|map
operator|)
index|[
name|idx
index|]
expr_stmt|;
block|}
operator|*
name|vblknr
operator|=
name|ind_block_num
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|nandfs_daddr_t
name|nandfs_vtop
parameter_list|(
name|struct
name|nandfs
modifier|*
name|fs
parameter_list|,
name|nandfs_daddr_t
name|vblocknr
parameter_list|)
block|{
name|nandfs_lbn_t
name|blocknr
decl_stmt|;
name|nandfs_daddr_t
name|pblocknr
decl_stmt|;
name|int
name|entrynr
decl_stmt|;
name|struct
name|nandfs_dat_entry
modifier|*
name|dat
decl_stmt|;
name|dat
operator|=
name|malloc
argument_list|(
name|fs
operator|->
name|nf_blocksize
argument_list|)
expr_stmt|;
name|nandfs_mdt_trans
argument_list|(
operator|&
name|fs
operator|->
name|nf_datfile_mdt
argument_list|,
name|vblocknr
argument_list|,
operator|&
name|blocknr
argument_list|,
operator|&
name|entrynr
argument_list|)
expr_stmt|;
if|if
condition|(
name|nandfs_read_inode
argument_list|(
name|fs
argument_list|,
operator|&
name|fs
operator|->
name|nf_datfile
argument_list|,
name|blocknr
argument_list|,
literal|1
argument_list|,
name|dat
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|dat
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NANDFS_DEBUG
argument_list|(
literal|"nandfs_vtop entrynr=%d vblocknr=%lld pblocknr=%lld\n"
argument_list|,
name|entrynr
argument_list|,
name|vblocknr
argument_list|,
name|dat
index|[
name|entrynr
index|]
operator|.
name|de_blocknr
argument_list|)
expr_stmt|;
name|pblocknr
operator|=
name|dat
index|[
name|entrynr
index|]
operator|.
name|de_blocknr
expr_stmt|;
name|free
argument_list|(
name|dat
argument_list|)
expr_stmt|;
return|return
operator|(
name|pblocknr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nandfs_calc_mdt_consts
parameter_list|(
name|int
name|blocksize
parameter_list|,
name|struct
name|nandfs_mdt
modifier|*
name|mdt
parameter_list|,
name|int
name|entry_size
parameter_list|)
block|{
name|mdt
operator|->
name|entries_per_group
operator|=
name|blocksize
operator|*
literal|8
expr_stmt|;
comment|/* bits in sector */
name|mdt
operator|->
name|entries_per_block
operator|=
name|blocksize
operator|/
name|entry_size
expr_stmt|;
name|mdt
operator|->
name|blocks_per_group
operator|=
operator|(
name|mdt
operator|->
name|entries_per_group
operator|-
literal|1
operator|)
operator|/
name|mdt
operator|->
name|entries_per_block
operator|+
literal|1
operator|+
literal|1
expr_stmt|;
name|mdt
operator|->
name|groups_per_desc_block
operator|=
name|blocksize
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|nandfs_block_group_desc
argument_list|)
expr_stmt|;
name|mdt
operator|->
name|blocks_per_desc_block
operator|=
name|mdt
operator|->
name|groups_per_desc_block
operator|*
name|mdt
operator|->
name|blocks_per_group
operator|+
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nandfs_mdt_trans
parameter_list|(
name|struct
name|nandfs_mdt
modifier|*
name|mdt
parameter_list|,
name|uint64_t
name|index
parameter_list|,
name|nandfs_daddr_t
modifier|*
name|blocknr
parameter_list|,
name|uint32_t
modifier|*
name|entry_in_block
parameter_list|)
block|{
name|nandfs_daddr_t
name|blknr
decl_stmt|;
name|uint64_t
name|group
decl_stmt|,
name|group_offset
decl_stmt|,
name|blocknr_in_group
decl_stmt|;
name|uint64_t
name|desc_block
decl_stmt|,
name|desc_offset
decl_stmt|;
comment|/* Calculate our offset in the file */
name|group
operator|=
name|index
operator|/
name|mdt
operator|->
name|entries_per_group
expr_stmt|;
name|group_offset
operator|=
name|index
operator|%
name|mdt
operator|->
name|entries_per_group
expr_stmt|;
name|desc_block
operator|=
name|group
operator|/
name|mdt
operator|->
name|groups_per_desc_block
expr_stmt|;
name|desc_offset
operator|=
name|group
operator|%
name|mdt
operator|->
name|groups_per_desc_block
expr_stmt|;
name|blocknr_in_group
operator|=
name|group_offset
operator|/
name|mdt
operator|->
name|entries_per_block
expr_stmt|;
comment|/* To descgroup offset */
name|blknr
operator|=
literal|1
operator|+
name|desc_block
operator|*
name|mdt
operator|->
name|blocks_per_desc_block
expr_stmt|;
comment|/* To group offset */
name|blknr
operator|+=
name|desc_offset
operator|*
name|mdt
operator|->
name|blocks_per_group
expr_stmt|;
comment|/* To actual file block */
name|blknr
operator|+=
literal|1
operator|+
name|blocknr_in_group
expr_stmt|;
operator|*
name|blocknr
operator|=
name|blknr
expr_stmt|;
operator|*
name|entry_in_block
operator|=
name|group_offset
operator|%
name|mdt
operator|->
name|entries_per_block
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ioread
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|,
name|off_t
name|pos
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|u_int
name|length
parameter_list|)
block|{
name|void
modifier|*
name|buffer
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|bsize
init|=
operator|(
operator|(
expr|struct
name|nandfs
operator|*
operator|)
name|f
operator|->
name|f_fsdata
operator|)
operator|->
name|nf_sectorsize
decl_stmt|;
name|u_int
name|off
decl_stmt|,
name|nsec
decl_stmt|;
name|off
operator|=
name|pos
operator|%
name|bsize
expr_stmt|;
name|pos
operator|/=
name|bsize
expr_stmt|;
name|nsec
operator|=
operator|(
name|length
operator|+
operator|(
name|bsize
operator|-
literal|1
operator|)
operator|)
operator|/
name|bsize
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"pos=%lld length=%d off=%d nsec=%d\n"
argument_list|,
name|pos
argument_list|,
name|length
argument_list|,
name|off
argument_list|,
name|nsec
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|malloc
argument_list|(
name|nsec
operator|*
name|bsize
argument_list|)
expr_stmt|;
name|err
operator|=
call|(
name|f
operator|->
name|f_dev
operator|->
name|dv_strategy
call|)
argument_list|(
name|f
operator|->
name|f_devdata
argument_list|,
name|F_READ
argument_list|,
name|pos
argument_list|,
name|nsec
operator|*
name|bsize
argument_list|,
name|buffer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|buffer
operator|+
name|off
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandfs_probe_sectorsize
parameter_list|(
name|struct
name|open_file
modifier|*
name|f
parameter_list|)
block|{
name|void
modifier|*
name|buffer
decl_stmt|;
name|int
name|i
decl_stmt|,
name|err
decl_stmt|;
name|buffer
operator|=
name|malloc
argument_list|(
literal|16
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"probing for sector size: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|512
init|;
name|i
operator|<
operator|(
literal|16
operator|*
literal|1024
operator|)
condition|;
name|i
operator|<<=
literal|1
control|)
block|{
name|NANDFS_DEBUG
argument_list|(
literal|"%d "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|err
operator|=
call|(
name|f
operator|->
name|f_dev
operator|->
name|dv_strategy
call|)
argument_list|(
name|f
operator|->
name|f_devdata
argument_list|,
name|F_READ
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
name|buffer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
block|{
name|NANDFS_DEBUG
argument_list|(
literal|"found"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
block|}
name|free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|NANDFS_DEBUG
argument_list|(
literal|"not found\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

end_unit


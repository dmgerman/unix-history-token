begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2003 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of KTH nor the names of its contributors may be  *    used to endorse or promote products derived from this software without  *    specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY KTH AND ITS CONTRIBUTORS ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL KTH OR ITS CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"krb5_locl.h"
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_function
specifier|static
name|int
name|check_config_file
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|char
modifier|*
name|filelist
parameter_list|,
name|char
modifier|*
modifier|*
name|res
parameter_list|,
name|int
name|def
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|char
modifier|*
modifier|*
name|pp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|pp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|def
condition|)
name|ret
operator|=
name|krb5_prepend_config_files_default
argument_list|(
name|filelist
argument_list|,
operator|&
name|pp
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|krb5_prepend_config_files
argument_list|(
name|filelist
argument_list|,
name|NULL
argument_list|,
operator|&
name|pp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"prepend_config_files"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|res
index|[
name|i
index|]
operator|&&
name|pp
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|pp
index|[
name|i
index|]
argument_list|,
name|res
index|[
name|i
index|]
argument_list|)
operator|!=
literal|0
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"'%s' != '%s'"
argument_list|,
name|pp
index|[
name|i
index|]
argument_list|,
name|res
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"pp ended before res list"
argument_list|)
expr_stmt|;
if|if
condition|(
name|def
condition|)
block|{
name|char
modifier|*
modifier|*
name|deflist
decl_stmt|;
name|int
name|j
decl_stmt|;
name|ret
operator|=
name|krb5_get_default_config_files
argument_list|(
operator|&
name|deflist
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"get_default_config_files"
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|pp
index|[
name|i
index|]
operator|&&
name|deflist
index|[
name|j
index|]
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|pp
index|[
name|i
index|]
argument_list|,
name|deflist
index|[
name|j
index|]
argument_list|)
operator|!=
literal|0
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"'%s' != '%s'"
argument_list|,
name|pp
index|[
name|i
index|]
argument_list|,
name|deflist
index|[
name|j
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|deflist
index|[
name|j
index|]
operator|!=
name|NULL
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"pp ended before def list"
argument_list|)
expr_stmt|;
name|krb5_free_config_files
argument_list|(
name|deflist
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pp
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"pp ended after res (and def) list"
argument_list|)
expr_stmt|;
name|krb5_free_config_files
argument_list|(
name|pp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
name|char
modifier|*
name|list0
index|[]
init|=
block|{
literal|"/tmp/foo"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|list1
index|[]
init|=
block|{
literal|"/tmp/foo"
block|,
literal|"/tmp/foo/bar"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|list2
index|[]
init|=
block|{
literal|""
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
block|{
name|char
modifier|*
name|fl
decl_stmt|;
name|char
modifier|*
modifier|*
name|res
decl_stmt|;
block|}
name|test
index|[]
init|=
block|{
block|{
literal|"/tmp/foo"
block|,
name|NULL
block|}
block|,
block|{
literal|"/tmp/foo"
name|PATH_SEP
literal|"/tmp/foo/bar"
block|,
name|NULL
block|}
block|,
block|{
literal|""
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|check_config_files
parameter_list|(
name|void
parameter_list|)
block|{
name|krb5_context
name|context
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_init_context %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|test
index|[
literal|0
index|]
operator|.
name|res
operator|=
name|list0
expr_stmt|;
name|test
index|[
literal|1
index|]
operator|.
name|res
operator|=
name|list1
expr_stmt|;
name|test
index|[
literal|2
index|]
operator|.
name|res
operator|=
name|list2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|test
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|test
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|check_config_file
argument_list|(
name|context
argument_list|,
name|test
index|[
name|i
index|]
operator|.
name|fl
argument_list|,
name|test
index|[
name|i
index|]
operator|.
name|res
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|check_config_file
argument_list|(
name|context
argument_list|,
name|test
index|[
name|i
index|]
operator|.
name|fl
argument_list|,
name|test
index|[
name|i
index|]
operator|.
name|res
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|krb5_free_context
argument_list|(
name|context
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result0
index|[]
init|=
block|{
literal|"A"
block|,
literal|"B"
block|,
literal|"C"
block|,
literal|"D"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result1
index|[]
init|=
block|{
literal|"A"
block|,
literal|"B"
block|,
literal|"C D"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result2
index|[]
init|=
block|{
literal|"A"
block|,
literal|"B"
block|,
literal|""
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result3
index|[]
init|=
block|{
literal|"A B;C: D"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result4
index|[]
init|=
block|{
literal|"\"\""
block|,
literal|""
block|,
literal|"\"\""
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result5
index|[]
init|=
block|{
literal|"A\"BQd"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result6
index|[]
init|=
block|{
literal|"efgh\""
block|,
literal|"ABC"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result7
index|[]
init|=
block|{
literal|"SnapeKills\\"
block|,
literal|"Dumbledore"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result8
index|[]
init|=
block|{
literal|"\"TownOf Sandwich: Massachusetts\"Oldest"
block|,
literal|"Town"
block|,
literal|"In"
block|,
literal|"Cape Cod"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result9
index|[]
init|=
block|{
literal|"\"Begins and\"ends"
block|,
literal|"In"
block|,
literal|"One"
block|,
literal|"String"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|config_string_result10
index|[]
init|=
block|{
literal|"Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:"
block|,
literal|"1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer."
block|,
literal|"2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution."
block|,
literal|"3. Neither the name of the Institute nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission."
block|,
literal|"THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE."
block|,
literal|"Why do we test with such long strings? Because some people have config files"
block|,
literal|"That"
block|,
literal|"look"
block|,
literal|"Like this."
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_struct
specifier|const
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|expected
decl_stmt|;
block|}
name|config_strings_tests
index|[]
init|=
block|{
block|{
literal|"foo"
block|,
name|config_string_result0
block|}
block|,
block|{
literal|"bar"
block|,
name|config_string_result1
block|}
block|,
block|{
literal|"baz"
block|,
name|config_string_result2
block|}
block|,
block|{
literal|"quux"
block|,
name|config_string_result3
block|}
block|,
block|{
literal|"questionable"
block|,
name|config_string_result4
block|}
block|,
block|{
literal|"mismatch1"
block|,
name|config_string_result5
block|}
block|,
block|{
literal|"mismatch2"
block|,
name|config_string_result6
block|}
block|,
block|{
literal|"internal1"
block|,
name|config_string_result7
block|}
block|,
block|{
literal|"internal2"
block|,
name|config_string_result8
block|}
block|,
block|{
literal|"internal3"
block|,
name|config_string_result9
block|}
block|,
block|{
literal|"longer_strings"
block|,
name|config_string_result10
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|check_escaped_strings
parameter_list|(
name|void
parameter_list|)
block|{
name|krb5_context
name|context
decl_stmt|;
name|krb5_config_section
modifier|*
name|c
init|=
name|NULL
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_init_context %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_config_parse_file
argument_list|(
name|context
argument_list|,
literal|"test_config_strings.out"
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"krb5_config_parse_file()"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|config_strings_tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|config_strings_tests
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
modifier|*
name|ps
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|s
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|e
decl_stmt|;
name|ps
operator|=
name|krb5_config_get_strings
argument_list|(
name|context
argument_list|,
name|c
argument_list|,
literal|"escapes"
argument_list|,
name|config_strings_tests
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Failed to read string value %s"
argument_list|,
name|config_strings_tests
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|e
operator|=
name|config_strings_tests
index|[
name|i
index|]
operator|.
name|expected
expr_stmt|;
for|for
control|(
name|s
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|ps
init|;
operator|*
name|s
operator|&&
operator|*
name|e
condition|;
name|s
operator|++
operator|,
name|e
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|s
argument_list|,
operator|*
name|e
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Unexpected configuration string at value [%s].\n"
literal|"Actual=[%s]\n"
literal|"Expected=[%s]\n"
argument_list|,
name|config_strings_tests
index|[
name|i
index|]
operator|.
name|name
argument_list|,
operator|*
name|s
argument_list|,
operator|*
name|e
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|s
operator|||
operator|*
name|e
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Configuation string list for value [%s] has incorrect length."
argument_list|,
name|config_strings_tests
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|krb5_config_free_strings
argument_list|(
name|ps
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|krb5_config_file_free
argument_list|(
name|context
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"krb5_config_file_free()"
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|context
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|check_config_files
argument_list|()
expr_stmt|;
name|check_escaped_strings
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


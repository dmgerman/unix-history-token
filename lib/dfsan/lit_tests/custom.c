begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// RUN: %clang_dfsan -m64 %s -o %t&& %t
end_comment

begin_comment
comment|// RUN: %clang_dfsan -mllvm -dfsan-args-abi -m64 %s -o %t&& %t
end_comment

begin_comment
comment|// Tests custom implementations of various libc functions.
end_comment

begin_define
define|#
directive|define
name|_GNU_SOURCE
end_define

begin_include
include|#
directive|include
file|<sanitizer/dfsan_interface.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<link.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_function
name|void
modifier|*
name|ptcb
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|assert
argument_list|(
name|p
operator|==
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
operator|(
name|uintptr_t
operator|)
name|p
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|void
operator|*
operator|)
literal|2
return|;
block|}
end_function

begin_function
name|int
name|dlcb
parameter_list|(
name|struct
name|dl_phdr_info
modifier|*
name|info
parameter_list|,
name|size_t
name|size
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|assert
argument_list|(
name|data
operator|==
operator|(
name|void
operator|*
operator|)
literal|3
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
operator|(
name|uintptr_t
operator|)
name|info
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|size
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
operator|(
name|uintptr_t
operator|)
name|data
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
init|=
literal|1
decl_stmt|;
name|dfsan_label
name|i_label
init|=
name|dfsan_create_label
argument_list|(
literal|"i"
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|dfsan_set_label
argument_list|(
name|i_label
argument_list|,
operator|&
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|j
init|=
literal|2
decl_stmt|;
name|dfsan_label
name|j_label
init|=
name|dfsan_create_label
argument_list|(
literal|"j"
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|dfsan_set_label
argument_list|(
name|j_label
argument_list|,
operator|&
name|j
argument_list|,
sizeof|sizeof
argument_list|(
name|j
argument_list|)
argument_list|)
expr_stmt|;
name|struct
name|stat
name|s
decl_stmt|;
name|s
operator|.
name|st_dev
operator|=
name|i
expr_stmt|;
name|int
name|rv
init|=
name|stat
argument_list|(
literal|"/"
argument_list|,
operator|&
name|s
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|rv
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|s
operator|.
name|st_dev
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|s
operator|.
name|st_dev
operator|=
name|i
expr_stmt|;
name|rv
operator|=
name|stat
argument_list|(
literal|"/nonexistent"
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rv
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|s
operator|.
name|st_dev
argument_list|)
operator|==
name|i_label
argument_list|)
expr_stmt|;
name|int
name|fd
init|=
name|open
argument_list|(
literal|"/dev/zero"
argument_list|,
name|O_RDONLY
argument_list|)
decl_stmt|;
name|s
operator|.
name|st_dev
operator|=
name|i
expr_stmt|;
name|rv
operator|=
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rv
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|s
operator|.
name|st_dev
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|char
name|str1
index|[]
init|=
literal|"str1"
decl_stmt|,
name|str2
index|[]
init|=
literal|"str2"
decl_stmt|;
name|dfsan_set_label
argument_list|(
name|i_label
argument_list|,
operator|&
name|str1
index|[
literal|3
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dfsan_set_label
argument_list|(
name|j_label
argument_list|,
operator|&
name|str2
index|[
literal|3
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rv
operator|=
name|memcmp
argument_list|(
name|str1
argument_list|,
name|str2
argument_list|,
sizeof|sizeof
argument_list|(
name|str1
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rv
operator|<
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|rv
argument_list|)
operator|==
name|dfsan_union
argument_list|(
name|i_label
argument_list|,
name|j_label
argument_list|)
argument_list|)
expr_stmt|;
name|char
name|strc
index|[
sizeof|sizeof
argument_list|(
name|str1
argument_list|)
index|]
decl_stmt|;
name|memcpy
argument_list|(
name|strc
argument_list|,
name|str1
argument_list|,
sizeof|sizeof
argument_list|(
name|str1
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|strc
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|strc
index|[
literal|3
index|]
argument_list|)
operator|==
name|i_label
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|strc
argument_list|,
name|j
argument_list|,
sizeof|sizeof
argument_list|(
name|strc
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|strc
index|[
literal|0
index|]
argument_list|)
operator|==
name|j_label
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|strc
index|[
literal|1
index|]
argument_list|)
operator|==
name|j_label
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|strc
index|[
literal|2
index|]
argument_list|)
operator|==
name|j_label
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|strc
index|[
literal|3
index|]
argument_list|)
operator|==
name|j_label
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|strc
index|[
literal|4
index|]
argument_list|)
operator|==
name|j_label
argument_list|)
expr_stmt|;
name|rv
operator|=
name|strcmp
argument_list|(
name|str1
argument_list|,
name|str2
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rv
operator|<
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|rv
argument_list|)
operator|==
name|dfsan_union
argument_list|(
name|i_label
argument_list|,
name|j_label
argument_list|)
argument_list|)
expr_stmt|;
name|char
modifier|*
name|strd
init|=
name|strdup
argument_list|(
name|str1
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|strd
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|strd
index|[
literal|3
index|]
argument_list|)
operator|==
name|i_label
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|strd
argument_list|)
expr_stmt|;
name|rv
operator|=
name|strncmp
argument_list|(
name|str1
argument_list|,
name|str2
argument_list|,
sizeof|sizeof
argument_list|(
name|str1
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rv
operator|<
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|rv
argument_list|)
operator|==
name|dfsan_union
argument_list|(
name|i_label
argument_list|,
name|j_label
argument_list|)
argument_list|)
expr_stmt|;
name|rv
operator|=
name|strncmp
argument_list|(
name|str1
argument_list|,
name|str2
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rv
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|rv
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|str1
index|[
literal|0
index|]
operator|=
literal|'S'
expr_stmt|;
name|rv
operator|=
name|strncasecmp
argument_list|(
name|str1
argument_list|,
name|str2
argument_list|,
sizeof|sizeof
argument_list|(
name|str1
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rv
operator|<
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|rv
argument_list|)
operator|==
name|dfsan_union
argument_list|(
name|i_label
argument_list|,
name|j_label
argument_list|)
argument_list|)
expr_stmt|;
name|rv
operator|=
name|strncasecmp
argument_list|(
name|str1
argument_list|,
name|str2
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rv
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|rv
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|char
modifier|*
name|crv
init|=
name|strchr
argument_list|(
name|str1
argument_list|,
literal|'r'
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|crv
operator|==
operator|&
name|str1
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
operator|(
name|uintptr_t
operator|)
name|crv
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|crv
operator|=
name|strchr
argument_list|(
name|str1
argument_list|,
literal|'1'
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|crv
operator|==
operator|&
name|str1
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
operator|(
name|uintptr_t
operator|)
name|crv
argument_list|)
operator|==
name|i_label
argument_list|)
expr_stmt|;
name|crv
operator|=
name|strchr
argument_list|(
name|str1
argument_list|,
literal|'x'
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|crv
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
operator|(
name|uintptr_t
operator|)
name|crv
argument_list|)
operator|==
name|i_label
argument_list|)
expr_stmt|;
comment|// With any luck this sequence of calls will cause calloc to return the same
comment|// pointer both times.  This is probably the best we can do to test this
comment|// function.
name|crv
operator|=
name|calloc
argument_list|(
literal|4096
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|crv
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|crv
argument_list|)
expr_stmt|;
name|crv
operator|=
name|calloc
argument_list|(
literal|4096
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|crv
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|crv
argument_list|)
expr_stmt|;
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|i
expr_stmt|;
name|buf
index|[
literal|15
index|]
operator|=
name|j
expr_stmt|;
name|rv
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rv
operator|==
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|buf
index|[
literal|15
index|]
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
literal|"/bin/sh"
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|i
expr_stmt|;
name|buf
index|[
literal|15
index|]
operator|=
name|j
expr_stmt|;
name|rv
operator|=
name|pread
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rv
operator|==
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dfsan_get_label
argument_list|(
name|buf
index|[
literal|15
index|]
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|pthread_t
name|pt
decl_stmt|;
name|pthread_create
argument_list|(
operator|&
name|pt
argument_list|,
literal|0
argument_list|,
name|ptcb
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|)
expr_stmt|;
name|void
modifier|*
name|cbrv
decl_stmt|;
name|pthread_join
argument_list|(
name|pt
argument_list|,
operator|&
name|cbrv
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|cbrv
operator|==
operator|(
name|void
operator|*
operator|)
literal|2
argument_list|)
expr_stmt|;
name|dl_iterate_phdr
argument_list|(
name|dlcb
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|3
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


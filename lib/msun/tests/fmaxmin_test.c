begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2008 David Schultz<das@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Tests for fmax{,f,l}() and fmin{,f,l}.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<fenv.h>
end_include

begin_include
include|#
directive|include
file|<float.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"test-utils.h"
end_include

begin_pragma
pragma|#
directive|pragma
name|STDC
name|FENV_ACCESS
name|ON
end_pragma

begin_comment
comment|/*  * Test whether func(x, y) has the expected result, and make sure no  * exceptions are raised.  */
end_comment

begin_define
define|#
directive|define
name|TEST
parameter_list|(
name|func
parameter_list|,
name|type
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|,
name|expected
parameter_list|)
value|do {				      \ 	type __x = (x);
comment|/* convert before we clear exceptions */
value|\ 	type __y = (y);							      \ 	feclearexcept(ALL_STD_EXCEPT);					      \ 	long double __result = func((__x), (__y));			      \ 	if (fetestexcept(ALL_STD_EXCEPT)) {				      \ 		fprintf(stderr, #func "(%.20Lg, %.20Lg) raised 0x%x\n",	      \ 			(x), (y), fetestexcept(FE_ALL_EXCEPT));		      \ 		ok = 0;							      \ 	}								      \ 	if (!fpequal(__result, (expected)))	{			      \ 		fprintf(stderr, #func "(%.20Lg, %.20Lg) = %.20Lg, "	      \ 			"expected %.20Lg\n", (x), (y), __result, (expected)); \ 		ok = 0;							      \ 	}								      \ } while (0)
end_define

begin_function
name|int
name|testall_r
parameter_list|(
name|long
name|double
name|big
parameter_list|,
name|long
name|double
name|small
parameter_list|)
block|{
name|int
name|ok
decl_stmt|;
name|long
name|double
name|expected_max
init|=
name|isnan
argument_list|(
name|big
argument_list|)
condition|?
name|small
else|:
name|big
decl_stmt|;
name|long
name|double
name|expected_min
init|=
name|isnan
argument_list|(
name|small
argument_list|)
condition|?
name|big
else|:
name|small
decl_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
name|TEST
argument_list|(
name|fmaxf
argument_list|,
name|float
argument_list|,
name|big
argument_list|,
name|small
argument_list|,
name|expected_max
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
name|fmaxf
argument_list|,
name|float
argument_list|,
name|small
argument_list|,
name|big
argument_list|,
name|expected_max
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
name|fmax
argument_list|,
name|double
argument_list|,
name|big
argument_list|,
name|small
argument_list|,
name|expected_max
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
name|fmax
argument_list|,
name|double
argument_list|,
name|small
argument_list|,
name|big
argument_list|,
name|expected_max
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
argument|fmaxl
argument_list|,
argument|long double
argument_list|,
argument|big
argument_list|,
argument|small
argument_list|,
argument|expected_max
argument_list|)
empty_stmt|;
name|TEST
argument_list|(
argument|fmaxl
argument_list|,
argument|long double
argument_list|,
argument|small
argument_list|,
argument|big
argument_list|,
argument|expected_max
argument_list|)
empty_stmt|;
name|TEST
argument_list|(
name|fminf
argument_list|,
name|float
argument_list|,
name|big
argument_list|,
name|small
argument_list|,
name|expected_min
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
name|fminf
argument_list|,
name|float
argument_list|,
name|small
argument_list|,
name|big
argument_list|,
name|expected_min
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
name|fmin
argument_list|,
name|double
argument_list|,
name|big
argument_list|,
name|small
argument_list|,
name|expected_min
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
name|fmin
argument_list|,
name|double
argument_list|,
name|small
argument_list|,
name|big
argument_list|,
name|expected_min
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
argument|fminl
argument_list|,
argument|long double
argument_list|,
argument|big
argument_list|,
argument|small
argument_list|,
argument|expected_min
argument_list|)
empty_stmt|;
name|TEST
argument_list|(
argument|fminl
argument_list|,
argument|long double
argument_list|,
argument|small
argument_list|,
argument|big
argument_list|,
argument|expected_min
argument_list|)
empty_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|char
modifier|*
name|comment
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Test all the functions: fmaxf, fmax, fmaxl, fminf, fmin, and fminl,  * in all rounding modes and with the arguments in different orders.  * The input 'big' must be>= 'small'.  */
end_comment

begin_function
name|void
name|testall
parameter_list|(
name|int
name|testnum
parameter_list|,
name|long
name|double
name|big
parameter_list|,
name|long
name|double
name|small
parameter_list|)
block|{
specifier|static
specifier|const
name|int
name|rmodes
index|[]
init|=
block|{
name|FE_TONEAREST
block|,
name|FE_UPWARD
block|,
name|FE_DOWNWARD
block|,
name|FE_TOWARDZERO
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|fesetround
argument_list|(
name|rmodes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|testall_r
argument_list|(
name|big
argument_list|,
name|small
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILURE in rounding mode %d\n"
argument_list|,
name|rmodes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|printf
argument_list|(
literal|"%sok %d - big = %.20Lg, small = %.20Lg%s\n"
argument_list|,
operator|(
name|i
operator|==
literal|4
operator|)
condition|?
literal|""
else|:
literal|"not "
argument_list|,
name|testnum
argument_list|,
name|big
argument_list|,
name|small
argument_list|,
name|comment
operator|==
name|NULL
condition|?
literal|""
else|:
name|comment
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Clang 3.8.0+ fails the invariants for testcase 6, 7, 10, and 11. */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__clang__
argument_list|)
operator|&&
expr|\
operator|(
name|__clang_major__
operator|>=
literal|3
operator|&&
name|__clang_minor__
operator|>=
literal|8
operator|&&
name|__clang_patchlevel__
operator|>=
literal|0
operator|)
end_if

begin_define
define|#
directive|define
name|affected_by_bug_208703
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|printf
argument_list|(
literal|"1..12\n"
argument_list|)
expr_stmt|;
name|testall
argument_list|(
literal|1
argument_list|,
literal|1.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|testall
argument_list|(
literal|2
argument_list|,
literal|42.0
argument_list|,
name|nextafterf
argument_list|(
literal|42.0
argument_list|,
operator|-
name|INFINITY
argument_list|)
argument_list|)
expr_stmt|;
name|testall
argument_list|(
literal|3
argument_list|,
name|nextafterf
argument_list|(
literal|42.0
argument_list|,
name|INFINITY
argument_list|)
argument_list|,
literal|42.0
argument_list|)
expr_stmt|;
name|testall
argument_list|(
literal|4
argument_list|,
operator|-
literal|5.0
argument_list|,
operator|-
literal|5.0
argument_list|)
expr_stmt|;
name|testall
argument_list|(
literal|5
argument_list|,
operator|-
literal|3.0
argument_list|,
operator|-
literal|4.0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|affected_by_bug_208703
name|comment
operator|=
literal|"# TODO: testcase 6-7 fails invariant with clang 3.8+ (bug 208703)"
expr_stmt|;
endif|#
directive|endif
name|testall
argument_list|(
literal|6
argument_list|,
literal|1.0
argument_list|,
name|NAN
argument_list|)
expr_stmt|;
name|testall
argument_list|(
literal|7
argument_list|,
name|INFINITY
argument_list|,
name|NAN
argument_list|)
expr_stmt|;
name|comment
operator|=
name|NULL
expr_stmt|;
name|testall
argument_list|(
literal|8
argument_list|,
name|INFINITY
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|testall
argument_list|(
literal|9
argument_list|,
operator|-
literal|3.0
argument_list|,
operator|-
name|INFINITY
argument_list|)
expr_stmt|;
name|testall
argument_list|(
literal|10
argument_list|,
literal|3.0
argument_list|,
operator|-
name|INFINITY
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|affected_by_bug_208703
name|comment
operator|=
literal|"# TODO: testcase 11-12 fails invariant with clang 3.8+ (bug 208703)"
expr_stmt|;
endif|#
directive|endif
name|testall
argument_list|(
literal|11
argument_list|,
name|NAN
argument_list|,
name|NAN
argument_list|)
expr_stmt|;
comment|/* This test isn't strictly required to work by C99. */
name|testall
argument_list|(
literal|12
argument_list|,
literal|0.0
argument_list|,
operator|-
literal|0.0
argument_list|)
expr_stmt|;
name|comment
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


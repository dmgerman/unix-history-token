begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2005 Networks Associates Technology, Inc.  * All rights reserved.  *  * This software was developed for the FreeBSD Project by Network Associates  * Laboratories, the Security Research Division of Network Associates, Inc.  * under DARPA/SPAWAR contract N66001-01-C-8035 ("CBOSS"), as part of the  * DARPA CHATS research program.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/ucred.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<security/mac_bsdextended/mac_bsdextended.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"ugidfw.h"
end_include

begin_comment
comment|/*  * Text format for rules: rules contain subject and object elements, mode.  * The total form is "subject [s_element] object [o_element] mode [mode]".  * At least * one of a uid or gid entry must be present; both may also be  * present.  */
end_comment

begin_define
define|#
directive|define
name|MIB
value|"security.mac.bsdextended"
end_define

begin_function
name|int
name|bsde_rule_to_string
parameter_list|(
name|struct
name|mac_bsdextended_rule
modifier|*
name|rule
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|group
modifier|*
name|grp
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|struct
name|statfs
modifier|*
name|mntbuf
decl_stmt|;
name|char
modifier|*
name|cur
decl_stmt|,
name|type
index|[
sizeof|sizeof
argument_list|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_type
argument_list|)
operator|*
name|CHAR_BIT
operator|+
literal|1
index|]
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|;
name|int
name|anymode
decl_stmt|,
name|unknownmode
decl_stmt|,
name|truncated
decl_stmt|,
name|numfs
decl_stmt|,
name|i
decl_stmt|,
name|notdone
decl_stmt|;
name|cur
operator|=
name|buf
expr_stmt|;
name|left
operator|=
name|buflen
expr_stmt|;
name|truncated
operator|=
literal|0
expr_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"subject "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_flags
condition|)
block|{
if|if
condition|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_neg
operator|==
name|MBS_ALL_FLAGS
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"not "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
name|notdone
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|notdone
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_neg
operator|&
name|MBO_UID_DEFINED
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_flags
operator|&
name|MBO_UID_DEFINED
condition|)
block|{
name|pwd
operator|=
name|getpwuid
argument_list|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_uid_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|!=
name|NULL
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"uid %s"
argument_list|,
name|pwd
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"uid %u"
argument_list|,
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_uid_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_uid_min
operator|!=
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_uid_max
condition|)
block|{
name|pwd
operator|=
name|getpwuid
argument_list|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_uid_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|!=
name|NULL
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|":%s "
argument_list|,
name|pwd
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|":%u "
argument_list|,
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_uid_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_neg
operator|&
name|MBO_GID_DEFINED
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_flags
operator|&
name|MBO_GID_DEFINED
condition|)
block|{
name|grp
operator|=
name|getgrgid
argument_list|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_gid_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
operator|!=
name|NULL
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"gid %s"
argument_list|,
name|grp
operator|->
name|gr_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"gid %u"
argument_list|,
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_gid_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_gid_min
operator|!=
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_gid_max
condition|)
block|{
name|grp
operator|=
name|getgrgid
argument_list|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_gid_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
operator|!=
name|NULL
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|":%s "
argument_list|,
name|grp
operator|->
name|gr_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|":%u "
argument_list|,
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_gid_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_neg
operator|&
name|MBS_PRISON_DEFINED
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_flags
operator|&
name|MBS_PRISON_DEFINED
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"jailid %d "
argument_list|,
name|rule
operator|->
name|mbr_subject
operator|.
name|mbs_prison
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
block|}
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"object "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_flags
condition|)
block|{
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_neg
operator|==
name|MBO_ALL_FLAGS
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"not "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
name|notdone
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|notdone
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_neg
operator|&
name|MBO_UID_DEFINED
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_flags
operator|&
name|MBO_UID_DEFINED
condition|)
block|{
name|pwd
operator|=
name|getpwuid
argument_list|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_uid_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|!=
name|NULL
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"uid %s"
argument_list|,
name|pwd
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"uid %u"
argument_list|,
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_uid_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_uid_min
operator|!=
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_uid_max
condition|)
block|{
name|pwd
operator|=
name|getpwuid
argument_list|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_uid_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|!=
name|NULL
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|":%s "
argument_list|,
name|pwd
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|":%u "
argument_list|,
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_uid_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_neg
operator|&
name|MBO_GID_DEFINED
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_flags
operator|&
name|MBO_GID_DEFINED
condition|)
block|{
name|grp
operator|=
name|getgrgid
argument_list|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_gid_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
operator|!=
name|NULL
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"gid %s"
argument_list|,
name|grp
operator|->
name|gr_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"gid %u"
argument_list|,
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_gid_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_gid_min
operator|!=
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_gid_max
condition|)
block|{
name|grp
operator|=
name|getgrgid
argument_list|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_gid_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
operator|!=
name|NULL
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|":%s "
argument_list|,
name|grp
operator|->
name|gr_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|":%u "
argument_list|,
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_gid_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_neg
operator|&
name|MBO_FSID_DEFINED
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_flags
operator|&
name|MBO_FSID_DEFINED
condition|)
block|{
name|numfs
operator|=
name|getmntinfo
argument_list|(
operator|&
name|mntbuf
argument_list|,
name|MNT_NOWAIT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numfs
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|memcmp
argument_list|(
operator|&
operator|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_fsid
operator|)
argument_list|,
operator|&
operator|(
name|mntbuf
index|[
name|i
index|]
operator|.
name|f_fsid
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|mntbuf
index|[
name|i
index|]
operator|.
name|f_fsid
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"filesys %s "
argument_list|,
name|i
operator|==
name|numfs
condition|?
literal|"???"
else|:
name|mntbuf
index|[
name|i
index|]
operator|.
name|f_mntonname
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_neg
operator|&
name|MBO_SUID
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_flags
operator|&
name|MBO_SUID
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"suid "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_neg
operator|&
name|MBO_SGID
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_flags
operator|&
name|MBO_SGID
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"sgid "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_neg
operator|&
name|MBO_UID_SUBJECT
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_flags
operator|&
name|MBO_UID_SUBJECT
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"uid_of_subject "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_neg
operator|&
name|MBO_GID_SUBJECT
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_flags
operator|&
name|MBO_GID_SUBJECT
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"gid_of_subject "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|notdone
operator|&&
operator|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_neg
operator|&
name|MBO_TYPE_DEFINED
operator|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"! "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_flags
operator|&
name|MBO_TYPE_DEFINED
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_type
operator|&
name|MBO_TYPE_REG
condition|)
name|type
index|[
name|i
operator|++
index|]
operator|=
literal|'r'
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_type
operator|&
name|MBO_TYPE_DIR
condition|)
name|type
index|[
name|i
operator|++
index|]
operator|=
literal|'d'
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_type
operator|&
name|MBO_TYPE_BLK
condition|)
name|type
index|[
name|i
operator|++
index|]
operator|=
literal|'b'
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_type
operator|&
name|MBO_TYPE_CHR
condition|)
name|type
index|[
name|i
operator|++
index|]
operator|=
literal|'c'
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_type
operator|&
name|MBO_TYPE_LNK
condition|)
name|type
index|[
name|i
operator|++
index|]
operator|=
literal|'l'
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_type
operator|&
name|MBO_TYPE_SOCK
condition|)
name|type
index|[
name|i
operator|++
index|]
operator|=
literal|'s'
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_type
operator|&
name|MBO_TYPE_FIFO
condition|)
name|type
index|[
name|i
operator|++
index|]
operator|=
literal|'p'
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_object
operator|.
name|mbo_type
operator|==
name|MBO_ALL_TYPE
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
name|type
index|[
name|i
operator|++
index|]
operator|=
literal|'a'
expr_stmt|;
block|}
name|type
index|[
name|i
operator|++
index|]
operator|=
literal|'\0'
expr_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"type %s "
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
block|}
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"mode "
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
name|anymode
operator|=
operator|(
name|rule
operator|->
name|mbr_mode
operator|&
name|MBI_ALLPERM
operator|)
expr_stmt|;
name|unknownmode
operator|=
operator|(
name|rule
operator|->
name|mbr_mode
operator|&
operator|~
name|MBI_ALLPERM
operator|)
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|mbr_mode
operator|&
name|MBI_ADMIN
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_mode
operator|&
name|MBI_READ
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_mode
operator|&
name|MBI_STAT
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_mode
operator|&
name|MBI_WRITE
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|rule
operator|->
name|mbr_mode
operator|&
name|MBI_EXEC
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"x"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|anymode
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|unknownmode
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|cur
argument_list|,
name|left
argument_list|,
literal|"?"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
name|left
condition|)
goto|goto
name|truncated
goto|;
name|left
operator|-=
name|len
expr_stmt|;
name|cur
operator|+=
name|len
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|truncated
label|:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_parse_uidrange
parameter_list|(
name|char
modifier|*
name|spec
parameter_list|,
name|uid_t
modifier|*
name|min
parameter_list|,
name|uid_t
modifier|*
name|max
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|uid_t
name|uid1
decl_stmt|,
name|uid2
decl_stmt|;
name|char
modifier|*
name|spec1
decl_stmt|,
modifier|*
name|spec2
decl_stmt|,
modifier|*
name|endp
decl_stmt|;
name|unsigned
name|long
name|value
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|spec2
operator|=
name|spec
expr_stmt|;
name|spec1
operator|=
name|strsep
argument_list|(
operator|&
name|spec2
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|pwd
operator|=
name|getpwnam
argument_list|(
name|spec1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|!=
name|NULL
condition|)
name|uid1
operator|=
name|pwd
operator|->
name|pw_uid
expr_stmt|;
else|else
block|{
name|value
operator|=
name|strtoul
argument_list|(
name|spec1
argument_list|,
operator|&
name|endp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"invalid uid: '%s'"
argument_list|,
name|spec1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|uid1
operator|=
name|value
expr_stmt|;
block|}
if|if
condition|(
name|spec2
operator|==
name|NULL
condition|)
block|{
operator|*
name|max
operator|=
operator|*
name|min
operator|=
name|uid1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|pwd
operator|=
name|getpwnam
argument_list|(
name|spec2
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|!=
name|NULL
condition|)
name|uid2
operator|=
name|pwd
operator|->
name|pw_uid
expr_stmt|;
else|else
block|{
name|value
operator|=
name|strtoul
argument_list|(
name|spec2
argument_list|,
operator|&
name|endp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"invalid uid: '%s'"
argument_list|,
name|spec2
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|uid2
operator|=
name|value
expr_stmt|;
block|}
operator|*
name|min
operator|=
name|uid1
expr_stmt|;
operator|*
name|max
operator|=
name|uid2
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_parse_gidrange
parameter_list|(
name|char
modifier|*
name|spec
parameter_list|,
name|gid_t
modifier|*
name|min
parameter_list|,
name|gid_t
modifier|*
name|max
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|struct
name|group
modifier|*
name|grp
decl_stmt|;
name|gid_t
name|gid1
decl_stmt|,
name|gid2
decl_stmt|;
name|char
modifier|*
name|spec1
decl_stmt|,
modifier|*
name|spec2
decl_stmt|,
modifier|*
name|endp
decl_stmt|;
name|unsigned
name|long
name|value
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|spec2
operator|=
name|spec
expr_stmt|;
name|spec1
operator|=
name|strsep
argument_list|(
operator|&
name|spec2
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|grp
operator|=
name|getgrnam
argument_list|(
name|spec1
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
operator|!=
name|NULL
condition|)
name|gid1
operator|=
name|grp
operator|->
name|gr_gid
expr_stmt|;
else|else
block|{
name|value
operator|=
name|strtoul
argument_list|(
name|spec1
argument_list|,
operator|&
name|endp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"invalid gid: '%s'"
argument_list|,
name|spec1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|gid1
operator|=
name|value
expr_stmt|;
block|}
if|if
condition|(
name|spec2
operator|==
name|NULL
condition|)
block|{
operator|*
name|max
operator|=
operator|*
name|min
operator|=
name|gid1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|grp
operator|=
name|getgrnam
argument_list|(
name|spec2
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
operator|!=
name|NULL
condition|)
name|gid2
operator|=
name|grp
operator|->
name|gr_gid
expr_stmt|;
else|else
block|{
name|value
operator|=
name|strtoul
argument_list|(
name|spec2
argument_list|,
operator|&
name|endp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"invalid gid: '%s'"
argument_list|,
name|spec2
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|gid2
operator|=
name|value
expr_stmt|;
block|}
operator|*
name|min
operator|=
name|gid1
expr_stmt|;
operator|*
name|max
operator|=
name|gid2
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_parse_subject
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|struct
name|mac_bsdextended_subject
modifier|*
name|subject
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|int
name|not_seen
decl_stmt|,
name|flags
decl_stmt|;
name|int
name|current
decl_stmt|,
name|neg
decl_stmt|,
name|nextnot
decl_stmt|;
name|char
modifier|*
name|endp
decl_stmt|;
name|uid_t
name|uid_min
decl_stmt|,
name|uid_max
decl_stmt|;
name|gid_t
name|gid_min
decl_stmt|,
name|gid_max
decl_stmt|;
name|int
name|jid
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|long
name|value
decl_stmt|;
name|current
operator|=
literal|0
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
name|neg
operator|=
literal|0
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"not"
argument_list|,
name|argv
index|[
name|current
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|not_seen
operator|=
literal|1
expr_stmt|;
name|current
operator|++
expr_stmt|;
block|}
else|else
name|not_seen
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|current
operator|<
name|argc
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"uid"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|current
operator|+
literal|2
operator|>
name|argc
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"uid short"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBS_UID_DEFINED
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"one uid only"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|bsde_parse_uidrange
argument_list|(
name|argv
index|[
name|current
operator|+
literal|1
index|]
argument_list|,
operator|&
name|uid_min
argument_list|,
operator|&
name|uid_max
argument_list|,
name|buflen
argument_list|,
name|errstr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|flags
operator||=
name|MBS_UID_DEFINED
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBS_UID_DEFINED
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"gid"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|current
operator|+
literal|2
operator|>
name|argc
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"gid short"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBS_GID_DEFINED
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"one gid only"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|bsde_parse_gidrange
argument_list|(
name|argv
index|[
name|current
operator|+
literal|1
index|]
argument_list|,
operator|&
name|gid_min
argument_list|,
operator|&
name|gid_max
argument_list|,
name|buflen
argument_list|,
name|errstr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|flags
operator||=
name|MBS_GID_DEFINED
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBS_GID_DEFINED
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"jailid"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|current
operator|+
literal|2
operator|>
name|argc
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"prison short"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBS_PRISON_DEFINED
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"one jail only"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|value
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|current
operator|+
literal|1
index|]
argument_list|,
operator|&
name|endp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"invalid jid: '%s'"
argument_list|,
name|argv
index|[
name|current
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|jid
operator|=
name|value
expr_stmt|;
name|flags
operator||=
name|MBS_PRISON_DEFINED
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBS_PRISON_DEFINED
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"!"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|nextnot
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"double negative"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|nextnot
operator|=
literal|1
expr_stmt|;
name|current
operator|+=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"'%s' not expected"
argument_list|,
name|argv
index|[
name|current
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|subject
operator|->
name|mbs_flags
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|not_seen
condition|)
name|subject
operator|->
name|mbs_neg
operator|=
name|MBS_ALL_FLAGS
operator|^
name|neg
expr_stmt|;
else|else
name|subject
operator|->
name|mbs_neg
operator|=
name|neg
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|MBS_UID_DEFINED
condition|)
block|{
name|subject
operator|->
name|mbs_uid_min
operator|=
name|uid_min
expr_stmt|;
name|subject
operator|->
name|mbs_uid_max
operator|=
name|uid_max
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBS_GID_DEFINED
condition|)
block|{
name|subject
operator|->
name|mbs_gid_min
operator|=
name|gid_min
expr_stmt|;
name|subject
operator|->
name|mbs_gid_max
operator|=
name|gid_max
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBS_PRISON_DEFINED
condition|)
name|subject
operator|->
name|mbs_prison
operator|=
name|jid
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_parse_type
parameter_list|(
name|char
modifier|*
name|spec
parameter_list|,
name|int
modifier|*
name|type
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|*
name|type
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|spec
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|spec
index|[
name|i
index|]
condition|)
block|{
case|case
literal|'r'
case|:
case|case
literal|'-'
case|:
operator|*
name|type
operator||=
name|MBO_TYPE_REG
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
operator|*
name|type
operator||=
name|MBO_TYPE_DIR
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
operator|*
name|type
operator||=
name|MBO_TYPE_BLK
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
operator|*
name|type
operator||=
name|MBO_TYPE_CHR
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
operator|*
name|type
operator||=
name|MBO_TYPE_LNK
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
operator|*
name|type
operator||=
name|MBO_TYPE_SOCK
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
operator|*
name|type
operator||=
name|MBO_TYPE_FIFO
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
operator|*
name|type
operator||=
name|MBO_ALL_TYPE
expr_stmt|;
break|break;
default|default:
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"Unknown type code: %c"
argument_list|,
name|spec
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_parse_fsid
parameter_list|(
name|char
modifier|*
name|spec
parameter_list|,
name|struct
name|fsid
modifier|*
name|fsid
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|struct
name|statfs
name|buf
decl_stmt|;
if|if
condition|(
name|statfs
argument_list|(
name|spec
argument_list|,
operator|&
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"Unable to get id for %s: %s"
argument_list|,
name|spec
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
name|fsid
operator|=
name|buf
operator|.
name|f_fsid
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_parse_object
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|struct
name|mac_bsdextended_object
modifier|*
name|object
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|int
name|not_seen
decl_stmt|,
name|flags
decl_stmt|;
name|int
name|current
decl_stmt|,
name|neg
decl_stmt|,
name|nextnot
decl_stmt|;
name|uid_t
name|uid_min
decl_stmt|,
name|uid_max
decl_stmt|;
name|gid_t
name|gid_min
decl_stmt|,
name|gid_max
decl_stmt|;
name|int
name|type
decl_stmt|;
name|struct
name|fsid
name|fsid
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|current
operator|=
literal|0
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
name|neg
operator|=
literal|0
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"not"
argument_list|,
name|argv
index|[
name|current
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|not_seen
operator|=
literal|1
expr_stmt|;
name|current
operator|++
expr_stmt|;
block|}
else|else
name|not_seen
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|current
operator|<
name|argc
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"uid"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|current
operator|+
literal|2
operator|>
name|argc
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"uid short"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBO_UID_DEFINED
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"one uid only"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|bsde_parse_uidrange
argument_list|(
name|argv
index|[
name|current
operator|+
literal|1
index|]
argument_list|,
operator|&
name|uid_min
argument_list|,
operator|&
name|uid_max
argument_list|,
name|buflen
argument_list|,
name|errstr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|flags
operator||=
name|MBO_UID_DEFINED
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBO_UID_DEFINED
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"gid"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|current
operator|+
literal|2
operator|>
name|argc
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"gid short"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBO_GID_DEFINED
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"one gid only"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|bsde_parse_gidrange
argument_list|(
name|argv
index|[
name|current
operator|+
literal|1
index|]
argument_list|,
operator|&
name|gid_min
argument_list|,
operator|&
name|gid_max
argument_list|,
name|buflen
argument_list|,
name|errstr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|flags
operator||=
name|MBO_GID_DEFINED
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBO_GID_DEFINED
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"filesys"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|current
operator|+
literal|2
operator|>
name|argc
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"filesys short"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBO_FSID_DEFINED
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"one fsid only"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|bsde_parse_fsid
argument_list|(
name|argv
index|[
name|current
operator|+
literal|1
index|]
argument_list|,
operator|&
name|fsid
argument_list|,
name|buflen
argument_list|,
name|errstr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|flags
operator||=
name|MBO_FSID_DEFINED
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBO_FSID_DEFINED
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"suid"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|flags
operator||=
name|MBO_SUID
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBO_SUID
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"sgid"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|flags
operator||=
name|MBO_SGID
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBO_SGID
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"uid_of_subject"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|flags
operator||=
name|MBO_UID_SUBJECT
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBO_UID_SUBJECT
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"gid_of_subject"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|flags
operator||=
name|MBO_GID_SUBJECT
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBO_GID_SUBJECT
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"type"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|current
operator|+
literal|2
operator|>
name|argc
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"type short"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBO_TYPE_DEFINED
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"one type only"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|bsde_parse_type
argument_list|(
name|argv
index|[
name|current
operator|+
literal|1
index|]
argument_list|,
operator|&
name|type
argument_list|,
name|buflen
argument_list|,
name|errstr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|flags
operator||=
name|MBO_TYPE_DEFINED
expr_stmt|;
if|if
condition|(
name|nextnot
condition|)
block|{
name|neg
operator|^=
name|MBO_TYPE_DEFINED
expr_stmt|;
name|nextnot
operator|=
literal|0
expr_stmt|;
block|}
name|current
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|current
index|]
argument_list|,
literal|"!"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|nextnot
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"double negative'"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|nextnot
operator|=
literal|1
expr_stmt|;
name|current
operator|+=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"'%s' not expected"
argument_list|,
name|argv
index|[
name|current
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|object
operator|->
name|mbo_flags
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|not_seen
condition|)
name|object
operator|->
name|mbo_neg
operator|=
name|MBO_ALL_FLAGS
operator|^
name|neg
expr_stmt|;
else|else
name|object
operator|->
name|mbo_neg
operator|=
name|neg
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|MBO_UID_DEFINED
condition|)
block|{
name|object
operator|->
name|mbo_uid_min
operator|=
name|uid_min
expr_stmt|;
name|object
operator|->
name|mbo_uid_max
operator|=
name|uid_max
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBO_GID_DEFINED
condition|)
block|{
name|object
operator|->
name|mbo_gid_min
operator|=
name|gid_min
expr_stmt|;
name|object
operator|->
name|mbo_gid_max
operator|=
name|gid_max
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|MBO_FSID_DEFINED
condition|)
name|object
operator|->
name|mbo_fsid
operator|=
name|fsid
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|MBO_TYPE_DEFINED
condition|)
name|object
operator|->
name|mbo_type
operator|=
name|type
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_parse_mode
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|mode_t
modifier|*
name|mode
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"mode expects mode value"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|argc
operator|!=
literal|1
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"'%s' unexpected"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
name|mode
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|argv
index|[
literal|0
index|]
index|[
name|i
index|]
condition|)
block|{
case|case
literal|'a'
case|:
operator|*
name|mode
operator||=
name|MBI_ADMIN
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
operator|*
name|mode
operator||=
name|MBI_READ
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
operator|*
name|mode
operator||=
name|MBI_STAT
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
operator|*
name|mode
operator||=
name|MBI_WRITE
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
operator|*
name|mode
operator||=
name|MBI_EXEC
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* ignore */
break|break;
default|default:
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"Unknown mode letter: %c"
argument_list|,
name|argv
index|[
literal|0
index|]
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_parse_rule
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|struct
name|mac_bsdextended_rule
modifier|*
name|rule
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|int
name|subject
decl_stmt|,
name|subject_elements
decl_stmt|,
name|subject_elements_length
decl_stmt|;
name|int
name|object
decl_stmt|,
name|object_elements
decl_stmt|,
name|object_elements_length
decl_stmt|;
name|int
name|mode
decl_stmt|,
name|mode_elements
decl_stmt|,
name|mode_elements_length
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|bzero
argument_list|(
name|rule
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rule
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"Rule must begin with subject"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"subject"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"Rule must begin with subject"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|subject
operator|=
literal|0
expr_stmt|;
name|subject_elements
operator|=
literal|1
expr_stmt|;
comment|/* Search forward for object. */
name|object
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"object"
argument_list|)
operator|==
literal|0
condition|)
name|object
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|object
operator|==
operator|-
literal|1
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"Rule must contain an object"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Search forward for mode. */
name|mode
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|object
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"mode"
argument_list|)
operator|==
literal|0
condition|)
name|mode
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|mode
operator|==
operator|-
literal|1
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"Rule must contain mode"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|subject_elements_length
operator|=
name|object
operator|-
name|subject
operator|-
literal|1
expr_stmt|;
name|object_elements
operator|=
name|object
operator|+
literal|1
expr_stmt|;
name|object_elements_length
operator|=
name|mode
operator|-
name|object_elements
expr_stmt|;
name|mode_elements
operator|=
name|mode
operator|+
literal|1
expr_stmt|;
name|mode_elements_length
operator|=
name|argc
operator|-
name|mode_elements
expr_stmt|;
name|error
operator|=
name|bsde_parse_subject
argument_list|(
name|subject_elements_length
argument_list|,
name|argv
operator|+
name|subject_elements
argument_list|,
operator|&
name|rule
operator|->
name|mbr_subject
argument_list|,
name|buflen
argument_list|,
name|errstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|error
operator|=
name|bsde_parse_object
argument_list|(
name|object_elements_length
argument_list|,
name|argv
operator|+
name|object_elements
argument_list|,
operator|&
name|rule
operator|->
name|mbr_object
argument_list|,
name|buflen
argument_list|,
name|errstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|error
operator|=
name|bsde_parse_mode
argument_list|(
name|mode_elements_length
argument_list|,
name|argv
operator|+
name|mode_elements
argument_list|,
operator|&
name|rule
operator|->
name|mbr_mode
argument_list|,
name|buflen
argument_list|,
name|errstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_parse_rule_string
parameter_list|(
specifier|const
name|char
modifier|*
name|string
parameter_list|,
name|struct
name|mac_bsdextended_rule
modifier|*
name|rule
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|char
modifier|*
name|stringdup
decl_stmt|,
modifier|*
name|stringp
decl_stmt|,
modifier|*
name|argv
index|[
literal|100
index|]
decl_stmt|,
modifier|*
modifier|*
name|ap
decl_stmt|;
name|int
name|argc
decl_stmt|,
name|error
decl_stmt|;
name|stringp
operator|=
name|stringdup
operator|=
name|strdup
argument_list|(
name|string
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|stringp
operator|==
literal|' '
operator|||
operator|*
name|stringp
operator|==
literal|'\t'
condition|)
name|stringp
operator|++
expr_stmt|;
name|argc
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ap
operator|=
name|argv
init|;
operator|(
operator|*
name|ap
operator|=
name|strsep
argument_list|(
operator|&
name|stringp
argument_list|,
literal|" \t"
argument_list|)
operator|)
operator|!=
name|NULL
condition|;
control|)
block|{
name|argc
operator|++
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|ap
operator|!=
literal|'\0'
condition|)
if|if
condition|(
operator|++
name|ap
operator|>=
operator|&
name|argv
index|[
literal|100
index|]
condition|)
break|break;
block|}
name|error
operator|=
name|bsde_parse_rule
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|rule
argument_list|,
name|buflen
argument_list|,
name|errstr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|stringdup
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_get_mib
parameter_list|(
specifier|const
name|char
modifier|*
name|string
parameter_list|,
name|int
modifier|*
name|name
parameter_list|,
name|size_t
modifier|*
name|namelen
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|int
name|error
decl_stmt|;
name|len
operator|=
operator|*
name|namelen
expr_stmt|;
name|error
operator|=
name|sysctlnametomib
argument_list|(
name|string
argument_list|,
name|name
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
operator|*
name|namelen
operator|=
name|len
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_check_version
parameter_list|(
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|version
decl_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctlbyname
argument_list|(
name|MIB
literal|".rule_version"
argument_list|,
operator|&
name|version
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"version check failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|version
operator|!=
name|MB_VERSION
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"module v%d != library v%d"
argument_list|,
name|version
argument_list|,
name|MB_VERSION
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_get_rule_count
parameter_list|(
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|rule_count
decl_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|rule_count
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctlbyname
argument_list|(
name|MIB
literal|".rule_count"
argument_list|,
operator|&
name|rule_count
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|rule_count
argument_list|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"Data error in %s.rule_count"
argument_list|,
name|MIB
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|rule_count
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_get_rule_slots
parameter_list|(
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|rule_slots
decl_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|rule_slots
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctlbyname
argument_list|(
name|MIB
literal|".rule_slots"
argument_list|,
operator|&
name|rule_slots
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|rule_slots
argument_list|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"Data error in %s.rule_slots"
argument_list|,
name|MIB
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|rule_slots
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Returns 0 for success;  * Returns -1 for failure;  * Returns -2 for not present  */
end_comment

begin_function
name|int
name|bsde_get_rule
parameter_list|(
name|int
name|rulenum
parameter_list|,
name|struct
name|mac_bsdextended_rule
modifier|*
name|rule
parameter_list|,
name|size_t
name|errlen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|int
name|name
index|[
literal|10
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|bsde_check_version
argument_list|(
name|errlen
argument_list|,
name|errstr
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|len
operator|=
literal|10
expr_stmt|;
name|error
operator|=
name|bsde_get_mib
argument_list|(
name|MIB
literal|".rules"
argument_list|,
name|name
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|errlen
argument_list|,
literal|"%s: %s"
argument_list|,
name|MIB
literal|".rules"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|rule
argument_list|)
expr_stmt|;
name|name
index|[
name|len
index|]
operator|=
name|rulenum
expr_stmt|;
name|len
operator|++
expr_stmt|;
name|error
operator|=
name|sysctl
argument_list|(
name|name
argument_list|,
name|len
argument_list|,
name|rule
argument_list|,
operator|&
name|size
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
operator|&&
name|errno
operator|==
name|ENOENT
condition|)
return|return
operator|(
operator|-
literal|2
operator|)
return|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|errlen
argument_list|,
literal|"%s.%d: %s"
argument_list|,
name|MIB
literal|".rules"
argument_list|,
name|rulenum
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|size
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|rule
argument_list|)
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|errlen
argument_list|,
literal|"Data error in %s.%d: %s"
argument_list|,
name|MIB
literal|".rules"
argument_list|,
name|rulenum
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_delete_rule
parameter_list|(
name|int
name|rulenum
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|struct
name|mac_bsdextended_rule
name|rule
decl_stmt|;
name|int
name|name
index|[
literal|10
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|bsde_check_version
argument_list|(
name|buflen
argument_list|,
name|errstr
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|len
operator|=
literal|10
expr_stmt|;
name|error
operator|=
name|bsde_get_mib
argument_list|(
name|MIB
literal|".rules"
argument_list|,
name|name
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"%s: %s"
argument_list|,
name|MIB
literal|".rules"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|name
index|[
name|len
index|]
operator|=
name|rulenum
expr_stmt|;
name|len
operator|++
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|rule
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl
argument_list|(
name|name
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|rule
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"%s.%d: %s"
argument_list|,
name|MIB
literal|".rules"
argument_list|,
name|rulenum
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_set_rule
parameter_list|(
name|int
name|rulenum
parameter_list|,
name|struct
name|mac_bsdextended_rule
modifier|*
name|rule
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|int
name|name
index|[
literal|10
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|bsde_check_version
argument_list|(
name|buflen
argument_list|,
name|errstr
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|len
operator|=
literal|10
expr_stmt|;
name|error
operator|=
name|bsde_get_mib
argument_list|(
name|MIB
literal|".rules"
argument_list|,
name|name
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"%s: %s"
argument_list|,
name|MIB
literal|".rules"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|name
index|[
name|len
index|]
operator|=
name|rulenum
expr_stmt|;
name|len
operator|++
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|rule
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl
argument_list|(
name|name
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|rule
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"%s.%d: %s"
argument_list|,
name|MIB
literal|".rules"
argument_list|,
name|rulenum
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bsde_add_rule
parameter_list|(
name|int
modifier|*
name|rulenum
parameter_list|,
name|struct
name|mac_bsdextended_rule
modifier|*
name|rule
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|char
modifier|*
name|errstr
parameter_list|)
block|{
name|char
name|charstr
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|name
index|[
literal|10
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|size
decl_stmt|;
name|int
name|error
decl_stmt|,
name|rule_slots
decl_stmt|;
if|if
condition|(
name|bsde_check_version
argument_list|(
name|buflen
argument_list|,
name|errstr
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|len
operator|=
literal|10
expr_stmt|;
name|error
operator|=
name|bsde_get_mib
argument_list|(
name|MIB
literal|".rules"
argument_list|,
name|name
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"%s: %s"
argument_list|,
name|MIB
literal|".rules"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|rule_slots
operator|=
name|bsde_get_rule_slots
argument_list|(
name|BUFSIZ
argument_list|,
name|charstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rule_slots
operator|==
operator|-
literal|1
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"unable to get rule slots: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|name
index|[
name|len
index|]
operator|=
name|rule_slots
expr_stmt|;
name|len
operator|++
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|rule
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl
argument_list|(
name|name
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|rule
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|errstr
argument_list|,
name|buflen
argument_list|,
literal|"%s.%d: %s"
argument_list|,
name|MIB
literal|".rules"
argument_list|,
name|rule_slots
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|rulenum
operator|!=
name|NULL
condition|)
operator|*
name|rulenum
operator|=
name|rule_slots
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


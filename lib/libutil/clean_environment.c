begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2004 Tim Kientzle  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer  *    in this position and unchanged.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR(S) ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR(S) BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"libutil.h"
end_include

begin_function_decl
specifier|static
name|int
name|env_var_in_list
parameter_list|(
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|list
parameter_list|,
name|char
modifier|*
name|var
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Default whitelist of "known safe" environment variables.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|default_whitelist
index|[]
init|=
block|{
comment|/* List from SUS "Environment Variables" Appendix */
literal|"ARFLAGS"
block|,
literal|"CC"
block|,
literal|"CDPATH"
block|,
literal|"CFLAGS"
block|,
literal|"CHARSET"
block|,
literal|"COLUMNS"
block|,
literal|"DATEMSK"
block|,
literal|"DEAD"
block|,
literal|"EDITOR"
block|,
literal|"ENV"
block|,
literal|"EXINIT"
block|,
literal|"FC"
block|,
literal|"FCEDIT"
block|,
literal|"FFLAGS"
block|,
literal|"GET"
block|,
literal|"GFLAGS"
block|,
literal|"HISTFILE"
block|,
literal|"HISTORY"
block|,
literal|"HISTSIZE"
block|,
literal|"HOME"
block|,
literal|"IFS"
block|,
literal|"LANG"
block|,
literal|"LC_ALL"
block|,
literal|"LC_COLLATE"
block|,
literal|"LC_CTYPE"
block|,
literal|"LC_MESSAGES"
block|,
literal|"LC_MONETARY"
block|,
literal|"LC_NUMERIC"
block|,
literal|"LC_TIME"
block|,
literal|"LDFLAGS"
block|,
literal|"LEX"
block|,
literal|"LFLAGS"
block|,
literal|"LINENO"
block|,
literal|"LINES"
block|,
literal|"LISTER"
block|,
literal|"LOGNAME"
block|,
literal|"LPDEST"
block|,
literal|"MAIL"
block|,
literal|"MAILCHECK"
block|,
literal|"MAILER"
block|,
literal|"MAILPATH"
block|,
literal|"MAILRC"
block|,
literal|"MAKEFLAGS"
block|,
literal|"MAKESHELL"
block|,
literal|"MANPATH"
block|,
literal|"MBOX"
block|,
literal|"MORE"
block|,
literal|"MSGVERB"
block|,
literal|"NLSPATH"
block|,
literal|"NPROC"
block|,
literal|"OLDPWD"
block|,
literal|"OPTARG"
block|,
literal|"OPTERR"
block|,
literal|"OPTIND"
block|,
literal|"PAGER"
block|,
literal|"PATH"
block|,
literal|"PPID"
block|,
literal|"PRINTER"
block|,
literal|"PROCLANG"
block|,
literal|"PROJECTDIR"
block|,
literal|"PS1"
block|,
literal|"PS2"
block|,
literal|"PS3"
block|,
literal|"PS4"
block|,
literal|"PWD"
block|,
literal|"RANDOM"
block|,
literal|"SECONDS"
block|,
literal|"SHELL"
block|,
literal|"TERM"
block|,
literal|"TERMCAP"
block|,
literal|"TERMINFO"
block|,
literal|"TMPDIR"
block|,
literal|"TZ"
block|,
literal|"USER"
block|,
literal|"VISUAL"
block|,
literal|"YACC"
block|,
literal|"YFLAGS"
block|,
comment|/* Additional Environment Variables */
literal|"KRB5CCNAME"
block|,
literal|"LOGIN"
block|,
literal|"MAILDIR"
block|,
literal|"SSH_AGENT_PID"
block|,
literal|"SSH_AUTH_SOCK"
block|,
comment|/* Terminating NULL */
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|env_var_in_list
parameter_list|(
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|list
parameter_list|,
name|char
modifier|*
name|var
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
operator|*
name|list
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|var
argument_list|,
operator|*
name|list
argument_list|,
name|len
argument_list|)
operator|==
literal|0
operator|&&
name|len
operator|==
name|strlen
argument_list|(
operator|*
name|list
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|list
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Scrub the environment by applying a "whitelist" of safe variables  * and a "blacklist" of known dangerous variables.   Each environment  * variable is examined and is retained only if it appears in a whitelist  * and does not appear in the blacklist.  *  * If the first argument is NULL, a built-in whitelist will be used.  * The second and third arguments allow clients to adjust the built-in  * whitelist without having to replicate it.  *  */
end_comment

begin_function
name|void
name|clean_environment
parameter_list|(
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|whitelist
parameter_list|,
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|extra_whitelist
parameter_list|)
block|{
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
modifier|*
name|new
decl_stmt|,
modifier|*
modifier|*
name|old
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|safe
decl_stmt|;
name|old
operator|=
name|environ
expr_stmt|;
name|new
operator|=
name|environ
expr_stmt|;
if|if
condition|(
name|whitelist
operator|==
name|NULL
condition|)
name|whitelist
operator|=
name|default_whitelist
expr_stmt|;
while|while
condition|(
operator|*
name|old
operator|!=
name|NULL
condition|)
block|{
name|safe
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
operator|*
name|old
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
name|len
operator|=
name|p
operator|-
operator|*
name|old
expr_stmt|;
else|else
name|len
operator|=
name|strlen
argument_list|(
operator|*
name|old
argument_list|)
expr_stmt|;
if|if
condition|(
name|env_var_in_list
argument_list|(
name|whitelist
argument_list|,
operator|*
name|old
argument_list|,
name|len
argument_list|)
operator|||
name|env_var_in_list
argument_list|(
name|extra_whitelist
argument_list|,
operator|*
name|old
argument_list|,
name|len
argument_list|)
condition|)
operator|*
name|new
operator|++
operator|=
operator|*
name|old
expr_stmt|;
name|old
operator|++
expr_stmt|;
block|}
while|while
condition|(
operator|*
name|new
operator|!=
name|NULL
condition|)
operator|*
name|new
operator|++
operator|=
name|NULL
expr_stmt|;
block|}
end_function

end_unit


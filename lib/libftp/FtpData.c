begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* 		      Library for ftpd clients.(libftp) 			Copyright by Oleg Orel 			 All rights reserved. 			 This  library is desined  for  free,  non-commercial  software  creation.  It is changeable and can be improved. The author would greatly appreciate  any  advises, new  components  and  patches  of  the  existing  programs. Commercial  usage is  also  possible  with  participation of it's author.    */
end_comment

begin_include
include|#
directive|include
file|"FtpLibrary.h"
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_function
name|STATUS
name|FtpData
parameter_list|(
name|FTP
modifier|*
name|con
parameter_list|,
name|char
modifier|*
name|command
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|char
modifier|*
name|mode
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|data
decl_stmt|,
name|from
decl_stmt|;
specifier|register
name|struct
name|hostent
modifier|*
name|host
decl_stmt|;
name|String
name|hostname
decl_stmt|;
name|int
name|NewSocket
decl_stmt|,
name|Accepted_Socket
decl_stmt|,
name|len
init|=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
decl_stmt|,
name|one
init|=
literal|1
decl_stmt|,
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|;
name|FREE
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|from
argument_list|)
expr_stmt|;
if|if
condition|(
name|gethostname
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
name|hostname
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
operator|(
name|host
operator|=
operator|(
expr|struct
name|hostent
operator|*
operator|)
name|gethostbyname
argument_list|(
name|hostname
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|QUIT
argument_list|)
return|;
name|data
operator|.
name|sin_family
operator|=
name|host
operator|->
name|h_addrtype
expr_stmt|;
name|bcopy
argument_list|(
name|host
operator|->
name|h_addr_list
index|[
literal|0
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|data
operator|.
name|sin_addr
argument_list|,
name|host
operator|->
name|h_length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|NewSocket
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
name|setsockopt
argument_list|(
name|NewSocket
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_REUSEADDR
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|one
argument_list|,
sizeof|sizeof
argument_list|(
name|one
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|close
argument_list|(
name|NewSocket
argument_list|)
expr_stmt|;
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|QUIT
argument_list|)
return|;
block|}
name|data
operator|.
name|sin_port
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|NewSocket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data
argument_list|,
sizeof|sizeof
name|data
argument_list|)
operator|<
literal|0
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
name|getsockname
argument_list|(
name|NewSocket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data
argument_list|,
operator|&
name|len
argument_list|)
operator|<
literal|0
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
name|listen
argument_list|(
name|NewSocket
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|QUIT
argument_list|)
return|;
name|a
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|data
operator|.
name|sin_addr
expr_stmt|;
name|b
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|data
operator|.
name|sin_port
expr_stmt|;
name|FtpAssert
argument_list|(
name|con
argument_list|,
name|FtpPort
argument_list|(
name|con
argument_list|,
name|CUT
argument_list|(
name|a
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|CUT
argument_list|(
name|a
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|CUT
argument_list|(
name|a
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|CUT
argument_list|(
name|a
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|CUT
argument_list|(
name|b
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|CUT
argument_list|(
name|b
index|[
literal|1
index|]
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|seek
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|=
name|FtpCommand
argument_list|(
name|con
argument_list|,
literal|"REST %d"
argument_list|,
name|con
operator|->
name|seek
argument_list|,
literal|0
argument_list|,
name|EOF
argument_list|)
operator|)
operator|!=
literal|350
condition|)
return|return
operator|-
name|i
return|;
block|}
name|FtpAssert
argument_list|(
name|con
argument_list|,
name|FtpCommand
argument_list|(
name|con
argument_list|,
name|command
argument_list|,
name|file
argument_list|,
literal|200
argument_list|,
literal|120
argument_list|,
literal|150
argument_list|,
literal|125
argument_list|,
literal|250
argument_list|,
name|EOF
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|Accepted_Socket
operator|=
name|accept
argument_list|(
name|NewSocket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|close
argument_list|(
name|NewSocket
argument_list|)
expr_stmt|;
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|QUIT
argument_list|)
return|;
block|}
name|close
argument_list|(
name|NewSocket
argument_list|)
expr_stmt|;
name|FTPDATA
argument_list|(
name|con
argument_list|)
operator|=
name|fdopen
argument_list|(
name|Accepted_Socket
argument_list|,
literal|"r+"
argument_list|)
expr_stmt|;
return|return
name|i
return|;
block|}
end_function

end_unit


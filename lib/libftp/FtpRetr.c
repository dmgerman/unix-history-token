begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* 		      Library for ftpd clients.(libftp) 			Copyright by Oleg Orel 			 All rights reserved. 			 This  library is desined  for  free,  non-commercial  software  creation.  It is changeable and can be improved. The author would greatly appreciate  any  advises, new  components  and  patches  of  the  existing  programs. Commercial  usage is  also  possible  with  participation of it's author.    */
end_comment

begin_include
include|#
directive|include
file|"FtpLibrary.h"
end_include

begin_function
name|STATUS
name|FtpRetr
parameter_list|(
name|FTP
modifier|*
name|con
parameter_list|,
name|char
modifier|*
name|command
parameter_list|,
name|char
modifier|*
name|in
parameter_list|,
name|char
modifier|*
name|out
parameter_list|)
block|{
name|FILE
modifier|*
name|o
decl_stmt|;
name|int
name|c
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|char
name|buffer
index|[
name|FTPBUFSIZ
index|]
decl_stmt|,
name|buffer2
index|[
name|FTPBUFSIZ
index|]
decl_stmt|;
specifier|register
name|int
name|size
decl_stmt|;
name|FtpFilenameChecker
argument_list|(
operator|&
name|in
argument_list|,
operator|&
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|FtpTestFlag
argument_list|(
name|con
argument_list|,
name|FTP_REST
argument_list|)
operator|&&
name|stat
argument_list|(
name|out
argument_list|,
operator|&
name|st
argument_list|)
operator|==
literal|0
condition|)
block|{
name|con
operator|->
name|seek
operator|=
name|st
operator|.
name|st_size
expr_stmt|;
if|if
condition|(
operator|(
name|o
operator|=
name|Ftpfopen
argument_list|(
name|out
argument_list|,
literal|"a+"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|LQUIT
argument_list|)
return|;
block|}
else|else
block|{
name|con
operator|->
name|seek
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|o
operator|=
name|Ftpfopen
argument_list|(
name|out
argument_list|,
literal|"w+"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|LQUIT
argument_list|)
return|;
block|}
if|if
condition|(
name|FtpError
argument_list|(
name|FtpData
argument_list|(
name|con
argument_list|,
name|command
argument_list|,
name|in
argument_list|,
literal|"r"
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|con
operator|->
name|seek
operator|==
literal|0
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|con
operator|->
name|errno
argument_list|)
return|;
name|con
operator|->
name|seek
operator|=
literal|0
expr_stmt|;
name|fclose
argument_list|(
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
name|FtpError
argument_list|(
name|FtpData
argument_list|(
name|con
argument_list|,
name|command
argument_list|,
name|in
argument_list|,
literal|"r"
argument_list|)
argument_list|)
condition|)
block|{
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|con
operator|->
name|errno
argument_list|)
return|;
block|}
if|if
condition|(
operator|(
name|o
operator|=
name|Ftpfopen
argument_list|(
name|out
argument_list|,
literal|"w+"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|LQUIT
argument_list|)
return|;
block|}
name|fseek
argument_list|(
name|o
argument_list|,
name|con
operator|->
name|seek
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|size
operator|=
name|FtpReadBlock
argument_list|(
name|con
argument_list|,
name|buffer
argument_list|,
name|FTPBUFSIZ
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|write
argument_list|(
name|fileno
argument_list|(
name|o
argument_list|)
argument_list|,
name|buffer
argument_list|,
name|size
argument_list|)
operator|!=
name|size
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|LQUIT
argument_list|)
return|;
block|}
name|Ftpfclose
argument_list|(
name|o
argument_list|)
expr_stmt|;
return|return
name|FtpClose
argument_list|(
name|con
argument_list|)
return|;
block|}
end_function

end_unit


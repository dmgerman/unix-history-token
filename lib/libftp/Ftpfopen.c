begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* 		      Library for ftpd clients.(libftp) 			Copyright by Oleg Orel 			 All rights reserved. 			 This  library is desined  for  free,  non-commercial  software  creation.  It is changeable and can be improved. The author would greatly appreciate  any  advises, new  components  and  patches  of  the  existing  programs. Commercial  usage is  also  possible  with  participation of it's author.    */
end_comment

begin_include
include|#
directive|include
file|<FtpLibrary.h>
end_include

begin_define
define|#
directive|define
name|NFSD
value|256
end_define

begin_decl_stmt
specifier|static
name|int
name|fds_types
index|[
name|NFDS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|init
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
block|{
name|T_EMPTY
init|=
literal|0
block|,
name|T_FILE
block|,
name|T_STREAM
block|,
name|T_PIPE
block|,
name|T_FULL
block|}
enum|;
end_enum

begin_function
name|FILE
modifier|*
name|Ftpfopen
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|char
modifier|*
name|mode
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
if|if
condition|(
operator|!
name|init
condition|)
block|{
name|bzero
argument_list|(
name|fds_types
argument_list|,
name|NFDS
operator|*
sizeof|sizeof
argument_list|(
name|fds_types
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|init
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|filename
argument_list|,
literal|"*STDIN*"
argument_list|)
operator|||
operator|(
operator|!
name|strcmp
argument_list|(
name|filename
argument_list|,
literal|"-"
argument_list|)
operator|&&
operator|(
name|mode
index|[
literal|0
index|]
operator|==
literal|'r'
operator|)
operator|)
condition|)
block|{
name|fds_types
index|[
name|fileno
argument_list|(
name|stdin
argument_list|)
index|]
operator|=
name|T_STREAM
expr_stmt|;
return|return
name|stdin
return|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|filename
argument_list|,
literal|"*STDOUT*"
argument_list|)
operator|||
operator|(
operator|!
name|strcmp
argument_list|(
name|filename
argument_list|,
literal|"-"
argument_list|)
operator|&&
operator|(
name|mode
index|[
literal|0
index|]
operator|==
literal|'w'
operator|)
operator|)
condition|)
block|{
name|fds_types
index|[
name|fileno
argument_list|(
name|stdout
argument_list|)
index|]
operator|=
name|T_STREAM
expr_stmt|;
return|return
name|stdout
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|filename
argument_list|,
literal|"*STDERR*"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fds_types
index|[
name|fileno
argument_list|(
name|stderr
argument_list|)
index|]
operator|=
name|T_STREAM
expr_stmt|;
return|return
name|stderr
return|;
block|}
if|if
condition|(
operator|*
name|filename
operator|==
literal|'|'
condition|)
block|{
name|fp
operator|=
name|popen
argument_list|(
name|filename
operator|+
literal|1
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
return|return
name|fp
return|;
name|fds_types
index|[
name|fileno
argument_list|(
name|fp
argument_list|)
index|]
operator|=
name|T_PIPE
expr_stmt|;
return|return
name|fp
return|;
block|}
name|fp
operator|=
name|FtpFullOpen
argument_list|(
name|filename
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
return|return
name|fp
return|;
name|fds_types
index|[
name|fileno
argument_list|(
name|fp
argument_list|)
index|]
operator|=
name|T_FILE
expr_stmt|;
return|return
name|fp
return|;
block|}
end_function

begin_function
name|int
name|Ftpfclose
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
if|if
condition|(
operator|!
name|init
condition|)
block|{
name|bzero
argument_list|(
name|fds_types
argument_list|,
name|NFDS
operator|*
sizeof|sizeof
argument_list|(
name|fds_types
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|init
operator|=
literal|1
expr_stmt|;
block|}
switch|switch
condition|(
name|fds_types
index|[
name|fileno
argument_list|(
name|fp
argument_list|)
index|]
condition|)
block|{
case|case
name|T_FILE
case|:
return|return
name|FtpFullClose
argument_list|(
name|fp
argument_list|)
return|;
case|case
name|T_STREAM
case|:
return|return
name|fflush
argument_list|(
name|fp
argument_list|)
return|;
case|case
name|T_PIPE
case|:
return|return
name|pclose
argument_list|(
name|fp
argument_list|)
return|;
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

end_unit


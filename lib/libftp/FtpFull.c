begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* 		      Library for ftpd clients.(libftp) 			Copyright by Oleg Orel 			 All rights reserved. 			 This  library is desined  for  free,  non-commercial  software  creation.  It is changeable and can be improved. The author would greatly appreciate  any  advises, new  components  and  patches  of  the  existing  programs. Commercial  usage is  also  possible  with  participation of it's author.    */
end_comment

begin_include
include|#
directive|include
file|"FtpLibrary.h"
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_decl_stmt
specifier|static
name|FTP
modifier|*
name|ftp_table
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|STATUS
name|syntax
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|FILE
modifier|*
name|FtpFullOpen
parameter_list|(
name|char
modifier|*
name|file
parameter_list|,
name|char
modifier|*
name|mode
parameter_list|)
block|{
name|FTP
modifier|*
name|ftp
decl_stmt|;
name|FILE
modifier|*
name|tmp
decl_stmt|;
name|String
name|Host
decl_stmt|,
name|User
decl_stmt|,
name|Passwd
decl_stmt|,
name|RemoteFile
decl_stmt|;
name|STATUS
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|FtpFullSyntax
argument_list|(
name|file
argument_list|,
name|Host
argument_list|,
name|User
argument_list|,
name|Passwd
argument_list|,
name|RemoteFile
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
name|tmp
return|;
name|ftp_table
index|[
operator|(
name|int
operator|)
name|fileno
argument_list|(
name|tmp
argument_list|)
index|]
operator|=
name|NULL
expr_stmt|;
return|return
name|tmp
return|;
block|}
if|if
condition|(
name|FtpError
argument_list|(
name|i
operator|=
name|FtpLogin
argument_list|(
operator|&
name|ftp
argument_list|,
name|Host
argument_list|,
name|User
argument_list|,
name|Passwd
argument_list|,
name|NULL
argument_list|)
argument_list|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|mode
index|[
literal|1
index|]
operator|==
literal|'b'
condition|)
name|FtpBinary
argument_list|(
name|ftp
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'r'
case|:
if|if
condition|(
name|FtpError
argument_list|(
name|FtpOpenRead
argument_list|(
name|ftp
argument_list|,
name|RemoteFile
argument_list|)
argument_list|)
condition|)
return|return
name|NULL
return|;
name|ftp_table
index|[
name|fileno
argument_list|(
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
argument_list|)
index|]
operator|=
name|ftp
expr_stmt|;
return|return
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
return|;
case|case
literal|'w'
case|:
if|if
condition|(
name|FtpError
argument_list|(
name|FtpOpenWrite
argument_list|(
name|ftp
argument_list|,
name|RemoteFile
argument_list|)
argument_list|)
condition|)
return|return
name|NULL
return|;
name|ftp_table
index|[
name|fileno
argument_list|(
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
argument_list|)
index|]
operator|=
name|ftp
expr_stmt|;
return|return
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
return|;
case|case
literal|'a'
case|:
if|if
condition|(
name|FtpError
argument_list|(
name|FtpOpenAppend
argument_list|(
name|ftp
argument_list|,
name|RemoteFile
argument_list|)
argument_list|)
condition|)
return|return
name|NULL
return|;
name|ftp_table
index|[
name|fileno
argument_list|(
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
argument_list|)
index|]
operator|=
name|ftp
expr_stmt|;
return|return
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
return|;
block|}
comment|/* Error Mode */
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|STATUS
name|FtpFullClose
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|)
block|{
name|FTP
modifier|*
name|ftp
init|=
name|ftp_table
index|[
operator|(
name|int
operator|)
name|fileno
argument_list|(
name|f
argument_list|)
index|]
decl_stmt|;
if|if
condition|(
name|ftp
operator|==
name|NULL
condition|)
return|return
name|fclose
argument_list|(
name|f
argument_list|)
return|;
name|FtpClose
argument_list|(
name|ftp
argument_list|)
expr_stmt|;
return|return
name|FtpQuickBye
argument_list|(
name|ftp
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Format of ftp's file [user[/passord]@]hostname:filename_with_path */
end_comment

begin_function
name|STATUS
name|FtpFullSyntax
parameter_list|(
name|String
name|source
parameter_list|,
name|String
name|host
parameter_list|,
name|String
name|user
parameter_list|,
name|String
name|passwd
parameter_list|,
name|String
name|file
parameter_list|)
block|{
name|char
modifier|*
name|in
decl_stmt|,
modifier|*
name|out
decl_stmt|;
name|String
name|tmp
decl_stmt|;
name|host
index|[
literal|0
index|]
operator|=
name|user
index|[
literal|0
index|]
operator|=
name|passwd
index|[
literal|0
index|]
operator|=
name|file
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|in
operator|=
name|source
operator|,
name|out
operator|=
name|user
init|;
operator|*
name|in
operator|!=
literal|'\0'
operator|&&
operator|*
name|in
operator|!=
literal|'/'
operator|&&
operator|*
name|in
operator|!=
literal|'@'
operator|&&
operator|*
name|in
operator|!=
literal|':'
condition|;
operator|*
name|out
operator|++
operator|=
operator|*
name|in
operator|++
control|)
empty_stmt|;
operator|*
name|out
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|in
operator|==
literal|'\0'
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|in
operator|==
literal|':'
condition|)
block|{
name|strcpy
argument_list|(
name|host
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|user
argument_list|,
literal|"anonymous"
argument_list|)
expr_stmt|;
name|gethostname
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
name|tmp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|passwd
argument_list|,
literal|"%s@%s"
argument_list|,
name|getpwuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
operator|->
name|pw_name
argument_list|,
name|gethostbyname
argument_list|(
name|tmp
argument_list|)
operator|->
name|h_name
argument_list|)
expr_stmt|;
goto|goto
name|file
goto|;
block|}
if|if
condition|(
operator|*
name|in
operator|==
literal|'/'
condition|)
block|{
for|for
control|(
name|in
operator|++
operator|,
name|out
operator|=
name|passwd
init|;
operator|*
name|in
operator|!=
literal|'\0'
operator|&&
operator|*
name|in
operator|!=
literal|'@'
condition|;
operator|*
name|out
operator|++
operator|=
operator|*
name|in
operator|++
control|)
empty_stmt|;
operator|*
name|out
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|in
operator|==
literal|'\0'
condition|)
return|return
literal|0
return|;
block|}
else|else
block|{
name|gethostname
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
name|tmp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|passwd
argument_list|,
literal|"%s@%s"
argument_list|,
name|getpwuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
operator|->
name|pw_name
argument_list|,
name|gethostbyname
argument_list|(
name|tmp
argument_list|)
operator|->
name|h_name
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|in
operator|++
operator|,
name|out
operator|=
name|host
init|;
operator|*
name|in
operator|!=
literal|'\0'
operator|&&
operator|*
name|in
operator|!=
literal|':'
condition|;
operator|*
name|out
operator|++
operator|=
operator|*
name|in
operator|++
control|)
empty_stmt|;
operator|*
name|out
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|in
operator|==
literal|'\0'
condition|)
return|return
literal|0
return|;
name|file
label|:
for|for
control|(
name|in
operator|++
operator|,
name|out
operator|=
name|file
init|;
operator|*
name|in
operator|!=
literal|'\0'
condition|;
operator|*
name|out
operator|++
operator|=
operator|*
name|in
operator|++
control|)
empty_stmt|;
operator|*
name|out
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

end_unit


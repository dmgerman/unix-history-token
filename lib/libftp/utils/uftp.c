begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* File Transfer Protocol Toolkit based on libftp */
end_comment

begin_include
include|#
directive|include
file|"uftp.h"
end_include

begin_include
include|#
directive|include
file|<varargs.h>
end_include

begin_decl_stmt
name|FTP
modifier|*
name|ftp
index|[
name|NFRAMES
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|LINKINFO
name|iftp
index|[
name|NFRAMES
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|frame
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|status
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|jmp_buf
name|start
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lastcmd
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|glassmode
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|trymode
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|restmode
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|hashmode
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sleeptime
init|=
literal|30
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|time_t
name|noopinterval
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|time_t
name|nooptimeout
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|time_t
name|prevtime
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|String
name|cmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|String
name|prompt
init|=
literal|"%T %u@%H:%d> "
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|String
name|defaultuser
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ALIAS
modifier|*
name|firstalias
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* if main have any arguments, interprets each it as command with args */
end_comment

begin_function
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|p1
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|String
name|tmp
decl_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|start
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|main_loop
goto|;
name|setsignals
argument_list|()
expr_stmt|;
name|FtpSetErrorHandler
argument_list|(
operator|&
name|FtpInit
argument_list|,
name|my_error
argument_list|)
expr_stmt|;
name|FtpSetIOHandler
argument_list|(
operator|&
name|FtpInit
argument_list|,
name|my_error
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|defaultuser
argument_list|,
name|getpwuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
operator|->
name|pw_name
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ftp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|FTP
operator|*
argument_list|)
operator|*
name|NFRAMES
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|iftp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LINKINFO
argument_list|)
operator|*
name|NFRAMES
argument_list|)
expr_stmt|;
name|batch
argument_list|(
name|SYSTEMRC
argument_list|)
expr_stmt|;
if|if
condition|(
name|access
argument_list|(
name|getrcname
argument_list|()
argument_list|,
name|F_OK
argument_list|)
condition|)
block|{
name|FILE
modifier|*
name|out
init|=
name|fdopen
argument_list|(
name|open
argument_list|(
name|getrcname
argument_list|()
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
operator||
name|O_TRUNC
argument_list|,
literal|0700
argument_list|)
argument_list|,
literal|"w"
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Create default rc-file \"%s\"\n"
argument_list|,
name|getrcname
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|==
name|NULL
condition|)
name|perror
argument_list|(
name|getrcname
argument_list|()
argument_list|)
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"set timeout 120\nset hash\nset debug\nset bin\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"set prompt \"%%T %%u@%%h:%%d\\> \"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"alias a alias\na ed ! emacs\nalias tn ! telnet\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
block|}
name|batch
argument_list|(
name|getrcname
argument_list|()
argument_list|)
expr_stmt|;
name|batch
argument_list|(
name|getaliasrcname
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
operator|,
name|tmp
index|[
literal|0
index|]
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|strcat
argument_list|(
name|tmp
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|+
literal|1
operator|!=
name|argc
condition|)
name|strcat
argument_list|(
name|tmp
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tmp
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
block|{
name|String
name|new
decl_stmt|;
comment|/*       if (!strcmp(defaultuser,"ftp") || !strcmp(defaultuser,"anonymous")) 	strcpy(new,"ftp ");       else */
name|strcpy
argument_list|(
name|new
argument_list|,
literal|"open "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifalias
argument_list|(
name|tmp
argument_list|)
condition|)
name|execute
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|new
argument_list|,
name|tmp
argument_list|)
operator|,
name|execute
argument_list|(
name|new
argument_list|)
expr_stmt|;
block|}
name|main_loop
label|:
name|setsignals
argument_list|()
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|setjmp
argument_list|(
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|lastcmd
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|isatty
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|)
condition|)
name|p1
operator|=
name|readline
argument_list|(
name|getprompt
argument_list|()
argument_list|)
expr_stmt|;
else|else
name|p1
operator|=
name|gets
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|p1
operator|==
name|NULL
condition|)
block|{
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|cmd
argument_list|,
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
index|[
literal|0
index|]
condition|)
name|add_history
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|execute
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|INLINE
name|char
modifier|*
name|findspace
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
while|while
condition|(
operator|!
name|isspace
argument_list|(
operator|*
name|str
argument_list|)
operator|&&
operator|*
name|str
operator|!=
literal|'\0'
condition|)
name|str
operator|++
expr_stmt|;
return|return
name|str
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|word
parameter_list|(
name|char
modifier|*
name|str
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|String
name|new
decl_stmt|;
specifier|register
name|char
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|strcpy
argument_list|(
name|new
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|p1
operator|=
name|new
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|p1
argument_list|)
condition|)
name|p1
operator|++
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|1
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
operator|-
literal|1
condition|;
name|i
operator|++
control|)
comment|/* Skip n-1 words */
block|{
if|if
condition|(
operator|(
operator|*
name|p1
operator|==
literal|'"'
operator|)
operator|||
operator|(
operator|*
name|p1
operator|==
literal|'\''
operator|)
condition|)
block|{
name|p1
operator|=
name|strchr
argument_list|(
name|p1
operator|+
literal|1
argument_list|,
operator|*
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p1
operator|==
name|NULL
condition|)
return|return
literal|""
return|;
name|p1
operator|++
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|p1
argument_list|)
condition|)
name|p1
operator|++
expr_stmt|;
continue|continue;
block|}
name|p1
operator|=
name|findspace
argument_list|(
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p1
operator|==
literal|'\0'
condition|)
return|return
literal|""
return|;
name|p1
operator|++
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|p1
argument_list|)
condition|)
name|p1
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|p1
operator|==
literal|'"'
operator|)
operator||
operator|(
operator|*
name|p1
operator|==
literal|'\''
operator|)
condition|)
block|{
name|p2
operator|=
name|strchr
argument_list|(
name|p1
operator|+
literal|1
argument_list|,
operator|*
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2
operator|==
name|NULL
condition|)
return|return
name|p1
operator|+
literal|1
return|;
operator|*
name|p2
operator|=
literal|0
expr_stmt|;
return|return
name|p1
operator|+
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|p2
operator|=
name|findspace
argument_list|(
name|p1
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
operator|*
name|p2
operator|=
literal|0
expr_stmt|;
return|return
name|p1
return|;
block|}
return|return
literal|""
return|;
block|}
end_function

begin_comment
comment|/* Exacute few command separated by ';' . The character ' must use for mark complex    works*/
end_comment

begin_macro
name|execute
argument_list|(
argument|char *cmd
argument_list|)
end_macro

begin_block
block|{
name|String
name|w1
decl_stmt|,
name|w2
decl_stmt|,
name|w3
decl_stmt|,
name|w4
decl_stmt|,
name|w5
decl_stmt|,
name|w6
decl_stmt|;
name|String
name|newcmd
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
operator|*
name|cmd
operator|||
operator|*
name|cmd
operator|==
literal|'#'
condition|)
return|return;
for|for
control|(
name|p
operator|=
name|newcmd
init|;
operator|*
name|cmd
condition|;
name|cmd
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|cmd
operator|==
literal|'\''
condition|)
block|{
operator|*
name|p
operator|++
operator|=
operator|*
name|cmd
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|cmd
operator|!=
literal|'\''
operator|&&
operator|*
name|cmd
operator|!=
literal|0
condition|)
operator|*
name|p
operator|++
operator|=
operator|*
name|cmd
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|cmd
operator|==
literal|0
condition|)
return|return
name|puts
argument_list|(
literal|"Unbalanced \', please corrected!\n"
argument_list|)
return|;
operator|*
name|p
operator|++
operator|=
operator|*
name|cmd
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|*
name|cmd
operator|==
literal|';'
condition|)
block|{
operator|*
name|p
operator|=
literal|0
expr_stmt|;
name|execute
argument_list|(
name|newcmd
argument_list|)
expr_stmt|;
name|p
operator|=
name|newcmd
expr_stmt|;
continue|continue;
block|}
operator|*
name|p
operator|++
operator|=
operator|*
name|cmd
expr_stmt|;
block|}
operator|*
name|p
operator|=
literal|0
expr_stmt|;
name|cmd
operator|=
name|newcmd
expr_stmt|;
if|if
condition|(
operator|*
name|cmd
operator|==
literal|'\\'
condition|)
name|cmd
operator|++
expr_stmt|;
else|else
block|{
name|String
name|new
decl_stmt|;
name|strcpy
argument_list|(
name|new
argument_list|,
literal|"\\"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|new
argument_list|,
name|expandalias
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|execute
argument_list|(
name|new
argument_list|)
return|;
block|}
if|if
condition|(
operator|*
name|cmd
operator|==
literal|'!'
condition|)
block|{
name|int
name|pid
decl_stmt|,
name|_pid
decl_stmt|;
name|int
name|status
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
condition|)
block|{
name|execlp
argument_list|(
operator|(
name|getenv
argument_list|(
literal|"SHELL"
argument_list|)
operator|==
name|NULL
operator|)
condition|?
literal|"/bin/sh"
else|:
operator|(
name|char
operator|*
operator|)
name|getenv
argument_list|(
literal|"SHELL"
argument_list|)
argument_list|,
literal|"shell"
argument_list|,
literal|"-c"
argument_list|,
name|cmd
operator|+
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|_pid
operator|=
name|wait
argument_list|(
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|_pid
operator|==
name|pid
condition|)
return|return;
block|}
block|}
name|redir
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
index|[
name|strlen
argument_list|(
name|cmd
argument_list|)
operator|-
literal|1
index|]
operator|==
literal|'&'
condition|)
block|{
name|String
name|tmp
decl_stmt|;
name|cmd
index|[
name|strlen
argument_list|(
name|cmd
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|tmp
argument_list|,
literal|"bg "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|tmp
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|cmd
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|w1
argument_list|,
name|word
argument_list|(
name|cmd
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|w2
argument_list|,
name|word
argument_list|(
name|cmd
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|w3
argument_list|,
name|word
argument_list|(
name|cmd
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|w4
argument_list|,
name|word
argument_list|(
name|cmd
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|w5
argument_list|,
name|word
argument_list|(
name|cmd
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|w6
argument_list|,
name|word
argument_list|(
name|cmd
argument_list|,
literal|6
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|executev
argument_list|(
name|w1
argument_list|,
name|w2
argument_list|,
name|w3
argument_list|,
name|w4
argument_list|,
name|w5
argument_list|,
name|w6
argument_list|)
return|;
block|}
end_block

begin_macro
name|executev
argument_list|(
argument|ARGS
argument_list|)
end_macro

begin_block
block|{
name|CMDS
modifier|*
name|xcmd
init|=
operator|&
name|cmds
index|[
literal|0
index|]
decl_stmt|;
name|String
name|tmp
decl_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|w1
argument_list|)
condition|)
return|return
name|atoi
argument_list|(
name|w1
argument_list|)
operator|<
name|NFRAMES
condition|?
name|frame
operator|=
name|atoi
argument_list|(
name|w1
argument_list|)
else|:
literal|0
operator|,
name|executev
argument_list|(
name|w2
argument_list|,
name|w3
argument_list|,
name|w4
argument_list|,
name|w5
argument_list|,
name|w6
argument_list|,
literal|""
argument_list|)
return|;
while|while
condition|(
name|xcmd
operator|->
name|cmd
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|xcmd
operator|->
name|cmd
argument_list|,
name|w1
argument_list|)
operator|&&
operator|(
name|xcmd
operator|->
name|func
operator|!=
name|NULL
operator|)
condition|)
block|{
name|int
name|status
decl_stmt|;
if|if
condition|(
name|xcmd
operator|->
name|need
operator|&&
name|LINK
operator|==
name|NULL
condition|)
return|return
name|puts
argument_list|(
literal|"Need connection to server"
argument_list|)
return|;
name|iftp
index|[
name|frame
index|]
operator|.
name|lock
operator|=
literal|1
expr_stmt|;
name|unsetsignals
argument_list|()
expr_stmt|;
name|status
operator|=
call|(
modifier|*
name|xcmd
operator|->
name|func
call|)
argument_list|(
name|w1
argument_list|,
name|w2
argument_list|,
name|w3
argument_list|,
name|w4
argument_list|,
name|w5
argument_list|,
name|w6
argument_list|)
expr_stmt|;
name|iftp
index|[
name|frame
index|]
operator|.
name|lock
operator|=
literal|0
expr_stmt|;
name|setsignals
argument_list|()
expr_stmt|;
name|redirback
argument_list|()
expr_stmt|;
return|return
name|status
return|;
block|}
name|xcmd
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|LINK
operator|!=
name|NULL
operator|&&
name|glassmode
condition|)
return|return
name|FtpCommand
argument_list|(
name|LINK
argument_list|,
name|cmd
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
name|EOF
argument_list|)
return|;
name|printf
argument_list|(
literal|"%s: unknown command\n"
argument_list|,
name|w1
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_block

begin_function
name|void
name|intr
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Interupted by signal %d\n"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|LINK
operator|!=
name|NULL
condition|)
name|FtpSetHashHandler
argument_list|(
name|LINK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|setsignals
argument_list|()
expr_stmt|;
name|reset_termio
argument_list|()
expr_stmt|;
comment|/* From readline */
name|prevtime
operator|=
name|time
argument_list|(
operator|(
name|time_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|start
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|newframe
argument_list|(
argument|int connecteble
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|connecteble
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFRAMES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ftp
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
return|return
name|frame
operator|=
name|i
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFRAMES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ftp
index|[
name|i
index|]
operator|==
name|NULL
condition|)
return|return
name|frame
operator|=
name|i
return|;
return|return
operator|-
literal|1
return|;
block|}
end_block

begin_function
name|STATUS
name|my_error
parameter_list|(
name|FTP
modifier|*
name|ftp
parameter_list|,
name|int
name|code
parameter_list|,
name|char
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|code
operator|==
name|LQUIT
operator|||
operator|(
name|ftp
operator|==
name|NULL
operator|)
condition|)
name|log
argument_list|(
name|msg
argument_list|)
expr_stmt|;
else|else
name|FtpLog
argument_list|(
name|ftp
operator|->
name|title
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|abs
argument_list|(
name|code
argument_list|)
operator|==
literal|530
operator|&&
operator|(
name|strstr
argument_list|(
name|msg
argument_list|,
literal|"anonymous"
argument_list|)
operator|!=
name|NULL
operator|)
condition|)
block|{
name|Ftp_reopen
argument_list|()
expr_stmt|;
name|longjmp
argument_list|(
name|start
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|longjmp
argument_list|(
name|start
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|getrcname
parameter_list|()
block|{
specifier|static
name|String
name|rcpath
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
init|=
name|getpwuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
decl_stmt|;
name|sprintf
argument_list|(
name|rcpath
argument_list|,
literal|"%s/.uftprc"
argument_list|,
name|pwd
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
return|return
name|rcpath
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|getaliasrcname
parameter_list|()
block|{
specifier|static
name|String
name|rcpath
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
init|=
name|getpwuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
decl_stmt|;
name|sprintf
argument_list|(
name|rcpath
argument_list|,
literal|"%s/.uftp_aliases"
argument_list|,
name|pwd
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
return|return
name|rcpath
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|makestr
parameter_list|(
name|va_alist
parameter_list|)
function|va_dcl
block|{
name|char
modifier|*
name|p1
decl_stmt|;
name|va_list
name|args
decl_stmt|;
name|String
name|new
init|=
block|{
literal|0
block|}
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|p1
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|char
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|p1
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
operator|*
name|p1
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|new
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|new
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|new
argument_list|,
name|p1
argument_list|)
expr_stmt|;
block|}
block|}
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
return|return
name|new
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ADD
parameter_list|(
name|str
parameter_list|,
name|chr
parameter_list|)
value|(*str++=chr,*str=0)
end_define

begin_function
name|INLINE
name|ADDSTR
parameter_list|(
name|char
modifier|*
modifier|*
name|str
parameter_list|,
name|char
modifier|*
name|str1
parameter_list|)
block|{
while|while
condition|(
operator|*
name|str1
condition|)
operator|*
operator|(
operator|*
name|str
operator|)
operator|++
operator|=
operator|*
name|str1
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|expandalias
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
name|ALIAS
modifier|*
name|a
init|=
name|firstalias
decl_stmt|;
name|String
name|new
init|=
block|{
literal|0
block|}
decl_stmt|,
name|w1
init|=
block|{
literal|0
block|}
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|p1
init|=
name|new
decl_stmt|,
modifier|*
name|args
decl_stmt|;
name|int
name|dollar
init|=
literal|0
decl_stmt|;
name|strcpy
argument_list|(
name|w1
argument_list|,
name|word
argument_list|(
name|str
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|' '
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|args
operator|=
name|p
operator|+
literal|1
expr_stmt|;
else|else
name|args
operator|=
literal|""
expr_stmt|;
while|while
condition|(
name|a
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|a
operator|->
name|name
argument_list|,
name|w1
argument_list|)
condition|)
break|break;
name|a
operator|=
name|a
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|a
condition|)
return|return
name|str
return|;
for|for
control|(
name|p
operator|=
name|a
operator|->
name|str
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|!=
literal|'$'
condition|)
block|{
name|ADD
argument_list|(
name|p1
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|dollar
operator|=
literal|1
expr_stmt|;
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
name|ADDSTR
argument_list|(
operator|&
name|p1
argument_list|,
name|word
argument_list|(
name|str
argument_list|,
operator|(
operator|*
name|p
operator|)
operator|-
literal|'0'
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
switch|switch
condition|(
operator|*
name|p
condition|)
block|{
case|case
literal|'\0'
case|:
case|case
literal|'$'
case|:
name|ADD
argument_list|(
name|p1
argument_list|,
literal|'$'
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'*'
case|:
name|ADDSTR
argument_list|(
operator|&
name|p1
argument_list|,
name|args
argument_list|)
expr_stmt|;
continue|continue;
default|default:
name|ADD
argument_list|(
name|p1
argument_list|,
literal|'$'
argument_list|)
expr_stmt|;
name|ADD
argument_list|(
name|p1
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
operator|!
name|dollar
condition|)
block|{
name|ADD
argument_list|(
name|p1
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|ADDSTR
argument_list|(
operator|&
name|p1
argument_list|,
name|args
argument_list|)
expr_stmt|;
block|}
operator|*
name|p
operator|=
literal|0
expr_stmt|;
return|return
name|new
return|;
block|}
end_function

begin_macro
name|ifalias
argument_list|(
argument|char *cmd
argument_list|)
end_macro

begin_block
block|{
name|String
name|what
decl_stmt|;
name|ALIAS
modifier|*
name|a
init|=
name|firstalias
decl_stmt|;
name|strcpy
argument_list|(
name|what
argument_list|,
name|word
argument_list|(
name|cmd
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|a
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|a
operator|->
name|name
argument_list|,
name|what
argument_list|)
condition|)
return|return
literal|1
return|;
name|a
operator|=
name|a
operator|->
name|next
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_block

begin_function
name|char
modifier|*
name|getprompt
parameter_list|()
block|{
specifier|static
name|String
name|_prompt
decl_stmt|;
name|String
name|tmp
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|_prompt
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|s
operator|=
name|prompt
init|;
operator|*
name|s
condition|;
name|s
operator|++
control|)
switch|switch
condition|(
operator|*
name|s
condition|)
block|{
case|case
literal|'%'
case|:
switch|switch
condition|(
operator|*
operator|++
name|s
condition|)
block|{
case|case
literal|'H'
case|:
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|iftp
index|[
name|frame
index|]
operator|.
name|host
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|iftp
index|[
name|frame
index|]
operator|.
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|tmp
argument_list|,
literal|'.'
argument_list|)
operator|!=
name|NULL
condition|)
operator|*
operator|(
name|char
operator|*
operator|)
name|strchr
argument_list|(
name|tmp
argument_list|,
literal|'.'
argument_list|)
operator|=
literal|0
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
name|gethostname
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
name|tmp
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|gethostbyname
argument_list|(
name|tmp
argument_list|)
operator|->
name|h_name
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|gethostname
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
name|tmp
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|gethostbyname
argument_list|(
name|tmp
argument_list|)
operator|->
name|h_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|tmp
argument_list|,
literal|'.'
argument_list|)
operator|!=
name|NULL
condition|)
operator|*
operator|(
name|char
operator|*
operator|)
name|strchr
argument_list|(
name|tmp
argument_list|,
literal|'.'
argument_list|)
operator|=
literal|0
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|iftp
index|[
name|frame
index|]
operator|.
name|user
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|iftp
index|[
name|frame
index|]
operator|.
name|pwd
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|strcat
argument_list|(
name|_prompt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|getcwd
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%d"
argument_list|,
name|frame
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%d"
argument_list|,
operator|(
name|LINK
operator|==
name|NULL
operator|)
condition|?
literal|0
else|:
name|LINK
operator|->
name|port
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%d"
argument_list|,
operator|(
name|LINK
operator|==
name|NULL
operator|)
condition|?
literal|0
else|:
name|LINK
operator|->
name|timeout
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
block|{
name|time_t
name|t
init|=
name|time
argument_list|(
operator|(
name|time_t
operator|*
operator|)
literal|0
argument_list|)
decl_stmt|;
name|struct
name|tm
modifier|*
name|lt
init|=
name|localtime
argument_list|(
operator|&
name|t
argument_list|)
decl_stmt|;
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%02d:%02d:%02d"
argument_list|,
name|lt
operator|->
name|tm_hour
argument_list|,
name|lt
operator|->
name|tm_min
argument_list|,
name|lt
operator|->
name|tm_sec
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'P'
case|:
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%d"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
default|default:
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%%%c"
argument_list|,
operator|*
name|s
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'^'
case|:
operator|++
name|s
expr_stmt|;
if|if
condition|(
name|isalpha
argument_list|(
operator|*
name|s
argument_list|)
condition|)
block|{
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%c"
argument_list|,
name|toupper
argument_list|(
operator|*
name|s
argument_list|)
operator|-
literal|'A'
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%c"
argument_list|,
operator|*
name|s
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|_prompt
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|_prompt
return|;
block|}
end_function

begin_function
name|void
name|noop
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
name|time_t
name|curtime
decl_stmt|,
name|save
decl_stmt|;
name|STATUS
argument_list|(
operator|*
name|func1
argument_list|)
argument_list|()
decl_stmt|,
argument_list|(
operator|*
name|func2
argument_list|)
argument_list|()
decl_stmt|,
argument_list|(
operator|*
name|func3
argument_list|)
argument_list|()
decl_stmt|;
if|if
condition|(
name|noopinterval
operator|==
literal|0
condition|)
return|return;
name|curtime
operator|=
name|time
argument_list|(
operator|(
name|time_t
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|noop
argument_list|)
expr_stmt|;
if|if
condition|(
name|prevtime
operator|==
literal|0
condition|)
block|{
name|prevtime
operator|=
name|curtime
expr_stmt|;
name|alarm
argument_list|(
name|noopinterval
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|curtime
operator|-
name|prevtime
operator|<
name|noopinterval
condition|)
block|{
name|alarm
argument_list|(
name|prevtime
operator|+
name|noopinterval
operator|-
name|curtime
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"Waiting..."
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFRAMES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ftp
index|[
name|i
index|]
operator|==
name|NULL
operator|||
name|FTPCMD
argument_list|(
name|ftp
index|[
name|i
index|]
argument_list|)
operator|==
name|NULL
operator|||
name|iftp
index|[
name|i
index|]
operator|.
name|lock
condition|)
continue|continue;
name|func1
operator|=
name|ftp
index|[
name|i
index|]
operator|->
name|debug
expr_stmt|;
name|ftp
index|[
name|i
index|]
operator|->
name|debug
operator|=
name|NULL
expr_stmt|;
name|func2
operator|=
name|ftp
index|[
name|i
index|]
operator|->
name|error
expr_stmt|;
name|ftp
index|[
name|i
index|]
operator|->
name|error
operator|=
name|NULL
expr_stmt|;
name|func3
operator|=
name|ftp
index|[
name|i
index|]
operator|->
name|IO
expr_stmt|;
name|ftp
index|[
name|i
index|]
operator|->
name|IO
operator|=
name|NULL
expr_stmt|;
name|save
operator|=
name|ftp
index|[
name|i
index|]
operator|->
name|timeout
operator|.
name|tv_sec
expr_stmt|;
name|ftp
index|[
name|i
index|]
operator|->
name|timeout
operator|.
name|tv_sec
operator|=
name|nooptimeout
expr_stmt|;
name|FtpCommand
argument_list|(
name|ftp
index|[
name|i
index|]
argument_list|,
literal|"NOOP"
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
name|EOF
argument_list|)
expr_stmt|;
name|ftp
index|[
name|i
index|]
operator|->
name|timeout
operator|.
name|tv_sec
operator|=
name|save
expr_stmt|;
name|ftp
index|[
name|i
index|]
operator|->
name|debug
operator|=
name|func1
expr_stmt|;
name|ftp
index|[
name|i
index|]
operator|->
name|error
operator|=
name|func1
expr_stmt|;
name|ftp
index|[
name|i
index|]
operator|->
name|IO
operator|=
name|func1
expr_stmt|;
block|}
name|alarm
argument_list|(
name|noopinterval
argument_list|)
expr_stmt|;
name|prevtime
operator|=
name|curtime
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
name|putchar
argument_list|(
literal|8
argument_list|)
operator|,
name|putchar
argument_list|(
literal|' '
argument_list|)
operator|,
name|putchar
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|setsignals
argument_list|()
end_macro

begin_block
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|intr
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|intr
argument_list|)
expr_stmt|;
name|noop
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|unsetsignals
argument_list|()
end_macro

begin_block
block|{
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|int
name|myhash
parameter_list|(
name|FTP
modifier|*
name|ftp
parameter_list|,
name|unsigned
name|int
name|chars
parameter_list|)
block|{
if|if
condition|(
name|hashmode
condition|)
block|{
if|if
condition|(
name|chars
operator|==
literal|0
condition|)
return|return
name|ftp
operator|->
name|counter
operator|=
literal|0
return|;
name|ftp
operator|->
name|counter
operator|+=
name|chars
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%10u bytes transfered\r"
argument_list|,
name|ftp
operator|->
name|counter
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|lastcmd
condition|)
block|{
name|noop
argument_list|()
expr_stmt|;
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|makefilename
parameter_list|(
name|char
modifier|*
name|f1
parameter_list|,
name|char
modifier|*
name|f2
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|*
name|f2
operator|!=
literal|0
condition|)
return|return
name|f2
return|;
if|if
condition|(
operator|(
name|p
operator|=
name|strrchr
argument_list|(
name|f1
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
return|return
name|p
operator|+
literal|1
return|;
return|return
name|f1
return|;
block|}
end_function

begin_macro
name|redir
argument_list|(
argument|char *cmdline
argument_list|)
end_macro

begin_block
block|{
name|char
modifier|*
name|p
init|=
name|cmdline
decl_stmt|;
name|String
name|result
decl_stmt|;
name|char
modifier|*
name|r
init|=
name|result
decl_stmt|;
for|for
control|(
init|;
operator|*
name|p
condition|;
name|p
operator|++
operator|,
name|r
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|'\\'
condition|)
block|{
operator|*
name|r
operator|=
operator|*
operator|++
name|p
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|*
name|p
operator|==
literal|'>'
operator|||
operator|*
name|p
operator|==
literal|'<'
condition|)
block|{
name|String
name|filename
decl_stmt|;
name|char
modifier|*
name|q
init|=
name|filename
decl_stmt|;
name|char
name|c
init|=
operator|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|++
init|;
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
operator|&&
operator|*
name|p
operator|!=
literal|0
condition|;
name|p
operator|++
control|)
empty_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'"'
condition|)
block|{
for|for
control|(
name|p
operator|++
init|;
operator|*
name|p
operator|!=
literal|'"'
operator|&&
operator|*
name|p
operator|!=
literal|0
condition|;
name|p
operator|++
operator|,
name|q
operator|++
control|)
operator|*
name|q
operator|=
operator|*
name|p
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
literal|'"'
condition|)
name|p
operator|++
expr_stmt|;
block|}
else|else
for|for
control|(
init|;
operator|!
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
operator|&&
operator|*
name|p
operator|!=
literal|0
condition|;
name|p
operator|++
operator|,
name|q
operator|++
control|)
operator|*
name|q
operator|=
operator|*
name|p
expr_stmt|;
operator|*
name|q
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'>'
condition|)
name|output
argument_list|(
name|filename
argument_list|)
expr_stmt|;
else|else
name|input
argument_list|(
name|filename
argument_list|)
expr_stmt|;
block|}
operator|*
name|r
operator|=
operator|*
name|p
expr_stmt|;
block|}
operator|*
name|r
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|cmdline
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|int
name|itty
init|=
operator|-
literal|1
decl_stmt|,
name|otty
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|is
init|=
name|NULL
decl_stmt|,
modifier|*
name|os
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_macro
name|input
argument_list|(
argument|char *filename
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
operator|(
name|is
operator|=
name|Ftpfopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
name|fflush
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|itty
operator|=
name|dup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fileno
argument_list|(
name|is
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|output
argument_list|(
argument|char *filename
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
operator|(
name|os
operator|=
name|Ftpfopen
argument_list|(
name|filename
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|otty
operator|=
name|dup
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fileno
argument_list|(
name|os
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|redirback
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|itty
operator|!=
operator|-
literal|1
condition|)
block|{
name|fflush
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|Ftpfclose
argument_list|(
name|is
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|itty
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|is
operator|=
name|NULL
expr_stmt|;
name|itty
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|otty
operator|!=
operator|-
literal|1
condition|)
block|{
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|Ftpfclose
argument_list|(
name|os
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|otty
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|os
operator|=
name|NULL
expr_stmt|;
name|otty
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|batch
argument_list|(
argument|char *filename
argument_list|)
end_macro

begin_block
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|String
name|tmp
decl_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
name|fgets
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
name|tmp
argument_list|,
name|fp
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|tmp
index|[
name|strlen
argument_list|(
name|tmp
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|execute
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
index|[
literal|0
index|]
condition|)
name|add_history
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Library for ftpd clients.(libftp) 			Copyright by Oleg Orel 			 All rights reserved.  This  library is desined  for  free,  non-commercial  software  creation. It is changeable and can be improved. The author would greatly appreciate any  advises, new  components  and  patches  of  the  existing  programs. Commercial  usage is  also  possible  with  participation of it's author.    */
end_comment

begin_decl_stmt
name|char
name|intro
index|[]
init|=
literal|"\ 		    Ftptry - try transfer via FTP.\n\ 		 Copyright by Oleg Orel is Reserved.\n\ \n\ This program is writen using \"libftp\".The main orientation for this\n\ program  is  FTPing  via  bad-working  network. Many network  links are\n\ down-up  switched  and  networks  are  broaken,   so  the  problem  of\n\ transfering  large  files  exists.   The  main   method,  used  by this\n\ software  is  repetition  until  successfull  transfer.  There are some\n\ keys for  setting  repetition and timeout  intervals, modes of transfer\n\ (binary and ascii), types of transfer  (get,put,directory). All options\n\ will be described in usage, if the  program is started without them.\n\ \n\   The libftp you may transfer from host lpuds.oea.ihep.su via ftp-anonymous.\n\   All question are sent to author via e-mail (orel@oea.ihep.su)\n\   "
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|<FtpLibrary.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_define
define|#
directive|define
name|INLINE
value|inline
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|inline
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|FTPTRY
value|"FTPTRY"
end_define

begin_comment
comment|/* The name of enviroment                            variable with default options*/
end_comment

begin_define
define|#
directive|define
name|log
parameter_list|(
name|x
parameter_list|)
value|FtpLog("ftptry",x)
end_define

begin_define
define|#
directive|define
name|DEBUG
parameter_list|(
name|x
parameter_list|)
value|(debug?log(x):0)
end_define

begin_define
define|#
directive|define
name|USERNAME
value|(getenv("USER")==NULL?getenv("LOGNAME"):getenv("USER"))
end_define

begin_define
define|#
directive|define
name|DEFAULT_TIMEOUT
value|600
end_define

begin_enum
enum|enum
name|__type__
block|{
name|ascii
init|=
literal|1
block|,
name|binary
block|}
enum|;
end_enum

begin_enum
enum|enum
name|__mode__
block|{
name|get
init|=
literal|1
block|,
name|put
block|,
name|dir
block|,
name|multiget
block|}
enum|;
end_enum

begin_enum
enum|enum
name|__logmode__
block|{
name|lm_tty
block|,
name|lm_file
block|,
name|lm_mail
block|}
enum|;
end_enum

begin_enum
enum|enum
name|__rcode__
block|{
name|OK_
block|,
name|BREAK_
block|,
name|CANCEL_
block|}
enum|;
end_enum

begin_function_decl
name|char
modifier|*
name|gethost
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|date
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|my_abort
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|my_IO
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|my_debug
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|void
name|done
argument_list|()
decl_stmt|,
name|leave
argument_list|()
decl_stmt|,
name|sighup
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|machine
init|=
literal|"localhost"
decl_stmt|,
modifier|*
name|user
init|=
literal|"anonymous"
decl_stmt|,
modifier|*
name|password
decl_stmt|,
modifier|*
name|localfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|progname
init|=
literal|"ftptry"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|jmp_buf
name|stack
decl_stmt|,
name|trap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|counter
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|String
name|tmp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FTP
modifier|*
name|ftp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|type
init|=
name|ascii
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sleeptime
init|=
literal|600
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|debug
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mode
init|=
name|get
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|logmode
init|=
name|lm_tty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|logfile
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|LIST
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|optind
decl_stmt|,
name|opterr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|String
name|PASSWORD
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Setup enviroment */
end_comment

begin_function
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|out
decl_stmt|,
modifier|*
name|in
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|trap
argument_list|)
operator|!=
literal|0
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|sighup
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTRAP
argument_list|,
name|done
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|done
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|done
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|password
operator|=
name|PASSWORD
argument_list|,
literal|"%s@%s"
argument_list|,
name|USERNAME
argument_list|,
name|gethost
argument_list|()
argument_list|)
expr_stmt|;
name|progname
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|FtpDebug
argument_list|(
operator|&
name|FtpInit
argument_list|)
expr_stmt|;
name|FtpSetErrorHandler
argument_list|(
operator|&
name|FtpInit
argument_list|,
name|my_abort
argument_list|)
expr_stmt|;
name|FtpSetIOHandler
argument_list|(
operator|&
name|FtpInit
argument_list|,
name|my_IO
argument_list|)
expr_stmt|;
name|FtpSetFlag
argument_list|(
operator|&
name|FtpInit
argument_list|,
name|FTP_REST
argument_list|)
expr_stmt|;
name|FtpSetTimeout
argument_list|(
operator|&
name|FtpInit
argument_list|,
name|DEFAULT_TIMEOUT
argument_list|)
expr_stmt|;
name|setoptions
argument_list|()
expr_stmt|;
name|optind
operator|=
literal|1
expr_stmt|;
name|options
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|usage
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|logmode
condition|)
block|{
case|case
name|lm_file
case|:
if|if
condition|(
name|fork
argument_list|()
condition|)
name|quit
argument_list|(
literal|"Deattaching....."
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|logfile
operator|==
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"/tmp/ftptry-%s.XXXXXX"
argument_list|,
name|USERNAME
argument_list|)
expr_stmt|;
name|mktemp
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|logfile
argument_list|)
expr_stmt|;
name|open
argument_list|(
name|tmp
argument_list|,
name|O_TRUNC
operator||
name|O_CREAT
operator||
name|O_WRONLY
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|lm_mail
case|:
if|if
condition|(
name|fork
argument_list|()
condition|)
name|quit
argument_list|(
literal|"Deattaching....."
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|popen
argument_list|(
literal|"/usr/lib/sendmail -t"
argument_list|,
literal|"w"
argument_list|)
operator|==
name|NULL
condition|)
name|perror
argument_list|(
literal|"sendmail"
argument_list|)
operator|,
name|quit
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"From: %s@%s\n"
argument_list|,
name|USERNAME
argument_list|,
name|gethost
argument_list|()
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"To: %s@%s\n"
argument_list|,
name|USERNAME
argument_list|,
name|gethost
argument_list|()
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Subject: ftptry session log\n\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
break|break;
block|}
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|sighup
argument_list|)
expr_stmt|;
if|if
condition|(
name|isatty
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|)
condition|)
name|FtpSetHashHandler
argument_list|(
operator|&
name|FtpInit
argument_list|,
name|FtpHash
argument_list|)
expr_stmt|;
name|loop
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|optind
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|INLINE
name|noargs
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
name|int
name|optind
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|optind
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|argv
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Main loop */
end_comment

begin_macro
name|loop
argument_list|(
argument|int argc
argument_list|,
argument|char **argv
argument_list|,
argument|int optind
comment|/* First args as filename */
argument_list|)
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|,
name|rcode
decl_stmt|;
name|String
name|tmp
decl_stmt|;
name|String
name|machine
decl_stmt|;
name|String
name|filename
decl_stmt|;
name|String
name|localfilename
decl_stmt|;
name|char
modifier|*
name|p1
decl_stmt|;
for|for
control|(
name|i
operator|=
name|optind
init|;
condition|;
operator|(
name|i
operator|==
name|argc
operator|-
literal|1
operator|)
condition|?
name|i
operator|=
name|optind
operator|,
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"Sleeping %d secs"
argument_list|,
name|sleeptime
argument_list|)
operator|,
name|log
argument_list|(
name|tmp
argument_list|)
operator|,
name|sleep
argument_list|(
name|sleeptime
argument_list|)
operator|:
name|i
operator|++
control|)
block|{
if|if
condition|(
name|noargs
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|optind
argument_list|)
condition|)
name|quit
argument_list|(
literal|"Nothing doing"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|':'
argument_list|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|find_archie
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|machine
argument_list|,
name|filename
argument_list|,
name|localfilename
argument_list|)
operator|==
literal|0
condition|)
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|sscanf
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"%[^:]:%s"
argument_list|,
name|machine
argument_list|,
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p1
operator|=
name|strrchr
argument_list|(
name|filename
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|strcpy
argument_list|(
name|localfilename
argument_list|,
name|p1
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|localfilename
argument_list|,
name|filename
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|localfile
operator|==
name|NULL
condition|)
name|localfile
operator|=
name|localfilename
expr_stmt|;
if|if
condition|(
operator|(
name|rcode
operator|=
name|transfer
argument_list|(
name|machine
argument_list|,
name|filename
argument_list|,
name|localfile
argument_list|)
operator|)
operator|==
name|OK_
condition|)
name|DEBUG
argument_list|(
literal|"Transfer complete"
argument_list|)
operator|,
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcode
operator|==
name|CANCEL_
operator|&&
name|strchr
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|':'
argument_list|)
operator|!=
name|NULL
condition|)
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|transfer
argument_list|(
argument|char *machine
argument_list|,
argument|char *file
argument_list|,
argument|char *localfile
argument_list|)
end_macro

begin_block
block|{
name|int
name|r
decl_stmt|;
name|String
name|tmp
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|setjmp
argument_list|(
name|stack
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"Start transfer, machine is %s, remote file is %s, local file is %s"
argument_list|,
name|machine
argument_list|,
name|file
argument_list|,
name|localfile
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|FtpLogin
argument_list|(
operator|&
name|ftp
argument_list|,
name|machine
argument_list|,
name|user
argument_list|,
name|password
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|binary
condition|)
name|FtpBinary
argument_list|(
name|ftp
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|get
case|:
name|FtpRetr
argument_list|(
name|ftp
argument_list|,
literal|"RETR %s"
argument_list|,
name|file
argument_list|,
name|localfile
argument_list|)
expr_stmt|;
break|break;
case|case
name|put
case|:
name|FtpStor
argument_list|(
name|ftp
argument_list|,
literal|"STOR %s"
argument_list|,
name|localfile
argument_list|,
name|file
argument_list|)
expr_stmt|;
break|break;
case|case
name|dir
case|:
name|FtpRetr
argument_list|(
name|ftp
argument_list|,
literal|"LIST %s"
argument_list|,
name|file
argument_list|,
name|localfile
argument_list|)
expr_stmt|;
break|break;
case|case
name|multiget
case|:
name|domultiget
argument_list|(
name|file
argument_list|)
expr_stmt|;
break|break;
block|}
name|FtpBye
argument_list|(
name|ftp
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|"Transfer complete"
argument_list|)
expr_stmt|;
return|return
name|OK_
return|;
block|}
end_block

begin_function
name|void
name|leave
parameter_list|(
name|int
name|code
parameter_list|)
block|{
name|FtpQuickBye
argument_list|(
name|ftp
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|"Leaving transfering"
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|stack
argument_list|,
name|code
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sighup
parameter_list|()
block|{
name|leave
argument_list|(
name|BREAK_
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|quit
argument_list|(
argument|char *s
argument_list|)
end_macro

begin_block
block|{
name|log
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|trap
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|my_IO
argument_list|(
argument|FTP *ftp
argument_list|,
argument|int n
argument_list|,
argument|char *s
argument_list|)
end_macro

begin_block
block|{
name|DEBUG
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|leave
argument_list|(
name|BREAK_
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|my_abort
argument_list|(
argument|FTP *ftp
argument_list|,
argument|int n
argument_list|,
argument|char *s
argument_list|)
end_macro

begin_block
block|{
name|log
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* No access or not found, exclude network or host unreachable */
empty_stmt|;
if|if
condition|(
name|abs
argument_list|(
name|n
argument_list|)
operator|==
literal|550
operator|&&
name|FtpBadReply550
argument_list|(
name|s
argument_list|)
condition|)
name|leave
argument_list|(
name|CANCEL_
argument_list|)
expr_stmt|;
name|leave
argument_list|(
name|BREAK_
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|domultiget
argument_list|(
argument|char *file
argument_list|)
end_macro

begin_block
block|{
name|String
name|list
decl_stmt|,
name|localname
decl_stmt|,
name|tmp_name
decl_stmt|;
name|char
modifier|*
name|p1
decl_stmt|;
name|sprintf
argument_list|(
name|list
argument_list|,
literal|"/tmp/ftptry-%s-multiget.XXXXXX"
argument_list|,
name|USERNAME
argument_list|)
expr_stmt|;
name|mktemp
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|FtpRetr
argument_list|(
name|ftp
argument_list|,
literal|"NLST %s"
argument_list|,
name|file
argument_list|,
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|LIST
operator|=
name|fopen
argument_list|(
name|list
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|quit
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
name|tmp
argument_list|,
name|LIST
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|tmp
index|[
name|strlen
argument_list|(
name|tmp
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|p1
operator|=
name|strrchr
argument_list|(
name|tmp
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|strcpy
argument_list|(
name|localname
argument_list|,
name|p1
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|localname
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
name|localname
argument_list|)
expr_stmt|;
name|FtpGet
argument_list|(
name|ftp
argument_list|,
name|tmp
argument_list|,
name|localname
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|LIST
argument_list|)
expr_stmt|;
name|LIST
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
end_block

begin_macro
name|usage
argument_list|()
end_macro

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\ Usage: %s [optins] [host:file]\n\         (default host \"localhost\",\n\          default file \"README\" or \".\" in directory mode)\n\ \n\ Valid options:\n\ \n\       -u user              default anonymous\n\       -p password          default %s\n\       -P                   inquire password from your terminal\n\       -l local_file        use only if remote and local file differ\n\       -c                   direct output to stdout(like cat)\n\       -r                   reverse mode, i.e. send file to remote host\n\       -d                   directory mode, remote file is patern or \"ls\" options\n\                            default output is stdout.\n\       -G                   multiget mode, file is patern for \"ls\" command\n\                            again at next try.\n\       -b                   binary transfer mode\n\       -s seconds           Retry interval, default 10 minutes\n\       -t seconds           Timeout, default 10 minutes\n\       -D                   Turn on debugging mode\n\       -B                   Run in background and direct output to\n\                            /tmp/ftptry-%s.XXXXXX\n\       -o file              Run in background and direct output\n\                            to file\n\       -m                   Send output to orel via e-mail\n\       -I                   Print short introduction\n\ \n\ Example:\n\       %s  -Dbs 300 garbo.uwasa.fi:ls-lR.Z\n\                    Retrive file ls-lR.Z from garbo.uwasa.fi in binary mode\n\                    trying to reestablish connection every 5 minutes\n\                    on failure. Print debugging information.\n\ \n\       You can set default options to %s enviroment variable\n\ "
argument_list|,
name|progname
argument_list|,
name|password
argument_list|,
name|USERNAME
argument_list|,
name|progname
argument_list|,
name|FTPTRY
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|gethost
parameter_list|()
block|{
specifier|static
name|String
name|tmp
decl_stmt|;
name|String
name|tmp2
decl_stmt|;
name|gethostname
argument_list|(
name|tmp2
argument_list|,
sizeof|sizeof
name|tmp2
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|FtpGetHost
argument_list|(
name|tmp2
argument_list|)
operator|->
name|h_name
argument_list|)
expr_stmt|;
return|return
name|tmp
return|;
block|}
end_function

begin_function
name|void
name|done
parameter_list|(
name|sig
parameter_list|)
block|{
name|String
name|x
decl_stmt|;
name|signal
argument_list|(
name|sig
argument_list|,
name|done
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|x
argument_list|,
literal|"interputed by signal %d"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|x
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|trap
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|options
argument_list|(
argument|int argc
argument_list|,
argument|char **argv
argument_list|)
end_macro

begin_block
block|{
name|char
name|c
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"GOIBDru:p:Pdbs:o:l:t:cm"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'G'
case|:
name|mode
operator|=
name|multiget
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
if|if
condition|(
name|localfile
operator|==
name|NULL
condition|)
name|localfile
operator|=
literal|"*STDOUT*"
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|intro
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
case|case
literal|'r'
case|:
name|mode
operator|=
name|put
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|mode
operator|=
name|dir
expr_stmt|;
if|if
condition|(
name|localfile
operator|==
name|NULL
condition|)
name|localfile
operator|=
literal|"*STDOUT*"
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|FtpSetTimeout
argument_list|(
operator|&
name|FtpInit
argument_list|,
name|atoi
argument_list|(
name|optarg
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|localfile
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|debug
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|user
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|password
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|password
operator|=
operator|(
name|char
operator|*
operator|)
name|getpass
argument_list|(
literal|"Password:"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|type
operator|=
name|binary
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|sleeptime
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|logmode
operator|=
name|lm_file
expr_stmt|;
name|logfile
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|logmode
operator|=
name|lm_mail
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|logmode
operator|=
name|lm_file
expr_stmt|;
name|logfile
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|setoptions
argument_list|()
end_macro

begin_block
block|{
name|String
name|x
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|sp
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[
literal|100
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|getenv
argument_list|(
name|FTPTRY
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|p
operator|!=
literal|0
condition|)
name|strcpy
argument_list|(
name|x
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|else
return|return;
for|for
control|(
name|argv
index|[
literal|0
index|]
operator|=
literal|""
operator|,
name|p
operator|=
name|x
operator|,
name|sp
operator|=
name|x
operator|,
name|argc
operator|=
literal|1
init|;
operator|*
name|p
operator|!=
literal|0
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|' '
condition|)
block|{
operator|*
name|p
operator|=
literal|0
expr_stmt|;
name|argv
index|[
name|argc
operator|++
index|]
operator|=
name|sp
expr_stmt|;
name|sp
operator|=
name|p
operator|+
literal|1
expr_stmt|;
block|}
block|}
name|argv
index|[
name|argc
operator|++
index|]
operator|=
name|sp
expr_stmt|;
name|options
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|INLINE
name|unsigned
name|long
name|maxsize
parameter_list|(
name|String
modifier|*
name|result
parameter_list|,
name|int
name|hops
parameter_list|)
block|{
name|unsigned
name|long
name|maxsiz
init|=
literal|0
decl_stmt|,
name|cursiz
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hops
condition|;
name|i
operator|++
control|)
block|{
name|sscanf
argument_list|(
name|result
index|[
name|i
index|]
argument_list|,
literal|"%*[^ ] %u %*s"
argument_list|,
operator|&
name|cursiz
argument_list|)
expr_stmt|;
if|if
condition|(
name|cursiz
operator|>
name|maxsiz
condition|)
name|maxsiz
operator|=
name|cursiz
expr_stmt|;
block|}
return|return
name|maxsiz
return|;
block|}
end_function

begin_macro
name|find_archie
argument_list|(
argument|char *what
argument_list|,
argument|char *machine
argument_list|,
argument|char *filename
argument_list|,
argument|char *localfilename
argument_list|)
end_macro

begin_block
block|{
define|#
directive|define
name|MAXHOPS
value|15
specifier|static
name|String
name|result
index|[
name|MAXHOPS
index|]
decl_stmt|;
specifier|static
name|int
name|last
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|size
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|first
init|=
literal|0
decl_stmt|;
name|int
name|rnd
decl_stmt|;
specifier|static
name|int
name|init
init|=
literal|0
decl_stmt|;
specifier|static
name|String
name|oldwhat
init|=
block|{
literal|'\0'
block|}
decl_stmt|;
name|char
modifier|*
name|p1
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|init
operator|||
name|strcmp
argument_list|(
name|oldwhat
argument_list|,
name|what
argument_list|)
operator|!=
literal|0
operator|||
name|last
operator|==
literal|0
condition|)
block|{
name|String
name|cmd
decl_stmt|;
name|FILE
modifier|*
name|archie
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXHOPS
condition|;
name|i
operator|++
control|)
name|result
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|sprintf
argument_list|(
name|cmd
argument_list|,
literal|"archie -l -m %d %s"
argument_list|,
name|MAXHOPS
argument_list|,
name|what
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|archie
operator|=
name|popen
argument_list|(
name|cmd
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|quit
argument_list|(
literal|"Archie can't execute"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXHOPS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|result
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|result
index|[
name|i
index|]
argument_list|)
argument_list|,
name|archie
argument_list|)
operator|==
name|NULL
condition|)
break|break;
name|result
index|[
name|i
index|]
index|[
name|strlen
argument_list|(
name|result
index|[
name|i
index|]
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|DEBUG
argument_list|(
name|result
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|last
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|last
operator|==
literal|0
condition|)
block|{
name|DEBUG
argument_list|(
literal|"archie not found need file"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|init
operator|=
literal|1
expr_stmt|;
name|first
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|oldwhat
argument_list|,
name|what
argument_list|)
expr_stmt|;
name|size
operator|=
name|maxsize
argument_list|(
name|result
argument_list|,
name|MAXHOPS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|first
operator|>=
name|last
operator|-
literal|1
condition|)
name|first
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|first
init|;
name|i
operator|<
name|last
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|atoi
argument_list|(
name|strchr
argument_list|(
name|result
index|[
name|i
index|]
argument_list|,
literal|' '
argument_list|)
operator|+
literal|1
argument_list|)
operator|==
name|size
condition|)
block|{
name|first
operator|=
name|i
operator|+
literal|1
expr_stmt|;
break|break;
block|}
name|DEBUG
argument_list|(
literal|"Archie select is ... (see next line)"
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
name|result
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|result
index|[
name|i
index|]
argument_list|,
literal|"%*[^ ] %*[^ ] %[^ ] %s"
argument_list|,
name|machine
argument_list|,
name|filename
argument_list|)
operator|!=
literal|2
condition|)
block|{
name|DEBUG
argument_list|(
literal|"Bad archie output format"
argument_list|)
expr_stmt|;
name|last
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|p1
operator|=
name|strrchr
argument_list|(
name|filename
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|strcpy
argument_list|(
name|localfilename
argument_list|,
name|p1
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|localfilename
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

end_unit


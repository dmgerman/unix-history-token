begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*		      Library for ftpd clients.(libftp) 			Copyright by Oleg Orel 			 All rights reserved. 			 This  library is desined  for  free,  non-commercial  software  creation.  It is changeable and can be improved. The author would greatly appreciate  any  advises, new  components  and  patches  of  the  exist ing  programs. Commercial  usage is  also  possible  with  participation of it's author.    */
end_comment

begin_include
include|#
directive|include
file|"FtpLibrary.h"
end_include

begin_function
name|int
name|FtpRead
parameter_list|(
name|FTP
modifier|*
name|con
parameter_list|)
block|{
name|int
name|c
decl_stmt|;
if|if
condition|(
name|con
operator|->
name|mode
operator|==
literal|'I'
condition|)
return|return
name|FtpGetc
argument_list|(
name|con
argument_list|,
name|FTPDATA
argument_list|(
name|con
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|con
operator|->
name|ch
operator|!=
name|EOF
condition|)
block|{
name|c
operator|=
name|con
operator|->
name|ch
expr_stmt|;
name|con
operator|->
name|ch
operator|=
name|EOF
expr_stmt|;
return|return
name|c
return|;
block|}
name|c
operator|=
name|FtpGetc
argument_list|(
name|con
argument_list|,
name|FTPDATA
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|Ctrl
argument_list|(
literal|'M'
argument_list|)
condition|)
block|{
name|c
operator|=
name|FtpGetc
argument_list|(
name|con
argument_list|,
name|FTPDATA
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|Ctrl
argument_list|(
literal|'J'
argument_list|)
condition|)
return|return
literal|'\n'
return|;
name|con
operator|->
name|ch
operator|=
name|c
expr_stmt|;
return|return
name|Ctrl
argument_list|(
literal|'M'
argument_list|)
return|;
block|}
return|return
name|c
return|;
block|}
end_function

begin_function
name|int
name|FtpWrite
parameter_list|(
name|FTP
modifier|*
name|ftp
parameter_list|,
name|char
name|c
parameter_list|)
block|{
if|if
condition|(
name|ftp
operator|->
name|mode
operator|==
literal|'I'
operator|||
name|c
operator|!=
literal|'\n'
condition|)
return|return
name|FtpPutc
argument_list|(
name|ftp
argument_list|,
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
argument_list|,
name|c
argument_list|)
return|;
name|FtpPutc
argument_list|(
name|ftp
argument_list|,
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
argument_list|,
name|Ctrl
argument_list|(
literal|'M'
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|FtpPutc
argument_list|(
name|ftp
argument_list|,
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
argument_list|,
name|Ctrl
argument_list|(
literal|'J'
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|FtpGetc
parameter_list|(
name|FTP
modifier|*
name|ftp
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|fd_set
name|fds
decl_stmt|;
name|char
name|c
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|fp
argument_list|)
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|getdtablesize
argument_list|()
argument_list|,
operator|&
name|fds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
operator|(
name|ftp
operator|->
name|timeout
operator|)
argument_list|)
operator|<
literal|1
condition|)
return|return
name|EXIT
argument_list|(
name|ftp
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
name|read
argument_list|(
name|fileno
argument_list|(
name|fp
argument_list|)
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
operator|<
literal|1
condition|)
return|return
name|EOF
return|;
if|if
condition|(
name|ftp
operator|->
name|hash
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|ftp
operator|->
name|hash
call|)
argument_list|(
name|ftp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|int
operator|)
name|c
return|;
block|}
end_function

begin_function
name|STATUS
name|FtpPutc
parameter_list|(
name|FTP
modifier|*
name|ftp
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|char
name|c
parameter_list|)
block|{
name|fd_set
name|fds
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|fp
argument_list|)
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|getdtablesize
argument_list|()
argument_list|,
literal|0
argument_list|,
operator|&
name|fds
argument_list|,
literal|0
argument_list|,
operator|&
operator|(
name|ftp
operator|->
name|timeout
operator|)
argument_list|)
operator|<
literal|1
condition|)
return|return
name|EXIT
argument_list|(
name|ftp
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
name|write
argument_list|(
name|fileno
argument_list|(
name|fp
argument_list|)
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
return|return
name|EXIT
argument_list|(
name|ftp
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
name|ftp
operator|->
name|hash
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|ftp
operator|->
name|hash
call|)
argument_list|(
name|ftp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|STATUS
name|FtpReadBlock
parameter_list|(
name|FTP
modifier|*
name|ftp
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|fd_set
name|fds
decl_stmt|;
specifier|register
name|int
name|rsize
decl_stmt|,
name|status
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
argument_list|)
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|getdtablesize
argument_list|()
argument_list|,
operator|&
name|fds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
operator|(
name|ftp
operator|->
name|timeout
operator|)
argument_list|)
operator|<
literal|1
condition|)
return|return
name|EXIT
argument_list|(
name|ftp
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
operator|(
name|rsize
operator|=
name|read
argument_list|(
name|fileno
argument_list|(
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
argument_list|)
argument_list|,
name|buffer
argument_list|,
name|size
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|EXIT
argument_list|(
name|ftp
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
name|ftp
operator|->
name|hash
operator|!=
name|NULL
operator|&&
name|rsize
operator|!=
literal|0
condition|)
call|(
modifier|*
name|ftp
operator|->
name|hash
call|)
argument_list|(
name|ftp
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ftp
operator|->
name|mode
operator|==
literal|'A'
condition|)
block|{
name|char
name|buffer2
index|[
name|size
index|]
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|ii
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|ii
operator|=
literal|0
init|;
name|i
operator|<
name|rsize
condition|;
name|i
operator|++
operator|,
name|ii
operator|++
control|)
if|if
condition|(
name|buffer
index|[
name|i
index|]
operator|==
name|Ctrl
argument_list|(
literal|'M'
argument_list|)
operator|&&
name|buffer
index|[
name|i
operator|+
literal|1
index|]
operator|==
name|Ctrl
argument_list|(
literal|'J'
argument_list|)
condition|)
name|buffer2
index|[
name|ii
index|]
operator|=
literal|'\n'
operator|,
name|i
operator|++
expr_stmt|;
else|else
name|buffer2
index|[
name|ii
index|]
operator|=
name|buffer
index|[
name|i
index|]
expr_stmt|;
name|rsize
operator|=
name|ii
expr_stmt|;
name|bcopy
argument_list|(
name|buffer2
argument_list|,
name|buffer
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
block|}
return|return
name|rsize
return|;
block|}
end_function

begin_function
name|STATUS
name|FtpWriteBlock
parameter_list|(
name|FTP
modifier|*
name|ftp
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|fd_set
name|fds
decl_stmt|;
specifier|register
name|int
name|wsize
decl_stmt|;
name|char
name|buffer2
index|[
name|size
operator|*
literal|2
index|]
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
argument_list|)
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|getdtablesize
argument_list|()
argument_list|,
literal|0
argument_list|,
operator|&
name|fds
argument_list|,
literal|0
argument_list|,
operator|&
operator|(
name|ftp
operator|->
name|timeout
operator|)
argument_list|)
operator|<
literal|1
condition|)
return|return
name|EXIT
argument_list|(
name|ftp
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
name|ftp
operator|->
name|mode
operator|==
literal|'A'
condition|)
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|ii
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|ii
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
operator|,
name|ii
operator|++
control|)
if|if
condition|(
name|buffer
index|[
name|i
index|]
operator|==
literal|'\n'
condition|)
name|buffer2
index|[
name|ii
operator|++
index|]
operator|=
name|Ctrl
argument_list|(
literal|'M'
argument_list|)
operator|,
name|buffer2
index|[
name|ii
index|]
operator|=
name|Ctrl
argument_list|(
literal|'J'
argument_list|)
expr_stmt|;
else|else
name|buffer2
index|[
name|ii
index|]
operator|=
name|buffer
index|[
name|i
index|]
expr_stmt|;
name|buffer
operator|=
name|buffer2
expr_stmt|;
name|size
operator|=
name|ii
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|wsize
operator|=
name|write
argument_list|(
name|fileno
argument_list|(
name|FTPDATA
argument_list|(
name|ftp
argument_list|)
argument_list|)
argument_list|,
name|buffer
argument_list|,
name|size
argument_list|)
operator|)
operator|!=
name|size
condition|)
return|return
name|EXIT
argument_list|(
name|ftp
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
name|ftp
operator|->
name|hash
operator|!=
name|NULL
operator|&&
name|wsize
operator|!=
literal|0
condition|)
call|(
modifier|*
name|ftp
operator|->
name|hash
call|)
argument_list|(
name|ftp
argument_list|,
name|wsize
argument_list|)
expr_stmt|;
return|return
name|wsize
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*		      Library for ftpd clients.(libftp) 			Copyright by Oleg Orel 			 All rights reserved. 			 This  library is desined  for  free,  non-commercial  software  creation.  It is changeable and can be improved. The author would greatly appreciate  any  advises, new  components  and  patches  of  the  exist ing  programs. Commercial  usage is  also  possible  with  participation of it's author.    */
end_comment

begin_include
include|#
directive|include
file|"FtpLibrary.h"
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_function
name|char
modifier|*
name|FtpPasv
parameter_list|(
name|FTP
modifier|*
name|ftp
parameter_list|)
block|{
name|char
modifier|*
name|msg
decl_stmt|;
name|String
name|PORT
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|PORT
decl_stmt|;
if|if FtpError
condition|(
name|FtpCommand
argument_list|(
name|ftp
argument_list|,
literal|"PASV"
argument_list|,
literal|""
argument_list|,
literal|227
argument_list|,
name|EOF
argument_list|)
condition|)
return|return
literal|""
return|;
name|msg
operator|=
name|FtpMessage
argument_list|(
literal|227
argument_list|)
expr_stmt|;
name|msg
operator|+=
literal|3
expr_stmt|;
while|while
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|msg
operator|++
argument_list|)
condition|)
empty_stmt|;
name|msg
operator|--
expr_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
name|msg
argument_list|)
operator|||
operator|*
name|msg
operator|==
literal|','
condition|)
operator|*
name|p
operator|++
operator|=
operator|*
name|msg
operator|++
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
return|return
name|PORT
return|;
block|}
end_function

begin_function
name|STATUS
name|FtpLink
parameter_list|(
name|FTP
modifier|*
name|ftp1
parameter_list|,
name|FTP
modifier|*
name|ftp2
parameter_list|)
block|{
name|String
name|PORT
decl_stmt|;
name|strcpy
argument_list|(
name|PORT
argument_list|,
name|FtpPasv
argument_list|(
name|ftp1
argument_list|)
argument_list|)
expr_stmt|;
name|FtpCommand
argument_list|(
name|ftp2
argument_list|,
literal|"PORT %s"
argument_list|,
name|PORT
argument_list|,
literal|200
argument_list|,
name|EOF
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|STATUS
name|FtpPassiveTransfer
parameter_list|(
name|FTP
modifier|*
name|ftp1
parameter_list|,
name|FTP
modifier|*
name|ftp2
parameter_list|,
name|char
modifier|*
name|f1
parameter_list|,
name|char
modifier|*
name|f2
parameter_list|)
block|{
name|String
name|tmp
decl_stmt|;
name|fd_set
name|fds
decl_stmt|;
name|FtpAssert
argument_list|(
name|ftp1
argument_list|,
name|FtpLink
argument_list|(
name|ftp1
argument_list|,
name|ftp2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|f2
condition|)
name|f2
operator|=
name|f1
expr_stmt|;
name|FtpAssert
argument_list|(
name|ftp2
argument_list|,
name|FtpCommand
argument_list|(
name|ftp2
argument_list|,
literal|"STOR %s"
argument_list|,
name|f2
argument_list|,
literal|200
argument_list|,
literal|120
argument_list|,
literal|150
argument_list|,
literal|125
argument_list|,
literal|250
argument_list|,
name|EOF
argument_list|)
argument_list|)
expr_stmt|;
name|FtpAssert
argument_list|(
name|ftp1
argument_list|,
name|FtpCommand
argument_list|(
name|ftp1
argument_list|,
literal|"RETR %s"
argument_list|,
name|f1
argument_list|,
literal|200
argument_list|,
literal|120
argument_list|,
literal|150
argument_list|,
literal|125
argument_list|,
literal|250
argument_list|,
name|EOF
argument_list|)
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|FTPCMD
argument_list|(
name|ftp1
argument_list|)
argument_list|)
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|FTPCMD
argument_list|(
name|ftp2
argument_list|)
argument_list|)
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|getdtablesize
argument_list|()
argument_list|,
operator|&
name|fds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|ftp1
operator|->
name|error
operator|!=
name|NULL
condition|)
return|return
operator|(
operator|*
operator|(
name|ftp1
operator|->
name|error
operator|)
operator|)
operator|(
name|ftp1
operator|,
name|QUIT
operator|,
name|sys_errlist
index|[
name|errno
index|]
operator|)
return|;
if|if
condition|(
name|ftp2
operator|->
name|error
operator|!=
name|NULL
condition|)
return|return
operator|(
operator|*
operator|(
name|ftp2
operator|->
name|error
operator|)
operator|)
operator|(
name|ftp1
operator|,
name|QUIT
operator|,
name|sys_errlist
index|[
name|errno
index|]
operator|)
return|;
return|return
name|QUIT
return|;
block|}
if|if
condition|(
name|FD_ISSET
argument_list|(
name|fileno
argument_list|(
name|FTPCMD
argument_list|(
name|ftp1
argument_list|)
argument_list|)
argument_list|,
operator|&
name|fds
argument_list|)
condition|)
block|{
name|FtpGetMessage
argument_list|(
name|ftp1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|FtpLog
argument_list|(
name|ftp1
operator|->
name|title
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|FtpGetMessage
argument_list|(
name|ftp2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|FtpLog
argument_list|(
name|ftp2
operator|->
name|title
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|FtpGetMessage
argument_list|(
name|ftp2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|FtpLog
argument_list|(
name|ftp2
operator|->
name|title
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|FtpGetMessage
argument_list|(
name|ftp1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|FtpLog
argument_list|(
name|ftp1
operator|->
name|title
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


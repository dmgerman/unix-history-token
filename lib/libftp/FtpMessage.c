begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* 		      Library for ftpd clients.(libftp) 			Copyright by Oleg Orel 			 All rights reserved. 			 This  library is desined  for  free,  non-commercial  software  creation.  It is changeable and can be improved. The author would greatly appreciate  any  advises, new  components  and  patches  of  the  existing  programs. Commercial  usage is  also  possible  with  participation of it's author.    */
end_comment

begin_include
include|#
directive|include
file|"FtpLibrary.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_decl_stmt
specifier|static
name|char
modifier|*
name|FtpMessageList
index|[
literal|1000
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|INLINE
specifier|static
name|char
modifier|*
name|___gets
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|int
name|maxchars
parameter_list|,
name|FTP
modifier|*
name|ftp
parameter_list|)
block|{
name|char
modifier|*
name|p
init|=
name|s
decl_stmt|;
name|int
name|c
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|FtpGetc
argument_list|(
name|ftp
argument_list|,
name|FTPCMD
argument_list|(
name|ftp
argument_list|)
argument_list|)
operator|)
operator|==
name|EOF
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|c
operator|==
literal|'\n'
operator|&&
operator|*
operator|(
name|p
operator|-
literal|1
operator|)
operator|==
literal|'\r'
condition|)
block|{
name|p
operator|--
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
return|return
name|s
return|;
block|}
if|if
condition|(
operator|(
name|p
operator|-
name|s
operator|)
operator|>
name|maxchars
condition|)
return|return
name|NULL
return|;
operator|*
name|p
operator|++
operator|=
operator|(
name|char
operator|)
name|c
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|FtpGetMessage
parameter_list|(
name|FTP
modifier|*
name|con
parameter_list|,
name|char
modifier|*
name|Message
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|char
name|tmp
index|[
literal|1024
index|]
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|___gets
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
name|tmp
argument_list|,
name|con
argument_list|)
operator|==
name|NULL
condition|)
return|return
name|EXIT
argument_list|(
name|con
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
name|isdigit
argument_list|(
name|tmp
index|[
literal|0
index|]
argument_list|)
operator|&&
name|isdigit
argument_list|(
name|tmp
index|[
literal|1
index|]
argument_list|)
operator|&&
name|isdigit
argument_list|(
name|tmp
index|[
literal|2
index|]
argument_list|)
operator|&&
name|tmp
index|[
literal|3
index|]
operator|!=
literal|'-'
condition|)
break|break;
if|if
condition|(
name|con
operator|->
name|debug
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|con
operator|->
name|debug
call|)
argument_list|(
name|con
argument_list|,
literal|0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|Message
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|FtpInitMessageList
argument_list|()
expr_stmt|;
name|FtpMessageList
index|[
name|n
operator|=
name|FtpNumber
argument_list|(
name|Message
argument_list|)
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|Message
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|FtpMessageList
index|[
name|n
index|]
argument_list|,
name|Message
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|debug
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|con
operator|->
name|debug
call|)
argument_list|(
name|con
argument_list|,
name|n
argument_list|,
name|Message
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
name|STATUS
name|FtpSendMessage
parameter_list|(
name|FTP
modifier|*
name|ftp
parameter_list|,
name|char
modifier|*
name|Message
parameter_list|)
block|{
name|char
modifier|*
name|msg
init|=
name|Message
decl_stmt|;
while|while
condition|(
operator|*
name|Message
condition|)
name|FtpAssert
argument_list|(
name|ftp
argument_list|,
name|FtpPutc
argument_list|(
name|ftp
argument_list|,
name|FTPCMD
argument_list|(
name|ftp
argument_list|)
argument_list|,
operator|*
name|Message
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|FtpAssert
argument_list|(
name|ftp
argument_list|,
name|FtpPutc
argument_list|(
name|ftp
argument_list|,
name|FTPCMD
argument_list|(
name|ftp
argument_list|)
argument_list|,
literal|'\015'
argument_list|)
argument_list|)
expr_stmt|;
name|FtpAssert
argument_list|(
name|ftp
argument_list|,
name|FtpPutc
argument_list|(
name|ftp
argument_list|,
name|FTPCMD
argument_list|(
name|ftp
argument_list|)
argument_list|,
literal|'\012'
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ftp
operator|->
name|debug
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|ftp
operator|->
name|debug
call|)
argument_list|(
name|ftp
argument_list|,
literal|0
argument_list|,
name|msg
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|FtpMessage
parameter_list|(
name|int
name|number
parameter_list|)
block|{
specifier|extern
name|int
name|sys_nerr
decl_stmt|,
name|errno
decl_stmt|;
ifndef|#
directive|ifndef
name|__FreeBSD__
specifier|extern
name|char
modifier|*
name|sys_errlist
index|[]
decl_stmt|;
endif|#
directive|endif
name|FtpInitMessageList
argument_list|()
expr_stmt|;
if|if
condition|(
name|number
operator|==
literal|0
condition|)
return|return
operator|(
name|char
operator|*
operator|)
name|sys_errlist
index|[
name|errno
index|]
return|;
return|return
operator|(
name|FtpMessageList
index|[
name|abs
argument_list|(
name|number
argument_list|)
index|]
operator|==
name|NULL
operator|)
condition|?
literal|""
else|:
name|FtpMessageList
index|[
name|abs
argument_list|(
name|number
argument_list|)
index|]
return|;
block|}
end_function

begin_function
name|STATUS
name|FtpInitMessageList
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
specifier|static
name|u
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|u
condition|)
return|return
literal|1
return|;
name|u
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1000
condition|;
name|i
operator|++
control|)
name|FtpMessageList
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|FtpNumber
parameter_list|(
name|char
modifier|*
name|Message
parameter_list|)
block|{
return|return
operator|(
name|Message
index|[
literal|0
index|]
operator|-
literal|'0'
operator|)
operator|*
literal|100
operator|+
operator|(
name|Message
index|[
literal|1
index|]
operator|-
literal|'0'
operator|)
operator|*
literal|10
operator|+
operator|(
name|Message
index|[
literal|2
index|]
operator|-
literal|'0'
operator|)
return|;
block|}
end_function

end_unit


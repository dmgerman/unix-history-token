begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* 		      Library for ftpd clients.(libftp) 			Copyright by Oleg Orel 			 All rights reserved. 			 This  library is desined  for  free,  non-commercial  software  creation.  It is changeable and can be improved. The author would greatly appreciate  any  advises, new  components  and  patches  of  the  existing  programs. Commercial  usage is  also  possible  with  participation of it's author.    */
end_comment

begin_include
include|#
directive|include
file|"FtpLibrary.h"
end_include

begin_function
name|STATUS
name|FtpConnect
parameter_list|(
name|FTP
modifier|*
modifier|*
name|con
parameter_list|,
name|char
modifier|*
name|hostname
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|unit
decl_stmt|;
specifier|register
name|struct
name|hostent
modifier|*
name|host
decl_stmt|;
specifier|register
name|int
name|new_socket
decl_stmt|;
name|String
name|S1
decl_stmt|;
name|STATUS
name|x
decl_stmt|;
operator|*
name|con
operator|=
name|FtpCreateObject
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|host
operator|=
name|FtpGetHost
argument_list|(
name|hostname
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|EXIT
argument_list|(
operator|(
operator|*
name|con
operator|)
argument_list|,
name|QUIT
argument_list|)
return|;
name|strcpy
argument_list|(
operator|(
operator|*
name|con
operator|)
operator|->
name|title
argument_list|,
name|host
operator|->
name|h_name
argument_list|)
expr_stmt|;
comment|/* Default title for FtpLog */
name|unit
operator|.
name|sin_family
operator|=
name|host
operator|->
name|h_addrtype
expr_stmt|;
comment|/* AF_INET */
name|bcopy
argument_list|(
name|host
operator|->
name|h_addr_list
index|[
literal|0
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|unit
operator|.
name|sin_addr
argument_list|,
name|host
operator|->
name|h_length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new_socket
operator|=
name|socket
argument_list|(
name|unit
operator|.
name|sin_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|EXIT
argument_list|(
operator|(
operator|*
name|con
operator|)
argument_list|,
name|QUIT
argument_list|)
return|;
name|unit
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
operator|(
operator|*
name|con
operator|)
operator|->
name|port
argument_list|)
expr_stmt|;
while|while
condition|(
name|connect
argument_list|(
name|new_socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|unit
argument_list|,
sizeof|sizeof
name|unit
argument_list|)
operator|<
literal|0
condition|)
block|{
name|host
operator|->
name|h_addr_list
operator|++
expr_stmt|;
if|if
condition|(
name|host
operator|->
name|h_addr_list
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
block|{
name|close
argument_list|(
name|new_socket
argument_list|)
expr_stmt|;
return|return
name|EXIT
argument_list|(
operator|(
operator|*
name|con
operator|)
argument_list|,
name|QUIT
argument_list|)
return|;
block|}
name|bcopy
argument_list|(
name|host
operator|->
name|h_addr_list
index|[
literal|0
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|unit
argument_list|,
name|host
operator|->
name|h_length
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|new_socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new_socket
operator|=
name|socket
argument_list|(
name|unit
operator|.
name|sin_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|close
argument_list|(
name|new_socket
argument_list|)
expr_stmt|;
return|return
name|EXIT
argument_list|(
operator|(
operator|*
name|con
operator|)
argument_list|,
name|QUIT
argument_list|)
return|;
block|}
block|}
name|FTPCMD
argument_list|(
operator|*
name|con
argument_list|)
operator|=
name|fdopen
argument_list|(
name|new_socket
argument_list|,
literal|"r+"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|=
name|FtpGetMessage
argument_list|(
operator|*
name|con
argument_list|,
name|S1
argument_list|)
operator|)
operator|==
name|QUIT
condition|)
return|return
name|EXIT
argument_list|(
operator|(
operator|*
name|con
operator|)
argument_list|,
name|QUIT
argument_list|)
return|;
if|if
condition|(
operator|!
name|FtpGood
argument_list|(
name|x
argument_list|,
literal|120
argument_list|,
literal|220
argument_list|,
name|EOF
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|new_socket
argument_list|)
expr_stmt|;
return|return
name|EXIT
argument_list|(
operator|(
operator|*
name|con
operator|)
argument_list|,
operator|-
name|x
argument_list|)
return|;
block|}
if|if
condition|(
operator|(
operator|*
name|con
operator|)
operator|->
name|mode
operator|!=
literal|'A'
condition|)
name|FtpType
argument_list|(
operator|*
name|con
argument_list|,
operator|(
operator|*
name|con
operator|)
operator|->
name|mode
argument_list|)
expr_stmt|;
return|return
name|EXIT
argument_list|(
operator|(
operator|*
name|con
operator|)
argument_list|,
name|x
argument_list|)
return|;
block|}
end_function

end_unit


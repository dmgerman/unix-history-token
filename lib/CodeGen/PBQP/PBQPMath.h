begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//===-- PBQPMath.h - PBQP Vector and Matrix classes -------------*- C++ -*-===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|LLVM_CODEGEN_PBQP_PBQPMATH_H
end_ifndef

begin_define
define|#
directive|define
name|LLVM_CODEGEN_PBQP_PBQPMATH_H
end_define

begin_include
include|#
directive|include
file|<cassert>
end_include

begin_include
include|#
directive|include
file|<algorithm>
end_include

begin_include
include|#
directive|include
file|<functional>
end_include

begin_decl_stmt
name|namespace
name|PBQP
block|{
typedef|typedef
name|double
name|PBQPNum
typedef|;
comment|/// \brief PBQP Vector class.
name|class
name|Vector
block|{
name|public
label|:
comment|/// \brief Construct a PBQP vector of the given size.
name|explicit
name|Vector
argument_list|(
argument|unsigned length
argument_list|)
block|:
name|length
argument_list|(
name|length
argument_list|)
operator|,
name|data
argument_list|(
argument|new PBQPNum[length]
argument_list|)
block|{       }
comment|/// \brief Construct a PBQP vector with initializer.
name|Vector
argument_list|(
argument|unsigned length
argument_list|,
argument|PBQPNum initVal
argument_list|)
operator|:
name|length
argument_list|(
name|length
argument_list|)
operator|,
name|data
argument_list|(
argument|new PBQPNum[length]
argument_list|)
block|{
name|std
operator|::
name|fill
argument_list|(
name|data
argument_list|,
name|data
operator|+
name|length
argument_list|,
name|initVal
argument_list|)
block|;       }
comment|/// \brief Copy construct a PBQP vector.
name|Vector
argument_list|(
specifier|const
name|Vector
operator|&
name|v
argument_list|)
operator|:
name|length
argument_list|(
name|v
operator|.
name|length
argument_list|)
operator|,
name|data
argument_list|(
argument|new PBQPNum[length]
argument_list|)
block|{
name|std
operator|::
name|copy
argument_list|(
name|v
operator|.
name|data
argument_list|,
name|v
operator|.
name|data
operator|+
name|length
argument_list|,
name|data
argument_list|)
block|;       }
comment|/// \brief Destroy this vector, return its memory.
operator|~
name|Vector
argument_list|()
block|{
name|delete
index|[]
name|data
block|; }
comment|/// \brief Assignment operator.
name|Vector
operator|&
name|operator
operator|=
operator|(
specifier|const
name|Vector
operator|&
name|v
operator|)
block|{
name|delete
index|[]
name|data
block|;
name|length
operator|=
name|v
operator|.
name|length
block|;
name|data
operator|=
name|new
name|PBQPNum
index|[
name|length
index|]
block|;
name|std
operator|::
name|copy
argument_list|(
name|v
operator|.
name|data
argument_list|,
name|v
operator|.
name|data
operator|+
name|length
argument_list|,
name|data
argument_list|)
block|;
return|return
operator|*
name|this
return|;
block|}
comment|/// \brief Return the length of the vector
name|unsigned
name|getLength
argument_list|()
specifier|const
block|{
return|return
name|length
return|;
block|}
comment|/// \brief Element access.
name|PBQPNum
modifier|&
name|operator
function|[]
parameter_list|(
name|unsigned
name|index
parameter_list|)
block|{
name|assert
argument_list|(
name|index
operator|<
name|length
operator|&&
literal|"Vector element access out of bounds."
argument_list|)
expr_stmt|;
return|return
name|data
index|[
name|index
index|]
return|;
block|}
comment|/// \brief Const element access.
specifier|const
name|PBQPNum
modifier|&
name|operator
index|[]
argument_list|(
name|unsigned
name|index
argument_list|)
decl|const
block|{
name|assert
argument_list|(
name|index
operator|<
name|length
operator|&&
literal|"Vector element access out of bounds."
argument_list|)
expr_stmt|;
return|return
name|data
index|[
name|index
index|]
return|;
block|}
comment|/// \brief Add another vector to this one.
name|Vector
operator|&
name|operator
operator|+=
operator|(
specifier|const
name|Vector
operator|&
name|v
operator|)
block|{
name|assert
argument_list|(
name|length
operator|==
name|v
operator|.
name|length
operator|&&
literal|"Vector length mismatch."
argument_list|)
block|;
name|std
operator|::
name|transform
argument_list|(
name|data
argument_list|,
name|data
operator|+
name|length
argument_list|,
name|v
operator|.
name|data
argument_list|,
name|data
argument_list|,
name|std
operator|::
name|plus
operator|<
name|PBQPNum
operator|>
operator|(
operator|)
argument_list|)
block|;
return|return
operator|*
name|this
return|;
block|}
comment|/// \brief Subtract another vector from this one.
name|Vector
operator|&
name|operator
operator|-=
operator|(
specifier|const
name|Vector
operator|&
name|v
operator|)
block|{
name|assert
argument_list|(
name|length
operator|==
name|v
operator|.
name|length
operator|&&
literal|"Vector length mismatch."
argument_list|)
block|;
name|std
operator|::
name|transform
argument_list|(
name|data
argument_list|,
name|data
operator|+
name|length
argument_list|,
name|v
operator|.
name|data
argument_list|,
name|data
argument_list|,
name|std
operator|::
name|minus
operator|<
name|PBQPNum
operator|>
operator|(
operator|)
argument_list|)
block|;
return|return
operator|*
name|this
return|;
block|}
comment|/// \brief Returns the index of the minimum value in this vector
name|unsigned
name|minIndex
argument_list|()
specifier|const
block|{
return|return
name|std
operator|::
name|min_element
argument_list|(
name|data
argument_list|,
name|data
operator|+
name|length
argument_list|)
operator|-
name|data
return|;
block|}
name|private
label|:
name|unsigned
name|length
decl_stmt|;
name|PBQPNum
modifier|*
name|data
decl_stmt|;
block|}
empty_stmt|;
comment|/// \brief Output a textual representation of the given vector on the given
comment|///        output stream.
name|template
operator|<
name|typename
name|OStream
operator|>
name|OStream
operator|&
name|operator
operator|<<
operator|(
name|OStream
operator|&
name|os
operator|,
specifier|const
name|Vector
operator|&
name|v
operator|)
block|{
name|assert
argument_list|(
operator|(
name|v
operator|.
name|getLength
argument_list|()
operator|!=
literal|0
operator|)
operator|&&
literal|"Zero-length vector badness."
argument_list|)
block|;
name|os
operator|<<
literal|"[ "
operator|<<
name|v
index|[
literal|0
index|]
block|;
for|for
control|(
name|unsigned
name|i
init|=
literal|1
init|;
name|i
operator|<
name|v
operator|.
name|getLength
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
name|os
operator|<<
literal|", "
operator|<<
name|v
index|[
name|i
index|]
expr_stmt|;
block|}
name|os
operator|<<
literal|" ]"
expr_stmt|;
return|return
name|os
return|;
block|}
end_decl_stmt

begin_comment
comment|/// \brief PBQP Matrix class
end_comment

begin_decl_stmt
name|class
name|Matrix
block|{
name|public
label|:
comment|/// \brief Construct a PBQP Matrix with the given dimensions.
name|Matrix
argument_list|(
argument|unsigned rows
argument_list|,
argument|unsigned cols
argument_list|)
block|:
name|rows
argument_list|(
name|rows
argument_list|)
operator|,
name|cols
argument_list|(
name|cols
argument_list|)
operator|,
name|data
argument_list|(
argument|new PBQPNum[rows * cols]
argument_list|)
block|{     }
comment|/// \brief Construct a PBQP Matrix with the given dimensions and initial
comment|/// value.
name|Matrix
argument_list|(
argument|unsigned rows
argument_list|,
argument|unsigned cols
argument_list|,
argument|PBQPNum initVal
argument_list|)
operator|:
name|rows
argument_list|(
name|rows
argument_list|)
operator|,
name|cols
argument_list|(
name|cols
argument_list|)
operator|,
name|data
argument_list|(
argument|new PBQPNum[rows * cols]
argument_list|)
block|{
name|std
operator|::
name|fill
argument_list|(
name|data
argument_list|,
name|data
operator|+
operator|(
name|rows
operator|*
name|cols
operator|)
argument_list|,
name|initVal
argument_list|)
block|;     }
comment|/// \brief Copy construct a PBQP matrix.
name|Matrix
argument_list|(
specifier|const
name|Matrix
operator|&
name|m
argument_list|)
operator|:
name|rows
argument_list|(
name|m
operator|.
name|rows
argument_list|)
operator|,
name|cols
argument_list|(
name|m
operator|.
name|cols
argument_list|)
operator|,
name|data
argument_list|(
argument|new PBQPNum[rows * cols]
argument_list|)
block|{
name|std
operator|::
name|copy
argument_list|(
name|m
operator|.
name|data
argument_list|,
name|m
operator|.
name|data
operator|+
operator|(
name|rows
operator|*
name|cols
operator|)
argument_list|,
name|data
argument_list|)
block|;       }
comment|/// \brief Destroy this matrix, return its memory.
operator|~
name|Matrix
argument_list|()
block|{
name|delete
index|[]
name|data
block|; }
comment|/// \brief Assignment operator.
name|Matrix
operator|&
name|operator
operator|=
operator|(
specifier|const
name|Matrix
operator|&
name|m
operator|)
block|{
name|delete
index|[]
name|data
block|;
name|rows
operator|=
name|m
operator|.
name|rows
block|;
name|cols
operator|=
name|m
operator|.
name|cols
block|;
name|data
operator|=
name|new
name|PBQPNum
index|[
name|rows
operator|*
name|cols
index|]
block|;
name|std
operator|::
name|copy
argument_list|(
name|m
operator|.
name|data
argument_list|,
name|m
operator|.
name|data
operator|+
operator|(
name|rows
operator|*
name|cols
operator|)
argument_list|,
name|data
argument_list|)
block|;
return|return
operator|*
name|this
return|;
block|}
comment|/// \brief Return the number of rows in this matrix.
name|unsigned
name|getRows
argument_list|()
specifier|const
block|{
return|return
name|rows
return|;
block|}
comment|/// \brief Return the number of cols in this matrix.
name|unsigned
name|getCols
argument_list|()
specifier|const
block|{
return|return
name|cols
return|;
block|}
comment|/// \brief Matrix element access.
name|PBQPNum
modifier|*
name|operator
function|[]
parameter_list|(
name|unsigned
name|r
parameter_list|)
block|{
name|assert
argument_list|(
name|r
operator|<
name|rows
operator|&&
literal|"Row out of bounds."
argument_list|)
expr_stmt|;
return|return
name|data
operator|+
operator|(
name|r
operator|*
name|cols
operator|)
return|;
block|}
comment|/// \brief Matrix element access.
specifier|const
name|PBQPNum
modifier|*
name|operator
index|[]
argument_list|(
name|unsigned
name|r
argument_list|)
decl|const
block|{
name|assert
argument_list|(
name|r
operator|<
name|rows
operator|&&
literal|"Row out of bounds."
argument_list|)
expr_stmt|;
return|return
name|data
operator|+
operator|(
name|r
operator|*
name|cols
operator|)
return|;
block|}
comment|/// \brief Returns the given row as a vector.
name|Vector
name|getRowAsVector
argument_list|(
name|unsigned
name|r
argument_list|)
decl|const
block|{
name|Vector
name|v
parameter_list|(
name|cols
parameter_list|)
function_decl|;
for|for
control|(
name|unsigned
name|c
init|=
literal|0
init|;
name|c
operator|<
name|cols
condition|;
operator|++
name|c
control|)
name|v
index|[
name|c
index|]
operator|=
operator|(
operator|*
name|this
operator|)
index|[
name|r
index|]
index|[
name|c
index|]
expr_stmt|;
return|return
name|v
return|;
block|}
comment|/// \brief Returns the given column as a vector.
name|Vector
name|getColAsVector
argument_list|(
name|unsigned
name|c
argument_list|)
decl|const
block|{
name|Vector
name|v
parameter_list|(
name|rows
parameter_list|)
function_decl|;
for|for
control|(
name|unsigned
name|r
init|=
literal|0
init|;
name|r
operator|<
name|rows
condition|;
operator|++
name|r
control|)
name|v
index|[
name|r
index|]
operator|=
operator|(
operator|*
name|this
operator|)
index|[
name|r
index|]
index|[
name|c
index|]
expr_stmt|;
return|return
name|v
return|;
block|}
comment|/// \brief Reset the matrix to the given value.
name|Matrix
modifier|&
name|reset
parameter_list|(
name|PBQPNum
name|val
init|=
literal|0
parameter_list|)
block|{
name|std
operator|::
name|fill
argument_list|(
name|data
argument_list|,
name|data
operator|+
operator|(
name|rows
operator|*
name|cols
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|*
name|this
return|;
block|}
comment|/// \brief Set a single row of this matrix to the given value.
name|Matrix
modifier|&
name|setRow
parameter_list|(
name|unsigned
name|r
parameter_list|,
name|PBQPNum
name|val
parameter_list|)
block|{
name|assert
argument_list|(
name|r
operator|<
name|rows
operator|&&
literal|"Row out of bounds."
argument_list|)
expr_stmt|;
name|std
operator|::
name|fill
argument_list|(
name|data
operator|+
operator|(
name|r
operator|*
name|cols
operator|)
argument_list|,
name|data
operator|+
operator|(
operator|(
name|r
operator|+
literal|1
operator|)
operator|*
name|cols
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|*
name|this
return|;
block|}
comment|/// \brief Set a single column of this matrix to the given value.
name|Matrix
modifier|&
name|setCol
parameter_list|(
name|unsigned
name|c
parameter_list|,
name|PBQPNum
name|val
parameter_list|)
block|{
name|assert
argument_list|(
name|c
operator|<
name|cols
operator|&&
literal|"Column out of bounds."
argument_list|)
expr_stmt|;
for|for
control|(
name|unsigned
name|r
init|=
literal|0
init|;
name|r
operator|<
name|rows
condition|;
operator|++
name|r
control|)
operator|(
operator|*
name|this
operator|)
index|[
name|r
index|]
index|[
name|c
index|]
operator|=
name|val
expr_stmt|;
return|return
operator|*
name|this
return|;
block|}
comment|/// \brief Matrix transpose.
name|Matrix
name|transpose
argument_list|()
specifier|const
block|{
name|Matrix
name|m
argument_list|(
name|cols
argument_list|,
name|rows
argument_list|)
block|;
for|for
control|(
name|unsigned
name|r
init|=
literal|0
init|;
name|r
operator|<
name|rows
condition|;
operator|++
name|r
control|)
for|for
control|(
name|unsigned
name|c
init|=
literal|0
init|;
name|c
operator|<
name|cols
condition|;
operator|++
name|c
control|)
name|m
index|[
name|c
index|]
index|[
name|r
index|]
operator|=
operator|(
operator|*
name|this
operator|)
index|[
name|r
index|]
index|[
name|c
index|]
expr_stmt|;
return|return
name|m
return|;
block|}
end_decl_stmt

begin_comment
comment|/// \brief Returns the diagonal of the matrix as a vector.
end_comment

begin_comment
comment|///
end_comment

begin_comment
comment|/// Matrix must be square.
end_comment

begin_expr_stmt
name|Vector
name|diagonalize
argument_list|()
specifier|const
block|{
name|assert
argument_list|(
name|rows
operator|==
name|cols
operator|&&
literal|"Attempt to diagonalize non-square matrix."
argument_list|)
block|;
name|Vector
name|v
argument_list|(
name|rows
argument_list|)
block|;
for|for
control|(
name|unsigned
name|r
init|=
literal|0
init|;
name|r
operator|<
name|rows
condition|;
operator|++
name|r
control|)
name|v
index|[
name|r
index|]
operator|=
operator|(
operator|*
name|this
operator|)
index|[
name|r
index|]
index|[
name|r
index|]
expr_stmt|;
end_expr_stmt

begin_return
return|return
name|v
return|;
end_return

begin_comment
unit|}
comment|/// \brief Add the given matrix to this one.
end_comment

begin_expr_stmt
unit|Matrix
operator|&
name|operator
operator|+=
operator|(
specifier|const
name|Matrix
operator|&
name|m
operator|)
block|{
name|assert
argument_list|(
name|rows
operator|==
name|m
operator|.
name|rows
operator|&&
name|cols
operator|==
name|m
operator|.
name|cols
operator|&&
literal|"Matrix dimensions mismatch."
argument_list|)
block|;
name|std
operator|::
name|transform
argument_list|(
name|data
argument_list|,
name|data
operator|+
operator|(
name|rows
operator|*
name|cols
operator|)
argument_list|,
name|m
operator|.
name|data
argument_list|,
name|data
argument_list|,
name|std
operator|::
name|plus
operator|<
name|PBQPNum
operator|>
operator|(
operator|)
argument_list|)
block|;
return|return
operator|*
name|this
return|;
block|}
end_expr_stmt

begin_comment
comment|/// \brief Returns the minimum of the given row
end_comment

begin_decl_stmt
name|PBQPNum
name|getRowMin
argument_list|(
name|unsigned
name|r
argument_list|)
decl|const
block|{
name|assert
argument_list|(
name|r
operator|<
name|rows
operator|&&
literal|"Row out of bounds"
argument_list|)
expr_stmt|;
return|return
operator|*
name|std
operator|::
name|min_element
argument_list|(
name|data
operator|+
operator|(
name|r
operator|*
name|cols
operator|)
argument_list|,
name|data
operator|+
operator|(
operator|(
name|r
operator|+
literal|1
operator|)
operator|*
name|cols
operator|)
argument_list|)
return|;
block|}
end_decl_stmt

begin_comment
comment|/// \brief Returns the minimum of the given column
end_comment

begin_decl_stmt
name|PBQPNum
name|getColMin
argument_list|(
name|unsigned
name|c
argument_list|)
decl|const
block|{
name|PBQPNum
name|minElem
init|=
operator|(
operator|*
name|this
operator|)
index|[
literal|0
index|]
index|[
name|c
index|]
decl_stmt|;
for|for
control|(
name|unsigned
name|r
init|=
literal|1
init|;
name|r
operator|<
name|rows
condition|;
operator|++
name|r
control|)
if|if
condition|(
operator|(
operator|*
name|this
operator|)
index|[
name|r
index|]
index|[
name|c
index|]
operator|<
name|minElem
condition|)
name|minElem
operator|=
operator|(
operator|*
name|this
operator|)
index|[
name|r
index|]
index|[
name|c
index|]
expr_stmt|;
return|return
name|minElem
return|;
block|}
end_decl_stmt

begin_comment
comment|/// \brief Subtracts the given scalar from the elements of the given row.
end_comment

begin_function
name|Matrix
modifier|&
name|subFromRow
parameter_list|(
name|unsigned
name|r
parameter_list|,
name|PBQPNum
name|val
parameter_list|)
block|{
name|assert
argument_list|(
name|r
operator|<
name|rows
operator|&&
literal|"Row out of bounds"
argument_list|)
expr_stmt|;
name|std
operator|::
name|transform
argument_list|(
name|data
operator|+
operator|(
name|r
operator|*
name|cols
operator|)
argument_list|,
name|data
operator|+
operator|(
operator|(
name|r
operator|+
literal|1
operator|)
operator|*
name|cols
operator|)
argument_list|,
name|data
operator|+
operator|(
name|r
operator|*
name|cols
operator|)
argument_list|,
name|std
operator|::
name|bind2nd
argument_list|(
name|std
operator|::
name|minus
operator|<
name|PBQPNum
operator|>
operator|(
operator|)
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|*
name|this
return|;
block|}
end_function

begin_comment
comment|/// \brief Subtracts the given scalar from the elements of the given column.
end_comment

begin_function
name|Matrix
modifier|&
name|subFromCol
parameter_list|(
name|unsigned
name|c
parameter_list|,
name|PBQPNum
name|val
parameter_list|)
block|{
for|for
control|(
name|unsigned
name|r
init|=
literal|0
init|;
name|r
operator|<
name|rows
condition|;
operator|++
name|r
control|)
operator|(
operator|*
name|this
operator|)
index|[
name|r
index|]
index|[
name|c
index|]
operator|-=
name|val
expr_stmt|;
return|return
operator|*
name|this
return|;
block|}
end_function

begin_comment
comment|/// \brief Returns true if this is a zero matrix.
end_comment

begin_expr_stmt
name|bool
name|isZero
argument_list|()
specifier|const
block|{
return|return
name|find_if
argument_list|(
name|data
argument_list|,
name|data
operator|+
operator|(
name|rows
operator|*
name|cols
operator|)
argument_list|,
name|std
operator|::
name|bind2nd
argument_list|(
name|std
operator|::
name|not_equal_to
operator|<
name|PBQPNum
operator|>
operator|(
operator|)
argument_list|,
literal|0
argument_list|)
argument_list|)
operator|==
name|data
operator|+
operator|(
name|rows
operator|*
name|cols
operator|)
return|;
block|}
end_expr_stmt

begin_label
name|private
label|:
end_label

begin_decl_stmt
name|unsigned
name|rows
decl_stmt|,
name|cols
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|PBQPNum
modifier|*
name|data
decl_stmt|;
end_decl_stmt

begin_comment
unit|};
comment|/// \brief Output a textual representation of the given matrix on the given
end_comment

begin_comment
comment|///        output stream.
end_comment

begin_expr_stmt
name|template
operator|<
name|typename
name|OStream
operator|>
name|OStream
operator|&
name|operator
operator|<<
operator|(
name|OStream
operator|&
name|os
operator|,
specifier|const
name|Matrix
operator|&
name|m
operator|)
block|{
name|assert
argument_list|(
operator|(
name|m
operator|.
name|getRows
argument_list|()
operator|!=
literal|0
operator|)
operator|&&
literal|"Zero-row matrix badness."
argument_list|)
block|;
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|;
name|i
operator|<
name|m
operator|.
name|getRows
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
name|os
operator|<<
name|m
operator|.
name|getRowAsVector
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
end_expr_stmt

begin_return
return|return
name|os
return|;
end_return

begin_endif
unit|}  }
endif|#
directive|endif
end_endif

begin_comment
comment|// LLVM_CODEGEN_PBQP_PBQPMATH_HPP
end_comment

end_unit


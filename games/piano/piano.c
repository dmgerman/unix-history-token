begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * piano.c - a piano emulator  */
end_comment

begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<curses.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_decl_stmt
name|char
modifier|*
name|myname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|verbose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|initcmd
init|=
literal|"t160 o1 l16 ml"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|usage_msg
index|[]
init|=
literal|"simple keyboard player V0.8086\n"
literal|"usage: %s [-v][-i str]\n"
literal|"\t-i str defaults 't160 o1 l16 ml'\n"
literal|"function: play by console keyboard\n"
literal|"\tESC to exit. Note keys are ...\n"
literal|"\t1 2   4 5   7 8 9   - = \\\n"
literal|"\t Q W E R T Y U I O P [ ]\n"
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|kdef_t
block|{
name|int
name|ch
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|char
modifier|*
name|kstr
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|kdef_t
name|kdef
index|[]
init|=
block|{
comment|/* white key */
block|{
literal|'\t'
block|,
literal|"<g>"
block|}
block|,
block|{
literal|'q'
block|,
literal|"<a>"
block|}
block|,
block|{
literal|'w'
block|,
literal|"<b>"
block|}
block|,
block|{
literal|'e'
block|,
literal|"c"
block|}
block|,
block|{
literal|'r'
block|,
literal|"d"
block|}
block|,
block|{
literal|'t'
block|,
literal|"e"
block|}
block|,
block|{
literal|'y'
block|,
literal|"f"
block|}
block|,
block|{
literal|'u'
block|,
literal|"g"
block|}
block|,
block|{
literal|'i'
block|,
literal|"a"
block|}
block|,
block|{
literal|'o'
block|,
literal|"b"
block|}
block|,
block|{
literal|'p'
block|,
literal|">c<"
block|}
block|,
block|{
literal|'['
block|,
literal|">d<"
block|}
block|,
block|{
literal|']'
block|,
literal|">e<"
block|}
block|,
block|{
literal|'\n'
block|,
literal|">f<"
block|}
block|,
block|{
literal|'\r'
block|,
literal|">f<"
block|}
block|,
comment|/* black key */
block|{
literal|'`'
block|,
literal|"<f#>"
block|}
block|,
block|{
literal|'1'
block|,
literal|"<g#>"
block|}
block|,
block|{
literal|'2'
block|,
literal|"<a#>"
block|}
block|,
comment|/*{ '3', "<b#>" },*/
block|{
literal|'4'
block|,
literal|"c#"
block|}
block|,
block|{
literal|'5'
block|,
literal|"d#"
block|}
block|,
comment|/*{ '6', "e#" },*/
block|{
literal|'7'
block|,
literal|"f#"
block|}
block|,
block|{
literal|'8'
block|,
literal|"g#"
block|}
block|,
block|{
literal|'9'
block|,
literal|"a#"
block|}
block|,
comment|/*{ '0', "b#" },*/
block|{
literal|'-'
block|,
literal|">c#<"
block|}
block|,
block|{
literal|'='
block|,
literal|">d#<"
block|}
block|,
comment|/*{ '\', ">e#<" },*/
block|{
literal|'\177'
block|,
literal|">f#<"
block|}
block|,
block|{
literal|'\0'
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|init_kstr
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|kdef_t
modifier|*
name|mv
init|=
name|kdef
decl_stmt|;
while|while
condition|(
name|mv
operator|->
name|str
operator|!=
name|NULL
condition|)
block|{
name|kstr
index|[
name|mv
operator|->
name|ch
index|]
operator|=
name|mv
operator|->
name|str
expr_stmt|;
name|mv
operator|++
expr_stmt|;
block|}
comment|/* while */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* init_kstr */
end_comment

begin_function
specifier|static
name|int
name|fdputs
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|int
name|fd
parameter_list|,
name|int
name|echo
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|len
init|=
name|strlen
argument_list|(
name|s
argument_list|)
decl_stmt|;
name|write
argument_list|(
name|fd
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|err
operator|=
name|write
argument_list|(
name|fd
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|echo
condition|)
block|{
name|fputs
argument_list|(
name|s
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* fdputs */
end_comment

begin_function
specifier|static
name|int
name|outspkr
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
name|int
name|err
init|=
operator|-
literal|1
decl_stmt|,
name|fd
init|=
name|open
argument_list|(
literal|"/dev/speaker"
argument_list|,
name|O_WRONLY
argument_list|)
decl_stmt|;
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
block|{
name|fdputs
argument_list|(
name|initcmd
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|err
operator|=
name|fdputs
argument_list|(
name|s
argument_list|,
name|fd
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* outspkr */
end_comment

begin_function
specifier|static
name|int
name|nain
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|ch
decl_stmt|;
name|initscr
argument_list|()
expr_stmt|;
name|noecho
argument_list|()
expr_stmt|;
name|nonl
argument_list|()
expr_stmt|;
name|raw
argument_list|()
expr_stmt|;
name|init_kstr
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getch
argument_list|()
operator|)
operator|!=
literal|'\033'
condition|)
block|{
if|if
condition|(
name|kstr
index|[
name|ch
index|]
operator|!=
name|NULL
condition|)
block|{
name|outspkr
argument_list|(
name|kstr
index|[
name|ch
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|verbose
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
name|fputs
argument_list|(
literal|" "
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\b'
case|:
name|fputs
argument_list|(
literal|"\b"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* switch */
block|}
block|}
block|}
comment|/* while */
name|endwin
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* nain */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
specifier|extern
name|int
name|optind
decl_stmt|,
name|opterr
decl_stmt|;
name|int
name|ch
decl_stmt|,
name|ex
decl_stmt|,
name|show_usage
init|=
literal|0
decl_stmt|;
name|myname
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"-vi:"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
default|default:
case|case
literal|'V'
case|:
name|show_usage
operator|++
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|initcmd
operator|=
name|optarg
expr_stmt|;
break|break;
block|}
comment|/* switch */
block|}
comment|/* while */
name|ex
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|show_usage
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|usage_msg
argument_list|,
name|myname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Type ESC to exit.\n"
argument_list|)
expr_stmt|;
name|ex
operator|=
literal|0
expr_stmt|;
name|nain
argument_list|()
expr_stmt|;
block|}
return|return
name|ex
return|;
block|}
end_function

begin_comment
comment|/* main */
end_comment

end_unit


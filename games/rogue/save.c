begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1988, 1993  *	The Regents of the University of California.  All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * Timothy C. Stoehr.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)save.c	8.1 (Berkeley) 5/31/93"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*  * save.c  *  * This source herein may be modified and/or distributed by anybody who  * so desires, with the following restrictions:  *    1.)  No portion of this notice shall be removed.  *    2.)  Credit shall not be taken for the creation of this source.  *    3.)  This code is not to be traded, sold, or used for personal  *         gain or profit.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"rogue.h"
end_include

begin_decl_stmt
name|short
name|write_failed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|save_file
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|boolean
name|detect_monster
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|cur_level
decl_stmt|,
name|max_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|hunger_str
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|login_name
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|party_room
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|foods
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|boolean
name|is_wood
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|cur_room
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|boolean
name|being_held
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|bear_trap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|halluc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|blind
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|confused
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|levitate
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|haste_self
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|boolean
name|see_invisible
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|boolean
name|detect_monster
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|boolean
name|wizard
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|boolean
name|score_only
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|m_moves
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|boolean
name|msg_cleared
decl_stmt|;
end_decl_stmt

begin_macro
name|save_game
argument_list|()
end_macro

begin_block
block|{
name|char
name|fname
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|get_input_line
argument_list|(
literal|"file name?"
argument_list|,
name|save_file
argument_list|,
name|fname
argument_list|,
literal|"game not saved"
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
condition|)
block|{
return|return;
block|}
name|check_message
argument_list|()
expr_stmt|;
name|message
argument_list|(
name|fname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|save_into_file
argument_list|(
name|fname
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|save_into_file
argument_list|(
argument|sfile
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|sfile
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|file_id
decl_stmt|;
name|char
name|name_buffer
index|[
literal|80
index|]
decl_stmt|;
name|char
modifier|*
name|hptr
decl_stmt|;
name|struct
name|rogue_time
name|rt_buf
decl_stmt|;
if|if
condition|(
name|sfile
index|[
literal|0
index|]
operator|==
literal|'~'
condition|)
block|{
if|if
condition|(
name|hptr
operator|=
name|md_getenv
argument_list|(
literal|"HOME"
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|name_buffer
argument_list|,
name|hptr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|name_buffer
argument_list|,
name|sfile
operator|+
literal|1
argument_list|)
expr_stmt|;
name|sfile
operator|=
name|name_buffer
expr_stmt|;
block|}
block|}
comment|/* revoke */
name|setgid
argument_list|(
name|getgid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|sfile
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|file_id
operator|=
name|md_get_file_id
argument_list|(
name|sfile
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|message
argument_list|(
literal|"problem accessing the save file"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|md_ignore_signals
argument_list|()
expr_stmt|;
name|write_failed
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|xxx
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|detect_monster
argument_list|,
sizeof|sizeof
argument_list|(
name|detect_monster
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|cur_level
argument_list|,
sizeof|sizeof
argument_list|(
name|cur_level
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|max_level
argument_list|,
sizeof|sizeof
argument_list|(
name|max_level
argument_list|)
argument_list|)
expr_stmt|;
name|write_string
argument_list|(
name|hunger_str
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|write_string
argument_list|(
name|login_name
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|party_room
argument_list|,
sizeof|sizeof
argument_list|(
name|party_room
argument_list|)
argument_list|)
expr_stmt|;
name|write_pack
argument_list|(
operator|&
name|level_monsters
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|write_pack
argument_list|(
operator|&
name|level_objects
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|file_id
argument_list|,
sizeof|sizeof
argument_list|(
name|file_id
argument_list|)
argument_list|)
expr_stmt|;
name|rw_dungeon
argument_list|(
name|fp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|foods
argument_list|,
sizeof|sizeof
argument_list|(
name|foods
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|rogue
argument_list|,
sizeof|sizeof
argument_list|(
name|fighter
argument_list|)
argument_list|)
expr_stmt|;
name|write_pack
argument_list|(
operator|&
name|rogue
operator|.
name|pack
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|rw_id
argument_list|(
name|id_potions
argument_list|,
name|fp
argument_list|,
name|POTIONS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rw_id
argument_list|(
name|id_scrolls
argument_list|,
name|fp
argument_list|,
name|SCROLS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rw_id
argument_list|(
name|id_wands
argument_list|,
name|fp
argument_list|,
name|WANDS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rw_id
argument_list|(
name|id_rings
argument_list|,
name|fp
argument_list|,
name|RINGS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|traps
argument_list|,
operator|(
name|MAX_TRAPS
operator|*
sizeof|sizeof
argument_list|(
name|trap
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|is_wood
argument_list|,
operator|(
name|WANDS
operator|*
sizeof|sizeof
argument_list|(
name|boolean
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|cur_room
argument_list|,
sizeof|sizeof
argument_list|(
name|cur_room
argument_list|)
argument_list|)
expr_stmt|;
name|rw_rooms
argument_list|(
name|fp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|being_held
argument_list|,
sizeof|sizeof
argument_list|(
name|being_held
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|bear_trap
argument_list|,
sizeof|sizeof
argument_list|(
name|bear_trap
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|halluc
argument_list|,
sizeof|sizeof
argument_list|(
name|halluc
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|blind
argument_list|,
sizeof|sizeof
argument_list|(
name|blind
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|confused
argument_list|,
sizeof|sizeof
argument_list|(
name|confused
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|levitate
argument_list|,
sizeof|sizeof
argument_list|(
name|levitate
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|haste_self
argument_list|,
sizeof|sizeof
argument_list|(
name|haste_self
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|see_invisible
argument_list|,
sizeof|sizeof
argument_list|(
name|see_invisible
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|detect_monster
argument_list|,
sizeof|sizeof
argument_list|(
name|detect_monster
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|wizard
argument_list|,
sizeof|sizeof
argument_list|(
name|wizard
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|score_only
argument_list|,
sizeof|sizeof
argument_list|(
name|score_only
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m_moves
argument_list|,
sizeof|sizeof
argument_list|(
name|m_moves
argument_list|)
argument_list|)
expr_stmt|;
name|md_gct
argument_list|(
operator|&
name|rt_buf
argument_list|)
expr_stmt|;
name|rt_buf
operator|.
name|second
operator|+=
literal|10
expr_stmt|;
comment|/* allow for some processing time */
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|rt_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|rt_buf
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_failed
condition|)
block|{
operator|(
name|void
operator|)
name|md_df
argument_list|(
name|sfile
argument_list|)
expr_stmt|;
comment|/* delete file */
block|}
else|else
block|{
name|clean_up
argument_list|(
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_decl_stmt
specifier|static
name|char
name|save_name
index|[
literal|80
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|del_save_file
argument_list|()
block|{
comment|/* revoke */
name|setgid
argument_list|(
name|getgid
argument_list|()
argument_list|)
block|;
name|md_df
argument_list|(
name|save_name
argument_list|)
block|; }
name|restore
argument_list|(
argument|fname
argument_list|)
name|char
operator|*
name|fname
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|struct
name|rogue_time
name|saved_time
decl_stmt|,
name|mod_time
decl_stmt|;
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|char
name|tbuf
index|[
literal|40
index|]
decl_stmt|;
name|int
name|new_file_id
decl_stmt|,
name|saved_file_id
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|new_file_id
operator|=
name|md_get_file_id
argument_list|(
name|fname
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|)
operator|||
operator|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|clean_up
argument_list|(
literal|"cannot open file"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|md_link_count
argument_list|(
name|fname
argument_list|)
operator|>
literal|1
condition|)
block|{
name|clean_up
argument_list|(
literal|"file has link"
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|xxx
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|detect_monster
argument_list|,
sizeof|sizeof
argument_list|(
name|detect_monster
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|cur_level
argument_list|,
sizeof|sizeof
argument_list|(
name|cur_level
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|max_level
argument_list|,
sizeof|sizeof
argument_list|(
name|max_level
argument_list|)
argument_list|)
expr_stmt|;
name|read_string
argument_list|(
name|hunger_str
argument_list|,
name|fp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|login_name
argument_list|)
expr_stmt|;
name|read_string
argument_list|(
name|login_name
argument_list|,
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|tbuf
argument_list|,
name|login_name
argument_list|)
condition|)
block|{
name|clean_up
argument_list|(
literal|"you're not the original player"
argument_list|)
expr_stmt|;
block|}
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|party_room
argument_list|,
sizeof|sizeof
argument_list|(
name|party_room
argument_list|)
argument_list|)
expr_stmt|;
name|read_pack
argument_list|(
operator|&
name|level_monsters
argument_list|,
name|fp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read_pack
argument_list|(
operator|&
name|level_objects
argument_list|,
name|fp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|saved_file_id
argument_list|,
sizeof|sizeof
argument_list|(
name|saved_file_id
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_file_id
operator|!=
name|saved_file_id
condition|)
block|{
name|clean_up
argument_list|(
literal|"sorry, saved game is not in the same file"
argument_list|)
expr_stmt|;
block|}
name|rw_dungeon
argument_list|(
name|fp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|foods
argument_list|,
sizeof|sizeof
argument_list|(
name|foods
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|rogue
argument_list|,
sizeof|sizeof
argument_list|(
name|fighter
argument_list|)
argument_list|)
expr_stmt|;
name|read_pack
argument_list|(
operator|&
name|rogue
operator|.
name|pack
argument_list|,
name|fp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rw_id
argument_list|(
name|id_potions
argument_list|,
name|fp
argument_list|,
name|POTIONS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rw_id
argument_list|(
name|id_scrolls
argument_list|,
name|fp
argument_list|,
name|SCROLS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rw_id
argument_list|(
name|id_wands
argument_list|,
name|fp
argument_list|,
name|WANDS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rw_id
argument_list|(
name|id_rings
argument_list|,
name|fp
argument_list|,
name|RINGS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|traps
argument_list|,
operator|(
name|MAX_TRAPS
operator|*
sizeof|sizeof
argument_list|(
name|trap
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|is_wood
argument_list|,
operator|(
name|WANDS
operator|*
sizeof|sizeof
argument_list|(
name|boolean
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|cur_room
argument_list|,
sizeof|sizeof
argument_list|(
name|cur_room
argument_list|)
argument_list|)
expr_stmt|;
name|rw_rooms
argument_list|(
name|fp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|being_held
argument_list|,
sizeof|sizeof
argument_list|(
name|being_held
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|bear_trap
argument_list|,
sizeof|sizeof
argument_list|(
name|bear_trap
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|halluc
argument_list|,
sizeof|sizeof
argument_list|(
name|halluc
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|blind
argument_list|,
sizeof|sizeof
argument_list|(
name|blind
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|confused
argument_list|,
sizeof|sizeof
argument_list|(
name|confused
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|levitate
argument_list|,
sizeof|sizeof
argument_list|(
name|levitate
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|haste_self
argument_list|,
sizeof|sizeof
argument_list|(
name|haste_self
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|see_invisible
argument_list|,
sizeof|sizeof
argument_list|(
name|see_invisible
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|detect_monster
argument_list|,
sizeof|sizeof
argument_list|(
name|detect_monster
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|wizard
argument_list|,
sizeof|sizeof
argument_list|(
name|wizard
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|score_only
argument_list|,
sizeof|sizeof
argument_list|(
name|score_only
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m_moves
argument_list|,
sizeof|sizeof
argument_list|(
name|m_moves
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|saved_time
argument_list|,
sizeof|sizeof
argument_list|(
name|saved_time
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
operator|>
literal|0
condition|)
block|{
name|clear
argument_list|()
expr_stmt|;
name|clean_up
argument_list|(
literal|"extra characters in file"
argument_list|)
expr_stmt|;
block|}
name|md_gfmt
argument_list|(
name|fname
argument_list|,
operator|&
name|mod_time
argument_list|)
expr_stmt|;
comment|/* get file modification time */
if|if
condition|(
name|has_been_touched
argument_list|(
operator|&
name|saved_time
argument_list|,
operator|&
name|mod_time
argument_list|)
condition|)
block|{
name|clear
argument_list|()
expr_stmt|;
name|clean_up
argument_list|(
literal|"sorry, file has been touched"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|!
name|wizard
operator|)
condition|)
block|{
name|strcpy
argument_list|(
name|save_name
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|atexit
argument_list|(
name|del_save_file
argument_list|)
expr_stmt|;
block|}
name|msg_cleared
operator|=
literal|0
expr_stmt|;
name|ring_stats
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|write_pack
argument_list|(
argument|pack
argument_list|,
argument|fp
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|pack
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|object
name|t
decl_stmt|;
while|while
condition|(
name|pack
operator|=
name|pack
operator|->
name|next_object
condition|)
block|{
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|pack
argument_list|,
sizeof|sizeof
argument_list|(
name|object
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|t
operator|.
name|ichar
operator|=
name|t
operator|.
name|what_is
operator|=
literal|0
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|t
argument_list|,
sizeof|sizeof
argument_list|(
name|object
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|read_pack
argument_list|(
argument|pack
argument_list|,
argument|fp
argument_list|,
argument|is_rogue
argument_list|)
end_macro

begin_decl_stmt
name|object
modifier|*
name|pack
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|is_rogue
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|object
name|read_obj
decl_stmt|,
modifier|*
name|new_obj
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|read_obj
argument_list|,
sizeof|sizeof
argument_list|(
name|object
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_obj
operator|.
name|ichar
operator|==
literal|0
condition|)
block|{
name|pack
operator|->
name|next_object
operator|=
operator|(
name|object
operator|*
operator|)
literal|0
expr_stmt|;
break|break;
block|}
name|new_obj
operator|=
name|alloc_object
argument_list|()
expr_stmt|;
operator|*
name|new_obj
operator|=
name|read_obj
expr_stmt|;
if|if
condition|(
name|is_rogue
condition|)
block|{
if|if
condition|(
name|new_obj
operator|->
name|in_use_flags
operator|&
name|BEING_WORN
condition|)
block|{
name|do_wear
argument_list|(
name|new_obj
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|new_obj
operator|->
name|in_use_flags
operator|&
name|BEING_WIELDED
condition|)
block|{
name|do_wield
argument_list|(
name|new_obj
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|new_obj
operator|->
name|in_use_flags
operator|&
operator|(
name|ON_EITHER_HAND
operator|)
condition|)
block|{
name|do_put_on
argument_list|(
name|new_obj
argument_list|,
operator|(
operator|(
name|new_obj
operator|->
name|in_use_flags
operator|&
name|ON_LEFT_HAND
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|pack
operator|->
name|next_object
operator|=
name|new_obj
expr_stmt|;
name|pack
operator|=
name|new_obj
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|rw_dungeon
argument_list|(
argument|fp
argument_list|,
argument|rw
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|rw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
name|buf
index|[
name|DCOLS
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DROWS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rw
condition|)
block|{
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dungeon
index|[
name|i
index|]
argument_list|,
operator|(
name|DCOLS
operator|*
sizeof|sizeof
argument_list|(
name|dungeon
index|[
literal|0
index|]
index|[
literal|0
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|DCOLS
condition|;
name|j
operator|++
control|)
block|{
name|buf
index|[
name|j
index|]
operator|=
name|mvinch
argument_list|(
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
name|r_write
argument_list|(
name|fp
argument_list|,
name|buf
argument_list|,
name|DCOLS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dungeon
index|[
name|i
index|]
argument_list|,
operator|(
name|DCOLS
operator|*
sizeof|sizeof
argument_list|(
name|dungeon
index|[
literal|0
index|]
index|[
literal|0
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
name|buf
argument_list|,
name|DCOLS
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|DCOLS
condition|;
name|j
operator|++
control|)
block|{
name|mvaddch
argument_list|(
name|i
argument_list|,
name|j
argument_list|,
name|buf
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_block

begin_macro
name|rw_id
argument_list|(
argument|id_table
argument_list|,
argument|fp
argument_list|,
argument|n
argument_list|,
argument|wr
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|id
name|id_table
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|wr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wr
condition|)
block|{
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|id_table
index|[
name|i
index|]
operator|.
name|value
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|id_table
index|[
name|i
index|]
operator|.
name|id_status
operator|)
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
argument_list|)
expr_stmt|;
name|write_string
argument_list|(
name|id_table
index|[
name|i
index|]
operator|.
name|title
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|id_table
index|[
name|i
index|]
operator|.
name|value
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|id_table
index|[
name|i
index|]
operator|.
name|id_status
operator|)
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
argument_list|)
expr_stmt|;
name|read_string
argument_list|(
name|id_table
index|[
name|i
index|]
operator|.
name|title
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|write_string
argument_list|(
argument|s
argument_list|,
argument|fp
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|n
decl_stmt|;
name|n
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|1
expr_stmt|;
name|xxxx
argument_list|(
name|s
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
expr_stmt|;
name|r_write
argument_list|(
name|fp
argument_list|,
name|s
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|read_string
argument_list|(
argument|s
argument_list|,
argument|fp
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|n
decl_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
expr_stmt|;
name|r_read
argument_list|(
name|fp
argument_list|,
name|s
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|xxxx
argument_list|(
name|s
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rw_rooms
argument_list|(
argument|fp
argument_list|,
argument|rw
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean
name|rw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXROOMS
condition|;
name|i
operator|++
control|)
block|{
name|rw
condition|?
name|r_write
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|rooms
operator|+
name|i
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|room
argument_list|)
argument_list|)
else|:
name|r_read
argument_list|(
name|fp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|rooms
operator|+
name|i
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|room
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|r_read
argument_list|(
argument|fp
argument_list|,
argument|buf
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|n
argument_list|,
name|fp
argument_list|)
operator|!=
name|n
condition|)
block|{
name|clean_up
argument_list|(
literal|"read() failed, don't know why"
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|r_write
argument_list|(
argument|fp
argument_list|,
argument|buf
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|write_failed
condition|)
block|{
if|if
condition|(
name|fwrite
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|n
argument_list|,
name|fp
argument_list|)
operator|!=
name|n
condition|)
block|{
name|message
argument_list|(
literal|"write() failed, don't know why"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sound_bell
argument_list|()
expr_stmt|;
name|write_failed
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
end_block

begin_function
name|boolean
name|has_been_touched
parameter_list|(
name|saved_time
parameter_list|,
name|mod_time
parameter_list|)
name|struct
name|rogue_time
modifier|*
name|saved_time
decl_stmt|,
decl|*
name|mod_time
decl_stmt|;
end_function

begin_block
block|{
if|if
condition|(
name|saved_time
operator|->
name|year
operator|<
name|mod_time
operator|->
name|year
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|saved_time
operator|->
name|year
operator|>
name|mod_time
operator|->
name|year
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|saved_time
operator|->
name|month
operator|<
name|mod_time
operator|->
name|month
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|saved_time
operator|->
name|month
operator|>
name|mod_time
operator|->
name|month
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|saved_time
operator|->
name|day
operator|<
name|mod_time
operator|->
name|day
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|saved_time
operator|->
name|day
operator|>
name|mod_time
operator|->
name|day
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|saved_time
operator|->
name|hour
operator|<
name|mod_time
operator|->
name|hour
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|saved_time
operator|->
name|hour
operator|>
name|mod_time
operator|->
name|hour
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|saved_time
operator|->
name|minute
operator|<
name|mod_time
operator|->
name|minute
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|saved_time
operator|->
name|minute
operator|>
name|mod_time
operator|->
name|minute
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|saved_time
operator|->
name|second
operator|<
name|mod_time
operator|->
name|second
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * interplayer.c - player to player routines for Phantasia  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"include.h"
end_include

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: checkbattle() / / FUNCTION: check to see if current player should battle another / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: battleplayer(), fread(), fseek() / / GLOBAL INPUTS: Other, Users, Player, Fileloc, *Playersfp / / GLOBAL OUTPUTS: Users / / DESCRIPTION: /	Seach player file for a foe at the same coordinates as the /	current player. /	Also update user count. / *************************************************************************/
end_comment

begin_macro
name|checkbattle
argument_list|()
end_macro

begin_block
block|{
name|long
name|foeloc
init|=
literal|0L
decl_stmt|;
comment|/* location in file of person to fight */
name|Users
operator|=
literal|0
expr_stmt|;
name|fseek
argument_list|(
name|Playersfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Other
argument_list|,
name|SZ_PLAYERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Playersfp
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|Other
operator|.
name|p_status
operator|!=
name|S_OFF
operator|&&
name|Other
operator|.
name|p_status
operator|!=
name|S_NOTUSED
operator|&&
name|Other
operator|.
name|p_status
operator|!=
name|S_HUNGUP
operator|&&
operator|(
name|Other
operator|.
name|p_status
operator|!=
name|S_CLOAKED
operator|||
name|Other
operator|.
name|p_specialtype
operator|!=
name|SC_VALAR
operator|)
condition|)
comment|/* player is on and not a cloaked valar */
block|{
operator|++
name|Users
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_x
operator|==
name|Other
operator|.
name|p_x
operator|&&
name|Player
operator|.
name|p_y
operator|==
name|Other
operator|.
name|p_y
comment|/* same coordinates */
operator|&&
name|foeloc
operator|!=
name|Fileloc
comment|/* not self */
operator|&&
name|Player
operator|.
name|p_status
operator|==
name|S_PLAYING
operator|&&
operator|(
name|Other
operator|.
name|p_status
operator|==
name|S_PLAYING
operator|||
name|Other
operator|.
name|p_status
operator|==
name|S_INBATTLE
operator|)
comment|/* both are playing */
operator|&&
name|Other
operator|.
name|p_specialtype
operator|!=
name|SC_VALAR
operator|&&
name|Player
operator|.
name|p_specialtype
operator|!=
name|SC_VALAR
condition|)
comment|/* neither is valar */
block|{
name|battleplayer
argument_list|(
name|foeloc
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|foeloc
operator|+=
name|SZ_PLAYERSTRUCT
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: battleplayer() / / FUNCTION: inter-terminal battle with another player / / AUTHOR: E. A. Estes, 2/15/86 / / ARGUMENTS: /	long foeplace - location in player file of person to battle / / RETURN VALUE: none / / MODULES CALLED: readrecord(), readmessage(), writerecord(), collecttaxes(), /	displaystats(), fabs(), more(), death(), sleep(), wmove(), waddch(), printw(), /	myturn(), altercoordinates(), waddstr(), wrefresh(), mvprintw(), /	getanswer(), wclrtoeol(), wclrtobot() / / GLOBAL INPUTS: Foestrikes, LINES, Lines, Other, Shield, Player, *stdscr, /	Fileloc, *Enemyname / / GLOBAL OUTPUTS: Foestrikes, Lines, Shield, Player, Luckout, *Enemyname / / DESCRIPTION: /	Inter-terminal battle is a very fragile and slightly klugy thing. /	At any time, one player is master and the other is slave. /	We pick who is master first by speed and level.  After that, /	the slave waits for the master to relinquish its turn, and /	the slave becomes master, and so on. / /	The items in the player structure which control the handshake are: /	    p_tampered: /		master increments this to relinquish control /	    p_istat: /		master sets this to specify particular action /	    p_1scratch: /		set to total damage inflicted so far; changes to indicate action / *************************************************************************/
end_comment

begin_macro
name|battleplayer
argument_list|(
argument|foeplace
argument_list|)
end_macro

begin_decl_stmt
name|long
name|foeplace
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|double
name|dtemp
decl_stmt|;
comment|/* for temporary calculations */
name|double
name|oldhits
init|=
literal|0.0
decl_stmt|;
comment|/* previous damage inflicted by foe */
name|int
name|loop
decl_stmt|;
comment|/* for timing out */
name|int
name|ch
decl_stmt|;
comment|/* input */
name|short
name|oldtampered
decl_stmt|;
comment|/* old value of foe's p_tampered */
name|Lines
operator|=
literal|8
expr_stmt|;
name|Luckout
operator|=
name|FALSE
expr_stmt|;
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"Preparing for battle!\n"
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|SYS5
name|flushinp
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* set up variables, file, etc. */
name|Player
operator|.
name|p_status
operator|=
name|S_INBATTLE
expr_stmt|;
name|Shield
operator|=
name|Player
operator|.
name|p_energy
expr_stmt|;
comment|/* if p_tampered is not 0, someone else may try to change it (king, etc.) */
name|Player
operator|.
name|p_tampered
operator|=
name|oldtampered
operator|=
literal|1
expr_stmt|;
name|Player
operator|.
name|p_1scratch
operator|=
literal|0.0
expr_stmt|;
name|Player
operator|.
name|p_istat
operator|=
name|I_OFF
expr_stmt|;
name|readrecord
argument_list|(
operator|&
name|Other
argument_list|,
name|foeplace
argument_list|)
expr_stmt|;
if|if
condition|(
name|fabs
argument_list|(
name|Player
operator|.
name|p_level
operator|-
name|Other
operator|.
name|p_level
argument_list|)
operator|>
literal|20.0
condition|)
comment|/* see if players are greatly mismatched */
block|{
name|dtemp
operator|=
operator|(
name|Player
operator|.
name|p_level
operator|-
name|Other
operator|.
name|p_level
operator|)
operator|/
name|MAX
argument_list|(
name|Player
operator|.
name|p_level
argument_list|,
name|Other
operator|.
name|p_level
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtemp
operator|<
operator|-
literal|0.5
condition|)
comment|/* foe outweighs this one */
name|Player
operator|.
name|p_speed
operator|*=
literal|2.0
expr_stmt|;
block|}
name|writerecord
argument_list|(
operator|&
name|Player
argument_list|,
name|Fileloc
argument_list|)
expr_stmt|;
comment|/* write out all our info */
if|if
condition|(
name|Player
operator|.
name|p_blindness
condition|)
name|Enemyname
operator|=
literal|"someone"
expr_stmt|;
else|else
name|Enemyname
operator|=
name|Other
operator|.
name|p_name
expr_stmt|;
name|mvprintw
argument_list|(
literal|6
argument_list|,
literal|0
argument_list|,
literal|"You have encountered %s   Level: %.0f\n"
argument_list|,
name|Enemyname
argument_list|,
name|Other
operator|.
name|p_level
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
for|for
control|(
name|loop
operator|=
literal|0
init|;
name|Other
operator|.
name|p_status
operator|!=
name|S_INBATTLE
operator|&&
name|loop
operator|<
literal|30
condition|;
operator|++
name|loop
control|)
comment|/* wait for foe to respond */
block|{
name|readrecord
argument_list|(
operator|&
name|Other
argument_list|,
name|foeplace
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Other
operator|.
name|p_status
operator|!=
name|S_INBATTLE
condition|)
comment|/* foe did not respond */
block|{
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"%s is not responding.\n"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
goto|goto
name|LEAVE
goto|;
block|}
comment|/* else, we are ready to battle */
name|move
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtoeol
argument_list|()
expr_stmt|;
comment|/*      * determine who is first master      * if neither player is faster, check level      * if neither level is greater, battle is not allowed      * (this should never happen, but we have to handle it)      */
if|if
condition|(
name|Player
operator|.
name|p_speed
operator|>
name|Other
operator|.
name|p_speed
condition|)
name|Foestrikes
operator|=
name|FALSE
expr_stmt|;
elseif|else
if|if
condition|(
name|Other
operator|.
name|p_speed
operator|>
name|Player
operator|.
name|p_speed
condition|)
name|Foestrikes
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_level
operator|>
name|Other
operator|.
name|p_level
condition|)
name|Foestrikes
operator|=
name|FALSE
expr_stmt|;
elseif|else
if|if
condition|(
name|Other
operator|.
name|p_level
operator|>
name|Player
operator|.
name|p_level
condition|)
name|Foestrikes
operator|=
name|TRUE
expr_stmt|;
else|else
comment|/* no one is faster */
block|{
name|printw
argument_list|(
literal|"You can't fight %s yet."
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
goto|goto
name|LEAVE
goto|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|displaystats
argument_list|()
expr_stmt|;
name|readmessage
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
literal|1
argument_list|,
literal|26
argument_list|,
literal|"%20.0f"
argument_list|,
name|Shield
argument_list|)
expr_stmt|;
comment|/* overprint energy */
if|if
condition|(
operator|!
name|Foestrikes
condition|)
comment|/* take action against foe */
name|myturn
argument_list|()
expr_stmt|;
else|else
comment|/* wait for foe to take action */
block|{
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"Waiting...\n"
argument_list|)
expr_stmt|;
name|clrtoeol
argument_list|()
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
for|for
control|(
name|loop
operator|=
literal|0
init|;
name|loop
operator|<
literal|20
condition|;
operator|++
name|loop
control|)
comment|/* wait for foe to act */
block|{
name|readrecord
argument_list|(
operator|&
name|Other
argument_list|,
name|foeplace
argument_list|)
expr_stmt|;
if|if
condition|(
name|Other
operator|.
name|p_1scratch
operator|!=
name|oldhits
condition|)
comment|/* p_1scratch changes to indicate action */
break|break;
else|else
comment|/* wait and try again */
block|{
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|addch
argument_list|(
literal|'.'
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|Other
operator|.
name|p_1scratch
operator|==
name|oldhits
condition|)
block|{
comment|/* timeout */
name|mvaddstr
argument_list|(
literal|22
argument_list|,
literal|0
argument_list|,
literal|"Timeout: waiting for response.  Do you want to wait ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"NY"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|move
argument_list|(
literal|22
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'Y'
condition|)
continue|continue;
else|else
break|break;
block|}
else|else
comment|/* foe took action */
block|{
switch|switch
condition|(
name|Other
operator|.
name|p_istat
condition|)
block|{
case|case
name|I_RAN
case|:
comment|/* foe ran away */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s ran away!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
break|break;
case|case
name|I_STUCK
case|:
comment|/* foe tried to run, but couldn't */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s tried to run away."
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
break|break;
case|case
name|I_BLEWIT
case|:
comment|/* foe tried to luckout, but didn't */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s tried to luckout!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
break|break;
default|default:
name|dtemp
operator|=
name|Other
operator|.
name|p_1scratch
operator|-
name|oldhits
expr_stmt|;
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s hit you %.0f times!"
argument_list|,
name|Enemyname
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
name|Shield
operator|-=
name|dtemp
expr_stmt|;
break|break;
block|}
name|oldhits
operator|=
name|Other
operator|.
name|p_1scratch
expr_stmt|;
comment|/* keep track of old hits */
if|if
condition|(
name|Other
operator|.
name|p_tampered
operator|!=
name|oldtampered
condition|)
comment|/* p_tampered changes to relinquish turn */
block|{
name|oldtampered
operator|=
name|Other
operator|.
name|p_tampered
expr_stmt|;
name|Foestrikes
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
block|}
comment|/* decide what happens next */
name|refresh
argument_list|()
expr_stmt|;
if|if
condition|(
name|Lines
operator|>
name|LINES
operator|-
literal|2
condition|)
block|{
name|more
argument_list|(
name|Lines
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|Lines
operator|=
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|Other
operator|.
name|p_istat
operator|==
name|I_KILLED
operator|||
name|Shield
operator|<
literal|0.0
condition|)
comment|/* we died */
block|{
name|Shield
operator|=
operator|-
literal|2.0
expr_stmt|;
comment|/* insure this value is negative */
break|break;
block|}
if|if
condition|(
name|Player
operator|.
name|p_istat
operator|==
name|I_KILLED
condition|)
comment|/* we killed foe; award treasre */
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You killed %s!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_experience
operator|+=
name|Other
operator|.
name|p_experience
expr_stmt|;
name|Player
operator|.
name|p_crowns
operator|+=
operator|(
name|Player
operator|.
name|p_level
operator|<
literal|1000.0
operator|)
condition|?
name|Other
operator|.
name|p_crowns
else|:
literal|0
expr_stmt|;
name|Player
operator|.
name|p_amulets
operator|+=
name|Other
operator|.
name|p_amulets
expr_stmt|;
name|Player
operator|.
name|p_charms
operator|+=
name|Other
operator|.
name|p_charms
expr_stmt|;
name|collecttaxes
argument_list|(
name|Other
operator|.
name|p_gold
argument_list|,
name|Other
operator|.
name|p_gems
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_sword
operator|=
name|MAX
argument_list|(
name|Player
operator|.
name|p_sword
argument_list|,
name|Other
operator|.
name|p_sword
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_shield
operator|=
name|MAX
argument_list|(
name|Player
operator|.
name|p_shield
argument_list|,
name|Other
operator|.
name|p_shield
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_quksilver
operator|=
name|MAX
argument_list|(
name|Player
operator|.
name|p_quksilver
argument_list|,
name|Other
operator|.
name|p_quksilver
argument_list|)
expr_stmt|;
if|if
condition|(
name|Other
operator|.
name|p_virgin
operator|&&
operator|!
name|Player
operator|.
name|p_virgin
condition|)
block|{
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You have rescued a virgin.  Will you be honorable ? "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|=
name|getanswer
argument_list|(
literal|"YN"
argument_list|,
name|FALSE
argument_list|)
operator|)
operator|==
literal|'Y'
condition|)
name|Player
operator|.
name|p_virgin
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
operator|++
name|Player
operator|.
name|p_sin
expr_stmt|;
name|Player
operator|.
name|p_experience
operator|+=
literal|8000.0
expr_stmt|;
block|}
block|}
name|sleep
argument_list|(
literal|3
argument_list|)
expr_stmt|;
comment|/* give other person time to die */
break|break;
block|}
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_istat
operator|==
name|I_RAN
operator|||
name|Other
operator|.
name|p_istat
operator|==
name|I_RAN
condition|)
comment|/* either player ran away */
break|break;
block|}
name|LEAVE
label|:
comment|/* clean up things and leave */
name|writerecord
argument_list|(
operator|&
name|Player
argument_list|,
name|Fileloc
argument_list|)
expr_stmt|;
comment|/* update a final time */
name|altercoordinates
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|A_NEAR
argument_list|)
expr_stmt|;
comment|/* move away from battle site */
name|Player
operator|.
name|p_energy
operator|=
name|Shield
expr_stmt|;
comment|/* set energy to actual value */
name|Player
operator|.
name|p_tampered
operator|=
name|T_OFF
expr_stmt|;
comment|/* clear p_tampered */
name|more
argument_list|(
name|Lines
argument_list|)
expr_stmt|;
comment|/* pause */
name|move
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
comment|/* clear bottom area of screen */
if|if
condition|(
name|Player
operator|.
name|p_energy
operator|<
literal|0.0
condition|)
comment|/* we are dead */
name|death
argument_list|(
literal|"Interterminal battle"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: myturn() / / FUNCTION: process players action against foe in battle / / AUTHOR: E. A. Estes, 2/7/86 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: writerecord(), inputoption(), floor(), wmove(), drandom(), /	waddstr(), wrefresh(), mvprintw(), wclrtoeol(), wclrtobot() / / GLOBAL INPUTS: Lines, Other, Player, *stdscr, Fileloc, Luckout, /	*Enemyname / / GLOBAL OUTPUTS: Foestrikes, Lines, Player, Luckout / / DESCRIPTION: /	Take action action against foe, and decide who is master /	for next iteration. / *************************************************************************/
end_comment

begin_macro
name|myturn
argument_list|()
end_macro

begin_block
block|{
name|double
name|dtemp
decl_stmt|;
comment|/* for temporary calculations */
name|int
name|ch
decl_stmt|;
comment|/* input */
name|mvaddstr
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|,
literal|"1:Fight  2:Run Away!  3:Power Blast  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Luckout
condition|)
name|clrtoeol
argument_list|()
expr_stmt|;
else|else
name|addstr
argument_list|(
literal|"4:Luckout  "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|inputoption
argument_list|()
expr_stmt|;
name|move
argument_list|(
name|Lines
operator|=
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
default|default:
comment|/* fight */
name|dtemp
operator|=
name|ROLL
argument_list|(
literal|2.0
argument_list|,
name|Player
operator|.
name|p_might
argument_list|)
expr_stmt|;
name|HIT
label|:
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You hit %s %.0f times!"
argument_list|,
name|Enemyname
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_sin
operator|+=
literal|0.5
expr_stmt|;
name|Player
operator|.
name|p_1scratch
operator|+=
name|dtemp
expr_stmt|;
name|Player
operator|.
name|p_istat
operator|=
name|I_OFF
expr_stmt|;
break|break;
case|case
literal|'2'
case|:
comment|/* run away */
name|Player
operator|.
name|p_1scratch
operator|-=
literal|1.0
expr_stmt|;
comment|/* change this to indicate action */
if|if
condition|(
name|drandom
argument_list|()
operator|>
literal|0.25
condition|)
block|{
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You got away!"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_istat
operator|=
name|I_RAN
expr_stmt|;
block|}
else|else
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s is still after you!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_istat
operator|=
name|I_STUCK
expr_stmt|;
block|}
break|break;
case|case
literal|'3'
case|:
comment|/* power blast */
name|dtemp
operator|=
name|MIN
argument_list|(
name|Player
operator|.
name|p_mana
argument_list|,
name|Player
operator|.
name|p_level
operator|*
literal|5.0
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|-=
name|dtemp
expr_stmt|;
name|dtemp
operator|*=
operator|(
name|drandom
argument_list|()
operator|+
literal|0.5
operator|)
operator|*
name|Player
operator|.
name|p_magiclvl
operator|*
literal|0.2
operator|+
literal|2.0
expr_stmt|;
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You blasted %s !"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
goto|goto
name|HIT
goto|;
case|case
literal|'4'
case|:
comment|/* luckout */
if|if
condition|(
name|Luckout
operator|||
name|drandom
argument_list|()
operator|>
literal|0.1
condition|)
block|{
if|if
condition|(
name|Luckout
condition|)
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You already tried that!"
argument_list|)
expr_stmt|;
else|else
block|{
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"Not this time . . ."
argument_list|)
expr_stmt|;
name|Luckout
operator|=
name|TRUE
expr_stmt|;
block|}
name|Player
operator|.
name|p_1scratch
operator|-=
literal|1.0
expr_stmt|;
name|Player
operator|.
name|p_istat
operator|=
name|I_BLEWIT
expr_stmt|;
block|}
else|else
block|{
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You just lucked out!"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_1scratch
operator|=
name|Other
operator|.
name|p_energy
operator|*
literal|1.1
expr_stmt|;
block|}
break|break;
block|}
name|refresh
argument_list|()
expr_stmt|;
name|Player
operator|.
name|p_1scratch
operator|=
name|floor
argument_list|(
name|Player
operator|.
name|p_1scratch
argument_list|)
expr_stmt|;
comment|/* clean up any mess */
if|if
condition|(
name|Player
operator|.
name|p_1scratch
operator|>
name|Other
operator|.
name|p_energy
condition|)
name|Player
operator|.
name|p_istat
operator|=
name|I_KILLED
expr_stmt|;
elseif|else
if|if
condition|(
name|drandom
argument_list|()
operator|*
name|Player
operator|.
name|p_speed
operator|<
name|drandom
argument_list|()
operator|*
name|Other
operator|.
name|p_speed
condition|)
comment|/* relinquish control */
block|{
operator|++
name|Player
operator|.
name|p_tampered
expr_stmt|;
name|Foestrikes
operator|=
name|TRUE
expr_stmt|;
block|}
name|writerecord
argument_list|(
operator|&
name|Player
argument_list|,
name|Fileloc
argument_list|)
expr_stmt|;
comment|/* let foe know what we did */
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: checktampered() / / FUNCTION: check if current player has been tampered with / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: readrecord(), fread(), fseek(), tampered(), writevoid() / / GLOBAL INPUTS: *Energyvoidfp, Other, Player, Fileloc, Enrgyvoid / / GLOBAL OUTPUTS: Enrgyvoid / / DESCRIPTION: /	Check for energy voids, holy grail, and tampering by other /	players. / *************************************************************************/
end_comment

begin_macro
name|checktampered
argument_list|()
end_macro

begin_block
block|{
name|long
name|loc
init|=
literal|0L
decl_stmt|;
comment|/* location in energy void file */
comment|/* first check for energy voids */
name|fseek
argument_list|(
name|Energyvoidfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Enrgyvoid
argument_list|,
name|SZ_VOIDSTRUCT
argument_list|,
literal|1
argument_list|,
name|Energyvoidfp
argument_list|)
operator|==
literal|1
condition|)
if|if
condition|(
name|Enrgyvoid
operator|.
name|ev_active
operator|&&
name|Enrgyvoid
operator|.
name|ev_x
operator|==
name|Player
operator|.
name|p_x
operator|&&
name|Enrgyvoid
operator|.
name|ev_y
operator|==
name|Player
operator|.
name|p_y
condition|)
comment|/* sitting on one */
block|{
if|if
condition|(
name|loc
operator|>
literal|0L
condition|)
comment|/* not the holy grail; inactivate energy void */
block|{
name|Enrgyvoid
operator|.
name|ev_active
operator|=
name|FALSE
expr_stmt|;
name|writevoid
argument_list|(
operator|&
name|Enrgyvoid
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|tampered
argument_list|(
name|T_NRGVOID
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_status
operator|!=
name|S_CLOAKED
condition|)
comment|/* holy grail */
name|tampered
argument_list|(
name|T_GRAIL
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
name|loc
operator|+=
name|SZ_VOIDSTRUCT
expr_stmt|;
comment|/* now check for other things */
name|readrecord
argument_list|(
operator|&
name|Other
argument_list|,
name|Fileloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|Other
operator|.
name|p_tampered
operator|!=
name|T_OFF
condition|)
name|tampered
argument_list|(
name|Other
operator|.
name|p_tampered
argument_list|,
name|Other
operator|.
name|p_1scratch
argument_list|,
name|Other
operator|.
name|p_2scratch
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: tampered() / / FUNCTION: take care of tampering by other players / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	int what - what type of tampering /	double arg1, arg2 - rest of tampering info / / RETURN VALUE: none / / MODULES CALLED: writerecord(), more(), fread(), death(), fseek(), sleep(), /	floor(), wmove(), waddch(), drandom(), printw(), altercoordinates(), /	waddstr(), wrefresh(), encounter(), writevoid() / / GLOBAL INPUTS: Other, Player, *stdscr, Enrgyvoid, *Playersfp / / GLOBAL OUTPUTS: Other, Player, Changed, Enrgyvoid / / DESCRIPTION: /	Take care of energy voids, holy grail, decree and intervention /	action on current player. / *************************************************************************/
end_comment

begin_macro
name|tampered
argument_list|(
argument|what
argument_list|,
argument|arg1
argument_list|,
argument|arg2
argument_list|)
end_macro

begin_decl_stmt
name|int
name|what
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|arg1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|arg2
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|long
name|loc
decl_stmt|;
comment|/* location in file of other players */
name|Changed
operator|=
name|TRUE
expr_stmt|;
name|move
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_tampered
operator|=
name|T_OFF
expr_stmt|;
comment|/* no longer tampered with */
switch|switch
condition|(
name|what
condition|)
block|{
case|case
name|T_NRGVOID
case|:
name|addstr
argument_list|(
literal|"You've hit an energy void !\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|/=
literal|3.0
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|/=
literal|2.0
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|=
name|floor
argument_list|(
name|Player
operator|.
name|p_gold
operator|/
literal|1.25
argument_list|)
operator|+
literal|0.1
expr_stmt|;
name|altercoordinates
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|A_NEAR
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_TRANSPORT
case|:
name|addstr
argument_list|(
literal|"The king transported you !  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_charms
operator|>
literal|0
condition|)
block|{
name|addstr
argument_list|(
literal|"But your charm saved you. . .\n"
argument_list|)
expr_stmt|;
operator|--
name|Player
operator|.
name|p_charms
expr_stmt|;
block|}
else|else
block|{
name|altercoordinates
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|A_FAR
argument_list|)
expr_stmt|;
name|addch
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|T_BESTOW
case|:
name|printw
argument_list|(
literal|"The king has bestowed %.0f gold pieces on you !\n"
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|+=
name|arg1
expr_stmt|;
break|break;
case|case
name|T_CURSED
case|:
name|addstr
argument_list|(
literal|"You've been cursed !  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_blessing
condition|)
block|{
name|addstr
argument_list|(
literal|"But your blessing saved you. . .\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_blessing
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
name|addch
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_poison
operator|+=
literal|2.0
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|=
literal|10.0
expr_stmt|;
name|Player
operator|.
name|p_maxenergy
operator|*=
literal|0.95
expr_stmt|;
name|Player
operator|.
name|p_status
operator|=
name|S_PLAYING
expr_stmt|;
comment|/* no longer cloaked */
block|}
break|break;
case|case
name|T_VAPORIZED
case|:
name|addstr
argument_list|(
literal|"You have been vaporized!\n"
argument_list|)
expr_stmt|;
name|more
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|death
argument_list|(
literal|"Vaporization"
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_MONSTER
case|:
name|addstr
argument_list|(
literal|"The Valar zapped you with a monster!\n"
argument_list|)
expr_stmt|;
name|more
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|encounter
argument_list|(
operator|(
name|int
operator|)
name|arg1
argument_list|)
expr_stmt|;
return|return;
case|case
name|T_BLESSED
case|:
name|addstr
argument_list|(
literal|"The Valar has blessed you!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|=
operator|(
name|Player
operator|.
name|p_maxenergy
operator|*=
literal|1.05
operator|)
operator|+
name|Player
operator|.
name|p_shield
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|+=
literal|500.0
expr_stmt|;
name|Player
operator|.
name|p_strength
operator|+=
literal|0.5
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|+=
literal|0.5
expr_stmt|;
name|Player
operator|.
name|p_magiclvl
operator|+=
literal|0.5
expr_stmt|;
name|Player
operator|.
name|p_poison
operator|=
name|MIN
argument_list|(
literal|0.5
argument_list|,
name|Player
operator|.
name|p_poison
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_RELOCATE
case|:
name|addstr
argument_list|(
literal|"You've been relocated. . .\n"
argument_list|)
expr_stmt|;
name|altercoordinates
argument_list|(
name|arg1
argument_list|,
name|arg2
argument_list|,
name|A_FORCED
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_HEAL
case|:
name|addstr
argument_list|(
literal|"You've been healed!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_poison
operator|-=
literal|0.25
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|=
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_shield
expr_stmt|;
break|break;
case|case
name|T_EXVALAR
case|:
name|addstr
argument_list|(
literal|"You are no longer Valar!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_specialtype
operator|=
name|SC_COUNCIL
expr_stmt|;
break|break;
case|case
name|T_GRAIL
case|:
name|addstr
argument_list|(
literal|"You have found The Holy Grail!!\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|<
name|SC_COUNCIL
condition|)
comment|/* must be council of wise to behold grail */
block|{
name|addstr
argument_list|(
literal|"However, you are not experienced enough to behold it.\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_sin
operator|*=
name|Player
operator|.
name|p_sin
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|+=
literal|1000
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|==
name|SC_VALAR
operator|||
name|Player
operator|.
name|p_specialtype
operator|==
name|SC_EXVALAR
condition|)
block|{
name|addstr
argument_list|(
literal|"You have made it to the position of Valar once already.\n"
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"The Grail is of no more use to you now.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|addstr
argument_list|(
literal|"It is now time to see if you are worthy to behold it. . .\n"
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
name|sleep
argument_list|(
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|/
literal|2.0
operator|<
name|Player
operator|.
name|p_sin
condition|)
block|{
name|addstr
argument_list|(
literal|"You have failed!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_strength
operator|=
name|Player
operator|.
name|p_mana
operator|=
name|Player
operator|.
name|p_energy
operator|=
name|Player
operator|.
name|p_maxenergy
operator|=
name|Player
operator|.
name|p_magiclvl
operator|=
name|Player
operator|.
name|p_brains
operator|=
name|Player
operator|.
name|p_experience
operator|=
name|Player
operator|.
name|p_quickness
operator|=
literal|1.0
expr_stmt|;
name|altercoordinates
argument_list|(
literal|1.0
argument_list|,
literal|1.0
argument_list|,
name|A_FORCED
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_level
operator|=
literal|0.0
expr_stmt|;
block|}
else|else
block|{
name|addstr
argument_list|(
literal|"You made to position of Valar!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_specialtype
operator|=
name|SC_VALAR
expr_stmt|;
name|Player
operator|.
name|p_lives
operator|=
literal|5
expr_stmt|;
name|fseek
argument_list|(
name|Playersfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|loc
operator|=
literal|0L
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Other
argument_list|,
name|SZ_PLAYERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Playersfp
argument_list|)
operator|==
literal|1
condition|)
comment|/* search for existing valar */
if|if
condition|(
name|Other
operator|.
name|p_specialtype
operator|==
name|SC_VALAR
operator|&&
name|Other
operator|.
name|p_status
operator|!=
name|S_NOTUSED
condition|)
comment|/* found old valar */
block|{
name|Other
operator|.
name|p_tampered
operator|=
name|T_EXVALAR
expr_stmt|;
name|writerecord
argument_list|(
operator|&
name|Other
argument_list|,
name|loc
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
name|loc
operator|+=
name|SZ_PLAYERSTRUCT
expr_stmt|;
block|}
block|}
comment|/* move grail to new location */
name|Enrgyvoid
operator|.
name|ev_active
operator|=
name|TRUE
expr_stmt|;
name|Enrgyvoid
operator|.
name|ev_x
operator|=
name|ROLL
argument_list|(
operator|-
literal|1.0e6
argument_list|,
literal|2.0e6
argument_list|)
expr_stmt|;
name|Enrgyvoid
operator|.
name|ev_y
operator|=
name|ROLL
argument_list|(
operator|-
literal|1.0e6
argument_list|,
literal|2.0e6
argument_list|)
expr_stmt|;
name|writevoid
argument_list|(
operator|&
name|Enrgyvoid
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
break|break;
block|}
name|refresh
argument_list|()
expr_stmt|;
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: userlist() / / FUNCTION: print list of players and locations / / AUTHOR: E. A. Estes, 2/28/86 / / ARGUMENTS: /	bool ingameflag - set if called while playing / / RETURN VALUE: none / / MODULES CALLED: descrstatus(), descrlocation(), more(), fread(), fseek(), /	floor(), wmove(), printw(), waddstr(), distance(), wrefresh(), /	descrtype(), wclrtobot() / / GLOBAL INPUTS: LINES, Other, Circle, Wizard, Player, *stdscr, *Playersfp / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	We can only see the coordinate of those closer to the origin /	from us. /	Kings and council of the wise can see and can be seen by everyone. /	Palantirs are good for seeing everyone; and the valar can use /	one to see through a 'cloak' spell. /	The valar has no coordinates, and is completely invisible if /	cloaked. / *************************************************************************/
end_comment

begin_macro
name|userlist
argument_list|(
argument|ingameflag
argument_list|)
end_macro

begin_decl_stmt
name|bool
name|ingameflag
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|numusers
init|=
literal|0
decl_stmt|;
comment|/* number of users on file */
if|if
condition|(
name|ingameflag
operator|&&
name|Player
operator|.
name|p_blindness
condition|)
block|{
name|mvaddstr
argument_list|(
literal|8
argument_list|,
literal|0
argument_list|,
literal|"You cannot see anyone.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|fseek
argument_list|(
name|Playersfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|8
argument_list|,
literal|0
argument_list|,
literal|"Name                         X         Y    Lvl Type Login    Status\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Other
argument_list|,
name|SZ_PLAYERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Playersfp
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|Other
operator|.
name|p_status
operator|==
name|S_NOTUSED
comment|/* record is unused */
operator|||
operator|(
name|Other
operator|.
name|p_specialtype
operator|==
name|SC_VALAR
operator|&&
name|Other
operator|.
name|p_status
operator|==
name|S_CLOAKED
operator|)
condition|)
comment|/* cloaked valar */
block|{
if|if
condition|(
operator|!
name|Wizard
condition|)
comment|/* wizard can see everything on file */
continue|continue;
block|}
operator|++
name|numusers
expr_stmt|;
if|if
condition|(
name|ingameflag
operator|&&
comment|/* must be playing for the rest of these conditions */
operator|(
name|Player
operator|.
name|p_specialtype
operator|>=
name|SC_KING
comment|/* kings and higher can see others */
operator|||
name|Other
operator|.
name|p_specialtype
operator|>=
name|SC_KING
comment|/* kings and higher can be seen by others */
operator|||
name|Circle
operator|>=
name|CIRCLE
argument_list|(
name|Other
operator|.
name|p_x
argument_list|,
name|Other
operator|.
name|p_y
argument_list|)
comment|/* those nearer the origin can be seen */
operator|||
name|Player
operator|.
name|p_palantir
operator|)
comment|/* palantir enables one to see others */
operator|&&
operator|(
name|Other
operator|.
name|p_status
operator|!=
name|S_CLOAKED
operator|||
operator|(
name|Player
operator|.
name|p_specialtype
operator|==
name|SC_VALAR
operator|&&
name|Player
operator|.
name|p_palantir
operator|)
operator|)
comment|/* not cloaked; valar can see through cloak with a palantir */
operator|&&
name|Other
operator|.
name|p_specialtype
operator|!=
name|SC_VALAR
condition|)
comment|/* not a valar */
comment|/* coordinates should be printed */
name|printw
argument_list|(
literal|"%-20s  %8.0f  %8.0f "
argument_list|,
name|Other
operator|.
name|p_name
argument_list|,
name|Other
operator|.
name|p_x
argument_list|,
name|Other
operator|.
name|p_y
argument_list|)
expr_stmt|;
else|else
comment|/* cannot see player's coordinates */
name|printw
argument_list|(
literal|"%-20s %19.19s "
argument_list|,
name|Other
operator|.
name|p_name
argument_list|,
name|descrlocation
argument_list|(
operator|&
name|Other
argument_list|,
name|TRUE
argument_list|)
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"%6.0f %s  %-9.9s%s\n"
argument_list|,
name|Other
operator|.
name|p_level
argument_list|,
name|descrtype
argument_list|(
operator|&
name|Other
argument_list|,
name|TRUE
argument_list|)
argument_list|,
name|Other
operator|.
name|p_login
argument_list|,
name|descrstatus
argument_list|(
operator|&
name|Other
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|numusers
operator|%
operator|(
name|LINES
operator|-
literal|10
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|more
argument_list|(
name|LINES
operator|-
literal|1
argument_list|)
expr_stmt|;
name|move
argument_list|(
literal|9
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
block|}
block|}
name|printw
argument_list|(
literal|"Total players on file = %d\n"
argument_list|,
name|numusers
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: throneroom() / / FUNCTION: king stuff upon entering throne / / AUTHOR: E. A. Estes, 12/16/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: writerecord(), fread(), fseek(), fopen(), wmove(), fclose(), /	fwrite(), altercoordinates(), waddstr(), fprintf() / / GLOBAL INPUTS: *Energyvoidfp, Other, Player, *stdscr, /	Enrgyvoid, *Playersfp / / GLOBAL OUTPUTS: Other, Player, Changed / / DESCRIPTION: /	If player is not already king, make him/her so if the old king /	is not playing. /	Clear energy voids with new king. /	Print 'decree' prompt. / *************************************************************************/
end_comment

begin_macro
name|throneroom
argument_list|()
end_macro

begin_block
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
comment|/* to clear energy voids */
name|long
name|loc
init|=
literal|0L
decl_stmt|;
comment|/* location of old king in player file */
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|<
name|SC_KING
condition|)
comment|/* not already king -- assumes crown */
block|{
name|fseek
argument_list|(
name|Playersfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Other
argument_list|,
name|SZ_PLAYERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Playersfp
argument_list|)
operator|==
literal|1
condition|)
if|if
condition|(
name|Other
operator|.
name|p_specialtype
operator|==
name|SC_KING
operator|&&
name|Other
operator|.
name|p_status
operator|!=
name|S_NOTUSED
condition|)
comment|/* found old king */
block|{
if|if
condition|(
name|Other
operator|.
name|p_status
operator|!=
name|S_OFF
condition|)
comment|/* old king is playing */
block|{
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"The king is playing, so you cannot steal his throne\n"
argument_list|)
expr_stmt|;
name|altercoordinates
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|A_NEAR
argument_list|)
expr_stmt|;
name|move
argument_list|(
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
comment|/* old king is not playing - remove him/her */
block|{
name|Other
operator|.
name|p_specialtype
operator|=
name|SC_NONE
expr_stmt|;
if|if
condition|(
name|Other
operator|.
name|p_crowns
condition|)
operator|--
name|Other
operator|.
name|p_crowns
expr_stmt|;
name|writerecord
argument_list|(
operator|&
name|Other
argument_list|,
name|loc
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
name|loc
operator|+=
name|SZ_PLAYERSTRUCT
expr_stmt|;
comment|/* make player new king */
name|Changed
operator|=
name|TRUE
expr_stmt|;
name|Player
operator|.
name|p_specialtype
operator|=
name|SC_KING
expr_stmt|;
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"You have become king!\n"
argument_list|)
expr_stmt|;
comment|/* let everyone else know */
name|fp
operator|=
name|fopen
argument_list|(
name|_PATH_MESS
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"All hail the new king!"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* clear all energy voids; retain location of holy grail */
name|fseek
argument_list|(
name|Energyvoidfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Enrgyvoid
argument_list|,
name|SZ_VOIDSTRUCT
argument_list|,
literal|1
argument_list|,
name|Energyvoidfp
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
name|_PATH_VOID
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Enrgyvoid
argument_list|,
name|SZ_VOIDSTRUCT
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
name|mvaddstr
argument_list|(
literal|6
argument_list|,
literal|0
argument_list|,
literal|"0:Decree  "
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: dotampered() / / FUNCTION: king and valar special options / / AUTHOR: E. A. Estes, 2/28/86 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: writerecord(), truncstring(), fread(), fseek(), fopen(), /	floor(), wmove(), drandom(), fclose(), fwrite(), sscanf(), strcmp(), /	infloat(), waddstr(), findname(), distance(), userlist(), mvprintw(), /	allocvoid(), getanswer(), getstring(), wclrtoeol(), writevoid() / / GLOBAL INPUTS: *Energyvoidfp, Other, Illcmd[], Wizard, Player, *stdscr, /	Databuf[], Enrgyvoid / / GLOBAL OUTPUTS: Other, Player, Enrgyvoid / / DESCRIPTION: /	Tamper with other players.  Handle king/valar specific options. / *************************************************************************/
end_comment

begin_macro
name|dotampered
argument_list|()
end_macro

begin_block
block|{
name|short
name|tamper
decl_stmt|;
comment|/* value for tampering with other players */
name|char
modifier|*
name|option
decl_stmt|;
comment|/* pointer to option description */
name|double
name|temp1
init|=
literal|0.0
decl_stmt|,
name|temp2
init|=
literal|0.0
decl_stmt|;
comment|/* other tampering values */
name|int
name|ch
decl_stmt|;
comment|/* input */
name|long
name|loc
decl_stmt|;
comment|/* location in energy void file */
name|FILE
modifier|*
name|fp
decl_stmt|;
comment|/* for opening gold file */
name|move
argument_list|(
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtoeol
argument_list|()
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|<
name|SC_COUNCIL
operator|&&
operator|!
name|Wizard
condition|)
comment|/* king options */
block|{
name|addstr
argument_list|(
literal|"1:Transport  2:Curse  3:Energy Void  4:Bestow  5:Collect Taxes  "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|" "
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|move
argument_list|(
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtoeol
argument_list|()
expr_stmt|;
name|move
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'1'
case|:
comment|/* transport someone */
name|tamper
operator|=
name|T_TRANSPORT
expr_stmt|;
name|option
operator|=
literal|"transport"
expr_stmt|;
break|break;
case|case
literal|'2'
case|:
comment|/* curse another */
name|tamper
operator|=
name|T_CURSED
expr_stmt|;
name|option
operator|=
literal|"curse"
expr_stmt|;
break|break;
case|case
literal|'3'
case|:
comment|/* create energy void */
if|if
condition|(
operator|(
name|loc
operator|=
name|allocvoid
argument_list|()
operator|)
operator|>
literal|20L
operator|*
name|SZ_VOIDSTRUCT
condition|)
comment|/* can only have 20 void active at once */
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"Sorry, void creation limit reached.\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|addstr
argument_list|(
literal|"Enter the X Y coordinates of void ? "
argument_list|)
expr_stmt|;
name|getstring
argument_list|(
name|Databuf
argument_list|,
name|SZ_DATABUF
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|Databuf
argument_list|,
literal|"%lf %lf"
argument_list|,
operator|&
name|temp1
argument_list|,
operator|&
name|temp2
argument_list|)
expr_stmt|;
name|Enrgyvoid
operator|.
name|ev_x
operator|=
name|floor
argument_list|(
name|temp1
argument_list|)
expr_stmt|;
name|Enrgyvoid
operator|.
name|ev_y
operator|=
name|floor
argument_list|(
name|temp2
argument_list|)
expr_stmt|;
name|Enrgyvoid
operator|.
name|ev_active
operator|=
name|TRUE
expr_stmt|;
name|writevoid
argument_list|(
operator|&
name|Enrgyvoid
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"It is done.\n"
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
literal|'4'
case|:
comment|/* bestow gold to subject */
name|tamper
operator|=
name|T_BESTOW
expr_stmt|;
name|addstr
argument_list|(
literal|"How much gold to bestow ? "
argument_list|)
expr_stmt|;
name|temp1
operator|=
name|infloat
argument_list|()
expr_stmt|;
if|if
condition|(
name|temp1
operator|>
name|Player
operator|.
name|p_gold
operator|||
name|temp1
operator|<
literal|0
condition|)
block|{
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"You don't have that !\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* adjust gold after we are sure it will be given to someone */
name|option
operator|=
literal|"give gold to"
expr_stmt|;
break|break;
case|case
literal|'5'
case|:
comment|/* collect accumulated taxes */
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|_PATH_GOLD
argument_list|,
literal|"r+"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
comment|/* collect taxes */
block|{
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|temp1
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|fp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* clear out value */
name|temp2
operator|=
literal|0.0
expr_stmt|;
name|fwrite
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|temp2
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
name|mvprintw
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"You have collected %.0f in gold.\n"
argument_list|,
name|temp1
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|+=
name|floor
argument_list|(
name|temp1
argument_list|)
expr_stmt|;
return|return;
default|default:
return|return;
block|}
comment|/* end of king options */
block|}
else|else
comment|/* council of wise, valar, wizard options */
block|{
name|addstr
argument_list|(
literal|"1:Heal  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_palantir
operator|||
name|Wizard
condition|)
name|addstr
argument_list|(
literal|"2:Seek Grail  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|==
name|SC_VALAR
operator|||
name|Wizard
condition|)
name|addstr
argument_list|(
literal|"3:Throw Monster  4:Relocate  5:Bless  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Wizard
condition|)
name|addstr
argument_list|(
literal|"6:Vaporize  "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|" "
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Wizard
condition|)
block|{
if|if
condition|(
name|ch
operator|>
literal|'2'
operator|&&
name|Player
operator|.
name|p_specialtype
operator|!=
name|SC_VALAR
condition|)
block|{
name|ILLCMD
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|Player
operator|.
name|p_mana
operator|<
name|MM_INTERVENE
condition|)
block|{
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"No mana left.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
name|Player
operator|.
name|p_mana
operator|-=
name|MM_INTERVENE
expr_stmt|;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'1'
case|:
comment|/* heal another */
name|tamper
operator|=
name|T_HEAL
expr_stmt|;
name|option
operator|=
literal|"heal"
expr_stmt|;
break|break;
case|case
literal|'2'
case|:
comment|/* seek grail */
if|if
condition|(
name|Player
operator|.
name|p_palantir
condition|)
comment|/* need a palantir to seek */
block|{
name|fseek
argument_list|(
name|Energyvoidfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Enrgyvoid
argument_list|,
name|SZ_VOIDSTRUCT
argument_list|,
literal|1
argument_list|,
name|Energyvoidfp
argument_list|)
expr_stmt|;
name|temp1
operator|=
name|distance
argument_list|(
name|Player
operator|.
name|p_x
argument_list|,
name|Enrgyvoid
operator|.
name|ev_x
argument_list|,
name|Player
operator|.
name|p_y
argument_list|,
name|Enrgyvoid
operator|.
name|ev_y
argument_list|)
expr_stmt|;
name|temp1
operator|+=
name|ROLL
argument_list|(
operator|-
name|temp1
operator|/
literal|10.0
argument_list|,
name|temp1
operator|/
literal|5.0
argument_list|)
expr_stmt|;
comment|/* add some error */
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"The palantir says the Grail is about %.0f away.\n"
argument_list|,
name|temp1
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* no palantir */
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"You need a palantir to seek the Grail.\n"
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'3'
case|:
comment|/* lob monster at someone */
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"Which monster [0-99] ? "
argument_list|)
expr_stmt|;
name|temp1
operator|=
name|infloat
argument_list|()
expr_stmt|;
name|temp1
operator|=
name|MAX
argument_list|(
literal|0.0
argument_list|,
name|MIN
argument_list|(
literal|99.0
argument_list|,
name|temp1
argument_list|)
argument_list|)
expr_stmt|;
name|tamper
operator|=
name|T_MONSTER
expr_stmt|;
name|option
operator|=
literal|"throw a monster at"
expr_stmt|;
break|break;
case|case
literal|'4'
case|:
comment|/* move another player */
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"New X Y coordinates ? "
argument_list|)
expr_stmt|;
name|getstring
argument_list|(
name|Databuf
argument_list|,
name|SZ_DATABUF
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|Databuf
argument_list|,
literal|"%lf %lf"
argument_list|,
operator|&
name|temp1
argument_list|,
operator|&
name|temp2
argument_list|)
expr_stmt|;
name|tamper
operator|=
name|T_RELOCATE
expr_stmt|;
name|option
operator|=
literal|"relocate"
expr_stmt|;
break|break;
case|case
literal|'5'
case|:
comment|/* bless a player */
name|tamper
operator|=
name|T_BLESSED
expr_stmt|;
name|option
operator|=
literal|"bless"
expr_stmt|;
break|break;
case|case
literal|'6'
case|:
comment|/* kill off a player */
if|if
condition|(
name|Wizard
condition|)
block|{
name|tamper
operator|=
name|T_VAPORIZED
expr_stmt|;
name|option
operator|=
literal|"vaporize"
expr_stmt|;
break|break;
block|}
else|else
return|return;
default|default:
return|return;
block|}
comment|/* adjust age after we are sure intervention will be done */
comment|/* end of valar, etc. options */
block|}
for|for
control|(
init|;
condition|;
control|)
comment|/* prompt for player to affect */
block|{
name|mvprintw
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"Who do you want to %s ? "
argument_list|,
name|option
argument_list|)
expr_stmt|;
name|getstring
argument_list|(
name|Databuf
argument_list|,
name|SZ_DATABUF
argument_list|)
expr_stmt|;
name|truncstring
argument_list|(
name|Databuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|Databuf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|userlist
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
else|else
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|Player
operator|.
name|p_name
argument_list|,
name|Databuf
argument_list|)
operator|!=
literal|0
condition|)
comment|/* name other than self */
block|{
if|if
condition|(
operator|(
name|loc
operator|=
name|findname
argument_list|(
name|Databuf
argument_list|,
operator|&
name|Other
argument_list|)
operator|)
operator|>=
literal|0L
condition|)
block|{
if|if
condition|(
name|Other
operator|.
name|p_tampered
operator|!=
name|T_OFF
condition|)
block|{
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"That person has something pending already.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
if|if
condition|(
name|tamper
operator|==
name|T_RELOCATE
operator|&&
name|CIRCLE
argument_list|(
name|temp1
argument_list|,
name|temp2
argument_list|)
operator|<
name|CIRCLE
argument_list|(
name|Other
operator|.
name|p_x
argument_list|,
name|Other
operator|.
name|p_y
argument_list|)
operator|&&
operator|!
name|Wizard
condition|)
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"Cannot move someone closer to the Lord's Chamber.\n"
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|tamper
operator|==
name|T_BESTOW
condition|)
name|Player
operator|.
name|p_gold
operator|-=
name|floor
argument_list|(
name|temp1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Wizard
operator|&&
operator|(
name|tamper
operator|==
name|T_HEAL
operator|||
name|tamper
operator|==
name|T_MONSTER
operator|||
name|tamper
operator|==
name|T_RELOCATE
operator|||
name|tamper
operator|==
name|T_BLESSED
operator|)
condition|)
name|Player
operator|.
name|p_age
operator|+=
name|N_AGE
expr_stmt|;
comment|/* age penalty */
name|Other
operator|.
name|p_tampered
operator|=
name|tamper
expr_stmt|;
name|Other
operator|.
name|p_1scratch
operator|=
name|floor
argument_list|(
name|temp1
argument_list|)
expr_stmt|;
name|Other
operator|.
name|p_2scratch
operator|=
name|floor
argument_list|(
name|temp2
argument_list|)
expr_stmt|;
name|writerecord
argument_list|(
operator|&
name|Other
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"It is done.\n"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
block|}
else|else
comment|/* player not found */
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"There is no one by that name.\n"
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* self */
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"You may not do it to yourself!\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: writevoid() / / FUNCTION: update energy void entry in energy void file / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	struct energyvoid *vp - pointer to structure to write to file /	long loc - location in file to update / / RETURN VALUE: none / / MODULES CALLED: fseek(), fwrite(), fflush() / / GLOBAL INPUTS: *Energyvoidfp / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Write out energy void structure at specified location. / *************************************************************************/
end_comment

begin_macro
name|writevoid
argument_list|(
argument|vp
argument_list|,
argument|loc
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|energyvoid
modifier|*
name|vp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|loc
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fseek
argument_list|(
name|Energyvoidfp
argument_list|,
name|loc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
operator|(
name|char
operator|*
operator|)
name|vp
argument_list|,
name|SZ_VOIDSTRUCT
argument_list|,
literal|1
argument_list|,
name|Energyvoidfp
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|Energyvoidfp
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|Energyvoidfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: allocvoid() / / FUNCTION: allocate space for a new energy void / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: location of new energy void space / / MODULES CALLED: fread(), fseek() / / GLOBAL INPUTS: *Energyvoidfp, Enrgyvoid / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Search energy void file for an inactive entry and return its /	location. /	If no inactive ones are found, return one more than last location. / *************************************************************************/
end_comment

begin_function
name|long
name|allocvoid
parameter_list|()
block|{
name|long
name|loc
init|=
literal|0L
decl_stmt|;
comment|/* location of new energy void */
name|fseek
argument_list|(
name|Energyvoidfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Enrgyvoid
argument_list|,
name|SZ_VOIDSTRUCT
argument_list|,
literal|1
argument_list|,
name|Energyvoidfp
argument_list|)
operator|==
literal|1
condition|)
if|if
condition|(
name|Enrgyvoid
operator|.
name|ev_active
condition|)
name|loc
operator|+=
name|SZ_VOIDSTRUCT
expr_stmt|;
else|else
break|break;
return|return
operator|(
name|loc
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * misc.c  Phantasia miscellaneous support routines  */
end_comment

begin_include
include|#
directive|include
file|"include.h"
end_include

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: movelevel() / / FUNCTION: move player to new level / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: death(), floor(), wmove(), drandom(), waddstr(), explevel() / / GLOBAL INPUTS: Player, *stdscr, *Statptr, Stattable[] / / GLOBAL OUTPUTS: Player, Changed / / DESCRIPTION: /	Use lookup table to increment important statistics when /	progressing to new experience level. /	Players are rested to maximum as a bonus for making a new /	level. /	Check for council of wise, and being too big to be king. / /************************************************************************/
end_comment

begin_macro
name|movelevel
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|charstats
modifier|*
name|statptr
decl_stmt|;
comment|/* for pointing into Stattable */
name|double
name|new
decl_stmt|;
comment|/* new level */
name|double
name|inc
decl_stmt|;
comment|/* increment between new and old levels */
name|Changed
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_type
operator|==
name|C_EXPER
condition|)
comment|/* roll a type to use for increment */
name|statptr
operator|=
operator|&
name|Stattable
index|[
operator|(
name|int
operator|)
name|ROLL
argument_list|(
name|C_MAGIC
argument_list|,
name|C_HALFLING
operator|-
name|C_MAGIC
operator|+
literal|1
argument_list|)
index|]
expr_stmt|;
else|else
name|statptr
operator|=
name|Statptr
expr_stmt|;
name|new
operator|=
name|explevel
argument_list|(
name|Player
operator|.
name|p_experience
argument_list|)
expr_stmt|;
name|inc
operator|=
name|new
operator|-
name|Player
operator|.
name|p_level
expr_stmt|;
name|Player
operator|.
name|p_level
operator|=
name|new
expr_stmt|;
comment|/* add increments to statistics */
name|Player
operator|.
name|p_strength
operator|+=
name|statptr
operator|->
name|c_strength
operator|.
name|increase
operator|*
name|inc
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|+=
name|statptr
operator|->
name|c_mana
operator|.
name|increase
operator|*
name|inc
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|+=
name|statptr
operator|->
name|c_brains
operator|.
name|increase
operator|*
name|inc
expr_stmt|;
name|Player
operator|.
name|p_magiclvl
operator|+=
name|statptr
operator|->
name|c_magiclvl
operator|.
name|increase
operator|*
name|inc
expr_stmt|;
name|Player
operator|.
name|p_maxenergy
operator|+=
name|statptr
operator|->
name|c_energy
operator|.
name|increase
operator|*
name|inc
expr_stmt|;
comment|/* rest to maximum upon reaching new level */
name|Player
operator|.
name|p_energy
operator|=
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_shield
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_crowns
operator|>
literal|0
operator|&&
name|Player
operator|.
name|p_level
operator|>=
literal|1000.0
condition|)
comment|/* no longer able to be king -- turn crowns into cash */
block|{
name|Player
operator|.
name|p_gold
operator|+=
operator|(
operator|(
name|double
operator|)
name|Player
operator|.
name|p_crowns
operator|)
operator|*
literal|5000.0
expr_stmt|;
name|Player
operator|.
name|p_crowns
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|Player
operator|.
name|p_level
operator|>=
literal|3000.0
operator|&&
name|Player
operator|.
name|p_specialtype
operator|<
name|SC_COUNCIL
condition|)
comment|/* make a member of the council */
block|{
name|mvaddstr
argument_list|(
literal|6
argument_list|,
literal|0
argument_list|,
literal|"You have made it to the Council of the Wise.\n"
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"Good Luck on your search for the Holy Grail.\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_specialtype
operator|=
name|SC_COUNCIL
expr_stmt|;
comment|/* no rings for council and above */
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|=
name|R_NONE
expr_stmt|;
name|Player
operator|.
name|p_ring
operator|.
name|ring_duration
operator|=
literal|0
expr_stmt|;
name|Player
operator|.
name|p_lives
operator|=
literal|3
expr_stmt|;
comment|/* three extra lives */
block|}
if|if
condition|(
name|Player
operator|.
name|p_level
operator|>
literal|9999.0
operator|&&
name|Player
operator|.
name|p_specialtype
operator|!=
name|SC_VALAR
condition|)
name|death
argument_list|(
literal|"Old age"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: descrlocation() / / FUNCTION: return a formatted description of location / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	struct player playerp - pointer to player structure /	bool shortflag - set if short form is desired / / RETURN VALUE: pointer to string containing result / / MODULES CALLED: fabs(), floor(), sprintf(), distance() / / GLOBAL INPUTS: Databuf[] / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Look at coordinates and return an appropriately formatted /	string. / /************************************************************************/
end_comment

begin_function
name|char
modifier|*
name|descrlocation
parameter_list|(
name|playerp
parameter_list|,
name|shortflag
parameter_list|)
name|struct
name|player
modifier|*
name|playerp
decl_stmt|;
name|bool
name|shortflag
decl_stmt|;
block|{
name|double
name|circle
decl_stmt|;
comment|/* corresponding circle for coordinates */
specifier|register
name|int
name|quadrant
decl_stmt|;
comment|/* quandrant of grid */
specifier|register
name|char
modifier|*
name|label
decl_stmt|;
comment|/* pointer to place name */
specifier|static
name|char
modifier|*
name|nametable
index|[
literal|4
index|]
index|[
literal|4
index|]
init|=
comment|/* names of places */
block|{
literal|"Anorien"
block|,
literal|"Ithilien"
block|,
literal|"Rohan"
block|,
literal|"Lorien"
block|,
literal|"Gondor"
block|,
literal|"Mordor"
block|,
literal|"Dunland"
block|,
literal|"Rovanion"
block|,
literal|"South Gondor"
block|,
literal|"Khand"
block|,
literal|"Eriador"
block|,
literal|"The Iron Hills"
block|,
literal|"Far Harad"
block|,
literal|"Near Harad"
block|,
literal|"The Northern Waste"
block|,
literal|"Rhun"
block|}
decl_stmt|;
if|if
condition|(
name|playerp
operator|->
name|p_specialtype
operator|==
name|SC_VALAR
condition|)
return|return
operator|(
literal|" is in Valhala"
operator|)
return|;
elseif|else
if|if
condition|(
operator|(
name|circle
operator|=
name|CIRCLE
argument_list|(
name|playerp
operator|->
name|p_x
argument_list|,
name|playerp
operator|->
name|p_y
argument_list|)
operator|)
operator|>=
literal|1000.0
condition|)
block|{
if|if
condition|(
name|MAX
argument_list|(
name|fabs
argument_list|(
name|playerp
operator|->
name|p_x
argument_list|)
argument_list|,
name|fabs
argument_list|(
name|playerp
operator|->
name|p_y
argument_list|)
argument_list|)
operator|>
name|D_BEYOND
condition|)
name|label
operator|=
literal|"The Point of No Return"
expr_stmt|;
else|else
name|label
operator|=
literal|"The Ashen Mountains"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|circle
operator|>=
literal|55
condition|)
name|label
operator|=
literal|"Morannon"
expr_stmt|;
elseif|else
if|if
condition|(
name|circle
operator|>=
literal|35
condition|)
name|label
operator|=
literal|"Kennaquahair"
expr_stmt|;
elseif|else
if|if
condition|(
name|circle
operator|>=
literal|20
condition|)
name|label
operator|=
literal|"The Dead Marshes"
expr_stmt|;
elseif|else
if|if
condition|(
name|circle
operator|>=
literal|9
condition|)
name|label
operator|=
literal|"The Outer Waste"
expr_stmt|;
elseif|else
if|if
condition|(
name|circle
operator|>=
literal|5
condition|)
name|label
operator|=
literal|"The Moors Adventurous"
expr_stmt|;
else|else
block|{
if|if
condition|(
name|playerp
operator|->
name|p_x
operator|==
literal|0.0
operator|&&
name|playerp
operator|->
name|p_y
operator|==
literal|0.0
condition|)
name|label
operator|=
literal|"The Lord's Chamber"
expr_stmt|;
else|else
block|{
comment|/* this expression is split to prevent compiler loop with some compilers */
name|quadrant
operator|=
operator|(
operator|(
name|playerp
operator|->
name|p_x
operator|>
literal|0.0
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
name|quadrant
operator|+=
operator|(
operator|(
name|playerp
operator|->
name|p_y
operator|>=
literal|0.0
operator|)
condition|?
literal|2
else|:
literal|0
operator|)
expr_stmt|;
name|label
operator|=
name|nametable
index|[
operator|(
operator|(
name|int
operator|)
name|circle
operator|)
operator|-
literal|1
index|]
index|[
name|quadrant
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
name|shortflag
condition|)
name|sprintf
argument_list|(
name|Databuf
argument_list|,
literal|"%.29s"
argument_list|,
name|label
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|Databuf
argument_list|,
literal|" is in %s  (%.0f,%.0f)"
argument_list|,
name|label
argument_list|,
name|playerp
operator|->
name|p_x
argument_list|,
name|playerp
operator|->
name|p_y
argument_list|)
expr_stmt|;
return|return
operator|(
name|Databuf
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: tradingpost() / / FUNCTION: do trading post stuff / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: writerecord(), adjuststats(), fabs(), more(), sqrt(),  /	sleep(), floor(), wmove(), drandom(), wclear(), printw(),  /	altercoordinates(), infloat(), waddstr(), wrefresh(), mvprintw(), getanswer(),  /	wclrtoeol(), wclrtobot() / / GLOBAL INPUTS: Menu[], Circle, Player, *stdscr, Fileloc, Nobetter[] / / GLOBAL OUTPUTS: Player / / DESCRIPTION: /	Different trading posts have different items. /	Merchants cannot be cheated, but they can be dishonest /	themselves. / /	Shields, swords, and quicksilver are not cumulative.  This is /	one major area of complaint, but there are two reasons for this: /		1) It becomes MUCH too easy to make very large versions /		   of these items. /		2) In the real world, one cannot simply weld two swords /		   together to make a bigger one. / /	At one time, it was possible to sell old weapons at half the purchase /	price.  This resulted in huge amounts of gold floating around, /	and the game lost much of its challenge. / /	Also, purchasing gems defeats the whole purpose of gold.  Gold /	is small change for lower level players.  They really shouldn't /	be able to accumulate more than enough gold for a small sword or /	a few books.  Higher level players shouldn't even bother to pick /	up gold, except maybe to buy mana once in a while. / /************************************************************************/
end_comment

begin_macro
name|tradingpost
argument_list|()
end_macro

begin_block
block|{
name|double
name|numitems
decl_stmt|;
comment|/* number of items to purchase */
name|double
name|cost
decl_stmt|;
comment|/* cost of purchase */
name|double
name|blessingcost
decl_stmt|;
comment|/* cost of blessing */
name|int
name|ch
decl_stmt|;
comment|/* input */
specifier|register
name|int
name|size
decl_stmt|;
comment|/* size of the trading post */
specifier|register
name|int
name|loop
decl_stmt|;
comment|/* loop counter */
name|int
name|cheat
init|=
literal|0
decl_stmt|;
comment|/* number of times player has tried to cheat */
name|bool
name|dishonest
init|=
name|FALSE
decl_stmt|;
comment|/* set when merchant is dishonest */
name|Player
operator|.
name|p_status
operator|=
name|S_TRADING
expr_stmt|;
name|writerecord
argument_list|(
operator|&
name|Player
argument_list|,
name|Fileloc
argument_list|)
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|addstr
argument_list|(
literal|"You are at a trading post. All purchases must be made with gold."
argument_list|)
expr_stmt|;
name|size
operator|=
name|sqrt
argument_list|(
name|fabs
argument_list|(
name|Player
operator|.
name|p_x
operator|/
literal|100
argument_list|)
argument_list|)
operator|+
literal|1
expr_stmt|;
name|size
operator|=
name|MIN
argument_list|(
literal|7
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* set up cost of blessing */
name|blessingcost
operator|=
literal|1000.0
operator|*
operator|(
name|Player
operator|.
name|p_level
operator|+
literal|5.0
operator|)
expr_stmt|;
comment|/* print Menu */
name|move
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|loop
operator|=
literal|0
init|;
name|loop
operator|<
name|size
condition|;
operator|++
name|loop
control|)
comment|/* print Menu */
block|{
if|if
condition|(
name|loop
operator|==
literal|6
condition|)
name|cost
operator|=
name|blessingcost
expr_stmt|;
else|else
name|cost
operator|=
name|Menu
index|[
name|loop
index|]
operator|.
name|cost
expr_stmt|;
name|printw
argument_list|(
literal|"(%d) %-12s: %6.0f\n"
argument_list|,
name|loop
operator|+
literal|1
argument_list|,
name|Menu
index|[
name|loop
index|]
operator|.
name|item
argument_list|,
name|cost
argument_list|)
expr_stmt|;
block|}
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"L:Leave  P:Purchase  S:Sell Gems ? "
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|adjuststats
argument_list|()
expr_stmt|;
comment|/* truncate any bad values */
comment|/* print some important statistics */
name|mvprintw
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|"Gold:   %9.0f  Gems:  %9.0f  Level:   %6.0f  Charms: %6d\n"
argument_list|,
name|Player
operator|.
name|p_gold
argument_list|,
name|Player
operator|.
name|p_gems
argument_list|,
name|Player
operator|.
name|p_level
argument_list|,
name|Player
operator|.
name|p_charms
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"Shield: %9.0f  Sword: %9.0f  Quicksilver:%3.0f  Blessed: %s\n"
argument_list|,
name|Player
operator|.
name|p_shield
argument_list|,
name|Player
operator|.
name|p_sword
argument_list|,
name|Player
operator|.
name|p_quksilver
argument_list|,
operator|(
name|Player
operator|.
name|p_blessing
condition|?
literal|" True"
else|:
literal|"False"
operator|)
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"Brains: %9.0f  Mana:  %9.0f"
argument_list|,
name|Player
operator|.
name|p_brains
argument_list|,
name|Player
operator|.
name|p_mana
argument_list|)
expr_stmt|;
name|move
argument_list|(
literal|5
argument_list|,
literal|36
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"LPS"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|move
argument_list|(
literal|15
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'L'
case|:
comment|/* leave */
case|case
literal|'\n'
case|:
name|altercoordinates
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|A_NEAR
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'P'
case|:
comment|/* make purchase */
name|mvaddstr
argument_list|(
literal|15
argument_list|,
literal|0
argument_list|,
literal|"What what would you like to buy ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|" 1234567"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|move
argument_list|(
literal|15
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtoeol
argument_list|()
expr_stmt|;
if|if
condition|(
name|ch
operator|-
literal|'0'
operator|>
name|size
condition|)
name|addstr
argument_list|(
literal|"Sorry, this merchant doesn't have that."
argument_list|)
expr_stmt|;
else|else
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'1'
case|:
name|printw
argument_list|(
literal|"Mana is one per %.0f gold piece.  How many do you want (%.0f max) ? "
argument_list|,
name|Menu
index|[
literal|0
index|]
operator|.
name|cost
argument_list|,
name|floor
argument_list|(
name|Player
operator|.
name|p_gold
operator|/
name|Menu
index|[
literal|0
index|]
operator|.
name|cost
argument_list|)
argument_list|)
expr_stmt|;
name|cost
operator|=
operator|(
name|numitems
operator|=
name|floor
argument_list|(
name|infloat
argument_list|()
argument_list|)
operator|)
operator|*
name|Menu
index|[
literal|0
index|]
operator|.
name|cost
expr_stmt|;
if|if
condition|(
name|cost
operator|>
name|Player
operator|.
name|p_gold
operator|||
name|numitems
operator|<
literal|0
condition|)
operator|++
name|cheat
expr_stmt|;
else|else
block|{
name|cheat
operator|=
literal|0
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|-=
name|cost
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.02
condition|)
name|dishonest
operator|=
name|TRUE
expr_stmt|;
else|else
name|Player
operator|.
name|p_mana
operator|+=
name|numitems
expr_stmt|;
block|}
break|break;
case|case
literal|'2'
case|:
name|printw
argument_list|(
literal|"Shields are %.0f per +1.  How many do you want (%.0f max) ? "
argument_list|,
name|Menu
index|[
literal|1
index|]
operator|.
name|cost
argument_list|,
name|floor
argument_list|(
name|Player
operator|.
name|p_gold
operator|/
name|Menu
index|[
literal|1
index|]
operator|.
name|cost
argument_list|)
argument_list|)
expr_stmt|;
name|cost
operator|=
operator|(
name|numitems
operator|=
name|floor
argument_list|(
name|infloat
argument_list|()
argument_list|)
operator|)
operator|*
name|Menu
index|[
literal|1
index|]
operator|.
name|cost
expr_stmt|;
if|if
condition|(
name|numitems
operator|==
literal|0.0
condition|)
break|break;
elseif|else
if|if
condition|(
name|cost
operator|>
name|Player
operator|.
name|p_gold
operator|||
name|numitems
operator|<
literal|0
condition|)
operator|++
name|cheat
expr_stmt|;
elseif|else
if|if
condition|(
name|numitems
operator|<
name|Player
operator|.
name|p_shield
condition|)
name|NOBETTER
argument_list|()
expr_stmt|;
else|else
block|{
name|cheat
operator|=
literal|0
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|-=
name|cost
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.02
condition|)
name|dishonest
operator|=
name|TRUE
expr_stmt|;
else|else
name|Player
operator|.
name|p_shield
operator|=
name|numitems
expr_stmt|;
block|}
break|break;
case|case
literal|'3'
case|:
name|printw
argument_list|(
literal|"A book costs %.0f gp.  How many do you want (%.0f max) ? "
argument_list|,
name|Menu
index|[
literal|2
index|]
operator|.
name|cost
argument_list|,
name|floor
argument_list|(
name|Player
operator|.
name|p_gold
operator|/
name|Menu
index|[
literal|2
index|]
operator|.
name|cost
argument_list|)
argument_list|)
expr_stmt|;
name|cost
operator|=
operator|(
name|numitems
operator|=
name|floor
argument_list|(
name|infloat
argument_list|()
argument_list|)
operator|)
operator|*
name|Menu
index|[
literal|2
index|]
operator|.
name|cost
expr_stmt|;
if|if
condition|(
name|cost
operator|>
name|Player
operator|.
name|p_gold
operator|||
name|numitems
operator|<
literal|0
condition|)
operator|++
name|cheat
expr_stmt|;
else|else
block|{
name|cheat
operator|=
literal|0
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|-=
name|cost
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.02
condition|)
name|dishonest
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|drandom
argument_list|()
operator|*
name|numitems
operator|>
name|Player
operator|.
name|p_level
operator|/
literal|10.0
operator|&&
name|numitems
operator|!=
literal|1
condition|)
block|{
name|printw
argument_list|(
literal|"\nYou blew your mind!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|/=
literal|5
expr_stmt|;
block|}
else|else
block|{
name|Player
operator|.
name|p_brains
operator|+=
name|floor
argument_list|(
name|numitems
argument_list|)
operator|*
name|ROLL
argument_list|(
literal|20
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'4'
case|:
name|printw
argument_list|(
literal|"Swords are %.0f gp per +1.  How many + do you want (%.0f max) ? "
argument_list|,
name|Menu
index|[
literal|3
index|]
operator|.
name|cost
argument_list|,
name|floor
argument_list|(
name|Player
operator|.
name|p_gold
operator|/
name|Menu
index|[
literal|3
index|]
operator|.
name|cost
argument_list|)
argument_list|)
expr_stmt|;
name|cost
operator|=
operator|(
name|numitems
operator|=
name|floor
argument_list|(
name|infloat
argument_list|()
argument_list|)
operator|)
operator|*
name|Menu
index|[
literal|3
index|]
operator|.
name|cost
expr_stmt|;
if|if
condition|(
name|numitems
operator|==
literal|0.0
condition|)
break|break;
elseif|else
if|if
condition|(
name|cost
operator|>
name|Player
operator|.
name|p_gold
operator|||
name|numitems
operator|<
literal|0
condition|)
operator|++
name|cheat
expr_stmt|;
elseif|else
if|if
condition|(
name|numitems
operator|<
name|Player
operator|.
name|p_sword
condition|)
name|NOBETTER
argument_list|()
expr_stmt|;
else|else
block|{
name|cheat
operator|=
literal|0
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|-=
name|cost
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.02
condition|)
name|dishonest
operator|=
name|TRUE
expr_stmt|;
else|else
name|Player
operator|.
name|p_sword
operator|=
name|numitems
expr_stmt|;
block|}
break|break;
case|case
literal|'5'
case|:
name|printw
argument_list|(
literal|"A charm costs %.0f gp.  How many do you want (%.0f max) ? "
argument_list|,
name|Menu
index|[
literal|4
index|]
operator|.
name|cost
argument_list|,
name|floor
argument_list|(
name|Player
operator|.
name|p_gold
operator|/
name|Menu
index|[
literal|4
index|]
operator|.
name|cost
argument_list|)
argument_list|)
expr_stmt|;
name|cost
operator|=
operator|(
name|numitems
operator|=
name|floor
argument_list|(
name|infloat
argument_list|()
argument_list|)
operator|)
operator|*
name|Menu
index|[
literal|4
index|]
operator|.
name|cost
expr_stmt|;
if|if
condition|(
name|cost
operator|>
name|Player
operator|.
name|p_gold
operator|||
name|numitems
operator|<
literal|0
condition|)
operator|++
name|cheat
expr_stmt|;
else|else
block|{
name|cheat
operator|=
literal|0
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|-=
name|cost
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.02
condition|)
name|dishonest
operator|=
name|TRUE
expr_stmt|;
else|else
name|Player
operator|.
name|p_charms
operator|+=
name|numitems
expr_stmt|;
block|}
break|break;
case|case
literal|'6'
case|:
name|printw
argument_list|(
literal|"Quicksilver is %.0f gp per +1.  How many + do you want (%.0f max) ? "
argument_list|,
name|Menu
index|[
literal|5
index|]
operator|.
name|cost
argument_list|,
name|floor
argument_list|(
name|Player
operator|.
name|p_gold
operator|/
name|Menu
index|[
literal|5
index|]
operator|.
name|cost
argument_list|)
argument_list|)
expr_stmt|;
name|cost
operator|=
operator|(
name|numitems
operator|=
name|floor
argument_list|(
name|infloat
argument_list|()
argument_list|)
operator|)
operator|*
name|Menu
index|[
literal|5
index|]
operator|.
name|cost
expr_stmt|;
if|if
condition|(
name|numitems
operator|==
literal|0.0
condition|)
break|break;
elseif|else
if|if
condition|(
name|cost
operator|>
name|Player
operator|.
name|p_gold
operator|||
name|numitems
operator|<
literal|0
condition|)
operator|++
name|cheat
expr_stmt|;
elseif|else
if|if
condition|(
name|numitems
operator|<
name|Player
operator|.
name|p_quksilver
condition|)
name|NOBETTER
argument_list|()
expr_stmt|;
else|else
block|{
name|cheat
operator|=
literal|0
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|-=
name|cost
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.02
condition|)
name|dishonest
operator|=
name|TRUE
expr_stmt|;
else|else
name|Player
operator|.
name|p_quksilver
operator|=
name|numitems
expr_stmt|;
block|}
break|break;
case|case
literal|'7'
case|:
if|if
condition|(
name|Player
operator|.
name|p_blessing
condition|)
block|{
name|addstr
argument_list|(
literal|"You already have a blessing."
argument_list|)
expr_stmt|;
break|break;
block|}
name|printw
argument_list|(
literal|"A blessing requires a %.0f gp donation.  Still want one ? "
argument_list|,
name|blessingcost
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"NY"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'Y'
condition|)
if|if
condition|(
name|Player
operator|.
name|p_gold
operator|<
name|blessingcost
condition|)
operator|++
name|cheat
expr_stmt|;
else|else
block|{
name|cheat
operator|=
literal|0
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|-=
name|blessingcost
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.02
condition|)
name|dishonest
operator|=
name|TRUE
expr_stmt|;
else|else
name|Player
operator|.
name|p_blessing
operator|=
name|TRUE
expr_stmt|;
block|}
break|break;
block|}
break|break;
case|case
literal|'S'
case|:
comment|/* sell gems */
name|mvprintw
argument_list|(
literal|15
argument_list|,
literal|0
argument_list|,
literal|"A gem is worth %.0f gp.  How many do you want to sell (%.0f max) ? "
argument_list|,
operator|(
name|double
operator|)
name|N_GEMVALUE
argument_list|,
name|Player
operator|.
name|p_gems
argument_list|)
expr_stmt|;
name|numitems
operator|=
name|floor
argument_list|(
name|infloat
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|numitems
operator|>
name|Player
operator|.
name|p_gems
operator|||
name|numitems
operator|<
literal|0
condition|)
operator|++
name|cheat
expr_stmt|;
else|else
block|{
name|cheat
operator|=
literal|0
expr_stmt|;
name|Player
operator|.
name|p_gems
operator|-=
name|numitems
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|+=
name|numitems
operator|*
name|N_GEMVALUE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cheat
operator|==
literal|1
condition|)
name|mvaddstr
argument_list|(
literal|17
argument_list|,
literal|0
argument_list|,
literal|"Come on, merchants aren't stupid.  Stop cheating.\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cheat
operator|==
literal|2
condition|)
block|{
name|mvaddstr
argument_list|(
literal|17
argument_list|,
literal|0
argument_list|,
literal|"You had your chance.  This merchant happens to be\n"
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"a %.0f level magic user, and you made %s mad!\n"
argument_list|,
name|ROLL
argument_list|(
name|Circle
operator|*
literal|20.0
argument_list|,
literal|40.0
argument_list|)
argument_list|,
operator|(
name|drandom
argument_list|()
operator|<
literal|0.5
operator|)
condition|?
literal|"him"
else|:
literal|"her"
argument_list|)
expr_stmt|;
name|altercoordinates
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|A_FAR
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|/=
literal|2.0
expr_stmt|;
operator|++
name|Player
operator|.
name|p_sin
expr_stmt|;
name|more
argument_list|(
literal|23
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|dishonest
condition|)
block|{
name|mvaddstr
argument_list|(
literal|17
argument_list|,
literal|0
argument_list|,
literal|"The merchant stole your money!"
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
name|altercoordinates
argument_list|(
name|Player
operator|.
name|p_x
operator|-
name|Player
operator|.
name|p_x
operator|/
literal|10.0
argument_list|,
name|Player
operator|.
name|p_y
operator|-
name|Player
operator|.
name|p_y
operator|/
literal|10.0
argument_list|,
name|A_SPECIFIC
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: displaystats() / / FUNCTION: print out important player statistics / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: descrstatus(), descrlocation(), mvprintw() / / GLOBAL INPUTS: Users, Player / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Important player statistics are printed on the screen. / /************************************************************************/
end_comment

begin_macro
name|displaystats
argument_list|()
end_macro

begin_block
block|{
name|mvprintw
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"%s%s\n"
argument_list|,
name|Player
operator|.
name|p_name
argument_list|,
name|descrlocation
argument_list|(
operator|&
name|Player
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|"Level :%7.0f   Energy  :%9.0f(%9.0f)  Mana :%9.0f  Users:%3d\n"
argument_list|,
name|Player
operator|.
name|p_level
argument_list|,
name|Player
operator|.
name|p_energy
argument_list|,
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_shield
argument_list|,
name|Player
operator|.
name|p_mana
argument_list|,
name|Users
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|"Quick :%3.0f(%3.0f)  Strength:%9.0f(%9.0f)  Gold :%9.0f  %s\n"
argument_list|,
name|Player
operator|.
name|p_speed
argument_list|,
name|Player
operator|.
name|p_quickness
operator|+
name|Player
operator|.
name|p_quksilver
argument_list|,
name|Player
operator|.
name|p_might
argument_list|,
name|Player
operator|.
name|p_strength
operator|+
name|Player
operator|.
name|p_sword
argument_list|,
name|Player
operator|.
name|p_gold
argument_list|,
name|descrstatus
argument_list|(
operator|&
name|Player
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: allstatslist() / / FUNCTION: show player items / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: mvprintw(), descrtype() / / GLOBAL INPUTS: Player / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Print out some player statistics of lesser importance. / /************************************************************************/
end_comment

begin_macro
name|allstatslist
argument_list|()
end_macro

begin_block
block|{
specifier|static
name|char
modifier|*
name|flags
index|[]
init|=
comment|/* to print value of some bools */
block|{
literal|"False"
block|,
literal|" True"
block|}
decl_stmt|;
name|mvprintw
argument_list|(
literal|8
argument_list|,
literal|0
argument_list|,
literal|"Type: %s\n"
argument_list|,
name|descrtype
argument_list|(
operator|&
name|Player
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|10
argument_list|,
literal|0
argument_list|,
literal|"Experience: %9.0f"
argument_list|,
name|Player
operator|.
name|p_experience
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|11
argument_list|,
literal|0
argument_list|,
literal|"Brains    : %9.0f"
argument_list|,
name|Player
operator|.
name|p_brains
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|12
argument_list|,
literal|0
argument_list|,
literal|"Magic Lvl : %9.0f"
argument_list|,
name|Player
operator|.
name|p_magiclvl
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|13
argument_list|,
literal|0
argument_list|,
literal|"Sin       : %9.5f"
argument_list|,
name|Player
operator|.
name|p_sin
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|14
argument_list|,
literal|0
argument_list|,
literal|"Poison    : %9.5f"
argument_list|,
name|Player
operator|.
name|p_poison
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|15
argument_list|,
literal|0
argument_list|,
literal|"Gems      : %9.0f"
argument_list|,
name|Player
operator|.
name|p_gems
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|16
argument_list|,
literal|0
argument_list|,
literal|"Age       : %9d"
argument_list|,
name|Player
operator|.
name|p_age
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|10
argument_list|,
literal|40
argument_list|,
literal|"Holy Water: %9d"
argument_list|,
name|Player
operator|.
name|p_holywater
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|11
argument_list|,
literal|40
argument_list|,
literal|"Amulets   : %9d"
argument_list|,
name|Player
operator|.
name|p_amulets
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|12
argument_list|,
literal|40
argument_list|,
literal|"Charms    : %9d"
argument_list|,
name|Player
operator|.
name|p_charms
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|13
argument_list|,
literal|40
argument_list|,
literal|"Crowns    : %9d"
argument_list|,
name|Player
operator|.
name|p_crowns
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|14
argument_list|,
literal|40
argument_list|,
literal|"Shield    : %9.0f"
argument_list|,
name|Player
operator|.
name|p_shield
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|15
argument_list|,
literal|40
argument_list|,
literal|"Sword     : %9.0f"
argument_list|,
name|Player
operator|.
name|p_sword
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|16
argument_list|,
literal|40
argument_list|,
literal|"Quickslver: %9.0f"
argument_list|,
name|Player
operator|.
name|p_quksilver
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|18
argument_list|,
literal|0
argument_list|,
literal|"Blessing: %s   Ring: %s   Virgin: %s   Palantir: %s"
argument_list|,
name|flags
index|[
name|Player
operator|.
name|p_blessing
index|]
argument_list|,
name|flags
index|[
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|!=
name|R_NONE
index|]
argument_list|,
name|flags
index|[
name|Player
operator|.
name|p_virgin
index|]
argument_list|,
name|flags
index|[
name|Player
operator|.
name|p_palantir
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: descrtype() / / FUNCTION: return a string specifying player type / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	struct player playerp - pointer to structure for player /	bool shortflag - set if short form is desired / / RETURN VALUE: pointer to string describing player type / / MODULES CALLED: strcpy() / / GLOBAL INPUTS: Databuf[] / / GLOBAL OUTPUTS: Databuf[] / / DESCRIPTION: /	Return a string describing the player type. /	King, council, valar, supercedes other types. /	The first character of the string is '*' if the player /	has a crown. /	If 'shortflag' is TRUE, return a 3 character string. / /************************************************************************/
end_comment

begin_function
name|char
modifier|*
name|descrtype
parameter_list|(
name|playerp
parameter_list|,
name|shortflag
parameter_list|)
name|struct
name|player
modifier|*
name|playerp
decl_stmt|;
name|bool
name|shortflag
decl_stmt|;
block|{
specifier|register
name|int
name|type
decl_stmt|;
comment|/* for caluculating result subscript */
specifier|static
name|char
modifier|*
name|results
index|[]
init|=
comment|/* description table */
block|{
literal|" Magic User"
block|,
literal|" MU"
block|,
literal|" Fighter"
block|,
literal|" F "
block|,
literal|" Elf"
block|,
literal|" E "
block|,
literal|" Dwarf"
block|,
literal|" D "
block|,
literal|" Halfling"
block|,
literal|" H "
block|,
literal|" Experimento"
block|,
literal|" EX"
block|,
literal|" Super"
block|,
literal|" S "
block|,
literal|" King"
block|,
literal|" K "
block|,
literal|" Council of Wise"
block|,
literal|" CW"
block|,
literal|" Ex-Valar"
block|,
literal|" EV"
block|,
literal|" Valar"
block|,
literal|" V "
block|,
literal|" ? "
block|,
literal|" ? "
block|}
decl_stmt|;
name|type
operator|=
name|playerp
operator|->
name|p_type
expr_stmt|;
switch|switch
condition|(
name|playerp
operator|->
name|p_specialtype
condition|)
block|{
case|case
name|SC_NONE
case|:
name|type
operator|=
name|playerp
operator|->
name|p_type
expr_stmt|;
break|break;
case|case
name|SC_KING
case|:
name|type
operator|=
literal|7
expr_stmt|;
break|break;
case|case
name|SC_COUNCIL
case|:
name|type
operator|=
literal|8
expr_stmt|;
break|break;
case|case
name|SC_EXVALAR
case|:
name|type
operator|=
literal|9
expr_stmt|;
break|break;
case|case
name|SC_VALAR
case|:
name|type
operator|=
literal|10
expr_stmt|;
break|break;
block|}
name|type
operator|*=
literal|2
expr_stmt|;
comment|/* calculate offset */
if|if
condition|(
name|type
operator|>
literal|20
condition|)
comment|/* error */
name|type
operator|=
literal|22
expr_stmt|;
if|if
condition|(
name|shortflag
condition|)
comment|/* use short descriptions */
operator|++
name|type
expr_stmt|;
if|if
condition|(
name|playerp
operator|->
name|p_crowns
operator|>
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|Databuf
argument_list|,
name|results
index|[
name|type
index|]
argument_list|)
expr_stmt|;
name|Databuf
index|[
literal|0
index|]
operator|=
literal|'*'
expr_stmt|;
return|return
operator|(
name|Databuf
operator|)
return|;
block|}
else|else
return|return
operator|(
name|results
index|[
name|type
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: findname() / / FUNCTION: find location in player file of given name / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	char *name - name of character to look for /	struct player *playerp - pointer of structure to fill / / RETURN VALUE: location of player if found, -1 otherwise / / MODULES CALLED: fread(), fseek(), strcmp() / / GLOBAL INPUTS: Wizard, *Playersfp / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Search the player file for the player of the given name. /	If player is found, fill structure with player data. / /************************************************************************/
end_comment

begin_function
name|long
name|findname
parameter_list|(
name|name
parameter_list|,
name|playerp
parameter_list|)
specifier|register
name|char
modifier|*
name|name
decl_stmt|;
specifier|register
name|struct
name|player
modifier|*
name|playerp
decl_stmt|;
block|{
name|long
name|loc
init|=
literal|0
decl_stmt|;
comment|/* location in the file */
name|fseek
argument_list|(
name|Playersfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
name|playerp
argument_list|,
name|SZ_PLAYERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Playersfp
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|playerp
operator|->
name|p_name
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|playerp
operator|->
name|p_status
operator|!=
name|S_NOTUSED
operator|||
name|Wizard
condition|)
comment|/* found it */
return|return
operator|(
name|loc
operator|)
return|;
block|}
name|loc
operator|+=
name|SZ_PLAYERSTRUCT
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: allocrecord() / / FUNCTION: find space in the player file for a new character / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: location of free space in file / / MODULES CALLED: initplayer(), writerecord(), fread(), fseek() / / GLOBAL INPUTS: Other, *Playersfp / / GLOBAL OUTPUTS: Player / / DESCRIPTION: /	Search the player file for an unused entry.  If none are found, /	make one at the end of the file. / /************************************************************************/
end_comment

begin_function
name|long
name|allocrecord
parameter_list|()
block|{
name|long
name|loc
init|=
literal|0L
decl_stmt|;
comment|/* location in file */
name|fseek
argument_list|(
name|Playersfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Other
argument_list|,
name|SZ_PLAYERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Playersfp
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|Other
operator|.
name|p_status
operator|==
name|S_NOTUSED
condition|)
comment|/* found an empty record */
return|return
operator|(
name|loc
operator|)
return|;
else|else
name|loc
operator|+=
name|SZ_PLAYERSTRUCT
expr_stmt|;
block|}
comment|/* make a new record */
name|initplayer
argument_list|(
operator|&
name|Other
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_status
operator|=
name|S_OFF
expr_stmt|;
name|writerecord
argument_list|(
operator|&
name|Other
argument_list|,
name|loc
argument_list|)
expr_stmt|;
return|return
operator|(
name|loc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: freerecord() / / FUNCTION: free up a record on the player file / / AUTHOR: E. A. Estes, 2/7/86 / / ARGUMENTS: /	struct player playerp - pointer to structure to free /	long loc - location in file to free / / RETURN VALUE: none / / MODULES CALLED: writerecord() / / GLOBAL INPUTS: none / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Mark structure as not used, and update player file. / /************************************************************************/
end_comment

begin_macro
name|freerecord
argument_list|(
argument|playerp
argument_list|,
argument|loc
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|player
modifier|*
name|playerp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|loc
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|playerp
operator|->
name|p_name
index|[
literal|0
index|]
operator|=
name|CH_MARKDELETE
expr_stmt|;
name|playerp
operator|->
name|p_status
operator|=
name|S_NOTUSED
expr_stmt|;
name|writerecord
argument_list|(
name|playerp
argument_list|,
name|loc
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: leavegame() / / FUNCTION: leave game / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: freerecord(), writerecord(), cleanup() / / GLOBAL INPUTS: Player, Fileloc / / GLOBAL OUTPUTS: Player / / DESCRIPTION: /	Mark player as inactive, and cleanup. /	Do not save players below level 1. / /************************************************************************/
end_comment

begin_macro
name|leavegame
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|Player
operator|.
name|p_level
operator|<
literal|1.0
condition|)
comment|/* delete character */
name|freerecord
argument_list|(
operator|&
name|Player
argument_list|,
name|Fileloc
argument_list|)
expr_stmt|;
else|else
block|{
name|Player
operator|.
name|p_status
operator|=
name|S_OFF
expr_stmt|;
name|writerecord
argument_list|(
operator|&
name|Player
argument_list|,
name|Fileloc
argument_list|)
expr_stmt|;
block|}
name|cleanup
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: death() / / FUNCTION: death routine / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	char *how - pointer to string describing cause of death / / RETURN VALUE: none / / MODULES CALLED: freerecord(), enterscore(), more(), exit(), fread(),  /	fseek(), execl(), fopen(), floor(), wmove(), drandom(), wclear(), strcmp(),  /	fwrite(), fflush(), printw(), strcpy(), fclose(), waddstr(), cleanup(),  /	fprintf(), wrefresh(), getanswer(), descrtype() / / GLOBAL INPUTS: Curmonster, Wizard, Player, *stdscr, Fileloc, *Monstfp / / GLOBAL OUTPUTS: Player / / DESCRIPTION: /	Kill off current player. /	Handle rings, and multiple lives. /	Print an appropriate message. /	Update scoreboard, lastdead, and let other players know about /	the demise of their comrade. / /************************************************************************/
end_comment

begin_macro
name|death
argument_list|(
argument|how
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|how
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
comment|/* for updating various files */
name|int
name|ch
decl_stmt|;
comment|/* input */
specifier|static
name|char
modifier|*
name|deathmesg
index|[]
init|=
comment|/* add more messages here, if desired */
block|{
literal|"You have been wounded beyond repair.  "
block|,
literal|"You have been disemboweled.  "
block|,
literal|"You've been mashed, mauled, and spit upon.  (You're dead.)\n"
block|,
literal|"You died!  "
block|,
literal|"You're a complete failure -- you've died!!\n"
block|,
literal|"You have been dealt a fatal blow!  "
block|}
decl_stmt|;
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|how
argument_list|,
literal|"Stupidity"
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|Player
operator|.
name|p_level
operator|>
literal|9999.0
condition|)
comment|/* old age */
name|addstr
argument_list|(
literal|"Characters must be retired upon reaching level 10000.  Sorry."
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_lives
operator|>
literal|0
condition|)
comment|/* extra lives */
block|{
name|addstr
argument_list|(
literal|"You should be more cautious.  You've been killed.\n"
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"You only have %d more chance(s).\n"
argument_list|,
operator|--
name|Player
operator|.
name|p_lives
argument_list|)
expr_stmt|;
name|more
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|=
name|Player
operator|.
name|p_maxenergy
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|==
name|SC_VALAR
condition|)
block|{
name|addstr
argument_list|(
literal|"You had your chances, but Valar aren't totally\n"
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"immortal.  You are now left to wither and die . . .\n"
argument_list|)
expr_stmt|;
name|more
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|=
name|Player
operator|.
name|p_level
operator|/
literal|25.0
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|=
name|Player
operator|.
name|p_maxenergy
operator|/=
literal|5.0
expr_stmt|;
name|Player
operator|.
name|p_quksilver
operator|=
name|Player
operator|.
name|p_sword
operator|=
literal|0.0
expr_stmt|;
name|Player
operator|.
name|p_specialtype
operator|=
name|SC_COUNCIL
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_inuse
operator|&&
operator|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|==
name|R_DLREG
operator|||
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|==
name|R_NAZREG
operator|)
condition|)
comment|/* good ring in use - saved from death */
block|{
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"Your ring saved you from death!\n"
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|=
name|R_NONE
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|=
name|Player
operator|.
name|p_maxenergy
operator|/
literal|12.0
operator|+
literal|1.0
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_crowns
operator|>
literal|0
condition|)
operator|--
name|Player
operator|.
name|p_crowns
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|==
name|R_BAD
operator|||
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|==
name|R_SPOILED
condition|)
comment|/* bad ring in possession; name idiot after player */
block|{
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"Your ring has taken control of you and turned you into a monster!\n"
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|Monstfp
argument_list|,
literal|13L
operator|*
name|SZ_MONSTERSTRUCT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Curmonster
argument_list|,
name|SZ_MONSTERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Monstfp
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|Curmonster
operator|.
name|m_name
argument_list|,
name|Player
operator|.
name|p_name
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|Monstfp
argument_list|,
literal|13L
operator|*
name|SZ_MONSTERSTRUCT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Curmonster
argument_list|,
name|SZ_MONSTERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Monstfp
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|Monstfp
argument_list|)
expr_stmt|;
block|}
block|}
name|enterscore
argument_list|()
expr_stmt|;
comment|/* update score board */
comment|/* put info in last dead file */
name|fp
operator|=
name|fopen
argument_list|(
name|_PATH_LASTDEAD
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s (%s, run by %s, level %.0f, killed by %s)"
argument_list|,
name|Player
operator|.
name|p_name
argument_list|,
name|descrtype
argument_list|(
operator|&
name|Player
argument_list|,
name|TRUE
argument_list|)
argument_list|,
name|Player
operator|.
name|p_login
argument_list|,
name|Player
operator|.
name|p_level
argument_list|,
name|how
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* let other players know */
name|fp
operator|=
name|fopen
argument_list|(
name|_PATH_MESS
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s was killed by %s."
argument_list|,
name|Player
operator|.
name|p_name
argument_list|,
name|how
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|freerecord
argument_list|(
operator|&
name|Player
argument_list|,
name|Fileloc
argument_list|)
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|move
argument_list|(
literal|10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
name|deathmesg
index|[
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|0.0
argument_list|,
operator|(
name|double
operator|)
sizeof|sizeof
argument_list|(
name|deathmesg
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
index|]
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"Care to give it another try ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"NY"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'Y'
condition|)
block|{
name|cleanup
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
name|execl
argument_list|(
name|_PATH_GAMEPROG
argument_list|,
literal|"phantasia"
argument_list|,
literal|"-s"
argument_list|,
operator|(
name|Wizard
condition|?
literal|"-S"
else|:
operator|(
name|char
operator|*
operator|)
name|NULL
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
name|cleanup
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: writerecord() / / FUNCTION: update structure in player file / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	struct player *playerp - pointer to structure to write out /	long place - location in file to updata / / RETURN VALUE: none / / MODULES CALLED: fseek(), fwrite(), fflush() / / GLOBAL INPUTS: *Playersfp / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Update location in player file with given structure. / /************************************************************************/
end_comment

begin_expr_stmt
name|writerecord
argument_list|(
name|playerp
argument_list|,
name|place
argument_list|)
specifier|register
expr|struct
name|player
operator|*
name|playerp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|long
name|place
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fseek
argument_list|(
name|Playersfp
argument_list|,
name|place
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
operator|(
name|char
operator|*
operator|)
name|playerp
argument_list|,
name|SZ_PLAYERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Playersfp
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|Playersfp
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: explevel() / / FUNCTION: calculate level based upon experience / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	double experience - experience to calculate experience level from / / RETURN VALUE: experience level / / MODULES CALLED: pow(), floor() / / GLOBAL INPUTS: none / / GLOBAL OUTPUTS: none / / DESCRIPTION:  /	Experience level is a geometric progression.  This has been finely /	tuned over the years, and probably should not be changed. / /************************************************************************/
end_comment

begin_function
name|double
name|explevel
parameter_list|(
name|experience
parameter_list|)
name|double
name|experience
decl_stmt|;
block|{
if|if
condition|(
name|experience
operator|<
literal|1.1e7
condition|)
return|return
operator|(
name|floor
argument_list|(
name|pow
argument_list|(
operator|(
name|experience
operator|/
literal|1000.0
operator|)
argument_list|,
literal|0.4875
argument_list|)
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|floor
argument_list|(
name|pow
argument_list|(
operator|(
name|experience
operator|/
literal|1250.0
operator|)
argument_list|,
literal|0.4865
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: truncstring() / / FUNCTION: truncate trailing blanks off a string / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS:  /	char *string - pointer to null terminated string / / RETURN VALUE: none / / MODULES CALLED: strlen() / / GLOBAL INPUTS: none / / GLOBAL OUTPUTS: none / / DESCRIPTION:  /	Put nul characters in place of spaces at the end of the string. / /************************************************************************/
end_comment

begin_expr_stmt
name|truncstring
argument_list|(
name|string
argument_list|)
specifier|register
name|char
operator|*
name|string
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|length
decl_stmt|;
comment|/* length of string */
name|length
operator|=
name|strlen
argument_list|(
name|string
argument_list|)
expr_stmt|;
while|while
condition|(
name|string
index|[
operator|--
name|length
index|]
operator|==
literal|' '
condition|)
name|string
index|[
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: altercoordinates() / / FUNCTION: Alter x, y coordinates and set/check location flags / / AUTHOR: E. A. Estes, 12/16/85 / / ARGUMENTS:  /	double xnew, ynew - new x, y coordinates /	int operation - operation to perform with coordinates / / RETURN VALUE: none / / MODULES CALLED: fabs(), floor(), drandom(), distance() / / GLOBAL INPUTS: Circle, Beyond, Player / / GLOBAL OUTPUTS: Marsh, Circle, Beyond, Throne, Player, Changed / / DESCRIPTION:  /	This module is called whenever the player's coordinates are altered. /	If the player is beyond the point of no return, he/she is forced /	to stay there. / /************************************************************************/
end_comment

begin_macro
name|altercoordinates
argument_list|(
argument|xnew
argument_list|,
argument|ynew
argument_list|,
argument|operation
argument_list|)
end_macro

begin_decl_stmt
name|double
name|xnew
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|ynew
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|operation
decl_stmt|;
end_decl_stmt

begin_block
block|{
switch|switch
condition|(
name|operation
condition|)
block|{
case|case
name|A_FORCED
case|:
comment|/* move with no checks */
break|break;
case|case
name|A_NEAR
case|:
comment|/* pick random coordinates near */
name|xnew
operator|=
name|Player
operator|.
name|p_x
operator|+
name|ROLL
argument_list|(
literal|1.0
argument_list|,
literal|5.0
argument_list|)
expr_stmt|;
name|ynew
operator|=
name|Player
operator|.
name|p_y
operator|-
name|ROLL
argument_list|(
literal|1.0
argument_list|,
literal|5.0
argument_list|)
expr_stmt|;
comment|/* fall through for check */
case|case
name|A_SPECIFIC
case|:
comment|/* just move player */
if|if
condition|(
name|Beyond
operator|&&
name|fabs
argument_list|(
name|xnew
argument_list|)
operator|<
name|D_BEYOND
operator|&&
name|fabs
argument_list|(
name|ynew
argument_list|)
operator|<
name|D_BEYOND
condition|)
comment|/* 		 * cannot move back from point of no return 		 * pick the largest coordinate to remain unchanged 		 */
block|{
if|if
condition|(
name|fabs
argument_list|(
name|xnew
argument_list|)
operator|>
name|fabs
argument_list|(
name|ynew
argument_list|)
condition|)
name|xnew
operator|=
name|SGN
argument_list|(
name|Player
operator|.
name|p_x
argument_list|)
operator|*
name|MAX
argument_list|(
name|fabs
argument_list|(
name|Player
operator|.
name|p_x
argument_list|)
argument_list|,
name|D_BEYOND
argument_list|)
expr_stmt|;
else|else
name|ynew
operator|=
name|SGN
argument_list|(
name|Player
operator|.
name|p_y
argument_list|)
operator|*
name|MAX
argument_list|(
name|fabs
argument_list|(
name|Player
operator|.
name|p_y
argument_list|)
argument_list|,
name|D_BEYOND
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|A_FAR
case|:
comment|/* pick random coordinates far */
name|xnew
operator|=
name|Player
operator|.
name|p_x
operator|+
name|SGN
argument_list|(
name|Player
operator|.
name|p_x
argument_list|)
operator|*
name|ROLL
argument_list|(
literal|50
operator|*
name|Circle
argument_list|,
literal|250
operator|*
name|Circle
argument_list|)
expr_stmt|;
name|ynew
operator|=
name|Player
operator|.
name|p_y
operator|+
name|SGN
argument_list|(
name|Player
operator|.
name|p_y
argument_list|)
operator|*
name|ROLL
argument_list|(
literal|50
operator|*
name|Circle
argument_list|,
literal|250
operator|*
name|Circle
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* now set location flags and adjust coordinates */
name|Circle
operator|=
name|CIRCLE
argument_list|(
name|Player
operator|.
name|p_x
operator|=
name|floor
argument_list|(
name|xnew
argument_list|)
argument_list|,
name|Player
operator|.
name|p_y
operator|=
name|floor
argument_list|(
name|ynew
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set up flags based upon location */
name|Throne
operator|=
name|Marsh
operator|=
name|Beyond
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_x
operator|==
literal|0.0
operator|&&
name|Player
operator|.
name|p_y
operator|==
literal|0.0
condition|)
name|Throne
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|Circle
operator|<
literal|35
operator|&&
name|Circle
operator|>=
literal|20
condition|)
name|Marsh
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|MAX
argument_list|(
name|fabs
argument_list|(
name|Player
operator|.
name|p_x
argument_list|)
argument_list|,
name|fabs
argument_list|(
name|Player
operator|.
name|p_y
argument_list|)
argument_list|)
operator|>=
name|D_BEYOND
condition|)
name|Beyond
operator|=
name|TRUE
expr_stmt|;
name|Changed
operator|=
name|TRUE
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: readrecord() / / FUNCTION: read a player structure from file / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	struct player *playerp - pointer to structure to fill /	int loc - location of record to read / / RETURN VALUE: none / / MODULES CALLED: fread(), fseek() / / GLOBAL INPUTS: *Playersfp / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Read structure information from player file. / /************************************************************************/
end_comment

begin_expr_stmt
name|readrecord
argument_list|(
name|playerp
argument_list|,
name|loc
argument_list|)
specifier|register
expr|struct
name|player
operator|*
name|playerp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|long
name|loc
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fseek
argument_list|(
name|Playersfp
argument_list|,
name|loc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
name|playerp
argument_list|,
name|SZ_PLAYERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Playersfp
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: adjuststats() / / FUNCTION: adjust player statistics / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: death(), floor(), drandom(), explevel(), movelevel() / / GLOBAL INPUTS: Player, *Statptr / / GLOBAL OUTPUTS: Circle, Player, Timeout / / DESCRIPTION: /	Handle adjustment and maximums on various player characteristics. / /************************************************************************/
end_comment

begin_macro
name|adjuststats
argument_list|()
end_macro

begin_block
block|{
name|double
name|dtemp
decl_stmt|;
comment|/* for temporary calculations */
if|if
condition|(
name|explevel
argument_list|(
name|Player
operator|.
name|p_experience
argument_list|)
operator|>
name|Player
operator|.
name|p_level
condition|)
comment|/* move one or more levels */
block|{
name|movelevel
argument_list|()
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_level
operator|>
literal|5.0
condition|)
name|Timeout
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|==
name|SC_VALAR
condition|)
comment|/* valar */
name|Circle
operator|=
name|Player
operator|.
name|p_level
operator|/
literal|5.0
expr_stmt|;
comment|/* calculate effective quickness */
name|dtemp
operator|=
operator|(
operator|(
name|Player
operator|.
name|p_gold
operator|+
name|Player
operator|.
name|p_gems
operator|/
literal|2.0
operator|)
operator|-
literal|1000.0
operator|)
operator|/
name|Statptr
operator|->
name|c_goldtote
operator|-
name|Player
operator|.
name|p_level
expr_stmt|;
empty_stmt|;
name|dtemp
operator|=
name|MAX
argument_list|(
literal|0.0
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
comment|/* gold slows player down */
name|Player
operator|.
name|p_speed
operator|=
name|Player
operator|.
name|p_quickness
operator|+
name|Player
operator|.
name|p_quksilver
operator|-
name|dtemp
expr_stmt|;
comment|/* calculate effective strength */
if|if
condition|(
name|Player
operator|.
name|p_poison
operator|>
literal|0.0
condition|)
comment|/* poison makes player weaker */
block|{
name|dtemp
operator|=
literal|1.0
operator|-
name|Player
operator|.
name|p_poison
operator|*
name|Statptr
operator|->
name|c_weakness
operator|/
literal|800.0
expr_stmt|;
name|dtemp
operator|=
name|MAX
argument_list|(
literal|0.1
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
block|}
else|else
name|dtemp
operator|=
literal|1.0
expr_stmt|;
name|Player
operator|.
name|p_might
operator|=
name|dtemp
operator|*
name|Player
operator|.
name|p_strength
operator|+
name|Player
operator|.
name|p_sword
expr_stmt|;
comment|/* insure that important things are within limits */
name|Player
operator|.
name|p_quksilver
operator|=
name|MIN
argument_list|(
literal|99.0
argument_list|,
name|Player
operator|.
name|p_quksilver
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|=
name|MIN
argument_list|(
name|Player
operator|.
name|p_mana
argument_list|,
name|Player
operator|.
name|p_level
operator|*
name|Statptr
operator|->
name|c_maxmana
operator|+
literal|1000.0
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|=
name|MIN
argument_list|(
name|Player
operator|.
name|p_brains
argument_list|,
name|Player
operator|.
name|p_level
operator|*
name|Statptr
operator|->
name|c_maxbrains
operator|+
literal|200.0
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_charms
operator|=
name|MIN
argument_list|(
name|Player
operator|.
name|p_charms
argument_list|,
name|Player
operator|.
name|p_level
operator|+
literal|10.0
argument_list|)
expr_stmt|;
comment|/*      * some implementations have problems with floating point compare      * we work around it with this stuff      */
name|Player
operator|.
name|p_gold
operator|=
name|floor
argument_list|(
name|Player
operator|.
name|p_gold
argument_list|)
operator|+
literal|0.1
expr_stmt|;
name|Player
operator|.
name|p_gems
operator|=
name|floor
argument_list|(
name|Player
operator|.
name|p_gems
argument_list|)
operator|+
literal|0.1
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|=
name|floor
argument_list|(
name|Player
operator|.
name|p_mana
argument_list|)
operator|+
literal|0.1
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|!=
name|R_NONE
condition|)
comment|/* do ring things */
block|{
comment|/* rest to max */
name|Player
operator|.
name|p_energy
operator|=
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_shield
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_duration
operator|<=
literal|0
condition|)
comment|/* clean up expired rings */
switch|switch
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
condition|)
block|{
case|case
name|R_BAD
case|:
comment|/* ring drives player crazy */
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|=
name|R_SPOILED
expr_stmt|;
name|Player
operator|.
name|p_ring
operator|.
name|ring_duration
operator|=
operator|(
name|short
operator|)
name|ROLL
argument_list|(
literal|10.0
argument_list|,
literal|25.0
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_NAZREG
case|:
comment|/* ring disappears */
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|=
name|R_NONE
expr_stmt|;
break|break;
case|case
name|R_SPOILED
case|:
comment|/* ring kills player */
name|death
argument_list|(
literal|"A cursed ring"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_DLREG
case|:
comment|/* this ring doesn't expire */
name|Player
operator|.
name|p_ring
operator|.
name|ring_duration
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|Player
operator|.
name|p_age
operator|/
name|N_AGE
operator|>
name|Player
operator|.
name|p_degenerated
condition|)
comment|/* age player slightly */
block|{
operator|++
name|Player
operator|.
name|p_degenerated
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_quickness
operator|>
literal|23.0
condition|)
name|Player
operator|.
name|p_quickness
operator|*=
literal|0.99
expr_stmt|;
name|Player
operator|.
name|p_strength
operator|*=
literal|0.97
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|*=
literal|0.95
expr_stmt|;
name|Player
operator|.
name|p_magiclvl
operator|*=
literal|0.97
expr_stmt|;
name|Player
operator|.
name|p_maxenergy
operator|*=
literal|0.95
expr_stmt|;
name|Player
operator|.
name|p_quksilver
operator|*=
literal|0.95
expr_stmt|;
name|Player
operator|.
name|p_sword
operator|*=
literal|0.93
expr_stmt|;
name|Player
operator|.
name|p_shield
operator|*=
literal|0.93
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: initplayer() / / FUNCTION: initialize a character / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	struct player *playerp - pointer to structure to init / / RETURN VALUE: none / / MODULES CALLED: floor(), drandom() / / GLOBAL INPUTS: none / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Put a bunch of default values in the given structure. / /************************************************************************/
end_comment

begin_expr_stmt
name|initplayer
argument_list|(
name|playerp
argument_list|)
specifier|register
expr|struct
name|player
operator|*
name|playerp
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|playerp
operator|->
name|p_experience
operator|=
name|playerp
operator|->
name|p_level
operator|=
name|playerp
operator|->
name|p_strength
operator|=
name|playerp
operator|->
name|p_sword
operator|=
name|playerp
operator|->
name|p_might
operator|=
name|playerp
operator|->
name|p_energy
operator|=
name|playerp
operator|->
name|p_maxenergy
operator|=
name|playerp
operator|->
name|p_shield
operator|=
name|playerp
operator|->
name|p_quickness
operator|=
name|playerp
operator|->
name|p_quksilver
operator|=
name|playerp
operator|->
name|p_speed
operator|=
name|playerp
operator|->
name|p_magiclvl
operator|=
name|playerp
operator|->
name|p_mana
operator|=
name|playerp
operator|->
name|p_brains
operator|=
name|playerp
operator|->
name|p_poison
operator|=
name|playerp
operator|->
name|p_gems
operator|=
name|playerp
operator|->
name|p_sin
operator|=
name|playerp
operator|->
name|p_1scratch
operator|=
name|playerp
operator|->
name|p_2scratch
operator|=
literal|0.0
expr_stmt|;
name|playerp
operator|->
name|p_gold
operator|=
name|ROLL
argument_list|(
literal|50.0
argument_list|,
literal|75.0
argument_list|)
operator|+
literal|0.1
expr_stmt|;
comment|/* give some gold */
name|playerp
operator|->
name|p_x
operator|=
name|ROLL
argument_list|(
operator|-
literal|125.0
argument_list|,
literal|251.0
argument_list|)
expr_stmt|;
name|playerp
operator|->
name|p_y
operator|=
name|ROLL
argument_list|(
operator|-
literal|125.0
argument_list|,
literal|251.0
argument_list|)
expr_stmt|;
comment|/* give random x, y */
comment|/* clear ring */
name|playerp
operator|->
name|p_ring
operator|.
name|ring_type
operator|=
name|R_NONE
expr_stmt|;
name|playerp
operator|->
name|p_ring
operator|.
name|ring_duration
operator|=
literal|0
expr_stmt|;
name|playerp
operator|->
name|p_ring
operator|.
name|ring_inuse
operator|=
name|FALSE
expr_stmt|;
name|playerp
operator|->
name|p_age
operator|=
literal|0L
expr_stmt|;
name|playerp
operator|->
name|p_degenerated
operator|=
literal|1
expr_stmt|;
comment|/* don't degenerate initially */
name|playerp
operator|->
name|p_type
operator|=
name|C_FIGHTER
expr_stmt|;
comment|/* default */
name|playerp
operator|->
name|p_specialtype
operator|=
name|SC_NONE
expr_stmt|;
name|playerp
operator|->
name|p_lives
operator|=
name|playerp
operator|->
name|p_crowns
operator|=
name|playerp
operator|->
name|p_charms
operator|=
name|playerp
operator|->
name|p_amulets
operator|=
name|playerp
operator|->
name|p_holywater
operator|=
name|playerp
operator|->
name|p_lastused
operator|=
literal|0
expr_stmt|;
name|playerp
operator|->
name|p_status
operator|=
name|S_NOTUSED
expr_stmt|;
name|playerp
operator|->
name|p_tampered
operator|=
name|T_OFF
expr_stmt|;
name|playerp
operator|->
name|p_istat
operator|=
name|I_OFF
expr_stmt|;
name|playerp
operator|->
name|p_palantir
operator|=
name|playerp
operator|->
name|p_blessing
operator|=
name|playerp
operator|->
name|p_virgin
operator|=
name|playerp
operator|->
name|p_blindness
operator|=
name|FALSE
expr_stmt|;
name|playerp
operator|->
name|p_name
index|[
literal|0
index|]
operator|=
name|playerp
operator|->
name|p_password
index|[
literal|0
index|]
operator|=
name|playerp
operator|->
name|p_login
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: readmessage() / / FUNCTION: read message from other players / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: fseek(), fgets(), wmove(), waddstr(), wclrtoeol() / / GLOBAL INPUTS: *stdscr, Databuf[], *Messagefp / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	If there is a message from other players, print it. / /************************************************************************/
end_comment

begin_macro
name|readmessage
argument_list|()
end_macro

begin_block
block|{
name|move
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtoeol
argument_list|()
expr_stmt|;
name|fseek
argument_list|(
name|Messagefp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|Databuf
argument_list|,
name|SZ_DATABUF
argument_list|,
name|Messagefp
argument_list|)
operator|!=
name|NULL
condition|)
name|addstr
argument_list|(
name|Databuf
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: error() / / FUNCTION: process evironment error / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	char *whichfile - pointer to name of file which caused error / / RETURN VALUE: none / / MODULES CALLED: wclear(), cleanup() / / GLOBAL INPUTS: errno, *stdscr, printw(), printf(), Windows / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Print message about offending file, and exit. / /************************************************************************/
end_comment

begin_macro
name|error
argument_list|(
argument|whichfile
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|whichfile
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
argument_list|(
argument|*funcp
argument_list|)
name|__P
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|,
operator|...
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Windows
condition|)
block|{
name|funcp
operator|=
name|printw
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
block|}
else|else
name|funcp
operator|=
name|printf
expr_stmt|;
call|(
modifier|*
name|funcp
call|)
argument_list|(
literal|"An unrecoverable error has occurred reading %s.  (errno = %d)\n"
argument_list|,
name|whichfile
argument_list|,
name|errno
argument_list|)
expr_stmt|;
call|(
modifier|*
name|funcp
call|)
argument_list|(
literal|"Please run 'setup' to determine the problem.\n"
argument_list|)
expr_stmt|;
name|cleanup
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: distance() / / FUNCTION: calculate distance between two points / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS:  /	double x1, y1 - x, y coordinates of first point /	double x2, y2 - x, y coordinates of second point / / RETURN VALUE: distance between the two points / / MODULES CALLED: sqrt() / / GLOBAL INPUTS: none / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	This function is provided because someone's hypot() library function /	fails if x1 == x2&& y1 == y2. / /************************************************************************/
end_comment

begin_function
name|double
name|distance
parameter_list|(
name|x1
parameter_list|,
name|x2
parameter_list|,
name|y1
parameter_list|,
name|y2
parameter_list|)
name|double
name|x1
decl_stmt|,
name|x2
decl_stmt|,
name|y1
decl_stmt|,
name|y2
decl_stmt|;
block|{
name|double
name|deltax
decl_stmt|,
name|deltay
decl_stmt|;
name|deltax
operator|=
name|x1
operator|-
name|x2
expr_stmt|;
name|deltay
operator|=
name|y1
operator|-
name|y2
expr_stmt|;
return|return
operator|(
name|sqrt
argument_list|(
name|deltax
operator|*
name|deltax
operator|+
name|deltay
operator|*
name|deltay
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: ill_sig() / / FUNCTION: exit upon trapping an illegal signal / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	int whichsig - signal which occured to cause jump to here / / RETURN VALUE: none / / MODULES CALLED: wclear(), printw(), cleanup() / / GLOBAL INPUTS: *stdscr / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	When an illegal signal is caught, print a message, and cleanup. / /************************************************************************/
end_comment

begin_macro
name|ill_sig
argument_list|(
argument|whichsig
argument_list|)
end_macro

begin_decl_stmt
name|int
name|whichsig
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|whichsig
operator|==
name|SIGINT
operator|||
name|whichsig
operator|==
name|SIGQUIT
operator|)
condition|)
name|printw
argument_list|(
literal|"Error: caught signal # %d.\n"
argument_list|,
name|whichsig
argument_list|)
expr_stmt|;
name|cleanup
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: descrstatus() / / FUNCTION: return a string describing the player status / / AUTHOR: E. A. Estes, 3/3/86 / / ARGUMENTS: /	struct player playerp - pointer to player structure to describe / / RETURN VALUE: string describing player's status / / MODULES CALLED: none / / GLOBAL INPUTS: none / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Return verbal description of player status. /	If player status is S_PLAYING, check for low energy and blindness. / /************************************************************************/
end_comment

begin_function
name|char
modifier|*
name|descrstatus
parameter_list|(
name|playerp
parameter_list|)
specifier|register
name|struct
name|player
modifier|*
name|playerp
decl_stmt|;
block|{
switch|switch
condition|(
name|playerp
operator|->
name|p_status
condition|)
block|{
case|case
name|S_PLAYING
case|:
if|if
condition|(
name|playerp
operator|->
name|p_energy
operator|<
literal|0.2
operator|*
operator|(
name|playerp
operator|->
name|p_maxenergy
operator|+
name|playerp
operator|->
name|p_shield
operator|)
condition|)
return|return
operator|(
literal|"Low Energy"
operator|)
return|;
elseif|else
if|if
condition|(
name|playerp
operator|->
name|p_blindness
condition|)
return|return
operator|(
literal|"Blind"
operator|)
return|;
else|else
return|return
operator|(
literal|"In game"
operator|)
return|;
case|case
name|S_CLOAKED
case|:
return|return
operator|(
literal|"Cloaked"
operator|)
return|;
case|case
name|S_INBATTLE
case|:
return|return
operator|(
literal|"In Battle"
operator|)
return|;
case|case
name|S_MONSTER
case|:
return|return
operator|(
literal|"Encounter"
operator|)
return|;
case|case
name|S_TRADING
case|:
return|return
operator|(
literal|"Trading"
operator|)
return|;
case|case
name|S_OFF
case|:
return|return
operator|(
literal|"Off"
operator|)
return|;
case|case
name|S_HUNGUP
case|:
return|return
operator|(
literal|"Hung up"
operator|)
return|;
default|default:
return|return
operator|(
literal|""
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: drandom() / / FUNCTION: return a random floating point number from 0.0< 1.0 / / AUTHOR: E. A. Estes, 2/7/86 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: random() / / GLOBAL INPUTS: none / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Convert random integer from library routine into a floating /	point number, and divide by the largest possible random number. /	We mask large integers with 32767 to handle sites that return /	31 bit random integers. / /************************************************************************/
end_comment

begin_function
name|double
name|drandom
parameter_list|()
block|{
if|if
condition|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|!=
literal|2
condition|)
comment|/* use only low bits */
return|return
operator|(
call|(
name|double
call|)
argument_list|(
name|random
argument_list|()
operator|&
literal|0x7fff
argument_list|)
operator|/
literal|32768.0
operator|)
return|;
else|else
return|return
operator|(
operator|(
name|double
operator|)
name|random
argument_list|()
operator|/
literal|32768.0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: collecttaxes() / / FUNCTION: collect taxes from current player / / AUTHOR: E. A. Estes, 2/7/86 / / ARGUMENTS: /	double gold - amount of gold to tax /	double gems - amount of gems to tax / / RETURN VALUE: none / / MODULES CALLED: fread(), fseek(), fopen(), floor(), fwrite(), fclose() / / GLOBAL INPUTS: Player / / GLOBAL OUTPUTS: Player / / DESCRIPTION: /	Pay taxes on gold and gems.  If the player does not have enough /	gold to pay taxes on the added gems, convert some gems to gold. /	Add taxes to tax data base; add remaining gold and gems to /	player's cache. / /************************************************************************/
end_comment

begin_macro
name|collecttaxes
argument_list|(
argument|gold
argument_list|,
argument|gems
argument_list|)
end_macro

begin_decl_stmt
name|double
name|gold
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|gems
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
comment|/* to update Goldfile */
name|double
name|dtemp
decl_stmt|;
comment|/* for temporary calculations */
name|double
name|taxes
decl_stmt|;
comment|/* tax liability */
comment|/* add to cache */
name|Player
operator|.
name|p_gold
operator|+=
name|gold
expr_stmt|;
name|Player
operator|.
name|p_gems
operator|+=
name|gems
expr_stmt|;
comment|/* calculate tax liability */
name|taxes
operator|=
name|N_TAXAMOUNT
operator|/
literal|100.0
operator|*
operator|(
name|N_GEMVALUE
operator|*
name|gems
operator|+
name|gold
operator|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_gold
operator|<
name|taxes
condition|)
comment|/* not enough gold to pay taxes, must convert some gems to gold */
block|{
name|dtemp
operator|=
name|floor
argument_list|(
name|taxes
operator|/
name|N_GEMVALUE
operator|+
literal|1.0
argument_list|)
expr_stmt|;
comment|/* number of gems to convert */
if|if
condition|(
name|Player
operator|.
name|p_gems
operator|>=
name|dtemp
condition|)
comment|/* player has enough to convert */
block|{
name|Player
operator|.
name|p_gems
operator|-=
name|dtemp
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|+=
name|dtemp
operator|*
name|N_GEMVALUE
expr_stmt|;
block|}
else|else
comment|/* take everything; this should never happen */
block|{
name|Player
operator|.
name|p_gold
operator|+=
name|Player
operator|.
name|p_gems
operator|*
name|N_GEMVALUE
expr_stmt|;
name|Player
operator|.
name|p_gems
operator|=
literal|0.0
expr_stmt|;
name|taxes
operator|=
name|Player
operator|.
name|p_gold
expr_stmt|;
block|}
block|}
name|Player
operator|.
name|p_gold
operator|-=
name|taxes
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|_PATH_GOLD
argument_list|,
literal|"r+"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
comment|/* update taxes */
block|{
name|dtemp
operator|=
literal|0.0
expr_stmt|;
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|dtemp
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|dtemp
operator|+=
name|floor
argument_list|(
name|taxes
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|fp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|dtemp
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit


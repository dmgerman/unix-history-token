begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * gamesupport.c - auxiliary routines for support of Phantasia  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"include.h"
end_include

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: changestats() / / FUNCTION: examine/change statistics for a player / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	bool ingameflag - set if called while playing game (Wizard only) / / RETURN VALUE: none / / MODULES CALLED: freerecord(), writerecord(), descrstatus(), truncstring(), /	time(), more(), wmove(), wclear(), strcmp(), printw(), strcpy(), /	infloat(), waddstr(), cleanup(), findname(), userlist(), mvprintw(), /	localtime(), getanswer(), descrtype(), getstring() / / GLOBAL INPUTS: LINES, *Login, Other, Wizard, Player, *stdscr, Databuf[], /	Fileloc / / GLOBAL OUTPUTS: Echo / / DESCRIPTION: /	Prompt for player name to examine/change. /	If the name is NULL, print a list of all players. /	If we are called from within the game, check for the /	desired name being the same as the current player's name. /	Only the 'Wizard' may alter players. /	Items are changed only if a non-zero value is specified. /	To change an item to 0, use 0.1; it will be truncated later. / /	Players may alter their names and passwords, if the following /	are true: /	    - current login matches the character's logins /	    - the password is known /	    - the player is not in the middle of the game (ingameflag == FALSE) / /	The last condition is imposed for two reasons: /	    - the game could possibly get a bit hectic if a player were /	      continually changing his/her name /	    - another player structure would be necessary to check for names /	      already in use / *************************************************************************/
end_comment

begin_macro
name|changestats
argument_list|(
argument|ingameflag
argument_list|)
end_macro

begin_decl_stmt
name|bool
name|ingameflag
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|char
name|flag
index|[
literal|2
index|]
init|=
comment|/* for printing values of bools */
block|{
literal|'F'
block|,
literal|'T'
block|}
decl_stmt|;
name|struct
name|player
modifier|*
name|playerp
decl_stmt|;
comment|/* pointer to structure to alter */
name|char
modifier|*
name|prompt
decl_stmt|;
comment|/* pointer to prompt string */
name|int
name|c
decl_stmt|;
comment|/* input */
name|int
name|today
decl_stmt|;
comment|/* day of year of today */
name|int
name|temp
decl_stmt|;
comment|/* temporary variable */
name|long
name|loc
decl_stmt|;
comment|/* location in player file */
name|time_t
name|now
decl_stmt|;
comment|/* time now */
name|double
name|dtemp
decl_stmt|;
comment|/* temporary variable */
name|bool
modifier|*
name|bptr
decl_stmt|;
comment|/* pointer to bool item to change */
name|double
modifier|*
name|dptr
decl_stmt|;
comment|/* pointer to double item to change */
name|short
modifier|*
name|sptr
decl_stmt|;
comment|/* pointer to short item to change */
name|clear
argument_list|()
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
comment|/* get name of player to examine/alter */
block|{
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"Which character do you want to look at ? "
argument_list|)
expr_stmt|;
name|getstring
argument_list|(
name|Databuf
argument_list|,
name|SZ_DATABUF
argument_list|)
expr_stmt|;
name|truncstring
argument_list|(
name|Databuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|Databuf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|userlist
argument_list|(
name|ingameflag
argument_list|)
expr_stmt|;
else|else
break|break;
block|}
name|loc
operator|=
operator|-
literal|1L
expr_stmt|;
if|if
condition|(
operator|!
name|ingameflag
condition|)
comment|/* use 'Player' structure */
name|playerp
operator|=
operator|&
name|Player
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|Databuf
argument_list|,
name|Player
operator|.
name|p_name
argument_list|)
operator|==
literal|0
condition|)
comment|/* alter/examine current player */
block|{
name|playerp
operator|=
operator|&
name|Player
expr_stmt|;
name|loc
operator|=
name|Fileloc
expr_stmt|;
block|}
else|else
comment|/* use 'Other' structure */
name|playerp
operator|=
operator|&
name|Other
expr_stmt|;
comment|/* find player on file */
if|if
condition|(
name|loc
operator|<
literal|0L
operator|&&
operator|(
name|loc
operator|=
name|findname
argument_list|(
name|Databuf
argument_list|,
name|playerp
argument_list|)
operator|)
operator|<
literal|0L
condition|)
comment|/* didn't find player */
block|{
name|clear
argument_list|()
expr_stmt|;
name|mvaddstr
argument_list|(
literal|11
argument_list|,
literal|0
argument_list|,
literal|"Not found."
argument_list|)
expr_stmt|;
return|return;
block|}
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|today
operator|=
name|localtime
argument_list|(
operator|&
name|now
argument_list|)
operator|->
name|tm_yday
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
comment|/* print player structure, and prompt for action */
block|{
name|mvprintw
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"A:Name         %s\n"
argument_list|,
name|playerp
operator|->
name|p_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|Wizard
condition|)
name|printw
argument_list|(
literal|"B:Password     %s\n"
argument_list|,
name|playerp
operator|->
name|p_password
argument_list|)
expr_stmt|;
else|else
name|addstr
argument_list|(
literal|"B:Password     XXXXXXXX\n"
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|" :Login        %s\n"
argument_list|,
name|playerp
operator|->
name|p_login
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"C:Experience   %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_experience
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"D:Level        %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_level
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"E:Strength     %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_strength
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"F:Sword        %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_sword
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|" :Might        %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_might
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"G:Energy       %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_energy
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"H:Max-Energy   %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_maxenergy
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"I:Shield       %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_shield
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"J:Quickness    %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_quickness
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"K:Quicksilver  %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_quksilver
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|" :Speed        %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_speed
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"L:Magic Level  %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_magiclvl
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"M:Mana         %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_mana
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"N:Brains       %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_brains
argument_list|)
expr_stmt|;
if|if
condition|(
name|Wizard
operator|||
name|playerp
operator|->
name|p_specialtype
operator|!=
name|SC_VALAR
condition|)
name|mvaddstr
argument_list|(
literal|0
argument_list|,
literal|40
argument_list|,
name|descrstatus
argument_list|(
name|playerp
argument_list|)
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|1
argument_list|,
literal|40
argument_list|,
literal|"O:Poison       %0.3f\n"
argument_list|,
name|playerp
operator|->
name|p_poison
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|2
argument_list|,
literal|40
argument_list|,
literal|"P:Gold         %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_gold
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|3
argument_list|,
literal|40
argument_list|,
literal|"Q:Gem          %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_gems
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|4
argument_list|,
literal|40
argument_list|,
literal|"R:Sin          %0.3f\n"
argument_list|,
name|playerp
operator|->
name|p_sin
argument_list|)
expr_stmt|;
if|if
condition|(
name|Wizard
condition|)
block|{
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|40
argument_list|,
literal|"S:X-coord      %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_x
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|6
argument_list|,
literal|40
argument_list|,
literal|"T:Y-coord      %.0f\n"
argument_list|,
name|playerp
operator|->
name|p_y
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|40
argument_list|,
literal|"S:X-coord      ?\n"
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|6
argument_list|,
literal|40
argument_list|,
literal|"T:Y-coord      ?\n"
argument_list|)
expr_stmt|;
block|}
name|mvprintw
argument_list|(
literal|7
argument_list|,
literal|40
argument_list|,
literal|"U:Age          %ld\n"
argument_list|,
name|playerp
operator|->
name|p_age
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|8
argument_list|,
literal|40
argument_list|,
literal|"V:Degenerated  %d\n"
argument_list|,
name|playerp
operator|->
name|p_degenerated
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|9
argument_list|,
literal|40
argument_list|,
literal|"W:Type         %d (%s)\n"
argument_list|,
name|playerp
operator|->
name|p_type
argument_list|,
name|descrtype
argument_list|(
name|playerp
argument_list|,
name|FALSE
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|10
argument_list|,
literal|40
argument_list|,
literal|"X:Special Type %d\n"
argument_list|,
name|playerp
operator|->
name|p_specialtype
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|11
argument_list|,
literal|40
argument_list|,
literal|"Y:Lives        %d\n"
argument_list|,
name|playerp
operator|->
name|p_lives
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|12
argument_list|,
literal|40
argument_list|,
literal|"Z:Crowns       %d\n"
argument_list|,
name|playerp
operator|->
name|p_crowns
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|13
argument_list|,
literal|40
argument_list|,
literal|"0:Charms       %d\n"
argument_list|,
name|playerp
operator|->
name|p_charms
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|14
argument_list|,
literal|40
argument_list|,
literal|"1:Amulets      %d\n"
argument_list|,
name|playerp
operator|->
name|p_amulets
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|15
argument_list|,
literal|40
argument_list|,
literal|"2:Holy Water   %d\n"
argument_list|,
name|playerp
operator|->
name|p_holywater
argument_list|)
expr_stmt|;
name|temp
operator|=
name|today
operator|-
name|playerp
operator|->
name|p_lastused
expr_stmt|;
if|if
condition|(
name|temp
operator|<
literal|0
condition|)
comment|/* last year */
name|temp
operator|+=
literal|365
expr_stmt|;
name|mvprintw
argument_list|(
literal|16
argument_list|,
literal|40
argument_list|,
literal|"3:Lastused     %d  (%d)\n"
argument_list|,
name|playerp
operator|->
name|p_lastused
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|18
argument_list|,
literal|8
argument_list|,
literal|"4:Palantir %c  5:Blessing %c  6:Virgin %c  7:Blind %c"
argument_list|,
name|flag
index|[
name|playerp
operator|->
name|p_palantir
index|]
argument_list|,
name|flag
index|[
name|playerp
operator|->
name|p_blessing
index|]
argument_list|,
name|flag
index|[
name|playerp
operator|->
name|p_virgin
index|]
argument_list|,
name|flag
index|[
name|playerp
operator|->
name|p_blindness
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Wizard
condition|)
name|mvprintw
argument_list|(
literal|19
argument_list|,
literal|8
argument_list|,
literal|"8:Ring    %c"
argument_list|,
name|flag
index|[
name|playerp
operator|->
name|p_ring
operator|.
name|ring_type
operator|!=
name|R_NONE
index|]
argument_list|)
expr_stmt|;
else|else
name|mvprintw
argument_list|(
literal|19
argument_list|,
literal|8
argument_list|,
literal|"8:Ring    %d  9:Duration %d"
argument_list|,
name|playerp
operator|->
name|p_ring
operator|.
name|ring_type
argument_list|,
name|playerp
operator|->
name|p_ring
operator|.
name|ring_duration
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Wizard
comment|/* not wizard */
operator|&&
operator|(
name|ingameflag
operator|||
name|strcmp
argument_list|(
name|Login
argument_list|,
name|playerp
operator|->
name|p_login
argument_list|)
operator|!=
literal|0
operator|)
condition|)
comment|/* in game or not examining own character */
block|{
if|if
condition|(
name|ingameflag
condition|)
block|{
name|more
argument_list|(
name|LINES
operator|-
literal|1
argument_list|)
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
return|return;
block|}
else|else
name|cleanup
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
name|mvaddstr
argument_list|(
literal|20
argument_list|,
literal|0
argument_list|,
literal|"!:Quit       ?:Delete"
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|21
argument_list|,
literal|0
argument_list|,
literal|"What would you like to change ? "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Wizard
condition|)
name|c
operator|=
name|getanswer
argument_list|(
literal|" "
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
else|else
comment|/* examining own player; allow to change name and password */
name|c
operator|=
name|getanswer
argument_list|(
literal|"!BA"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'A'
case|:
comment|/* change name */
case|case
literal|'B'
case|:
comment|/* change password */
if|if
condition|(
operator|!
name|Wizard
condition|)
comment|/* prompt for password */
block|{
name|mvaddstr
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"Password ? "
argument_list|)
expr_stmt|;
name|Echo
operator|=
name|FALSE
expr_stmt|;
name|getstring
argument_list|(
name|Databuf
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|Echo
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|Databuf
argument_list|,
name|playerp
operator|->
name|p_password
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
block|}
if|if
condition|(
name|c
operator|==
literal|'A'
condition|)
comment|/* get new name */
block|{
name|mvaddstr
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"New name: "
argument_list|)
expr_stmt|;
name|getstring
argument_list|(
name|Databuf
argument_list|,
name|SZ_NAME
argument_list|)
expr_stmt|;
name|truncstring
argument_list|(
name|Databuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|Databuf
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
if|if
condition|(
name|Wizard
operator|||
name|findname
argument_list|(
name|Databuf
argument_list|,
operator|&
name|Other
argument_list|)
operator|<
literal|0L
condition|)
name|strcpy
argument_list|(
name|playerp
operator|->
name|p_name
argument_list|,
name|Databuf
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* get new password */
block|{
if|if
condition|(
operator|!
name|Wizard
condition|)
name|Echo
operator|=
name|FALSE
expr_stmt|;
do|do
comment|/* get two copies of new password until they match */
block|{
comment|/* get first copy */
name|mvaddstr
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"New password ? "
argument_list|)
expr_stmt|;
name|getstring
argument_list|(
name|Databuf
argument_list|,
name|SZ_PASSWORD
argument_list|)
expr_stmt|;
if|if
condition|(
name|Databuf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
break|break;
comment|/* get second copy */
name|mvaddstr
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"One more time ? "
argument_list|)
expr_stmt|;
name|getstring
argument_list|(
name|playerp
operator|->
name|p_password
argument_list|,
name|SZ_PASSWORD
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|strcmp
argument_list|(
name|playerp
operator|->
name|p_password
argument_list|,
name|Databuf
argument_list|)
operator|!=
literal|0
condition|)
do|;
name|Echo
operator|=
name|TRUE
expr_stmt|;
block|}
continue|continue;
case|case
literal|'C'
case|:
comment|/* change experience */
name|prompt
operator|=
literal|"experience"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_experience
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'D'
case|:
comment|/* change level */
name|prompt
operator|=
literal|"level"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_level
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'E'
case|:
comment|/* change strength */
name|prompt
operator|=
literal|"strength"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_strength
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'F'
case|:
comment|/* change swords */
name|prompt
operator|=
literal|"sword"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_sword
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'G'
case|:
comment|/* change energy */
name|prompt
operator|=
literal|"energy"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_energy
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'H'
case|:
comment|/* change maximum energy */
name|prompt
operator|=
literal|"max energy"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_maxenergy
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'I'
case|:
comment|/* change shields */
name|prompt
operator|=
literal|"shield"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_shield
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'J'
case|:
comment|/* change quickness */
name|prompt
operator|=
literal|"quickness"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_quickness
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'K'
case|:
comment|/* change quicksilver */
name|prompt
operator|=
literal|"quicksilver"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_quksilver
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'L'
case|:
comment|/* change magic */
name|prompt
operator|=
literal|"magic level"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_magiclvl
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'M'
case|:
comment|/* change mana */
name|prompt
operator|=
literal|"mana"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_mana
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'N'
case|:
comment|/* change brains */
name|prompt
operator|=
literal|"brains"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_brains
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'O'
case|:
comment|/* change poison */
name|prompt
operator|=
literal|"poison"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_poison
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'P'
case|:
comment|/* change gold */
name|prompt
operator|=
literal|"gold"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_gold
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'Q'
case|:
comment|/* change gems */
name|prompt
operator|=
literal|"gems"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_gems
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'R'
case|:
comment|/* change sin */
name|prompt
operator|=
literal|"sin"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_sin
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'S'
case|:
comment|/* change x coord */
name|prompt
operator|=
literal|"x"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_x
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'T'
case|:
comment|/* change y coord */
name|prompt
operator|=
literal|"y"
expr_stmt|;
name|dptr
operator|=
operator|&
name|playerp
operator|->
name|p_y
expr_stmt|;
goto|goto
name|DALTER
goto|;
case|case
literal|'U'
case|:
comment|/* change age */
name|mvprintw
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"age = %ld; age = "
argument_list|,
name|playerp
operator|->
name|p_age
argument_list|)
expr_stmt|;
name|dtemp
operator|=
name|infloat
argument_list|()
expr_stmt|;
if|if
condition|(
name|dtemp
operator|!=
literal|0.0
condition|)
name|playerp
operator|->
name|p_age
operator|=
operator|(
name|long
operator|)
name|dtemp
expr_stmt|;
continue|continue;
case|case
literal|'V'
case|:
comment|/* change degen */
name|mvprintw
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"degen = %d; degen = "
argument_list|,
name|playerp
operator|->
name|p_degenerated
argument_list|)
expr_stmt|;
name|dtemp
operator|=
name|infloat
argument_list|()
expr_stmt|;
if|if
condition|(
name|dtemp
operator|!=
literal|0.0
condition|)
name|playerp
operator|->
name|p_degenerated
operator|=
operator|(
name|int
operator|)
name|dtemp
expr_stmt|;
continue|continue;
case|case
literal|'W'
case|:
comment|/* change type */
name|prompt
operator|=
literal|"type"
expr_stmt|;
name|sptr
operator|=
operator|&
name|playerp
operator|->
name|p_type
expr_stmt|;
goto|goto
name|SALTER
goto|;
case|case
literal|'X'
case|:
comment|/* change special type */
name|prompt
operator|=
literal|"special type"
expr_stmt|;
name|sptr
operator|=
operator|&
name|playerp
operator|->
name|p_specialtype
expr_stmt|;
goto|goto
name|SALTER
goto|;
case|case
literal|'Y'
case|:
comment|/* change lives */
name|prompt
operator|=
literal|"lives"
expr_stmt|;
name|sptr
operator|=
operator|&
name|playerp
operator|->
name|p_lives
expr_stmt|;
goto|goto
name|SALTER
goto|;
case|case
literal|'Z'
case|:
comment|/* change crowns */
name|prompt
operator|=
literal|"crowns"
expr_stmt|;
name|sptr
operator|=
operator|&
name|playerp
operator|->
name|p_crowns
expr_stmt|;
goto|goto
name|SALTER
goto|;
case|case
literal|'0'
case|:
comment|/* change charms */
name|prompt
operator|=
literal|"charm"
expr_stmt|;
name|sptr
operator|=
operator|&
name|playerp
operator|->
name|p_charms
expr_stmt|;
goto|goto
name|SALTER
goto|;
case|case
literal|'1'
case|:
comment|/* change amulet */
name|prompt
operator|=
literal|"amulet"
expr_stmt|;
name|sptr
operator|=
operator|&
name|playerp
operator|->
name|p_amulets
expr_stmt|;
goto|goto
name|SALTER
goto|;
case|case
literal|'2'
case|:
comment|/* change holy water */
name|prompt
operator|=
literal|"holy water"
expr_stmt|;
name|sptr
operator|=
operator|&
name|playerp
operator|->
name|p_holywater
expr_stmt|;
goto|goto
name|SALTER
goto|;
case|case
literal|'3'
case|:
comment|/* change last-used */
name|prompt
operator|=
literal|"last-used"
expr_stmt|;
name|sptr
operator|=
operator|&
name|playerp
operator|->
name|p_lastused
expr_stmt|;
goto|goto
name|SALTER
goto|;
case|case
literal|'4'
case|:
comment|/* change palantir */
name|prompt
operator|=
literal|"palantir"
expr_stmt|;
name|bptr
operator|=
operator|&
name|playerp
operator|->
name|p_palantir
expr_stmt|;
goto|goto
name|BALTER
goto|;
case|case
literal|'5'
case|:
comment|/* change blessing */
name|prompt
operator|=
literal|"blessing"
expr_stmt|;
name|bptr
operator|=
operator|&
name|playerp
operator|->
name|p_blessing
expr_stmt|;
goto|goto
name|BALTER
goto|;
case|case
literal|'6'
case|:
comment|/* change virgin */
name|prompt
operator|=
literal|"virgin"
expr_stmt|;
name|bptr
operator|=
operator|&
name|playerp
operator|->
name|p_virgin
expr_stmt|;
goto|goto
name|BALTER
goto|;
case|case
literal|'7'
case|:
comment|/* change blindness */
name|prompt
operator|=
literal|"blindness"
expr_stmt|;
name|bptr
operator|=
operator|&
name|playerp
operator|->
name|p_blindness
expr_stmt|;
goto|goto
name|BALTER
goto|;
case|case
literal|'8'
case|:
comment|/* change ring type */
name|prompt
operator|=
literal|"ring-type"
expr_stmt|;
name|sptr
operator|=
operator|&
name|playerp
operator|->
name|p_ring
operator|.
name|ring_type
expr_stmt|;
goto|goto
name|SALTER
goto|;
case|case
literal|'9'
case|:
comment|/* change ring duration */
name|prompt
operator|=
literal|"ring-duration"
expr_stmt|;
name|sptr
operator|=
operator|&
name|playerp
operator|->
name|p_ring
operator|.
name|ring_duration
expr_stmt|;
goto|goto
name|SALTER
goto|;
case|case
literal|'!'
case|:
comment|/* quit, update */
if|if
condition|(
name|Wizard
operator|&&
operator|(
operator|!
name|ingameflag
operator|||
name|playerp
operator|!=
operator|&
name|Player
operator|)
condition|)
comment|/* turn off status if not modifying self */
block|{
name|playerp
operator|->
name|p_status
operator|=
name|S_OFF
expr_stmt|;
name|playerp
operator|->
name|p_tampered
operator|=
name|T_OFF
expr_stmt|;
block|}
name|writerecord
argument_list|(
name|playerp
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
return|return;
case|case
literal|'?'
case|:
comment|/* delete player */
if|if
condition|(
name|ingameflag
operator|&&
name|playerp
operator|==
operator|&
name|Player
condition|)
comment|/* cannot delete self */
continue|continue;
name|freerecord
argument_list|(
name|playerp
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
return|return;
default|default:
continue|continue;
block|}
name|DALTER
label|:
name|mvprintw
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"%s = %f; %s = "
argument_list|,
name|prompt
argument_list|,
operator|*
name|dptr
argument_list|,
name|prompt
argument_list|)
expr_stmt|;
name|dtemp
operator|=
name|infloat
argument_list|()
expr_stmt|;
if|if
condition|(
name|dtemp
operator|!=
literal|0.0
condition|)
operator|*
name|dptr
operator|=
name|dtemp
expr_stmt|;
continue|continue;
name|SALTER
label|:
name|mvprintw
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"%s = %d; %s = "
argument_list|,
name|prompt
argument_list|,
operator|*
name|sptr
argument_list|,
name|prompt
argument_list|)
expr_stmt|;
name|dtemp
operator|=
name|infloat
argument_list|()
expr_stmt|;
if|if
condition|(
name|dtemp
operator|!=
literal|0.0
condition|)
operator|*
name|sptr
operator|=
operator|(
name|short
operator|)
name|dtemp
expr_stmt|;
continue|continue;
name|BALTER
label|:
name|mvprintw
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"%s = %c; %s = "
argument_list|,
name|prompt
argument_list|,
name|flag
index|[
operator|*
name|bptr
index|]
argument_list|,
name|prompt
argument_list|)
expr_stmt|;
name|c
operator|=
name|getanswer
argument_list|(
literal|"\nTF"
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'T'
condition|)
operator|*
name|bptr
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'F'
condition|)
operator|*
name|bptr
operator|=
name|FALSE
expr_stmt|;
continue|continue;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: monstlist() / / FUNCTION: print a monster listing / / AUTHOR: E. A. Estes, 2/27/86 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: puts(), fread(), fseek(), printf() / / GLOBAL INPUTS: Curmonster, *Monstfp / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Read monster file, and print a monster listing on standard output. / *************************************************************************/
end_comment

begin_macro
name|monstlist
argument_list|()
end_macro

begin_block
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
comment|/* count in file */
name|puts
argument_list|(
literal|" #)  Name                 Str  Brain  Quick  Energy  Exper  Treas  Type  Flock%\n"
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|Monstfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Curmonster
argument_list|,
name|SZ_MONSTERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Monstfp
argument_list|)
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|"%2d)  %-20.20s%4.0f   %4.0f     %2.0f   %5.0f  %5.0f     %2d    %2d     %3.0f\n"
argument_list|,
name|count
operator|++
argument_list|,
name|Curmonster
operator|.
name|m_name
argument_list|,
name|Curmonster
operator|.
name|m_strength
argument_list|,
name|Curmonster
operator|.
name|m_brains
argument_list|,
name|Curmonster
operator|.
name|m_speed
argument_list|,
name|Curmonster
operator|.
name|m_energy
argument_list|,
name|Curmonster
operator|.
name|m_experience
argument_list|,
name|Curmonster
operator|.
name|m_treasuretype
argument_list|,
name|Curmonster
operator|.
name|m_type
argument_list|,
name|Curmonster
operator|.
name|m_flock
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: scorelist() / / FUNCTION: print player score board / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: fread(), fopen(), printf(), fclose() / / GLOBAL INPUTS: / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Read the scoreboard file and print the contents. / *************************************************************************/
end_comment

begin_macro
name|scorelist
argument_list|()
end_macro

begin_block
block|{
name|struct
name|scoreboard
name|sbuf
decl_stmt|;
comment|/* for reading entries */
name|FILE
modifier|*
name|fp
decl_stmt|;
comment|/* to open the file */
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|_PATH_SCORE
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sbuf
argument_list|,
name|SZ_SCORESTRUCT
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|"%-20s   (%-9s)  Level: %6.0f  Type: %s\n"
argument_list|,
name|sbuf
operator|.
name|sb_name
argument_list|,
name|sbuf
operator|.
name|sb_login
argument_list|,
name|sbuf
operator|.
name|sb_level
argument_list|,
name|sbuf
operator|.
name|sb_type
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: activelist() / / FUNCTION: print list of active players to standard output / / AUTHOR: E. A. Estes, 3/7/86 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: descrstatus(), fread(), fseek(), printf(), descrtype() / / GLOBAL INPUTS: Other, *Playersfp / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Read player file, and print list of active records to standard output. / *************************************************************************/
end_comment

begin_macro
name|activelist
argument_list|()
end_macro

begin_block
block|{
name|fseek
argument_list|(
name|Playersfp
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Current characters on file are:\n\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Other
argument_list|,
name|SZ_PLAYERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Playersfp
argument_list|)
operator|==
literal|1
condition|)
if|if
condition|(
name|Other
operator|.
name|p_status
operator|!=
name|S_NOTUSED
condition|)
name|printf
argument_list|(
literal|"%-20s   (%-9s)  Level: %6.0f  %s  (%s)\n"
argument_list|,
name|Other
operator|.
name|p_name
argument_list|,
name|Other
operator|.
name|p_login
argument_list|,
name|Other
operator|.
name|p_level
argument_list|,
name|descrtype
argument_list|(
operator|&
name|Other
argument_list|,
name|FALSE
argument_list|)
argument_list|,
name|descrstatus
argument_list|(
operator|&
name|Other
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: purgeoldplayers() / / FUNCTION: purge inactive players from player file / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: freerecord(), time(), fread(), fseek(), localtime() / / GLOBAL INPUTS: Other, *Playersfp / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Delete characters which have not been used with the last /	three weeks. / *************************************************************************/
end_comment

begin_macro
name|purgeoldplayers
argument_list|()
end_macro

begin_block
block|{
name|int
name|today
decl_stmt|;
comment|/* day of year for today */
name|int
name|daysold
decl_stmt|;
comment|/* how many days since the character has been used */
name|time_t
name|ltime
decl_stmt|;
comment|/* time in seconds */
name|long
name|loc
init|=
literal|0L
decl_stmt|;
comment|/* location in file */
name|time
argument_list|(
operator|&
name|ltime
argument_list|)
expr_stmt|;
name|today
operator|=
name|localtime
argument_list|(
operator|&
name|ltime
argument_list|)
operator|->
name|tm_yday
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|fseek
argument_list|(
name|Playersfp
argument_list|,
name|loc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Other
argument_list|,
name|SZ_PLAYERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Playersfp
argument_list|)
operator|!=
literal|1
condition|)
break|break;
name|daysold
operator|=
name|today
operator|-
name|Other
operator|.
name|p_lastused
expr_stmt|;
if|if
condition|(
name|daysold
operator|<
literal|0
condition|)
name|daysold
operator|+=
literal|365
expr_stmt|;
if|if
condition|(
name|daysold
operator|>
name|N_DAYSOLD
condition|)
comment|/* player hasn't been used in a while; delete */
name|freerecord
argument_list|(
operator|&
name|Other
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|loc
operator|+=
name|SZ_PLAYERSTRUCT
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: enterscore() / / FUNCTION: enter player into scoreboard / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: fread(), fseek(), fopen(), error(), strcmp(), fclose(), /	strcpy(), fwrite(), descrtype() / / GLOBAL INPUTS: Player / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	The scoreboard keeps track of the highest character on a /	per-login basis. /	Search the scoreboard for an entry for the current login, /	if an entry is found, and it is lower than the current player, /	replace it, otherwise create an entry. / *************************************************************************/
end_comment

begin_macro
name|enterscore
argument_list|()
end_macro

begin_block
block|{
name|struct
name|scoreboard
name|sbuf
decl_stmt|;
comment|/* buffer to read in scoreboard entries */
name|FILE
modifier|*
name|fp
decl_stmt|;
comment|/* to open scoreboard file */
name|long
name|loc
init|=
literal|0L
decl_stmt|;
comment|/* location in scoreboard file */
name|bool
name|found
init|=
name|FALSE
decl_stmt|;
comment|/* set if we found an entry for this login */
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|_PATH_SCORE
argument_list|,
literal|"r+"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sbuf
argument_list|,
name|SZ_SCORESTRUCT
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
operator|==
literal|1
condition|)
if|if
condition|(
name|strcmp
argument_list|(
name|Player
operator|.
name|p_login
argument_list|,
name|sbuf
operator|.
name|sb_login
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
else|else
name|loc
operator|+=
name|SZ_SCORESTRUCT
expr_stmt|;
block|}
else|else
block|{
name|error
argument_list|(
name|_PATH_SCORE
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
comment|/*      * At this point, 'loc' will either indicate a point beyond      * the end of file, or the place where the previous entry      * was found.      */
if|if
condition|(
operator|(
operator|!
name|found
operator|)
operator|||
name|Player
operator|.
name|p_level
operator|>
name|sbuf
operator|.
name|sb_level
condition|)
comment|/* put new entry in for this login */
block|{
name|strcpy
argument_list|(
name|sbuf
operator|.
name|sb_login
argument_list|,
name|Player
operator|.
name|p_login
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|sbuf
operator|.
name|sb_name
argument_list|,
name|Player
operator|.
name|p_name
argument_list|)
expr_stmt|;
name|sbuf
operator|.
name|sb_level
operator|=
name|Player
operator|.
name|p_level
expr_stmt|;
name|strcpy
argument_list|(
name|sbuf
operator|.
name|sb_type
argument_list|,
name|descrtype
argument_list|(
operator|&
name|Player
argument_list|,
name|TRUE
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* update entry */
name|fseek
argument_list|(
name|fp
argument_list|,
name|loc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sbuf
argument_list|,
name|SZ_SCORESTRUCT
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


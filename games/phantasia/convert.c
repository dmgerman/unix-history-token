begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	Convert Phantasia 3.3.1 and 3.3.1+ characs file format to 3.3.2  *  */
end_comment

begin_include
include|#
directive|include
file|"include.h"
end_include

begin_include
include|#
directive|include
file|"oldplayer.h"
end_include

begin_decl_stmt
name|struct
name|oldplayer
name|Oldplayer
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* old format structure */
end_comment

begin_decl_stmt
name|struct
name|player
name|Newplayer
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* new format structure */
end_comment

begin_decl_stmt
name|char
name|Oldpfile
index|[]
init|=
name|DEST
operator|/
name|characs
literal|";		/* old format file */ char	Newpfile[] = DEST/newcharacs"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* new format file */
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: main() / / FUNCTION: convert old Phantasia player file to new format / / AUTHOR: C. Robertson, 9/1/85  E. A. Estes, 3/12/86 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: time(), exit(), fread(), fopen(), srandom(), floor(),  /	random(), strcmp(), fwrite(), strcpy(), fclose(), fprintf() / / GLOBAL INPUTS: _iob[], Oldplayer, Newplayer / / GLOBAL OUTPUTS: Oldplayer, Newplayer / / DESCRIPTION: /	Read in old player structures and write out to new file in /	new format. /	Old player file is unmodified. /	New file is "DEST/newcharacs". /	#define PHANTPLUS to convert from 3.3.1+. / /************************************************************************/
end_comment

begin_function
name|main
parameter_list|()
block|{
name|FILE
modifier|*
name|oldcharac
decl_stmt|,
modifier|*
name|newcharac
decl_stmt|;
comment|/* to open old and new files */
if|if
condition|(
operator|(
name|oldcharac
operator|=
name|fopen
argument_list|(
name|Oldpfile
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot open original character file!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|newcharac
operator|=
name|fopen
argument_list|(
name|Newpfile
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot create new character file!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|srandom
argument_list|(
operator|(
name|unsigned
operator|)
name|time
argument_list|(
operator|(
name|long
operator|*
operator|)
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* prime random numbers */
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Oldplayer
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oldplayer
argument_list|)
argument_list|,
literal|1
argument_list|,
name|oldcharac
argument_list|)
operator|==
literal|1
condition|)
comment|/* read and convert old structures into new */
block|{
name|Newplayer
operator|.
name|p_experience
operator|=
name|Oldplayer
operator|.
name|o_experience
expr_stmt|;
name|Newplayer
operator|.
name|p_level
operator|=
operator|(
name|double
operator|)
name|Oldplayer
operator|.
name|o_level
expr_stmt|;
name|Newplayer
operator|.
name|p_strength
operator|=
name|Oldplayer
operator|.
name|o_strength
expr_stmt|;
name|Newplayer
operator|.
name|p_sword
operator|=
name|Oldplayer
operator|.
name|o_sword
expr_stmt|;
name|Newplayer
operator|.
name|p_might
operator|=
literal|0.0
expr_stmt|;
comment|/* game will calculate */
name|Newplayer
operator|.
name|p_energy
operator|=
name|Oldplayer
operator|.
name|o_energy
expr_stmt|;
name|Newplayer
operator|.
name|p_maxenergy
operator|=
name|Oldplayer
operator|.
name|o_maxenergy
expr_stmt|;
name|Newplayer
operator|.
name|p_shield
operator|=
name|Oldplayer
operator|.
name|o_shield
expr_stmt|;
name|Newplayer
operator|.
name|p_quickness
operator|=
operator|(
name|double
operator|)
name|Oldplayer
operator|.
name|o_quickness
expr_stmt|;
name|Newplayer
operator|.
name|p_quksilver
operator|=
operator|(
name|double
operator|)
name|Oldplayer
operator|.
name|o_quksilver
expr_stmt|;
name|Newplayer
operator|.
name|p_speed
operator|=
literal|0.0
expr_stmt|;
comment|/* game will calculate */
name|Newplayer
operator|.
name|p_magiclvl
operator|=
name|Oldplayer
operator|.
name|o_magiclvl
expr_stmt|;
name|Newplayer
operator|.
name|p_mana
operator|=
name|Oldplayer
operator|.
name|o_mana
expr_stmt|;
name|Newplayer
operator|.
name|p_brains
operator|=
name|Oldplayer
operator|.
name|o_brains
expr_stmt|;
name|Newplayer
operator|.
name|p_poison
operator|=
name|Oldplayer
operator|.
name|o_poison
expr_stmt|;
name|Newplayer
operator|.
name|p_gold
operator|=
name|Oldplayer
operator|.
name|o_gold
expr_stmt|;
name|Newplayer
operator|.
name|p_gems
operator|=
name|Oldplayer
operator|.
name|o_gems
expr_stmt|;
name|Newplayer
operator|.
name|p_sin
operator|=
name|Oldplayer
operator|.
name|o_sin
expr_stmt|;
name|Newplayer
operator|.
name|p_x
operator|=
name|Oldplayer
operator|.
name|o_x
expr_stmt|;
name|Newplayer
operator|.
name|p_y
operator|=
name|Oldplayer
operator|.
name|o_y
expr_stmt|;
name|Newplayer
operator|.
name|p_1scratch
operator|=
name|Oldplayer
operator|.
name|o_1scratch
expr_stmt|;
name|Newplayer
operator|.
name|p_2scratch
operator|=
name|Oldplayer
operator|.
name|o_2scratch
expr_stmt|;
name|Newplayer
operator|.
name|p_ring
operator|.
name|ring_type
operator|=
name|Oldplayer
operator|.
name|o_ring
operator|.
name|ring_type
expr_stmt|;
name|Newplayer
operator|.
name|p_ring
operator|.
name|ring_duration
operator|=
name|Oldplayer
operator|.
name|o_ring
operator|.
name|ring_duration
expr_stmt|;
name|Newplayer
operator|.
name|p_ring
operator|.
name|ring_inuse
operator|=
name|FALSE
expr_stmt|;
name|Newplayer
operator|.
name|p_age
operator|=
operator|(
name|long
operator|)
name|Oldplayer
operator|.
name|o_degenerated
operator|*
name|N_AGE
expr_stmt|;
name|Newplayer
operator|.
name|p_degenerated
operator|=
name|Oldplayer
operator|.
name|o_degenerated
operator|+
literal|1
expr_stmt|;
comment|/* convert character type into character type and special type */
if|if
condition|(
name|Oldplayer
operator|.
name|o_type
operator|<
literal|0
condition|)
comment|/* player with crown */
name|Oldplayer
operator|.
name|o_type
operator|=
operator|-
name|Oldplayer
operator|.
name|o_type
expr_stmt|;
if|if
condition|(
name|Oldplayer
operator|.
name|o_type
operator|==
literal|99
condition|)
comment|/* valar */
block|{
name|Newplayer
operator|.
name|p_specialtype
operator|=
name|SC_VALAR
expr_stmt|;
name|Newplayer
operator|.
name|p_type
operator|=
operator|(
name|short
operator|)
name|ROLL
argument_list|(
name|C_MAGIC
argument_list|,
name|C_EXPER
operator|-
name|C_MAGIC
operator|+
literal|1
argument_list|)
expr_stmt|;
name|Newplayer
operator|.
name|p_lives
operator|=
name|Oldplayer
operator|.
name|o_ring
operator|.
name|ring_duration
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Oldplayer
operator|.
name|o_type
operator|==
literal|90
condition|)
comment|/* ex-valar */
block|{
name|Newplayer
operator|.
name|p_specialtype
operator|=
name|SC_EXVALAR
expr_stmt|;
name|Newplayer
operator|.
name|p_type
operator|=
operator|(
name|short
operator|)
name|ROLL
argument_list|(
name|C_MAGIC
argument_list|,
name|C_EXPER
operator|-
name|C_MAGIC
operator|+
literal|1
argument_list|)
expr_stmt|;
name|Newplayer
operator|.
name|p_lives
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Oldplayer
operator|.
name|o_type
operator|>
literal|20
condition|)
comment|/* council of wise */
block|{
name|Newplayer
operator|.
name|p_specialtype
operator|=
name|SC_COUNCIL
expr_stmt|;
name|Newplayer
operator|.
name|p_type
operator|=
name|Oldplayer
operator|.
name|o_type
operator|-
literal|20
expr_stmt|;
name|Newplayer
operator|.
name|p_lives
operator|=
name|Oldplayer
operator|.
name|o_ring
operator|.
name|ring_duration
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Oldplayer
operator|.
name|o_type
operator|>
literal|10
condition|)
comment|/* king */
block|{
name|Newplayer
operator|.
name|p_specialtype
operator|=
name|SC_KING
expr_stmt|;
name|Newplayer
operator|.
name|p_type
operator|=
name|Oldplayer
operator|.
name|o_type
operator|-
literal|10
expr_stmt|;
name|Newplayer
operator|.
name|p_lives
operator|=
literal|0
expr_stmt|;
block|}
else|else
comment|/* normal player */
block|{
name|Newplayer
operator|.
name|p_specialtype
operator|=
name|SC_NONE
expr_stmt|;
name|Newplayer
operator|.
name|p_type
operator|=
name|Oldplayer
operator|.
name|o_type
expr_stmt|;
name|Newplayer
operator|.
name|p_lives
operator|=
literal|0
expr_stmt|;
block|}
name|Newplayer
operator|.
name|p_lives
operator|=
literal|0
expr_stmt|;
name|Newplayer
operator|.
name|p_crowns
operator|=
name|Oldplayer
operator|.
name|o_crowns
expr_stmt|;
name|Newplayer
operator|.
name|p_charms
operator|=
name|Oldplayer
operator|.
name|o_charms
expr_stmt|;
name|Newplayer
operator|.
name|p_amulets
operator|=
name|Oldplayer
operator|.
name|o_amulets
expr_stmt|;
name|Newplayer
operator|.
name|p_holywater
operator|=
name|Oldplayer
operator|.
name|o_holywater
expr_stmt|;
name|Newplayer
operator|.
name|p_lastused
operator|=
name|Oldplayer
operator|.
name|o_lastused
expr_stmt|;
comment|/* convert status and name into status */
name|Newplayer
operator|.
name|p_status
operator|=
name|Oldplayer
operator|.
name|o_status
operator|+
name|S_OFF
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|Oldplayer
operator|.
name|m_name
argument_list|,
literal|"<null>"
argument_list|)
operator|==
literal|0
condition|)
comment|/* unused recored */
name|Newplayer
operator|.
name|p_status
operator|=
name|S_NOTUSED
expr_stmt|;
if|if
condition|(
name|Oldplayer
operator|.
name|o_quickness
operator|<
literal|0
condition|)
comment|/* hung up player */
block|{
name|Newplayer
operator|.
name|p_quickness
operator|=
operator|(
name|double
operator|)
name|Oldplayer
operator|.
name|o_tampered
expr_stmt|;
name|Oldplayer
operator|.
name|o_tampered
operator|=
name|T_OFF
expr_stmt|;
name|Newplayer
operator|.
name|p_status
operator|=
name|S_HUNGUP
expr_stmt|;
block|}
name|Newplayer
operator|.
name|p_tampered
operator|=
name|Oldplayer
operator|.
name|o_tampered
operator|+
name|T_OFF
expr_stmt|;
name|Newplayer
operator|.
name|p_istat
operator|=
name|I_OFF
expr_stmt|;
name|Newplayer
operator|.
name|p_palantir
operator|=
name|Oldplayer
operator|.
name|o_palantir
expr_stmt|;
name|Newplayer
operator|.
name|p_blessing
operator|=
name|Oldplayer
operator|.
name|o_blessing
expr_stmt|;
name|Newplayer
operator|.
name|p_virgin
operator|=
name|Oldplayer
operator|.
name|o_virgin
expr_stmt|;
name|Newplayer
operator|.
name|p_blindness
operator|=
name|Oldplayer
operator|.
name|o_blindness
expr_stmt|;
name|strcpy
argument_list|(
name|Newplayer
operator|.
name|p_name
argument_list|,
name|Oldplayer
operator|.
name|o_name
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|Newplayer
operator|.
name|p_password
argument_list|,
name|Oldplayer
operator|.
name|o_password
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|Newplayer
operator|.
name|p_login
argument_list|,
name|Oldplayer
operator|.
name|o_login
argument_list|)
expr_stmt|;
comment|/* write new structure */
name|fwrite
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Newplayer
argument_list|,
sizeof|sizeof
argument_list|(
name|Newplayer
argument_list|)
argument_list|,
literal|1
argument_list|,
name|newcharac
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|oldcharac
argument_list|)
expr_stmt|;
comment|/* close files */
name|fclose
argument_list|(
name|newcharac
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: drandom() / / FUNCTION: return a random number between 0.0< 1.0 / / AUTHOR: E. A. Estes, 2/7/86 / / ARGUMENTS: none / / RETURN VALUE: random number / / MODULES CALLED: random() / / GLOBAL INPUTS: none / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Return a random number. / /************************************************************************/
end_comment

begin_function
name|double
name|drandom
parameter_list|()
block|{
if|if
condition|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|!=
literal|2
condition|)
return|return
operator|(
call|(
name|double
call|)
argument_list|(
name|random
argument_list|()
operator|&
literal|0x7fff
argument_list|)
operator|/
literal|32768.0
operator|)
return|;
else|else
return|return
operator|(
operator|(
name|double
operator|)
name|random
argument_list|()
operator|/
literal|32768.0
operator|)
return|;
block|}
end_function

end_unit


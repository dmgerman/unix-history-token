begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * fight.c   Phantasia monster fighting routines  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"include.h"
end_include

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: encounter() / / FUNCTION: monster battle routine / / AUTHOR: E. A. Estes, 2/20/86 / / ARGUMENTS: /	int particular - particular monster to fight if>= 0 / / RETURN VALUE: none / / MODULES CALLED: monsthits(), playerhits(), readmessage(), callmonster(), /	writerecord(), pickmonster(), displaystats(), pow(), cancelmonster(), /	awardtreasure(), more(), death(), wmove(), setjmp(), drandom(), printw(), /	longjmp(), wrefresh(), mvprintw(), wclrtobot() / / GLOBAL INPUTS: Curmonster, Whichmonster, LINES, Lines, Circle, Shield, /	Player, *stdscr, Fileloc, Fightenv[], *Enemyname / / GLOBAL OUTPUTS: Curmonster, Whichmonster, Lines, Shield, Player, Luckout / / DESCRIPTION: /	Choose a monster and check against some special types. /	Arbitrate between monster and player.  Watch for either /	dying. / *************************************************************************/
end_comment

begin_macro
name|encounter
argument_list|(
argument|particular
argument_list|)
end_macro

begin_decl_stmt
name|int
name|particular
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|bool
name|firsthit
init|=
name|Player
operator|.
name|p_blessing
decl_stmt|;
comment|/* set if player gets the first hit */
name|int
name|flockcnt
init|=
literal|1
decl_stmt|;
comment|/* how many time flocked */
comment|/* let others know what we are doing */
name|Player
operator|.
name|p_status
operator|=
name|S_MONSTER
expr_stmt|;
name|writerecord
argument_list|(
operator|&
name|Player
argument_list|,
name|Fileloc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SYS5
name|flushinp
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|Shield
operator|=
literal|0.0
expr_stmt|;
comment|/* no shield up yet */
if|if
condition|(
name|particular
operator|>=
literal|0
condition|)
comment|/* monster is specified */
name|Whichmonster
operator|=
name|particular
expr_stmt|;
else|else
comment|/* pick random monster */
name|Whichmonster
operator|=
name|pickmonster
argument_list|()
expr_stmt|;
name|setjmp
argument_list|(
name|Fightenv
argument_list|)
expr_stmt|;
comment|/* this is to enable changing fight state */
name|move
argument_list|(
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
comment|/* clear bottom area of screen */
name|Lines
operator|=
literal|9
expr_stmt|;
name|callmonster
argument_list|(
name|Whichmonster
argument_list|)
expr_stmt|;
comment|/* set up monster to fight */
name|Luckout
operator|=
name|FALSE
expr_stmt|;
comment|/* haven't tried to luckout yet */
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_MORGOTH
condition|)
name|mvprintw
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"You've encountered %s, Bane of the Council and Valar.\n"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_UNICORN
condition|)
block|{
if|if
condition|(
name|Player
operator|.
name|p_virgin
condition|)
block|{
name|printw
argument_list|(
literal|"You just subdued %s, thanks to the virgin.\n"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_virgin
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
name|printw
argument_list|(
literal|"You just saw %s running away!\n"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Curmonster
operator|.
name|m_experience
operator|=
literal|0.0
expr_stmt|;
name|Curmonster
operator|.
name|m_treasuretype
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
comment|/* not a special monster */
for|for
control|(
init|;
condition|;
control|)
comment|/* print header, and arbitrate between player and monster */
block|{
name|mvprintw
argument_list|(
literal|6
argument_list|,
literal|0
argument_list|,
literal|"You are being attacked by %s,   EXP: %.0f   (Size: %.0f)\n"
argument_list|,
name|Enemyname
argument_list|,
name|Curmonster
operator|.
name|m_experience
argument_list|,
name|Circle
argument_list|)
expr_stmt|;
name|displaystats
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
literal|1
argument_list|,
literal|26
argument_list|,
literal|"%20.0f"
argument_list|,
name|Player
operator|.
name|p_energy
operator|+
name|Shield
argument_list|)
expr_stmt|;
comment|/* overprint energy */
name|readmessage
argument_list|()
expr_stmt|;
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_DARKLORD
operator|&&
name|Player
operator|.
name|p_blessing
operator|&&
name|Player
operator|.
name|p_charms
operator|>
literal|0
condition|)
comment|/* overpower Dark Lord with blessing and charm */
block|{
name|mvprintw
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|,
literal|"You just overpowered %s!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Lines
operator|=
literal|8
expr_stmt|;
name|Player
operator|.
name|p_blessing
operator|=
name|FALSE
expr_stmt|;
operator|--
name|Player
operator|.
name|p_charms
expr_stmt|;
break|break;
block|}
comment|/* allow paralyzed monster to wake up */
name|Curmonster
operator|.
name|m_speed
operator|=
name|MIN
argument_list|(
name|Curmonster
operator|.
name|m_speed
operator|+
literal|1.0
argument_list|,
name|Curmonster
operator|.
name|m_maxspeed
argument_list|)
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|*
name|Curmonster
operator|.
name|m_speed
operator|>
name|drandom
argument_list|()
operator|*
name|Player
operator|.
name|p_speed
comment|/* monster is faster */
operator|&&
name|Curmonster
operator|.
name|m_type
operator|!=
name|SM_DARKLORD
comment|/* not D. L. */
operator|&&
name|Curmonster
operator|.
name|m_type
operator|!=
name|SM_SHRIEKER
comment|/* not mimic */
operator|&&
operator|!
name|firsthit
condition|)
comment|/* monster gets a hit */
name|monsthits
argument_list|()
expr_stmt|;
else|else
comment|/* player gets a hit */
block|{
name|firsthit
operator|=
name|FALSE
expr_stmt|;
name|playerhits
argument_list|()
expr_stmt|;
block|}
name|refresh
argument_list|()
expr_stmt|;
if|if
condition|(
name|Lines
operator|>
name|LINES
operator|-
literal|2
condition|)
comment|/* near bottom of screen - pause */
block|{
name|more
argument_list|(
name|Lines
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|Lines
operator|=
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|Player
operator|.
name|p_energy
operator|<=
literal|0.0
condition|)
comment|/* player died */
block|{
name|more
argument_list|(
name|Lines
argument_list|)
expr_stmt|;
name|death
argument_list|(
name|Enemyname
argument_list|)
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
break|break;
comment|/* fight ends if the player is saved from death */
block|}
if|if
condition|(
name|Curmonster
operator|.
name|m_energy
operator|<=
literal|0.0
condition|)
comment|/* monster died */
break|break;
block|}
comment|/* give player credit for killing monster */
name|Player
operator|.
name|p_experience
operator|+=
name|Curmonster
operator|.
name|m_experience
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|<
name|Curmonster
operator|.
name|m_flock
operator|/
literal|100.0
condition|)
comment|/* monster flocks */
block|{
name|more
argument_list|(
name|Lines
argument_list|)
expr_stmt|;
operator|++
name|flockcnt
expr_stmt|;
name|longjmp
argument_list|(
name|Fightenv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
elseif|else
if|if
condition|(
name|Circle
operator|>
literal|1.0
operator|&&
name|Curmonster
operator|.
name|m_treasuretype
operator|>
literal|0
operator|&&
name|drandom
argument_list|()
operator|>
literal|0.2
operator|+
name|pow
argument_list|(
literal|0.4
argument_list|,
call|(
name|double
call|)
argument_list|(
name|flockcnt
operator|/
literal|3
operator|+
name|Circle
operator|/
literal|3.0
argument_list|)
argument_list|)
condition|)
comment|/* monster has treasure; this takes # of flocks and size into account */
block|{
name|more
argument_list|(
name|Lines
argument_list|)
expr_stmt|;
name|awardtreasure
argument_list|()
expr_stmt|;
block|}
comment|/* pause before returning */
name|getyx
argument_list|(
name|stdscr
argument_list|,
name|Lines
argument_list|,
name|flockcnt
argument_list|)
expr_stmt|;
name|more
argument_list|(
name|Lines
operator|+
literal|1
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_ring
operator|.
name|ring_inuse
operator|=
name|FALSE
expr_stmt|;
comment|/* not using ring */
comment|/* clean up the screen */
name|move
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: pickmonster() / / FUNCTION: choose a monster based upon where we are / / AUTHOR: E. A. Estes, 2/20/86 / / ARGUMENTS: none / / RETURN VALUE: monster number to call / / MODULES CALLED: floor(), drandom() / / GLOBAL INPUTS: Marsh, Circle, Player / / GLOBAL OUTPUTS: none / / DESCRIPTION: /	Certain monsters can be found in certain areas of the grid. /	We take care of rolling them here. /	Unfortunately, this routine assumes that the monster data /	base is arranged in a particular order.  If the data base /	is altered (to add monsters, or make them tougher), this /	routine may also need to be changed. / *************************************************************************/
end_comment

begin_macro
name|pickmonster
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|==
name|SC_VALAR
condition|)
comment|/* even chance of any monster */
return|return
operator|(
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|0.0
argument_list|,
literal|100.0
argument_list|)
operator|)
return|;
if|if
condition|(
name|Marsh
condition|)
comment|/* water monsters */
return|return
operator|(
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|0.0
argument_list|,
literal|15.0
argument_list|)
operator|)
return|;
elseif|else
if|if
condition|(
name|Circle
operator|>
literal|24
condition|)
comment|/* even chance of all non-water monsters */
return|return
operator|(
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|14.0
argument_list|,
literal|86.0
argument_list|)
operator|)
return|;
elseif|else
if|if
condition|(
name|Circle
operator|>
literal|15
condition|)
comment|/* chance of all non-water monsters, weighted toward middle */
return|return
operator|(
call|(
name|int
call|)
argument_list|(
name|ROLL
argument_list|(
literal|0.0
argument_list|,
literal|50.0
argument_list|)
operator|+
name|ROLL
argument_list|(
literal|14.0
argument_list|,
literal|37.0
argument_list|)
argument_list|)
operator|)
return|;
elseif|else
if|if
condition|(
name|Circle
operator|>
literal|8
condition|)
comment|/* not all non-water monsters, weighted toward middle */
return|return
operator|(
call|(
name|int
call|)
argument_list|(
name|ROLL
argument_list|(
literal|0.0
argument_list|,
literal|50.0
argument_list|)
operator|+
name|ROLL
argument_list|(
literal|14.0
argument_list|,
literal|26.0
argument_list|)
argument_list|)
operator|)
return|;
elseif|else
if|if
condition|(
name|Circle
operator|>
literal|3
condition|)
comment|/* even chance of some tamer non-water monsters */
return|return
operator|(
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|14.0
argument_list|,
literal|50.0
argument_list|)
operator|)
return|;
else|else
comment|/* even chance of some of the tamest non-water monsters */
return|return
operator|(
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|14.0
argument_list|,
literal|25.0
argument_list|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: playerhits() / / FUNCTION: prompt player for action in monster battle, and process / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: hitmonster(), throwspell(), inputoption(), cancelmonster(), /	floor(), wmove(), drandom(), altercoordinates(), waddstr(), mvprintw(), /	wclrtoeol(), wclrtobot() / / GLOBAL INPUTS: Curmonster, Lines, Player, *stdscr, Luckout, *Enemyname / / GLOBAL OUTPUTS: Curmonster, Lines, Player, Luckout / / DESCRIPTION: /	Process all monster battle options. / *************************************************************************/
end_comment

begin_macro
name|playerhits
argument_list|()
end_macro

begin_block
block|{
name|double
name|inflict
decl_stmt|;
comment|/* damage inflicted */
name|int
name|ch
decl_stmt|;
comment|/* input */
name|mvaddstr
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|,
literal|"1:Melee  2:Skirmish  3:Evade  4:Spell  5:Nick  "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Luckout
condition|)
block|{
comment|/* haven't tried to luckout yet */
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_MORGOTH
condition|)
comment|/* cannot luckout against Morgoth */
name|addstr
argument_list|(
literal|"6:Ally  "
argument_list|)
expr_stmt|;
else|else
name|addstr
argument_list|(
literal|"6:Luckout  "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|!=
name|R_NONE
condition|)
comment|/* player has a ring */
name|addstr
argument_list|(
literal|"7:Use Ring  "
argument_list|)
expr_stmt|;
else|else
name|clrtoeol
argument_list|()
expr_stmt|;
name|ch
operator|=
name|inputoption
argument_list|()
expr_stmt|;
name|move
argument_list|(
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
comment|/* clear any messages from before */
name|Lines
operator|=
literal|9
expr_stmt|;
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
comment|/* clear status area */
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'T'
case|:
comment|/* timeout; lose turn */
break|break;
case|case
literal|' '
case|:
case|case
literal|'1'
case|:
comment|/* melee */
comment|/* melee affects monster's energy and strength */
name|inflict
operator|=
name|ROLL
argument_list|(
name|Player
operator|.
name|p_might
operator|/
literal|2.0
operator|+
literal|5.0
argument_list|,
literal|1.3
operator|*
name|Player
operator|.
name|p_might
argument_list|)
operator|+
operator|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_inuse
condition|?
name|Player
operator|.
name|p_might
else|:
literal|0.0
operator|)
expr_stmt|;
name|Curmonster
operator|.
name|m_melee
operator|+=
name|inflict
expr_stmt|;
name|Curmonster
operator|.
name|m_strength
operator|=
name|Curmonster
operator|.
name|m_o_strength
operator|-
name|Curmonster
operator|.
name|m_melee
operator|/
name|Curmonster
operator|.
name|m_o_energy
operator|*
name|Curmonster
operator|.
name|m_o_strength
operator|/
literal|4.0
expr_stmt|;
name|hitmonster
argument_list|(
name|inflict
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'2'
case|:
comment|/* skirmish */
comment|/* skirmish affects monter's energy and speed */
name|inflict
operator|=
name|ROLL
argument_list|(
name|Player
operator|.
name|p_might
operator|/
literal|3.0
operator|+
literal|3.0
argument_list|,
literal|1.1
operator|*
name|Player
operator|.
name|p_might
argument_list|)
operator|+
operator|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_inuse
condition|?
name|Player
operator|.
name|p_might
else|:
literal|0.0
operator|)
expr_stmt|;
name|Curmonster
operator|.
name|m_skirmish
operator|+=
name|inflict
expr_stmt|;
name|Curmonster
operator|.
name|m_maxspeed
operator|=
name|Curmonster
operator|.
name|m_o_speed
operator|-
name|Curmonster
operator|.
name|m_skirmish
operator|/
name|Curmonster
operator|.
name|m_o_energy
operator|*
name|Curmonster
operator|.
name|m_o_speed
operator|/
literal|4.0
expr_stmt|;
name|hitmonster
argument_list|(
name|inflict
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'3'
case|:
comment|/* evade */
comment|/* use brains and speed to try to evade */
if|if
condition|(
operator|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_DARKLORD
operator|||
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_SHRIEKER
comment|/* can always run from D. L. and shrieker */
operator|||
name|drandom
argument_list|()
operator|*
name|Player
operator|.
name|p_speed
operator|*
name|Player
operator|.
name|p_brains
operator|>
name|drandom
argument_list|()
operator|*
name|Curmonster
operator|.
name|m_speed
operator|*
name|Curmonster
operator|.
name|m_brains
operator|)
operator|&&
operator|(
name|Curmonster
operator|.
name|m_type
operator|!=
name|SM_MIMIC
operator|)
condition|)
comment|/* cannot run from mimic */
block|{
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You got away!"
argument_list|)
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
name|altercoordinates
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|A_NEAR
argument_list|)
expr_stmt|;
block|}
else|else
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s is still after you!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
case|case
literal|'4'
case|:
comment|/* magic spell */
name|throwspell
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'5'
case|:
comment|/* nick */
comment|/* hit 1 plus sword; give some experience */
name|inflict
operator|=
literal|1.0
operator|+
name|Player
operator|.
name|p_sword
expr_stmt|;
name|Player
operator|.
name|p_experience
operator|+=
name|floor
argument_list|(
name|Curmonster
operator|.
name|m_experience
operator|/
literal|10.0
argument_list|)
expr_stmt|;
name|Curmonster
operator|.
name|m_experience
operator|*=
literal|0.92
expr_stmt|;
comment|/* monster gets meaner */
name|Curmonster
operator|.
name|m_maxspeed
operator|+=
literal|2.0
expr_stmt|;
name|Curmonster
operator|.
name|m_speed
operator|=
operator|(
name|Curmonster
operator|.
name|m_speed
operator|<
literal|0.0
operator|)
condition|?
literal|0.0
else|:
name|Curmonster
operator|.
name|m_speed
operator|+
literal|2.0
expr_stmt|;
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_DARKLORD
condition|)
comment|/* Dark Lord; doesn't like to be nicked */
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You hit %s %.0f times, and made him mad!"
argument_list|,
name|Enemyname
argument_list|,
name|inflict
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_quickness
operator|/=
literal|2.0
expr_stmt|;
name|altercoordinates
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|A_FAR
argument_list|)
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
block|}
else|else
name|hitmonster
argument_list|(
name|inflict
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
case|case
literal|'6'
case|:
comment|/* luckout */
if|if
condition|(
name|Luckout
condition|)
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You already tried that."
argument_list|)
expr_stmt|;
else|else
block|{
name|Luckout
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_MORGOTH
condition|)
comment|/* Morgoth; ally */
block|{
if|if
condition|(
name|drandom
argument_list|()
operator|<
name|Player
operator|.
name|p_sin
operator|/
literal|100.0
condition|)
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s accepted!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
block|}
else|else
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"Nope, he's not interested."
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* normal monster; use brains for success */
block|{
if|if
condition|(
operator|(
name|drandom
argument_list|()
operator|+
literal|0.333
operator|)
operator|*
name|Player
operator|.
name|p_brains
operator|<
operator|(
name|drandom
argument_list|()
operator|+
literal|0.333
operator|)
operator|*
name|Curmonster
operator|.
name|m_brains
condition|)
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You blew it, %s."
argument_list|,
name|Player
operator|.
name|p_name
argument_list|)
expr_stmt|;
else|else
block|{
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You made it!"
argument_list|)
expr_stmt|;
name|Curmonster
operator|.
name|m_energy
operator|=
literal|0.0
expr_stmt|;
block|}
block|}
block|}
break|break;
case|case
literal|'7'
case|:
comment|/* use ring */
if|if
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|!=
name|R_NONE
condition|)
block|{
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"Now using ring."
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_ring
operator|.
name|ring_inuse
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|!=
name|R_DLREG
condition|)
comment|/* age ring */
operator|--
name|Player
operator|.
name|p_ring
operator|.
name|ring_duration
expr_stmt|;
block|}
break|break;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: monsthits() / / FUNCTION: process a monster hitting the player / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: cancelmonster(), scramblestats(), more(), floor(), wmove(), /	drandom(), altercoordinates(), longjmp(), waddstr(), mvprintw(), /	getanswer() / / GLOBAL INPUTS: Curmonster, Lines, Circle, Shield, Player, *stdscr, /	Fightenv[], *Enemyname / / GLOBAL OUTPUTS: Curmonster, Whichmonster, Lines, Shield, Player, /	*Enemyname / / DESCRIPTION: /	Handle all special monsters here.  If the monster is not a special /	one, simply roll a hit against the player. / *************************************************************************/
end_comment

begin_macro
name|monsthits
argument_list|()
end_macro

begin_block
block|{
name|double
name|inflict
decl_stmt|;
comment|/* damage inflicted */
name|int
name|ch
decl_stmt|;
comment|/* input */
switch|switch
condition|(
name|Curmonster
operator|.
name|m_type
condition|)
comment|/* may be a special monster */
block|{
case|case
name|SM_DARKLORD
case|:
comment|/* hits just enough to kill player */
name|inflict
operator|=
operator|(
name|Player
operator|.
name|p_energy
operator|+
name|Shield
operator|)
operator|*
literal|1.02
expr_stmt|;
goto|goto
name|SPECIALHIT
goto|;
case|case
name|SM_SHRIEKER
case|:
comment|/* call a big monster */
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"Shrieeeek!!  You scared it, and it called one of its friends."
argument_list|)
expr_stmt|;
name|more
argument_list|(
name|Lines
argument_list|)
expr_stmt|;
name|Whichmonster
operator|=
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|70.0
argument_list|,
literal|30.0
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|Fightenv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
name|SM_BALROG
case|:
comment|/* take experience away */
name|inflict
operator|=
name|ROLL
argument_list|(
literal|10.0
argument_list|,
name|Curmonster
operator|.
name|m_strength
argument_list|)
expr_stmt|;
name|inflict
operator|=
name|MIN
argument_list|(
name|Player
operator|.
name|p_experience
argument_list|,
name|inflict
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s took away %.0f experience points."
argument_list|,
name|Enemyname
argument_list|,
name|inflict
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_experience
operator|-=
name|inflict
expr_stmt|;
return|return;
case|case
name|SM_FAERIES
case|:
if|if
condition|(
name|Player
operator|.
name|p_holywater
operator|>
literal|0
condition|)
comment|/* holy water kills when monster tries to hit */
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"Your holy water killed it!"
argument_list|)
expr_stmt|;
operator|--
name|Player
operator|.
name|p_holywater
expr_stmt|;
name|Curmonster
operator|.
name|m_energy
operator|=
literal|0.0
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SM_NONE
case|:
comment|/* normal hit */
break|break;
default|default:
if|if
condition|(
name|drandom
argument_list|()
operator|>
literal|0.2
condition|)
comment|/* normal hit */
break|break;
comment|/* else special things */
switch|switch
condition|(
name|Curmonster
operator|.
name|m_type
condition|)
block|{
case|case
name|SM_LEANAN
case|:
comment|/* takes some of the player's strength */
name|inflict
operator|=
name|ROLL
argument_list|(
literal|1.0
argument_list|,
operator|(
name|Circle
operator|-
literal|1.0
operator|)
operator|/
literal|2.0
argument_list|)
expr_stmt|;
name|inflict
operator|=
name|MIN
argument_list|(
name|Player
operator|.
name|p_strength
argument_list|,
name|inflict
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s sapped %0.f of your strength!"
argument_list|,
name|Enemyname
argument_list|,
name|inflict
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_strength
operator|-=
name|inflict
expr_stmt|;
name|Player
operator|.
name|p_might
operator|-=
name|inflict
expr_stmt|;
break|break;
case|case
name|SM_SARUMAN
case|:
if|if
condition|(
name|Player
operator|.
name|p_palantir
condition|)
comment|/* take away palantir */
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"Wormtongue stole your palantir!"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_palantir
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|drandom
argument_list|()
operator|>
literal|0.5
condition|)
comment|/* gems turn to gold */
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s transformed your gems into gold!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|+=
name|Player
operator|.
name|p_gems
expr_stmt|;
name|Player
operator|.
name|p_gems
operator|=
literal|0.0
expr_stmt|;
block|}
else|else
comment|/* scramble some stats */
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s scrambled your stats!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|scramblestats
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|SM_THAUMATURG
case|:
comment|/* transport player */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s transported you!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|altercoordinates
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|A_FAR
argument_list|)
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
break|break;
case|case
name|SM_VORTEX
case|:
comment|/* suck up some mana */
name|inflict
operator|=
name|ROLL
argument_list|(
literal|0
argument_list|,
literal|7.5
operator|*
name|Circle
argument_list|)
expr_stmt|;
name|inflict
operator|=
name|MIN
argument_list|(
name|Player
operator|.
name|p_mana
argument_list|,
name|floor
argument_list|(
name|inflict
argument_list|)
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s sucked up %.0f of your mana!"
argument_list|,
name|Enemyname
argument_list|,
name|inflict
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|-=
name|inflict
expr_stmt|;
break|break;
case|case
name|SM_NAZGUL
case|:
comment|/* try to take ring if player has one */
if|if
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|!=
name|R_NONE
condition|)
comment|/* player has a ring */
block|{
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"Will you relinguish your ring ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"YN"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'Y'
condition|)
comment|/* take ring away */
block|{
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|=
name|R_NONE
expr_stmt|;
name|Player
operator|.
name|p_ring
operator|.
name|ring_inuse
operator|=
name|FALSE
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
comment|/* otherwise, take some brains */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s neutralized 1/5 of your brain!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|*=
literal|0.8
expr_stmt|;
break|break;
case|case
name|SM_TIAMAT
case|:
comment|/* take some gold and gems */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s took half your gold and gems and flew off."
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|/=
literal|2.0
expr_stmt|;
name|Player
operator|.
name|p_gems
operator|/=
literal|2.0
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
break|break;
case|case
name|SM_KOBOLD
case|:
comment|/* steal a gold piece and run */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s stole one gold piece and ran away."
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_gold
operator|=
name|MAX
argument_list|(
literal|0.0
argument_list|,
name|Player
operator|.
name|p_gold
operator|-
literal|1.0
argument_list|)
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
break|break;
case|case
name|SM_SHELOB
case|:
comment|/* bite and (medium) poison */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s has bitten and poisoned you!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_poison
operator|-=
literal|1.0
expr_stmt|;
break|break;
case|case
name|SM_LAMPREY
case|:
comment|/*  bite and (small) poison */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s bit and poisoned you!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_poison
operator|+=
literal|0.25
expr_stmt|;
break|break;
case|case
name|SM_BONNACON
case|:
comment|/* fart and run */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s farted and scampered off."
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|/=
literal|2.0
expr_stmt|;
comment|/* damage from fumes */
name|cancelmonster
argument_list|()
expr_stmt|;
break|break;
case|case
name|SM_SMEAGOL
case|:
if|if
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|!=
name|R_NONE
condition|)
comment|/* try to steal ring */
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s tried to steal your ring, "
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|>
literal|0.1
condition|)
name|addstr
argument_list|(
literal|"but was unsuccessful."
argument_list|)
expr_stmt|;
else|else
block|{
name|addstr
argument_list|(
literal|"and ran away with it!"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|=
name|R_NONE
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
block|}
block|}
break|break;
case|case
name|SM_SUCCUBUS
case|:
comment|/* inflict damage through shield */
name|inflict
operator|=
name|ROLL
argument_list|(
literal|15.0
argument_list|,
name|Circle
operator|*
literal|10.0
argument_list|)
expr_stmt|;
name|inflict
operator|=
name|MIN
argument_list|(
name|inflict
argument_list|,
name|Player
operator|.
name|p_energy
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s sapped %.0f of your energy."
argument_list|,
name|Enemyname
argument_list|,
name|inflict
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|-=
name|inflict
expr_stmt|;
break|break;
case|case
name|SM_CERBERUS
case|:
comment|/* take all metal treasures */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s took all your metal treasures!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_crowns
operator|=
literal|0
expr_stmt|;
name|Player
operator|.
name|p_sword
operator|=
name|Player
operator|.
name|p_shield
operator|=
name|Player
operator|.
name|p_gold
operator|=
literal|0.0
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
break|break;
case|case
name|SM_UNGOLIANT
case|:
comment|/* (large) poison and take a quickness */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s poisoned you, and took one quik."
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_poison
operator|+=
literal|5.0
expr_stmt|;
name|Player
operator|.
name|p_quickness
operator|-=
literal|1.0
expr_stmt|;
break|break;
case|case
name|SM_JABBERWOCK
case|:
comment|/* fly away, and leave either a Jubjub bird or Bonnacon */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s flew away, and left you to contend with one of its friends."
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Whichmonster
operator|=
literal|55
operator|+
operator|(
name|drandom
argument_list|()
operator|>
literal|0.5
operator|)
condition|?
literal|22
else|:
literal|0
expr_stmt|;
name|longjmp
argument_list|(
name|Fightenv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
name|SM_TROLL
case|:
comment|/* partially regenerate monster */
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s partially regenerated his energy.!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Curmonster
operator|.
name|m_energy
operator|+=
name|floor
argument_list|(
operator|(
name|Curmonster
operator|.
name|m_o_energy
operator|-
name|Curmonster
operator|.
name|m_energy
operator|)
operator|/
literal|2.0
argument_list|)
expr_stmt|;
name|Curmonster
operator|.
name|m_strength
operator|=
name|Curmonster
operator|.
name|m_o_strength
expr_stmt|;
name|Curmonster
operator|.
name|m_melee
operator|=
name|Curmonster
operator|.
name|m_skirmish
operator|=
literal|0.0
expr_stmt|;
name|Curmonster
operator|.
name|m_maxspeed
operator|=
name|Curmonster
operator|.
name|m_o_speed
expr_stmt|;
break|break;
case|case
name|SM_WRAITH
case|:
if|if
condition|(
operator|!
name|Player
operator|.
name|p_blindness
condition|)
comment|/* make blind */
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s blinded you!"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_blindness
operator|=
name|TRUE
expr_stmt|;
name|Enemyname
operator|=
literal|"A monster"
expr_stmt|;
block|}
break|break;
block|}
return|return;
block|}
comment|/* fall through to here if monster inflicts a normal hit */
name|inflict
operator|=
name|drandom
argument_list|()
operator|*
name|Curmonster
operator|.
name|m_strength
operator|+
literal|0.5
expr_stmt|;
name|SPECIALHIT
label|:
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s hit you %.0f times!"
argument_list|,
name|Enemyname
argument_list|,
name|inflict
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|Shield
operator|-=
name|inflict
operator|)
operator|<
literal|0
condition|)
block|{
name|Player
operator|.
name|p_energy
operator|+=
name|Shield
expr_stmt|;
name|Shield
operator|=
literal|0.0
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: cancelmonster() / / FUNCTION: mark current monster as no longer active / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: none / / GLOBAL INPUTS: none / / GLOBAL OUTPUTS: Curmonster / / DESCRIPTION: /	Clear current monster's energy, experience, treasure type, and /	flock.  This is the same as having the monster run away. / *************************************************************************/
end_comment

begin_macro
name|cancelmonster
argument_list|()
end_macro

begin_block
block|{
name|Curmonster
operator|.
name|m_energy
operator|=
literal|0.0
expr_stmt|;
name|Curmonster
operator|.
name|m_experience
operator|=
literal|0.0
expr_stmt|;
name|Curmonster
operator|.
name|m_treasuretype
operator|=
literal|0
expr_stmt|;
name|Curmonster
operator|.
name|m_flock
operator|=
literal|0.0
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: hitmonster() / / FUNCTION: inflict damage upon current monster / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: /	double inflict - damage to inflict upon monster / / RETURN VALUE: none / / MODULES CALLED: monsthits(), wmove(), strcmp(), waddstr(), mvprintw() / / GLOBAL INPUTS: Curmonster, Lines, Player, *stdscr, *Enemyname / / GLOBAL OUTPUTS: Curmonster, Lines / / DESCRIPTION: /	Hit monster specified number of times.  Handle when monster dies, /	and a few special monsters. / *************************************************************************/
end_comment

begin_macro
name|hitmonster
argument_list|(
argument|inflict
argument_list|)
end_macro

begin_decl_stmt
name|double
name|inflict
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You hit %s %.0f times!"
argument_list|,
name|Enemyname
argument_list|,
name|inflict
argument_list|)
expr_stmt|;
name|Curmonster
operator|.
name|m_energy
operator|-=
name|inflict
expr_stmt|;
if|if
condition|(
name|Curmonster
operator|.
name|m_energy
operator|>
literal|0.0
condition|)
block|{
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_DARKLORD
operator|||
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_SHRIEKER
condition|)
comment|/* special monster didn't die */
name|monsthits
argument_list|()
expr_stmt|;
block|}
else|else
comment|/* monster died.  print message. */
block|{
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_MORGOTH
condition|)
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You have defeated Morgoth, but he may return. . ."
argument_list|)
expr_stmt|;
else|else
comment|/* all other types of monsters */
block|{
name|mvprintw
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"You killed it.  Good work, %s."
argument_list|,
name|Player
operator|.
name|p_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_MIMIC
operator|&&
name|strcmp
argument_list|(
name|Curmonster
operator|.
name|m_name
argument_list|,
literal|"A Mimic"
argument_list|)
operator|!=
literal|0
operator|&&
operator|!
name|Player
operator|.
name|p_blindness
condition|)
name|mvaddstr
argument_list|(
name|Lines
operator|++
argument_list|,
literal|0
argument_list|,
literal|"The body slowly changes into the form of a mimic."
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: throwspell() / / FUNCTION: throw a magic spell / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: hitmonster(), cancelmonster(), sqrt(), floor(), wmove(), /	drandom(), altercoordinates(), longjmp(), infloat(), waddstr(), mvprintw(), /	getanswer() / / GLOBAL INPUTS: Curmonster, Whichmonster, Nomana[], Player, *stdscr, /	Fightenv[], Illspell[], *Enemyname / / GLOBAL OUTPUTS: Curmonster, Whichmonster, Shield, Player / / DESCRIPTION: /	Prompt player and process magic spells. / *************************************************************************/
end_comment

begin_macro
name|throwspell
argument_list|()
end_macro

begin_block
block|{
name|double
name|inflict
decl_stmt|;
comment|/* damage inflicted */
name|double
name|dtemp
decl_stmt|;
comment|/* for dtemporary calculations */
name|int
name|ch
decl_stmt|;
comment|/* input */
name|mvaddstr
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
comment|/* clear menu area */
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|>=
name|ML_ALLORNOTHING
condition|)
name|mvaddstr
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|,
literal|"1:All or Nothing  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|>=
name|ML_MAGICBOLT
condition|)
name|addstr
argument_list|(
literal|"2:Magic Bolt  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|>=
name|ML_FORCEFIELD
condition|)
name|addstr
argument_list|(
literal|"3:Force Field  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|>=
name|ML_XFORM
condition|)
name|addstr
argument_list|(
literal|"4:Transform  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|>=
name|ML_INCRMIGHT
condition|)
name|addstr
argument_list|(
literal|"5:Increase Might\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|>=
name|ML_INVISIBLE
condition|)
name|mvaddstr
argument_list|(
literal|8
argument_list|,
literal|0
argument_list|,
literal|"6:Invisibility  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|>=
name|ML_XPORT
condition|)
name|addstr
argument_list|(
literal|"7:Transport  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|>=
name|ML_PARALYZE
condition|)
name|addstr
argument_list|(
literal|"8:Paralyze  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|>=
name|SC_COUNCIL
condition|)
name|addstr
argument_list|(
literal|"9:Specify"
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"Spell ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|" "
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
comment|/* clear menu area */
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_MORGOTH
operator|&&
name|ch
operator|!=
literal|'3'
condition|)
comment|/* can only throw force field against Morgoth */
name|ILLSPELL
argument_list|()
expr_stmt|;
else|else
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'1'
case|:
comment|/* all or nothing */
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.25
condition|)
comment|/* success */
block|{
name|inflict
operator|=
name|Curmonster
operator|.
name|m_energy
operator|*
literal|1.01
operator|+
literal|1.0
expr_stmt|;
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_DARKLORD
condition|)
comment|/* all or nothing doesn't quite work against D. L. */
name|inflict
operator|*=
literal|0.9
expr_stmt|;
block|}
else|else
comment|/* failure -- monster gets stronger and quicker */
block|{
name|Curmonster
operator|.
name|m_o_strength
operator|=
name|Curmonster
operator|.
name|m_strength
operator|*=
literal|2.0
expr_stmt|;
name|Curmonster
operator|.
name|m_maxspeed
operator|*=
literal|2.0
expr_stmt|;
name|Curmonster
operator|.
name|m_o_speed
operator|*=
literal|2.0
expr_stmt|;
comment|/* paralyzed monsters wake up a bit */
name|Curmonster
operator|.
name|m_speed
operator|=
name|MAX
argument_list|(
literal|1.0
argument_list|,
name|Curmonster
operator|.
name|m_speed
operator|*
literal|2.0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Player
operator|.
name|p_mana
operator|>=
name|MM_ALLORNOTHING
condition|)
comment|/* take a mana if player has one */
name|Player
operator|.
name|p_mana
operator|-=
name|MM_ALLORNOTHING
expr_stmt|;
name|hitmonster
argument_list|(
name|inflict
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'2'
case|:
comment|/* magic bolt */
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|<
name|ML_MAGICBOLT
condition|)
name|ILLSPELL
argument_list|()
expr_stmt|;
else|else
block|{
do|do
comment|/* prompt for amount to expend */
block|{
name|mvaddstr
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
literal|"How much mana for bolt? "
argument_list|)
expr_stmt|;
name|dtemp
operator|=
name|floor
argument_list|(
name|infloat
argument_list|()
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|dtemp
operator|<
literal|0.0
operator|||
name|dtemp
operator|>
name|Player
operator|.
name|p_mana
condition|)
do|;
name|Player
operator|.
name|p_mana
operator|-=
name|dtemp
expr_stmt|;
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_DARKLORD
condition|)
comment|/* magic bolts don't work against D. L. */
name|inflict
operator|=
literal|0.0
expr_stmt|;
else|else
name|inflict
operator|=
name|dtemp
operator|*
name|ROLL
argument_list|(
literal|15.0
argument_list|,
name|sqrt
argument_list|(
name|Player
operator|.
name|p_magiclvl
operator|/
literal|3.0
operator|+
literal|1.0
argument_list|)
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"Magic Bolt fired!\n"
argument_list|)
expr_stmt|;
name|hitmonster
argument_list|(
name|inflict
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'3'
case|:
comment|/* force field */
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|<
name|ML_FORCEFIELD
condition|)
name|ILLSPELL
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_mana
operator|<
name|MM_FORCEFIELD
condition|)
name|NOMANA
argument_list|()
expr_stmt|;
else|else
block|{
name|Player
operator|.
name|p_mana
operator|-=
name|MM_FORCEFIELD
expr_stmt|;
name|Shield
operator|=
operator|(
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_shield
operator|)
operator|*
literal|4.2
operator|+
literal|45.0
expr_stmt|;
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"Force Field up.\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'4'
case|:
comment|/* transform */
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|<
name|ML_XFORM
condition|)
name|ILLSPELL
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_mana
operator|<
name|MM_XFORM
condition|)
name|NOMANA
argument_list|()
expr_stmt|;
else|else
block|{
name|Player
operator|.
name|p_mana
operator|-=
name|MM_XFORM
expr_stmt|;
name|Whichmonster
operator|=
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|0.0
argument_list|,
literal|100.0
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|Fightenv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
break|break;
case|case
literal|'5'
case|:
comment|/* increase might */
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|<
name|ML_INCRMIGHT
condition|)
name|ILLSPELL
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_mana
operator|<
name|MM_INCRMIGHT
condition|)
name|NOMANA
argument_list|()
expr_stmt|;
else|else
block|{
name|Player
operator|.
name|p_mana
operator|-=
name|MM_INCRMIGHT
expr_stmt|;
name|Player
operator|.
name|p_might
operator|+=
operator|(
literal|1.2
operator|*
operator|(
name|Player
operator|.
name|p_strength
operator|+
name|Player
operator|.
name|p_sword
operator|)
operator|+
literal|5.0
operator|-
name|Player
operator|.
name|p_might
operator|)
operator|/
literal|2.0
expr_stmt|;
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"New strength:  %.0f\n"
argument_list|,
name|Player
operator|.
name|p_might
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'6'
case|:
comment|/* invisible */
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|<
name|ML_INVISIBLE
condition|)
name|ILLSPELL
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_mana
operator|<
name|MM_INVISIBLE
condition|)
name|NOMANA
argument_list|()
expr_stmt|;
else|else
block|{
name|Player
operator|.
name|p_mana
operator|-=
name|MM_INVISIBLE
expr_stmt|;
name|Player
operator|.
name|p_speed
operator|+=
operator|(
literal|1.2
operator|*
operator|(
name|Player
operator|.
name|p_quickness
operator|+
name|Player
operator|.
name|p_quksilver
operator|)
operator|+
literal|5.0
operator|-
name|Player
operator|.
name|p_speed
operator|)
operator|/
literal|2.0
expr_stmt|;
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"New quickness:  %.0f\n"
argument_list|,
name|Player
operator|.
name|p_speed
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'7'
case|:
comment|/* transport */
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|<
name|ML_XPORT
condition|)
name|ILLSPELL
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_mana
operator|<
name|MM_XPORT
condition|)
name|NOMANA
argument_list|()
expr_stmt|;
else|else
block|{
name|Player
operator|.
name|p_mana
operator|-=
name|MM_XPORT
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_brains
operator|+
name|Player
operator|.
name|p_magiclvl
operator|<
name|Curmonster
operator|.
name|m_experience
operator|/
literal|200.0
operator|*
name|drandom
argument_list|()
condition|)
block|{
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"Transport backfired!\n"
argument_list|)
expr_stmt|;
name|altercoordinates
argument_list|(
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|A_FAR
argument_list|)
expr_stmt|;
name|cancelmonster
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"%s is transported.\n"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.3
condition|)
comment|/* monster didn't drop its treasure */
name|Curmonster
operator|.
name|m_treasuretype
operator|=
literal|0
expr_stmt|;
name|Curmonster
operator|.
name|m_energy
operator|=
literal|0.0
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'8'
case|:
comment|/* paralyze */
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|<
name|ML_PARALYZE
condition|)
name|ILLSPELL
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_mana
operator|<
name|MM_PARALYZE
condition|)
name|NOMANA
argument_list|()
expr_stmt|;
else|else
block|{
name|Player
operator|.
name|p_mana
operator|-=
name|MM_PARALYZE
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_magiclvl
operator|>
name|Curmonster
operator|.
name|m_experience
operator|/
literal|1000.0
operator|*
name|drandom
argument_list|()
condition|)
block|{
name|mvprintw
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"%s is held.\n"
argument_list|,
name|Enemyname
argument_list|)
expr_stmt|;
name|Curmonster
operator|.
name|m_speed
operator|=
operator|-
literal|2.0
expr_stmt|;
block|}
else|else
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"Monster unaffected.\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'9'
case|:
comment|/* specify */
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|<
name|SC_COUNCIL
condition|)
name|ILLSPELL
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_mana
operator|<
name|MM_SPECIFY
condition|)
name|NOMANA
argument_list|()
expr_stmt|;
else|else
block|{
name|Player
operator|.
name|p_mana
operator|-=
name|MM_SPECIFY
expr_stmt|;
name|mvaddstr
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|,
literal|"Which monster do you want [0-99] ? "
argument_list|)
expr_stmt|;
name|Whichmonster
operator|=
operator|(
name|int
operator|)
name|infloat
argument_list|()
expr_stmt|;
name|Whichmonster
operator|=
name|MAX
argument_list|(
literal|0
argument_list|,
name|MIN
argument_list|(
literal|99
argument_list|,
name|Whichmonster
argument_list|)
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|Fightenv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
break|break;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: callmonster() / / FUNCTION: read monster from file, and fill structure / / AUTHOR: E. A. Estes, 2/25/86 / / ARGUMENTS: /	int which - which monster to call / / RETURN VALUE: none / / MODULES CALLED: truncstring(), fread(), fseek(), floor(), drandom(), /	strcpy() / / GLOBAL INPUTS: Curmonster, Circle, Player, *Monstfp / / GLOBAL OUTPUTS: Curmonster, Player, *Enemyname / / DESCRIPTION: /	Read specified monster from monster database and fill up /	current monster structure. /	Adjust statistics based upon current size. /	Handle some special monsters. / *************************************************************************/
end_comment

begin_macro
name|callmonster
argument_list|(
argument|which
argument_list|)
end_macro

begin_decl_stmt
name|int
name|which
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|monster
name|Othermonster
decl_stmt|;
comment|/* to find a name for mimics */
name|which
operator|=
name|MIN
argument_list|(
name|which
argument_list|,
literal|99
argument_list|)
expr_stmt|;
comment|/* make sure within range */
comment|/* fill structure */
name|fseek
argument_list|(
name|Monstfp
argument_list|,
operator|(
name|long
operator|)
name|which
operator|*
operator|(
name|long
operator|)
name|SZ_MONSTERSTRUCT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Curmonster
argument_list|,
name|SZ_MONSTERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Monstfp
argument_list|)
expr_stmt|;
comment|/* handle some special monsters */
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_MODNAR
condition|)
block|{
if|if
condition|(
name|Player
operator|.
name|p_specialtype
operator|<
name|SC_COUNCIL
condition|)
comment|/* randomize some stats */
block|{
name|Curmonster
operator|.
name|m_strength
operator|*=
name|drandom
argument_list|()
operator|+
literal|0.5
expr_stmt|;
name|Curmonster
operator|.
name|m_brains
operator|*=
name|drandom
argument_list|()
operator|+
literal|0.5
expr_stmt|;
name|Curmonster
operator|.
name|m_speed
operator|*=
name|drandom
argument_list|()
operator|+
literal|0.5
expr_stmt|;
name|Curmonster
operator|.
name|m_energy
operator|*=
name|drandom
argument_list|()
operator|+
literal|0.5
expr_stmt|;
name|Curmonster
operator|.
name|m_experience
operator|*=
name|drandom
argument_list|()
operator|+
literal|0.5
expr_stmt|;
name|Curmonster
operator|.
name|m_treasuretype
operator|=
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|0.0
argument_list|,
operator|(
name|double
operator|)
name|Curmonster
operator|.
name|m_treasuretype
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* make Modnar into Morgoth */
block|{
name|strcpy
argument_list|(
name|Curmonster
operator|.
name|m_name
argument_list|,
literal|"Morgoth"
argument_list|)
expr_stmt|;
name|Curmonster
operator|.
name|m_strength
operator|=
name|drandom
argument_list|()
operator|*
operator|(
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_shield
operator|)
operator|/
literal|1.4
operator|+
name|drandom
argument_list|()
operator|*
operator|(
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_shield
operator|)
operator|/
literal|1.5
expr_stmt|;
name|Curmonster
operator|.
name|m_brains
operator|=
name|Player
operator|.
name|p_brains
expr_stmt|;
name|Curmonster
operator|.
name|m_energy
operator|=
name|Player
operator|.
name|p_might
operator|*
literal|30.0
expr_stmt|;
name|Curmonster
operator|.
name|m_type
operator|=
name|SM_MORGOTH
expr_stmt|;
name|Curmonster
operator|.
name|m_speed
operator|=
name|Player
operator|.
name|p_speed
operator|*
literal|1.1
operator|+
operator|(
name|Player
operator|.
name|p_specialtype
operator|==
name|SC_EXVALAR
operator|)
condition|?
name|Player
operator|.
name|p_speed
else|:
literal|0.0
expr_stmt|;
name|Curmonster
operator|.
name|m_flock
operator|=
literal|0.0
expr_stmt|;
name|Curmonster
operator|.
name|m_treasuretype
operator|=
literal|0
expr_stmt|;
name|Curmonster
operator|.
name|m_experience
operator|=
literal|0.0
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|==
name|SM_MIMIC
condition|)
comment|/* pick another name */
block|{
name|which
operator|=
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|0.0
argument_list|,
literal|100.0
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|Monstfp
argument_list|,
operator|(
name|long
operator|)
name|which
operator|*
operator|(
name|long
operator|)
name|SZ_MONSTERSTRUCT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fread
argument_list|(
operator|&
name|Othermonster
argument_list|,
name|SZ_MONSTERSTRUCT
argument_list|,
literal|1
argument_list|,
name|Monstfp
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|Curmonster
operator|.
name|m_name
argument_list|,
name|Othermonster
operator|.
name|m_name
argument_list|)
expr_stmt|;
block|}
name|truncstring
argument_list|(
name|Curmonster
operator|.
name|m_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|Curmonster
operator|.
name|m_type
operator|!=
name|SM_MORGOTH
condition|)
comment|/* adjust stats based on which circle player is in */
block|{
name|Curmonster
operator|.
name|m_strength
operator|*=
operator|(
literal|1.0
operator|+
name|Circle
operator|/
literal|2.0
operator|)
expr_stmt|;
name|Curmonster
operator|.
name|m_brains
operator|*=
name|Circle
expr_stmt|;
name|Curmonster
operator|.
name|m_speed
operator|+=
name|Circle
operator|*
literal|1.e-9
expr_stmt|;
name|Curmonster
operator|.
name|m_energy
operator|*=
name|Circle
expr_stmt|;
name|Curmonster
operator|.
name|m_experience
operator|*=
name|Circle
expr_stmt|;
block|}
if|if
condition|(
name|Player
operator|.
name|p_blindness
condition|)
comment|/* cannot see monster if blind */
name|Enemyname
operator|=
literal|"A monster"
expr_stmt|;
else|else
name|Enemyname
operator|=
name|Curmonster
operator|.
name|m_name
expr_stmt|;
if|if
condition|(
name|Player
operator|.
name|p_speed
operator|<=
literal|0.0
condition|)
comment|/* make Player.p_speed positive */
block|{
name|Curmonster
operator|.
name|m_speed
operator|+=
operator|-
name|Player
operator|.
name|p_speed
expr_stmt|;
name|Player
operator|.
name|p_speed
operator|=
literal|1.0
expr_stmt|;
block|}
comment|/* fill up the rest of the structure */
name|Curmonster
operator|.
name|m_o_strength
operator|=
name|Curmonster
operator|.
name|m_strength
expr_stmt|;
name|Curmonster
operator|.
name|m_o_speed
operator|=
name|Curmonster
operator|.
name|m_maxspeed
operator|=
name|Curmonster
operator|.
name|m_speed
expr_stmt|;
name|Curmonster
operator|.
name|m_o_energy
operator|=
name|Curmonster
operator|.
name|m_energy
expr_stmt|;
name|Curmonster
operator|.
name|m_melee
operator|=
name|Curmonster
operator|.
name|m_skirmish
operator|=
literal|0.0
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: awardtreasure() / / FUNCTION: select a treasure / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: pickmonster(), collecttaxes(), more(), cursedtreasure(), /	floor(), wmove(), drandom(), sscanf(), printw(), altercoordinates(), /	longjmp(), infloat(), waddstr(), getanswer(), getstring(), wclrtobot() / / GLOBAL INPUTS: Somebetter[], Curmonster, Whichmonster, Circle, Player, /	*stdscr, Databuf[], *Statptr, Fightenv[] / / GLOBAL OUTPUTS: Whichmonster, Shield, Player / / DESCRIPTION: /	Roll up a treasure based upon monster type and size, and /	certain player statistics. /	Handle cursed treasure. / *************************************************************************/
end_comment

begin_macro
name|awardtreasure
argument_list|()
end_macro

begin_block
block|{
name|int
name|whichtreasure
decl_stmt|;
comment|/* calculated treasure to grant */
name|int
name|temp
decl_stmt|;
comment|/* temporary */
name|int
name|ch
decl_stmt|;
comment|/* input */
name|double
name|treasuretype
decl_stmt|;
comment|/* monster's treasure type */
name|double
name|gold
init|=
literal|0.0
decl_stmt|;
comment|/* gold awarded */
name|double
name|gems
init|=
literal|0.0
decl_stmt|;
comment|/* gems awarded */
name|double
name|dtemp
decl_stmt|;
comment|/* for temporary calculations */
name|whichtreasure
operator|=
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|1.0
argument_list|,
literal|3.0
argument_list|)
expr_stmt|;
comment|/* pick a treasure */
name|treasuretype
operator|=
operator|(
name|double
operator|)
name|Curmonster
operator|.
name|m_treasuretype
expr_stmt|;
name|move
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrtobot
argument_list|()
expr_stmt|;
name|move
argument_list|(
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drandom
argument_list|()
operator|>
literal|0.65
condition|)
comment|/* gold and gems */
block|{
if|if
condition|(
name|Curmonster
operator|.
name|m_treasuretype
operator|>
literal|7
condition|)
comment|/* gems */
block|{
name|gems
operator|=
name|ROLL
argument_list|(
literal|1.0
argument_list|,
operator|(
name|treasuretype
operator|-
literal|7.0
operator|)
operator|*
operator|(
name|treasuretype
operator|-
literal|7.0
operator|)
operator|*
operator|(
name|Circle
operator|-
literal|1.0
operator|)
operator|/
literal|4.0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"You have discovered %.0f gems!"
argument_list|,
name|gems
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* gold */
block|{
name|gold
operator|=
name|ROLL
argument_list|(
name|treasuretype
operator|*
literal|10.0
argument_list|,
name|treasuretype
operator|*
name|treasuretype
operator|*
literal|10.0
operator|*
operator|(
name|Circle
operator|-
literal|1.0
operator|)
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"You have found %.0f gold pieces."
argument_list|,
name|gold
argument_list|)
expr_stmt|;
block|}
name|addstr
argument_list|(
literal|"  Do you want to pick them up ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"NY"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'Y'
condition|)
block|{
if|if
condition|(
name|drandom
argument_list|()
operator|<
name|treasuretype
operator|/
literal|35.0
operator|+
literal|0.04
condition|)
comment|/* cursed */
block|{
name|addstr
argument_list|(
literal|"They were cursed!\n"
argument_list|)
expr_stmt|;
name|cursedtreasure
argument_list|()
expr_stmt|;
block|}
else|else
name|collecttaxes
argument_list|(
name|gold
argument_list|,
name|gems
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
else|else
comment|/* other treasures */
block|{
name|addstr
argument_list|(
literal|"You have found some treasure.  Do you want to inspect it ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"NY"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|!=
literal|'Y'
condition|)
return|return;
elseif|else
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.08
operator|&&
name|Curmonster
operator|.
name|m_treasuretype
operator|!=
literal|4
condition|)
block|{
name|addstr
argument_list|(
literal|"It was cursed!\n"
argument_list|)
expr_stmt|;
name|cursedtreasure
argument_list|()
expr_stmt|;
return|return;
block|}
else|else
switch|switch
condition|(
name|Curmonster
operator|.
name|m_treasuretype
condition|)
block|{
case|case
literal|1
case|:
comment|/* treasure type 1 */
switch|switch
condition|(
name|whichtreasure
condition|)
block|{
case|case
literal|1
case|:
name|addstr
argument_list|(
literal|"You've discovered a power booster!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|+=
name|ROLL
argument_list|(
name|Circle
operator|*
literal|4.0
argument_list|,
name|Circle
operator|*
literal|30.0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|addstr
argument_list|(
literal|"You have encountered a druid.\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_experience
operator|+=
name|ROLL
argument_list|(
literal|0.0
argument_list|,
literal|2000.0
operator|+
name|Circle
operator|*
literal|400.0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|addstr
argument_list|(
literal|"You have found a holy orb.\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_sin
operator|=
name|MAX
argument_list|(
literal|0.0
argument_list|,
name|Player
operator|.
name|p_sin
operator|-
literal|0.25
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end treasure type 1 */
case|case
literal|2
case|:
comment|/* treasure type 2 */
switch|switch
condition|(
name|whichtreasure
condition|)
block|{
case|case
literal|1
case|:
name|addstr
argument_list|(
literal|"You have found an amulet.\n"
argument_list|)
expr_stmt|;
operator|++
name|Player
operator|.
name|p_amulets
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|addstr
argument_list|(
literal|"You've found some holy water!\n"
argument_list|)
expr_stmt|;
operator|++
name|Player
operator|.
name|p_holywater
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|addstr
argument_list|(
literal|"You've met a hermit!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_sin
operator|*=
literal|0.75
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|+=
literal|12.0
operator|*
name|Circle
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end treasure type 2 */
case|case
literal|3
case|:
comment|/* treasure type 3 */
switch|switch
condition|(
name|whichtreasure
condition|)
block|{
case|case
literal|1
case|:
name|dtemp
operator|=
name|ROLL
argument_list|(
literal|7.0
argument_list|,
literal|30.0
operator|+
name|Circle
operator|/
literal|10.0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"You've found a +%.0f shield!\n"
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtemp
operator|>=
name|Player
operator|.
name|p_shield
condition|)
name|Player
operator|.
name|p_shield
operator|=
name|dtemp
expr_stmt|;
else|else
name|SOMEBETTER
argument_list|()
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|addstr
argument_list|(
literal|"You have rescued a virgin.  Will you be honorable ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"NY"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'Y'
condition|)
name|Player
operator|.
name|p_virgin
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|Player
operator|.
name|p_experience
operator|+=
literal|2000.0
operator|*
name|Circle
expr_stmt|;
operator|++
name|Player
operator|.
name|p_sin
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
name|addstr
argument_list|(
literal|"You've discovered some athelas!\n"
argument_list|)
expr_stmt|;
operator|--
name|Player
operator|.
name|p_poison
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end treasure type 3 */
case|case
literal|4
case|:
comment|/* treasure type 4 */
name|addstr
argument_list|(
literal|"You've found a scroll.  Will you read it ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"NY"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'Y'
condition|)
switch|switch
condition|(
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|1
argument_list|,
literal|6
argument_list|)
condition|)
block|{
case|case
literal|1
case|:
name|addstr
argument_list|(
literal|"It throws up a shield for you next monster.\n"
argument_list|)
expr_stmt|;
name|getyx
argument_list|(
name|stdscr
argument_list|,
name|whichtreasure
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|more
argument_list|(
name|whichtreasure
argument_list|)
expr_stmt|;
name|Shield
operator|=
operator|(
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_energy
operator|)
operator|*
literal|5.5
operator|+
name|Circle
operator|*
literal|50.0
expr_stmt|;
name|Whichmonster
operator|=
name|pickmonster
argument_list|()
expr_stmt|;
name|longjmp
argument_list|(
name|Fightenv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|2
case|:
name|addstr
argument_list|(
literal|"It makes you invisible for you next monster.\n"
argument_list|)
expr_stmt|;
name|getyx
argument_list|(
name|stdscr
argument_list|,
name|whichtreasure
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|more
argument_list|(
name|whichtreasure
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_speed
operator|=
literal|1e6
expr_stmt|;
name|Whichmonster
operator|=
name|pickmonster
argument_list|()
expr_stmt|;
name|longjmp
argument_list|(
name|Fightenv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|3
case|:
name|addstr
argument_list|(
literal|"It increases your strength ten fold to fight your next monster.\n"
argument_list|)
expr_stmt|;
name|getyx
argument_list|(
name|stdscr
argument_list|,
name|whichtreasure
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|more
argument_list|(
name|whichtreasure
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_might
operator|*=
literal|10.0
expr_stmt|;
name|Whichmonster
operator|=
name|pickmonster
argument_list|()
expr_stmt|;
name|longjmp
argument_list|(
name|Fightenv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|4
case|:
name|addstr
argument_list|(
literal|"It is a general knowledge scroll.\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|+=
name|ROLL
argument_list|(
literal|2.0
argument_list|,
name|Circle
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_magiclvl
operator|+=
name|ROLL
argument_list|(
literal|1.0
argument_list|,
name|Circle
operator|/
literal|2.0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|addstr
argument_list|(
literal|"It tells you how to pick your next monster.\n"
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"Which monster do you want [0-99] ? "
argument_list|)
expr_stmt|;
name|Whichmonster
operator|=
operator|(
name|int
operator|)
name|infloat
argument_list|()
expr_stmt|;
name|Whichmonster
operator|=
name|MIN
argument_list|(
literal|99
argument_list|,
name|MAX
argument_list|(
literal|0
argument_list|,
name|Whichmonster
argument_list|)
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|Fightenv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
case|case
literal|6
case|:
name|addstr
argument_list|(
literal|"It was cursed!\n"
argument_list|)
expr_stmt|;
name|cursedtreasure
argument_list|()
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end treasure type 4 */
case|case
literal|5
case|:
comment|/* treasure type 5 */
switch|switch
condition|(
name|whichtreasure
condition|)
block|{
case|case
literal|1
case|:
name|dtemp
operator|=
name|ROLL
argument_list|(
name|Circle
operator|/
literal|4.0
operator|+
literal|5.0
argument_list|,
name|Circle
operator|/
literal|2.0
operator|+
literal|9.0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"You've discovered a +%.0f dagger.\n"
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtemp
operator|>=
name|Player
operator|.
name|p_sword
condition|)
name|Player
operator|.
name|p_sword
operator|=
name|dtemp
expr_stmt|;
else|else
name|SOMEBETTER
argument_list|()
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|dtemp
operator|=
name|ROLL
argument_list|(
literal|7.5
operator|+
name|Circle
operator|*
literal|3.0
argument_list|,
name|Circle
operator|*
literal|2.0
operator|+
literal|160.0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"You have found some +%.0f armour!\n"
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtemp
operator|>=
name|Player
operator|.
name|p_shield
condition|)
name|Player
operator|.
name|p_shield
operator|=
name|dtemp
expr_stmt|;
else|else
name|SOMEBETTER
argument_list|()
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|addstr
argument_list|(
literal|"You've found a tablet.\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|+=
literal|4.5
operator|*
name|Circle
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end treasure type 5 */
case|case
literal|6
case|:
comment|/* treasure type 6 */
switch|switch
condition|(
name|whichtreasure
condition|)
block|{
case|case
literal|1
case|:
name|addstr
argument_list|(
literal|"You've found a priest.\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|=
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_shield
expr_stmt|;
name|Player
operator|.
name|p_sin
operator|/=
literal|2.0
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|+=
literal|24.0
operator|*
name|Circle
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|+=
name|Circle
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|addstr
argument_list|(
literal|"You have come upon Robin Hood!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_shield
operator|+=
name|Circle
operator|*
literal|2.0
expr_stmt|;
name|Player
operator|.
name|p_strength
operator|+=
name|Circle
operator|/
literal|2.5
operator|+
literal|1.0
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|dtemp
operator|=
name|ROLL
argument_list|(
literal|2.0
operator|+
name|Circle
operator|/
literal|4.0
argument_list|,
name|Circle
operator|/
literal|1.2
operator|+
literal|10.0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"You have found a +%.0f axe!\n"
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtemp
operator|>=
name|Player
operator|.
name|p_sword
condition|)
name|Player
operator|.
name|p_sword
operator|=
name|dtemp
expr_stmt|;
else|else
name|SOMEBETTER
argument_list|()
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end treasure type 6 */
case|case
literal|7
case|:
comment|/* treasure type 7 */
switch|switch
condition|(
name|whichtreasure
condition|)
block|{
case|case
literal|1
case|:
name|addstr
argument_list|(
literal|"You've discovered a charm!\n"
argument_list|)
expr_stmt|;
operator|++
name|Player
operator|.
name|p_charms
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|addstr
argument_list|(
literal|"You have encountered Merlyn!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|+=
name|Circle
operator|+
literal|5.0
expr_stmt|;
name|Player
operator|.
name|p_magiclvl
operator|+=
name|Circle
operator|/
literal|3.0
operator|+
literal|5.0
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|+=
name|Circle
operator|*
literal|10.0
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|dtemp
operator|=
name|ROLL
argument_list|(
literal|5.0
operator|+
name|Circle
operator|/
literal|3.0
argument_list|,
name|Circle
operator|/
literal|1.5
operator|+
literal|20.0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"You have found a +%.0f war hammer!\n"
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtemp
operator|>=
name|Player
operator|.
name|p_sword
condition|)
name|Player
operator|.
name|p_sword
operator|=
name|dtemp
expr_stmt|;
else|else
name|SOMEBETTER
argument_list|()
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end treasure type 7 */
case|case
literal|8
case|:
comment|/* treasure type 8 */
switch|switch
condition|(
name|whichtreasure
condition|)
block|{
case|case
literal|1
case|:
name|addstr
argument_list|(
literal|"You have found a healing potion.\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_poison
operator|=
name|MIN
argument_list|(
operator|-
literal|2.0
argument_list|,
name|Player
operator|.
name|p_poison
operator|-
literal|2.0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|addstr
argument_list|(
literal|"You have discovered a transporter.  Do you wish to go anywhere ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"NY"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'Y'
condition|)
block|{
name|double
name|x
decl_stmt|,
name|y
decl_stmt|;
name|addstr
argument_list|(
literal|"X Y Coordinates ? "
argument_list|)
expr_stmt|;
name|getstring
argument_list|(
name|Databuf
argument_list|,
name|SZ_DATABUF
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|Databuf
argument_list|,
literal|"%lf %lf"
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
name|altercoordinates
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|A_FORCED
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
name|dtemp
operator|=
name|ROLL
argument_list|(
literal|10.0
operator|+
name|Circle
operator|/
literal|1.2
argument_list|,
name|Circle
operator|*
literal|3.0
operator|+
literal|30.0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"You've found a +%.0f sword!\n"
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtemp
operator|>=
name|Player
operator|.
name|p_sword
condition|)
name|Player
operator|.
name|p_sword
operator|=
name|dtemp
expr_stmt|;
else|else
name|SOMEBETTER
argument_list|()
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end treasure type 8 */
case|case
literal|10
case|:
case|case
literal|11
case|:
case|case
literal|12
case|:
case|case
literal|13
case|:
comment|/* treasure types 10 - 13 */
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.33
condition|)
block|{
if|if
condition|(
name|Curmonster
operator|.
name|m_treasuretype
operator|==
literal|10
condition|)
block|{
name|addstr
argument_list|(
literal|"You've found a pair of elven boots!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_quickness
operator|+=
literal|2.0
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|Curmonster
operator|.
name|m_treasuretype
operator|==
literal|11
operator|&&
operator|!
name|Player
operator|.
name|p_palantir
condition|)
block|{
name|addstr
argument_list|(
literal|"You've acquired Saruman's palantir.\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_palantir
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|==
name|R_NONE
operator|&&
name|Player
operator|.
name|p_specialtype
operator|<
name|SC_COUNCIL
operator|&&
operator|(
name|Curmonster
operator|.
name|m_treasuretype
operator|==
literal|12
operator|||
name|Curmonster
operator|.
name|m_treasuretype
operator|==
literal|13
operator|)
condition|)
comment|/* roll up a ring */
block|{
if|if
condition|(
name|drandom
argument_list|()
operator|<
literal|0.8
condition|)
comment|/* regular rings */
block|{
if|if
condition|(
name|Curmonster
operator|.
name|m_treasuretype
operator|==
literal|12
condition|)
block|{
name|whichtreasure
operator|=
name|R_NAZREG
expr_stmt|;
name|temp
operator|=
literal|35
expr_stmt|;
block|}
else|else
block|{
name|whichtreasure
operator|=
name|R_DLREG
expr_stmt|;
name|temp
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
comment|/* bad rings */
block|{
name|whichtreasure
operator|=
name|R_BAD
expr_stmt|;
name|temp
operator|=
literal|15
operator|+
name|Statptr
operator|->
name|c_ringduration
operator|+
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|0
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
name|addstr
argument_list|(
literal|"You've discovered a ring.  Will you pick it up ? "
argument_list|)
expr_stmt|;
name|ch
operator|=
name|getanswer
argument_list|(
literal|"NY"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|addstr
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'Y'
condition|)
block|{
name|Player
operator|.
name|p_ring
operator|.
name|ring_type
operator|=
name|whichtreasure
expr_stmt|;
name|Player
operator|.
name|p_ring
operator|.
name|ring_duration
operator|=
name|temp
expr_stmt|;
block|}
break|break;
block|}
block|}
comment|/* end treasure types 10 - 13 */
comment|/* fall through to treasure type 9 if no treasure from above */
case|case
literal|9
case|:
comment|/* treasure type 9 */
switch|switch
condition|(
name|whichtreasure
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|Player
operator|.
name|p_level
operator|<=
literal|1000.0
operator|&&
name|Player
operator|.
name|p_crowns
operator|<=
literal|3
operator|&&
name|Player
operator|.
name|p_level
operator|>=
literal|10.0
condition|)
block|{
name|addstr
argument_list|(
literal|"You have found a golden crown!\n"
argument_list|)
expr_stmt|;
operator|++
name|Player
operator|.
name|p_crowns
expr_stmt|;
break|break;
block|}
comment|/* fall through otherwise */
case|case
literal|2
case|:
name|addstr
argument_list|(
literal|"You've been blessed!\n"
argument_list|)
expr_stmt|;
name|Player
operator|.
name|p_blessing
operator|=
name|TRUE
expr_stmt|;
name|Player
operator|.
name|p_sin
operator|/=
literal|3.0
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|=
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_shield
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|+=
literal|100.0
operator|*
name|Circle
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|dtemp
operator|=
name|ROLL
argument_list|(
literal|1.0
argument_list|,
name|Circle
operator|/
literal|5.0
operator|+
literal|5.0
argument_list|)
expr_stmt|;
name|dtemp
operator|=
name|MIN
argument_list|(
name|dtemp
argument_list|,
literal|99.0
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|"You have discovered some +%.0f quicksilver!\n"
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtemp
operator|>=
name|Player
operator|.
name|p_quksilver
condition|)
name|Player
operator|.
name|p_quksilver
operator|=
name|dtemp
expr_stmt|;
else|else
name|SOMEBETTER
argument_list|()
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end treasure type 9 */
block|}
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: cursedtreasure() / / FUNCTION: take care of cursed treasure / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: waddstr() / / GLOBAL INPUTS: Player, *stdscr / / GLOBAL OUTPUTS: Player / / DESCRIPTION: /	Handle cursed treasure.  Look for amulets and charms to save /	the player from the curse. / *************************************************************************/
end_comment

begin_macro
name|cursedtreasure
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|Player
operator|.
name|p_charms
operator|>
literal|0
condition|)
block|{
name|addstr
argument_list|(
literal|"But your charm saved you!\n"
argument_list|)
expr_stmt|;
operator|--
name|Player
operator|.
name|p_charms
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Player
operator|.
name|p_amulets
operator|>
literal|0
condition|)
block|{
name|addstr
argument_list|(
literal|"But your amulet saved you!\n"
argument_list|)
expr_stmt|;
operator|--
name|Player
operator|.
name|p_amulets
expr_stmt|;
block|}
else|else
block|{
name|Player
operator|.
name|p_energy
operator|=
operator|(
name|Player
operator|.
name|p_maxenergy
operator|+
name|Player
operator|.
name|p_shield
operator|)
operator|/
literal|10.0
expr_stmt|;
name|Player
operator|.
name|p_poison
operator|+=
literal|0.25
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/************************************************************************ / / FUNCTION NAME: scramblestats() / / FUNCTION: scramble some selected statistics / / AUTHOR: E. A. Estes, 12/4/85 / / ARGUMENTS: none / / RETURN VALUE: none / / MODULES CALLED: floor(), drandom() / / GLOBAL INPUTS: Player / / GLOBAL OUTPUTS: Player / / DESCRIPTION: /	Swap a few player statistics randomly. / *************************************************************************/
end_comment

begin_macro
name|scramblestats
argument_list|()
end_macro

begin_block
block|{
name|double
name|dbuf
index|[
literal|6
index|]
decl_stmt|;
comment|/* to put statistic in */
name|double
name|dtemp1
decl_stmt|,
name|dtemp2
decl_stmt|;
comment|/* for swapping values */
name|int
name|first
decl_stmt|,
name|second
decl_stmt|;
comment|/* indices for swapping */
name|double
modifier|*
name|dptr
decl_stmt|;
comment|/* pointer for filling and emptying buf[] */
comment|/* fill buffer */
name|dptr
operator|=
operator|&
name|dbuf
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|dptr
operator|++
operator|=
name|Player
operator|.
name|p_strength
expr_stmt|;
operator|*
name|dptr
operator|++
operator|=
name|Player
operator|.
name|p_mana
expr_stmt|;
operator|*
name|dptr
operator|++
operator|=
name|Player
operator|.
name|p_brains
expr_stmt|;
operator|*
name|dptr
operator|++
operator|=
name|Player
operator|.
name|p_magiclvl
expr_stmt|;
operator|*
name|dptr
operator|++
operator|=
name|Player
operator|.
name|p_energy
expr_stmt|;
operator|*
name|dptr
operator|=
name|Player
operator|.
name|p_sin
expr_stmt|;
comment|/* pick values to swap */
name|first
operator|=
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|0
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|second
operator|=
operator|(
name|int
operator|)
name|ROLL
argument_list|(
literal|0
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* swap values */
name|dptr
operator|=
operator|&
name|dbuf
index|[
literal|0
index|]
expr_stmt|;
name|dtemp1
operator|=
name|dptr
index|[
name|first
index|]
expr_stmt|;
comment|/* this expression is split to prevent a compiler loop on some compilers */
name|dtemp2
operator|=
name|dptr
index|[
name|second
index|]
expr_stmt|;
name|dptr
index|[
name|first
index|]
operator|=
name|dtemp2
expr_stmt|;
name|dptr
index|[
name|second
index|]
operator|=
name|dtemp1
expr_stmt|;
comment|/* empty buffer */
name|Player
operator|.
name|p_strength
operator|=
operator|*
name|dptr
operator|++
expr_stmt|;
name|Player
operator|.
name|p_mana
operator|=
operator|*
name|dptr
operator|++
expr_stmt|;
name|Player
operator|.
name|p_brains
operator|=
operator|*
name|dptr
operator|++
expr_stmt|;
name|Player
operator|.
name|p_magiclvl
operator|=
operator|*
name|dptr
operator|++
expr_stmt|;
name|Player
operator|.
name|p_energy
operator|=
operator|*
name|dptr
operator|++
expr_stmt|;
name|Player
operator|.
name|p_sin
operator|=
operator|*
name|dptr
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*     Xroach - A game of skill.  Try to find the roaches under your windows.      Copyright 1991 by J.T. Anderson      jta@locus.com      This program may be freely distributed provided that all     copyright notices are retained.      To build:       cc -o xroach roach.c -lX11 [-lsocketorwhatever] [-lm] [-l...]      Dedicated to Greg McFarlane.   (gregm@otc.otca.oz.au) */
end_comment

begin_include
include|#
directive|include
file|<X11/Xlib.h>
end_include

begin_include
include|#
directive|include
file|<X11/Xutil.h>
end_include

begin_include
include|#
directive|include
file|<X11/Xos.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_decl_stmt
name|char
name|Copyright
index|[]
init|=
literal|"Xroach\nCopyright 1991 J.T. Anderson"
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|"roachmap.h"
end_include

begin_typedef
typedef|typedef
name|unsigned
name|long
name|Pixel
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|int
name|ErrorHandler
parameter_list|()
function_decl|;
end_typedef

begin_define
define|#
directive|define
name|SCAMPER_EVENT
value|(LASTEvent + 1)
end_define

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|GRAB_SERVER
argument_list|)
end_if

begin_define
define|#
directive|define
name|GRAB_SERVER
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|Display
modifier|*
name|display
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|screen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Window
name|rootWin
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|display_width
decl_stmt|,
name|display_height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|center_x
decl_stmt|,
name|center_y
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|GC
name|gc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|display_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Pixel
name|black
decl_stmt|,
name|white
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|done
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|eventBlock
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|errorVal
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
name|Roach
block|{
name|RoachMap
modifier|*
name|rp
decl_stmt|;
name|int
name|index
decl_stmt|;
name|float
name|x
decl_stmt|;
name|float
name|y
decl_stmt|;
name|int
name|intX
decl_stmt|;
name|int
name|intY
decl_stmt|;
name|int
name|hidden
decl_stmt|;
name|int
name|turnLeft
decl_stmt|;
name|int
name|steps
decl_stmt|;
block|}
name|Roach
typedef|;
end_typedef

begin_decl_stmt
name|Roach
modifier|*
name|roaches
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|maxRoaches
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|curRoaches
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|float
name|roachSpeed
init|=
literal|20.0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Region
name|rootVisible
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|Usage
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|SigHandler
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|AddRoach
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|MoveRoach
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DrawRoaches
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|CoverRoot
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|CalcRootVisible
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|MarkHiddenRoaches
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|Pixel
name|AllocNamedColor
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|void
name|main
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
name|av
index|[]
decl_stmt|;
block|{
name|XGCValues
name|xgcv
decl_stmt|;
name|int
name|ax
decl_stmt|;
name|char
modifier|*
name|arg
decl_stmt|;
name|RoachMap
modifier|*
name|rp
decl_stmt|;
name|int
name|rx
decl_stmt|;
name|float
name|angle
decl_stmt|;
name|XEvent
name|ev
decl_stmt|;
name|char
modifier|*
name|roachColor
init|=
literal|"black"
decl_stmt|;
name|int
name|nVis
decl_stmt|;
name|int
name|needCalc
decl_stmt|;
comment|/*        Process command line options.     */
for|for
control|(
name|ax
operator|=
literal|1
init|;
name|ax
operator|<
name|ac
condition|;
name|ax
operator|++
control|)
block|{
name|arg
operator|=
name|av
index|[
name|ax
index|]
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-display"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|display_name
operator|=
name|av
index|[
operator|++
name|ax
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-rc"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|roachColor
operator|=
name|av
index|[
operator|++
name|ax
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-speed"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|roachSpeed
operator|=
name|atof
argument_list|(
name|av
index|[
operator|++
name|ax
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-roaches"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|maxRoaches
operator|=
name|strtol
argument_list|(
name|av
index|[
operator|++
name|ax
index|]
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Usage
argument_list|()
expr_stmt|;
block|}
block|}
name|srand
argument_list|(
operator|(
name|int
operator|)
name|time
argument_list|(
operator|(
name|long
operator|*
operator|)
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
comment|/*        Catch some signals so we can erase any visible roaches.     */
name|signal
argument_list|(
name|SIGKILL
argument_list|,
name|SigHandler
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SigHandler
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|SigHandler
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SigHandler
argument_list|)
expr_stmt|;
name|display
operator|=
name|XOpenDisplay
argument_list|(
name|display_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|display
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|display_name
operator|==
name|NULL
condition|)
name|display_name
operator|=
name|getenv
argument_list|(
literal|"DISPLAY"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: cannot connect to X server %s\n"
argument_list|,
name|av
index|[
literal|0
index|]
argument_list|,
name|display_name
condition|?
name|display_name
else|:
literal|"(default)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|screen
operator|=
name|DefaultScreen
argument_list|(
name|display
argument_list|)
expr_stmt|;
name|rootWin
operator|=
name|RootWindow
argument_list|(
name|display
argument_list|,
name|screen
argument_list|)
expr_stmt|;
name|black
operator|=
name|BlackPixel
argument_list|(
name|display
argument_list|,
name|screen
argument_list|)
expr_stmt|;
name|white
operator|=
name|WhitePixel
argument_list|(
name|display
argument_list|,
name|screen
argument_list|)
expr_stmt|;
name|display_width
operator|=
name|DisplayWidth
argument_list|(
name|display
argument_list|,
name|screen
argument_list|)
expr_stmt|;
name|display_height
operator|=
name|DisplayHeight
argument_list|(
name|display
argument_list|,
name|screen
argument_list|)
expr_stmt|;
name|center_x
operator|=
name|display_width
operator|/
literal|2
expr_stmt|;
name|center_y
operator|=
name|display_height
operator|/
literal|2
expr_stmt|;
comment|/*        Create roach pixmaps at several orientations.     */
for|for
control|(
name|ax
operator|=
literal|0
init|;
name|ax
operator|<
literal|360
condition|;
name|ax
operator|+=
name|ROACH_ANGLE
control|)
block|{
name|rx
operator|=
name|ax
operator|/
name|ROACH_ANGLE
expr_stmt|;
name|angle
operator|=
name|rx
operator|*
literal|0.261799387799
expr_stmt|;
name|rp
operator|=
operator|&
name|roachPix
index|[
name|rx
index|]
expr_stmt|;
name|rp
operator|->
name|pixmap
operator|=
name|XCreateBitmapFromData
argument_list|(
name|display
argument_list|,
name|rootWin
argument_list|,
name|rp
operator|->
name|roachBits
argument_list|,
name|rp
operator|->
name|width
argument_list|,
name|rp
operator|->
name|height
argument_list|)
expr_stmt|;
name|rp
operator|->
name|sine
operator|=
name|sin
argument_list|(
name|angle
argument_list|)
expr_stmt|;
name|rp
operator|->
name|cosine
operator|=
name|cos
argument_list|(
name|angle
argument_list|)
expr_stmt|;
block|}
name|roaches
operator|=
operator|(
name|Roach
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Roach
argument_list|)
operator|*
name|maxRoaches
argument_list|)
expr_stmt|;
name|gc
operator|=
name|XCreateGC
argument_list|(
name|display
argument_list|,
name|rootWin
argument_list|,
literal|0L
argument_list|,
operator|&
name|xgcv
argument_list|)
expr_stmt|;
name|XSetForeground
argument_list|(
name|display
argument_list|,
name|gc
argument_list|,
name|AllocNamedColor
argument_list|(
name|roachColor
argument_list|,
name|black
argument_list|)
argument_list|)
expr_stmt|;
name|XSetFillStyle
argument_list|(
name|display
argument_list|,
name|gc
argument_list|,
name|FillStippled
argument_list|)
expr_stmt|;
while|while
condition|(
name|curRoaches
operator|<
name|maxRoaches
condition|)
name|AddRoach
argument_list|()
expr_stmt|;
name|XSelectInput
argument_list|(
name|display
argument_list|,
name|rootWin
argument_list|,
name|ExposureMask
operator||
name|SubstructureNotifyMask
argument_list|)
expr_stmt|;
name|needCalc
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|!
name|done
condition|)
block|{
if|if
condition|(
name|XPending
argument_list|(
name|display
argument_list|)
condition|)
block|{
name|XNextEvent
argument_list|(
name|display
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|needCalc
condition|)
block|{
name|needCalc
operator|=
name|CalcRootVisible
argument_list|()
expr_stmt|;
block|}
name|nVis
operator|=
name|MarkHiddenRoaches
argument_list|()
expr_stmt|;
if|if
condition|(
name|nVis
condition|)
block|{
name|ev
operator|.
name|type
operator|=
name|SCAMPER_EVENT
expr_stmt|;
block|}
else|else
block|{
name|DrawRoaches
argument_list|()
expr_stmt|;
name|eventBlock
operator|=
literal|1
expr_stmt|;
name|XNextEvent
argument_list|(
name|display
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
name|eventBlock
operator|=
literal|0
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|ev
operator|.
name|type
condition|)
block|{
case|case
name|SCAMPER_EVENT
case|:
for|for
control|(
name|rx
operator|=
literal|0
init|;
name|rx
operator|<
name|curRoaches
condition|;
name|rx
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|roaches
index|[
name|rx
index|]
operator|.
name|hidden
condition|)
name|MoveRoach
argument_list|(
name|rx
argument_list|)
expr_stmt|;
block|}
name|DrawRoaches
argument_list|()
expr_stmt|;
name|XSync
argument_list|(
name|display
argument_list|,
name|False
argument_list|)
expr_stmt|;
break|break;
case|case
name|Expose
case|:
case|case
name|MapNotify
case|:
case|case
name|UnmapNotify
case|:
case|case
name|ConfigureNotify
case|:
name|needCalc
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|CoverRoot
argument_list|()
expr_stmt|;
name|XCloseDisplay
argument_list|(
name|display
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|USEPRT
parameter_list|(
name|msg
parameter_list|)
value|fprintf(stderr, msg)
end_define

begin_function
name|void
name|Usage
parameter_list|()
block|{
name|USEPRT
argument_list|(
literal|"Usage: xroach [options]\n\n"
argument_list|)
expr_stmt|;
name|USEPRT
argument_list|(
literal|"Options:\n"
argument_list|)
expr_stmt|;
name|USEPRT
argument_list|(
literal|"       -display displayname\n"
argument_list|)
expr_stmt|;
name|USEPRT
argument_list|(
literal|"       -rc      roachcolor\n"
argument_list|)
expr_stmt|;
name|USEPRT
argument_list|(
literal|"       -roaches numroaches\n"
argument_list|)
expr_stmt|;
name|USEPRT
argument_list|(
literal|"       -speed   roachspeed\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|SigHandler
parameter_list|()
block|{
comment|/*        If we are blocked, no roaches are visible and we can just bail        out.  If we are not blocked, then let the main procedure clean        up the root window.     */
if|if
condition|(
name|eventBlock
condition|)
block|{
name|XCloseDisplay
argument_list|(
name|display
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|done
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*    Generate random integer between 0 and maxVal-1. */
end_comment

begin_function
name|int
name|RandInt
parameter_list|(
name|maxVal
parameter_list|)
name|int
name|maxVal
decl_stmt|;
block|{
return|return
name|rand
argument_list|()
operator|%
name|maxVal
return|;
block|}
end_function

begin_comment
comment|/*    Check for roach completely in specified rectangle. */
end_comment

begin_function
name|int
name|RoachInRect
parameter_list|(
name|roach
parameter_list|,
name|rx
parameter_list|,
name|ry
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|,
name|width
parameter_list|,
name|height
parameter_list|)
name|Roach
modifier|*
name|roach
decl_stmt|;
name|int
name|rx
decl_stmt|;
name|int
name|ry
decl_stmt|;
name|int
name|x
decl_stmt|;
name|int
name|y
decl_stmt|;
name|unsigned
name|int
name|width
decl_stmt|;
name|unsigned
name|int
name|height
decl_stmt|;
block|{
if|if
condition|(
name|rx
operator|<
name|x
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|rx
operator|+
name|roach
operator|->
name|rp
operator|->
name|width
operator|)
operator|>
operator|(
name|x
operator|+
name|width
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ry
operator|<
name|y
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|ry
operator|+
name|roach
operator|->
name|rp
operator|->
name|height
operator|)
operator|>
operator|(
name|y
operator|+
name|height
operator|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*    Check for roach overlapping specified rectangle. */
end_comment

begin_function
name|int
name|RoachOverRect
parameter_list|(
name|roach
parameter_list|,
name|rx
parameter_list|,
name|ry
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|,
name|width
parameter_list|,
name|height
parameter_list|)
name|Roach
modifier|*
name|roach
decl_stmt|;
name|int
name|rx
decl_stmt|;
name|int
name|ry
decl_stmt|;
name|int
name|x
decl_stmt|;
name|int
name|y
decl_stmt|;
name|unsigned
name|int
name|width
decl_stmt|;
name|unsigned
name|int
name|height
decl_stmt|;
block|{
if|if
condition|(
name|rx
operator|>=
operator|(
name|x
operator|+
name|width
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|rx
operator|+
name|roach
operator|->
name|rp
operator|->
name|width
operator|)
operator|<=
name|x
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ry
operator|>=
operator|(
name|y
operator|+
name|height
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|ry
operator|+
name|roach
operator|->
name|rp
operator|->
name|height
operator|)
operator|<=
name|y
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*    Give birth to a roach. */
end_comment

begin_function
name|void
name|AddRoach
parameter_list|()
block|{
name|Roach
modifier|*
name|r
decl_stmt|;
if|if
condition|(
name|curRoaches
operator|<
name|maxRoaches
condition|)
block|{
name|r
operator|=
operator|&
name|roaches
index|[
name|curRoaches
operator|++
index|]
expr_stmt|;
name|r
operator|->
name|index
operator|=
name|RandInt
argument_list|(
name|ROACH_HEADINGS
argument_list|)
expr_stmt|;
name|r
operator|->
name|rp
operator|=
operator|&
name|roachPix
index|[
name|r
operator|->
name|index
index|]
expr_stmt|;
name|r
operator|->
name|x
operator|=
name|RandInt
argument_list|(
name|display_width
operator|-
name|r
operator|->
name|rp
operator|->
name|width
argument_list|)
expr_stmt|;
name|r
operator|->
name|y
operator|=
name|RandInt
argument_list|(
name|display_height
operator|-
name|r
operator|->
name|rp
operator|->
name|height
argument_list|)
expr_stmt|;
name|r
operator|->
name|intX
operator|=
operator|-
literal|1
expr_stmt|;
name|r
operator|->
name|intY
operator|=
operator|-
literal|1
expr_stmt|;
name|r
operator|->
name|hidden
operator|=
literal|0
expr_stmt|;
name|r
operator|->
name|steps
operator|=
name|RandInt
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|r
operator|->
name|turnLeft
operator|=
name|RandInt
argument_list|(
literal|100
argument_list|)
operator|>=
literal|50
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*    Turn a roach. */
end_comment

begin_function
name|void
name|TurnRoach
parameter_list|(
name|roach
parameter_list|)
name|Roach
modifier|*
name|roach
decl_stmt|;
block|{
if|if
condition|(
name|roach
operator|->
name|index
operator|!=
operator|(
name|roach
operator|->
name|rp
operator|-
name|roachPix
operator|)
condition|)
return|return;
if|if
condition|(
name|roach
operator|->
name|turnLeft
condition|)
block|{
name|roach
operator|->
name|index
operator|+=
operator|(
name|RandInt
argument_list|(
literal|30
argument_list|)
operator|/
literal|10
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|roach
operator|->
name|index
operator|>=
name|ROACH_HEADINGS
condition|)
name|roach
operator|->
name|index
operator|-=
name|ROACH_HEADINGS
expr_stmt|;
block|}
else|else
block|{
name|roach
operator|->
name|index
operator|-=
operator|(
name|RandInt
argument_list|(
literal|30
argument_list|)
operator|/
literal|10
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|roach
operator|->
name|index
operator|<
literal|0
condition|)
name|roach
operator|->
name|index
operator|+=
name|ROACH_HEADINGS
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*    Move a roach. */
end_comment

begin_function
name|void
name|MoveRoach
parameter_list|(
name|rx
parameter_list|)
name|int
name|rx
decl_stmt|;
block|{
name|Roach
modifier|*
name|roach
decl_stmt|;
name|Roach
modifier|*
name|r2
decl_stmt|;
name|float
name|newX
decl_stmt|;
name|float
name|newY
decl_stmt|;
name|int
name|ii
decl_stmt|;
name|roach
operator|=
operator|&
name|roaches
index|[
name|rx
index|]
expr_stmt|;
name|newX
operator|=
name|roach
operator|->
name|x
operator|+
operator|(
name|roachSpeed
operator|*
name|roach
operator|->
name|rp
operator|->
name|cosine
operator|)
expr_stmt|;
name|newY
operator|=
name|roach
operator|->
name|y
operator|-
operator|(
name|roachSpeed
operator|*
name|roach
operator|->
name|rp
operator|->
name|sine
operator|)
expr_stmt|;
if|if
condition|(
name|RoachInRect
argument_list|(
name|roach
argument_list|,
operator|(
name|int
operator|)
name|newX
argument_list|,
operator|(
name|int
operator|)
name|newY
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|display_width
argument_list|,
name|display_height
argument_list|)
condition|)
block|{
name|roach
operator|->
name|x
operator|=
name|newX
expr_stmt|;
name|roach
operator|->
name|y
operator|=
name|newY
expr_stmt|;
if|if
condition|(
name|roach
operator|->
name|steps
operator|--
operator|<=
literal|0
condition|)
block|{
name|TurnRoach
argument_list|(
name|roach
argument_list|)
expr_stmt|;
name|roach
operator|->
name|steps
operator|=
name|RandInt
argument_list|(
literal|200
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|ii
operator|=
name|rx
operator|+
literal|1
init|;
name|ii
operator|<
name|curRoaches
condition|;
name|ii
operator|++
control|)
block|{
name|r2
operator|=
operator|&
name|roaches
index|[
name|ii
index|]
expr_stmt|;
if|if
condition|(
name|RoachOverRect
argument_list|(
name|roach
argument_list|,
operator|(
name|int
operator|)
name|newX
argument_list|,
operator|(
name|int
operator|)
name|newY
argument_list|,
name|r2
operator|->
name|intX
argument_list|,
name|r2
operator|->
name|intY
argument_list|,
name|r2
operator|->
name|rp
operator|->
name|width
argument_list|,
name|r2
operator|->
name|rp
operator|->
name|height
argument_list|)
condition|)
block|{
name|TurnRoach
argument_list|(
name|roach
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|TurnRoach
argument_list|(
name|roach
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*    Draw all roaches. */
end_comment

begin_function
name|void
name|DrawRoaches
parameter_list|()
block|{
name|Roach
modifier|*
name|roach
decl_stmt|;
name|int
name|rx
decl_stmt|;
for|for
control|(
name|rx
operator|=
literal|0
init|;
name|rx
operator|<
name|curRoaches
condition|;
name|rx
operator|++
control|)
block|{
name|roach
operator|=
operator|&
name|roaches
index|[
name|rx
index|]
expr_stmt|;
if|if
condition|(
name|roach
operator|->
name|intX
operator|>=
literal|0
condition|)
block|{
name|XClearArea
argument_list|(
name|display
argument_list|,
name|rootWin
argument_list|,
name|roach
operator|->
name|intX
argument_list|,
name|roach
operator|->
name|intY
argument_list|,
name|roach
operator|->
name|rp
operator|->
name|width
argument_list|,
name|roach
operator|->
name|rp
operator|->
name|height
argument_list|,
name|False
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|rx
operator|=
literal|0
init|;
name|rx
operator|<
name|curRoaches
condition|;
name|rx
operator|++
control|)
block|{
name|roach
operator|=
operator|&
name|roaches
index|[
name|rx
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|roach
operator|->
name|hidden
condition|)
block|{
name|roach
operator|->
name|intX
operator|=
name|roach
operator|->
name|x
expr_stmt|;
name|roach
operator|->
name|intY
operator|=
name|roach
operator|->
name|y
expr_stmt|;
name|roach
operator|->
name|rp
operator|=
operator|&
name|roachPix
index|[
name|roach
operator|->
name|index
index|]
expr_stmt|;
name|XSetStipple
argument_list|(
name|display
argument_list|,
name|gc
argument_list|,
name|roach
operator|->
name|rp
operator|->
name|pixmap
argument_list|)
expr_stmt|;
name|XSetTSOrigin
argument_list|(
name|display
argument_list|,
name|gc
argument_list|,
name|roach
operator|->
name|intX
argument_list|,
name|roach
operator|->
name|intY
argument_list|)
expr_stmt|;
name|XFillRectangle
argument_list|(
name|display
argument_list|,
name|rootWin
argument_list|,
name|gc
argument_list|,
name|roach
operator|->
name|intX
argument_list|,
name|roach
operator|->
name|intY
argument_list|,
name|roach
operator|->
name|rp
operator|->
name|width
argument_list|,
name|roach
operator|->
name|rp
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|roach
operator|->
name|intX
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*    Cover root window to erase roaches. */
end_comment

begin_function
name|void
name|CoverRoot
parameter_list|()
block|{
name|XSetWindowAttributes
name|xswa
decl_stmt|;
name|long
name|wamask
decl_stmt|;
name|Window
name|roachWin
decl_stmt|;
name|xswa
operator|.
name|background_pixmap
operator|=
name|ParentRelative
expr_stmt|;
name|xswa
operator|.
name|override_redirect
operator|=
name|True
expr_stmt|;
name|wamask
operator|=
name|CWBackPixmap
operator||
name|CWOverrideRedirect
expr_stmt|;
name|roachWin
operator|=
name|XCreateWindow
argument_list|(
name|display
argument_list|,
name|rootWin
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|display_width
argument_list|,
name|display_height
argument_list|,
literal|0
argument_list|,
name|CopyFromParent
argument_list|,
name|InputOutput
argument_list|,
name|CopyFromParent
argument_list|,
name|wamask
argument_list|,
operator|&
name|xswa
argument_list|)
expr_stmt|;
name|XLowerWindow
argument_list|(
name|display
argument_list|,
name|roachWin
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|display
argument_list|,
name|roachWin
argument_list|)
expr_stmt|;
name|XFlush
argument_list|(
name|display
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
operator|!
name|GRAB_SERVER
end_if

begin_function
name|int
name|RoachErrors
parameter_list|(
name|dpy
parameter_list|,
name|err
parameter_list|)
name|Display
modifier|*
name|dpy
decl_stmt|;
name|XErrorEvent
modifier|*
name|err
decl_stmt|;
block|{
name|errorVal
operator|=
name|err
operator|->
name|error_code
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* GRAB_SERVER */
end_comment

begin_comment
comment|/*    Calculate Visible region of root window. */
end_comment

begin_function
name|int
name|CalcRootVisible
parameter_list|()
block|{
name|Region
name|covered
decl_stmt|;
name|Region
name|visible
decl_stmt|;
name|Window
modifier|*
name|children
decl_stmt|;
name|int
name|nChildren
decl_stmt|;
name|Window
name|dummy
decl_stmt|;
name|XWindowAttributes
name|wa
decl_stmt|;
name|int
name|wx
decl_stmt|;
name|XRectangle
name|rect
decl_stmt|;
name|int
name|winX
decl_stmt|,
name|winY
decl_stmt|;
name|unsigned
name|int
name|winHeight
decl_stmt|,
name|winWidth
decl_stmt|;
name|unsigned
name|int
name|borderWidth
decl_stmt|;
name|unsigned
name|int
name|depth
decl_stmt|;
comment|/*        If we don't grab the server, the XGetWindowAttribute or XGetGeometry        calls can abort us.  On the other hand, the server grabs can make for        some annoying delays.     */
if|#
directive|if
name|GRAB_SERVER
name|XGrabServer
argument_list|(
name|display
argument_list|)
expr_stmt|;
else|#
directive|else
name|XSetErrorHandler
argument_list|(
name|RoachErrors
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*        Get children of root.     */
name|XQueryTree
argument_list|(
name|display
argument_list|,
name|rootWin
argument_list|,
operator|&
name|dummy
argument_list|,
operator|&
name|dummy
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|nChildren
argument_list|)
expr_stmt|;
comment|/*        For each mapped child, add the window rectangle to the covered        region.     */
name|covered
operator|=
name|XCreateRegion
argument_list|()
expr_stmt|;
for|for
control|(
name|wx
operator|=
literal|0
init|;
name|wx
operator|<
name|nChildren
condition|;
name|wx
operator|++
control|)
block|{
if|if
condition|(
name|XEventsQueued
argument_list|(
name|display
argument_list|,
name|QueuedAlready
argument_list|)
condition|)
return|return
literal|1
return|;
name|errorVal
operator|=
literal|0
expr_stmt|;
name|XGetWindowAttributes
argument_list|(
name|display
argument_list|,
name|children
index|[
name|wx
index|]
argument_list|,
operator|&
name|wa
argument_list|)
expr_stmt|;
if|if
condition|(
name|errorVal
condition|)
continue|continue;
if|if
condition|(
name|wa
operator|.
name|map_state
operator|==
name|IsViewable
condition|)
block|{
name|XGetGeometry
argument_list|(
name|display
argument_list|,
name|children
index|[
name|wx
index|]
argument_list|,
operator|&
name|dummy
argument_list|,
operator|&
name|winX
argument_list|,
operator|&
name|winY
argument_list|,
operator|&
name|winWidth
argument_list|,
operator|&
name|winHeight
argument_list|,
operator|&
name|borderWidth
argument_list|,
operator|&
name|depth
argument_list|)
expr_stmt|;
if|if
condition|(
name|errorVal
condition|)
continue|continue;
name|rect
operator|.
name|x
operator|=
name|winX
expr_stmt|;
name|rect
operator|.
name|y
operator|=
name|winY
expr_stmt|;
name|rect
operator|.
name|width
operator|=
name|winWidth
operator|+
operator|(
name|borderWidth
operator|*
literal|2
operator|)
expr_stmt|;
name|rect
operator|.
name|height
operator|=
name|winHeight
operator|+
operator|(
name|borderWidth
operator|*
literal|2
operator|)
expr_stmt|;
name|XUnionRectWithRegion
argument_list|(
operator|&
name|rect
argument_list|,
name|covered
argument_list|,
name|covered
argument_list|)
expr_stmt|;
block|}
block|}
name|XFree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|children
argument_list|)
expr_stmt|;
if|#
directive|if
name|GRAB_SERVER
name|XUngrabServer
argument_list|(
name|display
argument_list|)
expr_stmt|;
else|#
directive|else
name|XSetErrorHandler
argument_list|(
operator|(
name|ErrorHandler
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*        Subtract the covered region from the root window region.     */
name|visible
operator|=
name|XCreateRegion
argument_list|()
expr_stmt|;
name|rect
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|rect
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|rect
operator|.
name|width
operator|=
name|display_width
expr_stmt|;
name|rect
operator|.
name|height
operator|=
name|display_height
expr_stmt|;
name|XUnionRectWithRegion
argument_list|(
operator|&
name|rect
argument_list|,
name|visible
argument_list|,
name|visible
argument_list|)
expr_stmt|;
name|XSubtractRegion
argument_list|(
name|visible
argument_list|,
name|covered
argument_list|,
name|visible
argument_list|)
expr_stmt|;
name|XDestroyRegion
argument_list|(
name|covered
argument_list|)
expr_stmt|;
comment|/*        Save visible region globally.     */
if|if
condition|(
name|rootVisible
condition|)
name|XDestroyRegion
argument_list|(
name|rootVisible
argument_list|)
expr_stmt|;
name|rootVisible
operator|=
name|visible
expr_stmt|;
comment|/*        Mark all roaches visible.     */
for|for
control|(
name|wx
operator|=
literal|0
init|;
name|wx
operator|<
name|curRoaches
condition|;
name|wx
operator|++
control|)
name|roaches
index|[
name|wx
index|]
operator|.
name|hidden
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*    Mark hidden roaches. */
end_comment

begin_function
name|int
name|MarkHiddenRoaches
parameter_list|()
block|{
name|int
name|rx
decl_stmt|;
name|Roach
modifier|*
name|r
decl_stmt|;
name|int
name|nVisible
decl_stmt|;
name|nVisible
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|rx
operator|=
literal|0
init|;
name|rx
operator|<
name|curRoaches
condition|;
name|rx
operator|++
control|)
block|{
name|r
operator|=
operator|&
name|roaches
index|[
name|rx
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|r
operator|->
name|hidden
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|intX
operator|>
literal|0
operator|&&
name|XRectInRegion
argument_list|(
name|rootVisible
argument_list|,
name|r
operator|->
name|intX
argument_list|,
name|r
operator|->
name|intY
argument_list|,
name|r
operator|->
name|rp
operator|->
name|width
argument_list|,
name|r
operator|->
name|rp
operator|->
name|height
argument_list|)
operator|==
name|RectangleOut
condition|)
block|{
name|r
operator|->
name|hidden
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|nVisible
operator|++
expr_stmt|;
block|}
block|}
block|}
return|return
name|nVisible
return|;
block|}
end_function

begin_comment
comment|/*    Allocate a color by name. */
end_comment

begin_function
name|Pixel
name|AllocNamedColor
parameter_list|(
name|colorName
parameter_list|,
name|dfltPix
parameter_list|)
name|char
modifier|*
name|colorName
decl_stmt|;
name|Pixel
name|dfltPix
decl_stmt|;
block|{
name|Pixel
name|pix
decl_stmt|;
name|XColor
name|scrncolor
decl_stmt|;
name|XColor
name|exactcolor
decl_stmt|;
if|if
condition|(
name|XAllocNamedColor
argument_list|(
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|display
argument_list|,
name|screen
argument_list|)
argument_list|,
name|colorName
argument_list|,
operator|&
name|scrncolor
argument_list|,
operator|&
name|exactcolor
argument_list|)
condition|)
block|{
name|pix
operator|=
name|scrncolor
operator|.
name|pixel
expr_stmt|;
block|}
else|else
block|{
name|pix
operator|=
name|dfltPix
expr_stmt|;
block|}
return|return
name|pix
return|;
block|}
end_function

end_unit


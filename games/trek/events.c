begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1980, 1993  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static char sccsid[] = "@(#)events.c	8.1 (Berkeley) 5/31/93";
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|"trek.h"
end_include

begin_comment
comment|/* **  CAUSE TIME TO ELAPSE ** **	This routine does a hell of a lot.  It elapses time, eats up **	energy, regenerates energy, processes any events that occur, **	and so on. */
end_comment

begin_macro
name|events
argument_list|(
argument|warp
argument_list|)
end_macro

begin_decl_stmt
name|int
name|warp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* set if called in a time warp */
end_comment

begin_block
block|{
name|int
name|i
decl_stmt|;
name|int
name|j
decl_stmt|;
name|struct
name|kling
modifier|*
name|k
decl_stmt|;
name|double
name|rtime
decl_stmt|;
name|double
name|xdate
decl_stmt|;
name|double
name|idate
decl_stmt|;
name|struct
name|event
modifier|*
name|ev
decl_stmt|,
modifier|*
name|xsched
argument_list|()
decl_stmt|,
modifier|*
name|schedule
argument_list|()
decl_stmt|;
name|int
name|ix
decl_stmt|,
name|iy
decl_stmt|;
name|struct
name|quad
modifier|*
name|q
decl_stmt|;
name|struct
name|event
modifier|*
name|e
decl_stmt|;
name|int
name|evnum
decl_stmt|;
name|int
name|restcancel
decl_stmt|;
comment|/* if nothing happened, just allow for any Klingons killed */
if|if
condition|(
name|Move
operator|.
name|time
operator|<=
literal|0.0
condition|)
block|{
name|Now
operator|.
name|time
operator|=
name|Now
operator|.
name|resource
operator|/
name|Now
operator|.
name|klings
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* indicate that the cloaking device is now working */
name|Ship
operator|.
name|cloakgood
operator|=
literal|1
expr_stmt|;
comment|/* idate is the initial date */
name|idate
operator|=
name|Now
operator|.
name|date
expr_stmt|;
comment|/* schedule attacks if resting too long */
if|if
condition|(
name|Move
operator|.
name|time
operator|>
literal|0.5
operator|&&
name|Move
operator|.
name|resting
condition|)
name|schedule
argument_list|(
name|E_ATTACK
argument_list|,
literal|0.5
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* scan the event list */
while|while
condition|(
literal|1
condition|)
block|{
name|restcancel
operator|=
literal|0
expr_stmt|;
name|evnum
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* xdate is the date of the current event */
name|xdate
operator|=
name|idate
operator|+
name|Move
operator|.
name|time
expr_stmt|;
comment|/* find the first event that has happened */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXEVENTS
condition|;
name|i
operator|++
control|)
block|{
name|e
operator|=
operator|&
name|Event
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|evcode
operator|==
literal|0
operator|||
operator|(
name|e
operator|->
name|evcode
operator|&
name|E_GHOST
operator|)
condition|)
continue|continue;
if|if
condition|(
name|e
operator|->
name|date
operator|<
name|xdate
condition|)
block|{
name|xdate
operator|=
name|e
operator|->
name|date
expr_stmt|;
name|ev
operator|=
name|e
expr_stmt|;
name|evnum
operator|=
name|i
expr_stmt|;
block|}
block|}
name|e
operator|=
name|ev
expr_stmt|;
comment|/* find the time between events */
name|rtime
operator|=
name|xdate
operator|-
name|Now
operator|.
name|date
expr_stmt|;
comment|/* decrement the magic "Federation Resources" pseudo-variable */
name|Now
operator|.
name|resource
operator|-=
name|Now
operator|.
name|klings
operator|*
name|rtime
expr_stmt|;
comment|/* and recompute the time left */
name|Now
operator|.
name|time
operator|=
name|Now
operator|.
name|resource
operator|/
name|Now
operator|.
name|klings
expr_stmt|;
comment|/* move us up to the next date */
name|Now
operator|.
name|date
operator|=
name|xdate
expr_stmt|;
comment|/* check for out of time */
if|if
condition|(
name|Now
operator|.
name|time
operator|<=
literal|0.0
condition|)
name|lose
argument_list|(
name|L_NOTIME
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|xTRACE
if|if
condition|(
name|evnum
operator|>=
literal|0
operator|&&
name|Trace
condition|)
name|printf
argument_list|(
literal|"xdate = %.2f, evcode %d params %d %d %d\n"
argument_list|,
name|xdate
argument_list|,
name|e
operator|->
name|evcode
argument_list|,
name|e
operator|->
name|x
argument_list|,
name|e
operator|->
name|y
argument_list|,
name|e
operator|->
name|systemname
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* if evnum< 0, no events occurred  */
if|if
condition|(
name|evnum
operator|<
literal|0
condition|)
break|break;
comment|/* otherwise one did.  Find out what it is */
switch|switch
condition|(
name|e
operator|->
name|evcode
operator|&
name|E_EVENT
condition|)
block|{
case|case
name|E_SNOVA
case|:
comment|/* supernova */
comment|/* cause the supernova to happen */
name|snova
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* and schedule the next one */
name|xresched
argument_list|(
name|e
argument_list|,
name|E_SNOVA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_LRTB
case|:
comment|/* long range tractor beam */
comment|/* schedule the next one */
name|xresched
argument_list|(
name|e
argument_list|,
name|E_LRTB
argument_list|,
name|Now
operator|.
name|klings
argument_list|)
expr_stmt|;
comment|/* LRTB cannot occur if we are docked */
if|if
condition|(
name|Ship
operator|.
name|cond
operator|!=
name|DOCKED
condition|)
block|{
comment|/* pick a new quadrant */
name|i
operator|=
name|ranf
argument_list|(
name|Now
operator|.
name|klings
argument_list|)
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|ix
operator|=
literal|0
init|;
name|ix
operator|<
name|NQUADS
condition|;
name|ix
operator|++
control|)
block|{
for|for
control|(
name|iy
operator|=
literal|0
init|;
name|iy
operator|<
name|NQUADS
condition|;
name|iy
operator|++
control|)
block|{
name|q
operator|=
operator|&
name|Quad
index|[
name|ix
index|]
index|[
name|iy
index|]
expr_stmt|;
if|if
condition|(
name|q
operator|->
name|stars
operator|>=
literal|0
condition|)
if|if
condition|(
operator|(
name|i
operator|-=
name|q
operator|->
name|klings
operator|)
operator|<=
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
break|break;
block|}
comment|/* test for LRTB to same quadrant */
if|if
condition|(
name|Ship
operator|.
name|quadx
operator|==
name|ix
operator|&&
name|Ship
operator|.
name|quady
operator|==
name|iy
condition|)
break|break;
comment|/* nope, dump him in the new quadrant */
name|Ship
operator|.
name|quadx
operator|=
name|ix
expr_stmt|;
name|Ship
operator|.
name|quady
operator|=
name|iy
expr_stmt|;
name|printf
argument_list|(
literal|"\n%s caught in long range tractor beam\n"
argument_list|,
name|Ship
operator|.
name|shipname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"*** Pulled to quadrant %d,%d\n"
argument_list|,
name|Ship
operator|.
name|quadx
argument_list|,
name|Ship
operator|.
name|quady
argument_list|)
expr_stmt|;
name|Ship
operator|.
name|sectx
operator|=
name|ranf
argument_list|(
name|NSECTS
argument_list|)
expr_stmt|;
name|Ship
operator|.
name|secty
operator|=
name|ranf
argument_list|(
name|NSECTS
argument_list|)
expr_stmt|;
name|initquad
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* truncate the move time */
name|Move
operator|.
name|time
operator|=
name|xdate
operator|-
name|idate
expr_stmt|;
block|}
break|break;
case|case
name|E_KATSB
case|:
comment|/* Klingon attacks starbase */
comment|/* if out of bases, forget it */
if|if
condition|(
name|Now
operator|.
name|bases
operator|<=
literal|0
condition|)
block|{
name|unschedule
argument_list|(
name|e
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* check for starbase and Klingons in same quadrant */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Now
operator|.
name|bases
condition|;
name|i
operator|++
control|)
block|{
name|ix
operator|=
name|Now
operator|.
name|base
index|[
name|i
index|]
operator|.
name|x
expr_stmt|;
name|iy
operator|=
name|Now
operator|.
name|base
index|[
name|i
index|]
operator|.
name|y
expr_stmt|;
comment|/* see if a Klingon exists in this quadrant */
name|q
operator|=
operator|&
name|Quad
index|[
name|ix
index|]
index|[
name|iy
index|]
expr_stmt|;
if|if
condition|(
name|q
operator|->
name|klings
operator|<=
literal|0
condition|)
continue|continue;
comment|/* see if already distressed */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MAXEVENTS
condition|;
name|j
operator|++
control|)
block|{
name|e
operator|=
operator|&
name|Event
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|e
operator|->
name|evcode
operator|&
name|E_EVENT
operator|)
operator|!=
name|E_KDESB
condition|)
continue|continue;
if|if
condition|(
name|e
operator|->
name|x
operator|==
name|ix
operator|&&
name|e
operator|->
name|y
operator|==
name|iy
condition|)
break|break;
block|}
if|if
condition|(
name|j
operator|<
name|MAXEVENTS
condition|)
continue|continue;
comment|/* got a potential attack */
break|break;
block|}
name|e
operator|=
name|ev
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|Now
operator|.
name|bases
condition|)
block|{
comment|/* not now; wait a while and see if some Klingons move in */
name|reschedule
argument_list|(
name|e
argument_list|,
literal|0.5
operator|+
literal|3.0
operator|*
name|franf
argument_list|()
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* schedule a new attack, and a destruction of the base */
name|xresched
argument_list|(
name|e
argument_list|,
name|E_KATSB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|e
operator|=
name|xsched
argument_list|(
name|E_KDESB
argument_list|,
literal|1
argument_list|,
name|ix
argument_list|,
name|iy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* report it if we can */
if|if
condition|(
operator|!
name|damaged
argument_list|(
name|SSRADIO
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\nUhura:  Captain, we have recieved a distress signal\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  from the starbase in quadrant %d,%d.\n"
argument_list|,
name|ix
argument_list|,
name|iy
argument_list|)
expr_stmt|;
name|restcancel
operator|++
expr_stmt|;
block|}
else|else
comment|/* SSRADIO out, make it so we can't see the distress call */
comment|/* but it's still there!!! */
name|e
operator|->
name|evcode
operator||=
name|E_HIDDEN
expr_stmt|;
break|break;
case|case
name|E_KDESB
case|:
comment|/* Klingon destroys starbase */
name|unschedule
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|q
operator|=
operator|&
name|Quad
index|[
name|e
operator|->
name|x
index|]
index|[
name|e
operator|->
name|y
index|]
expr_stmt|;
comment|/* if the base has mysteriously gone away, or if the Klingon 			   got tired and went home, ignore this event */
if|if
condition|(
name|q
operator|->
name|bases
operator|<=
literal|0
operator|||
name|q
operator|->
name|klings
operator|<=
literal|0
condition|)
break|break;
comment|/* are we in the same quadrant? */
if|if
condition|(
name|e
operator|->
name|x
operator|==
name|Ship
operator|.
name|quadx
operator|&&
name|e
operator|->
name|y
operator|==
name|Ship
operator|.
name|quady
condition|)
block|{
comment|/* yep, kill one in this quadrant */
name|printf
argument_list|(
literal|"\nSpock: "
argument_list|)
expr_stmt|;
name|killb
argument_list|(
name|Ship
operator|.
name|quadx
argument_list|,
name|Ship
operator|.
name|quady
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* kill one in some other quadrant */
name|killb
argument_list|(
name|e
operator|->
name|x
argument_list|,
name|e
operator|->
name|y
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_ISSUE
case|:
comment|/* issue a distress call */
name|xresched
argument_list|(
name|e
argument_list|,
name|E_ISSUE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* if we already have too many, throw this one away */
if|if
condition|(
name|Ship
operator|.
name|distressed
operator|>=
name|MAXDISTR
condition|)
break|break;
comment|/* try a whole bunch of times to find something suitable */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|ix
operator|=
name|ranf
argument_list|(
name|NQUADS
argument_list|)
expr_stmt|;
name|iy
operator|=
name|ranf
argument_list|(
name|NQUADS
argument_list|)
expr_stmt|;
name|q
operator|=
operator|&
name|Quad
index|[
name|ix
index|]
index|[
name|iy
index|]
expr_stmt|;
comment|/* need a quadrant which is not the current one, 				   which has some stars which are inhabited and 				   not already under attack, which is not 				   supernova'ed, and which has some Klingons in it */
if|if
condition|(
operator|!
operator|(
operator|(
name|ix
operator|==
name|Ship
operator|.
name|quadx
operator|&&
name|iy
operator|==
name|Ship
operator|.
name|quady
operator|)
operator|||
name|q
operator|->
name|stars
operator|<
literal|0
operator|||
operator|(
name|q
operator|->
name|qsystemname
operator|&
name|Q_DISTRESSED
operator|)
operator|||
operator|(
name|q
operator|->
name|qsystemname
operator|&
name|Q_SYSTEM
operator|)
operator|==
literal|0
operator|||
name|q
operator|->
name|klings
operator|<=
literal|0
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>=
literal|100
condition|)
comment|/* can't seem to find one; ignore this call */
break|break;
comment|/* got one!!  Schedule its enslavement */
name|Ship
operator|.
name|distressed
operator|++
expr_stmt|;
name|e
operator|=
name|xsched
argument_list|(
name|E_ENSLV
argument_list|,
literal|1
argument_list|,
name|ix
argument_list|,
name|iy
argument_list|,
name|q
operator|->
name|qsystemname
argument_list|)
expr_stmt|;
name|q
operator|->
name|qsystemname
operator|=
operator|(
name|e
operator|-
name|Event
operator|)
operator||
name|Q_DISTRESSED
expr_stmt|;
comment|/* tell the captain about it if we can */
if|if
condition|(
operator|!
name|damaged
argument_list|(
name|SSRADIO
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\nUhura: Captain, starsystem %s in quadrant %d,%d is under attack\n"
argument_list|,
name|Systemname
index|[
name|e
operator|->
name|systemname
index|]
argument_list|,
name|ix
argument_list|,
name|iy
argument_list|)
expr_stmt|;
name|restcancel
operator|++
expr_stmt|;
block|}
else|else
comment|/* if we can't tell him, make it invisible */
name|e
operator|->
name|evcode
operator||=
name|E_HIDDEN
expr_stmt|;
break|break;
case|case
name|E_ENSLV
case|:
comment|/* starsystem is enslaved */
name|unschedule
argument_list|(
name|e
argument_list|)
expr_stmt|;
comment|/* see if current distress call still active */
name|q
operator|=
operator|&
name|Quad
index|[
name|e
operator|->
name|x
index|]
index|[
name|e
operator|->
name|y
index|]
expr_stmt|;
if|if
condition|(
name|q
operator|->
name|klings
operator|<=
literal|0
condition|)
block|{
comment|/* no Klingons, clean up */
comment|/* restore the system name */
name|q
operator|->
name|qsystemname
operator|=
name|e
operator|->
name|systemname
expr_stmt|;
break|break;
block|}
comment|/* play stork and schedule the first baby */
name|e
operator|=
name|schedule
argument_list|(
name|E_REPRO
argument_list|,
name|Param
operator|.
name|eventdly
index|[
name|E_REPRO
index|]
operator|*
name|franf
argument_list|()
argument_list|,
name|e
operator|->
name|x
argument_list|,
name|e
operator|->
name|y
argument_list|,
name|e
operator|->
name|systemname
argument_list|)
expr_stmt|;
comment|/* report the disaster if we can */
if|if
condition|(
operator|!
name|damaged
argument_list|(
name|SSRADIO
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\nUhura:  We've lost contact with starsystem %s\n"
argument_list|,
name|Systemname
index|[
name|e
operator|->
name|systemname
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  in quadrant %d,%d.\n"
argument_list|,
name|e
operator|->
name|x
argument_list|,
name|e
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
else|else
name|e
operator|->
name|evcode
operator||=
name|E_HIDDEN
expr_stmt|;
break|break;
case|case
name|E_REPRO
case|:
comment|/* Klingon reproduces */
comment|/* see if distress call is still active */
name|q
operator|=
operator|&
name|Quad
index|[
name|e
operator|->
name|x
index|]
index|[
name|e
operator|->
name|y
index|]
expr_stmt|;
if|if
condition|(
name|q
operator|->
name|klings
operator|<=
literal|0
condition|)
block|{
name|unschedule
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|q
operator|->
name|qsystemname
operator|=
name|e
operator|->
name|systemname
expr_stmt|;
break|break;
block|}
name|xresched
argument_list|(
name|e
argument_list|,
name|E_REPRO
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* reproduce one Klingon */
name|ix
operator|=
name|e
operator|->
name|x
expr_stmt|;
name|iy
operator|=
name|e
operator|->
name|y
expr_stmt|;
if|if
condition|(
name|Now
operator|.
name|klings
operator|==
literal|127
condition|)
break|break;
comment|/* full right now */
if|if
condition|(
name|q
operator|->
name|klings
operator|>=
name|MAXKLQUAD
condition|)
block|{
comment|/* this quadrant not ok, pick an adjacent one */
for|for
control|(
name|i
operator|=
name|ix
operator|-
literal|1
init|;
name|i
operator|<=
name|ix
operator|+
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|<
literal|0
operator|||
name|i
operator|>=
name|NQUADS
condition|)
continue|continue;
for|for
control|(
name|j
operator|=
name|iy
operator|-
literal|1
init|;
name|j
operator|<=
name|iy
operator|+
literal|1
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|<
literal|0
operator|||
name|j
operator|>=
name|NQUADS
condition|)
continue|continue;
name|q
operator|=
operator|&
name|Quad
index|[
name|i
index|]
index|[
name|j
index|]
expr_stmt|;
comment|/* check for this quad ok (not full& no snova) */
if|if
condition|(
name|q
operator|->
name|klings
operator|>=
name|MAXKLQUAD
operator|||
name|q
operator|->
name|stars
operator|<
literal|0
condition|)
continue|continue;
break|break;
block|}
if|if
condition|(
name|j
operator|<=
name|iy
operator|+
literal|1
condition|)
break|break;
block|}
if|if
condition|(
name|j
operator|>
name|iy
operator|+
literal|1
condition|)
comment|/* cannot create another yet */
break|break;
name|ix
operator|=
name|i
expr_stmt|;
name|iy
operator|=
name|j
expr_stmt|;
block|}
comment|/* deliver the child */
name|q
operator|->
name|klings
operator|++
expr_stmt|;
name|Now
operator|.
name|klings
operator|++
expr_stmt|;
if|if
condition|(
name|ix
operator|==
name|Ship
operator|.
name|quadx
operator|&&
name|iy
operator|==
name|Ship
operator|.
name|quady
condition|)
block|{
comment|/* we must position Klingon */
name|sector
argument_list|(
operator|&
name|ix
argument_list|,
operator|&
name|iy
argument_list|)
expr_stmt|;
name|Sect
index|[
name|ix
index|]
index|[
name|iy
index|]
operator|=
name|KLINGON
expr_stmt|;
name|k
operator|=
operator|&
name|Etc
operator|.
name|klingon
index|[
name|Etc
operator|.
name|nkling
operator|++
index|]
expr_stmt|;
name|k
operator|->
name|x
operator|=
name|ix
expr_stmt|;
name|k
operator|->
name|y
operator|=
name|iy
expr_stmt|;
name|k
operator|->
name|power
operator|=
name|Param
operator|.
name|klingpwr
expr_stmt|;
name|k
operator|->
name|srndreq
operator|=
literal|0
expr_stmt|;
name|compkldist
argument_list|(
name|Etc
operator|.
name|klingon
index|[
literal|0
index|]
operator|.
name|dist
operator|==
name|Etc
operator|.
name|klingon
index|[
literal|0
index|]
operator|.
name|avgdist
condition|?
literal|0
else|:
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* recompute time left */
name|Now
operator|.
name|time
operator|=
name|Now
operator|.
name|resource
operator|/
name|Now
operator|.
name|klings
expr_stmt|;
break|break;
case|case
name|E_SNAP
case|:
comment|/* take a snapshot of the galaxy */
name|xresched
argument_list|(
name|e
argument_list|,
name|E_SNAP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|i
operator|=
operator|(
name|int
operator|)
name|Etc
operator|.
name|snapshot
expr_stmt|;
name|i
operator|=
name|bmove
argument_list|(
name|Quad
argument_list|,
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|Quad
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|=
name|bmove
argument_list|(
name|Event
argument_list|,
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|Event
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|=
name|bmove
argument_list|(
operator|&
name|Now
argument_list|,
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|Now
argument_list|)
argument_list|)
expr_stmt|;
name|Game
operator|.
name|snap
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|E_ATTACK
case|:
comment|/* Klingons attack during rest period */
if|if
condition|(
operator|!
name|Move
operator|.
name|resting
condition|)
block|{
name|unschedule
argument_list|(
name|e
argument_list|)
expr_stmt|;
break|break;
block|}
name|attack
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|reschedule
argument_list|(
name|e
argument_list|,
literal|0.5
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_FIXDV
case|:
name|i
operator|=
name|e
operator|->
name|systemname
expr_stmt|;
name|unschedule
argument_list|(
name|e
argument_list|)
expr_stmt|;
comment|/* de-damage the device */
name|printf
argument_list|(
literal|"%s reports repair work on the %s finished.\n"
argument_list|,
name|Device
index|[
name|i
index|]
operator|.
name|person
argument_list|,
name|Device
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
comment|/* handle special processing upon fix */
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|LIFESUP
case|:
name|Ship
operator|.
name|reserves
operator|=
name|Param
operator|.
name|reserves
expr_stmt|;
break|break;
case|case
name|SINS
case|:
if|if
condition|(
name|Ship
operator|.
name|cond
operator|==
name|DOCKED
condition|)
break|break;
name|printf
argument_list|(
literal|"Spock has tried to recalibrate your Space Internal Navigation System,\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  but he has no standard base to calibrate to.  Suggest you get\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  to a starbase immediately so that you can properly recalibrate.\n"
argument_list|)
expr_stmt|;
name|Ship
operator|.
name|sinsbad
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SSRADIO
case|:
name|restcancel
operator|=
name|dumpssradio
argument_list|()
expr_stmt|;
break|break;
block|}
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|restcancel
operator|&&
name|Move
operator|.
name|resting
operator|&&
name|getynpar
argument_list|(
literal|"Spock: Shall we cancel our rest period"
argument_list|)
condition|)
name|Move
operator|.
name|time
operator|=
name|xdate
operator|-
name|idate
expr_stmt|;
block|}
comment|/* unschedule an attack during a rest period */
if|if
condition|(
name|e
operator|=
name|Now
operator|.
name|eventptr
index|[
name|E_ATTACK
index|]
condition|)
name|unschedule
argument_list|(
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|warp
condition|)
block|{
comment|/* eat up energy if cloaked */
if|if
condition|(
name|Ship
operator|.
name|cloaked
condition|)
name|Ship
operator|.
name|energy
operator|-=
name|Param
operator|.
name|cloakenergy
operator|*
name|Move
operator|.
name|time
expr_stmt|;
comment|/* regenerate resources */
name|rtime
operator|=
literal|1.0
operator|-
name|exp
argument_list|(
operator|-
name|Param
operator|.
name|regenfac
operator|*
name|Move
operator|.
name|time
argument_list|)
expr_stmt|;
name|Ship
operator|.
name|shield
operator|+=
operator|(
name|Param
operator|.
name|shield
operator|-
name|Ship
operator|.
name|shield
operator|)
operator|*
name|rtime
expr_stmt|;
name|Ship
operator|.
name|energy
operator|+=
operator|(
name|Param
operator|.
name|energy
operator|-
name|Ship
operator|.
name|energy
operator|)
operator|*
name|rtime
expr_stmt|;
comment|/* decrement life support reserves */
if|if
condition|(
name|damaged
argument_list|(
name|LIFESUP
argument_list|)
operator|&&
name|Ship
operator|.
name|cond
operator|!=
name|DOCKED
condition|)
name|Ship
operator|.
name|reserves
operator|-=
name|Move
operator|.
name|time
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


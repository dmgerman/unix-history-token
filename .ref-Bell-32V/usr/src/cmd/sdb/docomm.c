begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|"head.h"
end_include

begin_include
include|#
directive|include
file|<a.out.h>
end_include

begin_decl_stmt
name|struct
name|user
name|u
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|cntval
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|signo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|adrflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|oldaddr
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_macro
name|docommand
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|ADDR
name|addr
decl_stmt|,
name|odot
decl_stmt|;
name|struct
name|proct
modifier|*
name|procp
decl_stmt|;
if|if
condition|(
name|signo
operator|==
name|SIGINT
condition|)
name|signo
operator|=
literal|0
expr_stmt|;
name|cntval
operator|=
literal|1
expr_stmt|;
name|adrflg
operator|=
literal|0
expr_stmt|;
name|errflg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|scallf
condition|)
block|{
name|doscall
argument_list|()
expr_stmt|;
name|setcur
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|reflag
condition|)
block|{
comment|/* search for regular expression */
name|dore
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cmd
operator|==
literal|'\0'
condition|)
block|{
if|if
condition|(
name|integ
operator|!=
literal|0
operator|&&
name|var
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|error
argument_list|(
literal|"Invalid command (1)"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|integ
operator|!=
literal|0
condition|)
block|{
comment|/* print line number */
name|ffind
argument_list|(
name|integ
argument_list|)
expr_stmt|;
name|fprint
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|var
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Unexpected null command\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
literal|'a'
case|:
name|debug
operator|=
operator|!
name|debug
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|prframe
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|p
operator|=
name|args
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"%.8s() in \"%s\"\n"
argument_list|,
name|curproc
argument_list|()
operator|->
name|pname
argument_list|,
name|curfile
argument_list|)
expr_stmt|;
break|break;
block|}
while|while
condition|(
operator|*
name|p
operator|!=
literal|'\0'
condition|)
if|if
condition|(
operator|*
name|p
operator|++
operator|==
literal|'.'
condition|)
goto|goto
name|l1
goto|;
comment|/* argument is procedure name */
name|procp
operator|=
name|findproc
argument_list|(
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|procp
operator|->
name|pname
index|[
literal|0
index|]
operator|!=
literal|'\0'
operator|)
operator|&&
operator|(
name|procp
operator|->
name|sfptr
operator|!=
name|badfile
operator|)
condition|)
block|{
name|finit
argument_list|(
name|adrtofilep
argument_list|(
name|procp
operator|->
name|paddr
argument_list|)
operator|->
name|sfilename
argument_list|)
expr_stmt|;
name|ffind
argument_list|(
name|procp
operator|->
name|lineno
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"Can't find %s\n"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%.8s() in \"%s\"\n"
argument_list|,
name|curproc
argument_list|()
operator|->
name|pname
argument_list|,
name|curfile
argument_list|)
expr_stmt|;
break|break;
name|l1
label|:
comment|/* argument is filename */
name|finit
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\"%s\"\n"
argument_list|,
name|curfile
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
if|if
condition|(
name|integ
condition|)
name|ffind
argument_list|(
name|integ
argument_list|)
expr_stmt|;
name|fprint
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
case|case
literal|'w'
case|:
if|if
condition|(
name|integ
condition|)
name|ffind
argument_list|(
name|integ
argument_list|)
expr_stmt|;
name|i
operator|=
name|fline
expr_stmt|;
name|fback
argument_list|(
name|WINDOW
operator|/
literal|2
argument_list|)
expr_stmt|;
name|fprintn
argument_list|(
name|WINDOW
argument_list|)
expr_stmt|;
name|ffind
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|prdebug
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'z'
case|:
if|if
condition|(
name|integ
condition|)
name|ffind
argument_list|(
name|integ
argument_list|)
expr_stmt|;
name|fprintn
argument_list|(
name|WINDOW
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'-'
case|:
name|fback
argument_list|(
name|integ
condition|?
name|integ
else|:
literal|1
argument_list|)
expr_stmt|;
name|fpargs
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'+'
case|:
name|fforward
argument_list|(
name|integ
condition|?
name|integ
else|:
literal|1
argument_list|)
expr_stmt|;
name|fpargs
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
name|fforward
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|fprint
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'\004'
case|:
name|fforward
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\b"
argument_list|)
expr_stmt|;
name|fprintn
argument_list|(
name|WINDOW
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
if|if
condition|(
name|debug
condition|)
name|error
argument_list|(
literal|"calling subpcs"
argument_list|)
expr_stmt|;
if|if
condition|(
name|integ
condition|)
name|cntval
operator|=
name|integ
expr_stmt|;
if|if
condition|(
operator|!
name|executing
condition|)
block|{
name|executing
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|integ
condition|)
name|cntval
operator|=
name|integ
expr_stmt|;
name|subpcs
argument_list|(
literal|'r'
argument_list|)
expr_stmt|;
name|executing
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|debug
condition|)
name|error
argument_list|(
literal|"exiting subpcs"
argument_list|)
expr_stmt|;
comment|/* 		setcur(); 		break; */
case|case
literal|'c'
case|:
if|if
condition|(
name|debug
condition|)
name|error
argument_list|(
literal|"calling subpcs"
argument_list|)
expr_stmt|;
if|if
condition|(
name|integ
condition|)
name|cntval
operator|=
name|integ
expr_stmt|;
name|subpcs
argument_list|(
literal|'c'
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|error
argument_list|(
literal|"exiting subpcs"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|signo
condition|)
name|printf
argument_list|(
literal|"Breakpoint"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" at\n"
argument_list|)
expr_stmt|;
name|setcur
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|singstep
argument_list|(
name|integ
condition|?
name|integ
else|:
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|signo
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|setcur
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|odot
operator|=
operator|*
operator|(
name|ADDR
operator|*
operator|)
operator|(
operator|(
operator|(
name|ADDR
operator|)
operator|&
name|u
operator|)
operator|+
name|PC
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|dot
operator|=
name|getaddr
argument_list|(
name|adrtoprocp
argument_list|(
name|odot
argument_list|)
operator|->
name|pname
argument_list|,
name|adrtolineno
argument_list|(
name|odot
argument_list|)
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|dot
operator|!=
name|odot
operator|||
name|dot
operator|==
operator|-
literal|1
condition|)
break|break;
block|}
if|if
condition|(
name|odot
operator|==
name|dot
operator|||
name|dot
operator|==
operator|-
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"Cannot find next line"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"Setting bkpt with i=%d at %d, odot = %d\n"
argument_list|,
name|i
argument_list|,
name|dot
argument_list|,
name|odot
argument_list|)
expr_stmt|;
name|odot
operator|=
name|dot
expr_stmt|;
name|subpcs
argument_list|(
literal|'b'
argument_list|)
expr_stmt|;
name|subpcs
argument_list|(
literal|'c'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|signo
condition|)
name|printf
argument_list|(
literal|"Next statement\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" at\n"
argument_list|)
expr_stmt|;
name|setcur
argument_list|()
expr_stmt|;
name|dot
operator|=
name|odot
expr_stmt|;
name|subpcs
argument_list|(
literal|'d'
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
if|if
condition|(
name|proc
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|&&
name|integ
operator|==
literal|0
condition|)
block|{
name|prbkpt
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|dot
operator|=
name|getaddr
argument_list|(
name|proc
argument_list|,
name|integ
argument_list|)
expr_stmt|;
if|if
condition|(
name|dot
operator|==
operator|-
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"Cannot set breakpoint"
argument_list|)
expr_stmt|;
break|break;
block|}
name|subpcs
argument_list|(
literal|'b'
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%.8s:%d b\n"
argument_list|,
name|adrtoprocp
argument_list|(
name|dot
argument_list|)
operator|->
name|pname
argument_list|,
name|adrtolineno
argument_list|(
name|dot
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'d'
case|:
if|if
condition|(
name|proc
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|&&
name|integ
operator|==
literal|0
condition|)
block|{
name|idbkpt
argument_list|()
expr_stmt|;
break|break;
block|}
name|dot
operator|=
name|getaddr
argument_list|(
name|proc
argument_list|,
name|integ
argument_list|)
expr_stmt|;
if|if
condition|(
name|dot
operator|==
operator|-
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"Non existent breakpoint"
argument_list|)
expr_stmt|;
break|break;
block|}
name|subpcs
argument_list|(
literal|'d'
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|addr
operator|=
name|varaddr
argument_list|(
name|proc
index|[
literal|0
index|]
condition|?
name|proc
else|:
name|curproc
argument_list|()
operator|->
name|pname
argument_list|,
name|var
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stopped with value %d\n"
argument_list|,
name|monex
argument_list|(
name|addr
argument_list|,
literal|'d'
argument_list|)
argument_list|)
expr_stmt|;
name|setcur
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'/'
case|:
if|if
condition|(
name|var
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|var
index|[
literal|1
index|]
operator|==
literal|'\0'
condition|)
block|{
if|if
condition|(
name|integ
operator|==
literal|0
condition|)
name|integ
operator|=
name|oldaddr
expr_stmt|;
name|dispf
argument_list|(
operator|(
name|ADDR
operator|)
name|integ
argument_list|,
name|args
index|[
literal|0
index|]
condition|?
name|args
else|:
name|odesc
argument_list|,
name|oclass
operator|==
name|N_RSYM
condition|?
name|oclass
else|:
name|N_GSYM
argument_list|,
name|otype
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|oldaddr
operator|=
name|integ
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|integ
condition|)
block|{
name|dispf
argument_list|(
operator|(
name|ADDR
operator|)
name|integ
argument_list|,
name|args
argument_list|,
name|N_GSYM
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|oldaddr
operator|=
name|dispvar
argument_list|(
name|proc
index|[
literal|0
index|]
condition|?
name|proc
else|:
name|curproc
argument_list|()
operator|->
name|pname
argument_list|,
name|var
argument_list|,
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'='
case|:
if|if
condition|(
name|var
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|addr
operator|=
name|getaddr
argument_list|(
name|proc
argument_list|,
name|integ
argument_list|)
expr_stmt|;
else|else
name|addr
operator|=
name|varaddr
argument_list|(
name|proc
index|[
literal|0
index|]
condition|?
name|proc
else|:
name|curproc
argument_list|()
operator|->
name|pname
argument_list|,
name|var
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"Unknown address"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"0x%x\n"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'!'
case|:
if|if
condition|(
name|var
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|addr
operator|=
name|getaddr
argument_list|(
name|proc
argument_list|,
name|integ
argument_list|)
expr_stmt|;
else|else
name|addr
operator|=
name|varaddr
argument_list|(
name|proc
index|[
literal|0
index|]
condition|?
name|proc
else|:
name|curproc
argument_list|()
operator|->
name|pname
argument_list|,
name|var
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"Unknown variable"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sl_class
operator|==
name|N_RSYM
condition|)
name|putreg
argument_list|(
name|addr
argument_list|,
name|typetodesc
argument_list|(
name|sl_type
argument_list|,
name|subflag
argument_list|)
index|[
literal|0
index|]
argument_list|,
name|argvalue
argument_list|(
name|args
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|putval
argument_list|(
name|addr
argument_list|,
name|typetodesc
argument_list|(
name|sl_type
argument_list|,
name|subflag
argument_list|)
index|[
literal|0
index|]
argument_list|,
name|argvalue
argument_list|(
name|args
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_macro
name|fpargs
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|args
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'p'
case|:
case|case
literal|'\0'
case|:
name|fprint
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
name|i
operator|=
name|fline
expr_stmt|;
name|fback
argument_list|(
name|WINDOW
operator|/
literal|2
argument_list|)
expr_stmt|;
name|fprintn
argument_list|(
name|WINDOW
argument_list|)
expr_stmt|;
name|ffind
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'z'
case|:
name|fprintn
argument_list|(
name|WINDOW
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************                      The LLVM Compiler Infrastructure    This file is distributed under the University of Illinois Open Source   License. See LICENSE.TXT for details.  ******************************************************************************  * This C file vends a simple interface to set the Application Specific Info * on Mac OS X through Python. To use, compile as a dylib, import crashinfo * and call crashinfo.setCrashReporterDescription("hello world") * The testCrashReporterDescription() API is simply there to let you test that this * is doing what it is intended to do without having to actually cons up a crash ******************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<Python/Python.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_decl_stmt
name|void
modifier|*
name|__crashreporter_info__
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_asm
asm|asm(".desc ___crashreporter_info__, 0x10");
end_asm

begin_function
specifier|static
name|PyObject
modifier|*
name|setCrashReporterDescription
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|string
parameter_list|)
block|{
if|if
condition|(
name|__crashreporter_info__
condition|)
block|{
name|free
argument_list|(
name|__crashreporter_info__
argument_list|)
expr_stmt|;
name|__crashreporter_info__
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|string
operator|&&
name|PyString_Check
argument_list|(
name|string
argument_list|)
condition|)
block|{
name|Py_ssize_t
name|size
init|=
name|PyString_Size
argument_list|(
name|string
argument_list|)
decl_stmt|;
name|char
modifier|*
name|data
init|=
name|PyString_AsString
argument_list|(
name|string
argument_list|)
decl_stmt|;
if|if
condition|(
name|size
operator|>
literal|0
operator|&&
name|data
condition|)
block|{
operator|++
name|size
expr_stmt|;
comment|// Include the NULL terminateor in allocation and memcpy()
name|__crashreporter_info__
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|__crashreporter_info__
argument_list|,
name|data
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
name|Py_True
return|;
block|}
block|}
return|return
name|Py_False
return|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|testCrashReporterDescription
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|arg
parameter_list|)
block|{
name|int
modifier|*
name|ptr
init|=
literal|0
decl_stmt|;
operator|*
name|ptr
operator|=
literal|1
expr_stmt|;
return|return
name|Py_None
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|PyMethodDef
name|crashinfo_methods
index|[]
init|=
block|{
block|{
literal|"setCrashReporterDescription"
block|,
name|setCrashReporterDescription
block|,
name|METH_O
block|}
block|,
block|{
literal|"testCrashReporterDescription"
block|,
name|testCrashReporterDescription
block|,
name|METH_O
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|initcrashinfo
parameter_list|()
block|{
operator|(
name|void
operator|)
name|Py_InitModule
argument_list|(
literal|"crashinfo"
argument_list|,
name|crashinfo_methods
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


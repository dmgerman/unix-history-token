begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*===-- executionengine_ocaml.c - LLVM Ocaml Glue ---------------*- C++ -*-===*\ |*                                                                            *| |*                     The LLVM Compiler Infrastructure                       *| |*                                                                            *| |* This file is distributed under the University of Illinois Open Source      *| |* License. See LICENSE.TXT for details.                                      *| |*                                                                            *| |*===----------------------------------------------------------------------===*| |*                                                                            *| |* This file glues LLVM's ocaml interface to its C interface. These functions *| |* are by and large transparent wrappers to the corresponding C functions.    *| |*                                                                            *| |* Note that these functions intentionally take liberties with the CAMLparamX *| |* macros, since most of the parameters are not GC heap objects.              *| |*                                                                            *| \*===----------------------------------------------------------------------===*/
end_comment

begin_include
include|#
directive|include
file|"llvm-c/ExecutionEngine.h"
end_include

begin_include
include|#
directive|include
file|"llvm-c/Target.h"
end_include

begin_include
include|#
directive|include
file|"caml/alloc.h"
end_include

begin_include
include|#
directive|include
file|"caml/custom.h"
end_include

begin_include
include|#
directive|include
file|"caml/fail.h"
end_include

begin_include
include|#
directive|include
file|"caml/memory.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_comment
comment|/* Force the LLVM interpreter and JIT to be linked in. */
end_comment

begin_function
name|void
name|llvm_initialize
parameter_list|(
name|void
parameter_list|)
block|{
name|LLVMLinkInInterpreter
argument_list|()
expr_stmt|;
name|LLVMLinkInJIT
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* unit -> bool */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_initialize_native_target
parameter_list|(
name|value
name|Unit
parameter_list|)
block|{
return|return
name|Val_bool
argument_list|(
name|LLVMInitializeNativeTarget
argument_list|()
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Can't use the recommended caml_named_value mechanism for backwards    compatibility reasons. This is largely equivalent. */
end_comment

begin_decl_stmt
specifier|static
name|value
name|llvm_ee_error_exn
decl_stmt|;
end_decl_stmt

begin_function
name|CAMLprim
name|value
name|llvm_register_ee_exns
parameter_list|(
name|value
name|Error
parameter_list|)
block|{
name|llvm_ee_error_exn
operator|=
name|Field
argument_list|(
name|Error
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|register_global_root
argument_list|(
operator|&
name|llvm_ee_error_exn
argument_list|)
expr_stmt|;
return|return
name|Val_unit
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|llvm_raise
parameter_list|(
name|value
name|Prototype
parameter_list|,
name|char
modifier|*
name|Message
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|Prototype
argument_list|)
expr_stmt|;
name|CAMLlocal1
argument_list|(
name|CamlMessage
argument_list|)
expr_stmt|;
name|CamlMessage
operator|=
name|copy_string
argument_list|(
name|Message
argument_list|)
expr_stmt|;
name|LLVMDisposeMessage
argument_list|(
name|Message
argument_list|)
expr_stmt|;
name|raise_with_arg
argument_list|(
name|Prototype
argument_list|,
name|CamlMessage
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
comment|/* NOTREACHED */
ifdef|#
directive|ifdef
name|CAMLnoreturn
name|CAMLnoreturn
expr_stmt|;
comment|/* Silences warnings, but is missing in some versions. */
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*--... Operations on generic values .......................................--*/
end_comment

begin_define
define|#
directive|define
name|Genericvalue_val
parameter_list|(
name|v
parameter_list|)
value|(*(LLVMGenericValueRef *)(Data_custom_val(v)))
end_define

begin_function
specifier|static
name|void
name|llvm_finalize_generic_value
parameter_list|(
name|value
name|GenVal
parameter_list|)
block|{
name|LLVMDisposeGenericValue
argument_list|(
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|custom_operations
name|generic_value_ops
init|=
block|{
operator|(
name|char
operator|*
operator|)
literal|"LLVMGenericValue"
block|,
name|llvm_finalize_generic_value
block|,
name|custom_compare_default
block|,
name|custom_hash_default
block|,
name|custom_serialize_default
block|,
name|custom_deserialize_default
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|value
name|alloc_generic_value
parameter_list|(
name|LLVMGenericValueRef
name|Ref
parameter_list|)
block|{
name|value
name|Val
init|=
name|alloc_custom
argument_list|(
operator|&
name|generic_value_ops
argument_list|,
sizeof|sizeof
argument_list|(
name|LLVMGenericValueRef
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|Genericvalue_val
argument_list|(
name|Val
argument_list|)
operator|=
name|Ref
expr_stmt|;
return|return
name|Val
return|;
block|}
end_function

begin_comment
comment|/* Llvm.lltype -> float -> t */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_of_float
parameter_list|(
name|LLVMTypeRef
name|Ty
parameter_list|,
name|value
name|N
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|N
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|alloc_generic_value
argument_list|(
name|LLVMCreateGenericValueOfFloat
argument_list|(
name|Ty
argument_list|,
name|Double_val
argument_list|(
name|N
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* 'a -> t */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_of_value
parameter_list|(
name|value
name|V
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|V
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|alloc_generic_value
argument_list|(
name|LLVMCreateGenericValueOfPointer
argument_list|(
name|Op_val
argument_list|(
name|V
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Llvm.lltype -> int -> t */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_of_int
parameter_list|(
name|LLVMTypeRef
name|Ty
parameter_list|,
name|value
name|Int
parameter_list|)
block|{
return|return
name|alloc_generic_value
argument_list|(
name|LLVMCreateGenericValueOfInt
argument_list|(
name|Ty
argument_list|,
name|Int_val
argument_list|(
name|Int
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Llvm.lltype -> int32 -> t */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_of_int32
parameter_list|(
name|LLVMTypeRef
name|Ty
parameter_list|,
name|value
name|Int32
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|Int32
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|alloc_generic_value
argument_list|(
name|LLVMCreateGenericValueOfInt
argument_list|(
name|Ty
argument_list|,
name|Int32_val
argument_list|(
name|Int32
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Llvm.lltype -> nativeint -> t */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_of_nativeint
parameter_list|(
name|LLVMTypeRef
name|Ty
parameter_list|,
name|value
name|NatInt
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|NatInt
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|alloc_generic_value
argument_list|(
name|LLVMCreateGenericValueOfInt
argument_list|(
name|Ty
argument_list|,
name|Nativeint_val
argument_list|(
name|NatInt
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Llvm.lltype -> int64 -> t */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_of_int64
parameter_list|(
name|LLVMTypeRef
name|Ty
parameter_list|,
name|value
name|Int64
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|Int64
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|alloc_generic_value
argument_list|(
name|LLVMCreateGenericValueOfInt
argument_list|(
name|Ty
argument_list|,
name|Int64_val
argument_list|(
name|Int64
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Llvm.lltype -> t -> float */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_as_float
parameter_list|(
name|LLVMTypeRef
name|Ty
parameter_list|,
name|value
name|GenVal
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|GenVal
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|copy_double
argument_list|(
name|LLVMGenericValueToFloat
argument_list|(
name|Ty
argument_list|,
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* t -> 'a */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_as_value
parameter_list|(
name|value
name|GenVal
parameter_list|)
block|{
return|return
name|Val_op
argument_list|(
name|LLVMGenericValueToPointer
argument_list|(
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* t -> int */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_as_int
parameter_list|(
name|value
name|GenVal
parameter_list|)
block|{
name|assert
argument_list|(
name|LLVMGenericValueIntWidth
argument_list|(
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|)
operator|<=
literal|8
operator|*
sizeof|sizeof
argument_list|(
name|value
argument_list|)
operator|&&
literal|"Generic value too wide to treat as an int!"
argument_list|)
expr_stmt|;
return|return
name|Val_int
argument_list|(
name|LLVMGenericValueToInt
argument_list|(
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* t -> int32 */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_as_int32
parameter_list|(
name|value
name|GenVal
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|GenVal
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|LLVMGenericValueIntWidth
argument_list|(
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|)
operator|<=
literal|32
operator|&&
literal|"Generic value too wide to treat as an int32!"
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|copy_int32
argument_list|(
name|LLVMGenericValueToInt
argument_list|(
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* t -> int64 */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_as_int64
parameter_list|(
name|value
name|GenVal
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|GenVal
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|LLVMGenericValueIntWidth
argument_list|(
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|)
operator|<=
literal|64
operator|&&
literal|"Generic value too wide to treat as an int64!"
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|copy_int64
argument_list|(
name|LLVMGenericValueToInt
argument_list|(
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* t -> nativeint */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_genericvalue_as_nativeint
parameter_list|(
name|value
name|GenVal
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|GenVal
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|LLVMGenericValueIntWidth
argument_list|(
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|)
operator|<=
literal|8
operator|*
sizeof|sizeof
argument_list|(
name|value
argument_list|)
operator|&&
literal|"Generic value too wide to treat as a nativeint!"
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|copy_nativeint
argument_list|(
name|LLVMGenericValueToInt
argument_list|(
name|Genericvalue_val
argument_list|(
name|GenVal
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*--... Operations on execution engines ....................................--*/
end_comment

begin_comment
comment|/* llmoduleprovider -> ExecutionEngine.t */
end_comment

begin_function
name|CAMLprim
name|LLVMExecutionEngineRef
name|llvm_ee_create
parameter_list|(
name|LLVMModuleProviderRef
name|MP
parameter_list|)
block|{
name|LLVMExecutionEngineRef
name|Interp
decl_stmt|;
name|char
modifier|*
name|Error
decl_stmt|;
if|if
condition|(
name|LLVMCreateExecutionEngine
argument_list|(
operator|&
name|Interp
argument_list|,
name|MP
argument_list|,
operator|&
name|Error
argument_list|)
condition|)
name|llvm_raise
argument_list|(
name|llvm_ee_error_exn
argument_list|,
name|Error
argument_list|)
expr_stmt|;
return|return
name|Interp
return|;
block|}
end_function

begin_comment
comment|/* llmoduleprovider -> ExecutionEngine.t */
end_comment

begin_function
name|CAMLprim
name|LLVMExecutionEngineRef
name|llvm_ee_create_interpreter
parameter_list|(
name|LLVMModuleProviderRef
name|MP
parameter_list|)
block|{
name|LLVMExecutionEngineRef
name|Interp
decl_stmt|;
name|char
modifier|*
name|Error
decl_stmt|;
if|if
condition|(
name|LLVMCreateInterpreter
argument_list|(
operator|&
name|Interp
argument_list|,
name|MP
argument_list|,
operator|&
name|Error
argument_list|)
condition|)
name|llvm_raise
argument_list|(
name|llvm_ee_error_exn
argument_list|,
name|Error
argument_list|)
expr_stmt|;
return|return
name|Interp
return|;
block|}
end_function

begin_comment
comment|/* llmoduleprovider -> ExecutionEngine.t */
end_comment

begin_function
name|CAMLprim
name|LLVMExecutionEngineRef
name|llvm_ee_create_jit
parameter_list|(
name|LLVMModuleProviderRef
name|MP
parameter_list|)
block|{
name|LLVMExecutionEngineRef
name|JIT
decl_stmt|;
name|char
modifier|*
name|Error
decl_stmt|;
if|if
condition|(
name|LLVMCreateJITCompiler
argument_list|(
operator|&
name|JIT
argument_list|,
name|MP
argument_list|,
literal|3
argument_list|,
operator|&
name|Error
argument_list|)
condition|)
name|llvm_raise
argument_list|(
name|llvm_ee_error_exn
argument_list|,
name|Error
argument_list|)
expr_stmt|;
return|return
name|JIT
return|;
block|}
end_function

begin_comment
comment|/* llmoduleprovider -> ExecutionEngine.t */
end_comment

begin_function
name|CAMLprim
name|LLVMExecutionEngineRef
name|llvm_ee_create_fast_jit
parameter_list|(
name|LLVMModuleProviderRef
name|MP
parameter_list|)
block|{
name|LLVMExecutionEngineRef
name|JIT
decl_stmt|;
name|char
modifier|*
name|Error
decl_stmt|;
if|if
condition|(
name|LLVMCreateJITCompiler
argument_list|(
operator|&
name|JIT
argument_list|,
name|MP
argument_list|,
literal|0
argument_list|,
operator|&
name|Error
argument_list|)
condition|)
name|llvm_raise
argument_list|(
name|llvm_ee_error_exn
argument_list|,
name|Error
argument_list|)
expr_stmt|;
return|return
name|JIT
return|;
block|}
end_function

begin_comment
comment|/* ExecutionEngine.t -> unit */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_ee_dispose
parameter_list|(
name|LLVMExecutionEngineRef
name|EE
parameter_list|)
block|{
name|LLVMDisposeExecutionEngine
argument_list|(
name|EE
argument_list|)
expr_stmt|;
return|return
name|Val_unit
return|;
block|}
end_function

begin_comment
comment|/* llmoduleprovider -> ExecutionEngine.t -> unit */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_ee_add_mp
parameter_list|(
name|LLVMModuleProviderRef
name|MP
parameter_list|,
name|LLVMExecutionEngineRef
name|EE
parameter_list|)
block|{
name|LLVMAddModuleProvider
argument_list|(
name|EE
argument_list|,
name|MP
argument_list|)
expr_stmt|;
return|return
name|Val_unit
return|;
block|}
end_function

begin_comment
comment|/* llmoduleprovider -> ExecutionEngine.t -> llmodule */
end_comment

begin_function
name|CAMLprim
name|LLVMModuleRef
name|llvm_ee_remove_mp
parameter_list|(
name|LLVMModuleProviderRef
name|MP
parameter_list|,
name|LLVMExecutionEngineRef
name|EE
parameter_list|)
block|{
name|LLVMModuleRef
name|RemovedModule
decl_stmt|;
name|char
modifier|*
name|Error
decl_stmt|;
if|if
condition|(
name|LLVMRemoveModuleProvider
argument_list|(
name|EE
argument_list|,
name|MP
argument_list|,
operator|&
name|RemovedModule
argument_list|,
operator|&
name|Error
argument_list|)
condition|)
name|llvm_raise
argument_list|(
name|llvm_ee_error_exn
argument_list|,
name|Error
argument_list|)
expr_stmt|;
return|return
name|RemovedModule
return|;
block|}
end_function

begin_comment
comment|/* string -> ExecutionEngine.t -> llvalue option */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_ee_find_function
parameter_list|(
name|value
name|Name
parameter_list|,
name|LLVMExecutionEngineRef
name|EE
parameter_list|)
block|{
name|CAMLparam1
argument_list|(
name|Name
argument_list|)
expr_stmt|;
name|CAMLlocal1
argument_list|(
name|Option
argument_list|)
expr_stmt|;
name|LLVMValueRef
name|Found
decl_stmt|;
if|if
condition|(
name|LLVMFindFunction
argument_list|(
name|EE
argument_list|,
name|String_val
argument_list|(
name|Name
argument_list|)
argument_list|,
operator|&
name|Found
argument_list|)
condition|)
name|CAMLreturn
argument_list|(
name|Val_unit
argument_list|)
expr_stmt|;
name|Option
operator|=
name|alloc
argument_list|(
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|Field
argument_list|(
name|Option
argument_list|,
literal|0
argument_list|)
operator|=
name|Val_op
argument_list|(
name|Found
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|Option
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* llvalue -> GenericValue.t array -> ExecutionEngine.t -> GenericValue.t */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_ee_run_function
parameter_list|(
name|LLVMValueRef
name|F
parameter_list|,
name|value
name|Args
parameter_list|,
name|LLVMExecutionEngineRef
name|EE
parameter_list|)
block|{
name|unsigned
name|NumArgs
decl_stmt|;
name|LLVMGenericValueRef
name|Result
decl_stmt|,
modifier|*
name|GVArgs
decl_stmt|;
name|unsigned
name|I
decl_stmt|;
name|NumArgs
operator|=
name|Wosize_val
argument_list|(
name|Args
argument_list|)
expr_stmt|;
name|GVArgs
operator|=
operator|(
name|LLVMGenericValueRef
operator|*
operator|)
name|malloc
argument_list|(
name|NumArgs
operator|*
sizeof|sizeof
argument_list|(
name|LLVMGenericValueRef
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|I
operator|=
literal|0
init|;
name|I
operator|!=
name|NumArgs
condition|;
operator|++
name|I
control|)
name|GVArgs
index|[
name|I
index|]
operator|=
name|Genericvalue_val
argument_list|(
name|Field
argument_list|(
name|Args
argument_list|,
name|I
argument_list|)
argument_list|)
expr_stmt|;
name|Result
operator|=
name|LLVMRunFunction
argument_list|(
name|EE
argument_list|,
name|F
argument_list|,
name|NumArgs
argument_list|,
name|GVArgs
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|GVArgs
argument_list|)
expr_stmt|;
return|return
name|alloc_generic_value
argument_list|(
name|Result
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ExecutionEngine.t -> unit */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_ee_run_static_ctors
parameter_list|(
name|LLVMExecutionEngineRef
name|EE
parameter_list|)
block|{
name|LLVMRunStaticConstructors
argument_list|(
name|EE
argument_list|)
expr_stmt|;
return|return
name|Val_unit
return|;
block|}
end_function

begin_comment
comment|/* ExecutionEngine.t -> unit */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_ee_run_static_dtors
parameter_list|(
name|LLVMExecutionEngineRef
name|EE
parameter_list|)
block|{
name|LLVMRunStaticDestructors
argument_list|(
name|EE
argument_list|)
expr_stmt|;
return|return
name|Val_unit
return|;
block|}
end_function

begin_comment
comment|/* llvalue -> string array -> (string * string) array -> ExecutionEngine.t ->    int */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_ee_run_function_as_main
parameter_list|(
name|LLVMValueRef
name|F
parameter_list|,
name|value
name|Args
parameter_list|,
name|value
name|Env
parameter_list|,
name|LLVMExecutionEngineRef
name|EE
parameter_list|)
block|{
name|CAMLparam2
argument_list|(
name|Args
argument_list|,
name|Env
argument_list|)
expr_stmt|;
name|int
name|I
decl_stmt|,
name|NumArgs
decl_stmt|,
name|NumEnv
decl_stmt|,
name|EnvSize
decl_stmt|,
name|Result
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|CArgs
decl_stmt|,
modifier|*
modifier|*
name|CEnv
decl_stmt|;
name|char
modifier|*
name|CEnvBuf
decl_stmt|,
modifier|*
name|Pos
decl_stmt|;
name|NumArgs
operator|=
name|Wosize_val
argument_list|(
name|Args
argument_list|)
expr_stmt|;
name|NumEnv
operator|=
name|Wosize_val
argument_list|(
name|Env
argument_list|)
expr_stmt|;
comment|/* Build the environment. */
name|CArgs
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|malloc
argument_list|(
name|NumArgs
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|I
operator|=
literal|0
init|;
name|I
operator|!=
name|NumArgs
condition|;
operator|++
name|I
control|)
name|CArgs
index|[
name|I
index|]
operator|=
name|String_val
argument_list|(
name|Field
argument_list|(
name|Args
argument_list|,
name|I
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Compute the size of the environment string buffer. */
for|for
control|(
name|I
operator|=
literal|0
operator|,
name|EnvSize
operator|=
literal|0
init|;
name|I
operator|!=
name|NumEnv
condition|;
operator|++
name|I
control|)
block|{
name|EnvSize
operator|+=
name|strlen
argument_list|(
name|String_val
argument_list|(
name|Field
argument_list|(
name|Field
argument_list|(
name|Env
argument_list|,
name|I
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
operator|+
literal|1
expr_stmt|;
name|EnvSize
operator|+=
name|strlen
argument_list|(
name|String_val
argument_list|(
name|Field
argument_list|(
name|Field
argument_list|(
name|Env
argument_list|,
name|I
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
comment|/* Build the environment. */
name|CEnv
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|NumEnv
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|CEnvBuf
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|EnvSize
argument_list|)
expr_stmt|;
name|Pos
operator|=
name|CEnvBuf
expr_stmt|;
for|for
control|(
name|I
operator|=
literal|0
init|;
name|I
operator|!=
name|NumEnv
condition|;
operator|++
name|I
control|)
block|{
name|char
modifier|*
name|Name
init|=
name|String_val
argument_list|(
name|Field
argument_list|(
name|Field
argument_list|(
name|Env
argument_list|,
name|I
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
decl_stmt|,
modifier|*
name|Value
init|=
name|String_val
argument_list|(
name|Field
argument_list|(
name|Field
argument_list|(
name|Env
argument_list|,
name|I
argument_list|)
argument_list|,
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|NameLen
init|=
name|strlen
argument_list|(
name|Name
argument_list|)
decl_stmt|,
name|ValueLen
init|=
name|strlen
argument_list|(
name|Value
argument_list|)
decl_stmt|;
name|CEnv
index|[
name|I
index|]
operator|=
name|Pos
expr_stmt|;
name|memcpy
argument_list|(
name|Pos
argument_list|,
name|Name
argument_list|,
name|NameLen
argument_list|)
expr_stmt|;
name|Pos
operator|+=
name|NameLen
expr_stmt|;
operator|*
name|Pos
operator|++
operator|=
literal|'='
expr_stmt|;
name|memcpy
argument_list|(
name|Pos
argument_list|,
name|Value
argument_list|,
name|ValueLen
argument_list|)
expr_stmt|;
name|Pos
operator|+=
name|ValueLen
expr_stmt|;
operator|*
name|Pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
name|CEnv
index|[
name|NumEnv
index|]
operator|=
name|NULL
expr_stmt|;
name|Result
operator|=
name|LLVMRunFunctionAsMain
argument_list|(
name|EE
argument_list|,
name|F
argument_list|,
name|NumArgs
argument_list|,
name|CArgs
argument_list|,
name|CEnv
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|CArgs
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|CEnv
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|CEnvBuf
argument_list|)
expr_stmt|;
name|CAMLreturn
argument_list|(
name|Val_int
argument_list|(
name|Result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* llvalue -> ExecutionEngine.t -> unit */
end_comment

begin_function
name|CAMLprim
name|value
name|llvm_ee_free_machine_code
parameter_list|(
name|LLVMValueRef
name|F
parameter_list|,
name|LLVMExecutionEngineRef
name|EE
parameter_list|)
block|{
name|LLVMFreeMachineCodeForFunction
argument_list|(
name|EE
argument_list|,
name|F
argument_list|)
expr_stmt|;
return|return
name|Val_unit
return|;
block|}
end_function

end_unit


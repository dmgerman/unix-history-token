begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * testcode/unitmain.c - unit test main program for unbound.  *  * Copyright (c) 2007, NLnet Labs. All rights reserved.  *  * This software is open source.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * Redistributions of source code must retain the above copyright notice,  * this list of conditions and the following disclaimer.  *  * Redistributions in binary form must reproduce the above copyright notice,  * this list of conditions and the following disclaimer in the documentation  * and/or other materials provided with the distribution.  *  * Neither the name of the NLNET LABS nor the names of its contributors may  * be used to endorse or promote products derived from this software without  * specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  *  */
end_comment

begin_comment
comment|/**  * \file  * Unit test main program. Calls all the other unit tests.  * Exits with code 1 on a failure. 0 if all unit tests are successfull.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_OPENSSL_ERR_H
end_ifdef

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_OPENSSL_RAND_H
end_ifdef

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_OPENSSL_CONF_H
end_ifdef

begin_include
include|#
directive|include
file|<openssl/conf.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_OPENSSL_ENGINE_H
end_ifdef

begin_include
include|#
directive|include
file|<openssl/engine.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NSS
end_ifdef

begin_comment
comment|/* nss3 */
end_comment

begin_include
include|#
directive|include
file|"nss.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|"util/log.h"
end_include

begin_include
include|#
directive|include
file|"testcode/unitmain.h"
end_include

begin_comment
comment|/** number of tests done */
end_comment

begin_decl_stmt
name|int
name|testcount
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|"util/alloc.h"
end_include

begin_comment
comment|/** test alloc code */
end_comment

begin_function
specifier|static
name|void
name|alloc_test
parameter_list|(
name|void
parameter_list|)
block|{
name|alloc_special_t
modifier|*
name|t1
decl_stmt|,
modifier|*
name|t2
decl_stmt|;
name|struct
name|alloc_cache
name|major
decl_stmt|,
name|minor1
decl_stmt|,
name|minor2
decl_stmt|;
name|int
name|i
decl_stmt|;
name|unit_show_feature
argument_list|(
literal|"alloc_special_obtain"
argument_list|)
expr_stmt|;
name|alloc_init
argument_list|(
operator|&
name|major
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|alloc_init
argument_list|(
operator|&
name|minor1
argument_list|,
operator|&
name|major
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|alloc_init
argument_list|(
operator|&
name|minor2
argument_list|,
operator|&
name|major
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|t1
operator|=
name|alloc_special_obtain
argument_list|(
operator|&
name|minor1
argument_list|)
expr_stmt|;
name|alloc_clear
argument_list|(
operator|&
name|minor1
argument_list|)
expr_stmt|;
name|alloc_special_release
argument_list|(
operator|&
name|minor2
argument_list|,
name|t1
argument_list|)
expr_stmt|;
name|t2
operator|=
name|alloc_special_obtain
argument_list|(
operator|&
name|minor2
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|t1
operator|==
name|t2
argument_list|)
expr_stmt|;
comment|/* reused */
name|alloc_special_release
argument_list|(
operator|&
name|minor2
argument_list|,
name|t1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|t1
operator|=
name|alloc_special_obtain
argument_list|(
operator|&
name|minor1
argument_list|)
expr_stmt|;
name|alloc_special_release
argument_list|(
operator|&
name|minor2
argument_list|,
name|t1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
literal|0
condition|)
block|{
name|alloc_stats
argument_list|(
operator|&
name|minor1
argument_list|)
expr_stmt|;
name|alloc_stats
argument_list|(
operator|&
name|minor2
argument_list|)
expr_stmt|;
name|alloc_stats
argument_list|(
operator|&
name|major
argument_list|)
expr_stmt|;
block|}
comment|/* reuse happened */
name|unit_assert
argument_list|(
name|minor1
operator|.
name|num_quar
operator|+
name|minor2
operator|.
name|num_quar
operator|+
name|major
operator|.
name|num_quar
operator|==
literal|11
argument_list|)
expr_stmt|;
name|alloc_clear
argument_list|(
operator|&
name|minor1
argument_list|)
expr_stmt|;
name|alloc_clear
argument_list|(
operator|&
name|minor2
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|major
operator|.
name|num_quar
operator|==
literal|11
argument_list|)
expr_stmt|;
name|alloc_clear
argument_list|(
operator|&
name|major
argument_list|)
expr_stmt|;
block|}
end_function

begin_include
include|#
directive|include
file|"util/net_help.h"
end_include

begin_comment
comment|/** test net code */
end_comment

begin_function
specifier|static
name|void
name|net_test
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|t4
index|[]
init|=
block|{
literal|"\000\000\000\000"
block|,
literal|"\200\000\000\000"
block|,
literal|"\300\000\000\000"
block|,
literal|"\340\000\000\000"
block|,
literal|"\360\000\000\000"
block|,
literal|"\370\000\000\000"
block|,
literal|"\374\000\000\000"
block|,
literal|"\376\000\000\000"
block|,
literal|"\377\000\000\000"
block|,
literal|"\377\200\000\000"
block|,
literal|"\377\300\000\000"
block|,
literal|"\377\340\000\000"
block|,
literal|"\377\360\000\000"
block|,
literal|"\377\370\000\000"
block|,
literal|"\377\374\000\000"
block|,
literal|"\377\376\000\000"
block|,
literal|"\377\377\000\000"
block|,
literal|"\377\377\200\000"
block|,
literal|"\377\377\300\000"
block|,
literal|"\377\377\340\000"
block|,
literal|"\377\377\360\000"
block|,
literal|"\377\377\370\000"
block|,
literal|"\377\377\374\000"
block|,
literal|"\377\377\376\000"
block|,
literal|"\377\377\377\000"
block|,
literal|"\377\377\377\200"
block|,
literal|"\377\377\377\300"
block|,
literal|"\377\377\377\340"
block|,
literal|"\377\377\377\360"
block|,
literal|"\377\377\377\370"
block|,
literal|"\377\377\377\374"
block|,
literal|"\377\377\377\376"
block|,
literal|"\377\377\377\377"
block|,
literal|"\377\377\377\377"
block|,
literal|"\377\377\377\377"
block|, 	}
decl_stmt|;
name|unit_show_func
argument_list|(
literal|"util/net_help.c"
argument_list|,
literal|"str_is_ip6"
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|str_is_ip6
argument_list|(
literal|"::"
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|str_is_ip6
argument_list|(
literal|"::1"
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|str_is_ip6
argument_list|(
literal|"2001:7b8:206:1:240:f4ff:fe37:8810"
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|str_is_ip6
argument_list|(
literal|"fe80::240:f4ff:fe37:8810"
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|str_is_ip6
argument_list|(
literal|"0.0.0.0"
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|str_is_ip6
argument_list|(
literal|"213.154.224.12"
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|str_is_ip6
argument_list|(
literal|"213.154.224.255"
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|str_is_ip6
argument_list|(
literal|"255.255.255.0"
argument_list|)
argument_list|)
expr_stmt|;
name|unit_show_func
argument_list|(
literal|"util/net_help.c"
argument_list|,
literal|"is_pow2"
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|is_pow2
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|is_pow2
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|is_pow2
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|is_pow2
argument_list|(
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|is_pow2
argument_list|(
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|is_pow2
argument_list|(
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|is_pow2
argument_list|(
literal|1024
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|is_pow2
argument_list|(
literal|1024
operator|*
literal|1024
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|is_pow2
argument_list|(
literal|1024
operator|*
literal|1024
operator|*
literal|1024
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|6
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|9
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|11
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|17
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|23
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|257
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|is_pow2
argument_list|(
literal|259
argument_list|)
argument_list|)
expr_stmt|;
comment|/* test addr_mask */
name|unit_show_func
argument_list|(
literal|"util/net_help.c"
argument_list|,
literal|"addr_mask"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
condition|)
block|{
name|struct
name|sockaddr_in
name|a4
decl_stmt|;
name|struct
name|sockaddr_in6
name|a6
decl_stmt|;
name|socklen_t
name|l4
init|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|a4
argument_list|)
decl_stmt|;
name|socklen_t
name|l6
init|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|a6
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|a4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|a6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|35
condition|;
name|i
operator|++
control|)
block|{
comment|/* address 255.255.255.255 */
name|memcpy
argument_list|(
operator|&
name|a4
operator|.
name|sin_addr
argument_list|,
literal|"\377\377\377\377"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|addr_mask
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a4
argument_list|,
name|l4
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|memcmp
argument_list|(
operator|&
name|a4
operator|.
name|sin_addr
argument_list|,
name|t4
index|[
name|i
index|]
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
operator|&
name|a6
operator|.
name|sin6_addr
argument_list|,
literal|"\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377"
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|addr_mask
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a6
argument_list|,
name|l6
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|memcmp
argument_list|(
operator|&
name|a6
operator|.
name|sin6_addr
argument_list|,
literal|"\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377"
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|addr_mask
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a6
argument_list|,
name|l6
argument_list|,
literal|122
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|memcmp
argument_list|(
operator|&
name|a6
operator|.
name|sin6_addr
argument_list|,
literal|"\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\300"
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|addr_mask
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a6
argument_list|,
name|l6
argument_list|,
literal|120
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|memcmp
argument_list|(
operator|&
name|a6
operator|.
name|sin6_addr
argument_list|,
literal|"\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\000"
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|addr_mask
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a6
argument_list|,
name|l6
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|memcmp
argument_list|(
operator|&
name|a6
operator|.
name|sin6_addr
argument_list|,
literal|"\377\377\377\377\377\377\377\377\000\000\000\000\000\000\000\000"
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|addr_mask
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a6
argument_list|,
name|l6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|memcmp
argument_list|(
operator|&
name|a6
operator|.
name|sin6_addr
argument_list|,
literal|"\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* test addr_in_common */
name|unit_show_func
argument_list|(
literal|"util/net_help.c"
argument_list|,
literal|"addr_in_common"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
condition|)
block|{
name|struct
name|sockaddr_in
name|a4
decl_stmt|,
name|b4
decl_stmt|;
name|struct
name|sockaddr_in6
name|a6
decl_stmt|,
name|b6
decl_stmt|;
name|socklen_t
name|l4
init|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|a4
argument_list|)
decl_stmt|;
name|socklen_t
name|l6
init|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|a6
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|a4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|b4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|a6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|b6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|a4
operator|.
name|sin_addr
argument_list|,
literal|"abcd"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|b4
operator|.
name|sin_addr
argument_list|,
literal|"abcd"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a4
argument_list|,
literal|32
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b4
argument_list|,
literal|32
argument_list|,
name|l4
argument_list|)
operator|==
literal|32
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a4
argument_list|,
literal|34
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b4
argument_list|,
literal|32
argument_list|,
name|l4
argument_list|)
operator|==
literal|32
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a4
argument_list|,
literal|32
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b4
argument_list|,
name|i
argument_list|,
name|l4
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a4
argument_list|,
name|i
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b4
argument_list|,
literal|32
argument_list|,
name|l4
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a4
argument_list|,
name|i
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b4
argument_list|,
name|i
argument_list|,
name|l4
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|memcpy
argument_list|(
operator|&
name|a4
operator|.
name|sin_addr
argument_list|,
literal|"\377\377\377\377"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|b4
operator|.
name|sin_addr
argument_list|,
name|t4
index|[
name|i
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a4
argument_list|,
literal|32
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b4
argument_list|,
literal|32
argument_list|,
name|l4
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b4
argument_list|,
literal|32
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a4
argument_list|,
literal|32
argument_list|,
name|l4
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
operator|&
name|a6
operator|.
name|sin6_addr
argument_list|,
literal|"abcdefghabcdefgh"
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|b6
operator|.
name|sin6_addr
argument_list|,
literal|"abcdefghabcdefgh"
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a6
argument_list|,
literal|128
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b6
argument_list|,
literal|128
argument_list|,
name|l6
argument_list|)
operator|==
literal|128
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a6
argument_list|,
literal|129
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b6
argument_list|,
literal|128
argument_list|,
name|l6
argument_list|)
operator|==
literal|128
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|128
condition|;
name|i
operator|++
control|)
block|{
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a6
argument_list|,
literal|128
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b6
argument_list|,
name|i
argument_list|,
name|l6
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a6
argument_list|,
name|i
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b6
argument_list|,
literal|128
argument_list|,
name|l6
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_in_common
argument_list|(
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|a6
argument_list|,
name|i
argument_list|,
operator|(
expr|struct
name|sockaddr_storage
operator|*
operator|)
operator|&
name|b6
argument_list|,
name|i
argument_list|,
name|l6
argument_list|)
operator|==
name|i
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* test sockaddr_cmp_addr */
name|unit_show_func
argument_list|(
literal|"util/net_help.c"
argument_list|,
literal|"sockaddr_cmp_addr"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
condition|)
block|{
name|struct
name|sockaddr_storage
name|a
decl_stmt|,
name|b
decl_stmt|;
name|socklen_t
name|alen
init|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|a
argument_list|)
decl_stmt|;
name|socklen_t
name|blen
init|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|b
argument_list|)
decl_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"127.0.0.0"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|alen
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"127.255.255.255"
argument_list|,
literal|53
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|blen
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|sockaddr_cmp_addr
argument_list|(
operator|&
name|a
argument_list|,
name|alen
argument_list|,
operator|&
name|b
argument_list|,
name|blen
argument_list|)
operator|<
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|sockaddr_cmp_addr
argument_list|(
operator|&
name|b
argument_list|,
name|blen
argument_list|,
operator|&
name|a
argument_list|,
name|alen
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|sockaddr_cmp_addr
argument_list|(
operator|&
name|a
argument_list|,
name|alen
argument_list|,
operator|&
name|a
argument_list|,
name|alen
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|sockaddr_cmp_addr
argument_list|(
operator|&
name|b
argument_list|,
name|blen
argument_list|,
operator|&
name|b
argument_list|,
name|blen
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"192.168.121.5"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|alen
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|sockaddr_cmp_addr
argument_list|(
operator|&
name|a
argument_list|,
name|alen
argument_list|,
operator|&
name|b
argument_list|,
name|blen
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|sockaddr_cmp_addr
argument_list|(
operator|&
name|b
argument_list|,
name|blen
argument_list|,
operator|&
name|a
argument_list|,
name|alen
argument_list|)
operator|<
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|sockaddr_cmp_addr
argument_list|(
operator|&
name|a
argument_list|,
name|alen
argument_list|,
operator|&
name|a
argument_list|,
name|alen
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"2001:3578:ffeb::99"
argument_list|,
literal|53
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|blen
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|sockaddr_cmp_addr
argument_list|(
operator|&
name|b
argument_list|,
name|blen
argument_list|,
operator|&
name|b
argument_list|,
name|blen
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|sockaddr_cmp_addr
argument_list|(
operator|&
name|a
argument_list|,
name|alen
argument_list|,
operator|&
name|b
argument_list|,
name|blen
argument_list|)
operator|<
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|sockaddr_cmp_addr
argument_list|(
operator|&
name|b
argument_list|,
name|blen
argument_list|,
operator|&
name|a
argument_list|,
name|alen
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* test addr_is_ip4mapped */
name|unit_show_func
argument_list|(
literal|"util/net_help.c"
argument_list|,
literal|"addr_is_ip4mapped"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
condition|)
block|{
name|struct
name|sockaddr_storage
name|a
decl_stmt|;
name|socklen_t
name|l
init|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|a
argument_list|)
decl_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"12.13.14.15"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_ip4mapped
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"fe80::217:31ff:fe91:df"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_ip4mapped
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"ffff::217:31ff:fe91:df"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_ip4mapped
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"::ffff:31ff:fe91:df"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_ip4mapped
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"::fffe:fe91:df"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_ip4mapped
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"::ffff:127.0.0.1"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_is_ip4mapped
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"::ffff:127.0.0.2"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_is_ip4mapped
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"::ffff:192.168.0.2"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_is_ip4mapped
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"2::ffff:192.168.0.2"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_ip4mapped
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* test addr_is_any */
name|unit_show_func
argument_list|(
literal|"util/net_help.c"
argument_list|,
literal|"addr_is_any"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
condition|)
block|{
name|struct
name|sockaddr_storage
name|a
decl_stmt|;
name|socklen_t
name|l
init|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|a
argument_list|)
decl_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"0.0.0.0"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"0.0.0.0"
argument_list|,
literal|10053
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"0.0.0.0"
argument_list|,
literal|0
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"::0"
argument_list|,
literal|0
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"::0"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"::1"
argument_list|,
literal|53
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"2001:1667::1"
argument_list|,
literal|0
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"2001::0"
argument_list|,
literal|0
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"10.0.0.0"
argument_list|,
literal|0
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"0.0.0.10"
argument_list|,
literal|0
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"192.0.2.1"
argument_list|,
literal|0
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|addr_is_any
argument_list|(
operator|&
name|a
argument_list|,
name|l
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_include
include|#
directive|include
file|"util/config_file.h"
end_include

begin_comment
comment|/** test config_file: cfg_parse_memsize */
end_comment

begin_function
specifier|static
name|void
name|config_memsize_test
parameter_list|(
name|void
parameter_list|)
block|{
name|size_t
name|v
init|=
literal|0
decl_stmt|;
name|unit_show_func
argument_list|(
literal|"util/config_file.c"
argument_list|,
literal|"cfg_parse_memsize"
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
condition|)
block|{
comment|/* these emit errors */
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|""
argument_list|,
operator|&
name|v
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"bla"
argument_list|,
operator|&
name|v
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"nop"
argument_list|,
operator|&
name|v
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"n0b"
argument_list|,
operator|&
name|v
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"gb"
argument_list|,
operator|&
name|v
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"b"
argument_list|,
operator|&
name|v
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"kb"
argument_list|,
operator|&
name|v
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"kk kb"
argument_list|,
operator|&
name|v
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"0"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"1"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|1
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"10"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|10
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"10b"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|10
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"5b"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|5
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"1024"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"1k"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"1K"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"1Kb"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"1kb"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"1 kb"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"10 kb"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|10240
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"2k"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|2048
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"2m"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|2048
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"3M"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|3072
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"40m"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|40960
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"1G"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|1024
operator|*
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"1 Gb"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|1024
operator|*
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|cfg_parse_memsize
argument_list|(
literal|"0 Gb"
argument_list|,
operator|&
name|v
argument_list|)
operator|&&
name|v
operator|==
literal|0
operator|*
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
block|}
end_function

begin_include
include|#
directive|include
file|"util/rtt.h"
end_include

begin_comment
comment|/** test RTT code */
end_comment

begin_function
specifier|static
name|void
name|rtt_test
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|init
init|=
literal|376
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|rtt_info
name|r
decl_stmt|;
name|unit_show_func
argument_list|(
literal|"util/rtt.c"
argument_list|,
literal|"rtt_timeout"
argument_list|)
expr_stmt|;
name|rtt_init
argument_list|(
operator|&
name|r
argument_list|)
expr_stmt|;
comment|/* initial value sensible */
name|unit_assert
argument_list|(
name|rtt_timeout
argument_list|(
operator|&
name|r
argument_list|)
operator|==
name|init
argument_list|)
expr_stmt|;
name|rtt_lost
argument_list|(
operator|&
name|r
argument_list|,
name|init
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|rtt_timeout
argument_list|(
operator|&
name|r
argument_list|)
operator|==
name|init
operator|*
literal|2
argument_list|)
expr_stmt|;
name|rtt_lost
argument_list|(
operator|&
name|r
argument_list|,
name|init
operator|*
literal|2
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|rtt_timeout
argument_list|(
operator|&
name|r
argument_list|)
operator|==
name|init
operator|*
literal|4
argument_list|)
expr_stmt|;
name|rtt_update
argument_list|(
operator|&
name|r
argument_list|,
literal|4000
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|rtt_timeout
argument_list|(
operator|&
name|r
argument_list|)
operator|>=
literal|2000
argument_list|)
expr_stmt|;
name|rtt_lost
argument_list|(
operator|&
name|r
argument_list|,
name|rtt_timeout
argument_list|(
operator|&
name|r
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|rtt_lost
argument_list|(
operator|&
name|r
argument_list|,
name|rtt_timeout
argument_list|(
operator|&
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|rtt_timeout
argument_list|(
operator|&
name|r
argument_list|)
operator|>
name|RTT_MIN_TIMEOUT
operator|-
literal|1
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|rtt_timeout
argument_list|(
operator|&
name|r
argument_list|)
operator|<
name|RTT_MAX_TIMEOUT
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_include
include|#
directive|include
file|"services/cache/infra.h"
end_include

begin_include
include|#
directive|include
file|"util/config_file.h"
end_include

begin_comment
comment|/* lookup and get key and data structs easily */
end_comment

begin_function
specifier|static
name|struct
name|infra_data
modifier|*
name|infra_lookup_host
parameter_list|(
name|struct
name|infra_cache
modifier|*
name|infra
parameter_list|,
name|struct
name|sockaddr_storage
modifier|*
name|addr
parameter_list|,
name|socklen_t
name|addrlen
parameter_list|,
name|uint8_t
modifier|*
name|zone
parameter_list|,
name|size_t
name|zonelen
parameter_list|,
name|int
name|wr
parameter_list|,
name|time_t
name|now
parameter_list|,
name|struct
name|infra_key
modifier|*
modifier|*
name|k
parameter_list|)
block|{
name|struct
name|infra_data
modifier|*
name|d
decl_stmt|;
name|struct
name|lruhash_entry
modifier|*
name|e
init|=
name|infra_lookup_nottl
argument_list|(
name|infra
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|wr
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|e
condition|)
return|return
name|NULL
return|;
name|d
operator|=
operator|(
expr|struct
name|infra_data
operator|*
operator|)
name|e
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|ttl
operator|<
name|now
condition|)
block|{
name|lock_rw_unlock
argument_list|(
operator|&
name|e
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|k
operator|=
operator|(
expr|struct
name|infra_key
operator|*
operator|)
name|e
operator|->
name|key
expr_stmt|;
return|return
name|d
return|;
block|}
end_function

begin_comment
comment|/** test host cache */
end_comment

begin_function
specifier|static
name|void
name|infra_test
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|sockaddr_storage
name|one
decl_stmt|;
name|socklen_t
name|onelen
decl_stmt|;
name|uint8_t
modifier|*
name|zone
init|=
operator|(
name|uint8_t
operator|*
operator|)
literal|"\007example\003com\000"
decl_stmt|;
name|size_t
name|zonelen
init|=
literal|13
decl_stmt|;
name|struct
name|infra_cache
modifier|*
name|slab
decl_stmt|;
name|struct
name|config_file
modifier|*
name|cfg
init|=
name|config_create
argument_list|()
decl_stmt|;
name|time_t
name|now
init|=
literal|0
decl_stmt|;
name|uint8_t
name|edns_lame
decl_stmt|;
name|int
name|vs
decl_stmt|,
name|to
decl_stmt|;
name|struct
name|infra_key
modifier|*
name|k
decl_stmt|;
name|struct
name|infra_data
modifier|*
name|d
decl_stmt|;
name|int
name|init
init|=
literal|376
decl_stmt|;
name|unit_show_feature
argument_list|(
literal|"infra cache"
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|ipstrtoaddr
argument_list|(
literal|"127.0.0.1"
argument_list|,
literal|53
argument_list|,
operator|&
name|one
argument_list|,
operator|&
name|onelen
argument_list|)
argument_list|)
expr_stmt|;
name|slab
operator|=
name|infra_create
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_host
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|now
argument_list|,
operator|&
name|vs
argument_list|,
operator|&
name|edns_lame
argument_list|,
operator|&
name|to
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|vs
operator|==
literal|0
operator|&&
name|to
operator|==
name|init
operator|&&
name|edns_lame
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_rtt_update
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|LDNS_RR_TYPE_A
argument_list|,
operator|-
literal|1
argument_list|,
name|init
argument_list|,
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_host
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|now
argument_list|,
operator|&
name|vs
argument_list|,
operator|&
name|edns_lame
argument_list|,
operator|&
name|to
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|vs
operator|==
literal|0
operator|&&
name|to
operator|==
name|init
operator|*
literal|2
operator|&&
name|edns_lame
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_edns_update
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
operator|-
literal|1
argument_list|,
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_host
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|now
argument_list|,
operator|&
name|vs
argument_list|,
operator|&
name|edns_lame
argument_list|,
operator|&
name|to
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|vs
operator|==
operator|-
literal|1
operator|&&
name|to
operator|==
name|init
operator|*
literal|2
operator|&&
name|edns_lame
operator|==
literal|1
argument_list|)
expr_stmt|;
name|now
operator|+=
name|cfg
operator|->
name|host_ttl
operator|+
literal|10
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_host
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|now
argument_list|,
operator|&
name|vs
argument_list|,
operator|&
name|edns_lame
argument_list|,
operator|&
name|to
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|vs
operator|==
literal|0
operator|&&
name|to
operator|==
name|init
operator|&&
name|edns_lame
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_set_lame
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|now
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LDNS_RR_TYPE_A
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|(
name|d
operator|=
name|infra_lookup_host
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
literal|0
argument_list|,
name|now
argument_list|,
operator|&
name|k
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|d
operator|->
name|ttl
operator|==
name|now
operator|+
name|cfg
operator|->
name|host_ttl
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|d
operator|->
name|edns_version
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|d
operator|->
name|isdnsseclame
operator|&&
operator|!
name|d
operator|->
name|rec_lame
operator|&&
name|d
operator|->
name|lame_type_A
operator|&&
operator|!
name|d
operator|->
name|lame_other
argument_list|)
expr_stmt|;
name|lock_rw_unlock
argument_list|(
operator|&
name|k
operator|->
name|entry
operator|.
name|lock
argument_list|)
expr_stmt|;
comment|/* test merge of data */
name|unit_assert
argument_list|(
name|infra_set_lame
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|now
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LDNS_RR_TYPE_AAAA
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|(
name|d
operator|=
name|infra_lookup_host
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
literal|0
argument_list|,
name|now
argument_list|,
operator|&
name|k
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|!
name|d
operator|->
name|isdnsseclame
operator|&&
operator|!
name|d
operator|->
name|rec_lame
operator|&&
name|d
operator|->
name|lame_type_A
operator|&&
name|d
operator|->
name|lame_other
argument_list|)
expr_stmt|;
name|lock_rw_unlock
argument_list|(
operator|&
name|k
operator|->
name|entry
operator|.
name|lock
argument_list|)
expr_stmt|;
comment|/* test that noEDNS cannot overwrite known-yesEDNS */
name|now
operator|+=
name|cfg
operator|->
name|host_ttl
operator|+
literal|10
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_host
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|now
argument_list|,
operator|&
name|vs
argument_list|,
operator|&
name|edns_lame
argument_list|,
operator|&
name|to
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|vs
operator|==
literal|0
operator|&&
name|to
operator|==
name|init
operator|&&
name|edns_lame
operator|==
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_edns_update
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
literal|0
argument_list|,
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_host
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|now
argument_list|,
operator|&
name|vs
argument_list|,
operator|&
name|edns_lame
argument_list|,
operator|&
name|to
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|vs
operator|==
literal|0
operator|&&
name|to
operator|==
name|init
operator|&&
name|edns_lame
operator|==
literal|1
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_edns_update
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
operator|-
literal|1
argument_list|,
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|infra_host
argument_list|(
name|slab
argument_list|,
operator|&
name|one
argument_list|,
name|onelen
argument_list|,
name|zone
argument_list|,
name|zonelen
argument_list|,
name|now
argument_list|,
operator|&
name|vs
argument_list|,
operator|&
name|edns_lame
argument_list|,
operator|&
name|to
argument_list|)
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|vs
operator|==
literal|0
operator|&&
name|to
operator|==
name|init
operator|&&
name|edns_lame
operator|==
literal|1
argument_list|)
expr_stmt|;
name|infra_delete
argument_list|(
name|slab
argument_list|)
expr_stmt|;
name|config_delete
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
block|}
end_function

begin_include
include|#
directive|include
file|"util/random.h"
end_include

begin_comment
comment|/** test randomness */
end_comment

begin_function
specifier|static
name|void
name|rnd_test
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|ub_randstate
modifier|*
name|r
decl_stmt|;
name|int
name|num
init|=
literal|1000
decl_stmt|,
name|i
decl_stmt|;
name|long
name|int
name|a
index|[
literal|1000
index|]
decl_stmt|;
name|unsigned
name|int
name|seed
init|=
operator|(
name|unsigned
operator|)
name|time
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
name|unit_show_feature
argument_list|(
literal|"ub_random"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ub_random seed is %u\n"
argument_list|,
name|seed
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|(
name|r
operator|=
name|ub_initstate
argument_list|(
name|seed
argument_list|,
name|NULL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|a
index|[
name|i
index|]
operator|=
name|ub_random
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|a
index|[
name|i
index|]
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
operator|(
name|size_t
operator|)
name|a
index|[
name|i
index|]
operator|<=
operator|(
name|size_t
operator|)
literal|0x7fffffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|5
condition|)
name|unit_assert
argument_list|(
name|a
index|[
name|i
index|]
operator|!=
name|a
index|[
name|i
operator|-
literal|1
index|]
operator|||
name|a
index|[
name|i
index|]
operator|!=
name|a
index|[
name|i
operator|-
literal|2
index|]
operator|||
name|a
index|[
name|i
index|]
operator|!=
name|a
index|[
name|i
operator|-
literal|3
index|]
operator|||
name|a
index|[
name|i
index|]
operator|!=
name|a
index|[
name|i
operator|-
literal|4
index|]
operator|||
name|a
index|[
name|i
index|]
operator|!=
name|a
index|[
name|i
operator|-
literal|5
index|]
operator|||
name|a
index|[
name|i
index|]
operator|!=
name|a
index|[
name|i
operator|-
literal|6
index|]
argument_list|)
expr_stmt|;
block|}
name|a
index|[
literal|0
index|]
operator|=
name|ub_random_max
argument_list|(
name|r
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|a
index|[
literal|0
index|]
operator|>=
literal|0
operator|&&
name|a
index|[
literal|0
index|]
operator|<
literal|1
argument_list|)
expr_stmt|;
name|a
index|[
literal|0
index|]
operator|=
name|ub_random_max
argument_list|(
name|r
argument_list|,
literal|10000
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|a
index|[
literal|0
index|]
operator|>=
literal|0
operator|&&
name|a
index|[
literal|0
index|]
operator|<
literal|10000
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|a
index|[
name|i
index|]
operator|=
name|ub_random_max
argument_list|(
name|r
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|unit_assert
argument_list|(
name|a
index|[
name|i
index|]
operator|>=
literal|0
operator|&&
name|a
index|[
name|i
index|]
operator|<
literal|10
argument_list|)
expr_stmt|;
block|}
name|ub_randfree
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|unit_show_func
parameter_list|(
specifier|const
name|char
modifier|*
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|func
parameter_list|)
block|{
name|printf
argument_list|(
literal|"test %s:%s\n"
argument_list|,
name|file
argument_list|,
name|func
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|unit_show_feature
parameter_list|(
specifier|const
name|char
modifier|*
name|feature
parameter_list|)
block|{
name|printf
argument_list|(
literal|"test %s functions\n"
argument_list|,
name|feature
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Main unit test program. Setup, teardown and report errors.  * @param argc: arg count.  * @param argv: array of commandline arguments.  * @return program failure if test fails.  */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|log_init
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"usage: %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tperforms unit tests.\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|printf
argument_list|(
literal|"Start of %s unit test.\n"
argument_list|,
name|PACKAGE_STRING
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_OPENSSL_CONFIG
name|OPENSSL_config
argument_list|(
literal|"unbound"
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_GOST
operator|(
name|void
operator|)
name|ldns_key_EVP_load_gost_id
argument_list|()
expr_stmt|;
endif|#
directive|endif
elif|#
directive|elif
name|defined
argument_list|(
name|HAVE_NSS
argument_list|)
if|if
condition|(
name|NSS_NoDB_Init
argument_list|(
literal|"."
argument_list|)
operator|!=
name|SECSuccess
condition|)
name|fatal_exit
argument_list|(
literal|"could not init NSS"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SSL or HAVE_NSS*/
name|checklock_start
argument_list|()
expr_stmt|;
name|neg_test
argument_list|()
expr_stmt|;
name|rnd_test
argument_list|()
expr_stmt|;
name|verify_test
argument_list|()
expr_stmt|;
name|net_test
argument_list|()
expr_stmt|;
name|config_memsize_test
argument_list|()
expr_stmt|;
name|dname_test
argument_list|()
expr_stmt|;
name|rtt_test
argument_list|()
expr_stmt|;
name|anchors_test
argument_list|()
expr_stmt|;
name|alloc_test
argument_list|()
expr_stmt|;
name|regional_test
argument_list|()
expr_stmt|;
name|lruhash_test
argument_list|()
expr_stmt|;
name|slabhash_test
argument_list|()
expr_stmt|;
name|infra_test
argument_list|()
expr_stmt|;
name|msgparse_test
argument_list|()
expr_stmt|;
name|checklock_stop
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"%d checks ok.\n"
argument_list|,
name|testcount
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
if|#
directive|if
name|defined
argument_list|(
name|USE_GOST
argument_list|)
operator|&&
name|defined
argument_list|(
name|HAVE_LDNS_KEY_EVP_UNLOAD_GOST
argument_list|)
name|ldns_key_EVP_unload_gost
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_OPENSSL_CONFIG
name|EVP_cleanup
argument_list|()
expr_stmt|;
name|ENGINE_cleanup
argument_list|()
expr_stmt|;
name|CONF_modules_free
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|CRYPTO_cleanup_all_ex_data
argument_list|()
expr_stmt|;
name|ERR_remove_state
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ERR_free_strings
argument_list|()
expr_stmt|;
name|RAND_cleanup
argument_list|()
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|HAVE_NSS
argument_list|)
if|if
condition|(
name|NSS_Shutdown
argument_list|()
operator|!=
name|SECSuccess
condition|)
name|fatal_exit
argument_list|(
literal|"could not shutdown NSS"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SSL or HAVE_NSS */
ifdef|#
directive|ifdef
name|HAVE_PTHREAD
comment|/* dlopen frees its thread specific state */
name|pthread_exit
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

end_unit


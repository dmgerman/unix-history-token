begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * makettyn - make a fast version of ttyn for version 6 UNIX systems  *  * Bill Joy UCB August 16, 1977  */
end_comment

begin_struct
struct|struct
name|T
block|{
name|char
name|Tmajor
decl_stmt|,
name|Tminor
decl_stmt|;
name|char
name|Ttty
decl_stmt|;
block|}
name|ttys
index|[
literal|128
index|]
struct|;
end_struct

begin_struct
struct|struct
name|Stat
block|{
name|char
name|xminor
decl_stmt|,
name|xmajor
decl_stmt|;
name|int
name|inumber
decl_stmt|,
name|flags
decl_stmt|;
name|char
name|nlinks
decl_stmt|,
name|uid
decl_stmt|,
name|gid
decl_stmt|,
name|size0
decl_stmt|;
name|int
name|size1
decl_stmt|;
name|char
name|dminor
decl_stmt|,
name|dmajor
decl_stmt|;
name|int
name|addr1
index|[
literal|7
index|]
decl_stmt|;
name|long
name|actime
decl_stmt|,
name|modtime
decl_stmt|;
block|}
name|stbuf
struct|;
end_struct

begin_function_decl
name|int
name|cmptty
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|int
name|fout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tvec
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|struct
name|T
modifier|*
name|tp
decl_stmt|;
name|struct
name|T
modifier|*
name|lastp
decl_stmt|;
name|int
name|c
decl_stmt|,
name|m
decl_stmt|,
name|n
decl_stmt|,
name|k
decl_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|fout
operator|=
name|creat
argument_list|(
literal|"Ttyn.c"
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
if|if
condition|(
name|fout
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"Ttyn.c"
argument_list|)
operator|,
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|fout
operator|=
name|dup
argument_list|(
name|fout
argument_list|)
expr_stmt|;
name|time
argument_list|(
name|tvec
argument_list|)
expr_stmt|;
for|for
control|(
name|tp
operator|=
operator|&
name|ttys
index|[
literal|0
index|]
operator|,
name|c
operator|=
literal|1
init|;
name|c
operator|<=
literal|0177
condition|;
name|c
operator|++
control|)
block|{
if|if
condition|(
name|c
operator|==
literal|'/'
condition|)
continue|continue;
name|cp
operator|=
literal|"/dev/ttyx"
expr_stmt|;
name|cp
index|[
literal|8
index|]
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|cp
argument_list|,
operator|&
name|stbuf
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
name|tp
operator|->
name|Tminor
operator|=
name|stbuf
operator|.
name|dminor
expr_stmt|;
name|tp
operator|->
name|Tmajor
operator|=
name|stbuf
operator|.
name|dmajor
expr_stmt|;
name|tp
operator|->
name|Ttty
operator|=
name|c
expr_stmt|;
name|tp
operator|++
expr_stmt|;
block|}
name|lastp
operator|=
name|tp
expr_stmt|;
name|qsort
argument_list|(
operator|&
name|ttys
argument_list|,
name|lastp
operator|-
operator|&
name|ttys
argument_list|,
sizeof|sizeof
name|ttys
index|[
literal|0
index|]
argument_list|,
name|cmptty
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#\n\ #\n\ /*\n\  * Ttyn - a fast version of ttyn which hashes major minor device numbers\n\  *\n\  * Bill Joy UCB August 17, 1977\n\  *\n\  * This routine can be called instead of calling 'ttyn' and stats\n\  * the specified unit, then looking in a table to determine\n\  * the unit number.  If the given unit is not in the table the standard\n\  * 'ttyn' is called to get the answer.\n\  *\n\  * Generated:\t%s\  * No. ttys:\t%d\n\  */\n"
argument_list|,
name|ctime
argument_list|(
name|tvec
argument_list|)
argument_list|,
name|lastp
operator|-
operator|&
name|ttys
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\ static\tstruct T {\n\ 	char	Tmajor;\n\ 	char	Tfirst;\n\ 	char 	*Tttys;\n\ 	char	Tlast;\n\ } Tttyinfo[] {\n\ "
argument_list|)
expr_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|tp
operator|=
operator|&
name|ttys
index|[
literal|0
index|]
init|;
name|tp
operator|<
name|lastp
condition|;
control|)
block|{
name|k
operator|++
expr_stmt|;
name|m
operator|=
name|tp
operator|->
name|Tmajor
expr_stmt|;
name|n
operator|=
name|tp
operator|->
name|Tminor
expr_stmt|;
name|printf
argument_list|(
literal|"\t%d,\t%d,\t\""
argument_list|,
name|m
argument_list|,
name|tp
operator|->
name|Tminor
argument_list|)
expr_stmt|;
do|do
block|{
while|while
condition|(
name|n
operator|<
name|tp
operator|->
name|Tminor
condition|)
name|n
operator|++
operator|,
name|putchar
argument_list|(
literal|'x'
argument_list|)
expr_stmt|;
name|putq
argument_list|(
name|tp
operator|->
name|Ttty
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
name|tp
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|tp
operator|<
name|lastp
operator|&&
name|tp
operator|->
name|Tmajor
operator|==
name|m
condition|)
do|;
name|printf
argument_list|(
literal|"\",\t%d,\n"
argument_list|,
name|n
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"};\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n#define\tNMAJDEV\t%d\n"
argument_list|,
name|k
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\ \n\ struct	Stat {\n\ 	char	xminor, xmajor;\n\ 	int	inumber, flags;\n\ 	char	nlinks, uid, gid, size0;\n\ 	int	size1;\n\ 	char	dminor, dmajor;\n\ 	int	addr1[7];\n\ 	long	actime, modtime;\n\ };\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\ \n\ Ttyn(unit)\n\ 	int unit;\n\ {\n\ 	register struct T *tp;\n\ 	struct Stat stbuf;\n\ \n\ 	if (fstat(unit,&stbuf))\n\ 		return ('x');\n\ 	for (tp =&Tttyinfo; tp<&Tttyinfo[NMAJDEV]; tp++)\n\ 		if (stbuf.dmajor == tp->Tmajor&& stbuf.dminor>= tp->Tfirst&& stbuf.dminor<= tp->Tlast)\n\ 			return (tp->Tttys[stbuf.dminor - tp->Tfirst]);\n\ 	return (ttyn(unit));\n\ }\n"
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|cmptty
argument_list|(
name|ftp
argument_list|,
name|ltp
argument_list|)
specifier|register
expr|struct
name|T
operator|*
name|ftp
operator|,
operator|*
name|ltp
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|ftp
operator|->
name|Tmajor
operator|==
name|ltp
operator|->
name|Tmajor
condition|)
return|return
operator|(
name|ftp
operator|->
name|Tminor
operator|-
name|ltp
operator|->
name|Tminor
operator|)
return|;
return|return
operator|(
name|ftp
operator|->
name|Tmajor
operator|-
name|ltp
operator|->
name|Tmajor
operator|)
return|;
block|}
end_block

begin_macro
name|putq
argument_list|(
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|int
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|c
operator|>=
literal|' '
condition|)
block|{
name|putchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"\\%d%d%d"
argument_list|,
name|c
operator|>>
literal|6
argument_list|,
operator|(
name|c
operator|>>
literal|3
operator|)
operator|&
literal|07
argument_list|,
name|c
operator|&
literal|07
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


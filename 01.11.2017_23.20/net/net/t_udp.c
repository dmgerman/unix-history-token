begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$NetBSD: t_udp.c,v 1.2 2013/01/06 02:22:50 christos Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<atf-c.h>
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
name|msg
index|[]
init|=
literal|"sendto test"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|sendit
parameter_list|(
name|int
name|family
parameter_list|)
block|{
name|struct
name|addrinfo
name|hints
decl_stmt|;
name|struct
name|addrinfo
modifier|*
name|res
decl_stmt|;
name|int
name|S
decl_stmt|,
name|s
decl_stmt|;
name|int
name|e
decl_stmt|;
comment|/* lookup localhost addr, depending on argv[1] */
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|family
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_DGRAM
expr_stmt|;
name|hints
operator|.
name|ai_protocol
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|hints
operator|.
name|ai_flags
operator|=
literal|0
expr_stmt|;
name|e
operator|=
name|getaddrinfo
argument_list|(
literal|"localhost"
argument_list|,
literal|"9999"
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|e
operator|==
literal|0
argument_list|,
literal|"getaddrinfo AF=%d: %s"
argument_list|,
name|family
argument_list|,
name|gai_strerror
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
comment|/* server socket */
name|S
operator|=
name|socket
argument_list|(
name|res
operator|->
name|ai_family
argument_list|,
name|res
operator|->
name|ai_socktype
argument_list|,
name|res
operator|->
name|ai_protocol
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|S
operator|>=
literal|0
argument_list|,
literal|"server-socket AF=%d: %s"
argument_list|,
name|family
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|=
name|bind
argument_list|(
name|S
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|e
operator|==
literal|0
argument_list|,
literal|"bind AF=%d: %s"
argument_list|,
name|family
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* client socket */
name|s
operator|=
name|socket
argument_list|(
name|res
operator|->
name|ai_family
argument_list|,
name|res
operator|->
name|ai_socktype
argument_list|,
name|res
operator|->
name|ai_protocol
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|s
operator|>=
literal|0
argument_list|,
literal|"client-socket AF=%d: %s"
argument_list|,
name|family
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* sendto */
name|e
operator|=
name|sendto
argument_list|(
name|s
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|0
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|e
operator|==
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|"sendto(1) AF=%d: %s"
argument_list|,
name|family
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|=
name|sendto
argument_list|(
name|s
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|0
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|e
operator|==
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|"sendto(2) AF=%d: %s"
argument_list|,
name|family
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* connect + send */
name|e
operator|=
name|connect
argument_list|(
name|s
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|e
operator|==
literal|0
argument_list|,
literal|"connect(1) AF=%d: %s"
argument_list|,
name|family
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|=
name|send
argument_list|(
name|s
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|e
operator|==
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|"send(1) AF=%d: %s"
argument_list|,
name|family
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|=
name|connect
argument_list|(
name|s
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|e
operator|==
literal|0
argument_list|,
literal|"connect(2) AF=%d: %s"
argument_list|,
name|family
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|=
name|send
argument_list|(
name|s
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|e
operator|==
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|"send(2) AF=%d: %s"
argument_list|,
name|family
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|ATF_TC
argument_list|(
name|udp4_send
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|udp4_send
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Check that inet4 udp send works both"
literal|" for connected and unconnected sockets"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|udp4_send
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|sendit
argument_list|(
name|AF_INET
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|udp6_send
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|udp6_send
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Check that inet6 udp send works both"
literal|" for connected and unconnected sockets"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|udp6_send
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|sendit
argument_list|(
name|AF_INET6
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TP_ADD_TCS
argument_list|(
argument|tp
argument_list|)
end_macro

begin_block
block|{
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|udp4_send
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|udp6_send
argument_list|)
expr_stmt|;
return|return
name|atf_no_error
argument_list|()
return|;
block|}
end_block

end_unit


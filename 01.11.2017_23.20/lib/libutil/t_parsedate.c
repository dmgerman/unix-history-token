begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $NetBSD: t_parsedate.c,v 1.25 2016/06/22 15:01:38 kre Exp $ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2010, 2015 The NetBSD Foundation, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE  * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$NetBSD: t_parsedate.c,v 1.25 2016/06/22 15:01:38 kre Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<atf-c.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<util.h>
end_include

begin_comment
comment|/*  * ANY is used as a placeholder for values that do not need to be  * checked.  The actual value is arbitrary.  We don't use -1  * because some tests might want to use -1 as a literal value.  */
end_comment

begin_define
define|#
directive|define
name|ANY
value|-30215
end_define

begin_comment
comment|/* parsecheck --  * call parsedate(), then call time_to_tm() on the result,  * and check that year/month/day/hour/minute/second are as expected.  *  * time_to_tm should usually be localtime_r or gmtime_r.  *  * Don't check values specified as ANY.  */
end_comment

begin_decl_stmt
specifier|static
name|void
name|parsecheck
argument_list|(
specifier|const
name|char
operator|*
name|datestr
argument_list|,
specifier|const
name|time_t
operator|*
name|reftime
argument_list|,
specifier|const
name|int
operator|*
name|zoff
argument_list|,
expr|struct
name|tm
operator|*
name|time_to_tm
argument_list|(
specifier|const
name|time_t
operator|*
argument_list|,
expr|struct
name|tm
operator|*
argument_list|)
argument_list|,
name|int
name|year
argument_list|,
name|int
name|month
argument_list|,
name|int
name|day
argument_list|,
name|int
name|hour
argument_list|,
name|int
name|minute
argument_list|,
name|int
name|second
argument_list|)
block|{
name|time_t
name|t
decl_stmt|;
name|struct
name|tm
name|tm
decl_stmt|;
name|char
name|argstr
index|[
literal|128
index|]
decl_stmt|;
comment|/* 	 * printable version of the args. 	 * 	 * Note that printf("%.*d", 0, 0)) prints nothing at all, 	 * while printf("%.*d", 1, val) prints the value as usual. 	 */
name|snprintf
argument_list|(
name|argstr
argument_list|,
sizeof|sizeof
argument_list|(
name|argstr
argument_list|)
argument_list|,
literal|"%s%s%s, %s%.*jd, %s%.*d"
argument_list|,
comment|/* NULL or \"<datestr>\" */
operator|(
name|datestr
condition|?
literal|"\""
else|:
literal|""
operator|)
argument_list|,
operator|(
name|datestr
condition|?
name|datestr
else|:
literal|"NULL"
operator|)
argument_list|,
operator|(
name|datestr
condition|?
literal|"\""
else|:
literal|""
operator|)
argument_list|,
comment|/* NULL or *reftime */
operator|(
name|reftime
condition|?
literal|""
else|:
literal|"NULL"
operator|)
argument_list|,
operator|(
name|reftime
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|,
operator|(
name|reftime
condition|?
operator|(
name|intmax_t
operator|)
operator|*
name|reftime
else|:
operator|(
name|intmax_t
operator|)
literal|0
operator|)
argument_list|,
comment|/* NULL or *zoff */
operator|(
name|zoff
condition|?
literal|""
else|:
literal|"NULL"
operator|)
argument_list|,
operator|(
name|zoff
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|,
operator|(
name|zoff
condition|?
operator|*
name|zoff
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_MSG
argument_list|(
operator|(
name|t
operator|=
name|parsedate
argument_list|(
name|datestr
argument_list|,
name|reftime
argument_list|,
name|zoff
argument_list|)
operator|)
operator|!=
operator|-
literal|1
argument_list|,
literal|"parsedate(%s) returned -1\n"
argument_list|,
name|argstr
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|time_to_tm
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|year
operator|!=
name|ANY
condition|)
name|ATF_CHECK_MSG
argument_list|(
name|tm
operator|.
name|tm_year
operator|+
literal|1900
operator|==
name|year
argument_list|,
literal|"parsedate(%s) expected year %d got %d (+1900)\n"
argument_list|,
name|argstr
argument_list|,
name|year
argument_list|,
operator|(
name|int
operator|)
name|tm
operator|.
name|tm_year
argument_list|)
expr_stmt|;
if|if
condition|(
name|month
operator|!=
name|ANY
condition|)
name|ATF_CHECK_MSG
argument_list|(
name|tm
operator|.
name|tm_mon
operator|+
literal|1
operator|==
name|month
argument_list|,
literal|"parsedate(%s) expected month %d got %d (+1)\n"
argument_list|,
name|argstr
argument_list|,
name|month
argument_list|,
operator|(
name|int
operator|)
name|tm
operator|.
name|tm_mon
argument_list|)
expr_stmt|;
if|if
condition|(
name|day
operator|!=
name|ANY
condition|)
name|ATF_CHECK_MSG
argument_list|(
name|tm
operator|.
name|tm_mday
operator|==
name|day
argument_list|,
literal|"parsedate(%s) expected day %d got %d\n"
argument_list|,
name|argstr
argument_list|,
name|day
argument_list|,
operator|(
name|int
operator|)
name|tm
operator|.
name|tm_mday
argument_list|)
expr_stmt|;
if|if
condition|(
name|hour
operator|!=
name|ANY
condition|)
name|ATF_CHECK_MSG
argument_list|(
name|tm
operator|.
name|tm_hour
operator|==
name|hour
argument_list|,
literal|"parsedate(%s) expected hour %d got %d\n"
argument_list|,
name|argstr
argument_list|,
name|hour
argument_list|,
operator|(
name|int
operator|)
name|tm
operator|.
name|tm_hour
argument_list|)
expr_stmt|;
if|if
condition|(
name|minute
operator|!=
name|ANY
condition|)
name|ATF_CHECK_MSG
argument_list|(
name|tm
operator|.
name|tm_min
operator|==
name|minute
argument_list|,
literal|"parsedate(%s) expected minute %d got %d\n"
argument_list|,
name|argstr
argument_list|,
name|minute
argument_list|,
operator|(
name|int
operator|)
name|tm
operator|.
name|tm_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|second
operator|!=
name|ANY
condition|)
name|ATF_CHECK_MSG
argument_list|(
name|tm
operator|.
name|tm_sec
operator|==
name|second
argument_list|,
literal|"parsedate(%s) expected second %d got %d\n"
argument_list|,
name|argstr
argument_list|,
name|second
argument_list|,
operator|(
name|int
operator|)
name|tm
operator|.
name|tm_sec
argument_list|)
expr_stmt|;
block|}
end_decl_stmt

begin_expr_stmt
name|ATF_TC
argument_list|(
name|dates
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|dates
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test unambiguous dates"
literal|" (PR lib/44255)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|dates
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|parsecheck
argument_list|(
literal|"9/10/69"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|2069
argument_list|,
literal|9
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* year< 70: add 2000 */
name|parsecheck
argument_list|(
literal|"9/10/70"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|1970
argument_list|,
literal|9
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 70<= year< 100: add 1900 */
name|parsecheck
argument_list|(
literal|"69-09-10"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|69
argument_list|,
literal|9
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* ISO8601 year remains unchanged */
name|parsecheck
argument_list|(
literal|"70-09-10"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|70
argument_list|,
literal|9
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* ISO8601 year remains unchanged */
name|parsecheck
argument_list|(
literal|"2006-11-17"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|2006
argument_list|,
literal|11
argument_list|,
literal|17
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"10/1/2000"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|2000
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* month/day/year */
name|parsecheck
argument_list|(
literal|"20 Jun 1994"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|1994
argument_list|,
literal|6
argument_list|,
literal|20
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"97 September 2"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|1997
argument_list|,
literal|9
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"23jun2001"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|2001
argument_list|,
literal|6
argument_list|,
literal|23
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"1-sep-06"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|2006
argument_list|,
literal|9
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"1/11"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
name|ANY
argument_list|,
literal|1
argument_list|,
literal|11
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* month/day */
name|parsecheck
argument_list|(
literal|"1500-01-02"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|1500
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"9999-12-21"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|9999
argument_list|,
literal|12
argument_list|,
literal|21
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015.12.07.08.07.35"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|7
argument_list|,
literal|8
argument_list|,
literal|7
argument_list|,
literal|35
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|times
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|times
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test times"
literal|" (PR lib/44255)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|times
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|parsecheck
argument_list|(
literal|"10:01"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"10:12pm"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
literal|22
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"12:11:01.000012"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
literal|12
argument_list|,
literal|11
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"12:21-0500"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
literal|12
operator|+
literal|5
argument_list|,
literal|21
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* numeric zones not permitted with am/pm ... */
name|parsecheck
argument_list|(
literal|"7 a.m. ICT"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
literal|7
operator|-
literal|7
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"midnight"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"mn"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"noon"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|dsttimes
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|dsttimes
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test DST transition times"
literal|" (PR lib/47916)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|dsttimes
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|tm
name|tm
decl_stmt|;
name|time_t
name|t
decl_stmt|;
name|int
name|tzoff
decl_stmt|;
name|putenv
argument_list|(
name|__UNCONST
argument_list|(
literal|"TZ=EST"
argument_list|)
argument_list|)
expr_stmt|;
name|tzset
argument_list|()
expr_stmt|;
name|parsecheck
argument_list|(
literal|"12:0"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putenv
argument_list|(
name|__UNCONST
argument_list|(
literal|"TZ=Asia/Tokyo"
argument_list|)
argument_list|)
expr_stmt|;
name|tzset
argument_list|()
expr_stmt|;
name|parsecheck
argument_list|(
literal|"12:0"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
name|ANY
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * When the effective local time is Tue Jul  9 13:21:53 BST 2013, 	 * check mktime("14:00") 	 */
name|putenv
argument_list|(
name|__UNCONST
argument_list|(
literal|"TZ=Europe/London"
argument_list|)
argument_list|)
expr_stmt|;
name|tzset
argument_list|()
expr_stmt|;
name|tm
operator|=
operator|(
expr|struct
name|tm
operator|)
block|{
operator|.
name|tm_year
operator|=
literal|2013
operator|-
literal|1900
block|,
operator|.
name|tm_mon
operator|=
literal|7
operator|-
literal|1
block|,
operator|.
name|tm_mday
operator|=
literal|9
block|,
operator|.
name|tm_hour
operator|=
literal|13
block|,
operator|.
name|tm_min
operator|=
literal|21
block|,
operator|.
name|tm_sec
operator|=
literal|53
block|,
operator|.
name|tm_isdst
operator|=
literal|0
block|}
expr_stmt|;
name|t
operator|=
name|mktime
argument_list|(
operator|&
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|t
operator|!=
operator|(
name|time_t
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"14:00"
argument_list|,
operator|&
name|t
argument_list|,
name|NULL
argument_list|,
name|localtime_r
argument_list|,
literal|2013
argument_list|,
literal|7
argument_list|,
literal|9
argument_list|,
literal|14
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tzoff
operator|=
operator|-
literal|60
expr_stmt|;
comment|/* British Summer Time */
name|parsecheck
argument_list|(
literal|"14:00"
argument_list|,
operator|&
name|t
argument_list|,
operator|&
name|tzoff
argument_list|,
name|localtime_r
argument_list|,
literal|2013
argument_list|,
literal|7
argument_list|,
literal|9
argument_list|,
literal|14
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|relative
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|relative
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test relative items"
literal|" (PR lib/44255)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|relative
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|tm
name|tm
decl_stmt|;
name|time_t
name|now
decl_stmt|;
define|#
directive|define
name|REL_CHECK
parameter_list|(
name|s
parameter_list|,
name|now
parameter_list|,
name|tm
parameter_list|)
value|do {					\ 	time_t p, q;							\ 	char nb[30], pb[30], qb[30];					\ 	p = parsedate(s,&now, NULL);					\ 	q = mktime(&tm);						\ 	ATF_CHECK_EQ_MSG(p, q,						\ 	    "From %jd (%24.24s) using \"%s\", obtained %jd (%24.24s); expected %jd (%24.24s)", \ 	    (uintmax_t)now, ctime_r(&now, nb),				\ 	    s, (uintmax_t)p, ctime_r(&p, pb), (uintmax_t)q, 		\ 	    ctime_r(&q, qb));						\     } while (
comment|/*CONSTCOND*/
value|0)
define|#
directive|define
name|isleap
parameter_list|(
name|yr
parameter_list|)
value|(((yr)& 3) == 0&& (((yr) % 100) != 0 ||		\ 			((1900+(yr)) % 400) == 0))
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"-1 month"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"last friday"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"one week ago"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"this thursday"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"next sunday"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"+2 years"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Test relative to a number of fixed dates.  Avoid the 	 * edges of the time_t range to avert under- or overflow 	 * of the relative date, and use a prime step for maximum 	 * coverage of different times of day/week/month/year. 	 */
for|for
control|(
name|now
operator|=
literal|0x00FFFFFF
init|;
name|now
operator|<
literal|0xFF000000
condition|;
name|now
operator|+=
literal|3777779
control|)
block|{
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|--
expr_stmt|;
comment|/* "yesterday" leaves time untouched */
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"yesterday"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|++
expr_stmt|;
comment|/* as does "tomorrow" */
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"tomorrow"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tm
operator|.
name|tm_wday
operator|>
literal|4
condition|)
name|tm
operator|.
name|tm_mday
operator|+=
literal|7
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|+=
literal|4
operator|-
name|tm
operator|.
name|tm_wday
expr_stmt|;
comment|/* if a day name is mentioned, it means midnight (by default) */
name|tm
operator|.
name|tm_sec
operator|=
name|tm
operator|.
name|tm_min
operator|=
name|tm
operator|.
name|tm_hour
operator|=
literal|0
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"this thursday"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|+=
literal|14
operator|-
operator|(
name|tm
operator|.
name|tm_wday
condition|?
name|tm
operator|.
name|tm_wday
else|:
literal|7
operator|)
expr_stmt|;
name|tm
operator|.
name|tm_sec
operator|=
name|tm
operator|.
name|tm_min
operator|=
name|tm
operator|.
name|tm_hour
operator|=
literal|0
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"next sunday"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tm
operator|.
name|tm_wday
operator|<=
literal|5
condition|)
name|tm
operator|.
name|tm_mday
operator|-=
literal|7
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|+=
literal|5
operator|-
name|tm
operator|.
name|tm_wday
expr_stmt|;
name|tm
operator|.
name|tm_sec
operator|=
name|tm
operator|.
name|tm_min
operator|=
literal|0
expr_stmt|;
name|tm
operator|.
name|tm_hour
operator|=
literal|16
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"last friday 4 p.m."
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|+=
literal|14
expr_stmt|;
if|if
condition|(
name|tm
operator|.
name|tm_wday
operator|>
literal|3
condition|)
name|tm
operator|.
name|tm_mday
operator|+=
literal|7
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|+=
literal|3
operator|-
name|tm
operator|.
name|tm_wday
expr_stmt|;
name|tm
operator|.
name|tm_sec
operator|=
name|tm
operator|.
name|tm_min
operator|=
literal|0
expr_stmt|;
name|tm
operator|.
name|tm_hour
operator|=
literal|3
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"we fortnight 3 a.m."
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_min
operator|-=
literal|5
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"5 minutes ago"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_hour
operator|++
expr_stmt|;
name|tm
operator|.
name|tm_min
operator|+=
literal|37
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"97 minutes"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_mon
operator|++
expr_stmt|;
if|if
condition|(
name|tm
operator|.
name|tm_mon
operator|==
literal|1
operator|&&
name|tm
operator|.
name|tm_mday
operator|>
literal|28
operator|+
name|isleap
argument_list|(
name|tm
operator|.
name|tm_year
argument_list|)
condition|)
name|tm
operator|.
name|tm_mday
operator|=
literal|28
operator|+
name|isleap
argument_list|(
name|tm
operator|.
name|tm_year
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|tm
operator|.
name|tm_mon
operator|==
literal|3
operator|||
name|tm
operator|.
name|tm_mon
operator|==
literal|5
operator|||
name|tm
operator|.
name|tm_mon
operator|==
literal|8
operator|||
name|tm
operator|.
name|tm_mon
operator|==
literal|10
operator|)
operator|&&
name|tm
operator|.
name|tm_mday
operator|==
literal|31
condition|)
name|tm
operator|.
name|tm_mday
operator|=
literal|30
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"month"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_mon
operator|+=
literal|2
expr_stmt|;
comment|/* "next" means add 2 ... */
if|if
condition|(
name|tm
operator|.
name|tm_mon
operator|==
literal|13
operator|&&
name|tm
operator|.
name|tm_mday
operator|>
literal|28
operator|+
name|isleap
argument_list|(
name|tm
operator|.
name|tm_year
operator|+
literal|1
argument_list|)
condition|)
name|tm
operator|.
name|tm_mday
operator|=
literal|28
operator|+
name|isleap
argument_list|(
name|tm
operator|.
name|tm_year
operator|+
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tm
operator|.
name|tm_mon
operator|==
literal|8
operator|&&
name|tm
operator|.
name|tm_mday
operator|==
literal|31
condition|)
name|tm
operator|.
name|tm_mday
operator|=
literal|30
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"next month"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_mon
operator|--
expr_stmt|;
if|if
condition|(
name|tm
operator|.
name|tm_mon
operator|==
literal|1
operator|&&
name|tm
operator|.
name|tm_mday
operator|>
literal|28
operator|+
name|isleap
argument_list|(
name|tm
operator|.
name|tm_year
argument_list|)
condition|)
name|tm
operator|.
name|tm_mday
operator|=
literal|28
operator|+
name|isleap
argument_list|(
name|tm
operator|.
name|tm_year
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|tm
operator|.
name|tm_mon
operator|==
literal|3
operator|||
name|tm
operator|.
name|tm_mon
operator|==
literal|5
operator|||
name|tm
operator|.
name|tm_mon
operator|==
literal|8
operator|||
name|tm
operator|.
name|tm_mon
operator|==
literal|10
operator|)
operator|&&
name|tm
operator|.
name|tm_mday
operator|==
literal|31
condition|)
name|tm
operator|.
name|tm_mday
operator|=
literal|30
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"last month"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_mon
operator|+=
literal|6
expr_stmt|;
if|if
condition|(
name|tm
operator|.
name|tm_mon
operator|==
literal|13
operator|&&
name|tm
operator|.
name|tm_mday
operator|>
literal|28
operator|+
name|isleap
argument_list|(
name|tm
operator|.
name|tm_year
operator|+
literal|1
argument_list|)
condition|)
name|tm
operator|.
name|tm_mday
operator|=
literal|28
operator|+
name|isleap
argument_list|(
name|tm
operator|.
name|tm_year
operator|+
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|tm
operator|.
name|tm_mon
operator|==
literal|15
operator|||
name|tm
operator|.
name|tm_mon
operator|==
literal|17
operator|||
name|tm
operator|.
name|tm_mon
operator|==
literal|8
operator|||
name|tm
operator|.
name|tm_mon
operator|==
literal|10
operator|)
operator|&&
name|tm
operator|.
name|tm_mday
operator|==
literal|31
condition|)
name|tm
operator|.
name|tm_mday
operator|=
literal|30
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|+=
literal|2
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"+6 months 2 days"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_mon
operator|-=
literal|9
expr_stmt|;
if|if
condition|(
name|tm
operator|.
name|tm_mon
operator|==
literal|1
operator|&&
name|tm
operator|.
name|tm_mday
operator|>
literal|28
operator|+
name|isleap
argument_list|(
name|tm
operator|.
name|tm_year
argument_list|)
condition|)
name|tm
operator|.
name|tm_mday
operator|=
literal|28
operator|+
name|isleap
argument_list|(
name|tm
operator|.
name|tm_year
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|tm
operator|.
name|tm_mon
operator|==
operator|-
literal|9
operator|||
name|tm
operator|.
name|tm_mon
operator|==
operator|-
literal|7
operator|||
name|tm
operator|.
name|tm_mon
operator|==
operator|-
literal|2
operator|)
operator|&&
name|tm
operator|.
name|tm_mday
operator|==
literal|31
condition|)
name|tm
operator|.
name|tm_mday
operator|=
literal|30
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"9 months ago"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tm
operator|.
name|tm_wday
operator|<=
literal|2
condition|)
name|tm
operator|.
name|tm_mday
operator|-=
literal|7
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|+=
literal|2
operator|-
name|tm
operator|.
name|tm_wday
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|tm
operator|.
name|tm_hour
operator|=
name|tm
operator|.
name|tm_min
operator|=
name|tm
operator|.
name|tm_sec
operator|=
literal|0
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"1 week ago Tu"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|++
expr_stmt|;
name|tm
operator|.
name|tm_hour
operator|=
name|tm
operator|.
name|tm_min
operator|=
name|tm
operator|.
name|tm_sec
operator|=
literal|0
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"midnight tomorrow"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|++
expr_stmt|;
name|tm
operator|.
name|tm_hour
operator|=
name|tm
operator|.
name|tm_min
operator|=
name|tm
operator|.
name|tm_sec
operator|=
literal|0
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"tomorrow midnight"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|++
expr_stmt|;
name|tm
operator|.
name|tm_hour
operator|=
literal|12
expr_stmt|;
name|tm
operator|.
name|tm_min
operator|=
name|tm
operator|.
name|tm_sec
operator|=
literal|0
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"noon tomorrow"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tm
operator|.
name|tm_wday
operator|>
literal|2
condition|)
name|tm
operator|.
name|tm_mday
operator|+=
literal|7
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|+=
literal|2
operator|-
name|tm
operator|.
name|tm_wday
expr_stmt|;
name|tm
operator|.
name|tm_sec
operator|=
name|tm
operator|.
name|tm_min
operator|=
name|tm
operator|.
name|tm_hour
operator|=
literal|0
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"midnight Tuesday"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|localtime_r
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|tm
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tm
operator|.
name|tm_wday
operator|>
literal|2
operator|+
literal|1
condition|)
name|tm
operator|.
name|tm_mday
operator|+=
literal|7
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|+=
literal|2
operator|-
name|tm
operator|.
name|tm_wday
expr_stmt|;
name|tm
operator|.
name|tm_mday
operator|++
expr_stmt|;
comment|/* xxx midnight --> the next day */
name|tm
operator|.
name|tm_sec
operator|=
name|tm
operator|.
name|tm_min
operator|=
name|tm
operator|.
name|tm_hour
operator|=
literal|0
expr_stmt|;
name|tm
operator|.
name|tm_isdst
operator|=
operator|-
literal|1
expr_stmt|;
name|REL_CHECK
argument_list|(
literal|"Tuesday midnight"
argument_list|,
name|now
argument_list|,
name|tm
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|atsecs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|atsecs
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test seconds past the epoch"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|atsecs
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|tzoff
decl_stmt|;
comment|/* "@0" -> (time_t)0, regardless of timezone */
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|putenv
argument_list|(
name|__UNCONST
argument_list|(
literal|"TZ=Europe/Berlin"
argument_list|)
argument_list|)
expr_stmt|;
name|tzset
argument_list|()
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|putenv
argument_list|(
name|__UNCONST
argument_list|(
literal|"TZ=America/New_York"
argument_list|)
argument_list|)
expr_stmt|;
name|tzset
argument_list|()
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|tzoff
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
operator|&
name|tzoff
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|tzoff
operator|=
literal|3600
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
operator|&
name|tzoff
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|tzoff
operator|=
operator|-
literal|3600
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@0"
argument_list|,
name|NULL
argument_list|,
operator|&
name|tzoff
argument_list|)
operator|==
operator|(
name|time_t
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|/* -1 or other negative numbers are not errors */
name|errno
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@-1"
argument_list|,
name|NULL
argument_list|,
operator|&
name|tzoff
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
operator|&&
name|errno
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@-2"
argument_list|,
name|NULL
argument_list|,
operator|&
name|tzoff
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|2
operator|&&
name|errno
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* junk is an error */
name|errno
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"@junk"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
operator|&&
name|errno
operator|!=
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|zones
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|zones
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test parsing dates with zones"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|zones
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 UTC"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|16
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 UT"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|16
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 GMT"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|16
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 +0000"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|16
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 -0500"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|21
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 EST"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|21
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 EDT"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|20
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 +0500"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|11
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 +1000"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 AEST"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|6
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 -1000"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|7
argument_list|,
literal|2
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 HST"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|7
argument_list|,
literal|2
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 AWST"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|8
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 16:11:48 NZDT"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|3
argument_list|,
literal|11
argument_list|,
literal|48
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"Sun, 6 Dec 2015 09:43:16 -0500"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|14
argument_list|,
literal|43
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"Mon Dec  7 03:13:31 ICT 2015"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|20
argument_list|,
literal|13
argument_list|,
literal|31
argument_list|)
expr_stmt|;
comment|/* the day name is ignored when a day of month (etc) is given... */
name|parsecheck
argument_list|(
literal|"Sat Dec  7 03:13:31 ICT 2015"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|20
argument_list|,
literal|13
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 12:00:00 IDLW"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 12:00:00 IDLE"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 21:17:33 NFT"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|,
literal|47
argument_list|,
literal|33
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 21:17:33 ACST"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|11
argument_list|,
literal|47
argument_list|,
literal|33
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 21:17:33 +0717"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|14
argument_list|,
literal|0
argument_list|,
literal|33
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 21:21:21 Z"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 21:21:21 A"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|22
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 21:21:21 G"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|7
argument_list|,
literal|4
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 21:21:21 M"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|7
argument_list|,
literal|9
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 21:21:21 N"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|20
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 21:21:21 T"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|14
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
expr_stmt|;
name|parsecheck
argument_list|(
literal|"2015-12-06 21:21:21 Y"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gmtime_r
argument_list|,
literal|2015
argument_list|,
literal|12
argument_list|,
literal|6
argument_list|,
literal|9
argument_list|,
literal|21
argument_list|,
literal|21
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC
argument_list|(
name|gibberish
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|gibberish
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"Test (not) parsing nonsense"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|gibberish
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|errno
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"invalid nonsense"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
operator|&&
name|errno
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"12th day of Christmas"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
operator|&&
name|errno
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"2015-31-07 15:00"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
operator|&&
name|errno
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"2015-02-29 10:01"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
operator|&&
name|errno
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"2015-12-06 24:01"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
operator|&&
name|errno
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|parsedate
argument_list|(
literal|"2015-12-06 14:61"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
operator|&&
name|errno
operator|!=
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TP_ADD_TCS
argument_list|(
argument|tp
argument_list|)
end_macro

begin_block
block|{
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|dates
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|times
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|dsttimes
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|relative
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|atsecs
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|zones
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|gibberish
argument_list|)
expr_stmt|;
return|return
name|atf_no_error
argument_list|()
return|;
block|}
end_block

end_unit


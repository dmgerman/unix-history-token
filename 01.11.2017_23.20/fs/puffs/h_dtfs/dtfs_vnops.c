begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: dtfs_vnops.c,v 1.10 2013/10/19 17:45:00 christos Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 2006  Antti Kantee.  All Rights Reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS  * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/poll.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<puffs.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<util.h>
end_include

begin_include
include|#
directive|include
file|"dtfs.h"
end_include

begin_function
name|int
name|dtfs_node_lookup
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|struct
name|puffs_newinfo
modifier|*
name|pni
parameter_list|,
specifier|const
name|struct
name|puffs_cn
modifier|*
name|pcn
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn_dir
init|=
name|opc
decl_stmt|;
name|struct
name|dtfs_file
modifier|*
name|df
init|=
name|DTFS_CTOF
argument_list|(
name|opc
argument_list|)
decl_stmt|;
name|struct
name|dtfs_dirent
modifier|*
name|dfd
decl_stmt|;
specifier|extern
name|int
name|straightflush
decl_stmt|;
name|int
name|rv
decl_stmt|;
comment|/* parent dir? */
if|if
condition|(
name|PCNISDOTDOT
argument_list|(
name|pcn
argument_list|)
condition|)
block|{
if|if
condition|(
name|df
operator|->
name|df_dotdot
operator|==
name|NULL
condition|)
return|return
name|ENOENT
return|;
name|assert
argument_list|(
name|df
operator|->
name|df_dotdot
operator|->
name|pn_va
operator|.
name|va_type
operator|==
name|VDIR
argument_list|)
expr_stmt|;
name|puffs_newinfo_setcookie
argument_list|(
name|pni
argument_list|,
name|df
operator|->
name|df_dotdot
argument_list|)
expr_stmt|;
name|puffs_newinfo_setvtype
argument_list|(
name|pni
argument_list|,
name|df
operator|->
name|df_dotdot
operator|->
name|pn_va
operator|.
name|va_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|dfd
operator|=
name|dtfs_dirgetbyname
argument_list|(
name|df
argument_list|,
name|pcn
operator|->
name|pcn_name
argument_list|,
name|pcn
operator|->
name|pcn_namelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|dfd
condition|)
block|{
if|if
condition|(
operator|(
name|pcn
operator|->
name|pcn_flags
operator|&
name|NAMEI_ISLASTCN
operator|)
operator|&&
operator|(
name|pcn
operator|->
name|pcn_nameiop
operator|==
name|NAMEI_DELETE
operator|)
condition|)
block|{
name|rv
operator|=
name|puffs_access
argument_list|(
name|VDIR
argument_list|,
name|pn_dir
operator|->
name|pn_va
operator|.
name|va_mode
argument_list|,
name|pn_dir
operator|->
name|pn_va
operator|.
name|va_uid
argument_list|,
name|pn_dir
operator|->
name|pn_va
operator|.
name|va_gid
argument_list|,
name|PUFFS_VWRITE
argument_list|,
name|pcn
operator|->
name|pcn_cred
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
return|return
name|rv
return|;
block|}
name|puffs_newinfo_setcookie
argument_list|(
name|pni
argument_list|,
name|dfd
operator|->
name|dfd_node
argument_list|)
expr_stmt|;
name|puffs_newinfo_setvtype
argument_list|(
name|pni
argument_list|,
name|dfd
operator|->
name|dfd_node
operator|->
name|pn_va
operator|.
name|va_type
argument_list|)
expr_stmt|;
name|puffs_newinfo_setsize
argument_list|(
name|pni
argument_list|,
name|dfd
operator|->
name|dfd_node
operator|->
name|pn_va
operator|.
name|va_size
argument_list|)
expr_stmt|;
name|puffs_newinfo_setrdev
argument_list|(
name|pni
argument_list|,
name|dfd
operator|->
name|dfd_node
operator|->
name|pn_va
operator|.
name|va_rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|straightflush
condition|)
name|puffs_flush_pagecache_node
argument_list|(
name|pu
argument_list|,
name|dfd
operator|->
name|dfd_node
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|pcn
operator|->
name|pcn_flags
operator|&
name|NAMEI_ISLASTCN
operator|)
operator|&&
operator|(
name|pcn
operator|->
name|pcn_nameiop
operator|==
name|NAMEI_CREATE
operator|||
name|pcn
operator|->
name|pcn_nameiop
operator|==
name|NAMEI_RENAME
operator|)
condition|)
block|{
name|rv
operator|=
name|puffs_access
argument_list|(
name|VDIR
argument_list|,
name|pn_dir
operator|->
name|pn_va
operator|.
name|va_mode
argument_list|,
name|pn_dir
operator|->
name|pn_va
operator|.
name|va_uid
argument_list|,
name|pn_dir
operator|->
name|pn_va
operator|.
name|va_gid
argument_list|,
name|PUFFS_VWRITE
argument_list|,
name|pcn
operator|->
name|pcn_cred
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
return|return
name|rv
return|;
block|}
return|return
name|ENOENT
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_access
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|int
name|acc_mode
parameter_list|,
specifier|const
name|struct
name|puffs_cred
modifier|*
name|pcr
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn
init|=
name|opc
decl_stmt|;
return|return
name|puffs_access
argument_list|(
name|pn
operator|->
name|pn_va
operator|.
name|va_type
argument_list|,
name|pn
operator|->
name|pn_va
operator|.
name|va_mode
argument_list|,
name|pn
operator|->
name|pn_va
operator|.
name|va_uid
argument_list|,
name|pn
operator|->
name|pn_va
operator|.
name|va_gid
argument_list|,
name|acc_mode
argument_list|,
name|pcr
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_setattr
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
specifier|const
name|struct
name|vattr
modifier|*
name|va
parameter_list|,
specifier|const
name|struct
name|puffs_cred
modifier|*
name|pcr
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn
init|=
name|opc
decl_stmt|;
name|int
name|rv
decl_stmt|;
comment|/* check permissions */
if|if
condition|(
name|va
operator|->
name|va_flags
operator|!=
name|PUFFS_VNOVAL
condition|)
return|return
name|EOPNOTSUPP
return|;
if|if
condition|(
name|va
operator|->
name|va_uid
operator|!=
name|PUFFS_VNOVAL
operator|||
name|va
operator|->
name|va_gid
operator|!=
name|PUFFS_VNOVAL
condition|)
block|{
name|rv
operator|=
name|puffs_access_chown
argument_list|(
name|pn
operator|->
name|pn_va
operator|.
name|va_uid
argument_list|,
name|pn
operator|->
name|pn_va
operator|.
name|va_gid
argument_list|,
name|va
operator|->
name|va_uid
argument_list|,
name|va
operator|->
name|va_gid
argument_list|,
name|pcr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
return|return
name|rv
return|;
block|}
if|if
condition|(
name|va
operator|->
name|va_mode
operator|!=
name|PUFFS_VNOVAL
condition|)
block|{
name|rv
operator|=
name|puffs_access_chmod
argument_list|(
name|pn
operator|->
name|pn_va
operator|.
name|va_uid
argument_list|,
name|pn
operator|->
name|pn_va
operator|.
name|va_gid
argument_list|,
name|pn
operator|->
name|pn_va
operator|.
name|va_type
argument_list|,
name|va
operator|->
name|va_mode
argument_list|,
name|pcr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
return|return
name|rv
return|;
block|}
if|if
condition|(
operator|(
name|va
operator|->
name|va_atime
operator|.
name|tv_sec
operator|!=
name|PUFFS_VNOVAL
operator|&&
name|va
operator|->
name|va_atime
operator|.
name|tv_nsec
operator|!=
name|PUFFS_VNOVAL
operator|)
operator|||
operator|(
name|va
operator|->
name|va_mtime
operator|.
name|tv_sec
operator|!=
name|PUFFS_VNOVAL
operator|&&
name|va
operator|->
name|va_mtime
operator|.
name|tv_nsec
operator|!=
name|PUFFS_VNOVAL
operator|)
condition|)
block|{
name|rv
operator|=
name|puffs_access_times
argument_list|(
name|pn
operator|->
name|pn_va
operator|.
name|va_uid
argument_list|,
name|pn
operator|->
name|pn_va
operator|.
name|va_gid
argument_list|,
name|pn
operator|->
name|pn_va
operator|.
name|va_mode
argument_list|,
name|va
operator|->
name|va_vaflags
operator|&
name|VA_UTIMES_NULL
argument_list|,
name|pcr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
return|return
name|rv
return|;
block|}
if|if
condition|(
name|va
operator|->
name|va_size
operator|!=
name|PUFFS_VNOVAL
condition|)
block|{
switch|switch
condition|(
name|pn
operator|->
name|pn_va
operator|.
name|va_type
condition|)
block|{
case|case
name|VREG
case|:
name|dtfs_setsize
argument_list|(
name|pn
argument_list|,
name|va
operator|->
name|va_size
argument_list|)
expr_stmt|;
name|pn
operator|->
name|pn_va
operator|.
name|va_bytes
operator|=
name|va
operator|->
name|va_size
expr_stmt|;
break|break;
case|case
name|VBLK
case|:
case|case
name|VCHR
case|:
case|case
name|VFIFO
case|:
break|break;
case|case
name|VDIR
case|:
return|return
name|EISDIR
return|;
default|default:
return|return
name|EOPNOTSUPP
return|;
block|}
block|}
name|puffs_setvattr
argument_list|(
operator|&
name|pn
operator|->
name|pn_va
argument_list|,
name|va
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* create a new node in the parent directory specified by opc */
end_comment

begin_function
name|int
name|dtfs_node_create
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|struct
name|puffs_newinfo
modifier|*
name|pni
parameter_list|,
specifier|const
name|struct
name|puffs_cn
modifier|*
name|pcn
parameter_list|,
specifier|const
name|struct
name|vattr
modifier|*
name|va
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn_parent
init|=
name|opc
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn_new
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|va
operator|->
name|va_type
operator|==
name|VREG
operator|||
name|va
operator|->
name|va_type
operator|==
name|VSOCK
operator|)
condition|)
return|return
name|ENODEV
return|;
name|pn_new
operator|=
name|dtfs_genfile
argument_list|(
name|pn_parent
argument_list|,
name|pcn
argument_list|,
name|va
operator|->
name|va_type
argument_list|)
expr_stmt|;
name|puffs_setvattr
argument_list|(
operator|&
name|pn_new
operator|->
name|pn_va
argument_list|,
name|va
argument_list|)
expr_stmt|;
name|puffs_newinfo_setcookie
argument_list|(
name|pni
argument_list|,
name|pn_new
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_remove
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|void
modifier|*
name|targ
parameter_list|,
specifier|const
name|struct
name|puffs_cn
modifier|*
name|pcn
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn_parent
init|=
name|opc
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn
init|=
name|targ
decl_stmt|;
if|if
condition|(
name|pn
operator|->
name|pn_va
operator|.
name|va_type
operator|==
name|VDIR
condition|)
return|return
name|EPERM
return|;
name|dtfs_nukenode
argument_list|(
name|targ
argument_list|,
name|pn_parent
argument_list|,
name|pcn
operator|->
name|pcn_name
argument_list|,
name|pcn
operator|->
name|pcn_namelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|pn
operator|->
name|pn_va
operator|.
name|va_nlink
operator|==
literal|0
condition|)
name|puffs_setback
argument_list|(
name|puffs_cc_getcc
argument_list|(
name|pu
argument_list|)
argument_list|,
name|PUFFS_SETBACK_NOREF_N2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_mkdir
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|struct
name|puffs_newinfo
modifier|*
name|pni
parameter_list|,
specifier|const
name|struct
name|puffs_cn
modifier|*
name|pcn
parameter_list|,
specifier|const
name|struct
name|vattr
modifier|*
name|va
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn_parent
init|=
name|opc
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn_new
decl_stmt|;
name|pn_new
operator|=
name|dtfs_genfile
argument_list|(
name|pn_parent
argument_list|,
name|pcn
argument_list|,
name|VDIR
argument_list|)
expr_stmt|;
name|puffs_setvattr
argument_list|(
operator|&
name|pn_new
operator|->
name|pn_va
argument_list|,
name|va
argument_list|)
expr_stmt|;
name|puffs_newinfo_setcookie
argument_list|(
name|pni
argument_list|,
name|pn_new
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_rmdir
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|void
modifier|*
name|targ
parameter_list|,
specifier|const
name|struct
name|puffs_cn
modifier|*
name|pcn
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn_parent
init|=
name|opc
decl_stmt|;
name|struct
name|dtfs_file
modifier|*
name|df
init|=
name|DTFS_CTOF
argument_list|(
name|targ
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|LIST_EMPTY
argument_list|(
operator|&
name|df
operator|->
name|df_dirents
argument_list|)
condition|)
return|return
name|ENOTEMPTY
return|;
name|dtfs_nukenode
argument_list|(
name|targ
argument_list|,
name|pn_parent
argument_list|,
name|pcn
operator|->
name|pcn_name
argument_list|,
name|pcn
operator|->
name|pcn_namelen
argument_list|)
expr_stmt|;
name|puffs_setback
argument_list|(
name|puffs_cc_getcc
argument_list|(
name|pu
argument_list|)
argument_list|,
name|PUFFS_SETBACK_NOREF_N2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_readdir
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|struct
name|dirent
modifier|*
name|dent
parameter_list|,
name|off_t
modifier|*
name|readoff
parameter_list|,
name|size_t
modifier|*
name|reslen
parameter_list|,
specifier|const
name|struct
name|puffs_cred
modifier|*
name|pcr
parameter_list|,
name|int
modifier|*
name|eofflag
parameter_list|,
name|off_t
modifier|*
name|cookies
parameter_list|,
name|size_t
modifier|*
name|ncookies
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn
init|=
name|opc
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn_nth
decl_stmt|;
name|struct
name|dtfs_dirent
modifier|*
name|dfd_nth
decl_stmt|;
if|if
condition|(
name|pn
operator|->
name|pn_va
operator|.
name|va_type
operator|!=
name|VDIR
condition|)
return|return
name|ENOTDIR
return|;
name|dtfs_updatetimes
argument_list|(
name|pn
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|ncookies
operator|=
literal|0
expr_stmt|;
name|again
label|:
if|if
condition|(
operator|*
name|readoff
operator|==
name|DENT_DOT
operator|||
operator|*
name|readoff
operator|==
name|DENT_DOTDOT
condition|)
block|{
name|puffs_gendotdent
argument_list|(
operator|&
name|dent
argument_list|,
name|pn
operator|->
name|pn_va
operator|.
name|va_fileid
argument_list|,
operator|*
name|readoff
argument_list|,
name|reslen
argument_list|)
expr_stmt|;
operator|(
operator|*
name|readoff
operator|)
operator|++
expr_stmt|;
name|PUFFS_STORE_DCOOKIE
argument_list|(
name|cookies
argument_list|,
name|ncookies
argument_list|,
operator|*
name|readoff
argument_list|)
expr_stmt|;
goto|goto
name|again
goto|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|dfd_nth
operator|=
name|dtfs_dirgetnth
argument_list|(
name|pn
operator|->
name|pn_data
argument_list|,
name|DENT_ADJ
argument_list|(
operator|*
name|readoff
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dfd_nth
condition|)
block|{
operator|*
name|eofflag
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|pn_nth
operator|=
name|dfd_nth
operator|->
name|dfd_node
expr_stmt|;
if|if
condition|(
operator|!
name|puffs_nextdent
argument_list|(
operator|&
name|dent
argument_list|,
name|dfd_nth
operator|->
name|dfd_name
argument_list|,
name|pn_nth
operator|->
name|pn_va
operator|.
name|va_fileid
argument_list|,
name|puffs_vtype2dt
argument_list|(
name|pn_nth
operator|->
name|pn_va
operator|.
name|va_type
argument_list|)
argument_list|,
name|reslen
argument_list|)
condition|)
break|break;
operator|(
operator|*
name|readoff
operator|)
operator|++
expr_stmt|;
name|PUFFS_STORE_DCOOKIE
argument_list|(
name|cookies
argument_list|,
name|ncookies
argument_list|,
operator|*
name|readoff
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_poll
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|int
modifier|*
name|events
parameter_list|)
block|{
name|struct
name|dtfs_mount
modifier|*
name|dtm
init|=
name|puffs_getspecific
argument_list|(
name|pu
argument_list|)
decl_stmt|;
name|struct
name|dtfs_poll
name|dp
decl_stmt|;
name|struct
name|itimerval
name|it
decl_stmt|;
name|memset
argument_list|(
operator|&
name|it
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|itimerval
argument_list|)
argument_list|)
expr_stmt|;
name|it
operator|.
name|it_value
operator|.
name|tv_sec
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|setitimer
argument_list|(
name|ITIMER_REAL
argument_list|,
operator|&
name|it
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
name|errno
return|;
name|dp
operator|.
name|dp_pcc
operator|=
name|puffs_cc_getcc
argument_list|(
name|pu
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|dtm
operator|->
name|dtm_pollent
argument_list|,
operator|&
name|dp
argument_list|,
name|dp_entries
argument_list|)
expr_stmt|;
name|puffs_cc_yield
argument_list|(
name|dp
operator|.
name|dp_pcc
argument_list|)
expr_stmt|;
operator|*
name|events
operator|=
operator|*
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLOUT
operator||
name|POLLRDNORM
operator||
name|POLLWRNORM
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_mmap
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|vm_prot_t
name|prot
parameter_list|,
specifier|const
name|struct
name|puffs_cred
modifier|*
name|pcr
parameter_list|)
block|{
name|struct
name|dtfs_mount
modifier|*
name|dtm
init|=
name|puffs_getspecific
argument_list|(
name|pu
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|dtm
operator|->
name|dtm_allowprot
operator|&
name|prot
operator|)
operator|!=
name|prot
condition|)
return|return
name|EACCES
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_rename
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|void
modifier|*
name|src
parameter_list|,
specifier|const
name|struct
name|puffs_cn
modifier|*
name|pcn_src
parameter_list|,
name|void
modifier|*
name|targ_dir
parameter_list|,
name|void
modifier|*
name|targ
parameter_list|,
specifier|const
name|struct
name|puffs_cn
modifier|*
name|pcn_targ
parameter_list|)
block|{
name|struct
name|dtfs_dirent
modifier|*
name|dfd_src
decl_stmt|;
name|struct
name|dtfs_file
modifier|*
name|df_targ
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn_sdir
init|=
name|opc
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn_sfile
init|=
name|src
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn_tdir
init|=
name|targ_dir
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn_tfile
init|=
name|targ
decl_stmt|;
comment|/* check that we don't do the old amigados trick */
if|if
condition|(
name|pn_sfile
operator|->
name|pn_va
operator|.
name|va_type
operator|==
name|VDIR
condition|)
block|{
if|if
condition|(
name|dtfs_isunder
argument_list|(
name|pn_tdir
argument_list|,
name|pn_sfile
argument_list|)
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|(
name|pcn_src
operator|->
name|pcn_namelen
operator|==
literal|1
operator|&&
name|pcn_src
operator|->
name|pcn_name
index|[
literal|0
index|]
operator|==
literal|'.'
operator|)
operator|||
name|opc
operator|==
name|src
operator|||
name|PCNISDOTDOT
argument_list|(
name|pcn_src
argument_list|)
operator|||
name|PCNISDOTDOT
argument_list|(
name|pcn_targ
argument_list|)
condition|)
block|{
return|return
name|EINVAL
return|;
block|}
block|}
name|dfd_src
operator|=
name|dtfs_dirgetbyname
argument_list|(
name|DTFS_PTOF
argument_list|(
name|pn_sdir
argument_list|)
argument_list|,
name|pcn_src
operator|->
name|pcn_name
argument_list|,
name|pcn_src
operator|->
name|pcn_namelen
argument_list|)
expr_stmt|;
comment|/* does it still exist, or did someone race us here? */
if|if
condition|(
name|dfd_src
operator|==
name|NULL
condition|)
block|{
return|return
name|ENOENT
return|;
block|}
comment|/* if there's a target file, nuke it for atomic replacement */
if|if
condition|(
name|pn_tfile
condition|)
block|{
if|if
condition|(
name|pn_tfile
operator|->
name|pn_va
operator|.
name|va_type
operator|==
name|VDIR
condition|)
block|{
name|df_targ
operator|=
name|DTFS_CTOF
argument_list|(
name|pn_tfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|LIST_EMPTY
argument_list|(
operator|&
name|df_targ
operator|->
name|df_dirents
argument_list|)
condition|)
return|return
name|ENOTEMPTY
return|;
block|}
name|dtfs_nukenode
argument_list|(
name|pn_tfile
argument_list|,
name|pn_tdir
argument_list|,
name|pcn_targ
operator|->
name|pcn_name
argument_list|,
name|pcn_targ
operator|->
name|pcn_namelen
argument_list|)
expr_stmt|;
block|}
comment|/* out with the old */
name|dtfs_removedent
argument_list|(
name|pn_sdir
argument_list|,
name|dfd_src
argument_list|)
expr_stmt|;
comment|/* and in with the new */
name|dtfs_adddent
argument_list|(
name|pn_tdir
argument_list|,
name|dfd_src
argument_list|)
expr_stmt|;
comment|/* update name */
name|free
argument_list|(
name|dfd_src
operator|->
name|dfd_name
argument_list|)
expr_stmt|;
name|dfd_src
operator|->
name|dfd_name
operator|=
name|estrndup
argument_list|(
name|pcn_targ
operator|->
name|pcn_name
argument_list|,
name|pcn_targ
operator|->
name|pcn_namelen
argument_list|)
expr_stmt|;
name|dfd_src
operator|->
name|dfd_namelen
operator|=
name|strlen
argument_list|(
name|dfd_src
operator|->
name|dfd_name
argument_list|)
expr_stmt|;
name|dtfs_updatetimes
argument_list|(
name|src
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_link
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|void
modifier|*
name|targ
parameter_list|,
specifier|const
name|struct
name|puffs_cn
modifier|*
name|pcn
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn_dir
init|=
name|opc
decl_stmt|;
name|struct
name|dtfs_dirent
modifier|*
name|dfd
decl_stmt|;
name|dfd
operator|=
name|emalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|dtfs_dirent
argument_list|)
argument_list|)
expr_stmt|;
name|dfd
operator|->
name|dfd_node
operator|=
name|targ
expr_stmt|;
name|dfd
operator|->
name|dfd_name
operator|=
name|estrndup
argument_list|(
name|pcn
operator|->
name|pcn_name
argument_list|,
name|pcn
operator|->
name|pcn_namelen
argument_list|)
expr_stmt|;
name|dfd
operator|->
name|dfd_namelen
operator|=
name|strlen
argument_list|(
name|dfd
operator|->
name|dfd_name
argument_list|)
expr_stmt|;
name|dtfs_adddent
argument_list|(
name|pn_dir
argument_list|,
name|dfd
argument_list|)
expr_stmt|;
name|dtfs_updatetimes
argument_list|(
name|targ
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_symlink
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|struct
name|puffs_newinfo
modifier|*
name|pni
parameter_list|,
specifier|const
name|struct
name|puffs_cn
modifier|*
name|pcn_src
parameter_list|,
specifier|const
name|struct
name|vattr
modifier|*
name|va
parameter_list|,
specifier|const
name|char
modifier|*
name|link_target
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn_parent
init|=
name|opc
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn_new
decl_stmt|;
name|struct
name|dtfs_file
modifier|*
name|df_new
decl_stmt|;
if|if
condition|(
name|va
operator|->
name|va_type
operator|!=
name|VLNK
condition|)
return|return
name|ENODEV
return|;
name|pn_new
operator|=
name|dtfs_genfile
argument_list|(
name|pn_parent
argument_list|,
name|pcn_src
argument_list|,
name|VLNK
argument_list|)
expr_stmt|;
name|puffs_setvattr
argument_list|(
operator|&
name|pn_new
operator|->
name|pn_va
argument_list|,
name|va
argument_list|)
expr_stmt|;
name|df_new
operator|=
name|DTFS_PTOF
argument_list|(
name|pn_new
argument_list|)
expr_stmt|;
name|df_new
operator|->
name|df_linktarget
operator|=
name|estrdup
argument_list|(
name|link_target
argument_list|)
expr_stmt|;
name|pn_new
operator|->
name|pn_va
operator|.
name|va_size
operator|=
name|strlen
argument_list|(
name|df_new
operator|->
name|df_linktarget
argument_list|)
expr_stmt|;
name|puffs_newinfo_setcookie
argument_list|(
name|pni
argument_list|,
name|pn_new
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_readlink
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
specifier|const
name|struct
name|puffs_cred
modifier|*
name|cred
parameter_list|,
name|char
modifier|*
name|linkname
parameter_list|,
name|size_t
modifier|*
name|linklen
parameter_list|)
block|{
name|struct
name|dtfs_file
modifier|*
name|df
init|=
name|DTFS_CTOF
argument_list|(
name|opc
argument_list|)
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn
init|=
name|opc
decl_stmt|;
name|assert
argument_list|(
name|pn
operator|->
name|pn_va
operator|.
name|va_type
operator|==
name|VLNK
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|linkname
argument_list|,
name|df
operator|->
name|df_linktarget
argument_list|,
operator|*
name|linklen
argument_list|)
expr_stmt|;
operator|*
name|linklen
operator|=
name|strlen
argument_list|(
name|linkname
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_mknod
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|struct
name|puffs_newinfo
modifier|*
name|pni
parameter_list|,
specifier|const
name|struct
name|puffs_cn
modifier|*
name|pcn
parameter_list|,
specifier|const
name|struct
name|vattr
modifier|*
name|va
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn_parent
init|=
name|opc
decl_stmt|;
name|struct
name|puffs_node
modifier|*
name|pn_new
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|va
operator|->
name|va_type
operator|==
name|VBLK
operator|||
name|va
operator|->
name|va_type
operator|==
name|VCHR
operator|||
name|va
operator|->
name|va_type
operator|==
name|VFIFO
operator|)
condition|)
return|return
name|EINVAL
return|;
name|pn_new
operator|=
name|dtfs_genfile
argument_list|(
name|pn_parent
argument_list|,
name|pcn
argument_list|,
name|va
operator|->
name|va_type
argument_list|)
expr_stmt|;
name|puffs_setvattr
argument_list|(
operator|&
name|pn_new
operator|->
name|pn_va
argument_list|,
name|va
argument_list|)
expr_stmt|;
name|puffs_newinfo_setcookie
argument_list|(
name|pni
argument_list|,
name|pn_new
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|BLOCKOFF
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)& ((b)-1))
end_define

begin_define
define|#
directive|define
name|BLOCKLEFT
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((b) - BLOCKOFF(a,b))
end_define

begin_comment
comment|/*  * Read operation, used both for VOP_READ and VOP_GETPAGES  */
end_comment

begin_function
name|int
name|dtfs_node_read
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|off_t
name|offset
parameter_list|,
name|size_t
modifier|*
name|resid
parameter_list|,
specifier|const
name|struct
name|puffs_cred
modifier|*
name|pcr
parameter_list|,
name|int
name|ioflag
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn
init|=
name|opc
decl_stmt|;
name|struct
name|dtfs_file
modifier|*
name|df
init|=
name|DTFS_CTOF
argument_list|(
name|opc
argument_list|)
decl_stmt|;
name|quad_t
name|xfer
decl_stmt|,
name|origxfer
decl_stmt|;
name|uint8_t
modifier|*
name|src
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|size_t
name|copylen
decl_stmt|;
if|if
condition|(
name|pn
operator|->
name|pn_va
operator|.
name|va_type
operator|!=
name|VREG
condition|)
return|return
name|EISDIR
return|;
name|xfer
operator|=
name|MIN
argument_list|(
operator|*
name|resid
argument_list|,
name|df
operator|->
name|df_datalen
operator|-
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer
operator|<
literal|0
condition|)
return|return
name|EINVAL
return|;
name|dest
operator|=
name|buf
expr_stmt|;
name|origxfer
operator|=
name|xfer
expr_stmt|;
while|while
condition|(
name|xfer
operator|>
literal|0
condition|)
block|{
name|copylen
operator|=
name|MIN
argument_list|(
name|xfer
argument_list|,
name|BLOCKLEFT
argument_list|(
name|offset
argument_list|,
name|DTFS_BLOCKSIZE
argument_list|)
argument_list|)
expr_stmt|;
name|src
operator|=
name|df
operator|->
name|df_blocks
index|[
name|BLOCKNUM
argument_list|(
name|offset
argument_list|,
name|DTFS_BLOCKSHIFT
argument_list|)
index|]
operator|+
name|BLOCKOFF
argument_list|(
name|offset
argument_list|,
name|DTFS_BLOCKSIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dest
argument_list|,
name|src
argument_list|,
name|copylen
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|copylen
expr_stmt|;
name|dest
operator|+=
name|copylen
expr_stmt|;
name|xfer
operator|-=
name|copylen
expr_stmt|;
block|}
operator|*
name|resid
operator|-=
name|origxfer
expr_stmt|;
name|dtfs_updatetimes
argument_list|(
name|pn
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * write operation on the wing  */
end_comment

begin_function
name|int
name|dtfs_node_write
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|off_t
name|offset
parameter_list|,
name|size_t
modifier|*
name|resid
parameter_list|,
specifier|const
name|struct
name|puffs_cred
modifier|*
name|pcr
parameter_list|,
name|int
name|ioflag
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn
init|=
name|opc
decl_stmt|;
name|struct
name|dtfs_file
modifier|*
name|df
init|=
name|DTFS_CTOF
argument_list|(
name|opc
argument_list|)
decl_stmt|;
name|uint8_t
modifier|*
name|src
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|size_t
name|copylen
decl_stmt|;
if|if
condition|(
name|pn
operator|->
name|pn_va
operator|.
name|va_type
operator|!=
name|VREG
condition|)
return|return
name|EISDIR
return|;
if|if
condition|(
name|ioflag
operator|&
name|PUFFS_IO_APPEND
condition|)
name|offset
operator|=
name|pn
operator|->
name|pn_va
operator|.
name|va_size
expr_stmt|;
if|if
condition|(
operator|*
name|resid
operator|+
name|offset
operator|>
name|pn
operator|->
name|pn_va
operator|.
name|va_size
condition|)
name|dtfs_setsize
argument_list|(
name|pn
argument_list|,
operator|*
name|resid
operator|+
name|offset
argument_list|)
expr_stmt|;
name|src
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|resid
operator|>
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|;
name|copylen
operator|=
name|MIN
argument_list|(
operator|*
name|resid
argument_list|,
name|BLOCKLEFT
argument_list|(
name|offset
argument_list|,
name|DTFS_BLOCKSIZE
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|=
name|BLOCKNUM
argument_list|(
name|offset
argument_list|,
name|DTFS_BLOCKSHIFT
argument_list|)
expr_stmt|;
name|dest
operator|=
name|df
operator|->
name|df_blocks
index|[
name|i
index|]
operator|+
name|BLOCKOFF
argument_list|(
name|offset
argument_list|,
name|DTFS_BLOCKSIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dest
argument_list|,
name|src
argument_list|,
name|copylen
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|copylen
expr_stmt|;
name|dest
operator|+=
name|copylen
expr_stmt|;
operator|*
name|resid
operator|-=
name|copylen
expr_stmt|;
block|}
name|dtfs_updatetimes
argument_list|(
name|pn
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_pathconf
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|puffs_cookie_t
name|opc
parameter_list|,
name|int
name|name
parameter_list|,
name|register_t
modifier|*
name|retval
parameter_list|)
block|{
switch|switch
condition|(
name|name
condition|)
block|{
case|case
name|_PC_LINK_MAX
case|:
operator|*
name|retval
operator|=
name|LINK_MAX
expr_stmt|;
return|return
literal|0
return|;
case|case
name|_PC_NAME_MAX
case|:
operator|*
name|retval
operator|=
name|NAME_MAX
expr_stmt|;
return|return
literal|0
return|;
case|case
name|_PC_PATH_MAX
case|:
operator|*
name|retval
operator|=
name|PATH_MAX
expr_stmt|;
return|return
literal|0
return|;
case|case
name|_PC_PIPE_BUF
case|:
operator|*
name|retval
operator|=
name|PIPE_BUF
expr_stmt|;
return|return
literal|0
return|;
case|case
name|_PC_CHOWN_RESTRICTED
case|:
operator|*
name|retval
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
case|case
name|_PC_NO_TRUNC
case|:
operator|*
name|retval
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
case|case
name|_PC_SYNC_IO
case|:
operator|*
name|retval
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
case|case
name|_PC_FILESIZEBITS
case|:
operator|*
name|retval
operator|=
literal|43
expr_stmt|;
comment|/* this one goes to 11 */
return|return
literal|0
return|;
case|case
name|_PC_SYMLINK_MAX
case|:
operator|*
name|retval
operator|=
name|MAXPATHLEN
expr_stmt|;
return|return
literal|0
return|;
case|case
name|_PC_2_SYMLINKS
case|:
operator|*
name|retval
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
name|int
name|dtfs_node_inactive
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|puffs_cookie_t
name|opc
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn
init|=
name|opc
decl_stmt|;
if|if
condition|(
name|pn
operator|->
name|pn_va
operator|.
name|va_nlink
operator|==
literal|0
condition|)
name|puffs_setback
argument_list|(
name|puffs_cc_getcc
argument_list|(
name|pu
argument_list|)
argument_list|,
name|PUFFS_SETBACK_NOREF_N1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dtfs_node_reclaim
parameter_list|(
name|struct
name|puffs_usermount
modifier|*
name|pu
parameter_list|,
name|void
modifier|*
name|opc
parameter_list|)
block|{
name|struct
name|puffs_node
modifier|*
name|pn
init|=
name|opc
decl_stmt|;
if|if
condition|(
name|pn
operator|->
name|pn_va
operator|.
name|va_nlink
operator|==
literal|0
condition|)
name|dtfs_freenode
argument_list|(
name|pn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"ex.h"
end_include

begin_include
include|#
directive|include
file|"ex_glob.h"
end_include

begin_include
include|#
directive|include
file|"ex_tty.h"
end_include

begin_comment
comment|/*  * Ex - a text editor  * Bill Joy UCB June-October 1977  */
end_comment

begin_decl_stmt
name|char
name|version
index|[]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|char
name|CHANGE
index|[]
literal|"change"
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|char
name|PRINT
index|[]
literal|"print"
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|char
name|RECOVER
index|[]
literal|"recover"
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|char
name|PRESERVE
index|[]
literal|"preserve"
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|char
name|READ
index|[]
literal|"read"
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|pflag
decl_stmt|,
name|nflag
decl_stmt|,
name|kflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|poffset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|xpand
argument_list|()
decl_stmt|,
name|tabulate
argument_list|()
decl_stmt|;
end_decl_stmt

begin_macro
name|commands
argument_list|(
argument|noprompt
argument_list|,
argument|exitoneof
argument_list|)
end_macro

begin_decl_stmt
name|int
name|noprompt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|exitoneof
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
modifier|*
name|addr
decl_stmt|;
specifier|register
name|c
expr_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|lchngflag
decl_stmt|,
name|cnt
decl_stmt|;
name|char
name|hadpr
decl_stmt|;
name|resetflav
argument_list|()
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
if|if
condition|(
name|noprompt
operator|==
operator|-
literal|1
condition|)
block|{
name|noprompt
operator|=
literal|0
expr_stmt|;
name|c
operator|=
literal|'e'
expr_stmt|;
if|if
condition|(
name|recov
condition|)
block|{
name|recov
operator|=
literal|0
expr_stmt|;
goto|goto
name|dorecover
goto|;
block|}
goto|goto
name|doecmd
goto|;
comment|/* magic! */
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|shudclob
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pflag
operator|||
name|lchngflag
operator|!=
name|chngflag
operator|&&
name|value
argument_list|(
name|AUTOPRINT
argument_list|)
operator|&&
operator|!
name|inglobal
operator|&&
name|endline
condition|)
block|{
name|pflag
operator|=
literal|0
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
if|if
condition|(
name|dol
operator|!=
name|zero
condition|)
block|{
name|addr1
operator|=
name|addr2
operator|=
name|dot
operator|+
name|poffset
expr_stmt|;
if|if
condition|(
name|addr1
operator|<
name|one
operator|||
name|addr1
operator|>
name|dol
condition|)
name|error
argument_list|(
literal|"Offset out-of-bounds|Offset after command too large"
argument_list|)
expr_stmt|;
name|setdot1
argument_list|()
expr_stmt|;
goto|goto
name|print
goto|;
block|}
block|}
if|if
condition|(
name|value
argument_list|(
name|STICKY
argument_list|)
operator|==
literal|0
condition|)
name|resetflav
argument_list|()
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
if|if
condition|(
name|inglobal
operator|==
literal|0
condition|)
block|{
name|flush
argument_list|()
expr_stmt|;
if|if
condition|(
name|value
argument_list|(
name|HUSH
argument_list|)
operator|==
literal|0
operator|&&
name|value
argument_list|(
name|PROMPT
argument_list|)
operator|&&
name|globp
operator|==
literal|0
operator|&&
name|noprompt
operator|==
literal|0
operator|&&
name|intty
operator|&&
name|endline
condition|)
block|{
name|putchar
argument_list|(
literal|':'
argument_list|)
expr_stmt|;
name|hadpr
operator|=
literal|1
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
block|}
name|TSYNC
argument_list|()
expr_stmt|;
block|}
name|addr2
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|addr1
operator|=
name|addr2
expr_stmt|;
name|addr
operator|=
name|address
argument_list|()
expr_stmt|;
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|addr
operator|==
literal|0
condition|)
if|if
condition|(
name|c
operator|==
literal|','
condition|)
name|addr
operator|=
name|dot
expr_stmt|;
elseif|else
if|if
condition|(
name|addr1
operator|!=
literal|0
condition|)
block|{
name|addr2
operator|=
name|dot
expr_stmt|;
break|break;
block|}
else|else
break|break;
name|addr2
operator|=
name|addr
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|';'
condition|)
block|{
name|c
operator|=
literal|','
expr_stmt|;
name|dot
operator|=
name|addr
expr_stmt|;
block|}
block|}
do|while
condition|(
name|c
operator|==
literal|','
condition|)
do|;
if|if
condition|(
name|addr1
operator|==
literal|0
condition|)
name|addr1
operator|=
name|addr2
expr_stmt|;
name|tailspec
argument_list|(
name|c
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
if|if
condition|(
name|peekchar
argument_list|()
operator|==
literal|'r'
condition|)
block|{
name|tail
argument_list|(
literal|"args"
argument_list|)
expr_stmt|;
name|setnoaddr
argument_list|()
expr_stmt|;
name|c
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|exclam
argument_list|()
condition|)
name|c
operator|=
name|xargc0
operator|-
name|xargc
expr_stmt|;
name|newline
argument_list|()
expr_stmt|;
for|for
control|(
init|;
name|c
operator|<
name|xargc0
condition|;
name|c
operator|++
control|)
name|printf
argument_list|(
literal|"%6d  %s\n"
argument_list|,
name|c
operator|-
operator|(
name|xargc0
operator|-
name|xargc
operator|)
operator|+
literal|1
argument_list|,
name|xargv0
index|[
name|c
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|tail
argument_list|(
literal|"append"
argument_list|)
expr_stmt|;
name|setdot
argument_list|()
expr_stmt|;
name|setai
argument_list|(
name|exclam
argument_list|()
argument_list|)
expr_stmt|;
name|newline
argument_list|()
expr_stmt|;
name|deletenone
argument_list|()
expr_stmt|;
name|append
argument_list|(
name|gettty
argument_list|,
name|setin
argument_list|(
name|addr2
argument_list|)
argument_list|)
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
case|case
literal|'c'
case|:
switch|switch
condition|(
name|peekchar
argument_list|()
condition|)
block|{
case|case
literal|'o'
case|:
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|peekchar
argument_list|()
operator|==
literal|'m'
condition|)
block|{
name|tail2of
argument_list|(
literal|"comment"
argument_list|)
expr_stmt|;
do|do
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
do|while
condition|(
name|c
operator|==
literal|'|'
operator|||
operator|!
name|endcmd
argument_list|(
name|c
argument_list|)
condition|)
do|;
continue|continue;
block|}
name|tail2of
argument_list|(
literal|"Copy"
argument_list|)
expr_stmt|;
name|move
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'d'
case|:
name|tail
argument_list|(
literal|"cd"
argument_list|)
expr_stmt|;
goto|goto
name|changdir
goto|;
case|case
literal|'h'
case|:
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|peekchar
argument_list|()
operator|==
literal|'d'
condition|)
block|{
name|tail2of
argument_list|(
literal|"chdir"
argument_list|)
expr_stmt|;
name|changdir
label|:
ifdef|#
directive|ifdef
name|UNIMP
if|if
condition|(
name|savedfile
index|[
literal|0
index|]
operator|==
literal|'/'
condition|)
name|exclam
argument_list|()
expr_stmt|;
else|else
name|quickly
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|skipwh
argument_list|()
expr_stmt|;
if|if
condition|(
name|endcmd
argument_list|(
name|peekchar
argument_list|()
argument_list|)
condition|)
block|{
name|newline
argument_list|()
expr_stmt|;
name|p
operator|=
name|home
expr_stmt|;
block|}
else|else
name|getone
argument_list|()
operator|,
name|p
operator|=
name|file
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|p
argument_list|)
operator|<
literal|0
condition|)
name|filioerr
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|file
index|[
literal|0
index|]
operator|!=
literal|'/'
condition|)
name|value
argument_list|(
name|EDITED
argument_list|)
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
name|tail2of
argument_list|(
name|CHANGE
argument_list|)
expr_stmt|;
break|break;
default|default:
name|tail
argument_list|(
name|CHANGE
argument_list|)
expr_stmt|;
block|}
name|setai
argument_list|(
name|exclam
argument_list|()
argument_list|)
expr_stmt|;
name|setCNL
argument_list|()
expr_stmt|;
name|setin
argument_list|(
name|addr1
argument_list|)
expr_stmt|;
name|delete
argument_list|()
expr_stmt|;
name|append
argument_list|(
name|gettty
argument_list|,
name|addr1
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
case|case
literal|'d'
case|:
name|tail
argument_list|(
literal|"delete"
argument_list|)
expr_stmt|;
name|setCNL
argument_list|()
expr_stmt|;
name|delete
argument_list|()
expr_stmt|;
name|appendnone
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'e'
case|:
switch|switch
condition|(
name|peekchar
argument_list|()
condition|)
block|{
case|case
literal|'x'
case|:
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|peekchar
argument_list|()
operator|==
literal|'p'
condition|)
block|{
name|tail2of
argument_list|(
literal|"expand"
argument_list|)
expr_stmt|;
name|setCNL
argument_list|()
expr_stmt|;
name|xop
argument_list|(
operator|&
name|xpand
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|tail2of
argument_list|(
literal|"ex"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|tail
argument_list|(
literal|"echo"
argument_list|)
expr_stmt|;
name|skipwh
argument_list|()
expr_stmt|;
do|do
block|{
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'|'
case|:
name|putnl
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'\\'
case|:
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
default|default:
name|putchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|!
name|endcmd
argument_list|(
name|c
argument_list|)
condition|)
do|;
continue|continue;
default|default:
name|tail
argument_list|(
literal|"edit"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|exclam
argument_list|()
operator|&&
name|chngflag
condition|)
name|c
operator|=
literal|'E'
expr_stmt|;
name|doecmd
label|:
name|filename
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'E'
condition|)
block|{
name|ungetchar
argument_list|(
name|lastchar
argument_list|()
argument_list|)
expr_stmt|;
name|quickly
argument_list|()
expr_stmt|;
block|}
name|setnoaddr
argument_list|()
expr_stmt|;
name|init
argument_list|()
expr_stmt|;
name|addr2
operator|=
name|zero
expr_stmt|;
name|laste
operator|++
expr_stmt|;
name|sync
argument_list|()
expr_stmt|;
name|rop
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
case|case
literal|'f'
case|:
name|tail
argument_list|(
literal|"file"
argument_list|)
expr_stmt|;
name|setnoaddr
argument_list|()
expr_stmt|;
name|filename
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|putnl
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'g'
case|:
name|tail
argument_list|(
literal|"global"
argument_list|)
expr_stmt|;
name|global
argument_list|(
operator|!
name|exclam
argument_list|()
argument_list|)
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
case|case
literal|'i'
case|:
name|tail
argument_list|(
literal|"insert"
argument_list|)
expr_stmt|;
name|setdot
argument_list|()
expr_stmt|;
name|nonzero
argument_list|()
expr_stmt|;
name|setai
argument_list|(
name|exclam
argument_list|()
argument_list|)
expr_stmt|;
name|newline
argument_list|()
expr_stmt|;
name|deletenone
argument_list|()
expr_stmt|;
name|setin
argument_list|(
name|addr2
argument_list|)
expr_stmt|;
name|append
argument_list|(
name|gettty
argument_list|,
name|addr2
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dot
operator|==
name|zero
operator|&&
name|dol
operator|>
name|zero
condition|)
name|dot
operator|=
name|one
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
case|case
literal|'j'
case|:
name|tail
argument_list|(
literal|"join"
argument_list|)
expr_stmt|;
name|c
operator|=
name|exclam
argument_list|()
expr_stmt|;
name|setcount
argument_list|()
expr_stmt|;
name|nonzero
argument_list|()
expr_stmt|;
name|newline
argument_list|()
expr_stmt|;
if|if
condition|(
name|addr1
operator|==
name|addr2
condition|)
block|{
if|if
condition|(
name|addr1
operator|==
name|dol
condition|)
block|{
if|if
condition|(
name|dol
operator|!=
name|one
condition|)
name|error
argument_list|(
literal|"Illegal $ in join|$join not allowed unless only one line in buffer"
argument_list|)
expr_stmt|;
block|}
else|else
name|addr2
operator|++
expr_stmt|;
block|}
name|join
argument_list|(
name|c
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'k'
case|:
name|casek
label|:
name|skipwh
argument_list|()
expr_stmt|;
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|endcmd
argument_list|(
name|c
argument_list|)
condition|)
name|error
argument_list|(
literal|"Mark what?|%s requires following letter"
argument_list|,
name|Command
argument_list|)
expr_stmt|;
name|newline
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|!=
name|letter
argument_list|(
name|c
argument_list|)
condition|)
name|error
argument_list|(
literal|"Bad mark|Mark must specify a letter"
argument_list|)
expr_stmt|;
name|setdot
argument_list|()
expr_stmt|;
name|nonzero
argument_list|()
expr_stmt|;
name|names
index|[
name|c
operator|-
literal|'a'
index|]
operator|=
operator|*
name|addr2
operator|&
operator|~
literal|01
expr_stmt|;
continue|continue;
case|case
literal|'m'
case|:
if|if
condition|(
name|peekchar
argument_list|()
operator|==
literal|'a'
condition|)
block|{
name|tail
argument_list|(
literal|"mark"
argument_list|)
expr_stmt|;
goto|goto
name|casek
goto|;
block|}
name|tail
argument_list|(
literal|"Move"
argument_list|)
expr_stmt|;
name|move
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'o'
case|:
name|tail
argument_list|(
literal|"open"
argument_list|)
expr_stmt|;
name|oop
argument_list|()
expr_stmt|;
name|pflag
operator|=
literal|0
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
case|case
literal|'|'
case|:
name|endline
operator|=
literal|0
expr_stmt|;
goto|goto
name|caseline
goto|;
case|case
literal|'\n'
case|:
name|endline
operator|=
literal|1
expr_stmt|;
name|caseline
label|:
name|notempty
argument_list|()
expr_stmt|;
if|if
condition|(
name|addr2
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|dot
operator|==
name|dol
condition|)
name|error
argument_list|(
literal|"At EOF|At end-of-file"
argument_list|)
expr_stmt|;
if|if
condition|(
name|UPLINE
operator|&&
name|c
operator|==
literal|'\n'
operator|&&
operator|!
name|inglobal
condition|)
name|c
operator|=
literal|'\013'
expr_stmt|;
name|addr2
operator|=
name|dot
operator|+
literal|1
expr_stmt|;
block|}
name|addr1
operator|=
name|addr2
expr_stmt|;
name|setdot
argument_list|()
expr_stmt|;
name|nonzero
argument_list|()
expr_stmt|;
name|getline
argument_list|(
operator|*
name|addr1
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\013'
condition|)
block|{
name|putchar
argument_list|(
literal|'\013'
operator||
name|QUOTE
argument_list|)
expr_stmt|;
comment|/* prototype UPLINE */
if|if
condition|(
name|hadpr
condition|)
name|shudclob
operator|=
literal|1
expr_stmt|;
block|}
name|plines
argument_list|(
name|addr1
argument_list|,
name|addr2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'l'
case|:
name|tail
argument_list|(
literal|"list"
argument_list|)
expr_stmt|;
name|setCNL
argument_list|()
expr_stmt|;
name|setlist
argument_list|()
expr_stmt|;
name|pflag
operator|=
literal|0
expr_stmt|;
goto|goto
name|print
goto|;
case|case
literal|':'
case|:
name|setCNL
argument_list|()
expr_stmt|;
name|kflag
operator|=
literal|1
expr_stmt|;
name|setflav
argument_list|()
expr_stmt|;
name|pflag
operator|=
literal|0
expr_stmt|;
goto|goto
name|print
goto|;
case|case
literal|'#'
case|:
name|numberit
label|:
name|setCNL
argument_list|()
expr_stmt|;
name|setnumb
argument_list|()
expr_stmt|;
name|pflag
operator|=
literal|0
expr_stmt|;
goto|goto
name|print
goto|;
case|case
literal|'p'
case|:
switch|switch
condition|(
name|peekchar
argument_list|()
condition|)
block|{
case|case
literal|'u'
case|:
name|tail
argument_list|(
literal|"put"
argument_list|)
expr_stmt|;
name|setdot
argument_list|()
expr_stmt|;
name|eol
argument_list|()
expr_stmt|;
name|PUT
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'r'
case|:
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|peekchar
argument_list|()
operator|==
literal|'e'
condition|)
block|{
name|tail2of
argument_list|(
name|PRESERVE
argument_list|)
expr_stmt|;
name|eol
argument_list|()
expr_stmt|;
name|preserve
argument_list|()
expr_stmt|;
continue|continue;
block|}
name|tail2of
argument_list|(
name|PRINT
argument_list|)
expr_stmt|;
break|break;
default|default:
name|tail
argument_list|(
name|PRINT
argument_list|)
expr_stmt|;
break|break;
block|}
name|setCNL
argument_list|()
expr_stmt|;
name|pflag
operator|=
literal|0
expr_stmt|;
name|print
label|:
name|nonzero
argument_list|()
expr_stmt|;
if|if
condition|(
name|CLEAR
operator|&&
name|addr2
operator|-
name|addr1
operator|>=
name|LINES
condition|)
name|putchar
argument_list|(
literal|'\032'
operator||
name|QUOTE
argument_list|)
expr_stmt|;
comment|/* proto */
name|plines
argument_list|(
name|addr1
argument_list|,
name|addr2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'n'
case|:
if|if
condition|(
name|peekchar
argument_list|()
operator|==
literal|'u'
condition|)
block|{
name|tail
argument_list|(
literal|"number"
argument_list|)
expr_stmt|;
goto|goto
name|numberit
goto|;
block|}
name|tail
argument_list|(
literal|"next"
argument_list|)
expr_stmt|;
name|setnoaddr
argument_list|()
expr_stmt|;
name|quickly
argument_list|()
expr_stmt|;
if|if
condition|(
name|getargs
argument_list|()
operator|==
literal|0
condition|)
block|{
name|ungetchar
argument_list|(
name|lastchar
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|glob
argument_list|(
name|genbuf
argument_list|,
name|G
argument_list|)
expr_stmt|;
name|xargc0
operator|=
name|gargc
expr_stmt|;
name|xargv0
operator|=
operator|&
name|G
operator|->
name|Ava
index|[
literal|0
index|]
expr_stmt|;
name|rewind
argument_list|()
expr_stmt|;
return|return
operator|(
literal|2
operator|)
return|;
case|case
literal|'q'
case|:
name|tail
argument_list|(
literal|"quit"
argument_list|)
expr_stmt|;
name|setnoaddr
argument_list|()
expr_stmt|;
name|c
operator|=
name|quickly
argument_list|()
expr_stmt|;
name|eol
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
condition|)
name|argc
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
literal|'r'
case|:
if|if
condition|(
name|peekchar
argument_list|()
operator|==
literal|'e'
condition|)
block|{
name|getchar
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|peekchar
argument_list|()
condition|)
block|{
case|case
literal|'w'
case|:
name|tail2of
argument_list|(
literal|"rewind"
argument_list|)
expr_stmt|;
name|setnoaddr
argument_list|()
expr_stmt|;
name|quickly
argument_list|()
expr_stmt|;
name|newline
argument_list|()
expr_stmt|;
name|rewind
argument_list|()
expr_stmt|;
return|return
operator|(
literal|2
operator|)
return|;
case|case
literal|'s'
case|:
name|tail2of
argument_list|(
literal|"reset"
argument_list|)
expr_stmt|;
name|setNAEOL
argument_list|()
expr_stmt|;
name|REset
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'c'
case|:
name|tail2of
argument_list|(
name|RECOVER
argument_list|)
expr_stmt|;
name|setnoaddr
argument_list|()
expr_stmt|;
name|c
operator|=
literal|'e'
expr_stmt|;
if|if
condition|(
operator|!
name|exclam
argument_list|()
operator|&&
name|chngflag
condition|)
name|c
operator|=
literal|'E'
expr_stmt|;
name|dorecover
label|:
name|filename
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'E'
condition|)
block|{
name|ungetchar
argument_list|(
name|lastchar
argument_list|()
argument_list|)
expr_stmt|;
name|quickly
argument_list|()
expr_stmt|;
block|}
name|init
argument_list|()
expr_stmt|;
name|addr2
operator|=
name|zero
expr_stmt|;
name|laste
operator|++
expr_stmt|;
name|sync
argument_list|()
expr_stmt|;
name|recover
argument_list|()
expr_stmt|;
name|rop2
argument_list|()
expr_stmt|;
name|revocer
argument_list|()
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|0
condition|)
name|rop3
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|dol
operator|!=
name|zero
condition|)
name|change
argument_list|()
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
block|}
name|tail2of
argument_list|(
name|READ
argument_list|)
expr_stmt|;
block|}
else|else
name|tail
argument_list|(
name|READ
argument_list|)
expr_stmt|;
if|if
condition|(
name|savedfile
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|dol
operator|==
name|zero
condition|)
name|c
operator|=
literal|'e'
expr_stmt|;
name|filename
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|rop
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
case|case
literal|'s'
case|:
switch|switch
condition|(
name|peekchar
argument_list|()
condition|)
block|{
case|case
literal|'e'
case|:
name|tail
argument_list|(
literal|"set"
argument_list|)
expr_stmt|;
name|setnoaddr
argument_list|()
expr_stmt|;
name|set
argument_list|(
name|skipwh
argument_list|()
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'h'
case|:
name|tail
argument_list|(
literal|"shell"
argument_list|)
expr_stmt|;
name|setNAEOL
argument_list|()
expr_stmt|;
name|unix2
argument_list|(
literal|"-i"
argument_list|,
literal|0
argument_list|,
name|NIL
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'o'
case|:
name|tail
argument_list|(
literal|"source"
argument_list|)
expr_stmt|;
name|setnoaddr
argument_list|()
expr_stmt|;
name|getone
argument_list|()
expr_stmt|;
name|source
argument_list|(
name|file
argument_list|,
literal|0
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'y'
case|:
name|tail
argument_list|(
literal|"sync"
argument_list|)
expr_stmt|;
name|setNAEOL
argument_list|()
expr_stmt|;
name|synctmp
argument_list|()
expr_stmt|;
continue|continue;
block|}
case|case
literal|'&'
case|:
case|case
literal|'~'
case|:
name|Command
operator|=
literal|"substitute"
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'s'
condition|)
name|tail
argument_list|(
name|Command
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|substitute
argument_list|(
name|c
argument_list|)
condition|)
name|pflag
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
literal|'t'
case|:
if|if
condition|(
name|peekchar
argument_list|()
operator|==
literal|'a'
condition|)
block|{
name|tail
argument_list|(
literal|"tabulate"
argument_list|)
expr_stmt|;
name|c
operator|=
name|exclam
argument_list|()
expr_stmt|;
name|setCNL
argument_list|()
expr_stmt|;
name|xop
argument_list|(
operator|&
name|tabulate
argument_list|,
name|c
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|tail
argument_list|(
literal|"Transcribe"
argument_list|)
expr_stmt|;
name|move
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'u'
case|:
name|tail
argument_list|(
literal|"undo"
argument_list|)
expr_stmt|;
name|setnoaddr
argument_list|()
expr_stmt|;
name|markDOT
argument_list|()
expr_stmt|;
name|c
operator|=
name|exclam
argument_list|()
expr_stmt|;
name|newline
argument_list|()
expr_stmt|;
name|undo
argument_list|(
name|c
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'v'
case|:
switch|switch
condition|(
name|peekchar
argument_list|()
condition|)
block|{
case|case
literal|'e'
case|:
name|tail
argument_list|(
literal|"version"
argument_list|)
expr_stmt|;
name|setNAEOL
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'i'
case|:
name|tail
argument_list|(
literal|"visual"
argument_list|)
expr_stmt|;
name|vop
argument_list|()
expr_stmt|;
name|pflag
operator|=
literal|0
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
block|}
name|tail
argument_list|(
literal|"v"
argument_list|)
expr_stmt|;
name|global
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
case|case
literal|'w'
case|:
name|tail
argument_list|(
literal|"write"
argument_list|)
expr_stmt|;
name|setall
argument_list|()
expr_stmt|;
name|wop
argument_list|()
expr_stmt|;
name|lchngflag
operator|=
name|chngflag
expr_stmt|;
continue|continue;
case|case
literal|'x'
case|:
name|tail
argument_list|(
literal|"xpand"
argument_list|)
expr_stmt|;
name|setCNL
argument_list|()
expr_stmt|;
name|xop
argument_list|(
operator|&
name|xpand
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'y'
case|:
name|tail
argument_list|(
literal|"yank"
argument_list|)
expr_stmt|;
name|setcount
argument_list|()
expr_stmt|;
name|eol
argument_list|()
expr_stmt|;
name|yank
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'z'
case|:
name|zop
argument_list|()
expr_stmt|;
name|pflag
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
literal|'='
case|:
name|newline
argument_list|()
expr_stmt|;
name|setall
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"%d\n"
argument_list|,
name|addr2
operator|-
name|zero
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'!'
case|:
name|unix
argument_list|()
expr_stmt|;
continue|continue;
case|case
literal|'<'
case|:
case|case
literal|'>'
case|:
for|for
control|(
name|cnt
operator|=
literal|1
init|;
name|peekchar
argument_list|()
operator|==
name|c
condition|;
name|cnt
operator|++
control|)
name|getchar
argument_list|()
expr_stmt|;
name|setCNL
argument_list|()
expr_stmt|;
name|shift
argument_list|(
name|c
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|EOF
case|:
comment|/* onhup for chtty !?! */
if|if
condition|(
name|exitoneof
operator|||
name|gTTY
argument_list|(
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|dol
operator|==
name|zero
condition|)
block|{
name|putnl
argument_list|()
expr_stmt|;
name|notempty
argument_list|()
expr_stmt|;
block|}
name|ungetchar
argument_list|(
name|EOF
argument_list|)
expr_stmt|;
name|zop
argument_list|(
name|hadpr
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'h'
case|:
name|tail
argument_list|(
literal|"help"
argument_list|)
expr_stmt|;
name|setnoaddr
argument_list|()
expr_stmt|;
name|helpthem
argument_list|()
expr_stmt|;
continue|continue;
default|default:
if|if
condition|(
operator|!
name|letter
argument_list|(
name|c
argument_list|)
condition|)
break|break;
name|ungetchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|tailof
argument_list|(
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|error
argument_list|(
literal|"What?|Unknown command character '%c'"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|quickly
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|exclam
argument_list|()
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|chngflag
condition|)
block|{
name|chngflag
operator|=
literal|0
expr_stmt|;
name|xchngflag
operator|=
literal|0
expr_stmt|;
name|error
argument_list|(
literal|"No write@since last change"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|change
argument_list|()
end_macro

begin_block
block|{
name|tchngflag
operator|++
expr_stmt|;
name|chngflag
operator|=
name|tchngflag
expr_stmt|;
block|}
end_block

begin_macro
name|sync
argument_list|()
end_macro

begin_block
block|{
name|chngflag
operator|=
literal|0
expr_stmt|;
name|tchngflag
operator|=
literal|0
expr_stmt|;
name|xchngflag
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|plines
argument_list|(
argument|adr1
argument_list|,
argument|adr2
argument_list|,
argument|movedot
argument_list|)
end_macro

begin_decl_stmt
name|int
modifier|*
name|adr1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
modifier|*
name|adr2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|movedot
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
modifier|*
name|addr
decl_stmt|;
for|for
control|(
name|addr
operator|=
name|adr1
init|;
name|addr
operator|<=
name|adr2
condition|;
name|addr
operator|++
control|)
block|{
name|getline
argument_list|(
operator|*
name|addr
argument_list|)
expr_stmt|;
name|pline
argument_list|(
name|addr
operator|-
name|zero
argument_list|)
expr_stmt|;
if|if
condition|(
name|movedot
condition|)
name|dot
operator|=
name|addr
expr_stmt|;
block|}
block|}
end_block

begin_function_decl
name|int
name|normline
parameter_list|()
function_decl|;
end_function_decl

begin_macro
name|newline
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|c
expr_stmt|;
name|resetflav
argument_list|()
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'^'
case|:
case|case
literal|'-'
case|:
name|poffset
operator|--
expr_stmt|;
break|break;
case|case
literal|'+'
case|:
name|poffset
operator|++
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|listf
operator|++
expr_stmt|;
break|break;
case|case
literal|':'
case|:
name|kflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'#'
case|:
name|nflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|listf
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|' '
case|:
case|case
literal|'\t'
case|:
continue|continue;
default|default:
if|if
condition|(
operator|!
name|endcmd
argument_list|(
name|c
argument_list|)
condition|)
name|error
argument_list|(
literal|"Extra chars|Extra characters at end of \"%s\" command"
argument_list|,
name|Command
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|EOF
condition|)
name|ungetchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|setflav
argument_list|()
expr_stmt|;
return|return;
block|}
name|pflag
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|eol
argument_list|()
end_macro

begin_block
block|{
name|skipwh
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|endcmd
argument_list|(
name|getchar
argument_list|()
argument_list|)
condition|)
name|error
argument_list|(
literal|"Extra chars|Extra characters at end of command"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|resetflav
argument_list|()
end_macro

begin_block
block|{
name|listf
operator|=
literal|0
expr_stmt|;
name|kflag
operator|=
literal|0
expr_stmt|;
name|nflag
operator|=
literal|0
expr_stmt|;
name|pflag
operator|=
literal|0
expr_stmt|;
name|poffset
operator|=
literal|0
expr_stmt|;
name|setflav
argument_list|()
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|int
argument_list|(
operator|*
name|Pline
argument_list|)
argument_list|()
decl_stmt|,
name|normline
argument_list|()
decl_stmt|,
name|numbline
argument_list|()
decl_stmt|;
end_decl_stmt

begin_macro
name|setflav
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|nflag
operator|||
name|kflag
operator|==
literal|0
operator|&&
name|value
argument_list|(
name|NUMBER
argument_list|)
condition|)
name|setnumb
argument_list|()
expr_stmt|;
else|else
comment|/* setnonumb(); */
name|Pline
operator|=
operator|&
name|normline
expr_stmt|;
if|if
condition|(
name|listf
operator|||
name|kflag
operator|==
literal|0
operator|&&
name|value
argument_list|(
name|LIST
argument_list|)
condition|)
name|setlist
argument_list|()
expr_stmt|;
else|else
name|setnorm
argument_list|()
expr_stmt|;
name|setoutt
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|endcmd
argument_list|(
argument|ch
argument_list|)
end_macro

begin_block
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'\n'
case|:
case|case
name|EOF
case|:
name|endline
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|'|'
case|:
name|endline
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|tailspec
argument_list|(
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|char
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|char
name|foocmd
index|[
literal|2
index|]
decl_stmt|;
name|foocmd
index|[
literal|0
index|]
operator|=
name|c
expr_stmt|;
name|Command
operator|=
name|foocmd
expr_stmt|;
block|}
end_block

begin_macro
name|tail
argument_list|(
argument|comm
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|comm
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|tailof
argument_list|(
name|comm
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|comm
operator|)
return|;
block|}
end_block

begin_macro
name|tail2of
argument_list|(
argument|comm
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|comm
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|tailof
argument_list|(
name|comm
argument_list|,
literal|2
argument_list|)
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|tailof
argument_list|(
name|comm
argument_list|,
name|i
argument_list|)
specifier|register
name|char
operator|*
name|comm
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|i
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|;
name|char
name|command
index|[
literal|20
index|]
decl_stmt|;
name|Command
operator|=
name|comm
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|command
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
operator|*
name|cp
operator|++
operator|=
operator|*
name|comm
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|comm
operator|&&
name|peekchar
argument_list|()
operator|==
operator|*
name|comm
condition|)
operator|*
name|cp
operator|++
operator|=
name|getchar
argument_list|()
operator|,
name|comm
operator|++
expr_stmt|;
name|c
operator|=
name|peekchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|letter
argument_list|(
name|c
argument_list|)
operator|&&
name|c
operator|!=
literal|'l'
operator|&&
name|c
operator|!=
literal|'p'
condition|)
block|{
do|do
operator|*
name|cp
operator|++
operator|=
name|getchar
argument_list|()
expr_stmt|;
do|while
condition|(
name|cp
operator|<
operator|&
name|command
index|[
literal|19
index|]
operator|&&
name|letter
argument_list|(
name|peekchar
argument_list|()
argument_list|)
condition|)
do|;
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
name|error
argument_list|(
literal|"What?|%s: Not an editor command"
argument_list|,
name|command
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|exclam
argument_list|()
end_macro

begin_block
block|{
name|skipwh
argument_list|()
expr_stmt|;
if|if
condition|(
name|peekchar
argument_list|()
operator|==
literal|'!'
condition|)
block|{
name|getchar
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


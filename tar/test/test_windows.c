begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009 Michihiro NAKAJIMA  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR(S) ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR(S) BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"test.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<direct.h>
end_include

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_function
specifier|static
name|void
name|mkfile
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|name
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|f
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|5
argument_list|,
name|fwrite
argument_list|(
literal|"01234"
argument_list|,
literal|1
argument_list|,
literal|5
argument_list|,
name|f
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mkfullpath
parameter_list|(
name|char
modifier|*
modifier|*
name|path1
parameter_list|,
name|char
modifier|*
modifier|*
name|path2
parameter_list|,
specifier|const
name|char
modifier|*
name|tpath
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|char
modifier|*
name|fp1
init|=
name|NULL
decl_stmt|,
modifier|*
name|fp2
init|=
name|NULL
decl_stmt|,
modifier|*
name|p1
init|=
name|NULL
decl_stmt|,
modifier|*
name|p2
init|=
name|NULL
decl_stmt|;
name|size_t
name|l
decl_stmt|;
comment|/* 	 * Get full path name of "tpath" 	 */
name|l
operator|=
name|GetFullPathNameA
argument_list|(
name|tpath
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
literal|0
operator|!=
name|l
argument_list|)
expr_stmt|;
name|fp1
operator|=
name|malloc
argument_list|(
name|l
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|NULL
operator|!=
name|fp1
argument_list|)
expr_stmt|;
name|fp2
operator|=
name|malloc
argument_list|(
name|l
operator|*
literal|2
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|NULL
operator|!=
name|fp2
argument_list|)
expr_stmt|;
name|l
operator|=
name|GetFullPathNameA
argument_list|(
name|tpath
argument_list|,
operator|(
name|DWORD
operator|)
name|l
argument_list|,
name|fp1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|type
operator|&
literal|0x01
operator|)
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|p1
operator|=
name|fp1
init|;
operator|*
name|p1
operator|!=
literal|'\0'
condition|;
name|p1
operator|++
control|)
if|if
condition|(
operator|*
name|p1
operator|==
literal|'\\'
condition|)
operator|*
name|p1
operator|=
literal|'/'
expr_stmt|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|0
case|:
comment|/* start with "/" */
case|case
literal|1
case|:
comment|/* start with "\" */
comment|/* strip "c:" */
name|memmove
argument_list|(
name|fp1
argument_list|,
name|fp1
operator|+
literal|2
argument_list|,
name|l
operator|-
literal|2
argument_list|)
expr_stmt|;
name|fp1
index|[
name|l
operator|-
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
name|p1
operator|=
name|fp1
operator|+
literal|1
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* start with "c:/" */
case|case
literal|3
case|:
comment|/* start with "c:\" */
name|p1
operator|=
name|fp1
operator|+
literal|3
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* start with "//./c:/" */
case|case
literal|5
case|:
comment|/* start with "\\.\c:\" */
case|case
literal|6
case|:
comment|/* start with "//?/c:/" */
case|case
literal|7
case|:
comment|/* start with "\\?\c:\" */
name|p1
operator|=
name|malloc
argument_list|(
name|l
operator|+
literal|4
operator|+
literal|1
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|NULL
operator|!=
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|&
literal|0x1
condition|)
name|memcpy
argument_list|(
name|p1
argument_list|,
literal|"\\\\.\\"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|else
name|memcpy
argument_list|(
name|p1
argument_list|,
literal|"//./"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
literal|6
operator|||
name|type
operator|==
literal|7
condition|)
name|p1
index|[
literal|2
index|]
operator|=
literal|'?'
expr_stmt|;
name|memcpy
argument_list|(
name|p1
operator|+
literal|4
argument_list|,
name|fp1
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|p1
index|[
name|l
operator|+
literal|4
index|]
operator|=
literal|'\0'
expr_stmt|;
name|free
argument_list|(
name|fp1
argument_list|)
expr_stmt|;
name|fp1
operator|=
name|p1
expr_stmt|;
name|p1
operator|=
name|fp1
operator|+
literal|7
expr_stmt|;
break|break;
block|}
comment|/* 	 * Strip leading drive names and converting "\" to "\\" 	 */
name|p2
operator|=
name|fp2
expr_stmt|;
while|while
condition|(
operator|*
name|p1
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|p1
operator|==
literal|'\\'
condition|)
operator|*
name|p2
operator|=
literal|'/'
expr_stmt|;
else|else
operator|*
name|p2
operator|=
operator|*
name|p1
expr_stmt|;
operator|++
name|p1
expr_stmt|;
operator|++
name|p2
expr_stmt|;
block|}
operator|*
name|p2
operator|++
operator|=
literal|'\r'
expr_stmt|;
operator|*
name|p2
operator|++
operator|=
literal|'\n'
expr_stmt|;
operator|*
name|p2
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|path1
operator|=
name|fp1
expr_stmt|;
operator|*
name|path2
operator|=
name|fp2
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|list1
index|[]
init|=
block|{
literal|"aaa/"
block|,
literal|"aaa/file1"
block|,
literal|"aaa/xxa/"
block|,
literal|"aaa/xxb/"
block|,
literal|"aaa/zzc/"
block|,
literal|"aaa/zzc/file1"
block|,
literal|"aaa/xxb/file1"
block|,
literal|"aaa/xxa/file1"
block|,
literal|"aab/"
block|,
literal|"aac/"
block|,
literal|"abb/"
block|,
literal|"abc/"
block|,
literal|"abd/"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|list2
index|[]
init|=
block|{
literal|"bbb/"
block|,
literal|"bbb/file1"
block|,
literal|"bbb/xxa/"
block|,
literal|"bbb/xxb/"
block|,
literal|"bbb/zzc/"
block|,
literal|"bbb/zzc/file1"
block|,
literal|"bbb/xxb/file1"
block|,
literal|"bbb/xxa/file1"
block|,
literal|"bbc/"
block|,
literal|"bbd/"
block|,
literal|"bcc/"
block|,
literal|"bcd/"
block|,
literal|"bce/"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|list3
index|[]
init|=
block|{
literal|"aac/"
block|,
literal|"abc/"
block|,
literal|"bbc/"
block|,
literal|"bcc/"
block|,
literal|"ccc/"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|list4
index|[]
init|=
block|{
literal|"fff/abca"
block|,
literal|"fff/acca"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|list5
index|[]
init|=
block|{
literal|"aaa/file1"
block|,
literal|"aaa/xxa/"
block|,
literal|"aaa/xxa/file1"
block|,
literal|"aaa/xxb/"
block|,
literal|"aaa/xxb/file1"
block|,
literal|"aaa/zzc/"
block|,
literal|"aaa/zzc/file1"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|list6
index|[]
init|=
block|{
literal|"fff/abca"
block|,
literal|"fff/acca"
block|,
literal|"aaa/xxa/"
block|,
literal|"aaa/xxa/file1"
block|,
literal|"aaa/xxb/"
block|,
literal|"aaa/xxb/file1"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _WIN32&& !__CYGWIN__ */
end_comment

begin_macro
name|DEFINE_TEST
argument_list|(
argument|test_windows
argument_list|)
end_macro

begin_block
block|{
if|#
directive|if
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
name|char
modifier|*
name|fp1
decl_stmt|,
modifier|*
name|fp2
decl_stmt|;
comment|/* 	 * Preparre tests. 	 * Create directories and files. 	 */
name|assertMakeDir
argument_list|(
literal|"tmp"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertChdir
argument_list|(
literal|"tmp"
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"aaa"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"aaa/xxa"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"aaa/xxb"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"aaa/zzc"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"aaa/file1"
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"aaa/xxa/file1"
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"aaa/xxb/file1"
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"aaa/zzc/file1"
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"aab"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"aac"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"abb"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"abc"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"abd"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"bbb"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"bbb/xxa"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"bbb/xxb"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"bbb/zzc"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"bbb/file1"
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"bbb/xxa/file1"
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"bbb/xxb/file1"
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"bbb/zzc/file1"
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"bbc"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"bbd"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"bcc"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertMakeDir
argument_list|(
literal|"bcd"
argument_list|,
literal|0775
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|_mkdir
argument_list|(
literal|"bce"
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|_mkdir
argument_list|(
literal|"ccc"
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|_mkdir
argument_list|(
literal|"fff"
argument_list|)
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"fff/aaaa"
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"fff/abba"
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"fff/abca"
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"fff/acba"
argument_list|)
expr_stmt|;
name|mkfile
argument_list|(
literal|"fff/acca"
argument_list|)
expr_stmt|;
comment|/* 	 * Test1: Command line pattern matching. 	 */
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive1.tar a*"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive1.tar> ../list1"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertFileContainsLinesAnyOrder
argument_list|(
literal|"../list1"
argument_list|,
name|list1
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive2.tar b*"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive2.tar> ../list2"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertFileContainsLinesAnyOrder
argument_list|(
literal|"../list2"
argument_list|,
name|list2
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive3.tar ??c"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive3.tar> ../list3"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertFileContainsLinesAnyOrder
argument_list|(
literal|"../list3"
argument_list|,
name|list3
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive3b.tar *c"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive3b.tar> ../list3b"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertFileContainsLinesAnyOrder
argument_list|(
literal|"../list3b"
argument_list|,
name|list3
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive4.tar fff/a?ca"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive4.tar> ../list4"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertFileContainsLinesAnyOrder
argument_list|(
literal|"../list4"
argument_list|,
name|list4
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive5.tar aaa\\*"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive5.tar> ../list5"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertFileContainsLinesAnyOrder
argument_list|(
literal|"../list5"
argument_list|,
name|list5
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive6.tar fff\\a?ca aaa\\xx*"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive6.tar> ../list6"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
name|assertFileContainsLinesAnyOrder
argument_list|(
literal|"../list6"
argument_list|,
name|list6
argument_list|)
expr_stmt|;
comment|/* 	 * Test2: Archive the file start with drive letters. 	 */
comment|/* Test2a: start with "/" */
name|mkfullpath
argument_list|(
operator|&
name|fp1
argument_list|,
operator|&
name|fp2
argument_list|,
literal|"aaa/file1"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive10.tar %s> ../out10 2> ../err10"
argument_list|,
name|testprog
argument_list|,
name|fp1
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive10.tar> ../list10"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check drive letters have been stripped. */
name|assertFileContents
argument_list|(
name|fp2
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|fp2
argument_list|)
argument_list|,
literal|"../list10"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp2
argument_list|)
expr_stmt|;
comment|/* Test2b: start with "\" */
name|mkfullpath
argument_list|(
operator|&
name|fp1
argument_list|,
operator|&
name|fp2
argument_list|,
literal|"aaa/file1"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive11.tar %s> ../out11 2> ../err11"
argument_list|,
name|testprog
argument_list|,
name|fp1
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive11.tar> ../list11"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check drive letters have been stripped. */
name|assertFileContents
argument_list|(
name|fp2
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|fp2
argument_list|)
argument_list|,
literal|"../list11"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp2
argument_list|)
expr_stmt|;
comment|/* Test2c: start with "c:/" */
name|mkfullpath
argument_list|(
operator|&
name|fp1
argument_list|,
operator|&
name|fp2
argument_list|,
literal|"aaa/file1"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive12.tar %s> ../out12 2> ../err12"
argument_list|,
name|testprog
argument_list|,
name|fp1
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive12.tar> ../list12"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check drive letters have been stripped. */
name|assertFileContents
argument_list|(
name|fp2
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|fp2
argument_list|)
argument_list|,
literal|"../list12"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp2
argument_list|)
expr_stmt|;
comment|/* Test2d: start with "c:\" */
name|mkfullpath
argument_list|(
operator|&
name|fp1
argument_list|,
operator|&
name|fp2
argument_list|,
literal|"aaa/file1"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive13.tar %s> ../out13 2> ../err13"
argument_list|,
name|testprog
argument_list|,
name|fp1
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive13.tar> ../list13"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check drive letters have been stripped. */
name|assertFileContents
argument_list|(
name|fp2
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|fp2
argument_list|)
argument_list|,
literal|"../list13"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp2
argument_list|)
expr_stmt|;
comment|/* Test2e: start with "//./c:/" */
name|mkfullpath
argument_list|(
operator|&
name|fp1
argument_list|,
operator|&
name|fp2
argument_list|,
literal|"aaa/file1"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive14.tar %s> ../out14 2> ../err14"
argument_list|,
name|testprog
argument_list|,
name|fp1
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive14.tar> ../list14"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check drive letters have been stripped. */
name|assertFileContents
argument_list|(
name|fp2
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|fp2
argument_list|)
argument_list|,
literal|"../list14"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp2
argument_list|)
expr_stmt|;
comment|/* Test2f: start with "\\.\c:\" */
name|mkfullpath
argument_list|(
operator|&
name|fp1
argument_list|,
operator|&
name|fp2
argument_list|,
literal|"aaa/file1"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive15.tar %s> ../out15 2> ../err15"
argument_list|,
name|testprog
argument_list|,
name|fp1
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive15.tar> ../list15"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check drive letters have been stripped. */
name|assertFileContents
argument_list|(
name|fp2
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|fp2
argument_list|)
argument_list|,
literal|"../list15"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp2
argument_list|)
expr_stmt|;
comment|/* Test2g: start with "//?/c:/" */
name|mkfullpath
argument_list|(
operator|&
name|fp1
argument_list|,
operator|&
name|fp2
argument_list|,
literal|"aaa/file1"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|failure
argument_list|(
literal|"fp1=%s, fp2=%s"
argument_list|,
name|fp1
argument_list|,
name|fp2
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive16.tar %s> ../out16 2> ../err16"
argument_list|,
name|testprog
argument_list|,
name|fp1
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive16.tar> ../list16"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check drive letters have been stripped. */
name|assertFileContents
argument_list|(
name|fp2
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|fp2
argument_list|)
argument_list|,
literal|"../list16"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp2
argument_list|)
expr_stmt|;
comment|/* Test2h: start with "\\?\c:\" */
name|mkfullpath
argument_list|(
operator|&
name|fp1
argument_list|,
operator|&
name|fp2
argument_list|,
literal|"aaa/file1"
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|failure
argument_list|(
literal|"fp1=%s, fp2=%s"
argument_list|,
name|fp1
argument_list|,
name|fp2
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -cf ../archive17.tar %s> ../out17 2> ../err17"
argument_list|,
name|testprog
argument_list|,
name|fp1
argument_list|)
argument_list|)
expr_stmt|;
name|assertEqualInt
argument_list|(
literal|0
argument_list|,
name|systemf
argument_list|(
literal|"%s -tf ../archive17.tar> ../list17"
argument_list|,
name|testprog
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check drive letters have been stripped. */
name|assertFileContents
argument_list|(
name|fp2
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|fp2
argument_list|)
argument_list|,
literal|"../list17"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fp2
argument_list|)
expr_stmt|;
else|#
directive|else
name|skipping
argument_list|(
literal|"Windows specific test"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* _WIN32&& !__CYGWIN__ */
block|}
end_block

end_unit


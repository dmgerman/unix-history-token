begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	nsp_output.c	1.5	82/12/18	*/
end_comment

begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/systm.h"
end_include

begin_include
include|#
directive|include
file|"../h/mbuf.h"
end_include

begin_include
include|#
directive|include
file|"../h/protosw.h"
end_include

begin_include
include|#
directive|include
file|"../h/socket.h"
end_include

begin_include
include|#
directive|include
file|"../h/socketvar.h"
end_include

begin_include
include|#
directive|include
file|"../netdecnet/dn_systm.h"
end_include

begin_include
include|#
directive|include
file|"../netdecnet/nsp.h"
end_include

begin_include
include|#
directive|include
file|"../netdecnet/nsp_var.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_comment
comment|/*  * NSP output routine: figure out what should be sent and send it.  */
end_comment

begin_expr_stmt
name|nsp_output
argument_list|(
name|np
argument_list|)
specifier|register
expr|struct
name|nspcb
operator|*
name|np
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|socket
modifier|*
name|so
init|=
name|np
operator|->
name|n_socket
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
name|int
name|off
decl_stmt|,
name|flags
decl_stmt|;
specifier|register
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
comment|/* 	 * Determine what type of message to send and send it. 	 */
name|top
label|:
comment|/* interrupt to be sent? */
if|if
condition|(
name|np
operator|->
name|n_flags
operator|&
name|NF_INTAVAIL
condition|)
operator|&&
name|np
operator|->
name|nf_remint
operator|>
literal|0
operator|&&
operator|(
name|np
operator|->
name|n_flags
operator|&
name|NF_OTHSENT
operator|)
operator|==
literal|0
block|)
end_block

begin_block
block|{
specifier|register
name|struct
name|nspi
modifier|*
name|n
decl_stmt|;
name|m
operator|=
name|m_get
argument_list|(
name|M_CANTWAIT
argument_list|,
name|MT_HEADER
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|np
operator|->
name|nb_xmt
condition|)
name|len
operator|=
name|np
operator|->
name|nb_xmt
operator|->
name|m_len
expr_stmt|;
else|else
name|len
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nspi
argument_list|)
operator|+
name|len
expr_stmt|;
name|m
operator|->
name|m_off
operator|=
name|MMAXOFF
operator|-
name|m
operator|->
name|m_len
expr_stmt|;
name|n
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|nspi
operator|*
argument_list|)
expr_stmt|;
name|n
operator|->
name|nsp_msgflg
operator|=
name|NSP_INTR
expr_stmt|;
name|n
operator|->
name|nsp_dstaddr
operator|=
name|np
operator|->
name|n_rem
expr_stmt|;
name|n
operator|->
name|nsp_srcaddr
operator|=
name|np
operator|->
name|n_loc
expr_stmt|;
name|n
operator|->
name|nsp_acknum
operator|=
name|NSPA_ACK
operator||
name|np
operator|->
name|na_xmtoth
expr_stmt|;
name|n
operator|->
name|nsp_segnum
operator|=
name|np
operator|->
name|nn_oth
expr_stmt|;
if|if
condition|(
name|len
condition|)
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|n
operator|+
literal|1
operator|)
argument_list|,
name|mtod
argument_list|(
name|np
operator|->
name|nb_xmt
argument_list|,
name|char
operator|*
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp_output
argument_list|(
name|m
argument_list|,
name|np
operator|->
name|n_node
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|np
operator|->
name|n_flags
operator|&=
operator|~
operator|(
name|NF_INTAVAIL
operator||
name|NF_OTHACK
operator|)
expr_stmt|;
name|np
operator|->
name|n_flags
operator||=
name|NF_OTHSENT
expr_stmt|;
if|if
condition|(
name|len
condition|)
operator|(
name|void
operator|)
name|m_free
argument_list|(
name|np
operator|->
name|nb_xmt
argument_list|)
expr_stmt|;
name|nsp_insrtq
argument_list|(
name|m
argument_list|,
name|np
operator|->
name|nt_oth
argument_list|)
expr_stmt|;
goto|goto
name|top
goto|;
block|}
end_block

begin_comment
comment|/* interrupt request to be sent? */
end_comment

begin_if
if|if
condition|(
name|np
operator|->
name|nf_locint
operator|==
name|NFL_SEND
operator|&&
operator|(
name|np
operator|->
name|n_flags
operator|&
name|NF_OTHSENT
operator|)
operator|==
literal|0
condition|)
block|{
specifier|register
name|struct
name|nspls
modifier|*
name|n
decl_stmt|;
name|m
operator|=
name|m_get
argument_list|(
name|M_CANTWAIT
argument_list|,
name|MT_HEADER
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nspls
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_off
operator|=
name|MMAXOFF
operator|-
name|m
operator|->
name|m_len
expr_stmt|;
name|n
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|nspls
operator|*
argument_list|)
expr_stmt|;
name|n
operator|->
name|nsp_msgflg
operator|=
name|NSP_LS
expr_stmt|;
name|n
operator|->
name|nsp_dstaddr
operator|=
name|np
operator|->
name|n_rem
expr_stmt|;
name|n
operator|->
name|nsp_srcaddr
operator|=
name|np
operator|->
name|n_loc
expr_stmt|;
name|n
operator|->
name|nsp_acknum
operator|=
name|NSPA_ACK
operator||
name|np
operator|->
name|na_xmtoth
expr_stmt|;
name|n
operator|->
name|nsp_segnum
operator|=
name|np
operator|->
name|nn_oth
expr_stmt|;
name|n
operator|->
name|nsp_lsflags
operator|=
name|NSPLS_INTREQ
operator||
name|NSPLS_ON
expr_stmt|;
name|n
operator|->
name|nsp_fcval
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tp_output
argument_list|(
name|m
argument_list|,
name|np
operator|->
name|n_node
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|np
operator|->
name|n_flags
operator|&=
operator|~
name|NF_OTHACK
expr_stmt|;
name|np
operator|->
name|n_flags
operator||=
name|NF_OTHSENT
expr_stmt|;
name|nsp_insrtq
argument_list|(
name|m
argument_list|,
name|np
operator|->
name|nt_oth
argument_list|)
expr_stmt|;
goto|goto
name|top
goto|;
block|}
end_if

begin_comment
comment|/* data request to be sent? */
end_comment

begin_if
if|if
condition|(
name|np
operator|->
name|nf_locdat
operator|>
literal|0
operator|&&
operator|(
name|np
operator|->
name|n_flags
operator|&
name|NF_OTHSENT
operator|==
literal|0
operator|)
condition|)
block|{
specifier|register
name|struct
name|nspls
modifier|*
name|n
decl_stmt|;
name|m
operator|=
name|m_get
argument_list|(
name|M_CANTWAIT
argument_list|,
name|MT_HEADER
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nspls
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_off
operator|=
name|MMAXOFF
operator|-
name|m
operator|->
name|m_len
expr_stmt|;
name|n
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|nspls
operator|*
argument_list|)
expr_stmt|;
name|n
operator|->
name|nsp_msgflg
operator|=
name|NSP_LS
expr_stmt|;
name|n
operator|->
name|nsp_dstaddr
operator|=
name|np
operator|->
name|n_rem
expr_stmt|;
name|n
operator|->
name|nsp_srcaddr
operator|=
name|np
operator|->
name|n_loc
expr_stmt|;
name|n
operator|->
name|nsp_acknum
operator|=
name|NSPA_ACK
operator||
name|np
operator|->
name|na_xmtoth
expr_stmt|;
name|n
operator|->
name|nsp_segnum
operator|=
name|np
operator|->
name|nn_oth
expr_stmt|;
name|n
operator|->
name|nsp_lsflags
operator|=
name|NSPLS_DATREQ
operator||
name|NSPLS_ON
expr_stmt|;
name|n
operator|->
name|nsp_fcval
operator|=
name|np
operator|->
name|nf_locdat
expr_stmt|;
if|if
condition|(
name|tp_output
argument_list|(
name|m
argument_list|,
name|np
operator|->
name|n_node
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|np
operator|->
name|n_flags
operator|&=
operator|~
name|NF_OTHACK
expr_stmt|;
name|np
operator|->
name|n_flags
operator||=
name|NF_OTHSENT
expr_stmt|;
name|nsp_insrtq
argument_list|(
name|m
argument_list|,
name|np
operator|->
name|nt_oth
argument_list|)
expr_stmt|;
goto|goto
name|top
goto|;
block|}
end_if

begin_comment
comment|/* other data ack to be sent? */
end_comment

begin_if
if|if
condition|(
name|np
operator|->
name|n_flags
operator|&
name|NF_OTHACK
condition|)
block|{
specifier|register
name|struct
name|nspack
modifier|*
name|n
decl_stmt|;
name|m
operator|=
name|m_get
argument_list|(
name|M_CANTWAIT
argument_list|,
name|MT_HEADER
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nspack
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_off
operator|=
name|MMAXOFF
operator|-
name|m
operator|->
name|m_len
expr_stmt|;
name|n
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|nspack
operator|*
argument_list|)
expr_stmt|;
name|n
operator|->
name|nsp_msgflg
operator|=
name|NSP_OTHACK
expr_stmt|;
name|n
operator|->
name|nsp_dstaddr
operator|=
name|np
operator|->
name|n_rem
expr_stmt|;
name|n
operator|->
name|nsp_srcaddr
operator|=
name|np
operator|->
name|n_loc
expr_stmt|;
name|n
operator|->
name|nsp_acknum
operator|=
name|NSPA_ACK
operator||
name|np
operator|->
name|na_xmtoth
expr_stmt|;
if|if
condition|(
name|tp_output
argument_list|(
name|m
argument_list|,
name|np
operator|->
name|n_node
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|np
operator|->
name|n_flags
operator|&=
operator|~
name|NF_OTHACK
expr_stmt|;
operator|(
name|void
operator|)
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|top
goto|;
block|}
end_if

begin_comment
comment|/* data to be sent? */
end_comment

begin_if
if|if
condition|()
block|{
specifier|register
name|struct
name|nspd
modifier|*
name|n
decl_stmt|;
name|m
operator|=
name|nsp_mgetcl
argument_list|()
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|len
operator|<=
name|np
operator|->
name|n_segsize
condition|)
block|{
name|m
operator|->
name|m_next
operator|=
name|so
operator|->
name|so_snd
operator|.
name|sb_mb
expr_stmt|;
name|so
operator|->
name|so_snd
operator|.
name|sb_mb
operator|=
name|m
operator|->
name|m_next
operator|->
name|m_act
expr_stmt|;
block|}
comment|/* MORE */
block|}
end_if

begin_comment
comment|/* data ack to be sent? */
end_comment

begin_if
if|if
condition|(
name|np
operator|->
name|n_flags
operator|&
name|NF_DATACK
condition|)
block|{
specifier|register
name|struct
name|nspack
modifier|*
name|n
decl_stmt|;
name|m
operator|=
name|m_get
argument_list|(
name|M_CANTWAIT
argument_list|,
name|MT_HEADER
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nspack
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_off
operator|=
name|MMAXOFF
operator|-
name|m
operator|->
name|m_len
expr_stmt|;
name|n
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|nspack
operator|*
argument_list|)
expr_stmt|;
name|n
operator|->
name|nsp_msgflg
operator|=
name|NSP_DATACK
expr_stmt|;
name|n
operator|->
name|nsp_dstaddr
operator|=
name|np
operator|->
name|n_rem
expr_stmt|;
name|n
operator|->
name|nsp_srcaddr
operator|=
name|np
operator|->
name|n_loc
expr_stmt|;
name|n
operator|->
name|nsp_acknum
operator|=
name|NSPA_ACK
operator||
name|np
operator|->
name|na_xmtdat
expr_stmt|;
if|if
condition|(
name|tp_output
argument_list|(
name|m
argument_list|,
name|np
operator|->
name|n_node
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|np
operator|->
name|n_flags
operator|&=
operator|~
name|NF_DATACK
expr_stmt|;
operator|(
name|void
operator|)
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|top
goto|;
block|}
end_if

begin_comment
comment|/* 	 * Nothing left to do, return success. 	 */
end_comment

begin_return
return|return
operator|(
literal|1
operator|)
return|;
end_return

unit|}
end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/*                                                                        */
end_comment

begin_comment
comment|/*  code to support kernel generated traps -- user's can send their own   */
end_comment

begin_comment
comment|/*  thru normal channels.                                                 */
end_comment

begin_comment
comment|/*                                                                        */
end_comment

begin_comment
comment|/**************************************************************************/
end_comment

begin_if
if|#
directive|if
name|HMP
operator|&&
name|HMPTRAPS
end_if

begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/dir.h"
end_include

begin_include
include|#
directive|include
file|"../h/user.h"
end_include

begin_include
include|#
directive|include
file|"../h/mbuf.h"
end_include

begin_include
include|#
directive|include
file|"../h/protosw.h"
end_include

begin_include
include|#
directive|include
file|"../h/socket.h"
end_include

begin_include
include|#
directive|include
file|"../h/socketvar.h"
end_include

begin_include
include|#
directive|include
file|"../h/errno.h"
end_include

begin_include
include|#
directive|include
file|"../net/if.h"
end_include

begin_include
include|#
directive|include
file|"../net/route.h"
end_include

begin_include
include|#
directive|include
file|"../bbnnet/in.h"
end_include

begin_include
include|#
directive|include
file|"../bbnnet/in_pcb.h"
end_include

begin_include
include|#
directive|include
file|"../bbnnet/in_var.h"
end_include

begin_include
include|#
directive|include
file|"../bbnnet/ip.h"
end_include

begin_include
include|#
directive|include
file|"../bbnnet/hmp.h"
end_include

begin_include
include|#
directive|include
file|"../bbnnet/hmp_var.h"
end_include

begin_include
include|#
directive|include
file|"../bbnnet/hmp_traps.h"
end_include

begin_comment
comment|/*   * list of monitoring hosts that want to get traps  * uses a sockaddr_hmp so you can specify address& port. doesn't use  * other fields but is the most common structure for saving port/host info.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|sockaddr_hmp
name|mon_hosts
index|[
name|MAX_MONHOSTS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|num_monhosts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * learn who gets traps  */
end_comment

begin_macro
name|getmonhosts
argument_list|(
argument|optval
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|mbuf
modifier|*
modifier|*
name|optval
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
if|if
condition|(
operator|(
name|m
operator|=
name|m_getclr
argument_list|(
name|M_WAIT
argument_list|,
name|MT_DATA
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
if|if
condition|(
name|num_monhosts
condition|)
block|{
name|m
operator|->
name|m_len
operator|=
name|num_monhosts
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_hmp
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|mon_hosts
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
operator|(
name|unsigned
operator|)
name|m
operator|->
name|m_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* would like to return nothing, but can't */
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_hmp
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
name|m
operator|->
name|m_len
argument_list|)
expr_stmt|;
block|}
operator|*
name|optval
operator|=
name|m
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*   * changing who gets our traps   */
end_comment

begin_macro
name|setmonhosts
argument_list|(
argument|optval
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|mbuf
modifier|*
name|optval
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|unsigned
name|len
decl_stmt|;
if|if
condition|(
operator|!
name|suser
argument_list|()
condition|)
return|return
operator|(
name|u
operator|.
name|u_error
operator|)
return|;
if|if
condition|(
name|optval
operator|==
literal|0
condition|)
block|{
comment|/* clearing table */
name|num_monhosts
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|len
operator|=
operator|(
name|optval
operator|)
operator|->
name|m_len
expr_stmt|;
comment|/* rational data ? */
if|if
condition|(
operator|(
operator|(
name|len
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_hmp
argument_list|)
operator|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|len
operator|%
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_hmp
argument_list|)
operator|)
operator|!=
literal|0
operator|)
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|mon_hosts
argument_list|)
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
comment|/* close enough to true error */
name|bcopy
argument_list|(
name|mtod
argument_list|(
name|optval
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|mon_hosts
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|num_monhosts
operator|=
name|len
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_hmp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * what kernel calls to send stuff   */
end_comment

begin_comment
comment|/* nobody does anything but copy this */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|hmpcb
name|trappcb
init|=
block|{
literal|0
block|,
literal|0
block|,
name|HM_43HOST
block|,
name|HM_43HOST
block|,
name|HM_TRAP
block|,
name|HM_TRAP
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_macro
name|hmp_trap
argument_list|(
argument|code
argument_list|,
argument|data
argument_list|,
argument|len
argument_list|)
end_macro

begin_decl_stmt
name|int
name|code
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|data
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|len
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|inpcb
name|inp
decl_stmt|;
name|struct
name|hmpcb
name|hp
decl_stmt|;
name|struct
name|hmp_trap
name|ht
decl_stmt|;
if|if
condition|(
name|num_monhosts
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|len
operator|>
operator|(
name|MLEN
operator|-
sizeof|sizeof
argument_list|(
name|ht
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"hmp_trap: trap size too big\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|trappcb
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|hp
argument_list|,
sizeof|sizeof
argument_list|(
name|hp
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|inp
argument_list|,
sizeof|sizeof
argument_list|(
name|inp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* this may not be necessary but careful never hurts */
name|inp
operator|.
name|inp_ppcb
operator|=
operator|&
name|hp
expr_stmt|;
name|hp
operator|.
name|hp_inpcb
operator|=
operator|&
name|inp
expr_stmt|;
comment|/* fill in trap data leader */
name|ht
operator|.
name|ht_time
operator|=
name|iptime
argument_list|()
expr_stmt|;
name|ht
operator|.
name|ht_type
operator|=
name|htonl
argument_list|(
operator|(
name|u_long
operator|)
name|code
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_monhosts
condition|;
name|i
operator|++
control|)
block|{
comment|/* get mbuf for packet */
name|m
operator|=
name|m_getclr
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ht
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|ht
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|data
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ht
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|len
operator|+
sizeof|sizeof
argument_list|(
name|ht
argument_list|)
expr_stmt|;
comment|/* stuff remote address and port */
name|inp
operator|.
name|inp_faddr
operator|=
name|mon_hosts
index|[
name|i
index|]
operator|.
name|sin_addr
expr_stmt|;
name|inp
operator|.
name|inp_fport
operator|=
name|mon_hosts
index|[
name|i
index|]
operator|.
name|sin_port
expr_stmt|;
operator|(
name|void
operator|)
name|hmp_output
argument_list|(
operator|&
name|inp
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1982, 1986 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  *  *	@(#)tty_tty.c	7.2 (Berkeley) %G%  */
end_comment

begin_comment
comment|/*  * Indirect driver for controlling tty.  *  * THIS IS GARBAGE: MUST SOON BE DONE WITH struct inode * IN PROC TABLE.  */
end_comment

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"systm.h"
end_include

begin_include
include|#
directive|include
file|"conf.h"
end_include

begin_include
include|#
directive|include
file|"dir.h"
end_include

begin_include
include|#
directive|include
file|"user.h"
end_include

begin_include
include|#
directive|include
file|"ioctl.h"
end_include

begin_include
include|#
directive|include
file|"tty.h"
end_include

begin_include
include|#
directive|include
file|"proc.h"
end_include

begin_include
include|#
directive|include
file|"uio.h"
end_include

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|syopen
argument_list|(
argument|dev
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|u
operator|.
name|u_ttyp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
operator|(
operator|*
name|cdevsw
index|[
name|major
argument_list|(
name|u
operator|.
name|u_ttyd
argument_list|)
index|]
operator|.
name|d_open
operator|)
operator|(
name|u
operator|.
name|u_ttyd
operator|,
name|flag
operator|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|syread
argument_list|(
argument|dev
argument_list|,
argument|uio
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|u
operator|.
name|u_ttyp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
operator|(
operator|*
name|cdevsw
index|[
name|major
argument_list|(
name|u
operator|.
name|u_ttyd
argument_list|)
index|]
operator|.
name|d_read
operator|)
operator|(
name|u
operator|.
name|u_ttyd
operator|,
name|uio
operator|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|sywrite
argument_list|(
argument|dev
argument_list|,
argument|uio
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|u
operator|.
name|u_ttyp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
operator|(
operator|*
name|cdevsw
index|[
name|major
argument_list|(
name|u
operator|.
name|u_ttyd
argument_list|)
index|]
operator|.
name|d_write
operator|)
operator|(
name|u
operator|.
name|u_ttyd
operator|,
name|uio
operator|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|syioctl
argument_list|(
argument|dev
argument_list|,
argument|cmd
argument_list|,
argument|addr
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|cmd
operator|==
name|TIOCNOTTY
condition|)
block|{
name|u
operator|.
name|u_ttyp
operator|=
literal|0
expr_stmt|;
name|u
operator|.
name|u_ttyd
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|SESS_LEADER
argument_list|(
name|u
operator|.
name|u_procp
argument_list|)
condition|)
block|{
comment|/*  			 * XXX - check posix draft 			 */
name|u
operator|.
name|u_ttyp
operator|->
name|t_session
operator|=
literal|0
expr_stmt|;
name|u
operator|.
name|u_ttyp
operator|->
name|t_pgid
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|u
operator|.
name|u_ttyp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
operator|(
operator|*
name|cdevsw
index|[
name|major
argument_list|(
name|u
operator|.
name|u_ttyd
argument_list|)
index|]
operator|.
name|d_ioctl
operator|)
operator|(
name|u
operator|.
name|u_ttyd
operator|,
name|cmd
operator|,
name|addr
operator|,
name|flag
operator|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|syselect
argument_list|(
argument|dev
argument_list|,
argument|flag
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|u
operator|.
name|u_ttyp
operator|==
name|NULL
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|ENXIO
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
operator|(
operator|*
name|cdevsw
index|[
name|major
argument_list|(
name|u
operator|.
name|u_ttyd
argument_list|)
index|]
operator|.
name|d_select
operator|)
operator|(
name|u
operator|.
name|u_ttyd
operator|,
name|flag
operator|)
operator|)
return|;
block|}
end_block

end_unit


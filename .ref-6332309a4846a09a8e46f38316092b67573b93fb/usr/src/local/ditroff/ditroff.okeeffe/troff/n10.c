begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)n10.c	1.2	(CWI)	86/08/15"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* n10.c  Device interfaces */
end_comment

begin_include
include|#
directive|include
file|"tdef.h"
end_include

begin_include
include|#
directive|include
file|"ext.h"
end_include

begin_include
include|#
directive|include
file|"tw.h"
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_decl_stmt
name|struct
name|t
name|t
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* terminal characteristics */
end_comment

begin_decl_stmt
name|int
name|dtab
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|plotmode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|esct
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|xchname
index|[
literal|4
operator|*
operator|(
name|NROFFCHARS
operator|-
literal|128
operator|)
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* hy, em, etc. */
end_comment

begin_decl_stmt
name|short
name|xchtab
index|[
name|NROFFCHARS
operator|-
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* indexes into chname[] */
end_comment

begin_decl_stmt
name|char
modifier|*
name|codestr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|chname
init|=
name|xchname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
modifier|*
name|chtab
init|=
name|xchtab
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Inch
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Hor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Vert
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nfonts
init|=
literal|4
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* R, I, B, S */
end_comment

begin_comment
comment|/* these characters are used as various signals or values /* in miscellaneous places. /* values are set in specnames in t10.c */
end_comment

begin_decl_stmt
name|int
name|c_hyphen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_emdash
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_rule
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_minus
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_fi
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_fl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_ff
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_ffi
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_ffl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_acute
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_grave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_under
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_rooten
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_boxrule
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_lefthand
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_dagger
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c_isalnum
decl_stmt|;
end_decl_stmt

begin_macro
name|ptinit
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|cp
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|int
name|nread
decl_stmt|,
name|fd
decl_stmt|;
specifier|extern
name|char
modifier|*
name|skipstr
argument_list|()
decl_stmt|,
modifier|*
name|getstr
argument_list|()
decl_stmt|,
modifier|*
name|getint
argument_list|()
decl_stmt|;
specifier|extern
name|char
modifier|*
name|setbrk
parameter_list|()
function_decl|;
name|struct
name|stat
name|stbuf
decl_stmt|;
name|char
name|check
index|[
literal|50
index|]
decl_stmt|;
name|strcat
argument_list|(
name|termtab
argument_list|,
name|devname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|termtab
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|errprint
argument_list|(
literal|"cannot open %s"
argument_list|,
name|termtab
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|stbuf
argument_list|)
expr_stmt|;
name|codestr
operator|=
name|setbrk
argument_list|(
operator|(
name|int
operator|)
name|stbuf
operator|.
name|st_size
argument_list|)
expr_stmt|;
name|nread
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|codestr
argument_list|,
operator|(
name|int
operator|)
name|stbuf
operator|.
name|st_size
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|p
operator|=
name|codestr
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
comment|/* skip over type, could check */
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getint
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|.
name|bset
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getint
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|.
name|breset
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getint
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|.
name|Hor
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getint
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|.
name|Vert
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getint
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|.
name|Newline
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getint
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|.
name|Char
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getint
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|.
name|Em
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getint
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|.
name|Halfline
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getint
argument_list|(
name|p
argument_list|,
operator|&
name|t
operator|.
name|Adj
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|twinit
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|twrest
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|twnl
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|hlr
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|hlf
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|flr
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|bdon
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|bdoff
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|iton
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|itoff
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|ploton
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|plotoff
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|up
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|down
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|right
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|left
operator|=
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|skipstr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|t
operator|.
name|eject
operator|=
name|p
argument_list|)
expr_stmt|;
name|getstr
argument_list|(
name|p
argument_list|,
name|check
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|check
argument_list|,
literal|"charset"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|errprint
argument_list|(
literal|"device table apparently curdled"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
name|t
operator|.
name|width
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
comment|/* default ascii widths */
name|i
operator|=
literal|0
expr_stmt|;
comment|/* this ought to be a pointer array and in place in codestr */
name|cp
operator|=
name|chname
operator|+
literal|1
expr_stmt|;
comment|/* bug if starts at 0, in setch */
while|while
condition|(
name|p
operator|<
name|codestr
operator|+
name|nread
condition|)
block|{
while|while
condition|(
operator|*
name|p
operator|==
literal|' '
operator|||
operator|*
name|p
operator|==
literal|'\t'
operator|||
operator|*
name|p
operator|==
literal|'\n'
condition|)
name|p
operator|++
expr_stmt|;
name|chtab
index|[
name|i
index|]
operator|=
name|cp
operator|-
name|chname
expr_stmt|;
comment|/* index, not pointer */
operator|*
name|cp
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
comment|/* 2-char names */
operator|*
name|cp
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|==
literal|' '
operator|||
operator|*
name|p
operator|==
literal|'\t'
condition|)
name|p
operator|++
expr_stmt|;
name|t
operator|.
name|width
index|[
name|i
operator|+
literal|128
index|]
operator|=
operator|*
name|p
operator|++
operator|-
literal|'0'
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|==
literal|' '
operator|||
operator|*
name|p
operator|==
literal|'\t'
condition|)
name|p
operator|++
expr_stmt|;
name|t
operator|.
name|codetab
index|[
name|i
index|]
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|getstr
argument_list|(
name|p
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* compress string */
name|p
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|sps
operator|=
name|EM
expr_stmt|;
name|ics
operator|=
name|EM
operator|*
literal|2
expr_stmt|;
name|dtab
operator|=
literal|8
operator|*
name|t
operator|.
name|Em
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|tabtab
index|[
name|i
index|]
operator|=
name|dtab
operator|*
operator|(
name|i
operator|+
literal|1
operator|)
expr_stmt|;
name|pl
operator|=
literal|11
operator|*
name|INCH
expr_stmt|;
name|po
operator|=
name|PO
expr_stmt|;
name|spacesz
operator|=
name|SS
expr_stmt|;
name|lss
operator|=
name|lss1
operator|=
name|VS
expr_stmt|;
name|ll
operator|=
name|ll1
operator|=
name|lt
operator|=
name|lt1
operator|=
name|LL
expr_stmt|;
name|smnt
operator|=
name|nfonts
operator|=
literal|5
expr_stmt|;
comment|/* R I B BI S */
name|specnames
argument_list|()
expr_stmt|;
comment|/* install names like "hyphen", etc. */
if|if
condition|(
name|eqflg
condition|)
name|t
operator|.
name|Adj
operator|=
name|t
operator|.
name|Hor
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|skipstr
parameter_list|(
name|s
parameter_list|)
comment|/* skip over leading space plus string */
name|char
modifier|*
name|s
decl_stmt|;
block|{
while|while
condition|(
operator|*
name|s
operator|==
literal|' '
operator|||
operator|*
name|s
operator|==
literal|'\t'
operator|||
operator|*
name|s
operator|==
literal|'\n'
condition|)
name|s
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|s
operator|!=
literal|' '
operator|&&
operator|*
name|s
operator|!=
literal|'\t'
operator|&&
operator|*
name|s
operator|!=
literal|'\n'
condition|)
if|if
condition|(
operator|*
name|s
operator|++
operator|==
literal|'\\'
condition|)
name|s
operator|++
expr_stmt|;
return|return
name|s
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|getstr
parameter_list|(
name|s
parameter_list|,
name|t
parameter_list|)
comment|/* find next string in s, copy to t */
name|char
modifier|*
name|s
decl_stmt|,
decl|*
name|t
decl_stmt|;
end_function

begin_block
block|{
name|int
name|quote
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|*
name|s
operator|==
literal|' '
operator|||
operator|*
name|s
operator|==
literal|'\t'
operator|||
operator|*
name|s
operator|==
literal|'\n'
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|==
literal|'"'
condition|)
block|{
name|s
operator|++
expr_stmt|;
name|quote
operator|=
literal|1
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|quote
operator|&&
operator|*
name|s
operator|==
literal|'"'
condition|)
block|{
name|s
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|quote
operator|&&
operator|(
operator|*
name|s
operator|==
literal|' '
operator|||
operator|*
name|s
operator|==
literal|'\t'
operator|||
operator|*
name|s
operator|==
literal|'\n'
operator|)
condition|)
break|break;
if|if
condition|(
operator|*
name|s
operator|!=
literal|'\\'
condition|)
operator|*
name|t
operator|++
operator|=
operator|*
name|s
operator|++
expr_stmt|;
else|else
block|{
name|s
operator|++
expr_stmt|;
comment|/* skip \\ */
if|if
condition|(
name|isdigit
argument_list|(
name|s
index|[
literal|0
index|]
argument_list|)
operator|&&
name|isdigit
argument_list|(
name|s
index|[
literal|1
index|]
argument_list|)
operator|&&
name|isdigit
argument_list|(
name|s
index|[
literal|2
index|]
argument_list|)
condition|)
block|{
operator|*
name|t
operator|++
operator|=
operator|(
name|s
index|[
literal|0
index|]
operator|-
literal|'0'
operator|)
operator|<<
literal|6
operator||
operator|(
name|s
index|[
literal|1
index|]
operator|-
literal|'0'
operator|)
operator|<<
literal|3
operator||
name|s
index|[
literal|2
index|]
operator|-
literal|'0'
expr_stmt|;
name|s
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isdigit
argument_list|(
name|s
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
operator|*
name|t
operator|++
operator|=
operator|*
name|s
operator|-
literal|'0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|s
operator|==
literal|'b'
condition|)
block|{
operator|*
name|t
operator|++
operator|=
literal|'\b'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|s
operator|==
literal|'n'
condition|)
block|{
operator|*
name|t
operator|++
operator|=
literal|'\n'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|s
operator|==
literal|'r'
condition|)
block|{
operator|*
name|t
operator|++
operator|=
literal|'\r'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|s
operator|==
literal|'t'
condition|)
block|{
operator|*
name|t
operator|++
operator|=
literal|'\t'
expr_stmt|;
block|}
else|else
block|{
operator|*
name|t
operator|++
operator|=
operator|*
name|s
expr_stmt|;
block|}
name|s
operator|++
expr_stmt|;
block|}
block|}
operator|*
name|t
operator|=
literal|'\0'
expr_stmt|;
return|return
name|s
return|;
block|}
end_block

begin_function
name|char
modifier|*
name|getint
parameter_list|(
name|s
parameter_list|,
name|pn
parameter_list|)
comment|/* find integer at s */
name|char
modifier|*
name|s
decl_stmt|;
name|int
modifier|*
name|pn
decl_stmt|;
block|{
while|while
condition|(
operator|*
name|s
operator|==
literal|' '
operator|||
operator|*
name|s
operator|==
literal|'\t'
operator|||
operator|*
name|s
operator|==
literal|'\n'
condition|)
name|s
operator|++
expr_stmt|;
operator|*
name|pn
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|)
operator|*
name|pn
operator|=
literal|10
operator|*
operator|*
name|pn
operator|+
operator|*
name|s
operator|++
operator|-
literal|'0'
expr_stmt|;
return|return
name|s
return|;
block|}
end_function

begin_macro
name|specnames
argument_list|()
end_macro

begin_block
block|{
specifier|static
struct|struct
block|{
name|int
modifier|*
name|n
decl_stmt|;
name|char
modifier|*
name|v
decl_stmt|;
block|}
name|spnames
index|[]
init|=
block|{
operator|&
name|c_hyphen
block|,
literal|"hy"
block|,
operator|&
name|c_emdash
block|,
literal|"em"
block|,
operator|&
name|c_rule
block|,
literal|"ru"
block|,
operator|&
name|c_minus
block|,
literal|"\\-"
block|,
operator|&
name|c_fi
block|,
literal|"fi"
block|,
operator|&
name|c_fl
block|,
literal|"fl"
block|,
operator|&
name|c_ff
block|,
literal|"ff"
block|,
operator|&
name|c_ffi
block|,
literal|"Fi"
block|,
operator|&
name|c_ffl
block|,
literal|"Fl"
block|,
operator|&
name|c_acute
block|,
literal|"aa"
block|,
operator|&
name|c_grave
block|,
literal|"ga"
block|,
operator|&
name|c_under
block|,
literal|"ul"
block|,
operator|&
name|c_rooten
block|,
literal|"rn"
block|,
operator|&
name|c_boxrule
block|,
literal|"br"
block|,
operator|&
name|c_lefthand
block|,
literal|"lh"
block|,
operator|&
name|c_isalnum
block|,
literal|"__"
block|,
literal|0
block|,
literal|0
block|}
struct|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|spnames
index|[
name|i
index|]
operator|.
name|n
condition|;
name|i
operator|++
control|)
operator|*
name|spnames
index|[
name|i
index|]
operator|.
name|n
operator|=
name|findch
argument_list|(
name|spnames
index|[
name|i
index|]
operator|.
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|c_isalnum
operator|==
literal|0
condition|)
name|c_isalnum
operator|=
name|NROFFCHARS
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|findch
argument_list|(
name|s
argument_list|)
comment|/* find char s in chname */
specifier|register
name|char
operator|*
name|s
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|chtab
index|[
name|i
index|]
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|s
argument_list|,
operator|&
name|chname
index|[
name|chtab
index|[
name|i
index|]
index|]
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|i
operator|+
literal|128
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|twdone
argument_list|()
end_macro

begin_block
block|{
name|int
name|waitf
decl_stmt|;
name|obufp
operator|=
name|obuf
expr_stmt|;
name|oputs
argument_list|(
name|t
operator|.
name|twrest
argument_list|)
expr_stmt|;
name|flusho
argument_list|()
expr_stmt|;
if|if
condition|(
name|pipeflg
condition|)
block|{
name|close
argument_list|(
name|ptid
argument_list|)
expr_stmt|;
name|wait
argument_list|(
operator|&
name|waitf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ttysave
operator|!=
operator|-
literal|1
condition|)
block|{
name|ttys
operator|.
name|sg_flags
operator|=
name|ttysave
expr_stmt|;
name|stty
argument_list|(
literal|1
argument_list|,
operator|&
name|ttys
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|ptout
argument_list|(
argument|i
argument_list|)
end_macro

begin_decl_stmt
name|tchar
name|i
decl_stmt|;
end_decl_stmt

begin_block
block|{
operator|*
name|olinep
operator|++
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|olinep
operator|>=
operator|&
name|oline
index|[
name|LNSIZE
index|]
condition|)
name|olinep
operator|--
expr_stmt|;
if|if
condition|(
name|cbits
argument_list|(
name|i
argument_list|)
operator|!=
literal|'\n'
condition|)
return|return;
name|olinep
operator|--
expr_stmt|;
name|lead
operator|+=
name|dip
operator|->
name|blss
operator|+
name|lss
operator|-
name|t
operator|.
name|Newline
expr_stmt|;
name|dip
operator|->
name|blss
operator|=
literal|0
expr_stmt|;
name|esct
operator|=
name|esc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|olinep
operator|>
name|oline
condition|)
block|{
name|move
argument_list|()
expr_stmt|;
name|ptout1
argument_list|()
expr_stmt|;
name|oputs
argument_list|(
name|t
operator|.
name|twnl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lead
operator|+=
name|t
operator|.
name|Newline
expr_stmt|;
name|move
argument_list|()
expr_stmt|;
block|}
name|lead
operator|+=
name|dip
operator|->
name|alss
expr_stmt|;
name|dip
operator|->
name|alss
operator|=
literal|0
expr_stmt|;
name|olinep
operator|=
name|oline
expr_stmt|;
block|}
end_block

begin_macro
name|ptout1
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|k
expr_stmt|;
specifier|register
name|char
modifier|*
name|codep
decl_stmt|;
specifier|extern
name|char
modifier|*
name|plot
parameter_list|()
function_decl|;
name|int
name|w
decl_stmt|,
name|j
decl_stmt|,
name|phyw
decl_stmt|;
name|tchar
modifier|*
name|q
decl_stmt|,
name|i
decl_stmt|;
specifier|static
name|int
name|oxfont
init|=
name|FT
decl_stmt|;
comment|/* start off in roman */
for|for
control|(
name|q
operator|=
name|oline
init|;
name|q
operator|<
name|olinep
condition|;
name|q
operator|++
control|)
block|{
name|i
operator|=
operator|*
name|q
expr_stmt|;
if|if
condition|(
name|ismot
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|j
operator|=
name|absmot
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|isnmot
argument_list|(
name|i
argument_list|)
condition|)
name|j
operator|=
operator|-
name|j
expr_stmt|;
if|if
condition|(
name|isvmot
argument_list|(
name|i
argument_list|)
condition|)
name|lead
operator|+=
name|j
expr_stmt|;
else|else
name|esc
operator|+=
name|j
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|k
operator|=
name|cbits
argument_list|(
name|i
argument_list|)
operator|)
operator|<=
literal|040
condition|)
block|{
switch|switch
condition|(
name|k
condition|)
block|{
case|case
literal|' '
case|:
comment|/*space*/
name|esc
operator|+=
name|t
operator|.
name|Char
expr_stmt|;
break|break;
case|case
literal|'\033'
case|:
case|case
literal|'\007'
case|:
case|case
literal|'\016'
case|:
case|case
literal|'\017'
case|:
name|oput
argument_list|(
name|k
argument_list|)
expr_stmt|;
break|break;
block|}
continue|continue;
block|}
name|phyw
operator|=
name|w
operator|=
name|t
operator|.
name|Char
operator|*
name|t
operator|.
name|width
index|[
name|k
index|]
expr_stmt|;
if|if
condition|(
name|iszbit
argument_list|(
name|i
argument_list|)
condition|)
name|w
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|esc
operator|||
name|lead
condition|)
name|move
argument_list|()
expr_stmt|;
name|esct
operator|+=
name|w
expr_stmt|;
name|xfont
operator|=
name|fbits
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfont
operator|!=
name|oxfont
condition|)
block|{
switch|switch
condition|(
name|oxfont
condition|)
block|{
case|case
name|ULFONT
case|:
name|oputs
argument_list|(
name|t
operator|.
name|itoff
argument_list|)
expr_stmt|;
break|break;
case|case
name|BDFONT
case|:
name|oputs
argument_list|(
name|t
operator|.
name|bdoff
argument_list|)
expr_stmt|;
break|break;
case|case
name|BIFONT
case|:
name|oputs
argument_list|(
name|t
operator|.
name|itoff
argument_list|)
expr_stmt|;
name|oputs
argument_list|(
name|t
operator|.
name|bdoff
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|xfont
condition|)
block|{
case|case
name|ULFONT
case|:
if|if
condition|(
operator|*
name|t
operator|.
name|iton
operator|&
literal|0377
condition|)
name|oputs
argument_list|(
name|t
operator|.
name|iton
argument_list|)
expr_stmt|;
break|break;
case|case
name|BDFONT
case|:
if|if
condition|(
operator|*
name|t
operator|.
name|bdon
operator|&
literal|0377
condition|)
name|oputs
argument_list|(
name|t
operator|.
name|bdon
argument_list|)
expr_stmt|;
break|break;
case|case
name|BIFONT
case|:
if|if
condition|(
operator|*
name|t
operator|.
name|bdon
operator|&
literal|0377
condition|)
name|oputs
argument_list|(
name|t
operator|.
name|bdon
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|t
operator|.
name|iton
operator|&
literal|0377
condition|)
name|oputs
argument_list|(
name|t
operator|.
name|iton
argument_list|)
expr_stmt|;
break|break;
block|}
name|oxfont
operator|=
name|xfont
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|xfont
operator|==
name|ULFONT
operator|||
name|xfont
operator|==
name|BIFONT
operator|)
operator|&&
operator|!
operator|(
operator|*
name|t
operator|.
name|iton
operator|&
literal|0377
operator|)
condition|)
block|{
for|for
control|(
name|j
operator|=
name|w
operator|/
name|t
operator|.
name|Char
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
name|oput
argument_list|(
literal|'_'
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
name|w
operator|/
name|t
operator|.
name|Char
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
name|oput
argument_list|(
literal|'\b'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|t
operator|.
name|bdon
operator|&
literal|0377
operator|)
operator|&&
operator|(
operator|(
name|j
operator|=
name|bdtab
index|[
name|xfont
index|]
operator|)
operator|||
name|xfont
operator|==
name|BDFONT
operator|||
name|xfont
operator|==
name|BIFONT
operator|)
condition|)
name|j
operator|++
expr_stmt|;
else|else
name|j
operator|=
literal|1
expr_stmt|;
comment|/* number of overstrikes for bold */
if|if
condition|(
name|k
operator|<
literal|128
condition|)
block|{
comment|/* ordinary ascii */
name|oput
argument_list|(
name|k
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|j
operator|>
literal|0
condition|)
block|{
name|oput
argument_list|(
literal|'\b'
argument_list|)
expr_stmt|;
name|oput
argument_list|(
name|k
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|int
name|oj
init|=
name|j
decl_stmt|;
name|codep
operator|=
name|t
operator|.
name|codetab
index|[
name|k
operator|-
literal|128
index|]
expr_stmt|;
while|while
condition|(
operator|*
name|codep
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|codep
operator|&
literal|0200
condition|)
block|{
name|codep
operator|=
name|plot
argument_list|(
name|codep
argument_list|)
expr_stmt|;
name|oput
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|codep
operator|==
literal|'%'
condition|)
comment|/* escape */
name|codep
operator|++
expr_stmt|;
name|oput
argument_list|(
operator|*
name|codep
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|codep
operator|!=
literal|'\b'
condition|)
for|for
control|(
name|j
operator|=
name|oj
init|;
operator|--
name|j
operator|>
literal|0
condition|;
control|)
block|{
name|oput
argument_list|(
literal|'\b'
argument_list|)
expr_stmt|;
name|oput
argument_list|(
operator|*
name|codep
argument_list|)
expr_stmt|;
block|}
name|codep
operator|++
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|w
condition|)
for|for
control|(
name|j
operator|=
name|phyw
operator|/
name|t
operator|.
name|Char
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
name|oput
argument_list|(
literal|'\b'
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|char
modifier|*
name|plot
parameter_list|(
name|x
parameter_list|)
name|char
modifier|*
name|x
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|j
decl_stmt|,
modifier|*
name|k
decl_stmt|;
name|oputs
argument_list|(
name|t
operator|.
name|ploton
argument_list|)
expr_stmt|;
name|k
operator|=
name|x
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|k
operator|&
literal|0377
operator|)
operator|==
literal|0200
condition|)
name|k
operator|++
expr_stmt|;
for|for
control|(
init|;
operator|*
name|k
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|k
operator|==
literal|'%'
condition|)
block|{
comment|/* quote char within plot mode */
name|oput
argument_list|(
operator|*
operator|++
name|k
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|k
operator|&
literal|0200
condition|)
block|{
if|if
condition|(
operator|*
name|k
operator|&
literal|0100
condition|)
block|{
if|if
condition|(
operator|*
name|k
operator|&
literal|040
condition|)
name|j
operator|=
name|t
operator|.
name|up
expr_stmt|;
else|else
name|j
operator|=
name|t
operator|.
name|down
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|k
operator|&
literal|040
condition|)
name|j
operator|=
name|t
operator|.
name|left
expr_stmt|;
else|else
name|j
operator|=
name|t
operator|.
name|right
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|i
operator|=
operator|*
name|k
operator|&
literal|037
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 2nd 0200 turns it off */
operator|++
name|k
expr_stmt|;
break|break;
block|}
while|while
condition|(
name|i
operator|--
condition|)
name|oputs
argument_list|(
name|j
argument_list|)
expr_stmt|;
block|}
else|else
name|oput
argument_list|(
operator|*
name|k
argument_list|)
expr_stmt|;
block|}
name|oputs
argument_list|(
name|t
operator|.
name|plotoff
argument_list|)
expr_stmt|;
return|return
operator|(
name|k
operator|)
return|;
block|}
end_function

begin_macro
name|move
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|k
expr_stmt|;
specifier|register
name|char
modifier|*
name|i
decl_stmt|,
modifier|*
name|j
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|int
name|iesct
decl_stmt|,
name|dt
decl_stmt|;
name|iesct
operator|=
name|esct
expr_stmt|;
if|if
condition|(
name|esct
operator|+=
name|esc
condition|)
name|i
operator|=
literal|"\0"
expr_stmt|;
else|else
name|i
operator|=
literal|"\n\0"
expr_stmt|;
name|j
operator|=
name|t
operator|.
name|hlf
expr_stmt|;
name|p
operator|=
name|t
operator|.
name|right
expr_stmt|;
name|q
operator|=
name|t
operator|.
name|down
expr_stmt|;
if|if
condition|(
name|lead
condition|)
block|{
if|if
condition|(
name|lead
operator|<
literal|0
condition|)
block|{
name|lead
operator|=
operator|-
name|lead
expr_stmt|;
name|i
operator|=
name|t
operator|.
name|flr
expr_stmt|;
comment|/*	if(!esct)i = t.flr; else i = "\0";*/
name|j
operator|=
name|t
operator|.
name|hlr
expr_stmt|;
name|q
operator|=
name|t
operator|.
name|up
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|i
operator|&
literal|0377
condition|)
block|{
name|k
operator|=
name|lead
operator|/
name|t
operator|.
name|Newline
expr_stmt|;
name|lead
operator|=
name|lead
operator|%
name|t
operator|.
name|Newline
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
name|oputs
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|j
operator|&
literal|0377
condition|)
block|{
name|k
operator|=
name|lead
operator|/
name|t
operator|.
name|Halfline
expr_stmt|;
name|lead
operator|=
name|lead
operator|%
name|t
operator|.
name|Halfline
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
name|oputs
argument_list|(
name|j
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no half-line forward, not at line begining */
name|k
operator|=
name|lead
operator|/
name|t
operator|.
name|Newline
expr_stmt|;
name|lead
operator|=
name|lead
operator|%
name|t
operator|.
name|Newline
expr_stmt|;
if|if
condition|(
name|k
operator|>
literal|0
condition|)
name|esc
operator|=
name|esct
expr_stmt|;
name|i
operator|=
literal|"\n"
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
name|oputs
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|esc
condition|)
block|{
if|if
condition|(
name|esc
operator|<
literal|0
condition|)
block|{
name|esc
operator|=
operator|-
name|esc
expr_stmt|;
name|j
operator|=
literal|"\b"
expr_stmt|;
name|p
operator|=
name|t
operator|.
name|left
expr_stmt|;
block|}
else|else
block|{
name|j
operator|=
literal|" "
expr_stmt|;
if|if
condition|(
name|hflg
condition|)
while|while
condition|(
operator|(
name|dt
operator|=
name|dtab
operator|-
operator|(
name|iesct
operator|%
name|dtab
operator|)
operator|)
operator|<=
name|esc
condition|)
block|{
if|if
condition|(
name|dt
operator|%
name|t
operator|.
name|Em
condition|)
break|break;
name|oput
argument_list|(
name|TAB
argument_list|)
expr_stmt|;
name|esc
operator|-=
name|dt
expr_stmt|;
name|iesct
operator|+=
name|dt
expr_stmt|;
block|}
block|}
name|k
operator|=
name|esc
operator|/
name|t
operator|.
name|Em
expr_stmt|;
name|esc
operator|=
name|esc
operator|%
name|t
operator|.
name|Em
expr_stmt|;
while|while
condition|(
name|k
operator|--
condition|)
name|oputs
argument_list|(
name|j
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|t
operator|.
name|ploton
operator|&
literal|0377
operator|)
operator|&&
operator|(
name|esc
operator|||
name|lead
operator|)
condition|)
block|{
name|oputs
argument_list|(
name|t
operator|.
name|ploton
argument_list|)
expr_stmt|;
name|esc
operator|/=
name|t
operator|.
name|Hor
expr_stmt|;
name|lead
operator|/=
name|t
operator|.
name|Vert
expr_stmt|;
while|while
condition|(
name|esc
operator|--
condition|)
name|oputs
argument_list|(
name|p
argument_list|)
expr_stmt|;
while|while
condition|(
name|lead
operator|--
condition|)
name|oputs
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|oputs
argument_list|(
name|t
operator|.
name|plotoff
argument_list|)
expr_stmt|;
block|}
name|esc
operator|=
name|lead
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|ptlead
argument_list|()
end_macro

begin_block
block|{
name|move
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|dostop
argument_list|()
end_macro

begin_block
block|{
name|char
name|junk
decl_stmt|;
name|flusho
argument_list|()
expr_stmt|;
name|read
argument_list|(
literal|2
argument_list|,
operator|&
name|junk
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|newpage
argument_list|()
end_macro

begin_block
block|{
empty_stmt|;
block|}
end_block

begin_macro
name|pttrailer
argument_list|()
end_macro

begin_block
block|{
empty_stmt|;
block|}
end_block

end_unit


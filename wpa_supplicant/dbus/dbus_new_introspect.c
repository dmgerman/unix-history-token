begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant - D-Bus introspection  * Copyright (c) 2006, Dan Williams<dcbw@redhat.com> and Red Hat, Inc.  * Copyright (c) 2009, Witold Sowa<witold.sowa@gmail.com>  * Copyright (c) 2010, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/list.h"
end_include

begin_include
include|#
directive|include
file|"utils/wpabuf.h"
end_include

begin_include
include|#
directive|include
file|"dbus_common_i.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new_helpers.h"
end_include

begin_struct
struct|struct
name|interfaces
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|char
modifier|*
name|dbus_interface
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|xml
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|struct
name|interfaces
modifier|*
name|add_interface
parameter_list|(
name|struct
name|dl_list
modifier|*
name|list
parameter_list|,
specifier|const
name|char
modifier|*
name|dbus_interface
parameter_list|)
block|{
name|struct
name|interfaces
modifier|*
name|iface
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|iface
argument_list|,
argument|list
argument_list|,
argument|struct interfaces
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|iface
operator|->
name|dbus_interface
argument_list|,
name|dbus_interface
argument_list|)
operator|==
literal|0
condition|)
return|return
name|iface
return|;
comment|/* already in the list */
block|}
name|iface
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|interfaces
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iface
condition|)
return|return
name|NULL
return|;
name|iface
operator|->
name|dbus_interface
operator|=
name|os_strdup
argument_list|(
name|dbus_interface
argument_list|)
expr_stmt|;
name|iface
operator|->
name|xml
operator|=
name|wpabuf_alloc
argument_list|(
literal|6000
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|dbus_interface
operator|==
name|NULL
operator|||
name|iface
operator|->
name|xml
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|iface
operator|->
name|dbus_interface
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|iface
operator|->
name|xml
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|iface
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_printf
argument_list|(
name|iface
operator|->
name|xml
argument_list|,
literal|"<interface name=\"%s\">"
argument_list|,
name|dbus_interface
argument_list|)
expr_stmt|;
name|dl_list_add_tail
argument_list|(
name|list
argument_list|,
operator|&
name|iface
operator|->
name|list
argument_list|)
expr_stmt|;
return|return
name|iface
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_arg
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|xml
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|direction
parameter_list|)
block|{
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"<arg name=\"%s\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
condition|)
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|" type=\"%s\""
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|direction
condition|)
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|" direction=\"%s\""
argument_list|,
name|direction
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|xml
argument_list|,
literal|"/>"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_entry
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|xml
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|struct
name|wpa_dbus_argument
modifier|*
name|args
parameter_list|,
name|int
name|include_dir
parameter_list|)
block|{
specifier|const
name|struct
name|wpa_dbus_argument
modifier|*
name|arg
decl_stmt|;
if|if
condition|(
name|args
operator|==
name|NULL
operator|||
name|args
operator|->
name|name
operator|==
name|NULL
condition|)
block|{
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"<%s name=\"%s\"/>"
argument_list|,
name|type
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"<%s name=\"%s\">"
argument_list|,
name|type
argument_list|,
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|arg
operator|=
name|args
init|;
name|arg
operator|&&
name|arg
operator|->
name|name
condition|;
name|arg
operator|++
control|)
block|{
name|add_arg
argument_list|(
name|xml
argument_list|,
name|arg
operator|->
name|name
argument_list|,
name|arg
operator|->
name|type
argument_list|,
name|include_dir
condition|?
operator|(
name|arg
operator|->
name|dir
operator|==
name|ARG_IN
condition|?
literal|"in"
else|:
literal|"out"
operator|)
else|:
name|NULL
argument_list|)
expr_stmt|;
block|}
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"</%s>"
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_property
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|xml
parameter_list|,
specifier|const
name|struct
name|wpa_dbus_property_desc
modifier|*
name|dsc
parameter_list|)
block|{
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"<property name=\"%s\" type=\"%s\" "
literal|"access=\"%s%s\"/>"
argument_list|,
name|dsc
operator|->
name|dbus_property
argument_list|,
name|dsc
operator|->
name|type
argument_list|,
name|dsc
operator|->
name|getter
condition|?
literal|"read"
else|:
literal|""
argument_list|,
name|dsc
operator|->
name|setter
condition|?
literal|"write"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|extract_interfaces_methods
parameter_list|(
name|struct
name|dl_list
modifier|*
name|list
parameter_list|,
specifier|const
name|struct
name|wpa_dbus_method_desc
modifier|*
name|methods
parameter_list|)
block|{
specifier|const
name|struct
name|wpa_dbus_method_desc
modifier|*
name|dsc
decl_stmt|;
name|struct
name|interfaces
modifier|*
name|iface
decl_stmt|;
for|for
control|(
name|dsc
operator|=
name|methods
init|;
name|dsc
operator|&&
name|dsc
operator|->
name|dbus_method
condition|;
name|dsc
operator|++
control|)
block|{
name|iface
operator|=
name|add_interface
argument_list|(
name|list
argument_list|,
name|dsc
operator|->
name|dbus_interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
condition|)
name|add_entry
argument_list|(
name|iface
operator|->
name|xml
argument_list|,
literal|"method"
argument_list|,
name|dsc
operator|->
name|dbus_method
argument_list|,
name|dsc
operator|->
name|args
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|extract_interfaces_signals
parameter_list|(
name|struct
name|dl_list
modifier|*
name|list
parameter_list|,
specifier|const
name|struct
name|wpa_dbus_signal_desc
modifier|*
name|signals
parameter_list|)
block|{
specifier|const
name|struct
name|wpa_dbus_signal_desc
modifier|*
name|dsc
decl_stmt|;
name|struct
name|interfaces
modifier|*
name|iface
decl_stmt|;
for|for
control|(
name|dsc
operator|=
name|signals
init|;
name|dsc
operator|&&
name|dsc
operator|->
name|dbus_signal
condition|;
name|dsc
operator|++
control|)
block|{
name|iface
operator|=
name|add_interface
argument_list|(
name|list
argument_list|,
name|dsc
operator|->
name|dbus_interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
condition|)
name|add_entry
argument_list|(
name|iface
operator|->
name|xml
argument_list|,
literal|"signal"
argument_list|,
name|dsc
operator|->
name|dbus_signal
argument_list|,
name|dsc
operator|->
name|args
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|extract_interfaces_properties
parameter_list|(
name|struct
name|dl_list
modifier|*
name|list
parameter_list|,
specifier|const
name|struct
name|wpa_dbus_property_desc
modifier|*
name|properties
parameter_list|)
block|{
specifier|const
name|struct
name|wpa_dbus_property_desc
modifier|*
name|dsc
decl_stmt|;
name|struct
name|interfaces
modifier|*
name|iface
decl_stmt|;
for|for
control|(
name|dsc
operator|=
name|properties
init|;
name|dsc
operator|&&
name|dsc
operator|->
name|dbus_property
condition|;
name|dsc
operator|++
control|)
block|{
name|iface
operator|=
name|add_interface
argument_list|(
name|list
argument_list|,
name|dsc
operator|->
name|dbus_interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
condition|)
name|add_property
argument_list|(
name|iface
operator|->
name|xml
argument_list|,
name|dsc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * extract_interfaces - Extract interfaces from methods, signals and props  * @list: Interface list to be filled  * @obj_dsc: Description of object from which interfaces will be extracted  *  * Iterates over all methods, signals, and properties registered with an  * object and collects all declared DBus interfaces and create interfaces'  * node in XML root node for each. Returned list elements contain interface  * name and XML node of corresponding interface.  */
end_comment

begin_function
specifier|static
name|void
name|extract_interfaces
parameter_list|(
name|struct
name|dl_list
modifier|*
name|list
parameter_list|,
name|struct
name|wpa_dbus_object_desc
modifier|*
name|obj_dsc
parameter_list|)
block|{
name|extract_interfaces_methods
argument_list|(
name|list
argument_list|,
name|obj_dsc
operator|->
name|methods
argument_list|)
expr_stmt|;
name|extract_interfaces_signals
argument_list|(
name|list
argument_list|,
name|obj_dsc
operator|->
name|signals
argument_list|)
expr_stmt|;
name|extract_interfaces_properties
argument_list|(
name|list
argument_list|,
name|obj_dsc
operator|->
name|properties
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_interfaces
parameter_list|(
name|struct
name|dl_list
modifier|*
name|list
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|xml
parameter_list|)
block|{
name|struct
name|interfaces
modifier|*
name|iface
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|iface
argument_list|,
argument|n
argument_list|,
argument|list
argument_list|,
argument|struct interfaces
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpabuf_len
argument_list|(
name|iface
operator|->
name|xml
argument_list|)
operator|+
literal|20
operator|<
name|wpabuf_tailroom
argument_list|(
name|xml
argument_list|)
condition|)
block|{
name|wpabuf_put_buf
argument_list|(
name|xml
argument_list|,
name|iface
operator|->
name|xml
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|xml
argument_list|,
literal|"</interface>"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: Not enough room for add_interfaces inspect data: tailroom %u, add %u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|wpabuf_tailroom
argument_list|(
name|xml
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|wpabuf_len
argument_list|(
name|iface
operator|->
name|xml
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|dl_list_del
argument_list|(
operator|&
name|iface
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|iface
operator|->
name|xml
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|iface
operator|->
name|dbus_interface
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|iface
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|add_child_nodes
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|xml
parameter_list|,
name|DBusConnection
modifier|*
name|con
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|children
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* add child nodes to introspection tree */
name|dbus_connection_list_registered
argument_list|(
name|con
argument_list|,
name|path
argument_list|,
operator|&
name|children
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|children
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"<node name=\"%s\"/>"
argument_list|,
name|children
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|dbus_free_string_array
argument_list|(
name|children
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_introspectable_interface
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|xml
parameter_list|)
block|{
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"<interface name=\"%s\">"
literal|"<method name=\"%s\">"
literal|"<arg name=\"data\" type=\"s\" direction=\"out\"/>"
literal|"</method>"
literal|"</interface>"
argument_list|,
name|WPA_DBUS_INTROSPECTION_INTERFACE
argument_list|,
name|WPA_DBUS_INTROSPECTION_METHOD
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_properties_interface
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|xml
parameter_list|)
block|{
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"<interface name=\"%s\">"
argument_list|,
name|WPA_DBUS_PROPERTIES_INTERFACE
argument_list|)
expr_stmt|;
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"<method name=\"%s\">"
argument_list|,
name|WPA_DBUS_PROPERTIES_GET
argument_list|)
expr_stmt|;
name|add_arg
argument_list|(
name|xml
argument_list|,
literal|"interface"
argument_list|,
literal|"s"
argument_list|,
literal|"in"
argument_list|)
expr_stmt|;
name|add_arg
argument_list|(
name|xml
argument_list|,
literal|"propname"
argument_list|,
literal|"s"
argument_list|,
literal|"in"
argument_list|)
expr_stmt|;
name|add_arg
argument_list|(
name|xml
argument_list|,
literal|"value"
argument_list|,
literal|"v"
argument_list|,
literal|"out"
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|xml
argument_list|,
literal|"</method>"
argument_list|)
expr_stmt|;
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"<method name=\"%s\">"
argument_list|,
name|WPA_DBUS_PROPERTIES_GETALL
argument_list|)
expr_stmt|;
name|add_arg
argument_list|(
name|xml
argument_list|,
literal|"interface"
argument_list|,
literal|"s"
argument_list|,
literal|"in"
argument_list|)
expr_stmt|;
name|add_arg
argument_list|(
name|xml
argument_list|,
literal|"props"
argument_list|,
literal|"a{sv}"
argument_list|,
literal|"out"
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|xml
argument_list|,
literal|"</method>"
argument_list|)
expr_stmt|;
name|wpabuf_printf
argument_list|(
name|xml
argument_list|,
literal|"<method name=\"%s\">"
argument_list|,
name|WPA_DBUS_PROPERTIES_SET
argument_list|)
expr_stmt|;
name|add_arg
argument_list|(
name|xml
argument_list|,
literal|"interface"
argument_list|,
literal|"s"
argument_list|,
literal|"in"
argument_list|)
expr_stmt|;
name|add_arg
argument_list|(
name|xml
argument_list|,
literal|"propname"
argument_list|,
literal|"s"
argument_list|,
literal|"in"
argument_list|)
expr_stmt|;
name|add_arg
argument_list|(
name|xml
argument_list|,
literal|"value"
argument_list|,
literal|"v"
argument_list|,
literal|"in"
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|xml
argument_list|,
literal|"</method>"
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|xml
argument_list|,
literal|"</interface>"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_wpas_interfaces
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|xml
parameter_list|,
name|struct
name|wpa_dbus_object_desc
modifier|*
name|obj_dsc
parameter_list|)
block|{
name|struct
name|dl_list
name|ifaces
decl_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|ifaces
argument_list|)
expr_stmt|;
name|extract_interfaces
argument_list|(
operator|&
name|ifaces
argument_list|,
name|obj_dsc
argument_list|)
expr_stmt|;
name|add_interfaces
argument_list|(
operator|&
name|ifaces
argument_list|,
name|xml
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_dbus_introspect - Responds for Introspect calls on object  * @message: Message with Introspect call  * @obj_dsc: Object description on which Introspect was called  * Returns: Message with introspection result XML string as only argument  *  * Iterates over all methods, signals and properties registered with  * object and generates introspection data for the object as XML string.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpa_dbus_introspect
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_dbus_object_desc
modifier|*
name|obj_dsc
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|xml
decl_stmt|;
name|xml
operator|=
name|wpabuf_alloc
argument_list|(
literal|15000
argument_list|)
expr_stmt|;
if|if
condition|(
name|xml
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpabuf_put_str
argument_list|(
name|xml
argument_list|,
literal|"<?xml version=\"1.0\"?>\n"
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|xml
argument_list|,
name|DBUS_INTROSPECT_1_0_XML_DOCTYPE_DECL_NODE
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|xml
argument_list|,
literal|"<node>"
argument_list|)
expr_stmt|;
name|add_introspectable_interface
argument_list|(
name|xml
argument_list|)
expr_stmt|;
name|add_properties_interface
argument_list|(
name|xml
argument_list|)
expr_stmt|;
name|add_wpas_interfaces
argument_list|(
name|xml
argument_list|,
name|obj_dsc
argument_list|)
expr_stmt|;
name|add_child_nodes
argument_list|(
name|xml
argument_list|,
name|obj_dsc
operator|->
name|connection
argument_list|,
name|dbus_message_get_path
argument_list|(
name|message
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|xml
argument_list|,
literal|"</node>\n"
argument_list|)
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
condition|)
block|{
specifier|const
name|char
modifier|*
name|intro_str
init|=
name|wpabuf_head
argument_list|(
name|xml
argument_list|)
decl_stmt|;
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|intro_str
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|xml
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

end_unit


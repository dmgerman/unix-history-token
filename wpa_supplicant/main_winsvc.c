begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / main() function for Win32 service  * Copyright (c) 2003-2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  * The root of wpa_supplicant configuration in registry is  * HKEY_LOCAL_MACHINE\\SOFTWARE\\%wpa_supplicant. This level includes global  * parameters and a 'interfaces' subkey with all the interface configuration  * (adapter to confname mapping). Each such mapping is a subkey that has  * 'adapter' and 'config' values.  *  * This program can be run either as a normal command line application, e.g.,  * for debugging, with 'wpasvc.exe app' or as a Windows service. Service need  * to be registered with 'wpasvc.exe reg<full path to wpasvc.exe>'. After  * this, it can be started like any other Windows service (e.g., 'net start  * wpasvc') or it can be configured to start automatically through the Services  * tool in administrative tasks. The service can be unregistered with  * 'wpasvc.exe unreg'.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|WPASVC_NAME
end_ifndef

begin_define
define|#
directive|define
name|WPASVC_NAME
value|TEXT("wpasvc")
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WPASVC_DISPLAY_NAME
end_ifndef

begin_define
define|#
directive|define
name|WPASVC_DISPLAY_NAME
value|TEXT("wpa_supplicant service")
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WPASVC_DESCRIPTION
end_ifndef

begin_define
define|#
directive|define
name|WPASVC_DESCRIPTION
define|\
value|TEXT("Provides IEEE 802.1X and WPA/WPA2 supplicant functionality")
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|HANDLE
name|kill_svc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|SERVICE_STATUS_HANDLE
name|svc_status_handle
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|SERVICE_STATUS
name|svc_status
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|WPA_KEY_ROOT
end_ifndef

begin_define
define|#
directive|define
name|WPA_KEY_ROOT
value|HKEY_LOCAL_MACHINE
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WPA_KEY_PREFIX
end_ifndef

begin_define
define|#
directive|define
name|WPA_KEY_PREFIX
value|TEXT("SOFTWARE\\wpa_supplicant")
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|UNICODE
end_ifdef

begin_define
define|#
directive|define
name|TSTR
value|"%S"
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* UNICODE */
end_comment

begin_define
define|#
directive|define
name|TSTR
value|"%s"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* UNICODE */
end_comment

begin_function
specifier|static
name|int
name|read_interface
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|HKEY
name|_hk
parameter_list|,
specifier|const
name|TCHAR
modifier|*
name|name
parameter_list|)
block|{
name|HKEY
name|hk
decl_stmt|;
define|#
directive|define
name|TBUFLEN
value|255
name|TCHAR
name|adapter
index|[
name|TBUFLEN
index|]
decl_stmt|,
name|config
index|[
name|TBUFLEN
index|]
decl_stmt|,
name|ctrl_interface
index|[
name|TBUFLEN
index|]
decl_stmt|;
name|DWORD
name|buflen
decl_stmt|,
name|val
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|struct
name|wpa_interface
name|iface
decl_stmt|;
name|int
name|skip_on_error
init|=
literal|0
decl_stmt|;
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|_hk
argument_list|,
name|name
argument_list|,
literal|0
argument_list|,
name|KEY_QUERY_VALUE
argument_list|,
operator|&
name|hk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"Could not open wpa_supplicant interface key\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|iface
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|iface
operator|.
name|driver
operator|=
literal|"ndis"
expr_stmt|;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|ctrl_interface
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"ctrl_interface"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
name|ctrl_interface
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_SUCCESS
condition|)
block|{
name|ctrl_interface
index|[
name|TBUFLEN
operator|-
literal|1
index|]
operator|=
name|TEXT
argument_list|(
literal|'\0'
argument_list|)
expr_stmt|;
name|wpa_unicode2ascii_inplace
argument_list|(
name|ctrl_interface
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ctrl_interface[len=%d] '%s'\n"
argument_list|,
operator|(
name|int
operator|)
name|buflen
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ctrl_interface
argument_list|)
expr_stmt|;
name|iface
operator|.
name|ctrl_interface
operator|=
operator|(
name|char
operator|*
operator|)
name|ctrl_interface
expr_stmt|;
block|}
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"adapter"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
name|adapter
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_SUCCESS
condition|)
block|{
name|adapter
index|[
name|TBUFLEN
operator|-
literal|1
index|]
operator|=
name|TEXT
argument_list|(
literal|'\0'
argument_list|)
expr_stmt|;
name|wpa_unicode2ascii_inplace
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"adapter[len=%d] '%s'\n"
argument_list|,
operator|(
name|int
operator|)
name|buflen
argument_list|,
operator|(
name|char
operator|*
operator|)
name|adapter
argument_list|)
expr_stmt|;
name|iface
operator|.
name|ifname
operator|=
operator|(
name|char
operator|*
operator|)
name|adapter
expr_stmt|;
block|}
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|config
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"config"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
name|config
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_SUCCESS
condition|)
block|{
name|config
index|[
sizeof|sizeof
argument_list|(
name|config
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_unicode2ascii_inplace
argument_list|(
name|config
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"config[len=%d] '%s'\n"
argument_list|,
operator|(
name|int
operator|)
name|buflen
argument_list|,
operator|(
name|char
operator|*
operator|)
name|config
argument_list|)
expr_stmt|;
name|iface
operator|.
name|confname
operator|=
operator|(
name|char
operator|*
operator|)
name|config
expr_stmt|;
block|}
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"skip_on_error"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
operator|&
name|val
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_SUCCESS
operator|&&
name|buflen
operator|==
sizeof|sizeof
argument_list|(
name|val
argument_list|)
condition|)
name|skip_on_error
operator|=
name|val
expr_stmt|;
name|RegCloseKey
argument_list|(
name|hk
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_add_iface
argument_list|(
name|global
argument_list|,
operator|&
name|iface
argument_list|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|skip_on_error
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Skipped interface '%s' due to "
literal|"initialization failure"
argument_list|,
name|iface
operator|.
name|ifname
argument_list|)
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_thread
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|exitcode
decl_stmt|;
name|struct
name|wpa_params
name|params
decl_stmt|;
name|struct
name|wpa_global
modifier|*
name|global
decl_stmt|;
name|HKEY
name|hk
decl_stmt|,
name|ihk
decl_stmt|;
name|DWORD
name|val
decl_stmt|,
name|buflen
decl_stmt|,
name|i
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
if|if
condition|(
name|os_program_init
argument_list|()
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|wpa_debug_level
operator|=
name|MSG_INFO
expr_stmt|;
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|WPA_KEY_ROOT
argument_list|,
name|WPA_KEY_PREFIX
argument_list|,
literal|0
argument_list|,
name|KEY_QUERY_VALUE
argument_list|,
operator|&
name|hk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"Could not open wpa_supplicant registry key\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"debug_level"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
operator|&
name|val
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_SUCCESS
operator|&&
name|buflen
operator|==
sizeof|sizeof
argument_list|(
name|val
argument_list|)
condition|)
block|{
name|params
operator|.
name|wpa_debug_level
operator|=
name|val
expr_stmt|;
block|}
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"debug_show_keys"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
operator|&
name|val
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_SUCCESS
operator|&&
name|buflen
operator|==
sizeof|sizeof
argument_list|(
name|val
argument_list|)
condition|)
block|{
name|params
operator|.
name|wpa_debug_show_keys
operator|=
name|val
expr_stmt|;
block|}
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"debug_timestamp"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
operator|&
name|val
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_SUCCESS
operator|&&
name|buflen
operator|==
sizeof|sizeof
argument_list|(
name|val
argument_list|)
condition|)
block|{
name|params
operator|.
name|wpa_debug_timestamp
operator|=
name|val
expr_stmt|;
block|}
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"debug_use_file"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
operator|&
name|val
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_SUCCESS
operator|&&
name|buflen
operator|==
sizeof|sizeof
argument_list|(
name|val
argument_list|)
operator|&&
name|val
condition|)
block|{
name|params
operator|.
name|wpa_debug_file_path
operator|=
literal|"\\Temp\\wpa_supplicant-log.txt"
expr_stmt|;
block|}
name|exitcode
operator|=
literal|0
expr_stmt|;
name|global
operator|=
name|wpa_supplicant_init
argument_list|(
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to initialize wpa_supplicant\n"
argument_list|)
expr_stmt|;
name|exitcode
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"interfaces"
argument_list|)
argument_list|,
literal|0
argument_list|,
name|KEY_ENUMERATE_SUB_KEYS
argument_list|,
operator|&
name|ihk
argument_list|)
expr_stmt|;
name|RegCloseKey
argument_list|(
name|hk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"Could not open wpa_supplicant interfaces registry "
literal|"key\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
name|TCHAR
name|name
index|[
literal|255
index|]
decl_stmt|;
name|DWORD
name|namelen
decl_stmt|;
name|namelen
operator|=
literal|255
expr_stmt|;
name|ret
operator|=
name|RegEnumKeyEx
argument_list|(
name|ihk
argument_list|,
name|i
argument_list|,
name|name
argument_list|,
operator|&
name|namelen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_NO_MORE_ITEMS
condition|)
break|break;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"RegEnumKeyEx failed: 0x%x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|namelen
operator|>=
literal|255
condition|)
name|namelen
operator|=
literal|255
operator|-
literal|1
expr_stmt|;
name|name
index|[
name|namelen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"interface %d: %s\n"
argument_list|,
operator|(
name|int
operator|)
name|i
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_interface
argument_list|(
name|global
argument_list|,
name|ihk
argument_list|,
name|name
argument_list|)
operator|<
literal|0
condition|)
name|exitcode
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|RegCloseKey
argument_list|(
name|ihk
argument_list|)
expr_stmt|;
if|if
condition|(
name|exitcode
operator|==
literal|0
condition|)
name|exitcode
operator|=
name|wpa_supplicant_run
argument_list|(
name|global
argument_list|)
expr_stmt|;
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
name|os_program_deinit
argument_list|()
expr_stmt|;
return|return
name|exitcode
return|;
block|}
end_function

begin_function
specifier|static
name|DWORD
name|svc_thread
parameter_list|(
name|LPDWORD
name|param
parameter_list|)
block|{
name|int
name|ret
init|=
name|wpa_supplicant_thread
argument_list|()
decl_stmt|;
name|svc_status
operator|.
name|dwCurrentState
operator|=
name|SERVICE_STOPPED
expr_stmt|;
name|svc_status
operator|.
name|dwWaitHint
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|SetServiceStatus
argument_list|(
name|svc_status_handle
argument_list|,
operator|&
name|svc_status
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"SetServiceStatus() failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|register_service
parameter_list|(
specifier|const
name|TCHAR
modifier|*
name|exe
parameter_list|)
block|{
name|SC_HANDLE
name|svc
decl_stmt|,
name|scm
decl_stmt|;
name|SERVICE_DESCRIPTION
name|sd
decl_stmt|;
name|printf
argument_list|(
literal|"Registering service: "
name|TSTR
literal|"\n"
argument_list|,
name|WPASVC_NAME
argument_list|)
expr_stmt|;
name|scm
operator|=
name|OpenSCManager
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|SC_MANAGER_CREATE_SERVICE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|scm
condition|)
block|{
name|printf
argument_list|(
literal|"OpenSCManager failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|svc
operator|=
name|CreateService
argument_list|(
name|scm
argument_list|,
name|WPASVC_NAME
argument_list|,
name|WPASVC_DISPLAY_NAME
argument_list|,
name|SERVICE_ALL_ACCESS
argument_list|,
name|SERVICE_WIN32_OWN_PROCESS
argument_list|,
name|SERVICE_DEMAND_START
argument_list|,
name|SERVICE_ERROR_NORMAL
argument_list|,
name|exe
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svc
condition|)
block|{
name|printf
argument_list|(
literal|"CreateService failed: %d\n\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|CloseServiceHandle
argument_list|(
name|scm
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|sd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sd
argument_list|)
argument_list|)
expr_stmt|;
name|sd
operator|.
name|lpDescription
operator|=
name|WPASVC_DESCRIPTION
expr_stmt|;
if|if
condition|(
operator|!
name|ChangeServiceConfig2
argument_list|(
name|svc
argument_list|,
name|SERVICE_CONFIG_DESCRIPTION
argument_list|,
operator|&
name|sd
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"ChangeServiceConfig2 failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
comment|/* This is not a fatal error, so continue anyway. */
block|}
name|CloseServiceHandle
argument_list|(
name|svc
argument_list|)
expr_stmt|;
name|CloseServiceHandle
argument_list|(
name|scm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Service registered successfully.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|unregister_service
parameter_list|(
name|void
parameter_list|)
block|{
name|SC_HANDLE
name|svc
decl_stmt|,
name|scm
decl_stmt|;
name|SERVICE_STATUS
name|status
decl_stmt|;
name|printf
argument_list|(
literal|"Unregistering service: "
name|TSTR
literal|"\n"
argument_list|,
name|WPASVC_NAME
argument_list|)
expr_stmt|;
name|scm
operator|=
name|OpenSCManager
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|SC_MANAGER_CREATE_SERVICE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|scm
condition|)
block|{
name|printf
argument_list|(
literal|"OpenSCManager failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|svc
operator|=
name|OpenService
argument_list|(
name|scm
argument_list|,
name|WPASVC_NAME
argument_list|,
name|SERVICE_ALL_ACCESS
operator||
name|DELETE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svc
condition|)
block|{
name|printf
argument_list|(
literal|"OpenService failed: %d\n\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|CloseServiceHandle
argument_list|(
name|scm
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|QueryServiceStatus
argument_list|(
name|svc
argument_list|,
operator|&
name|status
argument_list|)
condition|)
block|{
if|if
condition|(
name|status
operator|.
name|dwCurrentState
operator|!=
name|SERVICE_STOPPED
condition|)
block|{
name|printf
argument_list|(
literal|"Service currently active - stopping "
literal|"service...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ControlService
argument_list|(
name|svc
argument_list|,
name|SERVICE_CONTROL_STOP
argument_list|,
operator|&
name|status
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"ControlService failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|Sleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|DeleteService
argument_list|(
name|svc
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Service unregistered successfully.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"DeleteService failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|CloseServiceHandle
argument_list|(
name|svc
argument_list|)
expr_stmt|;
name|CloseServiceHandle
argument_list|(
name|scm
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|WINAPI
name|service_ctrl_handler
parameter_list|(
name|DWORD
name|control_code
parameter_list|)
block|{
switch|switch
condition|(
name|control_code
condition|)
block|{
case|case
name|SERVICE_CONTROL_INTERROGATE
case|:
break|break;
case|case
name|SERVICE_CONTROL_SHUTDOWN
case|:
case|case
name|SERVICE_CONTROL_STOP
case|:
name|svc_status
operator|.
name|dwCurrentState
operator|=
name|SERVICE_STOP_PENDING
expr_stmt|;
name|svc_status
operator|.
name|dwWaitHint
operator|=
literal|2000
expr_stmt|;
name|eloop_terminate
argument_list|()
expr_stmt|;
name|SetEvent
argument_list|(
name|kill_svc
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|SetServiceStatus
argument_list|(
name|svc_status_handle
argument_list|,
operator|&
name|svc_status
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"SetServiceStatus() failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|WINAPI
name|service_start
parameter_list|(
name|DWORD
name|argc
parameter_list|,
name|LPTSTR
modifier|*
name|argv
parameter_list|)
block|{
name|DWORD
name|id
decl_stmt|;
name|svc_status_handle
operator|=
name|RegisterServiceCtrlHandler
argument_list|(
name|WPASVC_NAME
argument_list|,
name|service_ctrl_handler
argument_list|)
expr_stmt|;
if|if
condition|(
name|svc_status_handle
operator|==
operator|(
name|SERVICE_STATUS_HANDLE
operator|)
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"RegisterServiceCtrlHandler failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|svc_status
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_status
argument_list|)
argument_list|)
expr_stmt|;
name|svc_status
operator|.
name|dwServiceType
operator|=
name|SERVICE_WIN32_OWN_PROCESS
expr_stmt|;
name|svc_status
operator|.
name|dwCurrentState
operator|=
name|SERVICE_START_PENDING
expr_stmt|;
name|svc_status
operator|.
name|dwWaitHint
operator|=
literal|1000
expr_stmt|;
if|if
condition|(
operator|!
name|SetServiceStatus
argument_list|(
name|svc_status_handle
argument_list|,
operator|&
name|svc_status
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"SetServiceStatus() failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
name|kill_svc
operator|=
name|CreateEvent
argument_list|(
literal|0
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kill_svc
condition|)
block|{
name|printf
argument_list|(
literal|"CreateEvent failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|CreateThread
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|LPTHREAD_START_ROUTINE
operator|)
name|svc_thread
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|id
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"CreateThread failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|svc_status
operator|.
name|dwCurrentState
operator|==
name|SERVICE_START_PENDING
condition|)
block|{
name|svc_status
operator|.
name|dwCurrentState
operator|=
name|SERVICE_RUNNING
expr_stmt|;
name|svc_status
operator|.
name|dwWaitHint
operator|=
literal|0
expr_stmt|;
name|svc_status
operator|.
name|dwControlsAccepted
operator|=
name|SERVICE_ACCEPT_STOP
operator||
name|SERVICE_ACCEPT_SHUTDOWN
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|SetServiceStatus
argument_list|(
name|svc_status_handle
argument_list|,
operator|&
name|svc_status
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"SetServiceStatus() failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* wait until service gets killed */
name|WaitForSingleObject
argument_list|(
name|kill_svc
argument_list|,
name|INFINITE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|SERVICE_TABLE_ENTRY
name|dt
index|[]
init|=
block|{
block|{
name|WPASVC_NAME
block|,
name|service_start
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"reg"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|TCHAR
modifier|*
name|path
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|3
condition|)
block|{
name|path
operator|=
name|os_malloc
argument_list|(
name|MAX_PATH
operator|*
sizeof|sizeof
argument_list|(
name|TCHAR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|GetModuleFileName
argument_list|(
name|NULL
argument_list|,
name|path
argument_list|,
name|MAX_PATH
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"GetModuleFileName failed: "
literal|"%d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|path
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
name|path
operator|=
name|wpa_strdup_tchar
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|register_service
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|path
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"unreg"
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|unregister_service
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"app"
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|wpa_supplicant_thread
argument_list|()
return|;
block|}
block|}
if|if
condition|(
operator|!
name|StartServiceCtrlDispatcher
argument_list|(
name|dt
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"StartServiceCtrlDispatcher failed: %d\n"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


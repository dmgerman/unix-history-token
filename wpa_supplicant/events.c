begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - Driver event processing  * Copyright (c) 2003-2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"pcsc_funcs.h"
end_include

begin_include
include|#
directive|include
file|"preauth.h"
end_include

begin_include
include|#
directive|include
file|"pmksa_cache.h"
end_include

begin_include
include|#
directive|include
file|"wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap.h"
end_include

begin_include
include|#
directive|include
file|"ctrl_iface_dbus.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"blacklist.h"
end_include

begin_include
include|#
directive|include
file|"wpas_glue.h"
end_include

begin_include
include|#
directive|include
file|"wps_supplicant.h"
end_include

begin_function
specifier|static
name|int
name|wpa_supplicant_select_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
operator|&&
name|wpa_s
operator|->
name|current_ssid
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Select network based on association "
literal|"information"
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_supplicant_get_ssid
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No network configuration found for the "
literal|"current AP"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ssid
operator|->
name|disabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Selected network is disabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Network configuration found for the current "
literal|"AP"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_PSK
operator||
name|WPA_KEY_MGMT_IEEE8021X
operator||
name|WPA_KEY_MGMT_WPA_NONE
operator||
name|WPA_KEY_MGMT_FT_PSK
operator||
name|WPA_KEY_MGMT_FT_IEEE8021X
operator||
name|WPA_KEY_MGMT_PSK_SHA256
operator||
name|WPA_KEY_MGMT_IEEE8021X_SHA256
operator|)
condition|)
block|{
name|u8
name|wpa_ie
index|[
literal|80
index|]
decl_stmt|;
name|size_t
name|wpa_ie_len
init|=
sizeof|sizeof
argument_list|(
name|wpa_ie
argument_list|)
decl_stmt|;
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|,
name|wpa_ie
argument_list|,
operator|&
name|wpa_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|!=
name|ssid
condition|)
name|eapol_sm_invalidate_cached_session
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_supplicant_rsn_supp_set_config
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_initiate_eapol
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_stop_countermeasures
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|countermeasures
condition|)
block|{
name|wpa_s
operator|->
name|countermeasures
operator|=
literal|0
expr_stmt|;
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: TKIP countermeasures stopped"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpa_supplicant_mark_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
condition|)
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_ies_from_associnfo
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_find_assoc_pmkid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|pmksa_set
init|=
operator|-
literal|1
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|wpa_sm_parse_own_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
operator|||
name|ie
operator|.
name|pmkid
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ie
operator|.
name|num_pmkid
condition|;
name|i
operator|++
control|)
block|{
name|pmksa_set
operator|=
name|pmksa_cache_set_current
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ie
operator|.
name|pmkid
operator|+
name|i
operator|*
name|PMKID_LEN
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmksa_set
operator|==
literal|0
condition|)
block|{
name|eapol_sm_notify_pmkid_attempt
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKID from assoc IE %sfound from PMKSA "
literal|"cache"
argument_list|,
name|pmksa_set
operator|==
literal|0
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_pmkid_candidate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: No data in PMKID candidate event"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKID candidate event - bssid="
name|MACSTR
literal|" index=%d preauth=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|pmkid_candidate
operator|.
name|bssid
argument_list|)
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|index
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|preauth
argument_list|)
expr_stmt|;
name|pmksa_candidate_add
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|bssid
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|index
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|preauth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_dynamic_keys
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
operator|!
operator|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|eapol_flags
operator|&
operator|(
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
operator||
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
operator|)
operator|)
condition|)
block|{
comment|/* IEEE 802.1X, but not using dynamic WEP keys (i.e., either 		 * plaintext or static WEP keys). */
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_scard_init - Initialize SIM/USIM access with PC/SC  * @wpa_s: pointer to wpa_supplicant data  * @ssid: Configuration data for the network  * Returns: 0 on success, -1 on failure  *  * This function is called when starting authentication with a network that is  * configured to use PC/SC for SIM/USIM access (EAP-SIM or EAP-AKA).  */
end_comment

begin_function
name|int
name|wpa_supplicant_scard_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
name|int
name|aka
init|=
literal|0
decl_stmt|,
name|sim
init|=
literal|0
decl_stmt|,
name|type
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|eap
operator|.
name|pcsc
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|scard
operator|!=
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
operator|==
name|NULL
condition|)
block|{
name|sim
operator|=
literal|1
expr_stmt|;
name|aka
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|struct
name|eap_method_type
modifier|*
name|eap
init|=
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
decl_stmt|;
while|while
condition|(
name|eap
operator|->
name|vendor
operator|!=
name|EAP_VENDOR_IETF
operator|||
name|eap
operator|->
name|method
operator|!=
name|EAP_TYPE_NONE
condition|)
block|{
if|if
condition|(
name|eap
operator|->
name|vendor
operator|==
name|EAP_VENDOR_IETF
condition|)
block|{
if|if
condition|(
name|eap
operator|->
name|method
operator|==
name|EAP_TYPE_SIM
condition|)
name|sim
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|eap
operator|->
name|method
operator|==
name|EAP_TYPE_AKA
condition|)
name|aka
operator|=
literal|1
expr_stmt|;
block|}
name|eap
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|eap_peer_get_eap_method
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_SIM
argument_list|)
operator|==
name|NULL
condition|)
name|sim
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|eap_peer_get_eap_method
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_AKA
argument_list|)
operator|==
name|NULL
condition|)
name|aka
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|sim
operator|&&
operator|!
name|aka
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Selected network is configured to use "
literal|"SIM, but neither EAP-SIM nor EAP-AKA are enabled"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Selected network is configured to use SIM "
literal|"(sim=%d aka=%d) - initialize PCSC"
argument_list|,
name|sim
argument_list|,
name|aka
argument_list|)
expr_stmt|;
if|if
condition|(
name|sim
operator|&&
name|aka
condition|)
name|type
operator|=
name|SCARD_TRY_BOTH
expr_stmt|;
elseif|else
if|if
condition|(
name|aka
condition|)
name|type
operator|=
name|SCARD_USIM_ONLY
expr_stmt|;
else|else
name|type
operator|=
name|SCARD_GSM_SIM_ONLY
expr_stmt|;
name|wpa_s
operator|->
name|scard
operator|=
name|scard_init
argument_list|(
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|scard
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to initialize SIM "
literal|"(pcsc-lite)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_sm_set_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|eapol_sm_register_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_SCAN_PROCESSING
end_ifndef

begin_function
specifier|static
name|int
name|wpa_supplicant_match_privacy
parameter_list|(
name|struct
name|wpa_scan_res
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|privacy
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mixed_cell
condition|)
return|return
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
condition|)
block|{
name|privacy
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
operator|&&
name|ssid
operator|->
name|eapol_flags
operator|&
operator|(
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
operator||
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
operator|)
condition|)
name|privacy
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
if|if
condition|(
name|bss
operator|->
name|caps
operator|&
name|IEEE80211_CAP_PRIVACY
condition|)
return|return
name|privacy
return|;
return|return
operator|!
name|privacy
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_ssid_bss_match
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|proto_match
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|rsn_ie
decl_stmt|,
modifier|*
name|wpa_ie
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|wpas_wps_ssid_bss_match
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
condition|)
return|return
name|ret
return|;
name|rsn_ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
operator|&&
name|rsn_ie
condition|)
block|{
name|proto_match
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_parse_wpa_ie
argument_list|(
name|rsn_ie
argument_list|,
literal|2
operator|+
name|rsn_ie
index|[
literal|1
index|]
argument_list|,
operator|&
name|ie
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - parse failed"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|proto
operator|&
name|ssid
operator|->
name|proto
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - proto "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - PTK cipher "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - GTK cipher "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - key mgmt "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|capabilities
operator|&
name|WPA_CAPABILITY_MFPC
operator|)
operator|&&
name|ssid
operator|->
name|ieee80211w
operator|==
name|IEEE80211W_REQUIRED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - no mgmt frame "
literal|"protection"
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected based on RSN IE"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|wpa_ie
operator|=
name|wpa_scan_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_WPA
operator|)
operator|&&
name|wpa_ie
condition|)
block|{
name|proto_match
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_parse_wpa_ie
argument_list|(
name|wpa_ie
argument_list|,
literal|2
operator|+
name|wpa_ie
index|[
literal|1
index|]
argument_list|,
operator|&
name|ie
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip WPA IE - parse failed"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|proto
operator|&
name|ssid
operator|->
name|proto
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip WPA IE - proto "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip WPA IE - PTK cipher "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip WPA IE - GTK cipher "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip WPA IE - key mgmt "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected based on WPA IE"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|proto_match
operator|==
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - no WPA/RSN proto match"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_scan_res
modifier|*
name|wpa_supplicant_select_bss_wpa
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|group
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
modifier|*
name|selected_ssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|bss
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Try to find WPA-enabled AP"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|scan_res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|u8
modifier|*
name|ssid_
decl_stmt|;
name|u8
name|wpa_ie_len
decl_stmt|,
name|rsn_ie_len
decl_stmt|,
name|ssid_len
decl_stmt|;
name|bss
operator|=
name|wpa_s
operator|->
name|scan_res
operator|->
name|res
index|[
name|i
index|]
expr_stmt|;
name|ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
name|ssid_
operator|=
name|ie
condition|?
name|ie
operator|+
literal|2
else|:
operator|(
name|u8
operator|*
operator|)
literal|""
expr_stmt|;
name|ssid_len
operator|=
name|ie
condition|?
name|ie
index|[
literal|1
index|]
else|:
literal|0
expr_stmt|;
name|ie
operator|=
name|wpa_scan_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|=
name|ie
condition|?
name|ie
index|[
literal|1
index|]
else|:
literal|0
expr_stmt|;
name|ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
name|rsn_ie_len
operator|=
name|ie
condition|?
name|ie
index|[
literal|1
index|]
else|:
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%d: "
name|MACSTR
literal|" ssid='%s' "
literal|"wpa_ie_len=%u rsn_ie_len=%u caps=0x%x"
argument_list|,
operator|(
name|int
operator|)
name|i
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid_
argument_list|,
name|ssid_len
argument_list|)
argument_list|,
name|wpa_ie_len
argument_list|,
name|rsn_ie_len
argument_list|,
name|bss
operator|->
name|caps
argument_list|)
expr_stmt|;
name|e
operator|=
name|wpa_blacklist_get
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|&&
name|e
operator|->
name|count
operator|>
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - blacklisted"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|wpa_ie_len
operator|==
literal|0
operator|&&
name|rsn_ie_len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - no WPA/RSN IE"
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|ssid
operator|=
name|group
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|pnext
control|)
block|{
name|int
name|check_ssid
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|disabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - disabled"
argument_list|)
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS
if|if
condition|(
name|ssid
operator|->
name|ssid_len
operator|==
literal|0
operator|&&
name|wpas_wps_ssid_wildcard_ok
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bss
argument_list|)
condition|)
name|check_ssid
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
if|if
condition|(
name|check_ssid
operator|&&
operator|(
name|ssid_len
operator|!=
name|ssid
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid_
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"SSID mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ssid
operator|->
name|bssid_set
operator|&&
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|ssid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"BSSID mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|wpa_supplicant_ssid_bss_match
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected WPA AP "
name|MACSTR
literal|" ssid='%s'"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid_
argument_list|,
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|selected_ssid
operator|=
name|ssid
expr_stmt|;
return|return
name|bss
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_scan_res
modifier|*
name|wpa_supplicant_select_bss_non_wpa
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|group
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
modifier|*
name|selected_ssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|bss
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Try to find non-WPA AP"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|scan_res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|u8
modifier|*
name|ssid_
decl_stmt|;
name|u8
name|wpa_ie_len
decl_stmt|,
name|rsn_ie_len
decl_stmt|,
name|ssid_len
decl_stmt|;
name|bss
operator|=
name|wpa_s
operator|->
name|scan_res
operator|->
name|res
index|[
name|i
index|]
expr_stmt|;
name|ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
name|ssid_
operator|=
name|ie
condition|?
name|ie
operator|+
literal|2
else|:
operator|(
name|u8
operator|*
operator|)
literal|""
expr_stmt|;
name|ssid_len
operator|=
name|ie
condition|?
name|ie
index|[
literal|1
index|]
else|:
literal|0
expr_stmt|;
name|ie
operator|=
name|wpa_scan_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|=
name|ie
condition|?
name|ie
index|[
literal|1
index|]
else|:
literal|0
expr_stmt|;
name|ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
name|rsn_ie_len
operator|=
name|ie
condition|?
name|ie
index|[
literal|1
index|]
else|:
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%d: "
name|MACSTR
literal|" ssid='%s' "
literal|"wpa_ie_len=%u rsn_ie_len=%u caps=0x%x"
argument_list|,
operator|(
name|int
operator|)
name|i
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid_
argument_list|,
name|ssid_len
argument_list|)
argument_list|,
name|wpa_ie_len
argument_list|,
name|rsn_ie_len
argument_list|,
name|bss
operator|->
name|caps
argument_list|)
expr_stmt|;
name|e
operator|=
name|wpa_blacklist_get
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|&&
name|e
operator|->
name|count
operator|>
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - blacklisted"
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|ssid
operator|=
name|group
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|pnext
control|)
block|{
name|int
name|check_ssid
init|=
name|ssid
operator|->
name|ssid_len
operator|!=
literal|0
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|disabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - disabled"
argument_list|)
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
condition|)
block|{
comment|/* Only allow wildcard SSID match if an AP 				 * advertises active WPS operation that matches 				 * with our mode. */
name|check_ssid
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid_len
operator|==
literal|0
operator|&&
name|wpas_wps_ssid_wildcard_ok
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bss
argument_list|)
condition|)
name|check_ssid
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS */
if|if
condition|(
name|check_ssid
operator|&&
operator|(
name|ssid_len
operator|!=
name|ssid
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid_
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"SSID mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ssid
operator|->
name|bssid_set
operator|&&
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|ssid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"BSSID mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_NONE
operator|)
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"non-WPA network not allowed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_IEEE8021X
operator||
name|WPA_KEY_MGMT_PSK
operator||
name|WPA_KEY_MGMT_FT_IEEE8021X
operator||
name|WPA_KEY_MGMT_FT_PSK
operator||
name|WPA_KEY_MGMT_IEEE8021X_SHA256
operator||
name|WPA_KEY_MGMT_PSK_SHA256
operator|)
operator|)
operator|&&
operator|(
name|wpa_ie_len
operator|!=
literal|0
operator|||
name|rsn_ie_len
operator|!=
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"WPA network"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|wpa_supplicant_match_privacy
argument_list|(
name|bss
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"privacy mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|bss
operator|->
name|caps
operator|&
name|IEEE80211_CAP_IBSS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"IBSS (adhoc) network"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected non-WPA AP "
name|MACSTR
literal|" ssid='%s'"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid_
argument_list|,
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|selected_ssid
operator|=
name|ssid
expr_stmt|;
return|return
name|bss
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_scan_res
modifier|*
name|wpa_supplicant_select_bss
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|group
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
modifier|*
name|selected_ssid
parameter_list|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|selected
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Selecting BSS from priority group %d"
argument_list|,
name|group
operator|->
name|priority
argument_list|)
expr_stmt|;
comment|/* First, try to find WPA-enabled AP */
name|selected
operator|=
name|wpa_supplicant_select_bss_wpa
argument_list|(
name|wpa_s
argument_list|,
name|group
argument_list|,
name|selected_ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|selected
condition|)
return|return
name|selected
return|;
comment|/* If no WPA-enabled AP found, try to find non-WPA AP, if configuration 	 * allows this. */
return|return
name|wpa_supplicant_select_bss_non_wpa
argument_list|(
name|wpa_s
argument_list|,
name|group
argument_list|,
name|selected_ssid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|prio
decl_stmt|,
name|timeout
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|selected
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|wpa_supplicant_get_scan_results
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|2
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to get scan results - try "
literal|"scanning again"
argument_list|)
expr_stmt|;
name|timeout
operator|=
literal|1
expr_stmt|;
goto|goto
name|req_scan
goto|;
block|}
comment|/* 	 * Don't post the results if this was the initial cached 	 * and there were no results. 	 */
if|if
condition|(
name|wpa_s
operator|->
name|scan_res_tried
operator|==
literal|1
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
operator|&&
name|wpa_s
operator|->
name|scan_res
operator|->
name|num
operator|==
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Cached scan results are "
literal|"empty - not posting"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_SCAN_RESULTS
argument_list|)
expr_stmt|;
name|wpa_supplicant_dbus_notify_scan_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_wps_notify_scan_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|2
operator|&&
operator|!
name|wpas_wps_searching
argument_list|(
name|wpa_s
argument_list|)
operator|)
operator|||
name|wpa_s
operator|->
name|disconnected
condition|)
return|return;
while|while
condition|(
name|selected
operator|==
name|NULL
condition|)
block|{
for|for
control|(
name|prio
operator|=
literal|0
init|;
name|prio
operator|<
name|wpa_s
operator|->
name|conf
operator|->
name|num_prio
condition|;
name|prio
operator|++
control|)
block|{
name|selected
operator|=
name|wpa_supplicant_select_bss
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|pssid
index|[
name|prio
index|]
argument_list|,
operator|&
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|selected
condition|)
break|break;
block|}
if|if
condition|(
name|selected
operator|==
name|NULL
operator|&&
name|wpa_s
operator|->
name|blacklist
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No APs found - clear blacklist "
literal|"and try again"
argument_list|)
expr_stmt|;
name|wpa_blacklist_clear
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|blacklist_cleared
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|selected
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|selected
condition|)
block|{
if|if
condition|(
name|wpas_wps_scan_pbc_overlap
argument_list|(
name|wpa_s
argument_list|,
name|selected
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_OVERLAP
literal|"PBC session overlap"
argument_list|)
expr_stmt|;
name|timeout
operator|=
literal|10
expr_stmt|;
goto|goto
name|req_scan
goto|;
block|}
comment|/* Do not trigger new association unless the BSSID has changed 		 * or if reassociation is requested. If we are in process of 		 * associating with the selected BSSID, do not trigger new 		 * attempt. */
if|if
condition|(
name|wpa_s
operator|->
name|reassociate
operator|||
operator|(
name|os_memcmp
argument_list|(
name|selected
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
operator|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_ASSOCIATING
operator|||
name|os_memcmp
argument_list|(
name|selected
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|wpa_supplicant_scard_init
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_supplicant_associate
argument_list|(
name|wpa_s
argument_list|,
name|selected
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Already associated with the "
literal|"selected AP."
argument_list|)
expr_stmt|;
block|}
name|rsn_preauth_scan_results
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|scan_res
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No suitable AP found."
argument_list|)
expr_stmt|;
name|timeout
operator|=
literal|5
expr_stmt|;
goto|goto
name|req_scan
goto|;
block|}
return|return;
name|req_scan
label|:
if|if
condition|(
name|wpa_s
operator|->
name|scan_res_tried
operator|==
literal|1
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
condition|)
block|{
comment|/* 		 * Quick recovery if the initial scan results were not 		 * complete when fetched before the first scan request. 		 */
name|wpa_s
operator|->
name|scan_res_tried
operator|++
expr_stmt|;
name|timeout
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|timeout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_SCAN_PROCESSING */
end_comment

begin_function
specifier|static
name|void
name|wpa_supplicant_event_associnfo
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|int
name|l
decl_stmt|,
name|len
decl_stmt|,
name|found
init|=
literal|0
decl_stmt|,
name|wpa_found
decl_stmt|,
name|rsn_found
decl_stmt|;
name|u8
modifier|*
name|p
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Association info event"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
condition|)
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"req_ies"
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
condition|)
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"resp_ies"
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
condition|)
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"beacon_ies"
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies_len
argument_list|)
expr_stmt|;
name|p
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
expr_stmt|;
name|l
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
expr_stmt|;
comment|/* Go through the IEs and make a copy of the WPA/RSN IE, if present. */
while|while
condition|(
name|p
operator|&&
name|l
operator|>=
literal|2
condition|)
block|{
name|len
operator|=
name|p
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|l
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Truncated IE in assoc_info"
argument_list|,
name|p
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|p
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|6
operator|&&
operator|(
name|os_memcmp
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|,
literal|"\x00\x50\xF2\x01\x01\x00"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
name|p
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|2
operator|)
condition|)
block|{
if|if
condition|(
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
condition|)
break|break;
name|found
operator|=
literal|1
expr_stmt|;
name|wpa_find_assoc_pmkid
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
block|}
name|l
operator|-=
name|len
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
operator|&&
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
condition|)
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* WPA/RSN IE from Beacon/ProbeResp */
name|p
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
expr_stmt|;
name|l
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies_len
expr_stmt|;
comment|/* Go through the IEs and make a copy of the WPA/RSN IEs, if present. 	 */
name|wpa_found
operator|=
name|rsn_found
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|p
operator|&&
name|l
operator|>=
literal|2
condition|)
block|{
name|len
operator|=
name|p
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|l
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Truncated IE in beacon_ies"
argument_list|,
name|p
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|wpa_found
operator|&&
name|p
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|6
operator|&&
name|os_memcmp
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|,
literal|"\x00\x50\xF2\x01\x01\x00"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_found
operator|=
literal|1
expr_stmt|;
name|wpa_sm_set_ap_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|rsn_found
operator|&&
name|p
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|2
condition|)
block|{
name|rsn_found
operator|=
literal|1
expr_stmt|;
name|wpa_sm_set_ap_rsn_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
name|l
operator|-=
name|len
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wpa_found
operator|&&
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
condition|)
name|wpa_sm_set_ap_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsn_found
operator|&&
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
condition|)
name|wpa_sm_set_ap_rsn_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_found
operator|||
name|rsn_found
condition|)
name|wpa_s
operator|->
name|ap_ies_from_associnfo
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_assoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|ft_completed
init|=
name|wpa_ft_is_completed
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
decl_stmt|;
if|if
condition|(
name|data
condition|)
name|wpa_supplicant_event_associnfo
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ASSOCIATED
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|use_client_mlme
condition|)
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|use_client_mlme
operator|||
operator|(
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|>=
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Associated to a new BSS: BSSID="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_dynamic_keys
argument_list|(
name|wpa_s
argument_list|)
operator|&&
operator|!
name|ft_completed
condition|)
block|{
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_supplicant_select_config
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_supplicant_disassociate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Associated with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
comment|/* When using scanning (ap_scan=1), SIM PC/SC interface can be 		 * initialized before association, but for other modes, 		 * initialize PC/SC here, if the current configuration needs 		 * smartcard or SIM/USIM. */
name|wpa_supplicant_scard_init
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
block|}
name|wpa_sm_notify_assoc
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
name|l2_packet_notify_auth_start
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|)
expr_stmt|;
comment|/* 	 * Set portEnabled first to FALSE in order to get EAP state machine out 	 * of the SUCCESS state and eapSuccess cleared. Without this, EAPOL PAE 	 * state machine may transit to AUTHENTICATING state based on obsolete 	 * eapSuccess and then trigger BE_AUTH to SUCCESS and PAE to 	 * AUTHENTICATED without ever giving chance to EAP state machine to 	 * reset the state. 	 */
if|if
condition|(
operator|!
name|ft_completed
condition|)
block|{
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
operator|||
name|ft_completed
condition|)
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* 802.1X::portControl = Auto */
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|eapol_received
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_COMPLETED
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|ft_completed
condition|)
block|{
comment|/* Timeout for receiving the first EAPOL packet */
name|wpa_supplicant_req_auth_timeout
argument_list|(
name|wpa_s
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_cancel_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|driver_4way_handshake
operator|&&
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
comment|/* 		 * We are done; the driver will take care of RSN 4-way 		 * handshake. 		 */
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_COMPLETED
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|bssid
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* 		 * At least Host AP driver and a Prism3 card seemed to be 		 * generating streams of disconnected events when configuring 		 * IBSS for WPA-None. Ignore them for now. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Disconnect event - ignore in "
literal|"IBSS/WPA-None mode"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_4WAY_HANDSHAKE
operator|&&
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: 4-Way Handshake failed - "
literal|"pre-shared key may be incorrect"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_ASSOCIATED
condition|)
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|100000
argument_list|)
expr_stmt|;
name|bssid
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|bssid
argument_list|)
condition|)
name|bssid
operator|=
name|wpa_s
operator|->
name|pending_bssid
expr_stmt|;
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
name|wpa_sm_notify_disassoc
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_DISCONNECTED
literal|"- Disconnect event - "
literal|"remove keys"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_dynamic_keys
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_s
operator|->
name|keys_cleared
operator|=
literal|0
expr_stmt|;
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_DELAYED_MIC_ERROR_REPORT
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_delayed_mic_error_report
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|pending_mic_error_report
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Sending pending MIC error report"
argument_list|)
expr_stmt|;
name|wpa_sm_key_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
literal|1
argument_list|,
name|wpa_s
operator|->
name|pending_mic_error_pairwise
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_mic_error_report
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_DELAYED_MIC_ERROR_REPORT */
end_comment

begin_function
specifier|static
name|void
name|wpa_supplicant_event_michael_mic_failure
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|int
name|pairwise
decl_stmt|;
name|struct
name|os_time
name|t
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"Michael MIC failure detected"
argument_list|)
expr_stmt|;
name|pairwise
operator|=
operator|(
name|data
operator|&&
name|data
operator|->
name|michael_mic_failure
operator|.
name|unicast
operator|)
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|last_michael_mic_error
operator|&&
name|t
operator|.
name|sec
operator|-
name|wpa_s
operator|->
name|last_michael_mic_error
operator|<=
literal|60
operator|)
operator|||
name|wpa_s
operator|->
name|pending_mic_error_report
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|pending_mic_error_report
condition|)
block|{
comment|/* 			 * Send the pending MIC error report immediately since 			 * we are going to start countermeasures and AP better 			 * do the same. 			 */
name|wpa_sm_key_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
literal|1
argument_list|,
name|wpa_s
operator|->
name|pending_mic_error_pairwise
argument_list|)
expr_stmt|;
block|}
comment|/* Send the new MIC error report immediately since we are going 		 * to start countermeasures and AP better do the same. 		 */
name|wpa_sm_key_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
literal|1
argument_list|,
name|pairwise
argument_list|)
expr_stmt|;
comment|/* initialize countermeasures */
name|wpa_s
operator|->
name|countermeasures
operator|=
literal|1
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"TKIP countermeasures started"
argument_list|)
expr_stmt|;
comment|/* 		 * Need to wait for completion of request frame. We do not get 		 * any callback for the message completion, so just wait a 		 * short while and hope for the best. */
name|os_sleep
argument_list|(
literal|0
argument_list|,
literal|10000
argument_list|)
expr_stmt|;
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_MICHAEL_MIC_FAILURE
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_stop_countermeasures
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|60
argument_list|,
literal|0
argument_list|,
name|wpa_supplicant_stop_countermeasures
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* TODO: mark the AP rejected for 60 second. STA is 		 * allowed to associate with another AP.. */
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|CONFIG_DELAYED_MIC_ERROR_REPORT
if|if
condition|(
name|wpa_s
operator|->
name|mic_errors_seen
condition|)
block|{
comment|/* 			 * Reduce the effectiveness of Michael MIC error 			 * reports as a means for attacking against TKIP if 			 * more than one MIC failure is noticed with the same 			 * PTK. We delay the transmission of the reports by a 			 * random time between 0 and 60 seconds in order to 			 * force the attacker wait 60 seconds before getting 			 * the information on whether a frame resulted in a MIC 			 * failure. 			 */
name|u8
name|rval
index|[
literal|4
index|]
decl_stmt|;
name|int
name|sec
decl_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|rval
argument_list|,
sizeof|sizeof
argument_list|(
name|rval
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|sec
operator|=
name|os_random
argument_list|()
operator|%
literal|60
expr_stmt|;
else|else
name|sec
operator|=
name|WPA_GET_BE32
argument_list|(
name|rval
argument_list|)
operator|%
literal|60
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Delay MIC error report %d "
literal|"seconds"
argument_list|,
name|sec
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_mic_error_report
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|pending_mic_error_pairwise
operator|=
name|pairwise
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_delayed_mic_error_report
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
argument_list|,
name|os_random
argument_list|()
operator|%
literal|1000000
argument_list|,
name|wpa_supplicant_delayed_mic_error_report
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_sm_key_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
literal|1
argument_list|,
name|pairwise
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* CONFIG_DELAYED_MIC_ERROR_REPORT */
name|wpa_sm_key_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
literal|1
argument_list|,
name|pairwise
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_DELAYED_MIC_ERROR_REPORT */
block|}
name|wpa_s
operator|->
name|last_michael_mic_error
operator|=
name|t
operator|.
name|sec
expr_stmt|;
name|wpa_s
operator|->
name|mic_errors_seen
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_interface_status
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|data
operator|->
name|interface_status
operator|.
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
return|return;
switch|switch
condition|(
name|data
operator|->
name|interface_status
operator|.
name|ievent
condition|)
block|{
case|case
name|EVENT_INTERFACE_ADDED
case|:
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|interface_removed
condition|)
break|break;
name|wpa_s
operator|->
name|interface_removed
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Configured interface was added."
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_driver_init
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to initialize the driver "
literal|"after interface was added."
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|EVENT_INTERFACE_REMOVED
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Configured interface was removed."
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|interface_removed
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|l2_packet_deinit
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_PEERKEY
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_event_stkstart
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
name|wpa_sm_stkstart
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|stkstart
operator|.
name|peer
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_PEERKEY */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_event_ft_response
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_ft_process_response
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|ies
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|ies_len
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|ft_action
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|target_ap
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* TODO: prevent MLME/driver from trying to associate? */
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211R */
end_comment

begin_function
name|void
name|wpa_supplicant_event
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|wpa_event_type
name|event
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|EVENT_ASSOC
case|:
name|wpa_supplicant_event_assoc
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DISASSOC
case|:
name|wpa_supplicant_event_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_MICHAEL_MIC_FAILURE
case|:
name|wpa_supplicant_event_michael_mic_failure
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
ifndef|#
directive|ifndef
name|CONFIG_NO_SCAN_PROCESSING
case|case
name|EVENT_SCAN_RESULTS
case|:
name|wpa_supplicant_event_scan_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_NO_SCAN_PROCESSING */
case|case
name|EVENT_ASSOCINFO
case|:
name|wpa_supplicant_event_associnfo
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_INTERFACE_STATUS
case|:
name|wpa_supplicant_event_interface_status
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_PMKID_CANDIDATE
case|:
name|wpa_supplicant_event_pmkid_candidate
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_PEERKEY
case|case
name|EVENT_STKSTART
case|:
name|wpa_supplicant_event_stkstart
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_PEERKEY */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
case|case
name|EVENT_FT_RESPONSE
case|:
name|wpa_supplicant_event_ft_response
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
default|default:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown event %d"
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

end_unit


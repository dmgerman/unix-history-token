begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - Client mode MLME  * Copyright (c) 2003-2008, Jouni Malinen<j@w1.fi>  * Copyright (c) 2004, Instant802 Networks, Inc.  * Copyright (c) 2005-2006, Devicescape Software, Inc.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"mlme.h"
end_include

begin_comment
comment|/* Timeouts and intervals in milliseconds */
end_comment

begin_define
define|#
directive|define
name|IEEE80211_AUTH_TIMEOUT
value|(200)
end_define

begin_define
define|#
directive|define
name|IEEE80211_AUTH_MAX_TRIES
value|3
end_define

begin_define
define|#
directive|define
name|IEEE80211_ASSOC_TIMEOUT
value|(200)
end_define

begin_define
define|#
directive|define
name|IEEE80211_ASSOC_MAX_TRIES
value|3
end_define

begin_define
define|#
directive|define
name|IEEE80211_MONITORING_INTERVAL
value|(2000)
end_define

begin_define
define|#
directive|define
name|IEEE80211_PROBE_INTERVAL
value|(60000)
end_define

begin_define
define|#
directive|define
name|IEEE80211_RETRY_AUTH_INTERVAL
value|(1000)
end_define

begin_define
define|#
directive|define
name|IEEE80211_SCAN_INTERVAL
value|(2000)
end_define

begin_define
define|#
directive|define
name|IEEE80211_SCAN_INTERVAL_SLOW
value|(15000)
end_define

begin_define
define|#
directive|define
name|IEEE80211_IBSS_JOIN_TIMEOUT
value|(20000)
end_define

begin_define
define|#
directive|define
name|IEEE80211_PROBE_DELAY
value|(33)
end_define

begin_define
define|#
directive|define
name|IEEE80211_CHANNEL_TIME
value|(33)
end_define

begin_define
define|#
directive|define
name|IEEE80211_PASSIVE_CHANNEL_TIME
value|(200)
end_define

begin_define
define|#
directive|define
name|IEEE80211_SCAN_RESULT_EXPIRE
value|(10000)
end_define

begin_define
define|#
directive|define
name|IEEE80211_IBSS_MERGE_INTERVAL
value|(30000)
end_define

begin_define
define|#
directive|define
name|IEEE80211_IBSS_INACTIVITY_LIMIT
value|(60000)
end_define

begin_define
define|#
directive|define
name|IEEE80211_IBSS_MAX_STA_ENTRIES
value|128
end_define

begin_define
define|#
directive|define
name|IEEE80211_FC
parameter_list|(
name|type
parameter_list|,
name|stype
parameter_list|)
value|host_to_le16((type<< 2) | (stype<< 4))
end_define

begin_struct
struct|struct
name|ieee80211_sta_bss
block|{
name|struct
name|ieee80211_sta_bss
modifier|*
name|next
decl_stmt|;
name|struct
name|ieee80211_sta_bss
modifier|*
name|hnext
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|ssid
index|[
name|MAX_SSID_LEN
index|]
decl_stmt|;
name|size_t
name|ssid_len
decl_stmt|;
name|u16
name|capability
decl_stmt|;
comment|/* host byte order */
name|int
name|hw_mode
decl_stmt|;
name|int
name|channel
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|int
name|rssi
decl_stmt|;
name|u8
modifier|*
name|ie
decl_stmt|;
name|size_t
name|ie_len
decl_stmt|;
name|u8
modifier|*
name|wpa_ie
decl_stmt|;
name|size_t
name|wpa_ie_len
decl_stmt|;
name|u8
modifier|*
name|rsn_ie
decl_stmt|;
name|size_t
name|rsn_ie_len
decl_stmt|;
name|u8
modifier|*
name|wmm_ie
decl_stmt|;
name|size_t
name|wmm_ie_len
decl_stmt|;
name|u8
modifier|*
name|mdie
decl_stmt|;
name|size_t
name|mdie_len
decl_stmt|;
define|#
directive|define
name|IEEE80211_MAX_SUPP_RATES
value|32
name|u8
name|supp_rates
index|[
name|IEEE80211_MAX_SUPP_RATES
index|]
decl_stmt|;
name|size_t
name|supp_rates_len
decl_stmt|;
name|int
name|beacon_int
decl_stmt|;
name|u64
name|timestamp
decl_stmt|;
name|int
name|probe_resp
decl_stmt|;
name|struct
name|os_time
name|last_update
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|ieee80211_send_probe_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ieee80211_sta_bss
modifier|*
name|ieee80211_bss_get
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ieee80211_sta_find_ibss
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ieee80211_sta_wep_configured
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ieee80211_sta_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ieee80211_sta_scan_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|ieee80211_sta_set_channel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|wpa_hw_mode
name|phymode
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|struct
name|wpa_hw_modes
modifier|*
name|mode
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|mlme
operator|.
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
name|mode
operator|=
operator|&
name|wpa_s
operator|->
name|mlme
operator|.
name|modes
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|mode
operator|==
name|phymode
condition|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|curr_rates
operator|=
name|mode
operator|->
name|rates
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|num_curr_rates
operator|=
name|mode
operator|->
name|num_rates
expr_stmt|;
break|break;
block|}
block|}
return|return
name|wpa_drv_set_channel
argument_list|(
name|wpa_s
argument_list|,
name|phymode
argument_list|,
name|chan
argument_list|,
name|freq
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* FIX */
end_comment

begin_endif
unit|static int ecw2cw(int ecw) { 	int cw = 1; 	while (ecw> 0) { 		cw<<= 1; 		ecw--; 	} 	return cw - 1; }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|ieee80211_sta_wmm_params
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|wmm_param
parameter_list|,
name|size_t
name|wmm_param_len
parameter_list|)
block|{
name|size_t
name|left
decl_stmt|;
name|int
name|count
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|wmm_param_len
operator|<
literal|8
operator|||
name|wmm_param
index|[
literal|5
index|]
comment|/* version */
operator|!=
literal|1
condition|)
return|return;
name|count
operator|=
name|wmm_param
index|[
literal|6
index|]
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
name|count
operator|==
name|wpa_s
operator|->
name|mlme
operator|.
name|wmm_last_param_set
condition|)
return|return;
name|wpa_s
operator|->
name|mlme
operator|.
name|wmm_last_param_set
operator|=
name|count
expr_stmt|;
name|pos
operator|=
name|wmm_param
operator|+
literal|8
expr_stmt|;
name|left
operator|=
name|wmm_param_len
operator|-
literal|8
expr_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|wmm_acm = 0; 	for (; left>= 4; left -= 4, pos += 4) { 		int aci = (pos[0]>> 5)& 0x03; 		int acm = (pos[0]>> 4)& 0x01; 		int queue;  		switch (aci) { 		case 1: 			queue = IEEE80211_TX_QUEUE_DATA3; 			if (acm) 				wmm_acm |= BIT(1) | BIT(2); 			break; 		case 2: 			queue = IEEE80211_TX_QUEUE_DATA1; 			if (acm) 				wmm_acm |= BIT(4) | BIT(5); 			break; 		case 3: 			queue = IEEE80211_TX_QUEUE_DATA0; 			if (acm) 				wmm_acm |= BIT(6) | BIT(7); 			break; 		case 0: 		default: 			queue = IEEE80211_TX_QUEUE_DATA2; 			if (acm) 				wpa_s->mlme.wmm_acm |= BIT(0) | BIT(3); 			break; 		}  		params.aifs = pos[0]& 0x0f; 		params.cw_max = ecw2cw((pos[1]& 0xf0)>> 4); 		params.cw_min = ecw2cw(pos[1]& 0x0f);
comment|/* TXOP is in units of 32 usec; burst_time in 0.1 ms */
block|params.burst_time = (pos[2] | (pos[3]<< 8)) * 32 / 100; 		wpa_printf(MSG_DEBUG, "MLME: WMM queue=%d aci=%d acm=%d " 			   "aifs=%d cWmin=%d cWmax=%d burst=%d", 			   queue, aci, acm, params.aifs, params.cw_min, 			   params.cw_max, params.burst_time);
comment|/* TODO: handle ACM (block TX, fallback to next lowest allowed 		 * AC for now) */
block|if (local->hw->conf_tx(local->mdev, queue,&params)) { 			wpa_printf(MSG_DEBUG, "MLME: failed to set TX queue " 				   "parameters for queue %d", queue); 		} 	}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_set_associated
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|assoc
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|associated
operator|==
name|assoc
operator|&&
operator|!
name|assoc
condition|)
return|return;
name|wpa_s
operator|->
name|mlme
operator|.
name|associated
operator|=
name|assoc
expr_stmt|;
if|if
condition|(
name|assoc
condition|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|prev_bssid_set
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|prev_bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|req_ies
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|req_ies_len
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies_len
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies_len
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies_len
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_ASSOC
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|os_get_time
argument_list|(
operator|&
name|wpa_s
operator|->
name|mlme
operator|.
name|last_probe
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ieee80211_sta_tx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
return|return
name|wpa_drv_send_mlme
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_send_auth
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|transaction
parameter_list|,
name|u8
modifier|*
name|extra
parameter_list|,
name|size_t
name|extra_len
parameter_list|,
name|int
name|encrypt
parameter_list|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mgmt
argument_list|)
operator|+
literal|6
operator|+
name|extra_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to allocate buffer for "
literal|"auth frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|=
literal|24
operator|+
literal|6
expr_stmt|;
name|os_memset
argument_list|(
name|mgmt
argument_list|,
literal|0
argument_list|,
literal|24
operator|+
literal|6
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_AUTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|encrypt
condition|)
name|mgmt
operator|->
name|frame_control
operator||=
name|host_to_le16
argument_list|(
name|WLAN_FC_ISWEP
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|auth_alg
operator|=
name|host_to_le16
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|auth_transaction
operator|=
name|host_to_le16
argument_list|(
name|transaction
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_transaction
operator|=
name|transaction
operator|+
literal|1
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|status_code
operator|=
name|host_to_le16
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|extra
condition|)
block|{
name|os_memcpy
argument_list|(
name|buf
operator|+
name|len
argument_list|,
name|extra
argument_list|,
name|extra_len
argument_list|)
expr_stmt|;
name|len
operator|+=
name|extra_len
expr_stmt|;
block|}
name|ieee80211_sta_tx
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_reschedule_timer
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ms
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|ieee80211_sta_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|ms
operator|/
literal|1000
argument_list|,
literal|1000
operator|*
operator|(
name|ms
operator|%
literal|1000
operator|)
argument_list|,
name|ieee80211_sta_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_authenticate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|u8
modifier|*
name|extra
decl_stmt|;
name|size_t
name|extra_len
decl_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_tries
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_tries
operator|>
name|IEEE80211_AUTH_MAX_TRIES
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: authentication with AP "
name|MACSTR
literal|" timed out"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|=
name|IEEE80211_AUTHENTICATE
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: authenticate with AP "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|extra
operator|=
name|NULL
expr_stmt|;
name|extra_len
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|mlme
operator|.
name|key_mgmt
operator|==
name|KEY_MGMT_FT_802_1X
operator|||
name|wpa_s
operator|->
name|mlme
operator|.
name|key_mgmt
operator|==
name|KEY_MGMT_FT_PSK
operator|)
operator|&&
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
condition|)
block|{
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
decl_stmt|;
name|struct
name|rsn_mdie
modifier|*
name|mdie
init|=
name|NULL
decl_stmt|;
name|bss
operator|=
name|ieee80211_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|&&
name|bss
operator|->
name|mdie_len
operator|>=
literal|2
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|mdie
argument_list|)
condition|)
name|mdie
operator|=
operator|(
expr|struct
name|rsn_mdie
operator|*
operator|)
operator|(
name|bss
operator|->
name|mdie
operator|+
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|mdie
operator|&&
name|os_memcmp
argument_list|(
name|mdie
operator|->
name|mobility_domain
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|current_md
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Trying to use FT "
literal|"over-the-air"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|=
name|WLAN_AUTH_FT
expr_stmt|;
name|extra
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
expr_stmt|;
name|extra_len
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies_len
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|ieee80211_send_auth
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
name|extra
argument_list|,
name|extra_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ieee80211_reschedule_timer
argument_list|(
name|wpa_s
argument_list|,
name|IEEE80211_AUTH_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_send_assoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|ies
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|u16
name|capab
decl_stmt|;
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|wmm
init|=
literal|0
decl_stmt|;
name|size_t
name|blen
decl_stmt|,
name|buflen
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|curr_rates
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: curr_rates not set for assoc"
argument_list|)
expr_stmt|;
return|return;
block|}
name|buflen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|mgmt
argument_list|)
operator|+
literal|200
operator|+
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie_len
operator|+
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
condition|)
name|buflen
operator|+=
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies_len
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|buf
operator|=
name|os_malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to allocate buffer for "
literal|"assoc frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|blen
operator|=
literal|0
expr_stmt|;
name|capab
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|capab
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
operator|==
name|WPA_MODE_IEEE80211G
condition|)
block|{
name|capab
operator||=
name|WLAN_CAPABILITY_SHORT_SLOT_TIME
operator||
name|WLAN_CAPABILITY_SHORT_PREAMBLE
expr_stmt|;
block|}
name|bss
operator|=
name|ieee80211_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
if|if
condition|(
name|bss
operator|->
name|capability
operator|&
name|WLAN_CAPABILITY_PRIVACY
condition|)
name|capab
operator||=
name|WLAN_CAPABILITY_PRIVACY
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wmm_ie
condition|)
block|{
name|wmm
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|blen
operator|+=
literal|24
expr_stmt|;
name|os_memset
argument_list|(
name|mgmt
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|prev_bssid_set
condition|)
block|{
name|blen
operator|+=
literal|10
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_REASSOC_REQ
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|reassoc_req
operator|.
name|capab_info
operator|=
name|host_to_le16
argument_list|(
name|capab
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|reassoc_req
operator|.
name|listen_interval
operator|=
name|host_to_le16
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|reassoc_req
operator|.
name|current_ap
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|prev_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|blen
operator|+=
literal|4
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ASSOC_REQ
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|assoc_req
operator|.
name|capab_info
operator|=
name|host_to_le16
argument_list|(
name|capab
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|assoc_req
operator|.
name|listen_interval
operator|=
name|host_to_le16
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* SSID */
name|ies
operator|=
name|pos
operator|=
name|buf
operator|+
name|blen
expr_stmt|;
name|blen
operator|+=
literal|2
operator|+
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_SSID
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|num_curr_rates
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|8
condition|)
name|len
operator|=
literal|8
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
name|blen
expr_stmt|;
name|blen
operator|+=
name|len
operator|+
literal|2
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_SUPP_RATES
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|len
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|int
name|rate
init|=
name|wpa_s
operator|->
name|mlme
operator|.
name|curr_rates
index|[
name|i
index|]
operator|.
name|rate
decl_stmt|;
operator|*
name|pos
operator|++
operator|=
call|(
name|u8
call|)
argument_list|(
name|rate
operator|/
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|num_curr_rates
operator|>
name|len
condition|)
block|{
name|pos
operator|=
name|buf
operator|+
name|blen
expr_stmt|;
name|blen
operator|+=
name|wpa_s
operator|->
name|mlme
operator|.
name|num_curr_rates
operator|-
name|len
operator|+
literal|2
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_EXT_SUPP_RATES
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|num_curr_rates
operator|-
name|len
expr_stmt|;
for|for
control|(
name|i
operator|=
name|len
init|;
name|i
operator|<
name|wpa_s
operator|->
name|mlme
operator|.
name|num_curr_rates
condition|;
name|i
operator|++
control|)
block|{
name|int
name|rate
init|=
name|wpa_s
operator|->
name|mlme
operator|.
name|curr_rates
index|[
name|i
index|]
operator|.
name|rate
decl_stmt|;
operator|*
name|pos
operator|++
operator|=
call|(
name|u8
call|)
argument_list|(
name|rate
operator|/
literal|5
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie
operator|&&
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|!=
name|WLAN_AUTH_FT
condition|)
block|{
name|pos
operator|=
name|buf
operator|+
name|blen
expr_stmt|;
name|blen
operator|+=
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie_len
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|mlme
operator|.
name|key_mgmt
operator|==
name|KEY_MGMT_FT_802_1X
operator|||
name|wpa_s
operator|->
name|mlme
operator|.
name|key_mgmt
operator|==
name|KEY_MGMT_FT_PSK
operator|)
operator|&&
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|!=
name|WLAN_AUTH_FT
operator|&&
name|bss
operator|&&
name|bss
operator|->
name|mdie
operator|&&
name|bss
operator|->
name|mdie_len
operator|>=
literal|2
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rsn_mdie
argument_list|)
operator|&&
name|bss
operator|->
name|mdie
index|[
literal|1
index|]
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|rsn_mdie
argument_list|)
condition|)
block|{
name|pos
operator|=
name|buf
operator|+
name|blen
expr_stmt|;
name|blen
operator|+=
literal|2
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rsn_mdie
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_MOBILITY_DOMAIN
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|rsn_mdie
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|bss
operator|->
name|mdie
operator|+
literal|2
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|MOBILITY_DOMAIN_ID_LEN
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|0
expr_stmt|;
comment|/* FIX: copy from the target AP's MDIE */
block|}
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|mlme
operator|.
name|key_mgmt
operator|==
name|KEY_MGMT_FT_802_1X
operator|||
name|wpa_s
operator|->
name|mlme
operator|.
name|key_mgmt
operator|==
name|KEY_MGMT_FT_PSK
operator|)
operator|&&
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|==
name|WLAN_AUTH_FT
operator|&&
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
condition|)
block|{
name|pos
operator|=
name|buf
operator|+
name|blen
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies_len
expr_stmt|;
name|blen
operator|+=
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies_len
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
if|if
condition|(
name|wmm
operator|&&
name|wpa_s
operator|->
name|mlme
operator|.
name|wmm_enabled
condition|)
block|{
name|pos
operator|=
name|buf
operator|+
name|blen
expr_stmt|;
name|blen
operator|+=
literal|9
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_VENDOR_SPECIFIC
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|7
expr_stmt|;
comment|/* len */
operator|*
name|pos
operator|++
operator|=
literal|0x00
expr_stmt|;
comment|/* Microsoft OUI 00:50:F2 */
operator|*
name|pos
operator|++
operator|=
literal|0x50
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|0xf2
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|2
expr_stmt|;
comment|/* WMM */
operator|*
name|pos
operator|++
operator|=
literal|0
expr_stmt|;
comment|/* WMM info */
operator|*
name|pos
operator|++
operator|=
literal|1
expr_stmt|;
comment|/* WMM ver */
operator|*
name|pos
operator|++
operator|=
literal|0
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies_len
operator|=
operator|(
name|buf
operator|+
name|blen
operator|)
operator|-
name|ies
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies
operator|=
name|os_malloc
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies
condition|)
block|{
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies
argument_list|,
name|ies
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies_len
argument_list|)
expr_stmt|;
block|}
name|ieee80211_sta_tx
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|blen
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_send_deauth
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u16
name|reason
parameter_list|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|buf
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mgmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to allocate buffer for "
literal|"deauth frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|=
literal|24
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_DEAUTH
argument_list|)
expr_stmt|;
name|len
operator|+=
literal|2
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|deauth
operator|.
name|reason_code
operator|=
name|host_to_le16
argument_list|(
name|reason
argument_list|)
expr_stmt|;
name|ieee80211_sta_tx
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_send_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u16
name|reason
parameter_list|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|buf
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mgmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to allocate buffer for "
literal|"disassoc frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|=
literal|24
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_DISASSOC
argument_list|)
expr_stmt|;
name|len
operator|+=
literal|2
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|disassoc
operator|.
name|reason_code
operator|=
name|host_to_le16
argument_list|(
name|reason
argument_list|)
expr_stmt|;
name|ieee80211_sta_tx
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ieee80211_privacy_mismatch
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|res
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|mixed_cell
operator|||
name|wpa_s
operator|->
name|mlme
operator|.
name|key_mgmt
operator|!=
name|KEY_MGMT_NONE
condition|)
return|return
literal|0
return|;
name|bss
operator|=
name|ieee80211_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ieee80211_sta_wep_configured
argument_list|(
name|wpa_s
argument_list|)
operator|!=
operator|!
operator|!
operator|(
name|bss
operator|->
name|capability
operator|&
name|WLAN_CAPABILITY_PRIVACY
operator|)
condition|)
name|res
operator|=
literal|1
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_associate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|assoc_tries
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assoc_tries
operator|>
name|IEEE80211_ASSOC_MAX_TRIES
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: association with AP "
name|MACSTR
literal|" timed out"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|=
name|IEEE80211_ASSOCIATE
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: associate with AP "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ieee80211_privacy_mismatch
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: mismatch in privacy "
literal|"configuration and mixed-cell disabled - abort "
literal|"association"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ieee80211_send_assoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ieee80211_reschedule_timer
argument_list|(
name|wpa_s
argument_list|,
name|IEEE80211_ASSOC_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_associated
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|disassoc
decl_stmt|;
comment|/* TODO: start monitoring current AP signal quality and number of 	 * missed beacons. Scan other channels every now and then and search 	 * for better APs. */
comment|/* TODO: remove expired BSSes */
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|=
name|IEEE80211_ASSOCIATED
expr_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|sta = sta_info_get(local, wpa_s->bssid); 	if (sta == NULL) { 		wpa_printf(MSG_DEBUG "MLME: No STA entry for own AP " MACSTR, 			   MAC2STR(wpa_s->bssid)); 		disassoc = 1; 	} else { 		disassoc = 0; 		if (time_after(jiffies, 			       sta->last_rx + IEEE80211_MONITORING_INTERVAL)) { 			if (wpa_s->mlme.probereq_poll) { 				wpa_printf(MSG_DEBUG "MLME: No ProbeResp from " 					   "current AP " MACSTR " - assume " 					   "out of range", 					   MAC2STR(wpa_s->bssid)); 				disassoc = 1; 			} else { 				ieee80211_send_probe_req( 					wpa_s->bssid, 					wpa_s->mlme.scan_ssid, 					wpa_s->mlme.scan_ssid_len); 				wpa_s->mlme.probereq_poll = 1; 			} 		} else { 			wpa_s->mlme.probereq_poll = 0; 			if (time_after(jiffies, wpa_s->mlme.last_probe + 				       IEEE80211_PROBE_INTERVAL)) { 				wpa_s->mlme.last_probe = jiffies; 				ieee80211_send_probe_req(wpa_s->bssid, 							 wpa_s->mlme.ssid, 							 wpa_s->mlme.ssid_len); 			} 		} 		sta_info_release(local, sta); 	}
else|#
directive|else
name|disassoc
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|disassoc
condition|)
block|{
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ieee80211_reschedule_timer
argument_list|(
name|wpa_s
argument_list|,
name|IEEE80211_MONITORING_INTERVAL
operator|+
literal|30000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ieee80211_reschedule_timer
argument_list|(
name|wpa_s
argument_list|,
name|IEEE80211_MONITORING_INTERVAL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_send_probe_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|supp_rates
decl_stmt|;
name|u8
modifier|*
name|esupp_rates
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mgmt
argument_list|)
operator|+
literal|200
operator|+
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to allocate buffer for "
literal|"probe request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|=
literal|24
expr_stmt|;
name|os_memset
argument_list|(
name|mgmt
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_PROBE_REQ
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
condition|)
block|{
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memset
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
name|buf
operator|+
name|len
expr_stmt|;
name|len
operator|+=
literal|2
operator|+
name|ssid_len
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_SSID
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|supp_rates
operator|=
name|buf
operator|+
name|len
expr_stmt|;
name|len
operator|+=
literal|2
expr_stmt|;
name|supp_rates
index|[
literal|0
index|]
operator|=
name|WLAN_EID_SUPP_RATES
expr_stmt|;
name|supp_rates
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|mlme
operator|.
name|num_curr_rates
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_rate_data
modifier|*
name|rate
init|=
operator|&
name|wpa_s
operator|->
name|mlme
operator|.
name|curr_rates
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|esupp_rates
condition|)
block|{
name|pos
operator|=
name|buf
operator|+
name|len
expr_stmt|;
name|len
operator|++
expr_stmt|;
name|esupp_rates
index|[
literal|1
index|]
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|supp_rates
index|[
literal|1
index|]
operator|==
literal|8
condition|)
block|{
name|esupp_rates
operator|=
name|pos
expr_stmt|;
name|esupp_rates
index|[
literal|0
index|]
operator|=
name|WLAN_EID_EXT_SUPP_RATES
expr_stmt|;
name|esupp_rates
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
name|pos
operator|=
operator|&
name|esupp_rates
index|[
literal|2
index|]
expr_stmt|;
name|len
operator|+=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|pos
operator|=
name|buf
operator|+
name|len
expr_stmt|;
name|len
operator|++
expr_stmt|;
name|supp_rates
index|[
literal|1
index|]
operator|++
expr_stmt|;
block|}
operator|*
name|pos
operator|++
operator|=
name|rate
operator|->
name|rate
operator|/
literal|5
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie_len
argument_list|)
expr_stmt|;
name|len
operator|+=
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie_len
expr_stmt|;
block|}
name|ieee80211_sta_tx
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ieee80211_sta_wep_configured
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|#
directive|if
literal|0
comment|/* FIX */
block|if (sdata == NULL || sdata->default_key == NULL || 	    sdata->default_key->alg != ALG_WEP) 		return 0; 	return 1;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_auth_completed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: authenticated"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|authenticated
operator|=
literal|1
expr_stmt|;
name|ieee80211_associate
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_auth_challenge
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: replying to auth challenge"
argument_list|)
expr_stmt|;
name|pos
operator|=
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|variable
expr_stmt|;
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|pos
argument_list|,
name|len
operator|-
operator|(
name|pos
operator|-
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|)
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|==
name|ParseFailed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to parse Auth(challenge)"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|elems
operator|.
name|challenge
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: no challenge IE in shared key "
literal|"auth frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ieee80211_send_auth
argument_list|(
name|wpa_s
argument_list|,
literal|3
argument_list|,
name|elems
operator|.
name|challenge
operator|-
literal|2
argument_list|,
name|elems
operator|.
name|challenge_len
operator|+
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_rx_mgmt_auth
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|u16
name|auth_alg
decl_stmt|,
name|auth_transaction
decl_stmt|,
name|status_code
decl_stmt|;
name|int
name|adhoc
decl_stmt|;
name|adhoc
operator|=
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|!=
name|IEEE80211_AUTHENTICATE
operator|&&
operator|!
name|adhoc
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: authentication frame received "
literal|"from "
name|MACSTR
literal|", but not in authenticate state - "
literal|"ignored"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|<
literal|24
operator|+
literal|6
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: too short (%lu) authentication "
literal|"frame received from "
name|MACSTR
literal|" - ignored"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|adhoc
operator|&&
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: authentication frame received "
literal|"from unknown AP (SA="
name|MACSTR
literal|" BSSID="
name|MACSTR
literal|") - ignored"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|adhoc
operator|&&
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|mgmt
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: authentication frame received "
literal|"from unknown BSSID (SA="
name|MACSTR
literal|" BSSID="
name|MACSTR
literal|") - ignored"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|auth_alg
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|auth_alg
argument_list|)
expr_stmt|;
name|auth_transaction
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|auth_transaction
argument_list|)
expr_stmt|;
name|status_code
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|status_code
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: RX authentication from "
name|MACSTR
literal|" (alg=%d transaction=%d status=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|auth_alg
argument_list|,
name|auth_transaction
argument_list|,
name|status_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|adhoc
condition|)
block|{
comment|/* IEEE 802.11 standard does not require authentication in IBSS 		 * networks and most implementations do not seem to use it. 		 * However, try to reply to authentication attempts if someone 		 * has actually implemented this. 		 * TODO: Could implement shared key authentication. */
if|if
condition|(
name|auth_alg
operator|!=
name|WLAN_AUTH_OPEN
operator|||
name|auth_transaction
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: unexpected IBSS "
literal|"authentication frame (alg=%d "
literal|"transaction=%d)"
argument_list|,
name|auth_alg
argument_list|,
name|auth_transaction
argument_list|)
expr_stmt|;
return|return;
block|}
name|ieee80211_send_auth
argument_list|(
name|wpa_s
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|auth_alg
operator|!=
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|||
name|auth_transaction
operator|!=
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_transaction
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: unexpected authentication frame "
literal|"(alg=%d transaction=%d)"
argument_list|,
name|auth_alg
argument_list|,
name|auth_transaction
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status_code
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: AP denied authentication "
literal|"(auth_alg=%d code=%d)"
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
argument_list|,
name|status_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|status_code
operator|==
name|WLAN_STATUS_NOT_SUPPORTED_AUTH_ALG
condition|)
block|{
specifier|const
name|int
name|num_algs
init|=
literal|3
decl_stmt|;
name|u8
name|algs
index|[
name|num_algs
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|pos
decl_stmt|;
name|algs
index|[
literal|0
index|]
operator|=
name|algs
index|[
literal|1
index|]
operator|=
name|algs
index|[
literal|2
index|]
operator|=
literal|0xff
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_algs
operator|&
name|IEEE80211_AUTH_ALG_OPEN
condition|)
name|algs
index|[
literal|0
index|]
operator|=
name|WLAN_AUTH_OPEN
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_algs
operator|&
name|IEEE80211_AUTH_ALG_SHARED_KEY
condition|)
name|algs
index|[
literal|1
index|]
operator|=
name|WLAN_AUTH_SHARED_KEY
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_algs
operator|&
name|IEEE80211_AUTH_ALG_LEAP
condition|)
name|algs
index|[
literal|2
index|]
operator|=
name|WLAN_AUTH_LEAP
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|==
name|WLAN_AUTH_OPEN
condition|)
name|pos
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|==
name|WLAN_AUTH_SHARED_KEY
condition|)
name|pos
operator|=
literal|1
expr_stmt|;
else|else
name|pos
operator|=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_algs
condition|;
name|i
operator|++
control|)
block|{
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|>=
name|num_algs
condition|)
name|pos
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|algs
index|[
name|pos
index|]
operator|==
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|||
name|algs
index|[
name|pos
index|]
operator|==
literal|0xff
condition|)
continue|continue;
if|if
condition|(
name|algs
index|[
name|pos
index|]
operator|==
name|WLAN_AUTH_SHARED_KEY
operator|&&
operator|!
name|ieee80211_sta_wep_configured
argument_list|(
name|wpa_s
argument_list|)
condition|)
continue|continue;
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|=
name|algs
index|[
name|pos
index|]
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: set auth_alg=%d "
literal|"for next try"
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return;
block|}
switch|switch
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
condition|)
block|{
case|case
name|WLAN_AUTH_OPEN
case|:
case|case
name|WLAN_AUTH_LEAP
case|:
name|ieee80211_auth_completed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_AUTH_SHARED_KEY
case|:
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_transaction
operator|==
literal|4
condition|)
name|ieee80211_auth_completed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
else|else
name|ieee80211_auth_challenge
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
case|case
name|WLAN_AUTH_FT
case|:
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|ft_ies
operator|.
name|ies
operator|=
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|variable
expr_stmt|;
name|data
operator|.
name|ft_ies
operator|.
name|ies_len
operator|=
name|len
operator|-
operator|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|variable
operator|-
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|ft_ies
operator|.
name|target_ap
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_FT_RESPONSE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|ieee80211_auth_completed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_rx_mgmt_deauth
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|u16
name|reason_code
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|24
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: too short (%lu) deauthentication "
literal|"frame received from "
name|MACSTR
literal|" - ignored"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: deauthentication frame received "
literal|"from unknown AP (SA="
name|MACSTR
literal|" BSSID="
name|MACSTR
literal|") - ignored"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|reason_code
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|deauth
operator|.
name|reason_code
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: RX deauthentication from "
name|MACSTR
literal|" (reason=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|authenticated
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: deauthenticated"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|==
name|IEEE80211_AUTHENTICATE
operator|||
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|==
name|IEEE80211_ASSOCIATE
operator|||
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|==
name|IEEE80211_ASSOCIATED
condition|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|=
name|IEEE80211_AUTHENTICATE
expr_stmt|;
name|ieee80211_reschedule_timer
argument_list|(
name|wpa_s
argument_list|,
name|IEEE80211_RETRY_AUTH_INTERVAL
argument_list|)
expr_stmt|;
block|}
name|ieee80211_set_associated
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|authenticated
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_rx_mgmt_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|u16
name|reason_code
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|24
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: too short (%lu) disassociation "
literal|"frame received from "
name|MACSTR
literal|" - ignored"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: disassociation frame received "
literal|"from unknown AP (SA="
name|MACSTR
literal|" BSSID="
name|MACSTR
literal|") - ignored"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|reason_code
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|disassoc
operator|.
name|reason_code
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: RX disassociation from "
name|MACSTR
literal|" (reason=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|associated
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: disassociated"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|==
name|IEEE80211_ASSOCIATED
condition|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|=
name|IEEE80211_ASSOCIATE
expr_stmt|;
name|ieee80211_reschedule_timer
argument_list|(
name|wpa_s
argument_list|,
name|IEEE80211_RETRY_AUTH_INTERVAL
argument_list|)
expr_stmt|;
block|}
name|ieee80211_set_associated
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ieee80211_ft_assoc_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee802_11_elems
modifier|*
name|elems
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
specifier|const
name|u8
modifier|*
name|mobility_domain
init|=
name|NULL
decl_stmt|;
specifier|const
name|u8
modifier|*
name|r0kh_id
init|=
name|NULL
decl_stmt|;
name|size_t
name|r0kh_id_len
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|r1kh_id
init|=
name|NULL
decl_stmt|;
name|struct
name|rsn_ftie
modifier|*
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
if|if
condition|(
name|elems
operator|->
name|mdie
operator|&&
name|elems
operator|->
name|mdie_len
operator|>=
name|MOBILITY_DOMAIN_ID_LEN
condition|)
name|mobility_domain
operator|=
name|elems
operator|->
name|mdie
expr_stmt|;
if|if
condition|(
name|elems
operator|->
name|ftie
operator|&&
name|elems
operator|->
name|ftie_len
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|rsn_ftie
argument_list|)
condition|)
block|{
name|end
operator|=
name|elems
operator|->
name|ftie
operator|+
name|elems
operator|->
name|ftie_len
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|rsn_ftie
operator|*
operator|)
name|elems
operator|->
name|ftie
expr_stmt|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|FTIE_SUBELEM_R1KH_ID
operator|&&
name|pos
index|[
literal|1
index|]
operator|==
name|FT_R1KH_ID_LEN
condition|)
name|r1kh_id
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|FTIE_SUBELEM_R0KH_ID
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|1
operator|&&
name|pos
index|[
literal|1
index|]
operator|<=
name|FT_R0KH_ID_MAX_LEN
condition|)
block|{
name|r0kh_id
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|r0kh_id_len
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
block|}
return|return
name|wpa_sm_set_ft_params
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|mobility_domain
argument_list|,
name|r0kh_id
argument_list|,
name|r0kh_id_len
argument_list|,
name|r1kh_id
argument_list|)
return|;
else|#
directive|else
comment|/* CONFIG_IEEE80211R */
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_rx_mgmt_assoc_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|,
name|int
name|reassoc
parameter_list|)
block|{
name|u8
name|rates
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|rates_len
decl_stmt|;
name|u16
name|capab_info
decl_stmt|,
name|status_code
decl_stmt|,
name|aid
decl_stmt|;
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
comment|/* AssocResp and ReassocResp have identical structure, so process both 	 * of them in this function. */
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|!=
name|IEEE80211_ASSOCIATE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: association frame received from "
name|MACSTR
literal|", but not in associate state - ignored"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|<
literal|24
operator|+
literal|6
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: too short (%lu) association "
literal|"frame received from "
name|MACSTR
literal|" - ignored"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: association frame received from "
literal|"unknown AP (SA="
name|MACSTR
literal|" BSSID="
name|MACSTR
literal|") - "
literal|"ignored"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|capab_info
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
operator|.
name|capab_info
argument_list|)
expr_stmt|;
name|status_code
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
operator|.
name|status_code
argument_list|)
expr_stmt|;
name|aid
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
operator|.
name|aid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|aid
operator|&
operator|(
name|BIT
argument_list|(
literal|15
argument_list|)
operator||
name|BIT
argument_list|(
literal|14
argument_list|)
operator|)
operator|)
operator|!=
operator|(
name|BIT
argument_list|(
literal|15
argument_list|)
operator||
name|BIT
argument_list|(
literal|14
argument_list|)
operator|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: invalid aid value %d; bits 15:14 "
literal|"not set"
argument_list|,
name|aid
argument_list|)
expr_stmt|;
name|aid
operator|&=
operator|~
operator|(
name|BIT
argument_list|(
literal|15
argument_list|)
operator||
name|BIT
argument_list|(
literal|14
argument_list|)
operator|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: RX %sssocResp from "
name|MACSTR
literal|" (capab=0x%x status=%d aid=%d)"
argument_list|,
name|reassoc
condition|?
literal|"Rea"
else|:
literal|"A"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|capab_info
argument_list|,
name|status_code
argument_list|,
name|aid
argument_list|)
expr_stmt|;
name|pos
operator|=
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
operator|.
name|variable
expr_stmt|;
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|pos
argument_list|,
name|len
operator|-
operator|(
name|pos
operator|-
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|)
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|==
name|ParseFailed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to parse AssocResp"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status_code
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: AP denied association (code=%d)"
argument_list|,
name|status_code
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|status_code
operator|==
name|WLAN_STATUS_ASSOC_REJECTED_TEMPORARILY
operator|&&
name|elems
operator|.
name|timeout_int
operator|&&
name|elems
operator|.
name|timeout_int_len
operator|==
literal|5
operator|&&
name|elems
operator|.
name|timeout_int
index|[
literal|0
index|]
operator|==
name|WLAN_TIMEOUT_ASSOC_COMEBACK
condition|)
block|{
name|u32
name|tu
decl_stmt|,
name|ms
decl_stmt|;
name|tu
operator|=
name|WPA_GET_LE32
argument_list|(
name|elems
operator|.
name|timeout_int
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ms
operator|=
name|tu
operator|*
literal|1024
operator|/
literal|1000
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: AP rejected association "
literal|"temporarily; comeback duration %u TU "
literal|"(%u ms)"
argument_list|,
name|tu
argument_list|,
name|ms
argument_list|)
expr_stmt|;
if|if
condition|(
name|ms
operator|>
name|IEEE80211_ASSOC_TIMEOUT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Update timer "
literal|"based on comeback duration"
argument_list|)
expr_stmt|;
name|ieee80211_reschedule_timer
argument_list|(
name|wpa_s
argument_list|,
name|ms
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
return|return;
block|}
if|if
condition|(
name|elems
operator|.
name|supp_rates
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: no SuppRates element in "
literal|"AssocResp"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|==
name|WLAN_AUTH_FT
condition|)
block|{
if|if
condition|(
operator|!
name|reassoc
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: AP tried to use "
literal|"association, not reassociation, response "
literal|"with FT"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_ft_validate_reassoc_resp
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|pos
argument_list|,
name|len
operator|-
operator|(
name|pos
operator|-
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|)
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: FT validation of Reassoc"
literal|"Resp failed"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|ieee80211_ft_assoc_resp
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|elems
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: associated"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|aid
operator|=
name|aid
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|ap_capab
operator|=
name|capab_info
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies_len
operator|=
name|len
operator|-
operator|(
name|pos
operator|-
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies
operator|=
name|os_malloc
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies
condition|)
block|{
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies
argument_list|,
name|pos
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies_len
argument_list|)
expr_stmt|;
block|}
name|ieee80211_set_associated
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rates_len
operator|=
name|elems
operator|.
name|supp_rates_len
expr_stmt|;
if|if
condition|(
name|rates_len
operator|>
sizeof|sizeof
argument_list|(
name|rates
argument_list|)
condition|)
name|rates_len
operator|=
sizeof|sizeof
argument_list|(
name|rates
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|rates
argument_list|,
name|elems
operator|.
name|supp_rates
argument_list|,
name|rates_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|elems
operator|.
name|ext_supp_rates
condition|)
block|{
name|size_t
name|_len
init|=
name|elems
operator|.
name|ext_supp_rates_len
decl_stmt|;
if|if
condition|(
name|_len
operator|>
sizeof|sizeof
argument_list|(
name|rates
argument_list|)
operator|-
name|rates_len
condition|)
name|_len
operator|=
sizeof|sizeof
argument_list|(
name|rates
argument_list|)
operator|-
name|rates_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|rates
operator|+
name|rates_len
argument_list|,
name|elems
operator|.
name|ext_supp_rates
argument_list|,
name|_len
argument_list|)
expr_stmt|;
name|rates_len
operator|+=
name|_len
expr_stmt|;
block|}
if|if
condition|(
name|wpa_drv_set_bssid
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to set BSSID for the "
literal|"netstack"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_drv_set_ssid
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to set SSID for the "
literal|"netstack"
argument_list|)
expr_stmt|;
block|}
comment|/* Remove STA entry before adding a new one just in case to avoid 	 * problems with existing configuration (e.g., keys). */
name|wpa_drv_mlme_remove_sta
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_mlme_add_sta
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|rates
argument_list|,
name|rates_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to add STA entry to the "
literal|"netstack"
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
comment|/* FIX? */
block|sta->assoc_ap = 1;  	if (elems.wmm&& wpa_s->mlme.wmm_enabled) { 		sta->flags |= WLAN_STA_WMM; 		ieee80211_sta_wmm_params(wpa_s, elems.wmm, elems.wmm_len); 	}
endif|#
directive|endif
name|ieee80211_associated
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Caller must hold local->sta_bss_lock */
end_comment

begin_function
specifier|static
name|void
name|__ieee80211_bss_hash_add
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
parameter_list|)
block|{
name|bss
operator|->
name|hnext
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_hash
index|[
name|STA_HASH
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
index|]
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_hash
index|[
name|STA_HASH
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
index|]
operator|=
name|bss
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Caller must hold local->sta_bss_lock */
end_comment

begin_function
specifier|static
name|void
name|__ieee80211_bss_hash_del
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|ieee80211_sta_bss
modifier|*
name|b
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
name|b
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_hash
index|[
name|STA_HASH
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
index|]
expr_stmt|;
while|while
condition|(
name|b
condition|)
block|{
if|if
condition|(
name|b
operator|==
name|bss
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_hash
index|[
name|STA_HASH
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
index|]
operator|=
name|bss
operator|->
name|hnext
expr_stmt|;
block|}
else|else
block|{
name|prev
operator|->
name|hnext
operator|=
name|bss
operator|->
name|hnext
expr_stmt|;
block|}
break|break;
block|}
name|prev
operator|=
name|b
expr_stmt|;
name|b
operator|=
name|b
operator|->
name|hnext
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211_sta_bss
modifier|*
name|ieee80211_bss_add
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
decl_stmt|;
name|bss
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* TODO: order by RSSI? */
name|bss
operator|->
name|next
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_list
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_list
operator|=
name|bss
expr_stmt|;
name|__ieee80211_bss_hash_add
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
expr_stmt|;
return|return
name|bss
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211_sta_bss
modifier|*
name|ieee80211_bss_get
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
decl_stmt|;
name|bss
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_hash
index|[
name|STA_HASH
argument_list|(
name|bssid
argument_list|)
index|]
expr_stmt|;
while|while
condition|(
name|bss
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|bss
operator|=
name|bss
operator|->
name|hnext
expr_stmt|;
block|}
return|return
name|bss
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_bss_free
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
parameter_list|)
block|{
name|__ieee80211_bss_hash_del
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|wpa_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|rsn_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|wmm_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|mdie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_bss_list_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|bss
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_list
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_list
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|bss
condition|)
block|{
name|prev
operator|=
name|bss
expr_stmt|;
name|bss
operator|=
name|bss
operator|->
name|next
expr_stmt|;
name|ieee80211_bss_free
argument_list|(
name|wpa_s
argument_list|,
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_bss_info
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|,
name|int
name|beacon
parameter_list|)
block|{
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|size_t
name|baselen
decl_stmt|;
name|int
name|channel
decl_stmt|,
name|invalid
init|=
literal|0
decl_stmt|,
name|clen
decl_stmt|;
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
decl_stmt|;
name|u64
name|timestamp
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|ie_pos
decl_stmt|;
name|size_t
name|ie_len
decl_stmt|;
if|if
condition|(
operator|!
name|beacon
operator|&&
name|os_memcmp
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
condition|)
return|return;
comment|/* ignore ProbeResp to foreign address */
if|#
directive|if
literal|0
block|wpa_printf(MSG_MSGDUMP, "MLME: RX %s from " MACSTR " to " MACSTR, 		   beacon ? "Beacon" : "Probe Response", 		   MAC2STR(mgmt->sa), MAC2STR(mgmt->da));
endif|#
directive|endif
name|baselen
operator|=
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|->
name|u
operator|.
name|beacon
operator|.
name|variable
operator|-
operator|(
name|u8
operator|*
operator|)
name|mgmt
expr_stmt|;
if|if
condition|(
name|baselen
operator|>
name|len
condition|)
return|return;
name|pos
operator|=
name|mgmt
operator|->
name|u
operator|.
name|beacon
operator|.
name|timestamp
expr_stmt|;
name|timestamp
operator|=
name|WPA_GET_LE64
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|if (local->conf.mode == IW_MODE_ADHOC&& beacon&& 	    os_memcmp(mgmt->bssid, local->bssid, ETH_ALEN) == 0) {
ifdef|#
directive|ifdef
name|IEEE80211_IBSS_DEBUG
block|static unsigned long last_tsf_debug = 0; 		u64 tsf; 		if (local->hw->get_tsf) 			tsf = local->hw->get_tsf(local->mdev); 		else 			tsf = -1LLU; 		if (time_after(jiffies, last_tsf_debug + 5 * HZ)) { 			wpa_printf(MSG_DEBUG, "RX beacon SA=" MACSTR " BSSID=" 				   MACSTR " TSF=0x%llx BCN=0x%llx diff=%lld " 				   "@%ld", 				   MAC2STR(mgmt->sa), MAC2STR(mgmt->bssid), 				   tsf, timestamp, tsf - timestamp, jiffies); 			last_tsf_debug = jiffies; 		}
endif|#
directive|endif
comment|/* IEEE80211_IBSS_DEBUG */
block|}
endif|#
directive|endif
name|ie_pos
operator|=
name|mgmt
operator|->
name|u
operator|.
name|beacon
operator|.
name|variable
expr_stmt|;
name|ie_len
operator|=
name|len
operator|-
name|baselen
expr_stmt|;
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|ie_pos
argument_list|,
name|ie_len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|==
name|ParseFailed
condition|)
name|invalid
operator|=
literal|1
expr_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|if (local->conf.mode == IW_MODE_ADHOC&& elems.supp_rates&& 	    os_memcmp(mgmt->bssid, local->bssid, ETH_ALEN) == 0&& 	    (sta = sta_info_get(local, mgmt->sa))) { 		struct ieee80211_rate *rates; 		size_t num_rates; 		u32 supp_rates, prev_rates; 		int i, j, oper_mode;  		rates = local->curr_rates; 		num_rates = local->num_curr_rates; 		oper_mode = wpa_s->mlme.sta_scanning ? 			local->scan_oper_phymode : local->conf.phymode; 		for (i = 0; i< local->hw->num_modes; i++) { 			struct ieee80211_hw_modes *mode =&local->hw->modes[i]; 			if (oper_mode == mode->mode) { 				rates = mode->rates; 				num_rates = mode->num_rates; 				break; 			} 		}  		supp_rates = 0; 		for (i = 0; i< elems.supp_rates_len + 			     elems.ext_supp_rates_len; i++) { 			u8 rate = 0; 			int own_rate; 			if (i< elems.supp_rates_len) 				rate = elems.supp_rates[i]; 			else if (elems.ext_supp_rates) 				rate = elems.ext_supp_rates 					[i - elems.supp_rates_len]; 			own_rate = 5 * (rate& 0x7f); 			if (oper_mode == MODE_ATHEROS_TURBO) 				own_rate *= 2; 			for (j = 0; j< num_rates; j++) 				if (rates[j].rate == own_rate) 					supp_rates |= BIT(j); 		}  		prev_rates = sta->supp_rates; 		sta->supp_rates&= supp_rates; 		if (sta->supp_rates == 0) {
comment|/* No matching rates - this should not really happen. 			 * Make sure that at least one rate is marked 			 * supported to avoid issues with TX rate ctrl. */
block|sta->supp_rates = wpa_s->mlme.supp_rates_bits; 		} 		if (sta->supp_rates != prev_rates) { 			wpa_printf(MSG_DEBUG, "MLME: updated supp_rates set " 				   "for " MACSTR " based on beacon info " 				   "(0x%x& 0x%x -> 0x%x)", 				   MAC2STR(sta->addr), prev_rates, 				   supp_rates, sta->supp_rates); 		} 		sta_info_release(local, sta); 	}
endif|#
directive|endif
if|if
condition|(
name|elems
operator|.
name|ssid
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|elems
operator|.
name|ds_params
operator|&&
name|elems
operator|.
name|ds_params_len
operator|==
literal|1
condition|)
name|channel
operator|=
name|elems
operator|.
name|ds_params
index|[
literal|0
index|]
expr_stmt|;
else|else
name|channel
operator|=
name|rx_status
operator|->
name|channel
expr_stmt|;
name|bss
operator|=
name|ieee80211_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|bss
operator|=
name|ieee80211_bss_add
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return;
block|}
else|else
block|{
if|#
directive|if
literal|0
comment|/* TODO: order by RSSI? */
block|spin_lock_bh(&local->sta_bss_lock); 		list_move_tail(&bss->list,&local->sta_bss_list); 		spin_unlock_bh(&local->sta_bss_lock);
endif|#
directive|endif
block|}
if|if
condition|(
name|bss
operator|->
name|probe_resp
operator|&&
name|beacon
condition|)
block|{
comment|/* Do not allow beacon to override data from Probe Response. */
return|return;
block|}
name|bss
operator|->
name|beacon_int
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|beacon
operator|.
name|beacon_int
argument_list|)
expr_stmt|;
name|bss
operator|->
name|capability
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|beacon
operator|.
name|capab_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|ie
operator|==
name|NULL
operator|||
name|bss
operator|->
name|ie_len
operator|<
name|ie_len
condition|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|ie
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ie
operator|=
name|os_malloc
argument_list|(
name|ie_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bss
operator|->
name|ie
condition|)
block|{
name|os_memcpy
argument_list|(
name|bss
operator|->
name|ie
argument_list|,
name|ie_pos
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ie_len
operator|=
name|ie_len
expr_stmt|;
block|}
if|if
condition|(
name|elems
operator|.
name|ssid
operator|&&
name|elems
operator|.
name|ssid_len
operator|<=
name|MAX_SSID_LEN
condition|)
block|{
name|os_memcpy
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|elems
operator|.
name|ssid
argument_list|,
name|elems
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid_len
operator|=
name|elems
operator|.
name|ssid_len
expr_stmt|;
block|}
name|bss
operator|->
name|supp_rates_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|elems
operator|.
name|supp_rates
condition|)
block|{
name|clen
operator|=
name|IEEE80211_MAX_SUPP_RATES
operator|-
name|bss
operator|->
name|supp_rates_len
expr_stmt|;
if|if
condition|(
name|clen
operator|>
name|elems
operator|.
name|supp_rates_len
condition|)
name|clen
operator|=
name|elems
operator|.
name|supp_rates_len
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|bss
operator|->
name|supp_rates
index|[
name|bss
operator|->
name|supp_rates_len
index|]
argument_list|,
name|elems
operator|.
name|supp_rates
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|bss
operator|->
name|supp_rates_len
operator|+=
name|clen
expr_stmt|;
block|}
if|if
condition|(
name|elems
operator|.
name|ext_supp_rates
condition|)
block|{
name|clen
operator|=
name|IEEE80211_MAX_SUPP_RATES
operator|-
name|bss
operator|->
name|supp_rates_len
expr_stmt|;
if|if
condition|(
name|clen
operator|>
name|elems
operator|.
name|ext_supp_rates_len
condition|)
name|clen
operator|=
name|elems
operator|.
name|ext_supp_rates_len
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|bss
operator|->
name|supp_rates
index|[
name|bss
operator|->
name|supp_rates_len
index|]
argument_list|,
name|elems
operator|.
name|ext_supp_rates
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|bss
operator|->
name|supp_rates_len
operator|+=
name|clen
expr_stmt|;
block|}
if|if
condition|(
name|elems
operator|.
name|wpa_ie
operator|&&
operator|(
name|bss
operator|->
name|wpa_ie
operator|==
name|NULL
operator|||
name|bss
operator|->
name|wpa_ie_len
operator|!=
name|elems
operator|.
name|wpa_ie_len
operator|||
name|os_memcmp
argument_list|(
name|bss
operator|->
name|wpa_ie
argument_list|,
name|elems
operator|.
name|wpa_ie
argument_list|,
name|elems
operator|.
name|wpa_ie_len
argument_list|)
operator|)
condition|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|wpa_ie
argument_list|)
expr_stmt|;
name|bss
operator|->
name|wpa_ie
operator|=
name|os_malloc
argument_list|(
name|elems
operator|.
name|wpa_ie_len
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wpa_ie
condition|)
block|{
name|os_memcpy
argument_list|(
name|bss
operator|->
name|wpa_ie
argument_list|,
name|elems
operator|.
name|wpa_ie
operator|-
literal|2
argument_list|,
name|elems
operator|.
name|wpa_ie_len
operator|+
literal|2
argument_list|)
expr_stmt|;
name|bss
operator|->
name|wpa_ie_len
operator|=
name|elems
operator|.
name|wpa_ie_len
operator|+
literal|2
expr_stmt|;
block|}
else|else
name|bss
operator|->
name|wpa_ie_len
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|elems
operator|.
name|wpa_ie
operator|&&
name|bss
operator|->
name|wpa_ie
condition|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|wpa_ie
argument_list|)
expr_stmt|;
name|bss
operator|->
name|wpa_ie
operator|=
name|NULL
expr_stmt|;
name|bss
operator|->
name|wpa_ie_len
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|elems
operator|.
name|rsn_ie
operator|&&
operator|(
name|bss
operator|->
name|rsn_ie
operator|==
name|NULL
operator|||
name|bss
operator|->
name|rsn_ie_len
operator|!=
name|elems
operator|.
name|rsn_ie_len
operator|||
name|os_memcmp
argument_list|(
name|bss
operator|->
name|rsn_ie
argument_list|,
name|elems
operator|.
name|rsn_ie
argument_list|,
name|elems
operator|.
name|rsn_ie_len
argument_list|)
operator|)
condition|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|rsn_ie
argument_list|)
expr_stmt|;
name|bss
operator|->
name|rsn_ie
operator|=
name|os_malloc
argument_list|(
name|elems
operator|.
name|rsn_ie_len
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|rsn_ie
condition|)
block|{
name|os_memcpy
argument_list|(
name|bss
operator|->
name|rsn_ie
argument_list|,
name|elems
operator|.
name|rsn_ie
operator|-
literal|2
argument_list|,
name|elems
operator|.
name|rsn_ie_len
operator|+
literal|2
argument_list|)
expr_stmt|;
name|bss
operator|->
name|rsn_ie_len
operator|=
name|elems
operator|.
name|rsn_ie_len
operator|+
literal|2
expr_stmt|;
block|}
else|else
name|bss
operator|->
name|rsn_ie_len
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|elems
operator|.
name|rsn_ie
operator|&&
name|bss
operator|->
name|rsn_ie
condition|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|rsn_ie
argument_list|)
expr_stmt|;
name|bss
operator|->
name|rsn_ie
operator|=
name|NULL
expr_stmt|;
name|bss
operator|->
name|rsn_ie_len
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|elems
operator|.
name|wmm
operator|&&
operator|(
name|bss
operator|->
name|wmm_ie
operator|==
name|NULL
operator|||
name|bss
operator|->
name|wmm_ie_len
operator|!=
name|elems
operator|.
name|wmm_len
operator|||
name|os_memcmp
argument_list|(
name|bss
operator|->
name|wmm_ie
argument_list|,
name|elems
operator|.
name|wmm
argument_list|,
name|elems
operator|.
name|wmm_len
argument_list|)
operator|)
condition|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|wmm_ie
argument_list|)
expr_stmt|;
name|bss
operator|->
name|wmm_ie
operator|=
name|os_malloc
argument_list|(
name|elems
operator|.
name|wmm_len
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wmm_ie
condition|)
block|{
name|os_memcpy
argument_list|(
name|bss
operator|->
name|wmm_ie
argument_list|,
name|elems
operator|.
name|wmm
operator|-
literal|2
argument_list|,
name|elems
operator|.
name|wmm_len
operator|+
literal|2
argument_list|)
expr_stmt|;
name|bss
operator|->
name|wmm_ie_len
operator|=
name|elems
operator|.
name|wmm_len
operator|+
literal|2
expr_stmt|;
block|}
else|else
name|bss
operator|->
name|wmm_ie_len
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|elems
operator|.
name|wmm
operator|&&
name|bss
operator|->
name|wmm_ie
condition|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|wmm_ie
argument_list|)
expr_stmt|;
name|bss
operator|->
name|wmm_ie
operator|=
name|NULL
expr_stmt|;
name|bss
operator|->
name|wmm_ie_len
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|elems
operator|.
name|mdie
operator|&&
operator|(
name|bss
operator|->
name|mdie
operator|==
name|NULL
operator|||
name|bss
operator|->
name|mdie_len
operator|!=
name|elems
operator|.
name|mdie_len
operator|||
name|os_memcmp
argument_list|(
name|bss
operator|->
name|mdie
argument_list|,
name|elems
operator|.
name|mdie
argument_list|,
name|elems
operator|.
name|mdie_len
argument_list|)
operator|)
condition|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|mdie
argument_list|)
expr_stmt|;
name|bss
operator|->
name|mdie
operator|=
name|os_malloc
argument_list|(
name|elems
operator|.
name|mdie_len
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|mdie
condition|)
block|{
name|os_memcpy
argument_list|(
name|bss
operator|->
name|mdie
argument_list|,
name|elems
operator|.
name|mdie
operator|-
literal|2
argument_list|,
name|elems
operator|.
name|mdie_len
operator|+
literal|2
argument_list|)
expr_stmt|;
name|bss
operator|->
name|mdie_len
operator|=
name|elems
operator|.
name|mdie_len
operator|+
literal|2
expr_stmt|;
block|}
else|else
name|bss
operator|->
name|mdie_len
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|elems
operator|.
name|mdie
operator|&&
name|bss
operator|->
name|mdie
condition|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|mdie
argument_list|)
expr_stmt|;
name|bss
operator|->
name|mdie
operator|=
name|NULL
expr_stmt|;
name|bss
operator|->
name|mdie_len
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|bss
operator|->
name|hw_mode
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
expr_stmt|;
name|bss
operator|->
name|channel
operator|=
name|channel
expr_stmt|;
name|bss
operator|->
name|freq
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|freq
expr_stmt|;
if|if
condition|(
name|channel
operator|!=
name|wpa_s
operator|->
name|mlme
operator|.
name|channel
operator|&&
operator|(
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
operator|==
name|WPA_MODE_IEEE80211G
operator|||
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
operator|==
name|WPA_MODE_IEEE80211B
operator|)
operator|&&
name|channel
operator|>=
literal|1
operator|&&
name|channel
operator|<=
literal|14
condition|)
block|{
specifier|static
specifier|const
name|int
name|freq_list
index|[]
init|=
block|{
literal|2412
block|,
literal|2417
block|,
literal|2422
block|,
literal|2427
block|,
literal|2432
block|,
literal|2437
block|,
literal|2442
block|,
literal|2447
block|,
literal|2452
block|,
literal|2457
block|,
literal|2462
block|,
literal|2467
block|,
literal|2472
block|,
literal|2484
block|}
decl_stmt|;
comment|/* IEEE 802.11g/b mode can receive packets from neighboring 		 * channels, so map the channel into frequency. */
name|bss
operator|->
name|freq
operator|=
name|freq_list
index|[
name|channel
operator|-
literal|1
index|]
expr_stmt|;
block|}
name|bss
operator|->
name|timestamp
operator|=
name|timestamp
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|bss
operator|->
name|last_update
argument_list|)
expr_stmt|;
name|bss
operator|->
name|rssi
operator|=
name|rx_status
operator|->
name|ssi
expr_stmt|;
if|if
condition|(
operator|!
name|beacon
condition|)
name|bss
operator|->
name|probe_resp
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_rx_mgmt_probe_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|ieee80211_bss_info
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_rx_mgmt_beacon
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|int
name|use_protection
decl_stmt|;
name|size_t
name|baselen
decl_stmt|;
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|ieee80211_bss_info
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|mlme
operator|.
name|associated
operator|||
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|mgmt
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
return|return;
comment|/* Process beacon from the current BSS */
name|baselen
operator|=
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|->
name|u
operator|.
name|beacon
operator|.
name|variable
operator|-
operator|(
name|u8
operator|*
operator|)
name|mgmt
expr_stmt|;
if|if
condition|(
name|baselen
operator|>
name|len
condition|)
return|return;
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|beacon
operator|.
name|variable
argument_list|,
name|len
operator|-
name|baselen
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|==
name|ParseFailed
condition|)
return|return;
name|use_protection
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|elems
operator|.
name|erp_info
operator|&&
name|elems
operator|.
name|erp_info_len
operator|>=
literal|1
condition|)
block|{
name|use_protection
operator|=
operator|(
name|elems
operator|.
name|erp_info
index|[
literal|0
index|]
operator|&
name|ERP_INFO_USE_PROTECTION
operator|)
operator|!=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|use_protection
operator|!=
operator|!
operator|!
name|wpa_s
operator|->
name|mlme
operator|.
name|use_protection
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: CTS protection %s (BSSID="
name|MACSTR
literal|")"
argument_list|,
name|use_protection
condition|?
literal|"enabled"
else|:
literal|"disabled"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|use_protection
operator|=
name|use_protection
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|cts_protect_erp_frames
operator|=
name|use_protection
expr_stmt|;
block|}
if|if
condition|(
name|elems
operator|.
name|wmm
operator|&&
name|wpa_s
operator|->
name|mlme
operator|.
name|wmm_enabled
condition|)
block|{
name|ieee80211_sta_wmm_params
argument_list|(
name|wpa_s
argument_list|,
name|elems
operator|.
name|wmm
argument_list|,
name|elems
operator|.
name|wmm_len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_rx_mgmt_probe_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|int
name|tx_last_beacon
decl_stmt|,
name|adhoc
decl_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|struct ieee80211_mgmt *resp;
endif|#
directive|endif
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|adhoc
operator|=
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|adhoc
operator|||
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|!=
name|IEEE80211_IBSS_JOINED
operator|||
name|len
operator|<
literal|24
operator|+
literal|2
operator|||
name|wpa_s
operator|->
name|mlme
operator|.
name|probe_resp
operator|==
name|NULL
condition|)
return|return;
if|#
directive|if
literal|0
comment|/* FIX */
block|if (local->hw->tx_last_beacon) 		tx_last_beacon = local->hw->tx_last_beacon(local->mdev); 	else
endif|#
directive|endif
name|tx_last_beacon
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE80211_IBSS_DEBUG
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: RX ProbeReq SA="
name|MACSTR
literal|" DA="
name|MACSTR
literal|" BSSID="
name|MACSTR
literal|" (tx_last_beacon=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|da
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|)
argument_list|,
name|tx_last_beacon
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE80211_IBSS_DEBUG */
if|if
condition|(
operator|!
name|tx_last_beacon
condition|)
return|return;
if|if
condition|(
name|os_memcmp
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|end
operator|=
operator|(
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|)
operator|+
name|len
expr_stmt|;
name|pos
operator|=
name|mgmt
operator|->
name|u
operator|.
name|probe_req
operator|.
name|variable
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|!=
name|WLAN_EID_SSID
operator|||
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Invalid SSID IE in ProbeReq from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|!=
literal|0
operator|&&
operator|(
name|pos
index|[
literal|1
index|]
operator|!=
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|pos
operator|+
literal|2
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
comment|/* Ignore ProbeReq for foreign SSID */
return|return;
block|}
if|#
directive|if
literal|0
comment|/* FIX */
comment|/* Reply with ProbeResp */
block|skb = skb_copy(wpa_s->mlme.probe_resp, GFP_ATOMIC); 	if (skb == NULL) 		return;  	resp = (struct ieee80211_mgmt *) skb->data; 	os_memcpy(resp->da, mgmt->sa, ETH_ALEN);
ifdef|#
directive|ifdef
name|IEEE80211_IBSS_DEBUG
block|wpa_printf(MSG_DEBUG, "MLME: Sending ProbeResp to " MACSTR, 		   MAC2STR(resp->da));
endif|#
directive|endif
comment|/* IEEE80211_IBSS_DEBUG */
block|ieee80211_sta_tx(wpa_s, skb, 0, 1);
endif|#
directive|endif
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
end_ifdef

begin_function
specifier|static
name|void
name|ieee80211_rx_mgmt_ft_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|u16
name|status
decl_stmt|;
name|u8
modifier|*
name|sta_addr
decl_stmt|,
modifier|*
name|target_ap_addr
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|24
operator|+
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_resp
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Too short FT Action frame"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Only FT Action Response is needed for now since reservation 	 * protocol is not supported. 	 */
if|if
condition|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_resp
operator|.
name|action
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Unexpected FT Action %d"
argument_list|,
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_resp
operator|.
name|action
argument_list|)
expr_stmt|;
return|return;
block|}
name|status
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_resp
operator|.
name|status_code
argument_list|)
expr_stmt|;
name|sta_addr
operator|=
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_resp
operator|.
name|sta_addr
expr_stmt|;
name|target_ap_addr
operator|=
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_resp
operator|.
name|target_ap_addr
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Received FT Action Response: STA "
name|MACSTR
literal|" TargetAP "
name|MACSTR
literal|" Status Code %d"
argument_list|,
name|MAC2STR
argument_list|(
name|sta_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|target_ap_addr
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sta_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Foreign STA Address "
name|MACSTR
literal|" in FT Action Response"
argument_list|,
name|MAC2STR
argument_list|(
name|sta_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: FT Action Response indicates "
literal|"failure (status code %d)"
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* TODO: report error to FT code(?) */
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|ft_ies
operator|.
name|ies
operator|=
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_resp
operator|.
name|variable
expr_stmt|;
name|data
operator|.
name|ft_ies
operator|.
name|ies_len
operator|=
name|len
operator|-
operator|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_resp
operator|.
name|variable
operator|-
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|)
expr_stmt|;
name|data
operator|.
name|ft_ies
operator|.
name|ft_action
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|ft_ies
operator|.
name|target_ap
argument_list|,
name|target_ap_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_FT_RESPONSE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
comment|/* TODO: should only re-associate, if EVENT_FT_RESPONSE was processed 	 * successfully */
name|wpa_s
operator|->
name|mlme
operator|.
name|prev_bssid_set
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|=
name|WLAN_AUTH_FT
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|prev_bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|target_ap_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ieee80211_associate
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211R */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
end_ifdef

begin_comment
comment|/* MLME-SAQuery.response */
end_comment

begin_function
specifier|static
name|int
name|ieee80211_sta_send_sa_query_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|trans_id
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|mgmt
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mgmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgmt
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Failed to allocate buffer for "
literal|"SA Query action frame"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
literal|24
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ACTION
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|=
name|WLAN_ACTION_SA_QUERY
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|sa_query_resp
operator|.
name|action
operator|=
name|WLAN_SA_QUERY_RESPONSE
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|sa_query_resp
operator|.
name|trans_id
argument_list|,
name|trans_id
argument_list|,
name|WLAN_SA_QUERY_TR_ID_LEN
argument_list|)
expr_stmt|;
name|len
operator|+=
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|sa_query_resp
argument_list|)
expr_stmt|;
name|res
operator|=
name|ieee80211_sta_tx
argument_list|(
name|wpa_s
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|mgmt
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|mgmt
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_rx_mgmt_sa_query_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
literal|24
operator|+
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|sa_query_req
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Too short SA Query Action frame"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|sa_query_req
operator|.
name|action
operator|!=
name|WLAN_SA_QUERY_REQUEST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Unexpected SA Query Action %d"
argument_list|,
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|sa_query_req
operator|.
name|action
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Ignore SA Query from unknown "
literal|"source "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|==
name|IEEE80211_ASSOCIATE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Ignore SA query request during "
literal|"association process"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Replying to SA Query request"
argument_list|)
expr_stmt|;
name|ieee80211_sta_send_sa_query_resp
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|sa_query_req
operator|.
name|trans_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211W */
end_comment

begin_function
specifier|static
name|void
name|ieee80211_rx_mgmt_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: received Action frame"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|25
condition|)
return|return;
switch|switch
condition|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
case|case
name|WLAN_ACTION_FT
case|:
name|ieee80211_rx_mgmt_ft_action
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
case|case
name|WLAN_ACTION_SA_QUERY
case|:
name|ieee80211_rx_mgmt_sa_query_action
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: unknown Action Category %d"
argument_list|,
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_sta_rx_mgmt
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|u16
name|fc
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|24
condition|)
return|return;
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|frame_control
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|WLAN_FC_STYPE_PROBE_REQ
case|:
name|ieee80211_rx_mgmt_probe_req
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_STYPE_PROBE_RESP
case|:
name|ieee80211_rx_mgmt_probe_resp
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_STYPE_BEACON
case|:
name|ieee80211_rx_mgmt_beacon
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_STYPE_AUTH
case|:
name|ieee80211_rx_mgmt_auth
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_STYPE_ASSOC_RESP
case|:
name|ieee80211_rx_mgmt_assoc_resp
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_STYPE_REASSOC_RESP
case|:
name|ieee80211_rx_mgmt_assoc_resp
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_STYPE_DEAUTH
case|:
name|ieee80211_rx_mgmt_deauth
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_STYPE_DISASSOC
case|:
name|ieee80211_rx_mgmt_disassoc
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_STYPE_ACTION
case|:
name|ieee80211_rx_mgmt_action
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: received unknown management "
literal|"frame - stype=%d"
argument_list|,
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_sta_rx_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|u16
name|fc
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|24
condition|)
return|return;
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|frame_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
condition|)
block|{
if|if
condition|(
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_PROBE_RESP
condition|)
block|{
name|ieee80211_rx_mgmt_probe_resp
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_BEACON
condition|)
block|{
name|ieee80211_rx_mgmt_beacon
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ieee80211_sta_active_ibss
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|active
init|=
literal|0
decl_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|list_for_each(ptr,&local->sta_list) { 		sta = list_entry(ptr, struct sta_info, list); 		if (sta->dev == dev&& 		    time_after(sta->last_rx + IEEE80211_IBSS_MERGE_INTERVAL, 			       jiffies)) { 			active++; 			break; 		} 	}
endif|#
directive|endif
return|return
name|active
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_sta_expire
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|#
directive|if
literal|0
comment|/* FIX */
block|list_for_each_safe(ptr, n,&local->sta_list) { 		sta = list_entry(ptr, struct sta_info, list); 		if (time_after(jiffies, sta->last_rx + 			       IEEE80211_IBSS_INACTIVITY_LIMIT)) { 			wpa_printf(MSG_DEBUG, "MLME: expiring inactive STA " 				   MACSTR, MAC2STR(sta->addr)); 			sta_info_free(local, sta, 1); 		} 	}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_sta_merge_ibss
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|ieee80211_reschedule_timer
argument_list|(
name|wpa_s
argument_list|,
name|IEEE80211_IBSS_MERGE_INTERVAL
argument_list|)
expr_stmt|;
name|ieee80211_sta_expire
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ieee80211_sta_active_ibss
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: No active IBSS STAs - trying to scan for "
literal|"other IBSS networks with same SSID (merge)"
argument_list|)
expr_stmt|;
name|ieee80211_sta_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_sta_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
switch|switch
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|state
condition|)
block|{
case|case
name|IEEE80211_DISABLED
case|:
break|break;
case|case
name|IEEE80211_AUTHENTICATE
case|:
name|ieee80211_authenticate
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_ASSOCIATE
case|:
name|ieee80211_associate
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_ASSOCIATED
case|:
name|ieee80211_associated
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_IBSS_SEARCH
case|:
name|ieee80211_sta_find_ibss
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_IBSS_JOINED
case|:
name|ieee80211_sta_merge_ibss
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ieee80211_sta_timer: Unknown state %d"
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ieee80211_privacy_mismatch
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: privacy configuration mismatch "
literal|"and mixed-cell disabled - disassociate"
argument_list|)
expr_stmt|;
name|ieee80211_send_disassoc
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_UNSPECIFIED
argument_list|)
expr_stmt|;
name|ieee80211_set_associated
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_sta_new_auth
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|!=
literal|0
condition|)
return|return;
if|#
directive|if
literal|0
comment|/* FIX */
block|if (local->hw->reset_tsf) {
comment|/* Reset own TSF to allow time synchronization work. */
block|local->hw->reset_tsf(local->mdev); 	}
endif|#
directive|endif
name|wpa_s
operator|->
name|mlme
operator|.
name|wmm_last_param_set
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* allow any WMM update */
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_algs
operator|&
name|IEEE80211_AUTH_ALG_OPEN
condition|)
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|=
name|WLAN_AUTH_OPEN
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_algs
operator|&
name|IEEE80211_AUTH_ALG_SHARED_KEY
condition|)
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|=
name|WLAN_AUTH_SHARED_KEY
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_algs
operator|&
name|IEEE80211_AUTH_ALG_LEAP
condition|)
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|=
name|WLAN_AUTH_LEAP
expr_stmt|;
else|else
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
operator|=
name|WLAN_AUTH_OPEN
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Initial auth_alg=%d"
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_alg
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_transaction
operator|=
operator|-
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|auth_tries
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|assoc_tries
operator|=
literal|0
expr_stmt|;
name|ieee80211_authenticate
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ieee80211_ibss_allowed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|#
directive|if
literal|0
comment|/* FIX */
block|int m, c;  	for (m = 0; m< local->hw->num_modes; m++) { 		struct ieee80211_hw_modes *mode =&local->hw->modes[m]; 		if (mode->mode != local->conf.phymode) 			continue; 		for (c = 0; c< mode->num_channels; c++) { 			struct ieee80211_channel *chan =&mode->channels[c]; 			if (chan->flag& IEEE80211_CHAN_W_SCAN&& 			    chan->chan == local->conf.channel) { 				if (chan->flag& IEEE80211_CHAN_W_IBSS) 					return 1; 				break; 			} 		} 	}
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ieee80211_sta_join_ibss
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
parameter_list|)
block|{
name|int
name|res
init|=
literal|0
decl_stmt|,
name|rates
decl_stmt|,
name|done
init|=
literal|0
decl_stmt|;
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|struct ieee80211_tx_control control; 	struct ieee80211_rate *rate; 	struct rate_control_extra extra;
endif|#
directive|endif
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
comment|/* Remove possible STA entries from other IBSS networks. */
if|#
directive|if
literal|0
comment|/* FIX */
block|sta_info_flush(local, NULL);  	if (local->hw->reset_tsf) {
comment|/* Reset own TSF to allow time synchronization work. */
block|local->hw->reset_tsf(local->mdev); 	}
endif|#
directive|endif
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|local->conf.beacon_int = bss->beacon_int>= 10 ? bss->beacon_int : 10;  	sdata->drop_unencrypted = bss->capability& 		host_to_le16(WLAN_CAPABILITY_PRIVACY) ? 1 : 0;
endif|#
directive|endif
if|#
directive|if
literal|0
comment|/* FIX */
block|os_memset(&rq, 0, sizeof(rq)); 	rq.m = bss->freq * 100000; 	rq.e = 1; 	res = ieee80211_ioctl_siwfreq(wpa_s, NULL,&rq, NULL);
endif|#
directive|endif
if|if
condition|(
operator|!
name|ieee80211_ibss_allowed
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
if|#
directive|if
literal|0
comment|/* FIX */
block|wpa_printf(MSG_DEBUG, "MLME: IBSS not allowed on channel %d " 			   "(%d MHz)", local->conf.channel, 			   local->conf.freq);
endif|#
directive|endif
return|return
operator|-
literal|1
return|;
block|}
comment|/* Set beacon template based on scan results */
name|buf
operator|=
name|os_malloc
argument_list|(
literal|400
argument_list|)
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
do|do
block|{
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
break|break;
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|+=
literal|24
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|beacon
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|mgmt
argument_list|,
literal|0
argument_list|,
literal|24
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|beacon
argument_list|)
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_BEACON
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|mgmt->u.beacon.beacon_int = 			host_to_le16(local->conf.beacon_int);
endif|#
directive|endif
name|mgmt
operator|->
name|u
operator|.
name|beacon
operator|.
name|capab_info
operator|=
name|host_to_le16
argument_list|(
name|bss
operator|->
name|capability
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
name|len
expr_stmt|;
name|len
operator|+=
literal|2
operator|+
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_SSID
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|rates
operator|=
name|bss
operator|->
name|supp_rates_len
expr_stmt|;
if|if
condition|(
name|rates
operator|>
literal|8
condition|)
name|rates
operator|=
literal|8
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
name|len
expr_stmt|;
name|len
operator|+=
literal|2
operator|+
name|rates
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_SUPP_RATES
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|rates
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|bss
operator|->
name|supp_rates
argument_list|,
name|rates
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
name|len
expr_stmt|;
name|len
operator|+=
literal|2
operator|+
literal|1
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_DS_PARAMS
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|bss
operator|->
name|channel
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
name|len
expr_stmt|;
name|len
operator|+=
literal|2
operator|+
literal|2
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_IBSS_PARAMS
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|2
expr_stmt|;
comment|/* FIX: set ATIM window based on scan results */
operator|*
name|pos
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|supp_rates_len
operator|>
literal|8
condition|)
block|{
name|rates
operator|=
name|bss
operator|->
name|supp_rates_len
operator|-
literal|8
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
name|len
expr_stmt|;
name|len
operator|+=
literal|2
operator|+
name|rates
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_EXT_SUPP_RATES
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|rates
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|bss
operator|->
name|supp_rates
index|[
literal|8
index|]
argument_list|,
name|rates
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
comment|/* FIX */
block|os_memset(&control, 0, sizeof(control)); 		control.pkt_type = PKT_PROBE_RESP; 		os_memset(&extra, 0, sizeof(extra)); 		extra.endidx = local->num_curr_rates; 		rate = rate_control_get_rate(wpa_s, skb,&extra); 		if (rate == NULL) { 			wpa_printf(MSG_DEBUG, "MLME: Failed to determine TX " 				   "rate for IBSS beacon"); 			break; 		} 		control.tx_rate = (wpa_s->mlme.short_preamble&& 				   (rate->flags& IEEE80211_RATE_PREAMBLE2)) ? 			rate->val2 : rate->val; 		control.antenna_sel = local->conf.antenna_sel; 		control.power_level = local->conf.power_level; 		control.no_ack = 1; 		control.retry_limit = 1; 		control.rts_cts_duration = 0;
endif|#
directive|endif
if|#
directive|if
literal|0
comment|/* FIX */
block|wpa_s->mlme.probe_resp = skb_copy(skb, GFP_ATOMIC); 		if (wpa_s->mlme.probe_resp) { 			mgmt = (struct ieee80211_mgmt *) 				wpa_s->mlme.probe_resp->data; 			mgmt->frame_control = 				IEEE80211_FC(WLAN_FC_TYPE_MGMT, 					     WLAN_FC_STYPE_PROBE_RESP); 		} else { 			wpa_printf(MSG_DEBUG, "MLME: Could not allocate " 				   "ProbeResp template for IBSS"); 		}  		if (local->hw->beacon_update&& 		    local->hw->beacon_update(wpa_s, skb,&control) == 0) { 			wpa_printf(MSG_DEBUG, "MLME: Configured IBSS beacon " 				   "template based on scan results"); 			skb = NULL; 		}  		rates = 0; 		for (i = 0; i< bss->supp_rates_len; i++) { 			int rate = (bss->supp_rates[i]& 0x7f) * 5; 			if (local->conf.phymode == MODE_ATHEROS_TURBO) 				rate *= 2; 			for (j = 0; j< local->num_curr_rates; j++) 				if (local->curr_rates[j].rate == rate) 					rates |= BIT(j); 		} 		wpa_s->mlme.supp_rates_bits = rates;
endif|#
directive|endif
name|done
operator|=
literal|1
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|done
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Failed to configure IBSS beacon "
literal|"template"
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|=
name|IEEE80211_IBSS_JOINED
expr_stmt|;
name|ieee80211_reschedule_timer
argument_list|(
name|wpa_s
argument_list|,
name|IEEE80211_IBSS_MERGE_INTERVAL
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* FIX */
end_comment

begin_if
unit|static int ieee80211_sta_create_ibss(struct wpa_supplicant *wpa_s) { 	struct ieee80211_sta_bss *bss; 	u8 bssid[ETH_ALEN], *pos; 	int i;
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* Easier testing, use fixed BSSID. */
end_comment

begin_else
unit|os_memset(bssid, 0xfe, ETH_ALEN);
else|#
directive|else
end_else

begin_comment
comment|/* Generate random, not broadcast, locally administered BSSID. Mix in 	 * own MAC address to make sure that devices that do not have proper 	 * random number generator get different BSSID. */
end_comment

begin_endif
unit|os_get_random(bssid, ETH_ALEN); 	for (i = 0; i< ETH_ALEN; i++) 		bssid[i] ^= wpa_s->own_addr[i]; 	bssid[0]&= ~0x01; 	bssid[0] |= 0x02;
endif|#
directive|endif
end_endif

begin_if
unit|wpa_printf(MSG_DEBUG, "MLME: Creating new IBSS network, BSSID " 		   MACSTR "", MAC2STR(bssid));  	bss = ieee80211_bss_add(wpa_s, bssid); 	if (bss == NULL) 		return -ENOMEM;
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* FIX */
end_comment

begin_endif
unit|if (local->conf.beacon_int == 0) 		local->conf.beacon_int = 100; 	bss->beacon_int = local->conf.beacon_int; 	bss->hw_mode = local->conf.phymode; 	bss->channel = local->conf.channel; 	bss->freq = local->conf.freq;
endif|#
directive|endif
end_endif

begin_if
unit|os_get_time(&bss->last_update); 	bss->capability = host_to_le16(WLAN_CAPABILITY_IBSS);
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* FIX */
end_comment

begin_endif
unit|if (sdata->default_key) { 		bss->capability |= host_to_le16(WLAN_CAPABILITY_PRIVACY); 	} else 		sdata->drop_unencrypted = 0; 	bss->supp_rates_len = local->num_curr_rates;
endif|#
directive|endif
end_endif

begin_if
unit|pos = bss->supp_rates;
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* FIX */
end_comment

begin_endif
unit|for (i = 0; i< local->num_curr_rates; i++) { 		int rate = local->curr_rates[i].rate; 		if (local->conf.phymode == MODE_ATHEROS_TURBO) 			rate /= 2; 		*pos++ = (u8) (rate / 5); 	}
endif|#
directive|endif
end_endif

begin_endif
unit|return ieee80211_sta_join_ibss(wpa_s, bss); }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|ieee80211_sta_find_ibss
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|active_ibss
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
operator|==
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|active_ibss
operator|=
name|ieee80211_sta_active_ibss
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE80211_IBSS_DEBUG
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: sta_find_ibss (active_ibss=%d)"
argument_list|,
name|active_ibss
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE80211_IBSS_DEBUG */
for|for
control|(
name|bss
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_list
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
operator|!=
name|bss
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
operator|||
operator|!
operator|(
name|bss
operator|->
name|capability
operator|&
name|WLAN_CAPABILITY_IBSS
operator|)
condition|)
continue|continue;
ifdef|#
directive|ifdef
name|IEEE80211_IBSS_DEBUG
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   bssid="
name|MACSTR
literal|" found"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE80211_IBSS_DEBUG */
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|active_ibss
operator|||
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
break|break;
block|}
ifdef|#
directive|ifdef
name|IEEE80211_IBSS_DEBUG
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   sta_find_ibss: selected "
name|MACSTR
literal|" current "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE80211_IBSS_DEBUG */
if|if
condition|(
name|found
operator|&&
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
operator|(
name|bss
operator|=
name|ieee80211_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Selected IBSS BSSID "
name|MACSTR
literal|" based on configured SSID"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ieee80211_sta_join_ibss
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
return|;
block|}
ifdef|#
directive|ifdef
name|IEEE80211_IBSS_DEBUG
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   did not try to join ibss"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE80211_IBSS_DEBUG */
comment|/* Selected IBSS not found in current scan results - try to scan */
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|if (wpa_s->mlme.state == IEEE80211_IBSS_JOINED&& 	    !ieee80211_sta_active_ibss(wpa_s)) { 		ieee80211_reschedule_timer(wpa_s, 					   IEEE80211_IBSS_MERGE_INTERVAL); 	} else if (time_after(jiffies, wpa_s->mlme.last_scan_completed + 			      IEEE80211_SCAN_INTERVAL)) { 		wpa_printf(MSG_DEBUG, "MLME: Trigger new scan to find an IBSS " 			   "to join"); 		return ieee80211_sta_req_scan(wpa_s->mlme.ssid, 					      wpa_s->mlme.ssid_len); 	} else if (wpa_s->mlme.state != IEEE80211_IBSS_JOINED) { 		int interval = IEEE80211_SCAN_INTERVAL;  		if (time_after(jiffies, wpa_s->mlme.ibss_join_req + 			       IEEE80211_IBSS_JOIN_TIMEOUT)) { 			if (wpa_s->mlme.create_ibss&& 			    ieee80211_ibss_allowed(wpa_s)) 				return ieee80211_sta_create_ibss(wpa_s); 			if (wpa_s->mlme.create_ibss) { 				wpa_printf(MSG_DEBUG, "MLME: IBSS not allowed " 					   "on the configured channel %d " 					   "(%d MHz)", 					   local->conf.channel, 					   local->conf.freq); 			}
comment|/* No IBSS found - decrease scan interval and continue 			 * scanning. */
block|interval = IEEE80211_SCAN_INTERVAL_SLOW; 		}  		wpa_s->mlme.state = IEEE80211_IBSS_SEARCH; 		ieee80211_reschedule_timer(wpa_s, interval); 		return 0; 	}
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ieee80211_sta_get_ssid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|os_memcpy
argument_list|(
name|ssid
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ieee80211_sta_associate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
decl_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|bssid_set
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|freq
operator|=
name|params
operator|->
name|freq
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|bssid
condition|)
block|{
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|params
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|params
operator|->
name|bssid
argument_list|)
condition|)
name|wpa_s
operator|->
name|mlme
operator|.
name|bssid_set
operator|=
literal|1
expr_stmt|;
name|bss
operator|=
name|ieee80211_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
operator|=
name|bss
operator|->
name|hw_mode
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|channel
operator|=
name|bss
operator|->
name|channel
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
block|}
block|}
if|#
directive|if
literal|0
comment|/* FIX */
comment|/* TODO: This should always be done for IBSS, even if IEEE80211_QOS is 	 * not defined. */
block|if (local->hw->conf_tx) { 		struct ieee80211_tx_queue_params qparam; 		int i;  		os_memset(&qparam, 0, sizeof(qparam));
comment|/* TODO: are these ok defaults for all hw_modes? */
block|qparam.aifs = 2; 		qparam.cw_min = 			local->conf.phymode == MODE_IEEE80211B ? 31 : 15; 		qparam.cw_max = 1023; 		qparam.burst_time = 0; 		for (i = IEEE80211_TX_QUEUE_DATA0; i< NUM_TX_DATA_QUEUES; i++) 		{ 			local->hw->conf_tx(wpa_s, i + IEEE80211_TX_QUEUE_DATA0,&qparam); 		}
comment|/* IBSS uses different parameters for Beacon sending */
block|qparam.cw_min++; 		qparam.cw_min *= 2; 		qparam.cw_min--; 		local->hw->conf_tx(wpa_s, IEEE80211_TX_QUEUE_BEACON,&qparam); 	}
endif|#
directive|endif
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
operator|!=
name|params
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
name|wpa_s
operator|->
name|mlme
operator|.
name|prev_bssid_set
operator|=
literal|0
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid
operator|+
name|params
operator|->
name|ssid_len
argument_list|,
literal|0
argument_list|,
name|MAX_SSID_LEN
operator|-
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|ssid_set
operator|=
literal|1
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_ie
operator|==
name|NULL
operator|||
name|params
operator|->
name|wpa_ie_len
operator|==
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie
operator|=
name|os_malloc
argument_list|(
name|params
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie
operator|==
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie_len
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie
argument_list|,
name|params
operator|->
name|wpa_ie
argument_list|,
name|params
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie_len
operator|=
name|params
operator|->
name|wpa_ie_len
expr_stmt|;
block|}
name|wpa_s
operator|->
name|mlme
operator|.
name|key_mgmt
operator|=
name|params
operator|->
name|key_mgmt_suite
expr_stmt|;
name|ieee80211_sta_set_channel
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|channel
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|mode
operator|==
literal|1
operator|&&
operator|!
name|wpa_s
operator|->
name|mlme
operator|.
name|bssid_set
condition|)
block|{
name|os_get_time
argument_list|(
operator|&
name|wpa_s
operator|->
name|mlme
operator|.
name|ibss_join_req
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|=
name|IEEE80211_IBSS_SEARCH
expr_stmt|;
return|return
name|ieee80211_sta_find_ibss
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|bssid_set
condition|)
name|ieee80211_sta_new_auth
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_sta_save_oper_chan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_oper_channel
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|channel
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_oper_freq
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_oper_phymode
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ieee80211_sta_restore_oper_chan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|channel
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_oper_channel
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|freq
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_oper_freq
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_oper_phymode
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|freq
operator|==
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|ieee80211_sta_set_channel
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|channel
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|freq
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ieee80211_active_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|size_t
name|m
decl_stmt|;
name|int
name|c
decl_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|wpa_s
operator|->
name|mlme
operator|.
name|num_modes
condition|;
name|m
operator|++
control|)
block|{
name|struct
name|wpa_hw_modes
modifier|*
name|mode
init|=
operator|&
name|wpa_s
operator|->
name|mlme
operator|.
name|modes
index|[
name|m
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|mode
operator|->
name|mode
operator|!=
operator|(
name|int
operator|)
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
condition|)
continue|continue;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|mode
operator|->
name|num_channels
condition|;
name|c
operator|++
control|)
block|{
name|struct
name|wpa_channel_data
modifier|*
name|chan
init|=
operator|&
name|mode
operator|->
name|channels
index|[
name|c
index|]
decl_stmt|;
if|if
condition|(
name|chan
operator|->
name|flag
operator|&
name|WPA_CHAN_W_SCAN
operator|&&
name|chan
operator|->
name|chan
operator|==
name|wpa_s
operator|->
name|mlme
operator|.
name|channel
condition|)
block|{
if|if
condition|(
name|chan
operator|->
name|flag
operator|&
name|WPA_CHAN_W_ACTIVE_SCAN
condition|)
return|return
literal|1
return|;
break|break;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_sta_scan_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_hw_modes
modifier|*
name|mode
decl_stmt|;
name|struct
name|wpa_channel_data
modifier|*
name|chan
decl_stmt|;
name|int
name|skip
init|=
literal|0
decl_stmt|;
name|int
name|timeout
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|int
name|adhoc
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_scanning
operator|||
name|wpa_s
operator|->
name|mlme
operator|.
name|modes
operator|==
name|NULL
condition|)
return|return;
name|adhoc
operator|=
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
literal|1
expr_stmt|;
switch|switch
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_state
condition|)
block|{
case|case
name|SCAN_SET_CHANNEL
case|:
name|mode
operator|=
operator|&
name|wpa_s
operator|->
name|mlme
operator|.
name|modes
index|[
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_hw_mode_idx
index|]
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_hw_mode_idx
operator|>=
operator|(
name|int
operator|)
name|wpa_s
operator|->
name|mlme
operator|.
name|num_modes
operator|||
operator|(
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_hw_mode_idx
operator|+
literal|1
operator|==
operator|(
name|int
operator|)
name|wpa_s
operator|->
name|mlme
operator|.
name|num_modes
operator|&&
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_channel_idx
operator|>=
name|mode
operator|->
name|num_channels
operator|)
condition|)
block|{
if|if
condition|(
name|ieee80211_sta_restore_oper_chan
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to "
literal|"restore operational channel after "
literal|"scan"
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: scan completed"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_scanning
operator|=
literal|0
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|wpa_s
operator|->
name|mlme
operator|.
name|last_scan_completed
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|adhoc
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|mlme
operator|.
name|bssid_set
operator|||
operator|(
name|wpa_s
operator|->
name|mlme
operator|.
name|state
operator|==
name|IEEE80211_IBSS_JOINED
operator|&&
operator|!
name|ieee80211_sta_active_ibss
argument_list|(
name|wpa_s
argument_list|)
operator|)
condition|)
name|ieee80211_sta_find_ibss
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|skip
operator|=
operator|!
operator|(
name|wpa_s
operator|->
name|mlme
operator|.
name|hw_modes
operator|&
operator|(
literal|1
operator|<<
name|mode
operator|->
name|mode
operator|)
operator|)
expr_stmt|;
name|chan
operator|=
operator|&
name|mode
operator|->
name|channels
index|[
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_channel_idx
index|]
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|chan
operator|->
name|flag
operator|&
name|WPA_CHAN_W_SCAN
operator|)
operator|||
operator|(
name|adhoc
operator|&&
operator|!
operator|(
name|chan
operator|->
name|flag
operator|&
name|WPA_CHAN_W_IBSS
operator|)
operator|)
operator|||
operator|(
name|wpa_s
operator|->
name|mlme
operator|.
name|hw_modes
operator|&
operator|(
literal|1
operator|<<
name|WPA_MODE_IEEE80211G
operator|)
operator|&&
name|mode
operator|->
name|mode
operator|==
name|WPA_MODE_IEEE80211B
operator|&&
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_skip_11b
operator|)
condition|)
name|skip
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|skip
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"MLME: scan channel %d (%d MHz)"
argument_list|,
name|chan
operator|->
name|chan
argument_list|,
name|chan
operator|->
name|freq
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|channel
operator|=
name|chan
operator|->
name|chan
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|freq
operator|=
name|chan
operator|->
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|phymode
operator|=
name|mode
operator|->
name|mode
expr_stmt|;
if|if
condition|(
name|ieee80211_sta_set_channel
argument_list|(
name|wpa_s
argument_list|,
name|mode
operator|->
name|mode
argument_list|,
name|chan
operator|->
name|chan
argument_list|,
name|chan
operator|->
name|freq
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: failed to set "
literal|"channel %d (%d MHz) for scan"
argument_list|,
name|chan
operator|->
name|chan
argument_list|,
name|chan
operator|->
name|freq
argument_list|)
expr_stmt|;
name|skip
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_channel_idx
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_channel_idx
operator|>=
name|wpa_s
operator|->
name|mlme
operator|.
name|modes
index|[
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_hw_mode_idx
index|]
operator|.
name|num_channels
condition|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_hw_mode_idx
operator|++
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_channel_idx
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|skip
condition|)
block|{
name|timeout
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|timeout
operator|=
name|IEEE80211_PROBE_DELAY
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_state
operator|=
name|SCAN_SEND_PROBE
expr_stmt|;
break|break;
case|case
name|SCAN_SEND_PROBE
case|:
if|if
condition|(
name|ieee80211_active_scan
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|ieee80211_send_probe_req
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_ssid
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_ssid_len
argument_list|)
expr_stmt|;
name|timeout
operator|=
name|IEEE80211_CHANNEL_TIME
expr_stmt|;
block|}
else|else
block|{
name|timeout
operator|=
name|IEEE80211_PASSIVE_CHANNEL_TIME
expr_stmt|;
block|}
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_state
operator|=
name|SCAN_SET_CHANNEL
expr_stmt|;
break|break;
block|}
name|eloop_register_timeout
argument_list|(
name|timeout
operator|/
literal|1000
argument_list|,
literal|1000
operator|*
operator|(
name|timeout
operator|%
literal|1000
operator|)
argument_list|,
name|ieee80211_sta_scan_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ieee80211_sta_req_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
if|if
condition|(
name|ssid_len
operator|>
name|MAX_SSID_LEN
condition|)
return|return
operator|-
literal|1
return|;
comment|/* MLME-SCAN.request (page 118)  page 144 (11.1.3.1) 	 * BSSType: INFRASTRUCTURE, INDEPENDENT, ANY_BSS 	 * BSSID: MACAddress 	 * SSID 	 * ScanType: ACTIVE, PASSIVE 	 * ProbeDelay: delay (in microseconds) to be used prior to transmitting 	 *    a Probe frame during active scanning 	 * ChannelList 	 * MinChannelTime (>= ProbeDelay), in TU 	 * MaxChannelTime: (>= MinChannelTime), in TU 	 */
comment|/* MLME-SCAN.confirm 	  * BSSDescriptionSet 	  * ResultCode: SUCCESS, INVALID_PARAMETERS 	 */
comment|/* TODO: if assoc, move to power save mode for the duration of the 	 * scan */
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_scanning
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: starting scan"
argument_list|)
expr_stmt|;
name|ieee80211_sta_save_oper_chan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_scanning
operator|=
literal|1
expr_stmt|;
comment|/* TODO: stop TX queue? */
if|if
condition|(
name|ssid
condition|)
block|{
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_ssid_len
operator|=
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_ssid_len
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_skip_11b
operator|=
literal|1
expr_stmt|;
comment|/* FIX: clear this is 11g is not 					* supported */
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_state
operator|=
name|SCAN_SET_CHANNEL
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_hw_mode_idx
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|scan_channel_idx
operator|=
literal|0
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
name|ieee80211_sta_scan_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|wpa_scan_results
modifier|*
name|ieee80211_sta_get_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|size_t
name|ap_num
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_scan_results
modifier|*
name|res
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|r
decl_stmt|;
name|struct
name|ieee80211_sta_bss
modifier|*
name|bss
decl_stmt|;
name|res
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|res
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|bss
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_list
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
name|ap_num
operator|++
expr_stmt|;
name|res
operator|->
name|res
operator|=
name|os_zalloc
argument_list|(
name|ap_num
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_res
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|res
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|bss
operator|=
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_bss_list
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
name|r
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
operator|+
name|bss
operator|->
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|r
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|r
operator|->
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|r
operator|->
name|beacon_int
operator|=
name|bss
operator|->
name|beacon_int
expr_stmt|;
name|r
operator|->
name|caps
operator|=
name|bss
operator|->
name|capability
expr_stmt|;
name|r
operator|->
name|level
operator|=
name|bss
operator|->
name|rssi
expr_stmt|;
name|r
operator|->
name|tsf
operator|=
name|bss
operator|->
name|timestamp
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|ie
condition|)
block|{
name|r
operator|->
name|ie_len
operator|=
name|bss
operator|->
name|ie_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|r
operator|+
literal|1
argument_list|,
name|bss
operator|->
name|ie
argument_list|,
name|bss
operator|->
name|ie_len
argument_list|)
expr_stmt|;
block|}
name|res
operator|->
name|res
index|[
name|res
operator|->
name|num
operator|++
index|]
operator|=
name|r
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* FIX */
end_comment

begin_comment
unit|struct sta_info * ieee80211_ibss_add_sta(struct wpa_supplicant *wpa_s, 					 struct sk_buff *skb, u8 *bssid, 					 u8 *addr) { 	struct ieee80211_local *local = dev->priv; 	struct list_head *ptr; 	struct sta_info *sta; 	struct wpa_supplicant *sta_dev = NULL;
comment|/* TODO: Could consider removing the least recently used entry and 	 * allow new one to be added. */
end_comment

begin_comment
unit|if (local->num_sta>= IEEE80211_IBSS_MAX_STA_ENTRIES) { 		if (net_ratelimit()) { 			wpa_printf(MSG_DEBUG, "MLME: No room for a new IBSS " 				   "STA entry " MACSTR, MAC2STR(addr)); 		} 		return NULL; 	}  	spin_lock_bh(&local->sub_if_lock); 	list_for_each(ptr,&local->sub_if_list) { 		sdata = list_entry(ptr, struct ieee80211_sub_if_data, list); 		if (sdata->type == IEEE80211_SUB_IF_TYPE_STA&& 		    os_memcmp(bssid, sdata->u.sta.bssid, ETH_ALEN) == 0) { 			sta_dev = sdata->dev; 			break; 		} 	} 	spin_unlock_bh(&local->sub_if_lock);  	if (sta_dev == NULL) 		return NULL;  	wpa_printf(MSG_DEBUG, "MLME: Adding new IBSS station " MACSTR 		   " (dev=%s)", MAC2STR(addr), sta_dev->name);  	sta = sta_info_add(wpa_s, addr); 	if (sta == NULL) { 		return NULL; 	}  	sta->dev = sta_dev; 	sta->supp_rates = wpa_s->mlme.supp_rates_bits;  	rate_control_rate_init(local, sta);  	return sta;
comment|/* caller will call sta_info_release() */
end_comment

begin_endif
unit|}
endif|#
directive|endif
end_endif

begin_function
name|int
name|ieee80211_sta_deauthenticate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u16
name|reason
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: deauthenticate(reason=%d)"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|ieee80211_send_deauth
argument_list|(
name|wpa_s
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|ieee80211_set_associated
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ieee80211_sta_disassociate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u16
name|reason
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: disassociate(reason=%d)"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|mlme
operator|.
name|associated
condition|)
return|return
operator|-
literal|1
return|;
name|ieee80211_send_disassoc
argument_list|(
name|wpa_s
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|ieee80211_set_associated
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ieee80211_sta_rx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ieee80211_rx_status
modifier|*
name|rx_status
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|u16
name|fc
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
comment|/* wpa_hexdump(MSG_MSGDUMP, "MLME: Received frame", buf, len); */
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|sta_scanning
condition|)
block|{
name|ieee80211_sta_rx_scan
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|<
literal|24
condition|)
return|return;
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|frame_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
condition|)
name|ieee80211_sta_rx_mgmt
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_DATA
condition|)
block|{
if|if
condition|(
operator|(
name|fc
operator|&
operator|(
name|WLAN_FC_TODS
operator||
name|WLAN_FC_FROMDS
operator|)
operator|)
operator|!=
name|WLAN_FC_FROMDS
condition|)
return|return;
comment|/* mgmt->sa is actually BSSID for FromDS data frames */
if|if
condition|(
name|os_memcmp
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
return|return;
comment|/* Skip IEEE 802.11 and LLC headers */
name|pos
operator|=
name|buf
operator|+
literal|24
operator|+
literal|6
expr_stmt|;
if|if
condition|(
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
operator|!=
name|ETH_P_EAPOL
condition|)
return|return;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* mgmt->bssid is actually BSSID for SA data frames */
name|wpa_supplicant_rx_eapol
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
operator|->
name|bssid
argument_list|,
name|pos
argument_list|,
name|buf
operator|+
name|len
operator|-
name|pos
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ieee80211_sta_free_hw_features
parameter_list|(
name|struct
name|wpa_hw_modes
modifier|*
name|hw_features
parameter_list|,
name|size_t
name|num_hw_features
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|hw_features
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_hw_features
condition|;
name|i
operator|++
control|)
block|{
name|os_free
argument_list|(
name|hw_features
index|[
name|i
index|]
operator|.
name|channels
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hw_features
index|[
name|i
index|]
operator|.
name|rates
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|hw_features
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ieee80211_sta_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|u16
name|num_modes
decl_stmt|,
name|flags
decl_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|modes
operator|=
name|wpa_drv_get_hw_feature_data
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|num_modes
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|modes
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"MLME: Failed to read supported "
literal|"channels and rates from the driver"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|mlme
operator|.
name|num_modes
operator|=
name|num_modes
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|hw_modes
operator|=
literal|1
operator|<<
name|WPA_MODE_IEEE80211A
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|hw_modes
operator||=
literal|1
operator|<<
name|WPA_MODE_IEEE80211B
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|hw_modes
operator||=
literal|1
operator|<<
name|WPA_MODE_IEEE80211G
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ieee80211_sta_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|ieee80211_sta_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|ieee80211_sta_scan_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_ie
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|assocreq_ies
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|assocresp_ies
operator|=
name|NULL
expr_stmt|;
name|ieee80211_bss_list_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ieee80211_sta_free_hw_features
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|modes
argument_list|,
name|wpa_s
operator|->
name|mlme
operator|.
name|num_modes
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies_len
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
end_ifdef

begin_function
name|int
name|ieee80211_sta_update_ft_ies
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|md
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
block|{
if|if
condition|(
name|md
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Clear FT mobility domain"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|current_md
argument_list|,
literal|0
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Update FT IEs for MD "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|md
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|current_md
argument_list|,
name|md
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: FT IEs"
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
operator|=
name|os_malloc
argument_list|(
name|ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|ft_ies_len
operator|=
name|ies_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ieee80211_sta_send_ft_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|action
parameter_list|,
specifier|const
name|u8
modifier|*
name|target_ap
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|int
name|res
decl_stmt|;
comment|/* 	 * Action frame payload: 	 * Category[1] = 6 (Fast BSS Transition) 	 * Action[1] = 1 (Fast BSS Transition Request) 	 * STA Address 	 * Target AP Address 	 * FT IEs 	 */
name|buf
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mgmt
argument_list|)
operator|+
name|ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Failed to allocate buffer for "
literal|"FT action frame"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|len
operator|=
literal|24
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ACTION
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|=
name|WLAN_ACTION_FT
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_req
operator|.
name|action
operator|=
name|action
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_req
operator|.
name|sta_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_req
operator|.
name|target_ap_addr
argument_list|,
name|target_ap
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_req
operator|.
name|variable
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
name|len
operator|+=
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|ft_action_req
argument_list|)
operator|+
name|ies_len
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Send FT Action Frame: Action=%d "
literal|"Target AP="
name|MACSTR
literal|" body_len=%lu"
argument_list|,
name|action
argument_list|,
name|MAC2STR
argument_list|(
name|target_ap
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ies_len
argument_list|)
expr_stmt|;
name|res
operator|=
name|ieee80211_sta_tx
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211R */
end_comment

begin_function
name|int
name|ieee80211_sta_set_probe_req_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie
operator|=
name|os_malloc
argument_list|(
name|ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mlme
operator|.
name|extra_probe_ie_len
operator|=
name|ies_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


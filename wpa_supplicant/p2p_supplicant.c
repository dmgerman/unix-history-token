begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant - P2P  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_i.h"
end_include

begin_include
include|#
directive|include
file|"p2p/p2p.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ap/p2p_hostapd.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"ap.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"offchannel.h"
end_include

begin_include
include|#
directive|include
file|"wps_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"p2p_supplicant.h"
end_include

begin_comment
comment|/*  * How many times to try to scan to find the GO before giving up on join  * request.  */
end_comment

begin_define
define|#
directive|define
name|P2P_MAX_JOIN_SCAN_ATTEMPTS
value|10
end_define

begin_define
define|#
directive|define
name|P2P_AUTO_PD_SCAN_ATTEMPTS
value|5
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|P2P_MAX_CLIENT_IDLE
end_ifndef

begin_comment
comment|/*  * How many seconds to try to reconnect to the GO when connection in P2P client  * role has been lost.  */
end_comment

begin_define
define|#
directive|define
name|P2P_MAX_CLIENT_IDLE
value|10
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* P2P_MAX_CLIENT_IDLE */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|P2P_MAX_INITIAL_CONN_WAIT
end_ifndef

begin_comment
comment|/*  * How many seconds to wait for initial 4-way handshake to get completed after  * WPS provisioning step.  */
end_comment

begin_define
define|#
directive|define
name|P2P_MAX_INITIAL_CONN_WAIT
value|10
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* P2P_MAX_INITIAL_CONN_WAIT */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|P2P_CONCURRENT_SEARCH_DELAY
end_ifndef

begin_define
define|#
directive|define
name|P2P_CONCURRENT_SEARCH_DELAY
value|500
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* P2P_CONCURRENT_SEARCH_DELAY */
end_comment

begin_enum
enum|enum
name|p2p_group_removal_reason
block|{
name|P2P_GROUP_REMOVAL_UNKNOWN
block|,
name|P2P_GROUP_REMOVAL_SILENT
block|,
name|P2P_GROUP_REMOVAL_FORMATION_FAILED
block|,
name|P2P_GROUP_REMOVAL_REQUESTED
block|,
name|P2P_GROUP_REMOVAL_IDLE_TIMEOUT
block|,
name|P2P_GROUP_REMOVAL_UNAVAILABLE
block|,
name|P2P_GROUP_REMOVAL_GO_ENDING_SESSION
block|}
enum|;
end_enum

begin_function_decl
specifier|static
name|void
name|wpas_p2p_long_listen_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpas_p2p_get_group_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|addr_allocated
parameter_list|,
name|int
name|go
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpas_p2p_join_start
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_join_scan_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_join_scan
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpas_p2p_join
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|iface_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|,
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|,
name|int
name|auto_join
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpas_p2p_create_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_cross_connect_setup
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_group_idle_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_set_group_idle_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_fallback_to_go_neg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|group_added
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpas_p2p_stop_find_oper
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|wpas_p2p_scan_res_handler
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Scan results received (%d BSS)"
argument_list|,
operator|(
name|int
operator|)
name|scan_res
operator|->
name|num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scan_res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|bss
init|=
name|scan_res
operator|->
name|res
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|p2p_scan_res_handler
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|freq
argument_list|,
name|bss
operator|->
name|age
argument_list|,
name|bss
operator|->
name|level
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
argument_list|,
name|bss
operator|->
name|ie_len
argument_list|)
operator|>
literal|0
condition|)
break|break;
block|}
name|p2p_scan_res_handled
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_scan
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|p2p_scan_type
name|type
parameter_list|,
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|num_req_dev_types
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_dev_types
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_id
parameter_list|,
name|u16
name|pw_id
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|ifs
decl_stmt|;
name|struct
name|wpa_driver_scan_params
name|params
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|,
modifier|*
name|ies
decl_stmt|;
name|int
name|social_channels
index|[]
init|=
block|{
literal|2412
block|,
literal|2437
block|,
literal|2462
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|size_t
name|ielen
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|ifs
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|ifs
condition|;
name|ifs
operator|=
name|ifs
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ifs
operator|->
name|sta_scan_pending
operator|&&
name|wpas_p2p_in_progress
argument_list|(
name|wpa_s
argument_list|)
operator|==
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Delaying P2P scan to allow "
literal|"pending station mode scan to be "
literal|"completed on interface %s"
argument_list|,
name|ifs
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|ifs
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
comment|/* P2P Wildcard SSID */
name|params
operator|.
name|num_ssids
operator|=
literal|1
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
operator|=
operator|(
name|u8
operator|*
operator|)
name|P2P_WILDCARD_SSID
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
operator|=
name|P2P_WILDCARD_SSID_LEN
expr_stmt|;
name|wpa_s
operator|->
name|wps
operator|->
name|dev
operator|.
name|p2p
operator|=
literal|1
expr_stmt|;
name|wps_ie
operator|=
name|wps_build_probe_req_ie
argument_list|(
name|pw_id
argument_list|,
operator|&
name|wpa_s
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|wpa_s
operator|->
name|wps
operator|->
name|uuid
argument_list|,
name|WPS_REQ_ENROLLEE
argument_list|,
name|num_req_dev_types
argument_list|,
name|req_dev_types
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ielen
operator|=
name|p2p_scan_ie_buf_len
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|ies
operator|=
name|wpabuf_alloc
argument_list|(
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
operator|+
name|ielen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_put_buf
argument_list|(
name|ies
argument_list|,
name|wps_ie
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|p2p_scan_ie
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|ies
argument_list|,
name|dev_id
argument_list|)
expr_stmt|;
name|params
operator|.
name|p2p_probe
operator|=
literal|1
expr_stmt|;
name|params
operator|.
name|extra_ies
operator|=
name|wpabuf_head
argument_list|(
name|ies
argument_list|)
expr_stmt|;
name|params
operator|.
name|extra_ies_len
operator|=
name|wpabuf_len
argument_list|(
name|ies
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|P2P_SCAN_SOCIAL
case|:
name|params
operator|.
name|freqs
operator|=
name|social_channels
expr_stmt|;
break|break;
case|case
name|P2P_SCAN_FULL
case|:
break|break;
case|case
name|P2P_SCAN_SOCIAL_PLUS_ONE
case|:
name|social_channels
index|[
literal|3
index|]
operator|=
name|freq
expr_stmt|;
name|params
operator|.
name|freqs
operator|=
name|social_channels
expr_stmt|;
break|break;
block|}
name|ret
operator|=
name|wpa_drv_scan
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ies
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
for|for
control|(
name|ifs
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|ifs
condition|;
name|ifs
operator|=
name|ifs
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ifs
operator|->
name|scanning
operator|||
name|ifs
operator|->
name|scan_res_handler
operator|==
name|wpas_p2p_scan_res_handler
condition|)
block|{
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
name|wpa_s
operator|->
name|scan_res_handler
operator|=
name|wpas_p2p_scan_res_handler
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wpa_driver_if_type
name|wpas_p2p_if_type
parameter_list|(
name|int
name|p2p_group_interface
parameter_list|)
block|{
switch|switch
condition|(
name|p2p_group_interface
condition|)
block|{
case|case
name|P2P_GROUP_INTERFACE_PENDING
case|:
return|return
name|WPA_IF_P2P_GROUP
return|;
case|case
name|P2P_GROUP_INTERFACE_GO
case|:
return|return
name|WPA_IF_P2P_GO
return|;
case|case
name|P2P_GROUP_INTERFACE_CLIENT
case|:
return|return
name|WPA_IF_P2P_CLIENT
return|;
block|}
return|return
name|WPA_IF_P2P_GROUP
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpas_get_p2p_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
name|int
modifier|*
name|go
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|!=
literal|0
operator|||
operator|!
name|s
operator|->
name|p2p_group
operator|||
name|s
operator|->
name|ssid_len
operator|!=
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
name|s
operator|!=
name|wpa_s
operator|->
name|current_ssid
condition|)
continue|continue;
if|if
condition|(
name|go
condition|)
operator|*
name|go
operator|=
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
expr_stmt|;
return|return
name|wpa_s
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_group_delete
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|enum
name|p2p_group_removal_reason
name|removal_reason
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|char
modifier|*
name|gtype
decl_stmt|;
specifier|const
name|char
modifier|*
name|reason
decl_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * The current SSID was not known, but there may still be a 		 * pending P2P group interface waiting for provisioning or a 		 * P2P group that is trying to reconnect. 		 */
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
while|while
condition|(
name|ssid
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|p2p_group
operator|&&
name|ssid
operator|->
name|disabled
operator|!=
literal|2
condition|)
break|break;
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|&&
name|wpa_s
operator|->
name|p2p_group_interface
operator|==
name|NOT_P2P_GROUP_INTERFACE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: P2P group interface "
literal|"not found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_group_interface
operator|==
name|P2P_GROUP_INTERFACE_GO
condition|)
name|gtype
operator|=
literal|"GO"
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|p2p_group_interface
operator|==
name|P2P_GROUP_INTERFACE_CLIENT
operator|||
operator|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|reassociate
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|disconnected
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|gtype
operator|=
literal|"client"
expr_stmt|;
block|}
else|else
name|gtype
operator|=
literal|"GO"
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|cross_connect_in_use
condition|)
block|{
name|wpa_s
operator|->
name|cross_connect_in_use
operator|=
literal|0
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_CROSS_CONNECT_DISABLE
literal|"%s %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|removal_reason
condition|)
block|{
case|case
name|P2P_GROUP_REMOVAL_REQUESTED
case|:
name|reason
operator|=
literal|" reason=REQUESTED"
expr_stmt|;
break|break;
case|case
name|P2P_GROUP_REMOVAL_FORMATION_FAILED
case|:
name|reason
operator|=
literal|" reason=FORMATION_FAILED"
expr_stmt|;
break|break;
case|case
name|P2P_GROUP_REMOVAL_IDLE_TIMEOUT
case|:
name|reason
operator|=
literal|" reason=IDLE"
expr_stmt|;
break|break;
case|case
name|P2P_GROUP_REMOVAL_UNAVAILABLE
case|:
name|reason
operator|=
literal|" reason=UNAVAILABLE"
expr_stmt|;
break|break;
case|case
name|P2P_GROUP_REMOVAL_GO_ENDING_SESSION
case|:
name|reason
operator|=
literal|" reason=GO_ENDING_SESSION"
expr_stmt|;
break|break;
default|default:
name|reason
operator|=
literal|""
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|removal_reason
operator|!=
name|P2P_GROUP_REMOVAL_SILENT
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_REMOVED
literal|"%s %s%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|gtype
argument_list|,
name|reason
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancelled P2P group idle timeout"
argument_list|)
expr_stmt|;
if|if
condition|(
name|removal_reason
operator|!=
name|P2P_GROUP_REMOVAL_SILENT
operator|&&
name|ssid
condition|)
name|wpas_notify_p2p_group_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|gtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_group_interface
operator|!=
name|NOT_P2P_GROUP_INTERFACE
condition|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
decl_stmt|;
name|char
modifier|*
name|ifname
decl_stmt|;
name|enum
name|wpa_driver_if_type
name|type
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove group interface %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|global
operator|=
name|wpa_s
operator|->
name|global
expr_stmt|;
name|ifname
operator|=
name|os_strdup
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|type
operator|=
name|wpas_p2p_if_type
argument_list|(
name|wpa_s
operator|->
name|p2p_group_interface
argument_list|)
expr_stmt|;
name|wpa_supplicant_remove_iface
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|&&
name|ifname
condition|)
name|wpa_drv_if_remove
argument_list|(
name|wpa_s
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove temporary group network"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
operator|(
name|ssid
operator|->
name|p2p_group
operator|||
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GROUP_FORMATION
operator|||
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
operator|)
condition|)
block|{
name|int
name|id
init|=
name|ssid
operator|->
name|id
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|wpa_sm_set_config
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* 		 * Networks objects created during any P2P activities are not 		 * exposed out as they might/will confuse certain non-P2P aware 		 * applications since these network objects won't behave like 		 * regular ones. 		 * 		 * Likewise, we don't send out network removed signals for such 		 * network objects. 		 */
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpa_supplicant_clear_status
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sta_scan_pending
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Temporary group network not "
literal|"found"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
name|wpa_supplicant_ap_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
else|else
name|wpa_drv_deinit_p2p_cli
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_persistent_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
specifier|const
name|u8
modifier|*
name|bssid
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|p2p
decl_stmt|;
name|u8
name|group_capab
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|go_params
condition|)
name|bssid
operator|=
name|wpa_s
operator|->
name|go_params
operator|->
name|peer_interface_addr
expr_stmt|;
else|else
name|bssid
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|u8
name|iface_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|p2p_get_interface_addr
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|bssid
argument_list|,
name|iface_addr
argument_list|)
operator|==
literal|0
condition|)
name|bss
operator|=
name|wpa_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|iface_addr
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not figure out whether "
literal|"group is persistent - BSS "
name|MACSTR
literal|" not found"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|p2p
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not figure out whether "
literal|"group is persistent - BSS "
name|MACSTR
literal|" did not include P2P IE"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Probe Response IEs"
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
argument_list|,
name|bss
operator|->
name|ie_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Beacon IEs"
argument_list|,
operator|(
operator|(
name|u8
operator|*
operator|)
name|bss
operator|+
literal|1
operator|)
operator|+
name|bss
operator|->
name|ie_len
argument_list|,
name|bss
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|group_capab
operator|=
name|p2p_get_group_capab
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|addr
operator|=
name|p2p_get_go_dev_addr
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Checking whether group is persistent: "
literal|"group_capab=0x%x"
argument_list|,
name|group_capab
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
name|os_memcpy
argument_list|(
name|go_dev_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO Device Address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|os_memset
argument_list|(
name|go_dev_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: BSS "
name|MACSTR
literal|" group_capab=0x%x "
literal|"go_dev_addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|,
name|group_capab
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|group_capab
operator|&
name|P2P_GROUP_CAPAB_PERSISTENT_GROUP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_store_persistent_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|int
name|changed
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Storing credentials for a persistent "
literal|"group (GO Dev Addr "
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|==
literal|2
operator|&&
name|os_memcmp
argument_list|(
name|go_dev_addr
argument_list|,
name|s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|s
operator|->
name|ssid_len
operator|==
name|ssid
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|s
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Update existing persistent group "
literal|"entry"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|&&
operator|!
name|s
operator|->
name|passphrase
condition|)
name|changed
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|&&
name|s
operator|->
name|passphrase
operator|&&
name|os_strcmp
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|,
name|s
operator|->
name|passphrase
argument_list|)
operator|!=
literal|0
condition|)
name|changed
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Create a new persistent group "
literal|"entry"
argument_list|)
expr_stmt|;
name|changed
operator|=
literal|1
expr_stmt|;
name|s
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* 		 * Instead of network_added we emit persistent_group_added 		 * notification. Also to keep the defense checks in 		 * persistent_group obj registration method, we set the 		 * relevant flags in s to designate it as a persistent group. 		 */
name|s
operator|->
name|p2p_group
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|p2p_persistent_group
operator|=
literal|1
expr_stmt|;
name|wpas_notify_persistent_group_added
argument_list|(
name|wpa_s
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|s
operator|->
name|p2p_group
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|p2p_persistent_group
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|disabled
operator|=
literal|2
expr_stmt|;
name|s
operator|->
name|bssid_set
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|bssid
argument_list|,
name|go_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|s
operator|->
name|mode
operator|=
name|ssid
operator|->
name|mode
expr_stmt|;
name|s
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|s
operator|->
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
name|s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|s
operator|->
name|export_keys
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
condition|)
block|{
name|os_free
argument_list|(
name|s
operator|->
name|passphrase
argument_list|)
expr_stmt|;
name|s
operator|->
name|passphrase
operator|=
name|os_strdup
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|s
operator|->
name|psk_set
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|psk
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|->
name|passphrase
operator|&&
operator|!
name|s
operator|->
name|psk_set
condition|)
name|wpa_config_update_psk
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|ssid
operator|==
name|NULL
operator|||
name|s
operator|->
name|ssid_len
operator|<
name|ssid
operator|->
name|ssid_len
condition|)
block|{
name|os_free
argument_list|(
name|s
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|s
operator|->
name|ssid
operator|=
name|os_malloc
argument_list|(
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|->
name|ssid
condition|)
block|{
name|s
operator|->
name|ssid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_WRITE
if|if
condition|(
name|changed
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|conf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to update configuration"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_CONFIG_WRITE */
return|return
name|s
operator|->
name|id
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_add_persistent_group_client
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|u8
modifier|*
name|n
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|||
operator|!
name|ssid
operator|->
name|p2p_persistent_group
condition|)
return|return;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|!=
literal|2
operator|||
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
continue|continue;
if|if
condition|(
name|s
operator|->
name|ssid_len
operator|==
name|ssid
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|s
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|s
operator|->
name|p2p_client_list
operator|&&
name|i
operator|<
name|s
operator|->
name|num_p2p_clients
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
name|ETH_ALEN
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|i
operator|==
name|s
operator|->
name|num_p2p_clients
operator|-
literal|1
condition|)
return|return;
comment|/* already the most recent entry */
comment|/* move the entry to mark it most recent */
name|os_memmove
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
name|ETH_ALEN
argument_list|,
name|s
operator|->
name|p2p_client_list
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
name|ETH_ALEN
argument_list|,
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
name|i
operator|-
literal|1
operator|)
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
literal|1
operator|)
operator|*
name|ETH_ALEN
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|found
operator|&&
name|s
operator|->
name|num_p2p_clients
operator|<
name|P2P_MAX_STORED_CLIENTS
condition|)
block|{
name|n
operator|=
name|os_realloc_array
argument_list|(
name|s
operator|->
name|p2p_client_list
argument_list|,
name|s
operator|->
name|num_p2p_clients
operator|+
literal|1
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|n
operator|+
name|s
operator|->
name|num_p2p_clients
operator|*
name|ETH_ALEN
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|s
operator|->
name|p2p_client_list
operator|=
name|n
expr_stmt|;
name|s
operator|->
name|num_p2p_clients
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|found
condition|)
block|{
comment|/* Not enough room for an additional entry - drop the oldest 		 * entry */
name|os_memmove
argument_list|(
name|s
operator|->
name|p2p_client_list
argument_list|,
name|s
operator|->
name|p2p_client_list
operator|+
name|ETH_ALEN
argument_list|,
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
literal|1
operator|)
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
literal|1
operator|)
operator|*
name|ETH_ALEN
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_WRITE
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|parent
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|conf
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to update configuration"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_CONFIG_WRITE */
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_group_formation_completed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|success
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
specifier|const
name|char
modifier|*
name|ssid_txt
decl_stmt|;
name|int
name|client
decl_stmt|;
name|int
name|persistent
decl_stmt|;
name|u8
name|go_dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|network_id
init|=
operator|-
literal|1
decl_stmt|;
comment|/* 	 * This callback is likely called for the main interface. Update wpa_s 	 * to use the group interface if a new interface was created for the 	 * group. 	 */
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
condition|)
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|success
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_FORMATION_FAILURE
argument_list|)
expr_stmt|;
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_FORMATION_FAILED
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_FORMATION_SUCCESS
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GROUP_FORMATION
condition|)
block|{
name|ssid
operator|->
name|mode
operator|=
name|WPAS_MODE_P2P_GO
expr_stmt|;
name|p2p_group_notif_formation_done
argument_list|(
name|wpa_s
operator|->
name|p2p_group
argument_list|)
expr_stmt|;
name|wpa_supplicant_ap_mac_addr_filter
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|persistent
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
condition|)
block|{
name|ssid_txt
operator|=
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|client
operator|=
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
name|persistent
operator|=
name|ssid
operator|->
name|p2p_persistent_group
expr_stmt|;
name|os_memcpy
argument_list|(
name|go_dev_addr
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
name|persistent
operator|=
name|wpas_p2p_persistent_group
argument_list|(
name|wpa_s
argument_list|,
name|go_dev_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ssid_txt
operator|=
literal|""
expr_stmt|;
name|client
operator|=
name|wpa_s
operator|->
name|p2p_group_interface
operator|==
name|P2P_GROUP_INTERFACE_CLIENT
expr_stmt|;
name|os_memset
argument_list|(
name|go_dev_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|client
condition|)
block|{
comment|/* 		 * Indicate event only after successfully completed 4-way 		 * handshake, i.e., when the interface is ready for data 		 * packets. 		 */
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|passphrase
operator|==
name|NULL
operator|&&
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|char
name|psk
index|[
literal|65
index|]
decl_stmt|;
name|wpa_snprintf_hex
argument_list|(
name|psk
argument_list|,
sizeof|sizeof
argument_list|(
name|psk
argument_list|)
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_STARTED
literal|"%s GO ssid=\"%s\" freq=%d psk=%s go_dev_addr="
name|MACSTR
literal|"%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ssid_txt
argument_list|,
name|ssid
operator|->
name|frequency
argument_list|,
name|psk
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|,
name|persistent
condition|?
literal|" [PERSISTENT]"
else|:
literal|""
argument_list|)
expr_stmt|;
name|wpas_p2p_cross_connect_setup
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_p2p_set_group_idle_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_STARTED
literal|"%s GO ssid=\"%s\" freq=%d passphrase=\"%s\" "
literal|"go_dev_addr="
name|MACSTR
literal|"%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ssid_txt
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|frequency
else|:
literal|0
argument_list|,
name|ssid
operator|&&
name|ssid
operator|->
name|passphrase
condition|?
name|ssid
operator|->
name|passphrase
else|:
literal|""
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|,
name|persistent
condition|?
literal|" [PERSISTENT]"
else|:
literal|""
argument_list|)
expr_stmt|;
name|wpas_p2p_cross_connect_setup
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_p2p_set_group_idle_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|persistent
condition|)
name|network_id
operator|=
name|wpas_p2p_store_persistent_group
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|ssid
argument_list|,
name|go_dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|network_id
operator|<
literal|0
operator|&&
name|ssid
condition|)
name|network_id
operator|=
name|ssid
operator|->
name|id
expr_stmt|;
if|if
condition|(
operator|!
name|client
condition|)
name|wpas_notify_p2p_group_started
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|network_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_send_action_tx_status
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|enum
name|offchannel_send_action_result
name|result
parameter_list|)
block|{
name|enum
name|p2p_send_action_result
name|res
init|=
name|P2P_SEND_ACTION_SUCCESS
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|OFFCHANNEL_SEND_ACTION_SUCCESS
case|:
name|res
operator|=
name|P2P_SEND_ACTION_SUCCESS
expr_stmt|;
break|break;
case|case
name|OFFCHANNEL_SEND_ACTION_NO_ACK
case|:
name|res
operator|=
name|P2P_SEND_ACTION_NO_ACK
expr_stmt|;
break|break;
case|case
name|OFFCHANNEL_SEND_ACTION_FAILED
case|:
name|res
operator|=
name|P2P_SEND_ACTION_FAILED
expr_stmt|;
break|break;
block|}
name|p2p_send_action_cb
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|src
argument_list|,
name|bssid
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|OFFCHANNEL_SEND_ACTION_SUCCESS
operator|&&
name|wpa_s
operator|->
name|pending_pd_before_join
operator|&&
operator|(
name|os_memcmp
argument_list|(
name|dst
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|||
name|os_memcmp
argument_list|(
name|dst
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
operator|&&
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
condition|)
block|{
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: No ACK for PD Req "
literal|"during p2p_connect-auto"
argument_list|)
expr_stmt|;
name|wpas_p2p_fallback_to_go_neg
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_send_action
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|unsigned
name|int
name|wait_time
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
return|return
name|offchannel_send_action
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|src
argument_list|,
name|bssid
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|wait_time
argument_list|,
name|wpas_p2p_send_action_tx_status
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_send_action_done
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|offchannel_send_action_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_copy_go_neg_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|params
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|go_params
operator|==
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|go_params
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|params
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|go_params
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|go_params
argument_list|,
name|params
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|params
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_start_wps_enrollee
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|res
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Start WPS Enrollee for peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|peer_interface_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Start WPS Enrollee for SSID"
argument_list|,
name|res
operator|->
name|ssid
argument_list|,
name|res
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_supplicant_ap_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_copy_go_neg_results
argument_list|(
name|wpa_s
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|wps_method
operator|==
name|WPS_PBC
condition|)
name|wpas_wps_start_pbc
argument_list|(
name|wpa_s
argument_list|,
name|res
operator|->
name|peer_interface_addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
block|{
name|u16
name|dev_pw_id
init|=
name|DEV_PW_DEFAULT
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_wps_method
operator|==
name|WPS_PIN_KEYPAD
condition|)
name|dev_pw_id
operator|=
name|DEV_PW_REGISTRAR_SPECIFIED
expr_stmt|;
name|wpas_wps_start_pin
argument_list|(
name|wpa_s
argument_list|,
name|res
operator|->
name|peer_interface_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
literal|1
argument_list|,
name|dev_pw_id
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_go_configured
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|p2p_go_neg_results
modifier|*
name|params
init|=
name|data
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|network_id
init|=
operator|-
literal|1
decl_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Group setup without provisioning"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|==
name|wpa_s
condition|)
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|os_strlen
argument_list|(
name|params
operator|->
name|passphrase
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_STARTED
literal|"%s GO ssid=\"%s\" freq=%d passphrase=\"%s\" "
literal|"go_dev_addr="
name|MACSTR
literal|"%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|,
name|ssid
operator|->
name|frequency
argument_list|,
name|params
operator|->
name|passphrase
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|)
argument_list|,
name|params
operator|->
name|persistent_group
condition|?
literal|" [PERSISTENT]"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
name|psk
index|[
literal|65
index|]
decl_stmt|;
name|wpa_snprintf_hex
argument_list|(
name|psk
argument_list|,
sizeof|sizeof
argument_list|(
name|psk
argument_list|)
argument_list|,
name|params
operator|->
name|psk
argument_list|,
sizeof|sizeof
argument_list|(
name|params
operator|->
name|psk
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_STARTED
literal|"%s GO ssid=\"%s\" freq=%d psk=%s "
literal|"go_dev_addr="
name|MACSTR
literal|"%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|,
name|ssid
operator|->
name|frequency
argument_list|,
name|psk
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|)
argument_list|,
name|params
operator|->
name|persistent_group
condition|?
literal|" [PERSISTENT]"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|persistent_group
condition|)
name|network_id
operator|=
name|wpas_p2p_store_persistent_group
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|ssid
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|network_id
operator|<
literal|0
condition|)
name|network_id
operator|=
name|ssid
operator|->
name|id
expr_stmt|;
name|wpas_notify_p2p_group_started
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|network_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpas_p2p_cross_connect_setup
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_p2p_set_group_idle_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Setting up WPS for GO provisioning"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_ap_mac_addr_filter
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|peer_interface_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to setup MAC address "
literal|"filtering"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|params
operator|->
name|wps_method
operator|==
name|WPS_PBC
condition|)
name|wpa_supplicant_ap_wps_pbc
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|peer_interface_addr
argument_list|,
name|params
operator|->
name|peer_device_addr
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|p2p_pin
index|[
literal|0
index|]
condition|)
name|wpa_supplicant_ap_wps_pin
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|peer_interface_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|go_params
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|go_params
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_start_wps_go
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|params
parameter_list|,
name|int
name|group_formation
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Starting GO"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpas_copy_go_neg_results
argument_list|(
name|wpa_s
argument_list|,
name|params
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not copy GO Negotiation "
literal|"results"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not add network for GO"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|0
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|p2p_group
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|p2p_persistent_group
operator|=
name|params
operator|->
name|persistent_group
expr_stmt|;
name|ssid
operator|->
name|mode
operator|=
name|group_formation
condition|?
name|WPAS_MODE_P2P_GROUP_FORMATION
else|:
name|WPAS_MODE_P2P_GO
expr_stmt|;
name|ssid
operator|->
name|frequency
operator|=
name|params
operator|->
name|freq
expr_stmt|;
name|ssid
operator|->
name|ht40
operator|=
name|params
operator|->
name|ht40
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_zalloc
argument_list|(
name|params
operator|->
name|ssid_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
condition|)
block|{
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
block|}
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
name|ssid
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
if|if
condition|(
name|os_strlen
argument_list|(
name|params
operator|->
name|passphrase
argument_list|)
operator|>
literal|0
condition|)
block|{
name|ssid
operator|->
name|passphrase
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|passphrase
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to copy "
literal|"passphrase for GO"
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
name|ssid
operator|->
name|passphrase
operator|=
name|NULL
expr_stmt|;
name|ssid
operator|->
name|psk_set
operator|=
name|params
operator|->
name|psk_set
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|psk_set
condition|)
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|psk
argument_list|,
name|params
operator|->
name|psk
argument_list|,
sizeof|sizeof
argument_list|(
name|ssid
operator|->
name|psk
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|passphrase
condition|)
name|wpa_config_update_psk
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ap_max_inactivity
operator|=
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|p2p_go_max_inactivity
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb
operator|=
name|p2p_go_configured
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb_ctx
operator|=
name|wpa_s
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb_data
operator|=
name|wpa_s
operator|->
name|go_params
expr_stmt|;
name|wpa_s
operator|->
name|connect_without_scan
operator|=
name|ssid
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|disconnected
operator|=
literal|0
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Request scan (that will be skipped) to "
literal|"start GO)"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_clone_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpa_supplicant
modifier|*
name|src
parameter_list|)
block|{
name|struct
name|wpa_config
modifier|*
name|d
decl_stmt|;
specifier|const
name|struct
name|wpa_config
modifier|*
name|s
decl_stmt|;
name|d
operator|=
name|dst
operator|->
name|conf
expr_stmt|;
name|s
operator|=
name|src
operator|->
name|conf
expr_stmt|;
define|#
directive|define
name|C
parameter_list|(
name|n
parameter_list|)
value|if (s->n) d->n = os_strdup(s->n)
name|C
argument_list|(
name|device_name
argument_list|)
expr_stmt|;
name|C
argument_list|(
name|manufacturer
argument_list|)
expr_stmt|;
name|C
argument_list|(
name|model_name
argument_list|)
expr_stmt|;
name|C
argument_list|(
name|model_number
argument_list|)
expr_stmt|;
name|C
argument_list|(
name|serial_number
argument_list|)
expr_stmt|;
name|C
argument_list|(
name|config_methods
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|C
name|os_memcpy
argument_list|(
name|d
operator|->
name|device_type
argument_list|,
name|s
operator|->
name|device_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|d
operator|->
name|sec_device_type
argument_list|,
name|s
operator|->
name|sec_device_type
argument_list|,
sizeof|sizeof
argument_list|(
name|d
operator|->
name|sec_device_type
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|->
name|num_sec_device_types
operator|=
name|s
operator|->
name|num_sec_device_types
expr_stmt|;
name|d
operator|->
name|p2p_group_idle
operator|=
name|s
operator|->
name|p2p_group_idle
expr_stmt|;
name|d
operator|->
name|p2p_intra_bss
operator|=
name|s
operator|->
name|p2p_intra_bss
expr_stmt|;
name|d
operator|->
name|persistent_reconnect
operator|=
name|s
operator|->
name|persistent_reconnect
expr_stmt|;
name|d
operator|->
name|max_num_sta
operator|=
name|s
operator|->
name|max_num_sta
expr_stmt|;
name|d
operator|->
name|pbc_in_m1
operator|=
name|s
operator|->
name|pbc_in_m1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_add_group_interface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|enum
name|wpa_driver_if_type
name|type
parameter_list|)
block|{
name|char
name|ifname
index|[
literal|120
index|]
decl_stmt|,
name|force_ifname
index|[
literal|120
index|]
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Pending virtual interface exists "
literal|"- skip creation of a new one"
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Pending virtual address "
literal|"unknown?! ifname='%s'"
argument_list|,
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
name|os_snprintf
argument_list|(
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
argument_list|,
literal|"p2p-%s-%d"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|p2p_group_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strlen
argument_list|(
name|ifname
argument_list|)
operator|>=
name|IFNAMSIZ
operator|&&
name|os_strlen
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
operator|<
name|IFNAMSIZ
condition|)
block|{
comment|/* Try to avoid going over the IFNAMSIZ length limit */
name|os_snprintf
argument_list|(
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
argument_list|,
literal|"p2p-%d"
argument_list|,
name|wpa_s
operator|->
name|p2p_group_idx
argument_list|)
expr_stmt|;
block|}
name|force_ifname
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Create a new interface %s for the group"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group_idx
operator|++
expr_stmt|;
name|wpa_s
operator|->
name|pending_interface_type
operator|=
name|type
expr_stmt|;
if|if
condition|(
name|wpa_drv_if_add
argument_list|(
name|wpa_s
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|force_ifname
argument_list|,
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to create new group "
literal|"interface"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|force_ifname
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Driver forced interface name %s"
argument_list|,
name|force_ifname
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|pending_interface_name
argument_list|,
name|force_ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|pending_interface_name
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Created pending virtual interface %s addr "
name|MACSTR
argument_list|,
name|wpa_s
operator|->
name|pending_interface_name
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_remove_pending_group_interface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|||
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|)
condition|)
return|return;
comment|/* No pending virtual interface */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Removing pending group interface %s"
argument_list|,
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
expr_stmt|;
name|wpa_drv_if_remove
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_interface_type
argument_list|,
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpas_p2p_init_group_interface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|wpa_interface
name|iface
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|group_wpa_s
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: No pending group interface"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* 		 * Something has forced us to remove the pending interface; try 		 * to create a new one and hope for the best that we will get 		 * the same local address. 		 */
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|go
condition|?
name|WPA_IF_P2P_GO
else|:
name|WPA_IF_P2P_CLIENT
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|iface
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|iface
operator|.
name|ifname
operator|=
name|wpa_s
operator|->
name|pending_interface_name
expr_stmt|;
name|iface
operator|.
name|driver
operator|=
name|wpa_s
operator|->
name|driver
operator|->
name|name
expr_stmt|;
name|iface
operator|.
name|ctrl_interface
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
expr_stmt|;
name|iface
operator|.
name|driver_param
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
expr_stmt|;
name|group_wpa_s
operator|=
name|wpa_supplicant_add_iface
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
operator|&
name|iface
argument_list|)
expr_stmt|;
if|if
condition|(
name|group_wpa_s
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to create new "
literal|"wpa_supplicant interface"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|group_wpa_s
operator|->
name|parent
operator|=
name|wpa_s
expr_stmt|;
name|group_wpa_s
operator|->
name|p2p_group_interface
operator|=
name|go
condition|?
name|P2P_GROUP_INTERFACE_GO
else|:
name|P2P_GROUP_INTERFACE_CLIENT
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|group_wpa_s
expr_stmt|;
name|wpas_p2p_clone_config
argument_list|(
name|group_wpa_s
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|group_wpa_s
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_group_formation_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Group Formation timed out"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_group_formation_failed
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
name|wpa_drv_p2p_group_formation_failed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_group_formation_completed
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_go_neg_completed
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|res
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|||
name|wpa_s
operator|->
name|roc_waiting_drv_freq
condition|)
block|{
name|wpa_drv_cancel_remain_on_channel
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|->
name|status
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GO_NEG_FAILURE
literal|"status=%d"
argument_list|,
name|res
operator|->
name|status
argument_list|)
expr_stmt|;
name|wpas_notify_p2p_go_neg_completed
argument_list|(
name|wpa_s
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_go_ht40
condition|)
name|res
operator|->
name|ht40
operator|=
literal|1
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GO_NEG_SUCCESS
argument_list|)
expr_stmt|;
name|wpas_notify_p2p_go_neg_completed
argument_list|(
name|wpa_s
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|role_go
operator|&&
name|wpa_s
operator|->
name|p2p_persistent_id
operator|>=
literal|0
condition|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|disabled
operator|==
literal|2
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
name|ssid
operator|->
name|passphrase
condition|)
block|{
name|size_t
name|len
init|=
name|os_strlen
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Override passphrase based "
literal|"on requested persistent group"
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|res
operator|->
name|passphrase
argument_list|,
name|ssid
operator|->
name|passphrase
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|res
operator|->
name|passphrase
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|create_p2p_iface
condition|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|group_wpa_s
init|=
name|wpas_p2p_init_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|res
operator|->
name|role_go
argument_list|)
decl_stmt|;
if|if
condition|(
name|group_wpa_s
operator|==
name|NULL
condition|)
block|{
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|group_wpa_s
operator|!=
name|wpa_s
condition|)
block|{
name|os_memcpy
argument_list|(
name|group_wpa_s
operator|->
name|p2p_pin
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
sizeof|sizeof
argument_list|(
name|group_wpa_s
operator|->
name|p2p_pin
argument_list|)
argument_list|)
expr_stmt|;
name|group_wpa_s
operator|->
name|p2p_wps_method
operator|=
name|wpa_s
operator|->
name|p2p_wps_method
expr_stmt|;
block|}
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|group_wpa_s
operator|->
name|p2p_in_provisioning
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|role_go
condition|)
name|wpas_start_wps_go
argument_list|(
name|group_wpa_s
argument_list|,
name|res
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|wpas_start_wps_enrollee
argument_list|(
name|group_wpa_s
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|wpa_s
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|role_go
condition|)
name|wpas_start_wps_go
argument_list|(
name|wpa_s
argument_list|,
name|res
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|wpas_start_wps_enrollee
argument_list|(
name|ctx
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|15
operator|+
name|res
operator|->
name|peer_config_timeout
operator|/
literal|100
argument_list|,
operator|(
name|res
operator|->
name|peer_config_timeout
operator|%
literal|100
operator|)
operator|*
literal|10000
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_go_neg_req_rx
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
name|u16
name|dev_passwd_id
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_msg
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_GO_NEG_REQUEST MACSTR
literal|" dev_passwd_id=%u"
argument_list|,
argument|MAC2STR(src)
argument_list|,
argument|dev_passwd_id
argument_list|)
empty_stmt|;
name|wpas_notify_p2p_go_neg_req
argument_list|(
name|wpa_s
argument_list|,
name|src
argument_list|,
name|dev_passwd_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_dev_found
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|info
parameter_list|,
name|int
name|new_device
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_NO_STDOUT_DEBUG
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|wpa_msg
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_DEVICE_FOUND MACSTR
literal|" p2p_dev_addr="
argument|MACSTR
literal|" pri_dev_type=%s name='%s' config_methods=0x%x "
literal|"dev_capab=0x%x group_capab=0x%x"
argument_list|,
argument|MAC2STR(addr)
argument_list|,
argument|MAC2STR(info->p2p_device_addr)
argument_list|,
argument|wps_dev_type_bin2str(info->pri_dev_type, devtype, 				     sizeof(devtype))
argument_list|,
argument|info->device_name
argument_list|,
argument|info->config_methods
argument_list|,
argument|info->dev_capab
argument_list|,
argument|info->group_capab
argument_list|)
empty_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_STDOUT_DEBUG */
name|wpas_notify_p2p_device_found
argument_list|(
name|ctx
argument_list|,
name|info
operator|->
name|p2p_device_addr
argument_list|,
name|new_device
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_dev_lost
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_DEVICE_LOST
literal|"p2p_dev_addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpas_notify_p2p_device_lost
argument_list|(
name|wpa_s
argument_list|,
name|dev_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_start_listen
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|duration
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|probe_resp_ie
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_drv_set_ap_wps_ie
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|probe_resp_ie
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_probe_req_report
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to request the driver to "
literal|"report received Probe Request frames"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|pending_listen_freq
operator|=
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|pending_listen_duration
operator|=
name|duration
expr_stmt|;
if|if
condition|(
name|wpa_drv_remain_on_channel
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|duration
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to request the driver "
literal|"to remain on channel (%u MHz) for Listen "
literal|"state"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_listen_freq
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
name|freq
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_stop_listen
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|||
name|wpa_s
operator|->
name|roc_waiting_drv_freq
condition|)
block|{
name|wpa_drv_cancel_remain_on_channel
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_drv_set_ap_wps_ie
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_drv_probe_req_report
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_send_probe_resp
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
return|return
name|wpa_drv_send_mlme
argument_list|(
name|wpa_s
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * DNS Header section is used only to calculate compression pointers, so the  * contents of this data does not matter, but the length needs to be reserved  * in the virtual packet.  */
end_comment

begin_define
define|#
directive|define
name|DNS_HEADER_LEN
value|12
end_define

begin_comment
comment|/*  * 27-octet in-memory packet from P2P specification containing two implied  * queries for _tcp.lcoal. PTR IN and _udp.local. PTR IN  */
end_comment

begin_define
define|#
directive|define
name|P2P_SD_IN_MEMORY_LEN
value|27
end_define

begin_function
specifier|static
name|int
name|p2p_sd_dns_uncompress_label
parameter_list|(
name|char
modifier|*
modifier|*
name|upos
parameter_list|,
name|char
modifier|*
name|uend
parameter_list|,
name|u8
modifier|*
name|start
parameter_list|,
name|u8
modifier|*
modifier|*
name|spos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
while|while
condition|(
operator|*
name|spos
operator|<
name|end
condition|)
block|{
name|u8
name|val
init|=
operator|(
operator|(
operator|*
name|spos
operator|)
index|[
literal|0
index|]
operator|&
literal|0xc0
operator|)
operator|>>
literal|6
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|val
operator|==
literal|1
operator|||
name|val
operator|==
literal|2
condition|)
block|{
comment|/* These are reserved values in RFC 1035 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid domain name "
literal|"sequence starting with 0x%x"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|val
operator|==
literal|3
condition|)
block|{
name|u16
name|offset
decl_stmt|;
name|u8
modifier|*
name|spos_tmp
decl_stmt|;
comment|/* Offset */
if|if
condition|(
operator|*
name|spos
operator|+
literal|2
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No room for full "
literal|"DNS offset field"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|offset
operator|=
operator|(
operator|(
operator|(
operator|*
name|spos
operator|)
index|[
literal|0
index|]
operator|&
literal|0x3f
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|*
name|spos
operator|)
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|offset
operator|>=
operator|*
name|spos
operator|-
name|start
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid DNS "
literal|"pointer offset %u"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
operator|*
name|spos
operator|)
operator|+=
literal|2
expr_stmt|;
name|spos_tmp
operator|=
name|start
operator|+
name|offset
expr_stmt|;
return|return
name|p2p_sd_dns_uncompress_label
argument_list|(
name|upos
argument_list|,
name|uend
argument_list|,
name|start
argument_list|,
operator|&
name|spos_tmp
argument_list|,
operator|*
name|spos
operator|-
literal|2
argument_list|)
return|;
block|}
comment|/* Label */
name|len
operator|=
operator|(
operator|*
name|spos
operator|)
index|[
literal|0
index|]
operator|&
literal|0x3f
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
operator|(
operator|*
name|spos
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|spos
operator|+
name|len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid domain name "
literal|"sequence - no room for label with length "
literal|"%u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|*
name|upos
operator|+
name|len
operator|+
literal|2
operator|>
name|uend
condition|)
return|return
operator|-
literal|2
return|;
name|os_memcpy
argument_list|(
operator|*
name|upos
argument_list|,
operator|*
name|spos
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|spos
operator|+=
name|len
expr_stmt|;
operator|*
name|upos
operator|+=
name|len
expr_stmt|;
operator|(
operator|*
name|upos
operator|)
index|[
literal|0
index|]
operator|=
literal|'.'
expr_stmt|;
operator|(
operator|*
name|upos
operator|)
operator|++
expr_stmt|;
operator|(
operator|*
name|upos
operator|)
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Uncompress domain names per RFC 1035 using the P2P SD in-memory packet.  * Returns -1 on parsing error (invalid input sequence), -2 if output buffer is  * not large enough */
end_comment

begin_function
specifier|static
name|int
name|p2p_sd_dns_uncompress
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|,
name|size_t
name|offset
parameter_list|)
block|{
comment|/* 27-octet in-memory packet from P2P specification */
specifier|const
name|char
modifier|*
name|prefix
init|=
literal|"\x04_tcp\x05local\x00\x00\x0C\x00\x01"
literal|"\x04_udp\xC0\x11\x00\x0C\x00\x01"
decl_stmt|;
name|u8
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|spos
decl_stmt|;
name|char
modifier|*
name|upos
decl_stmt|,
modifier|*
name|uend
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|buf_len
operator|<
literal|2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|offset
operator|>
name|msg_len
condition|)
return|return
operator|-
literal|1
return|;
name|tmp
operator|=
name|os_malloc
argument_list|(
name|DNS_HEADER_LEN
operator|+
name|P2P_SD_IN_MEMORY_LEN
operator|+
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|spos
operator|=
name|tmp
operator|+
name|DNS_HEADER_LEN
operator|+
name|P2P_SD_IN_MEMORY_LEN
expr_stmt|;
name|end
operator|=
name|spos
operator|+
name|msg_len
expr_stmt|;
name|spos
operator|+=
name|offset
expr_stmt|;
name|os_memset
argument_list|(
name|tmp
argument_list|,
literal|0
argument_list|,
name|DNS_HEADER_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|tmp
operator|+
name|DNS_HEADER_LEN
argument_list|,
name|prefix
argument_list|,
name|P2P_SD_IN_MEMORY_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|tmp
operator|+
name|DNS_HEADER_LEN
operator|+
name|P2P_SD_IN_MEMORY_LEN
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|upos
operator|=
name|buf
expr_stmt|;
name|uend
operator|=
name|buf
operator|+
name|buf_len
expr_stmt|;
name|ret
operator|=
name|p2p_sd_dns_uncompress_label
argument_list|(
operator|&
name|upos
argument_list|,
name|uend
argument_list|,
name|tmp
argument_list|,
operator|&
name|spos
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|upos
operator|==
name|buf
condition|)
block|{
name|upos
index|[
literal|0
index|]
operator|=
literal|'.'
expr_stmt|;
name|upos
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|upos
index|[
operator|-
literal|1
index|]
operator|==
literal|'.'
condition|)
name|upos
index|[
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|p2p_srv_bonjour
modifier|*
name|wpas_p2p_service_get_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|len
operator|=
name|wpabuf_len
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bsrv
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|len
operator|==
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|&&
name|os_memcmp
argument_list|(
name|wpabuf_head
argument_list|(
name|query
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
name|bsrv
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|p2p_srv_upnp
modifier|*
name|wpas_p2p_service_get_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|usrv
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|version
operator|==
name|usrv
operator|->
name|version
operator|&&
name|os_strcmp
argument_list|(
name|service
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
operator|==
literal|0
condition|)
return|return
name|usrv
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_add_proto_not_avail
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_proto
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|u8
modifier|*
name|len_pos
decl_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_PROTO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
comment|/* Response Data: empty */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_all_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for all Bonjour services"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Bonjour protocol not available"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|bsrv
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching Bonjour service"
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|bsrv
operator|->
name|query
argument_list|)
expr_stmt|;
comment|/* Key */
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|bsrv
operator|->
name|resp
argument_list|)
expr_stmt|;
comment|/* Value */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|match_bonjour_query
parameter_list|(
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|char
name|str_rx
index|[
literal|256
index|]
decl_stmt|,
name|str_srv
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|query_len
operator|<
literal|3
operator|||
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|<
literal|3
condition|)
return|return
literal|0
return|;
comment|/* Too short to include DNS Type and Version */
if|if
condition|(
name|os_memcmp
argument_list|(
name|query
operator|+
name|query_len
operator|-
literal|3
argument_list|,
name|wpabuf_head_u8
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|-
literal|3
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Mismatch in DNS Type or Version */
if|if
condition|(
name|query_len
operator|==
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|&&
name|os_memcmp
argument_list|(
name|query
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
argument_list|,
name|query_len
operator|-
literal|3
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
comment|/* Binary match */
if|if
condition|(
name|p2p_sd_dns_uncompress
argument_list|(
name|str_rx
argument_list|,
sizeof|sizeof
argument_list|(
name|str_rx
argument_list|)
argument_list|,
name|query
argument_list|,
name|query_len
operator|-
literal|3
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Failed to uncompress query */
if|if
condition|(
name|p2p_sd_dns_uncompress
argument_list|(
name|str_srv
argument_list|,
sizeof|sizeof
argument_list|(
name|str_srv
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|-
literal|3
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Failed to uncompress service */
return|return
name|os_strcmp
argument_list|(
name|str_rx
argument_list|,
name|str_srv
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_req_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|int
name|matches
init|=
literal|0
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for Bonjour"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Bonjour protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|query_len
operator|==
literal|0
condition|)
block|{
name|wpas_sd_all_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|bsrv
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|match_bonjour_query
argument_list|(
name|bsrv
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
operator|+
name|query_len
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
condition|)
return|return;
name|matches
operator|++
expr_stmt|;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching Bonjour service"
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_data
argument_list|(
name|resp
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
comment|/* Key */
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|bsrv
operator|->
name|resp
argument_list|)
expr_stmt|;
comment|/* Value */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|matches
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested Bonjour service not "
literal|"available"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_REQUESTED_INFO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
comment|/* Response Data: empty */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_all_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for all UPnP services"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: UPnP protocol not available"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|usrv
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|usrv
operator|->
name|service
argument_list|)
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_UPNP
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|usrv
operator|->
name|version
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching UPnP Service: %s"
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|resp
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_req_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|u8
name|version
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for UPnP"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: UPnP protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_UPNP
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|query_len
operator|==
literal|0
condition|)
block|{
name|wpas_sd_all_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_UPNP
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|version
operator|=
name|query
index|[
literal|0
index|]
expr_stmt|;
name|str
operator|=
name|os_malloc
argument_list|(
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|str
argument_list|,
name|query
operator|+
literal|1
argument_list|,
name|query_len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|str
index|[
name|query_len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|usrv
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|version
operator|!=
name|usrv
operator|->
name|version
condition|)
continue|continue;
if|if
condition|(
name|os_strcmp
argument_list|(
name|str
argument_list|,
literal|"ssdp:all"
argument_list|)
operator|!=
literal|0
operator|&&
name|os_strstr
argument_list|(
name|usrv
operator|->
name|service
argument_list|,
name|str
argument_list|)
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|2
condition|)
break|break;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|version
argument_list|)
expr_stmt|;
block|}
else|else
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
literal|','
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching UPnP Service: %s"
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
name|os_strlen
argument_list|(
name|usrv
operator|->
name|service
argument_list|)
condition|)
break|break;
name|wpabuf_put_str
argument_list|(
name|resp
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested UPnP service not "
literal|"available"
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_REQUESTED_INFO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
comment|/* Response Data: empty */
block|}
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
end_ifdef

begin_function
specifier|static
name|void
name|wpas_sd_req_wfd
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|u8
name|role
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for WFD"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|wifi_display
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: WFD protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_WIFI_DISPLAY
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|query_len
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Missing WFD Requested Device "
literal|"Role"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
name|pos
operator|=
name|query
expr_stmt|;
name|role
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: WSD for device role 0x%x"
argument_list|,
name|role
argument_list|)
expr_stmt|;
comment|/* TODO: role specific handling */
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_WIFI_DISPLAY
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Status Code */
while|while
condition|(
name|pos
operator|<
name|query
operator|+
name|query_len
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|<
name|MAX_WFD_SUBELEMS
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|wfd_subelem
index|[
operator|*
name|pos
index|]
operator|&&
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|>=
name|wpabuf_len
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|wfd_subelem
index|[
operator|*
name|pos
index|]
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add WSD response "
literal|"subelement %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|wfd_subelem
index|[
operator|*
name|pos
index|]
argument_list|)
expr_stmt|;
block|}
name|pos
operator|++
expr_stmt|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WIFI_DISPLAY */
end_comment

begin_function
name|void
name|wpas_sd_request
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|u16
name|update_indic
parameter_list|,
specifier|const
name|u8
modifier|*
name|tlvs
parameter_list|,
name|size_t
name|tlvs_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
init|=
name|tlvs
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|tlvs
operator|+
name|tlvs_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|tlv_end
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
name|u8
name|srv_proto
decl_stmt|,
name|srv_trans_id
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Service Discovery Request TLVs"
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|buf_len
operator|=
literal|2
operator|*
name|tlvs_len
operator|+
literal|1
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_SERV_DISC_REQ
literal|"%d "
name|MACSTR
literal|" %u %u %s"
argument_list|,
name|freq
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|,
name|update_indic
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_sd_over_ctrl_iface
condition|)
block|{
name|wpas_notify_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|update_indic
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
return|return;
comment|/* to be processed by an external program */
block|}
name|resp
operator|=
name|wpabuf_alloc
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Request TLV"
argument_list|)
expr_stmt|;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
operator|||
name|slen
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unexpected Query Data "
literal|"length"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return;
block|}
name|tlv_end
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
name|srv_proto
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Protocol Type %u"
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|srv_trans_id
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Transaction ID %u"
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Query Data"
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|force_long_sd
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD test - force long "
literal|"response"
argument_list|)
expr_stmt|;
name|wpas_sd_all_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpas_sd_all_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
switch|switch
condition|(
name|srv_proto
condition|)
block|{
case|case
name|P2P_SERV_ALL_SERVICES
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Discovery Request "
literal|"for all services"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|)
operator|&&
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No service "
literal|"discovery protocols available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_ALL_SERVICES
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpas_sd_all_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpas_sd_all_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_SERV_BONJOUR
case|:
name|wpas_sd_req_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_SERV_UPNP
case|:
name|wpas_sd_req_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
case|case
name|P2P_SERV_WIFI_DISPLAY
case|:
name|wpas_sd_req_wfd
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unavailable service "
literal|"protocol %u"
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|tlv_end
expr_stmt|;
block|}
name|done
label|:
name|wpas_notify_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|update_indic
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_response
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_sd_response
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
name|u16
name|update_indic
parameter_list|,
specifier|const
name|u8
modifier|*
name|tlvs
parameter_list|,
name|size_t
name|tlvs_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
init|=
name|tlvs
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|tlvs
operator|+
name|tlvs_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|tlv_end
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Service Discovery Response TLVs"
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs_len
operator|>
literal|1500
condition|)
block|{
comment|/* TODO: better way for handling this */
name|wpa_msg_ctrl
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_SERV_DISC_RESP MACSTR
literal|" %u<long response: %u bytes>"
argument_list|,
argument|MAC2STR(sa)
argument_list|,
argument|update_indic
argument_list|,
argument|(unsigned int) tlvs_len
argument_list|)
empty_stmt|;
block|}
else|else
block|{
name|buf_len
operator|=
literal|2
operator|*
name|tlvs_len
operator|+
literal|1
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|wpa_msg_ctrl
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_SERV_DISC_RESP MACSTR
literal|" %u %s"
argument_list|,
argument|MAC2STR(sa)
argument_list|,
argument|update_indic
argument_list|,
argument|buf
argument_list|)
empty_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|u8
name|srv_proto
decl_stmt|,
name|srv_trans_id
decl_stmt|,
name|status
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Response TLV"
argument_list|)
expr_stmt|;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
operator|||
name|slen
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unexpected Response Data "
literal|"length"
argument_list|)
expr_stmt|;
return|return;
block|}
name|tlv_end
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
name|srv_proto
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Protocol Type %u"
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|srv_trans_id
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Transaction ID %u"
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|status
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Status Code ID %u"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Response Data"
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|=
name|tlv_end
expr_stmt|;
block|}
name|wpas_notify_p2p_sd_response
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|,
name|update_indic
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
name|wpa_drv_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|uintptr_t
operator|)
name|p2p_sd_request
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
return|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|tlvs
decl_stmt|;
name|u64
name|ret
decl_stmt|;
name|tlvs
operator|=
name|wpabuf_alloc
argument_list|(
literal|2
operator|+
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|query
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpabuf_put_le16
argument_list|(
name|tlvs
argument_list|,
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|query
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|P2P_SERV_UPNP
argument_list|)
expr_stmt|;
comment|/* Service Protocol Type */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Service Transaction ID */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|tlvs
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpas_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tlvs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
end_ifdef

begin_function
specifier|static
name|u64
name|wpas_p2p_sd_request_wfd
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|uintptr_t
operator|)
name|p2p_sd_request_wfd
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|MAX_WFD_SD_SUBELEMS
value|20
end_define

begin_function
specifier|static
name|void
name|wfd_add_sd_req_role
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|,
name|u8
name|id
parameter_list|,
name|u8
name|role
parameter_list|,
specifier|const
name|char
modifier|*
name|subelems
parameter_list|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|tlvs
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|P2P_SERV_WIFI_DISPLAY
argument_list|)
expr_stmt|;
comment|/* Service Protocol Type */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|id
argument_list|)
expr_stmt|;
comment|/* Service Transaction ID */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|role
argument_list|)
expr_stmt|;
name|pos
operator|=
name|subelems
expr_stmt|;
while|while
condition|(
operator|*
name|pos
condition|)
block|{
name|val
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>=
literal|0
operator|&&
name|val
operator|<
literal|256
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|==
name|MAX_WFD_SD_SUBELEMS
condition|)
break|break;
block|}
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
operator|+
literal|1
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
break|break;
name|pos
operator|++
expr_stmt|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|len
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|tlvs
argument_list|,
literal|0
argument_list|)
operator|-
name|len
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request_wifi_display
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|char
modifier|*
name|role
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|tlvs
decl_stmt|;
name|u64
name|ret
decl_stmt|;
specifier|const
name|char
modifier|*
name|subelems
decl_stmt|;
name|u8
name|id
init|=
literal|1
decl_stmt|;
name|subelems
operator|=
name|os_strchr
argument_list|(
name|role
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|subelems
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|subelems
operator|++
expr_stmt|;
name|tlvs
operator|=
name|wpabuf_alloc
argument_list|(
literal|4
operator|*
operator|(
literal|2
operator|+
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|MAX_WFD_SD_SUBELEMS
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[source]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x00
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[pri-sink]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x01
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[sec-sink]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x02
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[source+sink]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x03
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpas_p2p_sd_request_wfd
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tlvs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WIFI_DISPLAY */
end_comment

begin_function
name|int
name|wpas_p2p_sd_cancel_request
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u64
name|req
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
name|wpa_drv_p2p_sd_cancel_request
argument_list|(
name|wpa_s
argument_list|,
name|req
argument_list|)
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_sd_cancel_request
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|req
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_sd_response
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|resp_tlvs
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
block|{
name|wpa_drv_p2p_sd_response
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|dialog_token
argument_list|,
name|resp_tlvs
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|p2p_sd_response
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|dialog_token
argument_list|,
name|resp_tlvs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_sd_service_update
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
block|{
name|wpa_drv_p2p_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_sd_service_update
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_srv_bonjour_free
parameter_list|(
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
parameter_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|bsrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bsrv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_srv_upnp_free
parameter_list|(
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
parameter_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|usrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_service_flush
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|,
modifier|*
name|bn
decl_stmt|;
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|,
modifier|*
name|un
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|bsrv
argument_list|,
argument|bn
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
name|wpas_p2p_srv_bonjour_free
argument_list|(
name|bsrv
argument_list|)
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|usrv
argument_list|,
argument|un
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
name|wpas_p2p_srv_upnp_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_add_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|query
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|bsrv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bsrv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bsrv
operator|->
name|query
operator|=
name|query
expr_stmt|;
name|bsrv
operator|->
name|resp
operator|=
name|resp
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|,
operator|&
name|bsrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_del_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|bsrv
operator|=
name|wpas_p2p_service_get_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_p2p_srv_bonjour_free
argument_list|(
name|bsrv
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_add_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
if|if
condition|(
name|wpas_p2p_service_get_upnp
argument_list|(
name|wpa_s
argument_list|,
name|version
argument_list|,
name|service
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Already listed */
name|usrv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|usrv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|usrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|usrv
operator|->
name|version
operator|=
name|version
expr_stmt|;
name|usrv
operator|->
name|service
operator|=
name|os_strdup
argument_list|(
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|usrv
operator|->
name|service
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dl_list_add
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|,
operator|&
name|usrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_del_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|usrv
operator|=
name|wpas_p2p_service_get_upnp
argument_list|(
name|wpa_s
argument_list|,
name|version
argument_list|,
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|usrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_p2p_srv_upnp_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_prov_disc_local_display
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|,
name|unsigned
name|int
name|generated_pin
parameter_list|)
block|{
name|wpa_msg
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_PROV_DISC_SHOW_PIN MACSTR
literal|" %08d%s"
argument_list|,
argument|MAC2STR(peer)
argument_list|,
argument|generated_pin
argument_list|,
argument|params
argument_list|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_prov_disc_local_keypad
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|)
block|{
name|wpa_msg
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_PROV_DISC_ENTER_PIN MACSTR
literal|"%s"
argument_list|,
argument|MAC2STR(peer)
argument_list|,
argument|params
argument_list|)
empty_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_prov_disc_req
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|u16
name|config_methods
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|pri_dev_type
parameter_list|,
specifier|const
name|char
modifier|*
name|dev_name
parameter_list|,
name|u16
name|supp_config_methods
parameter_list|,
name|u8
name|dev_capab
parameter_list|,
name|u8
name|group_capab
parameter_list|,
specifier|const
name|u8
modifier|*
name|group_id
parameter_list|,
name|size_t
name|group_id_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|char
name|params
index|[
literal|300
index|]
decl_stmt|;
name|u8
name|empty_dev_type
index|[
literal|8
index|]
decl_stmt|;
name|unsigned
name|int
name|generated_pin
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|group
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|group_id
condition|)
block|{
for|for
control|(
name|group
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|group
condition|;
name|group
operator|=
name|group
operator|->
name|next
control|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
init|=
name|group
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
operator|&&
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
name|group_id_len
operator|-
name|ETH_ALEN
operator|==
name|s
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|group_id
operator|+
name|ETH_ALEN
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|pri_dev_type
operator|==
name|NULL
condition|)
block|{
name|os_memset
argument_list|(
name|empty_dev_type
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|empty_dev_type
argument_list|)
argument_list|)
expr_stmt|;
name|pri_dev_type
operator|=
name|empty_dev_type
expr_stmt|;
block|}
name|os_snprintf
argument_list|(
name|params
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|,
literal|" p2p_dev_addr="
name|MACSTR
literal|" pri_dev_type=%s name='%s' config_methods=0x%x "
literal|"dev_capab=0x%x group_capab=0x%x%s%s"
argument_list|,
name|MAC2STR
argument_list|(
name|dev_addr
argument_list|)
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|pri_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|,
name|dev_name
argument_list|,
name|supp_config_methods
argument_list|,
name|dev_capab
argument_list|,
name|group_capab
argument_list|,
name|group
condition|?
literal|" group="
else|:
literal|""
argument_list|,
name|group
condition|?
name|group
operator|->
name|ifname
else|:
literal|""
argument_list|)
expr_stmt|;
name|params
index|[
sizeof|sizeof
argument_list|(
name|params
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_DISPLAY
condition|)
block|{
name|generated_pin
operator|=
name|wps_generate_pin
argument_list|()
expr_stmt|;
name|wpas_prov_disc_local_display
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
name|params
argument_list|,
name|generated_pin
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_KEYPAD
condition|)
name|wpas_prov_disc_local_keypad
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
name|params
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_PUSHBUTTON
condition|)
name|wpa_msg
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_PROV_DISC_PBC_REQ MACSTR
literal|"%s"
argument_list|,
argument|MAC2STR(peer)
argument_list|,
argument|params
argument_list|)
empty_stmt|;
name|wpas_notify_p2p_provision_discovery
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
literal|1
comment|/* request */
argument_list|,
name|P2P_PROV_DISC_SUCCESS
argument_list|,
name|config_methods
argument_list|,
name|generated_pin
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_prov_disc_resp
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|u16
name|config_methods
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|unsigned
name|int
name|generated_pin
init|=
literal|0
decl_stmt|;
name|char
name|params
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_pd_before_join
operator|&&
operator|(
name|os_memcmp
argument_list|(
name|peer
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|||
name|os_memcmp
argument_list|(
name|peer
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Starting pending "
literal|"join-existing-group operation"
argument_list|)
expr_stmt|;
name|wpas_p2p_join_start
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|pending_pd_use
operator|==
name|AUTO_PD_JOIN
operator|||
name|wpa_s
operator|->
name|pending_pd_use
operator|==
name|AUTO_PD_GO_NEG
condition|)
name|os_snprintf
argument_list|(
name|params
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|,
literal|" peer_go=%d"
argument_list|,
name|wpa_s
operator|->
name|pending_pd_use
operator|==
name|AUTO_PD_JOIN
argument_list|)
expr_stmt|;
else|else
name|params
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_DISPLAY
condition|)
name|wpas_prov_disc_local_keypad
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
name|params
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_KEYPAD
condition|)
block|{
name|generated_pin
operator|=
name|wps_generate_pin
argument_list|()
expr_stmt|;
name|wpas_prov_disc_local_display
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
name|params
argument_list|,
name|generated_pin
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_PUSHBUTTON
condition|)
name|wpa_msg
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_PROV_DISC_PBC_RESP MACSTR
literal|"%s"
argument_list|,
argument|MAC2STR(peer)
argument_list|,
argument|params
argument_list|)
empty_stmt|;
name|wpas_notify_p2p_provision_discovery
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
literal|0
comment|/* response */
argument_list|,
name|P2P_PROV_DISC_SUCCESS
argument_list|,
name|config_methods
argument_list|,
name|generated_pin
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_prov_disc_fail
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|enum
name|p2p_prov_disc_status
name|status
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: PD for p2p_connect-auto "
literal|"failed - fall back to GO Negotiation"
argument_list|)
expr_stmt|;
name|wpas_p2p_fallback_to_go_neg
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
operator|==
name|P2P_PROV_DISC_TIMEOUT_JOIN
condition|)
block|{
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Starting pending "
literal|"join-existing-group operation (no ACK for PD "
literal|"Req attempts)"
argument_list|)
expr_stmt|;
name|wpas_p2p_join_start
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_PROV_DISC_FAILURE
literal|" p2p_dev_addr="
name|MACSTR
literal|" status=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|wpas_notify_p2p_provision_discovery
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
literal|0
comment|/* response */
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u8
name|wpas_invitation_process
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
name|int
modifier|*
name|go
parameter_list|,
name|u8
modifier|*
name|group_bssid
parameter_list|,
name|int
modifier|*
name|force_freq
parameter_list|,
name|int
name|persistent_group
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|u8
name|cur_bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|grp
decl_stmt|;
if|if
condition|(
operator|!
name|persistent_group
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invitation from "
name|MACSTR
literal|" to join an active group"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|)
operator|&&
operator|(
name|os_memcmp
argument_list|(
name|go_dev_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|||
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Accept previously "
literal|"authorized invitation"
argument_list|)
expr_stmt|;
goto|goto
name|accept_inv
goto|;
block|}
comment|/* 		 * Do not accept the invitation automatically; notify user and 		 * request approval. 		 */
return|return
name|P2P_SC_FAIL_INFO_CURRENTLY_UNAVAILABLE
return|;
block|}
name|grp
operator|=
name|wpas_get_p2p_group
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|,
name|go
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Accept invitation to already "
literal|"running persistent group"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|go
condition|)
name|os_memcpy
argument_list|(
name|group_bssid
argument_list|,
name|grp
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
goto|goto
name|accept_inv
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|persistent_reconnect
condition|)
return|return
name|P2P_SC_FAIL_INFO_CURRENTLY_UNAVAILABLE
return|;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|==
literal|2
operator|&&
name|os_memcmp
argument_list|(
name|s
operator|->
name|bssid
argument_list|,
name|go_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|s
operator|->
name|ssid_len
operator|==
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|s
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invitation from "
name|MACSTR
literal|" requested reinvocation of an unknown group"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|P2P_SC_FAIL_UNKNOWN_GROUP
return|;
block|}
if|if
condition|(
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
operator|!
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
operator|*
name|go
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_AUTHENTICATING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: The only available "
literal|"interface is already in use - reject "
literal|"invitation"
argument_list|)
expr_stmt|;
return|return
name|P2P_SC_FAIL_UNABLE_TO_ACCOMMODATE
return|;
block|}
name|os_memcpy
argument_list|(
name|group_bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
operator|*
name|go
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|WPA_IF_P2P_GO
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to allocate a new "
literal|"interface address for the group"
argument_list|)
expr_stmt|;
return|return
name|P2P_SC_FAIL_UNABLE_TO_ACCOMMODATE
return|;
block|}
name|os_memcpy
argument_list|(
name|group_bssid
argument_list|,
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|accept_inv
label|:
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|cur_bssid
argument_list|)
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|assoc_freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Trying to force channel to match "
literal|"the channel we are already using"
argument_list|)
expr_stmt|;
operator|*
name|force_freq
operator|=
name|wpa_s
operator|->
name|assoc_freq
expr_stmt|;
block|}
name|res
operator|=
name|wpa_drv_shared_freq
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Trying to force channel to match "
literal|"with the channel we are already using on a "
literal|"shared interface"
argument_list|)
expr_stmt|;
operator|*
name|force_freq
operator|=
name|res
expr_stmt|;
block|}
return|return
name|P2P_SC_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_invitation_received
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
name|u8
name|status
parameter_list|,
name|int
name|op_freq
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|==
literal|2
operator|&&
name|s
operator|->
name|ssid_len
operator|==
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|status
operator|==
name|P2P_SC_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invitation from peer "
name|MACSTR
literal|" was accepted; op_freq=%d MHz"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|op_freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
name|int
name|go
init|=
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
decl_stmt|;
name|wpas_p2p_group_add_persistent
argument_list|(
name|wpa_s
argument_list|,
name|s
argument_list|,
name|go
argument_list|,
name|go
condition|?
name|op_freq
else|:
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bssid
condition|)
block|{
name|wpa_s
operator|->
name|user_initiated_pd
operator|=
literal|0
expr_stmt|;
name|wpas_p2p_join
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|,
name|go_dev_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_wps_method
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|status
operator|!=
name|P2P_SC_FAIL_INFO_CURRENTLY_UNAVAILABLE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invitation from peer "
name|MACSTR
literal|" was rejected (status %u)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|s
condition|)
block|{
if|if
condition|(
name|bssid
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RECEIVED
literal|"sa="
name|MACSTR
literal|" go_dev_addr="
name|MACSTR
literal|" bssid="
name|MACSTR
literal|" unknown-network"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RECEIVED
literal|"sa="
name|MACSTR
literal|" go_dev_addr="
name|MACSTR
literal|" unknown-network"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RECEIVED
literal|"sa="
name|MACSTR
literal|" persistent=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|s
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_invitation_result
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|status
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
name|bssid
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RESULT
literal|"status=%d "
name|MACSTR
argument_list|,
name|status
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RESULT
literal|"status=%d "
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
name|wpas_notify_p2p_invitation_result
argument_list|(
name|wpa_s
argument_list|,
name|status
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_invite_ssid_id
operator|==
operator|-
literal|1
condition|)
return|return;
comment|/* Invitation to active group */
if|if
condition|(
name|status
operator|!=
name|P2P_SC_SUCCESS
condition|)
block|{
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|wpa_s
operator|->
name|pending_invite_ssid_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Could not find persistent group "
literal|"data matching with invitation"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * The peer could have missed our ctrl::ack frame for Invitation 	 * Response and continue retransmitting the frame. To reduce the 	 * likelihood of the peer not getting successful TX status for the 	 * Invitation Response frame, wait a short time here before starting 	 * the persistent group so that we will remain on the current channel to 	 * acknowledge any possible retransmission from the peer. 	 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: 50 ms wait on current channel before "
literal|"starting persistent group"
argument_list|)
expr_stmt|;
name|os_sleep
argument_list|(
literal|0
argument_list|,
literal|50000
argument_list|)
expr_stmt|;
name|wpas_p2p_group_add_persistent
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_go_freq
argument_list|,
name|wpa_s
operator|->
name|p2p_go_ht40
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_disallowed_freq
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|global
operator|->
name|p2p_disallow_freq
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|global
operator|->
name|num_p2p_disallow_freq
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|freq
operator|>=
name|global
operator|->
name|p2p_disallow_freq
index|[
name|i
index|]
operator|.
name|min
operator|&&
name|freq
operator|<=
name|global
operator|->
name|p2p_disallow_freq
index|[
name|i
index|]
operator|.
name|max
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_add_chan
parameter_list|(
name|struct
name|p2p_reg_class
modifier|*
name|reg
parameter_list|,
name|u8
name|chan
parameter_list|)
block|{
name|reg
operator|->
name|channel
index|[
name|reg
operator|->
name|channels
index|]
operator|=
name|chan
expr_stmt|;
name|reg
operator|->
name|channels
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_default_channels
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_channels
modifier|*
name|chan
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cla
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Enable operating classes for 2.4 GHz "
literal|"band"
argument_list|)
expr_stmt|;
comment|/* Operating class 81 - 2.4 GHz band channels 1..13 */
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|reg_class
operator|=
literal|81
expr_stmt|;
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|11
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|2412
operator|+
name|i
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
condition|)
name|cla
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Enable operating classes for lower 5 GHz "
literal|"band"
argument_list|)
expr_stmt|;
comment|/* Operating class 115 - 5 GHz, channels 36-48 */
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|reg_class
operator|=
literal|115
expr_stmt|;
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|36
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|36
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|40
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|40
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|44
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|44
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|48
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|48
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
condition|)
name|cla
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Enable operating classes for higher 5 GHz "
literal|"band"
argument_list|)
expr_stmt|;
comment|/* Operating class 124 - 5 GHz, channels 149,153,157,161 */
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|reg_class
operator|=
literal|124
expr_stmt|;
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|149
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|149
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|153
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|153
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|156
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|157
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|161
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|161
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
condition|)
name|cla
operator|++
expr_stmt|;
name|chan
operator|->
name|reg_classes
operator|=
name|cla
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_hw_modes
modifier|*
name|get_mode
parameter_list|(
name|struct
name|hostapd_hw_modes
modifier|*
name|modes
parameter_list|,
name|u16
name|num_modes
parameter_list|,
name|enum
name|hostapd_hw_mode
name|mode
parameter_list|)
block|{
name|u16
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|modes
index|[
name|i
index|]
operator|.
name|mode
operator|==
name|mode
condition|)
return|return
operator|&
name|modes
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|has_channel
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|,
name|u8
name|chan
parameter_list|,
name|int
modifier|*
name|flags
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|unsigned
name|int
name|freq
decl_stmt|;
name|freq
operator|=
operator|(
name|mode
operator|->
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211A
condition|?
literal|5000
else|:
literal|2407
operator|)
operator|+
name|chan
operator|*
literal|5
expr_stmt|;
if|if
condition|(
name|wpas_p2p_disallowed_freq
argument_list|(
name|global
argument_list|,
name|freq
argument_list|)
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mode
operator|->
name|num_channels
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mode
operator|->
name|channels
index|[
name|i
index|]
operator|.
name|chan
operator|==
name|chan
condition|)
block|{
if|if
condition|(
name|flags
condition|)
operator|*
name|flags
operator|=
name|mode
operator|->
name|channels
index|[
name|i
index|]
operator|.
name|flag
expr_stmt|;
return|return
operator|!
operator|(
name|mode
operator|->
name|channels
index|[
name|i
index|]
operator|.
name|flag
operator|&
operator|(
name|HOSTAPD_CHAN_DISABLED
operator||
name|HOSTAPD_CHAN_PASSIVE_SCAN
operator||
name|HOSTAPD_CHAN_NO_IBSS
operator||
name|HOSTAPD_CHAN_RADAR
operator|)
operator|)
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|p2p_oper_class_map
block|{
name|enum
name|hostapd_hw_mode
name|mode
decl_stmt|;
name|u8
name|op_class
decl_stmt|;
name|u8
name|min_chan
decl_stmt|;
name|u8
name|max_chan
decl_stmt|;
name|u8
name|inc
decl_stmt|;
enum|enum
block|{
name|BW20
block|,
name|BW40PLUS
block|,
name|BW40MINUS
block|}
name|bw
enum|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|p2p_oper_class_map
name|op_class
index|[]
init|=
block|{
block|{
name|HOSTAPD_MODE_IEEE80211G
block|,
literal|81
block|,
literal|1
block|,
literal|13
block|,
literal|1
block|,
name|BW20
block|}
block|,
if|#
directive|if
literal|0
comment|/* Do not enable HT40 on 2 GHz for now */
block|{ HOSTAPD_MODE_IEEE80211G, 83, 1, 9, 1, BW40PLUS }, 	{ HOSTAPD_MODE_IEEE80211G, 84, 5, 13, 1, BW40MINUS },
endif|#
directive|endif
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|115
block|,
literal|36
block|,
literal|48
block|,
literal|4
block|,
name|BW20
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|124
block|,
literal|149
block|,
literal|161
block|,
literal|4
block|,
name|BW20
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|116
block|,
literal|36
block|,
literal|44
block|,
literal|8
block|,
name|BW40PLUS
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|117
block|,
literal|40
block|,
literal|48
block|,
literal|8
block|,
name|BW40MINUS
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|126
block|,
literal|149
block|,
literal|157
block|,
literal|8
block|,
name|BW40PLUS
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|127
block|,
literal|153
block|,
literal|161
block|,
literal|8
block|,
name|BW40MINUS
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|BW20
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|wpas_p2p_verify_channel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|,
name|u8
name|channel
parameter_list|,
name|u8
name|bw
parameter_list|)
block|{
name|int
name|flag
decl_stmt|;
if|if
condition|(
operator|!
name|has_channel
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|mode
argument_list|,
name|channel
argument_list|,
operator|&
name|flag
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bw
operator|==
name|BW40MINUS
operator|&&
operator|(
operator|!
operator|(
name|flag
operator|&
name|HOSTAPD_CHAN_HT40MINUS
operator|)
operator|||
operator|!
name|has_channel
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|mode
argument_list|,
name|channel
operator|-
literal|4
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|bw
operator|==
name|BW40PLUS
operator|&&
operator|(
operator|!
operator|(
name|flag
operator|&
name|HOSTAPD_CHAN_HT40PLUS
operator|)
operator|||
operator|!
name|has_channel
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|mode
argument_list|,
name|channel
operator|+
literal|4
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_setup_channels
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_channels
modifier|*
name|chan
parameter_list|)
block|{
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
decl_stmt|;
name|int
name|cla
decl_stmt|,
name|op
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|hw
operator|.
name|modes
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Driver did not support fetching "
literal|"of all supported channels; assume dualband "
literal|"support"
argument_list|)
expr_stmt|;
return|return
name|wpas_p2p_default_channels
argument_list|(
name|wpa_s
argument_list|,
name|chan
argument_list|)
return|;
block|}
name|cla
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|op
operator|=
literal|0
init|;
name|op_class
index|[
name|op
index|]
operator|.
name|op_class
condition|;
name|op
operator|++
control|)
block|{
name|struct
name|p2p_oper_class_map
modifier|*
name|o
init|=
operator|&
name|op_class
index|[
name|op
index|]
decl_stmt|;
name|u8
name|ch
decl_stmt|;
name|struct
name|p2p_reg_class
modifier|*
name|reg
init|=
name|NULL
decl_stmt|;
name|mode
operator|=
name|get_mode
argument_list|(
name|wpa_s
operator|->
name|hw
operator|.
name|modes
argument_list|,
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
argument_list|,
name|o
operator|->
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
name|ch
operator|=
name|o
operator|->
name|min_chan
init|;
name|ch
operator|<=
name|o
operator|->
name|max_chan
condition|;
name|ch
operator|+=
name|o
operator|->
name|inc
control|)
block|{
if|if
condition|(
name|wpas_p2p_verify_channel
argument_list|(
name|wpa_s
argument_list|,
name|mode
argument_list|,
name|ch
argument_list|,
name|o
operator|->
name|bw
argument_list|)
operator|<
literal|1
condition|)
continue|continue;
if|if
condition|(
name|reg
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add operating "
literal|"class %u"
argument_list|,
name|o
operator|->
name|op_class
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
expr_stmt|;
name|cla
operator|++
expr_stmt|;
name|reg
operator|->
name|reg_class
operator|=
name|o
operator|->
name|op_class
expr_stmt|;
block|}
name|reg
operator|->
name|channel
index|[
name|reg
operator|->
name|channels
index|]
operator|=
name|ch
expr_stmt|;
name|reg
operator|->
name|channels
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|reg
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Channels"
argument_list|,
name|reg
operator|->
name|channel
argument_list|,
name|reg
operator|->
name|channels
argument_list|)
expr_stmt|;
block|}
block|}
name|chan
operator|->
name|reg_classes
operator|=
name|cla
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_get_ht40_mode
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|,
name|u8
name|channel
parameter_list|)
block|{
name|int
name|op
decl_stmt|,
name|ret
decl_stmt|;
for|for
control|(
name|op
operator|=
literal|0
init|;
name|op_class
index|[
name|op
index|]
operator|.
name|op_class
condition|;
name|op
operator|++
control|)
block|{
name|struct
name|p2p_oper_class_map
modifier|*
name|o
init|=
operator|&
name|op_class
index|[
name|op
index|]
decl_stmt|;
name|u8
name|ch
decl_stmt|;
for|for
control|(
name|ch
operator|=
name|o
operator|->
name|min_chan
init|;
name|ch
operator|<=
name|o
operator|->
name|max_chan
condition|;
name|ch
operator|+=
name|o
operator|->
name|inc
control|)
block|{
if|if
condition|(
name|o
operator|->
name|mode
operator|!=
name|HOSTAPD_MODE_IEEE80211A
operator|||
name|o
operator|->
name|bw
operator|==
name|BW20
operator|||
name|ch
operator|!=
name|channel
condition|)
continue|continue;
name|ret
operator|=
name|wpas_p2p_verify_channel
argument_list|(
name|wpa_s
argument_list|,
name|mode
argument_list|,
name|ch
argument_list|,
name|o
operator|->
name|bw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
continue|continue;
elseif|else
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
return|return
operator|(
name|o
operator|->
name|bw
operator|==
name|BW40MINUS
operator|)
condition|?
operator|-
literal|1
else|:
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_get_noa
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|interface_addr
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|interface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpa_drv_get_noa
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_go_connected
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
condition|)
continue|continue;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
operator|&&
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_GROUP_HANDSHAKE
condition|)
continue|continue;
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|go_dev_addr
argument_list|,
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_init - Initialize P2P module for %wpa_supplicant  * @global: Pointer to global data from wpa_supplicant_init()  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|wpas_p2p_init
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|p2p_config
name|p2p
decl_stmt|;
name|unsigned
name|int
name|r
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_CAPABLE
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|global
operator|->
name|p2p
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
block|{
name|struct
name|p2p_params
name|params
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use driver-based P2P management"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|dev_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
expr_stmt|;
name|os_memcpy
argument_list|(
name|params
operator|.
name|pri_dev_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|params
operator|.
name|num_sec_dev_types
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|num_sec_device_types
expr_stmt|;
name|os_memcpy
argument_list|(
name|params
operator|.
name|sec_dev_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|sec_device_type
argument_list|,
name|params
operator|.
name|num_sec_dev_types
operator|*
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_p2p_set_params
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|p2p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p2p
argument_list|)
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|msg_ctx
operator|=
name|wpa_s
expr_stmt|;
name|p2p
operator|.
name|cb_ctx
operator|=
name|wpa_s
expr_stmt|;
name|p2p
operator|.
name|p2p_scan
operator|=
name|wpas_p2p_scan
expr_stmt|;
name|p2p
operator|.
name|send_action
operator|=
name|wpas_send_action
expr_stmt|;
name|p2p
operator|.
name|send_action_done
operator|=
name|wpas_send_action_done
expr_stmt|;
name|p2p
operator|.
name|go_neg_completed
operator|=
name|wpas_go_neg_completed
expr_stmt|;
name|p2p
operator|.
name|go_neg_req_rx
operator|=
name|wpas_go_neg_req_rx
expr_stmt|;
name|p2p
operator|.
name|dev_found
operator|=
name|wpas_dev_found
expr_stmt|;
name|p2p
operator|.
name|dev_lost
operator|=
name|wpas_dev_lost
expr_stmt|;
name|p2p
operator|.
name|start_listen
operator|=
name|wpas_start_listen
expr_stmt|;
name|p2p
operator|.
name|stop_listen
operator|=
name|wpas_stop_listen
expr_stmt|;
name|p2p
operator|.
name|send_probe_resp
operator|=
name|wpas_send_probe_resp
expr_stmt|;
name|p2p
operator|.
name|sd_request
operator|=
name|wpas_sd_request
expr_stmt|;
name|p2p
operator|.
name|sd_response
operator|=
name|wpas_sd_response
expr_stmt|;
name|p2p
operator|.
name|prov_disc_req
operator|=
name|wpas_prov_disc_req
expr_stmt|;
name|p2p
operator|.
name|prov_disc_resp
operator|=
name|wpas_prov_disc_resp
expr_stmt|;
name|p2p
operator|.
name|prov_disc_fail
operator|=
name|wpas_prov_disc_fail
expr_stmt|;
name|p2p
operator|.
name|invitation_process
operator|=
name|wpas_invitation_process
expr_stmt|;
name|p2p
operator|.
name|invitation_received
operator|=
name|wpas_invitation_received
expr_stmt|;
name|p2p
operator|.
name|invitation_result
operator|=
name|wpas_invitation_result
expr_stmt|;
name|p2p
operator|.
name|get_noa
operator|=
name|wpas_get_noa
expr_stmt|;
name|p2p
operator|.
name|go_connected
operator|=
name|wpas_go_connected
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|dev_addr
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|dev_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
expr_stmt|;
name|p2p
operator|.
name|manufacturer
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|manufacturer
expr_stmt|;
name|p2p
operator|.
name|model_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|model_name
expr_stmt|;
name|p2p
operator|.
name|model_number
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|model_number
expr_stmt|;
name|p2p
operator|.
name|serial_number
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|serial_number
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps
condition|)
block|{
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|uuid
argument_list|,
name|wpa_s
operator|->
name|wps
operator|->
name|uuid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|config_methods
operator|=
name|wpa_s
operator|->
name|wps
operator|->
name|config_methods
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_reg_class
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_channel
condition|)
block|{
name|p2p
operator|.
name|reg_class
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_reg_class
expr_stmt|;
name|p2p
operator|.
name|channel
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_channel
expr_stmt|;
block|}
else|else
block|{
name|p2p
operator|.
name|reg_class
operator|=
literal|81
expr_stmt|;
comment|/* 		 * Pick one of the social channels randomly as the listen 		 * channel. 		 */
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|channel
operator|=
literal|1
operator|+
operator|(
name|r
operator|%
literal|3
operator|)
operator|*
literal|5
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Own listen channel: %d"
argument_list|,
name|p2p
operator|.
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
condition|)
block|{
name|p2p
operator|.
name|op_reg_class
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
expr_stmt|;
name|p2p
operator|.
name|op_channel
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
expr_stmt|;
name|p2p
operator|.
name|cfg_op_channel
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Configured operating channel: "
literal|"%d:%d"
argument_list|,
name|p2p
operator|.
name|op_reg_class
argument_list|,
name|p2p
operator|.
name|op_channel
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p2p
operator|.
name|op_reg_class
operator|=
literal|81
expr_stmt|;
comment|/* 		 * Use random operation channel from (1, 6, 11) if no other 		 * preference is indicated. 		 */
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|op_channel
operator|=
literal|1
operator|+
operator|(
name|r
operator|%
literal|3
operator|)
operator|*
literal|5
expr_stmt|;
name|p2p
operator|.
name|cfg_op_channel
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Random operating channel: "
literal|"%d:%d"
argument_list|,
name|p2p
operator|.
name|op_reg_class
argument_list|,
name|p2p
operator|.
name|op_channel
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
condition|)
block|{
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|country
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|country
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|country
index|[
literal|2
index|]
operator|=
literal|0x04
expr_stmt|;
block|}
else|else
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|country
argument_list|,
literal|"XX\x04"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpas_p2p_setup_channels
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|p2p
operator|.
name|channels
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to configure supported "
literal|"channel list"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|pri_dev_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|num_sec_dev_types
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|num_sec_device_types
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|sec_dev_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|sec_device_type
argument_list|,
name|p2p
operator|.
name|num_sec_dev_types
operator|*
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|concurrent_operations
operator|=
operator|!
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_CONCURRENT
operator|)
expr_stmt|;
name|p2p
operator|.
name|max_peers
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
condition|)
block|{
name|p2p
operator|.
name|ssid_postfix_len
operator|=
name|os_strlen
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|.
name|ssid_postfix_len
operator|>
sizeof|sizeof
argument_list|(
name|p2p
operator|.
name|ssid_postfix
argument_list|)
condition|)
name|p2p
operator|.
name|ssid_postfix_len
operator|=
sizeof|sizeof
argument_list|(
name|p2p
operator|.
name|ssid_postfix
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|ssid_postfix
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
argument_list|,
name|p2p
operator|.
name|ssid_postfix_len
argument_list|)
expr_stmt|;
block|}
name|p2p
operator|.
name|p2p_intra_bss
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_intra_bss
expr_stmt|;
name|p2p
operator|.
name|max_listen
operator|=
name|wpa_s
operator|->
name|max_remain_on_chan
expr_stmt|;
name|global
operator|->
name|p2p
operator|=
name|p2p_init
argument_list|(
operator|&
name|p2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|global
operator|->
name|p2p_init_wpa_s
operator|=
name|wpa_s
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_WPS_VENDOR_EXT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|p2p_add_wps_vendor_extension
argument_list|(
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_deinit - Deinitialize per-interface P2P data  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  *  * This function deinitialize per-interface P2P data.  */
end_comment

begin_function
name|void
name|wpas_p2p_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|driver
operator|&&
name|wpa_s
operator|->
name|drv_priv
condition|)
name|wpa_drv_probe_req_report
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|go_params
condition|)
block|{
comment|/* Clear any stored provisioning info */
name|p2p_clear_provisioning_info
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|go_params
operator|->
name|peer_device_addr
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wpa_s
operator|->
name|go_params
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|go_params
operator|=
name|NULL
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
comment|/* TODO: remove group interface from the driver if this wpa_s instance 	 * is on top of a P2P group interface */
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_deinit_global - Deinitialize global P2P module  * @global: Pointer to global data from wpa_supplicant_init()  *  * This function deinitializes the global (per device) P2P module.  */
end_comment

begin_function
name|void
name|wpas_p2p_deinit_global
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
if|if
condition|(
name|wpa_s
condition|)
name|wpas_p2p_service_flush
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
comment|/* Remove remaining P2P group interfaces */
while|while
condition|(
name|wpa_s
operator|&&
name|wpa_s
operator|->
name|p2p_group_interface
operator|!=
name|NOT_P2P_GROUP_INTERFACE
condition|)
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
while|while
condition|(
name|wpa_s
condition|)
block|{
name|tmp
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
while|while
condition|(
name|tmp
operator|&&
operator|(
name|tmp
operator|==
name|wpa_s
operator|||
name|tmp
operator|->
name|p2p_group_interface
operator|==
name|NOT_P2P_GROUP_INTERFACE
operator|)
condition|)
block|{
name|tmp
operator|=
name|tmp
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
break|break;
comment|/* Disconnect from the P2P group and deinit the interface */
name|wpas_p2p_disconnect
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Deinit GO data on any possibly remaining interface (if main 	 * interface is used as GO). 	 */
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
name|wpas_p2p_group_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
name|p2p_deinit
argument_list|(
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|global
operator|->
name|p2p
operator|=
name|NULL
expr_stmt|;
name|global
operator|->
name|p2p_init_wpa_s
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_create_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_no_group_iface
condition|)
return|return
literal|0
return|;
comment|/* separate interface disabled per configuration */
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
operator|(
name|WPA_DRIVER_FLAGS_P2P_DEDICATED_INTERFACE
operator||
name|WPA_DRIVER_FLAGS_P2P_MGMT_AND_NON_P2P
operator|)
condition|)
return|return
literal|1
return|;
comment|/* P2P group requires a new interface in every case 			   */
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_CONCURRENT
operator|)
condition|)
return|return
literal|0
return|;
comment|/* driver does not support concurrent operations */
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
operator|->
name|next
condition|)
return|return
literal|1
return|;
comment|/* more that one interface already in use */
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_AUTHENTICATING
condition|)
return|return
literal|1
return|;
comment|/* this interface is already in use */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_start_go_neg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|,
name|int
name|go_intent
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_interface_addr
parameter_list|,
name|unsigned
name|int
name|force_freq
parameter_list|,
name|int
name|persistent_group
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|unsigned
name|int
name|pref_freq
parameter_list|)
block|{
if|if
condition|(
name|persistent_group
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|persistent_reconnect
condition|)
name|persistent_group
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
block|{
return|return
name|wpa_drv_p2p_connect
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|,
name|wps_method
argument_list|,
name|go_intent
argument_list|,
name|own_interface_addr
argument_list|,
name|force_freq
argument_list|,
name|persistent_group
argument_list|)
return|;
block|}
comment|/* 	 * Increase GO config timeout if HT40 is used since it takes some time 	 * to scan channels for coex purposes before the BSS can be started. 	 */
name|p2p_set_config_timeout
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|p2p_go_ht40
condition|?
literal|255
else|:
literal|100
argument_list|,
literal|20
argument_list|)
expr_stmt|;
return|return
name|p2p_connect
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|wps_method
argument_list|,
name|go_intent
argument_list|,
name|own_interface_addr
argument_list|,
name|force_freq
argument_list|,
name|persistent_group
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid
else|:
name|NULL
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid_len
else|:
literal|0
argument_list|,
name|wpa_s
operator|->
name|p2p_pd_before_go_neg
argument_list|,
name|pref_freq
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_auth_go_neg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|,
name|int
name|go_intent
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_interface_addr
parameter_list|,
name|unsigned
name|int
name|force_freq
parameter_list|,
name|int
name|persistent_group
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|unsigned
name|int
name|pref_freq
parameter_list|)
block|{
if|if
condition|(
name|persistent_group
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|persistent_reconnect
condition|)
name|persistent_group
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_authorize
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|wps_method
argument_list|,
name|go_intent
argument_list|,
name|own_interface_addr
argument_list|,
name|force_freq
argument_list|,
name|persistent_group
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid
else|:
name|NULL
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid_len
else|:
literal|0
argument_list|,
name|pref_freq
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_check_join_scan_limit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|p2p_join_scan_count
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Join scan attempt %d"
argument_list|,
name|wpa_s
operator|->
name|p2p_join_scan_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_join_scan_count
operator|>
name|P2P_MAX_JOIN_SCAN_ATTEMPTS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to find GO "
name|MACSTR
literal|" for join operationg - stop join attempt"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_auto_pd
condition|)
block|{
name|wpa_s
operator|->
name|p2p_auto_pd
operator|=
literal|0
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_PROV_DISC_FAILURE
literal|" p2p_dev_addr="
name|MACSTR
literal|" status=N/A"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_FORMATION_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_check_freq_conflict
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
name|int
name|shared_freq
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_MULTI_CHANNEL_CONCURRENT
condition|)
return|return
literal|0
return|;
for|for
control|(
name|iface
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
operator|&&
name|iface
operator|==
name|wpa_s
condition|)
continue|continue;
if|if
condition|(
name|iface
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
name|iface
operator|->
name|assoc_freq
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|iface
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_AP
operator|||
name|iface
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
name|shared_freq
operator|=
name|iface
operator|->
name|current_ssid
operator|->
name|frequency
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_drv_get_bssid
argument_list|(
name|iface
argument_list|,
name|bssid
argument_list|)
operator|==
literal|0
condition|)
name|shared_freq
operator|=
name|iface
operator|->
name|assoc_freq
expr_stmt|;
else|else
name|shared_freq
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|shared_freq
operator|&&
name|freq
operator|!=
name|shared_freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Frequency conflict - %s "
literal|"connected on %d MHz - new connection on "
literal|"%d MHz"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
name|shared_freq
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
name|shared_freq
operator|=
name|wpa_drv_shared_freq
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|shared_freq
operator|>
literal|0
operator|&&
name|shared_freq
operator|!=
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Frequency conflict - shared "
literal|"virtual interface connected on %d MHz - new "
literal|"connection on %d MHz"
argument_list|,
name|shared_freq
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_peer_go
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_dev_addr
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|updated
decl_stmt|;
name|bss
operator|=
name|wpa_bss_get_p2p_dev_addr
argument_list|(
name|wpa_s
argument_list|,
name|peer_dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bss
operator|->
name|last_update_idx
operator|<
name|wpa_s
operator|->
name|bss_update_idx
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer BSS entry not updated in the "
literal|"last scan"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|updated
operator|=
name|os_time_before
argument_list|(
operator|&
name|wpa_s
operator|->
name|p2p_auto_started
argument_list|,
operator|&
name|bss
operator|->
name|last_update
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Current BSS entry for peer updated at "
literal|"%ld.%06ld (%supdated in last scan)"
argument_list|,
name|bss
operator|->
name|last_update
operator|.
name|sec
argument_list|,
name|bss
operator|->
name|last_update
operator|.
name|usec
argument_list|,
name|updated
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
return|return
name|updated
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_scan_res_join
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|u8
name|iface_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Scan results received (%d BSS) for %sjoin"
argument_list|,
name|scan_res
condition|?
operator|(
name|int
operator|)
name|scan_res
operator|->
name|num
else|:
operator|-
literal|1
argument_list|,
name|wpa_s
operator|->
name|p2p_auto_join
condition|?
literal|"auto_"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|scan_res
condition|)
name|wpas_p2p_scan_res_handler
argument_list|(
name|wpa_s
argument_list|,
name|scan_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_auto_pd
condition|)
block|{
name|int
name|join
init|=
name|wpas_p2p_peer_go
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|join
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|auto_pd_scan_retry
operator|<
name|P2P_AUTO_PD_SCAN_ATTEMPTS
condition|)
block|{
name|wpa_s
operator|->
name|auto_pd_scan_retry
operator|++
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Scan retry %d for "
literal|"the peer "
name|MACSTR
literal|" at %d MHz"
argument_list|,
name|wpa_s
operator|->
name|auto_pd_scan_retry
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|wpas_p2p_join_scan_req
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|join
operator|<
literal|0
condition|)
name|join
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_auto_pd
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_use
operator|=
name|join
condition|?
name|AUTO_PD_JOIN
else|:
name|AUTO_PD_GO_NEG
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Auto PD with "
name|MACSTR
literal|" join=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|,
name|join
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_prov_disc_req
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|wpa_s
operator|->
name|pending_pd_config_methods
argument_list|,
name|join
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|user_initiated_pd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|p2p_auto_pd
operator|=
literal|0
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_PROV_DISC_FAILURE
literal|" p2p_dev_addr="
name|MACSTR
literal|" status=N/A"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_auto_join
condition|)
block|{
name|int
name|join
init|=
name|wpas_p2p_peer_go
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|join
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer was not found to be "
literal|"running a GO -> use GO Negotiation"
argument_list|)
expr_stmt|;
name|wpas_p2p_connect
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
name|wpa_s
operator|->
name|p2p_wps_method
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_group
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|p2p_go_intent
argument_list|,
name|wpa_s
operator|->
name|p2p_connect_freq
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_id
argument_list|,
name|wpa_s
operator|->
name|p2p_pd_before_go_neg
argument_list|,
name|wpa_s
operator|->
name|p2p_go_ht40
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer was found running GO%s -> "
literal|"try to join the group"
argument_list|,
name|join
condition|?
literal|""
else|:
literal|" in older scan"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|join
condition|)
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
operator|=
literal|1
expr_stmt|;
block|}
name|freq
operator|=
name|p2p_get_oper_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|<
literal|0
operator|&&
name|p2p_get_interface_addr
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|iface_addr
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|iface_addr
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Overwrite pending interface "
literal|"address for join from "
name|MACSTR
literal|" to "
name|MACSTR
literal|" based on newly discovered P2P peer entry"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|iface_addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|iface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|freq
operator|=
name|p2p_get_oper_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|freq
operator|>=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Target GO operating frequency "
literal|"from P2P peer table: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
name|bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Target GO operating frequency "
literal|"from BSS table: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|freq
operator|>
literal|0
condition|)
block|{
name|u16
name|method
decl_stmt|;
if|if
condition|(
name|wpas_check_freq_conflict
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_FORMATION_FAILURE
literal|"reason=FREQ_CONFLICT"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Send Provision Discovery Request "
literal|"prior to joining an existing group (GO "
name|MACSTR
literal|" freq=%u MHz)"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|wpa_s
operator|->
name|pending_join_wps_method
condition|)
block|{
case|case
name|WPS_PIN_DISPLAY
case|:
name|method
operator|=
name|WPS_CONFIG_KEYPAD
expr_stmt|;
break|break;
case|case
name|WPS_PIN_KEYPAD
case|:
name|method
operator|=
name|WPS_CONFIG_DISPLAY
expr_stmt|;
break|break;
case|case
name|WPS_PBC
case|:
name|method
operator|=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
break|break;
default|default:
name|method
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|p2p_get_provisioning_info
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
operator|==
name|method
operator|)
condition|)
block|{
comment|/* 			 * We have already performed provision discovery for 			 * joining the group. Proceed directly to join 			 * operation without duplicated provision discovery. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Provision discovery "
literal|"with "
name|MACSTR
literal|" already done - proceed to "
literal|"join"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
goto|goto
name|start
goto|;
block|}
if|if
condition|(
name|p2p_prov_disc_req
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|method
argument_list|,
literal|1
argument_list|,
name|freq
argument_list|,
name|wpa_s
operator|->
name|user_initiated_pd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to send Provision "
literal|"Discovery Request before joining an "
literal|"existing group"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
goto|goto
name|start
goto|;
block|}
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to find BSS/GO - try again later"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_p2p_check_join_scan_limit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
name|start
label|:
comment|/* Start join operation immediately */
name|wpas_p2p_join_start
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_join_scan_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|wpa_driver_scan_params
name|params
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|,
modifier|*
name|ies
decl_stmt|;
name|size_t
name|ielen
decl_stmt|;
name|int
name|freqs
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
comment|/* P2P Wildcard SSID */
name|params
operator|.
name|num_ssids
operator|=
literal|1
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
operator|=
operator|(
name|u8
operator|*
operator|)
name|P2P_WILDCARD_SSID
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
operator|=
name|P2P_WILDCARD_SSID_LEN
expr_stmt|;
name|wpa_s
operator|->
name|wps
operator|->
name|dev
operator|.
name|p2p
operator|=
literal|1
expr_stmt|;
name|wps_ie
operator|=
name|wps_build_probe_req_ie
argument_list|(
name|DEV_PW_DEFAULT
argument_list|,
operator|&
name|wpa_s
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|wpa_s
operator|->
name|wps
operator|->
name|uuid
argument_list|,
name|WPS_REQ_ENROLLEE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|==
name|NULL
condition|)
block|{
name|wpas_p2p_scan_res_join
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
name|ielen
operator|=
name|p2p_scan_ie_buf_len
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|ies
operator|=
name|wpabuf_alloc
argument_list|(
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
operator|+
name|ielen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|wpas_p2p_scan_res_join
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpabuf_put_buf
argument_list|(
name|ies
argument_list|,
name|wps_ie
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|p2p_scan_ie
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|ies
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|params
operator|.
name|p2p_probe
operator|=
literal|1
expr_stmt|;
name|params
operator|.
name|extra_ies
operator|=
name|wpabuf_head
argument_list|(
name|ies
argument_list|)
expr_stmt|;
name|params
operator|.
name|extra_ies_len
operator|=
name|wpabuf_len
argument_list|(
name|ies
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|>
literal|0
condition|)
block|{
name|freqs
index|[
literal|0
index|]
operator|=
name|freq
expr_stmt|;
name|params
operator|.
name|freqs
operator|=
name|freqs
expr_stmt|;
block|}
comment|/* 	 * Run a scan to update BSS table and start Provision Discovery once 	 * the new scan results become available. 	 */
name|ret
operator|=
name|wpa_drv_scan
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|wpa_s
operator|->
name|scan_res_handler
operator|=
name|wpas_p2p_scan_res_join
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ies
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to start scan for join - "
literal|"try again later"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_p2p_check_join_scan_limit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_join_scan
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpas_p2p_join_scan_req
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_join
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|iface_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|,
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|,
name|int
name|auto_join
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Request to join existing group (iface "
name|MACSTR
literal|" dev "
name|MACSTR
literal|")%s"
argument_list|,
name|MAC2STR
argument_list|(
name|iface_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|dev_addr
argument_list|)
argument_list|,
name|auto_join
condition|?
literal|" (auto_join)"
else|:
literal|""
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_auto_pd
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_auto_join
operator|=
operator|!
operator|!
name|auto_join
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|iface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_join_wps_method
operator|=
name|wps_method
expr_stmt|;
comment|/* Make sure we are not running find during connection establishment */
name|wpas_p2p_stop_find
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_join_scan_count
operator|=
literal|0
expr_stmt|;
name|wpas_p2p_join_scan
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_join_start
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|group
decl_stmt|;
name|struct
name|p2p_go_neg_results
name|res
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|group
operator|=
name|wpas_p2p_get_group_iface
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|group
operator|!=
name|wpa_s
condition|)
block|{
name|os_memcpy
argument_list|(
name|group
operator|->
name|p2p_pin
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
sizeof|sizeof
argument_list|(
name|group
operator|->
name|p2p_pin
argument_list|)
argument_list|)
expr_stmt|;
name|group
operator|->
name|p2p_wps_method
operator|=
name|wpa_s
operator|->
name|p2p_wps_method
expr_stmt|;
block|}
name|group
operator|->
name|p2p_in_provisioning
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|wpa_s
expr_stmt|;
name|group
operator|->
name|p2p_fallback_to_go_neg
operator|=
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|res
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|res
operator|.
name|peer_interface_addr
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|res
operator|.
name|wps_method
operator|=
name|wpa_s
operator|->
name|pending_join_wps_method
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|res
operator|.
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|res
operator|.
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|res
operator|.
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|||
name|wpa_s
operator|->
name|roc_waiting_drv_freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancel remain-on-channel prior to "
literal|"starting client"
argument_list|)
expr_stmt|;
name|wpa_drv_cancel_remain_on_channel
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
literal|0
expr_stmt|;
block|}
name|wpas_start_wps_enrollee
argument_list|(
name|group
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
comment|/* 	 * Allow a longer timeout for join-a-running-group than normal 15 	 * second group formation timeout since the GO may not have authorized 	 * our connection yet. 	 */
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|60
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_connect - Request P2P Group Formation to be started  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * @peer_addr: Address of the peer P2P Device  * @pin: PIN to use during provisioning or %NULL to indicate PBC mode  * @persistent_group: Whether to create a persistent group  * @auto_join: Whether to select join vs. GO Negotiation automatically  * @join: Whether to join an existing group (as a client) instead of starting  *	Group Owner negotiation; @peer_addr is BSSID in that case  * @auth: Whether to only authorize the connection instead of doing that and  *	initiating Group Owner negotiation  * @go_intent: GO Intent or -1 to use default  * @freq: Frequency for the group or 0 for auto-selection  * @persistent_id: Persistent group credentials to use for forcing GO  *	parameters or -1 to generate new values (SSID/passphrase)  * @pd: Whether to send Provision Discovery prior to GO Negotiation as an  *	interoperability workaround when initiating group formation  * @ht40: Start GO with 40 MHz channel width  * Returns: 0 or new PIN (if pin was %NULL) on success, -1 on unspecified  *	failure, -2 on failure due to channel not currently available,  *	-3 if forced channel is not supported  */
end_comment

begin_function
name|int
name|wpas_p2p_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|,
name|int
name|persistent_group
parameter_list|,
name|int
name|auto_join
parameter_list|,
name|int
name|join
parameter_list|,
name|int
name|auth
parameter_list|,
name|int
name|go_intent
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|persistent_id
parameter_list|,
name|int
name|pd
parameter_list|,
name|int
name|ht40
parameter_list|)
block|{
name|int
name|force_freq
init|=
literal|0
decl_stmt|,
name|pref_freq
init|=
literal|0
decl_stmt|,
name|oper_freq
init|=
literal|0
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|enum
name|wpa_driver_if_type
name|iftype
decl_stmt|;
specifier|const
name|u8
modifier|*
name|if_addr
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|persistent_id
operator|>=
literal|0
condition|)
block|{
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|persistent_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|disabled
operator|!=
literal|2
operator|||
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|go_intent
operator|<
literal|0
condition|)
name|go_intent
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_go_intent
expr_stmt|;
if|if
condition|(
operator|!
name|auth
condition|)
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_wps_method
operator|=
name|wps_method
expr_stmt|;
name|wpa_s
operator|->
name|p2p_persistent_group
operator|=
operator|!
operator|!
name|persistent_group
expr_stmt|;
name|wpa_s
operator|->
name|p2p_persistent_id
operator|=
name|persistent_id
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_intent
operator|=
name|go_intent
expr_stmt|;
name|wpa_s
operator|->
name|p2p_connect_freq
operator|=
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_pd_before_go_neg
operator|=
operator|!
operator|!
name|pd
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_ht40
operator|=
operator|!
operator|!
name|ht40
expr_stmt|;
if|if
condition|(
name|pin
condition|)
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
name|pin
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|p2p_pin
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wps_method
operator|==
name|WPS_PIN_DISPLAY
condition|)
block|{
name|ret
operator|=
name|wps_generate_pin
argument_list|()
expr_stmt|;
name|os_snprintf
argument_list|(
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|p2p_pin
argument_list|)
argument_list|,
literal|"%08d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Randomly generated PIN: %s"
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_s
operator|->
name|p2p_pin
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|join
operator|||
name|auto_join
condition|)
block|{
name|u8
name|iface_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|,
name|dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|auth
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Authorize invitation to "
literal|"connect a running group from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peer_addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
name|peer_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|os_memcpy
argument_list|(
name|dev_addr
argument_list|,
name|peer_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_get_interface_addr
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|iface_addr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|iface_addr
argument_list|,
name|peer_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|p2p_get_dev_addr
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|dev_addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|auto_join
condition|)
block|{
name|os_get_time
argument_list|(
operator|&
name|wpa_s
operator|->
name|p2p_auto_started
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Auto join started at "
literal|"%ld.%06ld"
argument_list|,
name|wpa_s
operator|->
name|p2p_auto_started
operator|.
name|sec
argument_list|,
name|wpa_s
operator|->
name|p2p_auto_started
operator|.
name|usec
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|user_initiated_pd
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpas_p2p_join
argument_list|(
name|wpa_s
argument_list|,
name|iface_addr
argument_list|,
name|dev_addr
argument_list|,
name|wps_method
argument_list|,
name|auto_join
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|assoc_freq
condition|)
name|oper_freq
operator|=
name|wpa_s
operator|->
name|assoc_freq
expr_stmt|;
else|else
block|{
name|oper_freq
operator|=
name|wpa_drv_shared_freq
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|oper_freq
operator|<
literal|0
condition|)
name|oper_freq
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|freq
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: The forced channel "
literal|"(%u MHz) is not supported for P2P uses"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|3
return|;
block|}
if|if
condition|(
name|oper_freq
operator|>
literal|0
operator|&&
name|freq
operator|!=
name|oper_freq
operator|&&
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_MULTI_CHANNEL_CONCURRENT
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cannot start P2P group "
literal|"on %u MHz while connected on another "
literal|"channel (%u MHz)"
argument_list|,
name|freq
argument_list|,
name|oper_freq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Trying to force us to use the "
literal|"requested channel (%u MHz)"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|force_freq
operator|=
name|freq
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|oper_freq
operator|>
literal|0
operator|&&
operator|!
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|oper_freq
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_MULTI_CHANNEL_CONCURRENT
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cannot start P2P group "
literal|"while connected on non-P2P supported "
literal|"channel (%u MHz)"
argument_list|,
name|oper_freq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Current operating channel "
literal|"(%u MHz) not available for P2P - try to use "
literal|"another channel"
argument_list|,
name|oper_freq
argument_list|)
expr_stmt|;
name|force_freq
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|oper_freq
operator|>
literal|0
operator|&&
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_MULTI_CHANNEL_CONCURRENT
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Trying to prefer the channel we "
literal|"are already using (%u MHz) on another interface"
argument_list|,
name|oper_freq
argument_list|)
expr_stmt|;
name|pref_freq
operator|=
name|oper_freq
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|oper_freq
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Trying to force us to use the "
literal|"channel we are already using (%u MHz) on another "
literal|"interface"
argument_list|,
name|oper_freq
argument_list|)
expr_stmt|;
name|force_freq
operator|=
name|oper_freq
expr_stmt|;
block|}
name|wpa_s
operator|->
name|create_p2p_iface
operator|=
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|create_p2p_iface
condition|)
block|{
comment|/* Prepare to add a new interface for the group */
name|iftype
operator|=
name|WPA_IF_P2P_GROUP
expr_stmt|;
if|if
condition|(
name|go_intent
operator|==
literal|15
condition|)
name|iftype
operator|=
name|WPA_IF_P2P_GO
expr_stmt|;
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|iftype
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to allocate a new "
literal|"interface for the group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|if_addr
operator|=
name|wpa_s
operator|->
name|pending_interface_addr
expr_stmt|;
block|}
else|else
name|if_addr
operator|=
name|wpa_s
operator|->
name|own_addr
expr_stmt|;
if|if
condition|(
name|auth
condition|)
block|{
if|if
condition|(
name|wpas_p2p_auth_go_neg
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|,
name|wps_method
argument_list|,
name|go_intent
argument_list|,
name|if_addr
argument_list|,
name|force_freq
argument_list|,
name|persistent_group
argument_list|,
name|ssid
argument_list|,
name|pref_freq
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|wpas_p2p_start_go_neg
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|,
name|wps_method
argument_list|,
name|go_intent
argument_list|,
name|if_addr
argument_list|,
name|force_freq
argument_list|,
name|persistent_group
argument_list|,
name|ssid
argument_list|,
name|pref_freq
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|create_p2p_iface
condition|)
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_remain_on_channel_cb - Indication of remain-on-channel start  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * @freq: Frequency of the channel in MHz  * @duration: Duration of the stay on the channel in milliseconds  *  * This callback is called when the driver indicates that it has started the  * requested remain-on-channel duration.  */
end_comment

begin_function
name|void
name|wpas_p2p_remain_on_channel_cb
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|duration
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|==
name|wpa_s
operator|->
name|pending_listen_freq
condition|)
block|{
name|p2p_listen_cb
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_listen_freq
argument_list|,
name|wpa_s
operator|->
name|pending_listen_duration
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_listen_freq
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_listen_start
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|)
block|{
comment|/* Limit maximum Listen state time based on driver limitation. */
if|if
condition|(
name|timeout
operator|>
name|wpa_s
operator|->
name|max_remain_on_chan
condition|)
name|timeout
operator|=
name|wpa_s
operator|->
name|max_remain_on_chan
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
name|wpa_drv_p2p_listen
argument_list|(
name|wpa_s
argument_list|,
name|timeout
argument_list|)
return|;
return|return
name|p2p_listen
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|timeout
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_cancel_remain_on_channel_cb - Remain-on-channel timeout  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * @freq: Frequency of the channel in MHz  *  * This callback is called when the driver indicates that a remain-on-channel  * operation has been completed, i.e., the duration on the requested channel  * has timed out.  */
end_comment

begin_function
name|void
name|wpas_p2p_cancel_remain_on_channel_cb
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancel remain-on-channel callback "
literal|"(p2p_long_listen=%d ms pending_action_tx=%p)"
argument_list|,
name|wpa_s
operator|->
name|p2p_long_listen
argument_list|,
name|offchannel_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|p2p_listen_end
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
operator|>
literal|0
condition|)
return|return;
comment|/* P2P module started a new operation */
if|if
condition|(
name|offchannel_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_long_listen
operator|>
literal|0
condition|)
name|wpa_s
operator|->
name|p2p_long_listen
operator|-=
name|wpa_s
operator|->
name|max_remain_on_chan
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_long_listen
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Continuing long Listen state"
argument_list|)
expr_stmt|;
name|wpas_p2p_listen_start
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|p2p_long_listen
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_group_remove - Remove a P2P group  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * @ifname: Network interface name of the group interface or "*" to remove all  *	groups  * Returns: 0 on success, -1 on failure  *  * This function is used to remove a P2P group. This can be used to disconnect  * from a group in which the local end is a P2P Client or to end a P2P Group in  * case the local end is the Group Owner. If a virtual network interface was  * created for this group, that interface will be removed. Otherwise, only the  * configured P2P group network will be removed from the interface.  */
end_comment

begin_function
name|int
name|wpas_p2p_group_remove
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|wpa_s
operator|->
name|global
decl_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|ifname
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|prev
decl_stmt|;
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
while|while
condition|(
name|wpa_s
condition|)
block|{
name|prev
operator|=
name|wpa_s
expr_stmt|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
name|wpas_p2p_disconnect
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
return|return
name|wpas_p2p_disconnect
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_init_go_params
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|params
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|ht40
parameter_list|)
block|{
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|os_memset
argument_list|(
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|->
name|role_go
operator|=
literal|1
expr_stmt|;
name|params
operator|->
name|ht40
operator|=
name|ht40
expr_stmt|;
if|if
condition|(
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on forced "
literal|"frequency %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|params
operator|->
name|freq
operator|=
name|freq
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|==
literal|81
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|>=
literal|1
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|<=
literal|11
condition|)
block|{
name|params
operator|->
name|freq
operator|=
literal|2407
operator|+
literal|5
operator|*
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on configured "
literal|"frequency %d MHz"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|==
literal|115
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|==
literal|124
condition|)
block|{
name|params
operator|->
name|freq
operator|=
literal|5000
operator|+
literal|5
operator|*
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on configured "
literal|"frequency %d MHz"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|best_overall_freq
operator|>
literal|0
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|best_overall_freq
argument_list|)
condition|)
block|{
name|params
operator|->
name|freq
operator|=
name|wpa_s
operator|->
name|best_overall_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on best overall "
literal|"channel %d MHz"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|best_24_freq
operator|>
literal|0
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|best_24_freq
argument_list|)
condition|)
block|{
name|params
operator|->
name|freq
operator|=
name|wpa_s
operator|->
name|best_24_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on best 2.4 GHz "
literal|"channel %d MHz"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|best_5_freq
operator|>
literal|0
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|best_5_freq
argument_list|)
condition|)
block|{
name|params
operator|->
name|freq
operator|=
name|wpa_s
operator|->
name|best_5_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on best 5 GHz "
literal|"channel %d MHz"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|chan
decl_stmt|;
for|for
control|(
name|chan
operator|=
literal|0
init|;
name|chan
operator|<
literal|11
condition|;
name|chan
operator|++
control|)
block|{
name|params
operator|->
name|freq
operator|=
literal|2412
operator|+
name|chan
operator|*
literal|5
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|params
operator|->
name|freq
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|chan
operator|==
literal|11
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No 2.4 GHz channel "
literal|"allowed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq %d MHz (no preference "
literal|"known)"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|assoc_freq
operator|&&
operator|!
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Force GO on the channel we are "
literal|"already using"
argument_list|)
expr_stmt|;
name|params
operator|->
name|freq
operator|=
name|wpa_s
operator|->
name|assoc_freq
expr_stmt|;
block|}
name|res
operator|=
name|wpa_drv_shared_freq
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
operator|&&
operator|!
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Force GO on the channel we are "
literal|"already using on a shared interface"
argument_list|)
expr_stmt|;
name|params
operator|->
name|freq
operator|=
name|res
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|res
operator|>
literal|0
operator|&&
name|freq
operator|!=
name|res
operator|&&
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_MULTI_CHANNEL_CONCURRENT
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cannot start P2P group on %u MHz "
literal|"while connected on another channel (%u MHz)"
argument_list|,
name|freq
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpas_p2p_get_group_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|addr_allocated
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|group_wpa_s
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use same interface for group "
literal|"operations"
argument_list|)
expr_stmt|;
return|return
name|wpa_s
return|;
block|}
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|go
condition|?
name|WPA_IF_P2P_GO
else|:
name|WPA_IF_P2P_CLIENT
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to add group interface"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|group_wpa_s
operator|=
name|wpas_p2p_init_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|go
argument_list|)
expr_stmt|;
if|if
condition|(
name|group_wpa_s
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to initialize group "
literal|"interface"
argument_list|)
expr_stmt|;
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use separate group interface %s"
argument_list|,
name|group_wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
return|return
name|group_wpa_s
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_group_add - Add a new P2P group with local end as Group Owner  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * @persistent_group: Whether to create a persistent group  * @freq: Frequency for the group or 0 to indicate no hardcoding  * Returns: 0 on success, -1 on failure  *  * This function creates a new P2P group with the local end as the Group Owner,  * i.e., without using Group Owner Negotiation.  */
end_comment

begin_function
name|int
name|wpas_p2p_group_add
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|persistent_group
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|ht40
parameter_list|)
block|{
name|struct
name|p2p_go_neg_results
name|params
decl_stmt|;
name|unsigned
name|int
name|r
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Make sure we are not running find during connection establishment */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Stop any on-going P2P FIND"
argument_list|)
expr_stmt|;
name|wpas_p2p_stop_find_oper
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|==
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Request to start GO on 2.4 GHz "
literal|"band"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|best_24_freq
operator|>
literal|0
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|best_24_freq
argument_list|)
condition|)
block|{
name|freq
operator|=
name|wpa_s
operator|->
name|best_24_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use best 2.4 GHz band "
literal|"channel: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|freq
operator|=
literal|2412
operator|+
operator|(
name|r
operator|%
literal|3
operator|)
operator|*
literal|25
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use random 2.4 GHz band "
literal|"channel: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|freq
operator|==
literal|5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Request to start GO on 5 GHz "
literal|"band"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|best_5_freq
operator|>
literal|0
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|best_5_freq
argument_list|)
condition|)
block|{
name|freq
operator|=
name|wpa_s
operator|->
name|best_5_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use best 5 GHz band "
literal|"channel: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|freq
operator|=
literal|5180
operator|+
operator|(
name|r
operator|%
literal|4
operator|)
operator|*
literal|20
expr_stmt|;
if|if
condition|(
operator|!
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not select "
literal|"5 GHz channel for P2P group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use random 5 GHz band "
literal|"channel: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|freq
operator|>
literal|0
operator|&&
operator|!
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: The forced channel for GO "
literal|"(%u MHz) is not supported for P2P uses"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpas_p2p_init_go_params
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
name|freq
argument_list|,
name|ht40
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|.
name|freq
operator|&&
operator|!
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|params
operator|.
name|freq
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: The selected channel for GO "
literal|"(%u MHz) is not supported for P2P uses"
argument_list|,
name|params
operator|.
name|freq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p2p_go_params
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
name|params
operator|.
name|persistent_group
operator|=
name|persistent_group
expr_stmt|;
name|wpa_s
operator|=
name|wpas_p2p_get_group_iface
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_start_wps_go
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_start_p2p_client
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|params
parameter_list|,
name|int
name|addr_allocated
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|wpa_s
operator|=
name|wpas_p2p_get_group_iface
argument_list|(
name|wpa_s
argument_list|,
name|addr_allocated
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_supplicant_ap_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
name|ssid
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|ssid
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_malloc
argument_list|(
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
name|ssid
operator|->
name|p2p_group
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|export_keys
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|psk_set
condition|)
block|{
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|psk
argument_list|,
name|params
operator|->
name|psk
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|psk_set
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|passphrase
condition|)
name|ssid
operator|->
name|passphrase
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|passphrase
argument_list|)
expr_stmt|;
name|wpa_supplicant_select_network
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_group_add_persistent
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|int
name|addr_allocated
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|ht40
parameter_list|)
block|{
name|struct
name|p2p_go_neg_results
name|params
decl_stmt|;
name|int
name|go
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|disabled
operator|!=
literal|2
operator|||
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpas_get_p2p_group
argument_list|(
name|wpa_s
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
operator|&
name|go
argument_list|)
operator|&&
name|go
operator|==
operator|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested persistent group is "
literal|"already running"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Make sure we are not running find during connection establishment */
name|wpas_p2p_stop_find_oper
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
condition|)
return|return
name|wpas_start_p2p_client
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|addr_allocated
argument_list|)
return|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpas_p2p_init_go_params
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
name|freq
argument_list|,
name|ht40
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|params
operator|.
name|role_go
operator|=
literal|1
expr_stmt|;
name|params
operator|.
name|psk_set
operator|=
name|ssid
operator|->
name|psk_set
expr_stmt|;
if|if
condition|(
name|params
operator|.
name|psk_set
condition|)
name|os_memcpy
argument_list|(
name|params
operator|.
name|psk
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
sizeof|sizeof
argument_list|(
name|params
operator|.
name|psk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
condition|)
block|{
if|if
condition|(
name|os_strlen
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|params
operator|.
name|passphrase
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Invalid passphrase in "
literal|"persistent group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_strlcpy
argument_list|(
name|params
operator|.
name|passphrase
argument_list|,
name|ssid
operator|->
name|passphrase
argument_list|,
sizeof|sizeof
argument_list|(
name|params
operator|.
name|passphrase
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|params
operator|.
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
name|params
operator|.
name|persistent_group
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|=
name|wpas_p2p_get_group_iface
argument_list|(
name|wpa_s
argument_list|,
name|addr_allocated
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_start_wps_go
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_ie_update
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|beacon_ies
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|proberesp_ies
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|hapd
operator|->
name|conf
operator|->
name|p2p
operator|&
name|P2P_GROUP_OWNER
operator|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|beacon_ies
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|proberesp_ies
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|beacon_ies
condition|)
block|{
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|p2p_beacon_ie
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|p2p_beacon_ie
operator|=
name|beacon_ies
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|p2p_probe_resp_ie
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|p2p_probe_resp_ie
operator|=
name|proberesp_ies
expr_stmt|;
block|}
else|else
block|{
name|wpabuf_free
argument_list|(
name|beacon_ies
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|proberesp_ies
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_ap_update_beacon
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_idle_update
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|idle
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO - group %sidle"
argument_list|,
name|idle
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
if|if
condition|(
name|idle
condition|)
name|wpas_p2p_set_group_idle_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
else|else
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|p2p_group
modifier|*
name|wpas_p2p_group_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|p2p_group
modifier|*
name|group
decl_stmt|;
name|struct
name|p2p_group_config
modifier|*
name|cfg
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|cfg
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ssid
operator|->
name|p2p_persistent_group
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|persistent_reconnect
condition|)
name|cfg
operator|->
name|persistent_group
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|p2p_persistent_group
condition|)
name|cfg
operator|->
name|persistent_group
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|cfg
operator|->
name|interface_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|max_stations
operator|&&
name|wpa_s
operator|->
name|max_stations
operator|<
name|wpa_s
operator|->
name|conf
operator|->
name|max_num_sta
condition|)
name|cfg
operator|->
name|max_clients
operator|=
name|wpa_s
operator|->
name|max_stations
expr_stmt|;
else|else
name|cfg
operator|->
name|max_clients
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|max_num_sta
expr_stmt|;
name|os_memcpy
argument_list|(
name|cfg
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|cfg
operator|->
name|ssid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
name|cfg
operator|->
name|cb_ctx
operator|=
name|wpa_s
expr_stmt|;
name|cfg
operator|->
name|ie_update
operator|=
name|wpas_p2p_ie_update
expr_stmt|;
name|cfg
operator|->
name|idle_update
operator|=
name|wpas_p2p_idle_update
expr_stmt|;
name|group
operator|=
name|p2p_group_init
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|==
name|NULL
condition|)
name|os_free
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GROUP_FORMATION
condition|)
name|p2p_group_notif_formation_done
argument_list|(
name|group
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group
operator|=
name|group
expr_stmt|;
return|return
name|group
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_wps_success
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
name|int
name|registrar
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore WPS success event - P2P "
literal|"provisioning not in progress"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
condition|)
block|{
name|u8
name|go_dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|os_memcpy
argument_list|(
name|go_dev_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpas_p2p_persistent_group
argument_list|(
name|wpa_s
argument_list|,
name|go_dev_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
comment|/* Clear any stored provisioning info */
name|p2p_clear_provisioning_info
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|go_dev_addr
argument_list|)
expr_stmt|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
condition|)
block|{
comment|/* 		 * Use a separate timeout for initial data connection to 		 * complete to allow the group to be removed automatically if 		 * something goes wrong in this step before the P2P group idle 		 * timeout mechanism is taken into use. 		 */
name|eloop_register_timeout
argument_list|(
name|P2P_MAX_INITIAL_CONN_WAIT
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_wps_success_cb
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
name|wpa_drv_wps_success_cb
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|)
expr_stmt|;
name|wpas_group_formation_completed
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_wps_failed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_fail
modifier|*
name|fail
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore WPS fail event - P2P "
literal|"provisioning not in progress"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|go_params
condition|)
block|{
name|p2p_clear_provisioning_info
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|go_params
operator|->
name|peer_device_addr
argument_list|)
expr_stmt|;
block|}
name|wpas_notify_p2p_wps_failed
argument_list|(
name|wpa_s
argument_list|,
name|fail
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_prov_disc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
specifier|const
name|char
modifier|*
name|config_method
parameter_list|,
name|enum
name|wpas_p2p_prov_disc_use
name|use
parameter_list|)
block|{
name|u16
name|config_methods
decl_stmt|;
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_use
operator|=
name|NORMAL_PD
expr_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|config_method
argument_list|,
literal|"display"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
name|config_methods
operator|=
name|WPS_CONFIG_DISPLAY
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|config_method
argument_list|,
literal|"keypad"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
name|config_methods
operator|=
name|WPS_CONFIG_KEYPAD
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|config_method
argument_list|,
literal|"pbc"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|||
name|os_strncmp
argument_list|(
name|config_method
argument_list|,
literal|"pushbutton"
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
name|config_methods
operator|=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unknown config method"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|use
operator|==
name|WPAS_P2P_PD_AUTO
condition|)
block|{
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|peer_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_config_methods
operator|=
name|config_methods
expr_stmt|;
name|wpa_s
operator|->
name|p2p_auto_pd
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|p2p_auto_join
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|auto_pd_scan_retry
operator|=
literal|0
expr_stmt|;
name|wpas_p2p_stop_find
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_join_scan_count
operator|=
literal|0
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|wpa_s
operator|->
name|p2p_auto_started
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Auto PD started at %ld.%06ld"
argument_list|,
name|wpa_s
operator|->
name|p2p_auto_started
operator|.
name|sec
argument_list|,
name|wpa_s
operator|->
name|p2p_auto_started
operator|.
name|usec
argument_list|)
expr_stmt|;
name|wpas_p2p_join_scan
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
block|{
return|return
name|wpa_drv_p2p_prov_disc_req
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|,
name|config_methods
argument_list|,
name|use
operator|==
name|WPAS_P2P_PD_FOR_JOIN
argument_list|)
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_prov_disc_req
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|config_methods
argument_list|,
name|use
operator|==
name|WPAS_P2P_PD_FOR_JOIN
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_scan_result_text
parameter_list|(
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
name|end
parameter_list|)
block|{
return|return
name|p2p_scan_result_text
argument_list|(
name|ies
argument_list|,
name|ies_len
argument_list|,
name|buf
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_clear_pending_action_tx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|offchannel_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Drop pending Action TX due to new "
literal|"operation request"
argument_list|)
expr_stmt|;
name|offchannel_clear_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_find
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|enum
name|p2p_discovery_type
name|type
parameter_list|,
name|unsigned
name|int
name|num_req_dev_types
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_dev_types
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_id
parameter_list|,
name|unsigned
name|int
name|search_delay
parameter_list|)
block|{
name|wpas_p2p_clear_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
name|wpa_drv_p2p_find
argument_list|(
name|wpa_s
argument_list|,
name|timeout
argument_list|,
name|type
argument_list|)
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|p2p_find
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|timeout
argument_list|,
name|type
argument_list|,
name|num_req_dev_types
argument_list|,
name|req_dev_types
argument_list|,
name|dev_id
argument_list|,
name|search_delay
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_stop_find_oper
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpas_p2p_clear_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
block|{
name|wpa_drv_p2p_stop_find
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_stop_find
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_stop_find
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpas_p2p_stop_find_oper
argument_list|(
name|wpa_s
argument_list|)
operator|>
literal|0
condition|)
return|return;
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_long_listen_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_listen
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_p2p_clear_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|==
literal|0
condition|)
block|{
comment|/* 		 * This is a request for unlimited Listen state. However, at 		 * least for now, this is mapped to a Listen state for one 		 * hour. 		 */
name|timeout
operator|=
literal|3600
expr_stmt|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Stop previous find/listen operation to avoid trying to request a new 	 * remain-on-channel operation while the driver is still running the 	 * previous one. 	 */
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_stop_find
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|res
operator|=
name|wpas_p2p_listen_start
argument_list|(
name|wpa_s
argument_list|,
name|timeout
operator|*
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
operator|&&
name|timeout
operator|*
literal|1000
operator|>
name|wpa_s
operator|->
name|max_remain_on_chan
condition|)
block|{
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
name|timeout
operator|*
literal|1000
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|timeout
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_assoc_req_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|p2p_group
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|p2p_ie
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p2p_ie
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|p2p_assoc_req_ie
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|p2p_group
argument_list|,
name|p2p_ie
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p_ie
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_probe_req_rx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|int
name|ssi_signal
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|p2p_probe_req_rx
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|addr
argument_list|,
name|dst
argument_list|,
name|bssid
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
condition|)
block|{
case|case
name|P2P_PREQ_NOT_P2P
case|:
name|wpas_notify_preq
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|dst
argument_list|,
name|bssid
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|,
name|ssi_signal
argument_list|)
expr_stmt|;
comment|/* fall through */
case|case
name|P2P_PREQ_MALFORMED
case|:
case|case
name|P2P_PREQ_NOT_LISTEN
case|:
case|case
name|P2P_PREQ_NOT_PROCESSED
case|:
default|default:
comment|/* make gcc happy */
return|return
literal|0
return|;
case|case
name|P2P_PREQ_PROCESSED
case|:
return|return
literal|1
return|;
block|}
block|}
end_function

begin_function
name|void
name|wpas_p2p_rx_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|da
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u8
name|category
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|p2p_rx_action
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|da
argument_list|,
name|sa
argument_list|,
name|bssid
argument_list|,
name|category
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_scan_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|ies
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|p2p_scan_ie
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|ies
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_group_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|p2p_group_deinit
argument_list|(
name|wpa_s
operator|->
name|p2p_group
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb_ctx
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb_data
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|connect_without_scan
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_reject
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
name|wpa_drv_p2p_reject
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|)
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_reject
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|addr
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Invite to reinvoke a persistent group */
end_comment

begin_function
name|int
name|wpas_p2p_invite
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|ht40
parameter_list|)
block|{
name|enum
name|p2p_invite_role
name|role
decl_stmt|;
name|u8
modifier|*
name|bssid
init|=
name|NULL
decl_stmt|;
name|wpa_s
operator|->
name|p2p_persistent_go_freq
operator|=
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_ht40
operator|=
operator|!
operator|!
name|ht40
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
name|role
operator|=
name|P2P_INVITE_ROLE_GO
expr_stmt|;
if|if
condition|(
name|peer_addr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Missing peer "
literal|"address in invitation command"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|WPA_IF_P2P_GO
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to "
literal|"allocate a new interface for the "
literal|"group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|bssid
operator|=
name|wpa_s
operator|->
name|pending_interface_addr
expr_stmt|;
block|}
else|else
name|bssid
operator|=
name|wpa_s
operator|->
name|own_addr
expr_stmt|;
block|}
else|else
block|{
name|role
operator|=
name|P2P_INVITE_ROLE_CLIENT
expr_stmt|;
name|peer_addr
operator|=
name|ssid
operator|->
name|bssid
expr_stmt|;
block|}
name|wpa_s
operator|->
name|pending_invite_ssid_id
operator|=
name|ssid
operator|->
name|id
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
name|wpa_drv_p2p_invite
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|,
name|role
argument_list|,
name|bssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
name|go_dev_addr
argument_list|,
literal|1
argument_list|)
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_invite
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|role
argument_list|,
name|bssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
name|freq
argument_list|,
name|go_dev_addr
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Invite to join an active group */
end_comment

begin_function
name|int
name|wpas_p2p_invite_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|wpa_s
operator|->
name|global
decl_stmt|;
name|enum
name|p2p_invite_role
name|role
decl_stmt|;
name|u8
modifier|*
name|bssid
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|persistent
decl_stmt|;
name|wpa_s
operator|->
name|p2p_persistent_go_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_ht40
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Interface '%s' not found"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No current SSID to use for "
literal|"invitation"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|persistent
operator|=
name|ssid
operator|->
name|p2p_persistent_group
operator|&&
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|peer_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
name|role
operator|=
name|P2P_INVITE_ROLE_ACTIVE_GO
expr_stmt|;
name|bssid
operator|=
name|wpa_s
operator|->
name|own_addr
expr_stmt|;
if|if
condition|(
name|go_dev_addr
operator|==
name|NULL
condition|)
name|go_dev_addr
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
expr_stmt|;
block|}
else|else
block|{
name|role
operator|=
name|P2P_INVITE_ROLE_CLIENT
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Not associated - cannot "
literal|"invite to current group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|bssid
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
if|if
condition|(
name|go_dev_addr
operator|==
name|NULL
operator|&&
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|go_dev_addr
argument_list|)
condition|)
name|go_dev_addr
operator|=
name|wpa_s
operator|->
name|go_dev_addr
expr_stmt|;
block|}
name|wpa_s
operator|->
name|parent
operator|->
name|pending_invite_ssid_id
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
name|wpa_drv_p2p_invite
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|,
name|role
argument_list|,
name|bssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
name|go_dev_addr
argument_list|,
name|persistent
argument_list|)
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_invite
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|role
argument_list|,
name|bssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
name|go_dev_addr
argument_list|,
name|persistent
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_completed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
specifier|const
name|char
modifier|*
name|ssid_txt
decl_stmt|;
name|u8
name|go_dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|network_id
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|persistent
decl_stmt|;
name|int
name|freq
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GROUP_FORMATION
condition|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|show_group_started
operator|||
operator|!
name|ssid
condition|)
goto|goto
name|done
goto|;
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|0
expr_stmt|;
name|ssid_txt
operator|=
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|go_dev_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|bssid_set
condition|)
name|os_memcpy
argument_list|(
name|go_dev_addr
argument_list|,
name|ssid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|persistent
operator|=
name|wpas_p2p_persistent_group
argument_list|(
name|wpa_s
argument_list|,
name|go_dev_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|go_dev_addr
argument_list|,
name|go_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|==
name|wpa_s
condition|)
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|NULL
expr_stmt|;
name|freq
operator|=
name|wpa_s
operator|->
name|current_bss
condition|?
name|wpa_s
operator|->
name|current_bss
operator|->
name|freq
else|:
operator|(
name|int
operator|)
name|wpa_s
operator|->
name|assoc_freq
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|==
name|NULL
operator|&&
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|char
name|psk
index|[
literal|65
index|]
decl_stmt|;
name|wpa_snprintf_hex
argument_list|(
name|psk
argument_list|,
sizeof|sizeof
argument_list|(
name|psk
argument_list|)
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_STARTED
literal|"%s client ssid=\"%s\" freq=%d psk=%s go_dev_addr="
name|MACSTR
literal|"%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ssid_txt
argument_list|,
name|freq
argument_list|,
name|psk
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|,
name|persistent
condition|?
literal|" [PERSISTENT]"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_STARTED
literal|"%s client ssid=\"%s\" freq=%d passphrase=\"%s\" "
literal|"go_dev_addr="
name|MACSTR
literal|"%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ssid_txt
argument_list|,
name|freq
argument_list|,
name|ssid
operator|->
name|passphrase
condition|?
name|ssid
operator|->
name|passphrase
else|:
literal|""
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|,
name|persistent
condition|?
literal|" [PERSISTENT]"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|persistent
condition|)
name|network_id
operator|=
name|wpas_p2p_store_persistent_group
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|ssid
argument_list|,
name|go_dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|network_id
operator|<
literal|0
condition|)
name|network_id
operator|=
name|ssid
operator|->
name|id
expr_stmt|;
name|wpas_notify_p2p_group_started
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|network_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|done
label|:
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|&&
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|!=
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p2p_other_scan_completed
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Pending P2P operation "
literal|"continued after successful connection"
argument_list|)
expr_stmt|;
name|p2p_increase_search_delay
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpas_p2p_search_delay
argument_list|(
name|wpa_s
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|wpas_p2p_presence_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|duration1
parameter_list|,
name|u32
name|interval1
parameter_list|,
name|u32
name|duration2
parameter_list|,
name|u32
name|interval2
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_presence_req
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
name|duration1
argument_list|,
name|interval1
argument_list|,
name|duration2
argument_list|,
name|interval2
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_ext_listen
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|period
parameter_list|,
name|unsigned
name|int
name|interval
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_ext_listen
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|period
argument_list|,
name|interval
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_is_client
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * current_ssid can be cleared when P2P client interface gets 		 * disconnected, so assume this interface was used as P2P 		 * client. 		 */
return|return
literal|1
return|;
block|}
return|return
name|wpa_s
operator|->
name|current_ssid
operator|->
name|p2p_group
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_group_idle_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_group_idle
operator|==
literal|0
operator|&&
operator|!
name|wpas_p2p_is_client
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore group idle timeout - "
literal|"disabled"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Group idle timeout reached - terminate "
literal|"group"
argument_list|)
expr_stmt|;
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_IDLE_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_set_group_idle_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|timeout
decl_stmt|;
if|if
condition|(
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancelled P2P group idle timeout"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
operator|!
name|wpa_s
operator|->
name|current_ssid
operator|->
name|p2p_group
condition|)
return|return;
name|timeout
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_group_idle
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
operator|&&
operator|(
name|timeout
operator|==
literal|0
operator|||
name|timeout
operator|>
name|P2P_MAX_CLIENT_IDLE
operator|)
condition|)
name|timeout
operator|=
name|P2P_MAX_CLIENT_IDLE
expr_stmt|;
if|if
condition|(
name|timeout
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|timeout
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
condition|)
name|timeout
operator|=
literal|0
expr_stmt|;
comment|/* special client mode no-timeout */
else|else
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
block|{
comment|/* 		 * Use the normal group formation timeout during the 		 * provisioning phase to avoid terminating this process too 		 * early due to group idle timeout. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Do not use P2P group idle timeout "
literal|"during provisioning"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|show_group_started
condition|)
block|{
comment|/* 		 * Use the normal group formation timeout between the end of 		 * the provisioning phase and completion of 4-way handshake to 		 * avoid terminating this process too early due to group idle 		 * timeout. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Do not use P2P group idle timeout "
literal|"while waiting for initial 4-way handshake to "
literal|"complete"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set P2P group idle timeout to %u seconds"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|timeout
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Returns 1 if the interface was removed */
end_comment

begin_function
name|int
name|wpas_p2p_deauth_notif
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u16
name|reason_code
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|int
name|locally_generated
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|locally_generated
condition|)
name|p2p_deauth_notif
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|bssid
argument_list|,
name|reason_code
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason_code
operator|==
name|WLAN_REASON_DEAUTH_LEAVING
operator|&&
operator|!
name|locally_generated
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|p2p_group
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO indicated that the P2P Group "
literal|"session is ending"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_GO_ENDING_SESSION
argument_list|)
operator|>
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_disassoc_notif
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u16
name|reason_code
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|int
name|locally_generated
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return;
if|if
condition|(
operator|!
name|locally_generated
condition|)
name|p2p_disassoc_notif
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|bssid
argument_list|,
name|reason_code
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_update_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|p2p_data
modifier|*
name|p2p
init|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p
decl_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_CAPABLE
operator|)
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_DEVICE_NAME
condition|)
name|p2p_set_dev_name
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_DEVICE_TYPE
condition|)
name|p2p_set_pri_dev_type
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps
operator|&&
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_CONFIG_METHODS
operator|)
condition|)
name|p2p_set_config_methods
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|wps
operator|->
name|config_methods
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps
operator|&&
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_UUID
operator|)
condition|)
name|p2p_set_uuid
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|wps
operator|->
name|uuid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_WPS_STRING
condition|)
block|{
name|p2p_set_manufacturer
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|manufacturer
argument_list|)
expr_stmt|;
name|p2p_set_model_name
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|model_name
argument_list|)
expr_stmt|;
name|p2p_set_model_number
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|model_number
argument_list|)
expr_stmt|;
name|p2p_set_serial_number
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|serial_number
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_SEC_DEVICE_TYPE
condition|)
name|p2p_set_sec_dev_types
argument_list|(
name|p2p
argument_list|,
operator|(
name|void
operator|*
operator|)
name|wpa_s
operator|->
name|conf
operator|->
name|sec_device_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|num_sec_device_types
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_VENDOR_EXTENSION
condition|)
block|{
name|int
name|i
decl_stmt|;
name|p2p_remove_wps_vendor_extensions
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_WPS_VENDOR_EXT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|p2p_add_wps_vendor_extension
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_COUNTRY
operator|)
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
condition|)
block|{
name|char
name|country
index|[
literal|3
index|]
decl_stmt|;
name|country
index|[
literal|0
index|]
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
expr_stmt|;
name|country
index|[
literal|1
index|]
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
expr_stmt|;
name|country
index|[
literal|2
index|]
operator|=
literal|0x04
expr_stmt|;
name|p2p_set_country
argument_list|(
name|p2p
argument_list|,
name|country
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_SSID_POSTFIX
condition|)
block|{
name|p2p_set_ssid_postfix
argument_list|(
name|p2p
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
condition|?
name|os_strlen
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
argument_list|)
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_INTRA_BSS
condition|)
name|p2p_set_intra_bss_dist
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_intra_bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_LISTEN_CHANNEL
condition|)
block|{
name|u8
name|reg_class
decl_stmt|,
name|channel
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|unsigned
name|int
name|r
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_reg_class
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_channel
condition|)
block|{
name|reg_class
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_reg_class
expr_stmt|;
name|channel
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_channel
expr_stmt|;
block|}
else|else
block|{
name|reg_class
operator|=
literal|81
expr_stmt|;
comment|/* 			 * Pick one of the social channels randomly as the 			 * listen channel. 			 */
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|channel
operator|=
literal|1
operator|+
operator|(
name|r
operator|%
literal|3
operator|)
operator|*
literal|5
expr_stmt|;
block|}
name|ret
operator|=
name|p2p_set_listen_channel
argument_list|(
name|p2p
argument_list|,
name|reg_class
argument_list|,
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Own listen channel update "
literal|"failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_OPER_CHANNEL
condition|)
block|{
name|u8
name|op_reg_class
decl_stmt|,
name|op_channel
decl_stmt|,
name|cfg_op_channel
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|r
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
condition|)
block|{
name|op_reg_class
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
expr_stmt|;
name|op_channel
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
expr_stmt|;
name|cfg_op_channel
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|op_reg_class
operator|=
literal|81
expr_stmt|;
comment|/* 			 * Use random operation channel from (1, 6, 11) 			 *if no other preference is indicated. 			 */
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|op_channel
operator|=
literal|1
operator|+
operator|(
name|r
operator|%
literal|3
operator|)
operator|*
literal|5
expr_stmt|;
name|cfg_op_channel
operator|=
literal|0
expr_stmt|;
block|}
name|ret
operator|=
name|p2p_set_oper_channel
argument_list|(
name|p2p
argument_list|,
name|op_reg_class
argument_list|,
name|op_channel
argument_list|,
name|cfg_op_channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Own oper channel update "
literal|"failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_PREF_CHAN
condition|)
block|{
if|if
condition|(
name|p2p_set_pref_chan
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|num_p2p_pref_chan
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_pref_chan
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Preferred channel list "
literal|"update failed"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|wpas_p2p_set_noa
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|count
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|duration
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|hostapd_p2p_set_noa
argument_list|(
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|,
name|count
argument_list|,
name|start
argument_list|,
name|duration
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_set_cross_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_s
operator|->
name|global
operator|->
name|cross_connection
operator|=
name|enabled
expr_stmt|;
name|p2p_set_cross_connect
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|enabled
condition|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
for|for
control|(
name|iface
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
name|iface
operator|->
name|cross_connect_enabled
operator|==
literal|0
condition|)
continue|continue;
name|iface
operator|->
name|cross_connect_enabled
operator|=
literal|0
expr_stmt|;
name|iface
operator|->
name|cross_connect_in_use
operator|=
literal|0
expr_stmt|;
name|wpa_msg
argument_list|(
name|iface
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_CROSS_CONNECT_DISABLE
literal|"%s %s"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_enable_cross_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|uplink
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
if|if
condition|(
operator|!
name|uplink
operator|->
name|global
operator|->
name|cross_connection
condition|)
return|return;
for|for
control|(
name|iface
operator|=
name|uplink
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
name|iface
operator|->
name|cross_connect_enabled
condition|)
continue|continue;
if|if
condition|(
name|os_strcmp
argument_list|(
name|uplink
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|cross_connect_uplink
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|iface
operator|->
name|ap_iface
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|iface
operator|->
name|cross_connect_in_use
condition|)
continue|continue;
name|iface
operator|->
name|cross_connect_in_use
operator|=
literal|1
expr_stmt|;
name|wpa_msg
argument_list|(
name|iface
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_CROSS_CONNECT_ENABLE
literal|"%s %s"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_disable_cross_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|uplink
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
for|for
control|(
name|iface
operator|=
name|uplink
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
name|iface
operator|->
name|cross_connect_enabled
condition|)
continue|continue;
if|if
condition|(
name|os_strcmp
argument_list|(
name|uplink
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|cross_connect_uplink
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|!
name|iface
operator|->
name|cross_connect_in_use
condition|)
continue|continue;
name|wpa_msg
argument_list|(
name|iface
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_CROSS_CONNECT_DISABLE
literal|"%s %s"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
name|iface
operator|->
name|cross_connect_in_use
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpas_p2p_notif_connected
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
operator|||
name|wpa_s
operator|->
name|cross_connect_disallowed
condition|)
name|wpas_p2p_disable_cross_connect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
else|else
name|wpas_p2p_enable_cross_connect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
operator|&&
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancelled P2P group idle timeout"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_notif_disconnected
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpas_p2p_disable_cross_connect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
operator|&&
operator|!
name|eloop_is_timeout_registered
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
condition|)
name|wpas_p2p_set_group_idle_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_cross_connect_setup
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|cross_connection
condition|)
return|return;
for|for
control|(
name|iface
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
name|iface
operator|==
name|wpa_s
condition|)
continue|continue;
if|if
condition|(
name|iface
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_DEDICATED_INTERFACE
condition|)
continue|continue;
if|if
condition|(
name|iface
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_CAPABLE
condition|)
continue|continue;
name|wpa_s
operator|->
name|cross_connect_enabled
operator|=
literal|1
expr_stmt|;
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|cross_connect_uplink
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|cross_connect_uplink
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Enable cross connection from "
literal|"%s to %s whenever uplink is available"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|ap_iface
operator|||
name|iface
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
name|iface
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
operator|||
name|iface
operator|->
name|cross_connect_disallowed
operator|||
name|iface
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
condition|)
break|break;
name|wpa_s
operator|->
name|cross_connect_in_use
operator|=
literal|1
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_CROSS_CONNECT_ENABLE
literal|"%s %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|wpas_p2p_notif_pbc_overlap
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|p2p_group_interface
operator|!=
name|P2P_GROUP_INTERFACE_CLIENT
operator|&&
operator|!
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
return|return
literal|0
return|;
comment|/* not P2P client operation */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Terminate connection due to WPS PBC "
literal|"session overlap"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|!=
name|wpa_s
operator|->
name|parent
condition|)
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_OVERLAP
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_group_formation_failed
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_group_formation_completed
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_update_channel_list
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|p2p_channels
name|chan
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|chan
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|chan
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpas_p2p_setup_channels
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|chan
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to update supported "
literal|"channel list"
argument_list|)
expr_stmt|;
return|return;
block|}
name|p2p_update_channel_list
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
operator|&
name|chan
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_scan_res_ignore
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore scan results"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_cancel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|wpa_s
operator|->
name|global
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|peer
decl_stmt|;
if|if
condition|(
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Request to cancel group formation"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|&&
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|)
condition|)
name|found
operator|=
literal|1
expr_stmt|;
name|peer
operator|=
name|p2p_get_go_neg_peer
argument_list|(
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unauthorize pending GO Neg peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|p2p_unauthorize
argument_list|(
name|global
operator|->
name|p2p
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|scan_res_handler
operator|==
name|wpas_p2p_scan_res_join
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Stop pending scan for join"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_res_handler
operator|=
name|wpas_p2p_scan_res_ignore
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|pending_pd_before_join
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Stop pending PD before join"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
name|wpas_p2p_stop_find
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpa_s
operator|==
name|global
operator|->
name|p2p_group_formation
operator|&&
operator|(
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|||
name|wpa_s
operator|->
name|parent
operator|->
name|pending_interface_type
operator|==
name|WPA_IF_P2P_CLIENT
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Interface %s in group "
literal|"formation found - cancelling"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
block|{
name|wpas_group_formation_completed
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_REQUESTED
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No ongoing group formation found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_interface_unavailable
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
operator|!
name|wpa_s
operator|->
name|current_ssid
operator|->
name|p2p_group
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove group due to driver resource not "
literal|"being available anymore"
argument_list|)
expr_stmt|;
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_UNAVAILABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_update_best_channels
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq_24
parameter_list|,
name|int
name|freq_5
parameter_list|,
name|int
name|freq_overall
parameter_list|)
block|{
name|struct
name|p2p_data
modifier|*
name|p2p
init|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p
decl_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
operator|||
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
operator|)
condition|)
return|return;
name|p2p_set_best_channels
argument_list|(
name|p2p
argument_list|,
name|freq_24
argument_list|,
name|freq_5
argument_list|,
name|freq_overall
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_unauthorize
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|addr
parameter_list|)
block|{
name|u8
name|peer
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|p2p_data
modifier|*
name|p2p
init|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p
decl_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
operator|||
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_MGMT
operator|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|addr
argument_list|,
name|peer
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_unauthorize
argument_list|(
name|p2p
argument_list|,
name|peer
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_disconnect - Disconnect from a P2P Group  * @wpa_s: Pointer to wpa_supplicant data  * Returns: 0 on success, -1 on failure  *  * This can be used to disconnect from a group in which the local end is a P2P  * Client or to end a P2P Group in case the local end is the Group Owner. If a  * virtual network interface was created for this group, that interface will be  * removed. Otherwise, only the configured P2P group network will be removed  * from the interface.  */
end_comment

begin_function
name|int
name|wpas_p2p_disconnect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_REQUESTED
argument_list|)
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_in_progress
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
name|p2p_in_progress
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_network_removed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|&&
name|ssid
operator|->
name|p2p_group
operator|&&
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/** 		 * Remove the network by scheduling the group formation 		 * timeout to happen immediately. The teardown code 		 * needs to be scheduled to run asynch later so that we 		 * don't delete data from under ourselves unexpectedly. 		 * Calling wpas_p2p_group_formation_timeout directly 		 * causes a series of crashes in WPS failure scenarios. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Canceled group formation due to "
literal|"P2P group network getting removed"
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|struct
name|wpa_ssid
modifier|*
name|wpas_p2p_get_persistent
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|!=
literal|2
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|&&
operator|(
name|ssid_len
operator|!=
name|s
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|!=
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
name|os_memcmp
argument_list|(
name|s
operator|->
name|bssid
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|s
return|;
comment|/* peer is GO in the persistent group */
if|if
condition|(
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|||
name|s
operator|->
name|p2p_client_list
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|s
operator|->
name|num_p2p_clients
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
name|ETH_ALEN
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|s
return|;
comment|/* peer is P2P client in persistent 					   * group */
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_notify_ap_sta_authorized
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
return|return;
name|wpas_p2p_add_persistent_group_client
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_fallback_to_go_neg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|group_added
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|group
init|=
name|wpa_s
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
condition|)
name|group
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
expr_stmt|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|parent
expr_stmt|;
name|offchannel_send_action_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|group_added
condition|)
name|wpas_p2p_group_delete
argument_list|(
name|group
argument_list|,
name|P2P_GROUP_REMOVAL_SILENT
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Fall back to GO Negotiation"
argument_list|)
expr_stmt|;
name|wpas_p2p_connect
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
name|wpa_s
operator|->
name|p2p_wps_method
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_group
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|p2p_go_intent
argument_list|,
name|wpa_s
operator|->
name|p2p_connect_freq
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_id
argument_list|,
name|wpa_s
operator|->
name|p2p_pd_before_go_neg
argument_list|,
name|wpa_s
operator|->
name|p2p_go_ht40
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_scan_no_go_seen
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
operator|||
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|<=
literal|5
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wpas_p2p_peer_go
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
operator|>
literal|0
condition|)
return|return
literal|0
return|;
comment|/* peer operating as a GO */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO not found for p2p_connect-auto - "
literal|"fallback to GO Negotiation"
argument_list|)
expr_stmt|;
name|wpas_p2p_fallback_to_go_neg
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|wpas_p2p_search_delay
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|rn
decl_stmt|,
modifier|*
name|rn2
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|ifs
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>
name|WPA_SCANNING
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use %u ms search delay due to "
literal|"concurrent operation"
argument_list|,
name|P2P_CONCURRENT_SEARCH_DELAY
argument_list|)
expr_stmt|;
return|return
name|P2P_CONCURRENT_SEARCH_DELAY
return|;
block|}
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|driver
operator|->
name|get_radio_name
condition|)
return|return
literal|0
return|;
name|rn
operator|=
name|wpa_s
operator|->
name|driver
operator|->
name|get_radio_name
argument_list|(
name|wpa_s
operator|->
name|drv_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|rn
operator|==
name|NULL
operator|||
name|rn
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
return|return
literal|0
return|;
for|for
control|(
name|ifs
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|ifs
condition|;
name|ifs
operator|=
name|ifs
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ifs
operator|==
name|wpa_s
operator|||
operator|!
name|ifs
operator|->
name|driver
operator|->
name|get_radio_name
condition|)
continue|continue;
name|rn2
operator|=
name|ifs
operator|->
name|driver
operator|->
name|get_radio_name
argument_list|(
name|ifs
operator|->
name|drv_priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rn2
operator|||
name|os_strcmp
argument_list|(
name|rn
argument_list|,
name|rn2
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|ifs
operator|->
name|wpa_state
operator|>
name|WPA_SCANNING
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use %u ms search "
literal|"delay due to concurrent operation on "
literal|"interface %s"
argument_list|,
name|P2P_CONCURRENT_SEARCH_DELAY
argument_list|,
name|ifs
operator|->
name|ifname
argument_list|)
expr_stmt|;
return|return
name|P2P_CONCURRENT_SEARCH_DELAY
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************* *                                                                  * *    File: CIFPLOT/edges.c                                         * *    Written by Dan Fitzpatrick                                    * *    copyright 1980 -- Regents of the University of California     * *                                                                  * ********************************************************************/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"globals.h"
end_include

begin_include
include|#
directive|include
file|"parser_defs.h"
end_include

begin_include
include|#
directive|include
file|"structs.h"
end_include

begin_include
include|#
directive|include
file|"out_structs.h"
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|"alloc.h"
end_include

begin_function_decl
name|IMPORT
name|point
modifier|*
name|MakePoint
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|point
modifier|*
name|TransPt
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|Command
modifier|*
name|MakeFlash
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|Command
modifier|*
name|MakeBox
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|transform
modifier|*
name|MatrixMult
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|transform
modifier|*
name|Translate
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|real
name|ICompare
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|real
name|TCompare
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|StartEdgePath
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|iedge
modifier|*
name|NextEdgePath
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|iedge
modifier|*
name|EndEdgePath
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|FORWARD
name|iedge
modifier|*
name|MakeEdge
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|FORWARD
name|PolyDesc
modifier|*
name|MakeDesc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|FORWARD
name|instance
modifier|*
name|MakeItem
parameter_list|()
function_decl|;
end_function_decl

begin_macro
name|Instanciate
argument_list|(
argument|c
argument_list|,
argument|trans
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|Command
modifier|*
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|transform
modifier|*
name|trans
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|instance
modifier|*
name|i
decl_stmt|;
name|Command
modifier|*
name|p
decl_stmt|;
name|real
name|x
decl_stmt|,
name|y
decl_stmt|,
name|xmin
decl_stmt|,
name|ymin
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|SYMBOL
condition|)
name|Error
argument_list|(
literal|"Tried to Instanciate a Non-Symbol"
argument_list|,
name|INTERNAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth
operator|==
literal|0
operator|||
name|n
operator|<=
name|depth
condition|)
block|{
for|for
control|(
name|p
operator|=
name|c
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|CStart
init|;
name|p
operator|!=
name|NIL
condition|;
name|p
operator|=
name|p
operator|->
name|CLink
control|)
block|{
name|i
operator|=
name|MakeItem
argument_list|(
name|p
argument_list|,
name|trans
argument_list|,
name|n
operator|+
literal|1
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|symbox
condition|)
name|DrawBBox
argument_list|(
operator|&
operator|(
name|c
operator|->
name|CBBox
operator|)
argument_list|,
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|c
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SName
operator|)
operator|==
literal|'\0'
condition|)
return|return;
name|xmin
operator|=
name|c
operator|->
name|CBBox
operator|.
name|xmin
expr_stmt|;
name|ymin
operator|=
name|c
operator|->
name|CBBox
operator|.
name|ymin
expr_stmt|;
name|Trans
argument_list|(
operator|&
name|xmin
argument_list|,
operator|&
name|ymin
argument_list|,
name|trans
argument_list|)
expr_stmt|;
name|x
operator|=
name|c
operator|->
name|CBBox
operator|.
name|xmax
expr_stmt|;
name|y
operator|=
name|c
operator|->
name|CBBox
operator|.
name|ymin
expr_stmt|;
name|Trans
argument_list|(
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|+
name|y
operator|<
name|xmin
operator|+
name|ymin
condition|)
block|{
name|ymin
operator|=
name|y
expr_stmt|;
name|xmin
operator|=
name|x
expr_stmt|;
block|}
name|x
operator|=
name|c
operator|->
name|CBBox
operator|.
name|xmax
expr_stmt|;
name|y
operator|=
name|c
operator|->
name|CBBox
operator|.
name|ymax
expr_stmt|;
name|Trans
argument_list|(
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|+
name|y
operator|<
name|xmin
operator|+
name|ymin
condition|)
block|{
name|ymin
operator|=
name|y
expr_stmt|;
name|xmin
operator|=
name|x
expr_stmt|;
block|}
name|x
operator|=
name|c
operator|->
name|CBBox
operator|.
name|xmin
expr_stmt|;
name|y
operator|=
name|c
operator|->
name|CBBox
operator|.
name|ymax
expr_stmt|;
name|Trans
argument_list|(
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|+
name|y
operator|<
name|xmin
operator|+
name|ymin
condition|)
block|{
name|ymin
operator|=
name|y
expr_stmt|;
name|xmin
operator|=
name|x
expr_stmt|;
block|}
name|ClipText
argument_list|(
name|c
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SName
argument_list|,
name|xmin
argument_list|,
name|ymin
argument_list|,
literal|'S'
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Don't instanciate this symbol; just draw box and name*/
name|DrawBBox
argument_list|(
operator|&
operator|(
name|c
operator|->
name|CBBox
operator|)
argument_list|,
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|c
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SName
operator|)
operator|==
literal|'\0'
condition|)
return|return;
name|xmin
operator|=
name|c
operator|->
name|CBBox
operator|.
name|xmin
expr_stmt|;
name|ymin
operator|=
name|c
operator|->
name|CBBox
operator|.
name|ymin
expr_stmt|;
name|Trans
argument_list|(
operator|&
name|xmin
argument_list|,
operator|&
name|ymin
argument_list|,
name|trans
argument_list|)
expr_stmt|;
name|x
operator|=
name|c
operator|->
name|CBBox
operator|.
name|xmax
expr_stmt|;
name|y
operator|=
name|c
operator|->
name|CBBox
operator|.
name|ymax
expr_stmt|;
name|Trans
argument_list|(
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|trans
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|xmin
operator|+
name|x
operator|)
operator|/
literal|2
expr_stmt|;
name|y
operator|=
operator|(
name|ymin
operator|+
name|y
operator|)
operator|/
literal|2
expr_stmt|;
name|ClipText
argument_list|(
name|c
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SName
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|'C'
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|Activate
argument_list|(
argument|i
argument_list|)
end_macro

begin_decl_stmt
name|instance
modifier|*
name|i
decl_stmt|;
end_decl_stmt

begin_block
block|{
switch|switch
condition|(
name|i
operator|->
name|type
condition|)
block|{
case|case
name|CALL
case|:
block|{
name|transform
modifier|*
name|t
decl_stmt|;
name|t
operator|=
name|MatrixMult
argument_list|(
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Call
operator|.
name|trans
argument_list|,
name|i
operator|->
name|trans
argument_list|)
expr_stmt|;
name|Instanciate
argument_list|(
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Call
operator|.
name|CSymb
argument_list|,
name|t
argument_list|,
name|i
operator|->
name|depth
argument_list|)
expr_stmt|;
block|}
name|FreeItem
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
name|ARRAY
case|:
block|{
name|int
name|j
decl_stmt|,
name|k
decl_stmt|;
name|point
name|pt
decl_stmt|;
name|transform
modifier|*
name|trans
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|instance
modifier|*
name|inst
decl_stmt|;
name|pt
operator|.
name|x
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|Am
condition|;
name|j
operator|++
control|)
block|{
name|pt
operator|.
name|y
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|An
condition|;
name|k
operator|++
control|)
block|{
name|trans
operator|=
name|Translate
argument_list|(
operator|&
name|pt
argument_list|,
name|ident
argument_list|)
expr_stmt|;
name|t
operator|=
name|MatrixMult
argument_list|(
name|trans
argument_list|,
name|i
operator|->
name|trans
argument_list|)
expr_stmt|;
name|FreeTransform
argument_list|(
name|trans
argument_list|)
expr_stmt|;
name|inst
operator|=
name|MakeItem
argument_list|(
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|ACom
argument_list|,
name|t
argument_list|,
name|i
operator|->
name|depth
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|inst
argument_list|)
expr_stmt|;
name|pt
operator|.
name|y
operator|+=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|Ady
expr_stmt|;
block|}
name|pt
operator|.
name|x
operator|+=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|Adx
expr_stmt|;
block|}
block|}
break|break;
case|case
name|POLYGON
case|:
block|{
name|PolyDesc
modifier|*
name|poly
decl_stmt|;
name|PointList
modifier|*
name|path
decl_stmt|;
name|iedge
modifier|*
name|e
decl_stmt|;
name|point
modifier|*
name|pt
decl_stmt|;
name|poly
operator|=
name|MakeDesc
argument_list|(
name|i
operator|->
name|item
argument_list|)
expr_stmt|;
name|path
operator|=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Path
expr_stmt|;
name|pt
operator|=
operator|&
operator|(
name|path
operator|->
name|pt
operator|)
expr_stmt|;
name|StartEdgePath
argument_list|(
name|pt
operator|->
name|x
argument_list|,
name|pt
operator|->
name|y
argument_list|,
name|i
operator|->
name|trans
argument_list|,
name|poly
argument_list|)
expr_stmt|;
comment|/* Assertion: there are at least two points 		 * in every polygon	*/
for|for
control|(
name|path
operator|=
name|path
operator|->
name|PLink
init|;
name|path
operator|!=
name|NIL
condition|;
name|path
operator|=
name|path
operator|->
name|PLink
control|)
block|{
name|pt
operator|=
operator|&
operator|(
name|path
operator|->
name|pt
operator|)
expr_stmt|;
name|e
operator|=
name|NextEdgePath
argument_list|(
name|pt
operator|->
name|x
argument_list|,
name|pt
operator|->
name|y
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
name|e
operator|=
name|EndEdgePath
argument_list|()
expr_stmt|;
name|Selector
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
name|FreeItem
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
name|BOX
case|:
block|{
name|PolyDesc
modifier|*
name|poly
decl_stmt|;
name|point
modifier|*
name|d
decl_stmt|;
name|real
name|ly
decl_stmt|,
name|lx
decl_stmt|,
name|wx
decl_stmt|,
name|wy
decl_stmt|,
name|cx
decl_stmt|,
name|cy
decl_stmt|,
name|c
decl_stmt|;
name|iedge
modifier|*
name|e
decl_stmt|;
name|poly
operator|=
name|MakeDesc
argument_list|(
name|i
operator|->
name|item
argument_list|)
expr_stmt|;
name|d
operator|=
operator|&
operator|(
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|bdirect
operator|)
expr_stmt|;
name|c
operator|=
name|sqrt
argument_list|(
name|d
operator|->
name|x
operator|*
name|d
operator|->
name|x
operator|+
name|d
operator|->
name|y
operator|*
name|d
operator|->
name|y
argument_list|)
expr_stmt|;
name|cx
operator|=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|bcenter
operator|.
name|x
expr_stmt|;
name|cy
operator|=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|bcenter
operator|.
name|y
expr_stmt|;
name|lx
operator|=
operator|(
name|d
operator|->
name|x
operator|*
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|blength
operator|)
operator|/
operator|(
name|c
operator|*
literal|2.0
operator|)
expr_stmt|;
name|ly
operator|=
operator|(
name|d
operator|->
name|y
operator|*
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|blength
operator|)
operator|/
operator|(
name|c
operator|*
literal|2.0
operator|)
expr_stmt|;
name|wx
operator|=
operator|-
operator|(
name|d
operator|->
name|y
operator|*
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|bwidth
operator|)
operator|/
operator|(
name|c
operator|*
literal|2.0
operator|)
expr_stmt|;
name|wy
operator|=
operator|(
name|d
operator|->
name|x
operator|*
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|bwidth
operator|)
operator|/
operator|(
name|c
operator|*
literal|2.0
operator|)
expr_stmt|;
name|StartEdgePath
argument_list|(
name|cx
operator|-
name|lx
operator|-
name|wx
argument_list|,
name|cy
operator|-
name|ly
operator|-
name|wy
argument_list|,
name|i
operator|->
name|trans
argument_list|,
name|poly
argument_list|)
expr_stmt|;
name|e
operator|=
name|NextEdgePath
argument_list|(
name|cx
operator|-
name|lx
operator|+
name|wx
argument_list|,
name|cy
operator|-
name|ly
operator|+
name|wy
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|e
operator|=
name|NextEdgePath
argument_list|(
name|cx
operator|+
name|lx
operator|+
name|wx
argument_list|,
name|cy
operator|+
name|ly
operator|+
name|wy
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|e
operator|=
name|NextEdgePath
argument_list|(
name|cx
operator|+
name|lx
operator|-
name|wx
argument_list|,
name|cy
operator|+
name|ly
operator|-
name|wy
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|e
operator|=
name|EndEdgePath
argument_list|()
expr_stmt|;
name|Selector
argument_list|(
name|e
argument_list|)
expr_stmt|;
comment|/* 		e = MakeEdge(cx-lx-wx,cy-ly-wy,cx-lx+wx,cy-ly+wy,i->trans,poly); 		Selector(e); 		e = MakeEdge(cx-lx+wx,cy-ly+wy,cx+lx+wx,cy+ly+wy,i->trans,poly); 		Selector(e); 		e = MakeEdge(cx+lx+wx,cy+ly+wy,cx+lx-wx,cy+ly-wy,i->trans,poly); 		Selector(e); 		e = MakeEdge(cx+lx-wx,cy+ly-wy,cx-lx-wx,cy-ly-wy,i->trans,poly); 		Selector(e); 		*/
name|FreeItem
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|FLASH
case|:
block|{
name|PolyDesc
modifier|*
name|poly
decl_stmt|;
name|poly
operator|=
name|MakeDesc
argument_list|(
name|i
operator|->
name|item
argument_list|)
expr_stmt|;
name|MakeNgon
argument_list|(
name|circle
argument_list|,
operator|&
operator|(
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Flash
operator|.
name|fcenter
operator|)
argument_list|,
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Flash
operator|.
name|fdia
operator|/
literal|2.0
argument_list|,
name|i
operator|->
name|trans
argument_list|,
name|poly
argument_list|)
expr_stmt|;
block|}
name|FreeItem
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
name|WIRE
case|:
block|{
name|real
name|width
decl_stmt|;
name|PointList
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
name|Command
modifier|*
name|com
decl_stmt|;
name|instance
modifier|*
name|inst
decl_stmt|;
name|point
modifier|*
name|dir
decl_stmt|,
modifier|*
name|cen
decl_stmt|;
name|real
name|x
decl_stmt|,
name|y
decl_stmt|;
name|int
name|level
decl_stmt|;
if|if
condition|(
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WIns
operator|==
name|NIL
condition|)
block|{
name|width
operator|=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WWidth
expr_stmt|;
name|level
operator|=
name|i
operator|->
name|item
operator|->
name|level
expr_stmt|;
name|p1
operator|=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WPath
expr_stmt|;
name|com
operator|=
name|MakeFlash
argument_list|(
name|width
argument_list|,
operator|&
operator|(
name|p1
operator|->
name|pt
operator|)
argument_list|)
expr_stmt|;
name|com
operator|->
name|level
operator|=
name|level
expr_stmt|;
name|com
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WIns
operator|=
name|com
expr_stmt|;
name|inst
operator|=
name|MakeItem
argument_list|(
name|com
argument_list|,
name|i
operator|->
name|trans
argument_list|,
name|i
operator|->
name|depth
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|inst
argument_list|)
expr_stmt|;
for|for
control|(
operator|(
name|p2
operator|=
name|p1
operator|,
name|p1
operator|=
name|p1
operator|->
name|PLink
operator|)
init|;
name|p1
operator|!=
name|NIL
condition|;
operator|(
name|p2
operator|=
name|p1
operator|,
name|p1
operator|=
name|p1
operator|->
name|PLink
operator|)
control|)
block|{
name|x
operator|=
name|p1
operator|->
name|pt
operator|.
name|x
operator|-
name|p2
operator|->
name|pt
operator|.
name|x
expr_stmt|;
name|y
operator|=
name|p1
operator|->
name|pt
operator|.
name|y
operator|-
name|p2
operator|->
name|pt
operator|.
name|y
expr_stmt|;
name|com
operator|=
name|MakeFlash
argument_list|(
name|width
argument_list|,
operator|&
operator|(
name|p1
operator|->
name|pt
operator|)
argument_list|)
expr_stmt|;
name|com
operator|->
name|level
operator|=
name|level
expr_stmt|;
name|com
operator|->
name|CLink
operator|=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WIns
expr_stmt|;
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WIns
operator|=
name|com
expr_stmt|;
name|inst
operator|=
name|MakeItem
argument_list|(
name|com
argument_list|,
name|i
operator|->
name|trans
argument_list|,
name|i
operator|->
name|depth
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|inst
argument_list|)
expr_stmt|;
name|dir
operator|=
name|MakePoint
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|cen
operator|=
name|MakePoint
argument_list|(
operator|(
name|p1
operator|->
name|pt
operator|.
name|x
operator|+
name|p2
operator|->
name|pt
operator|.
name|x
operator|)
operator|/
literal|2.0
argument_list|,
operator|(
name|p1
operator|->
name|pt
operator|.
name|y
operator|+
name|p2
operator|->
name|pt
operator|.
name|y
operator|)
operator|/
literal|2.0
argument_list|)
expr_stmt|;
name|com
operator|=
name|MakeBox
argument_list|(
name|sqrt
argument_list|(
name|x
operator|*
name|x
operator|+
name|y
operator|*
name|y
argument_list|)
argument_list|,
name|width
argument_list|,
name|cen
argument_list|,
name|dir
argument_list|)
expr_stmt|;
name|com
operator|->
name|level
operator|=
name|level
expr_stmt|;
name|com
operator|->
name|CLink
operator|=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WIns
expr_stmt|;
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WIns
operator|=
name|com
expr_stmt|;
name|inst
operator|=
name|MakeItem
argument_list|(
name|com
argument_list|,
name|i
operator|->
name|trans
argument_list|,
name|i
operator|->
name|depth
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|inst
argument_list|)
expr_stmt|;
name|Free
argument_list|(
name|cen
argument_list|)
expr_stmt|;
name|Free
argument_list|(
name|dir
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|com
operator|=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WIns
init|;
name|com
operator|!=
name|NIL
condition|;
name|com
operator|=
name|com
operator|->
name|CLink
control|)
block|{
name|inst
operator|=
name|MakeItem
argument_list|(
name|com
argument_list|,
name|i
operator|->
name|trans
argument_list|,
name|i
operator|->
name|depth
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|inst
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|FreeItem
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
name|EDGE
case|:
name|Clip
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
operator|(
operator|(
operator|(
name|iedge
operator|*
operator|)
name|i
operator|)
operator|->
name|poly
operator|->
name|refs
operator|)
operator|==
literal|0
condition|)
name|FreeDesc
argument_list|(
operator|(
operator|(
name|iedge
operator|*
operator|)
name|i
operator|)
operator|->
name|poly
argument_list|)
expr_stmt|;
name|FreeIEdge
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
name|POINTNAME
case|:
block|{
name|real
name|x
decl_stmt|,
name|y
decl_stmt|;
name|x
operator|=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|loc
operator|.
name|x
expr_stmt|;
name|y
operator|=
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|loc
operator|.
name|y
expr_stmt|;
name|Trans
argument_list|(
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
name|i
operator|->
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|extractor
condition|)
name|ClipText
argument_list|(
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|Name
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|'T'
argument_list|)
expr_stmt|;
else|else
name|OutputExtPoint
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|i
operator|->
name|item
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|Name
argument_list|,
name|i
operator|->
name|item
operator|->
name|level
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|STEXT
case|:
block|{
name|real
name|x
decl_stmt|,
name|y
decl_stmt|;
name|Command
modifier|*
name|icom
decl_stmt|;
name|icom
operator|=
operator|(
name|Command
operator|*
operator|)
name|i
expr_stmt|;
name|x
operator|=
name|icom
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|loc
operator|.
name|x
expr_stmt|;
name|y
operator|=
name|icom
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|loc
operator|.
name|y
expr_stmt|;
name|ClipText
argument_list|(
name|icom
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|Name
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|'T'
argument_list|)
expr_stmt|;
name|FreeStif
argument_list|(
name|icom
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VECTOR
case|:
block|{
name|Command
modifier|*
name|icom
decl_stmt|;
name|PointList
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
name|icom
operator|=
operator|(
name|Command
operator|*
operator|)
name|i
expr_stmt|;
name|p1
operator|=
name|icom
operator|->
name|Ctype
operator|.
name|Path
expr_stmt|;
if|if
condition|(
name|p1
operator|==
name|NIL
condition|)
name|Error
argument_list|(
literal|"Vector has null path in edge"
argument_list|,
name|INTERNAL
argument_list|)
expr_stmt|;
for|for
control|(
operator|(
name|p2
operator|=
name|p1
operator|,
name|p1
operator|=
name|p1
operator|->
name|PLink
operator|)
init|;
name|p1
operator|!=
name|NIL
condition|;
operator|(
name|p2
operator|=
name|p1
operator|,
name|p1
operator|=
name|p1
operator|->
name|PLink
operator|)
control|)
block|{
name|MakeLine
argument_list|(
name|p1
operator|->
name|pt
operator|.
name|x
argument_list|,
name|p1
operator|->
name|pt
operator|.
name|y
argument_list|,
name|p2
operator|->
name|pt
operator|.
name|x
argument_list|,
name|p2
operator|->
name|pt
operator|.
name|y
argument_list|,
name|ident
argument_list|)
expr_stmt|;
block|}
name|FreeStif
argument_list|(
name|icom
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SPOLYGON
case|:
block|{
name|PolyDesc
modifier|*
name|poly
decl_stmt|;
name|PointList
modifier|*
name|path
decl_stmt|;
name|iedge
modifier|*
name|e
decl_stmt|;
name|point
modifier|*
name|pt
decl_stmt|;
name|Command
modifier|*
name|icom
decl_stmt|;
name|icom
operator|=
operator|(
name|Command
operator|*
operator|)
name|i
expr_stmt|;
name|i
operator|=
operator|(
name|instance
operator|*
operator|)
literal|0xffffffff
expr_stmt|;
comment|/* debugging */
name|poly
operator|=
name|MakeDesc
argument_list|(
name|icom
argument_list|)
expr_stmt|;
name|path
operator|=
name|icom
operator|->
name|Ctype
operator|.
name|Path
expr_stmt|;
name|pt
operator|=
operator|&
operator|(
name|path
operator|->
name|pt
operator|)
expr_stmt|;
name|StartEdgePath
argument_list|(
name|pt
operator|->
name|x
argument_list|,
name|pt
operator|->
name|y
argument_list|,
name|ident
argument_list|,
name|poly
argument_list|)
expr_stmt|;
comment|/* Assertion: there are at least two points 		 * in every polygon	*/
for|for
control|(
name|path
operator|=
name|path
operator|->
name|PLink
init|;
name|path
operator|!=
name|NIL
condition|;
name|path
operator|=
name|path
operator|->
name|PLink
control|)
block|{
name|pt
operator|=
operator|&
operator|(
name|path
operator|->
name|pt
operator|)
expr_stmt|;
name|e
operator|=
name|NextEdgePath
argument_list|(
name|pt
operator|->
name|x
argument_list|,
name|pt
operator|->
name|y
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
name|e
operator|=
name|EndEdgePath
argument_list|()
expr_stmt|;
name|Selector
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|FreeStif
argument_list|(
name|icom
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SFLASH
case|:
block|{
name|PolyDesc
modifier|*
name|poly
decl_stmt|;
name|Command
modifier|*
name|icom
decl_stmt|;
name|icom
operator|=
operator|(
name|Command
operator|*
operator|)
name|i
expr_stmt|;
name|i
operator|=
operator|(
name|instance
operator|*
operator|)
literal|0xffffffff
expr_stmt|;
comment|/* debugging */
name|poly
operator|=
name|MakeDesc
argument_list|(
name|icom
argument_list|)
expr_stmt|;
name|MakeNgon
argument_list|(
name|circle
argument_list|,
operator|&
operator|(
name|icom
operator|->
name|Ctype
operator|.
name|Flash
operator|.
name|fcenter
operator|)
argument_list|,
name|icom
operator|->
name|Ctype
operator|.
name|Flash
operator|.
name|fdia
operator|/
literal|2.0
argument_list|,
name|ident
argument_list|,
name|poly
argument_list|)
expr_stmt|;
name|FreeStif
argument_list|(
name|icom
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SWIRE
case|:
block|{
name|real
name|width
decl_stmt|;
name|PointList
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
name|Command
modifier|*
name|ncom
decl_stmt|;
name|instance
modifier|*
name|inst
decl_stmt|;
name|point
modifier|*
name|dir
decl_stmt|,
modifier|*
name|cen
decl_stmt|;
name|real
name|x
decl_stmt|,
name|y
decl_stmt|;
name|int
name|level
decl_stmt|;
name|Command
modifier|*
name|icom
decl_stmt|;
name|icom
operator|=
operator|(
name|Command
operator|*
operator|)
name|i
expr_stmt|;
name|i
operator|=
operator|(
name|instance
operator|*
operator|)
literal|0xffffffff
expr_stmt|;
comment|/* debugging */
name|width
operator|=
name|icom
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WWidth
expr_stmt|;
name|level
operator|=
name|icom
operator|->
name|level
expr_stmt|;
name|p1
operator|=
name|icom
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WPath
expr_stmt|;
name|ncom
operator|=
name|MakeFlash
argument_list|(
name|width
argument_list|,
operator|&
operator|(
name|p1
operator|->
name|pt
operator|)
argument_list|)
expr_stmt|;
name|ncom
operator|->
name|level
operator|=
name|level
expr_stmt|;
name|ncom
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
name|inst
operator|=
name|MakeItem
argument_list|(
name|ncom
argument_list|,
name|ident
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|inst
argument_list|)
expr_stmt|;
for|for
control|(
operator|(
name|p2
operator|=
name|p1
operator|,
name|p1
operator|=
name|p1
operator|->
name|PLink
operator|)
init|;
name|p1
operator|!=
name|NIL
condition|;
operator|(
name|p2
operator|=
name|p1
operator|,
name|p1
operator|=
name|p1
operator|->
name|PLink
operator|)
control|)
block|{
name|x
operator|=
name|p1
operator|->
name|pt
operator|.
name|x
operator|-
name|p2
operator|->
name|pt
operator|.
name|x
expr_stmt|;
name|y
operator|=
name|p1
operator|->
name|pt
operator|.
name|y
operator|-
name|p2
operator|->
name|pt
operator|.
name|y
expr_stmt|;
name|ncom
operator|=
name|MakeFlash
argument_list|(
name|width
argument_list|,
operator|&
operator|(
name|p1
operator|->
name|pt
operator|)
argument_list|)
expr_stmt|;
name|ncom
operator|->
name|level
operator|=
name|level
expr_stmt|;
name|inst
operator|=
name|MakeItem
argument_list|(
name|ncom
argument_list|,
name|ident
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|inst
argument_list|)
expr_stmt|;
name|dir
operator|=
name|MakePoint
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|cen
operator|=
name|MakePoint
argument_list|(
operator|(
name|p1
operator|->
name|pt
operator|.
name|x
operator|+
name|p2
operator|->
name|pt
operator|.
name|x
operator|)
operator|/
literal|2.0
argument_list|,
operator|(
name|p1
operator|->
name|pt
operator|.
name|y
operator|+
name|p2
operator|->
name|pt
operator|.
name|y
operator|)
operator|/
literal|2.0
argument_list|)
expr_stmt|;
name|ncom
operator|=
name|MakeBox
argument_list|(
name|sqrt
argument_list|(
name|x
operator|*
name|x
operator|+
name|y
operator|*
name|y
argument_list|)
argument_list|,
name|width
argument_list|,
name|cen
argument_list|,
name|dir
argument_list|)
expr_stmt|;
name|ncom
operator|->
name|level
operator|=
name|level
expr_stmt|;
name|inst
operator|=
name|MakeItem
argument_list|(
name|ncom
argument_list|,
name|ident
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Selector
argument_list|(
name|inst
argument_list|)
expr_stmt|;
name|Free
argument_list|(
name|cen
argument_list|)
expr_stmt|;
name|Free
argument_list|(
name|dir
argument_list|)
expr_stmt|;
block|}
name|FreeStif
argument_list|(
name|icom
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCALL
case|:
name|StifCall
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|FreeStif
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
default|default:
name|Error
argument_list|(
literal|"Tried to Activate Unknown type"
argument_list|,
name|INTERNAL
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|instance
modifier|*
name|MakeItem
parameter_list|(
name|c
parameter_list|,
name|trans
parameter_list|,
name|n
parameter_list|)
name|Command
modifier|*
name|c
decl_stmt|;
name|transform
modifier|*
name|trans
decl_stmt|;
name|int
name|n
decl_stmt|;
block|{
name|instance
modifier|*
name|i
decl_stmt|;
name|i
operator|=
name|GetItem
argument_list|()
expr_stmt|;
name|i
operator|->
name|type
operator|=
name|c
operator|->
name|type
expr_stmt|;
name|i
operator|->
name|Link
operator|=
name|NIL
expr_stmt|;
name|i
operator|->
name|trans
operator|=
name|trans
expr_stmt|;
name|trans
operator|->
name|refs
operator|++
expr_stmt|;
name|i
operator|->
name|item
operator|=
name|c
expr_stmt|;
name|i
operator|->
name|depth
operator|=
name|n
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
name|iedge
modifier|*
name|MakeEdge
parameter_list|(
name|rx1
parameter_list|,
name|ry1
parameter_list|,
name|rx2
parameter_list|,
name|ry2
parameter_list|,
name|trans
parameter_list|,
name|poly
parameter_list|)
name|real
name|rx1
decl_stmt|,
name|rx2
decl_stmt|,
name|ry1
decl_stmt|,
name|ry2
decl_stmt|;
name|transform
modifier|*
name|trans
decl_stmt|;
name|PolyDesc
modifier|*
name|poly
decl_stmt|;
block|{
name|iedge
modifier|*
name|e
decl_stmt|;
name|real
name|t
decl_stmt|;
name|e
operator|=
name|GetIEdge
argument_list|()
expr_stmt|;
name|e
operator|->
name|type
operator|=
name|EDGE
expr_stmt|;
name|e
operator|->
name|poly
operator|=
name|poly
expr_stmt|;
operator|(
name|poly
operator|->
name|refs
operator|)
operator|++
expr_stmt|;
name|Trans
argument_list|(
operator|&
name|rx1
argument_list|,
operator|&
name|ry1
argument_list|,
name|trans
argument_list|)
expr_stmt|;
name|Trans
argument_list|(
operator|&
name|rx2
argument_list|,
operator|&
name|ry2
argument_list|,
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|rx1
operator|<=
name|rx2
condition|)
name|e
operator|->
name|dir
operator|=
literal|1
expr_stmt|;
else|else
block|{
name|e
operator|->
name|dir
operator|=
operator|-
literal|1
expr_stmt|;
name|SWAP
argument_list|(
name|rx1
argument_list|,
name|rx2
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|SWAP
argument_list|(
name|ry1
argument_list|,
name|ry2
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
comment|/* Now rx1<= rx2 and the direction is set */
comment|/* Now convert from CIF units to plotter units */
name|e
operator|->
name|x1
operator|=
name|CONVERT
argument_list|(
name|rx1
argument_list|)
expr_stmt|;
name|e
operator|->
name|y1
operator|=
name|CONVERT
argument_list|(
name|ry1
argument_list|)
expr_stmt|;
name|e
operator|->
name|x2
operator|=
name|CONVERT
argument_list|(
name|rx2
argument_list|)
expr_stmt|;
name|e
operator|->
name|y2
operator|=
name|CONVERT
argument_list|(
name|ry2
argument_list|)
expr_stmt|;
name|e
operator|->
name|min
operator|=
name|CONVERT
argument_list|(
name|rx1
argument_list|)
expr_stmt|;
return|return
operator|(
name|e
operator|)
return|;
block|}
end_function

begin_function
name|PolyDesc
modifier|*
name|MakeDesc
parameter_list|(
name|c
parameter_list|)
name|Command
modifier|*
name|c
decl_stmt|;
block|{
name|PolyDesc
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|GetDesc
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|!=
name|NIL
condition|)
name|p
operator|->
name|level
operator|=
name|c
operator|->
name|level
expr_stmt|;
else|else
name|p
operator|->
name|level
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|refs
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|p
operator|)
return|;
block|}
end_function

begin_comment
comment|/* FreeInstance(i) instance *i; {     if(--(i->trans->refs) == 0) FreeTransform(i->trans);     FreeItem(i);     }     */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************* *                                                                  * *    File: CIFPLOT/make.c                                          * *    Written by Dan Fitzpatrick                                    * *    copyright 1980 -- Regents of the University of California     * *                                                                  * ********************************************************************/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"globals.h"
end_include

begin_include
include|#
directive|include
file|"parser_defs.h"
end_include

begin_include
include|#
directive|include
file|"structs.h"
end_include

begin_include
include|#
directive|include
file|"alloc.h"
end_include

begin_function_decl
name|IMPORT
name|Command
modifier|*
name|FindSymbol
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|Command
modifier|*
name|alloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|Command
modifier|*
name|palloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|struct
name|LCell
modifier|*
name|FindLayer
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|Free
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|State
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|CopyDelete
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|Error
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|ZeroBBox
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|CompBBox
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|CompPtBBox
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|MakeBBox
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|transform
modifier|*
name|MakeTransform
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|IMPORT
name|char
modifier|*
name|Concat
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|Command
modifier|*
name|MakeComment
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* Forward Reference */
end_comment

begin_function
name|Command
modifier|*
name|MakePoly
parameter_list|(
name|p
parameter_list|)
name|struct
name|PathHeader
modifier|*
name|p
decl_stmt|;
block|{
name|Command
modifier|*
name|command
decl_stmt|;
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|POLYGON
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Path
operator|=
name|p
operator|->
name|PHead
expr_stmt|;
name|Free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|command
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
name|MakeBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|,
name|command
argument_list|)
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
block|}
end_function

begin_function
name|Command
modifier|*
name|MakeBox
parameter_list|(
name|length
parameter_list|,
name|width
parameter_list|,
name|center
parameter_list|,
name|direct
parameter_list|)
name|real
name|length
decl_stmt|,
name|width
decl_stmt|;
name|point
modifier|*
name|center
decl_stmt|,
decl|*
name|direct
decl_stmt|;
end_function

begin_block
block|{
name|Command
modifier|*
name|command
decl_stmt|;
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|BOX
expr_stmt|;
name|command
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|blength
operator|=
name|length
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|bwidth
operator|=
name|width
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|bcenter
operator|.
name|x
operator|=
name|center
operator|->
name|x
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|bcenter
operator|.
name|y
operator|=
name|center
operator|->
name|y
expr_stmt|;
name|CheckPoint
argument_list|(
name|direct
argument_list|)
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|bdirect
operator|.
name|x
operator|=
name|direct
operator|->
name|x
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Box
operator|.
name|bdirect
operator|.
name|y
operator|=
name|direct
operator|->
name|y
expr_stmt|;
name|MakeBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|,
name|command
argument_list|)
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
block|}
end_block

begin_macro
name|CheckPoint
argument_list|(
argument|pt
argument_list|)
end_macro

begin_decl_stmt
name|point
modifier|*
name|pt
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|(
name|pt
operator|->
name|x
operator|==
literal|0.0
operator|)
operator|&&
operator|(
name|pt
operator|->
name|y
operator|==
literal|0.0
operator|)
condition|)
block|{
name|pt
operator|->
name|x
operator|=
literal|1.0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_function
name|Command
modifier|*
name|MakeFlash
parameter_list|(
name|dia
parameter_list|,
name|center
parameter_list|)
name|real
name|dia
decl_stmt|;
name|point
modifier|*
name|center
decl_stmt|;
block|{
name|Command
modifier|*
name|command
decl_stmt|;
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|FLASH
expr_stmt|;
name|command
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Flash
operator|.
name|fdia
operator|=
name|dia
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Flash
operator|.
name|fcenter
operator|.
name|x
operator|=
name|center
operator|->
name|x
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Flash
operator|.
name|fcenter
operator|.
name|y
operator|=
name|center
operator|->
name|y
expr_stmt|;
name|MakeBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|,
name|command
argument_list|)
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
block|}
end_function

begin_function
name|Command
modifier|*
name|MakeWire
parameter_list|(
name|width
parameter_list|,
name|p
parameter_list|)
name|real
name|width
decl_stmt|;
name|struct
name|PathHeader
modifier|*
name|p
decl_stmt|;
block|{
name|Command
modifier|*
name|command
decl_stmt|;
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|WIRE
expr_stmt|;
name|ZeroBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|)
expr_stmt|;
name|command
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WWidth
operator|=
name|width
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WPath
operator|=
name|p
operator|->
name|PHead
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Wire
operator|.
name|WIns
operator|=
name|NIL
expr_stmt|;
name|Free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|MakeBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|,
name|command
argument_list|)
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
block|}
end_function

begin_function
name|Command
modifier|*
name|MakeSymbol
parameter_list|(
name|num
parameter_list|,
name|a
parameter_list|,
name|b
parameter_list|)
name|int
name|num
decl_stmt|,
name|a
decl_stmt|,
name|b
decl_stmt|;
block|{
name|Command
modifier|*
name|command
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|struct
name|CCell
modifier|*
name|q
decl_stmt|;
name|char
name|s
index|[
literal|128
index|]
decl_stmt|;
switch|switch
condition|(
name|State
argument_list|(
name|num
argument_list|)
condition|)
block|{
case|case
name|USED
case|:
case|case
name|UNUSED
case|:
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"Symbol %d redefined"
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|Error
argument_list|(
name|s
argument_list|,
name|WARNING
argument_list|)
expr_stmt|;
name|p
operator|=
name|FindSymbol
argument_list|(
name|num
argument_list|)
expr_stmt|;
name|p
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|status
operator|=
name|DELETED
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|backTrace
operator|!=
name|NIL
condition|)
name|Error
argument_list|(
literal|"Dangling References after Symbol Redefintion"
argument_list|,
name|WARNING
argument_list|)
expr_stmt|;
for|for
control|(
name|q
operator|=
name|p
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|backTrace
init|;
name|q
operator|!=
name|NIL
condition|;
name|q
operator|=
name|q
operator|->
name|CCLink
control|)
name|CopyDelete
argument_list|(
name|q
operator|->
name|CCCom
argument_list|)
expr_stmt|;
comment|/* Fall through and create new symbol */
case|case
name|DELETED
case|:
case|case
name|NONEXIST
case|:
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|SYMBOL
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SymNo
operator|=
name|num
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|backTrace
operator|=
name|NIL
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|status
operator|=
name|UNUSED
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|a
operator|=
name|a
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|b
operator|=
name|b
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|CStart
operator|=
name|NIL
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|CFinnish
operator|=
name|NIL
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SName
operator|=
name|Concat
argument_list|(
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|command
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
name|command
operator|->
name|level
operator|=
operator|-
literal|1
expr_stmt|;
name|ZeroBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
case|case
name|UNDEFINED
case|:
name|command
operator|=
name|FindSymbol
argument_list|(
name|num
argument_list|)
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|status
operator|=
name|UNEXAMINED
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|a
operator|=
name|a
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|b
operator|=
name|b
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
default|default:
block|{
name|char
name|s
index|[
literal|128
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"Symbol %d in unknown state\n"
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|Error
argument_list|(
name|s
argument_list|,
name|INTERNAL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|Command
modifier|*
name|AddCmd
parameter_list|(
name|h
parameter_list|,
name|c
parameter_list|)
name|Command
modifier|*
name|h
decl_stmt|;
name|Command
modifier|*
name|c
decl_stmt|;
block|{
name|Command
modifier|*
name|p
decl_stmt|;
switch|switch
condition|(
name|c
operator|->
name|type
condition|)
block|{
case|case
name|COMMENT
case|:
name|FreeCommand
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
name|h
operator|)
return|;
case|case
name|NAME
case|:
if|if
condition|(
operator|*
operator|(
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SName
operator|)
operator|!=
literal|'\0'
condition|)
block|{
name|char
name|s
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|msg
decl_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"Symbol %d has already been named "
argument_list|,
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SymNo
argument_list|)
expr_stmt|;
name|msg
operator|=
name|Concat
argument_list|(
name|s
argument_list|,
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SName
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Error
argument_list|(
name|msg
argument_list|,
name|WARNING
argument_list|)
expr_stmt|;
name|Free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SName
operator|=
name|Concat
argument_list|(
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SName
argument_list|,
literal|"--"
argument_list|,
name|c
operator|->
name|Ctype
operator|.
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|FreeCommand
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
name|h
operator|)
return|;
block|}
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SName
operator|=
name|c
operator|->
name|Ctype
operator|.
name|s
expr_stmt|;
name|FreeCommand
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
name|h
operator|)
return|;
case|case
name|LAYER
case|:
name|h
operator|->
name|level
operator|=
name|c
operator|->
name|level
expr_stmt|;
name|FreeCommand
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
name|h
operator|)
return|;
case|case
name|WIRE
case|:
case|case
name|POLYGON
case|:
case|case
name|BOX
case|:
case|case
name|FLASH
case|:
comment|/* Check for valid layer description */
if|if
condition|(
name|h
operator|->
name|level
operator|==
operator|-
literal|1
condition|)
block|{
name|Error
argument_list|(
literal|"Layer not Specified"
argument_list|,
name|RECOVERABLE
argument_list|)
expr_stmt|;
name|h
operator|->
name|level
operator|=
literal|0
expr_stmt|;
block|}
case|case
name|POINTNAME
case|:
case|case
name|TEXT
case|:
case|case
name|CALL
case|:
case|case
name|ARRAY
case|:
comment|/* Add new command to end of command list */
if|if
condition|(
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|CStart
operator|==
name|NIL
condition|)
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|CFinnish
operator|=
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|CStart
operator|=
name|c
expr_stmt|;
else|else
block|{
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|CFinnish
operator|->
name|CLink
operator|=
name|c
expr_stmt|;
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|CFinnish
operator|=
name|c
expr_stmt|;
block|}
comment|/* New Command may itself be a list (i.e. a wire) */
for|for
control|(
name|p
operator|=
name|c
init|;
name|p
operator|!=
name|NIL
condition|;
name|p
operator|=
name|p
operator|->
name|CLink
control|)
block|{
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|CFinnish
operator|=
name|p
expr_stmt|;
comment|/* Set to current level */
name|p
operator|->
name|level
operator|=
name|h
operator|->
name|level
expr_stmt|;
block|}
return|return
operator|(
name|h
operator|)
return|;
default|default:
block|{
name|char
name|s
index|[
literal|128
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"Unknown Command in Defintion of Symbol %d\n"
argument_list|,
name|h
operator|->
name|Ctype
operator|.
name|Symbl
operator|.
name|SymNo
argument_list|)
expr_stmt|;
name|Error
argument_list|(
name|s
argument_list|,
name|INTERNAL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|Command
modifier|*
name|MakeCall
parameter_list|(
name|num
parameter_list|,
name|trans
parameter_list|)
name|int
name|num
decl_stmt|;
name|transform
modifier|*
name|trans
decl_stmt|;
block|{
name|Command
modifier|*
name|command
decl_stmt|;
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|CALL
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Call
operator|.
name|CallNo
operator|=
name|num
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Call
operator|.
name|trans
operator|=
name|trans
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Call
operator|.
name|CSymb
operator|=
name|NIL
expr_stmt|;
name|ZeroBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|)
expr_stmt|;
name|command
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
block|}
end_function

begin_function
name|Command
modifier|*
name|MakeComment
parameter_list|()
block|{
name|Command
modifier|*
name|command
decl_stmt|;
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|COMMENT
expr_stmt|;
name|ZeroBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|)
expr_stmt|;
name|command
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|PathHeader
modifier|*
name|MakePath
parameter_list|(
name|pt
parameter_list|)
name|point
modifier|*
name|pt
decl_stmt|;
block|{
name|PointList
modifier|*
name|path
decl_stmt|;
name|struct
name|PathHeader
modifier|*
name|PH
decl_stmt|;
name|path
operator|=
operator|(
name|PointList
operator|*
operator|)
name|alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|PointList
argument_list|)
argument_list|)
expr_stmt|;
name|PH
operator|=
operator|(
expr|struct
name|PathHeader
operator|*
operator|)
name|alloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|PathHeader
argument_list|)
argument_list|)
expr_stmt|;
name|PH
operator|->
name|PNo
operator|=
literal|1
expr_stmt|;
name|PH
operator|->
name|PHead
operator|=
name|PH
operator|->
name|PTail
operator|=
name|path
expr_stmt|;
name|path
operator|->
name|PLink
operator|=
name|NIL
expr_stmt|;
name|path
operator|->
name|pt
operator|.
name|x
operator|=
name|pt
operator|->
name|x
expr_stmt|;
name|path
operator|->
name|pt
operator|.
name|y
operator|=
name|pt
operator|->
name|y
expr_stmt|;
return|return
operator|(
name|PH
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|PathHeader
modifier|*
name|AddPath
parameter_list|(
name|PH
parameter_list|,
name|pt
parameter_list|)
name|struct
name|PathHeader
modifier|*
name|PH
decl_stmt|;
name|point
modifier|*
name|pt
decl_stmt|;
block|{
name|PointList
modifier|*
name|newpath
decl_stmt|;
name|newpath
operator|=
operator|(
name|PointList
operator|*
operator|)
name|alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|PointList
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|PH
operator|->
name|PNo
operator|)
operator|++
expr_stmt|;
name|PH
operator|->
name|PTail
operator|->
name|PLink
operator|=
name|newpath
expr_stmt|;
name|PH
operator|->
name|PTail
operator|=
name|newpath
expr_stmt|;
name|newpath
operator|->
name|PLink
operator|=
name|NIL
expr_stmt|;
name|newpath
operator|->
name|pt
operator|.
name|x
operator|=
name|pt
operator|->
name|x
expr_stmt|;
name|newpath
operator|->
name|pt
operator|.
name|y
operator|=
name|pt
operator|->
name|y
expr_stmt|;
return|return
operator|(
name|PH
operator|)
return|;
block|}
end_function

begin_function
name|point
modifier|*
name|MakePoint
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
name|real
name|x
decl_stmt|,
name|y
decl_stmt|;
block|{
name|point
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
name|point
operator|*
operator|)
name|alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|point
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|x
operator|=
name|x
expr_stmt|;
name|p
operator|->
name|y
operator|=
name|y
expr_stmt|;
return|return
operator|(
name|p
operator|)
return|;
block|}
end_function

begin_function
name|Command
modifier|*
name|MakeArray
parameter_list|(
name|s
parameter_list|,
name|m
parameter_list|,
name|n
parameter_list|,
name|dx
parameter_list|,
name|dy
parameter_list|)
name|int
name|s
decl_stmt|,
name|m
decl_stmt|,
name|n
decl_stmt|;
name|real
name|dx
decl_stmt|,
name|dy
decl_stmt|;
block|{
name|Command
modifier|*
name|command
decl_stmt|;
name|transform
modifier|*
name|t
decl_stmt|;
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|ARRAY
expr_stmt|;
name|ZeroBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|)
expr_stmt|;
name|command
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
name|t
operator|=
name|MakeTransform
argument_list|()
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|ACom
operator|=
name|MakeCall
argument_list|(
name|s
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|As
operator|=
name|s
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|Am
operator|=
name|m
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|An
operator|=
name|n
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|Adx
operator|=
name|dx
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Array
operator|.
name|Ady
operator|=
name|dy
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
block|}
end_function

begin_function
name|Command
modifier|*
name|MakePointName
parameter_list|(
name|s
parameter_list|,
name|pt
parameter_list|,
name|label
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|,
decl|*
name|label
decl_stmt|;
end_function

begin_decl_stmt
name|point
modifier|*
name|pt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Command
modifier|*
name|command
decl_stmt|;
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|POINTNAME
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|Name
operator|=
name|s
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|loc
operator|.
name|x
operator|=
name|pt
operator|->
name|x
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|loc
operator|.
name|y
operator|=
name|pt
operator|->
name|y
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|PointName
operator|.
name|Label
operator|=
name|label
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|label
argument_list|,
literal|"all"
argument_list|)
operator|==
literal|0
condition|)
name|command
operator|->
name|level
operator|=
operator|-
literal|1
expr_stmt|;
else|else
block|{
name|struct
name|LCell
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|FindLayer
argument_list|(
name|label
argument_list|)
operator|)
operator|==
name|NIL
condition|)
block|{
name|Error
argument_list|(
literal|"Unknown layer"
argument_list|,
name|RECOVERABLE
argument_list|)
expr_stmt|;
name|command
operator|->
name|level
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|command
operator|->
name|level
operator|=
name|p
operator|->
name|LNum
expr_stmt|;
block|}
name|MakeBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|,
name|command
argument_list|)
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
block|}
end_block

begin_function
name|Command
modifier|*
name|MakeName
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|Command
modifier|*
name|command
decl_stmt|;
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|NAME
expr_stmt|;
name|ZeroBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|)
expr_stmt|;
name|command
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|s
operator|=
name|s
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
block|}
end_function

begin_function
name|Command
modifier|*
name|MakeText
parameter_list|(
name|s
parameter_list|,
name|t
parameter_list|,
name|c
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
name|transform
modifier|*
name|t
decl_stmt|;
name|char
name|c
decl_stmt|;
block|{
name|Command
modifier|*
name|command
decl_stmt|;
name|command
operator|=
name|GetCommand
argument_list|()
expr_stmt|;
name|command
operator|->
name|type
operator|=
name|TEXT
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Text
operator|.
name|TString
operator|=
name|s
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Text
operator|.
name|TTrans
operator|=
name|t
expr_stmt|;
name|command
operator|->
name|Ctype
operator|.
name|Text
operator|.
name|TLoc
operator|=
name|c
expr_stmt|;
name|ZeroBBox
argument_list|(
operator|&
operator|(
name|command
operator|->
name|CBBox
operator|)
argument_list|)
expr_stmt|;
name|command
operator|->
name|CLink
operator|=
name|NIL
expr_stmt|;
return|return
operator|(
name|command
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	DZ-11 driver  *	------------  *  *	OPTIMIZED dz driver to handle multiple dzs as efficiently  *	as possible.  The efficiency is gained by disabling all  *	dz transmitter interrupts and using a KW11-P to generate  *	suitable interrupts.  Carrier is supported but not Ring.  *  *				Ian Johnstone	UNSW  *				May 1979  */
end_comment

begin_include
include|#
directive|include
file|"../defines.h"
end_include

begin_include
include|#
directive|include
file|"../param.h"
end_include

begin_include
include|#
directive|include
file|"../conf.h"
end_include

begin_include
include|#
directive|include
file|"../user.h"
end_include

begin_include
include|#
directive|include
file|"../tty.h"
end_include

begin_include
include|#
directive|include
file|"../proc.h"
end_include

begin_define
define|#
directive|define
name|NDZ
value|7
end_define

begin_comment
comment|/* no. of dz-11s */
end_comment

begin_define
define|#
directive|define
name|NDZLIN
value|8
end_define

begin_comment
comment|/* no. of lines per dz DO NOT ALTER */
end_comment

begin_define
define|#
directive|define
name|NLINES
value|(NDZLIN*NDZ)
end_define

begin_comment
comment|/* total no. of lines available */
end_comment

begin_define
define|#
directive|define
name|SSPEED
value|11
end_define

begin_comment
comment|/* standard speed 2400 bd */
end_comment

begin_define
define|#
directive|define
name|CLOCK
value|0172540
end_define

begin_comment
comment|/* kw11-p lives here */
end_comment

begin_struct
struct|struct
block|{
name|int
name|csr
decl_stmt|;
comment|/* control and status */
define|#
directive|define
name|GO
value|0101
comment|/* down, single, 100K, run */
name|unsigned
name|counter
decl_stmt|;
comment|/* counter */
block|}
struct|;
end_struct

begin_escape
end_escape

begin_decl_stmt
name|struct
name|tty
name|dz11
index|[
name|NLINES
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* tty structures for this dz */
end_comment

begin_struct
struct|struct
name|dz
comment|/* one for each dz-11 */
block|{
name|int
modifier|*
name|dzaddr
decl_stmt|;
comment|/* control registers for this dz */
name|char
name|nocarr
decl_stmt|;
comment|/* set for lines WITHOUT carrier */
name|char
name|sopen
decl_stmt|;
comment|/* set for lines with exclusive use */
name|struct
name|tty
modifier|*
name|ttys
index|[
name|NDZLIN
index|]
decl_stmt|;
comment|/* address of tty structs this dz */
comment|/* that is only ONE `open' allowed */
name|char
name|openl
decl_stmt|;
comment|/* flags for open lines */
name|char
name|closl
decl_stmt|;
comment|/* flags to indicate closing lines */
name|char
name|xmit
decl_stmt|;
comment|/* set for lines to transmit on */
name|unsigned
name|pyerrors
decl_stmt|;
comment|/* number of parity errors on input */
name|unsigned
name|overrors
decl_stmt|;
comment|/* number of overrun errors on input */
name|int
name|closet
index|[
name|NDZLIN
index|]
decl_stmt|;
comment|/* handle closing via this field */
block|}
name|dz
index|[
name|NDZ
index|]
block|{
block|{
literal|0160100
operator|,
literal|0377
operator|,
literal|0000
operator|,
operator|&
name|dz11
index|[
literal|000
index|]
operator|,
operator|&
name|dz11
index|[
literal|001
index|]
operator|,
operator|&
name|dz11
index|[
literal|002
index|]
operator|,
operator|&
name|dz11
index|[
literal|003
index|]
operator|,
operator|&
name|dz11
index|[
literal|004
index|]
operator|,
operator|&
name|dz11
index|[
literal|005
index|]
operator|,
operator|&
name|dz11
index|[
literal|006
index|]
operator|,
operator|&
name|dz11
index|[
literal|007
index|]
block|}
operator|,
block|{
literal|0160110
operator|,
literal|0007
operator|,
literal|0000
operator|,
operator|&
name|dz11
index|[
literal|010
index|]
operator|,
operator|&
name|dz11
index|[
literal|011
index|]
operator|,
operator|&
name|dz11
index|[
literal|012
index|]
operator|,
operator|&
name|dz11
index|[
literal|013
index|]
operator|,
operator|&
name|dz11
index|[
literal|014
index|]
operator|,
operator|&
name|dz11
index|[
literal|015
index|]
operator|,
operator|&
name|dz11
index|[
literal|016
index|]
operator|,
operator|&
name|dz11
index|[
literal|017
index|]
block|}
operator|,
block|{
literal|0160120
operator|,
literal|0320
operator|,
literal|0020
operator|,
operator|&
name|dz11
index|[
literal|020
index|]
operator|,
operator|&
name|dz11
index|[
literal|021
index|]
operator|,
operator|&
name|dz11
index|[
literal|022
index|]
operator|,
operator|&
name|dz11
index|[
literal|023
index|]
operator|,
operator|&
name|dz11
index|[
literal|024
index|]
operator|,
operator|&
name|dz11
index|[
literal|025
index|]
operator|,
operator|&
name|dz11
index|[
literal|026
index|]
operator|,
operator|&
name|dz11
index|[
literal|027
index|]
block|}
operator|,
block|{
literal|0160130
operator|,
literal|0000
operator|,
literal|0000
operator|,
operator|&
name|dz11
index|[
literal|030
index|]
operator|,
operator|&
name|dz11
index|[
literal|031
index|]
operator|,
operator|&
name|dz11
index|[
literal|032
index|]
operator|,
operator|&
name|dz11
index|[
literal|033
index|]
operator|,
operator|&
name|dz11
index|[
literal|034
index|]
operator|,
operator|&
name|dz11
index|[
literal|035
index|]
operator|,
operator|&
name|dz11
index|[
literal|036
index|]
operator|,
operator|&
name|dz11
index|[
literal|037
index|]
block|}
operator|,
block|{
literal|0160140
operator|,
literal|0000
operator|,
literal|0000
operator|,
operator|&
name|dz11
index|[
literal|040
index|]
operator|,
operator|&
name|dz11
index|[
literal|041
index|]
operator|,
operator|&
name|dz11
index|[
literal|042
index|]
operator|,
operator|&
name|dz11
index|[
literal|043
index|]
operator|,
operator|&
name|dz11
index|[
literal|044
index|]
operator|,
operator|&
name|dz11
index|[
literal|045
index|]
operator|,
operator|&
name|dz11
index|[
literal|046
index|]
operator|,
operator|&
name|dz11
index|[
literal|047
index|]
block|}
operator|,
block|{
literal|0160150
operator|,
literal|0360
operator|,
literal|0100
operator|,
operator|&
name|dz11
index|[
literal|050
index|]
operator|,
operator|&
name|dz11
index|[
literal|051
index|]
operator|,
operator|&
name|dz11
index|[
literal|052
index|]
operator|,
operator|&
name|dz11
index|[
literal|053
index|]
operator|,
operator|&
name|dz11
index|[
literal|054
index|]
operator|,
operator|&
name|dz11
index|[
literal|055
index|]
operator|,
operator|&
name|dz11
index|[
literal|056
index|]
operator|,
operator|&
name|dz11
index|[
literal|057
index|]
block|}
operator|,
block|{
literal|0160160
operator|,
literal|0110
operator|,
literal|0013
operator|,
operator|&
name|dz11
index|[
literal|060
index|]
operator|,
operator|&
name|dz11
index|[
literal|061
index|]
operator|,
operator|&
name|dz11
index|[
literal|062
index|]
operator|,
operator|&
name|dz11
index|[
literal|063
index|]
operator|,
operator|&
name|dz11
index|[
literal|064
index|]
operator|,
operator|&
name|dz11
index|[
literal|065
index|]
operator|,
operator|&
name|dz11
index|[
literal|066
index|]
operator|,
operator|&
name|dz11
index|[
literal|067
index|]
block|}
operator|,
comment|/* 	{ 	  0160170, 0377, 0000,&dz11[070],&dz11[071],&dz11[072],&dz11[073],&dz11[074],&dz11[075],&dz11[076],&dz11[077] 	} */
block|}
struct|;
end_struct

begin_decl_stmt
name|int
name|dzopenc
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* equal to total number of 'open' lines */
end_comment

begin_decl_stmt
name|int
name|dzrcvscan
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* when<= 0 scan receiver silos */
end_comment

begin_decl_stmt
name|char
name|dzbitab
index|[
name|NDZLIN
index|]
comment|/* convert line numbers to bit pattern */
block|{
literal|0001
operator|,
literal|0002
operator|,
literal|0004
operator|,
literal|0010
operator|,
literal|0020
operator|,
literal|0040
operator|,
literal|0100
operator|,
literal|0200
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_define
define|#
directive|define
name|SPLDZ
value|spl5
end_define

begin_comment
comment|/* dz interrupts at this priority */
end_comment

begin_escape
end_escape

begin_comment
comment|/*  *	DZ11 register layout  */
end_comment

begin_struct
struct|struct
name|dzr_read
block|{
name|int
name|dzcsr
decl_stmt|;
comment|/* r/w */
name|int
name|dzrbuf
decl_stmt|;
comment|/* no bit, byte, or tst ops */
name|char
name|dztcr
decl_stmt|;
comment|/* r/w */
name|char
name|dzdtr
decl_stmt|;
comment|/* r/w */
name|char
name|dzring
decl_stmt|;
name|char
name|dzcarr
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|dzr_write
block|{
name|int
name|dzcsr
decl_stmt|;
name|int
name|dzlpr
decl_stmt|;
comment|/* no bit or byte ops */
name|char
name|dztcr
decl_stmt|;
name|char
name|dzdtr
decl_stmt|;
name|char
name|dztbuf
decl_stmt|;
comment|/* no bit ops */
name|char
name|dzbrk
decl_stmt|;
comment|/* no bit ops */
block|}
struct|;
end_struct

begin_comment
comment|/*  *	register control bits  */
end_comment

begin_define
define|#
directive|define
name|SAE
value|010000
end_define

begin_comment
comment|/* dzcsr */
end_comment

begin_define
define|#
directive|define
name|RIE
value|0100
end_define

begin_define
define|#
directive|define
name|MSE
value|040
end_define

begin_define
define|#
directive|define
name|RCVR_ON
value|010000
end_define

begin_comment
comment|/* dzlpr */
end_comment

begin_define
define|#
directive|define
name|ODD_PAR
value|0300
end_define

begin_define
define|#
directive|define
name|EVN_PAR
value|0100
end_define

begin_define
define|#
directive|define
name|TWOSBIT
value|040
end_define

begin_define
define|#
directive|define
name|C8BIT
value|030
end_define

begin_define
define|#
directive|define
name|C7BIT
value|020
end_define

begin_define
define|#
directive|define
name|RERROR
value|070000
end_define

begin_comment
comment|/* dzrbuf */
end_comment

begin_define
define|#
directive|define
name|OVR_RUN
value|040000
end_define

begin_define
define|#
directive|define
name|FRAME
value|020000
end_define

begin_define
define|#
directive|define
name|PARITY
value|010000
end_define

begin_escape
end_escape

begin_comment
comment|/*  *	Table to map UNIX standard speeds to DZ11 speeds.  *	Illegal speeds are ignored, and are indicated by 0200 bit.  */
end_comment

begin_decl_stmt
name|char
name|dzspeedmap
index|[
literal|16
index|]
block|{
literal|0200
comment|/* 0 - zero */
operator|,
literal|0220
comment|/* 1 - 50 */
operator|,
literal|0221
comment|/* 2 - 75 */
operator|,
literal|0222
comment|/* 3 - 110 */
operator|,
literal|0223
comment|/* 4 - 134.5 */
operator|,
literal|0224
comment|/* 5 - 150 */
operator|,
literal|0200
comment|/* 6 - ILLEGAL */
define|#
directive|define
name|LOWSPEED
value|7
comment|/* lowest speed allowed on dz */
operator|,
literal|025
comment|/* 7 - 300 */
operator|,
literal|026
comment|/* 8 - 600 */
operator|,
literal|027
comment|/* 9 - 1200 */
operator|,
literal|0230
comment|/* 10 - 1800 */
operator|,
literal|032
comment|/* 11 - 2400 */
operator|,
literal|034
comment|/* 12 - 4800 */
operator|,
literal|036
comment|/* 13 - 9600 */
operator|,
literal|0231
comment|/* 14 - ext A - maps to 2000 */
operator|,
literal|0237
comment|/* 15 - ext B - maps to 19200 */
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_escape
end_escape

begin_comment
comment|/*  *	Table to map UNIX standard speeds to time between interrupts for  *	a line running at that speed.  The value in the table is multiplied  *	by 10 to get a value in microseconds.  A nominal 20 microseconds  *	is subtracted to make up for interrupt overhead.  */
end_comment

begin_decl_stmt
name|unsigned
name|dzmicmap
index|[
literal|16
index|]
block|{
literal|0
comment|/* 0 - zero */
operator|,
literal|19998
comment|/* 1 - 50 */
operator|,
literal|13331
comment|/* 2 - 75 */
operator|,
literal|9088
comment|/* 3 - 110 */
operator|,
literal|7433
comment|/* 4 - 134.5 */
operator|,
literal|6665
comment|/* 5 - 150 */
operator|,
literal|0
comment|/* 6 - ILLEGAL */
operator|,
literal|3331
comment|/* 7 - 300 */
operator|,
literal|1665
comment|/* 8 - 600 */
operator|,
literal|831
comment|/* 9 - 1200 */
operator|,
literal|554
comment|/* 10 - 1800 */
operator|,
literal|415
comment|/* 11 - 2400 */
operator|,
literal|206
comment|/* 12 - 4800 */
operator|,
literal|102
comment|/* 13 - 9600 */
operator|,
literal|498
comment|/* 14 - ext A - maps to 2000 */
operator|,
literal|50
comment|/* 15 - ext B - maps to 19200 */
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_escape
end_escape

begin_comment
comment|/*  *	open a DZ11 line  */
end_comment

begin_macro
name|dzopen
argument_list|(
argument|dev
argument_list|,
argument|flag
argument_list|)
end_macro

begin_block
block|{
extern|extern dzstart(
block|)
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|dz
modifier|*
name|dzp
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|register
name|lino
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|lino
operator|=
name|dev
operator|.
name|d_minor
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|lino
operator|>=
name|NLINES
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|ENXIO
expr_stmt|;
return|return;
block|}
end_if

begin_expr_stmt
name|dzp
operator|=
operator|&
name|dz
index|[
name|lino
operator|>>
literal|3
index|]
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|fkword
argument_list|(
name|dzp
operator|->
name|dzaddr
argument_list|)
condition|)
comment|/* fix036 */
block|{
name|u
operator|.
name|u_error
operator|=
name|ENXIO
expr_stmt|;
return|return;
block|}
end_if

begin_comment
comment|/* fix036 */
end_comment

begin_expr_stmt
name|tp
operator|=
operator|&
name|dz11
index|[
name|lino
index|]
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|lino
operator|=
operator|&
literal|07
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|(
name|dzp
operator|->
name|sopen
operator|&
name|dzbitab
index|[
name|lino
index|]
operator|)
operator|&&
operator|(
name|dzp
operator|->
name|openl
operator|&
name|dzbitab
index|[
name|lino
index|]
operator|)
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|EOPENFAIL
expr_stmt|;
return|return;
block|}
end_if

begin_if
if|if
condition|(
name|u
operator|.
name|u_procp
operator|->
name|p_ttyp
operator|==
literal|0
condition|)
name|u
operator|.
name|u_procp
operator|->
name|p_ttyp
operator|=
name|tp
expr_stmt|;
end_if

begin_expr_stmt
name|SPLDZ
argument_list|()
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|(
name|dzp
operator|->
name|openl
operator|&
name|dzbitab
index|[
name|lino
index|]
operator|)
operator|==
literal|0
condition|)
block|{
name|tp
operator|->
name|t_dev
operator|=
name|dev
expr_stmt|;
name|tp
operator|->
name|t_state
operator|=
operator|(
name|ISOPEN
operator||
name|CARR_ON
operator||
name|SSTART
operator|)
expr_stmt|;
name|tp
operator|->
name|t_addr
operator|=
operator|&
name|dzstart
expr_stmt|;
name|tp
operator|->
name|t_speeds
operator|=
name|SSPEED
operator||
operator|(
name|SSPEED
operator|<<
literal|8
operator|)
expr_stmt|;
name|tp
operator|->
name|t_flags
operator|=
name|ODDP
operator||
name|EVENP
operator||
name|XTABS
operator||
name|RAW
expr_stmt|;
name|tp
operator|->
name|t_erase
operator|=
name|CERASE
expr_stmt|;
name|tp
operator|->
name|t_kill
operator|=
name|CKILL
expr_stmt|;
name|dzparam
argument_list|(
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dzp
operator|->
name|openl
operator|==
literal|0
condition|)
name|dzp
operator|->
name|dzaddr
operator|->
name|dzcsr
operator|=
operator||
operator|(
name|RIE
operator||
name|SAE
operator||
name|MSE
operator|)
expr_stmt|;
comment|/* init */
name|dzp
operator|->
name|openl
operator|=
operator||
name|dzbitab
index|[
name|lino
index|]
expr_stmt|;
if|if
condition|(
name|dzopenc
operator|++
operator|==
literal|0
condition|)
name|dzxint
argument_list|()
expr_stmt|;
comment|/* start transmitting */
block|}
else|else
name|dzp
operator|->
name|closl
operator|=
operator|&
operator|~
name|dzbitab
index|[
name|lino
index|]
expr_stmt|;
end_if

begin_expr_stmt
name|spl0
argument_list|()
expr_stmt|;
end_expr_stmt

begin_comment
unit|}
comment|/*  *	close a DZ11 line  */
end_comment

begin_expr_stmt
unit|dzclose
operator|(
name|dev
operator|)
block|{
specifier|register
expr|struct
name|tty
operator|*
name|tp
block|;
specifier|register
expr|struct
name|dz
operator|*
name|dzp
block|;
specifier|register
name|lino
block|;
name|lino
operator|=
name|dev
operator|.
name|d_minor
block|;
name|dzp
operator|=
operator|&
name|dz
index|[
name|lino
operator|>>
literal|3
index|]
block|;
name|tp
operator|=
operator|&
name|dz11
index|[
name|lino
index|]
block|;
name|lino
operator|=
operator|&
literal|07
block|;
name|dzp
operator|->
name|closet
index|[
name|lino
index|]
operator|=
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|<<
literal|1
block|;
comment|/* time for close */
name|dzp
operator|->
name|closl
operator|=
operator||
name|dzbitab
index|[
name|lino
index|]
block|;
name|dzp
operator|->
name|xmit
operator|=
operator||
name|dzbitab
index|[
name|lino
index|]
block|;
comment|/* start transmitting */
name|dzp
operator|->
name|dzaddr
operator|->
name|dztcr
operator|=
operator||
name|dzbitab
index|[
name|lino
index|]
block|;
comment|/* start transmitting */
block|}
comment|/*  *	read from a DZ11 line  */
name|dzread
argument_list|(
argument|dev
argument_list|)
block|{
name|ttread
argument_list|(
operator|&
name|dz11
index|[
name|dev
operator|.
name|d_minor
index|]
argument_list|)
block|; }
comment|/*  *	write on a DZ11 line  */
name|dzwrite
argument_list|(
argument|dev
argument_list|)
block|{
name|ttwrite
argument_list|(
operator|&
name|dz11
index|[
name|dev
operator|.
name|d_minor
index|]
argument_list|)
block|; }
comment|/*  *	stty/gtty for DZ11  */
name|dzsgtty
argument_list|(
argument|dev
argument_list|,
argument|av
argument_list|)
block|{
specifier|register
expr|struct
name|tty
operator|*
name|tp
block|;
if|if
condition|(
operator|(
name|av
operator|==
literal|0
operator|)
operator|&&
operator|(
name|dzspeedmap
index|[
name|u
operator|.
name|u_arg
index|[
literal|0
index|]
operator|&
literal|017
index|]
operator|<
literal|0
operator|)
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|ENXIO
expr_stmt|;
comment|/* illegal speed */
return|return;
block|}
name|tp
operator|=
operator|&
name|dz11
index|[
name|dev
operator|.
name|d_minor
index|]
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|ttystty
argument_list|(
name|tp
argument_list|,
name|av
argument_list|)
condition|)
return|return;
end_if

begin_expr_stmt
name|dzparam
argument_list|(
name|tp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_escape
unit|}
end_escape

begin_comment
comment|/*  *	set parameters from open or stty into DZ hardware registers  */
end_comment

begin_expr_stmt
unit|dzparam
operator|(
name|tp
operator|)
specifier|register
expr|struct
name|tty
operator|*
name|tp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|lpr
operator|,
name|x
expr_stmt|;
extern|extern wakeup(
block|)
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_expr_stmt
name|lpr
operator|=
name|dzspeedmap
index|[
name|tp
operator|->
name|t_speeds
operator|&
literal|017
index|]
operator|<<
literal|8
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|(
name|x
operator|=
name|tp
operator|->
name|t_flags
operator|)
operator|&
name|EVENP
condition|)
if|if
condition|(
operator|(
name|x
operator|&
name|ODDP
operator|)
operator|==
literal|0
condition|)
name|lpr
operator|=
operator||
operator|(
name|EVN_PAR
operator||
name|C7BIT
operator|)
expr_stmt|;
else|else
name|lpr
operator|=
operator||
name|C8BIT
expr_stmt|;
elseif|else
if|if
condition|(
name|x
operator|&
name|ODDP
condition|)
name|lpr
operator|=
operator||
operator|(
name|ODD_PAR
operator||
name|C7BIT
operator|)
expr_stmt|;
else|else
name|lpr
operator|=
operator||
name|C8BIT
expr_stmt|;
end_if

begin_comment
comment|/* set new speed, char currently in uart may be screwed */
end_comment

begin_expr_stmt
name|dz
index|[
name|tp
operator|->
name|t_dev
operator|.
name|d_minor
operator|>>
literal|3
index|]
operator|.
name|dzaddr
operator|->
name|dzlpr
operator|=
name|lpr
operator||
operator|(
name|tp
operator|->
name|t_dev
operator|.
name|d_minor
operator|&
literal|07
operator|)
expr_stmt|;
end_expr_stmt

begin_comment
unit|}
comment|/*  *	dz start routine  */
end_comment

begin_expr_stmt
unit|dzstart
operator|(
name|tp
operator|)
comment|/* at SPLDZ */
expr|struct
name|tty
operator|*
name|tp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|lino
operator|=
name|tp
operator|->
name|t_dev
operator|.
name|d_minor
expr_stmt|;
specifier|register
name|struct
name|dz
modifier|*
name|dzp
decl_stmt|;
name|dzp
operator|=
operator|&
name|dz
index|[
name|lino
operator|>>
literal|3
index|]
expr_stmt|;
name|lino
operator|=
operator|&
literal|07
expr_stmt|;
name|dzp
operator|->
name|xmit
operator|=
operator||
name|dzbitab
index|[
name|lino
index|]
expr_stmt|;
comment|/* start transmitting */
name|dzp
operator|->
name|dzaddr
operator|->
name|dztcr
operator|=
operator||
name|dzbitab
index|[
name|lino
index|]
expr_stmt|;
comment|/* start transmitting */
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/*  *	DZ11 transmitter interrupt.  *  *	Scan every line on each dz.  Internal dz limitations  *	force this scan to take an unusual form.  One line  *	from each dz is serviced each scan until no dz requires  *	service.  This is less efficient than servicing  *	entirely a dz prior to scanning the next dz but it  *	it is necessary.  *  *	dzxint is not actually invoked by a dz interrupt  *	rather it is invoked by a clock interrupt.  *	to drive multiple dz's efficiently utilizing dz  *	transmitter interrupts is just NOT possible.  */
end_comment

begin_decl_stmt
name|int
name|dzxc
decl_stmt|;
end_decl_stmt

begin_macro
name|dzxint
argument_list|()
end_macro

begin_comment
comment|/* at SPLDZ */
end_comment

begin_block
block|{
extern|extern ttrstrt(
block|)
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
specifier|register
name|struct
name|dz
modifier|*
name|dzp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|hspeed
init|=
name|LOWSPEED
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* to determine clock speed */
end_comment

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* control dz scanning */
end_comment

begin_expr_stmt
name|dzxc
operator|++
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* count */
end_comment

begin_if
if|if
condition|(
name|dzopenc
operator|==
literal|0
condition|)
return|return;
end_if

begin_comment
comment|/* stop if inactive */
end_comment

begin_comment
comment|/*	scan every dz for characters to transmit	*/
end_comment

begin_do
do|do
block|{
for|for
control|(
name|dzp
operator|=
operator|&
name|dz
index|[
literal|0
index|]
operator|,
name|flag
operator|=
literal|0
init|;
name|dzp
operator|<
operator|&
name|dz
index|[
name|NDZ
index|]
condition|;
name|dzp
operator|++
control|)
block|{
specifier|register
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
specifier|register
name|struct
name|dzr_read
modifier|*
name|dza
init|=
name|dzp
operator|->
name|dzaddr
decl_stmt|;
name|int
name|lino
decl_stmt|,
name|t_bit
decl_stmt|;
if|if
condition|(
operator|(
name|lino
operator|=
name|dza
operator|->
name|dzcsr
operator|.
name|hibyte
operator|)
operator|<
literal|0
condition|)
comment|/* xmit ?? */
block|{
name|lino
operator|=
operator|&
literal|07
expr_stmt|;
comment|/* isolate line number */
name|tp
operator|=
name|dzp
operator|->
name|ttys
index|[
name|lino
index|]
expr_stmt|;
name|t_bit
operator|=
name|dzbitab
index|[
name|lino
index|]
expr_stmt|;
comment|/* bit mask, not line number */
name|flag
operator|++
expr_stmt|;
comment|/* note service */
if|if
condition|(
operator|(
name|dzp
operator|->
name|closl
operator|&
name|t_bit
operator|)
operator|&&
operator|(
operator|(
operator|--
operator|(
name|dzp
operator|->
name|closet
index|[
name|lino
index|]
operator|)
operator|<=
literal|0
operator|)
operator|||
operator|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
comment|/* line closed, no time or chars left */
name|flushtty
argument_list|(
name|tp
argument_list|)
expr_stmt|;
name|tp
operator|->
name|t_state
operator|=
name|SSTART
expr_stmt|;
name|dzp
operator|->
name|closl
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
name|dzp
operator|->
name|openl
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
name|dzp
operator|->
name|xmit
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
name|dza
operator|->
name|dztcr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
name|dza
operator|->
name|dzdtr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
if|if
condition|(
operator|(
name|dzp
operator|->
name|closl
operator|==
literal|0
operator|)
operator|&&
operator|(
name|dzp
operator|->
name|openl
operator|==
literal|0
operator|)
condition|)
name|dza
operator|->
name|dzcsr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|--
name|dzopenc
operator|==
literal|0
condition|)
return|return;
block|}
elseif|else
if|if
condition|(
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|==
literal|0
condition|)
block|{
name|dzp
operator|->
name|xmit
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
name|dza
operator|->
name|dztcr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|dzp
operator|->
name|nocarr
operator|&
name|t_bit
operator|)
operator|||
operator|(
name|dza
operator|->
name|dzcarr
operator|&
name|t_bit
operator|)
condition|)
block|{
name|int
name|c
init|=
name|getc
argument_list|(
operator|&
name|tp
operator|->
name|t_outq
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
operator|<=
literal|0177
operator|||
name|tp
operator|->
name|t_flags
operator|==
name|RAW
condition|)
block|{
comment|/* transmit the char for this line */
name|dza
operator|->
name|dztbuf
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|t_speeds
operator|.
name|lobyte
operator|>
name|hspeed
condition|)
name|hspeed
operator|=
name|tp
operator|->
name|t_speeds
operator|.
name|lobyte
expr_stmt|;
block|}
else|else
block|{
name|dzp
operator|->
name|xmit
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
name|dza
operator|->
name|dztcr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
name|timeout
argument_list|(
operator|&
name|ttrstrt
argument_list|,
name|tp
argument_list|,
name|c
operator|&
literal|0177
argument_list|)
expr_stmt|;
name|tp
operator|->
name|t_state
operator|=
operator||
name|TIMEOUT
expr_stmt|;
block|}
comment|/* if low water mark then want more */
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|ASLEEP
operator|&&
name|tp
operator|->
name|t_outq
operator|.
name|c_cc
operator|<=
name|TTLOWAT
condition|)
block|{
name|tp
operator|->
name|t_state
operator|=
operator|&
operator|~
name|ASLEEP
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|tp
operator|->
name|t_outq
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|dza
operator|->
name|dztcr
operator|=
operator|&
operator|~
name|t_bit
expr_stmt|;
block|}
block|}
block|}
block|}
do|while
condition|(
name|flag
condition|)
do|;
end_do

begin_comment
comment|/* finalize state of DZs prior to exitting */
end_comment

begin_for
for|for
control|(
name|dzp
operator|=
operator|&
name|dz
index|[
literal|0
index|]
init|;
name|dzp
operator|<
operator|&
name|dz
index|[
name|NDZ
index|]
condition|;
name|dzp
operator|++
control|)
block|{
specifier|register
name|struct
name|dzr_read
modifier|*
name|dza
init|=
name|dzp
operator|->
name|dzaddr
decl_stmt|;
comment|/* dtr to reflect state of carrier, for carrier lines */
name|dza
operator|->
name|dzdtr
operator|=
operator|(
name|dza
operator|->
name|dzcarr
operator||
name|dzp
operator|->
name|nocarr
operator|)
operator|&
name|dzp
operator|->
name|openl
expr_stmt|;
comment|/* Enable all lines still with characters to send */
name|dza
operator|->
name|dztcr
operator|=
name|dzp
operator|->
name|xmit
expr_stmt|;
block|}
end_for

begin_comment
comment|/*	setup for next interrupt 	*/
end_comment

begin_expr_stmt
name|CLOCK
operator|->
name|counter
operator|=
name|dzmicmap
index|[
name|hspeed
index|]
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* count in 10microseconds */
end_comment

begin_expr_stmt
name|CLOCK
operator|->
name|csr
operator|=
name|GO
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*	call dzrint if needed	*/
end_comment

begin_if
if|if
condition|(
name|dzrcvscan
operator|<=
literal|0
condition|)
name|dzrint
argument_list|(
literal|0
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|dzrcvscan
operator|=
operator|-
name|dzmicmap
index|[
name|hspeed
index|]
expr_stmt|;
end_expr_stmt

begin_escape
unit|}
end_escape

begin_comment
comment|/*  *	DZ11 receiver interrupt  *  *	Scan each dz commencing with the particular device that caused this call  *	Scan at least every dzmicmap[LOWSPEED] microseconds.  */
end_comment

begin_expr_stmt
unit|dzrint
operator|(
name|dev
operator|)
block|{
specifier|register
expr|struct
name|tty
operator|*
name|tp
block|;
specifier|register
expr|struct
name|dz
operator|*
name|dzp
block|;
specifier|register
name|int
name|lino
block|;
name|int
name|i
block|,
name|c
block|;
for|for
control|(
name|dzp
operator|=
operator|&
name|dz
index|[
name|dev
index|]
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NDZ
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
operator|(
name|c
operator|=
name|dzp
operator|->
name|dzaddr
operator|->
name|dzrbuf
operator|)
operator|<
literal|0
condition|)
comment|/* char present in silo */
block|{
name|lino
operator|=
name|c
operator|.
name|hibyte
expr_stmt|;
name|lino
operator|=
operator|&
literal|07
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dzp
operator|->
name|nocarr
operator|&
name|dzbitab
index|[
name|lino
index|]
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|dzp
operator|->
name|dzaddr
operator|->
name|dzcarr
operator|&
name|dzbitab
index|[
name|lino
index|]
operator|)
operator|==
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|dzp
operator|->
name|openl
operator|&
name|dzbitab
index|[
name|lino
index|]
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|tp
operator|=
name|dzp
operator|->
name|ttys
index|[
name|lino
index|]
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|RERROR
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|&
name|FRAME
operator|)
operator|&&
operator|(
name|tp
operator|->
name|t_flags
operator|&
name|RAW
operator|)
condition|)
name|ttyinput
argument_list|(
literal|0
argument_list|,
name|tp
argument_list|)
expr_stmt|;
comment|/* break for getty */
elseif|else
if|if
condition|(
name|c
operator|&
name|OVR_RUN
condition|)
name|dzp
operator|->
name|overrors
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|&
name|PARITY
condition|)
name|dzp
operator|->
name|pyerrors
operator|++
expr_stmt|;
block|}
end_expr_stmt

begin_else
else|else
block|{
name|ttyinput
argument_list|(
name|c
argument_list|,
name|tp
argument_list|)
expr_stmt|;
block|}
end_else

begin_expr_stmt
unit|} 		if
operator|(
operator|++
name|dzp
operator|>=
operator|&
name|dz
index|[
name|NDZ
index|]
operator|)
name|dzp
operator|=
operator|&
name|dz
index|[
literal|0
index|]
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|} 	dzrcvscan
operator|=
name|dzmicmap
index|[
name|LOWSPEED
index|]
expr_stmt|;
end_expr_stmt

unit|}
end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_comment
comment|/* Usage: 	sendberkmail [-m mach ] [-f addrfrom] [-h hopcnt] -t addrto 	 Archaic Usage: 	sendberkmail mach:user  	Send remote mail to user on mach. 	Only one addrto allowed.  	Sendberkmail uses the network to send an mmail command 	to the remote machine.  It specifies the source, destination, 	and a hop count only.  	Sendberkmail uses the -q option of net, so only error msgs 	and non-zero return codes will be sent back.  	It is best to think of sendberkmail as a transport mechanism: 	It takes mail from one machine to another machine (specified 	using the -m option) and executes the local mail program 	there with a to-address of "addrto", and a from-address 	of "addrfrom".  If the -m option is not given, it parses the 	"addrto" field to get a berkeley network address. 	This extreme generality is necessary when destinations are on 	different networks, consider a command from the Ing70:  		sendberkmail -m csvax -f schmidt@parc -t research!chuck   	This is clearly a forwarding function- send mail from the Arpanet 	to the Bell Net, which calls our CSVAX. 	Alternatively, executed on the CSVAX, 		sendberkmail -m ing70 -f research!chuck -t schmidt@parc 	sends mail the other way.  	There is duplication in the arguments because of 	a need to convert to labelled parameters. 	See the note in mmail.c to that effect.   	Options: 		-t addrto	mail command on remote machine will be 				fed "addrto" as address 		-f addrfrom	mail will be "From" addrfrom 		-m mach		send this mail to the "mach" machine 		-h hopcnt	if this hopcnt hits a threshold, there 				is presumed to be an infinite loop. 	 */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|char
name|addrto
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|addrfrom
index|[
name|BUFSIZ
index|]
decl_stmt|,
modifier|*
name|sn
decl_stmt|;
name|char
name|mchto
init|=
literal|0
decl_stmt|,
name|snto
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|snfrom
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|smchto
index|[
literal|20
index|]
decl_stmt|,
name|mchfrom
decl_stmt|;
name|int
name|cmdstr
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|hopcntstr
index|[
literal|20
index|]
decl_stmt|;
name|char
name|rcmd
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|hopcnt
init|=
literal|0
decl_stmt|;
name|argc
index|[
name|argv
index|]
operator|=
literal|0
expr_stmt|;
name|debugflg
operator|=
name|DBV
expr_stmt|;
name|addrfrom
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|addrto
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
operator|&&
name|argv
index|[
literal|1
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
switch|switch
condition|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'f'
case|:
name|harg
argument_list|(
name|addrfrom
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|harg
argument_list|(
name|hopcntstr
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
name|hopcnt
operator|=
name|atoi
argument_list|(
name|hopcntstr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|harg
argument_list|(
name|smchto
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
name|mchto
operator|=
name|lookup
argument_list|(
name|smchto
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|harg
argument_list|(
name|addrto
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|argv
argument_list|)
expr_stmt|;
break|break;
comment|/* it is important to ignore unknown flags 		   for compatibility reasons */
block|}
block|}
comment|/* handle to address */
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|strcpy
argument_list|(
name|addrto
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrto
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: sendberkmail mach:user\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mchto
operator|==
literal|0
condition|)
name|mchto
operator|=
name|MchSFromAddr
argument_list|(
name|snto
argument_list|,
name|addrto
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|snto
argument_list|,
name|addrto
argument_list|)
expr_stmt|;
if|if
condition|(
name|mchto
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown host %s\n"
argument_list|,
name|addrto
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_NOHOST
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|mchto
operator|==
name|local
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Use mail to send to %s on this machine. Mail not delivered.\n"
argument_list|,
name|addrto
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_NOUSER
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|rcmd
argument_list|,
literal|"mail %s"
argument_list|,
name|addrto
argument_list|)
expr_stmt|;
comment|/* handle from address */
if|if
condition|(
name|addrfrom
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|sn
operator|=
name|SnFromUid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|sn
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown userid\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_OSFILE
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|addrfrom
argument_list|,
literal|"%s:%s"
argument_list|,
name|longname
argument_list|(
name|local
argument_list|)
argument_list|,
name|sn
argument_list|)
expr_stmt|;
block|}
name|mchfrom
operator|=
name|MchSFromAddr
argument_list|(
name|snfrom
argument_list|,
name|addrfrom
argument_list|)
expr_stmt|;
comment|/* uses new options of mmail */
comment|/* X's are for compatibility with mmail */
name|sprintf
argument_list|(
name|cmdstr
argument_list|,
literal|"%s XXX XXX XXX -f '%s' -t '%s' -h %d"
argument_list|,
name|MMAILCMD
argument_list|,
name|addrfrom
argument_list|,
name|addrto
argument_list|,
name|hopcnt
argument_list|)
expr_stmt|;
comment|/* old code: 	sprintf(cmdstr,"%s '%s' %s '%s'", MMAILCMD,snfrom, 		longname(mchfrom),snto); 	*/
name|mexecl
argument_list|(
name|netcmd
argument_list|,
literal|"net"
argument_list|,
literal|"-m"
argument_list|,
name|longname
argument_list|(
name|mchto
argument_list|)
argument_list|,
literal|"-q"
argument_list|,
literal|"-l"
argument_list|,
literal|"network"
argument_list|,
literal|"-"
argument_list|,
literal|"-c"
argument_list|,
name|rcmd
argument_list|,
name|cmdstr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|netcmd
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Network is down\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_UNAVAILABLE
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


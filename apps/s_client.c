begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* apps/s_client.c */
end_comment

begin_comment
comment|/* Copyright (C) 1995-1998 Eric Young (eay@cryptsoft.com)  * All rights reserved.  *  * This package is an SSL implementation written  * by Eric Young (eay@cryptsoft.com).  * The implementation was written so as to conform with Netscapes SSL.  *  * This library is free for commercial and non-commercial use as long as  * the following conditions are aheared to.  The following conditions  * apply to all code found in this distribution, be it the RC4, RSA,  * lhash, DES, etc., code; not just the SSL code.  The SSL documentation  * included with this distribution is covered by the same copyright terms  * except that the holder is Tim Hudson (tjh@cryptsoft.com).  *  * Copyright remains Eric Young's, and as such any Copyright notices in  * the code are not to be removed.  * If this package is used in a product, Eric Young should be given attribution  * as the author of the parts of the library used.  * This can be in the form of a textual message at program startup or  * in documentation (online or textual) provided with the package.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *    "This product includes cryptographic software written by  *     Eric Young (eay@cryptsoft.com)"  *    The word 'cryptographic' can be left out if the rouines from the library  *    being used are not cryptographic related :-).  * 4. If you include any Windows specific code (or a derivative thereof) from  *    the apps directory (application code) you must include an acknowledgement:  *    "This product includes software written by Tim Hudson (tjh@cryptsoft.com)"  *  * THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * The licence and distribution terms for any publically available version or  * derivative of this code cannot be changed.  i.e. this code cannot simply be  * copied and put under another distribution licence  * [including the GNU Public Licence.]  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 1998-2006 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.openssl.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    openssl-core@openssl.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.openssl.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  *  * This product includes cryptographic software written by Eric Young  * (eay@cryptsoft.com).  This product includes software written by Tim  * Hudson (tjh@cryptsoft.com).  *  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright 2005 Nokia. All rights reserved.  *  * The portions of the attached software ("Contribution") is developed by  * Nokia Corporation and is licensed pursuant to the OpenSSL open source  * license.  *  * The Contribution, originally written by Mika Kousa and Pasi Eronen of  * Nokia Corporation, consists of the "PSK" (Pre-Shared Key) ciphersuites  * support (see RFC 4279) to OpenSSL.  *  * No patent licenses or other rights except those expressly stated in  * the OpenSSL open source license shall be deemed granted or received  * expressly, by implication, estoppel, or otherwise.  *  * No assurances are provided by Nokia that the Contribution does not  * infringe the patent or other intellectual property rights of any third  * party or that the license provides you with all the necessary rights  * to make use of the Contribution.  *  * THE SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND. IN  * ADDITION TO THE DISCLAIMERS INCLUDED IN THE LICENSE, NOKIA  * SPECIFICALLY DISCLAIMS ANY LIABILITY FOR CLAIMS BROUGHT BY YOU OR ANY  * OTHER ENTITY BASED ON INFRINGEMENT OF INTELLECTUAL PROPERTY RIGHTS OR  * OTHERWISE.  */
end_comment

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<openssl/e_os2.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_NO_STDIO
end_ifdef

begin_define
define|#
directive|define
name|APPS_WIN16
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * With IPv6, it looks like Digital has mixed up the proper order of  * recursive header file inclusion, resulting in the compiler complaining  * that u_int isn't defined, but only if _POSIX_C_SOURCE is defined, which is  * needed to have fileno() declared correctly...  So let's define u_int  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_VMS_DECC
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__U_INT
argument_list|)
end_if

begin_define
define|#
directive|define
name|__U_INT
end_define

begin_typedef
typedef|typedef
name|unsigned
name|int
name|u_int
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|USE_SOCKETS
end_define

begin_include
include|#
directive|include
file|"apps.h"
end_include

begin_include
include|#
directive|include
file|<openssl/x509.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ocsp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
end_ifndef

begin_include
include|#
directive|include
file|<openssl/srp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"s_apps.h"
end_include

begin_include
include|#
directive|include
file|"timeouts.h"
end_include

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|OPENSSL_SYS_VMS
argument_list|)
operator|&&
name|__VMS_VER
operator|<
literal|70000000
operator|)
end_if

begin_comment
comment|/* FIONBIO used as a switch to enable ioctl, and that isn't in VMS< 7.0 */
end_comment

begin_undef
undef|#
directive|undef
name|FIONBIO
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
end_if

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|PROG
end_undef

begin_define
define|#
directive|define
name|PROG
value|s_client_main
end_define

begin_comment
comment|/*  * #define SSL_HOST_NAME "www.netscape.com"  */
end_comment

begin_comment
comment|/*  * #define SSL_HOST_NAME "193.118.187.102"  */
end_comment

begin_define
define|#
directive|define
name|SSL_HOST_NAME
value|"localhost"
end_define

begin_comment
comment|/* no default cert. */
end_comment

begin_comment
comment|/*  * #define TEST_CERT "client.pem"  */
end_comment

begin_undef
undef|#
directive|undef
name|BUFSIZZ
end_undef

begin_define
define|#
directive|define
name|BUFSIZZ
value|1024*8
end_define

begin_decl_stmt
specifier|extern
name|int
name|verify_depth
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|verify_error
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|verify_return_error
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|verify_quiet
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FIONBIO
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|c_nbio
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|c_Pause
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_decl_stmt
specifier|static
name|int
name|c_tlsextdebug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_status_req
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|c_msg
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_showcerts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|keymatexportlabel
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|keymatexportlen
init|=
literal|20
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|sc_usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_stuff
parameter_list|(
name|BIO
modifier|*
name|berr
parameter_list|,
name|SSL
modifier|*
name|con
parameter_list|,
name|int
name|full
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_function_decl
specifier|static
name|int
name|ocsp_resp_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|BIO
modifier|*
name|bio_c_out
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|BIO
modifier|*
name|bio_c_msg
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_quiet
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_ign_eof
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_brief
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_PSK
end_ifndef

begin_comment
comment|/* Default PSK identity and key */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|psk_identity
init|=
literal|"Client_identity"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * char *psk_key=NULL; by default PSK is not used  */
end_comment

begin_function
specifier|static
name|unsigned
name|int
name|psk_client_cb
parameter_list|(
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|char
modifier|*
name|hint
parameter_list|,
name|char
modifier|*
name|identity
parameter_list|,
name|unsigned
name|int
name|max_identity_len
parameter_list|,
name|unsigned
name|char
modifier|*
name|psk
parameter_list|,
name|unsigned
name|int
name|max_psk_len
parameter_list|)
block|{
name|unsigned
name|int
name|psk_len
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|BIGNUM
modifier|*
name|bn
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|c_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"psk_client_cb\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hint
condition|)
block|{
comment|/* no ServerKeyExchange message */
if|if
condition|(
name|c_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"NULL received PSK identity hint, continuing anyway\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"Received PSK identity hint '%s'\n"
argument_list|,
name|hint
argument_list|)
expr_stmt|;
comment|/*      * lookup PSK identity and PSK key based on the given identity hint here      */
name|ret
operator|=
name|BIO_snprintf
argument_list|(
name|identity
argument_list|,
name|max_identity_len
argument_list|,
literal|"%s"
argument_list|,
name|psk_identity
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
operator|(
name|unsigned
name|int
operator|)
name|ret
operator|>
name|max_identity_len
condition|)
goto|goto
name|out_err
goto|;
if|if
condition|(
name|c_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"created identity '%s' len=%d\n"
argument_list|,
name|identity
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ret
operator|=
name|BN_hex2bn
argument_list|(
operator|&
name|bn
argument_list|,
name|psk_key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Could not convert PSK key '%s' to BIGNUM\n"
argument_list|,
name|psk_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|bn
condition|)
name|BN_free
argument_list|(
name|bn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|unsigned
name|int
operator|)
name|BN_num_bytes
argument_list|(
name|bn
argument_list|)
operator|>
name|max_psk_len
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"psk buffer of callback is too small (%d) for key (%d)\n"
argument_list|,
name|max_psk_len
argument_list|,
name|BN_num_bytes
argument_list|(
name|bn
argument_list|)
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|bn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|psk_len
operator|=
name|BN_bn2bin
argument_list|(
name|bn
argument_list|,
name|psk
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|bn
argument_list|)
expr_stmt|;
if|if
condition|(
name|psk_len
operator|==
literal|0
condition|)
goto|goto
name|out_err
goto|;
if|if
condition|(
name|c_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"created PSK len=%d\n"
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
return|return
name|psk_len
return|;
name|out_err
label|:
if|if
condition|(
name|c_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error in PSK client callback\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|sc_usage
parameter_list|(
name|void
parameter_list|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"usage: s_client args\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -host host     - use -connect instead\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -port port     - use -connect instead\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -connect host:port - who to connect to (default is %s:%s)\n"
argument_list|,
name|SSL_HOST_NAME
argument_list|,
name|PORT_STR
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify_hostname host - check peer certificate matches \"host\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify_email email - check peer certificate matches \"email\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify_ip ipaddr - check peer certificate matches \"ipaddr\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify arg   - turn on peer certificate verification\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify_return_error - return verification errors\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -cert arg     - certificate file to use, PEM format assumed\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -certform arg - certificate format (PEM or DER) PEM default\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -key arg      - Private key file to use, in cert file if\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 not specified but cert file is.\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -keyform arg  - key format (PEM or DER) PEM default\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -pass arg     - private key file pass phrase source\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -CApath arg   - PEM format directory of CA's\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -CAfile arg   - PEM format file of CA's\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_alt_chains - only ever use the first certificate chain found\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -reconnect    - Drop and re-make the connection with the same Session-ID\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -pause        - sleep(1) after each read(2) and write(2) system call\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -prexit       - print session information even on connection failure\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -showcerts    - show all certificates in the chain\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -debug        - extra output\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WATT32
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -wdebug       - WATT-32 tcp debugging\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -msg          - Show protocol messages\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -nbio_test    - more ssl protocol testing\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -state        - print the 'ssl' states\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FIONBIO
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -nbio         - Run with non-blocking IO\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -crlf         - convert LF from terminal into CRLF\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -quiet        - no s_client output\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -ign_eof      - ignore input eof (default when -quiet)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_ign_eof   - don't ignore input eof\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_PSK
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -psk_identity arg - PSK identity\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -psk arg      - PSK in hex (without 0x)\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_JPAKE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -jpake arg    - JPAKE secret to use\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -srpuser user     - SRP authentification for 'user'\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -srppass arg      - password for 'user'\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -srp_lateuser     - SRP username into second ClientHello message\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -srp_moregroups   - Tolerate other than the known g N values.\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -srp_strength int - minimal length in bits for N (default %d).\n"
argument_list|,
name|SRP_MINIMAL_N
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -ssl2         - just use SSLv2\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL3_METHOD
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -ssl3         - just use SSLv3\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -tls1_2       - just use TLSv1.2\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -tls1_1       - just use TLSv1.1\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -tls1         - just use TLSv1\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -dtls1        - just use DTLSv1\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -fallback_scsv - send TLS_FALLBACK_SCSV\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -mtu          - set the link layer MTU\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_tls1_2/-no_tls1_1/-no_tls1/-no_ssl3/-no_ssl2 - turn off that protocol\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -bugs         - Switch on all SSL implementation bug workarounds\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -serverpref   - Use server's cipher preferences (only SSLv2)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -cipher       - preferred cipher to use, use the 'openssl ciphers'\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 command to see what is available\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -starttls prot - use the STARTTLS command before starting TLS\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 for those protocols that support it, where\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 'prot' defines which one to assume.  Currently,\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 only \"smtp\", \"pop3\", \"imap\", \"ftp\" and \"xmpp\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 are supported.\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -engine id    - Initialise and use the specified engine\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -rand file%cfile%c...\n"
argument_list|,
name|LIST_SEPARATOR_CHAR
argument_list|,
name|LIST_SEPARATOR_CHAR
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -sess_out arg - file to write SSL session to\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -sess_in arg  - file to read SSL session from\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -servername host  - Set TLS extension servername in ClientHello\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -tlsextdebug      - hex dump of all TLS extensions received\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -status           - request certificate status from server\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_ticket        - disable use of RFC4507bis session tickets\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -serverinfo types - send empty ClientHello extensions (comma-separated numbers)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -curves arg       - Elliptic curves to advertise (colon-separated list)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -sigalgs arg      - Signature algorithms to support (colon-separated list)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -client_sigalgs arg - Signature algorithms to support for client\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                       certificate authentication (colon-separated list)\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_NEXTPROTONEG
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -nextprotoneg arg - enable NPN extension, considering named protocols supported (comma-separated list)\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -alpn arg         - enable ALPN extension, considering named protocols supported (comma-separated list)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -legacy_renegotiation - enable use of legacy renegotiation (dangerous)\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRTP
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -use_srtp profiles - Offer SRTP key management with a colon-separated profile list\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -keymatexport label   - Export keying material using label\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -keymatexportlen len  - Export len bytes of keying material (default 20)\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_comment
comment|/* This is a context that we pass to callbacks */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|tlsextctx_st
block|{
name|BIO
modifier|*
name|biodebug
decl_stmt|;
name|int
name|ack
decl_stmt|;
block|}
name|tlsextctx
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|MS_CALLBACK
name|ssl_servername_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|int
modifier|*
name|ad
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|tlsextctx
modifier|*
name|p
init|=
operator|(
name|tlsextctx
operator|*
operator|)
name|arg
decl_stmt|;
specifier|const
name|char
modifier|*
name|hn
init|=
name|SSL_get_servername
argument_list|(
name|s
argument_list|,
name|TLSEXT_NAMETYPE_host_name
argument_list|)
decl_stmt|;
if|if
condition|(
name|SSL_get_servername_type
argument_list|(
name|s
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|p
operator|->
name|ack
operator|=
operator|!
name|SSL_session_reused
argument_list|(
name|s
argument_list|)
operator|&&
name|hn
operator|!=
name|NULL
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Can't use SSL_get_servername\n"
argument_list|)
expr_stmt|;
return|return
name|SSL_TLSEXT_ERR_OK
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
end_ifndef

begin_comment
comment|/* This is a context that we pass to all callbacks */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|srp_arg_st
block|{
name|char
modifier|*
name|srppassin
decl_stmt|;
name|char
modifier|*
name|srplogin
decl_stmt|;
name|int
name|msg
decl_stmt|;
comment|/* copy from c_msg */
name|int
name|debug
decl_stmt|;
comment|/* copy from c_debug */
name|int
name|amp
decl_stmt|;
comment|/* allow more groups */
name|int
name|strength
comment|/* minimal size for N */
decl_stmt|;
block|}
name|SRP_ARG
typedef|;
end_typedef

begin_define
define|#
directive|define
name|SRP_NUMBER_ITERATIONS_FOR_PRIME
value|64
end_define

begin_function
specifier|static
name|int
name|srp_Verify_N_and_g
parameter_list|(
name|BIGNUM
modifier|*
name|N
parameter_list|,
name|BIGNUM
modifier|*
name|g
parameter_list|)
block|{
name|BN_CTX
modifier|*
name|bn_ctx
init|=
name|BN_CTX_new
argument_list|()
decl_stmt|;
name|BIGNUM
modifier|*
name|p
init|=
name|BN_new
argument_list|()
decl_stmt|;
name|BIGNUM
modifier|*
name|r
init|=
name|BN_new
argument_list|()
decl_stmt|;
name|int
name|ret
init|=
name|g
operator|!=
name|NULL
operator|&&
name|N
operator|!=
name|NULL
operator|&&
name|bn_ctx
operator|!=
name|NULL
operator|&&
name|BN_is_odd
argument_list|(
name|N
argument_list|)
operator|&&
name|BN_is_prime_ex
argument_list|(
name|N
argument_list|,
name|SRP_NUMBER_ITERATIONS_FOR_PRIME
argument_list|,
name|bn_ctx
argument_list|,
name|NULL
argument_list|)
operator|&&
name|p
operator|!=
name|NULL
operator|&&
name|BN_rshift1
argument_list|(
name|p
argument_list|,
name|N
argument_list|)
operator|&&
comment|/* p = (N-1)/2 */
name|BN_is_prime_ex
argument_list|(
name|p
argument_list|,
name|SRP_NUMBER_ITERATIONS_FOR_PRIME
argument_list|,
name|bn_ctx
argument_list|,
name|NULL
argument_list|)
operator|&&
name|r
operator|!=
name|NULL
operator|&&
comment|/* verify g^((N-1)/2) == -1 (mod N) */
name|BN_mod_exp
argument_list|(
name|r
argument_list|,
name|g
argument_list|,
name|p
argument_list|,
name|N
argument_list|,
name|bn_ctx
argument_list|)
operator|&&
name|BN_add_word
argument_list|(
name|r
argument_list|,
literal|1
argument_list|)
operator|&&
name|BN_cmp
argument_list|(
name|r
argument_list|,
name|N
argument_list|)
operator|==
literal|0
decl_stmt|;
if|if
condition|(
name|r
condition|)
name|BN_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
name|BN_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|bn_ctx
condition|)
name|BN_CTX_free
argument_list|(
name|bn_ctx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*-  * This callback is used here for two purposes:  * - extended debugging  * - making some primality tests for unknown groups  * The callback is only called for a non default group.  *  * An application does not need the call back at all if  * only the stanard groups are used.  In real life situations,  * client and server already share well known groups,  * thus there is no need to verify them.  * Furthermore, in case that a server actually proposes a group that  * is not one of those defined in RFC 5054, it is more appropriate  * to add the group to a static list and then compare since  * primality tests are rather cpu consuming.  */
end_comment

begin_function
specifier|static
name|int
name|MS_CALLBACK
name|ssl_srp_verify_param_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|SRP_ARG
modifier|*
name|srp_arg
init|=
operator|(
name|SRP_ARG
operator|*
operator|)
name|arg
decl_stmt|;
name|BIGNUM
modifier|*
name|N
init|=
name|NULL
decl_stmt|,
modifier|*
name|g
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|N
operator|=
name|SSL_get_srp_N
argument_list|(
name|s
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|g
operator|=
name|SSL_get_srp_g
argument_list|(
name|s
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|srp_arg
operator|->
name|debug
operator|||
name|srp_arg
operator|->
name|msg
operator|||
name|srp_arg
operator|->
name|amp
operator|==
literal|1
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"SRP parameters:\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\tN="
argument_list|)
expr_stmt|;
name|BN_print
argument_list|(
name|bio_err
argument_list|,
name|N
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n\tg="
argument_list|)
expr_stmt|;
name|BN_print
argument_list|(
name|bio_err
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SRP_check_known_gN_param
argument_list|(
name|g
argument_list|,
name|N
argument_list|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|srp_arg
operator|->
name|amp
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|srp_arg
operator|->
name|debug
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"SRP param N and g are not known params, going to check deeper.\n"
argument_list|)
expr_stmt|;
comment|/*          * The srp_moregroups is a real debugging feature. Implementors          * should rather add the value to the known ones. The minimal size          * has already been tested.          */
if|if
condition|(
name|BN_num_bits
argument_list|(
name|g
argument_list|)
operator|<=
name|BN_BITS
operator|&&
name|srp_Verify_N_and_g
argument_list|(
name|N
argument_list|,
name|g
argument_list|)
condition|)
return|return
literal|1
return|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"SRP param N and g rejected.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|PWD_STRLEN
value|1024
end_define

begin_function
specifier|static
name|char
modifier|*
name|MS_CALLBACK
name|ssl_give_srp_client_pwd_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|SRP_ARG
modifier|*
name|srp_arg
init|=
operator|(
name|SRP_ARG
operator|*
operator|)
name|arg
decl_stmt|;
name|char
modifier|*
name|pass
init|=
operator|(
name|char
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
name|PWD_STRLEN
operator|+
literal|1
argument_list|)
decl_stmt|;
name|PW_CB_DATA
name|cb_tmp
decl_stmt|;
name|int
name|l
decl_stmt|;
if|if
condition|(
operator|!
name|pass
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cb_tmp
operator|.
name|password
operator|=
operator|(
name|char
operator|*
operator|)
name|srp_arg
operator|->
name|srppassin
expr_stmt|;
name|cb_tmp
operator|.
name|prompt_info
operator|=
literal|"SRP user"
expr_stmt|;
if|if
condition|(
operator|(
name|l
operator|=
name|password_callback
argument_list|(
name|pass
argument_list|,
name|PWD_STRLEN
argument_list|,
literal|0
argument_list|,
operator|&
name|cb_tmp
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Can't read Password\n"
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
operator|(
name|pass
operator|+
name|l
operator|)
operator|=
literal|'\0'
expr_stmt|;
return|return
name|pass
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRTP
end_ifndef

begin_decl_stmt
name|char
modifier|*
name|srtp_profiles
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_NEXTPROTONEG
end_ifndef

begin_comment
comment|/* This the context that we pass to next_proto_cb */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|tlsextnextprotoctx_st
block|{
name|unsigned
name|char
modifier|*
name|data
decl_stmt|;
name|unsigned
name|short
name|len
decl_stmt|;
name|int
name|status
decl_stmt|;
block|}
name|tlsextnextprotoctx
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|tlsextnextprotoctx
name|next_proto
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|next_proto_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|out
parameter_list|,
name|unsigned
name|char
modifier|*
name|outlen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|unsigned
name|int
name|inlen
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|tlsextnextprotoctx
modifier|*
name|ctx
init|=
name|arg
decl_stmt|;
if|if
condition|(
operator|!
name|c_quiet
condition|)
block|{
comment|/* We can assume that |in| is syntactically valid. */
name|unsigned
name|i
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"Protocols advertised by server: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|inlen
condition|;
control|)
block|{
if|if
condition|(
name|i
condition|)
name|BIO_write
argument_list|(
name|bio_c_out
argument_list|,
literal|", "
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio_c_out
argument_list|,
operator|&
name|in
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|in
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i
operator|+=
name|in
index|[
name|i
index|]
operator|+
literal|1
expr_stmt|;
block|}
name|BIO_write
argument_list|(
name|bio_c_out
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|->
name|status
operator|=
name|SSL_select_next_proto
argument_list|(
name|out
argument_list|,
name|outlen
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
name|ctx
operator|->
name|data
argument_list|,
name|ctx
operator|->
name|len
argument_list|)
expr_stmt|;
return|return
name|SSL_TLSEXT_ERR_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ndef OPENSSL_NO_NEXTPROTONEG */
end_comment

begin_function
specifier|static
name|int
name|serverinfo_cli_parse_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|unsigned
name|int
name|ext_type
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|size_t
name|inlen
parameter_list|,
name|int
modifier|*
name|al
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|char
name|pem_name
index|[
literal|100
index|]
decl_stmt|;
name|unsigned
name|char
name|ext_buf
index|[
literal|4
operator|+
literal|65536
index|]
decl_stmt|;
comment|/* Reconstruct the type/len fields prior to extension data */
name|ext_buf
index|[
literal|0
index|]
operator|=
name|ext_type
operator|>>
literal|8
expr_stmt|;
name|ext_buf
index|[
literal|1
index|]
operator|=
name|ext_type
operator|&
literal|0xFF
expr_stmt|;
name|ext_buf
index|[
literal|2
index|]
operator|=
name|inlen
operator|>>
literal|8
expr_stmt|;
name|ext_buf
index|[
literal|3
index|]
operator|=
name|inlen
operator|&
literal|0xFF
expr_stmt|;
name|memcpy
argument_list|(
name|ext_buf
operator|+
literal|4
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|)
expr_stmt|;
name|BIO_snprintf
argument_list|(
name|pem_name
argument_list|,
sizeof|sizeof
argument_list|(
name|pem_name
argument_list|)
argument_list|,
literal|"SERVERINFO FOR EXTENSION %d"
argument_list|,
name|ext_type
argument_list|)
expr_stmt|;
name|PEM_write_bio
argument_list|(
name|bio_c_out
argument_list|,
name|pem_name
argument_list|,
literal|""
argument_list|,
name|ext_buf
argument_list|,
literal|4
operator|+
name|inlen
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_enum
enum|enum
block|{
name|PROTO_OFF
init|=
literal|0
block|,
name|PROTO_SMTP
block|,
name|PROTO_POP3
block|,
name|PROTO_IMAP
block|,
name|PROTO_FTP
block|,
name|PROTO_XMPP
block|}
enum|;
end_enum

begin_function_decl
name|int
name|MAIN
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|MAIN
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|build_chain
init|=
literal|0
decl_stmt|;
name|SSL
modifier|*
name|con
init|=
name|NULL
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
name|KSSL_CTX
modifier|*
name|kctx
decl_stmt|;
endif|#
directive|endif
name|int
name|s
decl_stmt|,
name|k
decl_stmt|,
name|width
decl_stmt|,
name|state
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|cbuf
init|=
name|NULL
decl_stmt|,
modifier|*
name|sbuf
init|=
name|NULL
decl_stmt|,
modifier|*
name|mbuf
init|=
name|NULL
decl_stmt|;
name|int
name|cbuf_len
decl_stmt|,
name|cbuf_off
decl_stmt|;
name|int
name|sbuf_len
decl_stmt|,
name|sbuf_off
decl_stmt|;
name|fd_set
name|readfds
decl_stmt|,
name|writefds
decl_stmt|;
name|short
name|port
init|=
name|PORT
decl_stmt|;
name|int
name|full_log
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|host
init|=
name|SSL_HOST_NAME
decl_stmt|;
name|char
modifier|*
name|cert_file
init|=
name|NULL
decl_stmt|,
modifier|*
name|key_file
init|=
name|NULL
decl_stmt|,
modifier|*
name|chain_file
init|=
name|NULL
decl_stmt|;
name|int
name|cert_format
init|=
name|FORMAT_PEM
decl_stmt|,
name|key_format
init|=
name|FORMAT_PEM
decl_stmt|;
name|char
modifier|*
name|passarg
init|=
name|NULL
decl_stmt|,
modifier|*
name|pass
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|cert
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|chain
operator|=
name|NULL
expr_stmt|;
name|char
modifier|*
name|CApath
init|=
name|NULL
decl_stmt|,
modifier|*
name|CAfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|chCApath
init|=
name|NULL
decl_stmt|,
modifier|*
name|chCAfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|vfyCApath
init|=
name|NULL
decl_stmt|,
modifier|*
name|vfyCAfile
init|=
name|NULL
decl_stmt|;
name|int
name|reconnect
init|=
literal|0
decl_stmt|,
name|badop
init|=
literal|0
decl_stmt|,
name|verify
init|=
name|SSL_VERIFY_NONE
decl_stmt|;
name|int
name|crlf
init|=
literal|0
decl_stmt|;
name|int
name|write_tty
decl_stmt|,
name|read_tty
decl_stmt|,
name|write_ssl
decl_stmt|,
name|read_ssl
decl_stmt|,
name|tty_on
decl_stmt|,
name|ssl_pending
decl_stmt|;
name|SSL_CTX
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|,
name|in_init
init|=
literal|1
decl_stmt|,
name|i
decl_stmt|,
name|nbio_test
init|=
literal|0
decl_stmt|;
name|int
name|starttls_proto
init|=
name|PROTO_OFF
decl_stmt|;
name|int
name|prexit
init|=
literal|0
decl_stmt|;
name|X509_VERIFY_PARAM
modifier|*
name|vpm
init|=
name|NULL
decl_stmt|;
name|int
name|badarg
init|=
literal|0
decl_stmt|;
specifier|const
name|SSL_METHOD
modifier|*
name|meth
init|=
name|NULL
decl_stmt|;
name|int
name|socket_type
init|=
name|SOCK_STREAM
decl_stmt|;
name|BIO
modifier|*
name|sbio
decl_stmt|;
name|char
modifier|*
name|inrand
init|=
name|NULL
decl_stmt|;
name|int
name|mbuf_len
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|timeout
decl_stmt|,
modifier|*
name|timeoutp
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|char
modifier|*
name|engine_id
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ssl_client_engine_id
init|=
name|NULL
decl_stmt|;
name|ENGINE
modifier|*
name|ssl_client_engine
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
name|ENGINE
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
name|struct
name|timeval
name|tv
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
name|int
name|stdin_set
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
name|char
modifier|*
name|servername
init|=
name|NULL
decl_stmt|;
name|tlsextctx
name|tlsextcbp
init|=
block|{
name|NULL
block|,
literal|0
block|}
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_NEXTPROTONEG
specifier|const
name|char
modifier|*
name|next_proto_neg_in
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
specifier|const
name|char
modifier|*
name|alpn_in
init|=
name|NULL
decl_stmt|;
define|#
directive|define
name|MAX_SI_TYPES
value|100
name|unsigned
name|short
name|serverinfo_types
index|[
name|MAX_SI_TYPES
index|]
decl_stmt|;
name|int
name|serverinfo_types_count
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|char
modifier|*
name|sess_in
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|sess_out
init|=
name|NULL
decl_stmt|;
name|struct
name|sockaddr
name|peer
decl_stmt|;
name|int
name|peerlen
init|=
sizeof|sizeof
argument_list|(
name|peer
argument_list|)
decl_stmt|;
name|int
name|fallback_scsv
init|=
literal|0
decl_stmt|;
name|int
name|enable_timeouts
init|=
literal|0
decl_stmt|;
name|long
name|socket_mtu
init|=
literal|0
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_JPAKE
specifier|static
name|char
modifier|*
name|jpake_secret
init|=
name|NULL
decl_stmt|;
define|#
directive|define
name|no_jpake
value|!jpake_secret
else|#
directive|else
define|#
directive|define
name|no_jpake
value|1
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
name|char
modifier|*
name|srppass
init|=
name|NULL
decl_stmt|;
name|int
name|srp_lateuser
init|=
literal|0
decl_stmt|;
name|SRP_ARG
name|srp_arg
init|=
block|{
name|NULL
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1024
block|}
decl_stmt|;
endif|#
directive|endif
name|SSL_EXCERT
modifier|*
name|exc
init|=
name|NULL
decl_stmt|;
name|SSL_CONF_CTX
modifier|*
name|cctx
init|=
name|NULL
decl_stmt|;
name|STACK_OF
argument_list|(
name|OPENSSL_STRING
argument_list|)
operator|*
name|ssl_args
operator|=
name|NULL
expr_stmt|;
name|char
modifier|*
name|crl_file
init|=
name|NULL
decl_stmt|;
name|int
name|crl_format
init|=
name|FORMAT_PEM
decl_stmt|;
name|int
name|crl_download
init|=
literal|0
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509_CRL
argument_list|)
operator|*
name|crls
operator|=
name|NULL
expr_stmt|;
name|meth
operator|=
name|SSLv23_client_method
argument_list|()
expr_stmt|;
name|apps_startup
argument_list|()
expr_stmt|;
name|c_Pause
operator|=
literal|0
expr_stmt|;
name|c_quiet
operator|=
literal|0
expr_stmt|;
name|c_ign_eof
operator|=
literal|0
expr_stmt|;
name|c_debug
operator|=
literal|0
expr_stmt|;
name|c_msg
operator|=
literal|0
expr_stmt|;
name|c_showcerts
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bio_err
operator|==
name|NULL
condition|)
name|bio_err
operator|=
name|BIO_new_fp
argument_list|(
name|stderr
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|load_config
argument_list|(
name|bio_err
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|end
goto|;
name|cctx
operator|=
name|SSL_CONF_CTX_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|cctx
condition|)
goto|goto
name|end
goto|;
name|SSL_CONF_CTX_set_flags
argument_list|(
name|cctx
argument_list|,
name|SSL_CONF_FLAG_CLIENT
argument_list|)
expr_stmt|;
name|SSL_CONF_CTX_set_flags
argument_list|(
name|cctx
argument_list|,
name|SSL_CONF_FLAG_CMDLINE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|cbuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|BUFSIZZ
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|sbuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|BUFSIZZ
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|mbuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|BUFSIZZ
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"out of memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|verify_depth
operator|=
literal|0
expr_stmt|;
name|verify_error
operator|=
name|X509_V_OK
expr_stmt|;
ifdef|#
directive|ifdef
name|FIONBIO
name|c_nbio
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>=
literal|1
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-host"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|host
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-port"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|port
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
condition|)
goto|goto
name|bad
goto|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-connect"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
operator|!
name|extract_host_port
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|,
operator|&
name|host
argument_list|,
name|NULL
argument_list|,
operator|&
name|port
argument_list|)
condition|)
goto|goto
name|bad
goto|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verify"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|verify
operator|=
name|SSL_VERIFY_PEER
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|verify_depth
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c_quiet
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"verify depth is %d\n"
argument_list|,
name|verify_depth
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|cert_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CRL"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|crl_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crl_download"
argument_list|)
operator|==
literal|0
condition|)
name|crl_download
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-sess_out"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|sess_out
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-sess_in"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|sess_in
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-certform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|cert_format
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CRLform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|crl_format
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|args_verify
argument_list|(
operator|&
name|argv
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|badarg
argument_list|,
name|bio_err
argument_list|,
operator|&
name|vpm
argument_list|)
condition|)
block|{
if|if
condition|(
name|badarg
condition|)
goto|goto
name|bad
goto|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verify_return_error"
argument_list|)
operator|==
literal|0
condition|)
name|verify_return_error
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verify_quiet"
argument_list|)
operator|==
literal|0
condition|)
name|verify_quiet
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-brief"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|c_brief
operator|=
literal|1
expr_stmt|;
name|verify_quiet
operator|=
literal|1
expr_stmt|;
name|c_quiet
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|args_excert
argument_list|(
operator|&
name|argv
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|badarg
argument_list|,
name|bio_err
argument_list|,
operator|&
name|exc
argument_list|)
condition|)
block|{
if|if
condition|(
name|badarg
condition|)
goto|goto
name|bad
goto|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|args_ssl
argument_list|(
operator|&
name|argv
argument_list|,
operator|&
name|argc
argument_list|,
name|cctx
argument_list|,
operator|&
name|badarg
argument_list|,
name|bio_err
argument_list|,
operator|&
name|ssl_args
argument_list|)
condition|)
block|{
if|if
condition|(
name|badarg
condition|)
goto|goto
name|bad
goto|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-prexit"
argument_list|)
operator|==
literal|0
condition|)
name|prexit
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crlf"
argument_list|)
operator|==
literal|0
condition|)
name|crlf
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-quiet"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|c_quiet
operator|=
literal|1
expr_stmt|;
name|c_ign_eof
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ign_eof"
argument_list|)
operator|==
literal|0
condition|)
name|c_ign_eof
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_ign_eof"
argument_list|)
operator|==
literal|0
condition|)
name|c_ign_eof
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-pause"
argument_list|)
operator|==
literal|0
condition|)
name|c_Pause
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-debug"
argument_list|)
operator|==
literal|0
condition|)
name|c_debug
operator|=
literal|1
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-tlsextdebug"
argument_list|)
operator|==
literal|0
condition|)
name|c_tlsextdebug
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-status"
argument_list|)
operator|==
literal|0
condition|)
name|c_status_req
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|WATT32
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-wdebug"
argument_list|)
operator|==
literal|0
condition|)
name|dbug_init
argument_list|()
expr_stmt|;
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-msg"
argument_list|)
operator|==
literal|0
condition|)
name|c_msg
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-msgfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|bio_c_msg
operator|=
name|BIO_new_file
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL_TRACE
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-trace"
argument_list|)
operator|==
literal|0
condition|)
name|c_msg
operator|=
literal|2
expr_stmt|;
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-showcerts"
argument_list|)
operator|==
literal|0
condition|)
name|c_showcerts
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nbio_test"
argument_list|)
operator|==
literal|0
condition|)
name|nbio_test
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-state"
argument_list|)
operator|==
literal|0
condition|)
name|state
operator|=
literal|1
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_PSK
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-psk_identity"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|psk_identity
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-psk"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|size_t
name|j
decl_stmt|;
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|psk_key
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|strlen
argument_list|(
name|psk_key
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|isxdigit
argument_list|(
operator|(
name|unsigned
name|char
operator|)
name|psk_key
index|[
name|j
index|]
argument_list|)
condition|)
continue|continue;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Not a hex number '%s'\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-srpuser"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|srp_arg
operator|.
name|srplogin
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|meth
operator|=
name|TLSv1_client_method
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-srppass"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|srppass
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|meth
operator|=
name|TLSv1_client_method
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-srp_strength"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|srp_arg
operator|.
name|strength
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"SRP minimal length for N is %d\n"
argument_list|,
name|srp_arg
operator|.
name|strength
argument_list|)
expr_stmt|;
name|meth
operator|=
name|TLSv1_client_method
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-srp_lateuser"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|srp_lateuser
operator|=
literal|1
expr_stmt|;
name|meth
operator|=
name|TLSv1_client_method
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-srp_moregroups"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|srp_arg
operator|.
name|amp
operator|=
literal|1
expr_stmt|;
name|meth
operator|=
name|TLSv1_client_method
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL2
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ssl2"
argument_list|)
operator|==
literal|0
condition|)
name|meth
operator|=
name|SSLv2_client_method
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL3_METHOD
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ssl3"
argument_list|)
operator|==
literal|0
condition|)
name|meth
operator|=
name|SSLv3_client_method
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLS1
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-tls1_2"
argument_list|)
operator|==
literal|0
condition|)
name|meth
operator|=
name|TLSv1_2_client_method
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-tls1_1"
argument_list|)
operator|==
literal|0
condition|)
name|meth
operator|=
name|TLSv1_1_client_method
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-tls1"
argument_list|)
operator|==
literal|0
condition|)
name|meth
operator|=
name|TLSv1_client_method
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_DTLS1
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dtls"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|DTLS_client_method
argument_list|()
expr_stmt|;
name|socket_type
operator|=
name|SOCK_DGRAM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dtls1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|DTLSv1_client_method
argument_list|()
expr_stmt|;
name|socket_type
operator|=
name|SOCK_DGRAM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dtls1_2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|DTLSv1_2_client_method
argument_list|()
expr_stmt|;
name|socket_type
operator|=
name|SOCK_DGRAM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-timeout"
argument_list|)
operator|==
literal|0
condition|)
name|enable_timeouts
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-mtu"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|socket_mtu
operator|=
name|atol
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-fallback_scsv"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fallback_scsv
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keyform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|key_format
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-pass"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|passarg
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cert_chain"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|chain_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-key"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|key_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-reconnect"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reconnect
operator|=
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CApath"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CApath
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-chainCApath"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|chCApath
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verifyCApath"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|vfyCApath
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-build_chain"
argument_list|)
operator|==
literal|0
condition|)
name|build_chain
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CAfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CAfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-chainCAfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|chCAfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verifyCAfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|vfyCAfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
ifndef|#
directive|ifndef
name|OPENSSL_NO_NEXTPROTONEG
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nextprotoneg"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|next_proto_neg_in
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-alpn"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|alpn_in
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-serverinfo"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|c
decl_stmt|;
name|int
name|start
init|=
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|c
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|serverinfo_types_count
operator|=
literal|0
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|c
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|len
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|i
operator|==
name|len
operator|||
name|c
index|[
name|i
index|]
operator|==
literal|','
condition|)
block|{
name|serverinfo_types
index|[
name|serverinfo_types_count
index|]
operator|=
name|atoi
argument_list|(
name|c
operator|+
name|start
argument_list|)
expr_stmt|;
name|serverinfo_types_count
operator|++
expr_stmt|;
name|start
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|serverinfo_types_count
operator|==
name|MAX_SI_TYPES
condition|)
break|break;
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FIONBIO
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nbio"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|c_nbio
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-starttls"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
operator|++
name|argv
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"smtp"
argument_list|)
operator|==
literal|0
condition|)
name|starttls_proto
operator|=
name|PROTO_SMTP
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"pop3"
argument_list|)
operator|==
literal|0
condition|)
name|starttls_proto
operator|=
name|PROTO_POP3
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"imap"
argument_list|)
operator|==
literal|0
condition|)
name|starttls_proto
operator|=
name|PROTO_IMAP
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"ftp"
argument_list|)
operator|==
literal|0
condition|)
name|starttls_proto
operator|=
name|PROTO_FTP
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"xmpp"
argument_list|)
operator|==
literal|0
condition|)
name|starttls_proto
operator|=
name|PROTO_XMPP
expr_stmt|;
else|else
goto|goto
name|bad
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-engine"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|engine_id
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ssl_client_engine"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|ssl_client_engine_id
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-rand"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|inrand
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-servername"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|servername
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
comment|/* meth=TLSv1_client_method(); */
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_JPAKE
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-jpake"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|jpake_secret
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRTP
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-use_srtp"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|srtp_profiles
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keymatexport"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|keymatexportlabel
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keymatexportlen"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|keymatexportlen
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|keymatexportlen
operator|==
literal|0
condition|)
goto|goto
name|bad
goto|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unknown option %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|badop
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|badop
condition|)
block|{
name|bad
label|:
name|sc_usage
argument_list|()
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_JPAKE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_PSK
argument_list|)
if|if
condition|(
name|jpake_secret
condition|)
block|{
if|if
condition|(
name|psk_key
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Can't use JPAKE and PSK together\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|psk_identity
operator|=
literal|"JPAKE"
expr_stmt|;
block|}
endif|#
directive|endif
name|OpenSSL_add_ssl_algorithms
argument_list|()
expr_stmt|;
name|SSL_load_error_strings
argument_list|()
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_TLSEXT
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_NEXTPROTONEG
argument_list|)
name|next_proto
operator|.
name|status
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|next_proto_neg_in
condition|)
block|{
name|next_proto
operator|.
name|data
operator|=
name|next_protos_parse
argument_list|(
operator|&
name|next_proto
operator|.
name|len
argument_list|,
name|next_proto_neg_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|next_proto
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error parsing -nextprotoneg argument\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
else|else
name|next_proto
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|e
operator|=
name|setup_engine
argument_list|(
name|bio_err
argument_list|,
name|engine_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssl_client_engine_id
condition|)
block|{
name|ssl_client_engine
operator|=
name|ENGINE_by_id
argument_list|(
name|ssl_client_engine_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssl_client_engine
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error getting client auth engine\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
operator|!
name|app_passwd
argument_list|(
name|bio_err
argument_list|,
name|passarg
argument_list|,
name|NULL
argument_list|,
operator|&
name|pass
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error getting password\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|key_file
operator|==
name|NULL
condition|)
name|key_file
operator|=
name|cert_file
expr_stmt|;
if|if
condition|(
name|key_file
condition|)
block|{
name|key
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|key_file
argument_list|,
name|key_format
argument_list|,
literal|0
argument_list|,
name|pass
argument_list|,
name|e
argument_list|,
literal|"client certificate private key file"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|key
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
name|cert_file
condition|)
block|{
name|cert
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|cert_file
argument_list|,
name|cert_format
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"client certificate file"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cert
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
name|chain_file
condition|)
block|{
name|chain
operator|=
name|load_certs
argument_list|(
name|bio_err
argument_list|,
name|chain_file
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"client certificate chain"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|chain
condition|)
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|crl_file
condition|)
block|{
name|X509_CRL
modifier|*
name|crl
decl_stmt|;
name|crl
operator|=
name|load_crl
argument_list|(
name|crl_file
argument_list|,
name|crl_format
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|crl
condition|)
block|{
name|BIO_puts
argument_list|(
name|bio_err
argument_list|,
literal|"Error loading CRL\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|crls
operator|=
name|sk_X509_CRL_new_null
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|crls
operator|||
operator|!
name|sk_X509_CRL_push
argument_list|(
name|crls
argument_list|,
name|crl
argument_list|)
condition|)
block|{
name|BIO_puts
argument_list|(
name|bio_err
argument_list|,
literal|"Error adding CRL\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|X509_CRL_free
argument_list|(
name|crl
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|load_excert
argument_list|(
operator|&
name|exc
argument_list|,
name|bio_err
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|app_RAND_load_file
argument_list|(
name|NULL
argument_list|,
name|bio_err
argument_list|,
literal|1
argument_list|)
operator|&&
name|inrand
operator|==
name|NULL
operator|&&
operator|!
name|RAND_status
argument_list|()
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"warning, not much extra random data, consider using the -rand option\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inrand
operator|!=
name|NULL
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%ld semi-random bytes loaded\n"
argument_list|,
name|app_RAND_load_files
argument_list|(
name|inrand
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio_c_out
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|c_quiet
operator|&&
operator|!
name|c_debug
condition|)
block|{
name|bio_c_out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_null
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|c_msg
operator|&&
operator|!
name|bio_c_msg
condition|)
name|bio_c_msg
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bio_c_out
operator|==
name|NULL
condition|)
name|bio_c_out
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
block|}
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
if|if
condition|(
operator|!
name|app_passwd
argument_list|(
name|bio_err
argument_list|,
name|srppass
argument_list|,
name|NULL
argument_list|,
operator|&
name|srp_arg
operator|.
name|srppassin
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error getting password\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
endif|#
directive|endif
name|ctx
operator|=
name|SSL_CTX_new
argument_list|(
name|meth
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|vpm
condition|)
name|SSL_CTX_set1_param
argument_list|(
name|ctx
argument_list|,
name|vpm
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|args_ssl_call
argument_list|(
name|ctx
argument_list|,
name|bio_err
argument_list|,
name|cctx
argument_list|,
name|ssl_args
argument_list|,
literal|1
argument_list|,
name|no_jpake
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|ssl_load_stores
argument_list|(
name|ctx
argument_list|,
name|vfyCApath
argument_list|,
name|vfyCAfile
argument_list|,
name|chCApath
argument_list|,
name|chCAfile
argument_list|,
name|crls
argument_list|,
name|crl_download
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error loading store locations\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
if|if
condition|(
name|ssl_client_engine
condition|)
block|{
if|if
condition|(
operator|!
name|SSL_CTX_set_client_cert_engine
argument_list|(
name|ctx
argument_list|,
name|ssl_client_engine
argument_list|)
condition|)
block|{
name|BIO_puts
argument_list|(
name|bio_err
argument_list|,
literal|"Error setting client auth engine\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|ssl_client_engine
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|ENGINE_free
argument_list|(
name|ssl_client_engine
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_PSK
ifdef|#
directive|ifdef
name|OPENSSL_NO_JPAKE
if|if
condition|(
name|psk_key
operator|!=
name|NULL
condition|)
else|#
directive|else
if|if
condition|(
name|psk_key
operator|!=
name|NULL
operator|||
name|jpake_secret
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
name|c_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"PSK key given or JPAKE in use, setting client callback\n"
argument_list|)
expr_stmt|;
name|SSL_CTX_set_psk_client_callback
argument_list|(
name|ctx
argument_list|,
name|psk_client_cb
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRTP
if|if
condition|(
name|srtp_profiles
operator|!=
name|NULL
condition|)
name|SSL_CTX_set_tlsext_use_srtp
argument_list|(
name|ctx
argument_list|,
name|srtp_profiles
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|exc
condition|)
name|ssl_ctx_set_excert
argument_list|(
name|ctx
argument_list|,
name|exc
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_TLSEXT
argument_list|)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_NEXTPROTONEG
argument_list|)
if|if
condition|(
name|next_proto
operator|.
name|data
condition|)
name|SSL_CTX_set_next_proto_select_cb
argument_list|(
name|ctx
argument_list|,
name|next_proto_cb
argument_list|,
operator|&
name|next_proto
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|alpn_in
condition|)
block|{
name|unsigned
name|short
name|alpn_len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|alpn
init|=
name|next_protos_parse
argument_list|(
operator|&
name|alpn_len
argument_list|,
name|alpn_in
argument_list|)
decl_stmt|;
if|if
condition|(
name|alpn
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error parsing -alpn argument\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|SSL_CTX_set_alpn_protos
argument_list|(
name|ctx
argument_list|,
name|alpn
argument_list|,
name|alpn_len
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|alpn
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|serverinfo_types_count
condition|;
name|i
operator|++
control|)
block|{
name|SSL_CTX_add_client_custom_ext
argument_list|(
name|ctx
argument_list|,
name|serverinfo_types
index|[
name|i
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|serverinfo_cli_parse_cb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|state
condition|)
name|SSL_CTX_set_info_callback
argument_list|(
name|ctx
argument_list|,
name|apps_ssl_info_callback
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|else         SSL_CTX_set_cipher_list(ctx, getenv("SSL_CIPHER"));
endif|#
directive|endif
name|SSL_CTX_set_verify
argument_list|(
name|ctx
argument_list|,
name|verify
argument_list|,
name|verify_callback
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|CAfile
operator|||
name|CApath
operator|)
operator|&&
operator|!
name|SSL_CTX_load_verify_locations
argument_list|(
name|ctx
argument_list|,
name|CAfile
argument_list|,
name|CApath
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|SSL_CTX_set_default_verify_paths
argument_list|(
name|ctx
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
name|ssl_ctx_add_crls
argument_list|(
name|ctx
argument_list|,
name|crls
argument_list|,
name|crl_download
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|set_cert_key_stuff
argument_list|(
name|ctx
argument_list|,
name|cert
argument_list|,
name|key
argument_list|,
name|chain
argument_list|,
name|build_chain
argument_list|)
condition|)
goto|goto
name|end
goto|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|servername
operator|!=
name|NULL
condition|)
block|{
name|tlsextcbp
operator|.
name|biodebug
operator|=
name|bio_err
expr_stmt|;
name|SSL_CTX_set_tlsext_servername_callback
argument_list|(
name|ctx
argument_list|,
name|ssl_servername_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_servername_arg
argument_list|(
name|ctx
argument_list|,
operator|&
name|tlsextcbp
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
if|if
condition|(
name|srp_arg
operator|.
name|srplogin
condition|)
block|{
if|if
condition|(
operator|!
name|srp_lateuser
operator|&&
operator|!
name|SSL_CTX_set_srp_username
argument_list|(
name|ctx
argument_list|,
name|srp_arg
operator|.
name|srplogin
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Unable to set SRP username\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|srp_arg
operator|.
name|msg
operator|=
name|c_msg
expr_stmt|;
name|srp_arg
operator|.
name|debug
operator|=
name|c_debug
expr_stmt|;
name|SSL_CTX_set_srp_cb_arg
argument_list|(
name|ctx
argument_list|,
operator|&
name|srp_arg
argument_list|)
expr_stmt|;
name|SSL_CTX_set_srp_client_pwd_callback
argument_list|(
name|ctx
argument_list|,
name|ssl_give_srp_client_pwd_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_srp_strength
argument_list|(
name|ctx
argument_list|,
name|srp_arg
operator|.
name|strength
argument_list|)
expr_stmt|;
if|if
condition|(
name|c_msg
operator|||
name|c_debug
operator|||
name|srp_arg
operator|.
name|amp
operator|==
literal|0
condition|)
name|SSL_CTX_set_srp_verify_param_callback
argument_list|(
name|ctx
argument_list|,
name|ssl_srp_verify_param_cb
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
name|con
operator|=
name|SSL_new
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sess_in
condition|)
block|{
name|SSL_SESSION
modifier|*
name|sess
decl_stmt|;
name|BIO
modifier|*
name|stmp
init|=
name|BIO_new_file
argument_list|(
name|sess_in
argument_list|,
literal|"r"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|stmp
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Can't open session file %s\n"
argument_list|,
name|sess_in
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|sess
operator|=
name|PEM_read_bio_SSL_SESSION
argument_list|(
name|stmp
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|stmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sess
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Can't open session file %s\n"
argument_list|,
name|sess_in
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|SSL_set_session
argument_list|(
name|con
argument_list|,
name|sess
argument_list|)
expr_stmt|;
name|SSL_SESSION_free
argument_list|(
name|sess
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fallback_scsv
condition|)
name|SSL_set_mode
argument_list|(
name|con
argument_list|,
name|SSL_MODE_SEND_FALLBACK_SCSV
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|servername
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|SSL_set_tlsext_host_name
argument_list|(
name|con
argument_list|,
name|servername
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Unable to set TLS servername extension.\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
if|if
condition|(
name|con
operator|&&
operator|(
name|kctx
operator|=
name|kssl_ctx_new
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|SSL_set0_kssl_ctx
argument_list|(
name|con
argument_list|,
name|kctx
argument_list|)
expr_stmt|;
name|kssl_ctx_setstring
argument_list|(
name|kctx
argument_list|,
name|KSSL_SERVER
argument_list|,
name|host
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_KRB5 */
comment|/*      SSL_set_cipher_list(con,"RC4-MD5"); */
if|#
directive|if
literal|0
ifdef|#
directive|ifdef
name|TLSEXT_TYPE_opaque_prf_input
block|SSL_set_tlsext_opaque_prf_input(con, "Test client", 11);
endif|#
directive|endif
endif|#
directive|endif
name|re_start
label|:
if|if
condition|(
name|init_client
argument_list|(
operator|&
name|s
argument_list|,
name|host
argument_list|,
name|port
argument_list|,
name|socket_type
argument_list|)
operator|==
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"connect:errno=%d\n"
argument_list|,
name|get_last_socket_error
argument_list|()
argument_list|)
expr_stmt|;
name|SHUTDOWN
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"CONNECTED(%08X)\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FIONBIO
if|if
condition|(
name|c_nbio
condition|)
block|{
name|unsigned
name|long
name|l
init|=
literal|1
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"turning on non blocking io\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_socket_ioctl
argument_list|(
name|s
argument_list|,
name|FIONBIO
argument_list|,
operator|&
name|l
argument_list|)
operator|<
literal|0
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|c_Pause
operator|&
literal|0x01
condition|)
name|SSL_set_debug
argument_list|(
name|con
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|socket_type
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|sbio
operator|=
name|BIO_new_dgram
argument_list|(
name|s
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|s
argument_list|,
operator|&
name|peer
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|peerlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"getsockname:errno=%d\n"
argument_list|,
name|get_last_socket_error
argument_list|()
argument_list|)
expr_stmt|;
name|SHUTDOWN
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
operator|(
name|void
operator|)
name|BIO_ctrl_set_connected
argument_list|(
name|sbio
argument_list|,
literal|1
argument_list|,
operator|&
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable_timeouts
condition|)
block|{
name|timeout
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
name|DGRAM_RCV_TIMEOUT
expr_stmt|;
name|BIO_ctrl
argument_list|(
name|sbio
argument_list|,
name|BIO_CTRL_DGRAM_SET_RECV_TIMEOUT
argument_list|,
literal|0
argument_list|,
operator|&
name|timeout
argument_list|)
expr_stmt|;
name|timeout
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
name|DGRAM_SND_TIMEOUT
expr_stmt|;
name|BIO_ctrl
argument_list|(
name|sbio
argument_list|,
name|BIO_CTRL_DGRAM_SET_SEND_TIMEOUT
argument_list|,
literal|0
argument_list|,
operator|&
name|timeout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|socket_mtu
condition|)
block|{
if|if
condition|(
name|socket_mtu
operator|<
name|DTLS_get_link_min_mtu
argument_list|(
name|con
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"MTU too small. Must be at least %ld\n"
argument_list|,
name|DTLS_get_link_min_mtu
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|sbio
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
block|}
name|SSL_set_options
argument_list|(
name|con
argument_list|,
name|SSL_OP_NO_QUERY_MTU
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DTLS_set_link_mtu
argument_list|(
name|con
argument_list|,
name|socket_mtu
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Failed to set MTU\n"
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|sbio
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
block|}
block|}
else|else
comment|/* want to do MTU discovery */
name|BIO_ctrl
argument_list|(
name|sbio
argument_list|,
name|BIO_CTRL_DGRAM_MTU_DISCOVER
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|sbio
operator|=
name|BIO_new_socket
argument_list|(
name|s
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbio_test
condition|)
block|{
name|BIO
modifier|*
name|test
decl_stmt|;
name|test
operator|=
name|BIO_new
argument_list|(
name|BIO_f_nbio_test
argument_list|()
argument_list|)
expr_stmt|;
name|sbio
operator|=
name|BIO_push
argument_list|(
name|test
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c_debug
condition|)
block|{
name|SSL_set_debug
argument_list|(
name|con
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BIO_set_callback
argument_list|(
name|sbio
argument_list|,
name|bio_dump_callback
argument_list|)
expr_stmt|;
name|BIO_set_callback_arg
argument_list|(
name|sbio
argument_list|,
operator|(
name|char
operator|*
operator|)
name|bio_c_out
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c_msg
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL_TRACE
if|if
condition|(
name|c_msg
operator|==
literal|2
condition|)
name|SSL_set_msg_callback
argument_list|(
name|con
argument_list|,
name|SSL_trace
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|SSL_set_msg_callback
argument_list|(
name|con
argument_list|,
name|msg_cb
argument_list|)
expr_stmt|;
name|SSL_set_msg_callback_arg
argument_list|(
name|con
argument_list|,
name|bio_c_msg
condition|?
name|bio_c_msg
else|:
name|bio_c_out
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|c_tlsextdebug
condition|)
block|{
name|SSL_set_tlsext_debug_callback
argument_list|(
name|con
argument_list|,
name|tlsext_cb
argument_list|)
expr_stmt|;
name|SSL_set_tlsext_debug_arg
argument_list|(
name|con
argument_list|,
name|bio_c_out
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c_status_req
condition|)
block|{
name|SSL_set_tlsext_status_type
argument_list|(
name|con
argument_list|,
name|TLSEXT_STATUSTYPE_ocsp
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_status_cb
argument_list|(
name|ctx
argument_list|,
name|ocsp_resp_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_status_arg
argument_list|(
name|ctx
argument_list|,
name|bio_c_out
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|{             STACK_OF(OCSP_RESPID) *ids = sk_OCSP_RESPID_new_null();             OCSP_RESPID *id = OCSP_RESPID_new();             id->value.byKey = ASN1_OCTET_STRING_new();             id->type = V_OCSP_RESPID_KEY;             ASN1_STRING_set(id->value.byKey, "Hello World", -1);             sk_OCSP_RESPID_push(ids, id);             SSL_set_tlsext_status_ids(con, ids);         }
endif|#
directive|endif
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_JPAKE
if|if
condition|(
name|jpake_secret
condition|)
name|jpake_client_auth
argument_list|(
name|bio_c_out
argument_list|,
name|sbio
argument_list|,
name|jpake_secret
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SSL_set_bio
argument_list|(
name|con
argument_list|,
name|sbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
name|SSL_set_connect_state
argument_list|(
name|con
argument_list|)
expr_stmt|;
comment|/* ok, lets connect */
name|width
operator|=
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
operator|+
literal|1
expr_stmt|;
name|read_tty
operator|=
literal|1
expr_stmt|;
name|write_tty
operator|=
literal|0
expr_stmt|;
name|tty_on
operator|=
literal|0
expr_stmt|;
name|read_ssl
operator|=
literal|1
expr_stmt|;
name|write_ssl
operator|=
literal|1
expr_stmt|;
name|cbuf_len
operator|=
literal|0
expr_stmt|;
name|cbuf_off
operator|=
literal|0
expr_stmt|;
name|sbuf_len
operator|=
literal|0
expr_stmt|;
name|sbuf_off
operator|=
literal|0
expr_stmt|;
comment|/* This is an ugly hack that does a lot of assumptions */
comment|/*      * We do have to handle multi-line responses which may come in a single      * packet or not. We therefore have to use BIO_gets() which does need a      * buffering BIO. So during the initial chitchat we do push a buffering      * BIO into the chain that is removed again later on to not disturb the      * rest of the s_client operation.      */
if|if
condition|(
name|starttls_proto
operator|==
name|PROTO_SMTP
condition|)
block|{
name|int
name|foundit
init|=
literal|0
decl_stmt|;
name|BIO
modifier|*
name|fbio
init|=
name|BIO_new
argument_list|(
name|BIO_f_buffer
argument_list|()
argument_list|)
decl_stmt|;
name|BIO_push
argument_list|(
name|fbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
comment|/* wait for multi-line response to end from SMTP */
do|do
block|{
name|mbuf_len
operator|=
name|BIO_gets
argument_list|(
name|fbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|mbuf_len
operator|>
literal|3
operator|&&
name|mbuf
index|[
literal|3
index|]
operator|==
literal|'-'
condition|)
do|;
comment|/* STARTTLS command requires EHLO... */
name|BIO_printf
argument_list|(
name|fbio
argument_list|,
literal|"EHLO openssl.client.net\r\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
comment|/* wait for multi-line response to end EHLO SMTP response */
do|do
block|{
name|mbuf_len
operator|=
name|BIO_gets
argument_list|(
name|fbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|strstr
argument_list|(
name|mbuf
argument_list|,
literal|"STARTTLS"
argument_list|)
condition|)
name|foundit
operator|=
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|mbuf_len
operator|>
literal|3
operator|&&
name|mbuf
index|[
literal|3
index|]
operator|==
literal|'-'
condition|)
do|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_pop
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|foundit
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"didn't found starttls in server response,"
literal|" try anyway...\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|sbio
argument_list|,
literal|"STARTTLS\r\n"
argument_list|)
expr_stmt|;
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|starttls_proto
operator|==
name|PROTO_POP3
condition|)
block|{
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|sbio
argument_list|,
literal|"STLS\r\n"
argument_list|)
expr_stmt|;
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|starttls_proto
operator|==
name|PROTO_IMAP
condition|)
block|{
name|int
name|foundit
init|=
literal|0
decl_stmt|;
name|BIO
modifier|*
name|fbio
init|=
name|BIO_new
argument_list|(
name|BIO_f_buffer
argument_list|()
argument_list|)
decl_stmt|;
name|BIO_push
argument_list|(
name|fbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
name|BIO_gets
argument_list|(
name|fbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
comment|/* STARTTLS command requires CAPABILITY... */
name|BIO_printf
argument_list|(
name|fbio
argument_list|,
literal|". CAPABILITY\r\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
comment|/* wait for multi-line CAPABILITY response */
do|do
block|{
name|mbuf_len
operator|=
name|BIO_gets
argument_list|(
name|fbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|strstr
argument_list|(
name|mbuf
argument_list|,
literal|"STARTTLS"
argument_list|)
condition|)
name|foundit
operator|=
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|mbuf_len
operator|>
literal|3
operator|&&
name|mbuf
index|[
literal|0
index|]
operator|!=
literal|'.'
condition|)
do|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_pop
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|foundit
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"didn't found STARTTLS in server response,"
literal|" try anyway...\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|sbio
argument_list|,
literal|". STARTTLS\r\n"
argument_list|)
expr_stmt|;
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|starttls_proto
operator|==
name|PROTO_FTP
condition|)
block|{
name|BIO
modifier|*
name|fbio
init|=
name|BIO_new
argument_list|(
name|BIO_f_buffer
argument_list|()
argument_list|)
decl_stmt|;
name|BIO_push
argument_list|(
name|fbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
comment|/* wait for multi-line response to end from FTP */
do|do
block|{
name|mbuf_len
operator|=
name|BIO_gets
argument_list|(
name|fbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|mbuf_len
operator|>
literal|3
operator|&&
name|mbuf
index|[
literal|3
index|]
operator|==
literal|'-'
condition|)
do|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_pop
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|sbio
argument_list|,
literal|"AUTH TLS\r\n"
argument_list|)
expr_stmt|;
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|starttls_proto
operator|==
name|PROTO_XMPP
condition|)
block|{
name|int
name|seen
init|=
literal|0
decl_stmt|;
name|BIO_printf
argument_list|(
name|sbio
argument_list|,
literal|"<stream:stream "
literal|"xmlns:stream='http://etherx.jabber.org/streams' "
literal|"xmlns='jabber:client' to='%s' version='1.0'>"
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|seen
operator|=
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|mbuf
index|[
name|seen
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|!
name|strstr
argument_list|(
name|mbuf
argument_list|,
literal|"<starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'"
argument_list|)
condition|)
block|{
if|if
condition|(
name|strstr
argument_list|(
name|mbuf
argument_list|,
literal|"/stream:features>"
argument_list|)
condition|)
goto|goto
name|shut
goto|;
name|seen
operator|=
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|mbuf
index|[
name|seen
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|sbio
argument_list|,
literal|"<starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'/>"
argument_list|)
expr_stmt|;
name|seen
operator|=
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|sbuf
index|[
name|seen
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|strstr
argument_list|(
name|sbuf
argument_list|,
literal|"<proceed"
argument_list|)
condition|)
goto|goto
name|shut
goto|;
name|mbuf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|FD_ZERO
argument_list|(
operator|&
name|readfds
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|writefds
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|SSL_version
argument_list|(
name|con
argument_list|)
operator|==
name|DTLS1_VERSION
operator|)
operator|&&
name|DTLSv1_get_timeout
argument_list|(
name|con
argument_list|,
operator|&
name|timeout
argument_list|)
condition|)
name|timeoutp
operator|=
operator|&
name|timeout
expr_stmt|;
else|else
name|timeoutp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|SSL_in_init
argument_list|(
name|con
argument_list|)
operator|&&
operator|!
name|SSL_total_renegotiations
argument_list|(
name|con
argument_list|)
condition|)
block|{
name|in_init
operator|=
literal|1
expr_stmt|;
name|tty_on
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|tty_on
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|in_init
condition|)
block|{
name|in_init
operator|=
literal|0
expr_stmt|;
if|#
directive|if
literal|0
comment|/* This test doesn't really work as intended                                  * (needs to be fixed) */
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
block|if (servername != NULL&& !SSL_session_reused(con)) {                     BIO_printf(bio_c_out,                                "Server did %sacknowledge servername extension.\n",                                tlsextcbp.ack ? "" : "not ");                 }
endif|#
directive|endif
endif|#
directive|endif
if|if
condition|(
name|sess_out
condition|)
block|{
name|BIO
modifier|*
name|stmp
init|=
name|BIO_new_file
argument_list|(
name|sess_out
argument_list|,
literal|"w"
argument_list|)
decl_stmt|;
if|if
condition|(
name|stmp
condition|)
block|{
name|PEM_write_bio_SSL_SESSION
argument_list|(
name|stmp
argument_list|,
name|SSL_get_session
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|stmp
argument_list|)
expr_stmt|;
block|}
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error writing session file %s\n"
argument_list|,
name|sess_out
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c_brief
condition|)
block|{
name|BIO_puts
argument_list|(
name|bio_err
argument_list|,
literal|"CONNECTION ESTABLISHED\n"
argument_list|)
expr_stmt|;
name|print_ssl_summary
argument_list|(
name|bio_err
argument_list|,
name|con
argument_list|)
expr_stmt|;
block|}
name|print_stuff
argument_list|(
name|bio_c_out
argument_list|,
name|con
argument_list|,
name|full_log
argument_list|)
expr_stmt|;
if|if
condition|(
name|full_log
operator|>
literal|0
condition|)
name|full_log
operator|--
expr_stmt|;
if|if
condition|(
name|starttls_proto
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s"
argument_list|,
name|mbuf
argument_list|)
expr_stmt|;
comment|/* We don't need to know any more */
name|starttls_proto
operator|=
name|PROTO_OFF
expr_stmt|;
block|}
if|if
condition|(
name|reconnect
condition|)
block|{
name|reconnect
operator|--
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"drop connection and then reconnect\n"
argument_list|)
expr_stmt|;
name|SSL_shutdown
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|SSL_set_connect_state
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|SHUTDOWN
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|re_start
goto|;
block|}
block|}
block|}
name|ssl_pending
operator|=
name|read_ssl
operator|&&
name|SSL_pending
argument_list|(
name|con
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssl_pending
condition|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
if|if
condition|(
name|tty_on
condition|)
block|{
if|if
condition|(
name|read_tty
condition|)
name|openssl_fdset
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_tty
condition|)
name|openssl_fdset
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|,
operator|&
name|writefds
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|read_ssl
condition|)
name|openssl_fdset
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_ssl
condition|)
name|openssl_fdset
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|writefds
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|!
name|tty_on
operator|||
operator|!
name|write_tty
condition|)
block|{
if|if
condition|(
name|read_ssl
condition|)
name|openssl_fdset
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_ssl
condition|)
name|openssl_fdset
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|writefds
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/*-         printf("mode tty(%d %d%d) ssl(%d%d)\n",                     tty_on,read_tty,write_tty,read_ssl,write_ssl);*/
comment|/*              * Note: under VMS with SOCKETSHR the second parameter is              * currently of type (int *) whereas under other systems it is              * (void *) if you don't have a cast it will choke the compiler:              * if you do have a cast then you can either go for (int *) or              * (void *).              */
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
comment|/*              * Under Windows/DOS we make the assumption that we can always              * write to the tty: therefore if we need to write to the tty we              * just fall through. Otherwise we timeout the select every              * second and see if there are any keypresses. Note: this is a              * hack, in a proper Windows application we wouldn't do this.              */
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|write_tty
condition|)
block|{
if|if
condition|(
name|read_tty
condition|)
block|{
name|tv
operator|.
name|tv_sec
operator|=
literal|1
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINCE
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
if|if
condition|(
operator|!
name|i
operator|&&
operator|(
operator|!
name|_kbhit
argument_list|()
operator|||
operator|!
name|read_tty
operator|)
condition|)
continue|continue;
else|#
directive|else
if|if
condition|(
operator|!
name|i
operator|&&
operator|(
operator|!
operator|(
operator|(
name|_kbhit
argument_list|()
operator|)
operator|||
operator|(
name|WAIT_OBJECT_0
operator|==
name|WaitForSingleObject
argument_list|(
name|GetStdHandle
argument_list|(
name|STD_INPUT_HANDLE
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|)
operator|)
operator|||
operator|!
name|read_tty
operator|)
condition|)
continue|continue;
endif|#
directive|endif
block|}
else|else
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
name|timeoutp
argument_list|)
expr_stmt|;
block|}
elif|#
directive|elif
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
if|if
condition|(
operator|!
name|write_tty
condition|)
block|{
if|if
condition|(
name|read_tty
condition|)
block|{
name|tv
operator|.
name|tv_sec
operator|=
literal|1
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
block|}
else|else
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
name|timeoutp
argument_list|)
expr_stmt|;
block|}
elif|#
directive|elif
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
comment|/* Under BeOS-R5 the situation is similar to DOS */
name|i
operator|=
literal|0
expr_stmt|;
name|stdin_set
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|fcntl
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|write_tty
condition|)
block|{
if|if
condition|(
name|read_tty
condition|)
block|{
name|tv
operator|.
name|tv_sec
operator|=
literal|1
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|sbuf
argument_list|,
literal|0
argument_list|)
operator|>=
literal|0
condition|)
name|stdin_set
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|i
operator|&&
operator|(
name|stdin_set
operator|!=
literal|1
operator|||
operator|!
name|read_tty
operator|)
condition|)
continue|continue;
block|}
else|else
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
name|timeoutp
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fcntl
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|F_SETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
name|timeoutp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"bad select %d\n"
argument_list|,
name|get_last_socket_error
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
comment|/* goto end; */
block|}
block|}
if|if
condition|(
operator|(
name|SSL_version
argument_list|(
name|con
argument_list|)
operator|==
name|DTLS1_VERSION
operator|)
operator|&&
name|DTLSv1_handle_timeout
argument_list|(
name|con
argument_list|)
operator|>
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"TIMEOUT occured\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ssl_pending
operator|&&
name|FD_ISSET
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|writefds
argument_list|)
condition|)
block|{
name|k
operator|=
name|SSL_write
argument_list|(
name|con
argument_list|,
operator|&
operator|(
name|cbuf
index|[
name|cbuf_off
index|]
operator|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|cbuf_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|k
argument_list|)
condition|)
block|{
case|case
name|SSL_ERROR_NONE
case|:
name|cbuf_off
operator|+=
name|k
expr_stmt|;
name|cbuf_len
operator|-=
name|k
expr_stmt|;
if|if
condition|(
name|k
operator|<=
literal|0
condition|)
goto|goto
name|end
goto|;
comment|/* we have done a  write(con,NULL,0); */
if|if
condition|(
name|cbuf_len
operator|<=
literal|0
condition|)
block|{
name|read_tty
operator|=
literal|1
expr_stmt|;
name|write_ssl
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* if (cbuf_len> 0) */
name|read_tty
operator|=
literal|0
expr_stmt|;
name|write_ssl
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|SSL_ERROR_WANT_WRITE
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"write W BLOCK\n"
argument_list|)
expr_stmt|;
name|write_ssl
operator|=
literal|1
expr_stmt|;
name|read_tty
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_WANT_READ
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"write R BLOCK\n"
argument_list|)
expr_stmt|;
name|write_tty
operator|=
literal|0
expr_stmt|;
name|read_ssl
operator|=
literal|1
expr_stmt|;
name|write_ssl
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_WANT_X509_LOOKUP
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"write X BLOCK\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_ZERO_RETURN
case|:
if|if
condition|(
name|cbuf_len
operator|!=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"shutdown\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|shut
goto|;
block|}
else|else
block|{
name|read_tty
operator|=
literal|1
expr_stmt|;
name|write_ssl
operator|=
literal|0
expr_stmt|;
break|break;
block|}
case|case
name|SSL_ERROR_SYSCALL
case|:
if|if
condition|(
operator|(
name|k
operator|!=
literal|0
operator|)
operator|||
operator|(
name|cbuf_len
operator|!=
literal|0
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"write:errno=%d\n"
argument_list|,
name|get_last_socket_error
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
block|}
else|else
block|{
name|read_tty
operator|=
literal|1
expr_stmt|;
name|write_ssl
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|SSL_ERROR_SSL
case|:
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
block|}
block|}
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
comment|/* Assume Windows/DOS/BeOS can always write */
elseif|else
if|if
condition|(
operator|!
name|ssl_pending
operator|&&
name|write_tty
condition|)
else|#
directive|else
elseif|else
if|if
condition|(
operator|!
name|ssl_pending
operator|&&
name|FD_ISSET
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|,
operator|&
name|writefds
argument_list|)
condition|)
endif|#
directive|endif
block|{
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
name|ascii2ebcdic
argument_list|(
operator|&
operator|(
name|sbuf
index|[
name|sbuf_off
index|]
operator|)
argument_list|,
operator|&
operator|(
name|sbuf
index|[
name|sbuf_off
index|]
operator|)
argument_list|,
name|sbuf_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|i
operator|=
name|raw_write_stdout
argument_list|(
operator|&
operator|(
name|sbuf
index|[
name|sbuf_off
index|]
operator|)
argument_list|,
name|sbuf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"DONE\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|shut
goto|;
comment|/* goto end; */
block|}
name|sbuf_len
operator|-=
name|i
expr_stmt|;
empty_stmt|;
name|sbuf_off
operator|+=
name|i
expr_stmt|;
if|if
condition|(
name|sbuf_len
operator|<=
literal|0
condition|)
block|{
name|read_ssl
operator|=
literal|1
expr_stmt|;
name|write_tty
operator|=
literal|0
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ssl_pending
operator|||
name|FD_ISSET
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|RENEG
block|{
specifier|static
name|int
name|iiii
decl_stmt|;
if|if
condition|(
operator|++
name|iiii
operator|==
literal|52
condition|)
block|{
name|SSL_renegotiate
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|iiii
operator|=
literal|0
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|#
directive|if
literal|1
name|k
operator|=
name|SSL_read
argument_list|(
name|con
argument_list|,
name|sbuf
argument_list|,
literal|1024
comment|/* BUFSIZZ */
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* Demo for pending and peek :-) */
name|k
operator|=
name|SSL_read
argument_list|(
name|con
argument_list|,
name|sbuf
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|{
name|char
name|zbuf
index|[
literal|10240
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"read=%d pending=%d peek=%d\n"
argument_list|,
name|k
argument_list|,
name|SSL_pending
argument_list|(
name|con
argument_list|)
argument_list|,
name|SSL_peek
argument_list|(
name|con
argument_list|,
name|zbuf
argument_list|,
literal|10240
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|k
argument_list|)
condition|)
block|{
case|case
name|SSL_ERROR_NONE
case|:
if|if
condition|(
name|k
operator|<=
literal|0
condition|)
goto|goto
name|end
goto|;
name|sbuf_off
operator|=
literal|0
expr_stmt|;
name|sbuf_len
operator|=
name|k
expr_stmt|;
name|read_ssl
operator|=
literal|0
expr_stmt|;
name|write_tty
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_WANT_WRITE
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"read W BLOCK\n"
argument_list|)
expr_stmt|;
name|write_ssl
operator|=
literal|1
expr_stmt|;
name|read_tty
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_WANT_READ
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"read R BLOCK\n"
argument_list|)
expr_stmt|;
name|write_tty
operator|=
literal|0
expr_stmt|;
name|read_ssl
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|read_tty
operator|==
literal|0
operator|)
operator|&&
operator|(
name|write_ssl
operator|==
literal|0
operator|)
condition|)
name|write_ssl
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_WANT_X509_LOOKUP
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"read X BLOCK\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_SYSCALL
case|:
name|ret
operator|=
name|get_last_socket_error
argument_list|()
expr_stmt|;
if|if
condition|(
name|c_brief
condition|)
name|BIO_puts
argument_list|(
name|bio_err
argument_list|,
literal|"CONNECTION CLOSED BY SERVER\n"
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"read:errno=%d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
case|case
name|SSL_ERROR_ZERO_RETURN
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"closed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|shut
goto|;
case|case
name|SSL_ERROR_SSL
case|:
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
comment|/* break; */
block|}
block|}
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINCE
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
elseif|else
if|if
condition|(
name|_kbhit
argument_list|()
condition|)
else|#
directive|else
elseif|else
if|if
condition|(
operator|(
name|_kbhit
argument_list|()
operator|)
operator|||
operator|(
name|WAIT_OBJECT_0
operator|==
name|WaitForSingleObject
argument_list|(
name|GetStdHandle
argument_list|(
name|STD_INPUT_HANDLE
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
endif|#
directive|endif
elif|#
directive|elif
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
elseif|else
if|if
condition|(
name|_kbhit
argument_list|()
condition|)
elif|#
directive|elif
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
elseif|else
if|if
condition|(
name|stdin_set
condition|)
else|#
directive|else
elseif|else
if|if
condition|(
name|FD_ISSET
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
name|crlf
condition|)
block|{
name|int
name|j
decl_stmt|,
name|lf_num
decl_stmt|;
name|i
operator|=
name|raw_read_stdin
argument_list|(
name|cbuf
argument_list|,
name|BUFSIZZ
operator|/
literal|2
argument_list|)
expr_stmt|;
name|lf_num
operator|=
literal|0
expr_stmt|;
comment|/* both loops are skipped when i<= 0 */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|cbuf
index|[
name|j
index|]
operator|==
literal|'\n'
condition|)
name|lf_num
operator|++
expr_stmt|;
for|for
control|(
name|j
operator|=
name|i
operator|-
literal|1
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
block|{
name|cbuf
index|[
name|j
operator|+
name|lf_num
index|]
operator|=
name|cbuf
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|cbuf
index|[
name|j
index|]
operator|==
literal|'\n'
condition|)
block|{
name|lf_num
operator|--
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|cbuf
index|[
name|j
operator|+
name|lf_num
index|]
operator|=
literal|'\r'
expr_stmt|;
block|}
block|}
name|assert
argument_list|(
name|lf_num
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|i
operator|=
name|raw_read_stdin
argument_list|(
name|cbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|c_ign_eof
operator|)
operator|&&
operator|(
operator|(
name|i
operator|<=
literal|0
operator|)
operator|||
operator|(
name|cbuf
index|[
literal|0
index|]
operator|==
literal|'Q'
operator|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"DONE\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|shut
goto|;
block|}
if|if
condition|(
operator|(
operator|!
name|c_ign_eof
operator|)
operator|&&
operator|(
name|cbuf
index|[
literal|0
index|]
operator|==
literal|'R'
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"RENEGOTIATING\n"
argument_list|)
expr_stmt|;
name|SSL_renegotiate
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|cbuf_len
operator|=
literal|0
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_HEARTBEATS
elseif|else
if|if
condition|(
operator|(
operator|!
name|c_ign_eof
operator|)
operator|&&
operator|(
name|cbuf
index|[
literal|0
index|]
operator|==
literal|'B'
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"HEARTBEATING\n"
argument_list|)
expr_stmt|;
name|SSL_heartbeat
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|cbuf_len
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
else|else
block|{
name|cbuf_len
operator|=
name|i
expr_stmt|;
name|cbuf_off
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
name|ebcdic2ascii
argument_list|(
name|cbuf
argument_list|,
name|cbuf
argument_list|,
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|write_ssl
operator|=
literal|1
expr_stmt|;
name|read_tty
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|shut
label|:
if|if
condition|(
name|in_init
condition|)
name|print_stuff
argument_list|(
name|bio_c_out
argument_list|,
name|con
argument_list|,
name|full_log
argument_list|)
expr_stmt|;
name|SSL_shutdown
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|SHUTDOWN
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|con
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|prexit
operator|!=
literal|0
condition|)
name|print_stuff
argument_list|(
name|bio_c_out
argument_list|,
name|con
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SSL_free
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_TLSEXT
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_NEXTPROTONEG
argument_list|)
if|if
condition|(
name|next_proto
operator|.
name|data
condition|)
name|OPENSSL_free
argument_list|(
name|next_proto
operator|.
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ctx
operator|!=
name|NULL
condition|)
name|SSL_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
condition|)
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|crls
condition|)
name|sk_X509_CRL_pop_free
argument_list|(
name|crls
argument_list|,
name|X509_CRL_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
name|EVP_PKEY_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
condition|)
name|sk_X509_pop_free
argument_list|(
name|chain
argument_list|,
name|X509_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|pass
condition|)
name|OPENSSL_free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
name|OPENSSL_free
argument_list|(
name|srp_arg
operator|.
name|srppassin
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|vpm
condition|)
name|X509_VERIFY_PARAM_free
argument_list|(
name|vpm
argument_list|)
expr_stmt|;
name|ssl_excert_free
argument_list|(
name|exc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssl_args
condition|)
name|sk_OPENSSL_STRING_free
argument_list|(
name|ssl_args
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
condition|)
name|SSL_CONF_CTX_free
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_JPAKE
if|if
condition|(
name|jpake_secret
operator|&&
name|psk_key
condition|)
name|OPENSSL_free
argument_list|(
name|psk_key
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cbuf
operator|!=
name|NULL
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|cbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|cbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sbuf
operator|!=
name|NULL
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|sbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mbuf
operator|!=
name|NULL
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|mbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bio_c_out
operator|!=
name|NULL
condition|)
block|{
name|BIO_free
argument_list|(
name|bio_c_out
argument_list|)
expr_stmt|;
name|bio_c_out
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|bio_c_msg
operator|!=
name|NULL
condition|)
block|{
name|BIO_free
argument_list|(
name|bio_c_msg
argument_list|)
expr_stmt|;
name|bio_c_msg
operator|=
name|NULL
expr_stmt|;
block|}
name|apps_shutdown
argument_list|()
expr_stmt|;
name|OPENSSL_EXIT
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_stuff
parameter_list|(
name|BIO
modifier|*
name|bio
parameter_list|,
name|SSL
modifier|*
name|s
parameter_list|,
name|int
name|full
parameter_list|)
block|{
name|X509
modifier|*
name|peer
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|space
init|=
literal|"                "
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|sk
expr_stmt|;
name|STACK_OF
argument_list|(
name|X509_NAME
argument_list|)
operator|*
name|sk2
expr_stmt|;
specifier|const
name|SSL_CIPHER
modifier|*
name|c
decl_stmt|;
name|X509_NAME
modifier|*
name|xn
decl_stmt|;
name|int
name|j
decl_stmt|,
name|i
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_COMP
specifier|const
name|COMP_METHOD
modifier|*
name|comp
decl_stmt|,
modifier|*
name|expansion
decl_stmt|;
endif|#
directive|endif
name|unsigned
name|char
modifier|*
name|exportedkeymat
decl_stmt|;
if|if
condition|(
name|full
condition|)
block|{
name|int
name|got_a_chain
init|=
literal|0
decl_stmt|;
name|sk
operator|=
name|SSL_get_peer_cert_chain
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|sk
operator|!=
name|NULL
condition|)
block|{
name|got_a_chain
operator|=
literal|1
expr_stmt|;
comment|/* we don't have it for SSL2 (yet) */
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\nCertificate chain\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_X509_num
argument_list|(
name|sk
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|sk_X509_value
argument_list|(
name|sk
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%2d s:%s\n"
argument_list|,
name|i
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_issuer_name
argument_list|(
name|sk_X509_value
argument_list|(
name|sk
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"   i:%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|c_showcerts
condition|)
name|PEM_write_bio_X509
argument_list|(
name|bio
argument_list|,
name|sk_X509_value
argument_list|(
name|sk
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\n"
argument_list|)
expr_stmt|;
name|peer
operator|=
name|SSL_get_peer_certificate
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Server certificate\n"
argument_list|)
expr_stmt|;
comment|/* Redundant if we showed the whole chain */
if|if
condition|(
operator|!
operator|(
name|c_showcerts
operator|&&
name|got_a_chain
operator|)
condition|)
name|PEM_write_bio_X509
argument_list|(
name|bio
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|peer
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"subject=%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_issuer_name
argument_list|(
name|peer
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"issuer=%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"no peer certificate available\n"
argument_list|)
expr_stmt|;
name|sk2
operator|=
name|SSL_get_client_CA_list
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sk2
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|sk_X509_NAME_num
argument_list|(
name|sk2
argument_list|)
operator|>
literal|0
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\nAcceptable client certificate CA names\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_X509_NAME_num
argument_list|(
name|sk2
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|xn
operator|=
name|sk_X509_NAME_value
argument_list|(
name|sk2
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|xn
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio
argument_list|,
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\nNo client certificate CA names sent\n"
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|SSL_get_shared_ciphers
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
comment|/*              * This works only for SSL 2.  In later protocol versions, the              * client does not know what other ciphers (in addition to the              * one to be used in the current connection) the server supports.              */
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\nCiphers common between both SSL endpoints:\n"
argument_list|)
expr_stmt|;
name|j
operator|=
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|':'
condition|)
block|{
name|BIO_write
argument_list|(
name|bio
argument_list|,
name|space
argument_list|,
literal|15
operator|-
name|j
operator|%
literal|25
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
name|BIO_write
argument_list|(
name|bio
argument_list|,
operator|(
operator|(
name|i
operator|%
literal|3
operator|)
condition|?
literal|" "
else|:
literal|"\n"
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BIO_write
argument_list|(
name|bio
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
name|p
operator|++
expr_stmt|;
block|}
name|BIO_write
argument_list|(
name|bio
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|ssl_print_sigalgs
argument_list|(
name|bio
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|ssl_print_tmp_key
argument_list|(
name|bio
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\nSSL handshake has read %ld bytes and written %ld bytes\n"
argument_list|,
name|BIO_number_read
argument_list|(
name|SSL_get_rbio
argument_list|(
name|s
argument_list|)
argument_list|)
argument_list|,
name|BIO_number_written
argument_list|(
name|SSL_get_wbio
argument_list|(
name|s
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|bio
argument_list|,
operator|(
name|SSL_cache_hit
argument_list|(
name|s
argument_list|)
condition|?
literal|"---\nReused, "
else|:
literal|"---\nNew, "
operator|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|SSL_get_current_cipher
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%s, Cipher is %s\n"
argument_list|,
name|SSL_CIPHER_get_version
argument_list|(
name|c
argument_list|)
argument_list|,
name|SSL_CIPHER_get_name
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|!=
name|NULL
condition|)
block|{
name|EVP_PKEY
modifier|*
name|pktmp
decl_stmt|;
name|pktmp
operator|=
name|X509_get_pubkey
argument_list|(
name|peer
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Server public key is %d bit\n"
argument_list|,
name|EVP_PKEY_bits
argument_list|(
name|pktmp
argument_list|)
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Secure Renegotiation IS%s supported\n"
argument_list|,
name|SSL_get_secure_renegotiation_support
argument_list|(
name|s
argument_list|)
condition|?
literal|""
else|:
literal|" NOT"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_COMP
name|comp
operator|=
name|SSL_get_current_compression
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|expansion
operator|=
name|SSL_get_current_expansion
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Compression: %s\n"
argument_list|,
name|comp
condition|?
name|SSL_COMP_get_name
argument_list|(
name|comp
argument_list|)
else|:
literal|"NONE"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Expansion: %s\n"
argument_list|,
name|expansion
condition|?
name|SSL_COMP_get_name
argument_list|(
name|expansion
argument_list|)
else|:
literal|"NONE"
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SSL_DEBUG
block|{
comment|/* Print out local port of connection: useful for debugging */
name|int
name|sock
decl_stmt|;
name|struct
name|sockaddr_in
name|ladd
decl_stmt|;
name|socklen_t
name|ladd_size
init|=
sizeof|sizeof
argument_list|(
name|ladd
argument_list|)
decl_stmt|;
name|sock
operator|=
name|SSL_get_fd
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|getsockname
argument_list|(
name|sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|ladd
argument_list|,
operator|&
name|ladd_size
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"LOCAL PORT is %u\n"
argument_list|,
name|ntohs
argument_list|(
name|ladd
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_TLSEXT
argument_list|)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_NEXTPROTONEG
argument_list|)
if|if
condition|(
name|next_proto
operator|.
name|status
operator|!=
operator|-
literal|1
condition|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|proto
decl_stmt|;
name|unsigned
name|int
name|proto_len
decl_stmt|;
name|SSL_get0_next_proto_negotiated
argument_list|(
name|s
argument_list|,
operator|&
name|proto
argument_list|,
operator|&
name|proto_len
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Next protocol: (%d) "
argument_list|,
name|next_proto
operator|.
name|status
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio
argument_list|,
name|proto
argument_list|,
name|proto_len
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|proto
decl_stmt|;
name|unsigned
name|int
name|proto_len
decl_stmt|;
name|SSL_get0_alpn_selected
argument_list|(
name|s
argument_list|,
operator|&
name|proto
argument_list|,
operator|&
name|proto_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto_len
operator|>
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"ALPN protocol: "
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio
argument_list|,
name|proto
argument_list|,
name|proto_len
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"No ALPN negotiated\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRTP
block|{
name|SRTP_PROTECTION_PROFILE
modifier|*
name|srtp_profile
init|=
name|SSL_get_selected_srtp_profile
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
name|srtp_profile
condition|)
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"SRTP Extension negotiated, profile=%s\n"
argument_list|,
name|srtp_profile
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|SSL_SESSION_print
argument_list|(
name|bio
argument_list|,
name|SSL_get_session
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|keymatexportlabel
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Keying material exporter:\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"    Label: '%s'\n"
argument_list|,
name|keymatexportlabel
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"    Length: %i bytes\n"
argument_list|,
name|keymatexportlen
argument_list|)
expr_stmt|;
name|exportedkeymat
operator|=
name|OPENSSL_malloc
argument_list|(
name|keymatexportlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|exportedkeymat
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|SSL_export_keying_material
argument_list|(
name|s
argument_list|,
name|exportedkeymat
argument_list|,
name|keymatexportlen
argument_list|,
name|keymatexportlabel
argument_list|,
name|strlen
argument_list|(
name|keymatexportlabel
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"    Error\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"    Keying material: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|keymatexportlen
condition|;
name|i
operator|++
control|)
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%02X"
argument_list|,
name|exportedkeymat
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|OPENSSL_free
argument_list|(
name|exportedkeymat
argument_list|)
expr_stmt|;
block|}
block|}
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|!=
name|NULL
condition|)
name|X509_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
comment|/* flush, or debugging output gets mixed with http response */
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|bio
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_function
specifier|static
name|int
name|ocsp_resp_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|;
name|OCSP_RESPONSE
modifier|*
name|rsp
decl_stmt|;
name|len
operator|=
name|SSL_get_tlsext_status_ocsp_resp
argument_list|(
name|s
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|arg
argument_list|,
literal|"OCSP response: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|BIO_puts
argument_list|(
name|arg
argument_list|,
literal|"no response sent\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|rsp
operator|=
name|d2i_OCSP_RESPONSE
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsp
condition|)
block|{
name|BIO_puts
argument_list|(
name|arg
argument_list|,
literal|"response parse error\n"
argument_list|)
expr_stmt|;
name|BIO_dump_indent
argument_list|(
name|arg
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p
argument_list|,
name|len
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|BIO_puts
argument_list|(
name|arg
argument_list|,
literal|"\n======================================\n"
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_print
argument_list|(
name|arg
argument_list|,
name|rsp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|arg
argument_list|,
literal|"======================================\n"
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 1985, 1986, 1987, 1988 by the Massachusetts Institute  * of Technology.  * For copying and distribution information, please see the file  *<Copyright.MIT>.  *  *	from: create_auth_reply.c,v 4.10 89/01/13 17:47:38 steiner Exp $  *	$Id: create_auth_reply.c,v 1.3 1995/07/18 16:38:06 mark Exp $  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_endif
unit|static char *rcsid = "$Id: create_auth_reply.c,v 1.3 1995/07/18 16:38:06 mark Exp $";
endif|#
directive|endif
end_endif

begin_comment
comment|/* lint */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<krb.h>
end_include

begin_include
include|#
directive|include
file|<prot.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_comment
comment|/*  * This routine is called by the Kerberos authentication server  * to create a reply to an authentication request.  The routine  * takes the user's name, instance, and realm, the client's  * timestamp, the number of tickets, the user's key version  * number and the ciphertext containing the tickets themselves.  * It constructs a packet and returns a pointer to it.  *  * Notes: The packet returned by this routine is static.  Thus, if you  * intend to keep the result beyond the next call to this routine, you  * must copy it elsewhere.  *  * The packet is built in the following format:  *  * 			variable  * type			or constant	   data  * ----			-----------	   ----  *  * unsigned char	KRB_PROT_VERSION   protocol version number  *  * unsigned char	AUTH_MSG_KDC_REPLY protocol message type  *  * [least significant	HOST_BYTE_ORDER	   sender's (server's) byte  *  bit of above field]			   order  *  * string		pname		   principal's name  *  * string		pinst		   principal's instance  *  * string		prealm		   principal's realm  *  * unsigned long	time_ws		   client's timestamp  *  * unsigned char	n		   number of tickets  *  * unsigned long	x_date		   expiration date  *  * unsigned char	kvno		   master key version  *  * short		w_1		   cipher length  *  * ---			cipher->dat	   cipher data  */
end_comment

begin_function
name|KTEXT
name|create_auth_reply
parameter_list|(
name|pname
parameter_list|,
name|pinst
parameter_list|,
name|prealm
parameter_list|,
name|time_ws
parameter_list|,
name|n
parameter_list|,
name|x_date
parameter_list|,
name|kvno
parameter_list|,
name|cipher
parameter_list|)
name|char
modifier|*
name|pname
decl_stmt|;
comment|/* Principal's name */
name|char
modifier|*
name|pinst
decl_stmt|;
comment|/* Principal's instance */
name|char
modifier|*
name|prealm
decl_stmt|;
comment|/* Principal's authentication domain */
name|long
name|time_ws
decl_stmt|;
comment|/* Workstation time */
name|int
name|n
decl_stmt|;
comment|/* Number of tickets */
name|unsigned
name|long
name|x_date
decl_stmt|;
comment|/* Principal's expiration date */
name|int
name|kvno
decl_stmt|;
comment|/* Principal's key version number */
name|KTEXT
name|cipher
decl_stmt|;
comment|/* Cipher text with tickets and 				 * session keys */
block|{
specifier|static
name|KTEXT_ST
name|pkt_st
decl_stmt|;
name|KTEXT
name|pkt
init|=
operator|&
name|pkt_st
decl_stmt|;
name|unsigned
name|char
modifier|*
name|v
init|=
name|pkt
operator|->
name|dat
decl_stmt|;
comment|/* Prot vers number */
name|unsigned
name|char
modifier|*
name|t
init|=
operator|(
name|pkt
operator|->
name|dat
operator|+
literal|1
operator|)
decl_stmt|;
comment|/* Prot message type */
name|short
name|w_l
decl_stmt|;
comment|/* Cipher length */
comment|/* Create fixed part of packet */
operator|*
name|v
operator|=
operator|(
name|unsigned
name|char
operator|)
name|KRB_PROT_VERSION
expr_stmt|;
operator|*
name|t
operator|=
operator|(
name|unsigned
name|char
operator|)
name|AUTH_MSG_KDC_REPLY
expr_stmt|;
operator|*
name|t
operator||=
name|HOST_BYTE_ORDER
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|0
condition|)
operator|*
name|v
operator|=
literal|3
expr_stmt|;
comment|/* Add the basic info */
operator|(
name|void
operator|)
name|strcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|pkt
operator|->
name|dat
operator|+
literal|2
operator|)
argument_list|,
name|pname
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|length
operator|=
literal|3
operator|+
name|strlen
argument_list|(
name|pname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|pkt
operator|->
name|dat
operator|+
name|pkt
operator|->
name|length
operator|)
argument_list|,
name|pinst
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|length
operator|+=
literal|1
operator|+
name|strlen
argument_list|(
name|pinst
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|pkt
operator|->
name|dat
operator|+
name|pkt
operator|->
name|length
operator|)
argument_list|,
name|prealm
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|length
operator|+=
literal|1
operator|+
name|strlen
argument_list|(
name|prealm
argument_list|)
expr_stmt|;
comment|/* Workstation timestamp */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|time_ws
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|pkt
operator|->
name|dat
operator|+
name|pkt
operator|->
name|length
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|length
operator|+=
literal|4
expr_stmt|;
operator|*
operator|(
name|pkt
operator|->
name|dat
operator|+
operator|(
name|pkt
operator|->
name|length
operator|)
operator|++
operator|)
operator|=
operator|(
name|unsigned
name|char
operator|)
name|n
expr_stmt|;
comment|/* Expiration date */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|x_date
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|pkt
operator|->
name|dat
operator|+
name|pkt
operator|->
name|length
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|length
operator|+=
literal|4
expr_stmt|;
comment|/* Now send the ciphertext and info to help decode it */
operator|*
operator|(
name|pkt
operator|->
name|dat
operator|+
operator|(
name|pkt
operator|->
name|length
operator|)
operator|++
operator|)
operator|=
operator|(
name|unsigned
name|char
operator|)
name|kvno
expr_stmt|;
name|w_l
operator|=
operator|(
name|short
operator|)
name|cipher
operator|->
name|length
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|w_l
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|pkt
operator|->
name|dat
operator|+
name|pkt
operator|->
name|length
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|length
operator|+=
literal|2
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|cipher
operator|->
name|dat
operator|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|pkt
operator|->
name|dat
operator|+
name|pkt
operator|->
name|length
operator|)
argument_list|,
name|cipher
operator|->
name|length
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|length
operator|+=
name|cipher
operator|->
name|length
expr_stmt|;
comment|/* And return the packet */
return|return
name|pkt
return|;
block|}
end_function

end_unit


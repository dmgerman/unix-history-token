begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 1986, 1987, 1988 by the Massachusetts Institute  * of Technology.  * For copying and distribution information, please see the file  *<Copyright.MIT>.  *  *	from: get_pw_tkt.c,v 4.6 89/01/13 18:19:11 steiner Exp $  * $FreeBSD$  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_endif
unit|static char *rcsid = "$FreeBSD$";
endif|#
directive|endif
end_endif

begin_comment
comment|/* lint */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<krb.h>
end_include

begin_comment
comment|/*  * Get a ticket for the password-changing server ("changepw.KRB_MASTER").  *  * Given the name, instance, realm, and current password of the  * principal for which the user wants a password-changing-ticket,  * return either:  *  *	GT_PW_BADPW if current password was wrong,  *	GT_PW_NULL  if principal had a NULL password,  *	or the result of the krb_get_pw_in_tkt() call.  *  * First, try to get a ticket for "user.instance@realm" to use the  * "changepw.KRB_MASTER" server (KRB_MASTER is defined in "krb.h").  * The requested lifetime for the ticket is "1", and the current  * password is the "cpw" argument given.  *  * If the password was bad, give up.  *  * If the principal had a NULL password in the Kerberos database  * (indicating that the principal is known to Kerberos, but hasn't  * got a password yet), try instead to get a ticket for the principal  * "default.changepw@realm" to use the "changepw.KRB_MASTER" server.  * Use the password "changepwkrb" instead of "cpw".  Return GT_PW_NULL  * if all goes well, otherwise the error.  *  * If this routine succeeds, a ticket and session key for either the  * principal "user.instance@realm" or "default.changepw@realm" to use  * the password-changing server will be in the user's ticket file.  */
end_comment

begin_function
name|int
name|get_pw_tkt
parameter_list|(
name|user
parameter_list|,
name|instance
parameter_list|,
name|realm
parameter_list|,
name|cpw
parameter_list|)
name|char
modifier|*
name|user
decl_stmt|;
name|char
modifier|*
name|instance
decl_stmt|;
name|char
modifier|*
name|realm
decl_stmt|;
name|char
modifier|*
name|cpw
decl_stmt|;
block|{
name|int
name|kerror
decl_stmt|;
name|kerror
operator|=
name|krb_get_pw_in_tkt
argument_list|(
name|user
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|,
literal|"changepw"
argument_list|,
name|KRB_MASTER
argument_list|,
literal|1
argument_list|,
name|cpw
argument_list|)
expr_stmt|;
if|if
condition|(
name|kerror
operator|==
name|INTK_BADPW
condition|)
return|return
operator|(
name|GT_PW_BADPW
operator|)
return|;
if|if
condition|(
name|kerror
operator|==
name|KDC_NULL_KEY
condition|)
block|{
name|kerror
operator|=
name|krb_get_pw_in_tkt
argument_list|(
literal|"default"
argument_list|,
literal|"changepw"
argument_list|,
name|realm
argument_list|,
literal|"changepw"
argument_list|,
name|KRB_MASTER
argument_list|,
literal|1
argument_list|,
literal|"changepwkrb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|kerror
condition|)
return|return
operator|(
name|kerror
operator|)
return|;
return|return
operator|(
name|GT_PW_NULL
operator|)
return|;
block|}
return|return
operator|(
name|kerror
operator|)
return|;
block|}
end_function

end_unit


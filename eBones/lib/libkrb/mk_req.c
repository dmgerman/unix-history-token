begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 1985, 1986, 1987, 1988 by the Massachusetts Institute  * of Technology.  * For copying and distribution information, please see the file  *<Copyright.MIT>.  *  *	from: der: mk_req.c,v 4.17 89/07/07 15:20:35 jtkohl Exp $  *	$Id: mk_req.c,v 1.3 1995/07/18 16:39:15 mark Exp $  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_endif
unit|static char *rcsid = "$Id: mk_req.c,v 1.3 1995/07/18 16:39:15 mark Exp $";
endif|#
directive|endif
end_endif

begin_comment
comment|/* lint */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<krb.h>
end_include

begin_include
include|#
directive|include
file|<prot.h>
end_include

begin_include
include|#
directive|include
file|<des.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_decl_stmt
specifier|extern
name|int
name|krb_ap_req_debug
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|timeval
name|tv_local
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|lifetime
init|=
name|DEFAULT_TKT_LIFE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * krb_mk_req takes a text structure in which an authenticator is to  * be built, the name of a service, an instance, a realm,  * and a checksum.  It then retrieves a ticket for  * the desired service and creates an authenticator in the text  * structure passed as the first argument.  krb_mk_req returns  * KSUCCESS on success and a Kerberos error code on failure.  *  * The peer procedure on the other end is krb_rd_req.  When making  * any changes to this routine it is important to make corresponding  * changes to krb_rd_req.  *  * The authenticator consists of the following:  *  * authent->dat  *  * unsigned char	KRB_PROT_VERSION	protocol version no.  * unsigned char	AUTH_MSG_APPL_REQUEST	message type  * (least significant  * bit of above)	HOST_BYTE_ORDER		local byte ordering  * unsigned char	kvno from ticket	server's key version  * string		realm			server's realm  * unsigned char	tl			ticket length  * unsigned char	idl			request id length  * text			ticket->dat		ticket for server  * text			req_id->dat		request id  *  * The ticket information is retrieved from the ticket cache or  * fetched from Kerberos.  The request id (called the "authenticator"  * in the papers on Kerberos) contains the following:  *  * req_id->dat  *  * string		cr.pname		{name, instance, and  * string		cr.pinst		realm of principal  * string		myrealm			making this request}  * 4 bytes		checksum		checksum argument given  * unsigned char	tv_local.tf_usec	time (milliseconds)  * 4 bytes		tv_local.tv_sec		time (seconds)  *  * req_id->length = 3 strings + 3 terminating nulls + 5 bytes for time,  *                  all rounded up to multiple of 8.  */
end_comment

begin_function
name|int
name|krb_mk_req
parameter_list|(
name|authent
parameter_list|,
name|service
parameter_list|,
name|instance
parameter_list|,
name|realm
parameter_list|,
name|checksum
parameter_list|)
specifier|register
name|KTEXT
name|authent
decl_stmt|;
comment|/* Place to build the authenticator */
name|char
modifier|*
name|service
decl_stmt|;
comment|/* Name of the service */
name|char
modifier|*
name|instance
decl_stmt|;
comment|/* Service instance */
name|char
modifier|*
name|realm
decl_stmt|;
comment|/* Authentication domain of service */
name|long
name|checksum
decl_stmt|;
comment|/* Checksum of data (optional) */
block|{
specifier|static
name|KTEXT_ST
name|req_st
decl_stmt|;
comment|/* Temp storage for req id */
specifier|register
name|KTEXT
name|req_id
init|=
operator|&
name|req_st
decl_stmt|;
name|unsigned
name|char
modifier|*
name|v
init|=
name|authent
operator|->
name|dat
decl_stmt|;
comment|/* Prot version number */
name|unsigned
name|char
modifier|*
name|t
init|=
operator|(
name|authent
operator|->
name|dat
operator|+
literal|1
operator|)
decl_stmt|;
comment|/* Message type */
name|unsigned
name|char
modifier|*
name|kv
init|=
operator|(
name|authent
operator|->
name|dat
operator|+
literal|2
operator|)
decl_stmt|;
comment|/* Key version no */
name|unsigned
name|char
modifier|*
name|tl
init|=
operator|(
name|authent
operator|->
name|dat
operator|+
literal|4
operator|+
name|strlen
argument_list|(
name|realm
argument_list|)
operator|)
decl_stmt|;
comment|/* Tkt len */
name|unsigned
name|char
modifier|*
name|idl
init|=
operator|(
name|authent
operator|->
name|dat
operator|+
literal|5
operator|+
name|strlen
argument_list|(
name|realm
argument_list|)
operator|)
decl_stmt|;
comment|/* Reqid len */
name|CREDENTIALS
name|cr
decl_stmt|;
comment|/* Credentials used by retr */
specifier|register
name|KTEXT
name|ticket
init|=
operator|&
operator|(
name|cr
operator|.
name|ticket_st
operator|)
decl_stmt|;
comment|/* Pointer to tkt_st */
name|int
name|retval
decl_stmt|;
comment|/* Returned by krb_get_cred */
specifier|static
name|Key_schedule
name|key_s
decl_stmt|;
name|char
name|myrealm
index|[
name|REALM_SZ
index|]
decl_stmt|;
comment|/* The fixed parts of the authenticator */
operator|*
name|v
operator|=
operator|(
name|unsigned
name|char
operator|)
name|KRB_PROT_VERSION
expr_stmt|;
operator|*
name|t
operator|=
operator|(
name|unsigned
name|char
operator|)
name|AUTH_MSG_APPL_REQUEST
expr_stmt|;
operator|*
name|t
operator||=
name|HOST_BYTE_ORDER
expr_stmt|;
comment|/* Get the ticket and move it into the authenticator */
if|if
condition|(
name|krb_ap_req_debug
condition|)
name|printf
argument_list|(
literal|"Realm: %s\n"
argument_list|,
name|realm
argument_list|)
expr_stmt|;
comment|/*      * Determine realm of these tickets.  We will send this to the      * KDC from which we are requesting tickets so it knows what to      * with our session key.      */
if|if
condition|(
operator|(
name|retval
operator|=
name|krb_get_tf_realm
argument_list|(
name|TKT_FILE
argument_list|,
name|myrealm
argument_list|)
operator|)
operator|!=
name|KSUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
name|retval
operator|=
name|krb_get_cred
argument_list|(
name|service
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|,
operator|&
name|cr
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|==
name|RET_NOTKT
condition|)
block|{
if|if
condition|(
operator|(
name|retval
operator|=
name|get_ad_tkt
argument_list|(
name|service
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|,
name|lifetime
argument_list|)
operator|)
condition|)
return|return
operator|(
name|retval
operator|)
return|;
if|if
condition|(
operator|(
name|retval
operator|=
name|krb_get_cred
argument_list|(
name|service
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|,
operator|&
name|cr
argument_list|)
operator|)
condition|)
return|return
operator|(
name|retval
operator|)
return|;
block|}
if|if
condition|(
name|retval
operator|!=
name|KSUCCESS
condition|)
return|return
operator|(
name|retval
operator|)
return|;
if|if
condition|(
name|krb_ap_req_debug
condition|)
name|printf
argument_list|(
literal|"%s %s %s %s %s\n"
argument_list|,
name|service
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|,
name|cr
operator|.
name|pname
argument_list|,
name|cr
operator|.
name|pinst
argument_list|)
expr_stmt|;
operator|*
name|kv
operator|=
operator|(
name|unsigned
name|char
operator|)
name|cr
operator|.
name|kvno
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|authent
operator|->
name|dat
operator|+
literal|3
operator|)
argument_list|,
name|realm
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|=
operator|(
name|unsigned
name|char
operator|)
name|ticket
operator|->
name|length
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ticket
operator|->
name|dat
operator|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|authent
operator|->
name|dat
operator|+
literal|6
operator|+
name|strlen
argument_list|(
name|realm
argument_list|)
operator|)
argument_list|,
name|ticket
operator|->
name|length
argument_list|)
expr_stmt|;
name|authent
operator|->
name|length
operator|=
literal|6
operator|+
name|strlen
argument_list|(
name|realm
argument_list|)
operator|+
name|ticket
operator|->
name|length
expr_stmt|;
if|if
condition|(
name|krb_ap_req_debug
condition|)
name|printf
argument_list|(
literal|"Ticket->length = %d\n"
argument_list|,
name|ticket
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb_ap_req_debug
condition|)
name|printf
argument_list|(
literal|"Issue date: %ld\n"
argument_list|,
name|cr
operator|.
name|issue_date
argument_list|)
expr_stmt|;
comment|/* Build request id */
operator|(
name|void
operator|)
name|strcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|req_id
operator|->
name|dat
operator|)
argument_list|,
name|cr
operator|.
name|pname
argument_list|)
expr_stmt|;
comment|/* Auth name */
name|req_id
operator|->
name|length
operator|=
name|strlen
argument_list|(
name|cr
operator|.
name|pname
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* Principal's instance */
operator|(
name|void
operator|)
name|strcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|req_id
operator|->
name|dat
operator|+
name|req_id
operator|->
name|length
operator|)
argument_list|,
name|cr
operator|.
name|pinst
argument_list|)
expr_stmt|;
name|req_id
operator|->
name|length
operator|+=
name|strlen
argument_list|(
name|cr
operator|.
name|pinst
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* Authentication domain */
operator|(
name|void
operator|)
name|strcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|req_id
operator|->
name|dat
operator|+
name|req_id
operator|->
name|length
operator|)
argument_list|,
name|myrealm
argument_list|)
expr_stmt|;
name|req_id
operator|->
name|length
operator|+=
name|strlen
argument_list|(
name|myrealm
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* Checksum */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|checksum
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|req_id
operator|->
name|dat
operator|+
name|req_id
operator|->
name|length
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|req_id
operator|->
name|length
operator|+=
literal|4
expr_stmt|;
comment|/* Fill in the times on the request id */
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|tv_local
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
operator|*
operator|(
name|req_id
operator|->
name|dat
operator|+
operator|(
name|req_id
operator|->
name|length
operator|)
operator|++
operator|)
operator|=
operator|(
name|unsigned
name|char
operator|)
name|tv_local
operator|.
name|tv_usec
expr_stmt|;
comment|/* Time (coarse) */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|tv_local
operator|.
name|tv_sec
operator|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|req_id
operator|->
name|dat
operator|+
name|req_id
operator|->
name|length
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|req_id
operator|->
name|length
operator|+=
literal|4
expr_stmt|;
comment|/* Fill to a multiple of 8 bytes for DES */
name|req_id
operator|->
name|length
operator|=
operator|(
operator|(
name|req_id
operator|->
name|length
operator|+
literal|7
operator|)
operator|/
literal|8
operator|)
operator|*
literal|8
expr_stmt|;
ifndef|#
directive|ifndef
name|NOENCRYPTION
name|key_sched
argument_list|(
operator|(
name|C_Block
operator|*
operator|)
name|cr
operator|.
name|session
argument_list|,
name|key_s
argument_list|)
expr_stmt|;
name|pcbc_encrypt
argument_list|(
operator|(
name|C_Block
operator|*
operator|)
name|req_id
operator|->
name|dat
argument_list|,
operator|(
name|C_Block
operator|*
operator|)
name|req_id
operator|->
name|dat
argument_list|,
operator|(
name|long
operator|)
name|req_id
operator|->
name|length
argument_list|,
name|key_s
argument_list|,
operator|(
name|C_Block
operator|*
operator|)
name|cr
operator|.
name|session
argument_list|,
name|ENCRYPT
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|key_s
argument_list|,
sizeof|sizeof
argument_list|(
name|key_s
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NOENCRYPTION */
comment|/* Copy it into the authenticator */
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|req_id
operator|->
name|dat
operator|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|authent
operator|->
name|dat
operator|+
name|authent
operator|->
name|length
operator|)
argument_list|,
name|req_id
operator|->
name|length
argument_list|)
expr_stmt|;
name|authent
operator|->
name|length
operator|+=
name|req_id
operator|->
name|length
expr_stmt|;
comment|/* And set the id length */
operator|*
name|idl
operator|=
operator|(
name|unsigned
name|char
operator|)
name|req_id
operator|->
name|length
expr_stmt|;
comment|/* clean up */
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|req_id
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req_id
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb_ap_req_debug
condition|)
name|printf
argument_list|(
literal|"Authent->length = %d\n"
argument_list|,
name|authent
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb_ap_req_debug
condition|)
name|printf
argument_list|(
literal|"idl = %d, tl = %d\n"
argument_list|,
operator|(
name|int
operator|)
operator|*
name|idl
argument_list|,
operator|(
name|int
operator|)
operator|*
name|tl
argument_list|)
expr_stmt|;
return|return
operator|(
name|KSUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * krb_set_lifetime sets the default lifetime for additional tickets  * obtained via krb_mk_req().  *  * It returns the previous value of the default lifetime.  */
end_comment

begin_function
name|int
name|krb_set_lifetime
parameter_list|(
name|newval
parameter_list|)
name|int
name|newval
decl_stmt|;
block|{
name|int
name|olife
init|=
name|lifetime
decl_stmt|;
name|lifetime
operator|=
name|newval
expr_stmt|;
return|return
operator|(
name|olife
operator|)
return|;
block|}
end_function

end_unit


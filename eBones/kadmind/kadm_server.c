begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 1988 by the Massachusetts Institute of Technology.  *  * For copying and distribution information, please see the file  * Copyright.MIT.  *  * Kerberos administration server-side subroutines  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|rcsid_kadm_server_c
index|[]
init|=
literal|"Header: /afs/athena.mit.edu/astaff/project/kerberos/src/kadmin/RCS/kadm_server.c,v 4.2 89/09/26 09:30:23 jtkohl Exp "
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|<kadm.h>
end_include

begin_include
include|#
directive|include
file|<kadm_err.h>
end_include

begin_comment
comment|/* kadm_ser_cpw - the server side of the change_password routine   recieves    : KTEXT, {key}   returns     : CKSUM, RETCODE   acl         : caller can change only own password  Replaces the password (i.e. des key) of the caller with that specified in key. Returns no actual data from the master server, since this is called by a user */
end_comment

begin_macro
name|kadm_ser_cpw
argument_list|(
argument|dat
argument_list|,
argument|len
argument_list|,
argument|ad
argument_list|,
argument|datout
argument_list|,
argument|outlen
argument_list|)
end_macro

begin_decl_stmt
name|u_char
modifier|*
name|dat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AUTH_DAT
modifier|*
name|ad
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
modifier|*
modifier|*
name|datout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|outlen
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|long
name|keylow
decl_stmt|,
name|keyhigh
decl_stmt|;
name|des_cblock
name|newkey
decl_stmt|;
name|int
name|stvlen
decl_stmt|;
comment|/* take key off the stream, and change the database */
if|if
condition|(
operator|(
name|stvlen
operator|=
name|stv_long
argument_list|(
name|dat
argument_list|,
operator|&
name|keyhigh
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|KADM_LENGTH_ERROR
operator|)
return|;
if|if
condition|(
name|stv_long
argument_list|(
name|dat
argument_list|,
operator|&
name|keylow
argument_list|,
name|stvlen
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|KADM_LENGTH_ERROR
operator|)
return|;
name|keylow
operator|=
name|ntohl
argument_list|(
name|keylow
argument_list|)
expr_stmt|;
name|keyhigh
operator|=
name|ntohl
argument_list|(
name|keyhigh
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|keyhigh
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
operator|(
operator|(
name|long
operator|*
operator|)
name|newkey
operator|)
operator|+
literal|1
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|keylow
argument_list|,
operator|(
name|char
operator|*
operator|)
name|newkey
argument_list|,
literal|4
argument_list|)
expr_stmt|;
operator|*
name|datout
operator|=
literal|0
expr_stmt|;
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|kadm_change
argument_list|(
name|ad
operator|->
name|pname
argument_list|,
name|ad
operator|->
name|pinst
argument_list|,
name|ad
operator|->
name|prealm
argument_list|,
name|newkey
argument_list|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/* kadm_ser_add - the server side of the add_entry routine   recieves    : KTEXT, {values}   returns     : CKSUM, RETCODE, {values}   acl         : su, sms (as alloc)  Adds and entry containing values to the database returns the values of the entry, so if you leave certain fields blank you will    be able to determine the default values they are set to */
end_comment

begin_macro
name|kadm_ser_add
argument_list|(
argument|dat
argument_list|,
argument|len
argument_list|,
argument|ad
argument_list|,
argument|datout
argument_list|,
argument|outlen
argument_list|)
end_macro

begin_decl_stmt
name|u_char
modifier|*
name|dat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AUTH_DAT
modifier|*
name|ad
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
modifier|*
modifier|*
name|datout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|outlen
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Kadm_vals
name|values
decl_stmt|,
name|retvals
decl_stmt|;
name|int
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|stream_to_vals
argument_list|(
name|dat
argument_list|,
operator|&
name|values
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|KADM_LENGTH_ERROR
operator|)
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_add_entry
argument_list|(
name|ad
operator|->
name|pname
argument_list|,
name|ad
operator|->
name|pinst
argument_list|,
name|ad
operator|->
name|prealm
argument_list|,
operator|&
name|values
argument_list|,
operator|&
name|retvals
argument_list|)
operator|)
operator|==
name|KADM_DATA
condition|)
block|{
operator|*
name|outlen
operator|=
name|vals_to_stream
argument_list|(
operator|&
name|retvals
argument_list|,
name|datout
argument_list|)
expr_stmt|;
return|return
name|KADM_SUCCESS
return|;
block|}
else|else
block|{
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
end_block

begin_comment
comment|/* kadm_ser_mod - the server side of the mod_entry routine   recieves    : KTEXT, {values, values}   returns     : CKSUM, RETCODE, {values}   acl         : su, sms (as register or dealloc)  Modifies all entries corresponding to the first values so they match the    second values. returns the values for the changed entries */
end_comment

begin_macro
name|kadm_ser_mod
argument_list|(
argument|dat
argument_list|,
argument|len
argument_list|,
argument|ad
argument_list|,
argument|datout
argument_list|,
argument|outlen
argument_list|)
end_macro

begin_decl_stmt
name|u_char
modifier|*
name|dat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AUTH_DAT
modifier|*
name|ad
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
modifier|*
modifier|*
name|datout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|outlen
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Kadm_vals
name|vals1
decl_stmt|,
name|vals2
decl_stmt|,
name|retvals
decl_stmt|;
name|int
name|wh
decl_stmt|;
name|int
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|wh
operator|=
name|stream_to_vals
argument_list|(
name|dat
argument_list|,
operator|&
name|vals1
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|stream_to_vals
argument_list|(
name|dat
operator|+
name|wh
argument_list|,
operator|&
name|vals2
argument_list|,
name|len
operator|-
name|wh
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_mod_entry
argument_list|(
name|ad
operator|->
name|pname
argument_list|,
name|ad
operator|->
name|pinst
argument_list|,
name|ad
operator|->
name|prealm
argument_list|,
operator|&
name|vals1
argument_list|,
operator|&
name|vals2
argument_list|,
operator|&
name|retvals
argument_list|)
operator|)
operator|==
name|KADM_DATA
condition|)
block|{
operator|*
name|outlen
operator|=
name|vals_to_stream
argument_list|(
operator|&
name|retvals
argument_list|,
name|datout
argument_list|)
expr_stmt|;
return|return
name|KADM_SUCCESS
return|;
block|}
else|else
block|{
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
end_block

begin_comment
comment|/* kadm_ser_get   recieves   : KTEXT, {values, flags}   returns    : CKSUM, RETCODE, {count, values, values, values}   acl        : su  gets the fields requested by flags from all entries matching values returns this data for each matching recipient, after a count of how many such   matches there were */
end_comment

begin_macro
name|kadm_ser_get
argument_list|(
argument|dat
argument_list|,
argument|len
argument_list|,
argument|ad
argument_list|,
argument|datout
argument_list|,
argument|outlen
argument_list|)
end_macro

begin_decl_stmt
name|u_char
modifier|*
name|dat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AUTH_DAT
modifier|*
name|ad
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
modifier|*
modifier|*
name|datout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|outlen
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Kadm_vals
name|values
decl_stmt|,
name|retvals
decl_stmt|;
name|u_char
name|fl
index|[
name|FLDSZ
index|]
decl_stmt|;
name|int
name|loop
decl_stmt|,
name|wh
decl_stmt|;
name|int
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|wh
operator|=
name|stream_to_vals
argument_list|(
name|dat
argument_list|,
operator|&
name|values
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
if|if
condition|(
name|wh
operator|+
name|FLDSZ
operator|>
name|len
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
for|for
control|(
name|loop
operator|=
name|FLDSZ
operator|-
literal|1
init|;
name|loop
operator|>=
literal|0
condition|;
name|loop
operator|--
control|)
name|fl
index|[
name|loop
index|]
operator|=
name|dat
index|[
name|wh
operator|++
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_get_entry
argument_list|(
name|ad
operator|->
name|pname
argument_list|,
name|ad
operator|->
name|pinst
argument_list|,
name|ad
operator|->
name|prealm
argument_list|,
operator|&
name|values
argument_list|,
name|fl
argument_list|,
operator|&
name|retvals
argument_list|)
operator|)
operator|==
name|KADM_DATA
condition|)
block|{
operator|*
name|outlen
operator|=
name|vals_to_stream
argument_list|(
operator|&
name|retvals
argument_list|,
name|datout
argument_list|)
expr_stmt|;
return|return
name|KADM_SUCCESS
return|;
block|}
else|else
block|{
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
end_block

end_unit


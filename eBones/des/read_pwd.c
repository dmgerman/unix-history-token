begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* read_pwd.c */
end_comment

begin_comment
comment|/* Copyright (C) 1993 Eric Young - see README for more details */
end_comment

begin_comment
comment|/* 06-Apr-92 Luke Brennan    Support for VMS */
end_comment

begin_comment
comment|/*-  *	$Id: read_pwd.c,v 1.1.1.1 1994/09/30 14:49:51 csgr Exp $  */
end_comment

begin_include
include|#
directive|include
file|"des_locl.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|BSD
end_ifdef

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_function_decl
specifier|extern
name|char
modifier|*
name|getpass
parameter_list|(
specifier|const
name|char
modifier|*
name|prompt
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|VMS
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|MSDOS
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|_IRIX
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|CRAY
end_ifdef

begin_include
include|#
directive|include
file|<termio.h>
end_include

begin_define
define|#
directive|define
name|sgttyb
value|termio
end_define

begin_define
define|#
directive|define
name|sg_flags
value|c_lflag
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !CRAY */
end_comment

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* _IRIX */
end_comment

begin_struct
struct|struct
name|sgttyb
block|{
name|char
name|sg_ispeed
decl_stmt|;
comment|/* input speed */
name|char
name|sg_ospeed
decl_stmt|;
comment|/* output speed */
name|char
name|sg_erase
decl_stmt|;
comment|/* erase character */
name|char
name|sg_kill
decl_stmt|;
comment|/* kill character */
name|short
name|sg_flags
decl_stmt|;
comment|/* mode flags */
block|}
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* MSDOS */
end_comment

begin_define
define|#
directive|define
name|fgets
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
value|noecho_fgets(a,b,c)
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|NSIG
end_ifndef

begin_define
define|#
directive|define
name|NSIG
value|32
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* VMS */
end_comment

begin_include
include|#
directive|include
file|<ssdef.h>
end_include

begin_include
include|#
directive|include
file|<iodef.h>
end_include

begin_include
include|#
directive|include
file|<ttdef.h>
end_include

begin_include
include|#
directive|include
file|<descrip.h>
end_include

begin_struct
struct|struct
name|IOSB
block|{
name|short
name|iosb$w_value
decl_stmt|;
name|short
name|iosb$w_count
decl_stmt|;
name|long
name|iosb$l_info
decl_stmt|;
block|}
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|read_till_nl
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|read_pw
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|recsig
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pushsig
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|popsig
parameter_list|()
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|MSDOS
end_ifdef

begin_function_decl
specifier|static
name|int
name|noecho_fgets
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
function_decl|(
modifier|*
name|savsig
index|[
name|NSIG
index|]
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|jmp_buf
name|save
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|des_read_password
parameter_list|(
name|key
parameter_list|,
name|prompt
parameter_list|,
name|verify
parameter_list|)
name|des_cblock
modifier|*
name|key
decl_stmt|;
name|char
modifier|*
name|prompt
decl_stmt|;
name|int
name|verify
decl_stmt|;
block|{
name|int
name|ok
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|buff
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|ok
operator|=
name|read_pw
argument_list|(
name|buf
argument_list|,
name|buff
argument_list|,
name|BUFSIZ
argument_list|,
name|prompt
argument_list|,
name|verify
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|des_string_to_key
argument_list|(
name|buf
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|buf
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|buff
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_function

begin_function
name|int
name|des_read_2passwords
parameter_list|(
name|key1
parameter_list|,
name|key2
parameter_list|,
name|prompt
parameter_list|,
name|verify
parameter_list|)
name|des_cblock
modifier|*
name|key1
decl_stmt|;
name|des_cblock
modifier|*
name|key2
decl_stmt|;
name|char
modifier|*
name|prompt
decl_stmt|;
name|int
name|verify
decl_stmt|;
block|{
name|int
name|ok
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|buff
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|ok
operator|=
name|read_pw
argument_list|(
name|buf
argument_list|,
name|buff
argument_list|,
name|BUFSIZ
argument_list|,
name|prompt
argument_list|,
name|verify
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|des_string_to_2keys
argument_list|(
name|buf
argument_list|,
name|key1
argument_list|,
name|key2
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|buf
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|buff
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|BSD
argument_list|)
end_if

begin_function
name|int
name|des_read_pw_string
parameter_list|(
name|buf
parameter_list|,
name|length
parameter_list|,
name|prompt
parameter_list|,
name|verify
parameter_list|)
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|length
decl_stmt|;
name|char
modifier|*
name|prompt
decl_stmt|;
name|int
name|verify
decl_stmt|;
block|{
name|int
name|len
init|=
name|MIN
argument_list|(
name|_PASSWORD_LEN
argument_list|,
name|length
argument_list|)
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|ok
init|=
literal|0
decl_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|ok
condition|)
block|{
name|s
operator|=
name|getpass
argument_list|(
name|prompt
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|buf
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|verify
condition|)
block|{
name|printf
argument_list|(
literal|"Verifying password\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|getpass
argument_list|(
name|prompt
argument_list|)
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\nVerify failure - try again\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|ok
operator|=
literal|1
expr_stmt|;
name|buf
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
return|return
operator|(
operator|!
name|ok
operator|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* BSD */
end_comment

begin_function
name|int
name|des_read_pw_string
parameter_list|(
name|buf
parameter_list|,
name|length
parameter_list|,
name|prompt
parameter_list|,
name|verify
parameter_list|)
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|length
decl_stmt|;
name|char
modifier|*
name|prompt
decl_stmt|;
name|int
name|verify
decl_stmt|;
block|{
name|char
name|buff
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|read_pw
argument_list|(
name|buf
argument_list|,
name|buff
argument_list|,
operator|(
name|length
operator|>
name|BUFSIZ
operator|)
condition|?
name|BUFSIZ
else|:
name|length
argument_list|,
name|prompt
argument_list|,
name|verify
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|buff
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|read_till_nl
parameter_list|(
name|in
parameter_list|)
name|FILE
modifier|*
name|in
decl_stmt|;
block|{
define|#
directive|define
name|SIZE
value|4
name|char
name|buf
index|[
name|SIZE
operator|+
literal|1
index|]
decl_stmt|;
do|do
block|{
name|fgets
argument_list|(
name|buf
argument_list|,
name|SIZE
argument_list|,
name|in
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|index
argument_list|(
name|buf
argument_list|,
literal|'\n'
argument_list|)
operator|==
name|NULL
condition|)
do|;
block|}
end_function

begin_comment
comment|/* return 0 if ok, 1 (or -1) otherwise */
end_comment

begin_function
specifier|static
name|int
name|read_pw
parameter_list|(
name|buf
parameter_list|,
name|buff
parameter_list|,
name|size
parameter_list|,
name|prompt
parameter_list|,
name|verify
parameter_list|)
name|char
modifier|*
name|buf
decl_stmt|,
decl|*
name|buff
decl_stmt|;
end_function

begin_decl_stmt
name|int
name|size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|prompt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|verify
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifndef|#
directive|ifndef
name|VMS
ifndef|#
directive|ifndef
name|MSDOS
name|struct
name|sgttyb
name|tty_orig
decl_stmt|,
name|tty_new
decl_stmt|;
endif|#
directive|endif
comment|/* !MSDOS */
else|#
directive|else
name|struct
name|IOSB
name|iosb
decl_stmt|;
name|$DESCRIPTOR
argument_list|(
name|terminal
argument_list|,
literal|"TT"
argument_list|)
expr_stmt|;
name|long
name|tty_orig
index|[
literal|3
index|]
decl_stmt|,
name|tty_new
index|[
literal|3
index|]
decl_stmt|;
name|long
name|status
decl_stmt|;
name|unsigned
name|short
name|channel
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|int
name|ok
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|ps
init|=
literal|0
decl_stmt|;
name|FILE
modifier|*
name|tty
decl_stmt|;
ifndef|#
directive|ifndef
name|MSDOS
if|if
condition|(
operator|(
name|tty
operator|=
name|fopen
argument_list|(
literal|"/dev/tty"
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|tty
operator|=
name|stdin
expr_stmt|;
else|#
directive|else
comment|/* MSDOS */
if|if
condition|(
operator|(
name|tty
operator|=
name|fopen
argument_list|(
literal|"con"
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|tty
operator|=
name|stdin
expr_stmt|;
endif|#
directive|endif
comment|/* MSDOS */
ifndef|#
directive|ifndef
name|VMS
ifdef|#
directive|ifdef
name|TIOCGETP
if|if
condition|(
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|tty
argument_list|)
argument_list|,
name|TIOCGETP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|tty_orig
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|bcopy
argument_list|(
operator|&
operator|(
name|tty_orig
operator|)
argument_list|,
operator|&
operator|(
name|tty_new
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|tty_orig
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|#
directive|else
comment|/* VMS */
name|status
operator|=
name|SYS$ASSIGN
argument_list|(
operator|&
name|terminal
argument_list|,
operator|&
name|channel
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SS$_NORMAL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|status
operator|=
name|SYS$QIOW
argument_list|(
literal|0
argument_list|,
name|channel
argument_list|,
name|IO$_SENSEMODE
argument_list|,
operator|&
name|iosb
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|tty_orig
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|SS$_NORMAL
operator|)
operator|||
operator|(
name|iosb
operator|.
name|iosb$w_value
operator|!=
name|SS$_NORMAL
operator|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
endif|#
directive|endif
if|if
condition|(
name|setjmp
argument_list|(
name|save
argument_list|)
condition|)
block|{
name|ok
operator|=
literal|0
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|pushsig
argument_list|()
expr_stmt|;
name|ps
operator|=
literal|1
expr_stmt|;
ifndef|#
directive|ifndef
name|VMS
ifndef|#
directive|ifndef
name|MSDOS
name|tty_new
operator|.
name|sg_flags
operator|&=
operator|~
name|ECHO
expr_stmt|;
endif|#
directive|endif
comment|/* !MSDOS */
ifdef|#
directive|ifdef
name|TIOCSETP
if|if
condition|(
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|tty
argument_list|)
argument_list|,
name|TIOCSETP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|tty_new
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
endif|#
directive|endif
else|#
directive|else
comment|/* VMS */
name|tty_new
index|[
literal|0
index|]
operator|=
name|tty_orig
index|[
literal|0
index|]
expr_stmt|;
name|tty_new
index|[
literal|1
index|]
operator|=
name|tty_orig
index|[
literal|1
index|]
operator||
name|TT$M_NOECHO
expr_stmt|;
name|tty_new
index|[
literal|2
index|]
operator|=
name|tty_orig
index|[
literal|2
index|]
expr_stmt|;
name|status
operator|=
name|SYS$QIOW
argument_list|(
literal|0
argument_list|,
name|channel
argument_list|,
name|IO$_SETMODE
argument_list|,
operator|&
name|iosb
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|tty_new
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|SS$_NORMAL
operator|)
operator|||
operator|(
name|iosb
operator|.
name|iosb$w_value
operator|!=
name|SS$_NORMAL
operator|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
endif|#
directive|endif
comment|/* VMS */
name|ps
operator|=
literal|2
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|ok
condition|)
block|{
name|fputs
argument_list|(
name|prompt
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fgets
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
name|tty
argument_list|)
expr_stmt|;
if|if
condition|(
name|feof
argument_list|(
name|tty
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|(
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|index
argument_list|(
name|buf
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
else|else
name|read_till_nl
argument_list|(
name|tty
argument_list|)
expr_stmt|;
if|if
condition|(
name|verify
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nVerifying password %s"
argument_list|,
name|prompt
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|buff
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fgets
argument_list|(
name|buff
argument_list|,
name|size
argument_list|,
name|tty
argument_list|)
expr_stmt|;
if|if
condition|(
name|feof
argument_list|(
name|tty
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|(
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|index
argument_list|(
name|buff
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
else|else
name|read_till_nl
argument_list|(
name|tty
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
name|buff
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nVerify failure - try again\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|ok
operator|=
literal|1
expr_stmt|;
block|}
name|error
label|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* What can we do if there is an error? */
ifndef|#
directive|ifndef
name|VMS
ifdef|#
directive|ifdef
name|TIOCSETP
if|if
condition|(
name|ps
operator|>=
literal|2
condition|)
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|tty
argument_list|)
argument_list|,
name|TIOCSETP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|tty_orig
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|#
directive|else
comment|/* VMS */
if|if
condition|(
name|ps
operator|>=
literal|2
condition|)
name|status
operator|=
name|SYS$QIOW
argument_list|(
literal|0
argument_list|,
name|channel
argument_list|,
name|IO$_SETMODE
argument_list|,
operator|&
name|iosb
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|tty_orig
argument_list|,
literal|12
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* VMS */
if|if
condition|(
name|ps
operator|>=
literal|1
condition|)
name|popsig
argument_list|()
expr_stmt|;
if|if
condition|(
name|stdin
operator|!=
name|tty
condition|)
name|fclose
argument_list|(
name|tty
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VMS
name|status
operator|=
name|SYS$DASSGN
argument_list|(
name|channel
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
operator|!
name|ok
operator|)
return|;
block|}
end_block

begin_function
specifier|static
name|void
name|pushsig
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NSIG
condition|;
name|i
operator|++
control|)
name|savsig
index|[
name|i
index|]
operator|=
name|signal
argument_list|(
name|i
argument_list|,
name|recsig
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|popsig
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NSIG
condition|;
name|i
operator|++
control|)
name|signal
argument_list|(
name|i
argument_list|,
name|savsig
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|recsig
parameter_list|()
block|{
name|longjmp
argument_list|(
name|save
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|MSDOS
end_ifdef

begin_function
specifier|static
name|int
name|noecho_fgets
parameter_list|(
name|buf
parameter_list|,
name|size
parameter_list|,
name|tty
parameter_list|)
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|size
decl_stmt|;
name|FILE
modifier|*
name|tty
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|size
operator|--
expr_stmt|;
name|i
operator|=
name|getch
argument_list|()
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|'\r'
condition|)
name|i
operator|=
literal|'\n'
expr_stmt|;
operator|*
operator|(
name|p
operator|++
operator|)
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


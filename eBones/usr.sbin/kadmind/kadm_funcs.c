begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 1988 by the Massachusetts Institute of Technology.  *  * For copying and distribution information, please see the file  * Copyright.MIT  *  * Kerberos administration server-side database manipulation routines  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static char rcsid_kadm_funcs_c[] = "Id: kadm_funcs.c,v 4.3 90/03/20 01:39:51 jon Exp ";
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$Id: kadm_funcs.c,v 1.1 1995/01/20 03:12:55 wollman Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_comment
comment|/* kadm_funcs.c the actual database manipulation code */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<kadm.h>
end_include

begin_include
include|#
directive|include
file|<kadm_err.h>
end_include

begin_include
include|#
directive|include
file|<krb_db.h>
end_include

begin_include
include|#
directive|include
file|"kadm_server.h"
end_include

begin_decl_stmt
specifier|extern
name|Kadm_Server
name|server_parm
decl_stmt|;
end_decl_stmt

begin_macro
name|check_access
argument_list|(
argument|pname
argument_list|,
argument|pinst
argument_list|,
argument|prealm
argument_list|,
argument|acltype
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|pname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|pinst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|prealm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|enum
name|acl_types
name|acltype
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|checkname
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|;
name|char
name|filename
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
specifier|extern
name|char
modifier|*
name|acldir
decl_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|checkname
argument_list|,
literal|"%s.%s@%s"
argument_list|,
name|pname
argument_list|,
name|pinst
argument_list|,
name|prealm
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|acltype
condition|)
block|{
case|case
name|ADDACL
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|filename
argument_list|,
literal|"%s%s"
argument_list|,
name|acldir
argument_list|,
name|ADD_ACL_FILE
argument_list|)
expr_stmt|;
break|break;
case|case
name|GETACL
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|filename
argument_list|,
literal|"%s%s"
argument_list|,
name|acldir
argument_list|,
name|GET_ACL_FILE
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODACL
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|filename
argument_list|,
literal|"%s%s"
argument_list|,
name|acldir
argument_list|,
name|MOD_ACL_FILE
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|acl_check
argument_list|(
name|filename
argument_list|,
name|checkname
argument_list|)
operator|)
return|;
block|}
end_block

begin_function
name|int
name|wildcard
parameter_list|(
name|str
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|str
argument_list|,
name|WILDCARD_STR
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|failadd
parameter_list|(
name|code
parameter_list|)
value|{  (void) log("FAILED addding '%s.%s' (%s)", valsin->name, valsin->instance, error_message(code)); return code; }
end_define

begin_macro
name|kadm_add_entry
argument_list|(
argument|rname
argument_list|,
argument|rinstance
argument_list|,
argument|rrealm
argument_list|,
argument|valsin
argument_list|,
argument|valsout
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|rname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* requestors name */
end_comment

begin_decl_stmt
name|char
modifier|*
name|rinstance
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* requestors instance */
end_comment

begin_decl_stmt
name|char
modifier|*
name|rrealm
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* requestors realm */
end_comment

begin_decl_stmt
name|Kadm_vals
modifier|*
name|valsin
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Kadm_vals
modifier|*
name|valsout
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|long
name|numfound
decl_stmt|;
comment|/* check how many we get written */
name|int
name|more
decl_stmt|;
comment|/* pointer to more grabbed records */
name|Principal
name|data_i
decl_stmt|,
name|data_o
decl_stmt|;
comment|/* temporary principal */
name|u_char
name|flags
index|[
literal|4
index|]
decl_stmt|;
name|des_cblock
name|newpw
decl_stmt|;
name|Principal
name|default_princ
decl_stmt|;
if|if
condition|(
operator|!
name|check_access
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|,
name|ADDACL
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"WARNING: '%s.%s@%s' tried to add an entry for '%s.%s'"
argument_list|,
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|,
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|)
expr_stmt|;
return|return
name|KADM_UNAUTH
return|;
block|}
comment|/* Need to check here for "legal" name and instance */
if|if
condition|(
name|wildcard
argument_list|(
name|valsin
operator|->
name|name
argument_list|)
operator|||
name|wildcard
argument_list|(
name|valsin
operator|->
name|instance
argument_list|)
condition|)
block|{
name|failadd
argument_list|(
name|KADM_ILL_WILDCARD
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"request to add an entry for '%s.%s' from '%s.%s@%s'"
argument_list|,
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
expr_stmt|;
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|KERB_DEFAULT_NAME
argument_list|,
name|KERB_DEFAULT_INST
argument_list|,
operator|&
name|default_princ
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failadd
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
operator|!=
literal|1
condition|)
block|{
name|failadd
argument_list|(
name|KADM_UK_RERROR
argument_list|)
expr_stmt|;
block|}
name|kadm_vals_to_prin
argument_list|(
name|valsin
operator|->
name|fields
argument_list|,
operator|&
name|data_i
argument_list|,
name|valsin
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|data_i
operator|.
name|name
argument_list|,
name|valsin
operator|->
name|name
argument_list|,
name|ANAME_SZ
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|data_i
operator|.
name|instance
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
name|INST_SZ
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|valsin
operator|->
name|fields
argument_list|)
condition|)
name|data_i
operator|.
name|exp_date
operator|=
name|default_princ
operator|.
name|exp_date
expr_stmt|;
if|if
condition|(
operator|!
name|IS_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|valsin
operator|->
name|fields
argument_list|)
condition|)
name|data_i
operator|.
name|attributes
operator|=
name|default_princ
operator|.
name|attributes
expr_stmt|;
if|if
condition|(
operator|!
name|IS_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|valsin
operator|->
name|fields
argument_list|)
condition|)
name|data_i
operator|.
name|max_life
operator|=
name|default_princ
operator|.
name|max_life
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|default_princ
argument_list|,
sizeof|sizeof
argument_list|(
name|default_princ
argument_list|)
argument_list|)
expr_stmt|;
comment|/* convert to host order */
name|data_i
operator|.
name|key_low
operator|=
name|ntohl
argument_list|(
name|data_i
operator|.
name|key_low
argument_list|)
expr_stmt|;
name|data_i
operator|.
name|key_high
operator|=
name|ntohl
argument_list|(
name|data_i
operator|.
name|key_high
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|data_i
operator|.
name|key_low
argument_list|,
name|newpw
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|data_i
operator|.
name|key_high
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
operator|(
operator|(
name|long
operator|*
operator|)
name|newpw
operator|)
operator|+
literal|1
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* encrypt new key in master key */
name|kdb_encrypt_key
argument_list|(
name|newpw
argument_list|,
name|newpw
argument_list|,
name|server_parm
operator|.
name|master_key
argument_list|,
name|server_parm
operator|.
name|master_key_schedule
argument_list|,
name|ENCRYPT
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|newpw
argument_list|,
operator|&
name|data_i
operator|.
name|key_low
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
operator|(
operator|(
name|long
operator|*
operator|)
name|newpw
operator|)
operator|+
literal|1
operator|)
argument_list|,
operator|&
name|data_i
operator|.
name|key_high
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|newpw
argument_list|,
sizeof|sizeof
argument_list|(
name|newpw
argument_list|)
argument_list|)
expr_stmt|;
name|data_o
operator|=
name|data_i
expr_stmt|;
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failadd
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
condition|)
block|{
name|failadd
argument_list|(
name|KADM_INUSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|data_i
operator|.
name|key_version
operator|++
expr_stmt|;
name|data_i
operator|.
name|kdc_key_ver
operator|=
name|server_parm
operator|.
name|master_key_version
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|data_i
operator|.
name|mod_name
argument_list|,
name|rname
argument_list|,
sizeof|sizeof
argument_list|(
name|data_i
operator|.
name|mod_name
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|data_i
operator|.
name|mod_instance
argument_list|,
name|rinstance
argument_list|,
sizeof|sizeof
argument_list|(
name|data_i
operator|.
name|mod_instance
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|numfound
operator|=
name|kerb_put_principal
argument_list|(
operator|&
name|data_i
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failadd
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
condition|)
block|{
name|failadd
argument_list|(
name|KADM_UK_SERROR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|numfound
operator|!=
literal|1
operator|)
operator|||
operator|(
name|more
operator|!=
literal|0
operator|)
condition|)
block|{
name|failadd
argument_list|(
name|KADM_UK_RERROR
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|flags
argument_list|,
sizeof|sizeof
argument_list|(
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_NAME
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_INST
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|kadm_prin_to_vals
argument_list|(
name|flags
argument_list|,
name|valsout
argument_list|,
operator|&
name|data_o
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"'%s.%s' added."
argument_list|,
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|)
expr_stmt|;
return|return
name|KADM_DATA
return|;
comment|/* Set all the appropriate fields */
block|}
block|}
block|}
end_block

begin_undef
undef|#
directive|undef
name|failadd
end_undef

begin_define
define|#
directive|define
name|failget
parameter_list|(
name|code
parameter_list|)
value|{  (void) log("FAILED retrieving '%s.%s' (%s)", valsin->name, valsin->instance, error_message(code)); return code; }
end_define

begin_macro
name|kadm_get_entry
argument_list|(
argument|rname
argument_list|,
argument|rinstance
argument_list|,
argument|rrealm
argument_list|,
argument|valsin
argument_list|,
argument|flags
argument_list|,
argument|valsout
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|rname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* requestors name */
end_comment

begin_decl_stmt
name|char
modifier|*
name|rinstance
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* requestors instance */
end_comment

begin_decl_stmt
name|char
modifier|*
name|rrealm
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* requestors realm */
end_comment

begin_decl_stmt
name|Kadm_vals
modifier|*
name|valsin
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* what they wannt to get */
end_comment

begin_decl_stmt
name|u_char
modifier|*
name|flags
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* which fields we want */
end_comment

begin_decl_stmt
name|Kadm_vals
modifier|*
name|valsout
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* what data is there */
end_comment

begin_block
block|{
name|long
name|numfound
decl_stmt|;
comment|/* check how many were returned */
name|int
name|more
decl_stmt|;
comment|/* To point to more name.instances */
name|Principal
name|data_o
decl_stmt|;
comment|/* Data object to hold Principal */
if|if
condition|(
operator|!
name|check_access
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|,
name|GETACL
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"WARNING: '%s.%s@%s' tried to get '%s.%s's entry"
argument_list|,
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|,
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|)
expr_stmt|;
return|return
name|KADM_UNAUTH
return|;
block|}
if|if
condition|(
name|wildcard
argument_list|(
name|valsin
operator|->
name|name
argument_list|)
operator|||
name|wildcard
argument_list|(
name|valsin
operator|->
name|instance
argument_list|)
condition|)
block|{
name|failget
argument_list|(
name|KADM_ILL_WILDCARD
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"retrieve '%s.%s's entry for '%s.%s@%s'"
argument_list|,
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
expr_stmt|;
comment|/* Look up the record in the database */
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failget
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
condition|)
block|{
comment|/* We got the record, let's return it */
name|kadm_prin_to_vals
argument_list|(
name|flags
argument_list|,
name|valsout
argument_list|,
operator|&
name|data_o
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"'%s.%s' retrieved."
argument_list|,
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|)
expr_stmt|;
return|return
name|KADM_DATA
return|;
comment|/* Set all the appropriate fields */
block|}
else|else
block|{
name|failget
argument_list|(
name|KADM_NOENTRY
argument_list|)
expr_stmt|;
comment|/* Else whimper and moan */
block|}
block|}
end_block

begin_undef
undef|#
directive|undef
name|failget
end_undef

begin_define
define|#
directive|define
name|failmod
parameter_list|(
name|code
parameter_list|)
value|{  (void) log("FAILED modifying '%s.%s' (%s)", valsin1->name, valsin1->instance, error_message(code)); return code; }
end_define

begin_macro
name|kadm_mod_entry
argument_list|(
argument|rname
argument_list|,
argument|rinstance
argument_list|,
argument|rrealm
argument_list|,
argument|valsin1
argument_list|,
argument|valsin2
argument_list|,
argument|valsout
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|rname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* requestors name */
end_comment

begin_decl_stmt
name|char
modifier|*
name|rinstance
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* requestors instance */
end_comment

begin_decl_stmt
name|char
modifier|*
name|rrealm
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* requestors realm */
end_comment

begin_decl_stmt
name|Kadm_vals
modifier|*
name|valsin1
decl_stmt|,
modifier|*
name|valsin2
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* holds the parameters being 					   passed in */
end_comment

begin_decl_stmt
name|Kadm_vals
modifier|*
name|valsout
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the actual record which is returned */
end_comment

begin_block
block|{
name|long
name|numfound
decl_stmt|;
name|int
name|more
decl_stmt|;
name|Principal
name|data_o
decl_stmt|,
name|temp_key
decl_stmt|;
name|u_char
name|fields
index|[
literal|4
index|]
decl_stmt|;
name|des_cblock
name|newpw
decl_stmt|;
if|if
condition|(
name|wildcard
argument_list|(
name|valsin1
operator|->
name|name
argument_list|)
operator|||
name|wildcard
argument_list|(
name|valsin1
operator|->
name|instance
argument_list|)
condition|)
block|{
name|failmod
argument_list|(
name|KADM_ILL_WILDCARD
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|check_access
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|,
name|MODACL
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"WARNING: '%s.%s@%s' tried to change '%s.%s's entry"
argument_list|,
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|,
name|valsin1
operator|->
name|name
argument_list|,
name|valsin1
operator|->
name|instance
argument_list|)
expr_stmt|;
return|return
name|KADM_UNAUTH
return|;
block|}
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"request to modify '%s.%s's entry from '%s.%s@%s' "
argument_list|,
name|valsin1
operator|->
name|name
argument_list|,
name|valsin1
operator|->
name|instance
argument_list|,
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
expr_stmt|;
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|valsin1
operator|->
name|name
argument_list|,
name|valsin1
operator|->
name|instance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failmod
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
condition|)
block|{
name|kadm_vals_to_prin
argument_list|(
name|valsin2
operator|->
name|fields
argument_list|,
operator|&
name|temp_key
argument_list|,
name|valsin2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|data_o
operator|.
name|name
argument_list|,
name|valsin1
operator|->
name|name
argument_list|,
name|ANAME_SZ
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|data_o
operator|.
name|instance
argument_list|,
name|valsin1
operator|->
name|instance
argument_list|,
name|INST_SZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|valsin2
operator|->
name|fields
argument_list|)
condition|)
name|data_o
operator|.
name|exp_date
operator|=
name|temp_key
operator|.
name|exp_date
expr_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|valsin2
operator|->
name|fields
argument_list|)
condition|)
name|data_o
operator|.
name|attributes
operator|=
name|temp_key
operator|.
name|attributes
expr_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|valsin2
operator|->
name|fields
argument_list|)
condition|)
name|data_o
operator|.
name|max_life
operator|=
name|temp_key
operator|.
name|max_life
expr_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_DESKEY
argument_list|,
name|valsin2
operator|->
name|fields
argument_list|)
condition|)
block|{
name|data_o
operator|.
name|key_version
operator|++
expr_stmt|;
name|data_o
operator|.
name|kdc_key_ver
operator|=
name|server_parm
operator|.
name|master_key_version
expr_stmt|;
comment|/* convert to host order */
name|temp_key
operator|.
name|key_low
operator|=
name|ntohl
argument_list|(
name|temp_key
operator|.
name|key_low
argument_list|)
expr_stmt|;
name|temp_key
operator|.
name|key_high
operator|=
name|ntohl
argument_list|(
name|temp_key
operator|.
name|key_high
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|temp_key
operator|.
name|key_low
argument_list|,
name|newpw
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|temp_key
operator|.
name|key_high
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
operator|(
operator|(
name|long
operator|*
operator|)
name|newpw
operator|)
operator|+
literal|1
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* encrypt new key in master key */
name|kdb_encrypt_key
argument_list|(
name|newpw
argument_list|,
name|newpw
argument_list|,
name|server_parm
operator|.
name|master_key
argument_list|,
name|server_parm
operator|.
name|master_key_schedule
argument_list|,
name|ENCRYPT
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|newpw
argument_list|,
operator|&
name|data_o
operator|.
name|key_low
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
operator|(
operator|(
name|long
operator|*
operator|)
name|newpw
operator|)
operator|+
literal|1
operator|)
argument_list|,
operator|&
name|data_o
operator|.
name|key_high
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|newpw
argument_list|,
sizeof|sizeof
argument_list|(
name|newpw
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|temp_key
argument_list|,
sizeof|sizeof
argument_list|(
name|temp_key
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|data_o
operator|.
name|mod_name
argument_list|,
name|rname
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
operator|.
name|mod_name
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|data_o
operator|.
name|mod_instance
argument_list|,
name|rinstance
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
operator|.
name|mod_instance
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|more
operator|=
name|kerb_put_principal
argument_list|(
operator|&
name|data_o
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|data_o
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|more
operator|==
operator|-
literal|1
condition|)
block|{
name|failmod
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|more
condition|)
block|{
name|failmod
argument_list|(
name|KADM_UK_SERROR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|valsin1
operator|->
name|name
argument_list|,
name|valsin1
operator|->
name|instance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|more
operator|!=
literal|0
operator|)
operator|||
operator|(
name|numfound
operator|!=
literal|1
operator|)
condition|)
block|{
name|failmod
argument_list|(
name|KADM_UK_RERROR
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fields
argument_list|,
sizeof|sizeof
argument_list|(
name|fields
argument_list|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_NAME
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_INST
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|kadm_prin_to_vals
argument_list|(
name|fields
argument_list|,
name|valsout
argument_list|,
operator|&
name|data_o
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"'%s.%s' modified."
argument_list|,
name|valsin1
operator|->
name|name
argument_list|,
name|valsin1
operator|->
name|instance
argument_list|)
expr_stmt|;
return|return
name|KADM_DATA
return|;
comment|/* Set all the appropriate fields */
block|}
block|}
else|else
block|{
name|failmod
argument_list|(
name|KADM_NOENTRY
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_undef
undef|#
directive|undef
name|failmod
end_undef

begin_define
define|#
directive|define
name|failchange
parameter_list|(
name|code
parameter_list|)
value|{  (void) log("FAILED changing key for '%s.%s@%s' (%s)", rname, rinstance, rrealm, error_message(code)); return code; }
end_define

begin_macro
name|kadm_change
argument_list|(
argument|rname
argument_list|,
argument|rinstance
argument_list|,
argument|rrealm
argument_list|,
argument|newpw
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|rname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|rinstance
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|rrealm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|des_cblock
name|newpw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|long
name|numfound
decl_stmt|;
name|int
name|more
decl_stmt|;
name|Principal
name|data_o
decl_stmt|;
name|des_cblock
name|local_pw
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|server_parm
operator|.
name|krbrlm
argument_list|,
name|rrealm
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"change key request from wrong realm, '%s.%s@%s'!\n"
argument_list|,
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
expr_stmt|;
return|return
operator|(
name|KADM_WRONG_REALM
operator|)
return|;
block|}
if|if
condition|(
name|wildcard
argument_list|(
name|rname
argument_list|)
operator|||
name|wildcard
argument_list|(
name|rinstance
argument_list|)
condition|)
block|{
name|failchange
argument_list|(
name|KADM_ILL_WILDCARD
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"'%s.%s@%s' wants to change its password"
argument_list|,
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|newpw
argument_list|,
name|local_pw
argument_list|,
sizeof|sizeof
argument_list|(
name|local_pw
argument_list|)
argument_list|)
expr_stmt|;
comment|/* encrypt new key in master key */
name|kdb_encrypt_key
argument_list|(
name|local_pw
argument_list|,
name|local_pw
argument_list|,
name|server_parm
operator|.
name|master_key
argument_list|,
name|server_parm
operator|.
name|master_key_schedule
argument_list|,
name|ENCRYPT
argument_list|)
expr_stmt|;
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failchange
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
condition|)
block|{
name|bcopy
argument_list|(
name|local_pw
argument_list|,
operator|&
name|data_o
operator|.
name|key_low
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
operator|(
operator|(
name|long
operator|*
operator|)
name|local_pw
operator|)
operator|+
literal|1
operator|)
argument_list|,
operator|&
name|data_o
operator|.
name|key_high
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|data_o
operator|.
name|key_version
operator|++
expr_stmt|;
name|data_o
operator|.
name|kdc_key_ver
operator|=
name|server_parm
operator|.
name|master_key_version
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|data_o
operator|.
name|mod_name
argument_list|,
name|rname
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
operator|.
name|mod_name
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|data_o
operator|.
name|mod_instance
argument_list|,
name|rinstance
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
operator|.
name|mod_instance
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|more
operator|=
name|kerb_put_principal
argument_list|(
operator|&
name|data_o
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|local_pw
argument_list|,
sizeof|sizeof
argument_list|(
name|local_pw
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|data_o
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|more
operator|==
operator|-
literal|1
condition|)
block|{
name|failchange
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|more
condition|)
block|{
name|failchange
argument_list|(
name|KADM_UK_SERROR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|log
argument_list|(
literal|"'%s.%s@%s' password changed."
argument_list|,
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
expr_stmt|;
return|return
name|KADM_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|failchange
argument_list|(
name|KADM_NOENTRY
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_undef
undef|#
directive|undef
name|failchange
end_undef

end_unit


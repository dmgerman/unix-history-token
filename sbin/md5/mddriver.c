begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* MDDRIVER.C - test driver for MD2, MD4 and MD5  */
end_comment

begin_comment
comment|/* Copyright (C) 1990-2, RSA Data Security, Inc. Created 1990. All rights reserved.  RSA Data Security, Inc. makes no representations concerning either the merchantability of this software or the suitability of this software for any particular purpose. It is provided "as is" without express or implied warranty of any kind.  These notices must be retained in any copies of any part of this documentation and/or software.  */
end_comment

begin_comment
comment|/* The following makes MD default to MD5 if it has not already been   defined with C compiler flags.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|MD
end_ifndef

begin_define
define|#
directive|define
name|MD
value|MD5
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"global.h"
end_include

begin_if
if|#
directive|if
name|MD
operator|==
literal|2
end_if

begin_include
include|#
directive|include
file|"md2.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|MD
operator|==
literal|4
end_if

begin_include
include|#
directive|include
file|"md4.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|MD
operator|==
literal|5
end_if

begin_include
include|#
directive|include
file|"md5.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Length of test block, number of test blocks.  */
end_comment

begin_define
define|#
directive|define
name|TEST_BLOCK_LEN
value|1000
end_define

begin_define
define|#
directive|define
name|TEST_BLOCK_COUNT
value|1000
end_define

begin_decl_stmt
specifier|static
name|void
name|MDString
name|PROTO_LIST
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|MDTimeTrial
name|PROTO_LIST
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|MDTestSuite
name|PROTO_LIST
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|MDFile
name|PROTO_LIST
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|MDFilter
name|PROTO_LIST
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|MDPrint
name|PROTO_LIST
argument_list|(
operator|(
name|unsigned
name|char
index|[
literal|16
index|]
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|MD
operator|==
literal|2
end_if

begin_define
define|#
directive|define
name|MD_CTX
value|MD2_CTX
end_define

begin_define
define|#
directive|define
name|MDInit
value|MD2Init
end_define

begin_define
define|#
directive|define
name|MDUpdate
value|MD2Update
end_define

begin_define
define|#
directive|define
name|MDFinal
value|MD2Final
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|MD
operator|==
literal|4
end_if

begin_define
define|#
directive|define
name|MD_CTX
value|MD4_CTX
end_define

begin_define
define|#
directive|define
name|MDInit
value|MD4Init
end_define

begin_define
define|#
directive|define
name|MDUpdate
value|MD4Update
end_define

begin_define
define|#
directive|define
name|MDFinal
value|MD4Final
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|MD
operator|==
literal|5
end_if

begin_define
define|#
directive|define
name|MD_CTX
value|MD5_CTX
end_define

begin_define
define|#
directive|define
name|MDInit
value|MD5Init
end_define

begin_define
define|#
directive|define
name|MDUpdate
value|MD5Update
end_define

begin_define
define|#
directive|define
name|MDFinal
value|MD5Final
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Main driver.  Arguments (may be any combination):   -sstring - digests string   -t       - runs time trial   -x       - runs test script   filename - digests file   (none)   - digests standard input  */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
operator|&&
name|argv
index|[
name|i
index|]
index|[
literal|1
index|]
operator|==
literal|'s'
condition|)
name|MDString
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|2
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-t"
argument_list|)
operator|==
literal|0
condition|)
name|MDTimeTrial
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-x"
argument_list|)
operator|==
literal|0
condition|)
name|MDTestSuite
argument_list|()
expr_stmt|;
else|else
name|MDFile
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|MDFilter
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Digests a string and prints the result.  */
end_comment

begin_function
specifier|static
name|void
name|MDString
parameter_list|(
name|string
parameter_list|)
name|char
modifier|*
name|string
decl_stmt|;
block|{
name|MD_CTX
name|context
decl_stmt|;
name|unsigned
name|char
name|digest
index|[
literal|16
index|]
decl_stmt|;
name|unsigned
name|int
name|len
init|=
name|strlen
argument_list|(
name|string
argument_list|)
decl_stmt|;
name|MDInit
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
name|MDUpdate
argument_list|(
operator|&
name|context
argument_list|,
name|string
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|MDFinal
argument_list|(
name|digest
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MD%d (\"%s\") = "
argument_list|,
name|MD
argument_list|,
name|string
argument_list|)
expr_stmt|;
name|MDPrint
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Measures the time to digest TEST_BLOCK_COUNT TEST_BLOCK_LEN-byte   blocks.  */
end_comment

begin_function
specifier|static
name|void
name|MDTimeTrial
parameter_list|()
block|{
name|MD_CTX
name|context
decl_stmt|;
name|time_t
name|endTime
decl_stmt|,
name|startTime
decl_stmt|;
name|unsigned
name|char
name|block
index|[
name|TEST_BLOCK_LEN
index|]
decl_stmt|,
name|digest
index|[
literal|16
index|]
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"MD%d time trial. Digesting %d %d-byte blocks ..."
argument_list|,
name|MD
argument_list|,
name|TEST_BLOCK_LEN
argument_list|,
name|TEST_BLOCK_COUNT
argument_list|)
expr_stmt|;
comment|/* Initialize block */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TEST_BLOCK_LEN
condition|;
name|i
operator|++
control|)
name|block
index|[
name|i
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|i
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/* Start timer */
name|time
argument_list|(
operator|&
name|startTime
argument_list|)
expr_stmt|;
comment|/* Digest blocks */
name|MDInit
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TEST_BLOCK_COUNT
condition|;
name|i
operator|++
control|)
name|MDUpdate
argument_list|(
operator|&
name|context
argument_list|,
name|block
argument_list|,
name|TEST_BLOCK_LEN
argument_list|)
expr_stmt|;
name|MDFinal
argument_list|(
name|digest
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
comment|/* Stop timer */
name|time
argument_list|(
operator|&
name|endTime
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" done\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Digest = "
argument_list|)
expr_stmt|;
name|MDPrint
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nTime = %ld seconds\n"
argument_list|,
call|(
name|long
call|)
argument_list|(
name|endTime
operator|-
name|startTime
argument_list|)
argument_list|)
expr_stmt|;
comment|/*    * Be careful that endTime-startTime is not zero.    * (Bug fix from Ric Anderson, ric@Artisoft.COM.)    */
name|printf
argument_list|(
literal|"Speed = %ld bytes/second\n"
argument_list|,
operator|(
name|long
operator|)
name|TEST_BLOCK_LEN
operator|*
operator|(
name|long
operator|)
name|TEST_BLOCK_COUNT
operator|/
operator|(
operator|(
name|endTime
operator|-
name|startTime
operator|)
operator|!=
literal|0
condition|?
operator|(
name|endTime
operator|-
name|startTime
operator|)
else|:
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Digests a reference suite of strings and prints the results.  */
end_comment

begin_function
specifier|static
name|void
name|MDTestSuite
parameter_list|()
block|{
name|printf
argument_list|(
literal|"MD%d test suite:\n"
argument_list|,
name|MD
argument_list|)
expr_stmt|;
name|MDString
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|MDString
argument_list|(
literal|"a"
argument_list|)
expr_stmt|;
name|MDString
argument_list|(
literal|"abc"
argument_list|)
expr_stmt|;
name|MDString
argument_list|(
literal|"message digest"
argument_list|)
expr_stmt|;
name|MDString
argument_list|(
literal|"abcdefghijklmnopqrstuvwxyz"
argument_list|)
expr_stmt|;
name|MDString
argument_list|(
literal|"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
argument_list|)
expr_stmt|;
name|MDString
argument_list|(
literal|"1234567890123456789012345678901234567890\ 1234567890123456789012345678901234567890"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Digests a file and prints the result.  */
end_comment

begin_function
specifier|static
name|void
name|MDFile
parameter_list|(
name|filename
parameter_list|)
name|char
modifier|*
name|filename
decl_stmt|;
block|{
name|FILE
modifier|*
name|file
decl_stmt|;
name|MD_CTX
name|context
decl_stmt|;
name|int
name|len
decl_stmt|;
name|unsigned
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|,
name|digest
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|file
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"rb"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s can't be opened\n"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
else|else
block|{
name|MDInit
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|=
name|fread
argument_list|(
name|buffer
argument_list|,
literal|1
argument_list|,
literal|1024
argument_list|,
name|file
argument_list|)
condition|)
name|MDUpdate
argument_list|(
operator|&
name|context
argument_list|,
name|buffer
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|MDFinal
argument_list|(
name|digest
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MD%d (%s) = "
argument_list|,
name|MD
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|MDPrint
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Digests the standard input and prints the result.  */
end_comment

begin_function
specifier|static
name|void
name|MDFilter
parameter_list|()
block|{
name|MD_CTX
name|context
decl_stmt|;
name|int
name|len
decl_stmt|;
name|unsigned
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|,
name|digest
index|[
literal|16
index|]
decl_stmt|;
name|MDInit
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|=
name|fread
argument_list|(
name|buffer
argument_list|,
literal|1
argument_list|,
literal|16
argument_list|,
name|stdin
argument_list|)
condition|)
name|MDUpdate
argument_list|(
operator|&
name|context
argument_list|,
name|buffer
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|MDFinal
argument_list|(
name|digest
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
name|MDPrint
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Prints a message digest in hexadecimal.  */
end_comment

begin_function
specifier|static
name|void
name|MDPrint
parameter_list|(
name|digest
parameter_list|)
name|unsigned
name|char
name|digest
index|[
literal|16
index|]
decl_stmt|;
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|digest
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

